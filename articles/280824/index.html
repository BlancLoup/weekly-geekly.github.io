<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>IL2CPP: generated code tour</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Here is the second article in the series on IL2CPP. This time we will talk about the C ++ code generated by the il2cpp.exe utility, and also consider ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>IL2CPP: generated code tour</h1><div class="post__text post__text-html js-mediator-article">  Here is the second article in the series on IL2CPP.  This time we will talk about the C ++ code generated by the il2cpp.exe utility, and also consider the presentation of managed types in machine code, runtime checks that are used to support the .NET virtual machine, the generation of loops, and much more. <br><br><img src="https://habrastorage.org/files/59a/333/b26/59a333b26acd4d06a62c3f0a21e28c77.jpg"><br><a name="habracut"></a><br>  To do this, we will use a very specific code that will surely change in future versions of Unity.  But the basic principles will remain unchanged. <br><br>  <b>Sample project</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For this example, I will use the latest available version of Unity 5.0.1p1.  As in the previous article, create a new empty project and add one script with the following content: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HelloWorld</span></span></span><span class="hljs-class"> :</span></span> MonoBehaviour { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Important</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ClassIdentifier = <span class="hljs-number"><span class="hljs-number">42</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> InstanceIdentifier; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Debug.Log(<span class="hljs-string"><span class="hljs-string">"Hello, IL2CPP!"</span></span>); Debug.LogFormat(<span class="hljs-string"><span class="hljs-string">"Static field: {0}"</span></span>, Important.ClassIdentifier); var importantData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> [] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Important { InstanceIdentifier = <span class="hljs-number"><span class="hljs-number">0</span></span> }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Important { InstanceIdentifier = <span class="hljs-number"><span class="hljs-number">1</span></span> } }; Debug.LogFormat(<span class="hljs-string"><span class="hljs-string">"First value: {0}"</span></span>, importantData[<span class="hljs-number"><span class="hljs-number">0</span></span>].InstanceIdentifier); Debug.LogFormat(<span class="hljs-string"><span class="hljs-string">"Second value: {0}"</span></span>, importantData[<span class="hljs-number"><span class="hljs-number">1</span></span>].InstanceIdentifier); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-string"><span class="hljs-string">"Don't panic"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InvalidOperationException e) { Debug.Log(e.Message); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>; ++i) { Debug.LogFormat(<span class="hljs-string"><span class="hljs-string">"Loop iteration: {0}"</span></span>, i); } } }</code> </pre> <br><br>  I will build this project under WebGL using the Unity editor on Windows.  To get relatively good names in the generated C ++ code, I enabled the Development Player option in Build Settings.  In addition, I set the Full value to Enable Exceptions in the WebGL Player Settings. <br><br>  <b>Overview of the generated code</b> <br><br>  After the build is completed, the generated C ++ code can be found in the Temp \ StagingArea \ Data \ il2cppOutput directory in the project folder.  As soon as I close the editor, this directory will be deleted, but as long as it is open, you can carefully examine it. <br><br>  The il2cpp.exe utility generated many files even for such a small project: 4625 header files and 89 C ++ source code files.  To check this amount of code, I prefer to use a text editor with support for <a href="http://ctags.sourceforge.net/">Exuberant CTags.</a>  Typically, CTags quickly generates a tag file, which greatly simplifies navigation through the code. <br><br>  You may notice that many of the generated C ++ files contain not simple code from our script, but converted code from standard libraries, such as mscorlib.dll.  As mentioned in the previous article, the IL2CPP script engine uses the same standard code for libraries as Mono.  Please note that we convert the code of mscorlib.dll and other standard libraries each time you run il2cpp.exe.  This may seem unnecessary, since the code does not change. <br><br>  The fact is that IL2CPP always clears bytecode to reduce the size of the executable file.  Therefore, even small changes in the script code can lead to the fact that different parts of the standard library code will be used or not, depending on the circumstances.  Therefore, mscorlib.dll must be converted with each build.  We are trying to improve the incremental build process, but so far without much success. <br><br>  <b>Mapping managed code in generated C ++ code</b> <br><br>  For each type in the managed code, il2cpp.exe generates 2 header files: to determine the type and declare the methods for that type.  For example, let's look at the contents of the converted UnityEngine.Vector3 type.  The header file for this type is called UnityEngine_UnityEngine_Vector3.h.  The name is created based on the assembly name (UnityEngine.dll), namespace, and type name.  The code looks like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// UnityEngine.Vector3 struct Vector3_t78 { // System.Single UnityEngine.Vector3::x float ___x_1; // System.Single UnityEngine.Vector3::y float ___y_2; // System.Single UnityEngine.Vector3::z float ___z_3; };</span></span></code> </pre><br><br>  The il2cpp.exe utility converts each of the three fields of the instance and slightly changes the names, using the initial underscore to avoid possible conflicts with reserved words.  We use reserved names in C ++, but have never seen them in conflict with the code of standard libraries. <br><br>  The UnityEngine_UnityEngine_Vector3MethodDeclarations.h file contains declarations for all methods in Vector3.  For example, Vector3 overrides the Object.ToString method: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// System.String UnityEngine.Vector3::ToString() extern "C" String_t* Vector3_ToString_m2315 (Vector3_t78 * __this, MethodInfo* method) IL2CPP_METHOD_ATTR</span></span></code> </pre><br><br>  Notice the comment, which specifies the managed method that represents the original declaration.  This can be useful for finding output files by the name of a managed method in this format, especially for methods with common names such as ToString. <br>  The methods converted by il2cpp.exe have several interesting features: <br><br>  ‚Ä¢ They are not member functions in C ++, but are free functions with this as the first argument.  For the first argument of static functions in managed code, IL2CPP always passes NULL.  By declaring methods with the this pointer as the first argument, we simplify the code generation in il2cpp.exe and invoking methods through other methods (for example, delegates) for the generated code. <br><br>  ‚Ä¢ Each method has an additional argument of type MethodInfo * containing metadata about the method that can be used, for example, to call a virtual method.  Mono uses platform-specific transports to pass this metadata.  But in the case of the IL2CPP, we decided not to use them to improve portability. <br>  ‚Ä¢ All methods are declared through extern "C", so that il2cpp.exe can deceive the C ++ compiler if necessary and treat all methods as if they were of the same type. <br><br>  ‚Ä¢ Type names contain the ‚Äú_t‚Äù suffix, method names - the ‚Äú_m‚Äù suffix.  Name conflicts are resolved by adding a unique number for each name.  In case of any changes in the code of the user script, these numbers also change, so you should not count on them when switching to a new assembly. <br><br>  The first 2 points imply that each method has at least 2 parameters: the this pointer and the MethodInfo pointer.  Do these parameters add extra resource costs?  Yes, they add, but this does not affect the performance, as it may seem at first glance.  At least that is what profiling results say. <br><br>  Let us proceed to the definition of the ToString method using Ctags.  It is in the Bulk_UnityEngine_0.cpp file.  The code in this method definition is not similar to C # code in the Vector3 :: ToString () method.  However, if you use a tool like ILSpy to view the code for the Vector3 :: ToString () method, you may notice that the generated C ++ code is very similar to the IL code. <br><br>  Why does il2cpp.exe not generate a separate C ++ file for defining methods of each type, as it does for declaring methods?  The Bulk_UnityEngine_0.cpp file is quite large - 20,481 lines!  The used C ++ compilers hardly coped with a large number of source files.  Compiling 4 thousand .cpp files took longer than compiling the same source code in 80 .cpp files.  Therefore, il2cpp.exe divides the method definitions for types into groups and generates one C ++ file for each of them. <br><br>  Now back to the header file method declarations and pay attention to the line at the top of the file: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"codegen/il2cpp-codegen.h"</span></span></span></span></code> </pre><br><br>  The il2cpp-codegen.h file contains the interface through which the generated code accesses the libil2cpp environment.  Later we will discuss several ways to use this environment. <br><br>  <b>Method prologue</b> <br><br>  Let's look at the definition of the Vector3 :: ToString () method, namely the general prologue created by il2cpp.exe for all methods. <br><br><pre> <code class="cpp hljs">StackTraceSentry _stackTraceSentry(&amp;Vector3_ToString_m2315_MethodInfo); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Vector3_ToString_m2315_init; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Vector3_ToString_m2315_init) { ObjectU5BU5D_t4_il2cpp_TypeInfo_var = il2cpp_codegen_class_from_type(&amp;ObjectU5BU5D_t4_0_0_0); Vector3_ToString_m2315_init = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre><br><br>  In the first line of the prologue, a local variable of type StackTraceSentry is created.  It is used to track the managed call stack, for example, using Environment.StackTrace.  In fact, the generation of this code is optional, in which case it started due to the il2cpp.exe passing the argument --enable-stacktrace (since I set the Full value to Enable Exceptions in WebGL Player Settings).  We found that for small functions, this variable increases resource costs and negatively affects performance.  Therefore, we never add this code for iOS and other platforms where you can get stack trace information without it.  The WebGL platform does not support stack tracing, so you need to allow managed code exceptions to work correctly. <br><br>  The second part of the prologue runs a ‚Äúlazy‚Äù initialization of the metadata type for any array or generic types used in the method body.  Thus, ObjectU5BU5D_t4 is the name of the type System.Object [].  This part of the prologue is executed only once and does not do anything if the type has already been initialized, so no negative effect on performance was noticed. <br><br>  What about streaming security?  What if two threads call Vector3 :: ToString () at the same time?  It's okay: all the code in the libil2cpp environment used to initialize the type is safe to call from multiple threads.  Most likely, the il2cpp_codegen_class_from_type function will be called several times, but in fact it will work only once, in one thread.  Method execution will not resume until initialization completes.  Therefore, this method prolog is thread safe. <br><br>  <b>Runtime Checks</b> <br><br>  The next part of the method creates an array of objects, saves the value of the X field for Vector3 into a local variable, then packages this variable and adds it to the array with a zero index.  The generated C ++ code (with comments) looks like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Create a new single-dimension, zero-based object array ObjectU5BU5D_t4* L_0 = ((ObjectU5BU5D_t4*)SZArrayNew(ObjectU5BU5D_t4_il2cpp_TypeInfo_var, 3)); // Store the Vector3::x field in a local float L_1 = (__this-&gt;___x_1); float L_2 = L_1; // Box the float instance, since it is a value type. Object_t * L_3 = Box(InitializedTypeInfo(&amp;Single_t264_il2cpp_TypeInfo), &amp;L_2); // Here are three important runtime checks NullCheck(L_0); IL2CPP_ARRAY_BOUNDS_CHECK(L_0, 0); ArrayElementTypeCheck (L_0, L_3); // Store the boxed value in the array at index 0 *((Object_t **)(Object_t **)SZArrayLdElema(L_0, 0)) = (Object_t *)L_3;</span></span></code> </pre><br><br>  Il2cpp.exe adds 3 checks that are missing from the IL code: <br><br>  ‚Ä¢ If the array value is NULL, the NullCheck check throws a NullReferenceException exception. <br>  ‚Ä¢ If the array index is incorrect, the IL2CPP_ARRAY_BOUNDS_CHECK check throws an IndexOutOfRangeException exception. <br>  ‚Ä¢ If the type of the element added to the array is incorrect, ArrayElementTypeCheck throws an ArrayTypeMismatchException exception. <br><br>  These run-time checks ensure that the data for the .NET virtual machine is correct.  Instead of embedding code, Mono uses target platform mechanisms to handle the same checks.  In the case of IL2CPP, we wanted to cover as many platforms as possible, including such as WebGL, which do not have their own verification mechanism.  Therefore, the il2cpp.exe utility injects these checks itself. <br><br>  Do these tests create performance problems?  In most cases, no problems were noticed.  Moreover, checks provide additional benefits and security for the .NET virtual machine.  In some individual cases, we still recorded a decrease in performance, especially in continuous cycles.  Now we are trying to find a way to allow managed code to remove dynamic checks when il2cpp.exe generates C ++ code.  Keep for updates. <br><br>  <b>Static fields</b> <br><br>  Now that we have seen how the fields of the instance look like (using the example of Vector3), let's see how static fields are transformed and how they are accessed.  First we find the definition of the HelloWorld_Start_m3 method, which is in the Bulk_Assembly-CSharp_0.cpp file in my assembly, and then go to the type Important_t1 (in the AssemblyU2DCSharp_HelloWorld_Important.h file): <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Important_t1</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object_t { <span class="hljs-comment"><span class="hljs-comment">// System.Int32 HelloWorld/Important::InstanceIdentifier int32_t ___InstanceIdentifier_1; }; struct Important_t1_StaticFields { // System.Int32 HelloWorld/Important::ClassIdentifier int32_t ___ClassIdentifier_0; };</span></span></code> </pre><br><br>  Note that il2cpp.exe created a separate C ++ structure to provide a static field that is accessible to all instances of this type.  Thus, at run time, one instance of type Important_t1_StaticFields will be created, and all instances of type Important_t1 will use it as a static field.  In the generated code, access to a static field is as follows: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> L_1 = (((Important_t1_StaticFields*)InitializedTypeInfo(&amp;Important_t1_il2cpp_TypeInfo)-&gt;static_fields)-&gt;___ClassIdentifier_0);</code> </pre><br><br>  The type metadata for Important_t1 contains a pointer to a single instance of type Important_t1_StaticFields, as well as the information that this instance is used to get the value of a static field. <br><br>  <b>Exceptions</b> <br><br>  Il2cpp.exe converts managed exceptions to C ++ exceptions.  We chose this approach so that, again, not to depend on specific platforms.  When il2cpp.exe needs to generate code to create a managed exception, it calls the il2cpp_codegen_raise_exception function.  The call and interception code for managed exceptions in our HelloWorld_Start_m3 method looks like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// begin try (depth: 1) InvalidOperationException_t7 * L_17 = (InvalidOperationException_t7 *)il2cpp_codegen_object_new (InitializedTypeInfo(&amp;InvalidOperationException_t7_il2cpp_TypeInfo)); InvalidOperationException__ctor_m8(L_17, (String_t*) &amp;_stringLiteral5, /*hidden argument*/&amp;InvalidOperationException__ctor_m8_MethodInfo); il2cpp_codegen_raise_exception(L_17); // IL_0092: leave IL_00a8 goto IL_00a8; } // end try (depth: 1) catch(Il2CppExceptionWrapper&amp; e) { __exception_local = (Exception_t8 *)e.ex; if(il2cpp_codegen_class_is_assignable_from (&amp;InvalidOperationException_t7_il2cpp_TypeInfo, e.ex-&gt;object.klass)) goto IL_0097; throw e; } IL_0097: { // begin catch(System.InvalidOperationException) V_1 = ((InvalidOperationException_t7 *)__exception_local); NullCheck(V_1); String_t* L_18 = (String_t*)VirtFuncInvoker0&lt; String_t* &gt;::Invoke(&amp;Exception_get_Message_m9_MethodInfo, V_1); Debug_Log_m6(NULL /*static, unused*/, L_18, /*hidden argument*/&amp;Debug_Log_m6_MethodInfo); // IL_00a3: leave IL_00a8 goto IL_00a8; } // end catch (depth: 1)</span></span></code> </pre><br><br>  All managed exceptions are wrapped in a type of Il2CppExceptionWrapper.  When the generated code intercepts an exception of this type, it unpacks its C ++ representation (which is of type Exception_t8).  In this case, we are only looking for InvalidOperationException, so if we don‚Äôt find an exception of this type, C ++ will throw a copy of it again.  If we find an exception of this type, the code will start the interception handler and display an exception message. <br><br>  <b>Goto ?!</b> <br><br>  An interesting question arises: what do goto labels and operators do here?  These constructs need not be used in structured programming.  The fact is that the IL language does not use the principles of structured programming, such as cycles and conditional statements.  This is a low-level language, so il2cpp.exe follows low-level concepts in the generated code. <br><br>  As an example, consider the for loop in the HelloWorld_Start_m3 method: <br><br><pre> <code class="cpp hljs">IL_00a8: { V_2 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> IL_00cc; } IL_00af: { ObjectU5BU5D_t4* L_19 = ((ObjectU5BU5D_t4*)SZArrayNew(ObjectU5BU5D_t4_il2cpp_TypeInfo_var, <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> L_20 = V_2; Object_t * L_21 = Box(InitializedTypeInfo(&amp;Int32_t5_il2cpp_TypeInfo), &amp;L_20); NullCheck(L_19); IL2CPP_ARRAY_BOUNDS_CHECK(L_19, <span class="hljs-number"><span class="hljs-number">0</span></span>); ArrayElementTypeCheck (L_19, L_21); *((Object_t **)(Object_t **)SZArrayLdElema(L_19, <span class="hljs-number"><span class="hljs-number">0</span></span>)) = (Object_t *)L_21; Debug_LogFormat_m7(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*static, unused*/</span></span>, (String_t*) &amp;_stringLiteral6, L_19, <span class="hljs-comment"><span class="hljs-comment">/*hidden argument*/</span></span>&amp;Debug_LogFormat_m7_MethodInfo); V_2 = ((<span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span>)(V_2+<span class="hljs-number"><span class="hljs-number">1</span></span>)); } IL_00cc: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((((<span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span>)V_2) &lt; ((<span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span>)<span class="hljs-number"><span class="hljs-number">3</span></span>))) { <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> IL_00af; } }</code> </pre><br><br>  The variable V_2 is the loop index.  At the beginning it has a value of 0, then it increases at the bottom of the loop in this line: <br><br><pre> <code class="cpp hljs">V_2 = ((<span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span>)(V_2+<span class="hljs-number"><span class="hljs-number">1</span></span>));</code> </pre><br><br>  The end of cycle condition is checked here: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((((<span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span>)V_2) &lt; ((<span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span>)<span class="hljs-number"><span class="hljs-number">3</span></span>)))</code> </pre><br><br>  While V_2 is less than three, the goto statement goes to the IL_00af label, which is the upper part of the loop body.  As you might have guessed, at the moment il2cpp.exe generates C ++ code directly from IL without using the intermediate abstract representation of the syntax tree.  You may also have noticed that in the "Runtime Checks" section there are such fragments in the code: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> L_1 = (__this-&gt;___x_1); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> L_2 = L_1;</code> </pre><br><br>  Obviously, the variable L_2 is superfluous here.  Despite the fact that it is eliminated in most C ++ compilers, we would like to avoid its appearance in the code at all.  We are now considering the possibility of using an abstract syntax tree to better understand IL code and generate the best C ++ code for cases when local variables and loops are used. <br><br>  <b>Conclusion</b> <br><br>  We have touched on only a small part of the C ++ code generated by IL2CPP for a very simple project.  Now I recommend that you take a look at the generated code of your own project.  Keep in mind that in future versions of Unity, C ++ code will look different as we continue to improve the quality and performance of the IL2CPP technology. <br><br>  By converting the IL code to C ++, we managed to achieve a good balance between its portability and performance.  We have received many useful functions for developers of managed code, while retaining the advantages of machine code, which the C ++ compiler provides for various platforms. <br><br>  In future posts, we will talk about the generated code in more detail: consider the method calls and the distribution of their implementations and wrappers for calling native libraries.  And next time we will debug the generated code for the 64-bit version of iOS using Xcode. </div><p>Source: <a href="https://habr.com/ru/post/280824/">https://habr.com/ru/post/280824/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280814/index.html">Framework fastcgi container</a></li>
<li><a href="../280816/index.html">About the UHD-resolution restaurant table and other interactive technologies from Kodisoft</a></li>
<li><a href="../280818/index.html">As I wrote the library under IEC 870-5-104 on Arduino using Wireshark</a></li>
<li><a href="../280820/index.html">The digest of interesting materials from the world of MODX # 1</a></li>
<li><a href="../280822/index.html">Reading large amounts of data in Python / Postgresql</a></li>
<li><a href="../280826/index.html">Announcement of the Russian-language catalog of solutions of independent developers certified for Microsoft Azure</a></li>
<li><a href="../280828/index.html">New big css book</a></li>
<li><a href="../280830/index.html">RING buffer - 2D case</a></li>
<li><a href="../280832/index.html">Critical vulnerability in TrendMicro antivirus allows remote code execution</a></li>
<li><a href="../280834/index.html">Difficult integrity constraint</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>