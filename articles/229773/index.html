<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Android "Evolution": how it was</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! My name is Alexander Grishin, I work in the studio IT-Territory (Mail.Ru Group) as a testing specialist. I am developing the Android version of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Android "Evolution": how it was</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/company/mailru/blog/229773/"><img src="https://habrastorage.org/getpro/habr/post_images/1a1/e41/cc1/1a1e41cc18aee1abfe7744d93da514af.png"></a> <br><br>  Hello!  My name is Alexander Grishin, I work in the studio IT-Territory (Mail.Ru Group) as a testing specialist.  I am developing the Android version of Evolution: The Battle for Utopia.  The iOS audience greeted the novelty with interest this spring, and we are already preparing for the first impressions of Android users.  In the article I will talk about how we ported the game to Android and what difficulties and nuances we encountered in the process. <br><a name="habracut"></a><br><h1>  Evolution on iOS </h1>  If you look at mobile games in general, now there are few projects on the market that are similar to Evolution - large, complex, costly, requiring a large team to be developed.  Creating games with so many mechanics, each of which, in fact, is a separate minigame, the process is long and painstaking: you need not only to do them, but then also to connect, grind to each other, to make everything work together as it should and caused the user interest, not bewilderment.  There are few such games even on iOS, for which studios are more willing to create games, and almost none on Android. <br><br><div class="spoiler">  <b class="spoiler_title">Lyrical digression</b> <div class="spoiler_text">  Evolution was released in Russia on January 31, 2014, on March 19 it was presented to a global audience at the Game Developers Conference, which was held this spring in San Francisco, and on April 2 an international release took place.  The game entered the top ten games for the iPad in 30 countries - and this despite the fact that Evolution entered the market almost simultaneously with Hearthstone from Blizzard Entertainment, which the fans were looking forward to.  Today more than 73,000 players from 198 countries of the world come to our game every day.  More than 41% of the players live in Russia, more than 20% in the USA, and another 5.7% are in the UK. </div></div><br><img src="https://habrastorage.org/getpro/habr/post_images/195/eb7/b0c/195eb7b0c642be750892b62e6d75e698.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Complex diversity </h1>  Android is a specific platform.  To begin with at least the fact that iOS has only five screen resolutions, which, of course, makes the development of the application easier.  In Android, the number of permissions goes to hundreds, if not thousands.  From a technical point of view, when drawing a graphical interface for this platform, it is tied to the corners.  But sometimes it is stretched, rather than drawing a pixel into a pixel - for example, backgrounds, why the graphics suffer or the proportions are violated.  In iOS, we always know how the picture will look like;  in Android, things are not so simple. <br><br>  On the market of Android devices there are a lot of different models with different performance, but here it is easier to control the installation on various devices;  for example, in iOS it is difficult to limit the devices on which the application can run.  You can note in the description of the application that the fourth-generation iPhone does not support it.  In this case, it runs on these devices, you can play it, but, in principle, no one guarantees that it will not fly out or do something else not according to plan.  In Android, you can specify specific devices for which people download the game, and upload a lot of distributions for different graphics chips. <br><br>  For iOS, we lay out a single distribution.  Some post two, one for tablets and another for smartphones.  Android needs different distros, which are built depending on the chip, texture compression and other parameters.  In some games it is necessary to make about 5-6 different assemblies, which, of course, complicates the application deployment process.  When several distributions are made for different GPUs, we upload them to Google Play;  when the client downloads the application, the digital store itself selects the build for the device's GPU and issues it. <br><br>  All iPhone graphics chips belong to the same PowerVR family, so we can always predict game performance very accurately.  There are four common graphics chips on Android that work quite differently.  We were faced with the fact that the application on this platform was so slow that we had to redo the shaders, reduce their quality or disable them altogether.  In Android, the speculator is considered to be in the vertex shader, and in iOS it is considered in pixel.  So we used the standard method of increasing the performance at the cost of some deterioration of the picture - transferring the calculations from the pixel shader to the vertex one. <br><br>  Another difficulty that we encountered when porting Evolution: on Android, there is no alpha-compatible texture compression format compatible with all devices (ETC1 (4bit) vs PVRTC4 / 2 (4/2 bit with alpha). Uncompressed textures are not just extra memory waste and increased application size, but also longer application loading and performance loss. From a technical point of view, the lack of texture compression with the alpha channel is a very, very big limitation of the Android platform.The standard graphics API OpenGL ES 2.0. single format ET  C1, which is already out of date and does not contain an alpha channel. On iOS there is a very good graphics chip: in addition to the fact that textures with it take up less memory, they also load faster. When you overload scenes with a lot of textures in the game, on iOS it happens instantly, and on Android with a noticeable delay, which in our case reached 1.5 seconds, but, alas, we had to work with what we have, or use compression formats specific for a specific hardware platform: PVRTC, DXT, ATC, ETC.  In principle, the problem of compression with the alpha channel Android developers are planning to solve in the following standard OpenGL ES 3.0: there will appear a good advanced compression format (ASTC), and it will immediately become easier for everyone to live. <br><br>  These are the main difficulties when porting an application from iOS to Android.  There were other problems, such as the size limit APK.  In Android, this figure is 50 Mb, while on iOS, restrictions exist only for cellular downloads.  The iOS version of the game is a single file of approximately 420 MB;  On Android, the game is broken down into a small APK file, which subsequently loads the large OBB file that contains the game.  However, Unity does most of the work for you. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5ef/f0e/f1b/5eff0ef1b97f67dc393969f3b93b308b.jpg"><br><br><h1>  How was it with us </h1>  We can say, historically, that first of all we are developing a game for Apple devices and then porting it.  Of course, you can develop the game immediately under the two platforms, and you can under the three.  "Juggernaut: Revenge of Sovering", for example, we also released just under the desktop MAC or OSX. <br><br>  Porting from iOS to Android is greatly simplified if the game is made under Unity.  It is enough just to run it on a new platform - and it becomes immediately obvious where you need to go through the file and what needs to be completed so that the result looks normal.  If the game is not under Unity, then I have bad news: in fact, you have to re-write it. <br><br>  It took us about two months to port ‚ÄúEvolution‚Äù to Android.  As I said, the game is very difficult, both for development and porting.  The fact is that several different gameplays are combined in it.  Characters move around the map, fight monsters, solve riddles - each of these activities has its own interface, its own mechanics.  And, of course, all this stuff is loaded right during the game session - that is, it was important for us that Evolution continued to ‚Äúfly‚Äù after being transferred to a new platform. <br><br>  The biggest problem we faced was sustaining the same combat performance that the game had on iOS.  To achieve this, we wrote new shaders, which gave the necessary increase in speed, slightly worsening the picture.  We even managed to save the ‚Äúhonest‚Äù shadows from the characters!  There was practically no need to redo graphic assets (scenes, models, animations). <br><br>  The second large (and even more labor-intensive) part of the work is the 2D part of the game, which in Evolution is even more than 3D.  Thousands of Android screen resolutions (against just a few for iOS) and the absence of such a wonderful texture compression format as PVRTC (available on any iOS device), lead to a lot of hard work.  In the "Evolution" dozens of screens, backgrounds, flipbook-animations (flip book) and thousands of sprites, packed in dozens of atlases.  Then I had to compress something, stretch something, repack something. <br><br>  With all the changes that the graphics undergoes during the porting, the weight of the game changes - for the worse for Android.  On iOS, the graphics are compressed 8 times.  There is a completely wonderful algorithm PVRTC4, which allows you to make very decent 4-bit quality from 32-bit graphics with alpha channel.  Since not all graphics on Android manage to compress as well as on iOS, it takes up more disk space. <br><br>  Many where manual tuning was required;  in spite of the fact that we chose a certain general solution, we had to do a lot of things with our own hands.  For example, the already mentioned problem with different screens: I had to take into account this feature of Android and somehow solve the situation.  Of course, it was not necessary to rewrite everything for every possible small screen.  On iOS, we had only two scales, both multiples of two - that is why we didn‚Äôt have any particular problems with violation of proportions and blurring of graphics.  As a rule, Android takes some kind of medium resolution, and everything else scales under it.  The change in resolution primarily affects the two-dimensional graphics: we have to include various interface elements, buttons, and so on.  I had to sort through these parts manually, pinch the textures, resize the graphic elements in the main interface. <br><br>  In total, we made four distros for Evolution.  In this case, we later had to abandon one of them - the game does not yet support Tegra.  In general, the porting on Tegra, especially the older generations, is a whole adventure.  As a rule, when people can port a graphically intensive 3D game to Tegra, they then go somewhere to a professional conference and make a report about it.  This is a jewelry and specific work, when the developer is trying to increase fps from 10 to 30, simply by changing the order of drawing different objects on the screen. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cfa/82b/37a/cfa82b37aa435d22d48e0bfb263466fe.jpg"><br><br><h1>  Modern mobile GPU aerial view </h1> All GPUs on the mobile market work a little differently.  They can be divided into 3 classes: tile-based deferred rendering (TBDR) - PowerVR;  tile-based rendering (TBR) - Adreno, Mali and immediate mode rendering (IMR) - Tegra. <br><br>  PowerVR with its TBDR is the most different from IMR, which is the usual solution for desktops.  PowerVR works like this: it breaks the entire screen into small tiles of 16x16 pixels and draws all the geometry that fell into this tile.  This happens in ultrafast memory inside the chip.  In the process of drawing, it discards all the pixels that will not be visible in the final image (for example, overlapped by other opaque objects), and then textures and calculates the lighting only for those pixels that are exactly visible on the screen.  To date, this is one of the most economical and fast solutions, and although it has its own set of drawbacks, from the point of view of mobile game developers, it is the most optimal.  Of the obvious advantages, it very quickly does alpha blending, anti-aliasing, texture filtering and is completely insensitive to the order of rendering opaque objects, mip mapping and so on, and the wonderful compression format PVRTC further reduces the load on the memory.  In other words, developers do not need to optimize anything - you just need to stick to a certain budget for the number of vertices, not to overuse transparency and not to use an alpha test that breaks the entire TBDR process. <br><br>  IMR draws everything using only approximate optimization of cutting off invisible surfaces (Early Z-cull), therefore it is very sensitive to the order of rendering opaque objects.  Unity here, unfortunately, cannot help anything - the developer must figure out which objects on the stage will take up more screen space, and tell Unity to draw them first (render queue).  As all pixels are shaded, pixel shaders get more work. <br><br>  TBR chips work in much the same way as IMR, but they break the screen into tiles to reduce the memory load. <br><br>  NVIDIA continues to release new types, soon there will be Tegra K1, so this is quite an interesting direction, but, unfortunately, there is a completely different approach, and because of this there will still be some difference when porting.  From the small details: for example, if you disable mipmap on all textures in iOS, then performance drops by 2-3 fps.  If this is done on Android, then the performance drops by a whole order.  There are a lot of these subtleties: if you are going to optimize the game for each of the chips, then be ready to study thicker manuals on optimization from the manufacturers, long profiling and experiments.  Someone does this work and then reads a report at the conference;  we decided not to dig so deep, but simply chose a list of devices for which we were going to develop distributions, tested the result and uploaded the successful versions to the store.  Alas, not everyone with Android devices will be able to play Evolution, but we ‚Äúcovered up‚Äù the maximum possible number of devices.  In general, the game supports approximately 1000 mobile devices with Android. <br><br>  That's the whole story.  Thank you for your attention, if you have questions - ask in the comments, with pleasure I will answer them. </div><p>Source: <a href="https://habr.com/ru/post/229773/">https://habr.com/ru/post/229773/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../229757/index.html">Search and analysis of the optimal color space for the construction of eye-catching objects on a given class of images</a></li>
<li><a href="../229761/index.html">Fail story of SaaS Helpdesk for small business</a></li>
<li><a href="../229763/index.html">YaLinqo (LINQ to Objects for PHP) - version 2.0</a></li>
<li><a href="../229765/index.html">Juniper SRX Series Basic Setup</a></li>
<li><a href="../229767/index.html">Efficient multithreading in Python</a></li>
<li><a href="../229777/index.html">How to communicate with the 36-year-old space probe using GNU Radio</a></li>
<li><a href="../229779/index.html">Weka project for the task of recognition of tonality (sentiment)</a></li>
<li><a href="../229781/index.html">To help the school sysadmin</a></li>
<li><a href="../229783/index.html">Android game development</a></li>
<li><a href="../229797/index.html">Vladimir Stasevich (Bank XXI, Sberbank): "We must prepare and prepare for the next stage of evolution - mass mobile banking"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>