<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Extension of Page / MasterPage / UserControl tag functionality in ASP.NET MVC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I began to translate an old samopisny engine with PHP to ASP.NET and faced with several points related to Smarty templates and ASP.NET MVC p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Extension of Page / MasterPage / UserControl tag functionality in ASP.NET MVC</h1><div class="post__text post__text-html js-mediator-article">  Recently, I began to translate an old samopisny engine with PHP to ASP.NET and faced with several points related to Smarty templates and ASP.NET MVC presentation capabilities.  At once I will make a reservation that the approach can also be applied to web projects, but there may need to be finished.  So. <br><br>  First, from the very beginning it became necessary to refer to the methods of the main object of the web application (let's call it Main) from the template ‚Äî for example, the configuration, the manager of the object, the methods of the calling controller, and so on.  The standard class System.Web.Mvc.ViewPage does not provide convenient functionality for this.  Of course, you can get to the ViewContext.Controller property, do a type conversion and work in a template with the code like &lt;% = ((IndexController) ViewContext.Controller) .CurrentTheme.Name%&gt;, but then the question arises about the readability of the code and the convenience of writing it in general.  I went along the path of expanding the functionality of System.Web.Mvc.ViewPage (along with System.Web.Mvc.MasterPage and System.Web.Mvc.UserControl) and adding the ControlHelper property to it, which returns a helper object that makes the necessary features available. <br><br>  Secondly, it became necessary for representations not to set the direct path of MasterPageFile, but to mark it with additional tags a la ‚ÄúCurrentTheme.SiteMaster‚Äù, ‚ÄúUserTheme.SiteMaster‚Äù, etc.  Unfortunately, when writing a similar string to the MasterPageFile attribute of the <a href="https://habrahabr.ru/users/page/" class="user_link">Page</a> directive, I received an error from the parser, complaining about the absence of the file "~ / Views / {CurrentTheme.SiteMaster}".  The only solution found is to create your own attribute for the <a href="https://habrahabr.ru/users/page/" class="user_link">Page</a> directive, for example MasterPagePath: <br><pre><code class="cs hljs">&lt;%@ Page Language=<span class="hljs-string"><span class="hljs-string">"C#"</span></span> MasterPagePath=<span class="hljs-string"><span class="hljs-string">"{CurrentTheme.SiteMaster}"</span></span> Inherits=<span class="hljs-string"><span class="hljs-string">"..."</span></span> %&gt;</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>  In connection with the second point a nuance arose, which I will discuss later. <br><br>  Suppose we have an MVC application project, we created the HomeController controller with one Index method, created the Site1.Master home page, created Views / Home / Index.aspx view inheriting from the Site1.Master home page. <br><pre> <code class="cs hljs">&lt;%@ Page Title=<span class="hljs-string"><span class="hljs-string">""</span></span> Language=<span class="hljs-string"><span class="hljs-string">"C#"</span></span> MasterPageFile=<span class="hljs-string"><span class="hljs-string">"~/Views/Site1.Master"</span></span> Inherits=<span class="hljs-string"><span class="hljs-string">"MvcHelperApplication.Inc.Types.ViewPage"</span></span> %&gt; &lt;asp:Content ID=<span class="hljs-string"><span class="hljs-string">"Content1"</span></span> ContentPlaceHolderID=<span class="hljs-string"><span class="hljs-string">"ContentPlaceHolder1"</span></span> runat=<span class="hljs-string"><span class="hljs-string">"server"</span></span>&gt;&lt;h2&gt;Index&lt;/h2&gt;&lt;/asp:Content&gt; &lt;asp:Content ID=<span class="hljs-string"><span class="hljs-string">"Content2"</span></span> ContentPlaceHolderID=<span class="hljs-string"><span class="hljs-string">"head"</span></span> runat=<span class="hljs-string"><span class="hljs-string">"server"</span></span>&gt; &lt;/asp:Content&gt;</code> </pre> <br><br>  Then we change the <a href="https://habrahabr.ru/users/page/" class="user_link">Page</a> directive in accordance with our requirement: <br><pre> <code class="cs hljs">&lt;%@ Page Title=<span class="hljs-string"><span class="hljs-string">""</span></span> Language=<span class="hljs-string"><span class="hljs-string">"C#"</span></span> MasterPagePath=<span class="hljs-string"><span class="hljs-string">"{CurrentMasterPath}"</span></span> Inherits=<span class="hljs-string"><span class="hljs-string">"MvcHelperApplication.Inc.Types.ViewPage"</span></span> %&gt;</code> </pre> <br><br>  MvcHelperApplication.Inc.Types.ViewPage is the future class of the page, which we will write below. <br><br>  First, let's write a simple helper class that does only one thing - it handles the PreInit event of the page and sets the value of its MasterPageFile attribute based on the custom attribute MasterPagePath. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MvcHelperApplication.Inc</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ControlHelper</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Types.ViewPage mPage = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ControlHelper</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Types.ViewPage page</span></span></span><span class="hljs-function">)</span></span> { mPage = page; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">page_PreInit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mPage.MasterPagePath != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; mPage.MasterPagePath == <span class="hljs-string"><span class="hljs-string">"{CurrentMasterPath}"</span></span>) { mPage.MasterPageFile = <span class="hljs-string"><span class="hljs-string">"~/Views/Site1.Master"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { } } } }</code> </pre> <br><br>  Everything should be clear here, this moment does not contain surprises and pitfalls.  If there is a MasterPagePath tag in the <a href="https://habrahabr.ru/users/page/" class="user_link">Page</a> directive, it is processed and, if it is equal to "{CurrentMasterPath}", then the MasterPageFile property is set to the path to the existing masterpage. <br><br>  Create a ViewPage class: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web.Mvc; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web.Mvc.Html; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web.UI; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Diagnostics.CodeAnalysis; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MvcHelperApplication.Inc.Types</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ViewPage</span></span> : <span class="hljs-title"><span class="hljs-title">System</span></span>.<span class="hljs-title"><span class="hljs-title">Web</span></span>.<span class="hljs-title"><span class="hljs-title">Mvc</span></span>.<span class="hljs-title"><span class="hljs-title">ViewPage</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _masterpagepath = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> MasterPagePath { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _masterpagepath; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { _masterpagepath = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ViewPage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.PreInit += <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EventHandler(ControlHelper.page_PreInit); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ControlHelper mControlHelper = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ControlHelper ControlHelper { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mControlHelper == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) mControlHelper = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ControlHelper(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mControlHelper; } } } }</code> </pre> <br><br>  Parse in order. <br>  1) MasterPagePath is the property through which the class will get the value of the MasterPagePath attribute from the <a href="https://habrahabr.ru/users/page/" class="user_link">Page</a> directive. <br>  2) ViewPage is a constructor, in it the page_PreInit method of our helper class is bound to the PreInit event. <br>  3) ControlHelper is the property itself for accessing the object of the helper class. <br><br>  We start debugging and see on the page the beautiful word Index.  If you wish, you can follow the process of the script. <br><br>  Great, we can now set our own path to MasterPageFile in any way.  Plus, the issue was resolved with access to themes, configuration, etc.  - it is enough to expand the ControlHelper class and access the configuration through it.  For example: <br><pre> <code class="cs hljs">&lt;%=ControlHelper.Config%&gt; &lt;%=ControlHelper.Themes.Current%&gt;</code> </pre> <br>  etc. <br><br>  It would seem that everything is great.  But no, ASP.NET prepared a very ugly dog, because of which it was necessary to spend a day digging on the net.  The fact is that the ASP.NET parser does not support generic types in overloaded classes by default.  This means that if in Index.aspx instead of Inherits = "MvcHelperApplication.Inc.Types.ViewPage" write Inherits = "MvcHelperApplication.Inc.Types.ViewPage" (i.e., apply the model to the view, which is why and all the fuss stuffed with MVC is started, then we get an error: <br><pre> <code class="cs hljs">:    ,     .            .     :     <span class="hljs-string"><span class="hljs-string">'masterpagepath'</span></span>:  <span class="hljs-string"><span class="hljs-string">'System.Web.Mvc.ViewPage'</span></span>      <span class="hljs-string"><span class="hljs-string">'masterpagepath'</span></span>.  :  <span class="hljs-number"><span class="hljs-number">1</span></span>: &lt;%@ Page Title=<span class="hljs-string"><span class="hljs-string">""</span></span> Language=<span class="hljs-string"><span class="hljs-string">"C#"</span></span> MasterPagePath=<span class="hljs-string"><span class="hljs-string">"{CurrentMasterPath}"</span></span> Inherits=<span class="hljs-string"><span class="hljs-string">"MvcHelperApplication.Inc.Types.ViewPage&lt;dynamic&gt;"</span></span> %&gt;</code> </pre><br><br>  Let‚Äôs try to calmly change the description of the ViewPage class to the following: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ViewPage</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TModel</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">System</span></span>.<span class="hljs-title"><span class="hljs-title">Web</span></span>.<span class="hljs-title"><span class="hljs-title">Mvc</span></span>.<span class="hljs-title"><span class="hljs-title">ViewPage</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TModel</span></span>&gt;</code> </pre> <br><br>  We compile, update and get the same error. <br><br>  In general, in order to slip a generic type to the parser, you will have to use such a thing as pageParserFilterType.  In the Web.config section in the &lt;system.web&gt; section the following is written: <br><pre> <code class="cs hljs">&lt;pages validateRequest=<span class="hljs-string"><span class="hljs-string">"false"</span></span> pageParserFilterType=<span class="hljs-string"><span class="hljs-string">"MvcHelperApplication.Inc.ViewTypeParserFilter"</span></span> pageBaseType=<span class="hljs-string"><span class="hljs-string">"MvcHelperApplication.Inc.Types.ViewPage"</span></span>&gt;</code> </pre><br><br>  Create a ViewTypeParserFilter: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web.UI; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web.Mvc; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.CodeDom; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web.UI; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MvcHelperApplication.Inc</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ViewTypeParserFilter</span></span> : <span class="hljs-title"><span class="hljs-title">PageParserFilter</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _viewBaseType; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DirectiveType _directiveType = DirectiveType.Unknown; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _viewTypeControlAdded; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PreprocessDirective</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> directiveName, IDictionary attributes</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.PreprocessDirective(directiveName, attributes); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> defaultBaseType = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (directiveName) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"page"</span></span>: _directiveType = DirectiveType.Page; defaultBaseType = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Types.ViewPage).FullName; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"control"</span></span>: _directiveType = DirectiveType.UserControl; defaultBaseType = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(System.Web.Mvc.ViewUserControl).FullName; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"master"</span></span>: _directiveType = DirectiveType.Master; defaultBaseType = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(System.Web.Mvc.ViewMasterPage).FullName; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_directiveType == DirectiveType.Unknown) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> inherits = (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)attributes[<span class="hljs-string"><span class="hljs-string">"inherits"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!String.IsNullOrEmpty(inherits)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsGenericTypeString(inherits)) { attributes[<span class="hljs-string"><span class="hljs-string">"inherits"</span></span>] = defaultBaseType; _viewBaseType = inherits; } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsGenericTypeString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> typeName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> typeName.IndexOfAny(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[] { <span class="hljs-string"><span class="hljs-string">'&lt;'</span></span>, <span class="hljs-string"><span class="hljs-string">'('</span></span> }) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ParseComplete</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ControlBuilder rootBuilder</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.ParseComplete(rootBuilder); ViewPageControlBuilder pageBuilder = rootBuilder <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ViewPageControlBuilder; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pageBuilder != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { pageBuilder.PageBaseType = _viewBaseType; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessCodeConstruct</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CodeConstructType codeType, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> code</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codeType == CodeConstructType.ExpressionSnippet &amp;&amp; !_viewTypeControlAdded &amp;&amp; _viewBaseType != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; _directiveType == DirectiveType.Master) { Hashtable attribs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Hashtable(); attribs[<span class="hljs-string"><span class="hljs-string">"typename"</span></span>] = _viewBaseType; AddControl(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(System.Web.Mvc.ViewType), attribs); _viewTypeControlAdded = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.ProcessCodeConstruct(codeType, code); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> AllowCode { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>;} } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AllowBaseType</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type baseType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AllowControl</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type controlType, ControlBuilder builder</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AllowVirtualReference</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> referenceVirtualPath, VirtualReferenceType referenceType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AllowServerSideInclude</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> includeVirtualPath</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> NumberOfControlsAllowed { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>;} } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> NumberOfDirectDependenciesAllowed { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>;} } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TotalNumberOfDependenciesAllowed { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>;} } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> DirectiveType { Unknown, Page, UserControl, Master, } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ViewPageControlBuilder</span></span> : <span class="hljs-title"><span class="hljs-title">FileLevelPageControlBuilder</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PageBaseType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessGeneratedCode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> CodeCompileUnit codeCompileUnit, CodeTypeDeclaration baseType, CodeTypeDeclaration derivedType, CodeMemberMethod buildMethod, CodeMemberMethod dataBindingMethod</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PageBaseType != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { derivedType.BaseTypes[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CodeTypeReference(PageBaseType); } } } }</code> </pre> <br><br>  Change the file ViewPage.cs <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web.Mvc; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web.Mvc.Html; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web.UI; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Diagnostics.CodeAnalysis; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MvcHelperApplication.Inc.Types</span></span> { [FileLevelControlBuilder(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ViewPageControlBuilder))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ViewPage</span></span> : <span class="hljs-title"><span class="hljs-title">System</span></span>.<span class="hljs-title"><span class="hljs-title">Web</span></span>.<span class="hljs-title"><span class="hljs-title">Mvc</span></span>.<span class="hljs-title"><span class="hljs-title">ViewPage</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _masterpagepath = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> MasterPagePath { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _masterpagepath; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { _masterpagepath = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ViewPage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.PreInit += <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EventHandler(ControlHelper.page_PreInit); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ControlHelper mControlHelper = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ControlHelper ControlHelper { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mControlHelper == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) mControlHelper = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ControlHelper(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mControlHelper; } } } [FileLevelControlBuilder(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ViewPageControlBuilder))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ViewPage</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TModel</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">ViewPage</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TModel</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span> { <span class="hljs-comment"><span class="hljs-comment">// code copied from source of ViewPage&lt;T&gt; private ViewDataDictionary&lt;TModel&gt; _viewData; public new AjaxHelper&lt;TModel&gt; Ajax { get; set; } public new HtmlHelper&lt;TModel&gt; Html { get; set; } public new TModel Model { get { return ViewData.Model; } } [SuppressMessage("Microsoft.Usage", "CA2227:CollectionPropertiesShouldBeReadOnly")] public new ViewDataDictionary&lt;TModel&gt; ViewData { get { if (_viewData == null) { SetViewData(new ViewDataDictionary&lt;TModel&gt;()); } return _viewData; } set { SetViewData(value); } } public override void InitHelpers() { base.InitHelpers(); Ajax = new AjaxHelper&lt;TModel&gt;(ViewContext, this); Html = new HtmlHelper&lt;TModel&gt;(ViewContext, this); } protected override void SetViewData(ViewDataDictionary viewData) { _viewData = new ViewDataDictionary&lt;TModel&gt;(viewData); base.SetViewData(_viewData); } } }</span></span></code> </pre> <br><br>  Compile - see the wonderful word Index in the browser. <br>  There is a small nuance associated with Web.config files in view folders.  The Views / Web.config file is best removed, because  it will overwrite the changes to the pages tag in the main website web.config. <br><br>  With the help of ViewTypeParserFilter, you can use your own ViewPage, ViewUserControl, ViewMaserPage classes.  Just in case, the remark - in the pages tag in the configuration file there is an opportunity to set the basic types pagesBaseType and userControlBaseType, but there is no possibility to set the masterpageBaseType.  You should not be afraid, it works without it. </div><p>Source: <a href="https://habr.com/ru/post/134843/">https://habr.com/ru/post/134843/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134837/index.html">In Russia, they can not only program</a></li>
<li><a href="../134838/index.html">Data on metadata: on the question of indexing technical drawings</a></li>
<li><a href="../134839/index.html">Installing TWRP 2.0 on Amazon Kindle Fire</a></li>
<li><a href="../134840/index.html">Groupon began to provide 10-dollar bonuses to local US customers.</a></li>
<li><a href="../134842/index.html">Hangouts on Google+ updated</a></li>
<li><a href="../134844/index.html">Getting ROOT rights on an Amazon Kindle Fire (jailbreak) tablet</a></li>
<li><a href="../134845/index.html">Zend_Tool Integration into NetBeans</a></li>
<li><a href="../134847/index.html">Agile implementation issues</a></li>
<li><a href="../134849/index.html">Opposition HP and Oracle. Conclusion</a></li>
<li><a href="../134850/index.html">Vox.io - a new look at the idea of ‚Äã‚ÄãSkype</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>