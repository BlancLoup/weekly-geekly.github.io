<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tale of how we supported the domestic manufacturer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you suffer for a long time - something will turn out! 
 (c) folk wisdom 

 It is time for fascinating stories,%% username! 

 At once I will make a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tale of how we supported the domestic manufacturer</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/ca6/e25/d0a/ca6e25d0ab7946caace940ed49450d10.jpg"><br><br>  <em>If you suffer for a long time - something will turn out!</em> <br>  <em>(c) folk wisdom</em> <br><br>  It is time for fascinating stories,%% username! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At once I will make a reservation that the story described below never happened.  All matches are random, all characters are fictional. <br><br>  Due to our professional activities, we have to work with different telecom operators.  Almost all of them are at the federal level, or their subsidiaries in the CIS countries.  One of these companies is ... Let it be Z. <br>  The history of relations with him is long-standing and colleagues will probably tell a lot of interesting things.  But this somehow later, but for now I will tell my story. <br>  The security requirements of this company are serious - the provision obliges (And another 152-FZ "On the protection of personal data").  And if earlier the requirements were draconian (in the spirit of ‚ÄúMission Impossible‚Äù: an isolated room, a retina scanner, submachine gunners ...), now they are simply strict: individual records and encrypted communication channels between us and the customer.  Encryption - GOST, no <s>bourgeois</s> overseas IPSec.  The market for such solutions is small, suppliers - once or twice and ran out.  The implementation ... well, not Checkpoint and not Cisco, but tolerable. <br><br>  But it was a saying, but for a fairy tale I ask for the cut! <br><a name="habracut"></a><br><h2>  1. Do you remember how it all began? </h2><br>  The partner‚Äôs secure network is built on the basis of the ViPNet solution from a domestic manufacturer, Infotex.  Until recently, individual ViPNet client clients were used with named keys.  However, we have a lot of employees, but only ten keys, the partner does not give them anymore.  Somehow coped, but it was terribly inconvenient, so we decided to install a dedicated gateway. <br><br>  After negotiations with the manager of Infotex and the partner‚Äôs experts, we stopped at the ViPNet Coordinator HW1000 PAK based on the Aquarius server.  <s>The import substitution is</s> Inside this PACK - the usual debian-based Linux with its own shell (you can go to bash) and the installed software ViPNet Coordinator (the test version can be downloaded as a package). <br><br>  Since  Since the market for such solutions is extremely small, standardization does not smell there.  You have to buy a piece of iron from the same manufacturer as your partner, otherwise it will not work.  Hence, the level of service - no NBD to you (although the cost of support is far from a penny), although the support responds fairly quickly, it is worth noting what, sometimes, you cannot say about the managers. <br><br>  The first ‚Äúdiscovery‚Äù after receiving the equipment was that the management software requires a 16-bit MS-DOS subsystem for its work (!).  Given that there are two programs (‚ÄúNetwork Control Center‚Äù and ‚ÄúVerification and Key Centers‚Äù), they use shared folders (although the documentation describes their separation into different workstations), the installation of a virtual machine with Win2003 x32 was the least hemorrhoid variant.  2015 year speak?  x86-64?  No, not heard.  The version of the software supporting 64-bit OS is currently undergoing certification by the authorities - was the answer of the support. <br><br>  The user manual is detailed and multi-page, and the description of the ready-made schemes takes up a dozen and a half pages and consists of half of the drawings.  If it were not for the help of colleagues who have already launched similar PAK (Sasha, thank you!), Then the process of setting up and mastering the documentation would be delayed, I think, for a month or two.  Infotex itself strongly recommends taking five-day courses (of course, paid, but relatively cheap), or use the services of an integrator.  But we are not looking for easy ways, right?  :) By the way, I sent a short instruction for support, nevertheless, to me. <br><br><h2>  2. Let's go! </h2><br>  It all starts with the installation of the administrator's software: the Network Management Center (NOC), the Verification and Key Center (UCC) and ViPNet Client, with which we will check our channel.  To work will require a license (comes with PAK).  We are not running the client yet, we still need to make keys for it.  The license file is copied to C: \ Program files \ InfoTecs \ {NCC, KC}.  We rebuy. <br><br>  <strong>Run the NOC.</strong> <br><img src="https://habrastorage.org/files/762/9d0/953/7629d0953b9d4350ba2fbd30b9d52c82.png"><br>  <i>NOC interface</i> <br><br>  We accept the default settings.  Open <em>Services -&gt; Address Administration -&gt; ViPNet Network Structure</em> . <br>  Create a server router (CM).  In most cases, it will need one, even if you have a cluster configuration.  In the SM create a <em>subscriber point</em> (AP) admin. <br><br><img src="https://habrastorage.org/files/ee2/52e/a70/ee252ea700494d778b4fd0583e8fd18f.png"><br>  <i>ViPNet network structure</i> <br><br>  Check with the command " <em>Issue routing table</em> ". <br>  Further, all in the same menu " <em>Services</em> ": <br>  <em>Group registration of nodes in tasks -&gt; Coordinator -&gt; add our CM.</em> <br>  <em>Individual registration in the tasks -&gt; admin -&gt; add the checkboxes NOC + ECC.</em> <br>  <em>Registering team types - admin -&gt; links -&gt; add SM.</em> <br>  <em>User registration -&gt; Add another user to the admin and vpn1000 channels</em> <br>  <em>Group registration of nodes in tasks -&gt; Coordinator -&gt; registration in task hw1000 -&gt; select the required CM -&gt; ip addresses -&gt; enter IP addresses.</em>  (See the documentation ‚ÄúViPNet NCC‚Äù pp. 13.4.2.1 and 13.5).  Here you need to specify the internal and external address of our coordinator and tunneled networks. <br><br>  <strong>Now we check</strong> : <br>  <em>Configuration check</em> <br>  <em>Generate all directories</em> <br><br>  <strong>We have finished with the NOC, we are launching our ECC</strong> <br><img src="https://habrastorage.org/files/4f0/b61/2d3/4f0b612d3f5d4fa184d038d6f1b67702.png"><br>  <i>Appearance of ECC</i> <br><br>  Primary adjustment is done using a simple wizard.  I will not describe each button, I will run briefly. <br>  The user whose name we assign to the network administrator is admin, the default settings are not changed.  Mark the checkbox "create asymmetric master key" <br><br>  Set an administrator password for the ‚ÄúAll Network‚Äù group (this group includes all network nodes by default), which is used to enter administrator mode on Network Nodes (our coordinators). <br>  The created distributions will be displayed in the ECC in the <em>Key Center</em> section <em>&gt; Own ViPNet network&gt; Keys&gt; Key Distributions.</em> <br><br>  After that, restart the ECC - he will ask for the password.  Enter the same administrator password that has just been generated. <br><br>  A small remark: if you suddenly forgot one of the passwords, it would be easiest to reconfigure everything again (delete the NOC and the ECC, delete the InfoTecs folder) - from the second or third time, the setup takes about fifteen minutes and goes almost to the machine). <br><br>  We form exports for our partner‚Äôs network. <br>  In NOC: <em>Services -&gt; Export.</em>  Since  we don't have anything yet, add a network for export (this is your partner's trusted network).  We add there all our SU and all TC.  Click Copy. <br>  The received files will need to be picked up in the NCC \ EXPORT folder, stuffed into an encrypted archive and transferred to the partner network administrator. <br>  Accept import.  We copy the contents of the archive into the IMPORT folder, reboot the NOC.  <em>Services -&gt; raw import.</em> <br><br>  <strong>We return to the ECC</strong> <br>  We accept a symmetric master key (see the manual for the ECC) or create your own - here you will agree with your partner <br>  Create node keys (see manual on ECC) <br>  <em>Own network -&gt; Keys -&gt; Keys of nodes.</em>  On each node PKM -&gt; move to NOC <br><br>  <strong>NOC</strong> <br>  Generate all directories, then re-export and send to partner.  Accept import. <br><br>  <strong>Cooking key distributions</strong> <br>  <em>WCC -&gt; KC -&gt; SU -&gt; Open.</em>  <em>We set the administrator password.</em> <br>  <em>NOC -&gt; Services -&gt; Files for ... ECC -&gt; Distributions ...</em> (copy both SU: VPN1000 and admin) <br>  <em>WCC -&gt; Service -&gt; Automatically create -&gt; Key Distributions</em> <br><br>  We transfer distributions (* .dst files) to removable media (using the Move to folder folder in the context menu). <br>  Copy user passwords to the same carrier ( <em>Tools&gt; Save Passwords In File&gt; User Passwords</em> ). <br><br>  <strong>Import certificates</strong> <br>  <em>UCC -&gt; UTs -&gt; Trusted Networks -&gt; Inbox.</em>  Import all certificates <br><br>  <strong>Finally, we get, in fact, to iron</strong> <br>  Import keys and directories on HW.  With the help of the wizard we set up network interfaces.  This can be done later from the console.  The default password for vipnet / vipnet login <br>  After installing the keys login: vipnet, password: password from the distribution with the keys SM, enable: password of the administrator of the SU (the one for the UCC). <br>  In the NCC we add connections between the imported TC and its own.  We again export and accept imports.  Import-export is repeated until anomalies stop on both sides. <br>  After each import, we do ‚ÄúGenerate all directories‚Äù, <em>Management -&gt; Submit changed files -&gt; Directory references</em> -&gt; select our control systems (admin, vpn1000) and send. <br>  In the ViPNet client, a message should appear on the update of address directories and a coordinator with whom we contact. <br>  <em>NOC -&gt; Management -&gt; Send changed files -&gt; Keys of nodes.</em>  We send the keys to the coordinator and the client. <br><br><div class="spoiler">  <b class="spoiler_title">Brief instructions for lazy people</b> <div class="spoiler_text">  So your network number is 1234 <br>  trusted network 4321 <br><br>  Online number 1234 do the following: <br>  - Making a backup copy (archive) <br>  - We form the initial export as described in the documentation <br>  - We set the gateway for inter network <br>  - Copy the initial export <br>  - We generate ISMMK for 4321 network in ECC <br>  - Making export for 4321 network <br><br>  then do the following: <br>  - Pass the initial export for 4321 network <br>  - copy the initial export from the 1234 network to the folders of the ISC of the NCC and the ECC of the 4321 network. <br><br>  Now for the 4321 network: <br>  - Making a backup copy (archive) <br>  - We connect the internetwork channel <br>  - Establish communication between TC 2 networks 1234 and 4321 <br>  - Generate return export for network 1234 <br>  - Do not forget to set the CM gateway and copy the return export <br>  - Just remember to check for abnormal situations. <br>  - Generate directories <br>  - Import the list of certificates of electronic digital signature of network administrators in 1234 in the ECC network 4321 <br>  - Import ISMMK from network 1234 <br>  - To form a new CU in the NCC and transfer them to the NCC <br>  - Send updates from the NOC <br><br>  We now turn to the next stage: <br>  - Send return export for network 1234. And then all actions will be performed there. <br>  - To carry out the import of reciprocal exports to the NOC and the UCC, and to create and create a final export. <br>  - Connect the internetwork channel.  in the NOC <br>  - See and check if there is a connection between the TK of the two networks 1234 and 4321. <br>  - Check for anomalies. <br>  - Generate directories. <br>  - Make import of the list of certificates of UL UL of the second network in the ECC of the first network. <br>  - Generate new node keys and transfer to NOC <br>  - Send updates of CU and address directories from the NOC. <br>  - Check once again the correctness of the installation procedure for interworking <br>  - Import final export network 4321 <br></div></div><br><br><h2>  3. Bonus </h2><br>  Failover implies that you have two pieces of iron, and they work together, posing as one cluster.  The work is based on VRRP plus synchronization of crypto sessions. <br><br><div class="spoiler">  <b class="spoiler_title">Failover setting</b> <div class="spoiler_text"><pre><code class="bash hljs">[network] checktime = 10 timeout = 2 activeretries = 3 channelretries = 3 synctime = 5 fastdown = yes [channel] device = eth1 ident = iface-1 activeip = 192.168.1.3 passiveip = 192.168.1.1 testip = 192.168.1.4 checkonlyidle = yes [channel] device = eth2 ident = iface-2 activeip = 1.2.3.3 passiveip = 1.2.3.1 testip = 1.2.3.4 checkonlyidle = yes [sendconfig] activeip = 192.168.2.2 sendtime = 60 device = eth0 config = yes keys = yes journals = yes port = 10090 [misc] activeconfig = /etc/iplirpsw passiveconfig = /etc/iplirpsw maxjournal = 30 <span class="hljs-comment"><span class="hljs-comment">#days reboot = no [debug] debuglevel = 3 debuglogfile = syslog:daemon.debug [events]</span></span></code> </pre> <br>  ### <br>  eth1 is a link to our internal networks <br>  192.168.1.3 - this is the internal IP cluster <br>  192.168.1.1 - this is the internal IP node <br>  192.168.1.4 is the IP address of the gateway through which we see client networks <br>  eth2 - link in the direction of the Internet <br>  1.2.3.3 is an external IP cluster <br>  1.2.3.1 is an external IP node <br>  1.2.3.4 is the default gateway IP <br><br>  eth0 is the interconnect between the nodes of the cluster <br>  192.168.2.2 is the IP address of the second node of the cluster <br></div></div><br><br>  Notice the [misc] section and the ‚Äúreboot = no‚Äù option.  By default, it is set to yes, and if failover fails to start the first time, you will have to reinstall the PACK OS again from the image.  At the same time, the instruction states that the default value is ‚Äúno‚Äù.  Perhaps this is already fixed, but you still have to keep in mind. <br><br>  We check that both you and the partner have the same encryption type: <br> <code>iplir set cipher-mode cfb</code> <br> <br>  Another useful feature of the encryption module: <br> <code>iplir show config</code> <br>  After all imports and exports, there should be your partner‚Äôs networks and networks, between which you need to set up the exchange.  Well, do not forget to properly configure the routing so that the traffic to the partner nodes is wrapped in the coordinator. <br><br><h2>  4. Through thorns - to the stars! </h2><br>  So, the setup is complete, but the channel between our PAK and the partner network does not rise.  And here the most interesting began. <br><br>  Naturally, the ticket was launched in support, there were clarifying questions, repeated reset of the PAK ‚Äúto default‚Äù, recheck of all settings, including  by the support itself through a remote session ... <br><br>  After a month of knocking on a tambourine and copying the next file from one folder to another, the channel rose.  Bingo?  In general, yes, but the sediment remained considerable!  A month almost wasted, hundreds of emails to support and a partner administrator, endless exchange of settings (one of the ViPNet tokens is import-export settings between the PACK with key information and network settings) <s>and a letter from the management to Infotex with a proposal to take the buggy piece back</s> . <br><br>  There were even attracted developers, the answer of which was, in its own way, brilliant: ‚Äúprobably, you did something wrong‚Äù.  Well, of course, the channel eventually earned.  And it still works, pah-pah. <br><br>  Colleagues suggest that they also suffered for about a month, and it, as a result, ‚Äúworked by itself‚Äù when the manufacturer‚Äôs technical support got involved. <br><br>  Mysticism, not otherwise.  Or maybe this is a kind of dedication - the system obeys only the persistent. <br><br>  In conclusion, I want to say that I don‚Äôt strive to ‚Äúthrow mud at someone‚Äù, I just describe my experience.  At first, the terminology, which seems to me to be sharpened by information security specialists rather than networkers: subscriber stations, key distributions, user groups, communications, and so on, caused particular dissonance.  Although, iron is designed for large companies, and they, as a rule, have IT security personnel.  On the other hand, an obvious sharpening under state structures (and who else <s>in their right mind</s> would use Gostov's encryption?) Imposes localization requirements, and, it seems, on terminology as well. </div><p>Source: <a href="https://habr.com/ru/post/260415/">https://habr.com/ru/post/260415/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260403/index.html">The main thing is to sit shoe. How 3D-technology helps to choose shoes by foot</a></li>
<li><a href="../260407/index.html">Experience using Object Change Notification in Oracle</a></li>
<li><a href="../260409/index.html">Sale of books at a discount of 50% and 30%</a></li>
<li><a href="../260411/index.html">Transformice story: indie game with 60 million users</a></li>
<li><a href="../260413/index.html">Instructions: Setting up the Gateway PD (AltLinux SPT 6.0 + VipNet Coordinator)</a></li>
<li><a href="../260417/index.html">Compile and decompile try-with-resources</a></li>
<li><a href="../260419/index.html">ECP and process management API</a></li>
<li><a href="../260425/index.html">Tin - the basis of circuitry in your home</a></li>
<li><a href="../260427/index.html">Prototypes are objects (and why this is important)</a></li>
<li><a href="../260429/index.html">Mail server on your own site via sendmail</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>