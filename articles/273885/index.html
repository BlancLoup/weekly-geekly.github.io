<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>On the issue of timers in RTOS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Here are two lines, I'm a genius, away doubts 
 Give delights, laurels and flowers ... 
 This post is dedicated to the pretty old task of reading the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>On the issue of timers in RTOS</h1><div class="post__text post__text-html js-mediator-article"><h1>  Here are two lines, I'm a genius, away doubts <br>  Give delights, laurels and flowers ... </h1><br>  This post is dedicated to the pretty old task of reading the timer, which I personally read in the book by Jack Gansley (The Art of Designing Embedded Systems (Second Edition), (2008) by Jack Ganssle) which deals with the fight against racing in asynchronous devices.  The problem was formulated and 4 ways to solve it were shown (2 incorrect and 2 correct), their shortcomings were considered, in general, good work in the style of Jack (I treat him very well).  Unfortunately, in my opinion, even working solutions did not have the proper degree of elegance, but the more beautiful did not occur to me for a long time, but yesterday it dawned on me.  So I consider myself entitled to present this problem in its historical context, because I have come up with a very elegant solution (you cannot praise yourself, you go all day as a spat). <br><a name="habracut"></a><br>  We formulate the problem: we have a hardware counter, which is synchronized from a certain system frequency and can be used to measure time.  However, due to hardware limitations, its capacity is not enough to form long periods of time, so a software extension of the counter capacity is created.  It is implemented as follows: when the counter overflows, an interrupt occurs and the interrupt processing subprogram modifies a global variable, which, together with the counter itself, forms an extended time counter, something like <pre><code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> High; <span class="hljs-function"><span class="hljs-function">interrupt </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TimerOv</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ High++; }</code> </pre>  Then we can write the current time as follows <pre> <code class="hljs cpp"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTimer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (High&lt;&lt;<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>))+ ReadReg(TimerCounter); }</code> </pre>  Everything is simple, understandable, and wrong, as expected.  Here the problem lies on the surface and is visible to anyone who wrote similar programs - in the process of reading the two halves of the extended timer, the youngest part may overflow, since it is asynchronous, and then the two parts will not be valid relative to each other.  At the same time, we can get both the past time point and the future as the value of the extended timer, and both of these cases are worse. <br><br>  There is an obvious solution to the problem - to stop the timer hardware at the time of reading, but this solution is unacceptable because of the effect on the counted time. <br><br>  Let's try another obvious solution - to ban interrupts for the time being read and we get <pre> <code class="hljs cpp"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTimer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ DisableInt(); <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> Tmp=(High&lt;&lt;<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>))+ ReadReg(TimerCounter); EnableInt(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Tmp; }</code> </pre>  Of course, when I write about the prohibition of interruption, it is assumed that the current value is saved with its restoration at the end, but these subtleties are omitted, they are not so important now.  What is not good in this decision: 1) we prohibit interruptions, which is not encouraging, and 2) this solution will not work.  Yes, exactly, although the method is approved, but not for this case.  The fact is that the prohibition of interrupts does not allow the timer to work (it is hardware), so if during the interruption request period the counter overflow occurs, we get the low part equal to zero, and the high one is not modified, that is, the data is not valid. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Possible modification of this solution leads to the following code. <pre> <code class="hljs cpp"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTimer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ DisableInt(); <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> TmpH=High; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> TmpL=ReadReg(TimerCounter); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TimerOvBit()) { TmpH++; TmpL=ReadReg(TimerCounter); }; EnableInt(); TmpH=(TmpH&lt;&lt;<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>))+ TmpL; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Tmp; }</code> </pre>  This is the first correct decision.  There are drawbacks to this solution: 1) we still prohibit interrupts, 2) we need an additional hardware bit and we need to take care of the interrupt service, 3) we made certain assumptions about the modification of the older part.  Are there any other solutions? <br><br>  Yes, such a solution exists and was found by Jack and me (honestly, on my own).  The code for this solution is as follows. <pre> <code class="hljs cpp"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTimer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> TmpH,TmpL; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { TmpH=High; TmpL= ReadReg(TimerCounter); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (TmpH!=High); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (TmpH&lt;&lt;<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>))+TmpL; }</code> </pre>  This is the second right decision, pay attention to the fact that the reading of the counter is framed by calls to the older part, otherwise it is wrong.  In general, this approach strongly resembles non-blocking algorithms when competing to resources that I like something with, there is some elegance in them.  This method has many advantages, but one drawback - if our system is heavily loaded, then we can hang for a long time in the loop, as Jack writes, the execution time becomes unpredictable. <br><br>  And here a small modification of this algorithm was invented, namely <pre> <code class="hljs cpp"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTimer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> TmpH,TmpL; TmpH=High; TmpL= ReadReg(TimerCounter); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TmpH!=(TmpH=High)) TmpL= ReadReg(TimerCounter); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (TmpH&lt;&lt;<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>))+TmpL; }</code> </pre>  This is the third right decision and I, as the author, like it most.  We do not prohibit interruptions, do not require anything from the equipment, make no assumptions, always get the right result, that is, 1) never get the value of the extended timer preceding the moment of entering the procedure and 2) never get the value following the time of exit from procedures, we have completely predictable behavior, and all this is practically free.  Of course, if we have a highly loaded system, then we can get a time at the output that is significantly less than the time required to exit the procedure, but this is also true of the other two correct methods.  If we really need the current value of time with a minimum deviation, then we must carry out all processing with prohibited interrupts, and this is clearly not our case. <br><br>  As I was right in the comments, the compiler may incorrectly compile the key line of the algorithm, so here‚Äôs the corrected version. <pre> <code class="hljs cpp"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTimer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> TmpHFirst,TmpH,TmpL; TmpHFirst=High; TmpL= ReadReg(TimerCounter); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TmpHFirst!=(TmpH=High)) TmpL= ReadReg(TimerCounter); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (TmpH&lt;&lt;<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>))+TmpL; }</code> </pre> <br>  Why I didn‚Äôt find this solution before (I didn‚Äôt see it in the literature either, maybe I just didn‚Äôt come across it), it‚Äôs completely incomprehensible, because everything is crystal clear and simple, apparently, a certain narrow-mindedness affected.  Why it works, I give it to the reader, but it definitely works, I couldn‚Äôt find a counter-example, if you manage to do this, I ask in comments. <br><br>  And finally, another interesting point.  We are not interested in time, as such, we usually use the current time in order to set a certain point in relation to it in the future, and to achieve something after it is reached.  So, in your opinion, are the next two lines equivalent? <pre> <code class="hljs objectivec"> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> TmpWait; TmpWait=GetTimer()+SomeDelay; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (TmpWait &gt; GetTimer()) ; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((TmpWait - GetTimer()) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) ; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> }</code> </pre>  These lines are not equivalent under certain conditions and it is interesting to consider why.  I will send interested persons to the Linux manuals, look for the jiffies term. </div><p>Source: <a href="https://habr.com/ru/post/273885/">https://habr.com/ru/post/273885/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../273875/index.html">German-Chinese device and a bit of mathematics (part 2)</a></li>
<li><a href="../273877/index.html">New book on Cortex-M0 / M0 +</a></li>
<li><a href="../273879/index.html">Connecting STM32 to radio control equipment</a></li>
<li><a href="../273881/index.html">Make AVR isp mkii clone work on windows 10 and Atmel Studio 7:</a></li>
<li><a href="../273883/index.html">About languages</a></li>
<li><a href="../273889/index.html">Engineers train robotic arms with IKEA furniture</a></li>
<li><a href="../273891/index.html">Farmers offer a quarter of a million for collecting blueberries</a></li>
<li><a href="../273893/index.html">Implement the ‚ÄúOnboarding Experience‚Äù in your application</a></li>
<li><a href="../273895/index.html">Standards symmetric encryption CIS countries in Python</a></li>
<li><a href="../273897/index.html">Git and Github. Simple recipes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>