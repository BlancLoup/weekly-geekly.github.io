<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pure solution architecture, tests without mocks and how I came to this</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello dear readers! In this article I want to talk about the architecture of my project, which I refactored 4 times at its start, because I was not sa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pure solution architecture, tests without mocks and how I came to this</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello dear readers!  In this article I want to talk about the architecture of my project, which I refactored 4 times at its start, because I was not satisfied with the result.  I'll tell you about the disadvantages of popular approaches and show mine. </p><a name="habracut"></a><br><p>  Just want to say that this is my first article, I am not saying what to do as I am - right.  I just want to show what I did, tell you how I got to the final result and the most important thing is to get the opinions of others. </p><br><p>  I worked in several campaigns and saw a bunch of things I‚Äôd do differently. </p><br><p>  For example, I often see an N-Layered architecture, there is a layer of working with data (DA), there is a layer with business logic (BL) that works using DA and maybe some other services, and there is also a view layer \ API in which accepted request, processed using BL.  It seems to be convenient, but looking at the code I see this situation: </p><br><ul><li>  [DA] draws \ writes \ changes data, even if a complex query is OK </li><li>  [BL] 80% calls 1 method and rolls the result higher - Why this empty layer? </li><li>  [View] 80% Calls 1 BL method pushes the result higher - Why this empty layer? </li></ul><br><p>  In addition, it is fashionable to wrap in the interfaces in order to then lock and test - wow, just wow! </p><br><ul><li>  Why mock? </li><li>  Well, to cut out side effects for the duration of the tests. </li><li>  That is, we will test without side effects, and in prod with them? <br>  ... </li></ul><br><p>  This is a grounded thing that I didn‚Äôt like in this architecture, so as to solve a problem of the type: "Display a list of user likes" is a big process, but in fact there is 1 query to the database and possibly mapping. </p><br><div class="spoiler">  <b class="spoiler_title">Approximate solution</b> <div class="spoiler_text"><p>  1) [DA] Add request to DA <br>  2) [BL] Forward the answer DA <br>  3) [View] Forward result BA, can promappit </p><br><p>  Do not forget about the fact that all these methods still need to be added to the interface, we are writing a project in order to get wet, and not to solve it. </p></div></div><br><p>  Elsewhere I saw an API implementation with a CQRS approach. </p><br><p>  The solution did not look bad, 1 folder - 1 feature.  The developer doing the feature is sitting in his folder and almost always can forget about the effect of his code on other features, but there were so many files that it was just a nightmare.  Query / response models, validators, helpers, logic itself.  The search in the studio practically refused to work, extensions were made to search for the necessary things in the code. </p><br><p>  There is a lot more to be said, but I have highlighted the main reasons that made me give up on it. </p><br><h2 id="i-nakonec-k-moemu-proektu">  And finally to my project </h2><br><p>  As I said, I refactored my project several times, at that moment I had a ‚Äúprogrammer‚Äôs depression‚Äù, I was just not happy with my code, and refactored it, again and again, I finally started to watch a video about the architecture of the application to see how do others.  I stumbled upon Anton Moldovan's reports about DDD and functional programming, and thought: "Here it is, I need F #!". </p><br><p>  Having spent a couple of days on F #, I realized that, in principle, I will do the same in C # and not worse.  In the video showed: </p><br><ul><li>  Here is the C # code, it's shit </li><li>  Here is F # cool, less wrote - super. </li></ul><br><p>  But the joke is that the solution on F # was implemented differently, and against it showed a poor implementation in C #.  The main principle was that BL is not a thing that causes DA services and does all the work, and this is a <strong>pure function</strong> . </p><br><p>  Of course, F # is good, I liked some features, but like C # it is just a tool that can be used in different ways. </p><br><p>  And I went back to C # and started creating. </p><br><p>  I created such projects in the solution: </p><br><ol><li>  API </li><li>  Core </li><li>  Services </li><li>  Tests </li></ol><br><p>  I also used C # 8 features, especially the nullable refence type, I will show its use. <br>  Briefly about the tasks of the layers that I gave them. </p><br><p>  <strong>API</strong> <br>  1) Receive requests, query models + validation, restrictions </p><br><div class="spoiler">  <b class="spoiler_title">Read more</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/1ba/e1f/fdf/1bae1ffdfd889b06d323d50d58904459.png" alt="image"></p></div></div><br><p>  2) Calling functions from Core and Services </p><br><div class="spoiler">  <b class="spoiler_title">Read more</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/a9f/01f/606/a9f01f6067340c60ca2e07e3e1321fbf.png" alt="image"></p><br><p>  Here we see a simple, readable code, I think everyone will understand what is written here. <br>  There is a clear pattern <br>  1) Get the data <br>  2) Edit, change, etc. - It is this part that needs to be tested. <br>  3) Save. </p></div></div><br><p>  3) Mapping, if needed <br>  4) Error handling (logging + human response) </p><br><div class="spoiler">  <b class="spoiler_title">Read more</b> <div class="spoiler_text"><p>  In this class all possible application errors are collected, to which exception handler responds. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/574/7f6/c44/5747f6c44498d03e6c94958b3b500f8b.png" alt="image"></p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/a74/5c4/4ab/a745c44ab83c307d92fdaa82b339bd55.png" alt="image"></p><br><p> It turns out that the application either works, or gives a specific error, and not processed errors are either a side effect or a bug, the log of such errors flies right away to my telegrams in a chat with a bot. </p><br><p>  I have AppError.Bug this error for not clear case. </p><br><p>  I have a CallBack from another service, it will have a userId in my system, and if I don‚Äôt find a user with this ID, it means either something happened to the user or it‚Äôs not clear at all, such an error flies to me like CRITICAL, in theory shouldn‚Äôt arise, but if it does, it requires my intervention. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/625/ecf/ce5/625ecfce5eb5570993443f65eb4b7006.png" alt="image"></p></div></div><br><p>  <strong>Core, the most interesting</strong> </p><br><p>  I always kept in mind that BL is just functions that, with the same input, give the same result.  The complexity of the code in this layer was at the level of laboratory work, not large functions that clearly and without error do their work.  And it was important that there were no side effects inside the functions; all that the function needs is a parameter to it. </p><br><p>  If the functions need a user's balance, then WE will reach the balance, and transfer it to the function, but DO NOT shove the users' service in BL. </p><br><p>  1) Basic entity actions </p><br><div class="spoiler">  <b class="spoiler_title">Read more</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/729/ec2/7d4/729ec27d4e71e4f050d6c404f2c25c5c.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/d49/b15/f17/d49b15f17eb75d63a61486db99f9ceab.png" alt="image"></p><br><p>  I rendered methods as extension methods so that the class does not bloat, and the functional can be grouped by features. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/3ef/4a6/634/3ef4a663438981f8ab3d326e2289e1c7.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/296/e9c/220/296e9c220a1b41407b5901d7789b317e.png" alt="image"></p></div></div><br><p>  Another important topic is the good construction of entity models. </p><br><p>  Here for example, I have a user, the user has balances in several currencies.  One of the typical solutions that I took without hesitation is the essence of "Balance" and simply shove an array of balances into the user.  But what is not convenient brought such a decision? </p><br><p>  1) Adding / removing currency.  This task immediately means for us not only writing new code, but also migration, filling / deleting all existing users and this is the simplest option.  God forbid, to add a new currency would have to make a button for the user, which he will press and initiate the creation of a new wallet for some business process.  As a result, it was only necessary to expand the enum for the new currency, and wrote another feature for creating purses by button, another task was thrown to the front. </p><br><p>  2) In the code, the constants FirstOrDefault (s =&gt; s.Currency == currency) and check for null </p><br><div class="spoiler">  <b class="spoiler_title">My decision</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/254/d7d/7d5/254d7d7d580592114c8ab62a6bd028de.png" alt="image"></p><br><p>  With the model itself, I guarantee myself that the balance will be no null, and by creating an operator indexer I simplified myself the code in all places of interaction with the balance. </p></div></div><br><h2 id="services">  Services </h2><br><p>  This layer provides me with convenient tools for working with various services. <br>  In my project I use MongoDB and for convenient work with it, I wrapped collections in such a repository. </p><br><div class="spoiler">  <b class="spoiler_title">Read more</b> <div class="spoiler_text"><p>  Repository itself <br><img src="https://habrastorage.org/getpro/habr/post_images/259/453/270/2594532705f07b698d6b6d29c19eb4ef.png" alt="image"></p><br><p>  Monga blocks the document at the time of working with it, respectively, it will help us with solving problems in the competition of requests.  And in the monge there are methods for finding an entity + an action on it, for example: "Find a user with id and add 10 to his current balance" </p><br><p>  And now about the C # 8 feature. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/579/237/bc6/579237bc61fdb0e58342ff73300b0def.png" alt="image"></p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/221/449/d5e/221449d5ea5fb587e3d8cf2aea980f0a.png" alt="image"></p><br><p>  The method signature tells me that User can come back, and maybe Null, respectively, when I see User?  I immediately get a compiler warning, and I check for null. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/441/28c/503/44128c503d8af4762f5bc7fea812f0b3.png" alt="image"></p><br><p>  When the method returns User, I work with it confidently. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/665/8c6/4b9/6658c64b9cb10ea08fbfae84447e6c48.png" alt="image"></p><br><p>  I also want to draw attention to the fact that there is no try catch because there can be exceptions only from "weird situations" and incorrect data that should not come here because there is validation.  There is also no try catch in the API layer, there is only one global exception handler. </p><br><p>  There is only one method that throws an Exception. This is the Update method. <br>  It provides protection against data loss in multi-threaded mode. <br><img src="https://habrastorage.org/getpro/habr/post_images/4b5/87c/709/4b587c709dffe51e88dcf8deb7db42ee.png" alt="image"></p><br><p>  Why did not use the methods of Mongi, about which he spoke above? <br>  There are places where I don‚Äôt know for sure if I can work with the user at all, maybe he simply doesn‚Äôt have money for this action, because in the beginning I get the user to check it, then I mutate and save it. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/9fd/c68/b23/9fdc68b236ce758a977c1cca2f50ad69.png" alt="image"></p><br><p>  In theory, my application will change the user's balance more often than once per second, since these will be fast games. </p><br><p>  But the user model itself, it is clearly visible here that the referral is not mandatory for the user, and you can work with everything else without thinking about null. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c0f/0c7/835/c0f0c7835e56f5ac9372dc0a5139908d.png" alt="image"></p></div></div><br><h2 id="i-nakonec-tests">  Finally Tests </h2><br><p>  As I said, you only need to test the logic, and the logic of our function, without side effects. <br>  Therefore, we can run our tests very quickly and with different parameters. </p><br><div class="spoiler">  <b class="spoiler_title">Read more</b> <div class="spoiler_text"><p>  I downloaded the FSCheck nuget which generates randomly incoming data and allows me to carry out many different cases. </p><br><p>  I just need to create different users, feed them to the test and check the changes. </p><br><p>  To create such users there is a builder, so far small, but it is easy to expand. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ff5/11a/bf1/ff511abf173fd7fd9b452934af2e0d20.png" alt="image"></p><br><p>  And here are the tests themselves </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/51e/ba1/1ec/51eba11ec1df6ca5393bba5095a4dd15.png" alt="image"></p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/4dd/fa7/063/4ddfa706330f69bff4950bf9d46b7fe0.png" alt="image"></p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/459/d62/92d/459d6292d288de62429663160487bb2c.png" alt="image"></p><br><p>  After some changes, I run tests, after 1-2 seconds I see that everything is in order. <br>  Also in the plans to write E2E tests in order to check the entire API from the outside and be sure that it works as it should, from the request to the answer. </p></div></div><br><h2 id="fishki">  Chips </h2><br><div class="spoiler">  <b class="spoiler_title">Cool things you might need</b> <div class="spoiler_text"><p>  Each my request is doped, when a bug occurs, I find the requestId and I can easily reproduce the bug by repeating the request, because my API has no state, and each request depends only on the request parameters. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/d4d/2e9/112/d4d2e9112f58db9beee8dbaaa9abb466.png" alt="image"></p></div></div><br><p>  Summarize. </p><br><p>  We really wrote a solution, not a framework in which a bunch of unnecessary abstractions, as well as mocks.  We did error handling in one place and those should occur very rarely.  We separated the BL and side effects, now the BL is just local logic that can be reused.  We did not write unnecessary functions that simply forward the call to other functions.  I will actively read the comments and add to the article, thank you! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/459394/">https://habr.com/ru/post/459394/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459380/index.html">We write API for React components, part 3: the order of props is important</a></li>
<li><a href="../459384/index.html">To a question about a different or next cry of Yaroslavna</a></li>
<li><a href="../459388/index.html">Star Wars: Knights of the Old Republic</a></li>
<li><a href="../45939/index.html">Errors in the Zend_Form_Element_File Component</a></li>
<li><a href="../459392/index.html">Redefining the interview process in the Microsoft Development Division</a></li>
<li><a href="../4594/index.html">Broadcasters covered the fifth part of Moscow apartments</a></li>
<li><a href="../459400/index.html">What incidents with the Border Gateway Protocol can be identified over the past few years</a></li>
<li><a href="../459402/index.html">How to implement pure architecture on Android?</a></li>
<li><a href="../459404/index.html">Idea: anonymous registration / authorization using the Ethereum + Metamask network, without emails, etc.</a></li>
<li><a href="../459408/index.html">As I tried to fix the search on the cards for drivers. Part 3 (final)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>