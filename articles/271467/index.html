<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>NGINX as a load balancer for MySQL or MariaDB Galera Cluster</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is a translation of the original article from the Severalnines website. 

 Nginx is well known to everyone for its advanced features and ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>NGINX as a load balancer for MySQL or MariaDB Galera Cluster</h1><div class="post__text post__text-html js-mediator-article">  <i>This article is a translation of the original <a href="http://severalnines.com/blog/nginx-database-load-balancer-mysql-or-mariadb-galera-cluster">article</a> from the Severalnines website.</i> <br><br>  Nginx is well known to everyone for its advanced features and performance as a proxy and / or low memory memory balancer.  As a rule, nginx is used on the first ‚Äúline of defense‚Äù of web applications in order to distribute the load on the backend servers, periodically checking their performance.  This technology is quite popular for applications that require increased fault tolerance. <br><br><img src="https://habrastorage.org/files/40d/9ee/28b/40d9ee28b58d43c0b73df6a0fae55a87.png"><br><a name="habracut"></a><br>  Recently, nginx 1.9 announced support for TCP balancing, about the same thing that was previously implemented using HAProxy.  One of the biggest drawbacks is that nginx does not support advanced server health checks.  This feature is required if you are using MySQL Galera Cluster.  We will talk about this in more detail in the next chapter.  It should be noted that in the paid version (called NGINX Plus) there is no such limitation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article, we use nginx as a proxy for MySQL Galera Cluster and try to get high performance.  We raised the Galera cluster using ClusterControl on CentOS 7.1;  Install nginx on a ‚Äúfresh‚Äù host, as shown in the diagram: <br><br><img src="https://habrastorage.org/files/4c9/22a/5e3/4c922a5e35f64e10a846a427ae6d5258.png"><br><br><h4>  Health check </h4><br>  With the advent of synchronously replicated clusters like Galera or NDB, the use of TCP proxy as a load balancer has become quite popular.  All MySQL nodes are processed in the same way, since you can read from all of them, and you can also write to all of them.  The separation between master and slave is no longer required, as was the case with the classic MySQL replication.  Nginx is not designed for databases, so you have to resort to additional configurations in order to force the cluster to return a ‚Äúclear‚Äù answer to the health check. <br><br>  If you use HAProxy, the health check script on each MySQL server must be able to return HTTP status.  For example, if the MySQL server ‚Äúfeels good‚Äù, the script returns HTTP status 200 OK.  Otherwise, the script will return 503 Service unavailable.  With such settings, HAProxy can update the routing list and exclude ‚Äúproblematic‚Äù servers.  Unfortunately, for testing, HAProxy uses xinetd as a daemon listening on port 9200.  These configurations are not yet available in nginx. <br><br>  This flowchart illustrates the process of determining the health of a Galera cluster with setting up a multi-master: <br><br><img src="https://habrastorage.org/files/da4/5b4/f1b/da45b4f1bc37468a86cb6a2012c64934.png"><br><br>  At the time of this writing, NGINX Plus (paid) also supported server health checks, but without custom port settings. <br><br><h4>  Using clustercheck-iptables </h4><br>  To get around the limitations, we created a health check script called <a href="https://github.com/ashraf-s9s/clustercheck-iptables/blob/master/mysqlchk_iptables">clustercheck-iptables</a> .  This is a background script that checks the performance of the Galera node and adds a redirecting port using iptables if the node works as expected (instead of returning an HTTP response).  This script can be used with other TCP balancers, with limited functionality checks, such as nginx (&gt; 1.9), IPVS, keepalived, piranha, distributor, balance or pen. <br><br>  How does he work?  The script checks the performance on each node of the Galera cluster, once a second.  If the node is working in normal mode (wsrep_cluster_state_comment = Synced and read_only = OFF) or (wsrep_cluster_state_comment = Donor and wsrep_sst_method = xtrabackup / xtrabackup-v2), the redirection port will be lifted using iptables (3308). <br><br><pre><code class="bash hljs">$ iptables -t nat -A PREROUTING -s <span class="hljs-variable"><span class="hljs-variable">$0</span></span>.0.0.0/0 -p tcp --dport 3308 -j REDIRECT --to-ports 3306</code> </pre> <br>  Otherwise, this rule will be removed from the list of iptables rules.  On the balancer, you must set port 3308 instead of the default port 3306. If the node is unhealthy, port 3308 will be unavailable, the balancer in such a case should remove this node from the balancing list. <br><br>  Let's install the script and see how it works in practice: <br><br>  1. On the database servers, run the following commands to install the script: <br><br><pre> <code class="bash hljs">$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/ashraf-s9s/clustercheck-iptables $ cp clustercheck-iptables/mysqlchk_iptables /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin</code> </pre><br>  2. By default, the script will use the MySQL user ‚Äúmysqlchk_user‚Äù with the password ‚Äúmysqlchk_password‚Äù.  We need to make sure that the user exists and has the necessary rights to test the functionality.  Execute these commands on one of the nodes of the cluster (Galera will execute them on the other nodes). <br><br><pre> <code class="bash hljs">mysql&gt; GRANT PROCESS ON *.* TO <span class="hljs-string"><span class="hljs-string">'mysqlchk_user'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span> IDENTIFIED BY <span class="hljs-string"><span class="hljs-string">'mysqlchk_password'</span></span>; mysql&gt; FLUSH PRIVILEGES;</code> </pre><br>  ** If you want to use another user or password, specify them in the -u and -p arguments.  Here is an example. <br><br>  3. The script needs iptables to work.  In this example, we use CentOS 7, where firewalld is installed by default.  We need to install iptables-services: <br><br><pre> <code class="bash hljs">$ yum install -y iptables-services $ systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> iptables $ systemctl start iptables</code> </pre><br>  Then, set the basic rules for the MySQL Galera cluster, so that iptables does not affect communication with the database: <br><br><pre> <code class="bash hljs">$ iptables -I INPUT -m tcp -p tcp --dport 3306 -j ACCEPT $ iptables -I INPUT -m tcp -p tcp --dport 3308 -j ACCEPT $ iptables -I INPUT -m tcp -p tcp --dport 4444 -j ACCEPT $ iptables -I INPUT -m tcp -p tcp --dport 4567:4568 -j ACCEPT $ service iptables save $ service iptables restart</code> </pre><br>  4. After installing the rules, check them using the command: <br><br><pre> <code class="bash hljs">$ iptables -L -n</code> </pre><br>  5. Test mysqlchk_iptables: <br><br><pre> <code class="bash hljs">$ mysqlchk_iptables -t Detected variables/status: wsrep_local_state: 4 wsrep_sst_method: xtrabackup-v2 read_only: OFF [11-11-15 08:33:49.257478192] [INFO] Galera Cluster Node is synced.</code> </pre><br>  6. Looks good.  Now run the script as a daemon: <br><br><pre> <code class="hljs pgsql">$ mysqlchk_iptables -d /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/sbin/mysqlchk_iptables started <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> PID <span class="hljs-number"><span class="hljs-number">66566.</span></span></code> </pre><br>  7. Our routing rules will look something like this: <br><br><pre> <code class="bash hljs">$ iptables -L -n -t nat Chain PREROUTING (policy ACCEPT) target prot opt <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> destination REDIRECT tcp -- 0.0.0.0/0 0.0.0.0/0 tcp dpt:3308 redir ports 3306 Chain INPUT (policy ACCEPT) target prot opt <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> destination Chain OUTPUT (policy ACCEPT) target prot opt <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> destination Chain POSTROUTING (policy ACCEPT) target prot opt <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> destination</code> </pre><br>  8. Finally, add the script launch to /etc/rc.local so that it starts at the start of the server: <br><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'/usr/local/sbin/mysqlchk_iptables -d'</span></span> &gt;&gt; /etc/rc.local</code> </pre><br>  In some distributions it‚Äôs worth checking that rc.local has the necessary permissions to run the script: <br><br><pre> <code class="bash hljs">$ chmod +x /etc/rc.local</code> </pre><br>  On the application side, check that you can connect to the database on port 3308. Repeat the above steps (except 2) on all (remaining) nodes of the cluster.  So, we‚Äôve finished with performance checks, now we‚Äôll do balancing. <br><br><h4>  Installing nginx as a load balancer on a MySQL cluster </h4><br>  1. On the balancer (server) - install the necessary packages: <br><br><pre> <code class="bash hljs">$ yum -y install pcre-devel zlib-devel</code> </pre><br>  2. Install nginx 1.9 (from the code) with the TCP proxy module: <br><br><pre> <code class="bash hljs">$ wget http://nginx.org/download/nginx-1.9.6.tar.gz $ tar -xzf nginx-1.9.6.tar.gz $ ./configure --with-stream</code> </pre><br>  3. Add the following lines to the nginx configuration file ( <code>/usr/local/nginx/conf/nginx.conf</code> ): <br><br><pre> <code class="bash hljs">stream { upstream stream_backend { zone tcp_servers 64k; server 192.168.55.201:3308; server 192.168.55.202:3308; server 192.168.55.203:3308; } server { listen 3307; proxy_pass stream_backend; proxy_connect_timeout 1s; } }</code> </pre><br>  4. Run nginx: <br><br><pre> <code class="bash hljs">$ /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/nginx/sbin/nginx</code> </pre><br>  5. Make sure that nginx is ‚Äúlistening‚Äù on port 3307, as we indicated in the configuration.  MySQL connections should go through this port, after which they will be transferred to port 3308. Then iptables (on the node) will transfer the request to port 3306, where MySQL is ‚Äúlistening‚Äù: <br><br><pre> <code class="bash hljs">$ netstat -tulpn | grep 3307 tcp 0 0 0.0.0.0:3307 0.0.0.0:* LISTEN 5348/nginx: master</code> </pre><br>  Fine!  We installed nginx as a load balancer for the MySQL Galera Cluster.  We proceed to testing. <br><br><h4>  Testing </h4><br>  We performed the following tests to check the nginx balancing for the Galera cluster: <br><br>  1. Install read-only = ON and read_only = OFF on g1.local. <br>  2. Killed the mysql process on g1.local and forced SST on startup. <br>  3. 2 other DB nodes are killed so that g1.local becomes non-primary. <br>  4. Run g1.local from non-primary status. <br>  5. Attached the other 2 nodes. <br><br>  <a href="https://asciinema.org/a/29799">The screencast</a> below will show the output of several terminals: <br><br><ul><li>  Terminal 1 (upper left corner): iptables PREROUTING output. </li><li>  Terminal 2 (upper right corner): MySQL error.log on g1.local. </li><li>  Terminal 3 (center left): application output when connected to the nginx balancer.  Shows date, hostname, wsrep_last_committed and wsrep_local_state_comment. </li><li>  Terminal 4 (center right): output / var / log / mysqlchk_iptables. </li><li>  Terminal 5 (left below): read_only and wsrep_sst_method output to g1.local. </li><li>  Terminal 6 (bottom right): working panel. </li></ul><br> <a href="https://asciinema.org/a/29799"><img src="https://habrastorage.org/files/903/c59/998/903c59998cfe4c75af70b185f8dc6fab.png"></a> <br><br><h4>  Conclusion </h4><br>  Verifying the performance of the nodes of the Galera cluster was limited to HAProxy, since only HAProxy allowed the use of a custom port.  With this <a href="https://github.com/ashraf-s9s/clustercheck-iptables">script,</a> you can use any TCP load balancer and / or proxy to correctly monitor the nodes of the Galera cluster. </div><p>Source: <a href="https://habr.com/ru/post/271467/">https://habr.com/ru/post/271467/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../271455/index.html">How to keep secret correspondence. Part 2</a></li>
<li><a href="../271457/index.html">The game "Life" on the logical elements</a></li>
<li><a href="../271459/index.html">Localization of mobile applications on the example of iOS. Implementation, support and development in the next versions</a></li>
<li><a href="../271461/index.html">Codesign.io - architecture that works</a></li>
<li><a href="../271465/index.html">The matrix of capabilities of modern messengers with an emphasis on security</a></li>
<li><a href="../271469/index.html">Zabyty on Mars: explore the travels of Mark Watney from The Martian movie</a></li>
<li><a href="../271471/index.html">The rise of Node.js - and why it will lead in the development of corporate software</a></li>
<li><a href="../271475/index.html">Parallel parsing of a large number of HTML pages using Apache Ignite (GridGain) in 200 lines of code</a></li>
<li><a href="../271477/index.html">Cooking ASP.NET 5: Continuous Deployment with Docker and Tutum</a></li>
<li><a href="../271479/index.html">Rabdological abacus Claude Perrot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>