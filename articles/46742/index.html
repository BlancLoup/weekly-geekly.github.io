<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Increase Zend Framework's performance by collecting its classes in one file.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Every time you launch a link, and ZendFramwork processes it on the server, there are unpleasant performance costs when building the PHP executable cod...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Increase Zend Framework's performance by collecting its classes in one file.</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/9b8/56d/85e/9b856d85ebae8cc874200c3f31fba6ac.gif" align="left">  Every time you launch a link, and ZendFramwork processes it on the server, there are unpleasant performance costs when building the PHP executable code with the interpreter. <br><br>  PHP can of course cache the opcode in memory using APC, Memcached, etc.  But before taking the opcode from memory, the hard disk is being accessed to make sure that the last modified date was updated.  When files are small, this happens unnoticed.  When there are many of them, a decrease in productivity begins to become noticeable. <br><br>  (In APC, of ‚Äã‚Äãcourse, you can configure that PHP interpreter does not check the date of files, but any change in files requires Apache to be restarted, which is not very convenient when developing). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The network has already met class assemblers, but they are not always correctly collected what you need. <br><br>  <b>Yes, this topic has already been raised several times, but I never found a single script that would correctly connect the classes Zend_Controller_Router_Route_Abstract and Zend_Controller_Router_Route_Chain.</b> <br><br><a name="habracut"></a><br><br>  Just run through the files and collect them into one does not work.  In the circle, inheritance from classes and interfaces is used.  And for correct compiling it is necessary that the class that goes after implements or extends be declared in the code earlier. <br><br>  This feature is implemented in the next class and when building, I do not think that you have any problems. <br><br>  So, you can run the compiler at the very end of the script execution after <b>Zend_Controller_Front :: getInstance () -&gt; dispatch ();</b>  (usually this line in index.php in the root folder of your project) using the following code: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">ZCompile::make( <font color="#A31515">'d:/www/project/lib/zendframework-1.7.1/Zend.compiled.phplib'</font> , <br> array(), <br> <font color="#A31515">'d:/www/project/lib/zendframework-1.7.1/'</font> <br> );</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  <b>The first parameter</b> specifies the path to the file into which all classes will be collected. <br>  <b>The second parameter</b> contains an array of additional files that need to be connected (about it a bit later). <br>  <b>The third parameter</b> contains the path to the framework library, at the <b>end a forward slash is required</b> '/'!  This directory is called Zend.  Those.  in my example, the Zend class files are in the d directory: /www/project/lib/zendframework-1.7.1/Zend/.  Again, you only need to specify the path to the Zend folder. <br><br>  After running the script, ZCompile will automatically take a list of necessary classes and write them into one file, observing the inheritance hierarchy. <br><br>  In the code, I usually use the following construction to choose to load the framework from the assembled file or from the standard library: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">if</font> (FRAMEWORK_LOAD_COMPILED_ZEND==1) { <br> require <font color="#A31515">'Zend.compiled.phplib'</font> ; <br> } <font color="#0000ff">else</font> { <br> require <font color="#A31515">'Zend/Loader.php'</font> ; <br> } <br> Zend_Loader::registerAutoload( <font color="#A31515">'Zend_Loader'</font> );</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  It is very convenient to keep the ‚Äúcompiled‚Äù file and the ZCompile class on the same level as the Zend folder (the framework library).  Those.  I have them stored in the directory d: /www/project/lib/zendframework-1.7.1/ <br><br>  So, remember, I told you about the <b>second parameter</b> , which is an array.  So, it allows you to connect those classes that were not used in the current script, but are needed in the project. <br>  There simply indicate the main classes or directories that you want to connect.  For example: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">array( <br> <font color="#A31515">'Zend/Auth/'</font> , <font color="#008000">//    ,    </font> <br> <font color="#A31515">'Zend/Acl/'</font> , <font color="#008000">//    ,    </font> <br> <font color="#A31515">'Zend/View/Helper/HeadTitle.php'</font> , <font color="#008000">//   </font> <br> <font color="#A31515">'Zend/View/Helper/Url.php'</font> , <font color="#008000">//   </font> <br> )</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  When a directory is connected, all files are read only at the current level, we don‚Äôt go into the subdirectories.  When we connect a pure class, we read only it. <br>  <b>BUT</b> when connecting a class (through a directory or directly) ZCompile collects all the classes necessary for the specified file to work.  Those.  if you specify the 'Zend / Auth /' directory, then it will most likely collect everything contained in the specified folder including subdirectories. <br><br>  You can simply execute the following code in a separate file, which will simply collect Acl and Auth for you: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;?php <br> <br> set_include_path( <br> <font color="#A31515">'d:/www/ksystem/lib/zendframework-1.7.1/'</font> <br> . PATH_SEPARATOR . get_include_path()); <br> <br> ZCompile::make( <font color="#A31515">'d:/www/project/lib/zendframework-1.7.1/Zend.compiled.phplib'</font> , <br> array( <font color="#A31515">'Zend/Auth/'</font> , <font color="#A31515">'Zend/Acl/'</font> ), <br> <font color="#A31515">'d:/www/ksystem/lib/zendframework-1.7.1/'</font> <br> ); <br> ?&gt;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  So, the ZCompile class itself (we don‚Äôt find fault with mistakes in the comments, this is not the main thing! There was no time to fix them;)): <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;?php <br> <font color="#008000">/**</font> <br> <font color="#008000">*     ZendFramwork   .</font> <br> <font color="#008000">*</font> <br> <font color="#008000">* @author Nod nodkz.at.mail.ru</font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">class</font> ZCompile <br> { <br> <font color="#0000ff">static</font> <font color="#0000ff">private</font> $path; <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*      , require/include,  </font> <br> <font color="#008000">*</font> <br> <font color="#008000">* @param string $dest    </font> <br> <font color="#008000">* @param string $includes   ZF  </font> <br> <font color="#008000">* @return array</font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> function make($dest, array $add_includes = array(), $path = <font color="#A31515">''</font> ) <br> { <br> self::$path=$path; <br> $includes=array_merge($add_includes, self::_scanFolderFiles($add_includes), self::_getZendIncludes()); <br> <br> <font color="#008000">//   </font> <br> <font color="#0000ff">foreach</font> ($includes <font color="#0000ff">as</font> $key=&gt;&amp;$ <font color="#0000ff">value</font> ) { <br> <font color="#0000ff">if</font> (substr($ <font color="#0000ff">value</font> ,0,1)== <font color="#A31515">'/'</font> ) { <br> $includes[$key] = substr($ <font color="#0000ff">value</font> ,1); <br> } <br> } <br> <br> <font color="#008000">//     </font> <br> $ordered_include=Array(); <br> <font color="#0000ff">foreach</font> ($includes <font color="#0000ff">as</font> $class_file) { <br> self::_getClassOrderIncludes($class_file, $ordered_include); <br> } <br> <br> <font color="#008000">//   '&lt;?php' '? &gt;',  ,    require/include[_once]</font> <br> <font color="#008000">//    </font> <br> $pattern[] = <font color="#A31515">'%(^\&lt;\?php|\?\&gt;$)%m'</font> ; <br> $replacement[] = <font color="#A31515">''</font> ; <br> $pattern[] = <font color="#A31515">'%/\*.*?\*/%sm'</font> ; <br> $replacement[] = <font color="#A31515">''</font> ; <br> <font color="#008000">//$pattern[] ='%//.*$%m';</font> <br> <font color="#008000">//$replacement[] = '';</font> <br> $pattern[] = <font color="#A31515">'%(require_once|include_once|require|include) [("\'](.*?)[)"\'];%sm'</font> ; <br> $replacement[] = <font color="#A31515">''</font> ; <br> $pattern[] = <font color="#A31515">'%(\n){2,}%'</font> ; <br> $replacement[] = <font color="#A31515">"\n"</font> ; <br> <br> $body = <font color="#A31515">"&lt;?php\n"</font> ; <br> $worked_classes = Array(); <br> <font color="#0000ff">foreach</font> ($ordered_include <font color="#0000ff">as</font> &amp;$fname) { <br> <font color="#0000ff">if</font> (!in_array($fname, $worked_classes)) { <br> $worked_classes[] = $fname; <br> <br> $fname = self::$path.$fname; <br> <font color="#0000ff">if</font> (@file_exists($fname)&amp;&amp;is_file($fname)) { <br> $body.= <font color="#A31515">"/*** FILE: "</font> .$fname. <font color="#A31515">" ***/ \r\n"</font> ; <br> $body .= preg_replace($pattern, $replacement, file_get_contents($fname, <font color="#0000ff">true</font> )); <br> } <br> } <br> } <br> <br> $size = file_put_contents($dest, $body); <br> <br> <font color="#0000ff">return</font> array( <font color="#A31515">'includes'</font> =&gt; $includes, <font color="#A31515">'compiledBody'</font> =&gt; $body, <font color="#A31515">'compiledSize'</font> =&gt; $size); <br> } <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*       (..   /).</font> <br> <font color="#008000">*      php ,      (  ).</font> <br> <font color="#008000">*</font> <br> <font color="#008000">* @param array $add_includes</font> <br> <font color="#008000">* @return array</font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> function _scanFolderFiles(&amp;$add_includes) { <br> $add_includes_dirs=array(); <br> <font color="#0000ff">foreach</font> ($add_includes <font color="#0000ff">as</font> $key=&gt;$elem) { <br> <font color="#0000ff">if</font> (substr($elem,-1)== <font color="#A31515">'/'</font> ) { <br> <font color="#0000ff">if</font> (is_dir(self::$path.$elem)) { <br> <font color="#0000ff">if</font> ($dh = opendir(self::$path.$elem)) { <br> <font color="#0000ff">while</font> (($file = readdir($dh)) !== <font color="#0000ff">false</font> ) { <br> <font color="#0000ff">if</font> (strpos(strtolower($file), <font color="#A31515">'.php'</font> )!== <font color="#0000ff">false</font> ) { <br> $add_includes_dirs[]=$elem.$file; <br> } <br> } <br> closedir($dh); <br> } <br> } <br> $add_includes[$key]= <font color="#A31515">''</font> ; <br> } <br> } <br> <font color="#0000ff">return</font> $add_includes_dirs; <br> } <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*        ,  .</font> <br> <font color="#008000">*</font> <br> <font color="#008000">* @param string $fname</font> <br> <font color="#008000">* @param array &amp;$already_included</font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> function _getClassOrderIncludes($class_filename, array &amp;$already_included=Array(), array &amp;$stack=Array()) { <br> <font color="#008000">//     </font> <br> <font color="#0000ff">if</font> (!in_array($class_filename, $stack)) { <br> array_push($stack, $class_filename); <br> } <font color="#0000ff">else</font> { <br> <font color="#0000ff">if</font> (!in_array($class_filename, $already_included)) { <br> $already_included[]=$class_filename; <br> } <br> <font color="#0000ff">return</font> ; <br> } <br> <br> <font color="#008000">//         </font> <br> <font color="#0000ff">if</font> (is_file(self::$path.$class_filename) &amp;&amp; !in_array($class_filename, $already_included)) { <br> $class_file_content = file_get_contents(self::$path.$class_filename, <font color="#0000ff">true</font> ); <br> <br> <font color="#008000">//      </font> <br> <font color="#008000">// ..     extends  implements,</font> <br> <font color="#008000">//         </font> <br> <font color="#0000ff">if</font> (preg_match_all( <font color="#A31515">'/class\s+[_\w]+\s+(extends|implements)\s+([_\w]+)/i'</font> , $class_file_content, $arr)) { <br> <font color="#0000ff">foreach</font> ($arr[2] <font color="#0000ff">as</font> $new_class_name) { <br> $new_class_path = str_replace( <font color="#A31515">'_'</font> , <font color="#A31515">'/'</font> ,$new_class_name). <font color="#A31515">'.php'</font> ; <br> <font color="#0000ff">if</font> (!in_array($new_class_path, $already_included)) { <br> self::_getClassOrderIncludes($new_class_path, $already_included, $stack); <br> } <br> } <br> } <br> <br> <font color="#008000">//          </font> <br> <font color="#0000ff">if</font> (preg_match_all( <font color="#A31515">'%(require_once|include_once|require|include) [("\'](.*?)[)"\'];%sm'</font> , $class_file_content, $arr)) { <br> <font color="#008000">//    </font> <br> <font color="#0000ff">foreach</font> ($arr[2] <font color="#0000ff">as</font> $new_class_path) { <br> <font color="#008000">//   ,      ,     </font> <br> <font color="#0000ff">if</font> (!in_array($new_class_path, $already_included) &amp;&amp; !in_array($new_class_path, $stack)) { <br> <font color="#008000">//      </font> <br> <font color="#0000ff">if</font> (strpos($new_class_path, <font color="#A31515">'$'</font> )=== <font color="#0000ff">false</font> ) { <br> <font color="#008000">//   ,      </font> <br> self::_getClassOrderIncludes($new_class_path, $already_included, $stack); <br> } <br> } <br> } <br> } <br> <font color="#0000ff">if</font> (!in_array($class_filename, $already_included)) { <br> $already_included[]=$class_filename; <br> } <br> } <br> <br> array_pop($stack); <br> } <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*    ZF   </font> <br> <font color="#008000">*</font> <br> <font color="#008000">* @return array</font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> function _getZendIncludes() <br> { <br> $required = array(); <br> $included_files = get_included_files(); <br> $included_files; <br> <font color="#0000ff">foreach</font> ($included_files <font color="#0000ff">as</font> $fname) { <br> $fname = str_replace( <font color="#A31515">'/'</font> , <font color="#A31515">'\\',$fname); <br> <br> if (!(strpos($fname, '</font> \\Zend\\ <font color="#A31515">') &gt; 0) || (strstr($fname, __CLASS__ . '</font> .php <font color="#A31515">'))) { <br> continue; <br> } <br> <br> $required[] = str_replace('</font> \\ <font color="#A31515">', '</font> / <font color="#A31515">', substr($fname, strpos($fname, '</font> \\Zend\\'), strlen($fname))); <br> } <br> <br> <font color="#0000ff">return</font> array_unique($required); <br> } <br> } <br> ?&gt;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  <a href="http://zaley.in/file.get.581973415">Download class</a> <br><br>  Use, on health. </div><p>Source: <a href="https://habr.com/ru/post/46742/">https://habr.com/ru/post/46742/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../46735/index.html">Named Scope for CakePHP</a></li>
<li><a href="../46736/index.html">Fallout 3: Operation Anchorage. Screenshots</a></li>
<li><a href="../46738/index.html">Phone with a removable camera</a></li>
<li><a href="../46739/index.html">Find for the photographer - The Super-Secret Spy Lens!</a></li>
<li><a href="../46741/index.html">SignalSlot architecture for PHP web applications on the example of ezComponents</a></li>
<li><a href="../46744/index.html">Banner Top Habr√©</a></li>
<li><a href="../46746/index.html">Coolpoint - interesting events near you</a></li>
<li><a href="../46747/index.html">Holiday calendar "hardware"</a></li>
<li><a href="../46750/index.html">Microsoft Office Groove 2007 is free and almost free</a></li>
<li><a href="../46751/index.html">Habr began to work more slowly lately?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>