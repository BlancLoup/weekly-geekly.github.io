<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Script for setting up MultiHomed linux router</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not being a full-fledged system administrator, I often encounter the need to configure the gateway. While the external interface was one - just change...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Script for setting up MultiHomed linux router</h1><div class="post__text post__text-html js-mediator-article">  Not being a full-fledged system administrator, I often encounter the need to configure the gateway.  While the external interface was one - just changed the relatively universal script to bash, compiled on the Internet and lartc.com.  When there were options with 2 Internet providers - I was honored to write a script, with settings grouped for ease of change. <br>  The script can: <ul><li>  set up Internet distribution using NAT </li><li>  open ports </li><li>  forward ports </li><li>  use more than one provider </li><li>  apply additionally described rules and routes </li><li>  execute additionally written commands </li></ul><a name="habracut"></a><br><br><h2>  Description </h2><br>  It is arranged in such a way that the main python script, according to the settings in itself, forms the bash script, which runs it.  Such a freak turned out for a reason, sufficiently weighty, that it could not be ignored, but not sufficiently adequate, to voice it.  Download the script with the settings you can <a href="https://docs.google.com/open%3Fid%3D0B6bVNSTwUcJNSkI4SGhyaHBUVy0xb2N4SVJSbjFmQQ">link</a> . <br>  And here his device is described. <br><br><h2>  Settings </h2><br>  The python script msr_ip.py starts with the required introductory lines: <br><blockquote>  <font color="#808080">#! / usr / bin / env python</font> <br>  <font color="#808080"># - * - coding: utf-8 - * -</font> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <font color="#808080"># settings are here</font> </blockquote><br><br>  Next comes a stream of settings, first a description of the interfaces: <br><blockquote>  ifaces = <font>[</font> <br>  <font>{</font> <br>  <font color="#483d8b">"dev"</font> : <font color="#483d8b">"eth1"</font> , <br>  <font color="#483d8b">"ip"</font> : <font color="#483d8b">"192.168.0.1"</font> , <br>  <font color="#483d8b">"role"</font> : <font color="#483d8b">"local"</font> <br>  <font>}</font> , <br>  <font>{</font> <br>  <font color="#483d8b">"dev"</font> : <font color="#483d8b">"eth2"</font> <br>  <font>}</font> , <br>  <font>{</font> <br>  <font color="#483d8b">"dev"</font> : <font color="#483d8b">"eth3"</font> , <br>  <font color="#483d8b">"ip"</font> : <font color="#483d8b">"1.2.3.4"</font> , <br>  <font color="#483d8b">"gw"</font> : <font color="#483d8b">"1.2.3.1"</font> , <br>  <font color="#483d8b">"table"</font> : <font color="#483d8b">"NewComPort"</font> , <br>  <font color="#483d8b">"mark"</font> : <font color="#483d8b">"0x2"</font> , <br>  <font color="#483d8b">"role"</font> : <font color="#483d8b">"external"</font> , <br>  <font color="#483d8b">"weight"</font> : <font color="#ff4500">7</font> <br>  <font>}</font> , <br>  <font>{</font> <br>  <font color="#483d8b">"dev"</font> : <font color="#483d8b">"ppp0"</font> , <br>  <font color="#483d8b">"gw"</font> : <font color="#483d8b">"5.6.7.1"</font> , <br>  <font color="#483d8b">"table"</font> : <font color="#483d8b">"velnet"</font> , <br>  <font color="#483d8b">"mark"</font> : <font color="#483d8b">"0x1"</font> , <br>  <font color="#483d8b">"role"</font> : <font color="#483d8b">"external"</font> , <br>  <font color="#483d8b">"weight"</font> : <font color="#ff4500">3</font> <br>  <font>}</font> , <br>  <font>{</font> <br>  <font color="#483d8b">"dev"</font> : <font color="#483d8b">"tun0"</font> , <br>  <font color="#483d8b">"ip"</font> : <font color="#483d8b">"192.168.1.1"</font> , <br>  <font color="#483d8b">"table"</font> : <font color="#483d8b">"VPN"</font> , <br>  <font color="#483d8b">"mark"</font> : <font color="#483d8b">"0x4"</font> , <br>  <font color="#483d8b">"role"</font> : <font color="#483d8b">"local"</font> <br>  <font>}</font> <br>  <font>]</font> </blockquote><br>  The interface has the following properties, which are actually dictionary elements: <br>  <b>dev</b> is the name of the interface, the only required element; <br>  <b>gw</b> - gateway; <br>  <b>table</b> - the number or name of the routing table, if the name is specified, then it should already be in the / etc / iproute2 / rt_tables file.  Required for external interfaces; <br>  <b>mark</b> - label for packages, used if you add your own rules with its use; <br>  <b>role</b> - role, can be external, local or none.  If external - the interface is considered external, respectively, it is NATit and does not accept new connections from the outside.  If local - the interface is local: NAT and can create a new connection to the outside; <br>  <b>weight</b> is the weight for route-based outbound load balancing. <br>  If the external interface is not raised, it will not be listed among the default routes. <br>  Now the ports that need to be opened and / or forward are described .: <br><blockquote>  Ports = <font>[</font> <br>  <font>{</font> <br>  <font color="#483d8b">"proto"</font> : <font color="#483d8b">"tcp"</font> , <br>  <font color="#483d8b">"tPort"</font> : <font color="#ff4500">22</font> , <br>  <font color="#483d8b">"sHost"</font> : <font color="#008000">None</font> , <br>  <font color="#483d8b">"nPort"</font> : <font color="#008000">None</font> , <br>  <font color="#483d8b">"dHost"</font> : <font color="#008000">None</font> <br>  <font>}</font> <br>  , <br>  <font>{</font> <font color="#808080"># let's solve the whole protocol right away</font> <br>  <font color="#483d8b">"proto"</font> : <font color="#483d8b">"icmp"</font> , <br>  <font color="#483d8b">"tPort"</font> : <font color="#008000">None</font> , <br>  <font color="#483d8b">"sHost"</font> : <font color="#008000">None</font> , <br>  <font color="#483d8b">"nPort"</font> : <font color="#008000">None</font> , <br>  <font color="#483d8b">"dHost"</font> : <font color="#008000">None</font> <br>  <font>}</font> <br>  , <br>  <font>{</font> <font color="#808080"># forwarding RDP from internet to LAN on 192.168.0.3</font> <br>  <font color="#483d8b">"proto"</font> : <font color="#483d8b">"tcp"</font> , <br>  <font color="#483d8b">"tPort"</font> : <font color="#ff4500">3389</font> , <br>  <font color="#483d8b">"sHost"</font> : <font color="#008000">None</font> , <br>  <font color="#483d8b">"nPort"</font> : <font color="#ff4500">3389</font> , <br>  <font color="#483d8b">"dHost"</font> : <font color="#483d8b">"192.168.0.3"</font> <br>  <font>}</font> <br>  , <br>  <font>{</font> <font color="#808080"># forwarding RDP from Internet with port changed to 3390 to 192.168.0.2</font> <br>  <font color="#483d8b">"proto"</font> : <font color="#483d8b">"tcp"</font> , <br>  <font color="#483d8b">"tPort"</font> : <font color="#ff4500">3390</font> , <br>  <font color="#483d8b">"sHost"</font> : <font color="#008000">None</font> , <br>  <font color="#483d8b">"nPort"</font> : <font color="#ff4500">3389</font> , <br>  <font color="#483d8b">"dHost"</font> : <font color="#483d8b">"192.168.0.2"</font> <br>  <font>}</font> <br>  , <br>  <font>{</font> <font color="#808080"># web control from only one remote host</font> <br>  <font color="#483d8b">"proto"</font> : <font color="#483d8b">"tcp"</font> , <br>  <font color="#483d8b">"tPort"</font> : <font color="#ff4500">80</font> , <br>  <font color="#483d8b">"sHost"</font> : <font color="#483d8b">"9.8.7.6"</font> , <br>  <font color="#483d8b">"nPort"</font> : <font color="#008000">None</font> , <br>  <font color="#483d8b">"dHost"</font> : <font color="#008000">None</font> <br>  <font>}</font> <br>  , <br>  <font>{</font> <font color="#808080"># openVPN for all</font> <br>  <font color="#483d8b">"proto"</font> : <font color="#483d8b">"tcp"</font> , <br>  <font color="#483d8b">"tPort"</font> : <font color="#ff4500">1194</font> , <br>  <font color="#483d8b">"sHost"</font> : <font color="#008000">None</font> , <br>  <font color="#483d8b">"nPort"</font> : <font color="#008000">None</font> , <br>  <font color="#483d8b">"dHost"</font> : <font color="#008000">None</font> <br>  <font>}</font> <br>  <font>]</font> </blockquote><br>  From the examples everything should be clear, but for the order I will describe: <br>  <b>proto</b> - protocol; <br>  <b>tPort</b> - external port that opens; <br>  <b>sHost</b> - restriction, if necessary, to the source address; <br>  <b>nPort</b> - new port when forwarding; <br>  <b>dHost</b> - the host to which the port is being forwarded. <br><br>  Now the rules are used to bind nodes to external interfaces: <br><blockquote>  rules = <font>[</font> <br>  <font>{</font> <font color="#808080"># provider statistics through his gateway</font> <br>  <font color="#483d8b">"to"</font> : <font color="#483d8b">"213.79.2.30"</font> , <font color="#808080"># stats</font> <br>  <font color="#483d8b">"lookup"</font> : <font color="#483d8b">"velnet"</font> <br>  <font>}</font> , <br>  <font>{</font> <font color="#808080"># VMs on VM table</font> <br>  <font color="#483d8b">"from"</font> : <font color="#483d8b">"192.168.0.150"</font> , <br>  <font color="#483d8b">"lookup"</font> : <font color="#483d8b">"VM"</font> <br>  <font>}</font> , <br>  <font>{</font> <font color="#808080"># VMs on VM table</font> <br>  <font color="#483d8b">"from"</font> : <font color="#483d8b">"192.168.0.151"</font> , <br>  <font color="#483d8b">"lookup"</font> : <font color="#483d8b">"VM"</font> <br>  <font>}</font> <br>  <font>]</font> </blockquote><br>  The rules from the example use few properties, but you can apply more, I tried to cover everything that is supported by the ip rule command. <br>  <b>cmd</b> - command, the default is add = add rule; <br>  <b>priority</b> - priority, if not specified, then auto-numbered from 1 in the order of mention; <br>  <b>fwmark</b> - packet label; <br>  <b>from</b> - source; <br>  <b>to</b> - destination; <br>  <b>lookup</b> - table; <br><br>  Now the routes: <br><blockquote>  routes = <font>[</font> <br>  <font>{</font> <font color="#808080"># Network behind VPN client</font> <br>  <font color="#483d8b">"to"</font> : <font color="#483d8b">"192.168.8.0"</font> , <br>  <font color="#483d8b">"dev"</font> : <font color="#483d8b">"tun0"</font> <br>  <font>}</font> , <br>  <font>{</font> <font color="#808080"># VM virtualok table through one provider</font> <br>  <font color="#483d8b">"to"</font> : <font color="#483d8b">"default"</font> , <br>  <font color="#483d8b">"via"</font> : <font color="#483d8b">"5.6.7.8"</font> , <br>  <font color="#483d8b">"dev"</font> : <font color="#483d8b">"ppp0"</font> , <br>  <font color="#483d8b">"table"</font> : <font color="#483d8b">"VM"</font> <br>  <font>}</font> <br>  <font>]</font> <br></blockquote><br>  <b>to</b> - destination; <br>  <b>via</b> - through which gateway; <br>  <b>dev</b> - through which interface; <br>  <b>table</b> - for which table. <br><br>  Finally, the last portion of the settings <br><blockquote>  ext_sure_ip = <font color="#483d8b">"8.8.8.8"</font> <br>  customcommands = <font color="#483d8b">"" "</font> <font color="#483d8b"><br></font>  <font color="#483d8b">"" "</font> <br>  cmdfile = <font color="#483d8b">"/root/msr_ip.run"</font> <br></blockquote><br><br>  <b>ext_sure_ip</b> - For external interfaces, which address should be pinged for a health check, at the moment this does not affect anything; <br>  <b>customcommands</b> - commands that must be executed after all the settings; <br>  <b>cmdfile</b> - The file in which the resulting script is written. <br><br><h2>  Script body </h2><br>  Now only the script itself is going on and there will be no more settings, which is what the Perf line of the fragment happily reports: <br><blockquote> <font color="#808080"># == no more configuration settings below this line =======================</font> <br><br>  <font color="#ff7700">import</font> <font color="#dc143c">os</font> <br>  <font color="#ff7700">import</font> <font color="#dc143c">syslog</font> <br>  <font color="#ff7700">import</font> <font color="#dc143c">subprocess</font> <br><br>  <font color="#dc143c">syslog</font>  <font color="#dc143c">syslog</font> <font>(</font> <font color="#483d8b">"Started"</font> <font>)</font> <br><br>  fields = <font>(</font> <font color="#483d8b">"dev"</font> , <font color="#483d8b">"ip"</font> , <font color="#483d8b">"gw"</font> , <font color="#483d8b">"table"</font> , <font color="#483d8b">"mark"</font> , <font color="#483d8b">"works"</font> , <font color="#483d8b">"state"</font> , <font color="#483d8b">"role"</font> , <font color="#483d8b">"type"</font> , <font color="#483d8b">"weight"</font> <font>)</font> <br>  fout = <font color="#008000">open</font> <font>(</font> cmdfile, <font color="#483d8b">'w'</font> <font>)</font> <br>  priority = <font color="#ff4500">1</font> <br><br>  <font color="#808080"># == add system's rules</font> <br>  rules = rules + <font>[</font> <br>  <font>{</font> <font color="#483d8b">"priority"</font> : <font color="#ff4500">100</font> , <font color="#483d8b">"from"</font> : <font color="#483d8b">"all"</font> , <font color="#483d8b">"lookup"</font> : <font color="#483d8b">"local"</font> <font>}</font> , <br>  <font>{</font> <font color="#483d8b">"priority"</font> : <font color="#ff4500">32766</font> , <font color="#483d8b">"from"</font> : <font color="#483d8b">"all"</font> , <font color="#483d8b">"lookup"</font> : <font color="#483d8b">"main"</font> <font>}</font> , <br>  <font>{</font> <font color="#483d8b">"priority"</font> : <font color="#ff4500">32767</font> , <font color="#483d8b">"from"</font> : <font color="#483d8b">"all"</font> , <font color="#483d8b">"lookup"</font> : <font color="#483d8b">"default"</font> <font>}</font> <br>  <font>]</font> <br><br><br>  <font color="#ff7700">def</font> isup <font>(</font> dev <font>)</font> : <br>  x = <font color="#dc143c">subprocess</font> .  <font>call</font> <font>(</font> <font>[</font> <font color="#483d8b">"ifconfig"</font> , dev <font>]</font> , stdin = <font color="#008000">None</font> , stdout = <font color="#008000">open</font> <font>(</font> <font color="#483d8b">'/ dev / null'</font> , <font color="#483d8b">'w'</font> <font>)</font> , stderr = <font color="#008000">open</font> <font>(</font> <font color="#483d8b">'/ dev / null'</font> , <font color="#483d8b">'w'</font> <font>)</font> , shell = <font color="#008000">False</font> <font>)</font> <br>  <font color="#ff7700">if</font> <font>(</font> x == <font color="#ff4500">0</font> <font>)</font> : <br>  r = <font color="#483d8b">"up"</font> <br>  <font color="#ff7700">else</font> : <br>  r = <font color="#483d8b">"down"</font> <br>  <font color="#ff7700">return</font> r <br><br>  <font color="#ff7700">def</font> works <font>(</font> dev <font>)</font> : <br>  <font color="#808080"># global ext_sure_ip</font> <br>  x = <font color="#dc143c">subprocess</font> .  <font>call</font> <font>(</font> <font>[</font> <font color="#483d8b">"ping"</font> , <font color="#483d8b">"-I"</font> + dev, <font color="#483d8b">"-c 3"</font> , <font color="#483d8b">"-w 5"</font> , ext_sure_ip <font>]</font> , stdin = <font color="#008000">None</font> , stdout = <font color="#008000">open</font> <font>(</font> <font color="#483d8b">'/ dev / null'</font> , <font color="#483d8b">'w'</font> <font>)</font> , stderr = <font color="#008000">open</font> <font>(</font> <font color="#483d8b">'/ dev / null'</font> , <font color="#483d8b">'w'</font> <font>)</font> , shell = <font color="#008000">False</font> <font>)</font> <br>  <font color="#ff7700">if</font> <font>(</font> x == <font color="#ff4500">0</font> <font>)</font> : <br>  r = <font color="#008000">true</font> <br>  <font color="#ff7700">else</font> : <br>  r = <font color="#008000">False</font> <br>  <font color="#ff7700">return</font> r <br><br>  <font color="#ff7700">def</font> addmissingfields <font>(</font> iface <font>)</font> : <br>  <font color="#ff7700">for</font> fld <font color="#ff7700">in</font> fields: <br>  <font color="#ff7700">if</font> <font color="#ff7700">not</font> <font>(</font> fld <font color="#ff7700">in</font> iface <font>)</font> : <br>  iface <font>[</font> fld <font>]</font> = <font color="#008000">None</font> <br><br>  <font color="#ff7700">def</font> openportcmd <font>(</font> port <font>)</font> : <br>  r = <font color="#483d8b">"n $ IPTABLES -t filter -A INPUT"</font> <br>  <font color="#ff7700">if</font> port <font>[</font> <font color="#483d8b">"sHost"</font> <font>]</font> : <br>  r = r + <font color="#483d8b">"-s {0}"</font> .  <font>format</font> <font>(</font> port <font>[</font> <font color="#483d8b">"sHost"</font> <font>]</font> <font>)</font> <br>  <font color="#ff7700">if</font> port <font>[</font> <font color="#483d8b">"proto"</font> <font>]</font> : <br>  r = r + <font color="#483d8b">"-p {0}"</font> .  <font>format</font> <font>(</font> port <font>[</font> <font color="#483d8b">"proto"</font> <font>]</font> <font>)</font> <br>  <font color="#ff7700">if</font> port <font>[</font> <font color="#483d8b">"tPort"</font> <font>]</font> : <br>  r = r + <font color="#483d8b">"--dport {0}"</font> .  <font>format</font> <font>(</font> port <font>[</font> <font color="#483d8b">"tPort"</font> <font>]</font> <font>)</font> <br>  r = r + <font color="#483d8b">"-j ACCEPT"</font> <br>  <font color="#ff7700">return</font> r <br><br>  <font color="#ff7700">def</font> forwardportcmd <font>(</font> port <font>)</font> : <br>  <font color="#ff7700">if</font> port <font>[</font> <font color="#483d8b">"dHost"</font> <font>]</font> : <br>  <font color="#808080"># allow $ IPTABLES -A FORWARD -p tcp --dport 3389 -j ACCEPT</font> <br>  r = <font color="#483d8b">"n $ IPTABLES -A FORWARD"</font> <br>  <font color="#ff7700">if</font> port <font>[</font> <font color="#483d8b">"proto"</font> <font>]</font> : <br>  r = r + <font color="#483d8b">"-p {0}"</font> .  <font>format</font> <font>(</font> port <font>[</font> <font color="#483d8b">"proto"</font> <font>]</font> <font>)</font> <br>  <font color="#ff7700">if</font> port <font>[</font> <font color="#483d8b">"nPort"</font> <font>]</font> : <br>  r = r + <font color="#483d8b">"--dport {0}"</font> .  <font>format</font> <font>(</font> port <font>[</font> <font color="#483d8b">"nPort"</font> <font>]</font> <font>)</font> <br>  r = r + <font color="#483d8b">"-j ACCEPT"</font> <br><br>  <font color="#808080"># forward</font> <br>  r = r + <font color="#483d8b">"n $ IPTABLES -t nat -A PREROUTING"</font> <br>  <font color="#ff7700">if</font> port <font>[</font> <font color="#483d8b">"sHost"</font> <font>]</font> : <br>  r = r + <font color="#483d8b">"-s {0}"</font> .  <font>format</font> <font>(</font> port <font>[</font> <font color="#483d8b">"sHost"</font> <font>]</font> <font>)</font> <br>  <font color="#ff7700">if</font> port <font>[</font> <font color="#483d8b">"proto"</font> <font>]</font> : <br>  r = r + <font color="#483d8b">"-p {0}"</font> .  <font>format</font> <font>(</font> port <font>[</font> <font color="#483d8b">"proto"</font> <font>]</font> <font>)</font> <br>  <font color="#ff7700">if</font> port <font>[</font> <font color="#483d8b">"tPort"</font> <font>]</font> : <br>  r = r + <font color="#483d8b">"--dport {0}"</font> .  <font>format</font> <font>(</font> port <font>[</font> <font color="#483d8b">"tPort"</font> <font>]</font> <font>)</font> <br>  r = r + <font color="#483d8b">"-j DNAT --to-destination {0}"</font> .  <font>format</font> <font>(</font> port <font>[</font> <font color="#483d8b">"dHost"</font> <font>]</font> <font>)</font> <br>  <font color="#ff7700">if</font> port <font>[</font> <font color="#483d8b">"nPort"</font> <font>]</font> : <br>  r = r + <font color="#483d8b">": {0}"</font> .  <font>format</font> <font>(</font> port <font>[</font> <font color="#483d8b">"nPort"</font> <font>]</font> <font>)</font> <br>  <font color="#ff7700">return</font> r <br>  <font color="#ff7700">else</font> : <br>  <font color="#ff7700">return</font> <font color="#483d8b">""</font> <br><br>  <font color="#ff7700">def</font> rulecmd <font>(</font> rule <font>)</font> : <br>  <font color="#ff7700">global</font> priority <br>  priority = priority + <font color="#ff4500">1</font> <br>  r = <font color="#483d8b">"nip rule"</font> <br>  <font color="#ff7700">if</font> <font>(</font> <font color="#483d8b">"cmd"</font> <font color="#ff7700">in</font> rule <font>)</font> <font color="#ff7700">and</font> <font>(</font> rule <font>[</font> <font color="#483d8b">"cmd"</font> <font>]</font> <font>)</font> : <br>  r = r + <font color="#483d8b">"{0}"</font> .  <font>rule</font> <font>[</font> <font color="#483d8b">"cmd"</font> <font>]</font> <br>  <font color="#ff7700">else</font> : <br>  r = r + <font color="#483d8b">"add"</font> <br><br>  <font color="#ff7700">if</font> <font>(</font> <font color="#483d8b">"priority"</font> <font color="#ff7700">in</font> rule <font>)</font> <font color="#ff7700">and</font> <font>(</font> rule <font>[</font> <font color="#483d8b">"priority"</font> <font>]</font> <font>)</font> : <br>  r = r + <font color="#483d8b">"priority {0}"</font> .  <font>format</font> <font>(</font> rule <font>[</font> <font color="#483d8b">"priority"</font> <font>]</font> <font>)</font> <br>  <font color="#ff7700">else</font> : <br>  r = r + <font color="#483d8b">"priority {0}"</font> .  <font>format</font> <font>(</font> priority <font>)</font> <br><br>  <font color="#ff7700">if</font> <font>(</font> <font color="#483d8b">"fwmark"</font> <font color="#ff7700">in</font> rule <font>)</font> <font color="#ff7700">and</font> <font>(</font> rule <font>[</font> <font color="#483d8b">"fwmark"</font> <font>]</font> <font>)</font> : <br>  r = r + <font color="#483d8b">"fwmark {0} / {0}"</font> .  <font>format</font> <font>(</font> rule <font>[</font> <font color="#483d8b">"fwmark"</font> <font>]</font> <font>)</font> <br><br>  <font color="#ff7700">if</font> <font>(</font> <font color="#483d8b">"from"</font> <font color="#ff7700">in</font> rule <font>)</font> <font color="#ff7700">and</font> <font>(</font> rule <font>[</font> <font color="#483d8b">"from"</font> <font>]</font> <font>)</font> : <br>  r = r + <font color="#483d8b">"from {0}"</font> .  <font>format</font> <font>(</font> rule <font>[</font> <font color="#483d8b">"from"</font> <font>]</font> <font>)</font> <br><br>  <font color="#ff7700">if</font> <font>(</font> <font color="#483d8b">"to"</font> <font color="#ff7700">in</font> rule <font>)</font> <font color="#ff7700">and</font> <font>(</font> rule <font>[</font> <font color="#483d8b">"to"</font> <font>]</font> <font>)</font> : <br>  r = r + <font color="#483d8b">"to {0}"</font> .  <font>format</font> <font>(</font> rule <font>[</font> <font color="#483d8b">"to"</font> <font>]</font> <font>)</font> <br><br>  <font color="#ff7700">if</font> <font>(</font> <font color="#483d8b">"lookup"</font> <font color="#ff7700">in</font> rule <font>)</font> <font color="#ff7700">and</font> <font>(</font> rule <font>[</font> <font color="#483d8b">"lookup"</font> <font>]</font> <font>)</font> : <br>  r = r + <font color="#483d8b">"lookup {0}"</font> .  <font>format</font> <font>(</font> rule <font>[</font> <font color="#483d8b">"lookup"</font> <font>]</font> <font>)</font> <br><br>  <font color="#ff7700">return</font> r <br><br>  <font color="#ff7700">def</font> routecmd <font>(</font> route <font>)</font> : <br>  r = <font color="#483d8b">"nip route add"</font> <br>  <font color="#ff7700">if</font> <font>(</font> <font color="#483d8b">"to"</font> <font color="#ff7700">in</font> route <font>)</font> <font color="#ff7700">and</font> <font>(</font> route <font>[</font> <font color="#483d8b">"to"</font> <font>]</font> <font>)</font> : <br>  r = r + <font color="#483d8b">"{0}"</font> .  <font>format</font> <font>(</font> route <font>[</font> <font color="#483d8b">"to"</font> <font>]</font> <font>)</font> <br>  <font color="#808080"># if ("netmask" in route) and (route ["netmask"]):</font> <br>  <font color="#808080"># r = r + "/ {0}". format (route ["netmask"])</font> <br>  <font color="#ff7700">if</font> <font>(</font> <font color="#483d8b">"via"</font> <font color="#ff7700">in</font> route <font>)</font> <font color="#ff7700">and</font> <font>(</font> route <font>[</font> <font color="#483d8b">"via"</font> <font>]</font> <font>)</font> : <br>  r = r + <font color="#483d8b">"via {0}"</font> .  <font>format</font> <font>(</font> route <font>[</font> <font color="#483d8b">"via"</font> <font>]</font> <font>)</font> <br>  <font color="#ff7700">if</font> <font>(</font> <font color="#483d8b">"dev"</font> <font color="#ff7700">in</font> route <font>)</font> <font color="#ff7700">and</font> <font>(</font> route <font>[</font> <font color="#483d8b">"dev"</font> <font>]</font> <font>)</font> : <br>  r = r + <font color="#483d8b">"dev {0}"</font> .  <font>format</font> <font>(</font> route <font>[</font> <font color="#483d8b">"dev"</font> <font>]</font> <font>)</font> <br>  <font color="#ff7700">if</font> <font>(</font> <font color="#483d8b">"table"</font> <font color="#ff7700">in</font> route <font>)</font> <font color="#ff7700">and</font> <font>(</font> route <font>[</font> <font color="#483d8b">"table"</font> <font>]</font> <font>)</font> : <br>  r = r + <font color="#483d8b">"table {0}"</font> .  <font>format</font> <font>(</font> route <font>[</font> <font color="#483d8b">"table"</font> <font>]</font> <font>)</font> <br>  <font color="#ff7700">return</font> r <br><br>  portion = <font color="#483d8b">"" "#! / bin / sh</font> <font color="#483d8b"><br><br></font>  <font color="#483d8b"># == set variables ===========================================</font> <font color="#483d8b"><br></font>  <font color="#483d8b">IPTABLES = / sbin / iptables</font> <font color="#483d8b"><br></font>  <font color="#483d8b">"" "</font> <br>  fout.  <font>write</font> <font>(</font> portion <font>)</font> <br><br><br>  fout.  <font>write</font> <font>(</font> <font color="#483d8b">"n # == interfaces:"</font> <font>)</font> <br><br>  <font color="#ff7700">for</font> iface <font color="#ff7700">in</font> ifaces: <br>  addmissingfields <font>(</font> iface <font>)</font> <br><br>  iface <font>[</font> <font color="#483d8b">"state"</font> <font>]</font> = isup <font>(</font> iface <font>[</font> <font color="#483d8b">"dev"</font> <font>]</font> <font>)</font> <br><br>  <font color="#ff7700">if</font> <font>(</font> iface <font>[</font> <font color="#483d8b">"role"</font> <font>]</font> == <font color="#483d8b">"external"</font> <font>)</font> : <br>  iface <font>[</font> <font color="#483d8b">"works"</font> <font>]</font> = works <font>(</font> iface <font>[</font> <font color="#483d8b">"dev"</font> <font>]</font> <font>)</font> <br>  descr = <font color="#483d8b">"{3} {0} is {1} and works = {2}"</font> .  <font>format</font> <font>(</font> iface <font>[</font> <font color="#483d8b">"dev"</font> <font>]</font> , iface <font>[</font> <font color="#483d8b">"state"</font> <font>]</font> , iface <font>[</font> <font color="#483d8b">"works"</font> <font>]</font> , iface <font>[</font> <font color="#483d8b">"role"</font> <font>]</font> <font>)</font> <br>  fout.  <font>write</font> <font>(</font> <font color="#483d8b">"n #"</font> + descr <font>)</font> <br>  <font color="#dc143c">syslog</font>  <font color="#dc143c">syslog</font> <font>(</font> descr <font>)</font> <br><br>  portion = <font color="#483d8b">"" "</font> <font color="#483d8b"><br></font>  <font color="#483d8b"># == Disallow forwarding during script running ========================================</font> <font color="#483d8b"><br></font>  <font color="#483d8b">echo 0&gt; / proc / sys / net / ipv4 / ip_forward</font> <font color="#483d8b"><br></font>  <font color="#483d8b"># == Drop all rules at script running ========================================</font> <font color="#483d8b"><br></font>  <font color="#483d8b">ip rule flush</font> <font color="#483d8b"><br><br></font>  <font color="#483d8b"># == delete all existing policies ===============================</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -F</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -t nat -F</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -t mangle -F</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -X</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -Z</font> <font color="#483d8b"><br><br></font>  <font color="#483d8b"># == Set default policies ====================================</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -P INPUT DROP</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -P OUTPUT ACCEPT</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -P FORWARD DROP</font> <font color="#483d8b"><br><br></font>  <font color="#483d8b"># == DROP bad packets ========================================</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -t filter -A INPUT -m state --state INVALID -j DROP</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -t filter -A OUTPUT -m state --state INVALID -j DROP</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -t filter -A OUTPUT -m state --state INVALID -j DROP</font> <font color="#483d8b"><br><br></font>  <font color="#483d8b"># == Only SYN packets establish NEW connections ==============</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -t filter -A INPUT -p tcp!</font>  <font color="#483d8b">--syn -m state --state NEW -j DROP</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -t filter -A OUTPUT -p tcp!</font>  <font color="#483d8b">--syn -m state --state NEW -j DROP</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -t filter -A FORWARD -p tcp!</font>  <font color="#483d8b">--syn -m state --state NEW -j DROP</font> <font color="#483d8b"><br><br></font>  <font color="#483d8b"># == secure lo iface =========================================</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -t filter -A FORWARD -i lo -j DROP</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -t filter -A FORWARD -o lo -j DROP</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -t filter -A OUTPUT -o lo -s 127.0.0.1/255.0.0.0 -j ACCEPT</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -t filter -A INPUT -i lo -d 127.0.0.1/255.0.0.0 -j ACCEPT</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -t filter -A OUTPUT -o lo -j DROP</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -t filter -A INPUT -i lo -j DROP</font> <font color="#483d8b"><br><br></font>  <font color="#483d8b">"" "</font> <br><br>  fout.  <font>write</font> <font>(</font> portion <font>)</font> <br><br>  fout.  <font>write</font> <font>(</font> <font color="#483d8b">"" "</font> <font color="#483d8b"><br><br></font>  <font color="#483d8b"># == Open &amp; forward ports ================================ "" "</font> <font>)</font> <br>  <font color="#ff7700">for</font> port <font color="#ff7700">in</font> Ports: <br>  fout.  <font>write</font> <font>(</font> openportcmd <font>(</font> port <font>)</font> <font>)</font> <br>  fout.  <font>write</font> <font>(</font> forwardportcmd <font>(</font> port <font>)</font> <font>)</font> <br><br>  fout.  <font>write</font> <font>(</font> <font color="#483d8b">"" "</font> <font color="#483d8b"><br><br></font>  <font color="#483d8b"># == between all if, allow, drop, and all masses; ext;</font> <br>  <font color="#ff7700">for</font> iface <font color="#ff7700">in</font> ifaces: <br>  fout.  <font>write</font> <font>(</font> <font color="#483d8b">"n # ==== for {0}"</font> . <font>format</font> <font>(</font> iface <font>[</font> <font color="#483d8b">"dev"</font> <font>]</font> <font>)</font> <font>)</font> <br>  <font color="#ff7700">for</font> oface <font color="#ff7700">in</font> ifaces: <br>  <font color="#ff7700">if</font> <font>(</font> iface <font color="#66cc66">!</font> = oface <font>)</font> : <br>  <font color="#ff7700">if</font> <font>(</font> iface <font>[</font> <font color="#483d8b">"role"</font> <font>]</font> == <font color="#483d8b">"local"</font> <font>)</font> <font color="#ff7700">and</font> <font>(</font> oface <font>[</font> <font color="#483d8b">"role"</font> <font>]</font> == <font color="#483d8b">"local"</font> <font>)</font> : <br>  fout.  <font>write</font> <font>(</font> <font color="#483d8b">"n $ IPTABLES -t filter -A FORWARD -i {0} -o {1} -j ACCEPT"</font> . <font>format</font> <font>(</font> iface <font>[</font> <font color="#483d8b">"dev"</font> <font>]</font> , oface <font>[</font> <font color="#483d8b">"dev"</font> <font>]</font> <font>)</font> <font>)</font> <br>  <font color="#ff7700">if</font> <font>(</font> iface <font>[</font> <font color="#483d8b">"role"</font> <font>]</font> == <font color="#483d8b">"local"</font> <font>)</font> <font color="#ff7700">and</font> <font>(</font> oface <font>[</font> <font color="#483d8b">"role"</font> <font>]</font> == <font color="#483d8b">"external"</font> <font>)</font> : <br>  fout.  <font>write</font> <font>(</font> <font color="#483d8b">"n $ IPTABLES -t filter -A FORWARD -i {0} -o {1} -m state - state NEW -j ACCEPT"</font> . <font>format</font> <font>(</font> iface <font>[</font> <font color="#483d8b">"dev"</font> <font>]</font> , oface <font>[</font> <font color="#483d8b">"dev"</font> <font>]</font> <font>)</font> <font>)</font> <br><br>  <font color="#ff7700">if</font> iface <font>[</font> <font color="#483d8b">"role"</font> <font>]</font> == <font color="#483d8b">"local"</font> : <br>  action = <font color="#483d8b">"ACCEPT"</font> <br>  <font color="#ff7700">else</font> : <br>  action = <font color="#483d8b">"DROP"</font> <br>  fout.  <font>write</font> <font>(</font> <font color="#483d8b">"n $ IPTABLES -t filter -A INPUT -i {0} -m state --state NEW -j {1}"</font> . <font>format</font> <font>(</font> iface <font>[</font> <font color="#483d8b">"dev"</font> <font>]</font> , action <font>)</font> <font>)</font> <br><br>  fout.  <font>write</font> <font>(</font> <font color="#483d8b">"n $ IPTABLES -t nat -A POSTROUTING -o {0} -j MASQUERADE"</font> . <font>format</font> <font>(</font> iface <font>[</font> <font color="#483d8b">"dev"</font> <font>]</font> <font>)</font> <font>)</font> <br><br><br>  fout.  <font>write</font> <font>(</font> <font color="#483d8b">"" "</font> <font color="#483d8b"><br><br></font>  <font color="#483d8b"># == Allow established to forward, others will be dropped by policy</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -t filter -A FORWARD -m state --state ESTABLISHED, RELATED -j ACCEPT</font> <font color="#483d8b"><br></font>  <font color="#483d8b">$ IPTABLES -t filter -A INPUT -m state --state ESTABLISHED, RELATED -j ACCEPT</font> <font color="#483d8b"><br><br></font>  <font color="#483d8b">"" "</font> <font>)</font> <br><br><br>  fout.  <font>write</font> <font>(</font> <font color="#483d8b">"" "</font> <font color="#483d8b"><br></font>  <font color="#483d8b"># == For some ifaces set tables, marks &amp; rules ====================================== ============= "" "</font> <font>)</font> <br>  <font color="#ff7700">for</font> iface <font color="#ff7700">in</font> ifaces: <br><br>  <font color="#ff7700">if</font> iface <font>[</font> <font color="#483d8b">"table"</font> <font>]</font> <font color="#ff7700">and</font> iface <font>[</font> <font color="#483d8b">"gw"</font> <font>]</font> <font color="#ff7700">and</font> iface <font>[</font> <font color="#483d8b">"table"</font> <font>]</font> : <br>  fout.  <font>write</font> <font>(</font> <font color="#483d8b">"nip route add default via {0} dev {1} table {2}"</font> . <font>format</font> <font>(</font> iface <font>[</font> <font color="#483d8b">"gw"</font> <font>]</font> , iface <font>[</font> <font color="#483d8b">"dev"</font> <font>]</font> , iface <font>[</font> <font color="#483d8b">"table"</font> <font>]</font> <font>)</font> <font>)</font> <br><br>  <font color="#ff7700">if</font> iface <font>[</font> <font color="#483d8b">"mark"</font> <font>]</font> : <br>  fout.  <font>write</font> <font>(</font> rulecmd <font>(</font> <font>{</font> <br>  <font color="#483d8b">"fwmark"</font> : iface <font>[</font> <font color="#483d8b">"mark"</font> <font>]</font> , <br>  <font color="#483d8b">"lookup"</font> : iface <font>[</font> <font color="#483d8b">"table"</font> <font>]</font> <br>  <font>}</font> <font>)</font> <font>)</font> <br><br><br>  fout.  <font>write</font> <font>(</font> <font color="#483d8b">"" "</font> <font color="#483d8b"><br><br></font>  <font color="#483d8b"># == Answers must be sent thrown incomming iface ================================== "" "</font> <font>)</font> <br>  <font color="#808080">#for iface in ifaces:</font> <br>  <font color="#808080"># if if ["mark"]:</font> <br>  <font color="#808080"># fout.write ("n $ IPTABLES -t mangle -A INPUT -i {0} -j CONNMARK --set-mark {1}". format (iface ["dev"], iface ["mark"]))</font> <br>  <font color="#808080"># fout.write ("n $ IPTABLES -t mangle -A OUTPUT -j CONNMARK --restore-markn")</font> <br>  <font color="#ff7700">for</font> iface <font color="#ff7700">in</font> ifaces: <br>  <font color="#ff7700">if</font> iface <font>[</font> <font color="#483d8b">"table"</font> <font>]</font> <font color="#ff7700">and</font> iface <font>[</font> <font color="#483d8b">"gw"</font> <font>]</font> : <br>  fout.  <font>write</font> <font>(</font> rulecmd <font>(</font> <font>{</font> <br>  <font color="#483d8b">"from"</font> : iface <font>[</font> <font color="#483d8b">"gw"</font> <font>]</font> , <br>  <font color="#483d8b">"lookup"</font> : iface <font>[</font> <font color="#483d8b">"table"</font> <font>]</font> <br>  <font>}</font> <font>)</font> <font>)</font> <br><br>  fout.  <font>write</font> <font>(</font> <font color="#483d8b">"" "</font> <font color="#483d8b"><br><br></font>  <font color="#483d8b"># == Rules from rules' list ================================= "" "</font> <br>  <font color="#ff7700">for</font> rule <font color="#ff7700">in</font> rules: <br>  fout.  <font>write</font> <font>(</font> rulecmd <font>(</font> rule <font>)</font> <font>)</font> <br><br>  fout.  <font>write</font> <font>(</font> <font color="#483d8b">"" "</font> <font color="#483d8b"><br><br></font>  <font color="#483d8b"># == Routes from routes' list ================================== "" "</font> <font>)</font> <br>  <font color="#ff7700">for</font> route <font color="#ff7700">in</font> routes: <br>  fout.  <font>write</font> <font>(</font> routecmd <font>(</font> route <font>)</font> <font>)</font> <br><br>  fout.  <font>write</font> <font>(</font> <font color="#483d8b">"" "</font> <font color="#483d8b"><br><br></font>  <font color="#483d8b"># == External ifaces interleaving (between all UP ext) =================================== "" "</font> <font>)</font> <br>  portion = <font color="#483d8b">"nip route replace default scope global"</font> <br>  <font color="#ff7700">for</font> iface <font color="#ff7700">in</font> ifaces: <br>  <font color="#ff7700">if</font> iface <font>[</font> <font color="#483d8b">"dev"</font> <font>]</font> <font color="#ff7700">and</font> iface <font>[</font> <font color="#483d8b">"gw"</font> <font>]</font> <font color="#ff7700">and</font> iface <font>[</font> <font color="#483d8b">"weight"</font> <font>]</font> <font color="#ff7700">and</font> <font>(</font> iface <font>[</font> <font color="#483d8b">"role"</font> <font>]</font> == <font color="#483d8b">"external"</font> <font>)</font> <font color="#ff7700">and</font> <font>(</font> iface <font>[</font> <font color="#483d8b">"state"</font> <font>]</font> == <font color="#483d8b">"up"</font> <font>)</font> : <br>  portion = portion + <font color="#483d8b">"nexthop via {0} dev {1} weight {2}"</font> .  <font>format</font> <font>(</font> iface <font>[</font> <font color="#483d8b">"gw"</font> <font>]</font> , iface <font>[</font> <font color="#483d8b">"dev"</font> <font>]</font> , iface <font>[</font> <font color="#483d8b">"weight"</font> <font>]</font> <font>)</font> <br>  fout.  <font>write</font> <font>(</font> portion <font>)</font> <br><br>  fout.  <font>write</font> <font>(</font> <font color="#483d8b">"" "</font> <font color="#483d8b"><br><br></font>  <font color="#483d8b"># == Allow forwarding ============================================= ===========================</font> <font color="#483d8b"><br></font>  <font color="#483d8b">echo 1&gt; / proc / sys / net / ipv4 / ip_forward</font> <font color="#483d8b"><br></font>  <font color="#483d8b">"" "</font> <font>)</font> <br><br>  fout.  <font>write</font> <font>(</font> <font color="#483d8b">"" "</font> <font color="#483d8b"><br><br></font>  <font color="#483d8b"># == some handmade custom commands =========================================== ===================</font> <font color="#483d8b"><br></font>  <font color="#483d8b">{0}</font> <font color="#483d8b"><br></font>  <font color="#483d8b">"" "</font> . <font>format</font> <font>(</font> customcommands <font>)</font> <font>)</font> <br><br><br>  fout.  <font>close</font> <font>(</font> <font>)</font> <br><br>  <font color="#dc143c">syslog</font>  <font color="#dc143c">syslog</font> <font>(</font> <font color="#483d8b">"Finished"</font> <font>)</font> <br>  <font color="#dc143c">syslog</font>  <font color="#dc143c">syslog</font> <font>(</font> <font color="#483d8b">"Script started"</font> <font>)</font> <br>  x = <font color="#dc143c">subprocess</font> .  <font>call</font> <font>(</font> <font>[</font> <font color="#483d8b">"/ bin / sh"</font> , <font color="#483d8b">"{0}"</font> . <font>format</font> <font>(</font> cmdfile <font>)</font> <font>]</font> , stdin = <font color="#008000">None</font> , stdout = <font color="#008000">open</font> <font>(</font> <font color="#483d8b">'/ dev / null'</font> , <font color="#483d8b">'w'</font> <font>)</font> , stderr = <font color="#008000">open</font> <font>(</font> <font color="#483d8b">'/ dev / null '</font> , <font color="#483d8b">' w '</font> <font>)</font> , shell = <font color="#008000">False</font> <font>)</font> <br>  <font color="#dc143c">syslog</font>  <font color="#dc143c">syslog</font> <font>(</font> <font color="#483d8b">"Script finished with result {0}"</font> . <font>format</font> <font>(</font> x <font>)</font> <font>)</font> </blockquote><br><br><br><h2>  Launch </h2><br>  One of the options, by me and the currently used script call when changing interfaces.  <s>To do this, write a call script:</s> <s><br></s> <pre> <s>
</s>  <s>root @ Gate: / root # cat ./msr_on_if_changed</s> <s> 
</s>  <s>#! / bin / sh</s> <s>
</s>  <s>/ usr / bin / python /root/msr_ip.py</s> <s>
</s>  <s>exit 0</s> <s>
</s> </pre><br>  Links to the script are installed in the network interface configuration directories.  The main thing is to make the name without an extension, otherwise the link will be ignored by the initialization system: <br><pre> ln -s /root/msr_ip.py / etc / network / if-down / msr_ip
 ln -s /root/msr_ip.py / etc / network / if-up / msr_ip
 ln -s /root/msr_ip.py /etc/ppp/ip-up.d/msr_ip
 ln -s /root/msr_ip.py /etc/ppp/ip-down.d/msr_ip
</pre><br><h2>  Total </h2><br>  The script has been working for 3 months and so far there have been no failures due to its fault, I hope that this will happen. </div><p>Source: <a href="https://habr.com/ru/post/138705/">https://habr.com/ru/post/138705/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../138699/index.html">Authorizing proxy for Windows (+ normal Opera work with NTLM as a bonus)</a></li>
<li><a href="../138700/index.html">Introduction to the theory of interacting sequential processes (Communicating Sequential Processes - CSP)</a></li>
<li><a href="../138702/index.html">"I can put a thousand bots ..."</a></li>
<li><a href="../138703/index.html">Monitoring index usage in query plans in Oracle 10g</a></li>
<li><a href="../138704/index.html">Scroogle Search Engine Close</a></li>
<li><a href="../138706/index.html">Each client in the process</a></li>
<li><a href="../138708/index.html">Mechanical design of computing power</a></li>
<li><a href="../138711/index.html">How to win CTF? Firsthand</a></li>
<li><a href="../138712/index.html">Sony and Tokyo Tech have developed new wireless communication chips (6 Gbit / s)</a></li>
<li><a href="../138713/index.html">Adobe refuses to develop Flash Player and AIR for GNU / Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>