<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We increase our premium twice, or how to hack documents signed with a reinforced qualified signature</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the wake of the chip-apocalypse news of 2018, when almost everything was hacked, and world brand sites, without knowing it, minting cryptocurrency ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We increase our premium twice, or how to hack documents signed with a reinforced qualified signature</h1><div class="post__text post__text-html js-mediator-article"><p>  In the wake of the chip-apocalypse news of 2018, when almost everything was hacked, and world brand sites, without knowing it, minting cryptocurrency in our browsers, we decided to encroach on the holy of holies and hack documents signed with an enhanced qualified electronic signature.  And that's what came of it. </p><br><img src="https://habrastorage.org/webt/0-/6n/je/0-6njeudr5xi8879ostcfuaau6u.png"><a name="habracut"></a><br><br><p>  As you know, enhanced qualified electronic signature (ES) allows you to identify the person who signed the document and detect the fact of making changes to the document (see Art. 5, p. 3 of Federal Law No. 63 ‚ÄúOn Electronic Signature‚Äù).  The <a href="https://habrahabr.ru/post/322478/">hash function collision</a> generation algorithm is not needed this time.  For hacking, it is necessary to find ways to make changes to the electronic document after its signing, so that these changes are not detected when checking the ES.  Let's start. </p><br><h3 id="scenariy-s-dokumentom-dwg-vektor-ataki--vneshnie-ssylki">  DWG script, attack vector - external links </h3><br><p>  Hereinafter, it is assumed that the system has already installed a certificate of qualified electronic signature: </p><br><ul><li>  Create a document HVAC.dwg, which refers to the file nothing.dwg, located on the ball in the local network of the enterprise.  The file nothing.dwg contains notes for the equipment of Supplier A; </li><li>  We send HVAC.dwg for approval to the responsible person; </li><li>  Using Autodesk ‚Üí AutoCAD ‚Üí Add Digital Signatures, the person in charge signs the HVAC.dwg.  Now this is an electronic script: </li></ul><br><p><img src="https://habrastorage.org/webt/o3/fq/nv/o3fqnvbipdk5m5ggptxfjphz0ti.png"><br><br></p><br><p>  We realize attack: </p><br><ul><li>  It is necessary to replace the equipment of Supplier A with the equipment of Supplier B with a change of nothing.dwg located on the network resource; </li><li>  The supply department receives an electronic script HVAC.dwg, the head of the department checks the integrity of the electronic signature, it is not broken, and AutoCAD dispel the last shadow of doubt with the soothing ‚ÄúDrawing has not changed since signing‚Äù, so instead of Supplier A, the order for equipment goes to Supplier B </li></ul><br><img src="https://habrastorage.org/webt/5h/y7/ty/5hy7tymdehqxpp59oyuxuafuqq4.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3 id="scenariy-s-dokumentom-docdocx-vektor-ataki--shrift">  DOC / DOCX script, attack vector font </h3><br><p>  This time we will use the most advanced <a href="http://www.cryptopro.ru/products">CryptoPro CSP 4.0</a> information security complex, which corresponds to the standard GOST R 34.10-2012: </p><br><ul><li>  We create an order on awarding prikaz.docx employees.  The main text is typed in Arial.  For premium size, we use a similar font, for example, the free Google <a href="https://fonts.google.com/specimen/Noto%2BSans">Noto Sans Regular</a> .  We introduce the premium amount agreed with the director of 150,000 rubles; </li><li>  We send the order for the signature to the director; </li><li>  The director signs prikaz.docx with enhanced qualified electronic signature using CryptoPro Office Signature 2.0.  We receive the electronic script: </li></ul><br><img src="https://habrastorage.org/webt/uj/rw/an/ujrwanfizzrc7riiasd2aaefm14.png"><br><br><p>  We realize attack: </p><br><ul><li>  Using the free program <a href="http://fontforge.github.io/">FontForge, we</a> modify the NotoSans-Regular.ttf font file, replacing the vector image of glyph 1 with the image of glyph 2 </li></ul><br><img src="https://habrastorage.org/webt/ug/6q/ld/ug6qldageg6jn67fqrkx7giby24.png"><br><br><ul><li>  The modified NotoSans-Regular.ttf file is installed on the accountant‚Äôs computer (administrative rights will be required); </li><li>  Having received the original order signed by the director, the accountant opens it and sees a valid signature.  But the amount of the premium increased from 150,000 rubles.  up to 250,000 rubles. </li></ul><br><img src="https://habrastorage.org/webt/s6/xg/hx/s6xghxluaefsbupttqaxnab76l8.png"><br><br><p>  These are effective, but not the only ways to attack.  There are also macros, calculated field values, styles.  Neither the use of a data management system (PDM), unfastened signatures, or the use of specialized cryptographic complexes such as CryptoPro CSP will protect against them. </p><br><p>  How to provide protection against such attacks?  The most effective way is to publish documents in an uneditable format or fixed markup format.  These formats are aimed at preserving the original form of the document on any device, anywhere in the world.  Here are the most common representatives of fixed markup formats: </p><br><ul><li>  PDF (Portable Document Format) - developed by Adobe.  ISO 32000 standard; </li><li>  XPS (XML Paper Specification) - developed by Microsoft.  <a href="https://www.ecma-international.org/publications/standards/Ecma-388.htm">ECMA-388</a> ; </li><li>  DWFx - developed by Autodesk.  Based on XPS. </li></ul><br><p>  But here is not so simple.  Let's try to attack through a font on a signed PDF document: </p><br><ul><li>  Document prikaz.docx publish in PDF, for example, using a virtual printer PDF-XChange.  The received file prikaz.pdf is sent for signature to the director; </li><li>  The director opens the document prikaz.pdf in the Adobe Acrobat Reader DC program; </li><li>  Signs with the "Sign Digital Signature" command in the "Certificates" section. </li><li>  The signed PDF is sent to the accountant. </li></ul><br><p>  We realize attack: </p><br><ul><li>  As well as in the script with the DOCX format, we set an accountant‚Äôs modified font NotoSans-Regular.ttf; </li><li>  Having received the signed prikaz.pdf, the accountant opens it in Adobe Reader and sees a premium of 250,000 rubles, the signature integrity is not compromised. </li></ul><br><img src="https://habrastorage.org/webt/rw/6o/b-/rw6ob-bdar6uggezr-nyy0_edj0.png"><br><br><p>  For PDF, it was possible to implement this type of attack because this format allows the use of fonts by reference, so it is not suitable for creating originals. There is a PDF / A standard (a subset of PDF) that provides the necessary protection.  Therefore, before signing each PDF, you must make sure that the document conforms to the PDF / A standard or that there are no dependencies on fonts. </p><br><p>  The DWFx and XPS formats are not subject to such attacks, since at the level of the ECMA-388 standard the storage of resources within the content of documents is regulated (F.3.1 M2.6).  But DWFx is not suitable for creating multi-page text documents, so the most versatile option is XPS. </p><br><p>  Let's try, by analogy with PDF, to conduct an attack through a font on a signed XPS document: </p><br><ul><li>  Document prikaz.docx publish in XPS using the built-in Windows virtual printer Microsoft XPS Document Writer.  The received file prikaz.xps is sent for signature to the director; </li><li>  The director opens the document prikaz.xps in <a href="https://pilot.ascon.ru/">Pilot-ICE</a> or <a href="https://pilot.ascon.ru/">Pilot-XPS</a> .  Signs with the "Sign" command via CryptoPro CSP; </li><li>  The signed XPS is sent to the accountant. </li></ul><br><p>  We realize attack: </p><br><ul><li>  Install the modified NotoSans-Regular.ttf font for the accountant; </li><li>  Having received the signed prikaz.xps, the accountant opens it in Pilot-ICE, checks the integrity of the EA and sees the same premium amount as at the time of signing the document - 150,000 rubles.  The attack on XPS failed. </li></ul><br><img src="https://habrastorage.org/webt/oh/ef/p0/ohefp0mwhi12_0fjwkekfi7ukmw.png"><br><br><h3 id="itogi">  Results </h3><br><p>  Reinforced qualified electronic signature is still a reliable technology for detecting changes to a document.  But we must comprehensively evaluate the effectiveness of its application.  The experiment showed that the editable formats DWG, DOC, DOCX are not suitable for creating electronic scripts, since they can be easily compromised.  <a href="https://en.wikipedia.org/wiki/PDF/A">PDF / A</a> and <a href="https://en.wikipedia.org/wiki/Open_XML_Paper_Specification">XPS</a> formats are more secure and versatile for creating originals, since they contain all the necessary information inside the file in order to display the document unchanged each time. </p><br><p>  Dmitry Poskrebyshev </p></div><p>Source: <a href="https://habr.com/ru/post/347016/">https://habr.com/ru/post/347016/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347000/index.html">McSema and decompiling into LLVM source code: is it real?</a></li>
<li><a href="../347002/index.html">Studying MBR and GPT structures</a></li>
<li><a href="../347004/index.html">Ukrainian startups are back from Las Vegas. And so</a></li>
<li><a href="../347008/index.html">Platforms for learning experiments with reinforcement and not only</a></li>
<li><a href="../347014/index.html">Learning to manage Kubernetes securely</a></li>
<li><a href="../347018/index.html">Developing Reusable Reusable Components</a></li>
<li><a href="../347020/index.html">Letter to Junior: what I would like to know at the beginning</a></li>
<li><a href="../347022/index.html">Work with problem * .dwg-files in the environment of nanoCAD</a></li>
<li><a href="../347024/index.html">How did I fix the interactive login, or What is there in the guts of // chrome / test / ChromeDriver?</a></li>
<li><a href="../347026/index.html">Introduction to modern network balancing and proxying</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>