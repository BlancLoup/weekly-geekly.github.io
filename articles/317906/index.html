<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Telegram-bot for the system administrator</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Telegram-bot for system administrators. This is by no means a finished project, there is a lot of work to be done. This is a semi-finished product and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Telegram-bot for the system administrator</h1><div class="post__text post__text-html js-mediator-article">  Telegram-bot for system administrators.  This is by no means a finished project, there is a lot of work to be done.  This is a semi-finished product and a set of techniques that each admin can file for his different tasks. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7e5/27a/612/7e527a6123b044cf95f19dd5e453f2eb.jpg"></div><br>  The article contains examples of several bots and examples of working with the api telegrams from powershell. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">It contains info how to register a bot and get a token</b> <div class="spoiler_text">  Before you continue, you must have a bot token to register your bot and get the token you need to find the user <b>@BotFather</b> and write to him.  We are interested in the <b>/ newbot command,</b> after which we need the name and name of the bot, you can write whatever you want. At the end, add <b>_bot</b> .  When the name is chosen, <b>BotFather</b> will return you a token and a link to the bot for quick addition.  At this bot registration bot ends. <br><br>  To quickly add a bot and make it possible to quickly add it to yourself, it is best to use a special link starting with the @ symbol, you can take it in info: <br><img src="https://habrastorage.org/files/bed/fd8/05f/bedfd805f7254d6f820da6782f167765.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/4dd/a34/d5f/4dda34d5f7924b598fe810a3405f6a6c.jpg"><br><br>  if such a link is sent to someone, he can simply click on it to open a chat with your bot <br></div></div><br><h2>  Ready adminbots templates </h2><br><div class="spoiler">  <b class="spoiler_title">Simple bot</b> <div class="spoiler_text">  Pros: <br><br><ul><li>  small - only about 300 lines </li><li>  can execute commands described in the logic function </li><li>  can receive and send messages </li><li>  can receive files </li><li>  there is a password check </li><li>  keeps log of sent commands </li><li>  can open several sessions for simultaneous work (not fully implemented. But several people can simultaneously interact </li></ul><br>  Minuses: <br><br><ul><li>  too simple authorization.  The password will remain in the chat on the device.  Cannot distinguish devices </li></ul><br>  You can download a simple bot <a href="https://cloud.mail.ru/public/LAGa/9tUXP4aZY"><b>from here</b></a> ; the archive contains: 1. a help with examples of text markup;  2. source <br><br>  To start, you need to get a bot token from <b>BotFather</b> as described at the beginning of the article and write to the <b>$ token</b> variable of the script.  Should work immediately. <br><br><img src="https://habrastorage.org/files/ed2/507/651/ed25076515544ec09c465373f0a21d3f.png"><br><br>  Add functionality to <b>logic</b> function <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Difficult bot</b> <div class="spoiler_text">  A plus: <br><br><ul><li>  Small - only about 450 lines </li><li>  Can execute commands described in logic function </li><li>  Can receive and send messages </li><li>  Can accept files </li><li>  There is a password check, it can additionally check <b>chat_id</b> </li><li>  Logs sent commands </li><li>  It can open several sessions for simultaneous work (not fully implemented. At the last stage, the console was screwed, if you work in it, other users will have a hang and may have a timeout kick. </li></ul><br>  The functionality that was implemented for the example: <br><br><ul><li>  Can take files, puts them in daddy </li><li>  Can show files from daddy </li><li>  Can delete files from download folder. </li><li>  Can run the file for execution (via <b>start-process</b> ) </li><li>  Shows a list of servers you are working with (just a list of names in a text file) </li><li>  Pings servers from the list and shows which ones are online. </li><li>  Disables computers from the list </li><li>  Shows users logged in to the terminal, makes a call to an external script (need to be installed on the terminal <b>PSTerminalServices</b> ) </li><li>  Makes the user <b>logoff</b> on the terminal.  Enter console mode and then write user names (you need to install on the <b>PSTerminalServices</b> terminal) </li><li>  Makes a screenshot of the computer on which it is running (but does not send it back) </li><li>  Opens the <b>ssh</b> session with the device on the network and switches to the command entry mode (for example, the credit and the address are hardwired into the script. To work, it requires installation on the machine with which the ssh <a href="http://www.powershellmagazine.com/2014/07/03/posh-ssh-open-source-ssh-powershell-module/">poshSSH</a> operation module will be managed) </li></ul><br>  From what has not been implemented, but I would like to: <br><br><ul><li>  File transfer back (write who knows how to do it through powershell) </li><li>  Inadequate support for multi-user work </li><li>  Defective console mode </li></ul><br>  You can download the bot <a href="https://cloud.mail.ru/public/Lpxj/LET9ympnF"><b>from here</b></a> , the archive contains: <br>  1. help with examples of text markup; <br>  2. configuration file <b>config.csv</b> ; <br>  3. bot itself - <b>abormot.ps1</b> ; <br>  4. a set of auxiliary files; <br>  5. list of computers for work in the text file <b>ping-list.txt</b> <br><br>  To start, you need to get a bot token from <b>BotFather</b> as described at the beginning of the article and set it in the <b>config.csv</b> configuration file.  Should work immediately. <br><br><img src="https://habrastorage.org/files/0bd/031/667/0bd0316674ec46f4acfd29366658b1c0.png"><br><br>  Add functionality to <b>logic</b> function <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Self-service bot doing Unlock account in domain</b> <div class="spoiler_text">  In some organizations, according to the requirements of the IB, if the password is entered incorrectly a certain number of times, then the account is locked for a certain time.  To remove the lock user must call the admin.  This bot is made so that it can write the name of the account and it unlocks it, but not more than 3 times a day.  If the limit is exceeded, he will redirect the user to the system administrator and send an alert to him in the chat. <br><br>  You can download the bot <a href="https://cloud.mail.ru/public/6khW/YFSyVsoH9"><b>from here</b></a> . <br><br>  To start, you need to get a bot token from <b>BotFather to</b> register the token in the <b>$ token</b> variable.  <b>Set</b> admin chat number to <b>$ adminChatID</b> .  Register the address of the blast machine and credits to it: <br><br><img src="https://habrastorage.org/files/8e0/33e/0ee/8e033e0ee33a41a18bf735f5fec9df61.png"><br><br>  I built the unlock function in the example directly into the script, for permanent use it is better to create a reaction to the event in the log and generate this event myself.  The event will run the unlock script from a place that is accessible only to admins, so you will not forget the password from the domain in the script.  It is important. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Bot accepting files from users he knows</b> <div class="spoiler_text">  For example, we need to forward photos from users to the site, or simply receive files and know from whom they came and send to whom.  Below is an example of a bot accepting photos from familiar users. <br><br>  You can download the bot <a href="https://cloud.mail.ru/public/CF2E/mBmqc8AXp"><b>from here</b></a> . <br><br>  To start, you need to get the bot token from the <b>BotFather to</b> register the token in the <b>$ token</b> variable, register your chat in switch 235 lines.  Should work immediately.  Do not forget to add the chat you want to <b>switch</b> <br></div></div><br><h2>  How to work with bot api </h2><br><h3>  1. Accept the message </h3><br>  Need to run <b>Invoke-WebRequest</b> to <br><br><pre><code class="hljs objectivec">https:<span class="hljs-comment"><span class="hljs-comment">//api.telegram.org/bot{}/getUpdates?offset={ ID }&amp;timeout={     }</span></span></code> </pre> <br>  <b>{Token}</b> - bot token received from BotFather <br>  <b>{ordinal message ID}</b> - for the first message <b>0</b> , for the subsequent <b>number of the last + 1</b> .  If you specify the last number, you will receive the last message with each call. <br>  <b>{waiting time before returning in seconds}</b> - the time that the telegram will wait for an answer if it is not there before returning the empty structure.  Suitable for creating a delay in the bot.  I used 1 second latency in order to not wait for debugging. <br>  at the output we get a <b>JSON</b> structure that is parsed with <b>ConvertFrom-Json</b> <br><br>  <b>Code Listing # 1</b> <br><pre> <code class="hljs mel">$ChatTimeout = <span class="hljs-number"><span class="hljs-number">1</span></span> $UpdateId = <span class="hljs-number"><span class="hljs-number">0</span></span> $token = <span class="hljs-string"><span class="hljs-string">"bot token"</span></span> $URL = <span class="hljs-string"><span class="hljs-string">"https://api.telegram.org/bot$token/getUpdates?offset=$UpdateId&amp;timeout=$ChatTimeout"</span></span> $Request = Invoke-WebRequest -Uri $URL -Method Get $content = ConvertFrom-Json $Request.content #    <span class="hljs-number"><span class="hljs-number">2</span></span>       $str = $content.result | <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> -First <span class="hljs-number"><span class="hljs-number">1</span></span> $str = ($str).message $props = [ordered]@{ ok = $content.ok UpdateId = ($str).update_id Message_ID = $str.message_id first_name = ($str.from).first_name last_name = ($str.from).last_name chat_id = ($str.chat).id <span class="hljs-keyword"><span class="hljs-keyword">text</span></span> = $str.<span class="hljs-keyword"><span class="hljs-keyword">text</span></span> } $obj = New-Object -TypeName PSObject -Property $props $obj</code> </pre><br>  At the output in the object <b>$ obj there</b> will be a message and from whom it came <br><br><h3>  2. Download file </h3><br>  If the file is transferred, then additional parameters will be passed in the <b>JSON</b> structure.  To get the file you need to pull out the file_id from the message, then contact the address: <br><br><pre> <code class="java hljs">https:<span class="hljs-comment"><span class="hljs-comment">//api.telegram.org/bot{token}/getFile?file_id={file_id  }</span></span></code> </pre> <br>  The request will return a JSON structure containing the path to download.  Next, download the file by reference. <br><br><pre> <code class="java hljs">https:<span class="hljs-comment"><span class="hljs-comment">//api.telegram.org/file/bot{token}/{file_path}</span></span></code> </pre> <br>  Suppose that we were given a file, then the code for downloading it will look like this: <br><br><pre> <code class="hljs perl">$ChatTimeout = <span class="hljs-number"><span class="hljs-number">1</span></span> $UpdateId = <span class="hljs-number"><span class="hljs-number">0</span></span> $token = <span class="hljs-string"><span class="hljs-string">"bot token"</span></span> $Path = <span class="hljs-string"><span class="hljs-string">"c:\" #####     $URL = "</span></span>https:<span class="hljs-regexp"><span class="hljs-regexp">//api</span></span>.telegram.org/bot$token/getUpdates?offset=$UpdateId&amp;timeout=$ChatTimeout<span class="hljs-string"><span class="hljs-string">" $Request = Invoke-WebRequest -Uri $URL -Method Get $content = ConvertFrom-Json $Request.content #    2       $str = $content.result | select -First 1 $str = ($str).message #####          #          if ( $($str.document).mime_type -eq "</span></span>image/jpeg<span class="hljs-string"><span class="hljs-string">" ) { $isJPG = $true } #####   file_name      #    ? if ( $($str.document).file_name -ne $null ) { ###      $DocFileName = ($str.document).file_name $DocFileID = ($str.document).file_id $DocFileSize = ($str.document).file_size #        /getFile $URL = "</span></span>https:<span class="hljs-regexp"><span class="hljs-regexp">//api</span></span>.telegram.org/bot$token/getFile?file_id=$DocFileID<span class="hljs-string"><span class="hljs-string">" $RequestFile = Invoke-WebRequest -Uri $URL ###  $RequestFile        foreach ( $JSON in $((ConvertFrom-Json $RequestFile.Content).result) ) { $FilePath = $json.file_path $URL = "</span></span>https:<span class="hljs-regexp"><span class="hljs-regexp">//api</span></span>.telegram.org/file/bot$token/$FilePath<span class="hljs-string"><span class="hljs-string">" $FilePath = Split-Path -Leaf $FilePath $OutputFile = "</span></span>$Path\$FilePath<span class="hljs-string"><span class="hljs-string">" #    Invoke-WebRequest -Uri $URL -OutFile $OutputFile } }</span></span></code> </pre><br><h3>  3. Write something </h3><br>  The telegram bot supports 2 <b>markdown</b> and <b>html</b> text markup modes. <br><br>  Warning: <u><b>br</b> mode is not supported in <b>html</b> mode.</u> <br><br><div class="spoiler">  <b class="spoiler_title">Markdown markup examples</b> <div class="spoiler_text">  <b>* bold text *</b> - bold text <br>  <i>_italic text_</i> - oblique text <br>  [text] (http://www.example.com/) - link <br>  `inline fixed-width code` - fixed <br><br>  text block <br>  `` `text <br>  pre-formatted fixed-width code block <br>  `` ` <br></div></div><br>  To wrap lines, use the sequence <b>% 0A</b> <br><br>  Example of sending a message <br><br><pre> <code class="hljs perl">$token = <span class="hljs-string"><span class="hljs-string">" "</span></span> $hatid = <span class="hljs-string"><span class="hljs-string">"ID      "</span></span> $text = <span class="hljs-string"><span class="hljs-string">" habr"</span></span> $payload = @{ <span class="hljs-string"><span class="hljs-string">"parse_mode"</span></span> = <span class="hljs-string"><span class="hljs-string">"Markdown"</span></span>; <span class="hljs-string"><span class="hljs-string">"disable_web_page_preview"</span></span> = <span class="hljs-string"><span class="hljs-string">"True"</span></span> } $URL = <span class="hljs-string"><span class="hljs-string">"https://api.telegram.org/bot$token/sendMessage?chat_id=$hatid&amp;text=$text"</span></span> $request = Invoke-WebRequest -Uri $URL -Method Post <span class="hljs-string"><span class="hljs-string">` -ContentType "application/json; charset=utf-8" `</span></span> -Body (ConvertTo-Json -Compress -InputObject $payload)</code> </pre><br>  If this code gives an error, for example, when sending a line like this: <br><br><pre> <code class="hljs perl"><span class="hljs-string"><span class="hljs-string">"$FDownload : file name is "</span></span><span class="hljs-string"><span class="hljs-string">"$($JSON.file_path)"</span></span><span class="hljs-string"><span class="hljs-string">"; size $($json.file_size) kb"</span></span></code> </pre><br>  You can use the send method more complicated: <br><br><pre> <code class="hljs perl">$token = <span class="hljs-string"><span class="hljs-string">" "</span></span> $chat_id = <span class="hljs-string"><span class="hljs-string">"ID chata"</span></span> $text = <span class="hljs-string"><span class="hljs-string">""</span></span> $markdown = $true $preview_mode = <span class="hljs-string"><span class="hljs-string">"True"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($markdown) { $markdown_mode = <span class="hljs-string"><span class="hljs-string">"Markdown"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {$markdown_mode = <span class="hljs-string"><span class="hljs-string">""</span></span>} $payload = @{ <span class="hljs-string"><span class="hljs-string">"chat_id"</span></span> = $chat_id; <span class="hljs-string"><span class="hljs-string">"text"</span></span> = $text <span class="hljs-string"><span class="hljs-string">"parse_mode"</span></span> = $markdown_mode; <span class="hljs-string"><span class="hljs-string">"disable_web_page_preview"</span></span> = $preview_mode; } $URL = <span class="hljs-string"><span class="hljs-string">"https://api.telegram.org/bot$token/sendMessaget"</span></span> $request = Invoke-WebRequest -Uri $URL <span class="hljs-string"><span class="hljs-string">` -Method Post -ContentType "application/json; charset=utf-8" `</span></span> -Body (ConvertTo-Json -Compress -InputObject $payload)</code> </pre><br>  If anyone knows how to download the file back - skinte, I will add. </div><p>Source: <a href="https://habr.com/ru/post/317906/">https://habr.com/ru/post/317906/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317892/index.html">SwiftLint - clean and tidy iOS project</a></li>
<li><a href="../317894/index.html">Alameda, Bower and NPM integration in the CleverStyle Framework</a></li>
<li><a href="../317896/index.html">WPF - Floppy Pages</a></li>
<li><a href="../317900/index.html">Check Umbraco source code again</a></li>
<li><a href="../317904/index.html">How to fill out and sign documents automatically using DocuSign</a></li>
<li><a href="../317908/index.html">How IT professionals work. Maxim Lapshin, Founder of Flussonic</a></li>
<li><a href="../317910/index.html">How Yandex taught the machine to create translations for rare languages</a></li>
<li><a href="../317912/index.html">As we on Habr√© survey about CRM conducted: results</a></li>
<li><a href="../317914/index.html">Citrix NetScaler and one-time passwords</a></li>
<li><a href="../317916/index.html">Test automation by Scrum methodology</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>