<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CSP bypass using Google Chrome extensions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, I set up on my CSP ( content security policy ) project, and decided that life was a success. After all, now it is impossible to load ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CSP bypass using Google Chrome extensions</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago, I set up on my CSP ( <a href="https://habrahabr.ru/company/nixsolutions/blog/271575/">content security policy</a> ) project, and decided that life was a success.  After all, now it is impossible to load scripts from forbidden resources, and even about trying to do this, I will be notified of the corresponding error.  And if someone uploads the script, it will still not be able to send anything, because ajax requests are sent only to my servers. <br><br>  So I thought, and was calm for a while. <br><a name="habracut"></a><br>  I also used the <b>HTTP Headers</b> extension, which helped me view the server response headers in a convenient way.  One day, I saw an advertisement on my resources that was never there.  After reviewing the code a bit and experimenting, I realized that it was this extension that added advertising to all the sites I visit.  The extension code, unfortunately, I did not copy on time, and at the moment it has already been removed from the extension store with the note ‚Äúcontains malicious software‚Äù.  From this and start my story. <br><br>  It became very interesting to me how it is, because I have clear rules for the browser about the policy of downloading scripts and sending data from my page, and here I see that the security settings well, very little increase the security of users if they use browser extensions (in This is specifically Google Chrome).  Therefore, I decided to recreate such an extension that could load scripts from a remote server bypassing the CSP. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Writing browser extensions is not very difficult, there have been many articles about this, in particular <a href="https://habrahabr.ru/company/google/blog/212107/">from Google</a> , so I will not dwell on the actual writing of the extension. <br><br>  As an example, the <i>Yandex Music</i> site was chosen for several reasons: <br><br><ul><li>  They have a CSP </li><li>  They have enough powerful servers to withstand all the ‚Äúwho are interested to see‚Äù; </li><li>  They have not fully configured CSP (at the time of writing this article, they have a content security policy report report only, so I can see all the error messages about incorrect content, but the blocking itself will not occur) </li></ul><br>  Putting together a malicious extension (you can see the finished version on <a href="https://github.com/Nidhognit/EvilExtention">GitHub</a> ): <br><br><h3>  1. The manifest.json file </h3><br><pre><code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"manifest_version"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"CSP vulnerability"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"This is just an example, please do not use it."</span></span>, <span class="hljs-string"><span class="hljs-string">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"browser_action"</span></span>: { <span class="hljs-string"><span class="hljs-string">"default_icon"</span></span>: <span class="hljs-string"><span class="hljs-string">"evil.png"</span></span>, <span class="hljs-string"><span class="hljs-string">"default_popup"</span></span>: <span class="hljs-string"><span class="hljs-string">"popup.html"</span></span> }, <span class="hljs-string"><span class="hljs-string">"content_scripts"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"matches"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"https://music.yandex.ua/*"</span></span> ], <span class="hljs-string"><span class="hljs-string">"js"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"evil.js"</span></span> ], <span class="hljs-string"><span class="hljs-string">"run_at"</span></span>: <span class="hljs-string"><span class="hljs-string">"document_end"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"permissions"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"activeTab"</span></span>, <span class="hljs-string"><span class="hljs-string">"https://music.yandex.ua/*"</span></span> ] }</code> </pre> <br><h3>  2. Create a malicious script itself. </h3><br>  Carefully reviewing where Yandex allows you to download scripts <br><br><pre> <code class="hljs dos">"script-src 'self' 'unsafe-eval' vk.com cdn.pushwoosh.com yandex.ua yandex.st yandex.<span class="hljs-built_in"><span class="hljs-built_in">net</span></span> yastatic.<span class="hljs-built_in"><span class="hljs-built_in">net</span></span> yandexadexchange.<span class="hljs-built_in"><span class="hljs-built_in">net</span></span> *.yandex.ru *.yandex.ua *.yandex.<span class="hljs-built_in"><span class="hljs-built_in">net</span></span> *.yastatic.<span class="hljs-built_in"><span class="hljs-built_in">net</span></span> *.yandexadexchange.<span class="hljs-built_in"><span class="hljs-built_in">net</span></span> *.yandex-team.ru .</code> </pre> <br>  I decided that Google analytics is clearly not enough on this list, so I choose <a href="">https://google-analytics.com/analytics.js</a> as a malicious downloadable script, especially since many people call Google a ‚Äúgood corporation‚Äù.  This choice is due to the following criteria: <br><br><ol><li>  The connected script does not harm anyone. </li><li>  It definitely works. </li><li>  He will try to make ajax requests. </li><li>  Anyone who wants to can connect it. </li></ol><br>  This is another bonus, because  I can use the loaded script to simulate requests without raising my server and additional code (of course, Google analyst will not let you see the collected information if I am not the site owner, but I didn‚Äôt want to collect any information, just a demonstration of blocking bypass). <br><br>  I take the standard script from the manual, only the number of the counter is made up from the head: <br><br><pre> <code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i, s, o, g, r, a, m</span></span></span><span class="hljs-function">) </span></span>{ i[<span class="hljs-string"><span class="hljs-string">'GoogleAnalyticsObject'</span></span>] = r; i[r] = i[r] || <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ (i[r].q = i[r].q || []).push(<span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>) }, i[r].l = <span class="hljs-number"><span class="hljs-number">1</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>(); a = s.createElement(o), m = s.getElementsByTagName(o)[<span class="hljs-number"><span class="hljs-number">0</span></span>]; a.async = <span class="hljs-number"><span class="hljs-number">1</span></span>; a.src = g; m.parentNode.insertBefore(a, m) })(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>, <span class="hljs-string"><span class="hljs-string">'script'</span></span>, <span class="hljs-string"><span class="hljs-string">'//www.google-analytics.com/analytics.js'</span></span>, <span class="hljs-string"><span class="hljs-string">'ga'</span></span>); ga(<span class="hljs-string"><span class="hljs-string">'create'</span></span>, <span class="hljs-string"><span class="hljs-string">'UA-00000000-0'</span></span>, <span class="hljs-string"><span class="hljs-string">'auto'</span></span>); ga(<span class="hljs-string"><span class="hljs-string">'send'</span></span>, <span class="hljs-string"><span class="hljs-string">'pageview'</span></span>);</code> </pre> <br>  To begin with, I try to execute this script from the console to check if the CSP works on this site at all, and I see the following: <br><br><pre> <code class="hljs pgsql">VM636:<span class="hljs-number"><span class="hljs-number">10</span></span> [Report <span class="hljs-keyword"><span class="hljs-keyword">Only</span></span>] Refused <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> the script <span class="hljs-string"><span class="hljs-string">'https://www.google-analytics.com/analytics.js'</span></span> because it violates the <span class="hljs-keyword"><span class="hljs-keyword">following</span></span> Content <span class="hljs-keyword"><span class="hljs-keyword">Security</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Policy</span></span> directive: "script-src 'self' 'unsafe-eval' vk.com cdn.pushwoosh.com yandex.ua yandex.st yandex.net yastatic.net yandexadexchange.net *.yandex.ru *.yandex.ua *.yandex.net *.yastatic.net *.yandexadexchange.net *.yandex-team.ru 'nonce-dWVmJGgsauDNxkDyep5LEg=='".</code> </pre> <br>  Now I will try to add all the same to the extension, and here, everything works.  The script was successfully added to the page without generating a single error. <br><br><h3>  findings </h3><br>  Yes, many will say that the choice of extensions is a personal matter for everyone, and Google more or less quickly blocked the extension (within a week from the moment I myself realized that it spammed me with advertising). <br><br>  On the other hand, it is not clear how much it was malicious.  I will explain why it was malicious: advertisements of doubtful products were added, with links to even more questionable sites, and, unfortunately, I don‚Äôt know if the extension collected any data on the pages I visited, and if so, which ones by the same success, they could collect information from forms or simply from the pages I visited. <br><br>  My opinion is that if a resource tells the browser a policy of behavior with the page received, then this policy should be absolute, and apply to everything, including extensions, but what do you think? </div><p>Source: <a href="https://habr.com/ru/post/315608/">https://habr.com/ru/post/315608/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315598/index.html">Deep Learning Program</a></li>
<li><a href="../315600/index.html">Virtual events in C #: something went wrong</a></li>
<li><a href="../315602/index.html">Founder's advice. As an online service of Egor Egereva transforms the event-market of Russia</a></li>
<li><a href="../315604/index.html">How we did the interactive quest for RailsClub</a></li>
<li><a href="../315606/index.html">C ++ 17 and C ++ 2a: news from the ISO meeting in Issaqua</a></li>
<li><a href="../315610/index.html">Security Week 46: OAuth 2.0 bypass, low-voltage ICMP DDoS, iOS privacy and loxcreen bypass</a></li>
<li><a href="../315614/index.html">SQL: a couple of tricks in SELECT queries</a></li>
<li><a href="../315616/index.html">Briefly and simply about the difficult - tariffing in "8-800"</a></li>
<li><a href="../315618/index.html">Connect Akuvox IP phones to Avaya PBX without a SIP license</a></li>
<li><a href="../315620/index.html">Headman and Neighbors</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>