<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Integration of PVS-Studio into the CI process</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, dear readers. 


 My name is Stas, I am an engineer of the DevOps Tooling team at Align Technology. 
 In this article I will try to briefly des...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Integration of PVS-Studio into the CI process</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello, dear readers. </p><br><p>  My name is Stas, I am an engineer of the DevOps Tooling team at Align Technology. <br>  In this article I will try to briefly describe how we implemented static code analysis based on PVS-Studio in our company. </p><br><h2>  Introduction </h2><br><p>  About a year ago, we thought about introducing static analysis into our company. <br>  We have used various tools for this, including for C / C ++ projects.  Therefore, it was interesting to try a new tool for a known task. <br>  A tool that is more advanced than the built-in VS, cpp-check, integrated into Sonar. </p><a name="habracut"></a><br><p>  As it always happens, an initiative group of developers first arose (from one developer, and his manager generally supported the idea). <br>  He came to our team and said he wanted to try. <br>  We contacted the developers of the PVS studio, they offered to use the trial free version. <br>  The developer checked the code of his project and arranged a presentation for the fellow developers, showing what errors PVS-Studio helps to reveal. <br>  Moreover, it was shown at the presentation that serious errors were encountered in the relatively new code. <br>  The presentation was very successful, the developers laughed at their colleagues' code and their code. <br>  The ranks of etuziast were replenished, moreover, which is valuable, including by managers. </p><br><p>  After that, the managers (in conjunction with the developers etuziasta) calculated the ROI for the implementation of this product. <br>  As they considered ROI, there may be a separate article on this. <br>  In general, we bought PVS-Studio. <br>  And our team was tasked to implement static analysis and error correction in the product development process. </p><br><p>  Here is how we solved this problem: </p><br><h2>  Process </h2><br><p>  The process of eliminating the identified warnings is jerky, mainly due to enthusiasts. <br>  From time to time, when someone from the initiative developers finds time, he eliminates any one type of warning. <br>  This is more convenient, because as a rule, warnings are easily fixed without changing the code logic, and therefore suspicious <br>  parts of the code can be easily refactored.  In addition, many warnings are eliminated with one or more <br>  more or less standard techniques, so eliminating one type of warning throughout the project is more productive, <br>  than, for example, eliminating the whole variety of warnings in a separate file. </p><br><h2>  Technical implementation </h2><br><p>  To make life easier for etuziastam developers, we have integrated the PVS analysis into the CI process. <br>  Atlassian Bamboo is our CI server, so I‚Äôll use its terms in the description. <br>  We have created special assembly plans that run automatically on a schedule.  One plan for each project. </p><br><p>  This plan starts a standalone-check of the head project for the current version of the code via the command line. <br>  The analysis continues for quite a long time (2-4 hours), because such a test we do not take more than once a day. <br>  After checking, the PVS analyzer generates a plog file ‚Äî essentially xml with a list of warnings found. <br>  After this file is processed a bit (absolute paths are replaced with relative ones), and then, with the help of xslt-transform, <br>  turns into a xUnit report that can understand and visualize Bamboo. <br>  We turn each type of warning into one unit test, with a list of all the files in which this warning is found. <br>  After the first launch, all warnings are sent to quarantine (that is, builds will be considered successful in case of failed tests). </p><br><p>  At that moment, when the developer fixes a particular type of warning, he releases the appropriate quarantine test. <br>  Thus, if suddenly the warning, which we believe corrected in the whole project, suddenly appears again, we get a fallen build <br>  and take action. </p><br><p>  It looks like a freshly detected warning: </p><br><p><img src="https://habrastorage.org/files/152/3be/da9/1523beda9c47427cb9d5819ceb09ed92.png" alt="Warning converted to test"></p><br><p>  Standard xUnit contains a three-level hierarchy: TestSuite as a union of TestCases.  The TestCase contains from 0 (if the test passed) to the Failures set.  We broadcast the test results as follows. </p><br><ul><li><p>  Testsuite are analyzers in PVS studios, for example, ‚ÄúProblems related to code analyzer‚Äù.  This level is not used in practice for any purpose; one could dump all TestCase into one TestSuite.  But we assume that for some projects some checks will not be considered, and this level of separation will come in handy. </p><br></li><li><p>  Testcase are specific warnings, for example, ‚ÄúImplicit type conversion argument of function 'foo' to 32-bit type‚Äù.  Actually, this is one test from the point of view of Bamboo.  TestCase for any warning is always there, regardless of whether this warning occurs in our code or not.  When the warning in our code does not occur - the test turns green. </p><br></li><li>  Failure is the file and line number where a specific warning is detected.  You can see where exactly it occurs and whether it is worth undertaking the correction of this type on Saturday evening.  :-) </li></ul><br><h2>  Difficulties </h2><br><p>  When integrating a PVS analyzer into our CI, several difficulties arose. </p><br><p>  First, the difficulty with the license.  We have purchased a site-license for 30 users.  In accordance with the licensing policy, one installation for a specific instance of the OS ‚Äúeats‚Äù one license. <br>  Since we have a lot of assemblies and projects, we also have decent agents - we are approaching the limit of 100 agents (now there are ~ 90).  Of course, not all of them are used to build C ++ code, however, we have enough of these machines.  We could not put on them at all the PVS studio, we had to make several agents allocated for this.  As a result, if at the moment of launching the analysis these selected agents are occupied, the analysis waits for their release and as a result takes them for a long time in the first half of the working day.  Because of this, we have health-check builds that are started after each commit, lacking agents.  In addition, it makes it difficult to automatically deploy agents (you have to recalculate used licenses all the time, which is not easy in the absence of a license server). </p><br><p>  Secondly, difficulties in obtaining a directory of warnings.  The only place from which you can get them is the website of the PVS-studio developers, the section of technical documentation.  However, we have not yet succeeded in making an automatic parser for this page - the page layout is too inconvenient for proper parsing and changes a little each time.  Yes, and there is a certain complexity of automatic centralized update of the PVS-studio versions on all agents and the directory (this can of course be solved, but has not yet reached out).  So update while hands. </p><br><h2>  Result </h2><br><p>  Here are some examples of errors found, that is, when the process worked in the new code. </p><br><ul><li><p>  V544.  It is odd that the value of 'X' of HRESULT type is compared with 'Y' </p><br><ul><li><p>  Minor issue: style issue at this point </p><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> HRESULT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findSomething</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X&amp; x)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// later in the code if (findSomething(x) == -1)</span></span></code> </pre> <br></li></ul><br></li><li><p>  V501: There are identical sub-expressions of the foo 'operator </p><br><ul><li><p>  Minor issue: invalid assert - no production impact </p><br><pre> <code class="cpp hljs">assert(leftPoints.size() == leftPoints.size());</code> </pre> <br></li><li><p>  Major issue: bug </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (upper &amp;&amp; upper) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> something;</code> </pre> <br></li><li><p>  Major issue: bug </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">operator</span></span></span><span class="hljs-class"> () ( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">char</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t2</span></span></span><span class="hljs-class"> ) {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( t1 != t1 ) { diff = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre> <br></li></ul><br></li><li><p>  V674: The expression contains a suspicious mix of integer and real types. </p><br><ul><li>  Major issue: bug <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">double</span></span> precision = getSettingInt(<span class="hljs-string"><span class="hljs-string">"Model"</span></span>, <span class="hljs-string"><span class="hljs-string">"Precision"</span></span>, <span class="hljs-number"><span class="hljs-number">1e-6</span></span>);</code> </pre> <br><p>  ¬∑ V655: The strings were concatenated but are not utilized.  Consider inspecting the expression. <br></p><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (someEnum) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> someCondition: err + <span class="hljs-string"><span class="hljs-string">" is null "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;</code> </pre> <p></p><br></li></ul><br><p>  V596: The object was not used.  The 'throw' keyword could be missing. </p><br><ul><li>  Minor issue: a bug that manifests itself with a small probability <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (open(‚Ä¶)) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::runtime_error(<span class="hljs-string"><span class="hljs-string">"Can not open database"</span></span>); }</code> </pre> </li></ul><br><br><p>  V557: ‚Äã‚ÄãArray overrun is possible. </p><br><ul><li>  Major issue: bug <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> Jx[<span class="hljs-number"><span class="hljs-number">3</span></span>]; ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">4</span></span>; i++){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j=i; j&lt;<span class="hljs-number"><span class="hljs-number">4</span></span>; j++){ value += Jx[i]*Jx[j]; } }</code> </pre> </li></ul><br><br></li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/282473/">https://habr.com/ru/post/282473/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282461/index.html">Free selection of 40 CSS effects</a></li>
<li><a href="../282463/index.html">The first update of the stable branch Vivaldi 1.1</a></li>
<li><a href="../282465/index.html">One little problem downloading files on slow connections</a></li>
<li><a href="../282467/index.html">How to connect the Internet in one day and set up telephony in the office?</a></li>
<li><a href="../282471/index.html">Yandex has developed a corporate font</a></li>
<li><a href="../282475/index.html">The implementation of the simulator of the mathematical game "Life"</a></li>
<li><a href="../282477/index.html">Async / Await in javascript. View from the outside</a></li>
<li><a href="../282479/index.html">CRM: April theses from Ruli24</a></li>
<li><a href="../282485/index.html">New Firefox 46.0 is available for free on FTP Mozilla</a></li>
<li><a href="../282489/index.html">Hackers and exchanges: The consequences of attacks on financial companies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>