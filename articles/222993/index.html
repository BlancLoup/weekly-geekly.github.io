<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>VM escape: 101</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will try to talk about the obvious (and not so) methods of escape from VMware WorkStation and VirtualBox, and also consider a few in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>VM escape: 101</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/697/42e/0c3/69742e0c31f14fb8045b6adf563cc462.png"><br><br>  In this article I will try to talk about the obvious (and not so) methods of escape from VMware WorkStation and VirtualBox, and also consider a few interesting special cases. <br><br>  VMware WorkStation, VirtualBox (Oracle VM VirtualBox) - <a href="http://ru.wikipedia.org/wiki/%25D0%2592%25D0%25B8%25D1%2580%25D1%2582%25D1%2583%25D0%25B0%25D0%25BB%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">virtualization</a> software products that allow you to run multiple operating systems on your computer at the same time. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><h4>  Instead of intro </h4><br>  VM escape stirs the minds of many security researchers.  Among hackers, these exploits are considered highly advanced and complex.  There are such examples, but there are quite a few of them (some of the most interesting are: <a href="http://blog.piotrbania.com/2009/09/vmware-cloudburst-vmware-guest-to-host.html">VMware CloudBurst</a> , <a href="http://www.vupen.com/blog/20120904.Advanced_Exploitation_of_Xen_Sysret_VM_Escape_CVE-2012-0217.php">Advanced Exploitation of Xen Hypervisor Sysret VM Escape Vulnerability</a> ).  But not always in order for your code from a virtual machine to hit the real one (or vice versa) you need to invent something such.  So, in the case of an attack on an ordinary user, we can take our ax and hack on the most banal things.  Without further ado - let's go. <br><br><h4>  Infection of shared folders </h4><br>  The easiest and most effective method at all times.  There is nothing special to write about this banality, I can only note that the spread of malicious code through shared network resources has already been historically implemented in many worms under NT systems. <br><br>  Shared Folder Options for VMware Workstation <br><img src="https://habrastorage.org/getpro/habr/post_images/5a1/117/73f/5a111773f266acd684d0893904adac77.png"><br><br>  Shared Folder Settings for VirtualBox <br><img src="https://habrastorage.org/getpro/habr/post_images/68c/9d4/cd6/68c9d4cd6792de5298eaaeb045d1bd3e.png"><br><br><h4>  Infection of captured USB devices </h4><br>  Not inferior in efficiency to the previous method considered option.  There are also quite implemented ITW-malware (as a historical example - <a href="http://en.wikipedia.org/wiki/Flame_%2528malware%2529">Flame</a> ) with built-in watchdogs that monitor the connection of USB devices that automatically propagate by infecting executable files, forwarding the malicious autorun.inf file, <a href="http://www.lavasoft.com/mylavasoft/securitycenter/whitepapers/lnk-exploits">LNK</a> vulnerability, etc. <br><br>  Naturally, the main condition for this method is the presence of a USB controller device with a specific configuration in the virtual machine. <br><br>  In VMware Workstation, it seems to me, the settings of the USB controller are implemented incorrectly: the filter is applied to all devices at once, and these dangerous settings are set by default when creating a new virtual machine. <br><br>  USB controller options for VMware Workstation <br><br><img src="https://habrastorage.org/getpro/habr/post_images/044/996/06c/04499606cb2a93f3fe2f6e1c0d70a83e.png"><br><br>  VirtualBox, on the contrary, is more flexible, allows us to install a controller filter on certain devices, although at the same time it is possible to install an empty filter to capture any USB, which is bad in terms of security. <br><br>  USB Controller Settings for VirtualBox <br><br><img src="https://habrastorage.org/getpro/habr/post_images/839/25b/5d4/83925b5d49bb9aae58ec85daf4155bec.png"><br><br><h4>  Attack on shared clipboard </h4><br><h5>  VMware Workstation </h5><br><h6>  Virtual Machine Settings </h6><br><img src="https://habrastorage.org/getpro/habr/post_images/33b/c44/3e5/33bc443e5b4569e8b440a8740eb6d6ea.png"><br><br>  To begin with, let's take a general look at the DnD (Drag'n'Drop) architecture and the shared clipboard.  Data transfer between the guest and the host is implemented through the GuestRpc mechanism, which is essentially a (0x1E) BackDoor I / O command (for those who do not know or have forgotten what VMware BackDoor I / O is: <a href="https://sites.google.com/site/chitchatvmback/backdoor">https://sites.google.com/ site / chitchatvmback / backdoor</a> ). <br><br>  DnD, a common clipboard model based on a class hierarchy (taken from <a href="http://open-vm-tools.sourceforge.net/about.php">OpenTools</a> sources): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cd9/304/5de/cd93045de1ad2ec4f0c3407f2603fd5d.png"><br><br>  In turn, GuestRpc also has a table of commands, the whole list of which can be obtained only after a thorough reversing of VMware (by the way, the standard set of guest utilities includes RpcTool, with which you can send GuestRpc commands accordingly).  In the case of DnD and the general clipboard, the following commands are used (also referred to as "transport interfaces"): <br>  dnd.transport <br>  copypaste.transport <br><br>  Each transport interface has its own set of commands that are already transmitted in the service headers of the data packet. <br><br>  So, for example, the command set for copypaste.transport looks like: <br><br><pre><code class="bash hljs">typedef enum { CP_CMD_REQUEST_CLIPBOARD = 2000, CP_CMD_REQUEST_FILES, CP_CMD_RECV_CLIPBOARD, CP_CMD_SEND_CLIPBOARD, CP_CMD_GET_FILES_DONE, CP_CMD_SEND_FILES_DONE, } CopyPasteCmdV4;</code> </pre> <br><br>  Package CP_CMD_SEND_CLIPBOARD, the clipboard directly highlighted in red <br>  Cross-platform format: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a0d/c67/45c/a0dc6745c0d78b20857c6020e1bd8197.png"><br><br>  So, possible scenarios for replacing VMware shared clipboard: <br><br><ul><li>  When a user copies any executable file from guest to host; </li><li>  When a user copies any executable file on a host with intermediate focus in the guest machine. </li></ul><br>  Accordingly, this is realized either by writing your clipboard monitor (send requests directly through BackDoor I / O), or by installing a number of hooks plus injecting your malicious code into the guest utility vmtoolsd.exe (under the NT system). <br><br>  Obviously, instead of an executable file, there can be any office exploit document, etc. <br><br>  A simple demonstration of this attack (directly injecting into the guest utility is used): <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/36F3i8PTTDw%3Ffeature%3Doembed&amp;xid=17259,1500000,15700023,15700186,15700190,15700253&amp;usg=ALkJrhimbXovNjB2_TxHCA8tf_-xiqJ9yg" frameborder="0" allowfullscreen=""></iframe><br><br><h5>  Virtualbox </h5><br>  Unfortunately (for an attacker), VirtualBox does not officially support the transfer of executable files in DnD and the general clipboard. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d22/c9a/755/d22c9a755237683f8aaea3945119437d.png"><br><br>  But I can not fail to mention the third-party project <a href="https://forums.virtualbox.org/viewtopic.php%3Ff%3D32%26t%3D52174">VMTransferFiles</a> , located on the official VirtualBox forum. <br><br>  With it, you can extend the functionality to transfer any files at your own risk, of course. <br><br><h4>  Attack on software indirectly related to virtualization </h4><br>  It is no secret that many diverse researchers in the field of information security somehow use virtual machines in their work.  For example, malware analysts often analyze the traffic or behavior of malware using the virtues of virtualization. <br>  Hence the roots of this sub-topic: to beat the software they use in this or that work. <br><br><h5>  Wireshark </h5><br>  It has long been the habit of using blacklists for various research software in various kinds of Malvaris, and Wireshark is actually one of the most popular candidates on this list. <br><br>  An example of a Rovnix bootkit blacklist: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5b8/a0f/c0e/5b8a0fc0e15847376a8066a741881fbd.png"><br><br>  Therefore, very often I observed a simple and lazy solution to bypass Wireshark detection: simply run it on my host, analyzing virtual machine traffic.  In addition, many sandbox systems automatically generate traffic pcp files, which, in turn, are usually analyzed on the host using Wireshark.  It would be a good idea to use various remote and local bugs in Wireshark dissectors for VM-escape purposes. <br><br>  As an example of a vulnerability, I decided to use <a href="http://cve.mitre.org/cgi-bin/cvename.cgi%3Fname%3DCVE-2014-2299">CVE-2014-2299</a> - a buffer overflow in the MPEG parser.  There is already an exploit source code, a <a href="http://1337day.com/exploit/22187">module under MetaSploit</a> . <br><br>  Video demonstration with combat calculators: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/Z-D5UqoyE4w%3Ffeature%3Doembed&amp;xid=17259,1500000,15700023,15700186,15700190,15700253&amp;usg=ALkJrhje3sckq3BMPkRQE9Gyf0pNqFzuYA" frameborder="0" allowfullscreen=""></iframe><br><br><h5>  Virtualkd </h5><br>  Before you begin, I draw your attention to an old, but interesting <a href="http://j00ru.vexillium.org/%3Fp%3D405">article</a> on how you can attack a host from a virtual machine using the remote kernel debugging protocol with the WinDbg debugger enabled. <br><br>  <a href="http://virtualkd.sysprogs.org/">VirtualKD</a> is an open-source project designed to improve kernel debugging performance under VMware or VirtualBox.  This is implemented by a very custom method (I will consider the implementation with VMware) - on the host side, the dm process is injected into the vmware-vmx process (our virtual machine process), which in turn patches / adds new commands and its handlers to the GuestRpc table.  From the guest‚Äôs side, a number of Kd * functions (KDCOM.DLL) are intercepted by their implementation in the KDVM.DLL driver. <br><br>  In fact, a simple scheme is obtained - the KDCOM protocol is tunneled through VMware BackDoor I / O (GuestRpc) to the host and then deployed directly to the pipe channel that WinDbg listens on. <br><br>  VirtulKD architecture (VMware specific): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/11c/902/0d5/11c9020d5ab23a18a5aa978fb11c9200.png"><br><br>  And everything would be fine, the utility really works, but I decided, in view of my theme, to go through its sources in search of quick bugs.  And indeed, within an hour, a trivial integer overflow was found. <br><br>  So, in the header file rpcdisp.h, in the KdRpcDispatcher :: SendPacket method, the data of the KDCOM-package wrapped with additional service information is processed. <br>  Some of this data is not validated correctly. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/329/4f4/2d9/3294f42d9a6b07fb1225cb69a82dabbf.png"><br><br>  As we see in the figure, the result of the addition of pParams [1] and pParams [2] can be easily overflowed (for example, pParams1 == 0xFFFF0000 and pParams2 == 0x18000 as a result will give us 0x8000).  And further on, the pParams [1] code will be used as an offset to the data, which will result in a common read error. <br><br>  Let me remind you that the processing of this data is in the context of the injected module.dll in the process of the vmware-vmx virtual machine, an exceptional situation in which leads to a drop in the process of the VMware virtual machine. <br><br>  Naturally, I wrote the sysprogs team about this bug, to which they replied in the style: ‚ÄúThank you, but we will not patch it, since we don‚Äôt see the impact‚Äù.  In addition, for some reason they thought that the bug was only used in kernel-mode under the guest, although in reality everything is just the opposite and even better - exploitation does not need any privileges at all!  In fact, the exploit sends our evil packages directly to BackDoor I / O, the size of the concept is in principle very small, and it can be easily, if desired, implemented in any malware. <br><br>  I also want to note that this VM DoS bug was found very quickly, and who knows - maybe, in VirtualKd, more significant vulnerabilities have been buried leading already to a real VM-escape.  For those who want to get acquainted with the exploit, here is its source <a href="">code</a> . <br><br>  And a small demonstration of this attack: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/R9OrT1g8N6U%3Ffeature%3Doembed&amp;xid=17259,1500000,15700023,15700186,15700190,15700253&amp;usg=ALkJrhj2eCaQXOMRJyuzERiqnS5QlW1BaA" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  Use of obsolete vulnerable technologies </h4><br><h5>  VMGL </h5><br>  This particular case, although it relates more to KVM and Xen, it seems to me, perfectly characterizes this under the topic. <br><br>  VMGL is a long-abandoned project on front-end OpenGL 3d hardware acceleration, which, however, still has links - for example, on the official page of the <a href="http://www.linux-kvm.org/page/HOWTO_VMGL">KVM project</a> . <br><br>  <a href="http://sysweb.cs.toronto.edu/vmgl%3Ftype%3DDownloads">Project site</a> where you can get the source code. <br><br>  Roughly speaking, VMGL is a client-server technology that tunnels through the TCP / IP protocol stack from a GL virtual command sent directly from a guest virtual machine to a host GPU. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/420/1f6/95c/4201f695c187b338ad67189fa0d15267.png"><br><br><h6>  VMGL architecture </h6><br>  After examining the deeper implementation and looking at the source code, I saw that the <a href="http://chromium.sourceforge.net/">Chromium</a> project was at the heart of VMGL.  So, this very Chromium project also underlies the 3D-acceleration of VirtualBox virtual machines and has already been studied quite successfully for the presence of bugs. <br><br>  So, with the installation of VMGL you get not just acceleration, but also at least three known <a href="http://www.coresecurity.com/advisories/oracle-virtualbox-3d-acceleration-multiple-memory-corruption-vulnerabilities">vulnerabilities</a> (CVE-2014-0981; CVE-2014-0982; CVE-2014-0983) of the Chromium engine design. <br><br>  Despite the fact that the vulnerabilities do not give us direct code execution, a theoretical VM escape is still possible, which should definitely excite you if, for some strange reason, you still use this abandoned project. <br><br>  Fragment of patched Chromium (util \ net.c) in VirtualBox (now vulnerable command handlers simply do not physically exist on the host): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/788/a80/0ae/788a800ae7dd685c1683b3e3787d1c88.png"><br><br><h4>  Conclusion </h4><br>  These simple and fairly simple methods of operation bring results and have been encountered in practice in some attacks.  So VM escape is not only hardcore exploitation of binary vulnerabilities with circumvention of various security mechanisms, but also well forgotten old ones. </div><p>Source: <a href="https://habr.com/ru/post/222993/">https://habr.com/ru/post/222993/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../222979/index.html">Another Pattern Matching in C #</a></li>
<li><a href="../222983/index.html">Mega-Tutorial Flask, Part 5: User Login</a></li>
<li><a href="../222985/index.html">IBM System / 360 - The story of the failure, not so</a></li>
<li><a href="../222989/index.html">Deep DRM injection or what awaits Firefox after Brendan Ike leaves</a></li>
<li><a href="../222991/index.html">Overview of leading companies in the provision of 3D printing services</a></li>
<li><a href="../222997/index.html">Is the native method expensive? JNI "Secret" extension</a></li>
<li><a href="../222999/index.html">ANC9 - evolution of headphones with active noise cancellation</a></li>
<li><a href="../223003/index.html">FCC approved net neutrality cancellation plan</a></li>
<li><a href="../223005/index.html">Spectral-selective polymer window films: 3M technology in sun protection</a></li>
<li><a href="../223009/index.html">"Quantum compass" as an alternative to GPS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>