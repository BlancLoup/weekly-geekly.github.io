<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Node.JS Loading modules on demand</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sometimes, for example, when processing large data arrays, in order to use maximum environmental resources and reduce the total working time spent, we...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Node.JS Loading modules on demand</h1><div class="post__text post__text-html js-mediator-article"> Sometimes, for example, when processing large data arrays, in order to use maximum environmental resources and reduce the total working time spent, we have to use competing processes that simultaneously perform similar tasks on different objects. <br><br>  Suppose we are developing a simple package for <em>npm</em> .  Let's call it, for example, <code>storage</code> .  We will foresee the possibility of using one of several types of storage, for example, <code>FsStorage</code> (file storage), <code>MysqlStorage</code> (MySQL storage), <code>MongoStorage</code> (Mongo storage). <br><a name="habracut"></a><br>  Throw the contents of the source code of our package (under the spoiler): <br><br><div class="spoiler">  <b class="spoiler_title">Approximate outline of the project source code</b> <div class="spoiler_text"><ul><li>  <code>package.json</code> : 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"storage"</span></span>, <span class="hljs-string"><span class="hljs-string">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.1.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"main"</span></span>: <span class="hljs-string"><span class="hljs-string">"./lib/index.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"dependencies"</span></span>: { <span class="hljs-string"><span class="hljs-string">"mysql"</span></span>: <span class="hljs-string"><span class="hljs-string">"*"</span></span>, <span class="hljs-string"><span class="hljs-string">"mongoose"</span></span>: <span class="hljs-string"><span class="hljs-string">"*"</span></span> } }</code> </pre> </li><li>  <code>lib/index.js</code> : <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">FsStorage</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./fs-storage.jsx'</span></span>), <span class="hljs-attr"><span class="hljs-attr">MysqlStorage</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./mysql-storage.jsx'</span></span>), <span class="hljs-attr"><span class="hljs-attr">MongoStorage</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./mongo-storage.jsx'</span></span>) };</code> </pre></li><li>  <code>lib/fs-storage.js</code> : <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = FsStorage; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FsStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// init code... }</span></span></code> </pre></li><li>  <code>lib/mysql-storage.js</code> : <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mysql = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'mysql'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = MysqlStorage; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MysqlStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// init code... }</span></span></code> </pre></li><li>  <code>lib/mongo-storage.js</code> : <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mongoose = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'mongoose'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = MongoStorage; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MongoStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// init code... }</span></span></code> </pre></li></ul><br></div></div><br>  The immediate dependency code of <code>mysql</code> and <code>mongoose</code> is not necessary for the demonstration.  Therefore, let's place <code>mysql</code> and <code>mongoose</code> stubs (under the spoiler) instead of the code: <br><br><div class="spoiler">  <b class="spoiler_title">Source code for stubs of the mysql and mongoose modules</b> <div class="spoiler_text"><ul><li>  <code>node_modules/mysql/index.js</code> : <br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'MySQL module loaded'</span></span>);</code> </pre></li><li>  <code>node_modules/mongoose/index.js</code> : <br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Mongoose module loaded'</span></span>);</code> </pre></li></ul></div></div><br>  Then the package's file structure will look like this (under the spoiler): <br><br><div class="spoiler">  <b class="spoiler_title">Layout of the file structure tree</b> <div class="spoiler_text"><pre> <code class="javascript hljs">storage/ ‚îú lib/ ‚îÇ ‚îú index.js ‚îÇ ‚îú fs-storage.js ‚îÇ ‚îú mongo-storage.js ‚îÇ ‚îî mysql-storage.js ‚îú node_modules/ ‚îÇ ‚îú mongoose/ ‚îÇ ‚îÇ ‚îî index.js ‚îÇ ‚îî mysql/ ‚îÇ ‚îî index.js ‚îî package.json</code> </pre></div></div><br>  Now imagine that we have a mega-big task that we will perform with the help of several child processes, and in the course of execution we need to use the storage as files. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> storage = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'storage'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fsStorage = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> storage.FsStorage();</code> </pre><br>  We start and we observe: each child process occupies memory 10 times more than expected.  And if the number of competing processes exceeds a hundred, and this is not the only task that is performed on the server in real time ?! <br><br>  Here we understand that, for example, when using file storage, there is no need to load both the <i>MySQL</i> database management library and the <i>Mongo</i> ODM client. <br><br>  Immediately after calling <code>require('storage')</code> , messages are displayed in the console: <br><br><pre> <code class="javascript hljs">MySQL <span class="hljs-built_in"><span class="hljs-built_in">module</span></span> loaded Mongoose <span class="hljs-built_in"><span class="hljs-built_in">module</span></span> loaded</code> </pre><br>  <code>Object.defineProperty()</code> experimented with the <code>Object.defineProperty()</code> method, I achieved an amazing result, which I designed as a function <code>demandProperty()</code> : <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">demandProperty</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj, name, modPath</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.defineProperty(obj, name, { <span class="hljs-attr"><span class="hljs-attr">configurable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">enumerable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">get</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mod = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(modPath); <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.defineProperty(obj, name, { <span class="hljs-attr"><span class="hljs-attr">configurable</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">enumerable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: mod }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mod } }) }</code> </pre><br>  The principle of operation is simple: Instead of a direct link, for example, to <code>MysqlStorage()</code> , an accessor ( <em>getter</em> ) is created.  With any request to the accessor, <code>require()</code> triggered, and the accessor itself returns the result of <code>require()</code> .  In addition, using the same <code>Object.defineProperty()</code> we set back a direct link to the same <code>require()</code> result instead of the accessor (that is, on <code>MysqlStorage()</code> ).  So all requests (of course, except the first) will work with the same speed and reliability from leaks, as if we had left the classic <code>require()</code> . <br><br>  Change <code>lib/index.js</code> .  Replace: <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">FsStorage</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./fs-storage.jsx'</span></span>), <span class="hljs-attr"><span class="hljs-attr">MysqlStorage</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./mysql-storage.jsx'</span></span>), <span class="hljs-attr"><span class="hljs-attr">MongoStorage</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./mongo-storage.jsx'</span></span>), };</code> </pre>  on: <br><br><pre> <code class="javascript hljs">demandProperty(<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports, <span class="hljs-string"><span class="hljs-string">'FsStorage'</span></span>, <span class="hljs-string"><span class="hljs-string">'./fs-storage.jsx'</span></span>); demandProperty(<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports, <span class="hljs-string"><span class="hljs-string">'MysqlStorage'</span></span>, <span class="hljs-string"><span class="hljs-string">'./mysql-storage.jsx'</span></span>); demandProperty(<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports, <span class="hljs-string"><span class="hljs-string">'MongoStorage'</span></span>, <span class="hljs-string"><span class="hljs-string">'./mongo-storage.jsx'</span></span>);</code> </pre><br>  And we use: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> storage = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'storage'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(util.inspect(storage)); <span class="hljs-comment"><span class="hljs-comment">/* =&gt; { FsStorage: [Getter], MysqlStorage: [Getter], MongoStorage: [Getter] } */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(util.inspect(storage.FsStorage.name)); <span class="hljs-comment"><span class="hljs-comment">// =&gt; 'FsStorage' console.log(util.inspect(storage)); /* =&gt; { FsStorage: [Function: FsStorage], MysqlStorage: [Getter], MongoStorage: [Getter] } */ var mysql = new storage.MysqlStorage(); // =&gt; MySQL module loaded console.log(util.inspect(mysql)); // =&gt; '{}' console.log(util.inspect(storage)); /* =&gt; { FsStorage: [Function: FsStorage], MysqlStorage: [Function: MysqlStorage], MongoStorage: [Getter] } */</span></span></code> </pre><br>  There is another subtlety.  If the definition of the <code>demandProperty()</code> function is <code>demandProperty()</code> outside the modules in the <code>lib</code> folder, the last argument must be passed the full path to the module, otherwise <code>require()</code> will look for the module in the folder where <code>demandProperty()</code> defined: <br><br><pre> <code class="javascript hljs">demandProperty(<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports, <span class="hljs-string"><span class="hljs-string">'FsStorage'</span></span>, path.resolve(__dirname, <span class="hljs-string"><span class="hljs-string">'./fs-storage.jsx'</span></span>)); demandProperty(<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports, <span class="hljs-string"><span class="hljs-string">'MysqlStorage'</span></span>, path.resolve(__dirname, <span class="hljs-string"><span class="hljs-string">'./mysql-storage.jsx'</span></span>)); demandProperty(<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports, <span class="hljs-string"><span class="hljs-string">'MongoStorage'</span></span>, path.resolve(__dirname, <span class="hljs-string"><span class="hljs-string">'./mongo-storage.jsx'</span></span>));</code> </pre><br><br>  All successful experiments! </div><p>Source: <a href="https://habr.com/ru/post/259281/">https://habr.com/ru/post/259281/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259271/index.html">PVS-Studio - we invite you to listen and watch</a></li>
<li><a href="../259273/index.html">Sales funnel in CRM: do not be gadgets, analyze losses</a></li>
<li><a href="../259275/index.html">Problems caused by defining tuples as functors</a></li>
<li><a href="../259277/index.html">Eight different types of programmers</a></li>
<li><a href="../259279/index.html">Looking for the perfect javascript framework</a></li>
<li><a href="../259283/index.html">Understanding UEFI and GPT: Installing Windows and Kubuntu on a single disk</a></li>
<li><a href="../259285/index.html">Bolts in tea, or a webinar on probability theory in practice</a></li>
<li><a href="../259287/index.html">New converged solutions from HP Networking</a></li>
<li><a href="../259291/index.html">Tunnel modeling - version 0.9</a></li>
<li><a href="../259293/index.html">Time management for the developer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>