<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Levenshtein distance in MySQL and fuzzy search algorithms using PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The famous Soviet and Russian mathematician Vladimir Iosifovich Levenshtein (by the way, who died a little over two months ago) at the beginning of th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Levenshtein distance in MySQL and fuzzy search algorithms using PHP</h1><div class="post__text post__text-html js-mediator-article">  The famous Soviet and Russian mathematician Vladimir Iosifovich Levenshtein (by the way, who died a little over two months ago) at the beginning of the second half of the last century introduced the concept of <i>editing distance</i> , which we use to this day in various fields - from search engines to bioinformatics.  In this article, we will apply its principle for <b>fuzzy searching</b> in MySQL (since MySQL currently does not offer an embedded solution), calculating the most efficient (i.e. fast) method from several found on the Internet, build an algorithm for such a search and implement it on PHP <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/za/9o/ei/za9oeiwzj2gye0ir0l7ukircjly.jpeg" alt="Google understands us"></div><a name="habracut"></a><br>  What will we use: <br><br><ul><li>  <a href="https://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B0%25D1%2581%25D1%2581%25D1%2582%25D0%25BE%25D1%258F%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%259B%25D0%25B5%25D0%25B2%25D0%25B5%25D0%25BD%25D1%2588%25D1%2582%25D0%25B5%25D0%25B9%25D0%25BD%25D0%25B0">Levenshtein distance</a> and <a href="https://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B0%25D1%2581%25D1%2581%25D1%2582%25D0%25BE%25D1%258F%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%2594%25D0%25B0%25D0%25BC%25D0%25B5%25D1%2580%25D0%25B0%25D1%2583_%25E2%2580%2594_%25D0%259B%25D0%25B5%25D0%25B2%25D0%25B5%25D0%25BD%25D1%2588%25D1%2582%25D0%25B5%25D0%25B9%25D0%25BD%25D0%25B0">Damerau-Levenshtein distance</a> : both represent the minimum number of operations for converting one string to another, differing in operations - Levenshtein suggested <i>inserting</i> , <i>deleting</i> and <i>replacing</i> one character, and Damerau added them with a <i>transposition</i> operation, i.e.  when two adjacent symbols change places;  The following implementations have been proposed for MySQL: <br><ul><li>  <a href="https://gordonlesti.com/fuzzy-fulltext-search-with-mysql/">request in the style of the Levenshtein algorithm</a> , by Gordon Lesti </li><li>  <a href="http://www.artfulsoftware.com/infotree/qrytip.php%3Fid%3D552">user function for calculating the Levenshtein distance,</a> published in the book <i>Get It Done With MySQL 5 &amp; Up</i> (ed. Peter Brawley and Arthur Fuller), by Just Rust </li><li>  <a href="https://github.com/ifsnop/damlev">custom function for calculating the Damerau-Levenshtein distance,</a> written on the basis <a href="">of a C function written by Linus Torvalds,</a> by Diego Torres </li></ul></li><li>  <a href="https://files.fm/down.php%3Fi%3Du333ggrr%26n%3DTR173.dgraph.pdf">Oliver's algorithm</a> : calculates the similarity of two lines <br><ul><li>  in PHP is represented by the function <a href="http://php.net/manual/en/function.similar-text.php">similar_text</a> </li></ul></li><li>  <a href="https://ru.wikipedia.org/wiki/Metaphone">metaphone</a> : the algorithm for indexing words according to the phonetic principle, works only with letters of the English alphabet <br><ul><li>  in PHP is represented by the <a href="http://php.net/manual/en/function.metaphone.php">metaphone</a> function </li></ul></li></ul><br><div class="spoiler">  <b class="spoiler_title">What we will not use</b> <div class="spoiler_text"><ul><li>  <a href="https://ru.wikipedia.org/wiki/Soundex">soundex</a> and its PHP function </li><li>  <a href="https://habrahabr.ru/post/114947/">all the remaining algorithms</a> , since  PHP has no corresponding functions. </li></ul></div></div><br><h2>  Fuzzy search algorithm </h2><br>  Obviously, with each search, it makes no sense to calculate the Levenshtein distance between the entered word and each word from the dictionary in the database, since  it will take a lot of time.  By the way, several years ago, a <a href="https://habrahabr.ru/post/115394/">method</a> was described in Habr√© where, with each search, the entire dictionary from the database was pushed into a PHP array, transliterated, and similar words were selected further, alternately using either the levenshtein function, the metaphone, the similar_text, or two at once.  The solution of preliminary rapid filtering and subsequent refining of the options found suggests itself. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Thus, the essence of the fuzzy search algorithm can be summarized as follows: <br><br><ol><li>  Calculate the search query metaphone. </li><li>  Find all words in the dictionary in the database by metaphone with Levenshtein distance (or Damerau-Levenshtein) &lt;2 characters. </li><li>  If nothing is found - the user has made too many errors in the word, stop tormenting the database and write that the <s>user goes to the bath and</s> nothing is found. </li><li>  If 1 word is found, return it. </li><li>  If found&gt; 1 words - refined: find the percentage of similarity of the search query with each found word from the dictionary in the database;  find the maximum percentage of similarity;  return all words with this percentage (in case several words have the same percentage, which will be the maximum). </li></ol><br>  With each search, it will be necessary to calculate the Levenshtein distance.  To do this, you need to find the fastest implementation of the algorithm for MySQL. <br><br><h2>  DB Preparation </h2><br>  For all tests, a <a href="https://github.com/x88/i18nGeoNamesDB">base of settlements</a> was selected, 4 years ago pulled out of Vkontakte.  For the tests, a table of cities was used, which contains more than 2.2 million records, partially translated into 13 languages.  Only columns with Russian translations were left, which contained many untranslated titles.  Also an index was made for the city_id column. <br><br>  The next step was the formation of a metaphone for each title.  Since the metaphone is calculated only from strings containing letters of the English alphabet, each name must first be converted: transliterate Cyrillic letters, and Latin letters containing accents must be converted into letters of the English alphabet. <br><br>  Thus, the PHP code for adding a metaphone column is as follows: <br><br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//        set_time_limit(0); ini_set('max_execution_time', 0); //   ,    $from = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '√°', 'ƒÉ', '·∫Ø', '·∫∑', '·∫±', '·∫≥', '·∫µ', '«é', '√¢', '·∫•', '·∫≠', '·∫ß', '·∫©', '·∫´', '√§', '«ü', '»ß', '«°', '·∫°', '»Å', '√†', '·∫£', '»É', 'ƒÅ', 'ƒÖ', '·∂è', '·∫ö', '√•', '«ª', '·∏Å', '‚±•', '√£', '…ê', '‚Çê', '·∏É', '·∏Ö', '…ì', '·∏á', '·µ¨', '·∂Ä', '∆Ä', '∆É', 'ƒá', 'ƒç', '√ß', '·∏â', 'ƒâ', '…ï', 'ƒã', '∆à', '»º', '‚ÜÑ', 'Íúø', 'ƒè', '·∏ë', '·∏ì', '»°', '·∏ã', '·∏ç', '…ó', '·∂ë', '·∏è', '·µ≠', '·∂Å', 'ƒë', '…ñ', '∆å', 'Íù∫', '√©', 'ƒï', 'ƒõ', '»©', '·∏ù', '√™', '·∫ø', '·ªá', '·ªÅ', '·ªÉ', '·ªÖ', '·∏ô', '√´', 'ƒó', '·∫π', '»Ö', '√®', '·∫ª', '»á', 'ƒì', '·∏ó', '·∏ï', '‚±∏', 'ƒô', '·∂í', '…á', '·∫Ω', '·∏õ', '…õ', '·∂ì', '…ò', '«ù', '‚Çë', '·∏ü', '∆í', '·µÆ', '·∂Ç', 'Íùº', '«µ', 'ƒü', '«ß', 'ƒ£', 'ƒù', 'ƒ°', '…†', '·∏°', '·∂É', '«•', '·µπ', '…°', '·µ∑', '·∏´', '»ü', '·∏©', 'ƒ•', '‚±®', '·∏ß', '·∏£', '·∏•', '…¶', '·∫ñ', 'ƒß', '…•', ' Æ', ' Ø', '√≠', 'ƒ≠', '«ê', '√Æ', '√Ø', '·∏Ø', '·ªã', '»â', '√¨', '·ªâ', '»ã', 'ƒ´', 'ƒØ', '·∂ñ', '…®', 'ƒ©', '·∏≠', 'ƒ±', '·¥â', '·µ¢', '«∞', 'ƒµ', ' ù', '…â', '»∑', '…ü', ' Ñ', '‚±º', '·∏±', '«©', 'ƒ∑', '‚±™', 'ÍùÉ', '·∏≥', '∆ô', '·∏µ', '·∂Ñ', 'ÍùÅ', 'ÍùÖ', ' û', 'ƒ∫', '∆ö', '…¨', 'ƒæ', 'ƒº', '·∏Ω', '»¥', '·∏∑', '·∏π', '‚±°', 'Íùâ', '·∏ª', '≈Ä', '…´', '·∂Ö', '…≠', '≈Ç', 'ÍûÅ', '·∏ø', '·πÅ', '·πÉ', '…±', '·µØ', '·∂Ü', '…Ø', '…∞', '≈Ñ', '≈à', '≈Ü', '·πã', '»µ', '·πÖ', '·πá', '«π', '…≤', '·πâ', '∆û', '·µ∞', '·∂á', '…≥', '√±', '√≥', '≈è', '«í', '√¥', '·ªë', '·ªô', '·ªì', '·ªï', '·ªó', '√∂', '»´', '»Ø', '»±', '·ªç', '≈ë', '»ç', '√≤', '·ªè', '∆°', '·ªõ', '·ª£', '·ªù', '·ªü', '·ª°', '»è', 'Íùã', 'Íùç', '‚±∫', '≈ç', '·πì', '·πë', '«´', '«≠', '√∏', '«ø', '√µ', '·πç', '·πè', '»≠', '…µ', '…î', '·∂ó', '·¥ë', '·¥ì', '‚Çí', '·πï', '·πó', 'Íùì', '∆•', '·µ±', '·∂à', 'Íùï', '·µΩ', 'Íùë', ' †', '…ã', 'Íùô', 'Íùó', '≈ï', '≈ô', '≈ó', '·πô', '·πõ', '·πù', '»ë', '…æ', '·µ≥', '»ì', '·πü', '…º', '·µ≤', '·∂â', '…ç', '…Ω', 'ÍûÉ', '…ø', '…π', '…ª', '…∫', '‚±π', '·µ£', '≈õ', '·π•', '≈°', '·πß', '≈ü', '≈ù', '»ô', '·π°', '·π£', '·π©', ' Ç', '·µ¥', '·∂ä', '»ø', 'ÍûÖ', '≈ø', '·∫ú', '·∫õ', '·∫ù', '≈•', '≈£', '·π±', '»õ', '»∂', '·∫ó', '‚±¶', '·π´', '·π≠', '∆≠', '·πØ', '·µµ', '∆´', ' à', '≈ß', 'Íûá', ' á', '√∫', '≈≠', '«î', '√ª', '·π∑', '√º', '«ò', '«ö', '«ú', '«ñ', '·π≥', '·ª•', '≈±', '»ï', '√π', '·¥ù', '·ªß', '∆∞', '·ª©', '·ª±', '·ª´', '·ª≠', '·ªØ', '»ó', '≈´', '·πª', '≈≥', '·∂ô', '≈Ø', '≈©', '·ππ', '·πµ', '·µ§', '·πø', '‚±¥', 'Íùü', ' ã', '·∂å', '‚±±', '·πΩ', ' å', '·µ•', '·∫É', '≈µ', '·∫Ö', '·∫á', '·∫â', '·∫Å', '‚±≥', '·∫ò', ' ç', '·∫ç', '·∫ã', '·∂ç', '‚Çì', '√Ω', '≈∑', '√ø', '·∫è', '·ªµ', '·ª≥', '∆¥', '·ª∑', '·ªø', '»≥', '·∫ô', '…è', '·ªπ', ' é', '≈∫', '≈æ', '·∫ë', ' ë', '‚±¨', '≈º', '·∫ì', '»•', '·∫ï', '·µ∂', '·∂é', ' ê', '∆∂', '…Ä', '√ü' ]; //   ,     $to = ['a', 'b', 'v', 'g', 'd', 'e', 'yo', 'zh', 'z', 'i', 'y', 'k', 'l', 'm', 'n', 'o', 'p', 'r', 's', 't', 'u', 'f', 'h', 'ts', 'ch', 'sh', 'shch', '', 'y', '', 'e', 'yu', 'ya', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'a', 'b', 'b', 'b', 'b', 'b', 'b', 'b', 'b', 'c', 'c', 'c', 'c', 'c', 'c', 'c', 'c', 'c', 'c', 'c', 'd', 'd', 'd', 'd', 'd', 'd', 'd', 'd', 'd', 'd', 'd', 'd', 'd', 'd', 'd', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'e', 'f', 'f', 'f', 'f', 'f', 'g', 'g', 'g', 'g', 'g', 'g', 'g', 'g', 'g', 'g', 'g', 'g', 'g', 'h', 'h', 'h', 'h', 'h', 'h', 'h', 'h', 'h', 'h', 'h', 'h', 'h', 'h', 'i', 'i', 'i', 'i', 'i', 'i', 'i', 'i', 'i', 'i', 'i', 'i', 'i', 'i', 'i', 'i', 'i', 'i', 'i', 'i', 'j', 'j', 'j', 'j', 'j', 'j', 'j', 'j', 'k', 'k', 'k', 'k', 'k', 'k', 'k', 'k', 'k', 'k', 'k', 'k', 'l', 'l', 'l', 'l', 'l', 'l', 'l', 'l', 'l', 'l', 'l', 'l', 'l', 'l', 'l', 'l', 'l', 'l', 'm', 'm', 'm', 'm', 'm', 'm', 'm', 'm', 'n', 'n', 'n', 'n', 'n', 'n', 'n', 'n', 'n', 'n', 'n', 'n', 'n', 'n', 'n', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'o', 'p', 'p', 'p', 'p', 'p', 'p', 'p', 'p', 'p', 'q', 'q', 'q', 'q', 'r', 'r', 'r', 'r', 'r', 'r', 'r', 'r', 'r', 'r', 'r', 'r', 'r', 'r', 'r', 'r', 'r', 'r', 'r', 'r', 'r', 'r', 'r', 's', 's', 's', 's', 's', 's', 's', 's', 's', 's', 's', 's', 's', 's', 's', 's', 's', 's', 's', 't', 't', 't', 't', 't', 't', 't', 't', 't', 't', 't', 't', 't', 't', 't', 't', 't', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'u', 'v', 'v', 'v', 'v', 'v', 'w', 'w', 'w', 'w', 'w', 'w', 'w', 'w', 'w', 'x', 'x', 'x', 'x', 'y', 'y', 'y', 'y', 'y', 'y', 'y', 'y', 'y', 'y', 'y', 'y', 'y', 'y', 'z', 'z', 'z', 'z', 'z', 'z', 'z', 'z', 'z', 'z', 'z', 'z', 'z', 'z', 'ss']; //     function mtphn($s){ //        return metaphone( str_replace($from, $to, mb_strtolower($s)) ); } //     $conn = mysqli_connect('localhost','root','','test') or die(mysqli_error($conn)); //       mysqli_query($conn, "ALTER TABLE _cities ADD COLUMN metaphone VARCHAR(30) DEFAULT NULL"); //      id $q = mysqli_query($conn, "SELECT city_id, title_ru FROM _cities"); while ($row = mysqli_fetch_assoc($q)) //        mysqli_query($conn, "UPDATE _cities SET metaphone='".mtphn($row['title_ru'])."' WHERE city_id=".$row['city_id']); mysqli_close($conn); //        echo '.   '.( microtime(true) - $_SERVER["REQUEST_TIME_FLOAT"] ).' .';</span></span></code> </pre> <br>  For 2,246,813 lines, the calculation of the metaphone and its insertion took ~ 38 minutes. <br><br>  Also an index was made on the metaphone column, since  further search operations will take place only in it. <br><br><h2>  Selecting Levenshtein distance implementation for MySQL </h2><br>  As noted earlier, three implementations will be checked for speed ‚Äî the Flattery query, the Rast function, and the Torres function. <br><br>  For the tests, 5 words will be used (or rather, their erroneous spelling), 3 of them are in Cyrillic, and 2 in Latin: <br><table><tbody><tr><td>  No </td><td>  Correct writing </td><td>  His metaphone </td><td>  <b>Wrong spelling</b> </td><td>  His metaphone </td><td>  Levenshtein metaphones </td></tr><tr><td>  one. </td><td>  Aleksandrovsk-Sakhalinsky </td><td>  ALKSNTRFSKSHLNSK </td><td>  Al <u>and</u> xander sa vsk-sa <u>g</u> olin <u>z</u> kiy </td><td>  ALKSNTRFSKS <u>K</u> LNSK </td><td>  one </td></tr><tr><td>  2 </td><td>  Semikarakorsk </td><td>  SMKRKRSK </td><td>  Semik <u>about</u> raco <u>in</u> sk </td><td>  SMKRK <u>F</u> SK </td><td>  one </td></tr><tr><td>  3 </td><td>  Charentsavan </td><td>  XRNTSFN </td><td>  H </td><td>  XRNTS <u>F</u> </td><td>  one </td></tr><tr><td>  four. </td><td>  Bounounbougoula </td><td>  BNNBKL </td><td>  B <u>o</u> n <u>u</u> nb <u>o</u> g <u>uv</u> a </td><td>  BNNBK <u>F</u> </td><td>  one </td></tr><tr><td>  five. </td><td>  Kampong Tenaki Kawang </td><td>  KMPNKTNKKWNK </td><td>  Kampo <u>nt</u> enaki ka ang </td><td>  KMP <u>NT</u> NKK <u>F</u> NK </td><td>  2 </td></tr></tbody></table>  In the last word, more mistakes were intentionally made so that the Levenshtein distance was 2 characters.  If each method works correctly, when searching for the last word, 0 lines will be returned each time. <br><br><h4>  Flattery Request </h4><br>  <a href="https://gordonlesti.com/fuzzy-fulltext-search-with-mysql/">The first option</a> is the most primitive of all three: here the principle of Levenshtein distance (insert, delete and replace), which is simulated in a SQL query using a large number of LIKE operators, is taken as a basis.  If the string (word) consists of <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>n</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.395ex" height="1.455ex" viewBox="0 -520.7 600.5 626.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-6E" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi></math></span></span><script type="math/tex" id="MathJax-Element-1"> n </script>  characters (letters), the number of LIKE operators when searching for Levenshtein distance of 1 character will be equal to <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>3</mn><mi>n</mi><mo>+</mo><mn>1</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.56ex" height="2.057ex" viewBox="0 -728.2 2824.4 885.9" role="img" focusable="false" style="vertical-align: -0.366ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMAIN-33" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-6E" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMAIN-2B" x="1323" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMAIN-31" x="2323" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>3</mn><mi>n</mi><mo>+</mo><mn>1</mn></math></span></span><script type="math/tex" id="MathJax-Element-2"> 3n + 1 </script>  (or <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>3</mn><mi>n</mi><mo>+</mo><mn>2</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.56ex" height="2.057ex" viewBox="0 -728.2 2824.4 885.9" role="img" focusable="false" style="vertical-align: -0.366ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMAIN-33" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-6E" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMAIN-2B" x="1323" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMAIN-32" x="2323" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>3</mn><mi>n</mi><mo>+</mo><mn>2</mn></math></span></span><script type="math/tex" id="MathJax-Element-3"> 3n + 2 </script>  when searching for Levenshtein distance &lt;2 characters). <br><br>  At the end of the article, the author offers a PHP function to automate the compilation of such SQL queries.  This function has been changed for our search by metaphones, but the principle is the same: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//    $input = ''; //    $input_m = mtphn($input); //  ,     LIKE  SQL- //       $q_likes = [$input_m . '_']; //     for ($i = 0, $len = strlen($input_m); $i &lt; $len; $i++) //     ,    for($n = 1; $n &lt; 4; $n++) $q_likes[] = substr( $input_m, 0, $i ) . ($n &amp; 1 ? '_' : '') . substr( $input_m, $i + ($n &gt; 1 ? 1 : 0) ); //    $conn = mysqli_connect('localhost','root','','test') or die(mysqli_error($conn)); //   +       $q = mysqli_query($conn, "SELECT city_id, title_ru FROM _cities WHERE metaphone LIKE '".implode("' OR metaphone LIKE '",$q_likes)."'"); //   mysqli_close($conn); //     $result = []; //     while($row = mysqli_fetch_assoc($q)) $result[] = [ $row['city_id'], $row['title_ru'] ]; //    // echo'&lt;pre&gt;'; print_r($result); echo'&lt;/pre&gt;'; echo '&lt;p&gt;.   '.( microtime(true) - $_SERVER["REQUEST_TIME_FLOAT"] ).' ';</span></span></code> </pre><br>  LIKE was checked with both <a href="https://ru.wikipedia.org/wiki/%25D0%25A8%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D0%25BE%25D0%25B8%25D1%2581%25D0%25BA%25D0%25B0">search patterns</a> , both with an underscore and with a percent sign. <br><table><tbody><tr><td>  Word number </td><td>  <i>t</i> for LIKE with "_", sec </td><td>  Found </td><td>  <i>t</i> for LIKE with "%", s </td><td>  Found </td></tr><tr><td>  one. </td><td>  24.2 </td><td>  one </td><td>  24.6 </td><td>  one </td></tr><tr><td>  2 </td><td>  14.1 </td><td>  one </td><td>  14.8 </td><td>  four </td></tr><tr><td>  3 </td><td>  11.9 </td><td>  188 </td><td>  12.3 </td><td>  224 </td></tr><tr><td>  four. </td><td>  11.9 </td><td>  70 </td><td>  12.8 </td><td>  87 </td></tr><tr><td>  five. </td><td>  18.1 </td><td>  0 </td><td>  19.6 </td><td>  0 </td></tr></tbody></table>  The longer the word, the more time is needed to search for similar metaphones (which is obvious), but, at the same time, the longer the word, the less time is spent on each letter (which is not obvious).  Let's pretend that <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>t</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="1.937ex" viewBox="0 -728.2 361.5 834" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-74" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>t</mi></math></span></span><script type="math/tex" id="MathJax-Element-4"> t </script>  - the total time spent searching for similar metaphones, and <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>n</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.395ex" height="1.455ex" viewBox="0 -520.7 600.5 626.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-6E" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi></math></span></span><script type="math/tex" id="MathJax-Element-5"> n </script>  - the total number of letters in the metaphone for which we were looking for similarities;  if the first word is shorter than the second ( <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-6-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>n</mi><mn>1</mn></msub><mo>&amp;lt;</mo><msub><mi>n</mi><mn>2</mn></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.996ex" height="1.937ex" viewBox="0 -624.5 3442.9 834" role="img" focusable="false" style="vertical-align: -0.487ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-6E" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMAIN-31" x="849" y="-213"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMAIN-3C" x="1332" y="0"></use><g transform="translate(2388,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-6E" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMAIN-32" x="849" y="-213"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>n</mi><mn>1</mn></msub><mo>&lt;</mo><msub><mi>n</mi><mn>2</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-6"> n_1 <n_2 </script>  ) and, accordingly, the total time spent searching for similar metaphones for the first word is less than for the second ( <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-7-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>t</mi><mn>1</mn></msub><mo>&amp;lt;</mo><msub><mi>t</mi><mn>2</mn></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.886ex" height="2.178ex" viewBox="0 -728.2 2964.9 937.7" role="img" focusable="false" style="vertical-align: -0.487ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-74" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMAIN-31" x="511" y="-213"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMAIN-3C" x="1093" y="0"></use><g transform="translate(2149,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-74" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMAIN-32" x="511" y="-213"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>t</mi><mn>1</mn></msub><mo>&lt;</mo><msub><mi>t</mi><mn>2</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-7"> t_1 <t_2 </script>  ), then <br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-8-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>t</mi><mn>1</mn></msub></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>n</mi><mn>1</mn></msub></mrow><mo>&amp;gt;</mo><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>t</mi><mn>2</mn></msub></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>n</mi><mn>2</mn></msub></mrow></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="22.073ex" height="2.419ex" viewBox="0 -780.1 9503.7 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-66" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-72" x="800" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-61" x="1252" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-63" x="1781" y="0"></use><g transform="translate(2215,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-74" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMAIN-31" x="511" y="-213"></use></g><g transform="translate(3030,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-6E" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMAIN-31" x="849" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMAIN-3E" x="4362" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-66" x="5668" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-72" x="6219" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-61" x="6670" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-63" x="7200" y="0"></use><g transform="translate(7633,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-74" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMAIN-32" x="511" y="-213"></use></g><g transform="translate(8449,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMATHI-6E" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/342434/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhi9WwPmFSqAXdmDfxrsIQI3igfTVA#MJMAIN-32" x="849" y="-213"></use></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><msub><mi>t</mi><mn>1</mn></msub></mrow><mrow class="MJX-TeXAtom-ORD"><msub><mi>n</mi><mn>1</mn></msub></mrow><mo>&gt;</mo><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><msub><mi>t</mi><mn>2</mn></msub></mrow><mrow class="MJX-TeXAtom-ORD"><msub><mi>n</mi><mn>2</mn></msub></mrow></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-8"> \ frac {t_1} {n_1}> \ frac {t_2} {n_2} </script></p>  A sharp increase in time was also expected when replacing the search pattern "_" with "%", but the total time increased from 2-8%. <br><br><h4>  Rasta function </h4><br>  <a href="http://www.artfulsoftware.com/infotree/qrytip.php%3Fid%3D552">The second option</a> is the user-defined levenshtein function, which takes two parameters ‚Äî two VARCHAR strings (255), and returns the INT number ‚Äî the Levenshtein distance.  The auxiliary function levenshtein_ratio is also proposed, which, on the basis of the Levenshtein distance calculated by the previous function, returns the percent similarity of two lines (by analogy with the PHP function similar_text).  We will test only the first function. <br><br>  Let's try to find all the words with a Levenshtein distance of 1 character: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> city_id, title_ru <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> _cities <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> levenshtein(<span class="hljs-string"><span class="hljs-string">"BNNBKF"</span></span>,metaphone)=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  The search for similar metaphones for the fourth title (which has the shortest metaphone) gave the same results as when searching with LIKE with the search pattern "_", but took ~ 66 minutes, so it was decided not to continue testing the other words. <br><br><h4>  Torres function </h4><br>  <a href="https://github.com/ifsnop/damlev">The third option</a> is the implementation of a <a href="">function written in C by Linus Torvalds</a> .  This function takes three parameters ‚Äî two strings for comparison, and the integer INT ‚Äî the upper bound, i.e.  the maximum number of characters that will be taken from each line for comparison. <br><br>  Set a universal upper limit for all metaphones from our test - 20 characters, and try to find all the words with a Damerau-Levenshtein distance of 1 character: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> city_id, title_ru <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> _cities <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> damlevlim(<span class="hljs-string"><span class="hljs-string">"BNNBKF"</span></span>,metaphone,<span class="hljs-number"><span class="hljs-number">20</span></span>)=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  Results: <br><table><tbody><tr><td>  Word number </td><td>  <i>t</i> for Torres f-ii, s </td><td>  Found </td></tr><tr><td>  one. </td><td>  11.24 </td><td>  one </td></tr><tr><td>  2 </td><td>  9.25 </td><td>  one </td></tr><tr><td>  3 </td><td>  9.19 </td><td>  173 </td></tr><tr><td>  four. </td><td>  8.3 </td><td>  86 </td></tr><tr><td>  five. </td><td>  11.57 </td><td>  0 </td></tr></tbody></table>  The Torres function showed excellent results in comparison with the Flattery query, and especially in comparison with the Rast function.  The second plus is that Torres used the advanced Damerau-Levenshtein algorithm, where a transposition operation was added to the insert, delete, and replace operations.  Compare the results of the Torres function and the Flattery query: <br><table><tbody><tr><td>  Word number </td><td>  <i>t</i> for request Flattery, sec </td><td>  <i>t</i> for Torres f-ii, s </td><td>  Request Flattery, found words </td><td>  F. Torres, found words </td></tr><tr><td>  one. </td><td>  24.2 </td><td>  <b>11.24</b> </td><td>  one </td><td>  one </td></tr><tr><td>  2 </td><td>  14.1 </td><td>  <b>9.25</b> </td><td>  one </td><td>  one </td></tr><tr><td>  3 </td><td>  11.9 </td><td>  <b>9.19</b> </td><td>  188 </td><td>  173 </td></tr><tr><td>  four. </td><td>  11.9 </td><td>  <b>8.3</b> </td><td>  70 </td><td>  86 </td></tr><tr><td>  five. </td><td>  18.1 </td><td>  <b>11.57</b> </td><td>  0 </td><td>  0 </td></tr></tbody></table>  The difference in the number of rows returned can be explained by the difference in the algorithms used (Levenshtein and Damerau-Levenshtein for the Flattery query and the Torres function, respectively).  In 5 cases out of 5 the winner was the Torres function, so it will be used in the final implementation in PHP, where the result is refined by the function similar_text. <br><br><h2>  PHP implementation </h2><br>  The most accurate refining results can be obtained if the search query is not transliterated, i.e.  after receiving similar words they will be compared with the original.  During the experiments, it was found that the function similar_text returns different results for words in Cyrillic and Latin at the same Levenshtein distance.  Therefore, for the purity of calculations, <a href="https://php.net/manual/en/function.levenshtein.php">the utf8_to_extended_ascii function</a> , originally proposed by <a href="https://php.net/manual/en/function.levenshtein.php">luciole75w</a> , will be additionally used to solve the same problem when using the PHP levenshtein function. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//   $input = ''; //     similar_text  UTF-8 function utf8_to_extended_ascii($str, &amp;$map){ $matches = array(); if (!preg_match_all('/[\xC0-\xF7][\x80-\xBF]+/', $str, $matches)) return $str; foreach ($matches[0] as $mbc) if (!isset($map[$mbc])) $map[$mbc] = chr(128 + count($map)); return strtr($str, $map); } //     function damlev($input){ //     $input_m = mtphn($input); //    $conn = mysqli_connect('localhost','root','','test') or die(mysqli_error($conn)); //      - 0  1 $q = mysqli_query($conn, 'SELECT city_id, title_ru FROM _cities WHERE damlevlim("'.$input_m.'",metaphone,20)&lt;2'); //   mysqli_close($conn); //     while ($row = mysqli_fetch_assoc($q)) $damlev_result[] = [ $row['city_id'], $row['title_ru'] ]; //    1 -  if (count($damlev_result) &gt; 1){ //   foreach ($damlev_result as $v) //     //         similar_text( utf8_to_extended_ascii($input,$charMap), utf8_to_extended_ascii($v[1],$charMap), $similar_text_result[] ); //    $max_similarity = max($similar_text_result); //       $most_similar_strings = array_flip( array_keys($similar_text_result, $max_similarity) ); //      return array_intersect_key($damlev_result,$most_similar_strings); } //      1 - //       1  else return $damlev_result; } echo '&lt;p&gt; : '.$input; $output = damlev($input); //      if (count($output) &gt; 0){ //     - foreach ($output as $v) //       $results_list[] = '&lt;a href="search.php?id='.$v[0].'"&gt;' .$v[1].'&lt;/a&gt;'; echo '&lt;p&gt;,  : '.implode(', ',$results_list); } else //    - ,    echo'&lt;p&gt;  ,  .';</span></span></code> </pre><br>  The result might look like this: <br><table><tbody><tr><td>  We are looking for name: Cherentseva <br>  Perhaps you are looking for: <a href="https://example.com/search.php%3Fid%3D5086">Charentsavan</a> , <a href="https://example.com/search.php%3Fid%3D1068762">Cherentsovka</a> </td></tr></tbody></table><br><h2>  Results </h2><br>  The implementation of the Damerau-Levenshtein distance, written by Linus Torvalds in C and adapted by Diego Torres for MySQL as a user function, turned out to be the fastest.  In second place with a small time difference, there is a primitive imitation of Levenshtein distance in the form of a SQL query with a large number of LIKE operators, the author is Gordon Flattery.  In third place, the user function for MySQL from Jason Rast was far behind. <br><br>  In conclusion, I would like to add that using Levenshtein distance calculation in MySQL in production is necessary only in cases where the line to compare is short, and the table with the words to be compared with the line is small.  Otherwise, a possible solution in the case of a table with a large dictionary may be its division into several tables, for example, by the first letter, or by the length of a word or its metaphone. <br><br>  Most often, the field of application of fuzzy search algorithms in the web is searching for names and names using an existing dictionary, where there is a high probability that a user can make a typo or make a mistake of at least 1 character.  In any case, try to ensure that the options offered by your script do not become the object of screenshots: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/r6/38/wj/r638wj5ubscbpc8lvgegf9igqks.jpeg" alt="typo - member and guys"></div><br><br>  PS <a href="https://samjlevy.com/mysql-levenshtein/">Another article</a> with other MySQL user functions for calculating the Levenshtein distance. <br><br>  PPS In the comments <a href="https://habrahabr.ru/users/yourchief/" class="user_link">YourChief</a> suggests that for production it is much more efficient to use the <a href="https://en.wikipedia.org/wiki/Levenshtein_automaton">Levenshtein machine gun</a> . </div><p>Source: <a href="https://habr.com/ru/post/342434/">https://habr.com/ru/post/342434/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342424/index.html">Atmega328p + ENC28J60 = Bridge between UART and Ethernet</a></li>
<li><a href="../342426/index.html">How to create graphics for VR - Google recommendations</a></li>
<li><a href="../342428/index.html">1000 ++ way to run commands on a remote computer</a></li>
<li><a href="../342430/index.html">Interns</a></li>
<li><a href="../342432/index.html">Do I need the OPTIONS method in REST services?</a></li>
<li><a href="../342436/index.html">Manage complex IT infrastructure of an application from a web interface? Easy</a></li>
<li><a href="../342438/index.html">How was the October moscowcss. Video recordings from the meeting of moscowcss ‚Ññ5 from the office of Tutu.ru October 31, 2017</a></li>
<li><a href="../342440/index.html">Let's talk about Plesk with the Docker extension</a></li>
<li><a href="../342442/index.html">Independent data centers: fuel cells instead of electrical</a></li>
<li><a href="../342444/index.html">Operating ROCA's crypto-vulnerability may be easier than intended.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>