<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multi-threaded download in cURL for PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this topic, in my opinion, a convenient and functional implementation of multithreaded cURL download for PHP is presented. Perhaps it will be usefu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multi-threaded download in cURL for PHP</h1><div class="post__text post__text-html js-mediator-article">  In this topic, in my opinion, a convenient and functional implementation of multithreaded cURL download for PHP is presented.  Perhaps it will be useful to someone, and an invite will bring me;) <br><br>  I didn‚Äôt use downloading via cURL, even if only out of interest, only lazy.  Whether from the console, or by implementing the code in any PL.  Solutions blocking download one link lying on every corner of the network, for example on <a href="http://php.net/manual/en/function.curl-init.php">php.net</a> .  However, if we consider implementations in PHP, then this approach is sometimes not suitable due to the high time spent on auxiliary operations (dns lookup, request waiting and the like).  For downloading a large number of pages, the sequential version is not acceptable.  If you are satisfied, then you can not read further :) <br><a name="habracut"></a><br>  In Perl, for example, you can use <b>fork</b> () or threads ( <b>use threads</b> ) to parallelize single-threaded downloads.  This is not counting the rich possibilities of the libraries of this language.  I personally applied threads and lwp.  However, we are talking about PHP, and here with paralleling big problems due to the lack of this feature in principle.  <i>If anyone knows how to create threads, please let us know, but I haven‚Äôt found any worthy solutions yet.</i>  Yes, in cURL there are <b>curl_multi_ *</b> functions, but here examples of implementations on their basis did not suit me.  And, in the end, I decided to collect my bike. <br><br>  Initially, I refer to the simplest example from <a href="http://www.php.net/manual/en/function.curl-multi-init.php">off.</a>  <a href="http://www.php.net/manual/en/function.curl-multi-init.php">directory</a> .  Let me bring it here :) <br>  <font color="#000000"><font color="#0000BB">&lt;? php</font></font> <font color="#000000"><font color="#0000BB"><br></font></font>  <font color="#000000"><font color="#FF8000">// create both cURL resources</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">$ ch1</font> <font color="#007700">=</font> <font color="#0000BB">curl_init</font> <font color="#007700">();</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">$</font> <font color="#0000BB">ch2</font> <font color="#007700">=</font> <font color="#0000BB">curl_init</font> <font color="#007700">();</font></font> <font color="#000000"><font color="#007700">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </font></font>  <font color="#000000"><font color="#FF8000">// set URL and other appropriate options</font></font> <font color="#000000"><font color="#FF8000"><br><br></font></font>  <font color="#000000"><font color="#0000BB">curl_setopt</font> <font color="#007700">(</font> <font color="#0000BB">$ ch1</font> <font color="#007700">,</font> <font color="#0000BB">CURLOPT_URL</font> <font color="#007700">,</font> <font color="#DD0000">" <a href="http://www.example.com/">www.example.com</a> "</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_setopt</font> <font color="#007700">(</font> <font color="#0000BB">$ ch1</font> <font color="#007700">,</font> <font color="#0000BB">CURLOPT_HEADER</font> <font color="#007700">,</font> <font color="#0000BB">0</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_setopt</font> <font color="#007700">(</font> <font color="#0000BB">$</font> <font color="#0000BB">ch2</font> <font color="#007700">,</font> <font color="#0000BB">CURLOPT_URL</font> <font color="#007700">,</font> <font color="#DD0000">" <a href="http://www.php.net/">www.php.net</a> "</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#0000BB">curl_setopt</font> <font color="#007700">(</font> <font color="#0000BB">$</font> <font color="#0000BB">ch2</font> <font color="#007700">,</font> <font color="#0000BB">CURLOPT_HEADER</font> <font color="#007700">,</font> <font color="#0000BB">0</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#FF8000">// create the multiple cURL handle</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">$ mh</font> <font color="#007700">=</font> <font color="#0000BB">curl_multi_init</font> <font color="#007700">();</font></font> <font color="#000000"><font color="#007700"><br><br><br></font></font>  <font color="#000000"><font color="#FF8000">// add the two handles</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_multi_add_handle</font> <font color="#007700">(</font> <font color="#0000BB">$ mh</font> <font color="#007700">,</font> <font color="#0000BB">$ ch1</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_multi_add_handle</font> <font color="#007700">(</font> <font color="#0000BB">$ mh</font> <font color="#007700">,</font> <font color="#0000BB">$ ch2</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br><br></font></font>  <font color="#000000"><font color="#0000BB">$ running</font> <font color="#007700">=</font> <font color="#0000BB">null</font> <font color="#007700">;</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#FF8000">// execute the handles</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#007700">do {</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_multi_exec</font> <font color="#007700">(</font> <font color="#0000BB">$ mh</font> <font color="#007700">,</font> <font color="#0000BB">$ running</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">} while (</font> <font color="#0000BB">$ running</font> <font color="#007700">&gt;</font> <font color="#0000BB">0</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br><br></font></font>  <font color="#000000"><font color="#FF8000">// close the handles</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_multi_remove_handle</font> <font color="#007700">(</font> <font color="#0000BB">$ mh</font> <font color="#007700">,</font> <font color="#0000BB">$ ch1</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_multi_remove_handle</font> <font color="#007700">(</font> <font color="#0000BB">$ mh</font> <font color="#007700">,</font> <font color="#0000BB">$ ch2</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_multi_close</font> <font color="#007700">(</font> <font color="#0000BB">$ mh</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#0000BB">?&gt;</font></font> <font color="#000000"><br></font> <br>  The code differs from the single-threaded approach in a more complex organization of interaction between application code and the library: <br>  1) For each connection, its own <b>curl_init</b> () is executed and parameters are set via <b>curl_setopt</b> ().  Everything is standard here, without any explanations. <br>  2) For the general download control, a separate descriptor is created by the <b>curl_multi_init</b> () call, through which all further work will be done. <br>  3) To this handle by calling <b>curl_multi_add_handle</b> (), separate connections created at the beginning are <b>attached</b> . <br>  The preparatory stage is completed, now directly download: <br>  4) The library download is performed automatically, there is no explicit call as it was with <b>curl_exec</b> ().  It is replaced by a multiple call to <b>curl_multi_exec</b> ().  Despite the similar name, this function performs a slightly different role - it blocks information on the change in the number of active threads (well, and the errors that occurred).  The second parameter in the call is a reference to a numeric variable in which the number of currently active connections is stored.  The number has changed - it means some thread has completed work.  For this reason, the download cycle is implemented through <br>  <font color="#007700">do {</font> <font color="#007700"><br></font>  <font color="#0000BB">curl_multi_exec</font> <font color="#007700">(</font> <font color="#0000BB">$ mh</font> <font color="#007700">,</font> <font color="#0000BB">$ running</font> <font color="#007700">);</font> <font color="#007700"><br></font>  <font color="#007700">} while (</font> <font color="#0000BB">$ running</font> <font color="#007700">&gt;</font> <font color="#0000BB">0</font> <font color="#007700">);</font> <font color="#007700"><br></font> <br>  5) And finally, after downloading, the release of resources is performed.  Important!  Although the connections created by <b>curl_init</b> () and ‚Äúcling‚Äù to the main descriptor, it does not automatically close them, it must be done manually by calling <b>curl_multi_remove_handle</b> () in addition to <b>curl_close</b> (). <br><br>  Someone may have enough of such an implementation, and they may no longer read.  I will go further. <br>  What is wrong with this implementation?  A couple of the most obvious moments: <br><ol><li>  Hard limitation on downloading 2 links set right in the code </li><li>  received pages are output directly to STDOUT </li></ol><br>  This is only a part, the rest is discussed further. <br><br>  I correct these shortcomings and get, for example, the following: <br>  <font color="#000000"><font color="#0000BB">&lt;? php</font></font> <font color="#000000"><font color="#0000BB"><br></font></font>  <font color="#000000"><font color="#0000BB">$ urls</font> <font color="#007700">= array (</font> <font color="#DD0000">" <a href="http://www.example.com/">www.example.com</a> "</font> <font color="#007700">,</font> <font color="#DD0000">" <a href="http://www.php.net/">www.php.net</a> "</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#0000BB">$ mh</font> <font color="#007700">=</font> <font color="#0000BB">curl_multi_init</font> <font color="#007700">();</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#0000BB">$ chs</font> <font color="#007700">= array ();</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">foreach (</font> <font color="#0000BB">$ urls</font> <font color="#007700">as</font> <font color="#0000BB">$ url</font> <font color="#007700">) {</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">$ chs</font> <font color="#007700">[] = (</font> <font color="#0000BB">$ ch</font> <font color="#007700">=</font> <font color="#0000BB">curl_init</font> <font color="#007700">());</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_setopt</font> <font color="#007700">(</font> <font color="#0000BB">$ ch</font> <font color="#007700">,</font> <font color="#0000BB">CURLOPT_URL</font> <font color="#007700">,</font> <font color="#0000BB">$ url</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#0000BB">curl_setopt</font> <font color="#007700">(</font> <font color="#0000BB">$ ch</font> <font color="#007700">,</font> <font color="#0000BB">CURLOPT_HEADER</font> <font color="#007700">,</font> <font color="#0000BB">0</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#FF8000">// CURLOPT_RETURNTRANSFER - return the value as the result of a function, and not output to stdout</font></font> <font color="#000000"><font color="#FF8000"><br><br></font></font>  <font color="#000000"><font color="#0000BB">curl_setopt</font> <font color="#007700">(</font> <font color="#0000BB">$ ch</font> <font color="#007700">,</font> <font color="#0000BB">CURLOPT_RETURNTRANSFER</font> <font color="#007700">,</font> <font color="#0000BB">1</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_multi_add_handle</font> <font color="#007700">(</font> <font color="#0000BB">$ mh</font> <font color="#007700">,</font> <font color="#0000BB">$ ch</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">}</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#0000BB">$ prev_running</font> <font color="#007700">=</font> <font color="#0000BB">$ running</font> <font color="#007700">=</font> <font color="#0000BB">null</font> <font color="#007700">;</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">do {</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_multi_exec</font> <font color="#007700">(</font> <font color="#0000BB">$ mh</font> <font color="#007700">,</font> <font color="#0000BB">$ running</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">if (</font> <font color="#0000BB">$ running</font> <font color="#007700">! =</font> <font color="#0000BB">$ prev_running</font> <font color="#007700">) {</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#FF8000">// get information about current connections</font></font> <font color="#000000"><font color="#FF8000"><br><br></font></font>  <font color="#000000"><font color="#0000BB">$ info</font> <font color="#007700">=</font> <font color="#0000BB">curl_multi_info_read</font> <font color="#007700">(</font> <font color="#0000BB">$ mh</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">if (</font> <font color="#0000BB">is_array</font> <font color="#007700">(</font> <font color="#0000BB">$ info</font> <font color="#007700">) &amp;&amp; (</font> <font color="#0000BB">$ ch</font> <font color="#007700">=</font> <font color="#0000BB">$ info</font> <font color="#007700">[</font> <font color="#DD0000">'handle'</font> <font color="#007700">])) {</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#FF8000">// get the content of the loaded page</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">$ content</font> <font color="#007700">=</font> <font color="#0000BB">curl_multi_getcontent</font> <font color="#007700">(</font> <font color="#0000BB">$ ch</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#FF8000">// there is some kind of page text processing</font></font> <font color="#000000"><font color="#FF8000"><br><br></font></font>  <font color="#000000"><font color="#FF8000">// for now let it be as in the original - output to STDOUT</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#007700">echo</font> <font color="#0000BB">$ content</font> <font color="#007700">;</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">}</font></font> <font color="#000000"><font color="#007700"><br><br><br></font></font>  <font color="#000000"><font color="#FF8000">// update the cached number of current active connections</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">$ prev_running</font> <font color="#007700">=</font> <font color="#0000BB">$ running</font> <font color="#007700">;</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">}</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">} while (</font> <font color="#0000BB">$ running</font> <font color="#007700">&gt;</font> <font color="#0000BB">0</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br><br></font></font>  <font color="#000000"><font color="#007700">foreach (</font> <font color="#0000BB">$ chs</font> <font color="#007700">as</font> <font color="#0000BB">$ ch</font> <font color="#007700">) {</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_multi_remove_handle</font> <font color="#007700">(</font> <font color="#0000BB">$ mh</font> <font color="#007700">,</font> <font color="#0000BB">$ ch</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_close</font> <font color="#007700">(</font> <font color="#0000BB">$ ch</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">}</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_multi_close</font> <font color="#007700">(</font> <font color="#0000BB">$ mh</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">?&gt;</font></font> <font color="#000000"><br></font> <br><br>  Further, it is unlikely in most cases it will be enough just to display pages in STDOUT.  Moreover, this happens in an arbitrary order, depending on the order of the actual download (and not the task calls to <b>curl_multi_add_handle</b> ()).  Also, if a large volume is downloaded, then there is no point in waiting for all pages to be received - you can already begin to process them as they are received.  But the option of getting all in a crowd also should not be removed from the accounts. <br>  For this: 1) I implement everything in the form of a function, 2) I will enter a parameter specifying the callback function that will be called for each received file.  If callback is not specified, the option of getting all pages at once is applied.  Here is an example: <br>  <font color="#000000"><font color="#0000BB">&lt;? php</font></font> <font color="#000000"><font color="#0000BB"><br></font></font>  <font color="#000000"><font color="#FF8000">// example of the simplest callback.</font></font>  <font color="#000000"><font color="#FF8000">almost dummy-func.</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#007700">function</font> <font color="#0000BB">my_callback</font> <font color="#007700">(</font> <font color="#0000BB">$ url</font> <font color="#007700">,</font> <font color="#0000BB">$ content</font> <font color="#007700">,</font> <font color="#0000BB">$ curl_status</font> <font color="#007700">,</font> <font color="#0000BB">$ ch</font> <font color="#007700">) {</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">echo</font> <font color="#DD0000">"Download page [$ url]"</font> <font color="#007700">;</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">if (!</font> <font color="#0000BB">$ curl_status</font> <font color="#007700">) {</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">echo</font> <font color="#DD0000">"was successful.</font></font>  <font color="#000000"><font color="#DD0000">page text: \ n $ content \ n "</font> <font color="#007700">;</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">}</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">else {</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">echo</font> <font color="#DD0000">"run with error # $ curl_status:"</font> <font color="#007700">.</font></font>  <font color="#000000"><font color="#0000BB">curl_error</font> <font color="#007700">(</font> <font color="#0000BB">$ ch</font> <font color="#007700">).</font></font>  <font color="#000000"><font color="#DD0000">"\ n"</font> <font color="#007700">;</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">}</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">}</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">function</font> <font color="#0000BB">http_load</font> <font color="#007700">(</font> <font color="#0000BB">$ urls</font> <font color="#007700">,</font> <font color="#0000BB">$ callback</font> <font color="#007700">=</font> <font color="#0000BB">false</font> <font color="#007700">) {</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">$ mh</font> <font color="#007700">=</font> <font color="#0000BB">curl_multi_init</font> <font color="#007700">();</font></font> <font color="#000000"><font color="#007700"><br><br><br></font></font>  <font color="#000000"><font color="#0000BB">$ chs</font> <font color="#007700">= array ();</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">foreach (</font> <font color="#0000BB">$ urls</font> <font color="#007700">as</font> <font color="#0000BB">$ url</font> <font color="#007700">) {</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">$ chs</font> <font color="#007700">[] = (</font> <font color="#0000BB">$ ch</font> <font color="#007700">=</font> <font color="#0000BB">curl_init</font> <font color="#007700">());</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#0000BB">curl_setopt</font> <font color="#007700">(</font> <font color="#0000BB">$ ch</font> <font color="#007700">,</font> <font color="#0000BB">CURLOPT_URL</font> <font color="#007700">,</font> <font color="#0000BB">$ url</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_setopt</font> <font color="#007700">(</font> <font color="#0000BB">$ ch</font> <font color="#007700">,</font> <font color="#0000BB">CURLOPT_HEADER</font> <font color="#007700">,</font> <font color="#0000BB">0</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#FF8000">// CURLOPT_RETURNTRANSFER - return the value as the result of a function, and not output to stdout</font></font> <font color="#000000"><font color="#FF8000"><br><br></font></font>  <font color="#000000"><font color="#0000BB">curl_setopt</font> <font color="#007700">(</font> <font color="#0000BB">$ ch</font> <font color="#007700">,</font> <font color="#0000BB">CURLOPT_RETURNTRANSFER</font> <font color="#007700">,</font> <font color="#0000BB">1</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_multi_add_handle</font> <font color="#007700">(</font> <font color="#0000BB">$ mh</font> <font color="#007700">,</font> <font color="#0000BB">$ ch</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">}</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#FF8000">// if $ callback is set to false, then the function should not call $ callback, but issue pages as the result of the work</font></font> <font color="#000000"><font color="#FF8000"><br><br></font></font>  <font color="#000000"><font color="#007700">if (</font> <font color="#0000BB">$ callback</font> <font color="#007700">===</font> <font color="#0000BB">false</font> <font color="#007700">) {</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">$ results</font> <font color="#007700">= array ();</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">}</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#0000BB">$ prev_running</font> <font color="#007700">=</font> <font color="#0000BB">$ running</font> <font color="#007700">=</font> <font color="#0000BB">null</font> <font color="#007700">;</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">do {</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_multi_exec</font> <font color="#007700">(</font> <font color="#0000BB">$ mh</font> <font color="#007700">,</font> <font color="#0000BB">$ running</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">if (</font> <font color="#0000BB">$ running</font> <font color="#007700">! =</font> <font color="#0000BB">$ prev_running</font> <font color="#007700">) {</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#FF8000">// get information about current connections</font></font> <font color="#000000"><font color="#FF8000"><br><br></font></font>  <font color="#000000"><font color="#0000BB">$ info</font> <font color="#007700">=</font> <font color="#0000BB">curl_multi_info_read</font> <font color="#007700">(</font> <font color="#0000BB">$ ghandler</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">if (</font> <font color="#0000BB">is_array</font> <font color="#007700">(</font> <font color="#0000BB">$ info</font> <font color="#007700">) &amp;&amp; (</font> <font color="#0000BB">$ ch</font> <font color="#007700">=</font> <font color="#0000BB">$ info</font> <font color="#007700">[</font> <font color="#DD0000">'handle'</font> <font color="#007700">])) {</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#FF8000">// get the content of the loaded page</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">$ content</font> <font color="#007700">=</font> <font color="#0000BB">curl_multi_getcontent</font> <font color="#007700">(</font> <font color="#0000BB">$ ch</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#FF8000">// downloaded link</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">$ url</font> <font color="#007700">=</font> <font color="#0000BB">curl_getinfo</font> <font color="#007700">(</font> <font color="#0000BB">$ ch</font> <font color="#007700">,</font> <font color="#0000BB">CURLINFO_EFFECTIVE_URL</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br><br></font></font>  <font color="#000000"><font color="#007700">if (</font> <font color="#0000BB">$ callback</font> <font color="#007700">! ==</font> <font color="#0000BB">false</font> <font color="#007700">) {</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#FF8000">// call the callback handler</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">$ callback</font> <font color="#007700">(</font> <font color="#0000BB">$ url</font> <font color="#007700">,</font> <font color="#0000BB">$ content</font> <font color="#007700">,</font> <font color="#0000BB">$ info</font> <font color="#007700">[</font> <font color="#DD0000">'result'</font> <font color="#007700">],</font> <font color="#0000BB">$ ch</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">}</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">else {</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#FF8000">// add results to hash</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">$ results</font> <font color="#007700">[</font> <font color="#0000BB">$ url</font> <font color="#007700">] = array (</font> <font color="#DD0000">'content'</font> <font color="#007700">=&gt;</font> <font color="#0000BB">$ content</font> <font color="#007700">,</font> <font color="#DD0000">'status'</font> <font color="#007700">=&gt;</font> <font color="#0000BB">$ info</font> <font color="#007700">[</font> <font color="#DD0000">'result'</font> <font color="#007700">],</font> <font color="#DD0000">'status_text'</font> <font color="#007700">=&gt;</font> <font color="#0000BB">curl_error</font> <font color="#007700">(</font> <font color="#0000BB">$ ch</font> <font color="#007700">));</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">}</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">}</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#FF8000">// update the cached number of current active connections</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">$ prev_running</font> <font color="#007700">=</font> <font color="#0000BB">$ running</font> <font color="#007700">;</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">}</font></font> <font color="#000000"><font color="#007700"><br><br><br></font></font>  <font color="#000000"><font color="#007700">} while (</font> <font color="#0000BB">$ running</font> <font color="#007700">&gt;</font> <font color="#0000BB">0</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">foreach (</font> <font color="#0000BB">$ chs</font> <font color="#007700">as</font> <font color="#0000BB">$ ch</font> <font color="#007700">) {</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_multi_remove_handle</font> <font color="#007700">(</font> <font color="#0000BB">$ mh</font> <font color="#007700">,</font> <font color="#0000BB">$ ch</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#0000BB">curl_close</font> <font color="#007700">(</font> <font color="#0000BB">$ ch</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">}</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_multi_close</font> <font color="#007700">(</font> <font color="#0000BB">$ mh</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#FF8000">// results</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#007700">return (</font> <font color="#0000BB">$ callback</font> <font color="#007700">! ==</font> <font color="#0000BB">false</font> <font color="#007700">)?</font></font>  <font color="#000000"><font color="#0000BB">true</font> <font color="#007700">:</font> <font color="#0000BB">$ results</font> <font color="#007700">;</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">}</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#0000BB">$ urls</font> <font color="#007700">= array (</font> <font color="#DD0000">" <a href="http://www.example.com/">www.example.com</a> "</font> <font color="#007700">,</font> <font color="#DD0000">" <a href="http://www.php.net/">www.php.net</a> "</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#FF8000">// simple issue option</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">print_r</font> <font color="#007700">(</font> <font color="#0000BB">http_load</font> <font color="#007700">(</font> <font color="#0000BB">$ urls</font> <font color="#007700">));</font></font> <font color="#000000"><font color="#007700"><br><br><br></font></font>  <font color="#000000"><font color="#FF8000">// option with callback</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">var_export</font> <font color="#007700">(</font> <font color="#0000BB">http_load</font> <font color="#007700">(</font> <font color="#0000BB">$ urls</font> <font color="#007700">,</font> <font color="#0000BB">my_callback</font> <font color="#007700">));</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#0000BB">?&gt;</font></font> <font color="#000000"><br></font> <br>  Now it is much more interesting.  Important point: with callback, the 4th parameter is the connection descriptor $ ch, and when issuing results by a hash, it is just a string description of the error that occurred (well, or an empty string, if everything is fine).  Why?  Because curl_error () requires the transmission of a descriptor that is closed at the end of the function.  So in the callback it still exists and we can use it, but in the hash it can not give anything valuable.  Alternatively, string descriptions of error codes can be found <a href="http://curl.haxx.se/libcurl/c/libcurl-errors.html">here</a> . <br><br>  So go ahead.  I want to call a function not only for an array of links, but also to be able to download a single page to it.  To do this, add just one line: <br>  <font color="#000000"><font color="#0000BB">&lt;? php</font> <font color="#007700">function</font> <font color="#0000BB">http_load</font> <font color="#007700">(</font> <font color="#0000BB">$ urls</font> <font color="#007700">,</font> <font color="#0000BB">$ callback</font> <font color="#007700">=</font> <font color="#0000BB">false</font> <font color="#007700">) {</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">...</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#FF8000">// even if a single parameter is passed, I consider it as an element of the array</font></font> <font color="#000000"><font color="#FF8000"><br><br></font></font>  <font color="#000000"><font color="#FF8000">// is it an analogue: $ urls = is_array ($ urls)?</font></font>  <font color="#000000"><font color="#FF8000">$ urls: array ($ urls);</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">$ urls</font> <font color="#007700">= (array)</font> <font color="#0000BB">$ urls</font> <font color="#007700">;</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">....</font> <font color="#0000BB">?&gt;</font></font> <font color="#000000"><br></font> <br>  Now you can download links one by one: http_load ('google.com').  A sort of return to the origins. <br><br>  Then I needed to set a lot more transferred headers for the connections.  Specifying them one by one via curl_setopt () is not practical.  It is better to use the <a href="http://ru.php.net/manual/en/function.curl-setopt-array.php">curl_setopt_array</a> function.  Redoing and getting (part of the code): <br>  <font color="#000000"><font color="#0000BB">&lt;? php</font></font> <font color="#000000"><font color="#0000BB"><br></font></font>  <font color="#000000"><font color="#007700">{</font> <font color="#FF8000">// common to all connections headers</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">$ ext_headers</font> <font color="#007700">= array (</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#DD0000">'Expect:'</font> <font color="#007700">,</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#DD0000">'Accept: text / html, application / xhtml + xml, application / xml; q = 0.9'</font> <font color="#007700">,</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#DD0000">'Accept-Language: ru, en-us; q = 0.7, en; q = 0.7'</font> <font color="#007700">,</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#FF8000">// 'Accept-Encoding: gzip, deflate', // need to be unpacked later.</font></font>  <font color="#000000"><font color="#FF8000">well, bye it</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#DD0000">'Accept-Charset: utf-8, windows-1251; q = 0.7, *; q = 0.5'</font> <font color="#007700">,</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">$ curl_options</font> <font color="#007700">= array (</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#0000BB">CURLOPT_PORT</font> <font color="#007700">=&gt;</font> <font color="#0000BB">80</font> <font color="#007700">,</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">CURLOPT_RETURNTRANSFER</font> <font color="#007700">=&gt;</font> <font color="#0000BB">1</font> <font color="#007700">,</font> <font color="#FF8000">// return the value as the result of a function, and not output to stdout</font></font> <font color="#000000"><font color="#FF8000"><br><br></font></font>  <font color="#000000"><font color="#0000BB">CURLOPT_BINARYTRANSFER</font> <font color="#007700">=&gt;</font> <font color="#0000BB">1</font> <font color="#007700">,</font> <font color="#FF8000">// transfer to binary-safe</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">CURLOPT_CONNECTTIMEOUT</font> <font color="#007700">=&gt;</font> <font color="#0000BB">10</font> <font color="#007700">,</font> <font color="#FF8000">// connection timeout (lookup + connect)</font></font> <font color="#000000"><font color="#FF8000"><br><br></font></font>  <font color="#000000"><font color="#0000BB">CURLOPT_TIMEOUT</font> <font color="#007700">=&gt;</font> <font color="#0000BB">30</font> <font color="#007700">,</font> <font color="#FF8000">// timeout for receiving data</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">CURLOPT_USERAGENT</font> <font color="#007700">=&gt;</font> <font color="#DD0000">'Mozilla / 5.0 (X11; U; Linux x86_64; en-US; rv: 1.9.1.1) Gecko / 20090716 Ubuntu / 9.04 (jaunty) Shiretoko / 3.5.1'</font> <font color="#007700">,</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#0000BB">CURLOPT_VERBOSE</font> <font color="#007700">=&gt;</font> <font color="#0000BB">2</font> <font color="#007700">,</font> <font color="#FF8000">// level of information</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">CURLOPT_HEADER</font> <font color="#007700">=&gt;</font> <font color="#0000BB">0</font> <font color="#007700">,</font> <font color="#FF8000">// title does not work</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">CURLOPT_FOLLOWLOCATION</font> <font color="#007700">=&gt;</font> <font color="#0000BB">1</font> <font color="#007700">,</font> <font color="#FF8000">// follow redirects</font></font> <font color="#000000"><font color="#FF8000"><br><br></font></font>  <font color="#000000"><font color="#0000BB">CURLOPT_MAXREDIRS</font> <font color="#007700">=&gt;</font> <font color="#0000BB">7</font> <font color="#007700">,</font> <font color="#FF8000">// maximum number of redirects</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">CURLOPT_AUTOREFERER</font> <font color="#007700">=&gt;</font> <font color="#0000BB">1</font> <font color="#007700">,</font> <font color="#FF8000">// when redirecting, substitute in ‚ÄúReferer:‚Äù a value from ‚ÄúLocation:‚Äù</font></font> <font color="#000000"><font color="#FF8000"><br><br></font></font>  <font color="#000000"><font color="#FF8000">// CURLOPT_FRESH_CONNECT =&gt; 0, // use a new connection every time</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">CURLOPT_HTTPHEADER</font> <font color="#007700">=&gt;</font> <font color="#0000BB">$ ext_headers</font> <font color="#007700">,</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">}</font></font> <font color="#000000"><font color="#007700"><br><br><br></font></font>  <font color="#000000"><font color="#007700">function</font> <font color="#0000BB">http_load</font> <font color="#007700">(</font> <font color="#0000BB">$ urls</font> <font color="#007700">,</font> <font color="#0000BB">$ callback</font> <font color="#007700">=</font> <font color="#0000BB">false</font> <font color="#007700">) {</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">global</font> <font color="#0000BB">$ curl_options</font> <font color="#007700">;</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#0000BB">$ mh</font> <font color="#007700">=</font> <font color="#0000BB">curl_multi_init</font> <font color="#007700">();</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">if (</font> <font color="#0000BB">$ mh</font> <font color="#007700">===</font> <font color="#0000BB">false</font> <font color="#007700">) return</font> <font color="#0000BB">false</font> <font color="#007700">;</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#0000BB">$ urls</font> <font color="#007700">= (array)</font> <font color="#0000BB">$ urls</font> <font color="#007700">;</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#0000BB">$ chs</font> <font color="#007700">= array ();</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">foreach (</font> <font color="#0000BB">$ urls</font> <font color="#007700">as</font> <font color="#0000BB">$ url</font> <font color="#007700">) {</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">$ chs</font> <font color="#007700">[] = (</font> <font color="#0000BB">$ ch</font> <font color="#007700">=</font> <font color="#0000BB">curl_init</font> <font color="#007700">());</font></font> <font color="#000000"><font color="#007700"><br><br><br></font></font>  <font color="#000000"><font color="#0000BB">curl_setopt_array</font> <font color="#007700">(</font> <font color="#0000BB">$ ch</font> <font color="#007700">,</font> <font color="#0000BB">$ curl_options</font> <font color="#007700">);</font></font>  <font color="#000000"><font color="#FF8000">// I set the headers together</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_setopt</font> <font color="#007700">(</font> <font color="#0000BB">$ ch</font> <font color="#007700">,</font> <font color="#0000BB">CURLOPT_URL</font> <font color="#007700">,</font> <font color="#0000BB">$ url</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br><br></font></font>  <font color="#000000"><font color="#0000BB">curl_multi_add_handle</font> <font color="#007700">(</font> <font color="#0000BB">$ mh</font> <font color="#007700">,</font> <font color="#0000BB">$ ch</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">}</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">...</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">?&gt;</font></font> <font color="#000000"><br></font> <br><br>  Pretending to be firelis.  Headings I commented.  For a detailed explanation post <a href="http://ru.php.net/manual/en/function.curl-setopt.php">here</a> . <br>  And in the follow-up to these headers, a third parameter is added to the function: <br> <code>&lt;?php function http_load( $urls, $callback = false, $urls_params = array() ) {} ?&gt;</code> <br>  in which you can specify your own headers, which will be additionally committed to the connections when they are initialized.  Thus, you can successfully send POST requests with parameters or specify your referrals and the format of the transmitted data (for example, with compression). <br>  <font color="#000000"><font color="#0000BB">&lt;? php</font></font> <font color="#000000"><font color="#0000BB"><br></font></font>  <font color="#000000"><font color="#007700">...</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">foreach (</font> <font color="#0000BB">$ urls</font> <font color="#007700">as</font> <font color="#0000BB">$ ind</font> <font color="#007700">=&gt;</font> <font color="#0000BB">$ url</font> <font color="#007700">) {</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">$ chs</font> <font color="#007700">[] = (</font> <font color="#0000BB">$ ch</font> <font color="#007700">=</font> <font color="#0000BB">curl_init</font> <font color="#007700">());</font></font> <font color="#000000"><font color="#007700"><br><br><br></font></font>  <font color="#000000"><font color="#0000BB">curl_setopt_array</font> <font color="#007700">(</font> <font color="#0000BB">$ ch</font> <font color="#007700">,</font> <font color="#0000BB">$ curl_options</font> <font color="#007700">);</font></font>  <font color="#000000"><font color="#FF8000">// I set the headers together</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#0000BB">curl_setopt</font> <font color="#007700">(</font> <font color="#0000BB">$ ch</font> <font color="#007700">,</font> <font color="#0000BB">CURLOPT_URL</font> <font color="#007700">,</font> <font color="#0000BB">$ url</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br><br></font></font>  <font color="#000000"><font color="#FF8000">// are there additional parameters to initialize this connection?</font></font> <font color="#000000"><font color="#FF8000"><br></font></font>  <font color="#000000"><font color="#007700">if (isset (</font> <font color="#0000BB">$ urls_params</font> <font color="#007700">[</font> <font color="#0000BB">$ ind</font> <font color="#007700">]) &amp;&amp;</font> <font color="#0000BB">is_array</font> <font color="#007700">(</font> <font color="#0000BB">$ urls_params</font> <font color="#007700">[</font> <font color="#0000BB">$ ind</font> <font color="#007700">])) {</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#0000BB">curl_setopt_array</font> <font color="#007700">(</font> <font color="#0000BB">$ ch</font> <font color="#007700">,</font> <font color="#0000BB">$ urls_params</font> <font color="#007700">[</font> <font color="#0000BB">$ ind</font> <font color="#007700">]);</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">}</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#0000BB">curl_multi_add_handle</font> <font color="#007700">(</font> <font color="#0000BB">$ mh</font> <font color="#007700">,</font> <font color="#0000BB">$ ch</font> <font color="#007700">);</font></font> <font color="#000000"><font color="#007700"><br><br></font></font>  <font color="#000000"><font color="#007700">}</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#007700">...</font></font> <font color="#000000"><font color="#007700"><br></font></font>  <font color="#000000"><font color="#0000BB">?&gt;</font></font> <font color="#000000"><br></font> <br><br>  This is the function.  You could also write about working with cookies and POST requests, but if you get an invite.  And so he wrote a lot, how many have mastered?  ;) </div><p>Source: <a href="https://habr.com/ru/post/68175/">https://habr.com/ru/post/68175/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../68161/index.html">MyGrid Wireless Charger from Duracell</a></li>
<li><a href="../68162/index.html">Firefox as the default browser when developing web applications</a></li>
<li><a href="../68165/index.html">Bruteforce cookies, forgot?</a></li>
<li><a href="../68170/index.html">Website Screenshots & Thumbnails Extractor</a></li>
<li><a href="../68172/index.html">We collect Ultimate Collector's Millennium Falcon</a></li>
<li><a href="../68178/index.html">Food for the mind and not only</a></li>
<li><a href="../68179/index.html">Take the keyboard, take a sledgehammer ...</a></li>
<li><a href="../68180/index.html">IBM takes first molecular snapshot 3D</a></li>
<li><a href="../68182/index.html">Loader Theory</a></li>
<li><a href="../68184/index.html">Transferring ‚Äúbig‚Äù Outlook accounts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>