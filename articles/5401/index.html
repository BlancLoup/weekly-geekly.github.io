<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Access terrain.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is no secret that timely access to information, including that stored within the corporate network of a company, can be a decisive factor in the su...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Access terrain.</h1><div class="post__text post__text-html js-mediator-article">  It is no secret that timely access to information, including that stored within the corporate network of a company, can be a decisive factor in the success of employees.  It's about virtual private networks (VPN).  Sometimes giving access is not so easy. <br><br><a name="habracut"></a><br>  <b>Access is always and everywhere.</b> <br>  Providing remote access to the internal network of the company has to take into account many factors.  Among which there is also the impossibility of establishing a connection between the client and the server.  The reason may be simple - the system administrators of the guest network, from which an employee of the company is trying to connect, have closed all outgoing connections, and access to web resources through a "transparent" proxy server.  In such a situation, establishing a VPN connection using standard solutions like pptp and IPsec is simply not possible. <br><br>  The second big trouble for any mobile user may be the banal loss (or theft) of a laptop.  It‚Äôs not necessary to explain what the stranger‚Äôs access to the corporate network for the company will turn into if the finder finds a laptop to take advantage of this opportunity.  Of course, mobile users are obliged (usually at the corporate standard level) not to set the password storage option on the VPN access account, but ... have you seen many such users?  I have not had a chance.  Therefore, it is preferable to introduce additional security features for accessing the company's internal network.  In other words, use two-factor user authentication in software and hardware.  We are talking about eToken keys that can be used to securely store certificates for encrypting and decrypting data or authorizing different systems. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And the last (by the way, but not least) that I would like to mention - the possibility of obtaining access not only to files on the company's servers, but also to other resources.  For example, to the mail server (in many companies, the use of external connections via pop3, imap and smtp protocols is prohibited).  The problem may lie in the fact that the mail server is, for example, outside the company's local network.  Next, we consider a comprehensive solution to all the problems indicated. <br>  <b>How we will solve the problem.</b> <br>  We will use the following software and hardware: <br>  ‚Ä¢ OpenVPN, running under Linux, as a provider of secure private communication channel; <br>  ‚Ä¢ htc and hts programs for organizing http tunnel through a proxy server; <br>  ‚Ä¢ eToken PRO from Alladin. <br>  You can use the same keys of any other manufacturers, the key of this company was just at my fingertips. <br><br>  So, we consider each item separately. <br><br>  <b>OpenVPN.</b> <br>  The OpenVPN system [1] was chosen to implement the solution not by chance.  This software is very actively updated by developers.  OpenVPN allows you to implement almost any task on the organization of VPN channels. <br><br>  Among the advantages of the system: <br>  ‚Ä¢ support of almost all possible operating systems - Linux, Windows versions 2000 / XP and higher, OpenBSD, FreeBSD, NetBSD, Mac OS X, Solaris; <br>  ‚Ä¢ the ability to use all available OpenSSL encryption, authentication and certificate methods to protect your private channel; <br>  ‚Ä¢ The ability to create entire server farms with load balancing thousands of incoming VPN connections; <br>  ‚Ä¢ using a static key for encryption or a public key system; <br>  ‚Ä¢ the ability to create a secure connection type "bridge" (ethernet bridges); <br>  ‚Ä¢ the ability to use both udp and tcp for the VPN channel. <br><br>  And this is not a complete listing of the OpenVPN functionality.  The system is constantly being finalized, the number of opportunities increases. <br><br>  <b>Http tunnel using htc and hts.</b> <br>  These are small programs, one of which runs on the server, and the other, respectively, on the client.  They do not need special settings and run a simple command line.  Below we consider them in more detail. <br><br>  <b>eToken key.</b> <br>  For our purposes, any hardware key designed for secure storage of digital certificates is suitable.  eToken PRO is a secure device designed for strong authentication, secure storage of secret data, performing cryptographic calculations and working with asymmetric keys and digital certificates.  The USB key is architecturally implemented as a USB card reader with a smart card chip (chip) built into it.  The key is made in the form of a keychain and is directly connected to the USB port of the computer, and does not require any additional devices for its operation. <br><br>  There is a huge variety of similar hardware on the market and everyone can choose the most optimal device for their purposes.  A nice feature of the keys is that you do not have to use them to solve only one task.  The same key can allow authorization for Wi-Fi access to the network, for establishing a VPN connection and for encrypting data on a hard disk. <br><br>  You only need the key itself and a free utility to work with it. <br><br>  So, we proceed to the solution of the problem. <br><br>  <b>Installing OpenVPN server.</b> <br>  Let's use Gentoo Linux to install the OpenVPN system.  But before we proceed with the installation, make sure that the Linux kernel contains all the necessary modules.  To do this, go to our kernel configurator and pay attention to the entry relating to TUN / TAP drivers. <br><br><blockquote>  Device Drivers ---&gt; <br>  Network device support ---&gt; <br>  &lt;*&gt; Universal TUN / TAP device driver support </blockquote><br>  If support is installed, then everything is fine and you can continue.  If not, set the required value and recompile the kernel of your system. <br><br>  If you do not plan to use hardware keys for two-factor authentication in the future, the installation of the OpenVPN system itself is extremely simple and is done in one command. <br><br><blockquote>  # USE = 'ssl examples' emerge openvpn </blockquote><br><br>  With the current version of ebuild, the system will install OpenVPN version 2.0.6 for you. To use eToken you will have to go through the ports tree and force a newer version (currently 2.1_beta14). <br><br><blockquote>  # echo net-misc / openvpn &gt;&gt; /etc/portage/package.keywords <br>  # USE = "ssl example" emerge openvpn </blockquote><br><br>  In addition, you may need to install the necessary additional packages.  Therefore, at the time of installation, I recommend simply uncommenting the ACCEPT_KEYWORDS option of the desired architecture in your /etc/make.conf (in my case it is ‚Äú~ x86‚Äù), allowing the system to install everything you need. <br>  The SSL option is required to support OpenSSL, and examples installs examples of OpenVPN configuration files.  Otherwise, there will be no examples and the configuration files will have to be written, as they say, from scratch. <br><br>  <b>Creating server keys and clients.</b> <br>  After the system is compiled, it will be necessary (for convenience) to copy the sample configuration files into / etc / openvpn and copy the scripts there to generate keys and certificates. <br><br>  Both are in the / usr / share / openvpn directory.  The easy-rsa subdirectory contains scripts for all occasions, allowing you to create: <br><br>  root certificate (build-ca); <br>  server key and certificate (build-key-server); <br>  simple keys for clients (build-key); <br>  password-protected client keys (build-key-pass); <br>  PKCS keys for the ability we need to use eToken (build-key-pkcs12). <br><br>  Initially, we will create all the necessary certificates and keys for the server. <br><br><blockquote>  # cd / etc / openvpn / easy-rsa <br>  # source ./vars <br>  # ./clean-all <br>  # ./build-ca <br>  # ./build-key-pkcs12 - server server <br>  # ./build-dh <br>  # ./build-key-pkcs12 ‚Äì-pkcs12 client1 </blockquote><br><br>  The last command creates PKCS12 keys for the user.  Where client1 is an example of a username.  The team must be executed for each prospective client.  Please note that when creating a key, you can protect it with an additional password. <br><br>  <b>Configure OpenVPN.</b> <br>  The OpenVPN configuration file (called the default server.conf) is provided with very detailed comments and allows you to set up all the necessary settings without any problems practically without using any additional documentation. <br><br>  First, we will indicate to what address and on which port our server will work: <br><br>  local H.H.H.H <br>  port 443 <br><br>  The choice of port is not accidental, I will explain later when we configure the client and server parts of the http tunnel. <br><br>  The second thing to choose is tcp or udp, our VPN will work.  For this there is a corresponding option: <br><br>  proto tcp <br>  or <br>  proto udp <br><br>  Since we are going to make access via the proxy web server of the guest system possible, we will choose proto tcp. <br><br>  Next, select the type of network device to be used. <br><br>  dev tun0 - in the case of organizing a normal VPN, or <br>  dev tap0 - if you want to use a bridge connection. <br><br>  Using the second option, remember about the need for a sufficient pool of free network addresses on your local network, which will occasionally be handled by remote users when connecting via VPN. <br><br>  In the key description section we will write the full path to our key: <br><br>  pkcs12 /etc/openvpn/easy-rsa/keys/server.p12 <br>  dh /etc/openvpn/easy-rsa/keys/dh1024.pem <br><br>  Note that only one pkcs12 key or the ‚Äústandard‚Äù ca, cert and key can be used at the same time.  If overlapping options are set, the system will refuse to start. <br><br>  If you decide to use a regular VPN, specify the address space in which it will work and from which it will assign them to clients. <br>  server 192.168.4.0 255.255.255.0 <br><br>  If you are going to use a bridge connection, you will need another option (the server parameter must be commented out, since the server can only work in one quality at a time): <br><br>  server-bridge 192.168.1.73 255.255.255.0 192.168.1.61 192.168.1.63 <br><br>  Where: <br><br>  ‚Ä¢ the first and second parameters - the address and mask of the local network server card; <br>  ‚Ä¢ the third and fourth parameters - a pool of addresses for issuing to external clients. <br><br>  Option we missed <br><br>  ifconfig-pool-persist /etc/openvpn/ipp.txt <br><br>  contains the name of the file in which the correspondences of customers will be stored (by the names of their keys) and their internal addresses, which the OpenVPN system gives them. <br><br>  The following very important options indicate which address spaces will be available to clients and will automatically be added to the routing table when connected. <br><br>  push "route 192.168.1.0 255.255.255.0" <br>  push "route ... 255.255.255.255" <br><br>  The first option adds the ability to use our local network, and the second adds a single external address where our mail server is located, to which clients should also have access under any circumstances. <br><br>  Most of the options that follow are necessary to realize the possibilities beyond the scope of this material. <br><br>  Options <br>  push "dhcp-option DNS 192.168.1.1" <br>  client-to-client <br><br>  They indicate what DNS clients should use to convert names to ip addresses inside our local network, and whether to allow VPN clients to interact with each other.  This can be useful if there is a need for file sharing between two users. <br><br>  If for some reason you need to allow two independent VPN clients to use identical certificates at the same time - uncomment the duplicate-cn option. <br>  The last thing you should now pay attention to is the name of the file and the path to it, where the OpenVPN log file will be written, as well as the number of valid users of the system at the same time. <br><br>  Configure the LAN gateway. <br>  If your OpenVPN server is not the main gateway of the local network, you will need to add routing for the VPN subnet.  Since my network uses the Cisco 2621 as the main gateway, I added a route on it with the following command: <br>  ip route 192.168.4.0 255.255.255.0 192.168.1.73 <br><br>  where the first and second parameters are the address and mask of the virtual subnet, and the last is the address of the internal interface of the OpenVPN server.  (Do not forget about the need to enable interactive mode on cisco before entering a command, as well as recording changes in the device‚Äôs memory after adding a route.) <br><br>  Adding a route to the Linux gateway is done with the command: <br><br><blockquote>  # route add -net 192.168.4.0/24 gw 192.168.1.73 </blockquote><br><br>  where the first address is our virtual subnet, and the second is the address of the internal interface of the OpenVPN server. <br><br>  If you do not do the above steps, packets from the local network will not be able to find a ‚Äúway‚Äù to the VPN client. <br><br>  Providing access to an external resource for VPN clients. <br>  In order to allow VPN clients to get to our mail server, located in the outside world relative to our working network, we will use the services of iptables. <br><br>  Creating a rule, I did not specify the allowed connection ports for the simple reason that, on an external server, in addition to the mail service, there are other services running on non-standard ports, which are often closed in the guest systems for connection.  You can specify which ports will be available for connections to VPN clients. <br><br>  In addition, if the rules on your firewall are configured according to the principle ‚Äúprohibit everything you need to allow‚Äù, then do not forget to add permissions to forward packets from the tun0 interface. <br><br>  <b>We start the server</b> <br>  After all the necessary settings have been made, it's time to start the OpenVPN server and see what will be in the log file.  Note that by default, the /etc/init.d/openvpn script is configured to work with the /etc/openvpn/openvpn.conf configuration file, and not the server.conf that goes in the examples at all.  So, we start our server: <br><br><blockquote>  # /etc/init.d/openvpn start </blockquote><br><br>  In the log file you should see something like: <br><br><blockquote>  Sat Jun 17 22:54:42 2006 us = 295361 OpenVPN 2.0.6 i686-pc-linux-gnu [SSL] [LZO] [EPOLL] built on Jun 15 2006 <br>  Sat Jun 17 22:54:42 2006 us = 569088 Diffie-Hellman initialized with 1024 bit key <br>  Sat Jun 17 22:54:42 2006 us = 798824 TLS-Auth MTU parms [L: 1544 D: 140 EF: 40 EB: 0 ET: 0 EL: 0] <br>  Sat Jun 17 22:54:42 2006 us = 799346 TUN / TAP device tun0 opened <br>  Sat Jun 17 22:54:42 2006 us = 799376 TUN / TAP TX queue length set to 100 <br>  Sat Jun 17 22:54:42 2006 us = 799409 / sbin / ifconfig tun0 192.168.4.1 pointopoint 192.168.4.2 mtu 1500 <br>  Sat Jun 17 22:54:42 2006 us = 824310 / sbin / route add-net 192.168.4.0 netmask 255.255.255.0 gw 192.168.4.2 <br>  Sat Jun 17 22:54:42 2006 us = 827291 Data Channel MTU parms [L: 1544 D: 1450 EF: 44 EB: 135 ET: 0 EL: 0 AF: 3/1] <br>  Sat Jun 17 22:54:42 2006 us = 912828 GID set to nobody <br>  Sat Jun 17 22:54:42 2006 us = 912911 UID set to nobody <br>  Sat Jun 17 22:54:42 2006 us = 912950 Listening for incoming TCP connection on H.H.H.H: 443 <br>  Sat Jun 17 22:54:42 2006 us = 913000 Socket Buffers: R = [87380-&gt; 131072] S = [16384-&gt; 131072] <br>  Sat Jun 17 22:54:42 2006 us = 913028 TCPv4_SERVER link local (bound): XXXX: 443 <br>  Sat Jun 17 22:54:42 2006 us = 913042 TCPv4_SERVER link remote: [undef] <br>  Sat Jun 17 22:54:42 2006 us = 913072 MULTI: multi_init called, r = 256 v = 256 <br>  Sat Jun 17 22:54:42 2006 us = 913136 IFCONFIG POOL: base = 192.168.4.4 size = 62 <br>  Sat Jun 17 22:54:42 2006 us = 913348 MULTI: TCP INIT maxclients = 10 maxevents = 14 <br>  Sat Jun 17 22:54:42 2006 us = 913382 Initialization Sequence Completed </blockquote><br><br>  It is also worth paying attention to the output of the ifconfig command, which should show that a new network device tun0 has appeared in the system. <br><br><blockquote>  tun0 Link encap: UNSPEC HWaddr 00-00-00-00-00-00-00-00-00-00-00-00-00 <br>  inet addr: 192.168.4.1 PtP: 192.168.4.2 Mask: 255.255.255.255 <br>  UP POINTOPOINT RUNNING NOARP MULTICAST MTU: 1500 Metric: 1 <br>  RX packets: 0 errors: 0 dropped: 0 overruns: 0 frame: 0 <br>  TX packets: 0 errors: 0 dropped: 0 overruns: 0 carrier: 0 <br>  collisions: 0 txqueuelen: 100 <br>  RX bytes: 0 (0.0 b) TX bytes: 0 (0.0 b) <br></blockquote><br>  If the device does not appear, then carefully review the log and configuration file. <br><br>  Do not forget to add the OpenVPN service to the list of automatically launched ones, as well as save the new iptables rules in your list. <br><br>  <b>Installing and configuring an OpenVPN client.</b> <br>  Now that the first half of our system setup is complete, it's time to start installing the client part of the program.  I will review clients for Linux and Windows systems. <br><br>  <b>Installing a Linux VPN client.</b> <br>  A client on a Linux system may be required here in which case.  Suppose you have a remote intranet server whose resources you would like to use on your local network.  Nothing is easier!  We simply connect these systems to our VPN and use.  This can be especially useful if the server is local to some remote network. <br><br>  As in the case of setting up a server system, make sure that the necessary modules are available in the kernel. <br><br>  In Linux, the client part from the server part differs only in the configuration file.  This file is much shorter and also has very detailed comments. <br><br>  The first parameters indicate to the OpenVPN service that it is a client on the system.  What network device and protocol are used, as well as what server IP address and what port is used by the OpenVPN service. <br><br>  client <br>  dev tun <br>  proto tcp <br>  remote openvpn.domain.ru 443 <br><br>  Copy the keys and certificates required for the work to the client system: <br><br>  ca.crt, client1.crt, client1.key <br><br>  and specify them in the configuration file <br><br>  ca /etc/openvpn/easy-rsa/keys/ca.crt <br>  cert /etc/openvpn/easy-rsa/keys/client1.crt <br>  key /etc/openvpn/easy-rsa/keys/client1.key <br><br>  This completes our client system setup and we can use it.  You can run it by simply renaming the file from client.conf in openvpn.conf or by using the command line. <br><br><blockquote>  # openvpn /etc/openvpn/client.conf </blockquote><br><br>  The first time I would recommend to run from the command line.  Since the protocol will be displayed directly on the screen, this will help ensure that everything is normal. <br>  If everything went well, then at the end of the output you will see something like: <br><br><blockquote>  Sun Jun 18 20:32:02 2006 TUN / TAP device tun0 opened <br>  Sun Jun 18 20:32:02 2006 / sbin / ifconfig tun0 192.168.4.30 pointopoint 192.168.4.29 mtu 1500 <br>  Sun Jun 18 20:32:02 2006 / sbin / route add-net 192.168.1.0 netmask 255.255.255.0 gw 192.168.4.29 <br>  Sun Jun 18 20:32:02 2006 / sbin / route add -net ... netmask 255.255.255.255 gw 192.168.4.29 <br>  Sun Jun 18 20:32:02 2006 / sbin / route add-net 192.168.4.0 netmask 255.255.255.0 gw 192.168.4.29 <br>  Sun Jun 18 20:32:02 2006 GID set to nobody <br>  Sun Jun 18 20:32:02 2006 UID set to nobody <br>  Sun Jun 18 20:32:02 2006 Initialization Sequence Completed </blockquote><br><br>  Do not forget to add the service to the list of automatically launched. <br><br>  <b>Install Windows OpenVPN client.</b> <br>  OpenVPN in Windows system has a graphical user interface (GUI), which greatly simplifies working with it for users.  At address [2] you can always find the latest version of the program.  I recommend at least the first time to download the full installation package (at the moment it is openvpn-2.0.7-gui-1.0.3-install.exe), as it contains drivers for TUN / TAP interfaces.  Later, you can download updates only the program itself.  (Application only by reference.) <br><br>  Among the advantages and convenience of the client are: <br><br>  ‚Ä¢ display of the program icon in the system tray; <br>  ‚Ä¢ minimizing the connection log window immediately after establishing a session; <br>  ‚Ä¢ view the connection log (call from the context menu); <br>  ‚Ä¢ change configuration file settings (call from the context menu); <br>  ‚Ä¢ using OpenVPN as a system service; <br>  ‚Ä¢ a window for entering a password for a digital certificate for server authentication; <br>  ‚Ä¢ additional protection of the program for the operation of the connection (your own password); <br>  ‚Ä¢ password change to a secure key (including PKCS # 12); <br>  ‚Ä¢ configuration of the proxy server used; <br>  ‚Ä¢ use of proxy server settings from Internet Explorer options; <br>  ‚Ä¢ script execution (bat) before and / or after connecting to the OpenVPN server; <br>  ‚Ä¢ indication of the connection status in the system tray. <br><br>  Remember that in versions of Windows younger than 2000 / XP the OpenVPN client will not work.  But I think in our time, such versions of operating rooms are rare. <br><br>  After installing the client, the OpenVPN item appears in the program menu with a rich selection: <br>  ‚Ä¢ link to the folder with configuration files; <br>  ‚Ä¢ on the folder with examples; <br>  ‚Ä¢ static key generation program; <br>  ‚Ä¢ a program for creating a certificate and forming a request for its signature; <br>  ‚Ä¢ OpenVPN client program itself; <br>  ‚Ä¢ links to various documentation. <br><br>  The configuration file, like all previous ones, is provided with comments and is no different from the file for the Linux client system.  The difference is only in the file extension.  If it was ‚Äúconf‚Äù in Linux, then opvpn in Windows.  Therefore, it makes no sense to describe the settings, you can safely borrow them from the previous example. <br><br>  Let's stop only on the description of keys and certificates.  As you remember, we decided to use two-factor authentication for mobile users.  To do this, copy to the client system from the server only two files - ca.crt and the certificate corresponding (by name) to this client with the extension p12. <br><br>  Now we need to import our certificate into the Alladin eToken in our location.  To do this, download (if not already installed) software for working with the RTE key using the link [3]. <br><br>  After installing the received program, we will have an eToken folder in the program menu with a single link to the program eToken properties. <br><br><img src="https://habrastorage.org/getpro/habr/olpictures/695/32b/ba9/69532bba91d7ed9e9c4b55058be3447f.jpg" width="450" height="349" alt="Figure 1. The program for working with the key." hspace="10" vspace="10"><br>  Figure 1. The program for working with the key. <br><br>  Having inserted our key into the USB port, we will see it in the program window.  Turning to the key icon and selecting "Advanced", enter the PIN code to access the key.  This will allow you to import a certificate. <br><br><img src="https://habrastorage.org/getpro/habr/olpictures/61e/779/7a2/61e7797a2d3104b3bd9c61697ae03aef.jpg" width="450" height="346" alt="Figure 2. Certificate import window." hspace="10" vspace="10"><br>  Figure 2. Certificate import window. <br><br>  If a password was used when creating a certificate on the server (immediately after signing it), here we will be asked to enter it again and you can dispose of this certificate. <br><br>  Now we can make sure that the certificate is known to our Windows system, and at the same time find out how the OpenVPN client will contact it.  To do this, proceed to the "Control Panel", where we select "Internet Options".  In this window, we are only interested in the "Content" tab and the "Certificates" button. <br><br><img src="https://habrastorage.org/getpro/habr/olpictures/6d0/3e6/6a9/6d03e66a9825283796b0fb6bfbf5f464.jpg" width="450" height="416" alt="Figure 3. List of available certificates." hspace="10" vspace="10"><br>  Figure 3. List of available certificates. <br><br>  Select our certificate and click on ‚ÄúView‚Äù, in the opened window select ‚ÄúComposition‚Äù.  Here we are interested in the field "Fingerprint", which we copy to the clipboard. <br><br>  The received information about the certificate thumbprint will be entered into the configuration file of our OpenVPN client. <br><br>  cryptoapicert "THUMB: ed 38 ac 63 ..." <br>  ca ca.crt <br><br>  Now that the initial configuration of the client is complete, it's time to try it out in action.  To do this, it is enough to select a connection in the context menu.  If the eToken access was completed correctly, a PIN code entry window will appear for access to the key. <br><br><img src="https://habrastorage.org/getpro/habr/olpictures/a8a/fda/f9d/a8afdaf9d6347a84194433e86e5657b5.jpg" width="450" height="292" hspace="10" vspace="10"><img src="https://habrastorage.org/getpro/habr/olpictures/242/1d4/8aa/2421d48aaa0114d6ad157a6c3c17908b.jpg" width="450" height="290" hspace="10" vspace="10"><br>  Figure 4, 5. Luck and defeat. <br><br>  In case of error, make sure that the key is inserted into the USB port, and the previous steps are correct. <br><br>  After confirming access to the key, the log of connection to the server will be displayed in the same input window.  The window will automatically hide as soon as the connection is successfully established.  You can always return to the log by selecting ‚ÄúView log‚Äù in the context menu.  It remains to try to ping to any of the computers on the remote LAN and make sure that everything is working correctly. <br><br>  Now that everything is set up and working, it‚Äôs time to return to the situation when access to the outside world is limited by web resources.  And to provide it, transparent proxying is used. <br><br>  <b>hts and htc.</b> <br>  As mentioned above, these two programs are easy to install and even easier to use.  The essence of their work is that the first one ‚Äúlistens‚Äù to the port indicated by it (in our case it will be 80, access to which is everywhere) and in the case of initiating the connection, creates the http tunnel. <br><br>  The second one, on the contrary, listens to port 443 and initiates a connection through port 80 with the remote htc. <br><br>  Installing htc on Gentoo Linux on the server is done with a simple command: <br><br><blockquote>  # emerge httptunnel </blockquote><br><br>  For Windows systems, you can download httptunnel from the project page by reference [4]. <br><br>  Using httptunnel is very, very simple.  To run on the server, the command is enough: <br><br><blockquote>  # hts --forward-port H.H.H.H: 443 80 </blockquote><br><br>  Where is the ip address and port on which the tunnel should be established in case of access to port 80. The command is executed without any output on the screen.  The results of its implementation can be found only in the system log.  (For example, / var / log / messages.) <br><br><blockquote>  Jun 18 01:47:28 admin hts [27389]: hts (httptunnel) 3.3 started with arguments: <br>  Jun 18 01:47:28 admin hts [27389]: me = hts <br>  Jun 18 01:47:28 admin hts [27389]: device = (null) <br>  Jun 18 01:47:28 admin hts [27389]: port = 80 <br>  Jun 18 01:47:28 admin hts [27389]: forward_port = 443 <br>  Jun 18 01:47:28 admin hts [27389]: forward_host = H.H.H.H <br>  Jun 18 01:47:28 admin hts [27389]: content_length = 102400 <br>  Jun 18 01:47:28 admin hts [27389]: strict_content_length = 0 <br>  Jun 18 01:47:28 admin hts [27389]: use_std = 0 <br>  Jun 18 01:47:28 admin hts [27389]: debug_level = 0 <br>  Jun 18 01:47:28 admin hts [27389]: pid_filename = (null) </blockquote><br><br>  The netstat team confirms to us that hts really works and "listens" to port 80. <br><br><blockquote>  # netstat -napl | grep 80 <br>  tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN 27389 / hts </blockquote><br><br>  It remains to make the windows script (bat) for launching the client part of the httptunnel.  We will create this file in the c: \ program files \ openvpn \ config folder and name it hts_pre.bat.  And in the file itself add only one line: <br><br><blockquote>  C: \ httptunnel \ htc.exe -F 443 -P 192.168.1.1:37128 XXXX: 80 </blockquote><br><br>  Where: <br>  -F 443 indicates the port that is the final recipient. <br>  -P 192.168.1.180128 ip address and port of the proxy server of the guest system. <br>  XXXX: 80 is the actual address of the server side httptunnel. <br><br>  The choice of location and file name for the script is not accidental.  As mentioned above, OpenVPN for Windows is able to execute bat files before connection, immediately after connection and after session termination.  For this it is enough to fulfill only two conditions.  Create a bat file in the OpenVPN configuration file directory and name the file as follows: <br><br>  ‚Ä¢ Name the file xxx_pre.bat to run the script just before the connection. <br>  ‚Ä¢ Call xxx_up.bat to execute immediately after the connection is established. <br>  ‚Ä¢ Call xxx_down.bat for the session terminating script. <br><br>  We are interested in the first type of script.  By the way, after executing the command from our bat file, the system will not close the window and it will have to be done manually.  This will not stop our tunnel, but it will save you from having an open window on your desktop.  I suppose there is a tool to avoid this ‚Äúalways open‚Äù window, but I didn‚Äôt find it right away (maybe because I‚Äôm not good at writing scripts for Windows).  If you know the way, so much the better. <br><br>  As you noticed, to establish the tunnel, we needed to know the ip address and port on which the proxy server of the guest system is running.  This information, of course, is not written in large print upon entering the building, but nevertheless (usually) is easily recognized by the system administrator.  Cases when the sysadmin refused to report the proxy settings to me (perhaps for now) are not known. <br><br>  Now our system is fully configured and ready to work in almost any conditions.  A sort of the most secure all-terrain vehicle on the Internet! <br><br>  <b>How mobile can be OpenVPN.</b> <br>     ,  OpenVPN         .    (    ),   ,    ¬´¬ª .       ().     (,     Windows Mobile  Symbian)      VPN ,       . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However, due to the use of the OpenVPN TUN / TAP system, simple connection methods will not work. And to find them for devices of this class, alas, is not yet possible. Surveys on the Internet gave only information about the ongoing development of the implementation of the use of OpenVPN. (Now a link to information about this is already on the main page of the project. [5]) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However, there is one exception. If you own a Sharp Zaurus PDA and have long been planning to install Linux on it, then you can use your VPN. Drivers and the necessary software for this can be found on the Internet. It is used by many people. The necessary files can be taken, for example, here [6]. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Final word</font></font></b> <br>     OpenVPN ,       Windows            ,         .     eToken,   ,    . ,         .      eToken    . ,  ,           Windows  (  ). <br><br>  References: <br> [1] ‚Äî <a href="http://openvpn.net/">openvpn.net</a> <br> [2] ‚Äî <a href="http://openvpn.se/files/install_packages/">openvpn.se/files/install_packages</a> <br> [3] ‚Äî <a href="http://www.alladin.ru/support/download/category177">www.alladin.ru/support/download/category177</a> <br> [4] ‚Äî <a href="">userpages.umbc.edu/~tmoses1/hypertunnelNT.zip</a> <br> [5] ‚Äî <a href="http://www.ziggurat29.com/OVPNPPCAlpha/OVPNPPCAlpha.htm">www.ziggurat29.com/OVPNPPCAlpha/OVPNPPCAlpha.htm</a> <br> [6] ‚Äî <a href="http://users.skynet.be/isa-et-pep/pep/zaurus/feed/">users.skynet.be/isa-et-pep/pep/zaurus/feed</a> <br><br>  (c) <a href="http://habrahabr.ru/users/akeeper/" class="user_link">akeeper</a> Korshunov Alexey. <br>     <a href="http://www.samag.ru/">¬´ .</a> </div><p>Source: <a href="https://habr.com/ru/post/5401/">https://habr.com/ru/post/5401/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../54004/index.html">fasTun is a free service for compressing traffic</a></li>
<li><a href="../54005/index.html">Big Music will give up, but not before 2011</a></li>
<li><a href="../54006/index.html">On the use of links to run functions.</a></li>
<li><a href="../54008/index.html">Fool Solitaire!</a></li>
<li><a href="../54009/index.html">Google will show you where we are - everything else</a></li>
<li><a href="../54011/index.html">Seagate doubles Serial ATA 3</a></li>
<li><a href="../54012/index.html">Search API for PHP (Flash, Java and others)</a></li>
<li><a href="../54015/index.html">"Keys" on 8 GB</a></li>
<li><a href="../54016/index.html">Installing SP1 on .NET Framework 3.5</a></li>
<li><a href="../54017/index.html">Homegrown Javascript frameworks - evil</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>