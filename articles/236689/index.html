<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic optimization of algorithms using fast exponentiation of matrices</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Suppose we want to calculate the ten millionth Fibonacci number in a Python program. A function that uses the trivial algorithm on my computer will pe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic optimization of algorithms using fast exponentiation of matrices</h1><div class="post__text post__text-html js-mediator-article">  Suppose we want to calculate the ten millionth <a href="https://ru.wikipedia.org/wiki/%25D0%25A7%25D0%25B8%25D1%2581%25D0%25BB%25D0%25B0_%25D0%25A4%25D0%25B8%25D0%25B1%25D0%25BE%25D0%25BD%25D0%25B0%25D1%2587%25D1%2587%25D0%25B8">Fibonacci number</a> in a Python program.  A function that uses the trivial algorithm on my computer will perform calculations for more than 25 minutes.  But if you apply a special optimizing decorator to the function, the function will calculate the answer in just 18 seconds ( <i>85 times faster</i> ): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/335/726/a40/335726a40fa94f4dacc23b3ae1816b7d.png"></div><br>  The fact is that before executing the program, the Python interpreter compiles all its parts into a special bytecode.  Using the method described by habrip SkidanovAlex, this decorator analyzes the resulting byte-code of the function and tries to optimize the algorithm used there.  Further you will see that this optimization can accelerate the program not as many times as it needs, but asymptotically.  So, the greater the number of iterations in a cycle, the more times the optimized function will accelerate compared to the original. <br><br>  This article will tell you about when and how the decorator manages to do such optimizations.  You can also download and test the <i>cpmoptimize</i> library containing this decorator. <br><a name="habracut"></a><br><h3>  Theory </h3><br>  Two years ago, <a href="https://habrahabr.ru/users/skidanovalex/" class="user_link">SkidanovAlex</a> published an interesting article describing a limited language interpreter that supports the following operations: <br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#       x = y x = 1 #          x += y x += 2 x -= y x -= 3 #     x *= 4 #       loop 100000 ... end</span></span></code> </pre> <br>  The values ‚Äã‚Äãof variables in the language must be numbers, their size is not limited ( <a href="https://ru.wikipedia.org/wiki/%25D0%2594%25D0%25BB%25D0%25B8%25D0%25BD%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25B0%25D1%2580%25D0%25B8%25D1%2584%25D0%25BC%25D0%25B5%25D1%2582%25D0%25B8%25D0%25BA%25D0%25B0">long arithmetic is</a> supported).  In fact, variables are stored as integers in Python, which switches to long arithmetic mode if the number goes beyond the bounds of a hardware supported four or eight-byte type. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Consider the case when long arithmetic is not used.  Then the execution time of the operations will not depend on the values ‚Äã‚Äãof the variables, which means that in a cycle all iterations will be executed in the same time.  If to execute such code "in the forehead", as in usual interpreters, the cycle will be executed in time. <img src="https://habrastorage.org/files/cb8/b51/c44/cb8b51c4455f429cb1c8780f093d6474.png">  where <i>n</i> is the number of iterations.  In other words, if the code for <i>n</i> iterations runs in time <i>t</i> , then the code for <img src="https://habrastorage.org/files/9fa/c09/665/9fac09665bc8458a9e36601413d1c852.png">  iterations will work for time <img src="https://habrastorage.org/files/306/d33/cf6/306d33cf6f2c48379f7e891cf500deb3.png">  (see <a href="http://en.wikipedia.org/wiki/Time_complexity">computational complexity</a> ). <br><br>  The interpreter from the <a href="http://habrahabr.ru/post/148901/">original article</a> represents each variable operation supported by the language in the form of a definite matrix by which the vector with the initial values ‚Äã‚Äãof the variables is multiplied.  As a result of multiplication, we get a vector with new values ‚Äã‚Äãof variables: <br><br><img src="https://habrastorage.org/files/3b6/e12/ec6/3b6e12ec6c4b4ed083dca38f5c3d6b0f.png"><br><br>  Thus, to perform a sequence of operations, one must multiply the vector in turn by the matrix corresponding to the next operation.  Another way is by using associativity, the matrices can be multiplied first, and then the original vector can be multiplied by the resulting product: <br><br><img src="https://habrastorage.org/files/902/b25/58b/902b2558b1da4984925bc84dd028de65.png"><br><br>  To perform a cycle, we must calculate the number <i>n</i> , the number of iterations in the cycle, and also the matrix <i>B</i> , the sequential product of matrices corresponding to the operations from the cycle body.  Then you need to multiply the source vector by the matrix <i>B</i> <i>n</i> times.  Another way is to first raise the matrix <i>B</i> to the power <i>n</i> , and then multiply the vector with variables by the result: <br><br><img src="https://habrastorage.org/files/1e8/dae/5bc/1e8dae5bcc874648abb3686adbc3274d.png"><br><br>  If we use the <a href="http://e-maxx.ru/algo/binary_pow">binary exponentiation</a> algorithm <a href="http://e-maxx.ru/algo/binary_pow">at</a> that, the cycle can be performed in much less time. <img src="https://habrastorage.org/files/7ac/7f0/c52/7ac7f0c524f4424cb8e8ad8d199c6057.png">  .  So, if the code for <i>n</i> iterations works in time <i>t</i> , then the code for <img src="https://habrastorage.org/files/9fa/c09/665/9fac09665bc8458a9e36601413d1c852.png">  iterations will work for time <img src="https://habrastorage.org/files/9e9/503/215/9e950321525a4c60a7ba20e9ebc590f7.png">  (only two times slower, not <i>n</i> times slower, as in the previous case). <br><br>  As a result, as was written above, the greater the number of iterations in the cycle <i>n</i> , the more times the optimized function is accelerated.  Therefore, the effect of optimization will be especially noticeable for large <i>n</i> . <br><br>  If long arithmetic is still used, the time estimates above may be incorrect.  For example, when calculating the <i>nth</i> Fibonacci number, the values ‚Äã‚Äãof variables from iteration to iteration become more and more, and operations with them are slowed down.  The asymptotic estimate of the program operation time in such a case is more difficult to do (it is necessary to take into account the length of numbers in variables at each iteration and the methods used to multiply the numbers) and here it will not be given.  However, after applying this optimization method, the asymptotics improves even in this case.  This is clearly seen on the chart: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/785/fbe/249/785fbe249f084eda977b853ceb8981a9.png"></div><br><h3>  Idea </h3><br>  If tens of years ago a programmer would need to multiply a variable in a program by 4, he would not use the multiplication operation, but its faster equivalent - a bit left shift by 2. Now the compilers can do such optimizations themselves.  In the struggle to reduce development time, languages ‚Äã‚Äãwith a high level of abstraction, new convenient technologies and libraries have appeared.  When writing programs, more and more of their time is spent by developers on explaining to the computer what a program should do (multiply the number by 4), and not <i>how</i> to do it effectively (use a bit shift).  Thus, the task of creating efficient code is partially transferred to compilers and interpreters. <br><br>  Now compilers are able to replace various operations with more efficient ones, predict the values ‚Äã‚Äãof expressions, delete or swap parts of the code.  But compilers do not yet replace the computational <i>algorithm</i> written by man with the asymptotically more efficient one. <br><br>  The implementation of the described method, presented in the original article, is problematic to use in real programs, since for this you will have to rewrite part of the code into a special language, and to interact with this code you will have to run a third-party script with an interpreter.  However, the author of the article suggests using his work in practice in optimizing compilers.  I tried to implement this method to optimize Python programs in a form that is really suitable for use in real projects. <br><br>  If you use the library written by me, to apply the optimization, it will be enough to add one line before the function that needs to be accelerated using a special decorator.  This decorator independently optimizes the cycles, if possible, and under no circumstances ‚Äúbreaks‚Äù the program. <br><br><h3>  Examples of using </h3><br>  Consider a series of tasks in which our decorator can be useful. <br><br><h4>  Example number 1.  Long cycles </h4><br>  Suppose we have a certain sequence corresponding to the rule shown in the diagram, and we need to calculate its <i>nth</i> term: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/fee/a52/e53/feea52e536614dcb939656db4b230b70.png"></div><br>  In this case, it is intuitively clear how the next member of the sequence appears, however, it takes time to come up with and prove the corresponding mathematical formula.  Nevertheless, we can write a trivial algorithm describing our rule and suggest the computer to figure out how to quickly calculate the answer to our problem: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cpmoptimize <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cpmoptimize, xrange @cpmoptimize() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function">:</span></span> step1 = <span class="hljs-number"><span class="hljs-number">1</span></span> step2 = <span class="hljs-number"><span class="hljs-number">1</span></span> res = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(n): res += step2 step2 += step1 step1 += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res</code> </pre><br>  Interestingly, if you run this function for <img src="https://habrastorage.org/files/f98/b6e/192/f98b6e1925614bcf8ac02384beb73858.png">  , inside it will run a loop with <img src="https://habrastorage.org/files/8e7/a78/0ab/8e7a780ab22341d395aef9274df89a98.png">  iterations.  Without optimization, such a function would not work for any conceivable period of time, but with the decorator it is performed for less than a second, while returning the correct result. <br><br><h4>  Example number 2.  Fibonacci numbers </h4><br>  To quickly calculate the <i>nth</i> Fibonacci number, there is a fast, but non-trivial <a href="http://e-maxx.ru/algo/fibonacci_numbers">algorithm</a> based on the same idea of ‚Äã‚Äãraising matrices to a power.  An experienced developer can implement it in a few minutes.  If the code where such calculations are made does not need to work quickly (for example, if you need to calculate the Fibonacci number with a number less than 10 thousand once), to save your working time, the developer will most likely decide to save efforts and write the solution ‚Äúin forehead". <br><br>  If the program still has to work quickly, or you have to make an effort and write a complex algorithm, or you can use the automatic optimization method, applying our decorator to the function.  If <i>n</i> is large enough, in both cases the program performance will be almost the same, but in the second case the developer will spend less than his working time. <br><br>  You can compare the working times of the described methods below on tables and graphs for small and for large <i>n</i> . <br><br>  To be fair, it should be noted that to calculate the Fibonacci numbers there is another algorithm known as <a href="http://nayuki.eigenstate.org/page/fast-fibonacci-algorithms">fast doubling</a> .  He somewhat wins the previous algorithms in time, since it eliminates unnecessary additions and multiplications of numbers.  The computation time through this algorithm is also presented in the graphs for comparison. <br><br><div class="spoiler">  <b class="spoiler_title">Charts</b> <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/files/d89/9e5/1ba/d899e51ba9874828a8b58f82f11cf1fa.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a68/ca6/4bf/a68ca64bf3554967bdf581b3554d4516.png"></div><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Time measurement results</b> <div class="spoiler_text"><pre> <code class="hljs ruby">Function <span class="hljs-string"><span class="hljs-string">"fib"</span></span>: (*) Testcase <span class="hljs-string"><span class="hljs-string">"big"</span></span>: +--------+----------+--------------+--------------+--------------+-------+ <span class="hljs-params"><span class="hljs-params">| arg |</span></span> naive, s <span class="hljs-params"><span class="hljs-params">| cpm, s |</span></span> matrices, s <span class="hljs-params"><span class="hljs-params">| fast dbl, s |</span></span> match <span class="hljs-params"><span class="hljs-params">| +--------+----------+--------------+--------------+--------------+-------+ |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-params"><span class="hljs-params">| 0.00 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-params"><span class="hljs-params">| 0.00 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-params"><span class="hljs-params">| True |</span></span> <span class="hljs-params"><span class="hljs-params">| 20000 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-params"><span class="hljs-params">| 0.00 (2.5x) |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span> (<span class="hljs-number"><span class="hljs-number">3.0</span></span>x) <span class="hljs-params"><span class="hljs-params">| 0.00 (5.1x) |</span></span> True <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">40000</span></span> <span class="hljs-params"><span class="hljs-params">| 0.03 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">01</span></span> (<span class="hljs-number"><span class="hljs-number">5.7</span></span>x) <span class="hljs-params"><span class="hljs-params">| 0.00 (1.8x) |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span> (<span class="hljs-number"><span class="hljs-number">4.8</span></span>x) <span class="hljs-params"><span class="hljs-params">| True |</span></span> <span class="hljs-params"><span class="hljs-params">| 60000 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-params"><span class="hljs-params">| 0.01 (7.9x) |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">01</span></span> (<span class="hljs-number"><span class="hljs-number">1.4</span></span>x) <span class="hljs-params"><span class="hljs-params">| 0.00 (4.8x) |</span></span> True <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">80000</span></span> <span class="hljs-params"><span class="hljs-params">| 0.11 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">01</span></span> (<span class="hljs-number"><span class="hljs-number">9.4</span></span>x) <span class="hljs-params"><span class="hljs-params">| 0.01 (1.3x) |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span> (<span class="hljs-number"><span class="hljs-number">4.6</span></span>x) <span class="hljs-params"><span class="hljs-params">| True |</span></span> <span class="hljs-params"><span class="hljs-params">| 100000 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-params"><span class="hljs-params">| 0.01 (11.6x) |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">01</span></span> (<span class="hljs-number"><span class="hljs-number">1.1</span></span>x) <span class="hljs-params"><span class="hljs-params">| 0.00 (4.5x) |</span></span> True <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">120000</span></span> <span class="hljs-params"><span class="hljs-params">| 0.23 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">02</span></span> (<span class="hljs-number"><span class="hljs-number">11.8</span></span>x) <span class="hljs-params"><span class="hljs-params">| 0.02 (1.2x) |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span> (<span class="hljs-number"><span class="hljs-number">4.7</span></span>x) <span class="hljs-params"><span class="hljs-params">| True |</span></span> <span class="hljs-params"><span class="hljs-params">| 140000 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-params"><span class="hljs-params">| 0.02 (14.7x) |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">02</span></span> (<span class="hljs-number"><span class="hljs-number">1.1</span></span>x) <span class="hljs-params"><span class="hljs-params">| 0.00 (4.1x) |</span></span> True <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">160000</span></span> <span class="hljs-params"><span class="hljs-params">| 0.40 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">03</span></span> (<span class="hljs-number"><span class="hljs-number">13.1</span></span>x) <span class="hljs-params"><span class="hljs-params">| 0.03 (1.2x) |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">01</span></span> (<span class="hljs-number"><span class="hljs-number">4.6</span></span>x) <span class="hljs-params"><span class="hljs-params">| True |</span></span> <span class="hljs-params"><span class="hljs-params">| 180000 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">51</span></span> <span class="hljs-params"><span class="hljs-params">| 0.03 (14.7x) |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">03</span></span> (<span class="hljs-number"><span class="hljs-number">1.1</span></span>x) <span class="hljs-params"><span class="hljs-params">| 0.01 (4.4x) |</span></span> True <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">200000</span></span> <span class="hljs-params"><span class="hljs-params">| 0.62 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">04</span></span> (<span class="hljs-number"><span class="hljs-number">16.6</span></span>x) <span class="hljs-params"><span class="hljs-params">| 0.03 (1.1x) |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">01</span></span> (<span class="hljs-number"><span class="hljs-number">4.4</span></span>x) <span class="hljs-params"><span class="hljs-params">| True |</span></span> <span class="hljs-params"><span class="hljs-params">| 220000 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">75</span></span> <span class="hljs-params"><span class="hljs-params">| 0.05 (16.1x) |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">04</span></span> (<span class="hljs-number"><span class="hljs-number">1.1</span></span>x) <span class="hljs-params"><span class="hljs-params">| 0.01 (4.9x) |</span></span> True <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">240000</span></span> <span class="hljs-params"><span class="hljs-params">| 0.89 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">05</span></span> (<span class="hljs-number"><span class="hljs-number">17.1</span></span>x) <span class="hljs-params"><span class="hljs-params">| 0.05 (1.0x) |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">01</span></span> (<span class="hljs-number"><span class="hljs-number">4.7</span></span>x) <span class="hljs-params"><span class="hljs-params">| True |</span></span> <span class="hljs-params"><span class="hljs-params">| 260000 |</span></span> <span class="hljs-number"><span class="hljs-number">1.04</span></span> <span class="hljs-params"><span class="hljs-params">| 0.06 (18.1x) |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">06</span></span> (<span class="hljs-number"><span class="hljs-number">1.0</span></span>x) <span class="hljs-params"><span class="hljs-params">| 0.01 (4.5x) |</span></span> True <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">280000</span></span> <span class="hljs-params"><span class="hljs-params">| 1.20 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">06</span></span> (<span class="hljs-number"><span class="hljs-number">20.2</span></span>x) <span class="hljs-params"><span class="hljs-params">| 0.06 (1.0x) |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">01</span></span> (<span class="hljs-number"><span class="hljs-number">4.2</span></span>x) <span class="hljs-params"><span class="hljs-params">| True |</span></span> <span class="hljs-params"><span class="hljs-params">| 300000 |</span></span> <span class="hljs-number"><span class="hljs-number">1.38</span></span> <span class="hljs-params"><span class="hljs-params">| 0.07 (19.4x) |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">07</span></span> (<span class="hljs-number"><span class="hljs-number">1.1</span></span>x) <span class="hljs-params"><span class="hljs-params">| 0.02 (4.4x) |</span></span> True <span class="hljs-params"><span class="hljs-params">| +--------+----------+--------------+--------------+--------------+-------+</span></span></code> </pre><br></div></div><br>  In practice, we can meet with a more complex situation if the sequence of numbers instead of the well-known recurrent formula: <br><img src="https://habrastorage.org/files/065/f5e/7c1/065f5e7c17e246cf9e2e5b6cfc150ec4.png"><br><br>  It is given by a somewhat complicated formula, for example, this: <br><img src="https://habrastorage.org/files/b80/179/c6d/b80179c6d7634c379dabf745265eba89.png"><br><br>  In this case, we will not be able to find the implementation of the above algorithms on the Internet, and it will take significant time to manually come up with an algorithm to raise matrices to a power.  Nevertheless, we can write a solution "in the forehead" and apply a decorator, then the computer will come up with a fast algorithm for us: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cpmoptimize <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cpmoptimize @cpmoptimize() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function">:</span></span> prev3 = <span class="hljs-number"><span class="hljs-number">0</span></span> prev2 = <span class="hljs-number"><span class="hljs-number">1</span></span> prev1 = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">3</span></span>, n + <span class="hljs-number"><span class="hljs-number">3</span></span>): cur = <span class="hljs-number"><span class="hljs-number">7</span></span> * (<span class="hljs-number"><span class="hljs-number">2</span></span> * prev1 + <span class="hljs-number"><span class="hljs-number">3</span></span> * prev2) + <span class="hljs-number"><span class="hljs-number">4</span></span> * prev3 + <span class="hljs-number"><span class="hljs-number">5</span></span> * i + <span class="hljs-number"><span class="hljs-number">6</span></span> prev3, prev2, prev1 = prev2, prev1, cur <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prev3</code> </pre><br><h4>  Example number 3.  Sum of a geometric progression </h4><br>  Suppose we need to calculate the sum of the <i>count</i> members of the geometric progression, for which the first member <i>start</i> and the denominator of <i>coeff are given</i> .  In this task, the decorator is again able to optimize our trivial solution: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cpmoptimize <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cpmoptimize @cpmoptimize() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">geom_sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(start, coeff, count)</span></span></span><span class="hljs-function">:</span></span> res = <span class="hljs-number"><span class="hljs-number">0</span></span> elem = start <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(count): res += elem elem *= coeff <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Schedule</b> <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/files/253/702/6b9/2537026b9b744e168c1746e2b84e7039.png"></div><br></div></div><br><h4>  Example number 4.  Exponentiation </h4><br>  Suppose we need to raise the number <i>a</i> to a nonnegative integer power <i>n</i> .  In such a task, the decorator will actually replace the trivial solution with the <a href="http://e-maxx.ru/algo/binary_pow">binary exponentiation</a> algorithm: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cpmoptimize <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cpmoptimize @cpmoptimize() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">power</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, n)</span></span></span><span class="hljs-function">:</span></span> res = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(n): res *= a <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Schedule</b> <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/files/c2d/5d4/282/c2d5d428275b420fb24fc6f40dc581d3.png"></div><br></div></div><br><h3>  Download links </h3><br>  You can install the library using <a href="https://pip.readthedocs.org/en/latest/">pip</a> : <br><pre> <code class="bash hljs">sudo pip install cpmoptimize</code> </pre> <br>  The source code for the library with examples is available on <a href="http://goo.gl/cMi97F">github</a> under a free MIT license. <br><br>  <b>UPD.</b>  The package is <a href="https://pypi.python.org/pypi/cpmoptimize">published</a> in the Python Package Index. <br><br>  Examples of the use of optimization are in the " <i>tests /</i> " folder.  Each example consists of a function representing the solution "in the forehead", its optimized version, as well as functions representing the well-known complex, but quick solutions of this problem.  These functions are placed in scripts that run them on different groups of tests, measure the time of their work and build the corresponding tables.  If the <a href="http://matplotlib.org/">matplotlib</a> library is <a href="http://matplotlib.org/">installed</a> , the scripts will also build graphs of the dependence of the running time of the functions on the input data (regular or logarithmic) and save them in the " <i>tests / plots /</i> " folder. <br><br><h3>  Library Description </h3><br>  When creating the library, I used the fact that the byte-code of the program that the Python interpreter creates can be analyzed and modified at the execution stage without interfering with the interpreter, which gives wide possibilities for language extension (see, for example, <a href="http://habrahabr.ru/post/140356/">the goto implementation</a> ).  The advantages of the described method usually manifest themselves when using long arithmetic, which is also built into Python. <br><br>  For these reasons, the implementation of the described optimization in Python has become a more interesting task for me, although, of course, its use in C ++ compilers would allow creating even faster programs.  In addition, the decoder-optimized Python code, as a rule, overtakes the head-on code in C ++ due to better asymptotics. <br><br>  When modifying the bytecode, I used the <a href="">byteplay</a> module, which provides a convenient interface for disassembling and assembling bytecode.  Unfortunately, the module has not yet been ported to Python 3, so I implemented the entire project in Python 2.7. <br><br>  The name of the <i><strong>cpmoptimize</strong></i> library is an abbreviation of the words <i>" <b>c</b> ompute and <b>optimize</b> "</i> .  The size of the article does not allow to describe in detail the process of analysis and modification of the byte-code, however, I will try to describe in detail what features this library provides and on what principles its work is based. <br><br><h4>  Own xrange </h4><br>  cpmoptimize.  <strong>xrange</strong> ( <i>stop</i> ) <br>  cpmoptimize.  <strong>xrange</strong> ( <i>start</i> , <i>stop</i> [, <i>step</i> ]) <br><br>  The built-in type <i>xrange</i> in Python 2 for optimization does not support long integers of type <i>long</i> as arguments: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>xrange(<span class="hljs-number"><span class="hljs-number">10</span></span> ** <span class="hljs-number"><span class="hljs-number">1000</span></span>) Traceback (most recent call last): File <span class="hljs-string"><span class="hljs-string">"&lt;stdin&gt;"</span></span>, line <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;module&gt; OverflowError: Python int too large to convert to C long</code> </pre><br>  Since when using our library cycles with the number of operations of the order <img src="https://habrastorage.org/files/8e7/a78/0ab/8e7a780ab22341d395aef9274df89a98.png">  can be executed in less than a second, and become a routine in the program, the library provides its own <i>xrange</i> implementation in pure Python (inside the library it is called <i>CPMRange</i> ).  It supports all the capabilities of the usual <i>xrange</i> and, in addition, the arguments of the type <i>long</i> .  Such code will not lead to errors and quickly calculate the correct result: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cpmoptimize <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cpmoptimize, xrange @cpmoptimize() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> res = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">10</span></span> ** <span class="hljs-number"><span class="hljs-number">1000</span></span>): res += <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> f()</code> </pre><br>  However, if in your case the number of iterations in the cycles is small, you can continue to use the built-in <i>xrange</i> with the decorator. <br><br><h4>  Cpmoptimize function </h4><br>  cpmoptimize.  <strong>cpmoptimize</strong> ( <i>strict</i> = False, <i>iters_limit</i> = 5000, <i>types</i> = (int, long), <i>opt_min_rows</i> = True, <i>opt_clear_stack</i> = True) <br><br><h5>  Decorator application </h5><br>  The <i>cpmoptimize</i> function takes the parameters of the optimization performed and returns a decorator that takes these parameters into account, which we need to apply to the function being optimized.  This can be done using a special syntax (with the ‚Äúdog‚Äù symbol) or without it: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cpmoptimize <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cpmoptimize @cpmoptimize() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#   def naive_g(n): #   smart_g = cpmoptimize()(naive_g)</span></span></code> </pre><br>  Before making changes to the bytecode, the original function is copied.  Thus, in the above code, the functions <i>f</i> and <i>smart_g</i> will eventually be optimized, but <i>naive_g will</i> not. <br><br><h5>  Search for loops </h5><br>  The decorator searches the byte-code of the function for standard loops, while loops <i>while</i> <i>for</i> loops and <i>for</i> loops inside the generator and list expressions are ignored.  Nested loops are not yet supported (only the innermost loop is optimized).  Properly processed <i>for-else constructions</i> . <br><br><h5>  Valid Types </h5><br>  The decorator cannot optimize the cycle, regardless of what types of variables are used in it.  The fact is that, for example, Python allows you to define a type that, with each multiplication, writes a string to a file.  As a result of applying the optimization, the number of multiplications made in the function could change.  Because of this, the number of lines in the file would be different and optimization would break the program. <br><br>  In addition, during matrix operations, variables are added and multiplied implicitly, so the types of variables can be ‚Äúmixed‚Äù.  If one of the constants or variables would be of type <i>float</i> , those variables that would have to be of type <i>int</i> after executing the code could also get a type of <i>float</i> (since the addition of <i>int</i> and <i>float</i> returns a <i>float</i> ).  This behavior can cause errors in the program and is also unacceptable. <br><br>  To avoid unwanted side effects, the decorator optimizes the cycle only if all the constants and variables used in it have a <i>valid</i> type.  Initially, the valid types are <i>int</i> and <i>long</i> , as well as the types inherited from them.  If one of the constants or variables is of the <i>long</i> type, those variables that would have had the <i>int</i> type after the execution of the code can also get the <i>long</i> type.  However, since <i>int</i> and <i>long</i> in Python are fairly interchangeable, this should not lead to errors. <br><br>  In case you want to change the set of valid types (for example, to add <i>float</i> support), you must pass a tuple of the required types in the <i><strong>types</strong></i> parameter.  Types included in this tuple or inherited from the types included in this tuple will be considered valid.  In fact, checking that a <i>value</i> has a valid type will be done using the expression <i>isinstance (value, types)</i> . <br><br><h5>  Cycle optimization conditions </h5><br>  Each cycle found should satisfy a number of conditions.  Some of them are checked already when applying the decorator: <br><ol><li>  The body of the loop should consist only of assignment instructions, unary and binary operations, which can be put together into complex expressions.  It cannot contain conditions, calls to other functions, <i>return</i> or <i>yield statements</i> , etc. </li><li>  Predictability condition may be required from the operands: at each iteration of the loop, their value should be the same, and it should not depend on the results of any calculations at the previous iteration.  Wherein: <br><ul><li>  All operands of addition and subtraction, as well as the operand of a unary minus can be unpredictable. </li><li>  At least one multiplication operand must be predictable (similar to the fact that in the original interpreter only multiplication by a constant was supported). </li><li>  All operands of exponentiation, division, and taking of the remainder and bitwise operations must be predictable. </li></ul></li><li>  All constants used in the loop must have a valid type. </li></ol><br>  If these conditions are met, a ‚Äútrap‚Äù is set before the cycle, which checks another part of the conditions, and the original byte-code of the cycle is not deleted.  Since Python uses dynamic typing, the following conditions can be checked only immediately before the loop starts: <br><ol><li>  The object through which the loop is run must be of the standard type <i>xrange</i> or its equivalent from the given library <i>cpmoptimize.xrange</i> .  However, the slow <i>range</i> function that returns a list is not supported. </li><li>  The values ‚Äã‚Äãof all variables used in the loop are of a valid type. </li></ol><br>  If the ‚Äútrap‚Äù concluded that the optimization is acceptable, the necessary matrices will be calculated, and then the values ‚Äã‚Äãof the variables used will change to new ones.  If optimization cannot be performed, the original bytecode of the loop will be launched. <br><br><h5>  Expressions and removal of code per cycle </h5><br>  Although the described method does not support exponentiation and ‚Äúbitwise AND‚Äù operations, the following code will be optimized: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@cpmoptimize() def f(n, k): res = 0 for i in xrange(n): m = 3 res += ((k ** m) &amp; 676) + i return res</span></span></code> </pre><br>  When analyzing the byte-code, the decorator will conclude that the values ‚Äã‚Äãof the variables <i>k</i> and <i>m</i> in the expression <i>(k ** m) &amp; 676</i> do not depend on which iteration of the cycle they are used, and therefore the value of the whole expression does not change.  It is not necessary to calculate it at each iteration; it is enough to calculate this value once.  Therefore, the corresponding instructions of the byte-code can be taken out and executed them immediately before the start of the cycle, substituting the ready-made value in the cycle.  The code will be as if converted to the following: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@cpmoptimize() def f(n, k): res = 0 m = 3 _const1 = (k ** m) &amp; 676 for i in xrange(n): res += _const1 + i return res</span></span></code> </pre><br>  This technique is known as the <i>removal of the invariant code loop</i> ( <strong><i>loop-invariant code motion</i></strong> ).<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note that the offset values ‚Äã‚Äãare calculated each time the function is started, since they can depend on changing global variables or function parameters (like </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_const1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the example depends on the parameter </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">The resulting code is now easy to optimize using matrices. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is at this stage that the predictability of the values ‚Äã‚Äãdescribed above is performed. </font><font style="vertical-align: inherit;">For example, if one of the ‚Äúbitwise AND‚Äù operands were unpredictable, this operation could no longer be taken out of the loop and optimization could not be applied. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The decorator also partially supports multiple assignments. </font><font style="vertical-align: inherit;">If there are few elements in them, Python creates a byte code supported by the decorator without using tuples:</font></font><br><pre> <code class="python hljs">a, b = b, a + b</code> </pre><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Threshold iters_limit </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the graphs above, you may have noticed that with a small number of iterations, the optimized cycle may work slower than usual, since in this case it still takes some time to construct the matrices and check the types. In cases where it is necessary for the function to work as quickly as possible and with a small number of iterations, you can explicitly set the threshold by the </font></font><i><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iters_limit</font></font></strong></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parameter </font><font style="vertical-align: inherit;">. Then the ‚Äútrap‚Äù before starting the optimization will check how many iterations the loop will have to perform, and will cancel the optimization if this number does not exceed the specified threshold. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initially, the threshold is set at 5000 iterations. It cannot be set lower than in 2 iterations.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is clear that the most favorable threshold value is the intersection point on the graph of lines corresponding to the operating time of the optimized and initial variants of the function. </font><font style="vertical-align: inherit;">If you set the threshold exactly this way, the function will be able to choose the fastest in this case algorithm (optimized or initial):</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/854/2e0/75a/8542e075adca431596cc575474a4ba71.png"></div><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Strict flag </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In some cases, optimization should be mandatory applied. So, if in a cycle of </font></font><img src="https://habrastorage.org/files/8e7/a78/0ab/8e7a780ab22341d395aef9274df89a98.png"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iterations, without optimization, the program will simply hang. The </font></font><i><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strict</font></font></strong></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> option is provided for this case </font><font style="vertical-align: inherit;">. Initially, its value is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">False</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but if it is set to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">True</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then in the case when any of the standard </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> loops has </font><font style="vertical-align: inherit;">not been optimized, an exception will be raised. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the fact that optimization is not applicable, was discovered at the stage of applying the decorator, the exception </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cpmoptimize.recompiler.RecompilationError</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will be raised </font><i><font style="vertical-align: inherit;">immediately</font></i><font style="vertical-align: inherit;"> . In the example in the cycle, two unpredictable variables are multiplied:</font></font><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cpmoptimize <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cpmoptimize &gt;&gt;&gt; &gt;&gt;&gt; @cpmoptimize(strict=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n, k)</span></span></span><span class="hljs-function">:</span></span> ... res = <span class="hljs-number"><span class="hljs-number">0</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(n): ... res += i * res ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res ... Traceback (most recent call last): File <span class="hljs-string"><span class="hljs-string">"&lt;stdin&gt;"</span></span>, line <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;module&gt; File <span class="hljs-string"><span class="hljs-string">"cpmoptimize/__init__.py"</span></span>, line <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> upgrade_func index += analyze_loop(settings, code, index) + <span class="hljs-number"><span class="hljs-number">1</span></span> File <span class="hljs-string"><span class="hljs-string">"cpmoptimize/__init__.py"</span></span>, line <span class="hljs-number"><span class="hljs-number">59</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> analyze_loop <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> err cpmoptimize.recompiler.RecompileError: Multiplication of two unpredictable values <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> unsupported</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the fact that optimization is not applicable was detected before executing the loop (that is, if it turned out that the types of values ‚Äã‚Äãof the iterator or variables are not supported), a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TypeError</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> exception will be raised </font><font style="vertical-align: inherit;">:</font></font><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cpmoptimize <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cpmoptimize &gt;&gt;&gt; &gt;&gt;&gt; @cpmoptimize(strict=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(iterable)</span></span></span><span class="hljs-function">:</span></span> ... res = <span class="hljs-number"><span class="hljs-number">0</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> elem <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> iterable: ... res += elem ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res ... &gt;&gt;&gt; f(xrange(<span class="hljs-number"><span class="hljs-number">30</span></span>)) <span class="hljs-number"><span class="hljs-number">435</span></span> &gt;&gt;&gt; f(range(<span class="hljs-number"><span class="hljs-number">30</span></span>)) Traceback (most recent call last): File <span class="hljs-string"><span class="hljs-string">"&lt;stdin&gt;"</span></span>, line <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;module&gt; File <span class="hljs-string"><span class="hljs-string">"&lt;stdin&gt;"</span></span>, line <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> f File <span class="hljs-string"><span class="hljs-string">"cpmoptimize/hook.py"</span></span>, line <span class="hljs-number"><span class="hljs-number">170</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> exec_loop <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> err TypeError: Iterator <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> optimized loops must have type <span class="hljs-string"><span class="hljs-string">"xrange"</span></span> instead of &lt;type <span class="hljs-string"><span class="hljs-string">'list'</span></span>&gt;</code> </pre><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Advanced Optimization Options </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Two flags </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opt_min_rows</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opt_clear_stack</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are responsible for using additional optimization methods when constructing matrices. Initially they are included, the possibility of their disconnection is present only for demonstration purposes (thanks to it, it is possible to compare the effectiveness of these methods). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When executing an optimized code, most of the time is the multiplication of long numbers in some cells of the generated matrices. Compared with this time-consuming process, the time spent on multiplying all the other cells is negligible. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the process of recompiling expressions, the decorator creates intermediate, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">virtual</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">variables responsible for the positions of the interpreter stack. After complex calculations, they can have long numbers that are already stored in some other, real variables. We don‚Äôt need to store these values ‚Äã‚Äãa second time, but they remain in the cells of the matrix and significantly slow down the work of the program, since when multiplying matrices we have to multiply these long numbers once more. The </font></font><i><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opt_clear_stack</font></font></strong></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> option </font><i><strong><font style="vertical-align: inherit;">is</font></strong></i><font style="vertical-align: inherit;"> responsible for clearing such variables: if after they are used, they are set to zero, the long values ‚Äã‚Äãin them will disappear. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This option is especially effective when the program operates with very large numbers. The elimination of unnecessary multiplications of such numbers makes it possible to speed up the program more than twice. </font><i><strong><font style="vertical-align: inherit;">Opt_min_rows</font></strong></i></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> option</font></font><i><strong><font style="vertical-align: inherit;"></font></strong></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">includes minimizing the size of square matrices that we multiply. Rows corresponding to unused and predictable variables are excluded from the matrices. If the loop variable itself is not used, the rows responsible for maintaining its correct value are also excluded. In order not to disrupt the program, after the cycle, all these variables will be assigned the correct final values. In addition, in the original article, the vector of variables was supplemented with an element equal to one. If the row corresponding to this element is unused, it will also be excluded. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This option can speed up the program somewhat for not very large </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , when the numbers have not yet become very long and the dimensions of the matrix make a tangible contribution during the operation of the program.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If both options are used simultaneously, the virtual variables start to have a predictable (zero) value, and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opt_min_rows</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> works even more efficiently. </font><font style="vertical-align: inherit;">In other words, the effectiveness of both options together is greater than the effectiveness of each of them separately. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The graph below shows the program runtime for calculating Fibonacci numbers when certain options are disabled (here "-m" is a program with </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opt_min_rows</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> turned </font><i><font style="vertical-align: inherit;">off</font></i><font style="vertical-align: inherit;"> , "-c" is a program with </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opt_clear_stack</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> disabled </font><font style="vertical-align: inherit;">, "-mc" is a program where both options are disabled ):</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/9af/7c0/076/9af7c007610b4880863cb5bb39a899ac.png"></div><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> What else can be implemented? </font></font></h3><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Modifying a set of operations </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will say that our method </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">supports a couple of operations</font></font></i> <img src="https://habrastorage.org/files/5a3/ad8/0bf/5a3ad80bf17d436fa9adeacbf4318757.png"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> if:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We can perform an operation </font></font><img src="https://habrastorage.org/files/f81/b36/71e/f81b3671e9ba47249e0660d62d19366e.png"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for two variables or for a variable and a constant;</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We can perform an operation </font></font><img src="https://habrastorage.org/files/2bd/0fd/f4a/2bd0fdf4a53e4bd0ade81dc4b4c809f0.png"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for a variable and a constant.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We already know that the method supports a couple of operations. </font></font><img src="https://habrastorage.org/files/83b/7e7/bf7/83b7e7bf76cc4f118f88efe7fbd45764.png">  .<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Really: </font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We can add two variables or a variable and a constant; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We can multiply a variable by a constant. </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">These operations are currently implemented in the optimizing decorator. </font><font style="vertical-align: inherit;">However, it turns out that the described method supports other pairs of operations, including </font></font><img src="https://habrastorage.org/files/0f1/3f2/fb0/0f13f2fb0cb74cf4a22e826e5d0f67fc.png"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(a pair of multiplication and exponentiation operations). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For example, our task may be to find the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nth</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> number in the sequence given by the recurrence relation: </font></font><br><img src="https://habrastorage.org/files/f2f/2de/b0e/f2f2deb0e62444298562020803616c4a.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If our decorator supported a couple of operations </font></font><img src="https://habrastorage.org/files/0f1/3f2/fb0/0f13f2fb0cb74cf4a22e826e5d0f67fc.png"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we could multiply the variable by another variable (but could not add the variables anymore). </font><font style="vertical-align: inherit;">In this case, the following trivial solution of this problem could be speeded up by the decorator:</font></font><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function">:</span></span> a = <span class="hljs-number"><span class="hljs-number">1</span></span> b = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(n): a, b = b, a * b <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It can be proved that our method also supports pairs of operations. </font></font><img src="https://habrastorage.org/files/72d/97e/717/72d97e717cdc4cc4b6e24d7cdb525385.png">  , <img src="https://habrastorage.org/files/a7b/a71/1ab/a7ba711ab305458ba7b9b6b13cda0cdf.png">  and <img src="https://habrastorage.org/files/6e1/67b/9c1/6e167b9c1cd64219aaecdd4dafba1fb7.png"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(here </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is bitwise AND, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - bitwise OR). </font><font style="vertical-align: inherit;">In the case of positive numbers you can work with pairs of operations</font></font><img src="https://habrastorage.org/files/51c/033/b45/51c033b45c8b46a5869cf1745e7e38b6.png">  and <img src="https://habrastorage.org/files/642/a2e/40f/642a2e40f6c5442c8276bef1960bd7b2.png">  . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To implement support for operations, </font></font><img src="https://habrastorage.org/files/0f1/3f2/fb0/0f13f2fb0cb74cf4a22e826e5d0f67fc.png"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you can, for example, operate not with the values ‚Äã‚Äãof variables, but with logarithms of these values. </font><font style="vertical-align: inherit;">Then the multiplication of variables is replaced by the addition of logarithms, and the raising of a variable to a constant degree by the multiplication of the logarithm by a constant. </font><font style="vertical-align: inherit;">Thus, we will reduce the task to the already realized case with operations.</font></font><img src="https://habrastorage.org/files/83b/7e7/bf7/83b7e7bf76cc4f118f88efe7fbd45764.png">  . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The explanation of how to implement support for the remaining pairs of operations mentioned above contains a number of mathematical calculations and is worthy of a separate article. </font><font style="vertical-align: inherit;">At the moment it is only worth mentioning that pairs of operations are interchangeable to a certain extent.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nested loops </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Having improved the algorithm for analyzing loops in bytecode, you can implement support for nested loops in order to optimize code like this: </font></font><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> res = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">10</span></span> ** <span class="hljs-number"><span class="hljs-number">50</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">10</span></span> ** <span class="hljs-number"><span class="hljs-number">100</span></span>): res += i * <span class="hljs-number"><span class="hljs-number">2</span></span> + j <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res</code> </pre><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Predictable conditions </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the following code, the condition in the body of the loop is predictable. </font><font style="vertical-align: inherit;">You can even find out if it is true before starting the loop and remove the non-executing code branch. </font><font style="vertical-align: inherit;">The resulting code can be optimized:</font></font><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mode)</span></span></span><span class="hljs-function">:</span></span> res = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">10</span></span> ** <span class="hljs-number"><span class="hljs-number">50</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> mode == <span class="hljs-number"><span class="hljs-number">1</span></span>: res += <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: res += <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res</code> </pre><br><h3>  findings </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Python interpreter, generally speaking, creates a predictable bytecode that almost exactly matches the source code you wrote. </font><font style="vertical-align: inherit;">Standardly, it does not embed functions, nor does it unfold loops, nor any other optimizations that require an analysis of the behavior of the program. </font><font style="vertical-align: inherit;">Only since version 2.6, CPython has learned to minimize constant arithmetic expressions, but this feature does not always work effectively.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are several reasons for this situation. </font><font style="vertical-align: inherit;">First, code analysis is generally difficult in Python, because you can track data types only during program execution (which we do in our case). </font><font style="vertical-align: inherit;">Secondly, optimization, as a rule, still does not allow Python to reach the speed of purely compiled languages, so in the case when the program needs to work very quickly, it is suggested to simply write it in a lower level language. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nevertheless, Python is a flexible language, which allows, if necessary, to implement many optimization methods independently without interfering with the interpreter. </font><font style="vertical-align: inherit;">This library, as well as other projects listed below, illustrate this opportunity well.</font></font><br><br>  <b>UPD.</b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The project description is now also available as a </font><font style="vertical-align: inherit;">SlideShare </font></font><a href="http://www.slideshare.net/hx0/cpmoptimize"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">presentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h3>  see also </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Below I will provide links to several other interesting projects to speed up the execution of Python programs: </font></font><br><ol><li> <a href="http://pypy.org/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyPy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is an alternative Python interpreter that supports </font></font><a href="https://ru.wikipedia.org/wiki/JIT-%25D0%25BA%25D0%25BE%25D0%25BC%25D0%25BF%25D0%25B8%25D0%25BB%25D1%258F%25D1%2586%25D0%25B8%25D1%258F"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JIT compilation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which, as a rule, allows you to execute Python programs much faster. </font><font style="vertical-align: inherit;">PyPy itself is written in RPython, for which a translator to C code has been specially developed.</font></font></li><li> <a href="http://www.opennet.ru/opennews/art.shtml%3Fnum%3D40571"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyston</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a new alternative Python interpreter that translates the code into an intermediate representation of </font></font><a href="https://ru.wikipedia.org/wiki/Low_Level_Virtual_Machine"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LLVM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , from which it can be optimized using LLVM and executed using JIT compilation.</font></font></li><li> <a href="http://nuitka.net/">Nuitka</a> ‚Äî  Python.     py2exe,   *.exe-,  ,    , Nuitka     Python    . </li><li> <a href="https://code.google.com/p/wpython2/">WPython</a> ‚Äî   CPython 2.6.4     -,        . </li><li> <a href="https://bitbucket.org/haypo/astoptimizer">astoptimizer</a> ‚Äî ,        -     <a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D0%25B1%25D1%2581%25D1%2582%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25BD%25D0%25BE%25D0%25B5_%25D1%2581%25D0%25B8%25D0%25BD%25D1%2582%25D0%25B0%25D0%25BA%25D1%2581%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25B5_%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B2%25D0%25BE">  </a> . </li><li> <a href="https://pypi.python.org/pypi/promise/">promise</a> ‚Äî ,  -,     ¬´¬ª.           ,     ,       . </li><li> <a href="http://forums.synapse-wireless.com/showthread.php%3Ft%3D4655">foldy.py</a> ‚Äî ,  -   <i> </i> ( <i><strong>constant folding</strong></i> ),        ,     . </li><li> <a href="http://code.activestate.com/recipes/277940-decorator-for-bindingconstants-at-compile-time/"></a> ,  -   <i> </i> ( <i><strong>constant binding</strong></i> ),                . </li></ol><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPD # 1. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The user </font></font><a href="https://habrahabr.ru/users/magik/" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">magik</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> offered some more links:</font></font><br><ul><li> <a href="http://www.numpy.org/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NumPy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a library (with modules for Python written in C) that can quickly perform calculations with large arrays and matrices, as well as use an extensive set of high-level mathematical functions.</font></font></li><li> <a href="http://numba.pydata.org/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Numba</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a library that accelerates programs containing mathematical calculations and array operations. </font><font style="vertical-align: inherit;">Optimization occurs through JIT compilation (using LLVM), which converts the code into native instructions of the CPU and GPU, as well as through some other classical methods.</font></font></li><li> <a href="https://github.com/pydata/numexpr"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Numexpr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a library that accelerates the calculation of mathematical expressions through the analysis and modification of the corresponding byte-code. </font><font style="vertical-align: inherit;">Expressions can be divided into several parts, some of which can be recalculated less often than others, accelerated due to the parallelization of the code, etc.</font></font></li><li> <a href="http://cython.org/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cython</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is an optimizing compiler of the Python superset, which allows using static typing in a program and interacting closely with C and C ++ code.</font></font></li><li> <a href="http://www.phi-node.com/2013/01/just-in-time-compilers-for-number.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An article reviewing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> libraries that allows you to speed up a variety of computations in Python through JIT compilation.</font></font></li></ul><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPD # 2. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">User </font></font><a href="https://habrahabr.ru/users/dunerat/" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DuneRat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pointed to several more Python compilation projects: </font></font><a href="https://code.google.com/p/shedskin/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shedskin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://github.com/cosmo-ethz/hope"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hope</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://github.com/serge-sans-paille/pythran"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pythran</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div><p>Source: <a href="https://habr.com/ru/post/236689/">https://habr.com/ru/post/236689/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../236679/index.html">Oracle Siebel CRM Event Model (Part 2)</a></li>
<li><a href="../236681/index.html">Some inspiration for your own Raspberry Pi project.</a></li>
<li><a href="../236683/index.html">Some interesting and useful things for web developer # 28</a></li>
<li><a href="../236685/index.html">Reasons for failing to achieve goals</a></li>
<li><a href="../236687/index.html">Ice Bucket Challenge: engagement lessons</a></li>
<li><a href="../236693/index.html">Flight to Mars: non-Gomanov trajectory, aero braking and landing difficulties in a rarefied atmosphere</a></li>
<li><a href="../236697/index.html">Quick access to map by key row</a></li>
<li><a href="../236699/index.html">Output video from multiple webcams on one page</a></li>
<li><a href="../236701/index.html">Available pre-order microcomputer Edison board for the Internet of things from Intel</a></li>
<li><a href="../236703/index.html">Modular Analog Synthesizers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>