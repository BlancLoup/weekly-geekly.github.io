<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Quick start of the first project in Windows Azure. Web sites. Website Migration to Cloud Services</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear colleagues. 

 The first five parts of the cycle are available here . In this part of the series, we will look at how to migrate ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Quick start of the first project in Windows Azure. Web sites. Website Migration to Cloud Services</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, dear colleagues. <br><br>  The first five parts of the cycle are available <a href="http://habrahabr.ru/post/147204/">here</a> .  In this part of the series, we will look at how to migrate our simple website to Cloud Services (ex-Hosted Services) using a simple application that will use the WIndows Azure role model, the Windows Azure Service Bus, and storage services. <br><br><a name="habracut"></a><br>  Let's consider the following scenario: you have already deployed your web site (for example, a standard ASP.NET MVC 4 web site, which will be further considered) on Windows Azure Web Sites, but after some time you discovered that additional web sites are required functionality - it is necessary that the user can go to your website and upload images to their own gallery.  We implement such a scenario with the help of one website functionality, however, the list of requirements also includes the condition of flexible scalability of your website.  In the event that you use only Windows Azure Web Sites, you can scale your website only as a whole, which is an inefficient solution - most likely, the main burden will be on image handlers rather than on the user web interface.  Migrating the website to Cloud Services and rethinking the architecture based on the Windows Azure Cloud Services role model, as well as using Windows Azure Blob Storage and Service Bus Queues will help create an effective implementation of such a scenario.  In this part of the loop, you will create a cloud application, which will consist of two layers: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      1) Web interface implemented as a web role.  On the main page of the application, the user will be able to upload images, as well as view already downloaded images.  After the image is loaded, the web role will send the image to the blob storage in the blob container, whose name will be preset to simplify the task, then put the message consisting of a link to the image blob into the Service Bus queue. <br><br>  2) An image processor implemented as a Worker role.  The handler in the infinite loop will poll the Service Bus queue for messages from the Web role, and if there is a message in the queue, pick it up, receive a link to the blob with the image, then use the copy-source blob mechanism to create a new blob with with the same image and put it in the blob storage. <br><br><h4>  Setup of Cloud Services on the Windows Azure platform </h4><br>  Open <a href="http://windows.azure.com/">http://windows.azure.com</a> in your web browser and log in using your Windows Live ID, which has a Windows Azure account associated with it. <br><br>  Create a new storage account in which the application data will be stored.  In the Windows Azure menu, click <strong>New Storage Account</strong> .  In the <strong>Create a New Storage Account</strong> dialog box that appears, select your subscription in the <strong>Choose a subscription</strong> drop-down list. In the <strong>Enter a URL</strong> text box, type the name of your storage account, for example, <strong><em>&lt;yourname&gt; gallery</em></strong> , where <em>&lt;yourname&gt;</em> is a unique name.  Windows Azure uses this value to create the URLs of the vault account services entry points.  Select <strong>Create or choose an affinity group</strong> and click in the <strong>Create a new affinity group</strong> drop-down list.  In the <strong>Create a New Affinity Group</strong> dialog box, type the name of the affine group in the <strong>Affinity Group Name</strong> text box, select a location from the drop-down list and click <strong>OK.</strong> Back in the <strong>Create a New Storage Account</strong> dialog box, click <strong>Create</strong> to create a new storage account. <br><br>  Wait until the end of the initialization process and update the <strong>Storage Accounts</strong> ‚Äútree‚Äù.  Notice that the Properties panel shows the <strong>URL</strong> associated with each service in the storage account.  Record the public name of the storage account ‚Äî the first segment of the URL of your entry points.  Click the <strong>View</strong> button <strong>,</strong> located next to the <strong>Primary access key</strong> in the Properties panel.  In the <strong>View Storage Access Keys</strong> dialog box, click <strong>Copy to Clipboard</strong> (next to <strong>Primary Access Key)</strong> .  The copied value will be needed to configure the application. <br><br>  Create a computational service that will execute the code for your application: in the left pane, click <strong>Hosted Services</strong> and click the <strong>New Hosted Service</strong> button located in the menu.  In the <strong>Create a new Hosted Service</strong> dialog box, select your subscription from the <strong>Choose a subscription</strong> drop-down list.  Enter the service name in the <strong>Enter a name for your service</strong> text box and enter the URL by entering the appropriate value <strong>Enter a URL prefix for your service</strong> , for example, <strong><em>&lt;yourname&gt; gallery</em></strong> , where <em>&lt;</em> <em>yourname</em> <em>&gt;</em> should be a unique name.  Windows Azure uses this value to create a URL for entry points to the service.  In the <strong>Create or choose an affinity group</strong> drop-down list, select the affine group that you created earlier for the storage account.  Specify <strong>Do not Deploy.</strong> Click <strong>OK</strong> to create the service and wait until the initialization process is complete. Click the <strong>Service Bus</strong> tab <strong>, Access Control &amp; Caching.</strong>  Click the <strong>Service Bus</strong> tab <strong>.</strong>  Click <strong>New</strong> .  In the <strong>Create a new Service Namespace</strong> dialog box that opens, enter the name of your <strong>Namespace</strong> (for example, <strong>mytestservicebus)</strong> , select the location region and click <strong>Create Namespace.</strong>  .  Select the created namespace and click the <strong>View</strong> button on the <strong>Properties</strong> panel in the <strong>Default Key</strong> field <strong>.</strong>  Copy the <strong>Default Issuer</strong> and <strong>Default Key</strong> values ‚Äã‚Äãfrom the <strong>Default Key</strong> dialog box. <br><br>  Deployment and storage services are configured;  Service Bus namespace created. <br><br><h4>  Configuring an ASP.NET MVC 4 Application </h4><br>  Open Visual Studio 2012 with admin rights. <br><br>  Click <strong>New Project</strong> .  Select the <strong>Web \ ASP.NET MVC 4 Web Application</strong> template (Fig. 1).  Name the project <strong>MVC4Gallery</strong> .  Select <strong>Internet Application</strong> and uncheck the option <strong>Create a unit test project.</strong>  Click <strong>OK.</strong>  Wait for the creation of the project. <br><br> <a href=""><img title="clip_image001 [6]" src="http://hpcru.files.wordpress.com/2012/08/clip_image0016.png" alt="clip_image001[6]" width="428" height="144"></a> <br><br>  Fig.  1. List of web project templates in Visual Studio 2012 <br><br>  Right-click on the <strong>Models</strong> directory <strong>.</strong>  Click <strong>Add =&gt; Class.</strong>  In the dialog that opens, enter <strong>Image.</strong>  <strong>cs</strong> and click <strong>OK</strong> .  Replace the contents of the <strong>Image</strong> file <strong>.</strong>  <strong>cs</strong> to the code below. <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MVC4Gallery.Models</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Image</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Title{ <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Link{ <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }}</code> </pre> <br>  Open the <strong>Views \ Home \ Index</strong> file <strong>.</strong>  <strong>cshtml</strong> and replace its contents with the code below. <br><br><pre> <code class="cs hljs">&lt;header&gt; &lt;div <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=<span class="hljs-string"><span class="hljs-string">"content-wrapper"</span></span>&gt; &lt;div <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=<span class="hljs-string"><span class="hljs-string">"float-left"</span></span>&gt; &lt;p <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=<span class="hljs-string"><span class="hljs-string">"site-title"</span></span>&gt;   - &lt;/div&gt; &lt;/div&gt; &lt;/header&gt; &lt;div id=<span class="hljs-string"><span class="hljs-string">"body"</span></span>&gt; &lt;section <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=<span class="hljs-string"><span class="hljs-string">"featured"</span></span>&gt; &lt;div <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=<span class="hljs-string"><span class="hljs-string">"content-wrapper"</span></span>&gt; &lt;form action=<span class="hljs-string"><span class="hljs-string">"/Home/Upload"</span></span> method=<span class="hljs-string"><span class="hljs-string">"post"</span></span> enctype=<span class="hljs-string"><span class="hljs-string">"multipart/form-data"</span></span>&gt; &lt;label <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>=<span class="hljs-string"><span class="hljs-string">"title"</span></span>&gt; &lt;label <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>=<span class="hljs-string"><span class="hljs-string">"FileData"</span></span>&gt; &lt;/label&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"file"</span></span> id=<span class="hljs-string"><span class="hljs-string">"FileData"</span></span> name=<span class="hljs-string"><span class="hljs-string">"FileData"</span></span> /&gt;&lt;br /&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"submit"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>=<span class="hljs-string"><span class="hljs-string">""</span></span> /&gt; &lt;/form&gt;    <span class="hljs-string"><span class="hljs-string">""</span></span>: @<span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> image <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ViewData.Model) { @image.Title &lt;br /&gt; &lt;img width=<span class="hljs-string"><span class="hljs-string">"100"</span></span> height=<span class="hljs-string"><span class="hljs-string">"100"</span></span> src=<span class="hljs-string"><span class="hljs-string">"@image.Link"</span></span> /&gt;&lt;br /&gt; } &lt;/div&gt; &lt;/section&gt; &lt;/div&gt;</code> </pre><br>  Open the file <strong>Controllers \ HomeController.</strong>  <strong>cs</strong> and replace its contents with the code below.  The required dependencies and libraries will be added in the next paragraph. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Specialized; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web.Mvc; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.ServiceBus.Messaging; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.StorageClient; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> MVC4Gallery.Models; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MvcApplication1.Controllers</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HomeController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { List&lt;Image&gt; images = getBlobs(<span class="hljs-string"><span class="hljs-string">"ourgallery"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(images); } [HttpPost] [ActionName(<span class="hljs-string"><span class="hljs-string">"Upload"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Upload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> author, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> title</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SendBlobToStorage(author); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendBlobToStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> author</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { HttpPostedFileBase file = Request.Files[<span class="hljs-number"><span class="hljs-number">0</span></span>]; CloudBlob blob = getBlobContainer(<span class="hljs-string"><span class="hljs-string">"ourgallery"</span></span>).GetBlobReference(file.FileName); NameValueCollection metadata = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NameValueCollection(); metadata[<span class="hljs-string"><span class="hljs-string">"title"</span></span>] = file.FileName; blob.UploadFromStream(file.InputStream); BrokeredMessage msg = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BrokeredMessage(blob.Uri.AbsoluteUri); SendBrokeredMessageToServiceBusQueue(msg); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (StorageClientException e) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"      : "</span></span> + e.Message); System.Environment.Exit(<span class="hljs-number"><span class="hljs-number">1</span></span>); }} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Image&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBlobs</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> author</span></span></span><span class="hljs-function">)</span></span>{ CloudBlobContainer container = getBlobContainer(author); List&lt;Image&gt; images = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Image&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (CloudBlob blob <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> container.ListBlobs()) { blob.FetchAttributes(); Image image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Image(); image.Link = blob.Uri.AbsoluteUri; image.Title = blob.Metadata[<span class="hljs-string"><span class="hljs-string">"title"</span></span>]; images.Add(image); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> images; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> CloudBlobContainer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBlobContainer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userId</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> account = CloudStorageAccount.FromConfigurationSetting(<span class="hljs-string"><span class="hljs-string">"storageaccount"</span></span>); CloudBlobContainer container = account.CreateCloudBlobClient().GetContainerReference(userId); container.CreateIfNotExist(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> permissions = container.GetPermissions(); permissions.PublicAccess = BlobContainerPublicAccessType.Container; container.SetPermissions(permissions); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> container; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendBrokeredMessageToServiceBusQueue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">BrokeredMessage msg</span></span></span><span class="hljs-function">)</span></span> { QueueDescription qd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QueueDescription(<span class="hljs-string"><span class="hljs-string">"servicebustest"</span></span>); qd.MaxSizeInMegabytes = <span class="hljs-number"><span class="hljs-number">5120</span></span>; qd.DefaultMessageTimeToLive = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TimeSpan(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> connectionString = CloudConfigurationManager.GetSetting(<span class="hljs-string"><span class="hljs-string">"Microsoft.ServiceBus.ConnectionString"</span></span>); QueueClient Client = QueueClient.CreateFromConnectionString(connectionString, <span class="hljs-string"><span class="hljs-string">"servicebustest"</span></span>); Client.Send(msg); }}}</code> </pre><br><br>  Right-click on the <strong>References</strong> directory <strong>.</strong>  Select <strong>Add Reference</strong> .  In the dialog that opens (pic. 3), select the following assemblies: <br><br>  <em>Microsoft.WindowsAzure.StorageClient 1.7.0.0</em> <br>  <em>Microsoft.WindowsAzure.Configuration 1.7.0.0</em> <br>  <em>Microsoft.WindowsAzure.ServiceRuntime 1.7.0.0</em> <br>  <em>Microsoft.ServiceBus 1.7.0.0</em> <br>  <em>System.Runtime.Serialization 4.0.0.0</em> <br><br> <a href=""><img title="clip_image003 [4]" src="http://hpcru.files.wordpress.com/2012/08/clip_image0034_thumb.jpg" alt="clip_image003[4]" width="375" height="258"></a> <br>  Fig.  3. Selection of assemblies for the project. <br><br>  Open the <strong>Global</strong> file <strong>.</strong>  <strong>asax</strong> and add the code below to the <strong>Application _ Start ()</strong> method. <br><br><pre> <code class="cs hljs">CloudStorageAccount.SetConfigurationSettingPublisher((configName, configSettingPublisher) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connectionString = RoleEnvironment.GetConfigurationSettingValue(configName); configSettingPublisher(connectionString); });</code> </pre><br><br>  Right click on the project <strong>.</strong>  Select <strong>Add Windows Azure Cloud Service Project</strong> (Figure 4). <br><br> <a href=""><img title="clip_image005 [4]" src="http://hpcru.files.wordpress.com/2012/08/clip_image0054_thumb.jpg" alt="clip_image005[4]" width="329" height="291"></a> <br>  Fig.  4. Add a cloud project to the solution <br><br>  Right-click on <strong>Roles</strong> in the created <strong>MVC 4 Gallery</strong> project <strong>.</strong>  <strong>Azure</strong> .  Select <strong>Add</strong> .  Click the <strong>New Worker Role Project</strong> (Figure 5). <br><br> <a href=""><img title="clip_image006 [4]" src="http://hpcru.files.wordpress.com/2012/08/clip_image0064_thumb.png" alt="clip_image006[4]" width="360" height="175"></a> <br>  Fig.  5. Adding a project for the Worker role to the solution <br><br>  In <strong>Windows Azure Tools 1.7</strong> , a new Worker-role template has been added, already configured to use the <strong>Service Bus.</strong>  In the <strong>Add New Role Project</strong> window, select <strong>Worker Role with Service Bus Queue</strong> and click <strong>Add</strong> (Figure 6). <br><br> <a href=""><img title="clip_image008 [4]" src="https://habrastorage.org/getpro/habr/post_images/60f/7a1/e77/60f7a1e77f0857088da1fcb08b5800b0.jpg" alt="clip_image008[4]" width="379" height="243"></a> <br>  Fig.  6. Adding a Worker Role Project Configured to Use Service Bus Queue <br><br>  Open the <strong>WorkerRole.cs</strong> file and replace its contents with the code below. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Specialized; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Diagnostics; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Net; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.ServiceBus; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.ServiceBus.Messaging; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.ServiceRuntime; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.StorageClient; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">WorkerRoleWithSBQueue1</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WorkerRole</span></span> : <span class="hljs-title"><span class="hljs-title">RoleEntryPoint</span></span> { <span class="hljs-comment"><span class="hljs-comment">// The name of your queue const string QueueName = "servicebustest"; // QueueClient is thread-safe. Recommended that you cache // rather than recreating it on every request QueueClient Client; bool IsStopped; public override void Run() { while (!IsStopped) { try { //   BrokeredMessage receivedMessage = null; receivedMessage = Client.Receive(); if (receivedMessage != null) { //  .       ,      ,     . GetBlobFromStorage("ourgallery", receivedMessage.GetBody&lt;string&gt;()); receivedMessage.Complete(); }} catch (MessagingException e) { if (!e.IsTransient) { Trace.WriteLine(e.Message); throw; } Thread.Sleep(10000); } catch (OperationCanceledException e) { if (!IsStopped) { Trace.WriteLine(e.Message); throw; }}}} public override bool OnStart() { CloudStorageAccount.SetConfigurationSettingPublisher((configName, configSettingPublisher) =&gt; { var connectionString = RoleEnvironment.GetConfigurationSettingValue(configName); configSettingPublisher(connectionString); }); //      ServicePointManager.DefaultConnectionLimit = 12; //     ,      string sbconnectionString = CloudConfigurationManager.GetSetting("Microsoft.ServiceBus.ConnectionString"); var namespaceManager = NamespaceManager.CreateFromConnectionString(sbconnectionString); if (!namespaceManager.QueueExists(QueueName)) { namespaceManager.CreateQueue(QueueName); } //     Service Bus Client = QueueClient.CreateFromConnectionString(sbconnectionString, QueueName); IsStopped = false; return base.OnStart(); } public override void OnStop() { //     Service Bus IsStopped = true; Client.Close(); base.OnStop(); } public void GetBlobFromStorage(string author, string title) { try { CloudBlob sourceBlob = getBlobContainer("ourgallery").GetBlobReference(title); CloudBlob newBlob = getBlobContainer("ourgallery").GetBlobReference(title + "small_copy"); newBlob.CopyFromBlob(sourceBlob); NameValueCollection metadata = new NameValueCollection(); metadata["title"] = title + "small_copy"; } catch (StorageClientException e) { Console.WriteLine(" : " + e.Message); System.Environment.Exit(1); }} public static CloudBlobContainer getBlobContainer(string userId) { var account = CloudStorageAccount.FromConfigurationSetting("storageaccount"); CloudBlobContainer container = account.CreateCloudBlobClient().GetContainerReference(userId); container.CreateIfNotExist(); return container; }}}</span></span></code> </pre><br>  Add the <strong>WebRole.cs</strong> file to the <strong>MVC4Gallery project</strong> and replace its contents with the code below. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.Diagnostics; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.ServiceRuntime; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.WindowsAzure.StorageClient; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MVC4Gallery</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WebRole</span></span> : <span class="hljs-title"><span class="hljs-title">RoleEntryPoint</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStart</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { RoleEnvironment.Changing += RoleEnvironmentChanging; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnStart(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RoleEnvironmentChanging</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoleEnvironmentChangingEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.Changes.Any(change =&gt; change <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> RoleEnvironmentConfigurationSettingChange)) { e.Cancel = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }}}}</code> </pre><br>  Double-click with the right mouse button on the <strong>MVC 4 Gallery</strong> in the <strong>Roles</strong> cloud project in order to open the graphical user interface of the web-role (Fig. 7). <br><br> <a href=""><img title="clip_image010 [4]" src="http://hpcru.files.wordpress.com/2012/08/clip_image0104_thumb.jpg" alt="clip_image010[4]" width="393" height="147"></a> <br>  Fig.  7. Graphical Web Role Management Interface <br><br>  On the <strong>Configuration</strong> tab, uncheck the <strong>Enable Diagnostics</strong> option <strong>.</strong>  Go to the <strong>Settings</strong> tab, click <strong>Add Setting</strong> and create a new configuration setting named <strong>storageaccount</strong> .  Specify its type as a Connection String, then click on the button with the ellipsis and configure the connection string.  The required data was recorded in <strong>Part 1.</strong> Click <strong>Add Setting</strong> and enter the name <strong>Microsoft.ServiceBus.ConnectionString</strong> (type - <strong>String)</strong> , and then insert the following line in the <strong>Value</strong> field: <br><br>  Endpoint = sb: // [namespacename] .servicebus.windows.net; SharedSecretIssuer = owner; SharedSecretValue = [DefaultKey] <br><br>  Where is the namespace name for the <strong>Endpoint</strong> part <strong>, Default Issuer</strong> for <strong>SharedSecretIssuer</strong> and <strong>Default Key</strong> for <strong>SharedSecretValue</strong> .  Click <strong>OK.</strong>  Double-right-click on <strong>WorkerRoleWithSBQueue 1</strong> in the <strong>Roles</strong> cloud project to open the Worker-role graphical user interface. <br><br>  On the <strong>Configuration</strong> tab, uncheck the <strong>Enable Diagnostics</strong> option <strong>.</strong>  Go to the <strong>Settings</strong> tab, click <strong>Add Setting</strong> and create a new configuration setting named <strong>storageaccount</strong> .  Specify its type as a Connection String, then click on the button with the ellipsis and configure the connection string.  The required data was recorded in <strong>Part 1.</strong> Click <strong>OK.</strong>  Paste the required values ‚Äã‚Äãinto the connection string to customize the <strong>Microsoft.ServiceBus.ConnectionString.</strong>  The required data was recorded in <strong>Part 1</strong> - the name of the namespace for the <strong>Endpoint</strong> part <strong>, Default Issuer</strong> for <strong>SharedSecretIssuer</strong> and <strong>Default Key</strong> for <strong>SharedSecretValue</strong> .  Save the changes and close the GUI for managing the Worker role. <br><br>  Run the project by pressing <strong>F5.</strong>  The project will start in the local compute emulator and launch the browser with the <strong>Home / Index</strong> view <strong>.</strong> <br><br>  Select an image and click <strong>Save</strong> .  After loading the image, the page will refresh.  Please note that at the moment only one image is shown - the one that you downloaded.  After a while (just a few seconds is enough) refresh the page - it will take the image handler to interrogate the queue, receive a message from the web role, load a blob, create a copy of it and put a new blob in the repository. <br><br><h4>  Deploying an ASP.NET MVC 4 application to Windows Azure platform in Cloud Services from Visual Studio 2012 </h4><br><br>  In order to deploy the application to Cloud Services on the Windows Azure platform, you need to adjust the publishing functionality in Visual Studio 2012 accordingly. <br><br>  Right-click on the <strong>MVC 4 Gallery</strong> cloud project <strong>.</strong>  <strong>Azure.</strong>  Click <strong>Publish</strong> .  In the dialog that opens, expand the list under <strong>Choose your subscription</strong> and select <strong>&lt;Manage ...&gt;</strong> (fig. 12). <br><br> <a href=""><img title="clip_image012 [4]" src="http://hpcru.files.wordpress.com/2012/08/clip_image0124_thumb.jpg" alt="clip_image012[4]" width="360" height="244"></a> <br>  Fig.  12. <br><br>  In the <strong>Windows Azure Cloud Service Project Management</strong> dialog that opens, click <strong>New.</strong>  Enter any convenient name for the new certificate that will be used to deploy the application.  Click <strong>Ok</strong> Click the <strong>Copy the full path</strong> link <strong>.</strong>  Navigate to the Windows Azure Management Portal.  Click the <strong>Hosted Services, Storage Accounts &amp; CDN</strong> tab <strong>.</strong>  .  Click on the <strong>Management Certificates</strong> tab <strong>.</strong>  .  On the <strong>Management Certificates</strong> tab, click <strong>Add Certificate</strong> .  In the <strong>Add New Management Certificate</strong> dialog box that opens, click <strong>Browse</strong> and paste the path to the certificate from the Visual Studio to the <strong>File Name</strong> field.  Click <strong>Open.</strong>  Click <strong>Ok.</strong>  Go to the <strong>Hosted Services</strong> tab and copy the <strong>Subscription ID</strong> from the <strong>Properties</strong> panel.  Go to Visual Studio 2012. Paste the copied subscription ID into the appropriate field (Figure 13).  Click <strong>OK</strong> . <br><br> <a href=""><img title="clip_image014 [4]" src="http://hpcru.files.wordpress.com/2012/08/clip_image0144_thumb.jpg" alt="clip_image014[4]" width="372" height="255"></a> <br>  Fig.  13. <br><br>  Click <strong>Close</strong> .  Click <strong>Next.</strong>  On the <strong>Windows Azure Publish Settings</strong> page <strong>,</strong> you can configure advanced deployment options.  Click <strong>Publish.</strong>  You can observe the deployment process in the <strong>Windows Azure Activity Log</strong> view (Figure 14). <br><br> <a href=""><img title="clip_image016 [4]" src="https://habrastorage.org/getpro/habr/post_images/24a/b4f/79c/24ab4f79c37e9c3c3ab8d7235c4efcee.jpg" alt="clip_image016[4]" width="430" height="87"></a> <br>  Fig.  14. Presentation of Windows Azure Activity Log <br><br>  Go to the Windows Azure Management Portal to the <strong>Hosted Services</strong> tab <strong>.</strong>  Select the deployed application and click the link in the <strong>DNS Name</strong> field on the <strong>Properties</strong> panel to go to the website (Fig. 15). <br> <a href=""><img title="clip_image018" src="https://habrastorage.org/getpro/habr/post_images/894/bb5/5d5/894bb55d5518995f4113ade4bd33f3c2.jpg" alt="clip_image018" width="434" height="138"></a> <br>  Fig.  15. Windows Azure Management Portal <br><br>  Note that the site looks the same as after deploying it to a local computing emulator.  This is due to the fact that in both cases the real storage of Windows Azure is used.  Add a new image and observe the result. <br></div><p>Source: <a href="https://habr.com/ru/post/150418/">https://habr.com/ru/post/150418/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150411/index.html">Lexmark ceases inkjet production</a></li>
<li><a href="../150413/index.html">Photos from a memory card that survived two winters on the street</a></li>
<li><a href="../150414/index.html">Jevix snippet for MODX Revolution</a></li>
<li><a href="../150415/index.html">How many unique domains are in each zone?</a></li>
<li><a href="../150417/index.html">The Great Chinese Firewall will come to us in the fall</a></li>
<li><a href="../150420/index.html">Soviet rovers</a></li>
<li><a href="../150421/index.html">Inflation of values ‚Äã‚Äãon the TV screen: how to protect the child?</a></li>
<li><a href="../150423/index.html">Our player, our records are not suitable</a></li>
<li><a href="../150424/index.html">IT Compote # 20 Programming and Technology Podcast</a></li>
<li><a href="../150425/index.html">Runetology (162): Ainur Abdulnasyrov, founder of LinguaLeo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>