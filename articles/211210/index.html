<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Browser Development - Functional Level</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quite a lot of questions came after past articles regarding my direct role in the life of the project - it all came down to the desire to learn techni...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Browser Development - Functional Level</h1><div class="post__text post__text-html js-mediator-article">  Quite a lot of questions came after <a href="http://habrahabr.ru/post/208734/">past</a> <a href="http://habrahabr.ru/post/205312/">articles</a> regarding my direct role in the life of the project - it all came down to the desire to learn technical details that did not constitute the basic logic of the world, but directly support the existence of everything that was planned.  Some questions have already been answered, but some moments remained behind the scenes.  For a long time I tried to figure out what is so good I can tell about the system, which would not be ‚Äúbanal solutions‚Äù, but it would be really unusual.  Those, really archival and unusual, in my opinion, moments were not found. <br><br>  Of course, the source contains some interesting places, but they are specific specifically for our project and are not suitable for everyone.  I want to tell about these ‚Äúplaces‚Äù that stand out slightly from the general mass of the functional, but one should not expect the level of ‚Äúmonsters‚Äù of the industry - all solutions are deeply integrated into the logic of the project itself and are its conclusions from the tasks set. <br><br>  Like last time, the story will be conducted from the point of view of one of the team members involved in the development of the project from its inception - the programmer, that is, this time - me. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/96f/8e3/d81/96f8e3d81e508bca0bb4e2894679a900.png" alt="Pernatsk :: Assassins Castle"><br><a name="habracut"></a><br><br><h4>  Developer labor </h4><br>  No matter how much I looked at the block from ‚Äúhantim‚Äù on the pages of ‚Äúhabr‚Äù, no matter how many suggestions I had to take to participate in projects, I was always skeptical of them.  Usually there is a ‚Äúcomplete team‚Äù, but only a developer is missing, and the offer consists of a tiny share and a huge amount of work. <br><br>  Until now, I can not answer the question - what did move me when I agreed to participate in our project?  It was clear right away - the work would be delayed not for one year, but the real physically tangible profit may not follow at all.  Apparently, the stars so formed that I was unexpectedly loyal to the team, and the team accepted me. <br><br>  <i>Distant acquaintances called close and distant acquaintances, as a result a team formed, as a result close acquaintances left the team, as a result distant acquaintances became close friends.</i> <br><br>  Thanks to this project, the amount of experience gained was always stable regardless of my main job, where the flow of new knowledge usually ended in a couple of months and the routine began.  At least, I hoped that this project would be an additional advantage for me when applying for a new job, if necessary.  However, later it turned out that employers are not interested in this - they were always interested only in previous jobs, for which I received a direct reward. <br><br>  The only thing left to do was to lead your project with the hope that one day it would become the main one, and I would work side by side with my comrades in spirit.  Well, experience means experience. <br><br><h4>  Do not trample, I just swept </h4><br>  The first thing I want to say about the development of the project - no matter what its scale and complexity - keep it as clean as possible.  If not for other developers who will come after you, then for yourself.  How many times I came across in the drafting of other people's projects, as many times I was surprised at how people can live in such a mess. <br><br>  Directly at the start, we had only one module - the ‚Äúadministration panel‚Äù, the rest (user part) was slowly ‚Äúsawed‚Äù in the group of controllers outside the module.  But this was the limit when the number of controllers exceeded a dozen, and the module of the administration panel with its set of directories ceased to fit into the screen when viewing the tree in the IDE.  The categorical solution was to completely rework the structure of the project and pack everything into various modules, including embedded modules for the administration panel.  This resulted in a project of a certain ‚ÄúZen‚Äù and easy accessibility of each section.  Thanks to the quick ‚Äúline-by-line replacement,‚Äù they also aligned the base, although later they still had to get their hands on it. <br><br>  Such global manipulations are much easier transferred when the amount of code just comes to a critical point, and the project is not yet in combat conditions - this will save from further complex refactoring, and will allow you to continue to maintain a strong project structure. <br><br>  With a database size of 135 tables, it is also impossible to arrange a heap in the model folder - from the very beginnings of the modelka project they are placed in directories with a triple nesting so as not to create chaos (even sorting alphabetically does not save from searching in 30 files starting with Bird ~).  Someone might think that 2-4 clicks when searching for the right file for editing is a lot, but for me and the project coordinator this procedure turned out to be much better than trying to scroll with the mouse wheel in search of one file from one hundred and fifty. <br><br>  Any strict project structure that complements the basic architecture will always make it easier to navigate in it, and the code automatically becomes a mark higher in quality.  Even with dubious solutions in a hurry, I still don‚Äôt consider the project poorly written and I believe that when it comes time to take on an additional programmers team, they will easily find their way around the code. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1b1/947/98d/1b194798da0b9230994c66837a0803bc.png" align="right" alt="Pernatsk :: Lis Jah">  At the same time, it was clear to me from the beginning that our coordinator would play his part in writing the project code - in the past he made his websites, how much he could and how much his knowledge was enough, but he still cannot replace a full-fledged developer.  However, at the same time, he can easily save me from the task of spot-changing coefficients or correcting minor flaws in the layout, and this was one of the reasons for additional improvements in the structure of the code. <br><br>  All formulas in which there are numerical coefficients, and which are involved in critical calculations, are fully rendered into a separate Formula class.  First, we got rid of the presence of constants in the code - we just write numbers in formulas, and there is nothing wrong with that, since the class and its methods are intended for this purpose.  Secondly, we got a single point of the system, which allows you to edit the balance of the game, without running through the rest of the project. <br><br>  In addition, Yii has ready-made mechanisms to support multilingualism - in our project several languages ‚Äã‚Äãare not supposed yet, however this mechanism helped us to separate literary texts describing errors from the ‚Äúmechanical‚Äù ones written by me in the process of creating a functional.  And again - all the texts of errors or successful actions are collected in several files, and there is no need to search for texts throughout the project. <br><br><h4>  On the other side of the code </h4><br>  Since our entire project is built on the user‚Äôs waiting time for ‚Äúaccomplishing an action‚Äù (end of work, completion of the timer, updating the list of something, etc.), undoubtedly, most of this work should be performed by the server regardless of the user's online presence . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3af/8a6/4ce/3af8a64ce3cc4afe1970f535ad6ae68a.png" alt="Pernatsk :: Hobb Bear" align="right">  Some assumed that the work of the ‚Äúserver‚Äù part of the project required additional applications written in a more ‚Äúcorrect‚Äù programming language, newfangled technologies, and so on.  However, in conditions of limited baggage of knowledge and, certainly, not limitless nerves and patience, we could not afford to introduce technologies that we had not studied until the end, and were based on what we have.  Accordingly, since the site‚Äôs ‚Äúface‚Äù is based on PHP with the Yii framework, the project‚Äôs backside works on the same wheels. <br><br>  At the same time, it is not at all necessary that we will feel a performance drawdown soon enough - we can afford some tricks that temporarily neutralize the lack of technology.  And if we really have such a problem, it will mean the popularity of the project and the availability of funds for development. <br><br>  Currently, the project works on the basis of forty-five entries in the list of background tasks (with some repetition, but not the essence) - this is a lot or a little, everyone will decide for himself, but this is clearly not the limit.  Here is our list: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a39/d1d/451/a39d1d451c30a93c3b1c0efa41cd1f52.png"><br><br>  The most important tasks - the calculation of the results of deferred user actions - are placed in a single task flow, called tick, which is running 100% of the time the server is running.  Of course, the PHP daemon is not something that can be made to work normally with the standard thinking of a PHP developer, when there is confidence that the application should die after its launch, so the tick works 10 minutes apart, after which restart the task.  To protect against some unforeseen circumstances, there is a setting of mutex flags in work cycles, and the start of a new process is slightly superimposed on the end of the previous one in order to avoid idle time. <br><br>  Speaking of ‚Äútick‚Äù - his work must be fast, and it does not tolerate any delays even for a fraction of a second, since on the other side of the system the user can wait for the page to automatically reload after the action timer expires, respectively, the calculation time accuracy is very important in this situation.  We cannot calculate in advance and charge the in-game currency immediately after the start of the task - by definition, the task can be abandoned, at the time of the work the player can be attacked by another player and can take away some of the funds available at that time.  In this case, we resort to a small trick and calculate the results in the background task for a couple of seconds before the expiration of the work - during these seconds, the user simply does not have time to understand what happened if he suddenly opens the page before the appointed time and sees the letter of accrued reward.  For these two seconds at the time of peak load, the server will be able to create a queue of players waiting for the completion of tasks, and have time to complete them before the onset of time "x". <br><br>  In order not to load the server with constant samples from the database in order to search for new users who are about to get the result of work, the ‚Äútick‚Äù task has a waiting mechanism that allows you to dynamically calculate the idle time.  In a simpler language, the server does not make unnecessary samples during the operation of a ‚Äútick‚Äù, if there are no users who are soon waiting to complete the work. <br><br>  In order to have the structure of a list of background tasks and not lose anything during a deployment, the list is automatically compiled from a separate config where data about each task is stored in a multidimensional array.  The list of commands is generated in a readable form using a separate console command ‚Äúphp yiic.php crontab‚Äù, which is actually manually deployed by one command via ‚Äúphp yiic.php crontab |  crontab ‚Äìu production - ‚Äú, rewriting the server‚Äôs task list for the desired environment. <br><br><h4>  Remember everything </h4><br>  Who would know that the cache will be one of the most cruel things on the project - since the appearance of its primordia in the code, we constantly ran into unconventional situations when the cache interfered with normal functioning.  Gradually gaining experience, we had to solve caching issues with almost radical methods. <br><br>  Firstly, about half of the project is kept on the cache - it is impossible to operate the system adequately quickly, where so much information is shown on the character's main page that half of the database is used for this.  Part of the data updates the server in the background by periodic calculations and forced rewriting of the cached data (for example, part of the statistics).  Part of the data simply loses its relevance and is loaded as the user requests (for example, the number of people online).  And a piece of data is updated as certain events occur - in particular, ‚Äúthe arrival of a new letter‚Äù updates the list of recent letters in the ‚Äúsidebar‚Äù. <br><img src="https://habrastorage.org/getpro/habr/post_images/322/e53/44f/322e5344f2caef86f52e1ff40aa0e0ef.png" alt="Pernatsk :: Partisans" align="right"><br>  Secondly, a huge reservoir of sampling from the database is kept on the cache.  There is information on the project that does not change at the user's request, but only by a strict administration decree - the characteristics of items (except for the invention of the invention), the methods of currency extraction (texts for them, settings for them), characteristics of buildings, weather, awards, gifts - about 35 table names in total.  The correct decision, in my opinion, was to use them in a permanent cache until the ‚Äúabove‚Äù command came to change the data.  Models will resist, put a stick in the wheel, but the speed increase is worth it. <br><br>  For the work of the permanent cache of selected models, a tiny interlayer was added for ActiveRecord, which, when trying to access CDbConnection, determined the need to indicate the use of the cache - and, when convenient, substituted the corresponding directive with standard methods.  In fact, I created a sufficient amount of headaches for myself on the subject of how caching is established in the interlayer.  Check out the Yii source and see what happens when you install ‚ÄúModel :: model () -&gt; cache ()‚Äù.  For the lazy, I‚Äôll say that in this case, the instruction comes in ‚Äúcache the next query in the database‚Äù, and there is no guarantee that the ‚Äúnext query‚Äù will be from the source of the instruction. <br><br>  An additional problem of such a cache operation scheme was the entry point in the cache - the CDbConnection call occurred both for the main search model, and for all models that go in the relational bundle (if such are specified in the query), and the call from related-models occurs later than from the main one, respectively, all requests with join inevitably fell into the permanent cache. <br><br>  Having put a few crutches in the form ‚ÄúI‚Äôm absolutely sure you don‚Äôt need to cache this wonderful query with the join of the static model,‚Äù we got a workable solution, but only under one condition - all the samples for the ‚Äústatic‚Äù models should be made strictly without join'ov where this is possible.  That is, if a table with a list of items of the character is displayed on the page, this means that one request was made to the bird_item table for the bird_id &lt;-&gt; item_id bundle, and the darkness of individual requests for obtaining individual data for each item that magically lies in the cache.  For reference, before the cache ‚Äúwarms up,‚Äù more than 230 queries are sent to the database on the character‚Äôs main page.  After "warming up" - only 19. <br><br><div class="spoiler">  <b class="spoiler_title">Excerpts from the caster interlayer</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Permanent cache for models * * Component "dbParam" is storring active parameters in database * Config parameter "staticModelList" consists of model names should be in permanent cache * */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ActiveRecord</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CActiveRecord</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Flag are cache setings already setted */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_cacheUpdated = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Setting cache for static data * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> CDbConnection */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDbConnection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_cacheUpdated)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::getDbConnection(); } $className = get_class(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (in_array($className, Yii::app()-&gt;params-&gt;staticModelList) !== <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { $dependency = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CExpressionDependency(<span class="hljs-string"><span class="hljs-string">'Yii::app()-&gt;dbParam-&gt;staticDataLastUpdateTime . "_'</span></span> . $className . <span class="hljs-string"><span class="hljs-string">'_" . Yii::app()-&gt;dbParam-&gt;schemaLastUpdate'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::getDbConnection()-&gt;cache(Yii::app()-&gt;db-&gt;schemaCachingDuration, $dependency); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::getDbConnection()-&gt;cache(<span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/** * Setting flag as updated cache * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $duration * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> null $dependency * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $queryCount * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> CActiveRecord */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($duration, $dependency = null, $queryCount = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ $className = get_class(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (in_array($className, Yii::app()-&gt;params-&gt;staticModelList) === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_cacheUpdated = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::cache($duration, $dependency, $queryCount); } <span class="hljs-comment"><span class="hljs-comment">/** * Save model and drop static-model cache condition * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> bool $runValidation * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> null $attributes * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($runValidation = true, $attributes = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (in_array(get_class(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>), Yii::app()-&gt;params-&gt;staticModelList) !== <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { Yii::app()-&gt;dbParam-&gt;staticDataLastUpdateTime = time(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::save($runValidation, $attributes); } <span class="hljs-comment"><span class="hljs-comment">/** * Drop model and drop static-model cache condition * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (in_array(get_class(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>), Yii::app()-&gt;params-&gt;staticModelList) !== <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { Yii::app()-&gt;dbParam-&gt;staticDataLastUpdateTime = time(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::delete(); } }</code> </pre> <br></div></div><br>  The principle of such a cache was introduced not from the very ‚Äúdiaper‚Äù of the project, but approximately several months before alpha testing.  The found ‚Äúbugs‚Äù of the hooked up joins of the ‚Äústatic‚Äù model were corrected already on the working version of the project.  Therefore, it is necessary to operate with such things with extreme caution. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a28/c16/a98/a28c16a98d3b7ecaeedd9944a08a7bbc.png" alt="Pernatsk :: Scout Camp"><br><br><h4>  Template code </h4><br>  Despite the fact that I have some experience with large projects, I have never had to tinker with design patterns (well, except maybe standard MVC and singleton, but these don't count).  I even studied this topic more than once, but it just didn‚Äôt put off in my head, and if I needed to implement some kind of architectural feature, I never popped into my memory. <br><br>  However, as it turned out a little later, if you ‚Äúre-invent‚Äù the pattern yourself, it will constantly migrate from project to project, but it‚Äôs far from the fact that it will be understood once that it is actually ‚Äúhe‚Äù - it will simply be ‚Äúgood decision "that will become a habit. <br><br>  With this pattern, I had a ‚Äústrategy‚Äù, with the help of which so-called ‚Äúswitchable behaviors‚Äù were implemented in my projects.  In Yii, there is a wonderful thing - behavior - which allows you to organize "horizontal" class inheritance (roughly speaking, trait, but implemented at the level of PHP code inside the framework for a long time).  It is on such classes-behaviors that certain elements of the system are based that require different results of work, depending on the state of the object. <br><br>  I will give an example.  The project implemented the weather conditions - fog, sunny, rain, cloudy, storm and several other options - which carry various effects that affect the behavior of the game.  For example, in cloudy weather, a player can be given a bonus of ‚Äúadditional chance‚Äù to find game currency, or when sunny weather sets in after a storm, there is a chance of sending a ‚Äústorm ration‚Äù to all players, including a small cash allowance ‚Äúfor restoring after bad weather‚Äù. <br><br>  Thus, each type of weather can contain one or several effects, which should have an iron base in the form of a code and ordinary parameters in the database.  The canvas of conditional operators in this situation will not succeed.  In our case, everything was decided through ‚Äúswitchable behaviors‚Äù. <br><br>  First, a basic class-behavior is needed, which by default will always be connected to the operated model (it is possible and not to the model, but for the current task ‚Äî specifically to it), which should contain methods for choosing the desired final behavior and methods stubs for returning default values ‚Äã‚Äãif the final behavior is not used.  Secondly, we need a set of behavior classes that actually perform the necessary functions. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/90f/378/dcb/90f378dcb2d72f6a81d62e9a7dff885f.png" alt="Pernatsk :: Squirrel Lightning" align="right">  For weather conditions, a list of methods was selected that actually constitute effects checks - this is ‚Äúobtaining a coefficient‚Äù (respectively, there is a call and use of an additional factor for calculations in the right places of the project), ‚Äúwhether the building is active‚Äù (with appropriate checks in the formulas) , "Whether the skill is active," "execute when activated" (method to perform when a new weather effect occurs).  In the base class, all these methods are represented with checking whether the final behavior is connected and returning the default values, while the final behavior classes contain the actual code (which is small enough and easy to navigate, easy to edit).  When checking (trying to perform one of the functions for the first time), the current base class is disconnected from the operated model and the final behavior class is connected. <br><br>  In fact, a certain toggle switch works, which connects the required class depending on the state of the object. <br><br><div class="spoiler">  <b class="spoiler_title">Excerpts from switchable weather behaviors</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * This class is appended as behavior to WeatherHistoryEffect and provides * real effect actions for current effect * * Class WeatherEffectBehavior */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WeatherEffectBehavior</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CBehavior</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Is weather enabled in admin settings * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isWeatherEnabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $isWeatherDisabledByEvent = GlobalEvent::model()-&gt;getValue(GlobalEvent::ACTION_WEATHER); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($isWeatherDisabledByEvent) &amp;&amp; (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(Yii::app()-&gt;par-&gt;weatherEnabled)); } <span class="hljs-comment"><span class="hljs-comment">/** * Activate weather effect * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">activate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $owner = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOwner(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isWeatherEnabled() &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;checkEnabledBehavior()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $owner-&gt;activate(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Checking if building is disabled during weather effect * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $building * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isBuildingDisabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($building)</span></span></span><span class="hljs-function"> </span></span>{ $owner = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOwner(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isWeatherEnabled() &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;checkEnabledBehavior()) { <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> WeatherEffectBehavior $owner */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $owner-&gt;isBuildingDisabled($building); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Checking if action is disabled during weather effect * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $action * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isActionDisabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($action)</span></span></span><span class="hljs-function"> </span></span>{ $owner = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOwner(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isWeatherEnabled() &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;checkEnabledBehavior()) { <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> WeatherEffectBehavior $owner */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $owner-&gt;isActionDisabled($action); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Checking if building is disabled during weather effect * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $type * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCoefficient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($type)</span></span></span><span class="hljs-function"> </span></span>{ $owner = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOwner(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isWeatherEnabled() &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;checkEnabledBehavior()) { <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> WeatherEffectBehavior $owner */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $owner-&gt;getCoefficient($type); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Generating text value of effect * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> null|string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTextValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $owner = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOwner(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isWeatherEnabled() &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;checkEnabledBehavior()) { <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> WeatherEffectBehavior $owner */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $owner-&gt;getTextValue(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Generated weather effect description * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> null|string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPublicText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $owner = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOwner(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isWeatherEnabled() &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;checkEnabledBehavior()) { <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> WeatherEffectBehavior $owner */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $owner-&gt;getPublicText(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Switching behaviors for effect model * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkEnabledBehavior</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $behavior = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOwner()-&gt;asa(<span class="hljs-string"><span class="hljs-string">'weatherFinalEffectBehavior'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($behavior)){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOwner()-&gt;effect)) { $behaviorName = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOwner()-&gt;effect-&gt;effect_id) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_CONES_SEARCH_MAX_CHANCE_COEFFICIENT: $behaviorName = <span class="hljs-string"><span class="hljs-string">'ConesSearchMaxChanceCoefficientBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_CONES_SEARCH_TIME_COEFFICIENT: $behaviorName = <span class="hljs-string"><span class="hljs-string">'ConesSearchTimeCoefficientBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_COINS_HUNT_TIME_COEFFICIENT: $behaviorName = <span class="hljs-string"><span class="hljs-string">'CoinsHuntTimeCoefficientBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_COINS_HUNT_BONUS_COEFFICIENT: $behaviorName = <span class="hljs-string"><span class="hljs-string">'CoinsHuntBonusCoefficientBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_DEFENCE_IDOLS_DO_NOT_WORK: $behaviorName = <span class="hljs-string"><span class="hljs-string">'DefenceIdolsDoNotWorkBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_ATTACK_IDOLS_DO_NOT_WORK: $behaviorName = <span class="hljs-string"><span class="hljs-string">'AttackIdolsDoNotWorkBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_ATTACK_TIMER_COEFFICIENT: $behaviorName = <span class="hljs-string"><span class="hljs-string">'AttackTimerCoefficientBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_BATTLE_WIN_COEFFICIENT: $behaviorName = <span class="hljs-string"><span class="hljs-string">'BattleWinCoefficientBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_CAN_NOT_SELL_ON_FLEAMARKET: $behaviorName = <span class="hljs-string"><span class="hljs-string">'CanNotSellOnFleamarketBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_CAN_NOT_COINS_HUNT: $behaviorName = <span class="hljs-string"><span class="hljs-string">'CanNotCoinsHuntBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_CAN_NOT_CONES_SEARCH: $behaviorName = <span class="hljs-string"><span class="hljs-string">'CanNotConesSearchBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_NO_DELAY_BETWEEN_ATTACK: $behaviorName = <span class="hljs-string"><span class="hljs-string">'NoDelayBetweenAttackBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_BATTLE_STATS_BONUS_COEFFICIENT: $behaviorName = <span class="hljs-string"><span class="hljs-string">'BattleStatsBonusCoefficientBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_BATTLE_FEATHERING_CHANCE_COEFFICIENT: $behaviorName = <span class="hljs-string"><span class="hljs-string">'BattleFeatheringChanceCoefficientBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_STAT_COST_COEFFICIENT: $behaviorName = <span class="hljs-string"><span class="hljs-string">'StatCostCoefficientBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_SHOP_PRICE_COEFFICIENT: $behaviorName = <span class="hljs-string"><span class="hljs-string">'ShopPriceCoefficientBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_WORK_TIMER_COEFFICIENT: $behaviorName = <span class="hljs-string"><span class="hljs-string">'WorkTimerCoefficientBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_BATTLE_CONES_WIN_MAX_CHANCE_COEFFICIENT: $behaviorName = <span class="hljs-string"><span class="hljs-string">'BattleConesWinMaxChanceCoefficientBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_STORM_RATION: $behaviorName = <span class="hljs-string"><span class="hljs-string">'StormRationBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_COINS_LEVEL_REWARD: $behaviorName = <span class="hljs-string"><span class="hljs-string">'CoinsLevelRewardBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_COINS_PERCENT_REWARD: $behaviorName = <span class="hljs-string"><span class="hljs-string">'CoinsPercentRewardBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_IDOLS_DO_NOT_WORK: $behaviorName = <span class="hljs-string"><span class="hljs-string">'IdolsDoNotWorkBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_FOLIAGE_DO_NOT_WORK: $behaviorName = <span class="hljs-string"><span class="hljs-string">'FoliageDoNotWorkBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_POLE_DO_NOT_WORK: $behaviorName = <span class="hljs-string"><span class="hljs-string">'PoleDoNotWorkBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_NECKLACE_CONES_UPGRADE_COST_COEFFICIENT: $behaviorName = <span class="hljs-string"><span class="hljs-string">'NecklaceConesUpgradeCostCoefficientBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WeatherEffect::TYPE_RARE_ITEM_FOUND_CHANCE_COEFFICIENT: $behaviorName = <span class="hljs-string"><span class="hljs-string">'RareItemFoundChanceCoefficientBehavior'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($behaviorName)) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOwner()-&gt;attachBehavior(<span class="hljs-string"><span class="hljs-string">'weatherFinalEffectBehavior'</span></span>, $behaviorName); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOwner()-&gt;detachBehavior(<span class="hljs-string"><span class="hljs-string">'weatherEffect'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CoinsHuntTimeCoefficientBehavior</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WeatherEffectBehavior</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCoefficient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($type == WeatherEffect::TYPE_COINS_HUNT_TIME_COEFFICIENT) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOwner()-&gt;value; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTextValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOwner()-&gt;value * <span class="hljs-number"><span class="hljs-number">100</span></span>) . <span class="hljs-string"><span class="hljs-string">'%'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPublicText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CHtml::tag(<span class="hljs-string"><span class="hljs-string">'b'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(), <span class="hljs-string"><span class="hljs-string">''</span></span>) . <span class="hljs-string"><span class="hljs-string">',       '</span></span> . CHtml::tag(<span class="hljs-string"><span class="hljs-string">'b'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'g18_icons i_hunt'</span></span>, <span class="hljs-string"><span class="hljs-string">'title'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>), <span class="hljs-string"><span class="hljs-string">''</span></span>) . CHtml::link(<span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'/location/coinshunt'</span></span>) . <span class="hljs-string"><span class="hljs-string">', '</span></span> . CHtml::tag(<span class="hljs-string"><span class="hljs-string">'b'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(), (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOwner()-&gt;value &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> ? <span class="hljs-string"><span class="hljs-string">''</span></span> : <span class="hljs-string"><span class="hljs-string">''</span></span>)) . Yii::app()-&gt;formatter-&gt;percentCoefficient(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOwner()-&gt;value); } }</code> </pre><br></div></div><br>  Yes, it complicates the structure of the model, adds additional checks, connecting and disconnecting classes (and, of course, it gives more load to the interpreter), but it makes it very, very much easier to operate with the same type of code, which differs technically and repeats structurally. <br><br><h4>  System collapse </h4><br>  I have already told earlier that a sufficient part of the time spent working on the project was spent on thinking about possible critical situations that arise in the system.  Whether it is a deliberate user attack or a code error that has occurred, this must somehow be handled by the system. <br><br>  There are especially important parts of the system, without which the normal functioning of the game is almost impossible - for example, the work of the ‚Äútick‚Äù team, on which the calculation of all users' performance depends.  If an error occurs in the operation of such an operation \ method \ function - it does not matter - the system should react just as critically. <br><br>  In our case, the ‚Äúcurfew‚Äù mode was added, which implies the complete inactivity of all players, the closure of all game functionality from users and the complete cessation of any background project tasks.  It would seem that it is a simple solution to implement, but it completely helps to prevent the appearance of ‚Äúdamaged‚Äù data (for example, incorrect multiple charges of funds that occurred due to a failure in the middle of the accrual function).  In the process of debugging on alpha testing, such protection worked more than once during the night, when no one from the administration monitored the state of the system - it‚Äôs better to get an inaccessible game for a couple of hours than to skew the data. <br><br>  This same mode of operation was later useful to us for creating a project deployment system.  We implemented the hot ‚Äúupdate code‚Äù function, which allows you to automatically start the timer before closing the game, then turn on the curfew, update the code from the repository, start the timer before opening the game, and after the specified time, let the waiting users into the game .  For the sake of security, it is impossible to update the project code on behalf of the user operating the web server, therefore a specially trained individual user of the system does it for the rest, checking for the presence of such an indication with a certain periodicity. <br><br>  This approach to updates allows you to enter painlessly small iterations of the code into the project, without interfering with the administrators to preliminarily check the integrity of the update, and notify users about the event. <br><br>  In addition to the above, a possible ‚Äúcrutch‚Äù of data synchronization between versions of a project ‚Äî for example, the data from the test server, if changed, is copied to the repository every night as possible against the occurrence of problems with project settings that are stored in ‚Äústatic‚Äù models. where they immediately get to the development server in order to have an up-to-date environment for preliminary testing of new code.  That is, if the data has been changed, then in addition to resetting their permanent cache, the task to save them to the repository is put ‚Äúactive‚Äù.  And only if the project server is marked as ‚Äúsource‚Äù (for example, the test server is one and the dev server is not) - so we can restore the old values ‚Äã‚Äãor transfer the values ‚Äã‚Äãto other versions of the project. <br><br>  Data storage in the repository is carried out without any tricks - these are ordinary files with serialize () - the contents of the models, where one file has one table entry (the amount of data at the moment is such that one file is not enough for all the data in order to avoid problems with lack of memory during serialization-deserialization). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b73/584/0c4/b735840c4f47a5d8ddf3f72e4f455a1a.png" alt="Pernatsk :: Dump"><br><br><h4>  Divide to recover </h4><br>  Until the team had a system administrator, we had to rely only on our own strength and knowledge in the matter of creating, storing and restoring backups in case of unforeseen situations. <br><img src="https://habrastorage.org/getpro/habr/post_images/5c8/684/2dd/5c86842dd2cbe44fb11f7dc87e10dac8.png" alt="Pernatsk :: Contraband" align="right"><br>  Now we have implemented a database backup bypassing mysqldump and locking the database, which allows you to restore the archive much faster than it would be with the help of a packet of requests from a dump.  But also recovery is possible only entirely, at once all available bases on the server.  Soon, we are promised another backup-recovery principle - already with the help of special utilities from Percona, but I can‚Äôt say anything about them yet. <br><br>  For your own comfort at the start of the project, a system for dividing the project database into two parts was invented - one full-fledged self-contained part (including the entire set of tables), and the second one, including only data that can be lost for a short time without disturbing the entire project.  In other words, the second part - the ‚Äúden‚Äù database - contained tables with letters, system logs, a history of battles and other similar data that are accumulated in very large numbers, but do not have real value for the overall system.  By default, all the ‚Äúlog‚Äù data is recorded in a separate database if access to it is available, and if for some reason access to the second database disappears, the system switches to the main database (where, by default, there is no data in the required tables, but in they can temporarily record new data that will later be transferred to an additional database). <br><br>  Thus, if we suddenly burn down the server and don‚Äôt have a hot swap, but only dumps of two databases, we will restore the main database (with important information that supports the entire game) in 5-20 minutes and launch the project further, warning players that a collapse has occurred, and the rest of the data will be pulled up later.  And in a few hours, when the additional base dump is loaded to a new location, it will be possible to switch the system to work with two bases. <br><br>  According to preliminary calculations, the ratio of the sizes of the two bases was 1 to 70 ‚Äî that is, the history of battles, letters, and other massive ‚Äúhusks‚Äù on a project is many times more than critical data. <br><br>  The implementation of this idea turned out to be not very difficult - just need to redefine the CDbConnection search method in the model, which, depending on the type of model, tries to connect to the required database.  But at the same time there are some minuses (or maybe not even minuses) - any ‚Äúmanual‚Äù spelling of SQL queries must be written using the tableName () method from the table model in use, where the correct database name was automatically substituted into the table name . <br><br><div class="spoiler">  <b class="spoiler_title">Excerpts from the split layer in two bases</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ActiveRecord</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CActiveRecord</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_tableCheckedPrefix = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-comment"><span class="hljs-comment">/** * Table names with DB name prefix * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $tableName * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tableNameWithPrefix</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($tableName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_tableCheckedPrefix[$tableName])) { $matches = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); preg_match(<span class="hljs-string"><span class="hljs-string">"/dbname=([^;]*)/"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getDbConnection()-&gt;connectionString, $matches); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getCheckedTableName($matches[<span class="hljs-number"><span class="hljs-number">1</span></span>], $tableName); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_tableCheckedPrefix[$tableName] . <span class="hljs-string"><span class="hljs-string">'.'</span></span> . $tableName; } <span class="hljs-comment"><span class="hljs-comment">/** * Creating static var cache of table names * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $tableName * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $dbName */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setCheckedTablePrefix</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($tableName, $dbName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_tableCheckedPrefix[$tableName] = $dbName; } <span class="hljs-comment"><span class="hljs-comment">/** * Creating static var cache of table names * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $dbName * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $tableName * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCheckedTableName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($dbName, $tableName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;setCheckedTablePrefix($tableName, $dbName); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $dbName . <span class="hljs-string"><span class="hljs-string">'.'</span></span> . $tableName; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LogActiveRecord</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ActiveRecord</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_dbLog; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_dbEnabled = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Checking DB available or resetting to main DB * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> CDbConnection */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDbConnection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_dbEnabled === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Yii::app()-&gt;db; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_dbLog !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_dbLog; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_dbLog = Yii::app()-&gt;dbLog; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_dbLog <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> CDbConnection) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_dbLog; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CDbException(Yii::t(<span class="hljs-string"><span class="hljs-string">'yii'</span></span>,<span class="hljs-string"><span class="hljs-string">'Active Record requires a "db" CDbConnection application component.'</span></span>)); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> $e) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_dbEnabled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Yii::app()-&gt;db; } } } <span class="hljs-comment"><span class="hljs-comment">/** * Table name with DB name prefix * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $dbName * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $tableName * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCheckedTableName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($dbName, $tableName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getDbConnection()-&gt;getSchema()-&gt;getTable($tableName) === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_dbEnabled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_dbLog = Yii::app()-&gt;db; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::tableNameWithPrefix($tableName); } <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_dbEnabled = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;setCheckedTablePrefix($tableName, $dbName); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $dbName . <span class="hljs-string"><span class="hljs-string">'.'</span></span> . $tableName; } }</code> </pre><br></div></div><br><h4>  Bike or other people's slippers </h4><br>  It is imperative that during the development a question arises whether to use someone else's work in some part of the system or do it yourself.  Even with a large catalog of extensions for the framework, this question is still not easy in view of the questionable quality of the code of other extensions. <br><img src="https://habrastorage.org/getpro/habr/post_images/bb5/137/4a0/bb51374a085bdecfda264ac7aa4239b8.png" alt="Pernatsk :: fork" align="right"><br>  From what is actually used on the project, in no way did only the new-fangled debag-toolbar, which had carefully transferred the framework from the new version of Yii2 to the version code Yii1.1, did not finish it in any way.  Everything else was either superficially written to get rid of the appearing "notices" during the work of extensions (for example, swiftMailer, where variables were not periodically initialized or were not checked for the presence of array elements), or were almost completely rewritten (as in the case of XDbParam, EMutex, where, in principle, the code did not suit the content and quality, but at least allowed to be based on it in terms of general ideas). <br><br>  A great example of the choice of agony can serve as an introduction to the draft forum, and in this matter we chose to create our own, rather than installing one of the many ready-made options.  Firstly, I do not have enough experience and perseverance to easily create a design theme for the forum, if we chose the finished version.  Secondly, a third-party forum would still have to be completed in order to implement its functionality linking the player and the forum (avatars, names, ratings, links to players, etc.) - yes, it is quite possible that there are ‚Äúbridges‚Äù for the connection between the framework and forum, but no matter how much time we spent on bringing it to mind. <br><br>  Creating our own forum allowed us to make the minimum necessary functionality based on the finished project, and the time spent on developing the basic framework turned out to be so insignificant that it can be ignored.  Moreover, the forum code was completely in the project repository, in the migration to databases, in the division into two databases and the automatic archiving of ‚Äústatic‚Äù data.  The benefit of our own development has blocked for us "the ability to immediately have ready-made functionality in a large volume."  The forum is being gradually added (new permissive BB codes are introduced, new message samples are selected, and other improvements), but the project did not stop due to possible difficulties arising from creating a typesetting theme. <br><br>  All other elements of the system go through a similar approach to the selection. -      , -   ,     ,           . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f31/e39/1ce/f31e391ce5b12547f5f043bca6660fed.png" alt=" :: , "><br><br><h4>  ‚Äì  </h4><br>        ¬´ ¬ª      ¬´ ¬ª,       .     ¬´ ¬ª ,    ,          ,        . <br><br>  -        Hetzner ‚Äì vq7  vq12,        memcache  ¬´-¬ª.         ,    .       ¬´¬ª    ¬´ ¬ª   ‚Äì  ¬´¬ª       .    ¬´¬ª     ‚Äì  DNS-     ip-,      . <br><img src="https://habrastorage.org/getpro/habr/post_images/31a/b89/fc5/31ab89fc5d0be4b4b4919b578f8599a6.png" alt=" :: " align="right"><br>      ¬´¬ª  EX6S    Hetzner.   -  nginx   php-fpm (  PHP  5.4,     5.5),   ‚Äì Percona Server (    MySQL,      ¬´¬ª ¬´¬ª      ),   Memcache.       APC-,     PHP 5.5          OPcache ‚Äì        ,      . <br><br>      Pinba  Zabbix.    ¬´¬ª       ,  Zabbix      . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/696/68b/7e9/69668b7e916b70744094872aa4a24c24.png"><br><br>       2.5  ‚Äì      ,   1  ‚Äì   (      ),    500  ‚Äì      (    ). <br><br>   ,    , ‚Äî      .         CActiveRecord,     ¬´master-slave¬ª ‚Äî        .          ,            . <br><br>   nosql      ‚Äì                   .     ,        . <br><br>             ‚Äì ,      ¬´¬ª sql-  ,        . <br><br><h4>    </h4><br>       ,        .  ‚Äì            ,     . <br><br>     (    ,    ) ‚Äì         .              ,     .            ,              ‚Äì       ,         ,      . <br><br>      ,         ‚Äî           9500 ,   2  ,     .          -  ,     ,       ,   . <br><br>     ‚Äì           .      ,      ,           . </div><p>Source: <a href="https://habr.com/ru/post/211210/">https://habr.com/ru/post/211210/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211200/index.html">The problem of glass balls - the solution in general</a></li>
<li><a href="../211202/index.html">Unity3D multiplayer basics</a></li>
<li><a href="../211204/index.html">Qwt and Qt Creator. Quick and easy. Part 1: Data Visualizer</a></li>
<li><a href="../211206/index.html">Incoding Rapid Development Framework (part 2 CQRS)</a></li>
<li><a href="../211208/index.html">Evolution in data center networks. Software defined SDN</a></li>
<li><a href="../211214/index.html">Cybersquatting in new zones will not be a problem</a></li>
<li><a href="../211216/index.html">iOS leaves your phone number hostage</a></li>
<li><a href="../211218/index.html">Replication of data from MySQL to MongoDB</a></li>
<li><a href="../211220/index.html">20 professions of the future</a></li>
<li><a href="../211222/index.html">Creating project office tools based on Microsoft Project Server</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>