<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Non-canonical STI in Rails</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Before you start the story, remember what is the STI . 

 STI (Single Table Inheritance) is a design pattern that allows you to transfer object-orient...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Non-canonical STI in Rails</h1><div class="post__text post__text-html js-mediator-article">  Before you start the story, remember what is the <em>STI</em> . <br><br>  <em>STI (Single Table Inheritance) is a design pattern that allows you to transfer object-oriented inheritance to a relational database table.</em>  <em>In the database table there should be a field identifying the name of the class in the hierarchy.</em>  <em>Often, including in RoR, the field is called type.</em> <br><br>  With this pattern, you can create objects that contain the same set of fields, but have different behaviors.  For example, a user table containing a name, a login and a password, but two classes of users Admin, Visitor were used.  Each class contains both an inherited and an individual set of methods.  Determining which class will be created and the <em>type</em> field is used, the field name can be overridden. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Thus, if we consider the canonical case: the class names are stored in the same table with the data. <br><img src="https://habrastorage.org/getpro/habr/post_images/c5f/f09/3b5/c5ff093b5748e4507eda8323424fa041.png"><br>  But a different situation may happen ... <br><a name="habracut"></a><br>  There are tasks when it is necessary on top of the existing base, to which a certain web editor is already tied.  And the likelihood that the existing scheme will fully meet the requirements of the <em>ORM</em> is small.  As a consequence, when configuring models, it is necessary to pull the whole thing. <br><img src="https://habrastorage.org/getpro/habr/post_images/87e/96b/b4c/87e96bb4c6881ffad91c93c33b82f760.png"><br>  A fairly common practice, for normalization, is the use of reference tables. <br><br>  For example, it may be a contact table associated with the contact type directory.  In this case, it would be logical to make a check of the entered data at the model level, you can add methods for formatting values, and so on. <br><br>  To solve this problem there are two ways: <br><ol><li>  take advantage of the <em>STI</em> , it directly begs here; </li><li>  use one thick class in which the logic is defined through the <em>case</em> . </li></ol><br>  I don‚Äôt even consider the second option, since  is too bulky and not too flexible.  Therefore, we dwell on the first. <br><br>  And so, to use the <em>STI,</em> you need an additional field that will point to the class.  To alter the scheme is possible, but the redundancy increases, which must be maintained in the correct state.  In the case of the above example, when adding the <em>type</em> field, the field value will have to be synchronized with the foreign key.  Therefore, it would be logical to use the available data.  Since  determining the name of the class occurs before its creation, then you have to interfere with the work of <em>ActiveRecord</em> itself. <br><br>  Digging in the documentation and source code clarified the whole mechanism.  The <em>instantiate</em> method in the <em>ActiveRecord :: Inheritance</em> module is responsible for it: <br><pre><code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># File activerecord/lib/active_record/inheritance.rb, line 61 def instantiate(record) sti_class = find_sti_class(record[inheritance_column]) record_id = sti_class.primary_key &amp;&amp; record[sti_class.primary_key] if ActiveRecord::IdentityMap.enabled? &amp;&amp; record_id instance = use_identity_map(sti_class, record_id, record) else instance = sti_class.allocate.init_with('attributes' =&gt; record) end instance end</span></span></code> </pre> <br>  This method is quite simple: <br><ol><li>  the class to be created is determined; </li><li>  if IdentityMap support is enabled, then we use it, otherwise we create a new instance based on data received from the database. </li></ol><br>  Consider how determined what class should be created.  To do this, we look at the source code further, namely the <em>find_sti_class</em> method <em>,</em> to which the name of the type taken from the field of the corresponding <em>inheritance_column</em> is transferred, by default, as already mentioned earlier, it is equal to <em>type.</em> <br><br>  As you can see there is no special magic.  Therefore, to solve the problem, it was necessary to override the instantiate method so that instead of the value from the field, another one derived from the related table is passed. <br><br>  The resulting solution was designed as a Gem-a.  Works on the same principle as the association.  <i>ActiveRecord</i> extends the additional method <i>acts_as_ati</i> , which has the same syntax as the <i>belongs_to</i> method. <br><br><pre> <code class="ruby hljs">@association_inheritance = { <span class="hljs-symbol"><span class="hljs-symbol">id:</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">field_name:</span></span> params[<span class="hljs-symbol"><span class="hljs-symbol">:field_name</span></span>] <span class="hljs-params"><span class="hljs-params">||</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:name</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">block:</span></span> block_given? ? Proc.new {<span class="hljs-params"><span class="hljs-params">|type|</span></span> <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> type } : Proc.new{ <span class="hljs-params"><span class="hljs-params">|type|</span></span> type }, <span class="hljs-symbol"><span class="hljs-symbol">class_cache:</span></span> {}, <span class="hljs-symbol"><span class="hljs-symbol">alias:</span></span> {} } params.delete <span class="hljs-symbol"><span class="hljs-symbol">:field_name</span></span> @association_inheritance[<span class="hljs-symbol"><span class="hljs-symbol">:association</span></span>] = belongs_to(association_name, params) validates @association_inheritance[<span class="hljs-symbol"><span class="hljs-symbol">:association</span></span>].foreign_key.to_sym, <span class="hljs-symbol"><span class="hljs-symbol">:presence</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span> before_validation <span class="hljs-symbol"><span class="hljs-symbol">:init_type</span></span></code> </pre> <br>  In this method, a hash with auxiliary information on communication is formed, the relation itself and validators are also added.  In addition, the instance is expanded by a number of auxiliary methods + the overload is actually performed. <br><br>  The overloaded method basically does not change, only the receipt of the class name based on the created relationship is added. <br><br><pre> <code class="ruby hljs">params = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.association_inheritance class_type = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> record.is_a? String (params[<span class="hljs-symbol"><span class="hljs-symbol">:alias</span></span>][record.to_s.downcase.to_sym] <span class="hljs-params"><span class="hljs-params">||</span></span> record).to_s.classify <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> association = params[<span class="hljs-symbol"><span class="hljs-symbol">:association</span></span>] type_id = record[association.foreign_key.to_s] params[<span class="hljs-symbol"><span class="hljs-symbol">:class_cache</span></span>][type_id] <span class="hljs-params"><span class="hljs-params">||</span></span>= <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> inheritance_record = association.klass.find(type_id) value = inheritance_record.send(params[<span class="hljs-symbol"><span class="hljs-symbol">:field_name</span></span>].to_sym) value = (params[<span class="hljs-symbol"><span class="hljs-symbol">:alias</span></span>][value.to_s.downcase.to_sym] <span class="hljs-params"><span class="hljs-params">||</span></span> value) value.to_s.classify <span class="hljs-keyword"><span class="hljs-keyword">rescue</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:ActiveRecord</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:RecordNotFound</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> sti_class = find_sti_class(params[<span class="hljs-symbol"><span class="hljs-symbol">:block</span></span>].call(class_type))</code> </pre> <br>  This is where the major changes end.  Using the resulting class, it turned out to implement the <i>STI</i> through a related table.  This approach has a minus in performance (in some places solved by data caching), but it also makes it possible to fully use polymorphism. <br><br>  Usage example: <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostType</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Post</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_accessible</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">acts_as_ati</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class_name</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostType</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreign_key</span></span></span><span class="hljs-class"> =&gt; :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">post_type_id</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">field_name</span></span></span><span class="hljs-class"> =&gt; :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">| "</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{type}Post" end end class ForumPost &lt; Post attr_accessible :name ati_type :forum end class BlogPost &lt; Post attr_accessible :name ati_type :blog end</span></span></span></span></code> </pre> <br>  This solution is used in the work of the internal resource and so far it has shown itself only on the positive side and has made the code more readable and easy to maintain. <br><br>  The gem is not yet hosted on rubygems, but it can be connected via a gemfile: <br> <code>gem 'ext_sti', :git =&gt; 'git://github.com/fuCtor/ext_sti.git'</code> <br>  either as a local copy <br> <code>gem 'ext_sti', :path =&gt; %path_to_ext_sti%</code> </div><p>Source: <a href="https://habr.com/ru/post/151883/">https://habr.com/ru/post/151883/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151875/index.html">Artificial Intelligence in the Mail.ru service</a></li>
<li><a href="../151876/index.html">Russian Code Cup 2012: a detailed analysis of the tasks from the final in pictures, video and examples</a></li>
<li><a href="../151878/index.html">Motorola requests to ban the importation of Apple products in the US (iPhone, iPad and iPod)</a></li>
<li><a href="../151879/index.html">Top 5 most popular CMS: which one to choose?</a></li>
<li><a href="../151882/index.html">RIM and Marmalade joint action for game developers</a></li>
<li><a href="../151884/index.html">Animation with HTML + CSS + JS - Japanese Nissan Note Promotion Site</a></li>
<li><a href="../151885/index.html">Replicator 2: the most advanced desktop 3D printer</a></li>
<li><a href="../151886/index.html">Design android applications in Photoshop</a></li>
<li><a href="../151887/index.html">Variable Numeric Objects</a></li>
<li><a href="../151890/index.html">Neurobiology and artificial intelligence: part two - intelligence and presentation of information in the brain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>