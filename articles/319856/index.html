<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Trucks and refrigerators in the cloud</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we would like to share with you the story of creating a basic prototype of the gateway and transferring it to the Microsoft Azure clo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Trucks and refrigerators in the cloud</h1><div class="post__text post__text-html js-mediator-article">  In this article, we would like to share with you the story of creating a basic prototype of the gateway and transferring it to the <a href="https://azure.microsoft.com/ru-ru/free/%3Fwt.mc_id%3DAID570629_QSG_BLOG_139069">Microsoft Azure</a> cloud platform using the Software as a Service (SaaS) model. <br><br><img src="https://habrastorage.org/files/1bc/df2/4c6/1bcdf24c6beb4b3d9c3bb7b7dd74ba13.jpg"><br><a name="habracut"></a><br>  In order to make it clear what will be discussed below - a little help: <br><br><ul><li>  <b><a href="https://aka.ms/habr_319856_1">Quarta Technologies</a></b> is a supplier of solutions in the field of basic IT infrastructure and the leader of the Russian IT market in the field of complete information and technical support of technologies for embedded systems based on Microsoft Windows Embedded. </li><li>  <b><a href="https://aka.ms/habr_319856_2">TechnoCom</a></b> works in the development and production of GLONASS / GPS satellite monitoring systems for vehicles, personnel, fuel sensors and software for any companies and sectors of transport, industry and agriculture.  The most famous product of the company is the navigation terminals of the series ‚ÄúAutoGRAPH‚Äù. </li><li>  <b><a href="https://aka.ms/habr_319856_3">iQFreeze</a></b> is a solution from Quart Technology that collects, processes and transmits information about the status of cargo and transport in real time. </li></ul><br><h2>  Creating a basic prototype gateway </h2><br>  The AutoGRAPH system is a classic client-server application with data access and analytics capabilities.  Its current architecture makes it costly to scale.  That is why the key idea for collaboration was an attempt to rethink the architecture, bringing it to the SaaS model to solve scalability problems and create innovative supply for the market. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/99c/a4b/8db/99ca4b8dbb7e4c2bae41d825a547385e.jpg"><br><br>  Before the start of the project, it was obvious that carrying out technological interaction in the Internet of Things paradigm can be a very difficult task, as it includes, in addition to integrating Azure services into already existing software, issues related to obtaining data from the equipment installed on the transport satellite AutoGRAPH transport monitoring (hereinafter referred to as the ‚ÄúSMT terminals‚Äù).  And only appropriate training greatly simplifies the task.  Therefore, preparation began about a month before the event itself.  As a result, several key questions were discussed, which are listed below with the answers to them. <br><br>  <b>Has the system been commissioned?</b>  <b>What condition do devices have, what can they do and what can't they do?</b> <br><br>  Today the system works for several years.  Since it was intended for use with vehicles from different manufacturers / partners, there are differences in equipment.  Almost all devices are similar only in one thing - changing the firmware even on a small number of them is not possible because of their work in a productive environment.  For this reason, the use of the Field Gateway model (placing or installing a gateway close to devices) is impossible. <br><br>  <b>What protocol do devices use to communicate with the server?</b> <br><br>  Binary protocol proprietary company TehnoKom. <br><br>  <b>Is it possible to create a new version of the server part without disturbing the processes taking place and redirect them there from the old version?</b> <br><br>  Difficult, but real.  But since such an approach requires serious and long-term testing and development, it was decided to exclude it from this iteration. <br><br>  <b>Do I need to control devices remotely?</b> <br><br>  Perhaps in the future, but not now. <br><br>  In the planning process, it was decided to expand the list of tasks in connection with the addition of components to the system for processing the collected data.  Accordingly, the current monolithic architecture should have been broken into modules.  An incoming stream of data from AutoGRAPH was organized, so questions regarding device emulation were closed. <br><br>  For hosting a gateway that listens on a TCP port and sends data to the data processing subsystem, the <a href="https://aka.ms/habr_319856_4">Microsoft Azure Cloud Services</a> cloud service was chosen. <br><br>  In order to implement the prototype, the team had 5 hours and 3 developers for 6 tasks: <br><br><ol><li>  Evaluate the current architecture and rethink it using PaaS. </li><li>  Implement a test gateway (console application) for testing. </li><li>  Evaluate existing options for creating a cloud gateway (for example, Azure IoT Gateway, Cloud Services, and so on). </li><li>  Migrate the gateway to the cloud. </li><li>  Connect the gateway with the data processing subsystem (that is, write code for this). </li><li>  Add monitoring capabilities to your prototype using Application Insights. </li></ol><br>  Initially we decided to focus on the question of how to break a monolithic application into components. <br><br><h4>  Architecture to </h4><br>  The old architecture was a classic two-tier client-server architecture, a monolithic application written in C ++ and running in the Windows Server environment.  His job was to receive data packets from a monitoring system installed on devices, save these packets to local storage and be a front-end for data access for external users.  Inside the application there were several modules: network, data storage, data decryption and work with the database. <br><br>  Data between the server and devices was transmitted via a proprietary binary TCP protocol.  To establish a connection, the client sends a handshake-packet, the server had to respond to it with a confirmation packet. <br><br><img src="https://habrastorage.org/files/00f/124/a7f/00f124a7fcc04b6abb4ef210f166ad87.png"><br><br>  In its work, the application used a set of Win32API system calls.  Data is stored in binary form as files. <br><br>  The problem of scaling this lies in the limited means of implementation: increasing server resources / adding new ones and setting up a load balancer and performing other tasks. <br><br><h4>  Architecture after </h4><br>  After the application of the new architecture, the application lost its relevance, since in fact it was a gateway and performed several office tasks (for example, to save data without changing it).  In the new architecture, all this was replaced by <a href="https://azure.microsoft.com/ru-ru/free/%3Fwt.mc_id%3DAID570629_QSG_BLOG_139069">Azure</a> services (the developers evaluated which option is better to choose: Azure IoT Gateway or a self-written gateway; and chose the second option with hosting in Azure Cloud Services). <br><br><img src="https://habrastorage.org/files/af4/223/7b7/af42237b7c8b48e7a218206927ba8de4.png"><br><br>  The principles of operation of the new system are similar to the principles of the old, but provide additional opportunities for scaling (including automatic) and remove infrastructure tasks, for example, to configure the load balancer.  Several instances (instances) of the Cloud Service with the gateway listen on a special port, connect devices and transfer data to the processing subsystem. <br><br><h2>  Migrating the prototype to the Microsoft Azure cloud platform using the Software as a Service (SaaS) model </h2><br>  It is important to start with small steps and not implement everything at once in the cloud.  The cloud has its advantages and features that may complicate prototyping (for example, opening ports, debugging a remote project, deployment, and so on).  Therefore, in this case, the first stage of development was to create a local version of the gateway: <br><br><ul><li>  The gateway listens to the TCP port and initiates a connection when it receives a handshake packet from the device. </li><li>  The gateway responds with an ACK packet and establishes a connection.  When receiving data packets, according to the specification, these packets are decomposed into ready-made content. </li><li>  The gateway forwards the data further. </li></ul><br>  In the process of creating a prototype, a problem arose - the developers worked in the Microsoft office, where the network security perimeter has a certain number of different kinds of policies, which could lead to the complication of prototyping the local gateway.  Since there was no opportunity to change policies, the team used <a href="https://ngrok.com/">ngrok</a> , which allows you to create a secure tunnel on localhost. <br><br>  During development, there were several other issues that were decided to work out deeper - writing to the local storage, getting the address and ports of the instance on which the gateway works.  Since many variables in the cloud change dynamically, it was important to resolve these issues before proceeding to the next stage. <br><br><h4>  Record on local storage Cloud Service </h4><br>  Of course, compared to local storage of data on the instance, <a href="https://azure.microsoft.com/ru-ru/free/%3Fwt.mc_id%3DAID570629_QSG_BLOG_139069">Azure</a> has better ways to store information, but the old architecture meant local storage, so it was necessary to check whether the system can work in this mode.  By default, everything that works in the Cloud Service does not have access to the file system - that is, it is not possible to simply capture and write information to c: / temp.  Since this is PaaS, you need to set up a special space called Local Storage in the cloud service configuration and set the cleanOnRoleRecycle flag, which with a certain degree of confidence ensures that information from the local storage will not be deleted when the role is restarted.  Below is the code that was used to solve this problem. <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> string azureLocalResourceNameFromServiceDefinition = <span class="hljs-string"><span class="hljs-string">"LocalStorage1"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> azureLocalResource = RoleEnvironment.GetLocalResource(azureLocalResourceNameFromServiceDefinition); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filepath = azureLocalResource.RootPath + <span class="hljs-string"><span class="hljs-string">"telemetry.txt"</span></span>; Byte[] bytes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Byte[<span class="hljs-number"><span class="hljs-number">514</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> data = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { TcpClient client = server.AcceptTcpClient(); data = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; int i; NetworkStream stream = client.GetStream(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((i = stream.Read(bytes, <span class="hljs-number"><span class="hljs-number">0</span></span>, bytes.Length)) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { ‚Ä¶ System.IO.File.AppendAllText(filepath, BitConverter.ToString(bytes)); ‚Ä¶ } client.Close(); }</code> </pre> <br>  After testing, it turned out that the data remains in the repository, so it can be a good way to store temporary data. <br><br><h4>  Obtain an instance address and port </h4><br>  In order to get data at runtime, you must define the Endpoint inside the configuration of the cloud service and access it in code. <br><br><img src="https://habrastorage.org/files/5ee/a99/9a5/5eea999a52f74745ad7370da2b7643fc.png"><br><br><pre> <code class="javascript hljs">IPEndPoint instEndpoint = RoleEnvironment.CurrentRoleInstance.InstanceEndpoints\[<span class="hljs-string"><span class="hljs-string">"TCPEndpoint"</span></span>\].IPEndpoint; IPAddress localAddr = IPAddress.Parse(instEndpoint.Address.ToString()); TcpListener server = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TcpListener(localAddr, instEndpoint.Port);</code> </pre> <br>  Now the automatically configured load balancer will manage requests between instances, the developer can scale the number of these instances, with each instance will receive the necessary data in runtime. <br><br>  So, the local gateway was launched and tested on Cloud Services (which can be emulated locally), now it is the turn to deploy the project to the cloud.  The Visual Studio Toolkit allows you to do this in a few clicks. <br><br><img src="https://habrastorage.org/files/8b9/34b/48f/8b934b48f1fb4752b5b359a2ab9cb1da.png"><br><br>  The issue of further data transfer from the gateway instance was successfully closed using official code samples. <br><br><h2>  findings </h2><br>  When planning, the team was worried that one day would not be enough to develop a working prototype of the system, especially in the presence of various environments, devices and requirements (outdated devices, protocols, monolithic C ++ application).  Something really did not have time to do, but the basic prototype was created and worked. <br><br>  Using the PaaS model for this kind of task is a great way: <br><ul><li>  Rapid prototyping solutions. </li><li>  Using services and settings to make a solution scalable and flexible from the very beginning. </li></ul><br>  In just a few hours, it was possible to create a basis for developing an end-to-end solution in the IoT paradigm using real data.  Future plans include using machine learning to take greater advantage of the data, migrate to a new protocol, and test the solution on the Azure Service Fabric platform. <br><br>  <i>Thank you for participating in the creation of the material by <a href="https://aka.ms/habr_319856_5">Alexander Belotserkovsky</a> and the team of Quart Technology.</i> </div><p>Source: <a href="https://habr.com/ru/post/319856/">https://habr.com/ru/post/319856/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319836/index.html">ExBB - PHP File Forum</a></li>
<li><a href="../319838/index.html">As I in one team did a redesign of a web product (cases!)</a></li>
<li><a href="../319848/index.html">"Ultimate DNS Digest": 45 materials from Habr and other resources</a></li>
<li><a href="../319852/index.html">Java examples from books and documentation</a></li>
<li><a href="../319854/index.html">"I learned something - try to explain it until you understand it yourself"</a></li>
<li><a href="../319858/index.html">dock: a simple library of unit testing C ++ code</a></li>
<li><a href="../319860/index.html">Bitcoin in a nutshell - Transaction</a></li>
<li><a href="../319862/index.html">Bitcoin in a nutshell - Protocol</a></li>
<li><a href="../319864/index.html">One of the easiest ways to improve your programming skills is to read someone else's code.</a></li>
<li><a href="../319866/index.html">Interesting in March: DevOpsDays in Moscow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>