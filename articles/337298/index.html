<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>In the wake of highloadcup: php vs node.js vs go, swoole vs workerman, splfixedarray vs array and more</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The story about how I participated in highloadcup ( championship for backend-developers ) from Mail.Ru, wrote a server serving 10,000 RPS on php, but ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>In the wake of highloadcup: php vs node.js vs go, swoole vs workerman, splfixedarray vs array and more</h1><div class="post__text post__text-html js-mediator-article">  The story about how I participated in highloadcup ( <a href="https://habrahabr.ru/company/mailru/blog/335384/">championship for backend-developers</a> ) from Mail.Ru, wrote a server serving 10,000 RPS on php, but still did not receive a winning T-shirt. <br><br><img src="https://habrastorage.org/web/a72/675/1fc/a726751fc2dd4d1bbc55b20525b0f911.png"><br><a name="habracut"></a><br><h2>  Introduction </h2><br>  So let's start with a t-shirt.  I had to write my decision before the first of September, and I only added the sixth. <br><br>  On the first of September the results were summed up, the places were distributed, and all those who did it in a thousand seconds were promised t-shirts.  After that, the organizers allowed another week to improve their decisions, but without prizes.  This time I used to rewrite my decision (in fact, I did not have enough just a couple of nights).  Actually I don‚Äôt put on a T-shirt, but sorry :( 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      During my previous article, I compared the <a href="https://habrahabr.ru/post/331462/">libraries in php to create a web socket server,</a> then they recommended the swoole library to me - it is written in C ++ and installed from pecl.  By the way, all these libraries can be used not only to create a server web socket, but they are also suitable just for the http server.  This is what I decided to use. <br><br>  I took the swoole library, created a sqlite database in memory and immediately went up to the top twenty with a score of 159 seconds, then I was dismissed, I added the cache and reduced the time to 79 seconds, got back to the twenty, I was dismissed, rewritten from sqlite to swoole_table and reduced the time to 47 seconds.  Of course, I was far from the top places, but I managed to get around my few friends with the Go solution in the table. <br><br>  This is the old rating table now: <br><br><img src="https://habrastorage.org/web/340/0e3/af5/3400e3af5135472f949dea1cc6df7f90.png"><br><br>  A little praise for Mail.Ru and you can go further. <br><br>  Thanks to this wonderful championship, I became more closely acquainted with the libraries swoole, workerman, learned how to better optimize php under high loads, learned how to use the yandex tank and much more.  Continue to organize such championships, competition encourages the study of new information and leveling skills. <br><br><h2>  php vs node.js vs go </h2><br>  For a start, I took swool, because it is written in C ++ and should definitely work faster than workerman, which is written in php. <br><br>  I wrote hello world code: <br><br><pre><code class="php hljs">$server = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Swoole\Http\Server(<span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span>, <span class="hljs-number"><span class="hljs-number">1080</span></span>); $server-&gt;set([<span class="hljs-string"><span class="hljs-string">'worker_num'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>,]); $server-&gt;on(<span class="hljs-string"><span class="hljs-string">'Request'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($req, $res)</span></span></span><span class="hljs-function"> </span></span>{$res-&gt;end(<span class="hljs-string"><span class="hljs-string">'hello world'</span></span>);}); $server-&gt;start();</code> </pre> <br>  I launched Apache Benchmark, a Linux console utility that makes 10k requests in 10 threads: <br><br><pre> <code class="plaintext hljs">ab -c 10 -n 10000 http://127.0.0.1:1080/</code> </pre> <br>  and received a response time of <b>0.17 ms</b> <br><br>  After that I wrote an example on workerman: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> DIR . <span class="hljs-string"><span class="hljs-string">'/vendor/autoload.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Workerman</span></span>\<span class="hljs-title"><span class="hljs-title">Worker</span></span>; $http_worker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Worker(<span class="hljs-string"><span class="hljs-string">"http://0.0.0.0:1080"</span></span>); $http_worker-&gt;count = <span class="hljs-number"><span class="hljs-number">1</span></span>; $http_worker-&gt;onMessage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($conn, $data)</span></span></span><span class="hljs-function"> </span></span>{$conn-&gt;send(<span class="hljs-string"><span class="hljs-string">"hello world"</span></span>);}; Worker::runAll();</code> </pre> <br>  and got <b>0.43 ms</b> , i.e.  the result is 3 times worse. <br>  But I did not give up, I installed the event library: <br><br><pre> <code class="plaintext hljs">pecl install event</code> </pre>  added to the code: <br><br><pre> <code class="plaintext hljs">Worker::$eventLoopClass = '\Workerman\Events\Ev';</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Summary code</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> DIR . <span class="hljs-string"><span class="hljs-string">'/vendor/autoload.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Workerman</span></span>\<span class="hljs-title"><span class="hljs-title">Worker</span></span>; Worker::$eventLoopClass = <span class="hljs-string"><span class="hljs-string">'\Workerman\Events\Ev'</span></span>; $http_worker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Worker(<span class="hljs-string"><span class="hljs-string">"http://0.0.0.0:1080"</span></span>); $http_worker-&gt;count = <span class="hljs-number"><span class="hljs-number">1</span></span>; $http_worker-&gt;onMessage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($conn, $data)</span></span></span><span class="hljs-function"> </span></span>{$conn-&gt;send(<span class="hljs-string"><span class="hljs-string">"hello world"</span></span>);}; Worker::runAll();</code> </pre> </div></div><br>  Measurements showed <b>0.11 ms</b> , i.e.  workerman written in php and using libevent began to work faster than swoole written in C ++.  I read tons of documentation in Chinese using GoogleTranslate.  But found nothing.  By the way, both libraries are written by the Chinese and comments on the Chinese in the library code for them - ... <br><br><div class="spoiler">  <b class="spoiler_title">Normal practice</b> <div class="spoiler_text">  <b>swoole:</b> <br><br><img src="https://habrastorage.org/web/e5e/5fe/97e/e5e5fe97efcc42dc8699109dc9426d9b.png"><br><br>  <b>workerman:</b> <br><br><img src="https://habrastorage.org/web/0e3/67c/a60/0e367ca6050045bfae121e30ef07d120.png"><br><br>  <b>The first version of my <a href="https://github.com/morozovsk/websocket/">library for web sockets</a> :</b> <br><br><img src="https://habrastorage.org/web/8df/0de/be8/8df0debe8ce14c0e939156e0021cc5e7.png"><br></div></div><br>  Now I understand how the Chinese felt when they read my code. <br><br>  I started the swoole gitkhab with the question of how this can happen. <br><br>  There I was recommended to use: <br><br><pre> <code class="plaintext hljs">$serv = new Swoole\Http\Server('0.0.0.0', 1080, SWOOLE_BASE);</code> </pre> <br>  instead: <br><br><pre> <code class="plaintext hljs">$serv = new Swoole\Http\Server('0.0.0.0', 1080);</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Summary code</b> <div class="spoiler_text"><pre> <code class="php hljs">$serv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Swoole\Http\Server(<span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span>, <span class="hljs-number"><span class="hljs-number">1080</span></span>, SWOOLE_BASE); $serv-&gt;set([<span class="hljs-string"><span class="hljs-string">'worker_num'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>,]); $serv-&gt;on(<span class="hljs-string"><span class="hljs-string">'Request'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($req, $res)</span></span></span><span class="hljs-function"> </span></span>{$res-&gt;end(<span class="hljs-string"><span class="hljs-string">'hello world'</span></span>);}); $serv-&gt;start();</code> </pre> <br></div></div><br>  I took their advice and received <b>0.10 ms</b> , i.e.  slightly faster than workerman. <br><br>  At this point, I already had a ready application for php, which I did not already know how to optimize, it was responsible for <b>0.12 ms</b> and decided to rewrite the application to something else. <br><br>  I tried <b>node.js</b> : <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ res.writeHead(<span class="hljs-number"><span class="hljs-number">200</span></span>); res.end(<span class="hljs-string"><span class="hljs-string">'hello world'</span></span>); }); server.listen(<span class="hljs-number"><span class="hljs-number">1080</span></span>);</code> </pre> <br>  Received <b>0.15 ms</b> , i.e.  0.03 ms less than my finished php application <br><br>  I took <b>fasthttp to go</b> and got <b>0.08 ms</b> : <br><br><div class="spoiler">  <b class="spoiler_title">Hello world on fasthttp</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"flag"</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"log"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/valyala/fasthttp"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( addr = flag.String(<span class="hljs-string"><span class="hljs-string">"addr"</span></span>, <span class="hljs-string"><span class="hljs-string">":1080"</span></span>, <span class="hljs-string"><span class="hljs-string">"TCP address to listen to"</span></span>) compress = flag.Bool(<span class="hljs-string"><span class="hljs-string">"compress"</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"Whether to enable transparent response compression"</span></span>) ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { flag.Parse() h := requestHandler <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> *compress { h = fasthttp.CompressHandler(h) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := fasthttp.ListenAndServe(*addr, h); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Fatalf(<span class="hljs-string"><span class="hljs-string">"Error in ListenAndServe: %s"</span></span>, err) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx *fasthttp.RequestCtx)</span></span></span></span> { fmt.Fprintf(ctx, <span class="hljs-string"><span class="hljs-string">"Hello, world!"</span></span>) }</code> </pre> </div></div><br>  Summary table ( <a href="https://github.com/morozovsk/webserver-performance-comparison">table and all tests published on github</a> ): <br><br> <a href="https://github.com/morozovsk/webserver-performance-comparison"><img src="https://habrastorage.org/web/70b/29f/fdc/70b29ffdca314b2c9f8c48c8b3e9bcb7.png"></a> <br><br><h2>  splfixedarray vs array </h2><br>  A week before the end of the contest, the conditions were a little more complicated: <br><br><ul><li>  the amount of data increased 10 times </li><li>  the number of requests per second increased 10 times </li></ul><br>  The data structure to be stored is 3 tables: users (1kk), locations (1kk) and visits (11kk). <br><br><div class="spoiler">  <b class="spoiler_title">Field description</b> <div class="spoiler_text"><blockquote>  <b>User:</b> <br>  <b>id</b> is a unique external user id.  It is installed by the testing system and is used to verify server responses.  A 32-bit unsigned integer. <br>  <b>email</b> - user email address.  Type - unicode string up to 100 characters.  Unique field. <br>  <b>First_name</b> and <b>last_name</b> are the first and last names, respectively.  Type - unicode strings up to 50 characters. <br>  <b>gender</b> - unicode string m means male gender, and f - female. <br>  <b>birth_date</b> is the date of birth, recorded as the number of seconds from the beginning of the UNIX epoch UTC (in other words, this is the timestamp). <br><br>  <b>Location (Landmark):</b> <br>  <b>id</b> is a unique external id of a landmark.  Installed by the testing system.  A 32-bit unsigned integer. <br>  <b>place</b> - description of the sight.  Text field of unlimited length. <br>  <b>country</b> - the name of the country of location.  Unicode string up to 50 characters. <br>  <b>city</b> - the name of the city location.  Unicode string up to 50 characters. <br>  <b>distance</b> - distance from the city in a straight line in kilometers.  A 32-bit unsigned integer. <br><br>  <b>Visit (Visit):</b> <br>  <b>id</b> is the unique external id of the visit.  A 32-bit integer unsigned integer. <br>  <b>location</b> - id sights.  A 32-bit unsigned integer. <br>  <b>user</b> - traveler id.  A 32-bit unsigned integer. <br>  <b>visited_at</b> - date of visit, timestamp. <br>  <b>mark</b> - visit score from 0 to 5 inclusive.  Integer. </blockquote></div></div><br>  My solution has ceased to fit into the 4GB allocated for it.  I had to look for options. <br>  For a start, I had to fill 11 million entries into memory from json files. <br><br>  I tried <b>swoole_table</b> , measured memory consumption - <b>2200 MB</b> <br><br><div class="spoiler">  <b class="spoiler_title">Data Load Code</b> <div class="spoiler_text"><pre> <code class="php hljs">$visits = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> swoole_table(<span class="hljs-number"><span class="hljs-number">11000000</span></span>); $visits-&gt;column(<span class="hljs-string"><span class="hljs-string">'id'</span></span>, swoole_table::TYPE_INT); $visits-&gt;column(<span class="hljs-string"><span class="hljs-string">'user'</span></span>, swoole_table::TYPE_INT); $visits-&gt;column(<span class="hljs-string"><span class="hljs-string">'location'</span></span>, swoole_table::TYPE_INT); $visits-&gt;column(<span class="hljs-string"><span class="hljs-string">'mark'</span></span>, swoole_table::TYPE_INT); $visits-&gt;column(<span class="hljs-string"><span class="hljs-string">'visited_at'</span></span>, swoole_table::TYPE_INT); $visits-&gt;create(); $i = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($visitsData = @file_get_contents(<span class="hljs-string"><span class="hljs-string">"data/visits_$i.json"</span></span>)) { $visitsData = json_decode($visitsData, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($visitsData[<span class="hljs-string"><span class="hljs-string">'visits'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $k =&gt; $row) { $visits-&gt;set($row[<span class="hljs-string"><span class="hljs-string">'id'</span></span>], $row); } $i++; } <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($visitsData); gc_collect_cycles(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'memory: '</span></span> . intval(memory_get_usage() / <span class="hljs-number"><span class="hljs-number">1000000</span></span>) . <span class="hljs-string"><span class="hljs-string">"\n"</span></span>;</code> </pre> </div></div><br>  I tried <b>an associative array</b> , memory consumption is much more - <b>6057 MB</b> <br><br><div class="spoiler">  <b class="spoiler_title">Data Load Code</b> <div class="spoiler_text"><pre> <code class="php hljs">$visits = []; $i = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($visitsData = @file_get_contents(<span class="hljs-string"><span class="hljs-string">"data/visits_$i.json"</span></span>)) { $visitsData = json_decode($visitsData, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($visitsData[<span class="hljs-string"><span class="hljs-string">'visits'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $k =&gt; $row) { $visits[$row[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]] = $row; } $i++;<span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"$i\n"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($visitsData); gc_collect_cycles(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'memory: '</span></span> . intval(memory_get_usage() / <span class="hljs-number"><span class="hljs-number">1000000</span></span>) . <span class="hljs-string"><span class="hljs-string">"\n"</span></span>;</code> </pre> </div></div><br>  I tried SplFixedArray, the memory consumption is a bit smaller than that of a regular array - <b>5696 MB</b> <br><br><div class="spoiler">  <b class="spoiler_title">Data Load Code</b> <div class="spoiler_text"><pre> <code class="php hljs">$visits = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SplFixedArray(<span class="hljs-number"><span class="hljs-number">11000000</span></span>); $i = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($visitsData = @file_get_contents(<span class="hljs-string"><span class="hljs-string">"data/visits_$i.json"</span></span>)) { $visitsData = json_decode($visitsData, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($visitsData[<span class="hljs-string"><span class="hljs-string">'visits'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $k =&gt; $row) { $visits[$row[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]] = $row; } $i++;<span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"$i\n"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($visitsData); gc_collect_cycles(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'memory: '</span></span> . intval(memory_get_usage() / <span class="hljs-number"><span class="hljs-number">1000000</span></span>) . <span class="hljs-string"><span class="hljs-string">"\n"</span></span>;</code> </pre> </div></div><br>  I decided to save individual properties of the visit to hotel arrays, because text keys can take up a lot of space in memory, i.e.  changed this code: <br><br><pre> <code class="php hljs">$visits[<span class="hljs-number"><span class="hljs-number">1</span></span>] = [<span class="hljs-string"><span class="hljs-string">'user'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">153</span></span>, <span class="hljs-string"><span class="hljs-string">'location'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">17</span></span>, <span class="hljs-string"><span class="hljs-string">'mark'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">'visited_at'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1503695452</span></span>];</code> </pre> <br>  on this: <br><br><pre> <code class="php hljs">$visits_user[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">153</span></span>; $visits_location[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">17</span></span>; $visits_mark[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">5</span></span>; $visits_visited_at[<span class="hljs-number"><span class="hljs-number">1</span></span>] =&gt; <span class="hljs-number"><span class="hljs-number">1503695452</span></span>;</code> </pre> <br>  memory consumption when <b>dividing a three-dimensional array into two-dimensional</b> was <b>2147 MB</b> , i.e.  3 times less.  So  the names of the keys in the three-dimensional array ate 2/3 of all the memory they occupied. <br><br><div class="spoiler">  <b class="spoiler_title">Data Load Code</b> <div class="spoiler_text"><pre> <code class="php hljs">$user = $location = $mark = $visited_at = []; $i = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($visitsData = @file_get_contents(<span class="hljs-string"><span class="hljs-string">"data/visits_$i.json"</span></span>)) { $visitsData = json_decode($visitsData, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($visitsData[<span class="hljs-string"><span class="hljs-string">'visits'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $k =&gt; $row) { $user[$row[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]] = $row[<span class="hljs-string"><span class="hljs-string">'user'</span></span>]; $location[$row[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]] = $row[<span class="hljs-string"><span class="hljs-string">'location'</span></span>]; $mark[$row[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]] = $row[<span class="hljs-string"><span class="hljs-string">'mark'</span></span>]; $visited_at[$row[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]] = $row[<span class="hljs-string"><span class="hljs-string">'visited_at'</span></span>]; } $i++;<span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"$i\n"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($visitsData); gc_collect_cycles(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'memory: '</span></span> . intval(memory_get_usage() / <span class="hljs-number"><span class="hljs-number">1000000</span></span>) . <span class="hljs-string"><span class="hljs-string">"\n"</span></span>;</code> </pre> </div></div><br>  I decided to use <b>a three-dimensional array partitioning with SplFixedArray</b> and the memory consumption dropped another 3 times to <b>704 MB.</b> <br><br><div class="spoiler">  <b class="spoiler_title">Data Load Code</b> <div class="spoiler_text"><pre> <code class="php hljs">$user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SplFixedArray(<span class="hljs-number"><span class="hljs-number">11000000</span></span>); $location = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SplFixedArray(<span class="hljs-number"><span class="hljs-number">11000000</span></span>); $mark = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SplFixedArray(<span class="hljs-number"><span class="hljs-number">11000000</span></span>); $visited_at = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SplFixedArray(<span class="hljs-number"><span class="hljs-number">11000000</span></span>); $user_visits = []; $location_visits = []; $i = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($visitsData = @file_get_contents(<span class="hljs-string"><span class="hljs-string">"data/visits_$i.json"</span></span>)) { $visitsData = json_decode($visitsData, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($visitsData[<span class="hljs-string"><span class="hljs-string">'visits'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $k =&gt; $row) { $user[$row[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]] = $row[<span class="hljs-string"><span class="hljs-string">'user'</span></span>]; $location[$row[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]] = $row[<span class="hljs-string"><span class="hljs-string">'location'</span></span>]; $mark[$row[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]] = $row[<span class="hljs-string"><span class="hljs-string">'mark'</span></span>]; $visited_at[$row[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]] = $row[<span class="hljs-string"><span class="hljs-string">'visited_at'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($user_visits[$row[<span class="hljs-string"><span class="hljs-string">'user'</span></span>]])) { $user_visits[$row[<span class="hljs-string"><span class="hljs-string">'user'</span></span>]][] = $row[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $user_visits[$row[<span class="hljs-string"><span class="hljs-string">'user'</span></span>]] = [$row[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]]; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($location_visits[$row[<span class="hljs-string"><span class="hljs-string">'location'</span></span>]])) { $location_visits[$row[<span class="hljs-string"><span class="hljs-string">'location'</span></span>]][] = $row[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $location_visits[$row[<span class="hljs-string"><span class="hljs-string">'location'</span></span>]] = [$row[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]]; } } $i++;<span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"$i\n"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($visitsData); gc_collect_cycles(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'memory: '</span></span> . intval(memory_get_usage() / <span class="hljs-number"><span class="hljs-number">1000000</span></span>) . <span class="hljs-string"><span class="hljs-string">"\n"</span></span>;</code> </pre> </div></div><br>  For the sake of interest I tried the same thing on <b>node.js</b> and got <b>780 MB</b> <br><br><div class="spoiler">  <b class="spoiler_title">Data Load Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); global.visits = []; global.users_visits = []; global.locations_visits = []; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> visitsData; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (fs.existsSync(<span class="hljs-string"><span class="hljs-string">`data/visits_</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${i}</span></span></span><span class="hljs-string">.json`</span></span>) &amp;&amp; (visitsData = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(fs.readFileSync(<span class="hljs-string"><span class="hljs-string">`data/visits_</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${i}</span></span></span><span class="hljs-string">.json`</span></span>, <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>)))) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (y = <span class="hljs-number"><span class="hljs-number">0</span></span>; y &lt; visitsData.visits.length; y++) { <span class="hljs-comment"><span class="hljs-comment">//visits[visitsData.visits[y]['id']] = visitsData.visits[y]; visits[visitsData.visits[y]['id']] = { user:visitsData.visits[y].user, location:visitsData.visits[y].location, mark:visitsData.visits[y].mark, visited_at:visitsData.visits[y].visited_at, //id:visitsData.visits[y].id, }; } i++; } global.gc(); console.log("memory usage: " + parseInt(process.memoryUsage().heapTotal/1000000));</span></span></code> </pre> </div></div><br>  Summary table ( <a href="https://github.com/morozovsk/php-arrays-in-memory-comparison">table and all tests published on github</a> ): <br><br> <a href="https://github.com/morozovsk/php-arrays-in-memory-comparison"><img src="https://habrastorage.org/web/c79/479/bbf/c79479bbf93d4a9a98210dce17b2bae6.png"></a> <br><br>  I wanted to try apc_cache and redis, but they still have additional memory spent on storing the names of the keys.  In real life, you can use, but for this championship in general is not an option. <br><br><h2>  Afterword </h2><br>  After all the optimizations, the total time was 404 seconds, which is almost 4 times slower than the first place. <br><br>  Thanks again to the organizers who didn‚Äôt sleep at night, reloaded the hung containers, fixed bugs, finished the site, answered questions in a telegram. <br><br>  The actual summary tables and a similar code for all tests are published on the githaba: <br>  <a href="https://github.com/morozovsk/webserver-performance-comparison">comparing the speed of different webservers</a> <br>  <a href="https://github.com/morozovsk/php-arrays-in-memory-comparison">comparison of memory consumption by different structures</a> <br><br>  My other today's article on Habr√©: a <a href="https://habrahabr.ru/post/332130/">free server in the cloud</a> </div><p>Source: <a href="https://habr.com/ru/post/337298/">https://habr.com/ru/post/337298/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337286/index.html">Why do you need BEM</a></li>
<li><a href="../337288/index.html">Using the KOMPAS-3D API ‚Üí Lesson 4 ‚Üí Title bar</a></li>
<li><a href="../337290/index.html">Fedora Linux is banned for distribution in the Crimea (and temporarily broken DNS)</a></li>
<li><a href="../337292/index.html">Custom properties</a></li>
<li><a href="../337294/index.html">About distinguishing objects by color</a></li>
<li><a href="../337300/index.html">V8 internal mechanisms and fast work with object properties</a></li>
<li><a href="../337302/index.html">git rebase for beginners</a></li>
<li><a href="../337304/index.html">Ransomware hackers hacked more than 26,000 MongoDB servers</a></li>
<li><a href="../337306/index.html">Docker Basics in X hours and Y days</a></li>
<li><a href="../337308/index.html">Lannisters always pay their debts! (and technical too)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>