<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Gitlab-ci</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. 
 We do not have many tasks that require a full CI. For some time, we used Jenkins as a CI service. Everything is pretty obvious there, it is s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Gitlab-ci</h1><div class="post__text post__text-html js-mediator-article"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/files/d83/293/edf/d83293edf85346cc80b3e4c830d3bea1.png"></div><p></p><br><br>  Hello. <br>  We do not have many tasks that require a full CI.  For some time, we used Jenkins as a CI service.  Everything is pretty obvious there, it is simple and flexible to configure, has a bunch of plug-ins, but a couple of times we ran into OOM killer agents on weak machines and decided to consider Gitlab CI as a CI service, because we like experiments and especially in the comments to our last article asked such a question. <br><a name="habracut"></a><br><br><h2>  Installing GitLab-CE </h2>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It's all pretty trivial, <a href="http://docs.gitlab.com/omnibus/">because</a> there is an <a href="http://docs.gitlab.com/omnibus/">Omnibus package</a> . <br><br>  Install and run the necessary packages: <br><br><pre><code class="bash hljs">sudo yum install curl openssh-server openssh-clients postfix cronie sudo service postfix start sudo chkconfig postfix on</code> </pre> <br><br>  Install Gitlab-CE: <br><br><pre> <code class="bash hljs">curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash sudo yum install gitlab-ce</code> </pre><br><br>  Configure and run Gitlab-CE: <br><br><pre> <code class="bash hljs">sudo gitlab-ctl reconfigure</code> </pre><br><br><h2>  Runner installation </h2><br><br>  GitLab Runner is an agent that actually executes instructions from a special .gitlab-ci.yml file. <br>  Unlike the Jenkins gitlab runners are written in Go, so they are very small and fast.  And they can run tasks in completely different ways: locally, in docker-containers, in different clouds or via ssh-connection to any server.  Details, as always, <a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner">in the documentation.</a> <br><br>  Someone in the comments to the last article asked to consider Gitlab for testing ansible-playbooks, and take it. <br>  To ensure the identity of the testing and production environments, we will use Docker. <br><br>  For the runner to work in Docker - first you need to install docker: <br><pre> <code class="bash hljs">curl -sSL https://get.docker.com/ | sh</code> </pre><br><br>  Runner installation <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  Debian/Ubuntu curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-ci-multi-runner/script.deb.sh | sudo bash #  RHEL/CentOS curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-ci-multi-runner/script.rpm.sh | sudo bash</span></span></code> </pre><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  Debian/Ubuntu sudo apt-get install gitlab-ci-multi-runner #  RHEL/CentOS sudo yum install gitlab-ci-multi-runner</span></span></code> </pre><br><br>  Setting up and connecting runner to CI-service: <br><br><pre> <code class="bash hljs">sudo gitlab-ci-multi-runner register Please enter the gitlab-ci coordinator URL (eg https://gitlab.com/ci ) http://domain.example.com/ci Please enter the gitlab-ci token <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> this runner bQ0nvkVJACDUrvQ9ttqx Please enter the gitlab-ci description <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> this runner my-runner INFO[0034] fcf5c619 Registering runner... succeeded Please enter the executor: shell, docker, docker-ssh, ssh? docker Please enter the Docker image (eg. ruby:2.1): centos:7 INFO[0037] Runner registered successfully. Feel free to start it, but <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> it<span class="hljs-string"><span class="hljs-string">'s running already the config should be automatically reloaded!</span></span></code> </pre><br><br>  We specify the URL of our Gitlab, and prescribe a token for authorization. <br>  You also need to set the runner name, the way to start the job, in the case of docker - we specify the image that will run the runner. <br>  The configuration for the runner is specified by url <a href="http://example.com/groupname/projectname/runners">example.com/groupname/projectname/runners</a> <br>  Here you can edit the name of the runner and the tags with which the project will be collected on this runner.  For example, we need to test the project at different stages first in the shell, then pack it into a docker container and roll it out somewhere via ssh.  About this a little later. <br><br>  From there, you need to take the URL of the master and the token to authorize the runner on the "master". <br><br><img src="https://habrastorage.org/files/dce/159/1e0/dce1591e0e5b4bafaf48cd3855b6402e.png"><br><br>  Launch <br><br><pre> <code class="hljs pgsql">sudo gitlab-ci-multi-runner <span class="hljs-keyword"><span class="hljs-keyword">start</span></span></code> </pre><br><br>  After that, it should appear in the list of project runners: <br><br><img src="https://habrastorage.org/files/095/4cf/16f/0954cf16fdc44521a4493773226cf92c.png"><br><br><h2>  Install Container Registry </h2><br><br>  Not so long ago, the <a href="https://about.gitlab.com/2016/05/23/gitlab-container-registry/">Container Registry was integrated</a> into Gitlab. <br>  GitLab Container Registry is a secure, private repository for storing Docker images. <br>  We are looking in <i>/etc/gitlab/gitlab.rb</i> section of the <i>Container registry settings</i> <br><br><pre> <code class="ruby hljs">registry_external_url <span class="hljs-string"><span class="hljs-string">'https://domain.example.com'</span></span> <span class="hljs-comment"><span class="hljs-comment"># Settings used by GitLab application gitlab_rails['registry_enabled'] = true gitlab_rails['registry_host'] = "domain.example.com" gitlab_rails['registry_port'] = "5000" gitlab_rails['registry_api_url'] = "http://localhost:5000" gitlab_rails['registry_key_path'] = "/var/opt/gitlab/gitlab-rails/certificate.key" gitlab_rails['registry_path'] = "/var/opt/gitlab/gitlab-rails/shared/registry" # gitlab_rails['registry_issuer'] = "omnibus-gitlab-issuer" # Settings used by Registry application registry['enable'] = true registry['username'] = "registry" registry['group'] = "registry" # registry['uid'] = nil # registry['gid'] = nil registry['dir'] = "/var/opt/gitlab/registry" registry['log_directory'] = "/var/log/gitlab/registry" registry['log_level'] = "info" registry['rootcertbundle'] = "/var/opt/gitlab/registry/gitlab-registry.crt" registry['storage_delete_enabled'] = true</span></span></code> </pre><br><br>  From the necessary: <br>  you need to set <i>gitlab_rails ['registry_enabled'] = true</i> and <i>registry ['enable'] = true</i> <br>  In the <i>registry_external_url</i> specify the domain name of the server on which the repository will be located. <br><br>  You also need to find the following settings: <br><br><pre> <code class="ruby hljs">registry_nginx[<span class="hljs-string"><span class="hljs-string">'ssl_certificate'</span></span>] = <span class="hljs-string"><span class="hljs-string">"/path/to/certificate.pem"</span></span> registry_nginx[<span class="hljs-string"><span class="hljs-string">'ssl_certificate_key'</span></span>] = <span class="hljs-string"><span class="hljs-string">"/path/to/certificate.key"</span></span></code> </pre><br><br>  And specify the correct path to the certificates. <br><br>  If self-signed certificates are used, then on the docker-daemon side, from which all work with images will take place, you need to set the <i>--insecure-registry</i> option, otherwise, if you try to log in, we will get an error (runner also applies). <br><br>  In Debian: <i>/etc/systemd/system/multi-user.target.wants/docker.service</i> <br><pre> <code class="hljs pgsql">[Unit] Description=Docker Application Container Engine Documentation=https://docs.docker.com <span class="hljs-keyword"><span class="hljs-keyword">After</span></span>=network.target docker.socket Requires=docker.socket [Service] <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">notify</span></span> ExecStart=/usr/bin/docker daemon -H fd:// <span class="hljs-comment"><span class="hljs-comment">--insecure-registry domain.example.com MountFlags=slave LimitNOFILE=1048576 LimitNPROC=1048576 LimitCORE=infinity TimeoutStartSec=0 [Install] WantedBy=multi-user.target</span></span></code> </pre><br><br>  (Yes, there is no need to specify the port. There is an API for the registry - it hangs on localhost: 5000 and the front, through which authorization and further work with images takes place. I‚Äôve been looking for a way to outweigh the API from the local host :)) <br><br>  apply changes <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">systemctl</span></span> daemon-reload</code> </pre><br><pre> <code class="hljs pgsql">systemctl <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> docker</code> </pre><br><br>  And we try to log in with our gitlab account. <br><pre> <code class="hljs pgsql">docker <span class="hljs-keyword"><span class="hljs-keyword">login</span></span> <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.example.com Username: root <span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>: Email: <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>@example.com <span class="hljs-built_in"><span class="hljs-built_in">WARNING</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">login</span></span> credentials saved <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /root/.docker/config.json <span class="hljs-keyword"><span class="hljs-keyword">Login</span></span> Succeeded</code> </pre><br><br>  Well, now is the time to do something with it, build the first pipeline and see how the project will be built. <br><br><h2>  CI Setup </h2><br><br>  We start testing ansible playbooks: <br><br>  I will not go into the depths and talk about serverspec and test-kitchen, they have already been written about in my last post. <br>  First of all - we collect a simple image with an environment for tests.  We will <a href="https://github.com/willthames/ansible-lint">manage</a> <a href="https://docs.ansible.com/ansible/playbooks_checkmode.html">Dry run</a> and <a href="https://github.com/willthames/ansible-lint">ansible-lint</a> . <br><br>  <i>vim Dockerfile</i> <br><pre> <code class="hljs sql">FROM centos:7 RUN yum -y <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> &amp;&amp; yum -y <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> epel-<span class="hljs-keyword"><span class="hljs-keyword">release</span></span> \ &amp;&amp; yum -y <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> ansible python-pip RUN pip <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> ansible-lint <span class="hljs-comment"><span class="hljs-comment"># Default command CMD ["/bin/bash"]</span></span></code> </pre><br><br>  Okay, let's get an image <br><br><pre> <code class="bash hljs">docker build -t centos:7 .</code> </pre><br><br>  and push in Registry <br><br><pre> <code class="bash hljs">docker tag centos:7 domain.example.com/&lt;groupname&gt;/&lt;projectname&gt; docker push domain.example.com/&lt;groupname&gt;/&lt;projectname&gt;</code> </pre><br><br>  Now is the time to describe pipeline <br><br>  At the root of our project, we create a .gitlab-ci.yml file (again, YAML, yeah) and describe the steps involved in building the project. <br><br><pre> <code class="hljs pgsql">image: <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.example.com/root/my-repo stages: - test - deploy test_job: stage: test script: - ansible-lint playbook.yml - ansible-playbook <span class="hljs-comment"><span class="hljs-comment">--check playbook.yml tags: - ansible deploy_job: stage: deploy script: - ansible-playbook playbook.yml tags: - ansible</span></span></code> </pre><br><br>  Here we indicate the assembly stages of the project.  At the testing stage, we go through lint for syntax errors and run Ansible in Dry mode, that is, without applying changes on the host, but simply showing them.  If suddenly something breaks during the playback of the playbook - we will know about it before the configuration on the host changes. <br>  Correspondingly, if we now try to add spaces to the playbook, the configuration will not apply, lint will report an error and drop during the testing phase, which can be found after the commit directly in the gitlab web interface. <br><br><img src="https://habrastorage.org/files/d6f/c66/500/d6fc6650016e448f8792d149f71562cf.png"><br><br><img src="https://habrastorage.org/files/862/17b/c97/86217bc977214691bd10cda7fc4980ad.png"><br><br>  <i>.Gitlab-ci.yml</i> <a href="http://docs.gitlab.com/ce/ci/yaml/README.html">has a lot of different options</a> for all cases of the project's life stage.  Unfortunately, it was not possible to get acquainted with everything in one evening. <br><br>  As you can see, Gitlab is no worse than other CI services, it has a positive and user-friendly interface, but there are features in terms of writing a test script and deployment. <br><br>  Thanks for attention.  Successful automation! </div><p>Source: <a href="https://habr.com/ru/post/306596/">https://habr.com/ru/post/306596/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306586/index.html">Rating of countries in which it is more favorable to deploy a server farm</a></li>
<li><a href="../306588/index.html">Our development centers around the country with "teleports" to any city</a></li>
<li><a href="../306590/index.html">Fast TCP Sockets on Erlang</a></li>
<li><a href="../306592/index.html">How to sell: how the seller should work</a></li>
<li><a href="../306594/index.html">In search of mutual understanding: ‚Äúbad advice‚Äù for customers</a></li>
<li><a href="../306598/index.html">ITU new generation Cisco Firepower 4100 series close-up</a></li>
<li><a href="../306600/index.html">In Q2 2016, encryptors top the list of cyber attacks</a></li>
<li><a href="../306602/index.html">When to use unstructured data types in PostgreSQL? Comparison Hstore vs. JSON vs. Jsonb</a></li>
<li><a href="../306604/index.html">The less the better - about the possibilities of programming languages</a></li>
<li><a href="../306606/index.html">Full Disk Encryption (FDE)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>