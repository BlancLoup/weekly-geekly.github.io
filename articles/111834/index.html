<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Memory leaks in C / C ++ programs - the history of several bugs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Stories of several memory leak problems. Most of these problems are fairly trivial, easily reproduced, easily detected with the appropriate tools, and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Memory leaks in C / C ++ programs - the history of several bugs</h1><div class="post__text post__text-html js-mediator-article">  Stories of several memory leak problems.  Most of these problems are fairly trivial, easily reproduced, easily detected with the appropriate tools, and corrected.  But, at times, problems turn out to be unusual, and require an unusual approach or solution ... <a name="habracut"></a><br><br><h5>  Memory Code Loader </h5><br>  The next testing in QA revealed a small permanent memory leak under load in the new version of the product.  Reproduction was not a problem, but the initial run of the program under Valgrind did not reveal leaks. <br><br>  After some thought, the option --leak-check = full was turned on and Valgrind began reporting leaks.  But among the expected leaks of various kinds of static variables, often not consciously released, there was nothing resembling a leak.  Usually, when you run several thousand iterations, it is easy to allocate a similar number of lost memory blocks allocated by malloc.  In this case, the leakage per 10,000 requests to the server was minimal. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After analyzing the stack of memory allocations and dropping out the expected cases, there was only one candidate who was responsible for several dozen lost blocks - a number absolutely not associated with 10,000 requests.  But there was an explanation for this - memory allocations occurred in the STL string class, which actively uses the memory pool to reduce the amount of memory allocations.  Therefore, instead of 10,000 lost memory blocks, Valgrind reported 40+.  The call stack looked like this: <br><br> <code>==15882== 76,400 bytes in 8 blocks are definitely lost in loss record 2 of 3 <br> ==15882==      at 0x401B007: operator new(unsigned int) (vg_replace_malloc.c:214) <br> ==15882==      by 0x40A40F0: std::__default_alloc_template&lt;true, 0&gt;::_S_chunk_alloc(unsigned int, int&amp;) (in /usr/lib/libstdc++.so.5.0.3) <br> ==15882==      by 0x40A3FFC: std::__default_alloc_template&lt;true, 0&gt;::_S_refill(unsigned int) (in /usr/lib/libstdc++.so.5.0.3) <br> ==15882==      by 0x40A3B6B: std::__default_alloc_template&lt;true, 0&gt;::allocate(unsigned int) (in /usr/lib/libstdc++.so.5.0.3) <br> ==15882==      by 0x40A9B67: std::string::_Rep::_S_create(unsigned int, std::allocator&lt;char&gt; const&amp;) (in /usr/lib/libstdc++.so.5.0.3) <br> ==15882==      by 0x40A9C98: std::string::_Rep::_M_clone(std::allocator&lt;char&gt; const&amp;, unsigned int) (in /usr/lib/libstdc++.so.5.0.3) <br> ==15882==      by 0x40A7A05: std::string::reserve(unsigned int) (in /usr/lib/libstdc++.so.5.0.3) <br> ==15882==      by 0x8049826: std::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; std::operator+&lt;char, <br> std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;(char const*, std::basic_string&lt;char, std::char_traits&lt;char&gt;, <br> std::allocator&lt;char&gt; &gt; const&amp;) (basic_string.tcc:619) <br> ==15882==      by 0x804956A: A::A(A const&amp;) (class_a.cpp:20) <br> ==15882==      by 0x80491BC: foo(int) (test.cpp:23) <br> ==15882==      by 0x80492EA: main (test.cpp:32)</code> <br> <br>  It seems that the source of the memory leak was found, but the code looked absolutely innocent - a function call with a temporary copy of the object passed to it: <br><br> <code>doSomething( condition ? Object( params ) : getObject() );</code> <br> <br>  We were already sure that the memory is lost in this line, and began to look at the code generated by the compiler for this line.  It seems that everything was in place - calling ‚Äúbasic_string :: length ()‚Äù, calling the constructor of the parameter class for one branch of the condition, calling the ‚ÄúParent :: getB ()‚Äù and copying constructor for the other branch, calling the actual function ‚ÄúA :: create ‚Äù, freeing temporary objects - everything except calling the temporary copy of the class created on the stack, but containing a copy of the string inside, which was not released as a result! <br><br><pre> <code class="hljs mel"><span class="hljs-number"><span class="hljs-number">110</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> A::create(b1, b2, s.length() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? B(s) : getB()); <span class="hljs-number"><span class="hljs-number">13</span></span>d4: <span class="hljs-number"><span class="hljs-number">83</span></span> ec <span class="hljs-number"><span class="hljs-number">0</span></span>c sub $0xc,%esp <span class="hljs-number"><span class="hljs-number">13</span></span>d7: <span class="hljs-number"><span class="hljs-number">8</span></span>d <span class="hljs-number"><span class="hljs-number">45</span></span> d8 lea <span class="hljs-number"><span class="hljs-number">0xffffffd8</span></span>(%ebp),%eax <span class="hljs-number"><span class="hljs-number">13</span></span>da: <span class="hljs-number"><span class="hljs-number">50</span></span> push %eax <span class="hljs-number"><span class="hljs-number">13</span></span>db: e8 fc ff ff ff call std::basic_string&lt;wchar_t&gt;::length() const &lt;&lt;========= <span class="hljs-number"><span class="hljs-number">13e0</span></span>: <span class="hljs-number"><span class="hljs-number">83</span></span> c4 <span class="hljs-number"><span class="hljs-number">10</span></span> add $0x10,%esp <span class="hljs-number"><span class="hljs-number">13e3</span></span>: <span class="hljs-number"><span class="hljs-number">85</span></span> c0 test %eax,%eax <span class="hljs-number"><span class="hljs-number">13e5</span></span>: <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> je <span class="hljs-number"><span class="hljs-number">13</span></span>ff &lt;A::create+<span class="hljs-number"><span class="hljs-number">0x341</span></span>&gt; <span class="hljs-number"><span class="hljs-number">13e7</span></span>: <span class="hljs-number"><span class="hljs-number">83</span></span> ec <span class="hljs-number"><span class="hljs-number">08</span></span> sub $0x8,%esp <span class="hljs-number"><span class="hljs-number">13</span></span>ea: <span class="hljs-number"><span class="hljs-number">8</span></span>d <span class="hljs-number"><span class="hljs-number">45</span></span> d8 lea <span class="hljs-number"><span class="hljs-number">0xffffffd8</span></span>(%ebp),%eax <span class="hljs-number"><span class="hljs-number">13</span></span>ed: <span class="hljs-number"><span class="hljs-number">50</span></span> push %eax <span class="hljs-number"><span class="hljs-number">13</span></span>ee: <span class="hljs-number"><span class="hljs-number">8</span></span>d <span class="hljs-number"><span class="hljs-number">85</span></span> f8 fe ff ff lea <span class="hljs-number"><span class="hljs-number">0xfffffef8</span></span>(%ebp),%eax <span class="hljs-number"><span class="hljs-number">13</span></span>f4: <span class="hljs-number"><span class="hljs-number">50</span></span> push %eax <span class="hljs-number"><span class="hljs-number">13</span></span>f5: e8 fc ff ff ff call B::B( std::basic_string&lt;wchar_t&gt; const &amp; ) &lt;&lt;========= <span class="hljs-number"><span class="hljs-number">13</span></span>fa: <span class="hljs-number"><span class="hljs-number">83</span></span> c4 <span class="hljs-number"><span class="hljs-number">10</span></span> add $0x10,%esp <span class="hljs-number"><span class="hljs-number">13</span></span>fd: eb <span class="hljs-number"><span class="hljs-number">21</span></span> jmp <span class="hljs-number"><span class="hljs-number">1420</span></span> &lt;A::create+<span class="hljs-number"><span class="hljs-number">0x362</span></span>&gt; <span class="hljs-number"><span class="hljs-number">13</span></span>ff: <span class="hljs-number"><span class="hljs-number">83</span></span> ec <span class="hljs-number"><span class="hljs-number">08</span></span> sub $0x8,%esp <span class="hljs-number"><span class="hljs-number">1402</span></span>: <span class="hljs-number"><span class="hljs-number">83</span></span> ec <span class="hljs-number"><span class="hljs-number">04</span></span> sub $0x4,%esp <span class="hljs-number"><span class="hljs-number">1405</span></span>: ff <span class="hljs-number"><span class="hljs-number">75</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>c pushl <span class="hljs-number"><span class="hljs-number">0xc</span></span>(%ebp) <span class="hljs-number"><span class="hljs-number">1408</span></span>: e8 fc ff ff ff call Parent::getB() &lt;&lt;========= <span class="hljs-number"><span class="hljs-number">140</span></span>d: <span class="hljs-number"><span class="hljs-number">83</span></span> c4 <span class="hljs-number"><span class="hljs-number">08</span></span> add $0x8,%esp <span class="hljs-number"><span class="hljs-number">1410</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span> push %eax <span class="hljs-number"><span class="hljs-number">1411</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span>d <span class="hljs-number"><span class="hljs-number">85</span></span> f8 fe ff ff lea <span class="hljs-number"><span class="hljs-number">0xfffffef8</span></span>(%ebp),%eax <span class="hljs-number"><span class="hljs-number">1417</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span> push %eax <span class="hljs-number"><span class="hljs-number">1418</span></span>: e8 fc ff ff ff call B::B( B const &amp; ) &lt;&lt;========= <span class="hljs-number"><span class="hljs-number">141</span></span>d: <span class="hljs-number"><span class="hljs-number">83</span></span> c4 <span class="hljs-number"><span class="hljs-number">10</span></span> add $0x10,%esp <span class="hljs-number"><span class="hljs-number">1420</span></span>: <span class="hljs-number"><span class="hljs-number">83</span></span> ec <span class="hljs-number"><span class="hljs-number">0</span></span>c sub $0xc,%esp <span class="hljs-number"><span class="hljs-number">1423</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span>d <span class="hljs-number"><span class="hljs-number">85</span></span> f8 fe ff ff lea <span class="hljs-number"><span class="hljs-number">0xfffffef8</span></span>(%ebp),%eax <span class="hljs-number"><span class="hljs-number">1429</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span> push %eax <span class="hljs-number"><span class="hljs-number">142</span></span>a: <span class="hljs-number"><span class="hljs-number">0</span></span>f b6 <span class="hljs-number"><span class="hljs-number">45</span></span> f6 movzbl <span class="hljs-number"><span class="hljs-number">0xfffffff6</span></span>(%ebp),%eax <span class="hljs-number"><span class="hljs-number">142</span></span>e: <span class="hljs-number"><span class="hljs-number">50</span></span> push %eax <span class="hljs-number"><span class="hljs-number">142</span></span>f: <span class="hljs-number"><span class="hljs-number">0</span></span>f b6 <span class="hljs-number"><span class="hljs-number">45</span></span> f7 movzbl <span class="hljs-number"><span class="hljs-number">0xfffffff7</span></span>(%ebp),%eax <span class="hljs-number"><span class="hljs-number">1433</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span> push %eax <span class="hljs-number"><span class="hljs-number">1434</span></span>: ff <span class="hljs-number"><span class="hljs-number">75</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>c pushl <span class="hljs-number"><span class="hljs-number">0xc</span></span>(%ebp) <span class="hljs-number"><span class="hljs-number">1437</span></span>: ff <span class="hljs-number"><span class="hljs-number">75</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span> pushl <span class="hljs-number"><span class="hljs-number">0x8</span></span>(%ebp) <span class="hljs-number"><span class="hljs-number">143</span></span>a: e8 fc ff ff ff call A::create(bool, bool, B) &lt;&lt;========= <span class="hljs-number"><span class="hljs-number">143</span></span>f: <span class="hljs-number"><span class="hljs-number">83</span></span> c4 <span class="hljs-number"><span class="hljs-number">1</span></span>c add $0x1c,%esp <span class="hljs-number"><span class="hljs-number">1442</span></span>: <span class="hljs-number"><span class="hljs-number">83</span></span> ec <span class="hljs-number"><span class="hljs-number">0</span></span>c sub $0xc,%esp <span class="hljs-number"><span class="hljs-number">1445</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span>d <span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">68</span></span> ff ff ff lea <span class="hljs-number"><span class="hljs-number">0xffffff68</span></span>(%ebp),%eax <span class="hljs-number"><span class="hljs-number">144</span></span>b: <span class="hljs-number"><span class="hljs-number">50</span></span> push %eax <span class="hljs-number"><span class="hljs-number">144</span></span>c: e8 fc ff ff ff call BS&lt;<span class="hljs-number"><span class="hljs-number">100</span></span>, char&gt;::~BS() <span class="hljs-number"><span class="hljs-number">1451</span></span>: <span class="hljs-number"><span class="hljs-number">83</span></span> c4 <span class="hljs-number"><span class="hljs-number">10</span></span> add $0x10,%esp <span class="hljs-number"><span class="hljs-number">1454</span></span>: <span class="hljs-number"><span class="hljs-number">83</span></span> ec <span class="hljs-number"><span class="hljs-number">0</span></span>c sub $0xc,%esp <span class="hljs-number"><span class="hljs-number">1457</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span>d <span class="hljs-number"><span class="hljs-number">45</span></span> d8 lea <span class="hljs-number"><span class="hljs-number">0xffffffd8</span></span>(%ebp),%eax <span class="hljs-number"><span class="hljs-number">145</span></span>a: <span class="hljs-number"><span class="hljs-number">50</span></span> push %eax <span class="hljs-number"><span class="hljs-number">145</span></span>b: e8 fc ff ff ff call std::basic_string&lt;wchar_t&gt;::~basic_string() <span class="hljs-number"><span class="hljs-number">1460</span></span>: <span class="hljs-number"><span class="hljs-number">83</span></span> c4 <span class="hljs-number"><span class="hljs-number">10</span></span> add $0x10,%esp <span class="hljs-number"><span class="hljs-number">1463</span></span>: eb <span class="hljs-number"><span class="hljs-number">55</span></span> jmp <span class="hljs-number"><span class="hljs-number">14</span></span>ba &lt;A::create+<span class="hljs-number"><span class="hljs-number">0x3fc</span></span>&gt; <span class="hljs-number"><span class="hljs-number">1465</span></span>: <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">85</span></span> f0 fe ff ff mov %eax,<span class="hljs-number"><span class="hljs-number">0xfffffef0</span></span>(%ebp) <span class="hljs-number"><span class="hljs-number">146</span></span>b: <span class="hljs-number"><span class="hljs-number">8</span></span>b b5 f0 fe ff ff mov <span class="hljs-number"><span class="hljs-number">0xfffffef0</span></span>(%ebp),%esi <span class="hljs-number"><span class="hljs-number">1471</span></span>: <span class="hljs-number"><span class="hljs-number">83</span></span> ec <span class="hljs-number"><span class="hljs-number">0</span></span>c sub $0xc,%esp <span class="hljs-number"><span class="hljs-number">1474</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span>d <span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">68</span></span> ff ff ff lea <span class="hljs-number"><span class="hljs-number">0xffffff68</span></span>(%ebp),%eax <span class="hljs-number"><span class="hljs-number">147</span></span>a: <span class="hljs-number"><span class="hljs-number">50</span></span> push %eax <span class="hljs-number"><span class="hljs-number">147</span></span>b: e8 fc ff ff ff call BS&lt;<span class="hljs-number"><span class="hljs-number">100</span></span>, char&gt;::~BS() <span class="hljs-number"><span class="hljs-number">1480</span></span>: <span class="hljs-number"><span class="hljs-number">83</span></span> c4 <span class="hljs-number"><span class="hljs-number">10</span></span> add $0x10,%esp <span class="hljs-number"><span class="hljs-number">1483</span></span>: <span class="hljs-number"><span class="hljs-number">89</span></span> b5 f0 fe ff ff mov %esi,<span class="hljs-number"><span class="hljs-number">0xfffffef0</span></span>(%ebp) <span class="hljs-number"><span class="hljs-number">1489</span></span>: eb <span class="hljs-number"><span class="hljs-number">06</span></span> jmp <span class="hljs-number"><span class="hljs-number">1491</span></span> &lt;A::create+<span class="hljs-number"><span class="hljs-number">0x3d3</span></span>&gt; <span class="hljs-number"><span class="hljs-number">148</span></span>b: <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">85</span></span> f0 fe ff ff mov %eax,<span class="hljs-number"><span class="hljs-number">0xfffffef0</span></span>(%ebp) <span class="hljs-number"><span class="hljs-number">1491</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span>b b5 f0 fe ff ff mov <span class="hljs-number"><span class="hljs-number">0xfffffef0</span></span>(%ebp),%esi <span class="hljs-number"><span class="hljs-number">1497</span></span>: <span class="hljs-number"><span class="hljs-number">83</span></span> ec <span class="hljs-number"><span class="hljs-number">0</span></span>c sub $0xc,%esp <span class="hljs-number"><span class="hljs-number">149</span></span>a: <span class="hljs-number"><span class="hljs-number">8</span></span>d <span class="hljs-number"><span class="hljs-number">45</span></span> d8 lea <span class="hljs-number"><span class="hljs-number">0xffffffd8</span></span>(%ebp),%eax <span class="hljs-number"><span class="hljs-number">149</span></span>d: <span class="hljs-number"><span class="hljs-number">50</span></span> push %eax <span class="hljs-number"><span class="hljs-number">149</span></span>e: e8 fc ff ff ff call std::basic_string&lt;wchar_t&gt;::~basic_string() <span class="hljs-number"><span class="hljs-number">14</span></span>a3: <span class="hljs-number"><span class="hljs-number">83</span></span> c4 <span class="hljs-number"><span class="hljs-number">10</span></span> add $0x10,%esp <span class="hljs-number"><span class="hljs-number">14</span></span>a6: <span class="hljs-number"><span class="hljs-number">89</span></span> b5 f0 fe ff ff mov %esi,<span class="hljs-number"><span class="hljs-number">0xfffffef0</span></span>(%ebp) <span class="hljs-number"><span class="hljs-number">14</span></span>ac: <span class="hljs-number"><span class="hljs-number">83</span></span> ec <span class="hljs-number"><span class="hljs-number">0</span></span>c sub $0xc,%esp <span class="hljs-number"><span class="hljs-number">14</span></span>af: ff b5 f0 fe ff ff pushl <span class="hljs-number"><span class="hljs-number">0xfffffef0</span></span>(%ebp) <span class="hljs-number"><span class="hljs-number">14</span></span>b5: e8 fc ff ff ff call _Unwind_Resume</code> </pre> <br><br>  Not finding the destructor‚Äôs call to the code, we began to look for similar problems, and almost immediately found " <a href="http://gcc.gnu.org/bugzilla/show_bug.cgi%3Fid%3D9946">gcc 3.2 bug 9946 - object destructor not called, causing a memory leak</a> ". <br><br>  The problem was in generating the code for the ‚Äú?:‚Äù Operator, and was solved either by updating the compiler, or by cosmetic changing the ‚Äú?:‚Äù Operator to a simple if (). <br><br> <code>//  ,      <br> const Object &amp; getObject(); <br> <br> //       <br> void doSomething( Object obj ); <br> <br> //    ,    . <br> //          , <br> //          . <br> doSomething( condition ? Object( params ) : getObject() );</code> <br> <br>  A simple test program would output the following (note the number of instances of class A created and released): <br><br> <code>main() start <br> A::A( 'on stack' ) <br> B::B() <br> A::A( 'static instance' ) <br> A::A( 'copy of static instance' ) <br> B::boo() <br> B::~B() <br> A::~A( 'on stack' ) <br> main() end <br> A::~A( 'static instance' ) <br> Class A created 3 times and destroyed 2 times <br> Class B created 1 times and destroyed 1 times</code> <br> <br>  The problem occurred only when generating 32-bit code in gcc 3.2.3, and did not occur in 64-bit code, or code generated by later versions of the compiler. <br><br><h5>  I am not me and my memory is not </h5><br>  At one time I supported and refined the program to collect data and transfer it to the server.  This program worked on a good dozen platforms, including Linux.  Since the program was commercial, it was compiled by a compiler corresponding to the minimum supported version of Linux, in our case gcc 3.3.x, and executable files were provided. <br><br>  At one point, in our department, QA registered and even managed to reproduce (during a long, several days, test under a large load) the program crash due to lack of memory - the process ate up 3GB of memory and safely dropped, creating core dump of a similar volume.  Moreover, the explosive growth of memory usage occurred literally 10-15 minutes before the sad end, and at this time the processor load was about 12% (there were 4 dual-core processors on the server, so one thread spinning in a cycle should use 12.5%). <br><br>  The call stack of the fallen stream pointed to a completely trivial code in the copy constructor, it was only clear that this was somehow related to exceptional situations. <br><br><pre> <code class="hljs delphi">(gdb) where <span class="hljs-string"><span class="hljs-string">#0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>xffffe410 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> __kernel_vsyscall () <span class="hljs-string"><span class="hljs-string">#1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>xb7dbd8d0 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> () from /lib/libc.so.<span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-string"><span class="hljs-string">#2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>xb7dbeff3 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> abort () from /lib/libc.so.<span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-string"><span class="hljs-string">#3</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>xb7f86da5 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dlopen () from /usr/lib/libstdc++.so.<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-string"><span class="hljs-string">#4</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>xb7f86de2 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> std::terminate () from /usr/lib/libstdc++.so.<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-string"><span class="hljs-string">#5</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>xb7f85e89 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> __cxa_allocate_exception () from /usr/lib/libstdc++.so.<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-string"><span class="hljs-string">#6</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>xb78f7f07 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Uuid::Uuid () from .../lib32/libourlibrary.so <span class="hljs-string"><span class="hljs-string">#7</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>xb782409d <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ...</code> </pre> <br><br>  Attempts to reproduce the problem with the memory debugger or the debug version of the executable files were not successful - the problem disappeared.  And the reproduction itself was costly - it was usually necessary to test the process under load for 2-4 days before the problem occurred, and this delayed the tests of other components that required the same infrastructure for tests under load. <br><br>  The search for similar call stacks gave almost no results, and the situation was a dead end.  It was necessary to somehow find the cause of a memory leak without using a debugger. <br><br>  In one implementation of the C ++ memory allocation library I encountered, each block allocated for a new instance of the class in the debug version of the library was marked with a string containing the name of this class.  This method allowed to easily determine by core dump-y which objects of a particular type were allocated.  I tried to search for strings contained in the core dump file, first running the ‚Äústrings‚Äù program, and then sorting with ‚Äúsort‚Äù. <br><br>  Curiously, it was found that the file contains 32,123,751 lines of the form ‚Äú++ CCUNG0o‚Äù - only these lines occupied about 275 MB in a file of 3 GB in size.  When searching these lines in the file, it turned out that each such signature started a block of 96 bytes in size (96b * 32,000,000 = 3Gb !!!) <br><br>  The blocks started with the inverted string ‚Äú++ CCUNG0o‚Äù with a leading zero (as it is inverted), and differed only in a pair of four bytes in different places, forming, apparently, a linked list. <br><br> <code>0x248b818: 0x00 0x2b 0x2b 0x43 0x43 0x55 0x4e 0x47 &lt;&lt;==  ¬´++CCUNG0o¬ª <br> 0x248b820: 0x30 0x6f 0xf8 0xb7 0x00 0x00 0x00 0x00 <br> 0x248b828: 0x6c 0xa8 0x78 0xb7 0x00 0x00 0x00 0x00 <br> 0x248b830: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 <br> 0x248b838: 0xa8 0x0e 0xd3 0xb7 0x3c 0xa2 0xfa 0xb7 <br> 0x248b840: 0xe8 0xae 0x82 0xb7 0x65 0x00 0x00 0x00 <br> 0x248b848: 0xc0 0x0e 0xd3 0xb7 0x38 0x9c 0xc8 0xb7 <br> 0x248b850: 0xf4 0x9b 0x04 0x08 0xe4 0x9c 0x04 0x08 <br> 0x248b858: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 <br> 0x248b860: 0x03 0x00 0x00 0x00 0xbe 0x80 0x79 0xb7 <br> 0x248b868: 0x58 0x80 0x79 0xb7 0x54 0xa9 0x78 0xb7 <br> 0x248b870: 0x98 0xb8 0x48 0x02 0x00 0x00 0x00 0x00 <br> <br> 0x248b878: 0x00 0x2b 0x2b 0x43 0x43 0x55 0x4e 0x47 &lt;&lt;==  ¬´++CCUNG0o¬ª <br> 0x248b880: 0x30 0x6f 0xf8 0xb7 0x00 0x00 0x00 0x00 <br> 0x248b888: 0x6c 0xa8 0x78 0xb7 0x00 0x00 0x00 0x00 <br> 0x248b890: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 <br> 0x248b898: 0xa8 0x0e 0xd3 0xb7 0x3c 0xa2 0xfa 0xb7 <br> 0x248b8a0: 0xff 0xff 0xff 0xff 0x65 0x00 0x00 0x00 <br> 0x248b8a8: 0xc0 0x0e 0xd3 0xb7 0x38 0x9c 0xc8 0xb7 <br> 0x248b8b0: 0xf4 0x9b 0x04 0x08 0xe4 0x9c 0x04 0x08 <br> 0x248b8b8: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 <br> 0x248b8c0: 0x03 0x00 0x00 0x00 0xbe 0x80 0x79 0xb7 <br> 0x248b8c8: 0x58 0x80 0x79 0xb7 0x54 0xa9 0x78 0xb7 <br> 0x248b8d0: 0xf8 0xb8 0x48 0x02 0x00 0x00 0x00 0x00</code> <br> <br>  The search for such a line on the Internet did not at first bring any useful results, but then one link to <a href="http://www.opensource.apple.com/">http://www.opensource.apple.com/</a> (unfortunately not working anymore) came up with the following snippet: <br><br><pre> <code class="hljs erlang-repl">// This is the exception class we report -- <span class="hljs-string"><span class="hljs-string">"GNUCC++\0"</span></span>. const _Unwind_Exception_Class __gxx_exception_class = ((((((((_Unwind_Exception_Class) <span class="hljs-string"><span class="hljs-string">'G'</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span> | (_Unwind_Exception_Class) <span class="hljs-string"><span class="hljs-string">'N'</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span> | (_Unwind_Exception_Class) <span class="hljs-string"><span class="hljs-string">'U'</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span> | (_Unwind_Exception_Class) <span class="hljs-string"><span class="hljs-string">'C'</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span> | (_Unwind_Exception_Class) <span class="hljs-string"><span class="hljs-string">'C'</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span> | (_Unwind_Exception_Class) <span class="hljs-string"><span class="hljs-string">'+'</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span> | (_Unwind_Exception_Class) <span class="hljs-string"><span class="hljs-string">'+'</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span> | (_Unwind_Exception_Class) <span class="hljs-string"><span class="hljs-string">'\0'</span></span>);</code> </pre> <br><br>  Then I went back to the call stacks of other threads, and found a very suspicious thread, obviously working in a loop at the time of the crash - and this loop also handles exception handling: <br><br><pre> <code class="hljs delphi">(gdb) thread <span class="hljs-number"><span class="hljs-number">20</span></span> [Switching <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> thread <span class="hljs-number"><span class="hljs-number">20</span></span> (process <span class="hljs-number"><span class="hljs-number">27635</span></span>)]<span class="hljs-string"><span class="hljs-string">#0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>xb7e87921 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dl_iterate_phdr () from /lib/libc.so.<span class="hljs-number"><span class="hljs-number">6</span></span> (gdb) where <span class="hljs-string"><span class="hljs-string">#0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>xb7e87921 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dl_iterate_phdr () from /lib/libc.so.<span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-string"><span class="hljs-string">#1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>x0804e837 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _Unwind_Find_FDE (pc=<span class="hljs-number"><span class="hljs-number">0</span></span>xb782409c, bases=<span class="hljs-number"><span class="hljs-number">0</span></span>xb70209b4) at ../../gcc/unwind-dw2-fde-glibc.c:<span class="hljs-number"><span class="hljs-number">283</span></span> <span class="hljs-string"><span class="hljs-string">#2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>x0804c950 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> uw_frame_state_for (context=<span class="hljs-number"><span class="hljs-number">0</span></span>xb7020960, fs=<span class="hljs-number"><span class="hljs-number">0</span></span>xb7020860) at ../../gcc/unwind-dw2.c:<span class="hljs-number"><span class="hljs-number">903</span></span> <span class="hljs-string"><span class="hljs-string">#3</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>x0804cfbf <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _Unwind_RaiseException_Phase2 (exc=<span class="hljs-number"><span class="hljs-number">0</span></span>xbfde3f38, context=<span class="hljs-number"><span class="hljs-number">0</span></span>xb7020960) at ../../gcc/unwind.inc:<span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-string"><span class="hljs-string">#4</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>x0804d397 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _Unwind_Resume (exc=<span class="hljs-number"><span class="hljs-number">0</span></span>xbfde3f38) at ../../gcc/unwind.inc:<span class="hljs-number"><span class="hljs-number">220</span></span> <span class="hljs-string"><span class="hljs-string">#5</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>xb78f82b0 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Uuid::Uuid () from /home/<span class="hljs-string"><span class="hljs-string">'work/lib32/libourlibrary.so #6 0xb782409d in ...</span></span></code> </pre> <br><br>  After that, we began to look more closely at the source code where the exception was caused, and assumed that the problem lies in the placement new operator that was used in this section of the code.  A simple test confirmed the assumption - the creation of an exception in the object constructor, called from the placement new operator, led to an infinite loop and an explosive memory leak.  The test was simple - simulation of an exceptional situation in a problem part of the code, but unfortunately, not at all easy apart from the context of our application - small test programs did not reproduce the problem.  It also turned out that this problem is present only in the version of the compiler that we used, that is, the problem was missing in gcc 3.4.  To the joy that the specific problem, which had already cost a pretty penny, was solved, the further investigation was turned off. <br><br><h5>  Not quite a leak </h5><br>  Once, after updating a software product, pre-testing at a client found a memory leak that did not occur before. <br><br>  The program worked under Solaris, under load, and memory usage increased sharply at 10-100 MB, while rarely enough - sometimes every 2-3 days, and sometimes 2-3 times a day.  Sooner or later, the memory used by the process grew to 2+ GB.  At the same time, even when the load was reduced to zero, the memory used (RSS and VSS values) never decreased. <br><br>  There was no direct access to the servers (for example, to configure libumem, for example), and the QA problem could not be reproduced.  It‚Äôs also good that we managed to get a trimmed core dump file - a snapshot of the process memory.  But analysis of the core dump file gave almost nothing - the call stack showed a drop in memory allocation due to lack of it.  At the same time, most of the memory was not used - almost the entire core dump file was occupied by empty 4 KB pages filled with zeros. <br><br>  The situation was strange, but gradually, by eliminating various components of the system and thoughtful analysis of the log files, the picture of the events taking place was restored. <br><br>  When updating the system, one of the client programs stopped sending some messages intended for monitoring the system.  By chance, the missing messages signaled closing the transactions, and they had to clean the internal buffers.  Accordingly, as the load increased, buffered messages began to accumulate, waiting for pairs.  By coincidence, in this case, the messages were atypically large (tens of kilobytes instead of hundreds of bytes), and the number of client processes was relatively large (several tens instead of the usual 2-5).  But in fact, all these parameters fit perfectly into the limitations supported by the system (provided that it functions normally).  And, although the program did not limit the size of the internal buffers, it did support a mechanism for clearing ‚Äúlost‚Äù transactions ‚Äî all incomplete messages older than 10 minutes were automatically deleted.  And just this counter always showed 0 due to an error - the mechanism was intended for an almost unbelievable exceptional situation, it was almost never involved, and was not sufficiently tested.  The cleaning itself worked fine, but was not efficient enough because of the large memory load caused by a large number of clients and the large size of non-standard messages.  And the diagnosis of the problem turned out to be very difficult due to a faulty counter in the statistics. <br><br>  Why the memory did not return when the load decreases?  Very simple - the standard process memory manager in Solaris only increases the address space of the process, and reserves the memory freed by the process for reuse, leaving the pages "occupied" by the process from the perspective of an outsider. <br><br>  In our case, single peaks of activity of problem clients led to periodic large memory allocations, in most cases imperceptible, since the previous maximum was not exceeded.  And only if the last maximum was exceeded, the next step was obtained, which has never decreased.  10 minutes after the peak, all the memory was freed, but outside it was not visible, only a snapshot of the memory showed that most of the memory is filled with zeros and is not used. <br><br>  The solution was simple even before correcting problematic clients and protecting against buffer overflows ‚Äî the age of ‚Äúold‚Äù transactions was temporarily limited to 30 seconds, and this was quite enough for timely clearing of buffers under a given load, with a large margin.  But diagnostics and troubleshooting took a long time, mainly due to incorrect statistics in the logs. <br><br><h5>  Instead of an epilogue </h5><br>  Who had interesting cases in practice - write! </div><p>Source: <a href="https://habr.com/ru/post/111834/">https://habr.com/ru/post/111834/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../111824/index.html">The largest sites will conduct a 24-hour IPv6 test</a></li>
<li><a href="../111825/index.html">First Dropquest from Dropbox.com</a></li>
<li><a href="../111829/index.html">How to develop a novice tester?</a></li>
<li><a href="../111830/index.html">Microsoft Excel is 25 years old!</a></li>
<li><a href="../111833/index.html">E-Ink in the service of the fatherland (not ours)</a></li>
<li><a href="../111835/index.html">Accelerating the reaction of Windows XP / 7. Careful use of SSD drives</a></li>
<li><a href="../111837/index.html">Using Razor outside of ASP.NET</a></li>
<li><a href="../111839/index.html">Ariel</a></li>
<li><a href="../111841/index.html">Fighting spam by law</a></li>
<li><a href="../111844/index.html">Where should the incoming call arrow be directed to in a spherical interface in a vacuum?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>