<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Home all-in-one server - success story</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I lived and I had a router of one good company with the letter ‚ÄúDead‚Äù. Well, it actually happened to him. 
 I looked at the prices of new ones, at a b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Home all-in-one server - success story</h1><div class="post__text post__text-html js-mediator-article">  I lived and I had a router of one good company with the letter ‚ÄúDead‚Äù.  Well, it actually happened to him. <br>  I looked at the prices of new ones, at a bunch of computer junk in the corner, at the list of connections on my home computer ... And I realized that I didn‚Äôt need a router.  I will collect my own, with normal routing, DNS, WINS, i2p, <s>blackjack</s> and so on. <br><a name="habracut"></a><br><h4>  How it was? </h4><br>  After a brief excavation in the deposits of iron, the light was extracted: <br>  ‚Ä¢ Intel Core 2 Duo E8400 @ 3GHz processor <br>  ‚Ä¢ With it - the motherboard Asus P5Q <br>  ‚Ä¢ 2 strips DDR2 for 2Gb <br>  ‚Ä¢ PCI-e TP-Link TG-3468 Network Card <br>  ‚Ä¢ Unidentified WiFi Network Card (b / g / n) based on Ralink RT3060 <br>  ‚Ä¢ Seagate 250Gb hard drive <br>  The output of lshw can be viewed <a href="http://pastebin.com/7K1kw2X7">here</a> . <br>  All this was cleared of dust, built into the case with the power supply, running and tested in memtest and mhdd.  Having found no defects, I began installing everything I needed. <br><br><h4>  Basics of the basics </h4><br>  I took the Debian Testing distribution kit, rolled out through Debootstrap, as a basis.  Immediately, the openssh-server, firmware-ralink and pppoe / pppoeconf were installed. <br>  Having rebooted into the newly installed system, I immediately transferred the SSH to 192.168.1.1 and turned off password authentication (by setting my own key). <br><br><h4>  Let there be a network! </h4><br>  For a start, pppoeconf was launched.  A network card with the name eth1 was connected to the DOCSIS modem, as a result, the following config / etc / ppp / peers / rt was received: <br><pre><code class="hljs pgsql">noipdefault defaultroute replacedefaultroute hide-<span class="hljs-keyword"><span class="hljs-keyword">password</span></span> noauth persist plugin rp-pppoe.so eth1 <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> "ptn" usepeerdns</code> </pre> <br>  But this is not all - you need to configure / etc / network / interfaces as follows: <br><pre> <code class="hljs pgsql">auto rt iface rt <span class="hljs-type"><span class="hljs-type">inet</span></span> ppp pre-up /sbin/ifconfig eth1 up provider rt</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  We turn a router into WiFi-AP </h4><br>  The original idea was to make 2 WiFi networks: one for their computers and laptops, with a strong password and connection to all necessary resources, and the second for guests who wanted to go online, but don‚Äôt need to know what's going on in my network. <br>  As a result, hostapd was installed on the server with the following configuration file (all network names and passwords were changed): <br><pre> <code class="hljs markdown">interface=wlan0 driver=nl80211 country<span class="hljs-emphasis"><span class="hljs-emphasis">_code=RU ieee80211d=1 hw_</span></span>mode=g channel=9 ssid=Private bridge=br0 preamble=1 ignore<span class="hljs-emphasis"><span class="hljs-emphasis">_broadcast_</span></span>ssid=0 wpa=3 wpa<span class="hljs-emphasis"><span class="hljs-emphasis">_key_</span></span>mgmt=WPA-PSK wpa<span class="hljs-emphasis"><span class="hljs-emphasis">_pairwise=TKIP CCMP rsn_</span></span>pairwise=CCMP wpa<span class="hljs-emphasis"><span class="hljs-emphasis">_passphrase=MyVeryStrongPassword wmm_</span></span>enabled=1 ieee80211n=1 ht<span class="hljs-emphasis"><span class="hljs-emphasis">_capab=[HT40-][SHORT-GI-20][SHORT-GI-40] internet=1 bss=wlan0_</span></span>0 ssid=Guest preamble=1 ignore<span class="hljs-emphasis"><span class="hljs-emphasis">_broadcast_</span></span>ssid=0 wpa=3 wpa<span class="hljs-emphasis"><span class="hljs-emphasis">_key_</span></span>mgmt=WPA-PSK wpa<span class="hljs-emphasis"><span class="hljs-emphasis">_pairwise=TKIP CCMP rsn_</span></span>pairwise=CCMP wpa<span class="hljs-emphasis"><span class="hljs-emphasis">_passphrase=passw0rd wmm_</span></span>enabled=1 ieee80211n=1 ht_capab=[<span class="hljs-string"><span class="hljs-string">HT40-</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">SHORT-GI-20</span></span>][<span class="hljs-string"><span class="hljs-string">SHORT-GI-40</span></span>] internet=1</code> </pre><br>  Here we also set bridge for eth0 and wlan0 - this will allow those who connect to our network to see it as a whole, and not the wireless segment.  Modify networks: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">auto</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eth0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">wlan0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">wlan0_0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">br0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">iface</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eth0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">manual</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">allow-hotplug</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">wlan0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">allow-hotplug</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">wlan0_0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">iface</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">wlan0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">manual</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pre-up</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ifconfig</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">wlan0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">hw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ether</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">f2</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:7d</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:68</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:6d</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:51</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:30</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">iface</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">br0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">static</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bridge_ports</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eth0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">wlan0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">netmask</span></span> 24 <span class="hljs-selector-tag"><span class="hljs-selector-tag">iface</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">wlan0_0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">static</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.254</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">netmask</span></span> 24</code> </pre><br>  A bit about magic in pre-up for wlan0: to work with multiple APs, we need to use more than one MAC address.  Hostapd assigns MACs for virtual interfaces (wlan0_0 in our case) automatically, but to do this, the address of the first access point must have several ‚Äúempty‚Äù bits at the end.  I did not trivialize and released immediately 4 pieces.  The task at home - calculate how much maximum AP can now be run on a single map. <br><br><h4>  Fly - IP to each and everyone, for free! </h4><br>  All computers on the network, sadly, must issue IP addresses.  Yes, yes, we will do it. <br>  Without thinking, the server was running a DHCP server with the following configuration: <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span>-static-leases <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>; authoritative; allow <span class="hljs-type"><span class="hljs-type">unknown</span></span>-clients; use-host-decl-names <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>-facility local7; subnet <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> { interface br0; authoritative; <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> subnet-mask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> ntp-servers <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>-<span class="hljs-type"><span class="hljs-type">name</span></span>-servers <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> netbios-<span class="hljs-type"><span class="hljs-type">name</span></span>-servers <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> routers <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>-<span class="hljs-type"><span class="hljs-type">name</span></span> "local"; } subnet <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> { interface wlan0_0; authoritative; <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> subnet-mask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>-<span class="hljs-type"><span class="hljs-type">name</span></span>-servers <span class="hljs-number"><span class="hljs-number">8.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span>, <span class="hljs-number"><span class="hljs-number">8.8</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> routers <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">local</span></span>-address <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>;</code> </pre><br>  It can be seen that DNS, WINS, NTP and Gateway 192.168.1.1 are also issued for 192.168.1.1/24 - it's time to configure them. <br>  With the gateway, everything is simple, I think, only the lazy does not know these commands: <br><pre> <code class="bash hljs">sysctl net.ipv4.ip_forward=1 iptables ‚Äìt nat -A POSTROUTING -o ppp0 -j MASQUERADE</code> </pre><br>  Of course, we install iptables-persistent to save our settings, as well as prescribe the appropriate parameters in /etc/sysctl.conf. <br>  Now our server is a full-fledged Chinese router for $ 10.  What?  Does it seem weak to you?  Me too.  We go further. <br><br><h4>  How do I get to the library? </h4><br>  I think no one forgot that we need a DNS?  The simplest forwarding is configured to absurdly simple, but after all we are doing a full-fledged server with rezolving and reverse-zones ... We put bind9, and configure: <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">options</span></span> { directory "/var/cache/bind"; forwarders { <span class="hljs-number"><span class="hljs-number">8.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span>; <span class="hljs-number"><span class="hljs-number">8.8</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span>; }; dnssec-validation auto; auth-nxdomain <span class="hljs-keyword"><span class="hljs-keyword">no</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> { <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; }; allow-transfer { <span class="hljs-keyword"><span class="hljs-keyword">none</span></span>; }; <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-keyword"><span class="hljs-keyword">none</span></span>; }; <span class="hljs-type"><span class="hljs-type">zone</span></span> "local" <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> master; file "/var/lib/bind/db.localnet"; }; <span class="hljs-type"><span class="hljs-type">zone</span></span> "1.168.192.in-addr.arpa" <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> master; file "/var/lib/bind/db.localnet-rev"; };</code> </pre><br>  Now we need the forward and reverse zone files: <br><div class="spoiler">  <b class="spoiler_title">/var/lib/bind/db.localnet</b> <div class="spoiler_text"><pre> <code class="hljs bash"><span class="hljs-variable"><span class="hljs-variable">$ORIGIN</span></span> . <span class="hljs-variable"><span class="hljs-variable">$TTL</span></span> 86400 ; 1 day <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> IN SOA ns.local. router.local. ( 200216990 ; serial 28800 ; refresh (8 hours) 7200 ; retry (2 hours) 604800 ; expire (1 week) 86400 ; minimum (1 day) ) NS ns.local. <span class="hljs-variable"><span class="hljs-variable">$ORIGIN</span></span> <span class="hljs-built_in"><span class="hljs-built_in">local</span></span>. <span class="hljs-variable"><span class="hljs-variable">$TTL</span></span> 86400 ; 1 day ns A 192.168.1.1 server A 192.168.1.1 router A 192.168.1.1</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">/var/lib/bind/db.localnet-rev</b> <div class="spoiler_text"><pre> <code class="hljs mel">$ORIGIN . $TTL <span class="hljs-number"><span class="hljs-number">86400</span></span> ; <span class="hljs-number"><span class="hljs-number">1</span></span> day <span class="hljs-number"><span class="hljs-number">1.168</span></span><span class="hljs-number"><span class="hljs-number">.192</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-addr.arpa IN SOA ns.local. router.local. ( <span class="hljs-number"><span class="hljs-number">2001105214</span></span> ; serial <span class="hljs-number"><span class="hljs-number">28800</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">refresh</span></span> (<span class="hljs-number"><span class="hljs-number">8</span></span> hours) <span class="hljs-number"><span class="hljs-number">14400</span></span> ; retry (<span class="hljs-number"><span class="hljs-number">4</span></span> hours) <span class="hljs-number"><span class="hljs-number">3600000</span></span> ; expire (<span class="hljs-number"><span class="hljs-number">5</span></span> weeks <span class="hljs-number"><span class="hljs-number">6</span></span> days <span class="hljs-number"><span class="hljs-number">16</span></span> hours) <span class="hljs-number"><span class="hljs-number">86400</span></span> ; minimum (<span class="hljs-number"><span class="hljs-number">1</span></span> day) ) NS ns.local. $ORIGIN <span class="hljs-number"><span class="hljs-number">1.168</span></span><span class="hljs-number"><span class="hljs-number">.192</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-addr.arpa. $TTL <span class="hljs-number"><span class="hljs-number">3600</span></span> ; <span class="hljs-number"><span class="hljs-number">1</span></span> hour <span class="hljs-number"><span class="hljs-number">1</span></span> PTR router.local.</code> </pre></div></div><br>  Simply?  And now we will make it so that every computer on the network can be seen not by IP, but by DNS name. <br>  To do this, we need to configure DDNS.  This technology allows you to associate a DHCP server that provides addresses and a DNS server. <br>  First, create a key for our DDNS: <br><pre> <code class="bash hljs">dnssec-keygen -a HMAC-MD5 -b 128 -r /dev/urandom -n USER DDNS_UPDATE</code> </pre><br>  This command will create us 2 files with DDNS-key.  We need the key content: <br><pre> <code class="bash hljs">cat Kddns_update.+157+36693.key DDNS_UPDATE. IN KEY 0 3 157 HEyb0FU9+aOXnYFQiXfiVA==</code> </pre><br>  ‚ÄúHEyb0FU9 + aOXnYFQiXfiVA ==‚Äù is our key. <br>  Let's a little edit our DHCP config by adding the following options to it: <br><pre> <code class="hljs pgsql">ddns-updates <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>; ddns-<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>-style interim; key rndc-key { algorithm HMAC-MD5; secret HEyb0FU9+aOXnYFQiXfiVA==; } <span class="hljs-type"><span class="hljs-type">zone</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span>. { <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; key rndc-key; } <span class="hljs-type"><span class="hljs-type">zone</span></span> <span class="hljs-number"><span class="hljs-number">1.168</span></span><span class="hljs-number"><span class="hljs-number">.192</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-addr.arpa. { <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; key rndc-key; } subnet <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> { ‚Ä¶ ddns-domainname "local."; ddns-rev-domainname "in-addr.arpa."; }</code> </pre><br>  Do the same with DNS: <br><pre> <code class="hljs pgsql">key "rndc-key" { algorithm hmac-md5; secret "HEyb0FU9+aOXnYFQiXfiVA=="; }; <span class="hljs-type"><span class="hljs-type">zone</span></span> "local" <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> { ‚Ä¶ allow-<span class="hljs-keyword"><span class="hljs-keyword">update</span></span> { key rndc-key; }; }; <span class="hljs-type"><span class="hljs-type">zone</span></span> "1.168.192.in-addr.arpa" <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> { ‚Ä¶ allow-<span class="hljs-keyword"><span class="hljs-keyword">update</span></span> { key rndc-key; }; };</code> </pre><br>  Voila - and this killer feature works. <br><br><h4>  The future is still here.  Sixth version </h4><br>  So historically, ¬©, my provider (a contemptuous glance towards Rostelecom) does not issue IPv6 (although <a href="http://www.comnews.ru/node/66310">promised</a> ). <br><blockquote>  At present, throughout the entire length of the Rostelecom network, it has provided the ability to work over IPv6, says the operator‚Äôs press service. </blockquote><br>  Well, fix this misunderstanding.  As a broker, I chose <a href="http://sixxs.net/">sixxs.net</a> - they have tunnel servers in Russia, and their tunnel is easy to configure for the case of dynamic IP. <br>  I will omit the process of registering and getting the tunnel / subnet settings - everything is pretty simple.  I will stop on adjustment. <br>  Setting up IPv6 on the server itself is done in 2 steps.  First, put the aiccu package - this is the tunneling program.  When installing we will be asked for a login and password from sixxs, and some other data.  After launch, we will have a new interface: <br><pre> <code class="hljs pgsql">sixxs Link encap:IPv6-<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-IPv4 inet6 addr: <span class="hljs-number"><span class="hljs-number">2</span></span>a02:<span class="hljs-number"><span class="hljs-number">578</span></span>:<span class="hljs-number"><span class="hljs-number">5002</span></span>:xxx::<span class="hljs-number"><span class="hljs-number">2</span></span>/<span class="hljs-number"><span class="hljs-number">64</span></span> Scope:<span class="hljs-keyword"><span class="hljs-keyword">Global</span></span> UP POINTOPOINT RUNNING NOARP MTU:<span class="hljs-number"><span class="hljs-number">1280</span></span> Metric:<span class="hljs-number"><span class="hljs-number">1</span></span> ‚Ä¶</code> </pre><br>  The server now has access to the v6 network - why not share it with others? <br>  To begin with, let's allow IPv6-forwarding (don't forget to put it in /etc/sysctl.conf): <br><pre> <code class="bash hljs">sysctl net.ipv6.conf.all.forwarding=1</code> </pre> <br>  You do not need to make settings with iptables - hello, 21st century! <br>  Next on the sixxs site we get the subnet.  Its address will be very similar to the address of our tunnel - be careful, they are different! <br>  After receiving the address of the form 2a02: 578: 5002: xxxx :: / 64, proceed to configure it.  First, let's set our server to 2a02: 578: 5002: xxxx :: 1, adding the following lines to interfaces: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">iface</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">br0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet6</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">static</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 2<span class="hljs-selector-tag"><span class="hljs-selector-tag">a02</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:578</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:5002</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:xxxx</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">netmask</span></span> 64</code> </pre><br>  Secondly, let's allow the issuance of IPv6 computers on the network.  Install the radvd package, and configure it as follows: <br><pre> <code class="hljs pgsql">interface br0 { AdvSendAdvert <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>; prefix <span class="hljs-number"><span class="hljs-number">2</span></span>a02:<span class="hljs-number"><span class="hljs-number">578</span></span>:<span class="hljs-number"><span class="hljs-number">5002</span></span>:xxxx::/<span class="hljs-number"><span class="hljs-number">64</span></span> { AdvOnLink <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>; AdvAutonomous <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>; AdvRouterAddr <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>; }; RDNSS <span class="hljs-number"><span class="hljs-number">2</span></span>a02:<span class="hljs-number"><span class="hljs-number">578</span></span>:<span class="hljs-number"><span class="hljs-number">5002</span></span>:xxxx::<span class="hljs-number"><span class="hljs-number">1</span></span> { }; };</code> </pre><br>  Add IPv6 DNS to our bind settings - for complete feng shui: <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">options</span></span> { forwarders { ‚Ä¶ <span class="hljs-number"><span class="hljs-number">2001</span></span>:<span class="hljs-number"><span class="hljs-number">4860</span></span>:<span class="hljs-number"><span class="hljs-number">4860</span></span>::<span class="hljs-number"><span class="hljs-number">8888</span></span>; <span class="hljs-number"><span class="hljs-number">2001</span></span>:<span class="hljs-number"><span class="hljs-number">4860</span></span>:<span class="hljs-number"><span class="hljs-number">4860</span></span>::<span class="hljs-number"><span class="hljs-number">8844</span></span>; }; <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>-v6 { ::<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">128</span></span>; <span class="hljs-number"><span class="hljs-number">2</span></span>a02:<span class="hljs-number"><span class="hljs-number">578</span></span>:<span class="hljs-number"><span class="hljs-number">5002</span></span>:xxxx::/<span class="hljs-number"><span class="hljs-number">64</span></span>; }; ‚Ä¶ };</code> </pre><br>  That's all - now we have access, for example, to <a href="http://ipv6.google.com/">ipv6.google.com</a> , or, which is much more valuable, to <a href="http://ipv6.nnm-club.me/">ipv6.nnm-club.me</a> ;) <br><br><h4>  Penguin looking out the window </h4><br>  I love it when everything is beautiful on my network.  And this is possible only in the case of complete harmony.  For example, when all computers see each other.  For Windows workstations, it is fair to recall WINS (remember, we even issued this setting in DHCP). <br>  Its setup is extremely simple: install the samba package.  The default config needs to be slightly changed: <br><pre> <code class="hljs pgsql">workgroup = WORKGROUP wins support = yes dns proxy = yes interfaces = lo br0 bind interfaces <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> = yes <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">role</span></span> = standalone <span class="hljs-keyword"><span class="hljs-keyword">server</span></span></code> </pre><br>  Checking the results ... Oh, it's all good! <br><img src="https://habrastorage.org/getpro/habr/post_images/b57/353/573/b5735357380a479ac83a872962d7b41f.png"><br>  By the way, since we have samba, you can immediately set up a file dump.  But this is already so hackneyed topic that I leave it on Google‚Äôs shoulders.  In fact, everything should work out of the box - except for read only for homes, turn off yes <b>smbpasswd -a user</b> ... <br><br><h4>  What time is it now? </h4><br>  Set up the distribution of time on the server: install ntp.  With configs, everything is absurdly simple: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">server</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.ru</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pool</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ntp</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.org</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.ru</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pool</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ntp</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.org</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.ru</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pool</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ntp</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.org</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server</span></span> 3<span class="hljs-selector-class"><span class="hljs-selector-class">.ru</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pool</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ntp</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.org</span></span> ‚Ä¶ <span class="hljs-selector-tag"><span class="hljs-selector-tag">broadcast</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span></code> </pre><br>  And here is the result: <br><img src="https://habrastorage.org/getpro/habr/post_images/d6a/328/9e1/d6a3289e13e49984b648a7d0ed0caf9a.png"><br>  We are already close to microtik level routers for $ 150- $ 200.  But this is not all?  Of course not. <br><br><h4>  Killer-feature # 1: I2P </h4><br>  And why not have access to this network without any settings, without proxy servers and so on?  So I think "why."  To get started, let's install the imputed version of Java: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb http://ppa.launchpad.net/webupd8team/java/ubuntu precise main"</span></span> &gt;&gt; /etc/apt/sources.list apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys EEA14886 apt-get update apt-get install oracle-java7-installer</code> </pre><br>  And install the router itself: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb http://deb.i2p2.no/ unstable main"</span></span> &gt;&gt; /etc/apt/sources.list wget <span class="hljs-string"><span class="hljs-string">"http://www.i2p2.de/_static/debian-repo.pub"</span></span> -O- -q | apt-key add - apt-get update apt-get install i2p i2p-keyring</code> </pre><br>  Now we will create a zone directing all requests to * .i2p to our server.  In the bind config: <br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">zone</span></span> "i2p" <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> master; file "/etc/bind/db.i2p"; };</code> </pre><br>  The zone itself: <br><pre> <code class="hljs dos">$ORIGIN i2p $TTL <span class="hljs-number"><span class="hljs-number">7200</span></span> i2p. <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> SOA ns.i2p. hostmaster.i2p. ( <span class="hljs-number"><span class="hljs-number">2010020701</span></span> ; serial <span class="hljs-number"><span class="hljs-number">7200</span></span> ; refresh <span class="hljs-number"><span class="hljs-number">1800</span></span> ; retry <span class="hljs-number"><span class="hljs-number">7200</span></span> ; expire <span class="hljs-number"><span class="hljs-number">7200</span></span> ; minimum ) i2p. <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> NS ns.i2p. ns.i2p. <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> A <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> *.i2p. <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> A <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> *.i2p. <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> AAAA <span class="hljs-number"><span class="hljs-number">2</span></span>a02:<span class="hljs-number"><span class="hljs-number">578</span></span>:<span class="hljs-number"><span class="hljs-number">5002</span></span>:xxxx::<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  Great, but how to handle it now?  It was trivial to wrap all the traffic to the port of the router I did not succeed - the proxy cursed that it could not work that way.  I had to set up a bunch of nginx + php5-fpm and write a small script.  How to do the first part - it is not necessary to search for a long time, the benefit of the manuals on the network is complete.  The second part of: <br><div class="spoiler">  <b class="spoiler_title">/ etc / nginx / sites-enabled / i2p</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">server</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> [<span class="hljs-number"><span class="hljs-number">2</span></span>a02:<span class="hljs-number"><span class="hljs-number">578</span></span>:<span class="hljs-number"><span class="hljs-number">5002</span></span>:xxxx::<span class="hljs-number"><span class="hljs-number">1</span></span>]:<span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span>; #           server_name localhost.i2p; <span class="hljs-keyword"><span class="hljs-keyword">location</span></span> / { proxy_pass http://<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">7657</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> [<span class="hljs-number"><span class="hljs-number">2</span></span>a02:<span class="hljs-number"><span class="hljs-number">578</span></span>:<span class="hljs-number"><span class="hljs-number">5002</span></span>:xxxx::<span class="hljs-number"><span class="hljs-number">1</span></span>]:<span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span>; server_name *.i2p; <span class="hljs-keyword"><span class="hljs-keyword">location</span></span> / { fastcgi_pass unix:/var/run/php5-fpm; <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> fastcgi_params; #     fastcgi_param SCRIPT_FILENAME /etc/nginx/proxy.php; #      HTTP proxy  i2p fastcgi_param PROXY_PASS <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">4444</span></span>; } }</code> </pre></div></div><br>  The script itself can be seen <a href="http://pastebin.com/v8fxgj6b">here</a> . <br>  It's all!  Now we have access to i2p even from the phone - no problem. <br><br><h4>  Killer-feature # 2: make the workplace a working network </h4><br>  So historically ¬©, that I am a system administrator for the remote in several companies.  And it is very useful to have access to them from any computer on the network.  Setting up OpenVPN (or any other) for the server is carried out as for any other client.  For example, after these actions we have a tap0 interface with IP 10.0.0.7/24.  But if we turn to the local network at 10.0.0.1, the traffic will go to the default gateway of the provider.  Fix this flaw: <br><pre> <code class="bash hljs">iptables -t nat -A POSTROUTING -d 10.0.0.0/24 -o tap0 -j MASQUERADE iptables-save &gt; /etc/iptables/rules.v4</code> </pre><br>  We do the same for all networks on the server. <br><br><h4>  Instead of conclusion </h4><br>  We have a full-fledged server that we can use at our discretion.  DNS, nginx, IPv6, i2p ... You can also set a zone for local development, for example, * .dev, and test your sites from any device on the local network.  Since each computer on the network has a permanent IPv6 address, you can access it from anywhere in the world (Security warning! Configure firewalls correctly!). <br>  And this is all - just the tip of the iceberg.  What will be its underwater part - you decide. <br><br>  I will be glad to hear comments, suggestions, sensible criticism and so on.  Thank. </div><p>Source: <a href="https://habr.com/ru/post/203376/">https://habr.com/ru/post/203376/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../203364/index.html">Windows Deployment Services and DHCP server on Linux + a couple of features</a></li>
<li><a href="../203366/index.html">9th Habravstrecha in Kiev</a></li>
<li><a href="../203368/index.html">Android In-app purchasing: paid ad disconnection in your application</a></li>
<li><a href="../203372/index.html">Say thanks to WINAMP ‚Ä¢ thxwinamp.com</a></li>
<li><a href="../203374/index.html">Someone made a $ 160 million bitcoin transaction</a></li>
<li><a href="../203386/index.html">Query optimization. Basics of EXPLAIN in PostgreSQL (Part 2)</a></li>
<li><a href="../203394/index.html">Achiver: what's what</a></li>
<li><a href="../203396/index.html">Preparing video for sound design. Which codec to choose</a></li>
<li><a href="../203398/index.html">There is an error in almost all implementations of binary search and merge sort</a></li>
<li><a href="../203400/index.html">The digest of interesting materials from the world of web development and IT for the last week No. 84 (November 16 - 23, 2013)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>