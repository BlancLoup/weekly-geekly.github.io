<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Some OSM and OpenLayers for enterprise systems</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr, today I will tell you a little about using osm for businesses and b2b. 
 Namely, how and why go from google maps api to osm, openlayers and h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Some OSM and OpenLayers for enterprise systems</h1><div class="post__text post__text-html js-mediator-article">  Hi Habr, today I will tell you a little about using osm for businesses and b2b. <br>  Namely, how and why go from google maps api to osm, openlayers and happiness. <br><a name="habracut"></a><br><h5>  The first question that will certainly arise: why? </h5><br>  To begin with, the use of google maps api for non-public services is limited by the terms of service.  Second: Google's Google Maps is exactly Google's Google Maps, and not to display everything that looks like a map.  Those.  if you wanted to display another substrate or add a raster layer rendered by a server in the local area network, prepare to sculpt the crutches.  Well, just be prepared that if something is not in api, it will be painful to add.  Third: you can not get the map data, respectively, you can not create a local map service for employees of the enterprise.  That is, Google cards must be available from each client machine.  It sounds crazy, but employees are not always open access to external networks. <br><br><h5>  Suppose I convinced you.  Where to begin? </h5><br>  First, we connect the card to the openlayers.  Everything is simple and not much different from google, yandex, leaflet. <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  ,       id='map' var map = new OpenLayers.Map('map'); //     OSM   "OSM mapnik" var layer = new OpenLayers.Layer.OSM('OSM mapnik'); //    map.addLayer(layer); //    ,  ,    . map.zoomToMaxExtent();</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Large companies can often afford to buy a map server and maps and distribute them on the local network via wms or tms.  WMS and TMS are the standards by which you can get map image pieces.  The main difference: for wms you can request an arbitrary piece of a map of arbitrary scale, for tms - a set of scales and dividing the map into small squares, which can be obtained fixedly. <br><br>  Correspondingly, change the wms layer creation string to <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    WMS var wms = new OpenLayers.Layer.WMS( //      "NASA Global Mosaic", // wms    "http://wms.jpl.nasa.gov/wms.cgi", //   wms: // ,  wms      ,       {layers: "modis,global_mosaic"} );</span></span></code> </pre><br><br>  for tms: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    TMS var layer = new OpenLayers.Layer.TMS( //      "My TMS Layer", //  TMS  "http://tilecache.osgeo.org/wms-c/Basic.py/", //   TMS: //    ,     (png/jpeg/gif)  {layername: "basic", type: "png"} );</span></span></code> </pre><br><br>  Also, no one bothers you to add all 3 layers to the map and switch between them, or add one of the layers on top of the other. <br><br><h5>  Projections </h5><br>  Now a few words about the rake, on which you are likely to step on. <br><br>  Suppose you have added a single layer with a map layer with osm.org (OpenLayers.Layer.OSM), but you want the map to open otzummirovannoy to the Moscow region, and not to the whole world.  We look at the latitude and longitude of Moscow and instead <br><br><pre> <code class="javascript hljs">map.zoomToMaxExtent</code> </pre><br>  write <br><br><pre> <code class="javascript hljs">map.moveTo( <span class="hljs-comment"><span class="hljs-comment">//    new OpenLayers.LonLat(37.16, 55.604), // 9 );</span></span></code> </pre><br><br>  And we fall into the ocean.  It's all about the coordinate system.  For the map layer, the native coordinate system is EPSG: 900913.  The reference point of the coordinates in it is the intersection of the Greenwich meridian and the equator, and the units of measure are meters.  Accordingly, we hit 37 meters east and 55 meters north of the reference point. <br><br>  The usual longitude and latitude imply that they are given in EPSG: 4326.  Accordingly, it is necessary to recalculate the coordinates. <br><br><pre> <code class="javascript hljs">map.moveTo( <span class="hljs-comment"><span class="hljs-comment">//   new OpenLayers.LonLat(37.16, 55.604).transform( //   EPSG:4326 new OpenLayers.Projection('EPSG:4326'), //    (EPSG:900913) map.getProjectionObject() ), 9 );</span></span></code> </pre><br><br>  It is better to remember that there are a lot of coordinate systems in the world when specifying any coordinates in the openlayers.  This adds a headache, but allows you to work with customer data if they use something exotic, for example, Pulkovo 42. <br><br>  To do this, connect the proj4js ( <a href="http://trac.osgeo.org/proj4js/wiki/Download">trac.osgeo.org/proj4js/wiki/Download</a> ) and add the line <br><br><pre> <code class="javascript hljs">Proj4js.defs[<span class="hljs-string"><span class="hljs-string">'EPSG:28403'</span></span>] = <span class="hljs-string"><span class="hljs-string">'+proj=tmerc +lat_0=0 +lon_0=39 +k=1 '</span></span> + <span class="hljs-string"><span class="hljs-string">'+x_0=500000 +y_0=0 +no_defs +a=6378140 +rf=298,257223563 +units=m '</span></span> + <span class="hljs-string"><span class="hljs-string">'+towgs84=28.000,-130.000,-95.000 +to_meter=1'</span></span>;</code> </pre><br><br>  Now, when recalculating coordinates, you can specify a new projection. <br><br>  This is not quite Pulkovo 42, but by slightly picking up the parameters, it is possible to achieve a normal display of data over layers in other coordinate systems. <br><br>  Now that we‚Äôve dealt with adding and displaying layers, we‚Äôll move on to the markers, lines, and event handling. <br><br><h5>  Markers </h5><br>  There are 2 types in the drivers: <br>  HTML (OpenLayers.Marker) and vector (OpenLayers.Geometry.Point).  A little later, I will explain what is meant by a marker and why point. <br><br>  HTML marker creates one or several divs, in which it places a picture and places it above the map in accordance with the coordinates.  If you have ever watched a firebug or another debugger as a marker on a Google map, everything will be familiar to you.  It is relatively easy for them to connect popups, it‚Äôs easy (since there is an html object) to work with from jQuerry, and yet the creators of the library do not recommend using them.  Why?  They are somewhat heavy: when you have 1 marker - everything is fine, when a thousand is bad.  They are out of the general concept of storing and displaying data adopted in ol.  Well, for practical reasons: when I started working with trainers, for such markers there was no drag control.  However, it is not there now. <br><br>  However, some code to add markers to the map: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    var markers = new OpenLayers.Layer.Markers( "Markers" ); //    map.addLayer(markers); //,    var lonLat = new OpenLayers.LonLat( 0, 0 ); //       0, 0 //    markers.addMarker(new OpenLayers.Marker(lonLat));</span></span></code> </pre><br><br>  Yes, there may be several layers with markers.  Yes, you can control the visibility of layers and hide groups of markers as you like. <br><br>  Now about who the vector markers are and about the ‚Äúconcept of storing and displaying data‚Äù. <br>  Few people are now satisfied with the ability to simply display different raster layers with maps.  The main charm in displaying your unique data on top of them.  So, suppose we want to display on top of the map optical cables, copper cables and wells / supports through which this stuff passes.  Each object will contain geometric information (how the cable itself passes / where the support or well is located) and attribute information (cable type, number of cable cores, signal attenuation, support height ... the list can be added to infinity).  Actually this idea is directly implemented in Leers: <br><br>  The object, ‚ÄúOpenLayers.Feature.Vector‚Äù, is stored along with its attributes, geometry, and, optionally, the display style. <br>  For point features: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpenLayers.Feature.Vector( <span class="hljs-comment"><span class="hljs-comment">// -    x, y (x -longitude, y - latitude) new OpenLayers.Geometry.Point(x, y), //: ,  {'type':'pillon', 'height':100}, //,         . //        null );</span></span></code> </pre><br><br>  A few words about styles. <br>  In styles, you can specify how to display the geometry, using the attributes of the object.  Depending on the type, you can use different icons, for example, draw wells with circles, and supports - with bars.  You can define the fill color, thickness, and stroke color.  Based on the attributes, text labels can be displayed for objects, etc.  You can set a style for a specific object, for example, you can assign a style to a layer so that all the objects in the layer are displayed in accordance with it. <br><br>  And yet to the markers: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   . //Markers -      . //     {showInLayerSwitcher: false} //      . var markers = new OpenLayers.Layer.Vector('Markers'); //    map.addLayer(markers); //,     var marker = new OpenLayers.Feature.Vector( /// new OpenLayers.Geometry.Point(0, 0), //   {}, //,   { //  externalGraphic:'http://someware.com/my_favorite_marker_icon.png', //   graphicWidth:16, //   * graphicHeight:16, //   8   //   graphicXOffset:-8, //  16   graphicYOffset:-16, //   (     ) label:'   ', //     -  labelAlign: 'ct', //   5   labelYOffset: '5' } ); markers.addFeatures([marker]);</span></span></code> </pre><br>  * Dear grammar-nazi, it was an allusion to the children's song. <br><br>  If you need to add several markers with the same style, it‚Äôs enough to use the same style object, but it is important to remember that changes in the style instance will affect all markers. <br><br>  So, we added a marker.  Now let's add the ability to move it, click on it, and respond to other events.  Actually, event handling is the most different from other libraries that have been worked with (attentive reader who reads the whole article, without missing paragraphs, finds out that, first of all, it‚Äôs google and a bit of leaflet with Yandex). <br><br>  Add a drag: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     ,      . var drag = OpenLayers.Control.DragFeature(markers); //      ,     //OpenLayers.Layer.Vector.RootContainer    // //    map.addControl(drag); //  //(      ,  ...) drag.activate();</span></span></code> </pre><br><br>  If the memory does not fail me, you will finally get to move the markers on the map. <br><br>  Or add our popup marker on the click: <br><br><pre> <code class="javascript hljs">selectControl = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpenLayers.Control.SelectFeature(markers, { <span class="hljs-comment"><span class="hljs-comment">//     onSelect: onFeatureSelect, //     onUnselect: onFeatureUnselect }); function onFeatureSelect(feature) { popup = new OpenLayers.Popup.FramedCloud("chicken", feature.geometry.getBounds().getCenterLonLat(), null, "&lt;div style='font-size:.8em'&gt; Habr!&lt;/div&gt;", null, true, onPopupClose ); feature.popup = popup; map.addPopup(popup); } function onFeatureUnselect(feature) { map.removePopup(feature.popup); feature.popup.destroy(); feature.popup = null; }</span></span></code> </pre><br>  You can see an example here: <a href="http://openlayers.org/dev/examples/select-feature-openpopup.html">openlayers.org/dev/examples/select-feature-openpopup.html</a> <br><br>  Big problems start when you need to: <br><ul><li>  be able to move markers </li><li>  display hover (i.e. handle onmousein and onmouseout) </li><li>  handle click, double click on object </li><li>  handle click, dubclick outside object </li></ul><br><br>  This is a solvable problem, but the solution, perhaps, deserves a separate article. <br><br><h5>  Geocoding </h5><br>  Fuf, we added OSM to the site and learned how to display our data over.  But still a significant part of Google's api (Yandex) is left out.  Namely, geocoding (getting coordinates by address and addresses by coordinates) and routing. <br><br>  About card routing in OSM I will tell you another time, now a few words about geocoding.  I did not do reverse geocoding (address by coordinates), so I‚Äôll stop looking at coordinates by address. <br><br>  There are several options: use a ready-made search from nominatim or openstreetmap.ru, write your bike.  A few words about why you might need your geocoder. <br><br>  1. For example, you are only interested in Moscow, respectively, the data will be easier to import, and search queries will be simple, without specifying the city. <br>  2. For some reason you can not give access to the external either from client machines or from the server. <br>  3. You need a geocoder on your own client address database. <br><br>  Well, there is no magic: the simplest option is to use Solr or Sphynx.  In fact, I simply save the documents with the full address and coordinates of the object to solr. <br><br>  To get a list of addresses, you can, for example, take the region of interest to you in shp format, load it into postgis, and then get addresses with a query like: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> bldng.osm_id, bldng.<span class="hljs-string"><span class="hljs-string">"A_STRT"</span></span>, bldng.<span class="hljs-string"><span class="hljs-string">"A_SBRB"</span></span>, bldng.<span class="hljs-string"><span class="hljs-string">"A_HSNMBR"</span></span>, settle.<span class="hljs-string"><span class="hljs-string">"NAME"</span></span>, ST_AsText(ST_Centroid(bldng.geom)) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> building-polygon bldng <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> settlement-polygon settle <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ST_Within(bldng.geom, settle.geom)</code> </pre><br><br>  That's all for today.  Next time I will try to tell you more about the event system in openlayers. <br><br><h5>  Links </h5><br>  Openlayers documentation - <a href="http://dev.openlayers.org/docs/files/OpenLayers/Map-js.html">dev.openlayers.org/docs/files/OpenLayers/Map-js.html</a> <br><br>  There's also a sandbox with examples - <a href="http://openlayers.org/dev/examples/">openlayers.org/dev/examples</a> <br><br>  Proj4js - <a href="http://trac.osgeo.org/proj4js/">trac.osgeo.org/proj4js</a> <br><br>  A site with a description of different coordinate systems in different formats, <br>  including in the proj4 format - <a href="http://spatialreference.org/">spatialreference.org</a> </div><p>Source: <a href="https://habr.com/ru/post/145552/">https://habr.com/ru/post/145552/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145547/index.html">WWDC and iOS 6: what are we waiting for?</a></li>
<li><a href="../145548/index.html">Creating a custom map control using the Yandex.Maps API 2.0</a></li>
<li><a href="../145549/index.html">Visual Studio Express 2012 for Windows Desktop</a></li>
<li><a href="../145550/index.html">Automation of music management in the office, any song on order via ICQ</a></li>
<li><a href="../145551/index.html">Test task for the Connected FixedThreadPool on C #. What is wrong here? UPD</a></li>
<li><a href="../145553/index.html">Effective role assignment through the RACI matrix (Updated)</a></li>
<li><a href="../145555/index.html">Optimize iOS application resources</a></li>
<li><a href="../145558/index.html">Mozilla Shumway - open source SWF to HTML5 converter</a></li>
<li><a href="../145559/index.html">Icenium: cross-platform cloud environment for creating mobile applications</a></li>
<li><a href="../145560/index.html">A little about the beauty of T-fractals</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>