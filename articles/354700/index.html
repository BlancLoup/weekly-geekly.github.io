<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Is there life without architecture?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most of the code for most modern applications was probably written in the days of Android 4.0. Applications survived the time of ContentProvider, Robo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Is there life without architecture?</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/7w/b_/h-/7wb_h-peunvu4kahir2yez8zzmq.jpeg" width="620" height="450"></div><br><p>  Most of the code for most modern applications was probably written in the days of Android 4.0.  Applications survived the time of ContentProvider, <a href="https://github.com/stephanenicolas/robospice">RoboSpice</a> , <a href="https://github.com/JakeWharton/ActionBarSherlock">various libraries</a> and <a href="https://docs.google.com/file/d/0B2dn_3573C3RdlVpU2JBWXdSb3c/edit">architectural approaches</a> .  Therefore, it is very important to have an architecture that will remain flexible not only for functional changes, but also ready for new developments, technologies and tools. </p><br><p>  In this article, I would like to talk about the architecture of the IFunny application, the principles that we adhere to, and how the main problems that arise during the development process are solved. </p><a name="habracut"></a><br><p>  Let's start with the moments that I consider fundamental in the development: </p><br><ul><li>  <strong>speak the same language within the team.</strong>  Each new developer has his own vision of the architecture and can introduce entropy into the existing code.  I would like to have a basic pattern for building individual independent components of the application; </li><li>  <strong>lack of global abstractions.</strong>  At the same time, I do not want to drive myself into the framework and implement each component as it is more convenient, and not as the architecture of the application dictates.  The architecture should work for the developer, not the other way around; </li><li>  <strong>reuse of components: the</strong> ability to use existing code as simply as possible; </li><li>  <strong>screen rotation processing.</strong>  One of the main problems of the application is the restoration of the screen after rotating or re-creating the Activity / Fragment.  Until now, we have added all the data in the Bundle to <em>onSaveInstansState / onRestoreInstanceState</em> ; </li><li>  <strong>correct processing of the application life cycle</strong> ; </li><li>  <strong>unidirectionality of data flows:</strong> evidence of the order of data processing within an application. </li></ul><br><p>  Now let's take a look at what we came to and how we solved each problem. </p><br><img src="https://habrastorage.org/getpro/habr/post_images/065/d3b/2b0/065d3b2b0933ed85f640855a195c6879.gif" align="left" width="300" height="530"><br><p>  Initially, when developing an application, there was some kind of MVC, where Activity / Fragment served as the controller.  In small applications, this is a fairly convenient pattern that does not require strong abstractions, and this pattern was initially dictated by the platform. </p><br><p>  But over time, Activity / Fragment grows to unreadable sizes (our record is 3 thousand lines of code in one of the Fragments).  Each new functional is in any way based on the state of the current code, and it is difficult not to continue adding code to these classes. <br></p><br><p>  We came to the conclusion that the entire screen needs to be split into independent components, and we have identified a separate entity for this: </p><br><div class="spoiler">  <b class="spoiler_title">ViewController.java</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewController</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewModel</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">D</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ViewModelContainer&lt;T&gt; container, @Nullable D data)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">detach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">ViewModelContainer.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewModelContainer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewModel</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LifecycleOwner</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">View </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getViewModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> </div></div><br><p>  Now Fragment looks like this: </p><br><div class="spoiler">  <b class="spoiler_title">ChatFragment.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChatFragment</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TrackedFragmentSubscriber</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewModelContainer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChatViewModel</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMessengerFragment</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> ChatMessagesViewController mChatViewController; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> TimeInfoViewController mTimeInfoViewController; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> ChatToolbarViewController mChatToolbarViewController; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> SendMessageViewController mSendMessageViewController; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> MessagesPaginationController mMessagesPaginationController; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> ViewModelProvider.Factory mViewModelFactory; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> UnreadMessagesViewController mUnreadMessagesViewController; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> UploadFileProgressViewController mUploadFileProgressViewController; <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> View </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreateView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> inflater.inflate(R.layout.face_to_face_chat, container, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onViewCreated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view, @Nullable Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onViewCreated(view, savedInstanceState); mChatViewController.attach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); mSendMessageViewController.attach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); mChatToolbarViewController.attach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); mMessagesPaginationController.attach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); mUnreadMessagesViewController.attach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); mTimeInfoViewController.attach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); mUploadFileProgressViewController.attach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroyView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ mUploadFileProgressViewController.detach(); mTimeInfoViewController.detach(); mUnreadMessagesViewController.detach(); mMessagesPaginationController.detach(); mChatToolbarViewController.detach(); mSendMessageViewController.detach(); mChatViewController.detach(); <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onDestroyView(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ChatViewModel </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getViewModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ViewModelProviders .of(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, mViewModelFactory) .get(ChatViewModel.class); } }</code> </pre> </div></div><br><p>  This approach gives many advantages at once: </p><br><ul><li>  <strong>reuse of components;</strong> <br>  For example, there are several screens that use the search string: </li></ul><br><p><img src="https://habrastorage.org/webt/l-/wx/ew/l-wxewb73tei7pca1f7h9ow9ois.gif" width="200" height="350"><img src="https://habrastorage.org/webt/nu/j7/an/nuj7anonqe_8oui4oxbpuio7auy.gif" width="200" height="350"><img src="https://habrastorage.org/webt/js/2w/qr/js2wqrimt5dekiqlnfvnbejhnhc.gif" width="200" height="350"></p><br><p>  To add this behavior, you only need to register in the code: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onViewCreated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view, @Nullable Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onViewCreated(view, savedInstanceState); mSearchFieldViewController.attach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); }</code> </pre> <br><p>  Or, for example, search results with the possibility of multiple selection, while the types of data themselves, the sources of this data, navigation and strategies, caching are completely different.  Matches only the display: </p><br><p><img src="https://habrastorage.org/webt/5x/nf/l5/5xnfl5cvt8trxp96nleoynovwio.jpeg" width="300" height="530"><img src="https://habrastorage.org/webt/vv/mr/6k/vvmr6k-j6eq6s03kl112ttmxyeo.jpeg" width="300" height="530"></p><br><ul><li>  <strong>testability</strong>  There is no need to create a Fragment / Activity to test the behavior of a single screen; </li><li>  <strong>modularity.</strong>  Separate parts of the application (UI or data processing) can be developed without binding to each other; </li><li>  but at the same time <strong>, no restrictions for developers are added</strong> and in each individual component you can use your own architectural approach (MVC, MVI, MVVM or any other MVX).  This abstraction only separates us from the Android components and sets the general style for writing code; </li></ul><br><p>  Then you need to organize the data structure.  It is necessary to store the status of screens somewhere and experience the re-creation of Activity / Fragment. </p><br><p>  Why data storage in the Bundle does not suit us: </p><br><ul><li>  too much boilerplate code; </li><li>  the life cycle of fragments and the order of calling methods are rather complicated  Saving View states and data in them is not obvious; </li></ul><br><div class="spoiler">  <b class="spoiler_title">One of the many nuances</b> <div class="spoiler_text"><p>  Thus, Activity restores the state of its View: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onRestoreInstanceState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mWindow != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Bundle windowState = savedInstanceState.getBundle(WINDOW_HIERARCHY_TAG); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (windowState != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mWindow.restoreHierarchyState(windowState); } } }</code> </pre> <br><p>  And if within the overridden <em>onRestoreInstanceState to</em> update the adapter RecycleView, the scrolled by default will be reset; </p></div></div><br><ul><li>  for all heavy data, it is necessary to organize storage in the database, otherwise you can catch TooLargeTransactionException. </li></ul><br><p>  We decided to use the <em>retain fragment</em> , namely, a convenient wrapper for them from Google in the form of a ViewModel.  These objects live in the FragmentManager as non-recreated Fragments. </p><br><p>  <strong><em>How it works</em></strong> <br>  <em>FragmentManager stores such objects in a separate field in FragmentManagerNonConfig.</em>  <em>This object is experiencing a re-creation of the Activity and the FragmentManager in a memory area outside the FragmentManager, in an object called ActivityClientRecord.</em>  <em>This object is formed during Activity.onDestroy and restores the state to Activity.attach.</em>  <em>But he is able to recover only by turning the screen.</em>  <em>Those.</em>  <em>if the system ‚Äúnailed‚Äù the Activity, then nothing will be saved</em> . </p><br><p>  Each ViewController needs its own ViewModel, in which its state will be located.  He also needs a View to display data in it.  This data is transmitted via ViewModelContainer, which is implemented by an Activity or Fragment. </p><br><p>  Now you need to organize the flow of data and states between components.  In fact, in this task, you can use several options.  For example, a good solution is to use Rx to interact between the ViewController and the ViewModel. <br>  We decided to try using LiveData for this purpose. <br>  LiveData is a kind of flow in Rx without a lot of operators (there are really not enough operators, so you have to use LiveData and Rx side by side), but with the ability to cache data and process the application life cycle. </p><br><p>  In general, all data lies inside the ViewModel.  At the same time, data processing takes place outside it.  ViewController simply initiates events and waits for data through the observer on the ViewModel. <br>  Inside the ViewModel are the necessary LiveData objects that cache all these states.  When you rotate the screen, the ViewController is re-created, subscribes to the data and the last state comes to it. </p><br><div class="spoiler">  <b class="spoiler_title">ChatViewModel.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChatViewModel</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MessageRepositoryFacade mMessageRepositoryFacade; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> CurrentChannelProvider mCurrentChannelProvider; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SendbirdConnectionManager mSendbirdConnectionManager; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MediatorLiveData&lt;List&lt;MessageModel&gt;&gt; mMessages = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MediatorLiveData&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MutableLiveData&lt;String&gt; mMessage = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MutableLiveData&lt;&gt;(); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ChatViewModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MessageRepositoryFacade messageRepositoryFacade, SendbirdConnectionManager sendbirdConnectionManager, CurrentChannelProvider currentChannelProvider)</span></span></span><span class="hljs-function"> </span></span>{ mMessageRepositoryFacade = messageRepositoryFacade; mCurrentChannelProvider = currentChannelProvider; mSendbirdConnectionManager = sendbirdConnectionManager; initLiveData(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> LiveData&lt;List&lt;MessageModel&gt;&gt; getMessages() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mMessages; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message)</span></span></span><span class="hljs-function"> </span></span>{ mMessage.postValue(message); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... } private void initLiveData() { LiveData&lt;List&lt;MessageModel&gt;&gt; messages = Transformations.switchMap(mCurrentChannelProvider.getCurrentChannel(), input -&gt; { if (!Resource.isDataNotNull(input)) { return AbsentLiveData.create(); } return mMessageRepositoryFacade.getMessagesList(input.data.mUrl); }); mMessages.addSource(messages, mMessages::setValue); mMessages.addSource(mSendbirdConnectionManager.getConnectionStateLiveData(), connectionState -&gt; { if (connectionState == null) { return; } switch (connectionState) { case OPEN: // ... break; case CLOSED: // ... break; } }); } }</span></span></code> </pre></div></div><br><p>  To initialize the View, we use the ButterKnife and the ViewHolder approach to get rid of the weakness of the initialized View. <br>  Each ViewController has its own ViewHolder, which is initialized to the call to <em>attach</em> , with the <em>detach</em> ViewHolder set to zero.  All fields in the display are written in his successor. </p><br><div class="spoiler">  <b class="spoiler_title">ViewHolder.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewHolder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Unbinder mUnbinder; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> View mView; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ViewHolder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view)</span></span></span><span class="hljs-function"> </span></span>{ mView = view; mUnbinder = ButterKnife.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, view); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unbind</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ mUnbinder.unbind(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> View </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mView; } }</code> </pre> </div></div><br><p>  Next we describe the controllers for our screen: </p><br><div class="spoiler">  <b class="spoiler_title">SendMessageViewController.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@ActivityScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SendMessageViewController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleViewController</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChatViewModel</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ViewHolder mViewHolder; <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ChatViewModel mChatViewModel; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendMessageViewController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ViewModelContainer&lt;ChatViewModel&gt; container)</span></span></span><span class="hljs-function"> </span></span>{ mViewHolder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ViewHolder(container.getView()); mChatViewModel = container.getViewModel(); mViewHolder.mSendMessageButton.setOnClickListener(v -&gt; mChatViewModel.sendMessage()); mViewHolder.mChatTextEdit.addTextChangedListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleTextWatcher() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">afterTextChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Editable s)</span></span></span><span class="hljs-function"> </span></span>{ mChatViewModel.setMessage(s.toString()); } }); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">detach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ViewHolderUtil.unbind(mViewHolder); mChatViewModel = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; mViewHolder = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChatViewHolder</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewHolder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@BindView</span></span>(R.id.message_edit_text) EmojiconEditText mChatTextEdit; <span class="hljs-meta"><span class="hljs-meta">@BindView</span></span>(R.id.send_message_button) ImageView mSendMessageButton; <span class="hljs-meta"><span class="hljs-meta">@BindView</span></span>(R.id.message_list) RecyclerView mRecyclerView; <span class="hljs-meta"><span class="hljs-meta">@BindView</span></span>(R.id.send_panel) View mSendPanel; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ViewHolder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(view); } } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">ChatMessagesViewController.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@ActivityScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChatMessagesViewController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleViewController</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChatViewModel</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ChatAdapter mChatAdapter; <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ChatViewModel mChatViewModel; <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ViewHolder mViewHolder; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ChatMessagesViewController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChatAdapter chatAdapter)</span></span></span><span class="hljs-function"> </span></span>{ mChatAdapter = chatAdapter; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ViewModelContainer&lt;ChatViewModel&gt; container)</span></span></span><span class="hljs-function"> </span></span>{ mChatViewModel = container.getViewModel(); mViewHolder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ViewHolder(container.getView()); mViewHolder.mRecyclerView.setAdapter(mChatAdapter); mChatViewModel.getMessages().observe(container, data -&gt; mChatAdapter.updateMessages(data)); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">detach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ViewHolderUtil.unbind(mViewHolder); mViewHolder = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; mChatViewModel = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SendMessageViewHolder</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewHolder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@BindView</span></span>(R.id.message_list) RecyclerView mRecyclerView; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ViewHolder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(view); LinearLayoutManager linearLayoutManager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinearLayoutManager(view.getContext()); linearLayoutManager.setReverseLayout(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); linearLayoutManager.setStackFromEnd(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); mRecyclerView.setLayoutManager(linearLayoutManager); } } }</code> </pre> </div></div><br><p>  Due to the LiveData logic, our list is not updated between onStop and onStart, since at this time LiveData is inactive, but new messages can still come through the push. </p><br><img src="https://habrastorage.org/webt/4m/nf/5i/4mnf5imxawm7mszgaxnkcj3rhlo.gif" width="300" height="530" align="left"><br><p>  This allows you to encapsulate the implementation of data storage and also makes obvious the order of calls between classes.  What do I mean by calling order? <br>  <em>For example, take MVP.</em> <em><br></em>  <em>It is implied that Presenter and View have links to each other.</em>  <em>View sends user events to the Presenter.</em>  <em>He somehow processes them and gives the results back.</em>  <em>With this interaction there is no clarity in the data streams.</em>  <em>Since both objects have explicit references to each other (and the interfaces do not break this connection, but only abstract it a little), calls go in both directions and a dispute begins about how far the View should be passive;</em>  <em>what to forward and what to handle itself, etc.</em>  <em>etc.</em>  <em>Also in this regard, often start the race for Presenter.</em> </p><br><p>  In our case, it is obvious that user data is also cached in the database.  But caching occurs asynchronously, and the user response does not depend on it in any way, since immediately after they are received, they fast in LiveData. </p><br><h3 id="kak-eto-vsyo-druzhit-s-mnogopotochnostyu-setevymi-vyzovami">  How is all this friendly with multithreading, network calls? </h3><br><p>  All network requests come from the context of classes that do not have references to Activity or Fragment, data from requests are processed in global classes, which are also in the Application.  The mapping gets this data through observer or any other listener.  If this is done via LiveData, then we will not update our mapping between onPause and onStart. <br>  Heavy operations associated only with the display (pick up data from the database, zadkodit image, write to a file) come from the context of ViewModel and fasting either through Rx or through LiveData.  When the display is recreated, the results of these operations remain in memory, and this does not lead to any leaks. </p><br><p>  If we talk about the disadvantages of LiveData and ViewModel, we can highlight the following points: </p><br><ul><li>  LiveData is active only between onStart and onStop, that is, it works after onSaveInstanceState, and after that you need to be attentive to the interaction with the FragmenManager; </li><li>  lack of operators to work with LiveData, and without Rx it is quite limited; </li><li>  ViewModel does not experience re-creation of Activity, if the system <em>(Don't keep activities)</em> killed it, which means that some of the important data cannot be cached only in LiveData; </li><li>  The ViewModel inherits all the problems of the re-created nested fragments. </li></ul><br><h3 id="vyvod">  Conclusion </h3><br><p>  Actually everything that is written in the article seems rather primitive and obvious, but we consider the principle of Keep It Simple, Stupid to be one of the main ones in development, because following the simplest architectural principles you can solve most of the technical problems faced by any developer when writing an application .  And no matter what it is called - MVP, MVC or MVVM - the main thing is to understand why you need it and what problems it will help to solve. </p><br><p>  <a href="https://developer.android.com/topic/libraries/architecture/guide.html">https://developer.android.com/topic/libraries/architecture/guide.html</a> <br>  <a href="https://en.wikipedia.org/wiki/KISS_principle">https://en.wikipedia.org/wiki/KISS_principle</a> <br>  <a href="https://www.androiddesignpatterns.com/2013/08/fragment-transaction-commit-state-loss.html">https://www.androiddesignpatterns.com/2013/08/fragment-transaction-commit-state-loss.html</a> <br>  <a href="https://android.jlelse.eu/android-architecture-components-viewmodel-e74faddf5b94">https://android.jlelse.eu/android-architecture-components-viewmodel-e74faddf5b94</a> <br>  <a href="http://hannesdorfmann.com/android/arch-components-purist">http://hannesdorfmann.com/android/arch-components-purist</a> </p><br></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/354700/">https://habr.com/ru/post/354700/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354690/index.html">Experience with WebAssembly or as C ++ undefined behavior shot in the leg</a></li>
<li><a href="../354692/index.html">Calculation of logical expressions in a string inside Java / Scala / Kotlin code</a></li>
<li><a href="../354694/index.html">Again about the trees</a></li>
<li><a href="../354696/index.html">Riddles resume. Part 1. Choosing a form</a></li>
<li><a href="../354698/index.html">A brief history of information security in China: how to build the Great Chinese firewall</a></li>
<li><a href="../354702/index.html">The solution to the problem of detecting the center line of the vessel</a></li>
<li><a href="../354704/index.html">ScadaPy Creator for python</a></li>
<li><a href="../354706/index.html">Twirp vs. gRPC. Is it worth it?</a></li>
<li><a href="../354708/index.html">Transparent HTTPS proxy to bypass Roskomnadzor‚Äôs locks</a></li>
<li><a href="../354710/index.html">MikroTik & OpenWRT & DNSCrypt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>