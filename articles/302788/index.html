<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As a programmer, I bought a car</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I was puzzled by the search B. car, in exchange for just sold, and, as is usually the case, several competitors claimed this role. 

 As you...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As a programmer, I bought a car</h1><div class="post__text post__text-html js-mediator-article">  Recently, I was puzzled by the search B.  car, in exchange for just sold, and, as is usually the case, several competitors claimed this role. <br><br>  As you know, for the purchase of cars on the territory of the Russian Federation there are several large reputable sites (auto.ru, drom.ru, avito.ru), on which I gave preference.  My requirements were met by hundreds, and for some models, thousands of cars from the sites listed above.  Apart from the fact that it is inconvenient to search on several resources, I would also like to select the most profitable (the price of which relative to the market is undervalued) proposals for a priori information that each resource provides before going to watch the car ‚Äúlive‚Äù.  Of course, I really wanted to solve several overdetermined systems of algebraic equations (possibly nonlinear) of high dimension manually, but I overpowered myself and decided to automate this process. <br><img src="https://habrastorage.org/files/208/b4a/9d1/208b4a9d14e44cb5ba4b37675dad369d.jpg" alt="image"><br><a name="habracut"></a><br><h2>  Data collection </h2><br>  I collected data from all the resources described above, and I was interested in the following parameters: <br><br><ul><li>  price (price) </li><li>  year of manufacture </li><li>  mileage </li><li>  engine capacity (engine.capacity) </li><li>  engine power (engine.power) </li><li>  engine type (2 <a href="https://en.wikipedia.org/wiki/Dummy_variable_%2528statistics%2529">indicator</a> mutually exclusive variables diesel and hybrid, taking the values ‚Äã‚Äã0 or 1, for diesel and hybrid engines, respectively).  The default engine type is gasoline (not rendered into the third variable in order to avoid <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D1%2583%25D0%25BB%25D1%258C%25D1%2582%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25BB%25D0%25BB%25D0%25B8%25D0%25BD%25D0%25B5%25D0%25B0%25D1%2580%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C">multicollinearity</a> ). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this way: <br><br><img src="https://habrastorage.org/files/11e/7cf/731/11e7cf73141e4acdba6c1061941c8737.jpg" alt="image"><br><br>  Further, similar logic for indicator variables is implied by default. </li><li>  type of gearbox (indicator variable mt (manual transmission), which takes a boolean value, for a manual transmission).  The type of gearbox is automatic by default. <br><br>  It should be noted that I referred to automatic transmissions as not only a classic hydraulic automatic, but also robotic mechanics and a CVT. </li><li>  drive type (2 indicator variables front.drive and rear.drive, taking boolean values).  The default drive type is full. </li><li>  body type (7 indicator variables sedan, hatchback, wagon, coupe, cabriolet, minivan, pickup, taking boolean values).  Body type default - SUV / crossover </li></ul><br>  I noted the data not filled by lazy sellers as NA (Not Available) so that these values ‚Äã‚Äãcould be correctly processed with <a href="https://www.r-project.org/">R.</a> <br><br><h2>  Data visualization </h2><br>  In order not to go into the dry theory, let's look at a specific example, we will look for profitable Mercedes-Benz E-klasse not older than the 2010 release, worth up to 1.5 million rubles in Moscow.  In order to start working with data, first of all we fill in the missing values ‚Äã‚Äã(NA) for medians, the benefit for which in R is the median () function. <br><br><pre><code>dat &lt;- read.csv("dataset.txt") #    R

dat$mileage[is.na(dat$mileage)] &lt;- median(na.omit(dat$mileage)) #   
</code></pre><br>
    ,    .<br>
<br>
       (        ).<br>
<br>
<img src="https://habrastorage.org/files/f43/eed/a50/f43eeda50d4d492c92ea46c86f60f20a.jpg" alt="image"><br>
<br>
       2013     2014!<br>
<br>
<img src="https://habrastorage.org/files/271/6cf/599/2716cf599e634387a07716c29e1ad719.jpg" alt="image"><br>
<br>
,    ,   .<br>
<br>
<img src="https://habrastorage.org/files/a8a/a84/ce4/a8aa84ce43e343b0a2b6102dcfa5dd0f.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/files/db2/4ae/d32/db24aed32dda4aefbce652fad98a9a40.jpg" alt="image"><br>
<br>
           ‚Äî <a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D1%258B%25D0%25B1%25D1%2580%25D0%25BE%25D1%2581_%2528%25D1%2581%25D1%2582%25D0%25B0%25D1%2582%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25B0%2529"></a>,  ,          .<br>
<br>
      ,       ,      ,     ‚Äú‚Äù,         ,    .<br>
<br>
,      ,        .<br>
<br>
<h2> </h2><br>
  ,    ,         ,        <a href="https://ru.wikipedia.org/wiki/%25D0%259B%25D0%25B8%25D0%25BD%25D0%25B5%25D0%25B9%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2580%25D0%25B5%25D0%25B3%25D1%2580%25D0%25B5%25D1%2581%25D1%2581%25D0%25B8%25D1%258F">  </a>,    .<br>
<br>
   ,    <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B5%25D0%25BE%25D1%2580%25D0%25B5%25D0%25BC%25D0%25B0_%25D0%2593%25D0%25B0%25D1%2583%25D1%2581%25D1%2581%25D0%25B0_%25E2%2580%2594_%25D0%259C%25D0%25B0%25D1%2580%25D0%25BA%25D0%25BE%25D0%25B2%25D0%25B0"> -</a>:<br>
<br>
<ol>
<li>   , ..:<br>
<ul>
<li>  . <br>
<br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text">   (.    ),     .<br>
</div></div><br>
</li>
<li>   .<br>
<br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"> ,    :<br>
<br>
<pre><code>dat_cor &lt;- as.matrix(cor(dat)) #    

dat_cor[is.na(dat_cor)] &lt;- 0 #     0 (..          )

library(corrplot) #   corrplot,   

palette &lt;-colorRampPalette(c("#7F0000","red","#FF7F00","yellow","#7FFF7F", "cyan", "#007FFF", "blue","#00007F"))

corrplot(dat_cor, method="color", col=palette(20), cl.length=21,order = "AOE", addCoef.col="green") #     
</code></pre><br>
<img src="https://habrastorage.org/files/234/8d8/312/2348d83120994c2898a4a953b3710c4b.jpg" alt="image"><br>
<br>
     (&gt;0.7)     ,          engine.capacity, ..               ( ,   ,   ‚Äî          ).<br>
</div></div><br>
</li>
<li> <a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D1%258B%25D0%25B1%25D1%2580%25D0%25BE%25D1%2581_%2528%25D1%2581%25D1%2582%25D0%25B0%25D1%2582%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25B0%2529"></a>. <br>
<br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"> ‚Äî      (.    ),        .  ,     ,   ‚Äî      ,  , ,  <a href="https://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25BE%25D0%25B1%25D0%25B0%25D1%2581%25D1%2582%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C_%25D0%25B2_%25D1%2581%25D1%2582%25D0%25B0%25D1%2582%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25B5"></a>      .<br>
<br>
           .  ,    , dffits,   (covratio),  ,   i-       ,        .   ,   dfbetas,   i-      .<br>
<br>
  (covratio) ‚Äî    .         i-         .<br>
<br>
         ,       ,      ,     dffits.<br>
<br>
  ‚Äî      ,  ..               ,       .<br>
 ,       dffits  covratio.<br>
<br>
<pre><code>model &lt;- lm(price ~ year + mileage  + diesel + hybrid + mt + front.drive + rear.drive + engine.power + sedan + hatchback + wagon + coupe + cabriolet + minivan + pickup, data = dat) #  

model.dffits &lt;- dffits(model) #   dffits
</code></pre><br>
   dffits     2*sqrt(k/n) = 0.42,     (k ‚Äî  , n ‚Äî   ).<br>
<br>
<pre><code>model.dffits.we &lt;- model.dffits[model.dffits &lt; 0.42]

model.covratio &lt;- covratio(model)  #     
</code></pre><br>
   covratio      | model.covratio[i] -1 | &gt; (3*k)/n.<br>
<br>
<pre><code>model.covratio.we &lt;- model.covratio[abs(model.covratio -1) &lt; 0.13]

dat.we &lt;- dat[intersect(c(rownames(as.matrix(model.dffits.we))), c(rownames(as.matrix(model.covratio.we)))),] #   

model.we &lt;- lm(price ~ year + mileage  + diesel + hybrid + mt + front.drive + rear.drive + engine.power + sedan + hatchback + wagon + coupe + cabriolet + minivan + pickup, data = dat.we) #       
</code></pre><br>
 ,       ,       .<br>
<br>
<img src="https://habrastorage.org/files/26a/f88/29d/26af8829d74f48a0bc8fd33e334c204c.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/files/44c/f3d/3ec/44cf3d3ec420441c8d06e0a2f9bde8f6.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/files/0c7/85e/02b/0c785e02bcf94a19948a3bf42356b549.jpg" alt="image"><br>
<br>
,           18 ,             <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B4_%25D0%25BD%25D0%25B0%25D0%25B8%25D0%25BC%25D0%25B5%25D0%25BD%25D1%258C%25D1%2588%25D0%25B8%25D1%2585_%25D0%25BA%25D0%25B2%25D0%25B0%25D0%25B4%25D1%2580%25D0%25B0%25D1%2582%25D0%25BE%25D0%25B2"></a>.<br>
</div></div><br>
</li>
</ul><br>
</li>
<li>     .<br>
<br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text">  .<br>
</div></div><br>
</li>
<li>    ,    (<a href="https://ru.wikipedia.org/wiki/%25D0%2593%25D0%25BE%25D0%25BC%25D0%25BE%25D1%2581%25D0%25BA%25D0%25B5%25D0%25B4%25D0%25B0%25D1%2581%25D1%2582%25D0%25B8%25D1%2587%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C"></a>)<br>
<br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text">     (     R   resid()).<br>
<br>
<pre><code>plot(dat.we$year, resid(model.we))
plot(dat.we$mileage, resid(model.we))
plot(dat.we$engine.power, resid(model.we))
</code></pre><br>
<img src="https://habrastorage.org/files/4d6/738/696/4d6738696fe846eca668e38afd314347.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/files/3ce/8f2/ae2/3ce8f2ae283841d5a1aaaf6116684ac3.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/files/fc2/025/e26/fc2025e26c6a4881bef6eb9a76d15f63.jpg" alt="image"><br>
<br>
 -     ,        .<br>
</div></div><br>
</li>
<li>  .<br>
<br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text">         ,       ,    .<br>
<br>
<pre><code>qqnorm(resid(model.we)) 
qqline(resid(model.we))
</code></pre><br>
<img src="https://habrastorage.org/files/453/9dc/859/4539dc859af8492e93cd84b4bc2cac26.jpg" alt="image"><br>
</div></div></li>
</ol><br>
<h2>  </h2><br>
,  ,    ,        .       ,      ,           .<br>
<br>
<pre><code>model.we &lt;- lm(price ~ year + mileage  + diesel + hybrid + mt + front.drive + rear.drive + engine.power + sedan + hatchback + wagon + coupe + cabriolet + minivan + pickup, data = dat.we)

coef(model.we) #   
  (Intercept)  year  mileage  diesel  rear.drive  engine.power  sedan 
  -1.76e+08  8.79e+04  -1.4e+00  2.5e+04  4.14e+04  2.11e+03  -2.866407e+04        
    
predicted.price &lt;- predict(model.we, dat) #     

real.price &lt;- dat$price #       

profit &lt;- predicted.price - real.price #         
</code></pre><br>
 , -      ,     ,          ,         .<br>
<br>
<pre><code>plot(real.price,profit)
abline(0,0)
</code></pre><br>
<img src="https://habrastorage.org/files/a76/d89/7d6/a76d897d644e45268d9c49ffdd572f77.jpeg" alt="image"><br>
<br>
        ?<br>
<br>
<pre><code>sorted &lt;- sort(predicted.price /real.price, decreasing = TRUE)
sorted[1:10]
      69       42      122      248      168       15      244      271      109      219 
1.590489 1.507614 1.386353 1.279716 1.279380 1.248001 1.227829 1.209341 1.209232 1.204062 
</code></pre><br>
,  59%   ,   ,    ¬´¬ª, ..     ,      .     4-  ( 28%)  ,    .<br>
<br>
   ,          ,     ,    ,        ,          (,    ,         ,  , ,      ,  ),     . ,           ,    ,          .<br>
<br>
<h2></h2><br>
 ,  ,          3 :<br>
<br>
<ol>
<li>   ?</li>
<li>          ?</li>
<li>         ?</li>
</ol><br>
 :<br>
<br>
<ol>
<li>    80/20.<br>
<br>
<pre><code>set.seed(1) #     ( )

split &lt;- runif(dim(dat)[1]) &gt; 0.2 #   

train &lt;- dat[split,] #   

test &lt;- dat[!split,] #  

train.model &lt;- lm(price ~ year + mileage  + diesel + hybrid + mt + front.drive + rear.drive + engine.power + sedan + hatchback + wagon + coupe + cabriolet + minivan + pickup, data = train) #       

train.dffits &lt;- dffits(train.model) #   dffits

train.dffits.we &lt;- train.dffits[train.dffits &lt; 0.42] #     dffits 

train.covratio &lt;- covratio(train.model)  #     

train.covratio.we &lt;- model.covratio[abs(model.covratio -1) &lt; 0.13] #     covratio 

train.we &lt;- dat[intersect(c(rownames(as.matrix(train.dffits.we))), c(rownames(as.matrix(train.covratio.we)))),] #     

train.model.we &lt;- lm(price ~ year + mileage  + diesel + hybrid + mt + front.drive + rear.drive + engine.power + sedan + hatchback + wagon + coupe + cabriolet + minivan + pickup, data = train.we) #         

predictions &lt;- predict(train.model.we, test) #     

print(sqrt(sum((as.vector(predictions - test$price))^2)/length(predictions))) #     ( )
[1] 121231.5
</code></pre><br>
    ‚Äî     .<br>
</li>
<li> ,            ,      .<br>
<br>
       2 (   ) .<br>
<br>
               .</li>
<li>     ,     -,       .<br>
<br>
 ,     ‚Äî <a href="http://robasta.ru/%3Fcity%3D%25D0%259C%25D0%25BE%25D1%2581%25D0%25BA%25D0%25B2%25D0%25B0%26model%3DMercedes-Benz%2BE-klasse%26price_from%3D%26price_to%3D1500000%26power_from%3D%26power_to%3D%26year_from%3D2010%26year_to%3D2016%26volume_from%3D0.0%26volume_to%3D100500.0%26km_from%3D0%26km_to%3D100500%26lm%3D0%26state%3D2%26seller%3D1%26engine%3D0%26transmission%3D0%26drive%3D0%26body%3D0%26hasphoto%3D0%26new%3D0">Mercedes-Benz E-klasse   2010  ,   1.5 .   </a>.<br>
<br>
<img src="https://habrastorage.org/files/a91/ab9/d9a/a91ab9d9aa974c9fa6c5fd32d1488b87.png" alt="image"><br>
<br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><img src="https://habrastorage.org/files/a1e/125/ac8/a1e125ac81004f0f8e24daab8ba2fe72.png" alt="image"><br>
</div></div><br>
</li>
</ol><br>
<h3></h3><br>
1.     csv ‚Äî <a href="http://robasta.ru/dataset.txt">dataset.txt</a></div><p>Source: <a href="https://habr.com/ru/post/302788/">https://habr.com/ru/post/302788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302778/index.html">Simply the Best. Top Posts in Intel Blog History</a></li>
<li><a href="../302780/index.html">Installing, configuring, and running DevStack from 'A' to 'Z'</a></li>
<li><a href="../302782/index.html">The book "Career Programmer. 6th edition</a></li>
<li><a href="../302784/index.html">Freelancer and entrepreneur</a></li>
<li><a href="../302786/index.html">Screwing the Gantt chart</a></li>
<li><a href="../302792/index.html">Google fixed multiple vulnerabilities in Android</a></li>
<li><a href="../302794/index.html">Gloves for those who complicate things</a></li>
<li><a href="../302796/index.html">Unity3D Speed ‚Äã‚Äãup drawing 2D animations at times? Easy</a></li>
<li><a href="../302798/index.html">How to build a competent testing system? Insights from QA experts: video and presentations from the meeting in Wrike</a></li>
<li><a href="../302800/index.html">1C: Bitrix, protection of arbitrary forms from spam</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>