<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Web Interface for Motion</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After updating the video server under debian, it was decided to remake the video surveillance system. 
 It was decided to leave Motion, but it became ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Web Interface for Motion</h1><div class="post__text post__text-html js-mediator-article"> After updating the video server under debian, it was decided to remake the video surveillance system. <br>  It was decided to leave Motion, but it became necessary to have a more human interface for viewing archived records. <br>  Regular searches on the Internet have not yielded any acceptable results, as a result of which it was decided to create their own product. <br>  After some hesitation, the choice fell on Rails.  No religion, I just wanted to better study this framework and a great programming language.  PostgreSQL is used as a DBMS. <br>  The result of the work under the hood ... <a name="habracut"></a><br><br>  For a start, a little more detail about the setting of motion. <br>  Due to the fact that I wanted, if possible, to get by with pure HTML5, I had to reinstall motion manually, enabling it to write files to ogg.  Fortunately, the authors of this program have implemented it, for which many thanks to them.  The build and installation process is described well on the project page, so I will not paint it here, especially since it will be different for different distributions.  Link to homepage <a href="http://www.lavrsen.dk/foswiki/bin/view/Motion/MotionGuideInstallation">www.lavrsen.dk/foswiki/bin/view/Motion/MotionGuideInstallation</a> . <br>  Will focus only on setting up the product. <br>  Since motion was originally installed from packages, after reinstalling, I did not transfer the configuration folder from / etc to / usr / local / etc. <br>  And one more point, the motion itself is started with the help of runit, therefore in the config it is turned off daemon mode. <br>  The alignment of forces is as follows: <br>  1. The motion configs are in / etc / motion. <br>  2. The video is written on a separate hard disk mounted in the / video directory, in folders with camera names. <br>  3. Records are stored in the database that store information about the time of the event, the full path to the event file, the type of file (in my case, video). <br>  Table structure <br> <code>CREATE TABLE records <br> ( <br> id serial NOT NULL, <br> thread integer, <br> filename character varying(255), <br> frame integer, <br> file_type integer, <br> event_timestamp timestamp without time zone, <br> created_at timestamp without time zone NOT NULL, <br> updated_at timestamp without time zone NOT NULL, <br> CONSTRAINT records_pkey PRIMARY KEY (id ) <br> ) <br> WITH ( <br> OIDS=FALSE <br> ); <br> ALTER TABLE records <br> OWNER TO motion; <br> <br> -- Index: thread <br> <br> -- DROP INDEX thread; <br> <br> CREATE INDEX thread <br> ON records <br> USING btree <br> (thread );</code> <br>  4. For live viewing (in real time) from the cameras using the interface motion. <br><br>  The main changes in the config are the following: <br>  /etc/motion.conf <br>  ffmpeg_video_codec ogg 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      webcontrol_port 8080 <br>  webcontrol_localhost off (if the web-interface will be launched on another server) <br>  webcontrol_html_output on <br>  webcontrol_authentication login: pass <br><br>  sql_query insert into records (thread, filename, frame, file_type, event_timestamp, created_at, updated_at) values ‚Äã‚Äã('% t', '% f', '% q', '% n', '% Y-% m-% d % T ', NOW (), NOW ()) <br><br>  And accordingly, the settings for connecting to the database. <br><br>  Next, connect the camera <br>  thread /etc/motion/thread1.conf <br>  thread /etc/motion/thread2.conf <br>  ... <br>  thread /etc/motion/threadN.conf, <br>  where N depends on the number of our cameras. <br><br>  The main points in threadX.conf, where X is any number <br>  stream_port PortNumber - this port will need to be written in the "Streaming Port" field when setting up cameras in the web-interface. <br>  These are major changes when setting up motion.  How to set the motion itself in this article will not paint. <br>  Rails configuration is well-written in the <a href="http://habrahabr.ru/post/140910/">habrahabr.ru/post/140910</a> article.  You may also need to install NodeJS - <a href="https://github.com/joyent/node/wiki/Installing-Node.js-via-package-manager">github.com/joyent/node/wiki/Installing-Node.js-via-package-manager</a> <br><br>  Now let's proceed directly to setting up the interface: <br>  1. Clone using git site. <br>  Bitbucket: <br>  git clone <a href="">webdev4u@bitbucket.org/webdev4u/motion_web.git</a> <br>  Github: <br>  git clone <a href="">github.com/webdev4u/motion_web.git</a> <br>  2. Rename config / settings.local.yml to config / settings.yml and enter the address of the server on which motion is running. <br>  3. Rename config / database.yml.example to config / database.yml and enter the settings for your database there. <br>  4. Change the db / seeds.rb data for the admin user. <br>  5. rake db: migrate <br>  6. rake db: seed <br>  7. For verification, you can run rails s.  The server will listen on port 3000.  If everything is normal, you can work. <br>  8. And finally, set up the task for the crown to clean the base.  By default, records are stored for 21 days, but you can change this parameter in the file app / models / record.rb 12 line, but better in the lib / tasks / crontask.rake line <br>  Record.clean_old_records <br>  replaced by <br>  Record.clean_old_records Required_number_days. <br>  Then drive the team <br>  whenever --update-crontab from under the user on whose behalf the site will run. <br><br>  Screenshot of the main page: <br><img src="https://habrastorage.org/storage2/a20/0a9/c60/a200a9c60cb3ee93017366d06257da72.png"><br>  Login page: <br><img src="https://habrastorage.org/storage2/2ea/438/caf/2ea438caf28176264bd3c099900a896e.png"><br>  Live view: <br><img src="https://habrastorage.org/storage2/f88/0ad/017/f880ad017651eebd02d7f871eb27a422.png"><br>  Camera list: <br><img src="https://habrastorage.org/storage2/707/168/749/70716874900c9833d215e25b0ed13463.png"><br>  View archive: <br><img src="https://habrastorage.org/storage2/4e7/90c/02f/4e790c02fa09c8bfc5be1f6561c1fce6.png"><br>  Add user: <br><img src="https://habrastorage.org/storage2/84f/f7b/7f8/84ff7b7f81a930d61d8c114622294906.png"><br>  Add Camera: <br><img src="https://habrastorage.org/storage2/e3f/2da/70f/e3f2da70f63663b9f86abe64abf88b33.png"></div><p>Source: <a href="https://habr.com/ru/post/190728/">https://habr.com/ru/post/190728/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../190716/index.html">eDavid: robot artist</a></li>
<li><a href="../190720/index.html">Shave your mustache - save the planet.</a></li>
<li><a href="../190722/index.html">Control systems in free-to-play</a></li>
<li><a href="../190724/index.html">Administering Microsoft Windows Server 2012</a></li>
<li><a href="../190726/index.html">Overview of the network platform Lanner FW-7581</a></li>
<li><a href="../190732/index.html">Superhydrophobicity in life or available nanotechnology. Continuation</a></li>
<li><a href="../190734/index.html">How not to lose $ 100,000 - tips of judges on participation in competitions of ideas</a></li>
<li><a href="../190738/index.html">1 Gb from Dropbox for Mailbox users</a></li>
<li><a href="../190740/index.html">HP Vertica, the first launched project in the Russian Federation, experience of one and a half years of actual operation</a></li>
<li><a href="../190742/index.html">How to work with designers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>