<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ATM virus post</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Guys, I could not stand it. We are now talking about the ATM virus found more than a year ago in Diebold ATMs, and the basic principle of its operatio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ATM virus post</h1><div class="post__text post__text-html js-mediator-article">  Guys, I could not stand it.  We are now talking about the ATM virus found more than a year ago in Diebold ATMs, and the basic principle of its operation.  This ancient topic, the peak of hysteria, has long passed, but the public hasn‚Äôt found out what really happened, which is why even IT managers build a lot of guesswork and tell myths.  Many articles have been written about this virus, from <a href="http://www.securitylab.ru/news/376519.php">technical descriptions</a> to <a href="http://www.computerra.ru/vision/413333/">political education of housewives</a> , but the main trick was never revealed to us.  I will try to explain more simply, because it is important for us to understand the essence, and not to delve into the details of the concrete implementation of something. <br><br>  Picture to attract attention: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0fc/ae8/e1a/0fcae8e1ab7a239145fc99de7c1ac6e3.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  Start over.  A year ago, there was a panic in the media: ‚ÄúATMs are viruses!‚Äù, As a result of which all self-respecting bank managers supported this panic and began to try to do something.  Panic arose for good reason: there are many freebie lovers in the world, so-called  carders whose purpose is to get your bank card details, including the PIN code, in order to duplicate it and withdraw all money or purchase something.  For this purpose, various methods of deception are invented, but before the appearance of the virus, they were all physical.  But the virus is very interesting, because it brought the technology to a new level in essence - PIN codes began to be installed at the program level.  It should be noted that the virus is still able to issue cash in unlimited amounts on a special card, but we, as clients, don't care, the bank gets into the money, not us. <br><br>  Now let's make a superficial excursion into the ATM itself, and see where the viruses can come from.  I will reveal the secret: the vast majority of ATMs running under Windows XP.  The quick-witted reader will understand that in this case there is a threat, and we must begin to be afraid.  But not everything is as bad as it seems.  First, bona fide suppliers of ATM software, this Windows is severely curtailed, disabling everything that is possible in it, protecting ports, closing access, and so on.  And secondly, the ATM never looks directly into the Internet - it is either in a dedicated segment of the corporate network, or connected through some encryption, such as Cisco or Checkpoint, and the virus gets there, to put it mildly, without options.  Accordingly, the exit here is only an insider, because from the outside it is problematic to slip something into an ATM. <br><br>  And what is a typical ATM software?  And that's what.  The architecture of this software is similar to the client-server.  The server in this case is able to work with a specific hardware (of which in an ATM in bulk) and publishes outside the program interfaces common to each type of hardware (dispenser, card reader, printer, keyboard, etc.).  The client, that is, the business application itself, in turn, using these interfaces, shows us advertising, issues a long-awaited salary, prints checks and blinks joyfully with lights.  All this economy is called the standard CEN / XFS.  I, perhaps, will attach a picture. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1d6/11b/c13/1d611bc136887ed071c735b9f59c091d.png"><br><br>  Having learned this news, we immediately start writing our ATM software <strike>with blackjack and whores</strike> , since there are no secrets here, and no one hides all the <a href="http://software-industries.com/products.htm">emulators</a> and <a href="http://www.cen.eu/cen/Sectors/Sectors/ISSS/CEN%2520Workshop%2520Agreements/Pages/CWA15748.aspx">specifications</a> from us.  We will read the magnetic strip from the card reader when the customer inserts the card, and the PIN code from the PIN keyboard when the customer dials it.  Here it is, as they say, profit.  And in appearance, it seems, everything is fine.  But it's too early to rejoice, a small bummer awaits us.  The fact is that the PIN code from the keyboard cannot be read in its pure form.  It can only be encrypted. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/43f/b21/bb8/43fb21bb80f15127d72eb4578a319908.png"><br><br>  Let us make a digression, for the general development of those interested.  The PIN-code in its pure form does not walk anywhere, except the keyboard itself and the special HSM device, which is in processing.  The process of entering a PIN code is as follows.  The software transmits the card number and the command to enter the PIN code to the keyboard.  Further, in the process of entering, the keyboard returns only the fact of the keystroke, but does not indicate which one.  Then the keyboard forms a construction from the two-digit length of the PIN code, the PIN code itself, then finishes up to 16 characters with the F number and makes an ‚Äúexclusive‚Äù number with the right 12 digits of the card number, except for the last check digit.  For example, for PIN-code 1234 and card 4987.6543.2109.8765 we take 04.1234.FFFFFFFFFF, make XOR over this with 0000.765432109876 and get 0412.42AB.CDEF.6789.  And then this last number is encrypted with a working key that is already in the keyboard, and the cipher is returned to the application that ordered the PIN code entry operation. <br><br>  Now let's deal with encryption keys, since we started talking about them.  These keys are located in the keyboard itself and cannot be read from there.  As a rule, prior to the operation of an ATM, bank security officers manually enter a so-called master key (MK) into the keyboard.  Then, periodically, a special working key (WK) arrives from the processing into the ATM, encrypted with the master key, which, apart from the keyboard and the special HSM device mentioned above, nobody knows (the officers enter their own components and also do not know the full key) .  Total in our keyboard sit MK and MK (WK). <br><br>  Let's start a smooth approach to the climax.  In fact, many different keys can be written to the keyboard.  You can also feed it a PIN block, force it to decrypt it with a working key, encrypt it with another key and return the result.  That is, we will never receive the key in its pure form, but please encrypt it in any key encrypted.  So why don't we write down our well-known master key and not give the keyboard a command to encrypt the PIN block for them, and not for some other?  And then we will decipher it, since the key is already known to us.  This is exactly what our virus does. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/529/d52/b7e/529d52b7e21ee8aa193ded06834422c1.png"><br><br>  That's the whole trick, guys.  Nothing complicated, right? <br><br>  Finally tell you what's the catch.  It is no coincidence that the virus was operating on Diebold ATMs.  The fact is that some Diebold ATMs have installed old keyboards that do not meet modern security requirements.  And modern security requirements state that keyboards in ATMs must provide a hierarchy of keys.  This means that if we give the keyboard command to decrypt the PIN block with a working key, then we can encrypt it only with the master key with which the worker was encrypted.  This is logical, because if we managed to load the working key, then we know this master key (we encrypted the worker) and we can be trusted.  But if we ask to encrypt a PIN-block with a key from a neighboring branch, we will not be given - there are signs of evil intentions. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/653/4d6/51c/6534d651c09dde87f66e1033567e6300.png"><br><br>  That's all.  It was a long time, it was not necessary to write about PIN blocks, but oh well.  I hope I clarified the situation a bit, and different myths and interpretations in famous circles will begin to walk less.  This is especially true for large bank managers who dream of putting antiviruses on ATMs, not realizing that they will get hemorrhoids many times more than good.  Normal guys have long enjoyed solutions a la Solidcore and live in peace. </div><p>Source: <a href="https://habr.com/ru/post/93507/">https://habr.com/ru/post/93507/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../93500/index.html">New rules for accounting meta tags Yandex search engine</a></li>
<li><a href="../93501/index.html">Panasonic Lumix DMC-TZ10 - compact with GPS</a></li>
<li><a href="../93502/index.html">General Motors cars can be driven from Android devices</a></li>
<li><a href="../93505/index.html">Alarm clock</a></li>
<li><a href="../93506/index.html">Eric Lippert - Generating All Binary Trees</a></li>
<li><a href="../93508/index.html">State registration of resources: registration interface</a></li>
<li><a href="../93509/index.html">Is Chatroulette great?</a></li>
<li><a href="../93510/index.html">Report from the Computer Museum in SPIIRAN</a></li>
<li><a href="../93511/index.html">Firebug - why can't I save the modified CSS to the server?</a></li>
<li><a href="../93512/index.html">We collect in one place developers for iPad!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>