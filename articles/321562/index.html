<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Signing resource identifiers and protecting APIs against DDoS attacks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to talk about some of the findings that I made after working on one of the most visited websites in the world. 

  

 I happened to take part i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Signing resource identifiers and protecting APIs against DDoS attacks</h1><div class="post__text post__text-html js-mediator-article">  I want to talk about some of the findings that I made after working on one of the most visited websites in the world. <br><br> <a href="https://habrahabr.ru/company/ruvds/blog/321562/"><img src="https://habrastorage.org/files/c54/17b/763/c5417b763726424481b15381850dfa5b.jpg"></a> <br><br>  I happened to take part in the work on this project as a consultant.  Attendance of the resource is about 200 million unique users per month.  Such popularity also means a high level of information security risks, in particular, the risk of being subjected to various types of attacks, the most common of which is DDoS.  The organization, which I will not name, has introduced a wide range of solutions to prevent the impact of such attacks on the performance of the service. <br><a name="habracut"></a><br>  These protective systems are quite common.  They are based on assembling content at boundary nodes (CDN, ESI) and applying a multi-level passive cache. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This design is good for ensuring the stable operation of the service.  However, the creation of applications designed to use the passive cache, means a greater additional burden on the programmer‚Äôs teams.  Below we will discuss this in more detail. <br><br>  Working on the project, I found a way to protect against DDoS attacks, which, having the same advantages as the passive cache, does not regulate as rigidly the architecture of the services that underlie the system.  About him today and will be discussed. <br><br><h2>  <font color="#3AC1EF">What is a passive cache?</font> </h2><br>  A service using a passive cache can only read data from a cache.  The service knows nothing about the source of this data. <br><br>  In this configuration, the cache support system is a key-value data store (for example, Redis), and the main data source is a relational database management system (for example, Oracle Database). <br><br>  A service with an active cache first tries to read the data from the cache, and if this fails, it accesses the main data source. <br><br><h2>  <font color="#3AC1EF">Use passive cache to protect against DDoS</font> </h2><br>  Using the passive cache architecture ensures that the main service with the source data source never encounters an unexpectedly large volume of requests.  Regardless of how many and which queries will be executed by the service, the primary data source is used only by the Message Queuing service to populate the cache data store. <br><br>  For example, <a href="http://gajus.com/blog/">http://gajus.com/blog/</a> is a blog service.  Here are the articles.  The client can access individual articles using their unique indexes.  Here are examples of article addresses: <br><br><ul><li>  <a href="http://gajus.com/blog/1/behaviour-driven-development-with-javascript">http://gajus.com/blog/1/behaviour-driven-development-with-javascript</a> </li><li>  <a href="http://gajus.com/blog/2/the-definitive-guide-to-the-javascript-generators">http://gajus.com/blog/2/the-definitive-guide-to-the-javascript-generators</a> </li><li>  <a href="http://gajus.com/blog/8/using-mysql-in-node-js">http://gajus.com/blog/8/using-mysql-in-node-js</a> </li><li>  <a href="http://gajus.com/blog/9/using-dataloader-to-batch-requests">http://gajus.com/blog/9/using-dataloader-to-batch-requests</a> </li></ul><br>  In this example, "1", "2", "8" and "9" are resource identifiers, unique indexes that are used to access data in the repository. <br><br>  The blog service in question uses an active cache.  When a client requests an article with index ‚Äú1‚Äù, the service accesses the cache and returns the result, or (if there is no record with the data of the requested article in the cache), it accesses the database, gets the result and stores it for some time in the cache. <br><br>  If an attacker organizes an attack that involves performing HTTP requests to get an article with an index of ‚Äú1‚Äù, all these requests will be served by the cache repository.  Requesting data from a key-value repository does not require a large expenditure of resources.  In order to successfully attack the system, loading over and above the search subsystem in such a repository, the attacker would need very serious power. <br><br>  The situation varies greatly if an attack uses arbitrary values ‚Äã‚Äãto construct an article identifier, for example, values ‚Äã‚Äãin the range from 1 to 1 million.  Now each request will result in the need to access the main database. <br><br>  Unlike searching in a key-value repository, queries to the relational database are very resource-intensive.  There are chances that requests / responses will need to go through a much larger number of nodes, it is possible that the answer will need to be processed using application logic, results will need to be cached, and so on. <br><br>  The scaling of the key-value storage is performed quickly and inexpensively, which cannot be said of the scaling of the relational database management system. <br><br>  If the service uses a passive cache, then scaling problems are limited to it.  The passive cache architecture is designed to quickly and easily increase the cache power.  However, such an architecture complicates development. <br><br><h2>  <font color="#3AC1EF">Developing services that use passive cache</font> </h2><br>  When creating a service that uses a passive cache, you need to take into account several requirements. <br><br><ul><li>  First, data can be read only from the cache. </li><li>  Secondly, after each operation requested from the service to create, update or delete data, it must put the corresponding task in the queue of requests to the source data store. </li><li>  Thirdly, after each task to create, update or delete data performed on the main storage data, the service should queue up the task of updating the corresponding cache sections. </li></ul><br>  Each CRUD operation of the system must be implemented taking into account the above limitations. <br><br>  During the development process, the time between a request to perform a certain operation and a result is increased due to the presence of a task queue.  This slows down the development and testing process.  In addition, the programmer needs to know about specific errors that may occur due to outdated data in the cache. <br><br>  On the other hand, during the development of an application that uses the active cache, the programmer can, in the course of work, simply disable the cache, achieving a very high speed of processing arbitrary requests to the main data store. <br><br>  It is more difficult to develop systems using passive cache, but when safety comes first, they usually do not pay attention to such difficulties.  However, this does not mean that all methods of protection against DDoS attacks will certainly require tremendous effort.  Above, we looked at an example of an attack on the blog service by iterating over article identifiers.  You can mitigate the effects of such attacks by making resource identifiers unpredictable. <br><br><h2>  <font color="#3AC1EF">Resource Identifier Signing</font> </h2><br>  The reason why active cache systems are subject to the attacks described above is that an attacker can easily construct a resource identifier.  Regardless of whether the identifier is a numeric ID (such as in our example), encoded in a base64 GUID, as in the GraphQL API, or a UUID, as in most document-oriented databases, the problem is that when the server receives request, he does not know whether the requested resource exists.  The only way to find out is to execute a call, either to the cache, or to the main data source, and wait for a response.  In order for the server, without accessing anything, to be able to determine whether the requested resource exists, resource identifiers can be signed. <br><br>  Signing allows, without seriously affecting the performance of the system, to find out whether the request was correctly formed.  If the resource identifier is signed, the attacker will not be able to query for identifiers that are not part of a limited set of public IDs. <br><br>  <b>It all works like this: the service receives a request, and tries to decrypt the resource identifier.</b>  <b>If he succeeds, the decoded value is used to search for the requested entry.</b>  <b>If the identifier cannot be decrypted, the request processing ends.</b> <br><br>  I use this approach when creating GraphQL resource identifiers.  In particular, the proxy, which forwards the GraphQL requests, first checks whether the resource ID is valid. <br><br><h2>  <font color="#3AC1EF">SGUID</font> </h2><br>  Signed GUID, or <a href="https://github.com/gajus/sguid">sguid</a> is a pact for Node.js, in which I adopted the procedures for creating and verifying signed identifiers.  You can <code>toSguid</code> identifier using the <code>toSguid</code> .  To check and open signed identifiers, use the <code>fromSguid</code> command.  It looks like this: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { fromSguid, InvalidSguidError, toSguid, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'sguid'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> secretKey = <span class="hljs-string"><span class="hljs-string">'6h2K+JuGfWTrs5Lxt+mJw9y5q+mXKCjiJgngIDWDFy23TWmjpfCnUBdO1fDzi6MxHMO2nTPazsnTcC2wuQrxVQ=='</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> publicKey = <span class="hljs-string"><span class="hljs-string">'t01po6Xwp1AXTtXw84ujMRzDtp0z2s7J03AtsLkK8VU='</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> namespace = <span class="hljs-string"><span class="hljs-string">'gajus'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> resourceTypeName = <span class="hljs-string"><span class="hljs-string">'article'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> generateArticleSguid = (articleId: number): <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">string</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> toSguid(secretKey, namespace, resourceTypeName, articleId); }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> parseArticleSguid = (articleGuide: string): <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fromSguid(publicKey, namespace, resourceTypeName, articleSguid).id; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error) {   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> InvalidSguidError) {     <span class="hljs-comment"><span class="hljs-comment">// Handle error.   }   throw error; } };</span></span></code> </pre> <br>  In addition to signing identifiers, Sguid is designed to use namespaces and resource type identifiers.  This ensures the global uniqueness of identifiers. <br><br>  Sguid uses the Ed25519 <a href="">public key cryptosystem</a> .  The resulting signature is encoded using the base64 URL encoding. <br><br>  The disadvantage of this approach is identifiers that are inconvenient for people to use: <br><br><pre> <code class="hljs">pbp3h9nTr0wPboKaWrg_Q77KnZW1-rBkwzzYJ0Px9Qvbq0KQvcfuR2uCRCtijQYsX98g1F50k50x5YKiCgnPAnsiaWQiOjEsIm5hbWVzcGFjZSI6ImdhanVzIiwidHlwZSI6ImFydGljbGUifQ</code> </pre> <br>  Plus - scalable protection against DDoS attacks conducted at the application layer of the OSI model, without overly complicating the development process. <br><br><h2>  <font color="#3AC1EF">Results</font> </h2><br>  It should be noted that the method described here does not at all help to protect against attacks aimed at overflow of communication channels.  Moreover, it is effective only if the cache is able to store data for all meaningful requests.  But, despite such limitations, this is a worthy approach to protecting against attacks designed for server cache misses. <br><br>  In addition, it must be remembered that in defending against cyber attacks, it is important how the results of the attack look from the point of view of the attacker.  In order to sort out an effectively constructed system using the resource identifiers using the approach described here, we need serious power.  Perhaps the attacker simply does not expect this, and seeing that the system does not respond to his actions (although it may well work at the limit of capabilities), decides that he has already tried everything he can and stops the attack. <br><br>  How do you protect against DDoS attacks? </div><p>Source: <a href="https://habr.com/ru/post/321562/">https://habr.com/ru/post/321562/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321550/index.html">It's hard to be a junior</a></li>
<li><a href="../321552/index.html">The first application on Spring Boot + ReactJS</a></li>
<li><a href="../321554/index.html">About ranks and virtualization in RAM</a></li>
<li><a href="../321558/index.html">Is it worth it for a IT start-up cofounder to learn programming?</a></li>
<li><a href="../321560/index.html">Comparison of solutions for balancing high-load systems</a></li>
<li><a href="../321564/index.html">It is finished! Procedural macros in Rust 1.15</a></li>
<li><a href="../321566/index.html">From zero experience to 6-digit salary: a play in 8 acts</a></li>
<li><a href="../321568/index.html">Difficulty Choosing a Hoster</a></li>
<li><a href="../321570/index.html">Evening Activity: Explode Effect on pure JS</a></li>
<li><a href="../321572/index.html">Installing Zabbix Agent on VCSA 6.5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>