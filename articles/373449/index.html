<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make friends the second generation FLIR One thermal imager with a computer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, there have been quite a few reviews of a thermal imaging console for the Seek Thermal smartphone. However, Seek Thermal is not the only ther...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make friends the second generation FLIR One thermal imager with a computer</h1><div class="post__text post__text-html js-mediator-article">  Recently, there have been quite a few reviews of a thermal imaging console for the Seek Thermal smartphone.  However, Seek Thermal is not the only thermal imager available to the masses of users - the well-known company FLIR also releases its thermal imaging console FLIR One of three different generations.  This article focuses on the second-generation FLIR One Gen 2 for Android, which has a bolometric resolution of 160x120 pixels. <br><a name="habracut"></a><br>  I bought this prefix on ebay three months ago with the hope of connecting to a personal computer via USB and, I must say, my hope came true. <br><br>  The first thing that needed to be done was to assemble a micro USB cable (mother) to USB (dad).  There will be no problems. <br><br>  Further - more interesting.  On the <a href="http://www.eevblog.com/forum/thermal-imaging/question-about-flir-one-for-android/">eevblog.com</a> forum <a href="http://www.eevblog.com/forum/thermal-imaging/question-about-flir-one-for-android/">,</a> tomas123 opened the USB exchange protocol and wrote its console application for Linux to get a picture of the thermal imaging and conventional camera set-top boxes using libusb.  For Linux, the program was not interesting for me, and I tried to write my own program for Windows XP based on the tomas123 program.  And this is where the problem arose: libusb for Windows refused to work correctly, producing an error 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote>  libusb0-dll: err [submit_async] submitting request failed, win error: The parameter is set incorrectly. </blockquote><br>  After asking a question on the eevblog.com forum, I received the answer that I was the third one who tried unsuccessfully to run this program for Windows using libusb.  It also turned out that under Linux, far from all FLIR One distributions work libusb stably - in Ubuntu 10, for example, ‚Äúpipe error‚Äù errors are frequent, and in Mageia 5 there are no such problems.  Well, I had to postpone the program for Windows for the future. <br><br>  The next OS for which I tried to write a program was QNX 6.3.  I use this OS at work, but I never wrote a USB driver for it.  With the help of the qnx.org.ru forum, I still managed to write something more or less correctly working via USB with FLIR One.  Here is the interface of the resulting program: <br><br><img src="https://habrastorage.org/web/4a6/957/b90/4a6957b903574f219c3aa8ef7daabf21.PNG"><br>  <i>The program for QNX 6.3.</i> <br><br>  However, the program is unstable - io-usb very often dies after a couple of minutes in an unequal battle with a thermal imager.  Moreover, on some machines, the system does not even notice the connection of the device!  It turned out that by switching the operation of the ports in USB 1 to the BIOS, the system still comes to life and begins to detect the device and work with it, albeit with a lower FPS.  I suppose that perhaps FLIR One uses an off-the-shelf USB, and this leads to similar problems.  But the main thing - the program works and the picture is built. <br><br>  Then it is time to return to Windows.  With the help of <a href="https://geektimes.ru/post/257192/">this</a> topic, I wrote a driver for Windows XP.  After taking off 20 times in the BSOD during the debugging process, the driver came to life, and I received a picture from the thermal imager in the program for Windows XP.  Victory!  However, everything is again not as rosy as it seemed at first.  On some computers (and even from different USB connectors of the same computer) with Windows XP, the driver is simply impossible to install - the system sees FLIR One as a composite USB device and absolutely does not want to divide it into three devices with endings on .iAP,. FileIO and .Frame.  The same problem was found in Windows 7, which also did not allow me to install the driver for this OS.  How to get around this problem, I still do not know. <br><br>  Actually, at the moment, on this development of programs for FLIR One and I stopped. <br><br><img src="https://habrastorage.org/web/284/bd9/2c3/284bd92c3a2b4dcda77db51c5b028839.PNG"><br>  <i>Program for Windows XP.</i> <br><br>  So, what does this imager represent in terms of sharing with it via USB: <br>  Manufacturer ID: 0x09CB. <br>  Device ID: 0x1996. <br>  The imager has three interfaces: <br><ol><li>  iAP with endpoints: 0x00 (read and write), 0x81 (read) and 0x02 (write); </li><li>  FileIO with endpoints: 0x00 (read and write), 0x83 (read) and 0x04 (write); </li><li>  Frame with endpoints: 0x00 (read and write), 0x85 (read) and 0x06 (write). </li></ol><br>  All of these end points are bulk. <br><br>  The iAP interface allows you to control the other two interfaces by sending a control command to iAP with the necessary parameters (they are in the attached program and driver files).  To obtain a thermal image, it is enough to read and decode data from the end point 0x85 of the Frame interface and not to forget to read the data from the end points 0x81 and 0x83, otherwise the thermal imager may stop data transmission after some time. <br>  The received data looks like this: <br><ol><li>  Four ‚Äúmagic‚Äù bytes separating packets from each other: 0xEF, 0xBE, 0x00,0x00; </li><li>  A header indicating the sizes of the thermal and normal camera data, the total frame size, and device status data. </li><li>  Frame data thermal camera. </li><li>  Other data. </li></ol><br>  What exactly is transmitted throughout the frame, I have not studied;  I had enough data from the thermal chamber. <br><br>  The received data from the thermal camera is an array of 14 bit ADC readings from the bolometric matrix, starting with data block headers for every 80 pixels (one pixel occupies 2 bytes of the unsigned short type).  The title looks like this (taken from the documentation for the Lepton 3 thermal imaging module used in FLIR One Gen 2): <br><br><img src="https://habrastorage.org/web/b8d/335/462/b8d335462c994eb0a211d1c8f684fd40.PNG"><br>  <i>The header of the data block is 80 pixels.</i> <br><br>  From this header, we are only interested in the CRC code calculated by the polynom specified in the documentation. <br><br>  To build a beautiful picture, simply find the maximum and minimum to bring the obtained readings in the range of 0-255 (according to the number of colors of the palette).  Actually, this construction of colorful pictures and ends.  If there is a desire to calculate the temperature according to the readings, then interesting formulas with a set of coefficients for a specific model of the thermal imager will be required.  Fortunately, these coefficients for FLIR One Gen 2 are known. <br>  And the formula according to the ‚ÄúFLIR Lepton with Radiometry Quick start Guide‚Äù documentation, is this: <br><br><img src="https://habrastorage.org/web/3b5/e5a/604/3b5e5a6044264a2c81224e762611cb6a.PNG"><br><br>  Hmm ... It's good that tomas123 has already attended to such calculations and in his program wrote the function of calculating the temperature of the object.  In my rework, it looks like this: <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> EPS 0.0000000001 double PlanckR1=16528.178; double PlanckB=1427.5; double PlanckF=1.0; double PlanckO=-1307.0; double PlanckR2=0.012258549; double TempReflected=20; double Emissivity=0.95; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//--------------------------------------------------------------------------- //  //--------------------------------------------------------------------------- bool GetTemperature(unsigned short raw14,double &amp;value) { if (raw14&gt;0x10000) return(false); raw14*=4; double zn=(PlanckR2*(exp(PlanckB/(TempReflected+273.15))-PlanckF)); if (fabs(zn)&lt;EPS) return(false); double RAWrefl=PlanckR1/zn-PlanckO; double RAWobj=(raw14-(1-Emissivity)*RAWrefl)/Emissivity; double lgr=PlanckR1/(PlanckR2*(RAWobj+PlanckO)+PlanckF); if (lgr&lt;=EPS) return(false); value=PlanckB/log(lgr)-273.15; return(true); }</span></span></span></span></code> </pre> <br>  Here TempReflected is the temperature of the bolometric matrix, and Emissivity is the emissivity of the surface being measured.  The PlanckR1, PlanckB, PlanckF, PlanckO, and PlanckR2 constants are specific to this thermal imager model. <br><br>  As you can see, my Windows program saves RAW files.  For their analysis, I also wrote a separate application.  It looks like this: <br><br><img src="https://habrastorage.org/web/081/dd1/cdd/081dd1cddcfb42d1881ee963d750ac91.PNG"><br>  <i>RAW file analyzer for Windows XP.</i> <br><br>  Here are some examples of images taken with this thermal imager from the Windows XP program: <br><br><img src="https://habrastorage.org/web/930/3da/b56/9303dab569b2401d8a0c6c2ff51a83e1.PNG" alt="image"><br><br><img src="https://habrastorage.org/web/6cf/8de/93f/6cf8de93fa2c47faa004e40b04ab783d.PNG" alt="image"><br><br><img src="https://habrastorage.org/web/eb1/5f2/204/eb15f220427b43d0bdefa75691637275.PNG" alt="image"><br><br><img src="https://habrastorage.org/web/15c/489/63a/15c48963ae1d4f42b7889874c8dd300c.PNG" alt="image"><br><br><img src="https://habrastorage.org/web/354/48f/718/35448f7186e241259f564e8aebdf085e.PNG" alt="image"><br><br>  Actually, that's all.  The sources and the programs themselves are attached to the links below (I still do not understand how to place them on github). <br><br><ol><li>  <a href="http://radiokot.ru/forum/download/file.php%3Fid%3D280858">For QNX 6.3</a> </li><li>  <a href="http://radiokot.ru/forum/download/file.php%3Fid%3D284168">For Windows XP</a> </li><li>  <a href="http://radiokot.ru/forum/download/file.php%3Fid%3D284169">The program for the analysis of RAW-images for Windows</a> </li></ol><br><br>  PS It turned out that from w3bsit3-dns.com without registration, do not download the attached files.  Made a link to another resource. <br><br>  Added links to github: <br>  <a href="https://github.com/da-nie/FlirOneControl">FlirOneControl</a> <br>  <a href="https://github.com/da-nie/FlirOneDrivers">Drivers</a> <br>  <a href="https://github.com/da-nie/FlirOneRAWAnalizer">Image analysis program</a> </div><p>Source: <a href="https://habr.com/ru/post/373449/">https://habr.com/ru/post/373449/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../373435/index.html">Atoms: building blocks of molecules</a></li>
<li><a href="../373439/index.html">Wikipedia is invulnerable to censoring the IPFS network</a></li>
<li><a href="../373441/index.html">Microsoft fixed a vulnerability in Windows Defender that made almost any PC open to attacks from outside</a></li>
<li><a href="../373443/index.html">Alex got a screen: Amazon showed digital assistant Echo Show</a></li>
<li><a href="../373447/index.html">Great physical activity adds 9 years of life to a person at the cellular level.</a></li>
<li><a href="../373453/index.html">Intel Itanium processor officially died</a></li>
<li><a href="../373455/index.html">Personality and sound: Fritz Zennheiser - victory that began with defeat</a></li>
<li><a href="../373457/index.html">Miller and Valasek have published all the information for hacking cars</a></li>
<li><a href="../373459/index.html">Does Wi-Fi harm living organisms?</a></li>
<li><a href="../373461/index.html">The colony. Chapter 11: The Doctor's Tale</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>