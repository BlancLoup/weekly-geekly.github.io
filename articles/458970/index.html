<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Use UIViewPropertyAnimator to create custom animations</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Creating animations is great. They are an important part of the iOS Human Interface Guidelines . Animations help draw the user's attention to importan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Use UIViewPropertyAnimator to create custom animations</h1><div class="post__text post__text-html js-mediator-article">  Creating animations is great.  They are an important part of the <a href="https://developer.apple.com/design/human-interface-guidelines/ios/visual-design/animation/">iOS Human Interface Guidelines</a> .  Animations help draw the user's attention to important things, or simply make the application not so boring. <br><br>  There are several ways to implement animation in iOS.  Probably the most popular way is to use <i>UIView.animate (withDuration: animations :)</i> .  You can animate the image layer using <b>CABasicAnimation</b> .  In addition, UIKit allows you to customize the animation for displaying the controller using <b>UIViewControllerTransitioningDelegate</b> . <br><br>  In this article I want to discuss another exciting way to animate views - <b>UIViewPropertyAnimator</b> .  This class provides much more control functions than its predecessor <i>UIView.animat</i> e.  With it, you can create temporary, interactive and interruptible animations.  In addition, it is possible to quickly change the animator. <br><a name="habracut"></a><br><h3>  Meet UIViewPropertyAnimator </h3><br>  <b>UIViewPropertyAnimator</b> was introduced in <b>iOS 10</b> .  It allows you to create animations in an object-oriented way.  Let's look at an example of an animation created using a <b>UIViewPropertyAnimator</b> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/284/201/7c2/2842017c24a19653c9be8f14b4f13bfc.gif" alt="image"><br><br>  This is how it was when using UIView. <br><br><pre><code class="swift hljs"><span class="hljs-type"><span class="hljs-type">UIView</span></span>.animate(withDuration: <span class="hljs-number"><span class="hljs-number">0.3</span></span>) { view.frame = view.frame.offsetBy(dx: <span class="hljs-number"><span class="hljs-number">100</span></span>, dy: <span class="hljs-number"><span class="hljs-number">0</span></span>) }</code> </pre> <br>  And this is how it can be done with the help of <b>UIViewPropertyAnimator</b> : <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> animator = <span class="hljs-type"><span class="hljs-type">UIViewPropertyAnimator</span></span>(duration:<span class="hljs-number"><span class="hljs-number">0.3</span></span>, curve: .linear) { view.frame = view.frame.offsetBy(dx:<span class="hljs-number"><span class="hljs-number">100</span></span>, dy:<span class="hljs-number"><span class="hljs-number">0</span></span>) } animator.startAnimation()</code> </pre><br>  If you need to check the animation, just create a Playground and run the code as shown below.  Both code fragments will lead to the same result. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f1a/1fb/515/f1a1fb51597dadf93c4155dc59d8164d.png" alt="image"><br><br>  You would think that in this example there is not much difference.  So, what's the point of adding a new way to create animation?  <b>UIViewPropertyAnimator</b> becomes more useful when you need to create interactive animations. <br><br><h3>  Interactive and interruptible animation </h3><br>  Do you remember the classic ‚ÄúShift finger to unlock device‚Äù gesture?  Or the gesture ‚ÄúMove your finger on the screen from bottom to top‚Äù to open the Control Center?  These are excellent examples of interactive animation.  You can start moving the image with your finger, then release it, and the image will return to its original position.  In addition, you can catch the image during the animation and continue moving it with your finger. <br><br>  Animations UIView does not provide an easy way to control the percentage of completion of an animation.  You cannot pause the animation in the middle of a loop and continue its execution after the interruption. <br><br>  In this case, it will be a <b>UIViewPropertyAnimator</b> .  Next, we will look at how you can easily create a fully interactive, interrupted animation, and reversing animation in a few steps. <br><br><h3>  Preparation of the starting project </h3><br>  First you need to <a href="">download the start project</a> .  After opening the archive, you will find the <b>CityGuide</b> application that helps users plan their vacation.  The user can scroll through the list of cities, and then open a detailed description with detailed information about the city that he liked. <br><br>  Consider the source code of the project before we start creating a beautiful animation.  Here's what you can find in the project by opening it in <b>Xcode</b> : <br><br><ol><li>  <b>ViewController.swift</b> : The main application controller with a <b>UICollectionView</b> that displays an array of <b>City</b> objects. </li><li>  <b>CityCollectionViewCell.swift:</b> Cell for displaying <b>City</b> .  In fact, in this article most of the changes will apply to this class.  You may notice that <b>descriptionLabel</b> and <b>closeButton</b> are already defined in the class.  However, after launching the application, these objects will be hidden.  Do not worry, they will be seen a little later.  In this class there are also <i>collectionView</i> and <i>index</i> properties.  Later they will be used for animation. </li><li>  <b>CityCollectionViewFlowLayout.swift:</b> This class is responsible for horizontal scrolling.  We will not change it yet. </li><li>  <b>City.swift</b> : The main application model has a method that was used in the ViewController. </li><li>  <b>Main.storyboard:</b> There you can find the user interface for the <b>ViewController</b> and <b>CityCollectionViewCell</b> . </li></ol><br>  Let's try to build and run the sample application.  As a result, we get the following. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/313/0ed/3e6/3130ed3e68179c72b4b99e160cc2cb9b.png" alt="cityguideapp-iphone8" width="350" height="614"></div><br><h3>  Implement deployment and collapse animation </h3><br>  After starting the application, a list of cities is displayed.  But the user can not interact with objects in the form of cells.  Now you need to display information for each city when the user clicks on one of the cells.  Take a look at the final application.  That's actually what was required to develop: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2d1/124/719/2d1124719b8918381a74d1dae192acb5.gif" alt="image" width="350" height="614"></div><br>  The animation looks good, doesn't it?  But there is nothing special here, it's just the basic logic of the <b>UIViewPropertyAnimator</b> .  Let's see how to implement this type of animation.  Create a <i>collectionView</i> method <i>(_: didSelectItemAt)</i> , add the following code fragment to the end of the <b>ViewController</b> file: <br><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">collectionView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> selectedCell = collectionView.cellForItem(at: indexPath)! <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>! <span class="hljs-type"><span class="hljs-type">CityCollectionViewCell</span></span> selectedCell.toggle() }</code> </pre><br>  Now we need to implement the <b>toggle</b> method.  Let's switch to <b>CityCollectionViewCell.swift</b> and implement this method. <br><br>  First, we add the <b>State</b> enumeration to the beginning of the file, just before the <b>CityCollectionViewCell</b> class <b>declaration</b> .  This listing allows you to track the state of a cell: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">enum</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">State</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> expanded <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> collapsed <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> change: <span class="hljs-type"><span class="hljs-type">State</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .expanded: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> .collapsed <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .collapsed: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> .expanded } } }</code> </pre><br>  Add a few properties to control the animation in the <b>CityCollectionViewCell</b> class: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> initialFrame: <span class="hljs-type"><span class="hljs-type">CGRect?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> state: <span class="hljs-type"><span class="hljs-type">State</span></span> = .collapsed <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-built_in"><span class="hljs-built_in">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> animator: <span class="hljs-type"><span class="hljs-type">UIViewPropertyAnimator</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">UIViewPropertyAnimator</span></span>(duration: <span class="hljs-number"><span class="hljs-number">0.3</span></span>, curve: .easeInOut) }()</code> </pre><br>  The <i>initialFrame</i> variable <i>is</i> used to store the cell frame before performing the animation.  <b>state is</b> used to track if a cell is expanded or collapsed.  And the variable <b>animator is</b> used to control the animation. <br><br>  Now add the <i>toggle</i> method and call it from the <i>close</i> method, for example: <br><br><pre> <code class="swift hljs"><span class="hljs-meta"><span class="hljs-meta">@IBAction</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Any</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { toggle() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toggle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> state { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .expanded: collapse() <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .collapsed: expand() } }</code> </pre><br>  Then add two more methods: <i>expand ()</i> and <i>collapse ()</i> .  We will continue their implementation.  First we start with the <i>expansiond ()</i> method: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> collectionView = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.collectionView, <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> index = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.index <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } animator.addAnimations { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.initialFrame = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.frame <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.descriptionLabel.alpha = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.closeButton.alpha = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.layer.cornerRadius = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.frame = <span class="hljs-type"><span class="hljs-type">CGRect</span></span>(x: collectionView.contentOffset.x, y:<span class="hljs-number"><span class="hljs-number">0</span></span>, width: collectionView.frame.width, height: collectionView.frame.height) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> leftCell = collectionView.cellForItem(at: <span class="hljs-type"><span class="hljs-type">IndexPath</span></span>(row: index - <span class="hljs-number"><span class="hljs-number">1</span></span>, section: <span class="hljs-number"><span class="hljs-number">0</span></span>)) { leftCell.center.x -= <span class="hljs-number"><span class="hljs-number">50</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> rightCell = collectionView.cellForItem(at: <span class="hljs-type"><span class="hljs-type">IndexPath</span></span>(row: index + <span class="hljs-number"><span class="hljs-number">1</span></span>, section: <span class="hljs-number"><span class="hljs-number">0</span></span>)) { rightCell.center.x += <span class="hljs-number"><span class="hljs-number">50</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.layoutIfNeeded() } animator.addCompletion { position <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> position { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .end: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.state = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.state.change collectionView.isScrollEnabled = <span class="hljs-literal"><span class="hljs-literal">false</span></span> collectionView.allowsSelection = <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: () } } animator.startAnimation() }</code> </pre><br>  Like a lot of code.  Let me explain what is happening step by step: <br><br><ol><li>  First we check if <i>collectionView</i> and <i>index</i> are not equal to zero.  Otherwise, we will not be able to start the animation. </li><li>  Next, we start creating an animation by calling <i>animator.addAnimations</i> . </li><li>  Next, save the current frame, which is used to restore it in the collapse animation. </li><li>  Then we set the alpha value for the <i>descriptionLabel</i> and <i>closeButton</i> to make them visible. </li><li>  Next, remove the rounded corner and set a new frame for the cell.  The cell will be shown in full screen mode. </li><li>  Next, we move the neighboring cells. </li><li>  Now we call the <i>animator.addComplete ()</i> method to disable the interaction of the image collection.  This prevents users from scrolling during cell expansion.  Also change the current state of the cell.  It is important to change the state of the cell and only after that the animation ends. </li></ol><br>  Now add a collapse animation.  In short, it‚Äôs just that we restore the cell to its former state: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">collapse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> collectionView = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.collectionView, <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> index = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.index <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } animator.addAnimations { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.descriptionLabel.alpha = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.closeButton.alpha = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.layer.cornerRadius = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.cornerRadius <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.frame = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.initialFrame! <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> leftCell = collectionView.cellForItem(at: <span class="hljs-type"><span class="hljs-type">IndexPath</span></span>(row: index - <span class="hljs-number"><span class="hljs-number">1</span></span>, section: <span class="hljs-number"><span class="hljs-number">0</span></span>)) { leftCell.center.x += <span class="hljs-number"><span class="hljs-number">50</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> rightCell = collectionView.cellForItem(at: <span class="hljs-type"><span class="hljs-type">IndexPath</span></span>(row: index + <span class="hljs-number"><span class="hljs-number">1</span></span>, section: <span class="hljs-number"><span class="hljs-number">0</span></span>)) { rightCell.center.x -= <span class="hljs-number"><span class="hljs-number">50</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.layoutIfNeeded() } animator.addCompletion { position <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> position { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .end: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.state = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.state.change collectionView.isScrollEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> collectionView.allowsSelection = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: () } } animator.startAnimation() }</code> </pre><br>  Now it's time to compile and run the application.  Try clicking on a cell and you will see an animation.  To close the image, click on the cross icon in the upper right corner. <br><br><h3>  Adding Gesture Processing </h3><br>  You can argue about achieving the same result using <i>UIView.animate</i> .  What is the point of using <b>UIViewPropertyAnimator</b> ? <br><br>  Well, it's time to make the animation interactive.  Add a <b>UIPanGestureRecognizer</b> and a new property named <i>popupOffset</i> to track how much a cell can move.  Let's declare these variables in the <b>CityCollectionViewCell</b> class: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> popupOffset: <span class="hljs-type"><span class="hljs-type">CGFloat</span></span> = (<span class="hljs-type"><span class="hljs-type">UIScreen</span></span>.main.bounds.height - cellSize.height)/<span class="hljs-number"><span class="hljs-number">2.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-built_in"><span class="hljs-built_in">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> panRecognizer: <span class="hljs-type"><span class="hljs-type">UIPanGestureRecognizer</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> recognizer = <span class="hljs-type"><span class="hljs-type">UIPanGestureRecognizer</span></span>() recognizer.addTarget(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, action: #selector(popupViewPanned(recognizer:))) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> recognizer }()</code> </pre><br>  Then add the following method to register the svip definition: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">awakeFromNib</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.addGestureRecognizer(panRecognizer) }</code> </pre><br>  Now you need to add the <i>popupViewPanned</i> method to track the swipe gesture.  Paste the following code into <b>CityCollectionViewCell</b> : <br><br><pre> <code class="swift hljs"><span class="hljs-meta"><span class="hljs-meta">@objc</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">popupViewPanned</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(recognizer: UIPanGestureRecognizer)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> recognizer.state { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .began: toggle() animator.pauseAnimation() <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .changed: <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> translation = recognizer.translation(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: collectionView) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fraction = -translation.y / popupOffset <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> state == .expanded { fraction *= -<span class="hljs-number"><span class="hljs-number">1</span></span> } animator.fractionComplete = fraction <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .ended: animator.continueAnimation(withTimingParameters: <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, durationFactor: <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: () } }</code> </pre><br>  There are three states here.  At the beginning of the gesture, we initialize the animator with the <i>toggle</i> method and immediately suspend it.  While the user drags the cell, we update the animation by setting the <i>fractionComplete</i> multiplier properties.  This is the main magic of the animator, which allows them to manage.  Finally, when the user releases the finger, the <i>continueAnimation</i> animator method is called to continue the animation.  The cell then moves to the target position. <br><br>  After starting the application, you can drag the cell up to expand it.  Then drag the expanded cell down to collapse it. <br><br>  Now the animation looks pretty good, but it's not possible to interrupt the animation in the middle.  Therefore, to make the animation fully interactive, you need to add another function - interrupt.  The user can start the expand / collapse animation as usual, but the animation should be paused immediately after the user clicks the cell during the animation cycle. <br><br>  To do this, you need to save the progress of the animation and then take this value into account to calculate the percentage of completion of the animation. <br><br>  First, <b>let's</b> declare a new property in <b>CityCollectionViewCell</b> : <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> animationProgress: <span class="hljs-type"><span class="hljs-type">CGFloat</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  Then we update the <b>.began</b> block of the <i>popupViewPanned</i> method with the following line of code to remember the progress: <br><br><pre> <code class="swift hljs">animationProgress = animator.fractionComplete</code> </pre><br>  In the <b>.changed</b> block, <b>you</b> need to update the following line of code to correctly calculate the percentage of completion: <br><br><pre> <code class="swift hljs">animator.fractionComplete = fraction + animationProgress</code> </pre><br>  Now the application is ready for testing.  Run the project and see what happens.  If all actions are performed correctly following my instructions, the animation should look like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8a5/eae/b13/8a5eaeb1341638dc9b45cbad05f8a66d.gif" alt="image" width="350" height="614"></div><br><h3>  Reverse animation </h3><br>  You can find a flaw for the current implementation.  If you drag the cell a little and then return it to its original position, the cell will continue to expand when you release your finger.  Let's fix this problem to make interactive animations even better. <br>  Perform an update to the <b>.end</b> block of the <b>popupViewPanned</b> method, as described below: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> velocity = recognizer.velocity(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> shouldComplete = velocity.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> velocity.y == <span class="hljs-number"><span class="hljs-number">0</span></span> { animator.continueAnimation(withTimingParameters: <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, durationFactor: <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> state { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .expanded: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !shouldComplete &amp;&amp; !animator.isReversed { animator.isReversed = !animator.isReversed } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> shouldComplete &amp;&amp; animator.isReversed { animator.isReversed = !animator.isReversed } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .collapsed: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> shouldComplete &amp;&amp; !animator.isReversed { animator.isReversed = !animator.isReversed } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !shouldComplete &amp;&amp; animator.isReversed { animator.isReversed = !animator.isReversed } } animator.continueAnimation(withTimingParameters: <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, durationFactor: <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre><br>  We now take into account the speed of the gesture to determine if the animation should be reversed. <br><br>  And finally, insert another line of code into the <b>.changed</b> block.  Place this code to the right of the calculation of <i>animator.fractionComplete</i> . <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> animator.isReversed { fraction *= -<span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre><br>  Let's run the application again.  Now everything should work without fail. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2a0/734/dc7/2a0734dc7012220eef4281c64db0e24b.gif" alt="image" width="350" height="614"></div><br><h3>  Fix pan gesture </h3><br>  So, we have completed the implementation of the animation using the <b>UIViewPropertyAnimator</b> .  However, there is one unpleasant mistake.  You may have met her while testing the application.  The problem is that scrolling the cell horizontally is not possible.  Let's try to swipe left / right in the cells, and we dove with the problem. <br><br>  The main reason is related to the <b>UIPanGestureRecognizer</b> we <b>created</b> .  It also captures the brush gesture, and conflicts with the built-in gesture recognizer <b>UICollectionView</b> . <br><br>  Although the user can still scroll through the top / bottom of the cells or the space between the cells to scroll through the cities, I still don‚Äôt like such a bad user interface.  Let's fix it. <br><br>  To resolve conflicts, we need to implement a delegate method named <i>gestRecognizerShouldBegin (_ :)</i> .  This method controls whether the gesture recognizer should continue to interpret the touches.  If you return <b>false</b> to the method, the gesture recognizer will ignore touches.  So what we are going to do is give our own panorama recognition tool the ability to ignore horizontal movements. <br><br>  To do this, let's set the <i>delegate of</i> our pan recognizer.  Insert the following line of code into the <b>panRecognizer</b> initialization (you can put the code right before <i>return recognizer</i> : <br><br><pre> <code class="swift hljs">recognizer.delegate = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span></code> </pre><br>  Then, we implement the <i>gestRecognizerShouldBegin (_ :)</i> method as follows: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gestureRecognizerShouldBegin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> gestureRecognizer: UIGestureRecognizer)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>((panRecognizer.velocity(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: panRecognizer.view)).y) &gt; <span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>((panRecognizer.velocity(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: panRecognizer.view)).x) }</code> </pre><br>  We will open / close if its speed of vertical movement is greater than the speed of horizontal movement. <br><br>  Great!  Let's test the application again.  Now you can navigate through the list of cities by swiping left / right through the cells. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dd6/bcb/909/dd6bcb90976b4eaae326027309fda1c6.gif" alt="image" width="350" height="614"></div><br><h3>  Bonus: Custom sync features </h3><br>  Before we finish this tutorial, let's talk about timing functions.  Do you still remember the case when the developer asked you to implement a custom synchronization function for the animation you create? <br><br>  You should usually change <i>UIView.animation</i> to <b>CABasicAnimation</b> or wrap it in <b>CATransaction</b> .  <b>With UIViewPropertyAnimator,</b> you can easily implement custom timing functions. <br><br>  The <b>timing functions</b> (or easing functions) are understood as functions of the animation speed, which affect the rate of change of a particular property being animated.  Four types are currently supported: easeInOut, easeIn, easeOut, linear. <br><br>  Replace the animator's initialization of this timing functions (try drawing your own cubic Bezier curve) as follows: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-built_in"><span class="hljs-built_in">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> animator: <span class="hljs-type"><span class="hljs-type">UIViewPropertyAnimator</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> cubicTiming = <span class="hljs-type"><span class="hljs-type">UICubicTimingParameters</span></span>(controlPoint1: <span class="hljs-type"><span class="hljs-type">CGPoint</span></span>(x: <span class="hljs-number"><span class="hljs-number">0.17</span></span>, y: <span class="hljs-number"><span class="hljs-number">0.67</span></span>), controlPoint2: <span class="hljs-type"><span class="hljs-type">CGPoint</span></span>(x: <span class="hljs-number"><span class="hljs-number">0.76</span></span>, y: <span class="hljs-number"><span class="hljs-number">1.0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">UIViewPropertyAnimator</span></span>(duration: <span class="hljs-number"><span class="hljs-number">0.3</span></span>, timingParameters: cubicTiming) }()</code> </pre><br>  Alternatively, instead of using the cubic sync parameters, you can also use spring synchronization, for example: <br><br><pre> <code class="swift hljs"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> springTiming = <span class="hljs-type"><span class="hljs-type">UISpringTimingParameters</span></span>(mass: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, stiffness: <span class="hljs-number"><span class="hljs-number">2.0</span></span>, damping: <span class="hljs-number"><span class="hljs-number">0.2</span></span>, initialVelocity: .zero)</code> </pre><br>  Try running the project again and see what happens. <br><br><h3>  Conclusion </h3><br>  With UIViewPropertyAnimator, you can enhance static screens and user interaction with interactive animations. <br><br>  I know that you cannot wait to implement what you have learned in your own project.  If you apply this approach in your project, it will be very cool, let me know about it, leaving a comment below. <br><br>  As a reference material, you can <a href="https://github.com/appcoda/Interactive-Animation/">download the final draft</a> . <br><br><h3>  Further links </h3><br>  <b>Professional animations using UIKit</b> - <a href="https://developer.apple.com/videos/play/wwdc2017/230/">https://developer.apple.com/videos/play/wwdc2017/230/</a> <br><br>  <b>UIViewPropertyAnimator Apple Developer Documentation</b> - <a href="https://developer.apple.com/documentation/uikit/uiviewpropertyanimator">https://developer.apple.com/documentation/uikit/uiviewpropertyanimator</a> </div><p>Source: <a href="https://habr.com/ru/post/458970/">https://habr.com/ru/post/458970/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../458960/index.html">Corporate Quest</a></li>
<li><a href="../458962/index.html">Let's transform the image into a sound - what can be heard?</a></li>
<li><a href="../458964/index.html">TestMace. Fast start</a></li>
<li><a href="../458966/index.html">Scientists and heads of technology corporations consider the withdrawal of industrial enterprises into space a reality</a></li>
<li><a href="../45897/index.html">How to connect PC and smartphone via WiFi Ad-Hoc</a></li>
<li><a href="../458972/index.html">News of the week: Yandex and Western intelligence agencies, FAS is fighting online casinos, the Ministry of Transport regulates the work of BlaBlaCar</a></li>
<li><a href="../45898/index.html">Netbooks are no longer cheap?</a></li>
<li><a href="../458982/index.html">Nginx Recipes: Convert from HTML to PDF</a></li>
<li><a href="../458984/index.html">How to create the first application for trading on the exchange: 3 initial steps</a></li>
<li><a href="../458986/index.html">PostgreSQL Recipes: Convert from HTML to PDF</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>