<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The introduction of AspectJ in the Android application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share with you my experience of studying the AOP paradigm and developing with its use in a large project. 



 Aspect-oriented programming, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The introduction of AspectJ in the Android application</h1><div class="post__text post__text-html js-mediator-article">  I want to share with you my experience of studying the AOP paradigm and developing with its use in a large project. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/332/e2f/1fd/332e2f1fd03d5bdffcaf83f9e5e5b5d5.png" alt="image"><br><br>  Aspect-oriented programming, or AOP, is a paradigm that distinguishes end-to-end functionality and isolates it in the form of a so-called aspect, or aspect class.  This implies the presence of semantic tools and mechanisms for the engine compartment injection of an aspect into the application code.  Thus, it turns out that the aspect itself determines which parts of the application it needs to process, while the application does not know (before compilation, of course) that an alien code is impudently and shamelessly entered into its sections. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Suppose that we have a rather trivial task - to provide the application with support for some languages ‚Äã‚Äã(russian, english, italian, french, etc.).  You will say that we have a linguistic and regional differentiation of all resources, and you will be right.  Except for the case when the application uses not the built-in resources, but ‚Äúpulls‚Äù them from the server.  In general, this situation is often encountered and is solved trivially - we add BaseSctivity to the abstract class, which we inherit from the system class, a couple of lines to the handler, and everything works.  And you can do without these pair of lines.  And even without a base class.  And if necessary, just copy one file to the application or add a dependency in the gradle, which will do everything itself. <br><br>  So, the task is clear, we write. <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.archinamon.example.xpoint; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.support.v7.app.AppCompatActivity; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.app.Application; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> aspect LocaleMonitor { <span class="hljs-function"><span class="hljs-function">pointcut </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveLocale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execution</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(* MyApplication.onCreate()</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">pointcut </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkLocale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AppCompatActivity activity)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">this</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(activity)</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execution</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(* AppCompatActivity+.onCreate(..)</span></span></span><span class="hljs-function">)</span></span>; after(): saveLocale() { saveCurrentLocale(); } before(AppCompatActivity activity): checkLocale(activity) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isLocaleChanged()) { saveCurrentLocale(); restartApplication(activity); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveCurrentLocale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{<span class="hljs-comment"><span class="hljs-comment">/* implementation */</span></span>} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">restartApplication</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AppCompatActivity context)</span></span></span><span class="hljs-function"> </span></span>{<span class="hljs-comment"><span class="hljs-comment">/* implementation */</span></span>} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isLocaleChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{<span class="hljs-comment"><span class="hljs-comment">/* implementation */</span></span>} }</code> </pre> <br>  By adding this class to our application, we will teach it to restart itself when changing the language in the system. <br><br>  For a while I searched for ready-made solutions and tasted them.  As a result, he wrote his own version.  How it all works, why I had to reinvent the wheel and what came of it all - under the cut! <br><a name="habracut"></a><br>  It should be noted that only the general framework of the aspect is described above, all the mechanics make you add a few extra lines of <i>tips</i> to take context data from <i>slices</i> and <i>connection points</i> .  You will find the full aspect code in the demo application at the end of the article.  The example illustrates the compactness and brevity of injections, due to which the aspect class permeates our application. <br><br><h2>  Philosophy </h2><br>  From this reservation it follows that the aspect class is a decorator over an object class.  Approaching the task of implementing some functionality on aspects, it is important not to forget about the object-oriented mechanisms of language and ideology as such.  Bad way - when an aspect becomes a class that is unreadable and stuffed with utility tools.  Best way - to describe all the logic with a separate object module, as isolated as possible from the outside world, which is connected to the application through an aspect decorator. <br><br>  Speaking about the aspect approach to development as a kind of decorating mechanism, it should be noted its main features, which were partially demonstrated in the example.  The notion of procedures, functions, and methods is replaced by the term <i>‚Äúadvice‚Äù</i> .  Advice can be applied <b>before</b> ( <i>before</i> ), <b>after</b> ( <i>after</i> ) or <b>instead of</b> ( <i>around</i> ) that part of the code where we have been inserted through the <i>slice</i> .  In turn, the notion of a <b>slice</b> ( <i>pointcut</i> ) hides under itself some description of the point (ek) in our program where the aspect class is connected.  This description is a whole set of parameters - the name of the class and / or the signature of the method, the place where it was called or executed, etc.  One slice can describe at least one <b>join point</b> ( <i>joinPoint</i> ), but the maximum is not limited and can permeate the entire application. <br><br><h2>  Testing </h2><br>  Another area where aspects can manifest itself in all its glory is testing and debugging.  Writing a universal profiler of methods and classes is easier than it might seem. <br><br><div class="spoiler">  <b class="spoiler_title">MyProfilerImpl extends Profiler aspect</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.archinamon.example.xpoint; aspect MyProfilerImpl extends Profiler { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> pointcut </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">strict</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">within</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(com.archinamon.example.*)</span></span></span><span class="hljs-function"> &amp;&amp; !</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">within</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*.xpoint.*)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">pointcut </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">innerExecution</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">strict</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execution</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(!</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">public</span></span></span></span><span class="hljs-function"><span class="hljs-params"> !</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">static</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * *(..)</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">pointcut </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">constructorCall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">strict</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*.new(..)</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">pointcut </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publicExecution</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">strict</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execution</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">public</span></span></span></span><span class="hljs-function"><span class="hljs-params"> !</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">static</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * *(..)</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">pointcut </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">staticsOnly</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">strict</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execution</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">static</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * *(..)</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> pointcut </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">catchAny</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">innerExecution</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> || </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">constructorCall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> || </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publicExecution</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> || </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">staticsOnly</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; before(): catchAny() { writeEnterTime(thisJoinPointStaticPart); } after(): catchAny() { writeExitTime(thisJoinPointStaticPart); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> aspect Profiler </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">issingleton</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> pointcut </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">innerExecution</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> pointcut </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">constructorCall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> pointcut </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publicExecution</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> pointcut </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">staticsOnly</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Map&lt;String, Long&gt; sTimeData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentHashMap&lt;&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeEnterTime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JoinPoint.StaticPart jp)</span></span></span><span class="hljs-function"> </span></span>{<span class="hljs-comment"><span class="hljs-comment">/* implementation */</span></span>} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeExitTime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JoinPoint.StaticPart jp)</span></span></span><span class="hljs-function"> </span></span>{<span class="hljs-comment"><span class="hljs-comment">/* implementation */</span></span>} }</code> </pre><br></div></div><br>  The <i>strict ()</i> slice cuts the crawl of junction points to avoid traversing the aspect classes themselves.  Otherwise, the structure described is extremely simple and intuitive.  I deliberately divide the selection of methods, constructors, and static methods into different cuts ‚Äî this will allow you to flexibly customize the profiler for a specific application and a specific task.  The <i>issingleton ()</i> marker in the description of an abstract aspect class explicitly declares that each successor will be a singleton.  In fact, the record is unnecessary, because  all aspect classes are singleton by default.  In our case, this marker is needed here to inform about this property of a third-party developer.  In my practice, I prefer to label implicit functionality - thus increasing the understanding and readability of the module for others. <br><br>  We proceed directly to the testing.  What aspects are effective? <br><br><ul><li>  First of all, its internal mechanics.  We are testing a section of code in its <i>usual</i> habitat, and not trying to emulate the context of application of a specific functional (functions, procedures, the object itself, etc.). </li><li>  The second important plus is the wealth of debug information available at the connection point due to injections at the compilation stage. </li><li>  The third and very important plus lies in the strength of the so-called NamePattern, which describes all the parameters of the slice.  A name pattern can cover a huge number of similar and similar areas (for example, capture all setters getters with a single line cut). </li></ul><br>  All this gives a great profit when writing unit and functional tests.  But there is always an important "but."  Aspect testing is more likely a real-time analysis.  To implement the classic testing cycle, it is still necessary to describe some environment or context in which the test decorators will be executed.  So, as a replacement, the usual frameworks of AOP will not work. <br><br>  I summarize all of the above.  Aspect approach is well suited as an addition to classical testing to cover analyzers and monitors of the work product in order to detect errors in an already running application.  For example, with manual testing or as a beta version of the application. <br><br><div class="spoiler">  <b class="spoiler_title">PS Useful stuff</b> <div class="spoiler_text">  <i>And on aspects you can cover classes and / or methods with exception handlers with one swipe of your fingers:</i> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> aspect NetworkProtector { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> pointcut </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">Response </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">around</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execution</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(* executeRequest(..)</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> proceed(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (NetworkException ex) { Response response = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response(); response.addError(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Error(ex)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response; } } }</code> </pre>  <i>This is the easiest option, and it can be more difficult, describing all the stages in detail and in steps.</i> <br></div></div><br><h3>  Bicycle v3.14: Why and How? </h3><br>  You can master AOP without Android.  To use technology in my project, I started writing my own plug-in to the Gradle build system.  But there are already ready-made solutions, the well-informed reader will say!  And he will be right.  And it will not be completely right, because  all available only for a narrow range of conditions, but did not cover all the necessary and possible combinations.  For example, no plugin could work correctly with flavors or create its own source-set for source code decomposition.  And some allowed to write aspects only in the style of java-annotations.  So I collected all the rakes on the way to implement your own plugin.  Which, as a result, covered all the bottlenecks. <br><br>  <sub>And I even got a <s>hacked</s> semantic plugin (hello Spring @ AOP from Ultimate version!) For personal convenience.</sub> <br><br><div class="spoiler">  <b class="spoiler_title">We are waiting for the official release in future versions of Android Studio</b> <div class="spoiler_text">  Issue Title: <a href="https://code.google.com/p/android/issues/detail%3Fid%3D177838">AspectJ support</a> <br>  Labels: Type-Enhancement <br>  Subcomponent-Tools-Studio Subcomponent-Tools-gradle-ide <br>  Priority-Small Target-1.6 <br></div></div><br>  I note a few obvious and not so things that I had to face during development. <br><br><ul><li><div class="spoiler">  <b class="spoiler_title">Organization of compiler task stack</b> <div class="spoiler_text">  Here and support preprocessing tools, and Retrolambda brought a headache.  It was the first and, subjectively, the most difficult rake.  I first took to writing an extension for Gradle, and I collected all the pitfalls with stack management at the very first stage of development.  According to the results, the plug-in explicitly checks the project for connecting Retrolambda to it and, if the result is positive, it is embedded in the queue before its task.  Otherwise, it becomes in the queue immediately after the java-compiler. </div></div></li><li><div class="spoiler">  <b class="spoiler_title">Performance and incremental build</b> <div class="spoiler_text">  Properly organizing a stack of tasks is half the battle.  To optimize it and give odds to performance is a task of another level.  AspectJ connects with its own compiler, ajc.  And so everything is handled.  Frankly, there is still room for a plugin to develop.  The tasks of code generation by preprocessor, java-source builds, assembly of dex-files (Android executable files of the environment) work in usual optimized conditions.  However, ajc still does not work in incremental mode. </div></div></li><li><div class="spoiler">  <b class="spoiler_title">Adaptation of workspace and gradle-tools</b> <div class="spoiler_text">  At first I implemented the basic features and support for popular plugins.  The source code is compiled, aspects are embedded, the application is being built.  In the project, which became a test site, a terrible date for the introduction of flavors came up.  I understood that the whole plugin will become irrelevant if it fails to make friends with these tools.  And at the same time I wanted to conveniently and concisely equip the workspace with the source code.  Soon, the plugin learned how to work with build-options, properly integrate into their tasks.  And at the end I got my own folder in resources - aspectj, along with java, groovy, aidl and others. </div></div></li></ul><br><h2>  What to take with you? </h2><br>  To the heap to aspects, we also take the syntax of Java 8 and StreamAPI from the same eight (this is necessary for functional work with arrays, collections and lists) - after all, the Java API is already included in the Android API, and alas, it does not boast of innovations. <br><br><div class="spoiler">  <b class="spoiler_title">The build.gradle project file is transformed.</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">buildscript { repositories { mavenCentral() maven { url <span class="hljs-string"><span class="hljs-string">'https://raw.github.com/Archinamon/GradleAspectJ-Android/master/'</span></span> } maven { url <span class="hljs-string"><span class="hljs-string">'https://raw.github.com/Archinamon/RetroStream/master/'</span></span> } } dependencies { //retrolambda classpath <span class="hljs-string"><span class="hljs-string">'me.tatarka:gradle-retrolambda:3.2.3'</span></span> //aspectj classpath <span class="hljs-string"><span class="hljs-string">'com.archinamon:AspectJ-gradle:1.0.16'</span></span> } } // Required because retrolambda <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> maven central repositories { mavenCentral() } apply plugin: <span class="hljs-string"><span class="hljs-string">'com.android.application'</span></span> //<span class="hljs-keyword"><span class="hljs-keyword">or</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'com.android.library'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'me.tatarka.retrolambda'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'com.archinamon.aspectj'</span></span> dependencies { compile <span class="hljs-string"><span class="hljs-string">'com.archinamon:RetroStream:1.0.4'</span></span> }</code> </pre><br></div></div><br>  That's all!  I will leave the detailed setting behind the scenes, but all the details can be found in the source code on the github. <br><br><h3>  Links </h3><br>  Demonstration <a href="https://github.com/Archinamon/AspectJExampleAndroid">project</a> . <br>  <a href="https://github.com/Archinamon/GradleAspectJ-Android">Gradle plugin</a> for Android Studio. </div><p>Source: <a href="https://habr.com/ru/post/269371/">https://habr.com/ru/post/269371/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269355/index.html">How to start a newbie in Go</a></li>
<li><a href="../269359/index.html">What is wrong with this code?</a></li>
<li><a href="../269361/index.html">The digest of interesting materials from the world of Drupal # 14</a></li>
<li><a href="../269367/index.html">Experiment: Is it possible to create an effective trading strategy using machine learning and historical data</a></li>
<li><a href="../269369/index.html">Gyro and accelerometer in web design</a></li>
<li><a href="../269373/index.html">Zombie code Code that lives its own life</a></li>
<li><a href="../269375/index.html">My cat is about "perfect code"</a></li>
<li><a href="../269377/index.html">Api-platform</a></li>
<li><a href="../269379/index.html">Analysis of options for building telephony based on Microsoft Skype For Business</a></li>
<li><a href="../269381/index.html">Pirate metrics: how to create an AARRR email campaign from Dave McClure. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>