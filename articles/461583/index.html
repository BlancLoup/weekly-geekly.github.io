<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Python to help test structural products</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Inspired by the advertising of structural products on Habr√© , adapted the python-script for their independent testing. The basic idea is that such pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Python to help test structural products</h1><div class="post__text post__text-html js-mediator-article">  Inspired by the advertising of structural products on <a href="https://habr.com/ru/company/iticapital/blog/461421/">Habr√©</a> , adapted the python-script for their independent testing.  The basic idea is that such products offer 100% capital protection.  And given 10 years of the bull market, the historical performance of such products is stupefying with risk-free paradise. <br><br>  This article will be interesting for beginner python programmers who are interested in managing their money.  Well, for some, this tool can come in handy for building such strategies on your own.  But be careful, brokers write that this is not for everyone. <br><br>  The code is posted on GitHub as a Jupyter notepad.  Go! <br><a name="habracut"></a><br><h2>  A few words to introduce </h2><br>  I will test on American stocks and there the yield will be lower than in rubles.  The Russian market in absolute terms on the charts is more interesting, but there are more risks in it.  The essence of the tests does not change from this. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We take the data from the free Alpha Advantages, where you first need to get the key by sharing the email address.  Brief instruction in a notebook.  You can take quotes of Russian securities at Finam. <br><br><h2>  Structural Product Charisma </h2><br>  Briefly, your capital is safe, and the yield is higher than the bank deposit (government bonds).  Here are just a few elements of the equation missing: <br><br><ul><li>  There is always income on a bank deposit, but there is a risk of playing zero; </li><li>  You will make a profit, but the broker claims for a significant piece of the pie; </li><li>  There is a restriction on the use of invested money; </li><li>  The broker practically does not bear any risks, and participates only in profits. </li></ul><br><h2>  Strategy </h2><br>  Consider the simplest strategy: <br><br><ul><li>  We buy short-term treasury bonds for 90% of the capital; </li><li>  For the remainder, we buy a high-risk asset; </li><li>  We put a stop at 10% of the price at the start of the period. </li></ul><br>  At the heart of the strategy: treasury bonds give 1-3% per annum, practically excluding the drawdown (if there is a yield).  10% of the drawdown of an asset bought with 10% of capital will be the very risk that bonds will cover.  During periods of the bull market, some stocks can grow several times, which will give us happiness. <br><br>  To manually repeat this strategy, you must perform the following steps: <br><br><ul><li>  Buy bonds.  For example, in the form of ETF. </li><li>  Buy stocks. </li><li>  Put a stop order. </li></ul><br><h2>  How to test </h2><br>  I will briefly describe some solutions with code excerpts that made testing quite flexible and convenient. <br><br><h3>  schedule </h3><br>  You can rebalance in the following periods: week, month, year.  And also on any day within the period: the first, Nth, last.  The `Schedule ()` class is responsible for this: <br><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#         df = pd.DataFrame([], index=pd.date_range(start, end, freq='B')) # ... #      ,   df = df[df.index.isin(dates)].copy() # ... #    # ... elif freq == 'week': groupby = ['year', 'week'] elif freq == 'month': groupby = ['year', 'month'] elif freq == 'year': groupby = ['year'] #      grouped = df.groupby(groupby) for idx, grp in grouped: if len(grp) &gt;= abs(day): df.loc[grp.iloc[day].name, 'allow'] = True</span></span></code> </pre> <br><h3>  Data cycle </h3><br><pre> <code class="python hljs">StructuredProductMill().run()</code> </pre> <br>  As described in one of the <a href="https://habr.com/ru/post/419979/">articles</a> , we can bypass only rebalancing dates in a cycle and skip all other days.  But then we lose statistics on changes in assets within the period, we will not see profitability and drawdowns for each day.  This script, to the detriment of speed, is bypassed every day, which allows you to see the market value of open positions and apply a stop order check. <br><br><h3>  Rebalancing </h3><br><pre> <code class="python hljs">StructuredProductMill().rebalance()</code> </pre> <br>  Here, assets that can be opened are allocated to available capital.  After comparing the calculation with open positions, transactions are executed for the required number: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#  :       balance = self._cash + self.position_balance(day) #         df = day.merge(self._positions[['quantity']], how='left', left_index=True, right_index=True) # ... #              day.loc[is_allow, 'size_order'] = day[is_allow]['size'] / day[is_allow]['size'].sum() #        day['position_to'] = (balance * day['size_order']) // day['open'] #     day['order'] = day['position_to'] - day['position'] # ... #   for symbol, row in day[fltr].iterrows(): self.trade(row['dt'], symbol, row.order, row.open, 'O' if row.order &gt; 0 else 'C')</span></span></code> </pre><br><h3>  Deals </h3><br><pre> <code class="python hljs">StructuredProductMill().trade()</code> </pre> <br>  And here, for speed, you can sacrifice details and control only the change in the profitability of each position.  But the script takes into account commissions and the value of assets, and also keeps a history of transactions, which allows you to calculate transactions and execute a stop order on any day of the test.  This method updates the position and size of the free cache. <br><br><h3>  Launch </h3><br>  To run, you must specify a set of assets with shares and test parameters.  We will test structural products for the calendar year: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   portfolio = {'MINT': 0.9, 'AAPL': 0.1,} #   SYMBOLS = list(portfolio.keys()) df = prices(SYMBOLS) params = { 'benchmark': 'SPY', #     'balance': 100_000, #   'portfolio': portfolio, 'rebalance_day': -1, #      'freq': 'year', #    'stop_loss': 0.1, # -  10% #          'reset_position_prices': True, 'allow_method': allow_default, 'start': pd.to_datetime('2011-01-01'), #   } #  ,      pm = StructuredProductMill(params, prices=prices(SYMBOLS + [params['benchmark']]), show_progress=True) pm.check_params().prepare() #   pm.run() #   pm.print_results(); #   pm.charts()</span></span></code> </pre><br>  At the bottom of the notebook there are charts with profitability and drawdowns at the date of rebalance (at the end of the year), which confirms the extremely low drawdowns of capital at the time of the report and constantly growing profitability.  Although this profitability loses to the broad index of American companies S&amp;P 500. <br><br><h2>  results </h2><br>  The tests involved freely traded American instruments since 2011: <br><br><ul><li>  BIL - ETF for short-term treasury bonds with a yield of 2% per annum at the time of writing.  Remember that in the period from 2009 to 2017, rates were near zero.  An alternative is to use MINT (a fund for short-term fixed-income instruments). </li><li>  AAPL - Apple Stock. </li><li>  MSFT - Microsoft stock. </li><li>  TSLA - Tesla shares. </li></ul><br><h3>  Aapl </h3><br>  This design brought in 8 years revenue of 24% (average annual 2.6%) with a drawdown between rebalances of -6%.  But at the turn of the years, the drawdown is about zero.  The stop was not touched, the market with 180% of the revenue lost order. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f3b/02c/db5/f3b02cdb51ee00dee623838a20da0ed5.png" alt="Profitability and drawdown for every day"><br><br>  Profitability and drawdown for each day (profitability on the left, drawdown on the right). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cf3/606/497/cf36064972efc96716ca5ce9b0408a9e.png" alt="Profitability and drawdown at the turn of the years"><br><br>  Profitability and drawdown at the junction of years (profitability on the left, drawdown on the right). <br><br><h3>  Msft </h3><br>  This design has brought in income for 26 years at 26% (average annual 2.75%) with a drawdown between rebalances of -2%.  At the junction of years, there is no drawdown. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2f8/3cd/506/2f83cd5067fa388a85102ae73c8ac3f4.png" alt="Profitability and drawdown for every day"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/4a6/c36/4d5/4a6c364d5fd322ff88688a8a2e63ed14.png" alt="Profitability and drawdown at the turn of the years"><br><br><h3>  TSLA </h3><br>  This design brought in 8 years revenue of 45% (average annual 4.6%) with a drawdown between rebalances as much as -15%.  But all this in 2013, when Tesla grew almost 5 times.  At the junction of years, the drawdown is up to -2%.  The most hectic, but also profitable passenger. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f1c/e12/0c0/f1ce120c0f705d3346be336bc7b48cc8.png" alt="Profitability and drawdown for every day"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f10/0e4/f6a/f100e4f6acf5154e8999ffe3a5ca6a4c.png" alt="Profitability and drawdown at the turn of the years"><br><br><h2>  Conclusion </h2><br>  Notepad allows you to test any portfolio composition.  These may be humeral funds or several companies.  Although generally without a protective asset. <br><br>  <a href="https://github.com/iamraa/backtest.structured.product">GitHub repository</a> . </div><p>Source: <a href="https://habr.com/ru/post/461583/">https://habr.com/ru/post/461583/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461569/index.html">Note for front-end: what to check before testing</a></li>
<li><a href="../461571/index.html">SVG in real life. Yandex Report</a></li>
<li><a href="../461575/index.html">Creating a 3CX cloud-based PBX on any Openstack-compatible hosting</a></li>
<li><a href="../461577/index.html">Part 5/2 bldg. 1: Crossroads of RocketChip Avenue and slippery instrumentation track</a></li>
<li><a href="../461579/index.html">WebMoney introduces new WMP wallets and changes the rules of the game</a></li>
<li><a href="../461589/index.html">Tic Tac Toe: Content Cycle</a></li>
<li><a href="../46159/index.html">Movable Type 4.23</a></li>
<li><a href="../461593/index.html">API on F #. Access Role Based Application Modules</a></li>
<li><a href="../461595/index.html">From theory to practice: how undergraduates of the faculty of photonics and optoinformatics study and work</a></li>
<li><a href="../4616/index.html">The secret plans of Google for 2006 became known.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>