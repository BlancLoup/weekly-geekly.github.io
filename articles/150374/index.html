<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>TPL + DLR = Multi-threaded scripting</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have long wanted to study ‚ÄúTPL‚Äù (Task Parallel Library) and ‚ÄúDLR‚Äù (Dynamic Languages ‚Äã‚ÄãRuntime). For this, I needed a specific and, preferably, quit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>TPL + DLR = Multi-threaded scripting</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/a2c/dfb/eeb/a2cdfbeeb6e8dc07ae3831377fcab493.png" align="left">  I have long wanted to study ‚ÄúTPL‚Äù (Task Parallel Library) and ‚ÄúDLR‚Äù (Dynamic Languages ‚Äã‚ÄãRuntime).  For this, I needed a specific and, preferably, quite relevant task.  In <a href="http://habrahabr.ru/post/136878/">one</a> of my translations it was told about the so-called "game cycles".  The topic reviewed there is quite interesting for me in itself, and besides, the TPL + DLR combination is suitable for that task in the best way possible, in my opinion.  So I came to the idea of ‚Äã‚Äãimplementing a lightweight asynchronous script engine, which could be relatively easily screwed to different applications (including games).  I decided to implement the engine core in C #.  The choice between dynamic languages ‚Äã‚Äãin my case did not even stand.  I have chosen Ruby for this purpose for a long time.  For a while, I hatched an idea, from time to time thinking about it at my leisure. <br><a name="habracut"></a><br><h4>  Formulation of the problem </h4><br>  So, I want to have the opportunity to run asynchronously or on some specific stream several scripts.  To do this, I will need a service that will be responsible for the following tasks: <br><ul><li>  storing references to running tasks with scripts </li><li>  request for stopping a specific script task </li><li>  task status tracking </li><li>  logging output to the console (Stdout and Stderr) </li><li>  notification of text output to the console by a broadcast event </li></ul><br>  In general, something like this <br> <a href=""><img src="https://habrastorage.org/storage2/fc9/30c/eaf/fc930ceaf78618836b5543f166fa9189.png"></a> <br>  What is there depicted?  The root node, " <b>IRE.Instance</b> ", is a singleton that will serve as the service responsible for coordinating the work of the scripts.  For this, a singleton instance will store a Dictionary with entries for each task added via the " <b>RunScriptWithScheduler</b> " and " <b>RunScriptAsync</b> " <b>functions</b> .  As the name suggests, these functions will be different by the scheduler, under which the task will be launched.  With the help of ‚ÄúRunScriptWithScheduler‚Äù you can run a task, for example, on a GUI thread.  The methods " <b>WriteMessage</b> " and " <b>WriteError</b> " will be accessible from everywhere (including from scripts) and are intended for outputting messages to the log.  On the side of the scripts, it will be possible to override the standard output methods in the console to redirect the text to the service log. <br>  What will be the entry in the dictionary of service tasks?  The key will be a unique GUID that will identify the running script.  This GUID can be easily transferred to both the party requesting the launch of the script and embedded in the context of the script itself.  The value of the record should at least keep references to <b>CancelationToukenSource</b> and <b>Task</b> .  <b>CancelingToukenSource</b> , with which the <b>Task</b> script is created, will allow at any time to signal the task that it is necessary to round out.  And the link to Task itself will allow us to hang a Continuation on it (I will not describe TPL in detail here). <br><br><h4>  IRE service </h4><br>  Perhaps I'll start with a description of the engine core, namely the service, made in the form of a singleton.  Singleton implementation taken from <a href="http://msdn.microsoft.com/en-us/library/ff650316.aspx">MSDN</a> .  There is also a link to a rather detailed analysis of different implementation of the singleton on the YaP JAVA.  I highly recommend reading if someone has not read it yet. <br>  So, I implemented the service in the form of a multithreaded "Double-Checked Locking" singleton.  The base implementation code would be something like this: <br><div class="spoiler">  <b class="spoiler_title">Singleton code commented</b> <div class="spoiler_text"><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Threading; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> IronRuby; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Scripting; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Scripting.Hosting; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Diagnostics</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Scripting.Runtime; namespace IREngine { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> sealed <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> IRE { #region Singleton private static <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> IRE _instance; private static readonly <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> SyncRoot = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>(); private IRE() { //     //        IRE.Instance //  ,       -  ( , )   // var instance = IRE.Instance; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static IRE Instance { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_instance == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (SyncRoot) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_instance == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) _instance = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> IRE(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _instance; } } #endregion #region Consts //     #endregion #region Fields //     #endregion #region Properties //      #endregion #region Private Methods //       #endregion #region <span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> Methods //        #endregion } }</code> </pre> </div></div><br><br>  I think the commentary structure is clear.  There is nothing special about the code.  I will give only a couple of comments on the essence of a singleton.  Instead of a singleton, you could use just a static helper.  But the life cycle of a singleton is easier to control.  For example, the moment a static constructor is called is nondetermined, and the call to a non-static constructor will occur only at the first call to the instance.  Thanks to this, if before starting to work with a singleton in the future we need to initialize something, we will be able to feel relatively safe.  Another interesting thing is double null checking.  Two threads can be inside the first condition at the same time, but ‚Äúlock‚Äù will be executed only on one of them.  The second will wait for the first thread to exit the critical section.  After releasing the critical section, the second thread should check the instance again for "null".  Thus, we will not allow the situation of creating two instances of a singleton in parallel with running threads. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Briefly about using TPL </h4><br>  Now briefly describe the basics of TPL.  You can read more on <a href="http://www.codeproject.com/Articles/152765/Task-Parallel-Library-1-of-n">CodeProject</a> . <br>  The first asynchronous tasks that we create will monitor console output buffers.  As I wrote at the beginning, one and the functions of the service will be logging the output of messages and errors in the console.  So what do we need? <br><ul><li>  Action checks for changes in the Output buffer </li><li>  Error Handling Action for Checking the Output Buffer </li><li>  Action checks for changes to the Error Buffer </li><li>  Error Error Handling Action </li><li>  The public method that will create Task instances for performing actions </li></ul><br>  Let's place the initialization of the Actions in the private constructor of the singleton <br><div class="spoiler">  <b class="spoiler_title">Action initialization</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">private IRE() { //     Ruby _outStringBuilder = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StringBuilder(); _errStringBuilder = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StringBuilder(); _outWatchAction = () =&gt; { <span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (IsConsoleOutputWatchingEnabled) { string msg = string.Format("***\t_outWatchTask &gt;&gt; tick ({0})\t***", i++); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.WriteLine(msg); WriteMessage(msg); Task.Factory.CancellationToken.ThrowIfCancellationRequested(); <span class="hljs-type"><span class="hljs-type">int</span></span> currentLength = OutputBuilder.Length; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OutputUpdated != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; currentLength != _lastOutSize) { OutputUpdated.Invoke(_outWatchTask, <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StringEventArgs(OutputBuilder. ToString(_lastOutSize, currentLength - _lastOutSize))); _lastOutSize = currentLength; } Thread.Sleep(TIME_BETWEEN_CONSOLE_OUTPUT_UPDATES); } }; _outWatchExcHandler = (t) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; Instance.WriteError( string.Format( "!!!\tException raised in Output Watch Task\t!!!\n{0}", t.<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>.InnerException.Message)); }; _errWatchAction = () =&gt; { <span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (IsConsoleErrorWatchingEnabled) { string msg = string.Format("***\t_errWatchTask &gt;&gt; tick ({0})\t***", i++); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.WriteLine(msg); WriteError(msg); Task.Factory.CancellationToken.ThrowIfCancellationRequested(); <span class="hljs-type"><span class="hljs-type">int</span></span> currentLength = ErrorBuilder.Length; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ErrorUpdated != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; currentLength != _lastErrSize) { ErrorUpdated.Invoke(_errWatchTask, <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StringEventArgs(ErrorBuilder. ToString(_lastErrSize, currentLength - _lastErrSize))); _lastErrSize = currentLength; } Thread.Sleep(TIME_BETWEEN_CONSOLE_OUTPUT_UPDATES); } }; _errWatchExcHandler = (t) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; Instance.WriteError( string.Format( "!!!\tException raised in Error Watch Task\t!!!{0}", t.<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>.InnerException.Message)); }; }</code> </pre></div></div><br><br>  Below are the ads of the desired properties, constants and private fields. <br><div class="spoiler">  <b class="spoiler_title">Fields, properties, constants initialization</b> <div class="spoiler_text"><pre> <code class="hljs kotlin">#region Consts <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> readonly int TIME_BETWEEN_CONSOLE_OUTPUT_UPDATES = <span class="hljs-number"><span class="hljs-number">1000</span></span>; #endregion #region Fields <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> bool _outWatchEnabled; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> bool _errWatchEnabled; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Task _outWatchTask; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly CancellationTokenSource _outWatchTaskToken = new CancellationTokenSource(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> int _lastOutSize = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Task _errWatchTask; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly CancellationTokenSource _errWatchTaskToken = new CancellationTokenSource(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> int _lastErrSize = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly StringBuilder _outStringBuilder; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly StringBuilder _errStringBuilder; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly Action _outWatchAction; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly Action&lt;Task&gt; _outWatchExcHandler; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly Action _errWatchAction; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly Action&lt;Task&gt; _errWatchExcHandler; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly CancellationTokenSource _scriptsToken = new CancellationTokenSource(); #endregion #region Properties <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> StringBuilder OutputBuilder { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { lock (SyncRoot) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _outStringBuilder; } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> StringBuilder ErrorBuilder { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { lock (SyncRoot) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _errStringBuilder; } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> bool IsConsoleOutputWatchingEnabled { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { lock (SyncRoot) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _outWatchEnabled; } } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { lock (SyncRoot) { _outWatchEnabled = value; } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> bool IsConsoleErrorWatchingEnabled { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { lock (SyncRoot) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _errWatchEnabled; } } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { lock (SyncRoot) { _errWatchEnabled = value; } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> event EventHandler&lt;StringEventArgs&gt; OutputUpdated; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> event EventHandler&lt;StringEventArgs&gt; ErrorUpdated; #endregion</code> </pre></div></div><br><br>  What does this code do?  The lengths of the StringBuilders are compared periodically, and if the lengths have changed, the corresponding events are jerking.  In the event handlers (on the GUI side), the added message text is displayed on the screen.  It should be noted that on the side of the graphical interface, the code in the handler will also be executed inside Task, but with an explicit indication for the scheduler task received from the graphical interface.  Because  an event is jerked in an asynchronous task executed NOT in a GUI thread, then the code in the handler will not have direct access to the interface elements.  We have to create an Action and run it on the interface stream, explicitly specifying the Scheduler of the main application window.  Below is the event handler code on the GUI side. <br><div class="spoiler">  <b class="spoiler_title">Event handler code</b> <div class="spoiler_text"><pre> <code class="hljs coffeescript">IRE.Instance.OutputUpdated += <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s, args)</span></span></span><span class="hljs-function"> =&gt;</span></span> { string msg = string.Format(<span class="hljs-string"><span class="hljs-string">"***\tIRE &gt;&gt; Out Updated callback\t***\nResult: {0}\n***\tEND\t***\n"</span></span>,args.Data); Debug.WriteLine(msg); var uiUpdateTask = Task.Factory.StartNew(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { OutputLogList.Items.Add(msg); }, Task.Factory.CancellationToken, TaskCreationOptions.None, _uiScheduler); uiUpdateTask.Wait(); }; IRE.Instance.ErrorUpdated += <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s, args)</span></span></span><span class="hljs-function"> =&gt;</span></span> { string msg = string.Format(<span class="hljs-string"><span class="hljs-string">"!!!\tIRE &gt;&gt; Err Updated callback\t!!!\nResult: {0}\n!!!\tEND\t!!!\n"</span></span>, args.Data); Debug.WriteLine(msg); var uiUpdateTask = Task.Factory.StartNew(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { ErrorLogList.Items.Add(msg); }, Task.Factory.CancellationToken, TaskCreationOptions.None, _uiScheduler); uiUpdateTask.Wait(); }; IRE.Instance.StartWatching();</code> </pre></div></div><br><br>  This code adds a subscription to the console output buffer update event.  The main thing you should pay attention to in it is " <b>_uiScheduler</b> ".  This is a link created in the constructor of the main window to its (windows) scheduler.  This link is created as follows. <br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainWindow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InitializeComponent(); _uiScheduler = TaskScheduler.FromCurrentSynchronizationContext(); }</code> </pre><br>  All Task'i created with the indication of this scheduler will be running on the flow of the graphical interface, regardless of which thread they instantiated.  Closures on graphical elements of the interface will not cause exceptions of cross-flow access. <br>  Now about the line " <b>uiUpdateTask.Wait ();</b> ".  It is desirable to frame this line in " <b>try - catch</b> ".  All exceptions that occur within a Task are not immediately transferred to the thread that created the task.  One way to get access to exceptions in the calling thread is to call the ‚ÄúWait ()‚Äù function.  It is also possible to add ‚ÄúContinuation‚Äù to the TASK and already in it to poke the exceptions.  It does not matter how, but you <b>must</b> handle exceptions.  Otherwise, exceptions will be passed to the calling thread when the GarbageCollector gets to the task.  At what point it happens - is unknown.  Therefore, for the application it can be fatal. <br>  In this case, for simplicity, I did not add " <b>try-catch</b> ", but I would probably add it later.  Now the code here is simple enough, and in the future everything can change. <br>  Now it remains to give the code for creating tasks for monitoring console output. <br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StartWatching</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { StopWatching(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_outWatchTask != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) _outWatchTask.Wait(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_errWatchTask != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) _errWatchTask.Wait(); IsConsoleOutputWatchingEnabled = IsConsoleErrorWatchingEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; _outWatchTask = Task.Factory.StartNew(_outWatchAction, _outWatchTaskToken.Token); _outWatchTask.ContinueWith(_outWatchExcHandler, TaskContinuationOptions.OnlyOnFaulted); _errWatchTask = Task.Factory.StartNew(_errWatchAction, _errWatchTaskToken.Token); _errWatchTask.ContinueWith(_errWatchExcHandler, TaskContinuationOptions.OnlyOnFaulted); }</code> </pre><br>  Everything is simple here too.  Just in case, we stop the tracking tasks (" <b>StopWatching ();</b> ").  Calling this function simply sets the flags " <b>IsConsoleOutputWatchingEnabled</b> " and " <b>IsConsoleErrorWatchingEnabled</b> " to <b>false</b> , and also stops the <b>request</b> through " <b>CancelingToken</b> ".  I could confine myself to a token.  But in general, a request to stop through a token is considered an emergency stop.  There is even a special function " <i>Task.Factory.CancellationToken.ThrowIfCancellationRequested ();</i> ", the call of which causes the task to throw an exception if during the execution of the task a cancellation request is received through a token.  Here it is worth making a reservation that calling this function and generally checking the status of the CancelationToken is quite an expensive procedure.  Therefore, it is desirable to do it as rarely as possible. <br>  The next thing I want to draw attention to is the construction of the form " <i>_outWatchTask.ContinueWith (_outWatchExcHandler, TaskContinuationOptions.OnlyOnFaulted);</i> ".  This code puts a so-called ‚Äúcontinuation‚Äù on the task (Continuation).  And the continuation is created with the option " <b>TaskContinuationOptions.OnlyOnFaulted</b> ".  Such a continuation will be called only in the case when the ‚ÄúAggregatedException‚Äù of the task contains at least one exception.  Simply put, if the task is completed normally, then this continuation will be ignored.  It should also be noted that there may be several exceptions.  After all, we can create nested sub-tasks within this task.  When nested tasks are collected by " <b>GC</b> ", all unhandled exceptions will pop up to the parent in the form of the same "AggregatedException".  Thus, you can get a whole tree of nested exceptions.  To turn this exception tree into a flat list, there is a special method " <a href="http://msdn.microsoft.com/ru-ru/library/system.aggregateexception.flatten"><b>AggregatedException.Flatten ()</b></a> ". <br><br><h4>  Script Embedding Basics </h4><br>  Now let's talk about the scripting itself.  First we need to create a ‚ÄúScriptEngine‚Äù and load the necessary .Net assemblies of our application into it.  This is done simply: <br><pre> <code class="hljs coffeescript">_defaultEngine = Ruby.CreateEngine(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(setup)</span></span></span><span class="hljs-function"> =&gt;</span></span> { setup.ExceptionDetail = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }); _defaultEngine.Runtime.LoadAssembly(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IRE).Assembly);</code> </pre><br>  I added this code to the beginning of the private singleton constructor.  The first part of the code, in fact, creates an instance of ‚ÄúScriptEngine‚Äù.  The lambda transmitted as a parameter allows you to configure the engine.  It is not necessary to do this.  But using this approach you can prevent ScriptEngine from compiling Ruby code so that the scripts are interpreted each time.  This is useful, for example, on the WindowsPhone 7 platform, since  save memory.  I just included a detailed display of information about exceptions. <br>  The second part simply loads the build with our service into the Ruby runtime engine.  Without this, we will not be able to communicate with our application from scripts.  In the same way you can download other necessary assemblies.  It is desirable to generally take out this loading of assemblies in a separate method, so that it is easier to add new assemblies and at the same time the sheet of the same type of code is not messed with eyes. <br>  It remains to provide the function code for adding an asynchronous task of the script and several service methods. <br><div class="spoiler">  <b class="spoiler_title">Add asynchronous task script script</b> <div class="spoiler_text"><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Guid RunScriptAsync(string code) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scriptScope = _defaultEngine.CreateScope(); CompiledCode compiledCode = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ScriptSource scriptSource = _defaultEngine.CreateScriptSourceFromString(code, SourceCodeKind.AutoDetect); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errListner = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorSinkProxyListener(ErrorSink.<span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>); compiledCode = scriptSource.Compile(errListner); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { WriteError(ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.<span class="hljs-keyword"><span class="hljs-keyword">Empty</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> action = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Action(() =&gt; compiledCode.Execute(scriptScope)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tokenSource = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CancellationTokenSource(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> task = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Task(action, tokenSource.Token, TaskCreationOptions.LongRunning); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> guid = Guid.NewGuid(); AddTask(guid, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TaskRecord { TokenSource = tokenSource, Task = task }); task.Start(); task.ContinueWith((t) =&gt; { <span class="hljs-comment"><span class="hljs-comment">// Actually we don't needed this due to "TaskContinuationOptions.OnlyOnFaulted" is set if (t.Exception == null) return; t.Exception.Flatten().Handle((ex) =&gt; { Instance.WriteError(t.Exception.InnerException.Message); return true; }); }, TaskContinuationOptions.OnlyOnFaulted); task.ContinueWith((t) =&gt; { Instance.RemoveTask(guid); }); return guid; } public void AddTask(Guid key, TaskRecord record) { _tasks.Add(key, record); } public void RemoveTask(Guid key) { _tasks.Remove(key); } public Task GetTask(Guid key) { return _tasks.ContainsKey(key) ? _tasks[key].Task : null; } public void RequestCancelation(Guid key) { var tokenSource = _tasks.ContainsKey(key) ? _tasks[key].TokenSource : null; if (tokenSource == null) return; tokenSource.Cancel(); }</span></span></code> </pre></div></div><br>  What do we have here?  First create a ScriptScope.  We will use the default Ruby engine, but each script will have its own ScriptScope.  The scope of all variables and script execution results will be limited to these scopes. <br>  Then ScriptSource and CompiledCode are created inside ‚Äútry-catch‚Äù.  ‚ÄúTry - catch‚Äù is needed because  when creating a compiled code, exceptions may occur.  In this case, we return an empty Guid, and the caller must adequately handle this situation.  If the script compiles normally, then you can start creating the task of executing the script. <br>  So, we create an Action that executes the script, we create a CancelationTokenSource, a new Task with the ‚ÄúTaskCreationOptions.LongRunning‚Äù option (after all, the script will potentially run for a long time).  Then we create a new Guid for the task and, finally, we pack it all into a new entry in the Dictionary of scripting tasks.  As I planned at the beginning. <br>  After creation, we run the task and hang on it with the continuation of exception handling.  In the continuation of the task, we produce a ‚Äúflattening‚Äù AggregatedException and process all exceptions ( <i>return true;</i> ), having previously written an error message to the log. <br>  In addition to the continuation indicated above, we hang another one that will be called upon any completion of the task.  In this continuation, we delete the spent Task from the dictionary, since  it is no longer useful to us. <br>  With service functions like everything is simple. <br><br><h4>  Usage example </h4><br>  To demonstrate the operation of this scripting framework, I created a window application project.  The window layout is simple. <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Window</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"IREngineTestBed.MainWindow"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:x</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MainWindow"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"350"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"525"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid.ColumnDefinitions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ColumnDefinition</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ColumnDefinition</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid.ColumnDefinitions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid.RowDefinitions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RowDefinition</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RowDefinition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Auto"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid.RowDefinitions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"StartButton"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Start"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Row</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Margin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"25"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"StartButton_Click"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"StopButton"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Stop"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Row</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Column</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Margin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"25"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"StopButton_Click"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ListBox</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"OutputLogList"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Column</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Margin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ListBox</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ErrorLogList"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Column</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Margin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Window</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h4>  Conclusion </h4><br>  The window contains two ListBoxes and two buttons.  I did not use TextBlock to display logs because of the poor performance of adding lines (TextBlock.Text + = "some string" - there is a great evil, as you probably know).  But ListBoxes are actually a bad idea.  Just because the text is not copied.  In general, ListBox'y just for the demonstration put (in haste).  In the future I will replace, probably, with RichTextBox.  In them, string virtualization seems to be there, and the text, it seems, is appended to StringBuilder. <br>  So, the ‚ÄúStartButton‚Äù button performs (re) the start of tasks for monitoring the console output buffers and the script execution task.  Button "StopButton" - all stops. <br>  Here is the test script code. <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#!ruby19 # encoding: utf-8 include IREngine class IRE def log(message) IRE.Instance.write_message message end def err(message) IRE.Instance.write_error message end end def log(message, is_err = false) IRE.Instance.log message unless is_err IRE.Instance.err message if is_err end 5.times{|i| log "Hello, Output! (from Ruby Async Task)" log "Hello, Error! (from Ruby Async Task)", true } raise "\n!!!\tBOOO! Catch super scaring exception from RUBY...\t!!!\n"</span></span></code> </pre> <br>  In this code, helper methods for outputting messages to the log are added to the service class.  Moreover, additional methods are added to the instance singleton.  But if I put the prefix ‚Äúself.‚Äù Or ‚ÄúIRE‚Äù in front of the method names, they would be created as static methods.  Probably later I will do it (it will be necessary to separately protest this case). <br>  In the body of the script, we see a fivefold line output to the log and forwarding exceptions.  This exception will be handled correctly on the service side.  This is what the interface looks like after running the script <br><img src="https://habrastorage.org/storage2/3d8/4c7/773/3d84c7773c3457b203ca8390393f9161.png"><br><br><h4>  Conclusion </h4><br>  In this article, I presented a basic implementation of the engine that allows you to run several scripts asynchronously at the same time.  At the time of this writing, not all our plans have been implemented.  For example, you still need to check the correctness of handling the situation of syntax errors in scripts.  Also, the method of launching the script with a specific scheduler is not implemented yet. <br>  You can follow the development of code in the repository on <a href="https://github.com/homoluden/IREngine">github</a> .  I would be glad if someone takes part in the development of the project. <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/150374/">https://habr.com/ru/post/150374/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150364/index.html">Strangeness with cycles: in debug it works, in release it is not</a></li>
<li><a href="../150368/index.html">Testing Java table from hamcrest</a></li>
<li><a href="../150370/index.html">Another includeJS</a></li>
<li><a href="../150372/index.html">Speakker - music player on jQuery</a></li>
<li><a href="../150373/index.html">HTML5 games and GodMode: everything is simple!</a></li>
<li><a href="../150375/index.html">Good client-server architecture</a></li>
<li><a href="../150376/index.html">Smart web search: not only finds, but also recommends</a></li>
<li><a href="../150377/index.html">Oceans, Robots and Java</a></li>
<li><a href="../150378/index.html">An error was registered in the updated version of the Google Chrome browser</a></li>
<li><a href="../150379/index.html">Speaktoit Assistant understands and speaks Russian</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>