<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As we did a small security system on the RPi. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! In the previous article I talked a little about the iron part of the project of the security system and about the system in Python, which works...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As we did a small security system on the RPi. Part 2</h1><div class="post__text post__text-html js-mediator-article">  Hello!  In the <a href="http://habrahabr.ru/post/231869/">previous article</a> I talked a little about the iron part of the project of the security system and about the system in Python, which works with this iron.  In this article I continue the story about the server part. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7f1/8dc/82b/7f18dc82b7fa456da5b51d5c7af60463.png" alt="image"></div><a name="habracut"></a><br>  The security system will be located outside of the wi-fi, and it will only have mobile Internet at low speed, so I decided that the data exchange should be done as less as possible.  In this case, the simplest solution is to use digital codes.  Those.  we send to server 1 and he realizes that the motion sensor has triggered, 2 is a smoke sensor, etc., for each event its own code.  In turn, the server decrypts the codes and sends what it considers necessary, in the form of a push-notification in the iOS application, already in text.  In addition, each event is recorded both in the log on the RPi side and in the server log, this log can also be viewed in the application.  By the way, all work with the server in Python is done using <a href="http://docs.python-requests.org/en/latest/">Requests</a> . <br><br>  The server is written in PHP, MySQL is also there, it contains a log and current settings, i.e.  just two tables, here's one of them: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/808/fd7/74b/808fd774bd88471290328f54beb9d526.png"><br><br>  All requests are accepted using normal POST, and are sent to JSON.  It looks like this: <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">print</span></span> json_encode(getRequest($_POST));</code> </pre> <br>  To work, the server needs not so many methods: <br><br><ul><li>  Receive a message from RPi </li><li>  Give log </li><li>  Set preferences </li><li>  Give settings </li></ul><br>  Now, regarding the settings, I thought for a long time how to implement the control of the security system from the application, and came to the conclusion that the method is quite suitable for me when the settings are stored on the server, and the security system updates them every minute.  Those.  if I want to turn off the alarm, in the worst case, it will turn off after a minute.  At the same time, she will inform me that she has turned off, so there will be no unpleasant surprise. <br><br>  The server also ensures that RPi reports every minute that it is online and nothing has happened to it.  If this does not happen within 5 minutes, the server starts to sound the alarm.  This check is made with the help of cron <br><br><pre> <code class="bash hljs">*/5 * * * * php /aliceserver/checkAlice.php</code> </pre> <br>  Every 5 minutes, he runs a simple checkout script. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">include_once</span></span> $dir . <span class="hljs-string"><span class="hljs-string">'defines.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">include_once</span></span> $dir . <span class="hljs-string"><span class="hljs-string">'db.php'</span></span>; $db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataBase; $db-&gt;connect(); $query = <span class="hljs-string"><span class="hljs-string">"SELECT alice, UNIX_TIMESTAMP(online) online FROM "</span></span> . SQLTableStatus; $result = $db-&gt;query($query); $alice_is_on = $result[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'alice'</span></span>]; $online = (time() - $result[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'online'</span></span>] &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($alice_is_on <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> !$online) { <span class="hljs-keyword"><span class="hljs-keyword">include_once</span></span> $dir . <span class="hljs-string"><span class="hljs-string">'send_push.php'</span></span>; $text = <span class="hljs-string"><span class="hljs-string">"Alice offline!"</span></span>; $query = <span class="hljs-string"><span class="hljs-string">"INSERT INTO `"</span></span> . SQLTableLog . <span class="hljs-string"><span class="hljs-string">"` (text, sender) VALUES ('$text', 1)"</span></span>; $db-&gt;query($query); send_push_message($text, AppToken, <span class="hljs-string"><span class="hljs-string">'alice_offline.caf'</span></span>, $dir); } $db-&gt;disconnect();</code> </pre> <br>  Sending push notifications is implemented using <a href="https://github.com/duccio/ApnsPHP">ApnsPHP</a> .  Those of you who have at least once encountered sending push notifications to Apple servers are probably familiar with this wonderful open-sourse solution.  For those who do not know what it is, I can only say that at the moment it is one of the best wrappers that allows you to easily send notifications, while at the same time you need a minimum of time and effort to set it up. <br><br>  This is where the story about the server part comes to an end, the next time I will tell you how the iOS application was made.  Thank you all for your attention, and if possible I will answer all questions on hardware and software in the comments. </div><p>Source: <a href="https://habr.com/ru/post/231963/">https://habr.com/ru/post/231963/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../231951/index.html">NASA Experts Chose Curiosity Scientific Instruments for the Heir</a></li>
<li><a href="../231955/index.html">CentOS 7 Review. Part 3: NFS, FedFS, pNFS</a></li>
<li><a href="../231957/index.html">Memory management in the Linux kernel. Yandex Workshop</a></li>
<li><a href="../231959/index.html">Who are you? A freelance artist, a gzhel tableware or a house painter?</a></li>
<li><a href="../231961/index.html">Non-functional software requirements. Part 1</a></li>
<li><a href="../231965/index.html">Digest photo news # 8: the best materials of the end of July</a></li>
<li><a href="../231967/index.html">Network installation of workstations based on Debian GNU / Linux</a></li>
<li><a href="../231969/index.html">Java Gadget Switch</a></li>
<li><a href="../231971/index.html">Introduction to sbt</a></li>
<li><a href="../231973/index.html">20 excellent quotes about the conversion of the "guru"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>