<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Testing Stored Functions with pgTAP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I posted an article with the "skeleton" of a data schema that you can use to create your PostgreSQL schemas. 
 In addition to the actual dep...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Testing Stored Functions with pgTAP</h1><div class="post__text post__text-html js-mediator-article">  Recently, I posted <a href="http://habrahabr.ru/post/209584/">an article</a> with the "skeleton" of a data schema that you can use to create your PostgreSQL schemas. <br>  In addition to the actual deployment of the schema, creation of objects, there were examples of stored functions and unit tests for them. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d92/76e/b51/d9276eb5167d78f682f41978fc7842b1.jpg"><br><br>  In this article, I would like to take a closer look at the example of pg_skeleton on how to write tests for PostgreSQL stored functions using <a href="http://pgtap.org/">pgTAP</a> . <br><a name="habracut"></a><br>  The pgTAP tests, as the name implies, output text in plain text <a href="http://en.wikipedia.org/wiki/Test_Anything_Protocol">TAP (Test Anything Protocol)</a> format.  This format is adopted by many CI systems.  We use <a href="https://wiki.jenkins-ci.org/display/JENKINS/TAP%2BPlugin">Jenkins TAP Plugin</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When installing the extension, the database creates stored functions (by default in the public scheme), which we will use when writing tests.  Most of the functions are various assertions.  The full list can be found here: <a href="http://pgtap.org/documentation.html">http://pgtap.org/documentation.html</a> <br><br>  We will test the functions from the sample test_user scheme: <br>  First, <a href="http://habrahabr.ru/post/209584/">install pg_skeleton</a> .  (If you want to write tests at once in your scheme - from the installation instructions for pg_skeleton, follow only the part about pgtap and load the extension into the database) <br><br>  I tried to make the tests similar to those used in real projects, and use more different f-th pgTAP. <br>  Before starting the tests, you must specify their number by calling the function plan (int). <br>  In our example, this call is in the file test / tests / run_user.sql: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> plan(<span class="hljs-number"><span class="hljs-number">7</span></span>+<span class="hljs-number"><span class="hljs-number">2</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  In this case, 7 is the number of tests run from the user_crud.sql file (tests f-th), 2 is the number of tests in the user_schema.sql file, 1 is a one-line test (checking the coverage of functions with tests) directly in the run_user.sql file. <br>  The pgTAP documentation deals mainly with tests triggered by individual select requests ‚Äî this is suitable for testing the schema, or for testing simple functions that have no side effects (such tests in user_schema.sql). <br>  But when testing complex scenarios, when you need to call several functions, and the result of the previous one is transferred to the next one, you can combine tests into a stored function that will execute a script containing several tests.  An example of such a function in the test / functions_user.sql file. <br>  The function must be declared as returning a set of lines: <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> test.test_user_0010() <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-keyword"><span class="hljs-keyword">setof</span></span> <span class="hljs-type"><span class="hljs-type">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $$<span class="ruby"><span class="ruby"> --   - ,        - --        runtests(). -- ,       : declare v_user_id integer; </span><span class="hljs-keyword"><span class="ruby"><span class="hljs-keyword">begin</span></span></span><span class="ruby"> --  - ,    ,   : </span><span class="hljs-keyword"><span class="ruby"><span class="hljs-keyword">return</span></span></span><span class="ruby"> </span><span class="hljs-keyword"><span class="ruby"><span class="hljs-keyword">next</span></span></span><span class="ruby"> lives_ok(</span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'select test_user.add_user('</span></span></span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'testuser unique'</span></span></span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'::varchar);'</span></span></span><span class="ruby">, </span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'test_user.add_user doesnt throw exception'</span></span></span><span class="ruby">); --   ,   , ,    (&gt;</span><span class="hljs-number"><span class="ruby"><span class="hljs-number">0</span></span></span><span class="ruby">): v_user_id </span><span class="hljs-symbol"><span class="ruby"><span class="hljs-symbol">:</span></span></span><span class="ruby">= test_user.add_user(</span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'blah blah'</span></span></span><span class="ruby">); </span><span class="hljs-keyword"><span class="ruby"><span class="hljs-keyword">return</span></span></span><span class="ruby"> </span><span class="hljs-keyword"><span class="ruby"><span class="hljs-keyword">next</span></span></span><span class="ruby"> cmp_ok(v_user_id, </span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'&gt;'</span></span></span><span class="ruby">, </span><span class="hljs-number"><span class="ruby"><span class="hljs-number">0</span></span></span><span class="ruby">, </span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'test_user.add_user: returns ok'</span></span></span><span class="ruby">); --,    . </span><span class="hljs-keyword"><span class="ruby"><span class="hljs-keyword">return</span></span></span><span class="ruby"> </span><span class="hljs-keyword"><span class="ruby"><span class="hljs-keyword">next</span></span></span><span class="ruby"> results_eq(</span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'select user_name::varchar from test_user.users where user_id='</span></span></span><span class="ruby"> </span><span class="hljs-params"><span class="ruby"><span class="hljs-params">||</span></span></span><span class="ruby"> v_user_id::varchar, </span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'select '</span></span></span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'blah blah'</span></span></span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'::varchar'</span></span></span><span class="ruby">, </span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'test_user.add_user inserts ok'</span></span></span><span class="ruby">); --      : </span><span class="hljs-keyword"><span class="ruby"><span class="hljs-keyword">return</span></span></span><span class="ruby"> </span><span class="hljs-keyword"><span class="ruby"><span class="hljs-keyword">next</span></span></span><span class="ruby"> is(test_user.alter_user(v_user_id,</span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'new user name blah'</span></span></span><span class="ruby">), v_user_id, </span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'test_user.alter_user: returns ok'</span></span></span><span class="ruby">); --,    : </span><span class="hljs-keyword"><span class="ruby"><span class="hljs-keyword">return</span></span></span><span class="ruby"> </span><span class="hljs-keyword"><span class="ruby"><span class="hljs-keyword">next</span></span></span><span class="ruby"> results_eq(</span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'select user_name::varchar from test_user.users where user_id='</span></span></span><span class="ruby"> </span><span class="hljs-params"><span class="ruby"><span class="hljs-params">||</span></span></span><span class="ruby"> v_user_id::varchar, </span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'select '</span></span></span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'new user name blah'</span></span></span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'::varchar'</span></span></span><span class="ruby">, </span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'test_user.alter_user updates record'</span></span></span><span class="ruby">); --      </span><span class="hljs-symbol"><span class="ruby"><span class="hljs-symbol">id:</span></span></span><span class="ruby"> </span><span class="hljs-keyword"><span class="ruby"><span class="hljs-keyword">return</span></span></span><span class="ruby"> </span><span class="hljs-keyword"><span class="ruby"><span class="hljs-keyword">next</span></span></span><span class="ruby"> is(test_user.delete_user(v_user_id), v_user_id, </span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'test_user.delete_user: returns ok'</span></span></span><span class="ruby">); -- . ,    : </span><span class="hljs-keyword"><span class="ruby"><span class="hljs-keyword">return</span></span></span><span class="ruby"> </span><span class="hljs-keyword"><span class="ruby"><span class="hljs-keyword">next</span></span></span><span class="ruby"> is_empty(</span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'select 1 from test_user.users where user_id='</span></span></span><span class="ruby"> </span><span class="hljs-params"><span class="ruby"><span class="hljs-params">||</span></span></span><span class="ruby"> v_user_id::varchar, </span><span class="hljs-string"><span class="ruby"><span class="hljs-string">'test_user.delete_user: deletes ok'</span></span></span><span class="ruby">); </span><span class="hljs-keyword"><span class="ruby"><span class="hljs-keyword">end</span></span></span><span class="ruby">; $$</span></span> <span class="hljs-keyword"><span class="hljs-keyword">language</span></span> plpgsql;</code> </pre><br><br>  You can run tests directly from sql: <br><pre> <code class="bash hljs">psql -h <span class="hljs-variable"><span class="hljs-variable">$db_host</span></span> -p <span class="hljs-variable"><span class="hljs-variable">$db_port</span></span> -U <span class="hljs-variable"><span class="hljs-variable">$db_user</span></span> <span class="hljs-variable"><span class="hljs-variable">$db_name</span></span> -f tests/run_user.sql</code> </pre><br>  in this case, we get a clean tap at the output: <br><pre> plan | 1..10
 test_user_0010 | ok 1 - test_user.add_user doesnt throw exception
 test_user_0010 | ok 2 - test_user.add_user: returns ok
 test_user_0010 | ok 3 - test_user.add_user inserts record
 test_user_0010 | ok 4 - test_user.alter_user: returns ok
 test_user_0010 | ok 5 - test_user.alter_user updates record
 test_user_0010 | ok 6 - test_user.delete_user: returns ok
 test_user_0010 | ok 7 - test_user.delete_user: deletes ok
 tables_are | ok 8 - Schema test_user contains users table
 columns_are | ok 9 - test_user.users column check
 test_scheme_check_func | ok 10 - all functions in schema test_user are covered with tests.
</pre><br>  Or using the pg_prove utility: <br><pre> <code class="bash hljs">pg_prove -h <span class="hljs-variable"><span class="hljs-variable">$db_host</span></span> -p <span class="hljs-variable"><span class="hljs-variable">$db_port</span></span> -d <span class="hljs-variable"><span class="hljs-variable">$db_name</span></span> -U <span class="hljs-variable"><span class="hljs-variable">$db_user</span></span> tests/run_*.sql</code> </pre><br>  Then the output will be more readable: <br><pre> tests / run_user.sql .. ok     
 All tests successful.
 Files = 1, Tests = 10, 0 wallclock secs (0.04 usr + 0.00 sys = 0.04 CPU)
 Result: PASS
</pre><br>  In pg_skeleton, the variables for host, port, username and database will be replaced by the /test/run_tests.sh script for you <br><br>  I hope that now everyone who has code in the PostgreSQL stored functions will have unit tests! </div><p>Source: <a href="https://habr.com/ru/post/209932/">https://habr.com/ru/post/209932/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../209920/index.html">Yet another audioplayer</a></li>
<li><a href="../209922/index.html">Designer review Android 4.4 KitKat. Part 1</a></li>
<li><a href="../209924/index.html">Burn after reading</a></li>
<li><a href="../209926/index.html">New beta Yandex. Browser 14.2: improved download manager and view office documents</a></li>
<li><a href="../209928/index.html">The main events of 2013 through the eyes of Chris Graft (Kris Graft), editor in chief of Gamasutra</a></li>
<li><a href="../209934/index.html">"Perfect" cluster. Part 2.2: Highly available and scalable web server, the best technologies to guard your business</a></li>
<li><a href="../209936/index.html">Deep immersion in test-driven javascript</a></li>
<li><a href="../209940/index.html">Intel Quark. Better late than never</a></li>
<li><a href="../209944/index.html">Who is who: Smart watches</a></li>
<li><a href="../209946/index.html">Bitcoin cryptocurrency began to take in Las Vegas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>