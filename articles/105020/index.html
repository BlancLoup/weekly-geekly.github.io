<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The battle with the "dark genius" or Microsoft-HTTPAPI / 2.0 strikes the first blow</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One day, after returning from vacation, having done enough, I decided to pile something divine in PHP. He opened his beloved Denwer and was struck by ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The battle with the "dark genius" or Microsoft-HTTPAPI / 2.0 strikes the first blow</h1><div class="post__text post__text-html js-mediator-article"> One day, after returning from vacation, having done enough, I decided to pile something divine in PHP.  He opened his beloved Denwer and was struck by an unexpected change: Apache completely refused to listen to port 80, which means that my noble intentions for this evening were in jeopardy.  The situation is, in general, quite banal - immediately the cherished trigger worked in my head: Skype!  However, to my surprise, Skype immediately announced that he was not involved in this incident by not having a check mark in front of the corresponding setting.  To finally check the alibi of a foreign videophone, I decided to see who is listening to port 80 at the moment. <br><a name="habracut"></a><br>  What I saw did not add to my optimism, but rather made me scratch my crown in thought: <br><br> <code>  <br> <br>       PID <br> TCP 0.0.0.0:80 0.0.0.0:0 LISTENING 4 <br>       <br> TCP 0.0.0.0:135 0.0.0.0:0 LISTENING 900 <br> RpcSs <br> [svchost.exe] <br> TCP 0.0.0.0:445 0.0.0.0:0 LISTENING 4 <br>       <br> TCP 0.0.0.0:990 0.0.0.0:0 LISTENING 2428 <br> WcesComm <br> [svchost.exe] <br> TCP 0.0.0.0:5357 0.0.0.0:0 LISTENING 4 <br>      </code> <br> <br>  It became clear that illegal armed gangs operate on the computer.  Moreover, they act by partisan methods, since PID = 4 belonged to the System process. <br>  The first thought came quite by accident: if someone listens to the port, then maybe he‚Äôs answering something there, because having armed with a bunch of Firefox + Firebug, I sent a request to <a href="http://localhost/">localhost</a> .  Oddly crazy thought bore fruit.  Unknown enemy replied: <br><br> <code>  <br> <br> HTTP/1.1 404 Not Found <br> Content-Type: text/html; charset=us-ascii <br> Server: Microsoft-HTTPAPI/2.0 <br> Date: Sat, 25 Sep 2010 11:20:20 GMT <br> Connection: close <br> Content-Length: 315</code> <br> <br>  So the name of the suspect (or his accomplice) has become clear: Microsoft-HTTPAPI / 2.0.  The beast is new to me, unfamiliar up to this point, because it was decided to go to the world wide web for information.  Googling, questions in <a href="http://habrahabr.ru/qa/419/">Habr-Q &amp; A</a> and <a href="http://www.askdev.ru/windows/2903/%25D0%259E%25D1%2582%25D0%25BA%25D0%25BB%25D1%258E%25D1%2587%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5-Microsoft-HTTPAPI-2-0/">askdev.ru</a> in general, did not bring much benefit.  Mostly people pointed to some Reporting Services from MS SQL Server or IIS remnants in the system.  I didn‚Äôt have either one or the other (although just in case I still checked these versions with an intensive search by file names).  So the prospect loomed irrelevant - a trojan or a worm.  I spent the next few days (or rather evenings) in unsuccessful searches for ‚Äúunwanted software‚Äù with the help of various antivirus software.  There were no results.  In the distance, the specter of a complete system reinstallation loomed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the same time, the questions to the respected community were not in vain: one comrade suggested stupidly deleting the file c: \ Windows \ System32 \ httpapi.dll, since it is he who is responsible for all the iniquities.  I, of course, did not delete the library, however I took the file to note.  Having hung myself with utilities from SysInternals, I rushed into battle: <br><br> <code>C:\Windows\system32&gt;tasklist /M httpapi.dll <br> <br>   PID  <br> ========================= ======== ============================================ <br> svchost.exe 1328 HTTPAPI.dll <br> svchost.exe 2628 HTTPAPI.dll <br> svchost.exe 3856 HTTPAPI.dll</code> <br> <br>  tasklist is a standard Windows utility, in essence, a console Task Manager.  With the / M key you can see which processes use the given library.  It became clear "direct performers."  Next, by running Process Explorer from SysInternals, I found the processes with the given identifiers.  Having opened the properties dialog, on the Services tab, I saw quite a few different Windows services that were registered in these processes.  There were many services, so there was no choice - I turned off everything just to check the correctness of my guess.  Among the services were: Smart Card, BranchCache, Smart Card Removal Policy, HomeGroup Listener, SSDP Detection, Discovery Provider Host, etc. Only about 15. After the reboot, the local network refused to work (though the Internet still worked ), however, to my joy, the 80th port was freed.  After that, there was a routine: to turn on the services that had just been turned off one by one and check whether the 80th port is busy.  Here it is necessary to make a small remark: the fact that several services are registered in the process that listens to a certain port does not mean at all that all these services listen to this port.  They just turned out to be "at the wrong time, in the wrong place."  Thus, the attacker was identified quite accurately: he was the BranchCache service, which, as follows from the description: caches network content received from the caching nodes of the local subnet. <br><br>  Well, then - the matter of technology.  The BranchCache <a href="http://technet.microsoft.com/en-us/library/dd837646(WS.10).aspx">manual</a> was found in MSDN, from which it appeared that BranchCache could work in different modes: a dedicated server (a server with a Windows Server 2008 R2 machine is needed) and distributed storage (it can work on regular versions of Windows 7).  Accordingly, two things had to be done: change the port and set the operation mode as distributed storage: <br><br> <code>REG ADD "HKLM\Software\Microsoft\Windows NT\CurrentVersion\PeerDist\DownloadManager\Peers\Connection" /v ListenPort /t REG_DWORD /d 4455 /f <br> <br> REG ADD "HKLM\Software\Microsoft\Windows NT\CurrentVersion\PeerDist\DownloadManager\Peers\Connection" /v ConnectPort /t REG_DWORD /d 4455 /f <br> <br> netsh br set service mode=distributed</code> <br> <br>  After that, we switch back BranchCache and make sure that port 80 is free (port 4455 is now listening).  The combat mission was successfully completed. <br><br>  <b>UPD</b> : At the request of comrades in the comments, I inform you that BranchCache is a normal Windows service.  You can disable it by setting the Startup type: ‚ÄúDisabled‚Äù in the parameters.  By default, this service is of the ‚ÄúManual‚Äù startup type and runs on demand of applications.  So for most users, it should be disabled immediately. </div><p>Source: <a href="https://habr.com/ru/post/105020/">https://habr.com/ru/post/105020/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../105011/index.html">Neither the game ‚ÄúRoads of Rome‚Äù (‚ÄúRoads of Rome‚Äù)</a></li>
<li><a href="../105015/index.html">Overview of twitter music distribution services</a></li>
<li><a href="../105016/index.html">Running clodo.ru hosting</a></li>
<li><a href="../105018/index.html">New StartupIndex Review directory number has been released.</a></li>
<li><a href="../105019/index.html">UN appoints representative for contact with aliens</a></li>
<li><a href="../105021/index.html">Java as a language for parallel computing. Installation, configuration, first program</a></li>
<li><a href="../105022/index.html">Redis 2.0</a></li>
<li><a href="../105023/index.html">The first Lenovo brand store opened in Moscow</a></li>
<li><a href="../105024/index.html">InvoiceMall - SaaS billing service for studios and freelancers</a></li>
<li><a href="../105025/index.html">The principles of the poker bot. part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>