<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Open-source solution for declining data read latency with Apache Cassandra</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the world's largest Apache Cassandra databases is deployed on Instagram. The project began using Cassandra in 2012 in order to replace Redis an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Open-source solution for declining data read latency with Apache Cassandra</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/8h/qz/qy/8hqzqyfytcsvjn_xc9y5uj9j7ns.jpeg"><br><br>  One of the world's largest Apache Cassandra databases is deployed on Instagram.  The project began using Cassandra in 2012 in order to replace Redis and support the implementation of such application functions as Fraud Recognition, Ribbon and Direct.  At first, Cassandra clusters worked in AWS, but later engineers migrated them to the Facebook infrastructure along with all other Instagram systems.  Cassandra performed very well in terms of reliability and fault tolerance.  At the same time, the delay metrics for reading data could clearly be improved. <br><br>  Last year, the Cassandra support team at Instagram began working on a project aimed at significantly reducing the delay in reading data at Cassandra, which engineers called Rocksandra.  In this material, the author tells us that she encouraged the team to implement this project, the difficulties that had to be overcome and the performance metrics that engineers use in both internal and external cloud environments. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Grounds for the transition </h3><br>  Instagram actively and widely uses Apache Cassandra as a key-value storage service.  Most Instagram requests are online, so to provide a reliable and enjoyable user experience for hundreds of millions of Instagram users, SLAs are very demanding on system performance. <a name="habracut"></a><br><br>  Instagram has a five nines reliability rating.  This means that the number of failures at any given time cannot exceed 0.001%.  In order to improve performance, engineers actively monitor the throughput and latency of various Cassandra clusters, and make sure that 99% of all requests fit into a certain indicator (P99 delay). <br><br>  Below is a graph showing client latency for one of the Cassandra combat clusters.  Blue is the average read speed (5 ms), and orange is the 99% read speed, varying between 25-60 ms.  Its changes are highly dependent on client traffic. <br><br> <a href=""><img src="https://habrastorage.org/webt/hh/w0/qq/hhw0qq_z9ce4zqkys5m8irabeja.png"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/h3/bs/oz/h3bsoz7oxelnn-sm9xse1wcn4u4.png"></a> <br><br>  The study found that sudden surges in latency were largely due to the work of the JVM garbage collector.  Engineers introduced a metric called ‚Äúpercentage of SM stops‚Äù to measure the percentage of time it took to ‚Äústop the world‚Äù with the Cassandra server, and was accompanied by a denial of service to customer requests.  Here is a graph above showing the amount of time (in percent) that was spent on stopping the CM using the example of one of the combat servers Cassandra.  The figure ranged from 1.25% at the moments of the smallest traffic to 2.5% at peak times. <br><br>  The graph shows that this Cassandra server instance could spend 2.5% of its time collecting garbage instead of servicing customer requests.  The collector's preventive operations obviously had a significant effect on the P99 delay, and therefore it became clear that if we could reduce the CM stopping rate, then the engineers could significantly reduce the P99 delay indicator. <br><br><h3>  Decision </h3><br>  Apache Cassandra is a Java-based distributed database, with its own data storage engine based on LSM trees.  Engineers found that such engine components as a memory table, a compression tool, read / write paths, and some others created many objects in Java dynamic memory, which caused the JVM to perform a lot of additional utility operations.  To reduce the impact of storage mechanisms on the work of the garbage collector, the support team considered various approaches and ultimately decided to develop a C ++ engine and replace the existing counterpart with it. <br><br>  Engineers did not want to do everything from scratch, and therefore decided to take RocksDB as a basis. <br><br>  RocksDB is a high-performance, open source embedded database for storing key-value type.  It is written in C ++, and its API has official language bindings for C ++, C, and Java.  RocksDB is optimized for high performance, especially on fast drives such as SSDs.  It is widely used in the industry as a storage engine for MySQL, mongoDB, and other popular databases. <br><br><h3>  Difficulties </h3><br>  In the process of implementing the new storage engine on RocksDB, engineers faced three difficult tasks and solved them. <br><br>  The first difficulty was that Cassandra still lacks an architecture that allows connecting third-party data handlers.  This means that the work of the existing engine is closely interconnected with other components of the database.  To find a balance between large-scale refactoring and fast iterations, engineers identified the API of the new engine, including the most common interfaces for reading, writing, and streams.  Thus, the support team was able to implement new data processing mechanisms behind the API and insert them into the appropriate code execution paths inside Cassandra. <br><br>  The second difficulty was that Cassandra supports structured data types and table diagrams, while RocksDB provides only key-value interfaces.  Engineers carefully defined the encoding and decoding algorithms to support the Cassandra data model within the framework of the RocksDB data structures and ensured the continuity of the semantics of similar queries between the two databases. <br><br>  The third difficulty was associated with such an important component for any distributed database as working with data streams.  Whenever a node is added or removed from a Cassandra cluster, it needs to properly distribute data between different nodes for load balancing within the cluster.  Existing implementations of these mechanisms were based on obtaining detailed data from the existing database engine.  Therefore, engineers had to separate them from each other, create an abstraction layer, and implement a new stream processing option using the RocksDB API.  To obtain high bandwidth of streams, the support team now first distributes data to temporary sst files, and then uses a special API RocksDB to ‚Äúswallow‚Äù the files, allowing them to mass-download simultaneously to the RocksDB instance. <br><br><h3>  Performance indicators </h3><br>  After almost a year of development and testing, the engineers completed the first version of the implementation and successfully ‚Äúrolled out‚Äù it on several combat Instagram Cassandra clusters.  On one of the battle clusters, the P99 delay dropped from 60 ms to 20 ms.  Observations also showed that the SM stops in this cluster fell from 2.5% to 0.3%, that is, almost 10 times! <br><br>  Engineers also wanted to see if Rocksandra could do well in a public cloud environment.  The support team set up a Cassandra cluster in the AWS environment using three i3.8 xlarge EC2 instances, each with a 32-core processor, 244 GB of RAM, and a zero raid of four NVMe flash drives. <br><br>  For comparative tests, we used <a href="https://github.com/Netflix/ndbench">NDBench</a> , and the default for the framework scheme of the table. <br><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> emp ( emp_uname <span class="hljs-type"><span class="hljs-type">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span>, emp_dept <span class="hljs-type"><span class="hljs-type">text</span></span>, emp_first <span class="hljs-type"><span class="hljs-type">text</span></span>, emp_last <span class="hljs-type"><span class="hljs-type">text</span></span> )</code> </pre> <br>  Engineers have pre-loaded 250 million 6 rows of 6 KB each (each server has about 500 GB of data).  Next, set up 128 readers and writers in NDBench. <br><br>  The support team tested various loads and measured average / P99 / P999 read and write delays.  The graphs below show that Rocksandra showed significantly lower and more stable read and write latency. <br><br><img src="https://habrastorage.org/webt/sc/7j/im/sc7jim4homfpkase00fbjixjhyq.png"><br><br><img src="https://habrastorage.org/webt/z1/ol/pw/z1olpwd4z6q-bp-kihfcf58j9bo.png"><br><br>  Engineers also tested the load in read mode without writing and found that with the same P99 read delay (2 ms), Rocksandra is able to provide more than a 10-fold increase in information reading speed (300 K / s for Rocksandra against 30 K / s for C * 3.0). <br><br><img src="https://habrastorage.org/webt/jn/sy/fu/jnsyfumtlax15y1p0tkkalrc_f4.png"><br><br><img src="https://habrastorage.org/webt/iv/js/fs/ivjsfsiexo3bzmuklo_ughr0tju.png"><br><br><h3>  Future plans </h3><br>  The Instagram support team has <a href="">unlocked the Rocksandra</a> code and <a href="">performance</a> <a href="https://github.com/Instagram/cassandra-aws-benchmark">framework</a> .  You can download them from Github and try them in your own environment.  Be sure to tell us what happened! <br><br>  As a next step, the team is actively working to add broader support for C * functionality, such as secondary indexes, repair, and more.  And besides, engineers are developing the <a href="https://issues.apache.org/jira/browse/CASSANDRA-13474">architecture of the connected database engine in C *</a> , in order to further transfer these developments to the Apache Cassandra community. <br><br> <a href="https://wirexapp.com/ru/"><img src="https://habrastorage.org/files/4bd/bf6/597/4bdbf659775744b1bdbb4d8a00a0a980.png" alt="image"></a> </div><p>Source: <a href="https://habr.com/ru/post/410985/">https://habr.com/ru/post/410985/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../410973/index.html">What drones are used in world cinema</a></li>
<li><a href="../410977/index.html">Attempt to create a universal input device</a></li>
<li><a href="../410979/index.html">"Breaking" the brain with the help of "pictures-contradictions"</a></li>
<li><a href="../410981/index.html">Yandex has added crypto miner protection to its browser</a></li>
<li><a href="../410983/index.html">FREE SPACE DESTROYERS STARS</a></li>
<li><a href="../410987/index.html">GLONASS will be made as accurate as the GPS navigation system.</a></li>
<li><a href="../410989/index.html">The predecessors of fitness bracelets: pedometer, heart rate monitor, bike computer</a></li>
<li><a href="../410991/index.html">Ledger's hardware cryptocurrency wallet was hacked by a 15-year-old hacker</a></li>
<li><a href="../410993/index.html">Someone sends sex toys from Amazon to strangers. Amazon doesn't know how to stop them.</a></li>
<li><a href="../410995/index.html">Telegram complained of Russia to the European Court of Human Rights</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>