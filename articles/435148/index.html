<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Own bash DHCP server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I like to automate the process and write my own bikes to study this or that material. My new goal was a DHCP server that will issue an address in smal...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Own bash DHCP server</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/cy/g3/b8/cyg3b8lmcpgxrj7j7_1jbfkxfta.png" align="left">  I like to automate the process and write my own bikes to study this or that material.  My new goal was a DHCP server that will issue an address in small networks so that you can make initial hardware configuration. <br><br>  In this article I will tell you a little about the DHCP protocol and some subtleties from bash. <br><a name="habracut"></a><br><br><br><h1>  Final result </h1><br>  Let's start from the end, so that it is clear what we are fighting for. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Demonstration of work: <br><br><img src="https://habrastorage.org/webt/co/za/6j/coza6jzioblfbafujqfcanrffco.gif"><br><br>  <a href="https://github.com/Firemoon777/bash-dhcp-server/">Script</a> repository: <a href="https://github.com/Firemoon777/bash-dhcp-server/">firemoon777 / bash-dhcp-server</a> <br><br><h1>  Initial problem </h1><br>  The setup I need is done this way: we connect directly over the twisted pair to the equipment, issue a temporary address via DHCP, configure the already created script.  And so ten to twenty times in a row. <br><br>  Many well-known isc-dhcp-server copes with its duties perfectly, but, alas, it does not notify my script that the address has been issued, so you need to somehow block the execution until the address has been issued. <br><br>  The solution, like, on the surface: ping until blue in the face, until the equipment responds: <br><br><pre><code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ! ping -c1 -W1 <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DHCP</span></span></span><span class="hljs-string">"</span></span> | grep -q <span class="hljs-string"><span class="hljs-string">"time="</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Waiting for </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DHCP</span></span></span><span class="hljs-string">..."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br>  But in this decision, definitely, there is not enough adventurism. <br><br><h1>  Theoretical part </h1><br><h3>  Getting an address with one DHCP server </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1t/5q/u9/1t5qu9ltl-tjqlkmc7egjfgjvpe.png"></div><br>  The DHCP protocol works over UDP on ports 67 and 68. The server always works only on 67, and the client only on 68. Since the client does not have an address (has the address 0.0.0.0), the DHCP packets are sent in a broadcast manner.  Those.  The client always sends packets to the address 255.255.255.255:67 from the address 0.0.0.0:68, and the server sends from its address: 67 to the address 255.255.255.255:68. <br><br>  The client <b>receives the</b> address in four packets ( <b>DORA</b> ): <br><br><ol><li>  The client finds out where the DHCP server is here ( <b>D</b> iscover) </li><li>  The server responds and offers its address ( <b>O</b> ffer) </li><li>  The client requests the proposed address from a specific server ( <b>R</b> equest) </li><li>  The server agrees and issues an address ( <b>A</b> ck) </li></ol><br>  Visually, the scheme can be represented as follows: <br><br><img src="https://habrastorage.org/webt/j5/ug/zy/j5ugzyefd8qvd-wrcsjtdahmnbs.png"><br><br><h3>  Getting an address with multiple DHCP servers </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/28/uo/fc/28uofcx-gthwmwhs8sgz0jrdysk.png"></div><br>  When a client sends Discover, all servers that can hear will send their Offer to the client.  But the customer must choose someone one.  Client selection is announced in the Request message by option 54 (DHCP server), which contains the IP address of the preferred DHCP server.  Although the Request is sent to everyone else on the network, only the DHCP server whose IP is specified in option 54 responds. <br><br><img src="https://habrastorage.org/webt/ke/xi/rv/kexirvjfnljlm3pdhcpfqglh02a.png"><br><br><h3>  DHCP Package Contents </h3><br>  A DHCP packet consists of two parts: a constant, 236 bytes in size, and a variable that carries options (DHCP Option). <br><br><div class="spoiler">  <b class="spoiler_title">A table with all the fields of a DHCP packet from Wikipedia</b> <div class="spoiler_text"><table><tbody><tr><th>  Field </th><th>  Description </th><th>  Length (in bytes) </th></tr><tr><td>  <b>op</b> <br></td><td>  Message type  For example, the values ‚Äã‚Äãcan be: BOOTREQUEST (0x01, request from client to server) and BOOTREPLY (0x02, response from server to client). <br></td><td>  one <br></td></tr><tr><td>  <b>htype</b> <br></td><td>  Type of hardware address.  Valid values ‚Äã‚Äãfor this field are defined in RFC 1700 "Assigned Numbers".  For example, for an Ethernet MAC address, this field is 0x01. <br></td><td>  one <br></td></tr><tr><td>  <b>hlen</b> <br></td><td>  The length of the hardware address in bytes.  For the Ethernet MAC address ‚Äî 0x06. <br></td><td>  one <br></td></tr><tr><td>  <b>hops</b> <br></td><td>  The number of intermediate routers (called <i>DHCP relay agents</i> ) that the message went through.  The client sets this field to 0x00. <br></td><td>  one <br></td></tr><tr><td>  <b>xid</b> <br></td><td>  A unique 4-byte transaction identifier generated by the client at the beginning of the address acquisition process. <br></td><td>  four <br></td></tr><tr><td>  <b>secs</b> <br></td><td>  The time in seconds since the beginning of the process of obtaining the address.  May not be used (in this case it is set to 0x0000). <br></td><td>  2 <br></td></tr><tr><td>  <b>flags</b> <br></td><td>  Field for flags - special parameters of the DHCP protocol. <br></td><td>  2 <br></td></tr><tr><td>  <b>ciaddr</b> <br></td><td>  The IP address of the client.  Filled only if the client already has its own IP address and is able to respond to ARP requests (this is possible if the client performs the address renewal procedure at the end of the lease period). <br></td><td>  four <br></td></tr><tr><td>  <b>yiaddr</b> <br></td><td>  The new client IP address offered by the server. <br></td><td>  four <br></td></tr><tr><td>  <b>siaddr</b> <br></td><td>  IP address of the server.  Returned in the DHCP offer (see below). <br></td><td>  four <br></td></tr><tr><td>  <b>giaddr</b> <br></td><td>  The IP address of the relay agent, if one was involved in the delivery of the DHCP message to the server. <br></td><td>  four <br></td></tr><tr><td>  <b>chaddr</b> <br></td><td>  The hardware address (usually the MAC address) of the client. <br></td><td>  sixteen <br></td></tr><tr><td>  <b>sname</b> <br></td><td>  Optional server name as a null-terminated string. <br></td><td>  64 <br></td></tr><tr><td>  <b>file</b> <br></td><td>  Optional file name on the server used by diskless workstations for remote boot.  Like <b>sname</b> , is represented as a null-terminated string. <br></td><td>  128 <br></td></tr><tr><td>  <b>options</b> <br></td><td>  <i>DHCP options</i> field.  Various advanced configuration options are listed here.  At the beginning of this field, four special bytes are specified with the values ‚Äã‚Äã99, 130, 83, 99 (‚Äúmagic numbers‚Äù), allowing the server to determine the presence of this field.  The field has a variable length, but the DHCP client must be ready to accept a DHCP message of 576 bytes in length (in this message, the <b>options</b> field is 340 bytes long). <br></td><td>  variable <br></td></tr></tbody></table><br></div></div><br>  <a href="https://www.iana.org/assignments/bootp-dhcp-parameters/bootp-dhcp-parameters.xhtml">List of all DHCP options in RFC 2132</a> <br><br>  DHCP options are encoded as follows: <br><table><tbody><tr><td>  room </td><td>  Length </td><td>  Data </td></tr></tbody></table><br>  For example, parameter 3 (proposed gateway) with a value of 10.0.0.1: <br><table><tbody><tr><td>  3 </td><td>  four </td><td>  ten </td><td>  0 </td><td>  0 </td><td>  one </td></tr></tbody></table><br>  In case you need to pass several parameters, the parameter length increases. <br>  For example, in parameter 6 (DNS server), we will transmit two addresses (1.1.1.1 and 8.8.4.4): <br><table><tbody><tr><td>  6 </td><td>  eight </td><td>  one </td><td>  one </td><td>  one </td><td>  one </td><td>  eight </td><td>  eight </td><td>  four </td><td>  four </td></tr></tbody></table><br>  A sign of the end of the options field is the parameter with the number 255 (0xFF) and a length of 0. <br><br>  Most often, the client submits parameter 55 (the list of parameters that he wants to receive in response) in DHCP Discover, however, we have the right to give him not everything he asked for. <br><br><h1>  Practical part </h1><br>  It was originally planned to write a server in some more suitable language for this (C), however, it would be simple and simple.  How it is to write a script that will take over the functions of the dhcp-server. <br><br><h3>  Simplify </h3><br>  Since the server being developed was supposed to be used in networks of two nodes connected by a patch, the following simplifications were adopted: <br><br><ul><li>  it is guaranteed that one client is online; </li><li>  it is guaranteed that there are no more dhcp servers in the network </li><li>  the trigger decides which address to issue </li><li>  DHCP Release and DHCP Decline are ignored. </li></ul><br><h3>  Listener </h3><br>  First you need to learn how to take packets.  This requires a <strike>certified sympathetic</strike> listener, for example, nc.  But not every nc is suitable for these purposes.  OpenBSD netcat 1.130 from debian is suitable, but 1.105 with Ubuntu is gone.  Run nc to listen to all UDP packets arriving on port 67. <br><br><pre> <code class="bash hljs">nc -l 0.0.0.0 -up 67 -w0</code> </pre><br>  OpenBSD netcat is also needed because of the -w key with a value of 0. After receiving one packet (UDP Broadcast), the traditional nc does not accept more packets, but it does not end either. <br><br><h3>  Work with raw bytes </h3><br>  In the command interpreter, it is very difficult to work with non-printable characters, for example, with a null character: it simply ignores it.  And the DHCP packet contains many bytes 0x00 (for example, the file field).  The solution to the problem comes in the form of hex-dump: <br><br><pre> <code class="bash hljs"> nc -l 0.0.0.0 -up 67 -w0 | stdbuf -o0 od -v -w1 -t x1 -An</code> </pre><br>  One byte per line, without displaying the address, not missing duplicate bytes.  You can also spice up stdbuf -o0 so that the output is not buffered. <br><br><h3>  Receiving, storing and processing packages </h3><br>  From stdout, the od command is retrieved by the read command and added to the array. <br><br><pre> <code class="bash hljs">msg=() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> {0..235}; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> -r tmp msg[<span class="hljs-variable"><span class="hljs-variable">$i</span></span>]=<span class="hljs-variable"><span class="hljs-variable">$tmp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  Although all values ‚Äã‚Äãare transmitted in hexadecimal notation, the DHCP Option number and the option length are best displayed on the screen / logs in the usual decimal form.  To do this, you can use a brief bash entry: <br><br><pre> <code class="bash hljs">$ op=AC $ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> $((16<span class="hljs-comment"><span class="hljs-comment">#$op)) 172</span></span></code> </pre><br>  The received packet is edited according to the type of request (Discover or Request) and sent back. <br><br><h3>  Send reply </h3><br>  However, sending a package is not such an easy task.  First you need to convert the bytes from the dump into the raw bytes and send all at once in one packet. <br><br>  The conversion can be done using the printf utility with the help of escape sequences.  And so that nothing is lost, write the bytes immediately to the file. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   &gt;/tmp/dhcp.payload #     for i in ${msg[*]}; do printf "\x$i" &gt;&gt; /tmp/dhcp.payload done</span></span></code> </pre><br>  OpenBSD netcat is also used for sending.  However, if version 1.105 with Ubuntu is suitable as a listener, then here it is not suitable for broadcasting UDP messages: we get a protocol not available error. <br><br><pre> <code class="bash hljs">cat /tmp/dhcp.payload | nc -ub 255.255.255.255 68 -s <span class="hljs-variable"><span class="hljs-variable">$SERVER</span></span> -p 67 -w0</code> </pre><br>  The -b switch allows sending broadcast messages, and this is the second reason why the server should be started from under the superuser. <br><br><h1>  What is there with restrictions? </h1><br>  This DHCP server was developed with simplifications like a single client on the network.  However, it will work with multiple clients.  Just get the fastest address. <br><br><img src="https://habrastorage.org/webt/yq/45/5f/yq455faeeblrxvyhtp9zeffiktg.png"><br><br><h1>  Conclusion </h1><br>  Although bash scripts can hardly be called a full-fledged programming language, nevertheless, with the proper desire, you can even solve such tasks as issuing an IP address on a network without using specially designed software.  And the solution of specific tasks not only brings joy, but also new knowledge that was discovered at the moment of the solution. <br><br><h1>  Sources </h1><br><ol><li>  <a href="https://ru.wikipedia.org/wiki/DHCP">DHCP - Wikipedia</a> </li><li>  <a href="https://www.iana.org/assignments/bootp-dhcp-parameters/bootp-dhcp-parameters.xhtml">DHCP and BOOTP Parameters - IANA</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/435148/">https://habr.com/ru/post/435148/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../435134/index.html">Simplify working with databases in Qt using QSqlRelationalTableModel</a></li>
<li><a href="../435136/index.html">Sergey and the scientific method</a></li>
<li><a href="../435138/index.html">How to take control of network infrastructure. Part Three Network security</a></li>
<li><a href="../435142/index.html">Examining Tracing with eBPF: Guide and Examples</a></li>
<li><a href="../435144/index.html">Introduction to Spring Boot: Creating a Simple Java REST API</a></li>
<li><a href="../435150/index.html">Clinical trials on the threshold - an interview with Aubrey de Gray</a></li>
<li><a href="../435152/index.html">Apple and Qualcomm patent dispute led to a halt in sales of iPhone 7 and 8 in Germany</a></li>
<li><a href="../435154/index.html">Memoirs of the subhuman robot, chapters 9-12</a></li>
<li><a href="../435156/index.html">Need more cameras: Nokia 9 has 5 at once.</a></li>
<li><a href="../435160/index.html">Internet of things in Russian. Spectral parameters of the radio signal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>