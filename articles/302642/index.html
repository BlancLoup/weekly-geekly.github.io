<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to raise CI for iOS developers in a day. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. This is a continuation of an article about how the Live Typing iOS department introduced CI methodology and deployed a server to automate assem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to raise CI for iOS developers in a day. Part 2</h1><div class="post__text post__text-html js-mediator-article">  Hello.  This is a continuation of an <a href="https://habrahabr.ru/company/livetyping/blog/302128/">article</a> about how the <a href="http://livetyping.com/">Live Typing</a> iOS department introduced CI methodology and deployed a server to automate assemblies on Jenkins.  As we promised, the second part is devoted to how to get the basic code metrics, archive the project in .ipa, and set up interaction with Slack. <br><a name="habracut"></a><br><h3>  1. Installing all the necessary programs and plug-ins. </h3><br>  To begin with, we will install programs that will collect statistics for us: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#     brew install gcovr #   brew install cloc #  ,   brew install sloccount #   brew install pmd #     (    oclint) sudo gem install xcpretty #   brew tap oclint/formulae brew install oclint</span></span></code> </pre> <br>  Next, we need to install plugins for Jenkins, which will display the statistics in a readable form: <br><ol><li>  <a href="https://wiki.jenkins-ci.org/display/JENKINS/PMD%2BPlugin">PMD Plug-in</a> - generation of a report on the statistical complexity of the code; </li><li>  <a href="https://wiki.jenkins-ci.org/display/JENKINS/SLOCCount%2BPlugin">SLOCCount Plug-in</a> - generation of a report on the number of lines of code; </li><li>  <a href="https://wiki.jenkins-ci.org/display/JENKINS/Test%2BResults%2BAnalyzer%2BPlugin">Test Results Analyzer Plugin</a> - generating a report on test results; </li><li>  <a href="https://wiki.jenkins-ci.org/display/JENKINS/Cobertura%2BPlugin">Cobertura Plugin</a> - generating a report on code coverage with tests; </li><li>  <a href="https://wiki.jenkins-ci.org/display/JENKINS/DRY%2BPlugin">DRY Plug-in</a> - generating a code duplication report. </li></ol><br>  Also install auxiliary plugins: <br><ol><li>  <a href="https://wiki.jenkins-ci.org/display/JENKINS/EnvInject%2BPlugin">Environment Injector Plugin</a> - the introduction of variables in the project; </li><li>  <a href="https://wiki.jenkins-ci.org/display/JENKINS/pre-scm-buildstep">Pre SCM BuildStep Plugin</a> - implementing variables before starting the job; </li><li>  <a href="https://wiki.jenkins-ci.org/display/JENKINS/Build%2BToken%2BRoot%2BPlugin">Build Authorization Token Root Plugin</a> - launching a job with a get-request with a token; </li><li>  <a href="https://wiki.jenkins-ci.org/display/JENKINS/Parameterized%2BTrigger%2BPlugin">Parameterized Trigger plugin</a> - allows you to run jobs with parameters at the end of the build; </li><li>  <a href="https://wiki.jenkins-ci.org/display/JENKINS/Slack%2BPlugin">Slack Notification Plugin</a> - sending messages to the Slack team chat; </li><li>  <a href="https://wiki.jenkins-ci.org/display/JENKINS/Publish%2BOver%2BSSH%2BPlugin">Publish Over SSH</a> - this plugin is listed here as an example.  It will suit you if you, like us, send data via SFTP to the server. </li></ol><br><h3>  2. Integration with Slack chat </h3><br>  To receive notifications about the build status in the Slack team chat, we need to add the appropriate integration with Jenkins in the Slack settings.  This can be done <a href="https://slack.com/apps/A0F7VRFKN-jenkins-ci">here</a> . <br>  After creating the integration, a unique token will be generated, which must be added to the Jenkins settings (or to the settings of a separate job) - as in the example in the screenshot: <br><br><img src="https://habrastorage.org/files/727/eff/e5a/727effe5a4e74ccf9bb0c894ecb17d5f.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Next, we configure the launch of assemblies using the built-in command mechanism in Slack.  First we need to add integration.  To do this, go to the Slash commands subsection in the Custom Integrations section and click on the Add configurations button.  This operation can be performed <a href="https://slack.com/apps/A0F82E8CA-slash-commands">here</a> . <br>  When setting up, you need to specify the name of your team, select the POST data transfer method and specify the URL to which the request will go. <br><br><img src="https://habrastorage.org/files/f8f/1e2/f8a/f8f1e2f8a60b4cf5a7c6af04da6156f4.png"><br><br>  Consider an example of the formation of the URL for the request in more detail.  Our URL for example looks like this: <br><br> <code>http://server:8080/buildByToken/buildWithParameters?job=JenkinsExecutor&amp;token=XXXXXXXXXXXXXXXXX <br></code> <br>  Let's sort it out by components: <br><ol><li>  server is the external address of your server.  If necessary, here we also indicate the required port (in our case, 8080); </li><li>  buildByToken is an opportunity provided by the Build Authorization Token Root Plugin plugin.  Allows you to run a job by reference with a token (in our case, XXXXXXXXXXXXXXXXXX); </li><li>  buildWithParameters - indicates that you need to run a parameterized build; </li><li>  JenkinsExecutor is the name of the job, which we will create and use to run other jobs.  It will be discussed below; </li><li>  XXXXXXXXXXXXXXXXX is the value of the token, which is set in the settings of the plugin in the configuration of each individual job. </li></ol><br>  As an example, we will use the following command structure: <br><br> <code>/build Example test master <br></code> <br><ol><li>  / build is the name of our team; </li><li>  Example - job'a name; </li><li>  test - an auxiliary flag associated with running tests and creating reports with metrics; </li><li>  master is the build branch. </li></ol><br>  The considered configuration will allow us to run the assembly of any project with an indication of the desired branch, and a single command will be used: / build. <br><br><h3>  3. Configuration auxiliary job'a - JenkinsExecutor </h3><br>  We will need this job in order to run other jobs.  It will also be able to handle errors if the user entered a non-existing project, and add information about the command (kind of help). <br>  We go to the server and create a new task with a free configuration and the name JenkinsExecutor.  Next, in the settings of the job, we set a flag indicating that the assembly is parameterized and accepts the text parameter.  When running a command in Slack, all the data (Example master test) will be passed in a single line in the text variable. <br><br><img src="https://habrastorage.org/files/942/e95/1ff/942e951ff8b64056bd634f3c9f45e3f1.png"><br><br>  Next, set the flag responsible for running the assembly remotely.  Here you need to specify a token that is identical to the one we set in the settings of the command in Slack: <br><br><img src="https://habrastorage.org/files/41e/75c/a2d/41e75ca2db7f43fe96fd9002498b6939.png"><br><br>  Now we need to extract the values ‚Äã‚Äãfrom the text variable.  To do this, go to the "Assembly" section and add the "execute the shell command" assembly step.  Command example: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    ,   IFS=' ' read -a array &lt;&lt;&lt; "$text" #  ,   ‚Äî    JOB_NAME=${array[0]} #,    TEST=${array[1]} #   BRANCH=${array[2]} # ,     : USER_NAME=${user_name} CHANNEL_NAME=${channel_name}</span></span></code> </pre><br>  To start the build with the parameters, send a POST request to execute a specific job.  To do this, add the following line to the previous shell command: <br><br><pre> <code class="bash hljs">curl -d TEST=<span class="hljs-variable"><span class="hljs-variable">${TEST}</span></span> -d BRANCH=<span class="hljs-variable"><span class="hljs-variable">${BRANCH}</span></span> -X POST \ -u username:password http://127.0.0.1:8080/job/<span class="hljs-variable"><span class="hljs-variable">${JOB_NAME}</span></span>/buildWithParameters</code> </pre><br>  Here, password is the API key of the user username (the user must have rights to run jobs). <br>  To get the key: <br><ol><li>  Click on the username in the upper right corner of the Jenkins web interface; </li><li>  Click on the "Customize" button on the left side of the screen; </li><li>  Click on Show API Key - the key we are looking for. </li></ol><br>  Please note that all running assemblies must be parameterized! <br><br><h3>  4. Build setup </h3><br>  4.1.  The first thing you should pay attention to when setting up a job is that the assembly must be parameterized.  To do this, set the appropriate flag, add the text parameters BRANCH and TEST and set the default parameters for them: <br><img src="https://habrastorage.org/files/fd3/19f/de3/fd319fde34f34224988a785f0e34a7ed.png"><br><br>  Here it is worth noting that for the BRANCH variable, you must additionally add a default value.  The fact is that if you run an assembly from Slack without specifying a branch, then the BRANCH variable will have an empty value and, accordingly, there will be an error.  To do this, we will add the Run buildstep before SCM runs flag in the ‚ÄúBuild Environment‚Äù section.  Then add the step ‚Äúexecute the shell command‚Äù and the step inject environment variables.  We do the following: <br><br><img src="https://habrastorage.org/files/9b0/741/4c6/9b07414c61ce4b0a91fdbf7a8f0156cc.png"><br><br>  4.2.  Configuring interaction with GitLab. <br>  Specify the address of the project repository.  Specify the assembly branch (in our case it is the BRANCH variable). <br><br><img src="https://habrastorage.org/files/54a/b8f/bdf/54ab8fbdf6684a8e8a00cc76b0f835fc.png"><br><br>  4.3.  Customize the assembly for the web hook. <br>  In the triggers of the assembly set the flag "Build on push in GitLab".  Add the necessary parameters and specify the branch for which the trigger will work: <br><br><img src="https://habrastorage.org/files/420/4e5/cfe/4204e5cfec884db3b6f2eeecfcd35b48.png"><br><br>  Then in the project settings on GitLab in the category Web hooks add a web hook to the Jenkins server: <br><br><img src="https://habrastorage.org/files/bd1/6da/f87/bd16daf8760c47d796f3136c0d05f321.png"><br><br>  4.4.  The build phase begins with the execution of a shell command that installs Pods, if the file has been updated: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ $(( $(date +<span class="hljs-string"><span class="hljs-string">"%s"</span></span>) - $(<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span> -f %m Podfile) )) -le 60 ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> pod install <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre><br>  Then, for convenience, set some variables for the project and write them to a file: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># .ipa- PROJECT_NAME="Example" #  .xcworkspace WORKSPACE_NAME="Example" #   SCHEME_NAME="Example" #   .        FOLDER_NAME_WITH_CODE="Example" #   ,       echo PROJECT_NAME=$PROJECT_NAME &gt; build.properties echo WORKSPACE_NAME=$WORKSPACE_NAME &gt;&gt; build.properties echo SCHEME_NAME=$SCHEME_NAME &gt;&gt; build.properties</span></span></code> </pre><br><br>  Depending on the set TEST parameter, we start or skip the testing phase and generate reports.  An example of what this might look like: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TEST</span></span></span><span class="hljs-string">"</span></span> == <span class="hljs-string"><span class="hljs-string">"test"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-comment"><span class="hljs-comment">#  reports,       if [ ! -d "reports" ]; then mkdir "reports" fi #      xcodebuild -workspace ${WORKSPACE_NAME}.xcworkspace \ -scheme ${SCHEME_NAME} \ -configuration Debug \ -sdk iphonesimulator \ -destination 'platform=iOS Simulator,name=iPhone 6' \ -IDECustomDerivedDataLocation="build_ccov" \ GCC_GENERATE_TEST_COVERAGE_FILES=YES \ GCC_INSTRUMENT_PROGRAM_FLOW_ARCS=YES \ clean test | xcpretty -r junit -o reports/junit.xml -r json-compilation-database -o compile_commands.json #Publish JUNIT test = **/reports/junit.xml #    oclint-json-compilation-database -v -e Pods -- \ -rc=LONG_LINE=200 \ -rc=NCSS_METHOD=60 \ -rc=LONG_METHOD=100 \ -rc=MINIMUM_CASES_IN_SWITCH=1 \ -report-type pmd \ -o reports/oclint.xml \ -max-priority-1 1000 \ -max-priority-2 1000 \ -max-priority-3 1000 #Publish PMD analysis = **/reports/oclint.xml #    gcovr --object-directory="build_ccov/${SCHEME_NAME}/Build/Intermediates/${SCHEME_NAME}.build/"\ "Debug-iphonesimulator/${SCHEME_NAME}.build/Objects-normal/x86_64/" \ --xml \ --print-summary \ --exclude '.*Tests.*' \ --exclude '.*Libs.*' \ --exclude '.*ExternalFrameworks.*' \ --exclude '.*Platforms.*' \ --output=reports/coverage.xml #Publish Cobertura Coverage = **/reports/coverage.xml #   ( ): cloc ${WORKSPACE}/${FOLDER_NAME_WITH_CODE} -by-file -skip-uniqueness -xml -out=${WORKSPACE}/reports/cloc.xml #Publish SLOCCount analysis = **/reports/cloc.xml sloccount --duplicates --wide --details ${WORKSPACE}/${FOLDER_NAME_WITH_CODE} -v &gt; reports/sloccount.sc #Publish SLOCCount analysis = **/reports/sloccount.sc #   pmd cpd --files ${WORKSPACE}/${FOLDER_NAME_WITH_CODE} \ --minimum-tokens 10 --language objectivec \ --encoding UTF-8 \ --format net.sourceforge.pmd.cpd.XMLRenderer | iconv -f macRoman -t utf-8 | sed 's/MacRoman/UTF-8/g' &gt; reports/duplicated-code.xml #Publish duplicate code = **/reports/duplicated-code.xml else touch reports/junit.xml #  ,      -    Publish JUNIT test result report fi</span></span></code> </pre><br>  Detailed information on the command syntax is available on the corresponding documentation pages: <br><ol><li>  <a href="http://docs.oclint.org/en/stable/manual/oclint.html">Oclint</a> </li><li>  <a href="http://gcovr.com/guide.html">Gcovr</a> </li><li>  <a href="http://cloc.sourceforge.net/">CLOC</a> </li><li>  <a href="http://www.dwheeler.com/sloccount/sloccount.htm">SLOCount</a> </li><li>  <a href="https://pmd.github.io/pmd-5.4.1/usage/cpd-usage.html">PMD (CPD)</a> </li><li>  <a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man1/xcodebuild.1.html">Xcode build</a> </li></ol><br>  4.5.  Recorded variables need to be embedded in the build process.  To do this, add the assembly step Inject environment variables and specify the desired path: <br><img src="https://habrastorage.org/files/ddd/398/1cd/ddd3981cd153431f9f1464bbb94451d6.png"><br><br>  4.6.  The next step is creating the assembly and archiving into an .ipa file.  To do this, use the Xcode plugin.  We do the following: <br><br><img src="https://habrastorage.org/files/058/d3e/85a/058d3e85aa91477a891e6211ada229ea.png"><br><img src="https://habrastorage.org/files/985/79a/4bf/98579a4bfc894ba5b5dcb56f21ef8666.png"><br><br>  4.7.  The last step is to add post assembly operations. <br>  We generated files for five reports, and now we need to transfer these files to the appropriate plugins: <br><ol><li>  Publish PMD analysis results = ** / reports / oclint.xml </li><li>  Publish duplicate code analysis results = ** / reports / duplicated-code.xml </li><li>  Publish Cobertura Coverage analysis results = ** / reports / coverage.xml </li><li>  Publish SLOCCount analysis results = depending on the module used: <br><ol><li>  ** / reports / cloc.xml </li><li>  ** / reports / sloccount.sc </li></ol></li><li>  Publish JUNIT test result report = ** / reports / junit.xml ( <i>Note</i> : In the advanced settings of the plug-in, you must set the flag do not have the build status, if it was started without running the tests ) </li></ol><br>  At this stage, we can send the received in the case of success .ipa-file to where we need (to the server, by e-mail, etc.).  If you want to send files to the server via SFTP and you use the Publish Over SSH plugin, you need to go to the Build Environment section, set the flag for send files or execute commands over SSH after the build runs and configure the plugin to suit your requirements. <br><br>  The last step we need to add is Slack Notification, which, you guessed it, sends notifications to Slack.  In the advanced settings of the plugin, you can specify individual settings for the current job.  It is worth noting that as a message you can specify a variable (example: $ MESSAGE), the value of which is changed at different stages of the assembly and thereby send more informative messages to Slack. <br><br>  At this point, CI implementation can be considered complete.  We hope that our article will be useful for you, and we ask you to share your questions, thoughts and comments in the comments. </div><p>Source: <a href="https://habr.com/ru/post/302642/">https://habr.com/ru/post/302642/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302628/index.html">A bit about the Stream API (Java 8)</a></li>
<li><a href="../302630/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ214 (May 30 - June 5, 2016)</a></li>
<li><a href="../302632/index.html">Digest of grocery design, May 2016</a></li>
<li><a href="../302634/index.html">Simultaneously Mounting Encrypted Folders in Synology DSM</a></li>
<li><a href="../302638/index.html">Fountain codes</a></li>
<li><a href="../302644/index.html">Hacking VKontakte: data stolen 171 million users</a></li>
<li><a href="../302646/index.html">Why Gorodor can be useful to you if you already have an RA or media?</a></li>
<li><a href="../302648/index.html">Aytreker in the service of a presentation consultant</a></li>
<li><a href="../302650/index.html">Inertial sensors: cooking recipes for positioning systems</a></li>
<li><a href="../302652/index.html">Adventure Jam 2016</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>