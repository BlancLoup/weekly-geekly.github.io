<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dofoil Hunt with Windows Defender ATP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In March 2018, hundreds of thousands of computers were attacked by Dofoil crypto miner . In previous blog posts, we looked at how we managed to shield...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dofoil Hunt with Windows Defender ATP</h1><div class="post__text post__text-html js-mediator-article">  In March 2018, hundreds of thousands of computers were attacked by <a href="https://habrahabr.ru/company/microsoft/blog/351356/">Dofoil crypto miner</a> .  In previous blog posts, we looked at how we managed to shield users from this massive attack.  We also managed to track the origins of the attack until the <a href="https://habrahabr.ru/company/microsoft/blog/351692/">infection of the software update service</a> that was used by the attackers to spread the malware. <br><br>  In this publication, we will examine in detail the methods of countering the launch in debugging and analysis mode, which the Dofoil authors resorted to, and describe how the ability of Windows 10 to detect malware can be useful in investigating such attacks. <br><br><img src="https://habrastorage.org/webt/nr/pc/z3/nrpcz3t2l-ffoqa6vhajgjv0zim.jpeg"><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the course of the investigation, we found out that methods of countering the analysis were built into the Dofoil virus.  It checks in which environment it is located and stops working in virtual machines.  He also scans the memory for the presence of analysis tools and immediately completes their processes.  All this significantly complicates the analysis of malicious code. <br><br>  The following figure is a diagram of the steps involved in deploying malware.  Some of these include an analysis environment check. <br><br><img src="https://habrastorage.org/webt/na/zd/w5/nazdw5dxfuqcxrk5gvbj0a5rfpy.png" alt="image"><br>  <i>Figure 1. Step-by-step execution scheme for shell code and Dofoil attack code</i> <br><br>  The table below describes the purpose of each stage.  Each of the first five stages includes means to counteract the dynamic or static analysis of malicious code. <br><br><table><tbody><tr><td>  <b>STAGES</b> </td><td>  <b>DESCRIPTION</b> </td></tr><tr><td>  1. Disguised Shell Code </td><td>  Protects against heuristic analysis. <br>  Protects against emulation. <br></td></tr><tr><td>  2. bootstrap module </td><td>  Replaces own process code for loading the next module. <br></td></tr><tr><td>  3. Anti-debug module </td><td>  Prevents attempts to run in debug mode. </td></tr><tr><td>  4. Trojan downloader module </td><td>  Checks the system environment. <br>  Prevents attempts to run inside the virtual machine. <br>  Embedded in explorer.exe by replacing the process code. <br></td></tr><tr><td>  5. Trojan downloader module in explorer.exe </td><td>  Communicates with the management and control server to download the trojan and execute it by replacing the process code. <br></td></tr><tr><td>  6. Module loader attacker code in explorer.exe </td><td>  Communicates with the management and control server to load the main attack code. <br></td></tr><tr><td>  7. Trojan module </td><td>  Steals credentials from different application configurations and sends the collected data to the management and control server through the HTTP channel. <br></td></tr><tr><td>  8. CoinMiner.D </td><td>  Performs mining cryptocurrency. </td></tr></tbody></table><br>  <i>Table 1. Modules implemented by Dofoil at different stages</i> <br><br><h2>  Initial stages </h2><br>  The first three steps (that is, the masked shell code, boot module, and anti-debug module) attempt to prevent analysis and recognition by the following methods. <br><br><table><tbody><tr><td width="200">  <b>METHODS OF COUNTERACTION ANALYSIS</b> </td><td>  <b>DESCRIPTION</b> </td></tr><tr><td>  Embedded clean code </td><td>  Embeds a huge patch of clean code to confuse heuristic and manual analysis. </td></tr><tr><td>  Emulation check </td><td>  Selects an arbitrary registry key <i>(HKEY_CLASSES_ROOT \ Interface \ {3050F557-98B5-11CF-BB82-00AA00BDCE0B})</i> and compares the data with the expected value <i>(DispHTMLCurrentStyle)</i> to find out if the malware is running inside the emulator. </td></tr><tr><td>  Replacing your own process code </td><td>  Replaces the code of the current process, significantly complicating the analysis due to the changed address marking of the code. </td></tr><tr><td>  Debug check </td><td>  Checks for debugging tools.  Having found them, modifies the code, causing a crash.  This mechanism complicates the work of researchers, who can only figure out the reason for this completion.  The program checks the <i>PEB.BeingDebugged</i> and <i>PEB.NtGlobalFlag fields</i> in the PEB structure.  For example, when a process is running in a debugger, the <i>PEB.BeingDebugged</i> field is <i>set</i> to 1, and <i>PEB.NtGlobalFlag</i> is set to <i>FLG_HEAP_ENABLE_TAIL_CHECK</i> |  <i>FLG_HEAP_ENABLE_FREE_CHECK</i> |  <i>FLG_HEAP_VALIDATE_PARAMETERS</i> . </td></tr></tbody></table><br>  <i>Table 2. Methods of counteracting the analysis</i> <br><br>  The first stage contains a section with a clean code, followed by a real malicious code.  Because of this, executable files may seem safe.  In addition, the presence of such code can complicate emulation, since it is not easy to mimic API calls that are rarely found in malware code. <br><br>  The code of the first stage also checks the registry key for compliance with the expected value.  After passing all the checks, the code decrypts the shell code of the second stage and executes it in the marked memory area.  A shell code clears the memory layout of the original source module, decrypts the third stage shell code and places it in the same memory location ‚Äî this procedure is called replacing the code of the own process. <br><br><img src="https://habrastorage.org/webt/5a/ly/-d/5aly-dykmidsizchbjfybe22kce.png" alt="image"><br>  <i>Figure 2. Code mutation depending on the value of PEB.BeingDebugged</i> <br><br>  The Windows Defender ATP process tree helps expose such anti-debugging mechanisms. <br><br><img src="https://habrastorage.org/webt/ez/-3/yo/ez-3yo69kslpidbfo1ci0vv636k.png" alt="image"><br>  <i>Figure 3. Anti-debugging mechanisms visible in the Windows Defender ATP process tree</i> <br><br><h2>  Trojan downloader module </h2><br>  Before downloading the attacking code, the Trojan loader module checks the execution environment in various ways, including for virtuality and availability of analysis tools. <br><br><table><tbody><tr><td width="200">  <b>METHODS OF COUNTERACTION ANALYSIS</b> </td><td>  <b>DESCRIPTION</b> </td></tr><tr><td>  Module name check </td><td>  Checks whether the name of the main executable file contains the string "sample". <br></td></tr><tr><td>  Volume Serial Number Check </td><td>  Checks whether the current volume has a serial number of <i>0xCD1A40</i> or <i>0x70144646</i> . </td></tr><tr><td>  Module check </td><td>  Checks for the presence of debug DLLs. </td></tr><tr><td>  Check disks registry keys </td><td>  It checks the value of the <i>HKLM \ System \ CurrentControlSet \ Services \ Disk \ Enum</i> registry key with the common disk name patterns on virtual machines ( <i>qemu, virtual, vmware, xen, ffffcce24</i> ). </td></tr><tr><td>  Process check </td><td>  It checks the running processes and terminates those associated with the analysis tools ( <i>procexp.exe, procexp64.exe, procmon.exe, procmon64.exe, tcpview.exe, wireshark.exe, processhacker.exe, ollydbg.exe, idaq.exe, x32dbg .exe</i> ). </td></tr><tr><td>  Windows class name checking </td><td>  Checks the current Windows class names and shuts down when it finds common class names associated with <i>parsing</i> and debugging ( <i>Autoruns, PROCEXPL, PROCMON_WINDOW_CLASS, TCPViewClass, ProcessHacker, OllyDbg, WinDbgFrameClass</i> ). </td></tr></tbody></table><br>  <i>Table 3. Methods of countering analysis in the Dofoil trojan downloader module</i> <br><br>  The names of target processes and Windows classes are stored as a list of specially calculated checksums.  The check algorithm looks like this: <br><br><img src="https://habrastorage.org/webt/93/8o/zf/938ozfe9obclydooml7wivyinew.png" alt="image"><br>  <i>Figure 4. Special algorithm for checking checksums based on shift operations and exclusive OR</i> <br><br>  The use of checksums should have slowed down the investigation and didn‚Äôt allow researchers to quickly figure out which analysis tools were determined by malware. <br><br><table><tbody><tr><td>  <b>LINE</b> </td><td>  <b>CHECK SUM</b> </td></tr><tr><td>  Autoruns </td><td>  0x0E5C1C5D </td></tr><tr><td>  PROCEXPL </td><td>  0x1D421B41 </td></tr><tr><td>  PROCMON_WINDOW_CLASS </td><td>  0x4B0C105A </td></tr><tr><td>  TCPViewClass </td><td>  0x1D4F5C43 </td></tr><tr><td>  Processhacker </td><td>  0x571A415E </td></tr><tr><td>  Ollydbg </td><td>  0x4108161D </td></tr><tr><td>  WinDbgFrameClass </td><td>  0x054E1905 </td></tr><tr><td>  procexp.exe </td><td>  0x19195C02 </td></tr><tr><td>  procexp64.exe </td><td>  0x1C0E041D </td></tr><tr><td>  procmon.exe </td><td>  0x06185D0B </td></tr><tr><td>  procmon64.exe </td><td>  0x1D07120A </td></tr><tr><td>  tcpview.exe </td><td>  0x060B5118 </td></tr><tr><td>  wireshark.exe </td><td>  0x550E1E0D </td></tr><tr><td>  processhacker.exe </td><td>  0x51565C47 </td></tr><tr><td>  ollydbg.exe </td><td>  0x04114C14 </td></tr><tr><td>  ollydbg.exe </td><td>  0x04114C14 </td></tr><tr><td>  x32dbg.exe </td><td>  0x5F4E5C04 </td></tr><tr><td>  idaq.exe </td><td>  0x14585A12 </td></tr></tbody></table><br>  <i>Table 4. Checksum table for Windows process names and classes</i> <br><br><h2>  Replacing process code </h2><br>  Dofoil's work is highly dependent on the process code replacement technique.  The main target process is explorer.exe.  The shell code Dofoil launches a new instance of explorer.exe, places the shell code in the dynamic memory and modifies the code of the entry point so that the transition to the shell code takes place.  Due to this, the malware implements code injection without using the <i>CreateRemoteThread</i> API function. <br><br><img src="https://habrastorage.org/webt/ix/k6/zt/ixk6ztglnwqr46n6vtseln7oi-a.png" alt="image"><br>  <i>Figure 5. Changing the entry point code in explorer.exe</i> <br><br>  Windows Defender ATP can detect the signs of replacing a process code by analyzing operations in memory.  In the next process tree, you can see how the malware is embedded in explorer.exe by replacing the process code. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/uk/iu/b9/ukiub9x6xuaa4ggswstnxgjt1ki.png" width="500" alt="image"></div><br>  <i>Figure 6. Windows Defender ATP warning process tree: first replacement of process code</i> <br><br>  When the shellcode loads the next layer of the attacking code, it spawns the next process explorer.exe, into which it then embeds the attacker code by the replacement method.  In such cases, Windows Defender ATP significantly speeds up the analysis, accurately identifying malicious operations and indicating the dubious actions of the newly created Windows system processes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/q5/rc/yp/q5rcypcnsofoyb5wls_dzmqa6xq.png" width="500" alt="image"></div><br>  <i>Figure 7. Windows Defender ATP warning process tree: second replacement of process code</i> <br><br>  For detection of the replacement of the process code is responsible for the component of <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-exploit-guard/exploit-protection-exploit-guard">protection against exploits</a> in <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-exploit-guard/windows-defender-exploit-guard">Windows Defender Exploit Guard</a> .  For this, you need to enable Export Address Filter (EAF) protection for the explorer.exe process.  In this case, the component will detect a substitution when the shellcode searches in the modules for the export addresses of the <i>LoadLibraryA</i> and <i>GetProcAddress</i> functions. <br><br><img src="https://habrastorage.org/webt/by/fv/2p/byfv2pf-rn0pgm8uiaml6djhl6u.png" alt="image"><br>  <i>Figure 8. EAF event in the event log</i> <br><br>  Windows Defender Exploit Guard events are also available on the Windows Defender ATP portal: <br><br><img src="https://habrastorage.org/webt/v9/nk/gn/v9nkgnugcyhjjhjsibj5nj-gocu.png" alt="image"><br>  <i>Figure 9. Windows Defender Exploit Guard event in Windows Defender ATP</i> <br><br>  When an EAF audit or blocking policy in Windows Defender Exploit Guard covers popular system processes, such as explorer.exe, cmd.exe or verclsid.exe, this makes it easier to detect and block key methods for replacing process code and implementing code used by malware.  The policy may affect the operation of third-party programs acting as a shell code, so we recommend testing it in <a href="https://docs.microsoft.com/ru-ru/windows/security/threat-protection/windows-defender-exploit-guard/audit-windows-defender-exploit-guard">the</a> Windows Defender Exploit Guard <a href="https://docs.microsoft.com/ru-ru/windows/security/threat-protection/windows-defender-exploit-guard/audit-windows-defender-exploit-guard">audit mode</a> before applying it all the time. <br><br><h2>  Management and Control (C &amp; C) and NameCoin Server Domains </h2><br>  Dofoil handles connection to C &amp; C servers with particular caution.  The Trojan code first tries to connect to trusted web pages to make sure that the Internet connection is present and that it is real, and not simulated in a test environment.  After confirming the authenticity of the Internet connection, the malware communicates with the real C &amp; C servers via HTTP. <br><br><img src="https://habrastorage.org/webt/qr/vv/77/qrvv77omntctrukr8amqewffluq.png" alt="image"><br>  <i>Figure 10. Connecting to known servers to test Internet connectivity</i> <br><br>  Malicious software accesses the servers with domain names NameCoin.  NameCoin is a decentralized DNS server system that provides a high degree of anonymity thanks to blockchain technology.  In general, working with it is not particularly different from normal DNS queries, but the DNS client must contact certain NameCoin DNS servers.  Since NameCoin relies on the blockchain model, the blocks can be used to track the history of the domain name change. <br><br><img src="https://habrastorage.org/webt/tx/53/i5/tx53i5mhkuqdwd4gfeugpyxxyus.png" alt="image"><br>  <i>Figure 11. DNS change record for malicious hosts ( <a href="https://namecha.in/name/d/vrubl">https://namecha.in/name/d/vrubl</a> )</i> <br><br>  Windows Defender ATP allows you to track the network activity of malware.  The following warning process tree shows how the malicious process resolves the names of the .bit domains corresponding to the C &amp; C servers and establishes connections with them.  You can also see other actions of the executable file, such as connecting to other servers via SMTP ports. <br><br><img src="https://habrastorage.org/webt/my/qb/lh/myqblhvvhcjpepjpw4c07q5igkc.png" alt="image"><br>  <i>Figure 12. Windows Defender ATP alert process tree: connecting to C &amp; C servers after name resolution through NameCoin servers</i> <br><br>  The Windows Defender ATP advanced threat scan feature, while available as an evaluation version, can detect more malicious code samples using NameCoin servers.  For example, the following query allows you to see recent connections to them.  This may help to obtain information about other threats communicating with the same NameCoin servers. <br><br><img src="https://habrastorage.org/webt/qm/ge/xm/qmgexm4ju1xqwm79ltsuwujbnji.png" alt="image"><br>  <i>Figure 13. Advanced search for threats using the same NameCoin servers</i> <br><br>  The NameCoin system is designed to complicate the interception of domain management (the so-called syncholing).  NameCoin domain name records are not controlled by any central regulator, therefore such records cannot be changed at the request of law enforcement agencies.  Moreover, malware relies on a number of NameCoin DNS servers and it is extremely difficult to stop them all. <br><br><h2>  Conclusion </h2><br>  Dofoil is a very quirky malware.  Using different methods, it checks the nature of the system environment and the authenticity of the Internet connection in order to work only on real computers and not in the analysis environment or on virtual machines.  All this slows down the analysis and confuses research systems. <br><br>  In Dofoil campaigns, <a href="https://www.microsoft.com/ru-ru/WindowsForBusiness/windows-atp">Windows Defender Advanced Threat Protection</a> can help security professionals analyze the order of events on the victim's computer and get detailed information on the steps of the processes, connections to C &amp; C servers, and operations to replace the process code.  Windows Defender ATP can act as an analysis platform for setting up detailed tracking of system operations in a test environment.  This way, you can save a lot of time and resources on investigating an infection. <br><br>  In addition, <a href="https://cloudblogs.microsoft.com/microsoftsecure/2017/10/23/windows-defender-exploit-guard-reduce-the-attack-surface-against-next-generation-malware/">Windows Defender Exploit Guard</a> can assist in detecting malicious shell code that scans export address tables.  It is a great tool for detecting and blocking exploit and malware actions. <br><br>  Windows Defender Exploit Guard events are also visible on the Windows Defender ATP portal, where other Microsoft security solutions are integrated, including <a href="https://www.microsoft.com/ru-ru/windows/comprehensive-security">Windows Defender Antivirus</a> and <a href="https://cloudblogs.microsoft.com/microsoftsecure/2017/10/23/making-microsoft-edge-the-most-secure-browser-with-windows-defender-application-guard/">Windows Defender Application Guard</a> . <br><br>  To evaluate in practice how Windows Defender ATP helps detect, analyze and repel attacks of increased complexity, get access to a <a href="https://winatpregistration-prd.trafficmanager.net/UserAgreement">free trial version</a> . <br><br>  <i>Matt Oh, Stefan Sellmer, Jonathan Bar Or, Mark Wodrich</i> <i><br></i>  <i><b>Windows Defender ATP Research Team</b></i> </div><p>Source: <a href="https://habr.com/ru/post/353250/">https://habr.com/ru/post/353250/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353234/index.html">Flask Mega-Tutorial, Part XIX: Deploying Based on Docker Containers</a></li>
<li><a href="../353236/index.html">The history of gaming analytics platforms</a></li>
<li><a href="../353238/index.html">Docker. Start</a></li>
<li><a href="../353246/index.html">We invite you to a lecture evening on game design on April 18th at VSBI</a></li>
<li><a href="../353248/index.html">Reachability of the lower limit of the execution time of a commit distributed fault-tolerant transactions</a></li>
<li><a href="../353252/index.html">Manage copying Active Directory attributes when duplicating user accounts</a></li>
<li><a href="../353254/index.html">How in hh.ru test job search</a></li>
<li><a href="../353256/index.html">How fast is AMP really?</a></li>
<li><a href="../353258/index.html">About decorators, end-to-end functionality, CQRS and layered architecture</a></li>
<li><a href="../353262/index.html">JS DevDay: about titanium, workers and hybrids</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>