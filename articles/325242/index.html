<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tuning SQL Server 2012 under SharePoint 2013/2016. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. My name is Lyubov Volkova, I am a systems architect in the business solutions development department. From time to time, I write application po...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tuning SQL Server 2012 under SharePoint 2013/2016. Part 1</h1><div class="post__text post__text-html js-mediator-article">  Hello.  My name is Lyubov Volkova, I am a systems architect in the business solutions development department.  From time to time, I write application posts about Microsoft server products (for example, about <a href="https://habrahabr.ru/company/softline/blog/322940/">monitoring SharePoint servers</a> and about <a href="https://habrahabr.ru/company/softline/blog/323046/">servicing databases</a> related to content databases, services, and components of this platform. <br><br>  This post is the first of two, in which I will talk about an important topic from the point of view of administering SharePoint portals - on tuning SQL servers aimed at achieving high performance.  It is extremely important to ensure careful planning, correct installation and subsequent configuration of the SQL server that will be used to store data hosted on the corporate portal. <br><br>  In this post you can read about planning the installation of a SQL server.  A little later, the second part will be published, devoted to the installation of a SQL server and subsequent configuration. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/84d/7d1/f4b/84d7d1f4bcd3465f83c14c54ad2ed205.jpg"><a name="habracut"></a><br><h2>  <font color="#2e74b5">SQL Server Installation Planning</font> </h2><br><h3>  <font color="#2e74b5">SQL Server Virtualization</font> </h3><br><h4>  <font color="#1f4d78">Why do you need server virtualization?</font> </h4><br>  Here are seven main reasons why server virtualization is being considered: <br><br><ol><li>  <b>Increase hardware utilization</b> .  According to statistics, most servers are loaded by 15-20 percent when they perform daily tasks.  Using multiple virtual servers on a single physical server will increase it to 80 percent, while providing substantial savings on hardware purchases. <br><br></li><li>  <b>Reduced hardware replacement costs.</b>  Since virtual servers are decoupled from specific equipment, it is not necessary to reinstall and configure the software when updating the physical server fleet.  The virtual machine can simply be copied to another server. <br><br></li><li>  <b>Increase the flexibility of using virtual servers.</b>  If you need to use multiple servers (for example, for testing and working in a product environment) with varying load, virtual servers are the best solution, as they can be safely transferred to other platforms when the physical server is under increased load. <br><br></li><li>  <b>Improved manageability of server infrastructure.</b>  There are many virtual infrastructure management products that allow you to centrally manage virtual servers and provide load balancing and live migration. <br><br></li><li>  <b>Provide high availability.</b>  Preparing backups of virtual machines and restoring them takes much less time and is simpler.  Also, in case of equipment failure, a backup copy of the virtual server can be immediately launched on another physical server. <br><br></li><li>  <b>Savings on maintenance staff</b> .  Simplifying the management of virtual servers in the future entails savings on specialists serving the infrastructure of the company.  If two people can do what four did with the help of virtual server management tools, why do you need two extra specialists who receive at least $ 15,000 a year?  Nevertheless, it must be borne in mind that considerable money is also needed to train qualified personnel in the field of virtualization. <br><br></li><li>  <b>Savings on electricity.</b>  For small companies, this factor, of course, does not matter much, but for large data centers, where the cost of maintaining a large server fleet includes the cost of electricity (power, cooling systems), this point is of considerable importance.  The concentration of several virtual servers on one physical will reduce these costs. </li></ol><br><h4>  <font color="#1f4d78">SQL Server Virtualization Support</font> </h4><br>  Considering the issue of server virtualization that is part of a SharePoint farm or network infrastructure servers that provide user authentication, name resolution, PKI management, and other functions, you need to remember that there is a possibility of virtualization: <br><br><ul><li>  Active Directory Domain Services; </li><li>  Web servers and SharePoint application servers (Front-End Web Server and Application Server); </li><li>  SQL Server Services; </li><li>  Any component of SQL, ADS, SharePoint 2013. </li></ul><br>  Summary data about guest operating systems, supported versions of SQL servers and virtual machine clustering are presented in the table below: <br><table><tbody><tr><th>  SQL Server Version </th><th>  Supported Windows Server Guest Operating Systems </th><th>  Hyper-V Support </th><th>  Guest Clustering Support </th></tr><tr><td>  SQL Server 2008 SP3 </td><td>  2003 SP2, 2003 R2 SP2, 2008 SP2, 2008 R2 SP1, 2012 SP2, 2012 </td><td>  Yes </td><td>  Yes </td></tr><tr><td>  SQL Server 2008 R2 SP2 </td><td>  2003 SP2, 2008 SP2, 2008 R2 SP1, 2012, 2012 R2 </td><td>  Yes </td><td>  Yes </td></tr><tr><td>  SQL Server 2012 SP1 </td><td>  2008 SP2, 2008 R2 SP1, 2012, 2012 R2 </td><td>  Yes </td><td>  Yes </td></tr><tr><td>  SQL Server 2014 </td><td>  2008 SP2, 2008 R2 SP1, 2012, 2012 R2 </td><td>  Yes </td><td>  Yes </td></tr></tbody></table><br>  Note that guest clustering support is provided in versions of Windows Server 2008 SP2 and later. <br><br>  A more detailed description of the purpose and architecture of a fault-tolerant guest cluster can be found <a href="https://technet.microsoft.com/ru-ru/library/ee922690.aspx">here</a> , and the hardware requirements, features of support for working in a virtual environment for specific versions of SQL servers can be obtained from the links in the following table: <br><table><tbody><tr><th>  SQL Server Version </th><th>  Documentation link </th></tr><tr><td>  SQL Server 2008 SP3 </td><td>  <a href="http://msdn.microsoft.com/en-us/library/ms143506(v%3Dsql.100).aspx">Hardware &amp; Software Requirements, Hardware Virtualization &amp; Guest Clustering Support</a> </td></tr><tr><td>  SQL Server 2008 R2 SP2 </td><td>  <a href="http://msdn.microsoft.com/en-us/library/ms143506(v%3Dsql.105).aspx">Hardware &amp; Software Requirements, Hardware Virtualization &amp; Guest Clustering Support</a> </td></tr><tr><td>  SQL Server 2012 SP1 </td><td>  <a href="https://msdn.microsoft.com/en-us/library/ms143506(v%3Dsql.110).aspx">Hardware &amp; Software Requirements, Hardware Virtualization &amp; Guest Clustering Support</a> </td></tr><tr><td>  SQL Server 2014 </td><td>  <a href="http://technet.microsoft.com/en-us/library/ms143506(v%3Dsql.120).aspx">Hardware &amp; Software Requirements, Hardware Virtualization &amp; Guest Clustering Support</a> </td></tr></tbody></table><br><h4>  <font color="#1f4d78">SQL Server Performance with Virtualization</font> </h4><br>  ESG Labs research confirmed that the performance of SQL Server 2012 OLTP on virtual servers is only about 6.3% lower than that of a physical platform. <br><br>  Hyper-V supports up to 64 processors per separate virtual machine, tests have shown a 6-fold increase in performance and a 5-fold increase in transaction time.  The illustration below shows the main results of the tests.  A detailed report can be found <a href="http://c/Users/volkovali/Downloads/ESG-Lab-Validation-WS2012-HyperV-and-SQL2012.pdf">here</a> . <br><br><img src="https://habrastorage.org/files/039/b81/8f7/039b818f70b445459aba5254f0eaf665.png"><br><br>  Hyper-V can be used to virtualize large volumes of SQL Server databases and supports the use of advanced features such as <a href="https://msdn.microsoft.com/en-us/windows/hardware/drivers/network/overview-of-single-root-i-o-virtualization--sr-iov-">SR-IOV</a> , <a href="https://msdn.microsoft.com/ru-ru/library/hh831413(v%3Dws.11).aspx">Virtual Fiber Channel</a> and <a href="https://technet.microsoft.com/ru-ru/library/dn282282(v%3Dws.11).aspx">Virtual NUMA</a> . <br><br><h4>  <font color="#1f4d78">Disadvantages of SQL Server Virtualization</font> </h4><br>  We list its main shortcomings, which become the main reasons that the SQL server for SharePoint is deployed on a physical server: <br><br><ol><li>  The need to restructure the approach to work with the reliability of the system.  Indeed, since several virtual machines are simultaneously running on the same physical server, the failure of the host leads to the simultaneous failure of all VMs and applications running on them. <br><br></li><li>  Load balancing  If a virtual machine, the SQL server typically uses a lot of processor (or memory) computing resources, which affects the performance of other virtual machines and host applications that also require processor time (memory).  Even if only a virtual machine with a SQL server is hosted on the host, setting the optimal performance level requires a whole range of actions.  Read more about this in the article by Michael Ooty, available here.  Administrators have to distribute the load by setting the rules by which the running virtual machines will automatically move to less loaded servers or ‚Äúunload‚Äù the loaded ones. </li></ol><br><h3>  <font color="#2e74b5">RAM &amp; CPU</font> </h3><br>  To ensure the normal level of functioning of the SQL server, it is necessary to ensure an adequate amount of RAM.  In the case when only one instance of SQL is deployed, which is allocated exclusively for working with SharePoint databases, the requirements are minimal: <br><table><tbody><tr><th></th><th>  Small SharePoint farm (content up to 500 GB) </th><th>  Average SharePoint farm (content from 501 GB to 1 TB) </th><th>  Big SharePoint farm (content 1-2 TB) </th><th>  Very large SharePoint farm (content 2-5 TB) </th><th>  Special cases </th></tr><tr><td>  Ram </td><td>  8 GB </td><td>  16 GB </td><td>  32 GB </td><td>  64 GB </td><td>  64 GB </td></tr><tr><td>  CPU </td><td>  four </td><td>  four </td><td>  eight </td><td>  eight </td><td>  eight </td></tr></tbody></table><br><h3>  <font color="#2e74b5">Plan size, layout, and general database requirements for SharePoint</font> </h3><br>  SharePoint is a powerful platform for building portal solutions that have a modular architecture.  The set of services and components supporting the operation of the corporate portal allows us to single out a list of databases, the storage of which must be planned.  There are three groups of databases that differ in the time of the recommended planning: <br><br><ol><li>  <b>Before installing the SQL server.</b>  This group includes all system databases of the SQL server, the SharePoint content database (the default is one). </li><li>  <b>Before installing the SharePoint server.</b>  This group includes the SharePoint configuration database, the SharePoint Central Administration content database. </li><li>  <b>Before deploying a service application storing data in a database / databases.</b>  Examples: Managed Metadata Service, User Profile Service, Search, etc. </li><li>  <b>Before creating additional SharePoint content databases.</b> </li></ol><br>  The <a href="https://technet.microsoft.com/en-us/library/cc678868.aspx">Microsoft article</a> details the main characteristics of all the databases listed in the groups.  The table below provides recommendations for setting up a recovery mode for each of them based on many years of experience in technical support, migrations, and recovery of SharePoint databases: <br><table><tbody><tr><th>  <nobr>Database</nobr> <br></th><th>  <nobr>Default</nobr> <nobr>Recovery Mode</nobr> <br></th><th>  <nobr>Recommended</nobr> Recovery Mode and Comments <br></th></tr><tr><td>  Master database <br></td><td>  Plain <br></td><td>  Plain <br></td></tr><tr><td>  Model database template <br></td><td>  Full access <br></td><td>  Plain. <br><br>  As a rule, tuning is performed once or very rarely.  It is enough to perform a backup after making changes. <br></td></tr><tr><td>  Msdb database <br></td><td>  Plain <br></td><td>  Plain <br></td></tr><tr><td>  Tempdb database <br></td><td>  Plain <br></td><td>  Plain <br></td></tr><tr><td>  Central Administration Content Database <br></td><td>  Full access <br></td><td>  Plain. <br></td></tr><tr><td>  Configuration database <br></td><td>  Full access <br></td><td>  Changes are usually actively made at the stage of initial or spot configuration of services and components of the SharePoint farm, which has clear short time boundaries.  It is more efficient to perform a backup after making completed blocks of changes. <br></td></tr><tr><td>  Application Management Service Database <br></td><td>  Full access <br></td><td>  Plain. <br>  Typically, in the SharePoint farm is set from 0 to a small number of applications (1-5) SharePoint.  Application installations are usually significantly separated in time.  More efficiently perform a full backup of the database after installing a separate application <br></td></tr><tr><td>  Subscription Settings Service Database <br></td><td>  Full access <br></td><td>  Plain. <br>  As a rule, SharePoint applications are installed on a small number of sites (1-5).  Application installations are usually significantly separated in time.  It is more efficient to perform a full backup of the database after installing a separate application. <br><br>  Full.  If you intend to install applications on an unlimited number of web sites, installations are often performed <br></td></tr><tr><td>  Business Connectivity Service <br></td><td>  Full access <br></td><td>  Plain. <br>  Setting up and making changes related to the operation of this service is usually short in time and is performed once or a small number of times.  It is more efficient to perform a full database backup after the completed blocks for creating / editing data models, external content types and external data lists <br></td></tr><tr><td>  Managed Metadata service application database <br></td><td>  Full access <br></td><td>  Simple in the case of using directories with rarely changeable content. <br><br><br>  Full access in case of changes to the term sets on a regular basis (active creation and editing of hierarchical directories, tagging of list items and documents). <br></td></tr><tr><td>  SharePoint Translation Service Application Database <br></td><td>  Full access <br></td><td>  Plain. <br></td></tr><tr><td>  Power Pivot Database <br></td><td>  Full access <br></td><td>  Full access <br></td></tr><tr><td>  PerformancePoint Services Database <br></td><td>  Full access <br></td><td>  Simple when working with a set of indicator panels, in whose settings changes are rarely made. <br><br><br>  Full access in case of intensive creation / modification of indicator panels <br></td></tr><tr><td>  Search Administration Database <br></td><td>  Plain <br></td><td>  Plain. <br>  Setting up and making changes related to the operation of this service is usually short in time and is performed once or a small number of times.  It is more efficient to perform a full backup of the database after the completed setting blocks, changes to the search pattern <br></td></tr><tr><td>  Analytics Reporting Database <br></td><td>  Plain <br></td><td>  Simple, if the analysis of search results and intelligent adaptation of the issuance of results, search suggestions is not critical. <br><br><br>  Full access if the search on the portal and its constant personalized work are critical for business <br></td></tr><tr><td>  Crawl database <br></td><td>  Plain <br></td><td>  Plain. <br>  Restoring this database from a backup or using a recovery wizard will often be much longer compared to resetting the index and crawling the content completely. <br></td></tr><tr><td>  Link Database <br></td><td>  Plain <br></td><td>  Simple, if the analysis of search results and intelligent adaptation of the issuance of results, search suggestions is not critical. <br><br><br>  Full access if the search on the portal and its constant personalized work are critical for business <br></td></tr><tr><td>  Secure Store Database <br></td><td>  Full access <br></td><td>  Plain. <br>  Setting up and making changes related to the operation of this service is usually short in time and is performed once or a small number of times.  It is more efficient to perform a full backup of the database after the completed settings blocks. <br></td></tr><tr><td>  State Service Application Database <br></td><td>  Full access <br></td><td>  Plain. <br>  Because this database provides temporary storage for InfoPath forms, Visio Web Parts is not intended for long-term storage of this information.  The correctness of the data in this database is important at the moment when a user views a particular InfoPath form or Visio diagram through a web part. <br></td></tr><tr><td>  Usage and Health Data Collection Database <br></td><td>  Plain <br></td><td>  Simple or Full access. <br>  Depends on the requirements for an acceptable level of data loss for the organization. <br></td></tr><tr><td>  Profile Database <br></td><td>  Plain <br></td><td>  Simple, if there is no business-critical functionality, whose work requires working with the most relevant data on user profiles <br><br><br>  Full access if the situation is reversed. <br></td></tr><tr><td>  Profile Sync Database <br></td><td>  Plain <br></td><td>  Simple if recovery time takes less time compared to reconfiguring connections and performing full profile synchronization <br><br><br>  Full access if the situation is reversed <br></td></tr><tr><td>  Social Tag Database <br></td><td>  Plain <br></td><td>  Simple, if working with social content is not a business critical functionality <br><br><br>  Full access if the situation is reversed <br></td></tr><tr><td>  Word Automation Database <br></td><td>  Full access <br></td><td>  Full access <br></td></tr></tbody></table><br><h3>  <font color="#2e74b5">Number of disks</font> </h3><br>  Ideally, on a SQL server, it is recommended to have six disks to accommodate the following files: <br><br><ol><li>  Tempdb database data files; </li><li>  Tempdb database transaction log file; </li><li>  SharePoint database data files; </li><li>  SharePoint database transaction log files; </li><li>  Operating system; </li><li>  Files of other applications. </li></ol><br><h3>  <font color="#2e74b5">Disk Subsystem Preparation</font> </h3><br>  SharePoint uses a SQL server to store its data, which has its own data storage features.  In this regard, the preparation of the disk subsystem at both the physical and logical levels, taking into account these features, will have a huge impact on the final performance of the corporate portal. <br><br>  The data that Microsoft SQL Server stores is broken up into pages of 8 KB each, which in turn are grouped into so-called extents of 64 KB each.  Read more about it <a href="https://technet.microsoft.com/ru-ru/library/ms190969.aspx%3Ftduid%3D(710f14f2ab6c22ab4bba0953cdd3eaa9)(256380)(2459594)(TnL5HPStwNw-AqO5VIpLHcQhShqMha9j2Q)()">here</a> .  In accordance with this, the tuning of the disk subsystem is to ensure the holistic placement of the extent at all physical and logical levels of the disk subsystem. <br><br>  The first thing to start is the initialization of RAID.  In this case, the array on which the databases will be located should have a stripe size of multiple 64 KB, preferably if it is exactly 64 KB. <br><br><h4>  <font color="#1f4d78">Alignment of hard drive or SSD SSD partitions</font> </h4><br>  The alignment of the file system relative to its physical placement on the disk array is very important when considering how to improve the performance of the SQL server.  It is described in detail <a href="https://technet.microsoft.com/en-us/library/dd758814(SQL.100).aspx">here</a> .  On any hard disk or SSD, the first 63 sectors of 512 bytes are reserved for placing files that are created during the installation of the operating system or when performing disk management operations, as well as with the help of special programs - hard disk partition managers.  The essence of the alignment procedure is to select such a starting offset (offset), in which an entire number of file system clusters would fit in one stripe of the disk array.  Otherwise, it is possible that in order to perform a read operation on a single cluster of file system data, it will be necessary to perform two physical read operations from the disk array, which significantly degrades the performance of the disk subsystem (the performance loss can be up to 30%).  In the case of a solid-state drive, the performance loss will be somewhat lower, but it will run out of its resource faster due to more frequent read-write operations. <br><br>  The illustration below shows the features of performing read / write operations for unaligned partitions using the example of a 64 KB stripe. <br><br><img src="https://habrastorage.org/files/a75/daf/3e8/a75daf3e86a540a1832fb6e3b9d5e6d9.png"><br><br>  The illustration below shows the features of performing read / write operations for leveled partitions using the example of a 64 KB stripe. <br><br>  By default, in Windows Server 2008/2012, the partition offset is 1024 Kb, which is well correlated with the size of stripes on 64 Kb, 128 Kb, 256 Kb, 512 Kb and 1024 Kb. <br><br>  In cases of setting up operating systems from images, using different software for managing disk partitions, situations may arise related to the violation of partition alignments.  In this regard, it is recommended that before installing the SQL server, as an additional insurance, perform a double-check of correlations, which are described in the next section. <br><br><h4>  <font color="#1f4d78">Important correlations: Partition Offset, File Allocation Unit Size, Stripe Unit Size</font> </h4><br>  <font color="#2e74b5"><i>Partition offset</i></font> <br><br>  The most correct method for checking partition offsets for basic disks is to use the <b>wmic.exe</b> command line <b>utility</b> : <br><br>  <i>wmic partition get BlockSize, StartingOffset, Name, Index</i> <br><br><img src="https://habrastorage.org/files/8ce/76e/e32/8ce76ee324974c359c0b1569ccd028cd.png"><br><br>  To check the alignment of partitions for dynamic disks, you must use <b>diskdiag.exe</b> (for a description of working with it, see the section ‚Äú <a href="https://technet.microsoft.com/en-us/library/dd758814(SQL.100).aspx">Dynamic Disk Partition Offsets</a> ‚Äù). <br><br>  <font color="#2e74b5"><i>Stripe Unit Size</i></font> <br><br>  In Windows, there are no standard means for determining the size of the minimum data block for writing to disk (stripe unit size).  The value of this parameter must be obtained from the vendor‚Äôs documentation on the hard disk or from the SAN administrator.  The most common indicators of Stripe Unit Size are 64 Kb, 128 Kb, 256 Kb, 512 Kb or 1024 Kb.  In the examples considered earlier, a value of 64 Kb was used. <br><br>  <font color="#2e74b5"><i>File Allocation Unit Size</i></font> <br><br>  To determine the value of this indicator, you must use the following command separately for each of the disks (Value of the Bytes Per Cluster property): <br><br>  <b>fsutil fsinfo ntfsinfo c:</b> <br><br><img src="https://habrastorage.org/files/a9e/96d/3a7/a9e96d3a7ae3410eace4c20a16aecf17.png"><br><br>  For partitions that store data files and SQL Server transaction log files, the metric value should be 65,536 bytes (64 KB).  See "Optimizing Storage at the File System Level". <br><br>  Two important correlations, the observance of which are the basis for optimal disk I / O performance.  The results of the calculations for the following expressions should be an integer: <br><br><ul><li>  Partition_Offset √∑ Stripe_Unit_Size </li><li>  Stripe_Unit_Size √∑ File_Allocation_Unit_Size </li></ul><br>  The most important is the first correlation. <br><br>  An example of non-equal values.  Partition offset is 32,256 bytes (31.5 Kb) and the minimum block size for writing data to disk is 65,536 bytes (64 Kb).  32,256 bytes / 65,536 bytes = 0.4921875.  The result of division is not an integer, as a result we have not equalized values ‚Äã‚Äãof Partition_Offset and Stripe_Unit_Size. <br><br>  If the offset of the partition (Partition offset) is 1,048,576 bytes (1 MB), and the size of the minimum block of data written to disk is 65,536 bytes (64 KB), then the result of the division is 8, is an integer. <br><br><h4>  <font color="#1f4d78">File system-level storage optimization</font> </h4><br>  The next level at which to organize optimal storage of extents is the file system.  The optimal settings here are the NTFS file system with a cluster size of 65,536 bytes (64 KB).  In this regard, before installing the SQL server, it is strongly recommended to format the disks and set the cluster size to 65,536 bytes (64 KB) instead of 4096 bytes (4 KB) by default. <br><br>  You can check the current values ‚Äã‚Äãfor the disk using the following command: <br>  <b>chkdsk c:</b> <br><br>  Example output: <br><br><img src="https://habrastorage.org/files/db7/db5/fe7/db7db5fe75744bd69b992c22ec1d1cc5.png"><br><br>  In the presented example, the cluster size is 4096 bytes / 1024 = 4 KB, which does not comply with the recommendations.  To change you have to reformat the disk.  Cluster size can be set by adjusting the disk formatting options using the Windows operating system: <br><br><img src="https://habrastorage.org/files/e2a/b2d/e87/e2ab2de8779d40fb8992a69fc4479ba7.png"><br><br>  After that, make sure that the cluster size now complies with the recommendations (65536 bytes / 1024 = 64 kb): <br><br><img src="https://habrastorage.org/files/125/caf/7b3/125caf7b373f4a91ac72bb47de86e76c.png"><br><br><h4>  <font color="#1f4d78">Disk rankings based on read / write speed</font> </h4><br>  When designing the placement of the SQL Server system databases and the SharePoint databases, it will be important to choose the disks according to their rank based on the read / write speeds. <br><br>  To test and determine accurate data on the speed of reading / writing files with random access and sequential access, you can use software similar to <font color="#2e74b5">CrystalDiskMark</font> (for example, <a href="https://www.mssqltips.com/sqlservertip/2127/benchmarking-sql-server-io-with-sqlio/">SQLI</a> O).  Typically, an application allows you to enter basic test parameters, at a minimum: <br><br><ul><li>  The number of tests.  There should be several tests to get a more accurate average. </li><li>  The size of the file to be used during the execution of tests.  It is recommended to set a value that exceeds the amount of server RAM to avoid using only the cache.  In addition, the figures will provide statistics on the processing of large file sizes, which is relevant for many corporate portals with intensive user collaboration on content. </li><li>  The name of the disk on which read / write operations will be performed; </li><li>  List of tests that must be performed. </li></ul><br>  Below is an example of the results of tests performed: <br><br><img src="https://habrastorage.org/files/4f0/3c3/1c8/4f03c31c8966491c9ccbafd0dff27786.png"><br><br>  Below is a description of the content of the tests performed: <br><br><ul><li>  <b>Seq Q32</b> - speed of reading / writing to files with sequential access.  For a SQL server, these are operations such as backing up, scanning tables, defragmenting indexes, reading / writing transaction files. <br><br></li><li>  <b>4K QD32</b> - the speed of a large number of random reads / writes with small data (4 KB) at the same time.  The test results allow you to judge the performance of the disk when performing transactions in the course of the OLTP-server, which has a high load. <br><br></li><li>  <b>512K</b> is the speed of a large number of read / write operations with large data sizes (4 Kb) at the same time.  The results of this test can be ignored, because  They have no relation to the work of the SQL server as such. <br><br></li><li>  <b>4K</b> is the speed of a small number of random read / write operations with small data sizes (4 Kb) at the same time.  The test results allow you to judge the performance of the disk when performing transactions during the work of the OLTP server with a small load. </li></ul><br>  Note that the tests use the recording unit size of 4 KB, which does not fully correspond to the actual data storage scheme of the SQL server and work with 8 KB pages of akents in 64 KB.  When performing, there is no goal to ensure that the results obtained are absolutely consistent with the actual data on the same operations performed by the SQL server.  The main final goal is to rank the discs according to the speed of read / write operations and get the final table. <br><br>  For quick decision making during the installation of the SQL server, configuring the parameters for placing the database files it will be useful to format the test results as a table separately for each type of test, the template of which is shown below: <br><table><tbody><tr><th>  Disks sorted by read / write speed from fastest to slowest &lt;Test name&gt; </th><th>  <nobr>Assigned</nobr> Name </th><th>  <nobr>The size</nobr> </th><th>  <nobr>Comments</nobr> </th></tr><tr><td>  0 </td><td>  I: </td><td>  20GB </td><td>  Fixed size VHD </td></tr><tr><td>  one </td><td>  H: </td><td>  20GB </td><td>  Fixed size VHD </td></tr><tr><td>  2 </td><td>  G: </td><td>  50GB </td><td></td></tr><tr><td>  3 </td><td>  F: </td><td>  200GB </td><td></td></tr><tr><td>  four </td><td>  C: </td><td>  80GB </td><td>  operating system </td></tr><tr><td>  five </td><td>  E: </td><td>  2TB </td><td></td></tr><tr><td>  6 </td><td>  D: </td><td>  100GB </td><td></td></tr></tbody></table><br><h4>  <font color="#1f4d78">How to interpret the test results CrystalDiskMark?</font> </h4><br>  For magnetic disks (individual or as part of RAID), sequential operations operations (Seq Q32 test) often exceed the results of other tests by 10x-100x times.  These metrics often depend on how you connect to the repository.  It must be remembered that the number of MB / s claimed by vendors is a theoretical limitation.  In practice, they are usually less than the claimed by 5-20%. <br><br>  For solid-state drives, the difference between the speed of sequential and arbitrary read / write operations should not differ much from each other, usually no more than 2-3 times.  Connection speeds such as 3Gb SATA, 1Gb iSCSI, or 2 / 4Gb FC will affect the speed. <br><br>  If the server boots from a local disk and stores the SQL server data on another disk, you should also include both of these disks in your test plan.  Comparison of the test results of the CrystalDiskMark disk, on which variables are stored, data with indicators of the disk on which the operating system is installed, can demonstrate an advantage in the performance of the second.  In such a situation, the system administrator needs to check the disk or SAN storage settings for correctness and optimal performance. <br><br><h4>  <font color="#1f4d78">Prioritization when choosing disks</font> </h4><br>  Information about the purposes for which the portal is used allows you to correctly prioritize the selection of disks for storing SharePoint databases. <br><br>  If the corporate portal is mainly used by users for reading content and there is no active daily increase in content (for example, the company's external website), the most efficient disks need to be allocated for data storage, having allocated less efficient storage for transaction log files: <br><table><tbody><tr><th>  Speed ‚Äã‚Äã/ Usage Scenario </th><th>  The prevalence of viewing content over its editing (external website) is significant </th></tr><tr><td>  Highest performance </td><td>  Data Files and Tempdb Database Transaction Log Files </td></tr><tr><td>  ... </td><td>  Database files </td></tr><tr><td>  ... </td><td>  Search service data files except administration database </td></tr><tr><td>  Lowest performance </td><td>  SharePoint Content Database Transaction Log Files </td></tr></tbody></table><br>  If the corporate portal is used to organize collaboration between users who actively download dozens of documents every day, the priorities will be different: <br><table><tbody><tr><th>  Speed ‚Äã‚Äã/ Usage Scenario </th><th>  Predominance of content editing over its reading (external website) </th></tr><tr><td>  Highest performance </td><td>  Data Files and Tempdb Database Transaction Log Files </td></tr><tr><td>  ... </td><td>  SharePoint Content Database Transaction Log Files </td></tr><tr><td>  ... </td><td>  Search service data files except administration database </td></tr><tr><td>  Lowest performance </td><td>  Content Database Data Files </td></tr></tbody></table><br><h3>  <font color="#2e74b5">Recommendations for database storage types for a SharePoint farm</font> </h3><br><h4>  <font color="#1f4d78">Recommendations for choosing a disk for tempdb</font> </h4><br>  The low speed of read / write operations for the tempdb system database of the SQL server seriously affects the overall performance of the SharePoint farm, as a result of the performance of the corporate portal.  The best recommendation would be to use RAID 10 to store the files of this database. <br><br><h4>  <font color="#1f4d78">Disc recommendations for heavily used content databases</font> </h4><br>  For sites intended for collaboration or large volume of update operations, special attention should be paid to the choice of disks for storing SharePoint content database files.  The following recommendations should be considered: <br><br><ul><li>  Placement of data files and transaction logs for content databases on different physical disks </li><li>  Consider the growth of content in the design of portal solutions.  The most optimal is to support the size of each individual content database up to 200 GB. </li><li>  For heavily used SharePoint content databases, it is recommended to use several data files, placing them on separate disks.  In order to avoid sudden system failures of databases, it is strongly recommended not to use the database size limit setting. </li></ul><br><h4>  <font color="#1f4d78">Calculate the expected size of the content database</font> </h4><br>  The general formula for calculating the expected size of a content database is: <br><br>  ((D * V) * S) + (10Kb * (L + (V * D))), where: <br><br><ul><li>  <b>D</b> - number of documents, taking into account personal sites, documents and pages in libraries, forecast for an increase in the number of countries in the coming year; </li><li>  <b>V</b> - number ‚Äî in versions of documents; </li><li>  <b>S</b> - the average size of the documents (if it is possible to find out); </li><li>  <b>10 Kb</b> - constant, expected SharePoint 2013 number of metadata for one document; </li><li>  <b>L</b> - the expected number of list items, taking into account the forecast for an increase in the count in the coming year. </li></ul><br>  It is necessary to consider additional storage costs: <br><br><ul><li>  Audit, the storage of audit data + forecasts for the growth of audit data; </li><li>  Recycle bin, data storage time in the site basket and site collection. </li></ul><br><h4>  <font color="#1f4d78">RAID recommendations</font> </h4><br>  Despite the fact that RAID 5 has the best performance / cost, for SharePoint databases it is strongly recommended to use RAID 10, especially in the case of active use of the corporate portal for user collaboration. RAID 5         . <br><br><h3> <font color="#2e74b5">    </font> </h3><br>    ,    SQL  SharePoint   . <br><br><h4> <font color="#1f4d78">       </font> </h4><br>              SharePoint      ,         SQL  SharePoint,       . <br><br>   SQL  SharePoint   Windows Server 2012                       SharePoint: <br><br><ul><li>      , ,  .            ,        . </li><li>    ,   .    , ,  ,       ,    . </li></ul><br>           <a href="https://technet.microsoft.com/ru-ru/windowsserver/jj873791.aspx"></a> . <br><br>     ,  SharePoint        : <br><br><ul><li> 64-  Windows Server 2008 R2    1 (SP1) Standard, Enterprise  Datacenter </li><li> 64-  Windows Server 2012 Standard  Datacenter </li><li>       Microsoft SharePoint Server 2013     SharePoint 2013   64-    <a href="https://support.microsoft.com/ru-ru/kb/2891274">Windows Server 2012 R2</a> . </li></ul><br><h4> <font color="#1f4d78">Scalable Networking Pack</font> </h4><br>   2007    Windows Server 2003 SP2   ,         Scalable Networking Pack (SNP).               .    SNP  ,   Receive Side Scaling (RSS), TCP/IP Chimney Offload (   TOE)  Network Direct Memory Access (NetDMA).    ,       TCP/IP     . <br><br> -    SNP   Server 2003 SP2 -       .   Server 2003    .    Server 2008, Server 2008 R2                    .       Server 2008 R2 (  SP1   ).  ,            -      ,         . <br><br><h4> <font color="#1f4d78">Receive Side Scaling</font> </h4><br>  RSS              . <br><br>      RSS,       ,          ,     .       ,     ,      ,      ,    . <br><br>     Server 2008 R2      RSS .   ,     ,    : <br><br> <b>netsh interface tcp show global</b> <br><br><img src="https://habrastorage.org/files/5a5/2b2/fc5/5a52b2fc5aa44aa9b52c0ee1b8e1623e.png"><br><br>    ,    RSS              : <br><br><img src="https://habrastorage.org/files/0d3/1f3/768/0d31f37683754c3b860c0d5030c3a297.png"><br><br> RSS      ,    TCP Checksum Offload, IP Checksum Offload, Large Send Offload  UDP Checksum Offload (  IPv4  IPv6).  ,       ,  RSS     . <br><br><img src="https://habrastorage.org/files/302/56f/2de/30256f2de6304c3d8d58a7ca81161c13.png"><br><br><img src="https://habrastorage.org/files/e79/ed7/26f/e79ed726fdc64f22816ff6a13b86b3c1.png"><br><br>  ,      ,   ,    RSS,     RSS. <br><br><img src="https://habrastorage.org/files/5eb/6d0/315/5eb6d03158a14c5e9cd92a51dbe8a385.png"><br><br>        RSS       .         ,     ,          . <br><br><h4> <font color="#1f4d78">TCP/IP Chimney Offload</font> </h4><br>  TCP Chimney Offload (   TCP/IP Offloading   , ‚Äî TOE)    TCP     ,   TOE.  TCP             ,     . TOE      TCP/IPv4,    TCP/IPv6 ,     . <br><br> - ,     TCP/IP   (      <a href="https://blogs.msdn.microsoft.com/psssql/2008/10/01/tcp-chimney-offload-possible-performance-and-concurrency-impacts-to-sql-server-workloads/"></a> ),  TOE    ,         . ,   ,     ,        ,   ,       TOE. <br><br>    ,   - SharePoint       .        TCP Chimney Offload. <br><br>    TCP     : <br><br> <b>netsh interface tcp show global</b> <br><br><img src="https://habrastorage.org/files/726/a90/69d/726a9069da6a46b48d71c1726e3ed2a2.png"><br><br>   TOE  TCP    : <br><br> <b>netsh int tcp set global chimney=disable</b> <br><br>       TOE       TOE  TCP   : <br><br> <b>Netsh netsh interface tcp show chimneystats</b> <br><br>    IP      <br><br> <b>netsh int ip set global taskoffload=disable</b> d <br><br>    IP    : <br><br> <b>netsh int ip show global</b> <br><br><img src="https://habrastorage.org/files/26c/a12/60c/26ca1260c7dd457ca4c44c971e4a53a1.png"><br><br><h4> <font color="#1f4d78">Network Direct Memory Access</font> </h4><br> NetDMA ‚Äì   .     ,       TOE      . NetDMA     CPU          ,    CPU  . <br><br>  ,   NetDMA,  ,    , ‚Äì   Windows       Intel I/O Acceleration Technology (I/OAT).  NetDMA   AMD , ,  . <br><br> ,  TOE  NetDMA  ,         . <br><br>   NetDMA  Windows 2008 R2    : <br><br> <b>netsh interface tcp set global netdma=enabled</b> <br><br>         : <br><br> <b>netsh interface tcp show global</b> <br><br><img src="https://habrastorage.org/files/864/dd2/ae1/864dd2ae14194fa3a15b973285aeb1de.png"><br><br><h4> <font color="#1f4d78"> SNP  </font> </h4><br> <font color="#2e74b5"><i>Windows Server 2008 R</i> 2</font> <br><table><tbody><tr><th>  Parameter </th><th>    </th></tr><tr><td> TCP Chimney Offload </td><td> automatic </td></tr><tr><td>  RSS feed </td><td> enabled </td></tr><tr><td> NetDMA </td><td> enabled </td></tr></tbody></table><br> ¬´Automatic¬ª  TCP Chimney Offload ,    ,       ¬´TCP Chimney Offload¬ª      ,  10 GB Ethernet. <br><br> <font color="#2e74b5"><i>Windows Server 2012, Windows Server 2012 R2</i> 2</font> <br><table><tbody><tr><th>  Parameter </th><th>    </th></tr><tr><td> TTCP Chimney Offload </td><td> disable </td></tr><tr><td>  RSS feed </td><td> enabled </td></tr><tr><td> NetDMA </td><td>   </td></tr></tbody></table></div><p>Source: <a href="https://habr.com/ru/post/325242/">https://habr.com/ru/post/325242/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325226/index.html">How hackers attack corporate WiFi: parsing attacks</a></li>
<li><a href="../325230/index.html">OpenSSL, ssl_ciphers and nginx: we pump 100%</a></li>
<li><a href="../325232/index.html">Zen social programming</a></li>
<li><a href="../325234/index.html">Poll. What php-framework do you use?</a></li>
<li><a href="../325236/index.html">FPGA image rotation</a></li>
<li><a href="../325244/index.html">SEM time measure. Or ‚Äúhow do you know SEM and what to do next?‚Äù</a></li>
<li><a href="../325246/index.html">Sandbox technology. Check Point SandBlast. Part 1</a></li>
<li><a href="../325248/index.html">Pitfalls for home-made distribution "out of the box" in the C ++ actor framework</a></li>
<li><a href="../325252/index.html">On the practice of using the IBM DOORS requirements management system at NAMI</a></li>
<li><a href="../325254/index.html">Bitfury: about the team, requirements for candidates and open vacancies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>