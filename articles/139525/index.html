<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A bunch of LightSquid + Active Directory</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I use the LightSquid log analyzer on the squid proxy server, and once I wanted the statistics to be in the form of a computer - the real name, and sin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A bunch of LightSquid + Active Directory</h1><div class="post__text post__text-html js-mediator-article">  I use the LightSquid log analyzer on the squid proxy server, and once I wanted the statistics to be in the form of a computer - the real name, and since editing the configuration file for 100+ users seemed routine, well, when changing the name or adding new users to climb again I did not want to configure, I decided to take the names from the Active Directory automatically.  For details please under the cat. <br><a name="habracut"></a><br>  I use Active Directory, but with minimal changes the script should work with regular LDAP. <br>  I will not describe the installation of LightSquid, it is quite simple, Google will help you.  To convert IP to hostname, we will use DNS, described in the configuration file lightsquid.cfg with the line: <br><br>  $ ip2name = "dns"; <br><br>  The parser rereads the files realname.cfg and group.cfg and takes from there the real names of users attached to the hosts.  The file format is: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      realname.cfg: <br>  "Hostname" "real name" <br><br>  group.cfg: <br>  "Hostname" "group number" "group name" <br><br><h4>  What do we want? </h4><br>  It is necessary to take with HELL the hosts, the names of users attached to the hosts, the groups which contain users;  then we write all this into configuration files in the appropriate format. <br><br>  Here is the actual script that does this: <br><br><pre><code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/local/bin/perl # # ldap2lightsquid (c) Roman Melko &lt;romanmelko@gmail.com&gt; # Description: Synchronize users and computers of LightSquid with LDAP server # Requirements: Should run periodically # Version: 2012030601 # License: BSD # use strict; use Net::LDAP; my $domain = "example.ua"; # Domain is supposed to have 2 levels my @parts = split(/\./,$domain); my $domain0 = $parts[1]; my $domain1 = $parts[0]; my $user = "&lt;username&gt;"; # LDAP user my $password = "&lt;password&gt;"; # LDAP password my $cfgpath = "/usr/local/etc/lightsquid/"; # depends on OS my $realname = "$cfgpath/realname.cfg"; my $group = "$cfgpath/group.cfg"; # departments OU my @units = ( "MGT", "OPR", "PRO", "Sales "); # computers OU my @pcunits = ( "Developer servers", "Servers", "Workstation OPR", "Workstations PRO", "Workstations Sales", "Workstations Telemarketing" ); my @dep = ("no in group"); my $ldap = Net::LDAP-&gt;new("$domain") or die "$0"; $ldap-&gt;bind("CN=$user,DC=$domain1,DC=$domain0", password=&gt;$password); my $base_path = "OU=&lt;some path&gt;,OU=&lt;some path&gt;,DC=$domain1,DC=$domain0"; # base LDAP path, change to yours my $num = @units; my $pcnum = @pcunits; my $attrs = "sn, givenname, department, samaccountname"; my $filter = "(objectcategory=CN=Person,CN=Schema,CN=Configuration,DC=$domain1,DC=$domain0)"; my $pcattrs = "cn, managedBy"; my $pcfilter = "(objectcategory=CN=Computer,CN=Schema,CN=Configuration,DC=$domain1,DC=$domain0)"; my $count; my $results; my %department_id = (); my %department_name = (); sub get_host_info { for (my $i=0; $i&lt;$count; $i++) { my $entry = $results-&gt;entry($i); my $hostname = join(".",lc($entry-&gt;get_value('cn')),$domain); my @tmp_array = split(/,/,$entry-&gt;get_value('managedBy')); @tmp_array = split(/=/,$tmp_array[0]); my $fullname = $tmp_array[1]; if(!$fullname) { next; } print(REALNAME "$hostname\t$fullname\n"); print(GROUP "$hostname\t$department_id{$fullname}\t$department_name{$fullname}\n"); } } sub get_user_info { for (my $i=0; $i&lt;$count; $i++) { my $entry = $results-&gt;entry($i); my $depnum = @dep; my $depid = $depnum; $depid++; foreach $depnum (0 .. @dep) { if ($entry-&gt;get_value('department') eq $dep[$depnum]) { $depid = $depnum; } } if ($depid &gt; $depnum) { $dep[$depid] = $entry-&gt;get_value('department'); } if (length $depid &lt; 2) { $depid = "0".$depid; } my $name = $entry-&gt;get_value('givenname'); my $surname = $entry-&gt;get_value('sn'); $name =~ s/^\s+//; $name =~ s/\s+$//; $surname =~ s/^\s+//; $surname =~ s/\s+$//; my $fullname = join(" ",$name,$surname); $department_id{$fullname} = $depid; $department_name{$fullname} = $entry-&gt;get_value('department'); } } open (REALNAME, "&gt;", $realname) or die $!; open (GROUP, "&gt;", $group) or die $!; # Getting real names and departments foreach $num (0 .. @units) { my $base = 'OU='.$units[$num].','.$base_path; $results = $ldap-&gt;search(base=&gt;$base,filter=&gt;$filter,attrs=&gt;$attrs); $count = $results-&gt;count; if ($count &gt; 0) { get_user_info(); } } # Getting pc names and owners, writing results to conf files foreach $pcnum (0 .. @pcunits) { my $base = 'OU='.$pcunits[$pcnum].',OU=Resources,'.$base_path; $results = $ldap-&gt;search(base=&gt;$base,filter=&gt;$pcfilter,attrs=&gt;$pcattrs); $count = $results-&gt;count; if ($count &gt; 0) { get_host_info(); } } # Closing connection to LDAP and files $ldap-&gt;unbind; close (REALNAME); close (GROUP); exit 0</span></span></code> </pre> <br><br>  Important points: <br>  - in each host in the AD, the managedby field must be filled in, so the host is tied to the user; <br>  - in each user in AD, the department field must be filled, so the user is tied to the group (for now, I haven't gotten my hands on real groups, since my one user can belong to many groups with similar names); <br>  - units and pcunits you must fill in your own data; <br>  - the script should be executed periodically, for example in cron; <br>  - the user, under which the script is accessed in AD, must be at the root of AD, otherwise it would not let me; <br>  - in order to make the script work with the standard LDAP database, you should smoke mana, there are differences with HELL. </div><p>Source: <a href="https://habr.com/ru/post/139525/">https://habr.com/ru/post/139525/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139521/index.html">Alisher Usmanov became the richest Russian thanks to Facebook, Zynga and Groupon</a></li>
<li><a href="../139522/index.html">Convergent billing for three popular hypervisors</a></li>
<li><a href="../139523/index.html">Designing Interfaces for Small Children</a></li>
<li><a href="../139524/index.html">Ubuntu for Android - the first look at the symbiosis of operating systems</a></li>
<li><a href="../139526/index.html">Review of the camera Samsung MV800</a></li>
<li><a href="../139527/index.html">Intel Medfield Platform. Atom Z2460 processor for smartphones</a></li>
<li><a href="../139528/index.html">Cebit 2012 - New items from day one from Asus, Enermax and Zotac</a></li>
<li><a href="../139529/index.html">Ability to count</a></li>
<li><a href="../139530/index.html">First, the "skeleton", and then the "meat", or why startups are unsuccessful</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>