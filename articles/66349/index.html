<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Nemerle and satellite, or OP for the little ones</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently on Habr√© the mention of Nemerle is often mentioned. Do you want to know what it is and how it is eaten, or rather, how it is eaten with it (t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Nemerle and satellite, or OP for the little ones</h1><div class="post__text post__text-html js-mediator-article"><img src="http://pic.ipicture.ru/uploads/090810/rZ6fdB8PPB.jpg" align="left"><br>  Recently on Habr√© the mention of Nemerle is often mentioned.  Do you want to know what it is and how it is eaten, or rather, how it is eaten with it (tasks)? <br><br>  I will try to show you with a simple example, but for this you will have to <a name="habracut"></a><br><br><h4>  First of all </h4><br>  I will tell you at once what I won't tell you :) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I will not tell you in detail the features of syntax and so on.  - Anyone can read this on <a href="http://www.nemerle.org/">http://www.nemerle.org/</a> and google it for details.  In short, Nemerle is a hybrid programming language for the .net platform.  Hybrid - means that it combines the properties of imperative OOP and procedural, C-like syntax and flexibility and abilities of a functional language. <br><br>  I will not talk about the features of the paradigm, hygienic macros, and how to change its syntax in this fully compiled static-typed language. <br><br>  I will not tell you that Nemerle "does not like" variables, and that many imperative things are not available in the language by default: <b>if</b> , cycles <b>for</b> , <b>return</b> , many more.  In truth, they are not in the language itself - everything is implemented by <s>special, street</s> macros. <br><br>  Finally, I will not tell you that Nemerle with phenomenal rigorous-ruleznost is able to deduce the types of objects - so much so that with # 4.0 it rests :) <br><br>  In general, this will be a bad article, because I will just tell you how beautifully to solve the problem in the functional paradigm, using the Nemerle gadgets.  Well, the problem we will have to <a href="http://icfpcontest.org/">match the</a> language - with the recently passed contest <a href="http://icfpcontest.org/">icfp2009</a> .  Rather, its part - we will write Orbital VM on Nemerle, in a functional style. <br><br>  For those to whom the lines above said little or almost nothing, I cite a <a href="http://icfpcontest.org/task-1.9.pdf">link</a> to the contest specification, and also briefly explain below what the essence is. <br><br>  The previous contest (for 2008) used the LiveCD Knoppix, equipped with various ‚Äúbatteries‚Äù, as a proving ground to prevent anyone from feeling offended - JRE, gcc, ghc (Haskell), CLOS (Lisp), Python.  Practice has shown that, due to differences in floating-point operations, not all languages ‚Äã‚Äãproduced the same results, which made it difficult, if not more.  Therefore, in the current year (ie, in 2009), the organizers rolled out unambiguous specs on the VM, having made that, it would be possible to bring its solution to the problem. <br><br>  There were 4 groups of tasks with 4 options (within the group, the tasks differed in initial conditions, between groups - goals), for each group of tasks a binary with bytecode and the initial state of the data memory for OVM were proposed.  After the program was loaded into OVM, it was necessary to configure it by setting a number (1000 + N variants) on a special input port of the machine and drive off 1 execution cycle.  And then - in flight. <br><br>  I set forth in my own words - the task as a whole was to read the sensor readings and control the satellite's servomotors, to perform ‚Äúaerobatics‚Äù: bring it to a given orbit;  catch up and overtake the alien satellite <s>rolling into the abyss of capitalism</s> , etc.  One run on all OVM instructions was equal to one second of simulation time (simsek). <br><br>  Since only a solution log was required from the teams (namely, a sequence of commands on servomotors with time reference), then, in principle, the task could be solved exclusively ‚Äúin mind‚Äù;  but, as the harsh reality showed, all the winning teams used VMs to debug the results.  (Moreover, it seems that all the teams, without exception, used VM; some, however, not their own :)). <br><br>  <sub>Details about the misadventures of different teams, and who ‚Äúdragged‚Äù the car from someone, if you do not know yet, you can see <a href="http://habrahabr.ru/blogs/icfpc/63279/">here</a></sub> <br><br>  We will implement it. <br><br><h4>  For the cause </h4><br>  After reading the specs, you can imagine in general this very Orbital VM (OVM): a register machine with data memory space of 16K, as well as a separate 16K address space for I / O ports (I and O are separate). <br>  Hands and itching to outline a cycle in which the program counter increases in a cycle, and the result read by it from the program file is parsed using bit operations and fed to a huge switch that updates the contents of memory and registers. <br><br>  All right;  so it is possible?  Yes.  But I suggest not to hurry and follow the path of OP-tao, designing from the top down :) <br><br>  So, consider the state of the OVM at time T <sub>0</sub> .  After executing one instruction, the state of the machine will change.  Thus, one OVM instruction for our purposes can be viewed as a function: at the input, the state of the machine S, at the output S *. <br><br>  S <sub>n + 1</sub> = INSTR <sub>n</sub> (S <sub>n</sub> ); <br><br>  <sub>A small consequence - if each instruction returns a new state, it means that we can save it to a separate list with time stamps to keep the story.</sub>  <sub>Trifle, but nice</sub> <br><br>  Accordingly, the whole program for OVM is a stream of instructions, which is represented by a list of closure functions;  To execute a program, it is necessary to call all functions in turn, starting with the very first of the list, transferring to each next state that the previous one returned.  We transfer the initial state S <sub>0 to the</sub> very first function.  Mathematically speaking, we perform a left (literally) convolution (fold left). <br><br>  So, closer to the code.  On Nemerle, on him, darling.  I will be brief (s), but with explanations. <br><br>  Define alias types: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">type</font> INSTR = OVMState -&gt; OVMState; <font color="#0000ff">type</font> PROGRAMM = <font color="#0000ff">list</font> [INSTR] * OVMState;</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <ol><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">type</font> INSTR = OVMState -&gt; OVMState; <font color="#0000ff">type</font> PROGRAMM = <font color="#0000ff">list</font> [INSTR] * OVMState; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">type</font> INSTR = OVMState -&gt; OVMState; <font color="#0000ff">type</font> PROGRAMM = <font color="#0000ff">list</font> [INSTR] * OVMState; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> </ol> <code><font color="gray"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">type</font> INSTR = OVMState -&gt; OVMState; <font color="#0000ff">type</font> PROGRAMM = <font color="#0000ff">list</font> [INSTR] * OVMState;</font> * This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  INSTR is a type that defines a function that takes an OVM state as input and returns an OVM. <br>  PROGRAM - OVM software;  a tuple consisting of: a list of instructions (this is a stream of commands) and an initial state.  The syntax '*' just says that these two types need to be linked into a tuple. <br><br>  Our Main function is simple to laugh: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  Main (): <font color="#0000ff">void</font> { </li><li>  <font color="#0000ff">def</font> (instructions, initialState) = load_program ( <font color="#A31515">"bin1.obf"</font> );  <font color="#008000">// exception</font> </li><li></li><li>  <font color="#008000">// configure</font> </li><li>  vmi_set_problem (1001, initialState); </li><li>  def state = exec_one_cycle (instructions, initialState);  <font color="#008000">// exception</font> </li><li>  vmi_set_problem (0000, state); </li><li></li><li>  <font color="#008000">// since that we can read all data</font> </li><li>  <font color="#2B91AF">Console</font> .WriteLine ( <font color="#A31515">"x = {0}, fuel = {1}"</font> , </li><li>  vmi_get_x (state), vmi_get_fuel (state)); </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  In the first line (where def), a tuple of type PROGRAMM is broken into a stream and an initial state, which is returned by the procedure for loading a program from a binary file. <br>  Next, we set the option number (1001), perform one clock cycle, clear the option register (this is necessary) and output the initial state to the screen (vmi_set_problem doesn‚Äôt cause problems for the program, but rather sets the desired value on the configuration port) <br><br>  A function that performs 1 second of simulation time agreed to look like this: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  exec_one_cycle (program: <font color="#0000ff">list</font> [INSTR], fromState: OVMState): OVMState { </li><li>  <font color="#2B91AF">List</font> .FoldLeft ( </li><li>  program, <font color="#008000">// &lt;- whom?</font> </li><li>  fromState, <font color="#008000">// &lt;- why?</font>  <font color="#008000">(from what?)</font> </li><li>  <font color="#0000ff">fun</font> (instruction: INSTR, currState: OVMState) { <font color="#008000">// the client</font> executes <font color="#008000">each instruction</font> </li><li>  instruction (currState) </li><li>  } </li><li>  ) </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  As agreed, we do the convolution on the left.  FoldLeft is the standard library method for working with lists in Nemerle. <br>  Here, fun in the 5th line is not because I became particularly fun, but the construction of the Nemerle language, which defines an anonymous function ‚Äúby place‚Äù.  In principle, you can use the syntax of the delegate, but so clearer.  Slightly. <br>  Note that there is no <b>return</b> - the fact is that in Nemerle the last expression is what will be the value returned from the function. <br><br>  <sub>By the way, fun is also a macro from the Nemerle library;</sub>  <sub>it allows you to define a function and returns it immediately</sub> <br><br>  Of the unlighted, but important, remains the structure of OVMState.  We tear covers. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">class</font> OVMState </li><li>  { </li><li>  <font color="#0000ff">public</font> MEM: array [ <font color="#0000ff">double</font> ] = array (16384); </li><li>  <font color="#0000ff">public</font> OUTS: array [ <font color="#0000ff">double</font> ] = array (16384); </li><li>  <font color="#0000ff">public</font> INS: array [ <font color="#0000ff">double</font> ] = array (16384); </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">mutable</font> STATUS: <font color="#0000ff">bool</font> = <font color="#0000ff">false</font> ; </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  No magic.  One moment - if you want to have a variable in Nemerle, then you need to specify this explicitly (mutable).  By default, everything is readonly, out of harm's way. <br><br>  What do we have left?  The answer is loading the program, and converting bytecode to the list of functions (or rather, closures filled with the specific data of each instruction).  I think you already understand what will happen next. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  load_program (file: <font color="#0000ff">string</font> ): PROGRAMM </li><li></li><li>  <font color="#008000">// many bukaf are omitted well, almost without harm to the meaning</font> </li><li></li><li>  <font color="#008000">// do</font> </li><li>  <font color="#0000ff">using</font> (stream = <font color="#2B91AF">File</font> .OpenRead (file)) { </li><li>  <font color="#0000ff">def</font> frames = read_frames (stream); </li><li>  (load_instructions (frames), load_state (frames)) </li><li>  } </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  The input file (the specs say that it is divided into frames) is read by the frames, and decoded.  If you do not go into details about the presence of two types of bytecode (S and D) and so on. And so forth, the decoder for D, for example, will look like below: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#008000">/// decodes d-type instruction</font> </li><li>  <font color="#0000ff">def</font> decode_d_type (addr: <font color="#0000ff">int</font> , opcode: DOpCodes, r1: <font color="#0000ff">int</font> , r2: <font color="#0000ff">int</font> ): INSTR { </li><li>  <font color="#0000ff">match</font> (opcode) { </li><li>  |  DOpCodes. Add =&gt; make_add (addr, r1, r2); </li><li>  |  DOpCodes.Sub =&gt; make_sub (addr, r1, r2); </li><li>  |  DOpCodes.Mult =&gt; make_mult (addr, r1, r2); </li><li>  |  DOpCodes.Div =&gt; make_div (addr, r1, r2); </li><li>  |  DOpCodes.Phi =&gt; make_phi (addr, r1, r2); </li><li>  |  DOpCodes.Output =&gt; make_out (r1, r2); </li><li>  |  _ =&gt; <font color="#0000ff">throw</font> InvalidOperationException ();  <font color="#008000">// exception</font> </li><li>  } </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  For S-instructions - the same.  match is a pattern matching operation, a sort of advanced switch with powerful capabilities. <br><br>  The final touch - in fact, the designers themselves closures - ¬´make_bla_bla¬ª.  For example, the ‚Äúcreator‚Äù of the add instruction is the multiplication: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  make_add (addr: <font color="#0000ff">int</font> , r1: <font color="#0000ff">int</font> , r2: <font color="#0000ff">int</font> ): INSTR { </li><li>  <font color="#0000ff">fun</font> (s) { </li><li>  s.MEM [addr] = s.MEM [r1] + s.MEM [r2]; </li><li>  s </li><li>  } </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  Those.  we create a closure that can add two operands, and return the newly appeared instruction.  Please note that I have specified the types of the function, which is not necessary - Nemerle will display them on their own. <br><br><h4>  For a snack </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/b5f/548/fa1/b5f548fa101ea250c93014104e494ad4.png" align="right">  I missed a certain amount of the service code, but I hope the thought was clear - we design it top-down, in a procedural manner, which is simpler and simpler in simple tasks than a garden with OOP.  The hybrid OOP with the OP in Nemerle contributes to this, allowing you to focus on the task. <br><br>  Those who wish to practice with this OVM and steer the satellite can use the following tips: <br>  - smoke specs on icfp2009 <br>  - arrange OVM as a class, connect it to a project on CSharp, for example, and write a management strategy in it. <br><br>  All the code from the article and the rest, which was not given, but will be needed, is available on pastebin.org <a href="http://www.pastebin.org/7696">here</a> .  The rate of fire on a regular laptop (Core2Duo 2GHz) is ~ 30,000 simulation seconds per second (sim / sec), i.e.  it is possible to comfortably control the control algorithms. <br><br>  PS Something like that.  Enjoy your flight.  Wire from orbit, if that :) <br><br>  PPS I almost forgot.  Interest for implemented direct VM (selection + decoding of instructions at each step) in C # - about 24000 sim / sec came out.  Unfortunately, this does not mean that Nemerle is so fast (20% faster) - this means that in C # the operations on the bits used in the decoder are well optimized. </div><p>Source: <a href="https://habr.com/ru/post/66349/">https://habr.com/ru/post/66349/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../66341/index.html">Why Apple iTouch Tablet will be the flagship product</a></li>
<li><a href="../66342/index.html">RE: RE: done by 95% or "Journey from Moscow to Petersburg"</a></li>
<li><a href="../66345/index.html">Google Chrome Beta</a></li>
<li><a href="../66346/index.html">Output to Webmoney from Runner</a></li>
<li><a href="../66347/index.html">Interesting data on the audience of popular sites</a></li>
<li><a href="../66350/index.html">Overview of the Falcon engine in mySQL</a></li>
<li><a href="../66351/index.html">Stable IPTV broadcasting via VLC</a></li>
<li><a href="../66352/index.html">Chromium and a strange young man instead of a button to close</a></li>
<li><a href="../66355/index.html">ActionResult for all occasions</a></li>
<li><a href="../66356/index.html">Multidimensional Cubes, OLAP and MDX</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>