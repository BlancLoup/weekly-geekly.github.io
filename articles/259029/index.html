<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Samba4 - using Python Scripting Interface</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Samba4 has a built-in Python interface. Many utilities (samba-tool, for example) are fully implemented in Python using this interface. 

 Everything d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Samba4 - using Python Scripting Interface</h1><div class="post__text post__text-html js-mediator-article">  Samba4 has a built-in Python interface.  Many utilities (samba-tool, for example) are fully implemented in Python using this interface. <br><br>  Everything done from the LDAP interface can be done on Samba 4 Python Scripting.  The advantages are file access, which means high speed, some features that are not in LDAP.  For example, you can take a hash of user passwords from one database and transfer it to another.  Yes, and the users themselves with their SID-s, passwords and all the rest to transfer to another domain (without problems with SID-history). <br><a name="habracut"></a><br>  Documentation is not enough, but there are examples in the <i>&lt;samba-source&gt; / python / samba</i> directory, if there are sources, otherwise somewhere in <i>/usr/lib/python2.7/dist-packages/samba</i> . <br><br>  Of greatest interest is the samdb.py file - the implementation of most operations in AD. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Suppose we have installed Samba4 in the AD domain controller configuration.  Let's try to connect to the AD database from a Python program.  To get started, import the necessary libraries: <br><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- import ldb from samba.samdb import SamDB from samba.auth import system_session from samba.ndr import ndr_pack, ndr_unpack from samba.dcerpc import security import samba.param import base64 import binascii</span></span></code> </pre> <br>  Connect to the main base /sam.ldb: <br><br><pre> <code class="python hljs">lp = samba.param.LoadParm() lp.load(samba.param.default_path()) <span class="hljs-comment"><span class="hljs-comment"># lp.load("/etc/samba/smb.conf") sam = SamDB(lp=lp,session_info=system_session())</span></span></code> </pre><br>  (It is also possible to connect with a non-standard location of the files and directories of the Samba4 installation and even to a stand-alone time base. About this below.) <br><br>  Now the sam object allows you to search and modify the database AD in full accordance with the syntax of LDAP. <br>  For example, database search (base is an LDAP tree node of the type CN = Users, DC = myDom, DC = lan, expression is an optional selection condition, attrs is a list of desired attributes): <br><br><pre> <code class="python hljs">res = sam.search(base=base, expression=expression, attrs=[*])</code> </pre> <br>  Let users lie in the OS: <br><br><pre> <code class="python hljs">base = <span class="hljs-string"><span class="hljs-string">"OU=myUsers,DC=myDom,DC=lan"</span></span> <span class="hljs-comment"><span class="hljs-comment">#        base = "CN=Users,DC=myDom,DC=lan"</span></span></code> </pre> <br>  Create a user ‚Äútst‚Äù with the password ‚Äúsecret‚Äù.  The SamDB class has a ready-made method, newuser (), but you can try it like this: <br><br><pre> <code class="python hljs">newUsr = <span class="hljs-string"><span class="hljs-string">"tst"</span></span> usrPass = <span class="hljs-string"><span class="hljs-string">"secret"</span></span> ld = {<span class="hljs-string"><span class="hljs-string">'dn'</span></span>: <span class="hljs-string"><span class="hljs-string">'CN=%s,%s'</span></span> % (newUsr,base), <span class="hljs-string"><span class="hljs-string">"sAMAccountName"</span></span>: newUsr, <span class="hljs-string"><span class="hljs-string">"userPrincipalName"</span></span>: <span class="hljs-string"><span class="hljs-string">"%s@%s"</span></span> % (newUsr,<span class="hljs-string"><span class="hljs-string">"myDom.lan"</span></span>), <span class="hljs-string"><span class="hljs-string">"objectClass"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"displayName"</span></span>: newUsr, <span class="hljs-string"><span class="hljs-string">"description"</span></span>: newUsr, <span class="hljs-string"><span class="hljs-string">"homeDirectory"</span></span>: <span class="hljs-string"><span class="hljs-string">r"\\%s\users\%s"</span></span> % (<span class="hljs-string"><span class="hljs-string">"myHost"</span></span>,newUsr), <span class="hljs-string"><span class="hljs-string">'scriptPath'</span></span>: <span class="hljs-string"><span class="hljs-string">"loginScr.cmd"</span></span>, } sam.transaction_start() <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: sam.add(ld) sam.setpassword(<span class="hljs-string"><span class="hljs-string">"(samAccountName=%s)"</span></span> % ldb.binary_encode(newUsr), usrPass, <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: sam.transaction_cancel() <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">'!!!error'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: sam.transaction_commit()</code> </pre><br>  As you can see, SamDB supports transactions. <br><br>  The entire AD database, if it is not very large, can be viewed (and edited) with the command: <br><br><pre> <code class="bash hljs">:~<span class="hljs-comment"><span class="hljs-comment"># ldbedit -e nano -H /var/lib/samba/private/sam.ldb</span></span></code> </pre> <br>  But it is better to limit the selection with the option -s or -b (base), for example, <i>-b 'CN = RID Manager $, CN = System, DC = myDom, DC = com'</i> . <br><br>  Transferring password hashes can be done according to this scheme: <br><br>  Suppose we have an old AD database - also on Samba4.  You can get a replica of the database from Win AD by connecting a new Samba4 installation as an additional AD DC ‚Äî a well-documented and simple procedure ‚Äî see <a href="https://wiki.samba.org/index.php/Join_a_domain_as_a_DC">here</a> . <br><br>  Copy and connect to it - call the connection sam0.  Connection with non-standard paths (let it be copied to / tmp / priv and its smb.conf there): <br><br><pre> <code class="python hljs">lp0 = samba.param.LoadParm() lp0.load(<span class="hljs-string"><span class="hljs-string">'/tmp/priv/smb.conf'</span></span>) lp0.set(<span class="hljs-string"><span class="hljs-string">'private directory'</span></span>,<span class="hljs-string"><span class="hljs-string">'/tmp/priv'</span></span>) sam0 = SamDB(lp=lp0,session_info=system_session())</code> </pre><br>  To get the entire list of users, and with passwords, we will make the following request: <br><br><pre> <code class="python hljs">res = sam0.search(base=<span class="hljs-string"><span class="hljs-string">"DC=oldDom,DC=myDom,DC=ru"</span></span>,expression=<span class="hljs-string"><span class="hljs-string">"(&amp;(objectCategory=person)(objectClass=user))"</span></span>, attrs=[<span class="hljs-string"><span class="hljs-string">'*'</span></span>,<span class="hljs-string"><span class="hljs-string">'unicodePwd'</span></span>])</code> </pre> <br>  We will go through the user base and add them to the new database.  Schematically it looks like this: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> res: dn = str(r.dn)<span class="hljs-comment"><span class="hljs-comment">#   DN ,     .  ! ------- sd = ndr_unpack(security.dom_sid,r['objectSid'][0])#  SID ,     (dom_sid, rid) = sd.split()#  SID   SID   RID ------- #....         - sam.add(ld). (  - ) #    : setpw = """ dn: %s changetype: modify replace: unicodePwd unicodePwd:: %s """ % (dn, base64.b64encode(str(r['unicodePwd']))) sam.transaction_start() try: sam.modify_ldif(setpw,["local_oid:1.3.6.1.4.1.7165.4.3.12:0"]) except: sam.transaction_cancel() print( '!!! ERROR SET PASSWORD USER : %s' % r['sAMAccountName']) else: sam.transaction_commit()</span></span></code> </pre><br>  Now a real example of transferring users from a domain under Win 2003 to Samba4. <br><br>  There are problems in the old domain (starting even with the wrong domain name).  Normal replication from DC to Samba4 (in the opposite direction - Samba4 DC -&gt; W2003 DC) did not start up, probably due to intradomain problems. <br>  The task was burdened by the presence of a file server on Samba3, so you had to save the sAMAccountName &lt;-&gt; mapping (UID, GID) that already exists in Samba3 (usually <i>/var/lib/samba/winbindd_idmap.tdb</i> ).  Actually the task was similar to that described <a href="http://habrahabr.ru/post/216173/">here</a> . <br><br>  All experiments and the final version were done on Ubuntu 14.04 servers running in OpenVZ containers (CentOS 6) <br>  Installation, configuration Samba4 described many times.  For example, already mentioned, <a href="http://habrahabr.ru/post/216173/">here</a> .  For the normal display of the Unix ID in the scheme with rfc2307 sssd was used.  By the way, the Samba4 build from sernet, which many recommend, is better not to use - it is difficult to make friends with the sssd package. <br><br>  To save passwords and SID users, you must have the old database AD in the form of private directory Samba4, as mentioned above.  Skipping details (see <a href="https://wiki.samba.org/index.php/Join_a_domain_as_a_DC">here</a> ), ‚Äúsamba-tool domain join samdom.example.com DC -Uadministrator --realm = samdom.example.com‚Äù - you can stop at this without starting the samba service, since the necessary database has already been created .  If it is necessary to further update the database, then the launch of the samba service is indispensable. <br><br>  The impact on the existing Win AD domain is minimal (another controller is created, almost non-functional, so there will be many NTDS Replication errors in the logs), after creating an autonomous AD database, you can practice in virtual environments without any risk.  If the MS Win domain needs to work normally for some time, it is better to kill this temporary Samba4 and clean the information about this DC from the working DC. <br><br>  The resulting private directory (usually <i>/ var / lib / samba / private</i> or <i>/ usr / local / samba / private</i> ) must be copied somewhere to a future Samba4 and copy smb.conf from / etc / samba to the same place.  Now all data on the old domain is stored in one place and is also available in the local filesystem. <br><br>  If there is still a file server on Samba3, then somewhere alongside you should also put the <i>/ var / lib / samba</i> directory from Samba3 (2 files are needed there - winbindd_idmap.tdb and group_mapping.tdb), if we want to keep the current idmap in Samba3 . <br><br>  Initial parameters are designed as a conf.py file: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- smb_conf = '/etc/samba/smb.conf' smb_priv = '/var/lib/samba/private' dom0 = 'olddom.mydom.ru' #    dom1 = 'newdom.lan' #   . (!)  ,    -      host = 'newdc' #    maildom = 'mydom.ru' # .  #homeDirectory, homeDrive = r'\\newdc\Users','Z:' #  smb_priv0 = '/var/lib/samba/private-0' #private directory    samba4 (    smb.conf!) smb3db = '/var/lib/samba/samba3' #  -  3 ( /var/lib/samba ()),  None start_unix_id = 50000 #   GID  UID   . ############     d0, d1 = dom0.split('.'), dom1.split('.') base0 = ','.join(['DC='+x for x in d0]) base, dom, realm = ','.join(['DC='+x for x in d1]), d1[0].upper(), '.'.join(d1).upper()</span></span></code> </pre><br>  Let's collect the basic functions of transferring to one file <br><div class="spoiler">  <b class="spoiler_title">lib1.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- import sys import string import ldb from struct import unpack #from samba.idmap import IDmapDB from samba.samdb import SamDB from samba.auth import system_session from samba.ndr import ndr_unpack from samba.dcerpc import security import samba.param import base64 from conf import * def get_1out(cmd): # 1     import subprocess return subprocess.Popen(cmd, stdout=subprocess.PIPE).stdout.read().splitlines()[0] if not 'host' in globals(): host = get_1out('hostname').upper() if not 'smb3db' in globals(): smb3db = None my_log = lambda *x: None chgDc = lambda x: x def set_my_log(): #   -.   .   from datetime import datetime global my_log f_log = open(datetime.strftime(datetime.now(), "log_%y-%m-%d_%H:%M:%S.txt"),'w') def my_log(*x): try: xx = ' '.join(x) except: xx = ' '.join(map(lambda a: str(a),x)) f_log.write(xx+'\n') print xx def mk_chg(d0=d0,d1=d1): #  . d0,d1      . !!!: len(d0) &gt;= len(d1) import re global chgDc if d0 == d1: return dif = len(d0)-len(d1)+1 #      , ddx = [d0[0],] + d0[dif:] #     ,  ddx == d0 #1  , 2   , 3 .. : myRe = [('',re.compile(r'\b(DC=)?%s\b[,.]?' % x, re.I)) for x in d0[1:dif]] +\ [(b,re.compile(r'\b%s\b' % a)) for (a,b) in zip(ddx,d1)] +\ [(b.upper(),re.compile(r'\b%s\b' % a.upper(), re.I)) for (a,b) in zip(ddx,d1)] def chg(s): #    d0 -&gt; d1 for r in myRe: s = r[1].sub(r[0],s) return s chgDc = chg return chg def mk_sam0(smb_priv0=smb_priv0): #    . smb_priv0 - private directory   (    smb.conf!) import os global sam0 lp0 = samba.param.LoadParm() lp0.load(smb_priv0+'/smb.conf') # smb.conf     private directory!!! lp0.set('private directory',smb_priv0) sam0 = SamDB(lp=lp0,session_info=system_session()) os.unsetenv('SMB_CONF_PATH') return sam0 def mk_sam(host=host): #         global sam, ridSet, ridMan, sfu, idmap, minRid, nis lp = samba.param.LoadParm() lp.load(smb_conf) lp.set('private directory',smb_priv) sam = SamDB(lp=lp,session_info=system_session()) # idmap = IDmapDB(lp=lp) sfu = "CN=%s,CN=ypservers,CN=ypServ30,CN=RpcServices,CN=System,%s" % (dom,base) # dn  sfu (msSFU30OrderNumber...) ridSet = "CN=RID Set,CN=%s,OU=Domain Controllers,%s" % (host, base) # dn  rIDNextRID ridMan = "CN=RID Manager$,CN=System,"+base # dn  RID Manager if not 'minRid' in globals(): minRid = int(sam.search(base = ridSet, attrs=["rIDNextRID"])[0]["rIDNextRID"][0]) my_log('\tminRid=%s' % str(minRid)) if not 'nis' in globals(): nis = str(sam.search(base=sfu, attrs=['msSFU30Domains'])[0]['msSFU30Domains'][0]) sam.nis = nis return sam def get_map0(i=None, path=smb3db, maps = {}): #  sAMAccountName &lt;-&gt; UID   idmap smb3 -  maps if not maps: if path != None: from samba.samba3 import DbDatabase mapdb = DbDatabase(path+'/group_mapping') for x in mapdb.db.iterkeys(): if x.startswith('UNIXGROUP') : y = mapdb.db.get(x) maps[y[8:-2]] = ('GID',unpack('&lt;L',y[0:4])[0]) mapdb.close() mapdb = DbDatabase(path+'/winbindd_idmap') for x in mapdb.db.iterkeys(): if x.startswith('S-1'): y = mapdb.db.get(x) res = sam0.search(base=base0,expression="(objectSid=%s)" % x.rstrip("\x00"), scope=ldb.SCOPE_SUBTREE, attrs=["sAMAccountName"]) if len(res) &gt; 0 and 'sAMAccountName' in res[0]: maps[str(res[0]["sAMAccountName"][0])] = y.rstrip("\x00").split(" ") mapdb.close() else: #     idmap,       ID 'Domain Users' my_log('!? Not MAP0') maps['Domain Users'] = ['GID',start_unix_id] if 'sam' in globals(): res = sam.search(base=base,expression="(sAMAccountName=Domain Users)",attrs=['gidNumber']) if len(res) &gt; 0 and 'gidNumber' in res[0]: maps['Domain Users'][1] = int(res[0]['gidNumber'][0]) maps['_users'] = maps['Domain Users'][1] # .    my_log('Set Domain Users = %d' % maps['_users']) maps['Administrator'] = ('UID',0) maps['Administrators'] = ('GID',0) if i == None: return maps return maps[i] if i in maps else False def mk_fill_matrix(m,r): # helper    m  cp_usr()  cp_grp() def rp(k,chg=0): #  chg!=0 -   ! if k in r: m[k] = str(r[k][0]) if chg==0 else chgDc(str(r[k][0])) return rp def mk_fill_ldb_msg(dn): # helper      ldb.Message m2 m2 = ldb.Message() m2.dn = ldb.Dn(sam, str(dn)) def rp(fld=None,val='',flg=ldb.FLAG_MOD_REPLACE): if fld: m2[fld] = ldb.MessageElement(str(val), flg, fld) return m2 return rp def usn_sort(res): #    res    -     (ou, grp) x = [r for r in res] x.sort(key = lambda r: int(r["uSNCreated"][0])) return x def rid_sort(res): #    res   RID x = [r for r in res] x.sort(key = lambda r: int(unpack('&lt;I',r['objectSid'][0][-4:])[0])) return x def set_grp_gid(r,gid): # Unix GID   rp = mk_fill_ldb_msg(r.dn) rp("msSFU30NisDomain",nis) rp("msSFU30Name",r['sAMAccountName'][0]) rp("gidNumber",gid) sam.modify(rp()) def set_usr_gid_uid(r,uid): # Unix GID, UID   rp = mk_fill_ldb_msg(r.dn) rp("msSFU30NisDomain",nis) rp("uid",r['sAMAccountName'][0]) rp("uidNumber",uid) rp("gidNumber",get_map0('_users')) # rp('objectClass','posixAccount',ldb.FLAG_MOD_ADD) sam.modify(rp()) def map_grp(): #   GID  IdMap  Samba 3 res = sam.search(base=base,expression="(objectClass=group)") my_log( "\tmap_grp ALL GRP COUNT: %s" % len(res)) sam.transaction_start() try: for r in res: x = get_map0(str(r['sAMAccountName'][0])) if x: set_grp_gid(r,x[1]) except: sam.transaction_cancel() my_log( '!!! ERROR MAP GRP %s' % r['sAMAccountName']) else: sam.transaction_commit() def map_usr(): #   UID  IdMap  Samba 3 res = sam.search(base=base,expression="(&amp;(objectCategory=person)(objectClass=user))",attrs=["sAMAccountName"]) my_log( "\tmap_usr ALL USR COUNT: %s" % len(res)) sam.transaction_start() try: for r in res: x = get_map0(str(r['sAMAccountName'][0])) if x: set_usr_gid_uid(r,x[1]) except: sam.transaction_cancel() my_log( '!!! ERROR SET SFU30 ATTR. USER %s !!!' % x[1]) else: sam.transaction_commit() def cp_ou(): #  organizationalUnit ous = [str(r.dn) for r in sam.search(base=base,expression="(objectClass=organizationalUnit)", attrs=[])] res = sam0.search(base=base0,expression="(objectClass=organizationalUnit)") my_log( "\tOU COUNT: %s" % len(res)) for r in usn_sort(res): dn = chgDc(str(r.dn)) if not dn in ous: m = {"dn": dn, "objectClass": "organizationalUnit", "name": str(r["name"][0])} try: sam.add(m) except: my_log("!!!Error Add OU : %s" % dn) def cp_usr(): #   users = [str(r.dn) for r in sam.search(base=base,expression="(&amp;(objectCategory=person)(objectClass=user))", attrs=[])] res = sam0.search(base=base0,expression="(&amp;(objectCategory=person)(objectClass=user))", attrs=['*','unicodePwd']) my_log( "\tNEW USR COUNT: %s" % len(res)) for r in res: dn = chgDc(str(r.dn)) if dn in users: continue sd = ndr_unpack(security.dom_sid,r['objectSid'][0]) (group_dom_sid, rid) = sd.split() if rid &lt;= minRid: my_log( '!! MinRid ERR : ', r['sAMAccountName'][0] ) continue m = {"dn": dn, "objectClass": "user"} rp = mk_fill_matrix(m,r) rp('userPrincipalName',1) rp('sAMAccountName') rp('sn') rp('name') rp('initials') rp('displayName') rp('scriptPath') rp('description') rp('userAccountControl') rp('pwdLastSet') m["nTSecurityDescriptor"] = r['objectSid'] if 'maildom' in globals(): m["mail"] = "%s@%s" % (r['sAMAccountName'][0], maildom) if 'homeDirectory' in globals(): m["homeDirectory"] = r"%s\%s" % (homeDirectory,r['sAMAccountName'][0]) if 'homeDrive' in globals(): m["homeDrive"] = homeDrive sam.transaction_start() try: sam.add(m) except: sam.transaction_cancel() my_log( '!!! ERROR ADD USER : %s' % m['sAMAccountName']) else: sam.transaction_commit() # Copy the password for it if not 'unicodePwd' in r: my_log( '!!! NOT PASSWD FOR USER : %s' % m['sAMAccountName']) continue setpw = """ dn: %s changetype: modify replace: unicodePwd unicodePwd:: %s """ % (dn, base64.b64encode(str(r['unicodePwd']))) sam.transaction_start() try: sam.modify_ldif(setpw,["local_oid:1.3.6.1.4.1.7165.4.3.12:0"]) except: sam.transaction_cancel() my_log( '!!! ERROR SET PASSWORD USER : %s' % m['sAMAccountName']) else: sam.transaction_commit() def cp_grp(): #   grps = [str(r.dn) for r in sam.search(base=base,expression="(objectClass=group)", attrs=[])] res = sam0.search(base=base0,expression="(&amp;(objectClass=group)(objectCategory=Group))") my_log( "\tNEW GRP COUNT: %s" % len(res)) for r in usn_sort(res): dn = chgDc(str(r.dn)) if dn in grps: continue sd = ndr_unpack(security.dom_sid,r['objectSid'][0]) (group_dom_sid, rid) = sd.split() if rid &lt;= minRid: my_log( '!! MinRid ERR : ', r['name'][0] ) continue m = {"dn": dn, "objectClass": "group"} rp = mk_fill_matrix(m,r) rp('sAMAccountName') rp('groupType') rp('description') m["nTSecurityDescriptor"] = r['objectSid'] sam.transaction_start() try: sam.add(m) except: sam.transaction_cancel() my_log( '!!! ERROR add GRP %s !!!' % m['sAMAccountName']) else: sam.transaction_commit() def grp_fill(): #   my_log( "\tgrp_fill") grps ={} for r in sam.search(base=base,expression="(&amp;(objectClass=group)(objectCategory=Group))",attrs=['member']): grps[str(r.dn)] = r['member'] if 'member' in r else [] users = [str(r.dn) for r in sam.search(base=base,expression="(&amp;(objectCategory=person)(objectClass=user))", attrs=[])] for r in sam0.search(base=base0,expression="(&amp;(objectClass=group)(objectCategory=Group))",attrs=['member']): if not 'member' in r: continue grp = chgDc(str(r.dn)) if not grps.has_key(grp): my_log( "!!not found group:\t",grp) continue add_m = '' for m in r['member']: m = chgDc(m) if m in grps[grp]: continue if not m in users: try: sam.search(base=m, attrs=[]) except: my_log( "!? err (not found) add %s \tto %s" % (m,grp)) continue add_m += "add: member\nmember: %s\n" % (m) if add_m == '': continue add_m = "\ndn: %s\nchangetype: modify\n%s\n" % (grp,add_m) sam.transaction_start() try: sam.modify_ldif(add_m) except: sam.transaction_cancel() my_log( "!!!Error fill grp "+grp) else: sam.transaction_commit() def set_max_gid_uid(max_gid=start_unix_id, max_uid=start_unix_id): #  max GID, UID   my_log('set_max_gid_uid start: set max_gid=%s, max_uid=%s' % (max_gid, max_uid)) chg = '' r = sam.search(base=sfu)[0] for x in (['msSFU30MaxGidNumber',max_gid],['msSFU30MaxUidNumber',max_uid]): x[1] = max(x[1],start_unix_id) if not x[0] in r or x[1] &gt; int(r[x[0]][0]): chg += "replace: %s\n%s: %d\n" % (x[0],x[0],x[1]) if chg != '': chg = "\ndn: %s\nchangetype: modify\n%s\n" % (sfu,chg) sam.transaction_start() try: sam.modify_ldif(chg) except: sam.transaction_cancel() my_log( "!!!Error set msSFU30Max...") else: sam.transaction_commit() def get_next_uid(): #   UID   nm = 'msSFU30MaxUidNumber' r = sam.search(base=sfu)[0] x = start_unix_id if nm in r: x = max(x, int(r[nm][0])) sam.transaction_start() try: sam.modify_ldif("\ndn: %s\nchangetype: modify\nreplace: %s\n%s: %d\n" % (sfu,nm,nm,x+1)) except: sam.transaction_cancel() my_log( "!!!Error set msSFU30Max...") raise else: sam.transaction_commit() return x def set_max_id(): # max GID, UID,   ,   +1 max_gid = max([int(r['gidNumber'][0]) for r in sam.search(base=base,expression="(&amp;(objectClass=group)(gidNumber=*))",attrs=['gidNumber'])]+[0]) max_uid = max([int(r['uidNumber'][0]) for r in sam.search(base=base,expression="(&amp;(objectCategory=person)(objectClass=user)(uidNumber=*))",attrs=['uidNumber'])]+[0]) set_max_gid_uid(max_gid=max_gid+1,max_uid=max_uid+1) def check_id(): # . GID, UID   r = sam.search(base=sfu)[0] (max_gid,max_uid) = [int(r[x][0]) if x in r else start_unix_id for x in ('msSFU30MaxGidNumber','msSFU30MaxUidNumber')] my_log('check_id start: initial max_gid=%d, max_uid=%d' % (max_gid, max_uid)) sam.transaction_start() try: for r in rid_sort(sam.search(base=base,expression="(&amp;(objectClass=group)(!(gidNumber=*)))",attrs=['sAMAccountName','objectSid'])): set_grp_gid(r,max_gid) max_gid += 1 for r in usn_sort(sam.search(base=base,expression="(&amp;(objectCategory=person)(objectClass=user)(!(uidNumber=*)))",attrs=['sAMAccountName','uSNCreated'])): set_usr_gid_uid(r,max_uid) max_uid += 1 except: sam.transaction_cancel() my_log( '!!! ERROR check_id %s' % r['sAMAccountName']) else: sam.transaction_commit() set_max_gid_uid(max_gid=max_gid,max_uid=max_uid) def set_max_rid(): # max RID  ,   "RID Set"  "RID Manager" res = sam.search(base=base,expression="(&amp;(sAMAccountName=*)(objectSid=*))",attrs=["objectSid"]) my_log( "\tSID COUNT: %s" % len(res)) x = max([int(unpack('&lt;I',r['objectSid'][0][-4:])[0]) for r in res]) rmin = (x-100)/500*500+100 pool = rmin + ((rmin + 499) &lt;&lt; 32) my_log("\tRid Set: %d %d %d " % (rmin,x,rmin + 499)) m = mk_fill_ldb_msg(ridSet) m('rIDNextRID',x) m('rIDAllocationPool',pool) m('rIDPreviousAllocationPool',pool) m2 = mk_fill_ldb_msg(ridMan) m2('rIDAvailablePool',rmin + 500 + (1073741823 &lt;&lt; 32)) sam.transaction_start() try: sam.modify(m()) sam.modify(m2()) except: sam.transaction_cancel() my_log( '!!! ERROR Set rIDNextRID %s' % x) else: sam.transaction_commit() return x def mk_dom(): #     samba 4   SID,       administrator = "1" !!! from samba.netcmd.main import cmd_sambatool def cmd(args, subcom='domain'): cmd = cmd_sambatool() try: retval = cmd._run("samba-tool", subcom, *args) except SystemExit, e: retval = e.code except Exception, e: cmd.show_command_error(e) retval = 1 if retval: sys.exit(retval) cmd(('provision', '--host-name=%s' % host, '--realm=%s' % realm, '--domain=%s' % dom, '--domain-sid=%s' % get_1out('./get_dom_sid.py'), '--adminpass=UJHkjhm7KH$$2vrXy', '--function-level=2003', '--server-role=dc', '--use-rfc2307', '--dns-backend=SAMBA_INTERNAL')) cmd(('passwordsettings', 'set', '--complexity=off', '--history-length=0', '--min-pwd-length=0', '--min-pwd-age=0', '--max-pwd-age=0')) cmd(('setpassword', 'administrator', '--newpassword=1'),subcom='user') #    1.     !!</span></span></code> </pre><br>  Here there is a call to get_dom_sid.py as an external program in the mk_dom () function - initialization of a new domain. <br>  get_dom_sid.py just prints the old domain sid: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python from lib1 import mk_sam0 print mk_sam0().domain_sid</span></span></code> </pre><br>  So I had to do this, because when connecting to the database of the old domain in the same stream as creating the new one, the environment variables were replaced with old data. <br></div></div><br><br>  So, after all the necessary packages are installed (samba4, sssd and dependencies), the directories of the old databases are copied to the right places, we can start creating a new domain. <br><br>  Domain initialization - start mk_dom.py: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- from lib1 import * set_my_log() mk_dom()</span></span></code> </pre><br>  If everything went well (the log file is named log_% y-% m-% d_% H:% M:% S.txt) we look at smb.conf, temporarily add it to the [global] section <br>  dns forwarder = &lt;address of the old DC&gt; (at the time of transferring workstations to a new domain). <br><br>  Copy krb5.conf from / var / lib / samba / private to / etc (or make a symbolic link).  Next, run the script to copy objects from the old domain cp_dom.py: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- from lib1 import * set_my_log() my_log(base0,' -&gt;',base, dom, realm) mk_chg() #    mk_sam0() #    mk_sam() #    cp_ou() # organizationalUnit cp_grp() #  cp_usr() #  grp_fill() #   get_map0() #   sAMAccountName &lt;-&gt; UID (   idmap Samba3) map_grp() # unix GID   map_usr() # unix GID, UID   set_max_rid() # max RID  ,   "RID Set"  "RID Manager" set_max_id() # max GID, UID,   ,   +1   check_id() #  GID, UID  </span></span></code> </pre><br>  Inevitably, there are errors in the log file.  The most serious - with three signs "!"  in front.  Type: <br>  <i>!!!</i>  <i>ERROR ADD USER: 5CA6ADDF-A2C8-46E5-A</i> <i><br></i>  <i>!!!</i>  <i>ERROR SET PASSWORD USER: 5CA6ADDF-A2C8-46E5-A</i> <br>  Most often these are objects that are missing in the current scheme and are essentially unnecessary.  If there were users in the domain from another domain of the forest, adding them will not work either and will get into the log.  Type errors are <i>irrelevant !!</i>  <i>MinRid ERR: DCOM Users</i> <br><br>  If everything is tolerable, start Samba: <br><br><pre> <code class="bash hljs">start samba-ad-dc</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">A little bit about sssd settings</b> <div class="spoiler_text">  Described in detail <a href="https://wiki.samba.org/index.php/Local_user_management_and_authentication/sssd">here</a> (Method 1: Connecting to AD via Kerberos). <br>  Cooking kerberos for sssd: <br><br><pre> <code class="bash hljs">samba-tool domain exportkeytab /etc/krb5.sssd.keytab --principal=&lt;myHostName&gt;$ chown root:root /etc/krb5.sssd.keytab chmod 600 /etc/krb5.sssd.keytab</code> </pre><br>  File /etc/sssd/sssd.conf: <br><br><pre> <code class="hljs swift">[sssd] services = nss, pam config_file_version = <span class="hljs-number"><span class="hljs-number">2</span></span> domains = newdom.lan [nss] [pam] [domain/newdom.lan] id_provider = ad auth_provider = ad ldap_schema = ad krb5_keytab = /etc/krb5.sssd.keytab access_provider = ad ldap_id_mapping=<span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-built_in"><span class="hljs-built_in">enumerate</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre><br>  Reset sssd cache: <br><br><pre> <code class="bash hljs">sss_cache -GU</code> </pre> <br>  Restart sssd: <br><br><pre> <code class="bash hljs">restart sssd</code> </pre> <br>  By the way, resetting the sssd cache may not help with large AD changes.  Then, with sssd stopped, remove the directory from / var / lib / sss / and restore their empty structure (from the installation package). <br></div></div><br>  We check the display of users and groups (the sssd database is filled for a while): <br><br><pre> <code class="bash hljs">getent passwd getent group</code> </pre> <br>  The easiest way to drag users is the <i>netdom.exe</i> utility (netdom.exe move /?), Adding it to the logon script on the old server.  Only it is necessary to start the version of <i>netdom.exe</i> suitable for OS.  Since the SID, GID, UID, and user passwords are saved, the movement is almost transparent to users ‚Äî local folders remain with them, network resources too.  You just need to rename the domain in the Samba file server configuration. <br><br>  It was even simpler for me - since all this zoo lived under OpenVZ, the network resource on a separate file system was easily mounted to different file servers at the same time (you can also make DC a file server - normal), and access problems were automatically resolved by matching GID and UID. <br><br>  Group Policy objects were not transferred to the new domain. </div><p>Source: <a href="https://habr.com/ru/post/259029/">https://habr.com/ru/post/259029/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259017/index.html">Blood vessel segmentation</a></li>
<li><a href="../259021/index.html">How I reduced the Docker image by 98.8% with fanotify</a></li>
<li><a href="../259023/index.html">Fedora 22 - all trends in one build</a></li>
<li><a href="../259025/index.html">Web-based Crona</a></li>
<li><a href="../259027/index.html">InGaAs Semiconductor as an Alternative to Silicon</a></li>
<li><a href="../259031/index.html">Double dispatch</a></li>
<li><a href="../259033/index.html">Through the hardships of PC development</a></li>
<li><a href="../259035/index.html">Text Analytics as Commodity: Text Analytics Application Overview</a></li>
<li><a href="../259041/index.html">How to make a small contest in one day</a></li>
<li><a href="../259047/index.html">OWASP TOP-10: a practical look at web application security: # 1 - injections</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>