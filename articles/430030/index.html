<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How do we replace a sports scout with a neural network</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Yes, indeed, we were able to replace the sports scout's neural network and began to automatically collect data about the game. And now we know about t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How do we replace a sports scout with a neural network</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/zt/ud/_r/ztud_rxsshccb2jigzmixrjiud4.jpeg"><br>  Yes, indeed, we were able to replace the sports scout's neural network and began to automatically collect data about the game.  And now we know about the sporting competition more of the audience present, and sometimes the judge. <br><a name="habracut"></a><br>  We ( <a href="https://const.tech/">Constanta</a> ) specialize in developing bookmaker IT products: mobile applications, websites and, more recently, we are developing projects in the field of computer vision and machine learning.  About one of them will be discussed. <br><br>  While athletes are fighting for big and small victories, the bookmaker needs to know the course of events in real time in order to recalculate the coefficients for which the bets are actually taken.  For this, sports scouts collect and transfer a large amount of data using a special application on a smartphone directly on the playing fields.  A scout is the same person as all of us, therefore the risks associated with the human factor naturally occur.  Our goal is to minimize them, at the same time increasing the volume and efficiency of data collection and transmission, plus - to reduce the cost of all this work.  A small ball flies over a tennis table or a ball across a football field - the technical side of implementing a computer vision system for data collection has no conceptual differences.  We decided that it was more interesting to immediately build a system for a game with a large number of interacting balls, as in billiards. <br><br><img src="https://habrastorage.org/webt/qg/hd/yn/qghdynncjpu6vpd5ghocwiifhl0.jpeg"><br>  <i>I need the coordinates and speeds of all your balls and your cue.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Note that in the analysis of many sports games to correctly determine the result, it is necessary to accurately trace the chain of events.  This implies high requirements for the reliability of the components responsible for determining these events.  Let us explain with a simple example: if in billiards, on average, players roll all balls into pockets for 20 shots, then, with a reliable determination of the outcome of a strike, the probability of determining the winner in a rally is only about 82% (0.99 <sup>20</sup> ‚âà 0.817).  The match lasts up to five wins for one of the players, that is, there are only 5 to 9 draws, an average of 7. Thus, on average, with such reliability of determining events, the correct match result is obtained with only about 24% probability (0.817 <sup>7</sup> ‚âà0, 24).  But initially the probability of error was only 1%! <br><br><h2>  Pool Nine </h2><br>  Of the variety of billiard games, consider Pool-9.  In the rally, the player who wins the ball with the number 9 in the pocket wins.  Initially, the "nine" is located in the center of the rhombus of colored balls.  The object ball, which the cue ball should hit, is the ball with the lowest number on the table.  If a player failed to score a single colored ball as a result of a strike or committed a foul, for example, did not hit the aiming ball or scored the cue ball in the pocket, the move goes to the opponent.  To correctly score a point, it is necessary to determine whether balls hit the pockets and all events leading to a player change. <br><br><h2>  Computer vision </h2><br>  First, let's talk about how the neural network receives data.  The input information flow is a video broadcast from a single camera located above the table and shooting at 60 frames per second. <br><br><img src="https://habrastorage.org/webt/ax/cn/l1/axcnl1zhzdougqtqwpznd3qxuo4.jpeg"><br>  <i>An example of a video stream frame processed by the system.</i> <br><br>  The key stage of video stream processing by a neural network is semantic segmentation.  This is a classic computer vision problem, which consists in the fact that the algorithm must assign image pixels to one or several classes.  Simply put, video frames need to determine what is which.  The neural network produces ‚Äúmasks‚Äù, highlighting pixels related, for example, to a ball or a player.  Having passed through a series of post-processing algorithms, the ‚Äúmask‚Äù of the balls turns into coordinates.  After smoothing them, the filter for each ball determines the speed and trajectory of motion.  At this stage, low-level, or intermediate, events are tracked, such as collisions of balls between themselves and with the sides of the table.  The received data is sent to the rule processing module, which implements the entire logic of the game.  In the end, it gives out to the final consumer, i.e.  bookmaker, high-level events: blocking balls in pockets, fouls, transitions of moves and, in fact, the result of the game. <br><br><img src="https://habrastorage.org/webt/ma/gj/32/magj32uxedtpgtk94cfgxvbw0rq.jpeg"><br>  <i>The general scheme of the system.</i> <br><br>  To solve the problem, it is first necessary to find the location of the table on the frame and all the balls on it.  Another important participant in the action is the cue; it is he who determines the direction of the strike and, accordingly, the movement trajectory of the cue ball.  Players lean over the table, partially closing it from the camera.  From the point of view of the analysis of the game, they are ‚Äúforeign objects‚Äù, as well as a stand for balls, as well as mobile phones, gloves, napkins and other things that, at the behest of the players, appear on the sides of the table.  Thus, there are several target classes for semantic image segmentation: the table, its sides, pockets, cue, foreign objects and, of course, balls.  In addition, each ball is represented by a separate class, depending on its color. <br><br>  For semantic segmentation, a fully convolutional neural network with <a href="https://arxiv.org/abs/1707.03718">LinkNet-34</a> architecture is <a href="https://arxiv.org/abs/1707.03718">used</a> .  It works relatively quickly and has established itself well in various ‚Äúcombat‚Äù tasks of computer vision contests.  To determine the above-mentioned set of classes, only one neural network is used, which solves all the tasks of computer vision. <br><br><img src="https://habrastorage.org/webt/nz/qo/zg/nzqozgkrkq1mpwseqbycmzdde9g.png"><br>  <i>LinkNet-34 network architecture (see <a href="https://arxiv.org/abs/1803.01207v1">arXiv</a> ).</i> <br><br>  Images are fed to the input, and the output is a stack of ‚Äúmasks‚Äù of all the required classes.  ‚ÄúPrediction masks‚Äù are two-dimensional arrays of numbers with values ‚Äã‚Äãfrom 0 to 1. The size of each element of the ‚Äúmask‚Äù corresponds to the network's confidence that the corresponding pixel belongs to the class of this ‚Äúmask‚Äù.  For the final pixel classification, the predictions obtained are binarized by a threshold filter. <br><br>  To teach a neural network to classify pixels on a large number of examples with appropriate ‚Äúmasks‚Äù.  To do this, we collected a lot of videos, divided into frames, and the markup department manually prepared ‚Äúmasks‚Äù for them.  In complex cases, additional data sets were required.  For example, when a ball ‚Äúdives‚Äù into a pocket or stands near it next to the board of a table, a shadow falls on it, due to which the colors look different.  Or, when a player breaks a diamond, the balls fly quickly along difficult trajectories, due to which their images are smeared.  If the neural network ‚Äúsaw‚Äù few such examples, the correct classification would be difficult. <br><br><img src="https://habrastorage.org/webt/m0/ve/fc/m0vefc1lfwo2epmmwyx7jemomsq.jpeg"><br>  <i>An example of an image and its corresponding markup.</i>  <i>The task of the neural network is to obtain such ‚Äúmasks‚Äù from the input image.</i> <br><br><h2>  Fast, faster, even faster ... </h2><br>  The final data consumer needs information in real time (and even better, faster rial time).  Several techniques have been used to speed up the neural network, such as combining batch normalization with 2D convolution (BatchNorm Fusion), which makes it possible to obtain an equivalent network without several layers.  A good result is also provided by the preparation and loading of a new frame in parallel with the processing of the previous one on the video card.  In addition, gpu performs part of the preparatory operations with frames and post-processing of ‚Äúmasks‚Äù.  Even a simple idea helped to reduce the total time for processing each frame - transferring the result of the network from a video card to RAM after binarization in the form of uint8 instead of float32 received from the network. <br><br>  As a result, the semantic segmentation of one frame with all the required pre- and post-processing takes on average only 17 ms!  And for the operation of the system, only one gaming video card is sufficient. <br><br><h2>  Was there a collision? </h2><br>  We define the coordinates of the balls by ‚Äúmasks‚Äù, but first we need to exclude what only resembles a ball, for example, round stripes on players' T-shirts.  Here heuristics come into play: the shape and size of the balls, their position relative to the past, well-known, are checked.  Further, if everything is in order with the ‚Äúmask‚Äù, its centroid is taken for processing. <br><br><img src="https://habrastorage.org/webt/vv/fo/sa/vvfosa3jtfm-6zlnedm7qva2sh4.jpeg"><br>  <i>Billiards player in scary dreams of developers.</i> <br><br>  At first glance, it is strange, but the fact is that the result of determining the position of the balls may differ between frames, even with fixed balls.  The explanation is simple - ‚Äúnoise‚Äù of the real video, compression artifacts of the video stream, which, together with the error in determining the position of blurred images of moving balls, leads to the need to smooth the results. <br><br>  According to the coordinates of the balls received from the network and defined in the previous frames, the velocity is estimated as a numerical derivative.  The number of points taken into account and the interval between them are selected adaptively in the process of the system, depending on the availability of data and events such as collisions.  Then information about the position and velocity of the balls is sent to the sigma-point <a href="https://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D0%259A%25D0%25B0%25D0%25BB%25D0%25BC%25D0%25B0%25D0%25BD%25D0%25B0">Kalman filter</a> .  It allows you to smooth out noisy data, which is especially important for determining the speed and its direction.  In addition, the result of the dynamic model of it can be used to predict the near future. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0fc/a2c/436/0fca2c43659097233268d665c93058a1.gif"><br>  <i>Demonstration of smoothing the determination of the position and velocity of balls by a Kalman filter.</i> <i><br></i>  <i><b>Left:</b> Raw: the result of direct measurement, the vectors of the balls correspond to the speed, the numbers indicate the estimate of the speed;</i>  <i>UKF: the result of the filter.</i> <i><br></i>  <i><b>Right:</b> an example of smoothing the direction of the velocity of the ball with a Kalman filter.</i>  <i>The blue color shows the measurement results, the red one - the result of filtering.</i>  <i>The sharp jumps of the direction correspond to the collisions of the ball.</i> <br><br>  The data on the state and trajectory of the balls allows us to determine the onset of the so-called low-level event, even when it fell ‚Äúbetween frames‚Äù. <br><br><img src="https://habrastorage.org/webt/y9/gt/m6/y9gtm61shyfy70r-9nhwibikhvo.jpeg"><br><br>  The balls move so fast during the impact that there is often no frame in which the event itself is visible, for example, a collision of balls.  Therefore, for all types of interactions (collision of balls between themselves, with the board or hitting the hole), a list of possible events is first constructed.  There are two criteria here.  First, the critically close mutual arrangement of the balls.  When moving slowly, a large relative error in determining the speed and trajectory occurs, therefore the distance between the interacting objects is important.  Secondly, at a high speed of movement of the balls, possible events are determined by the intersection of the trajectories obtained from the dynamic model.  This approach gives a very nice bonus: the ability to predict in advance the likely ball hit in a pocket. <br><br><img src="https://habrastorage.org/webt/aa/mn/av/aamnavf_fqqqxjflsw0hqwvz1-4.png"><br>  <i>Sequential frames of a video stream at the initial break of a diamond of balls.</i>  <i>Without a model describing the trajectories of the balls, it is difficult to determine which ball the cue-ball collided with.</i> <br><br>  A change in the direction and magnitude of the velocity vector makes it possible to judge that the event, namely the collision, has occurred.  In the case when the ball rolled into the pocket, it ‚Äúdisappears‚Äù.  But there is an important point: it is necessary to use the data on its trajectory and check that the ball was just scored, and did not disappear from the camera‚Äôs view of the player‚Äôs hand or some other object. <br><br>  And if something went wrong?  For example, some of the events were due to the loss of a frame or a player figure hanging over the table.  Such omissions are critical to game logic.  It is saved by a heuristic auto-correction system that increases the stability of the system.  For example, if a hit on the cue ball is determined and the object ball falls into the pocket, but no collisions of the cue ball are recorded and the other balls remain motionless, it is logical to add a collision of the cue ball with the object ball. <br><br><h2>  So we play or not? </h2><br>  The balls roll, collide, fall into the pockets ... Is the game really going at that moment?  Or, on the contrary, everything on the table seems unshakable ... So the game has stopped?  The correct answer to these questions is probably as important as the definition of collisions.  When a player prepares to strike, ponders it, aims, there is no movement.  But it happens and vice versa, in non-playing moments life on the table can go quite dynamically: balls scored are moved from one pocket to another, the cue ball can roll on the table when it is installed after the foul, and this is done including the tip of the cue (very much like a blow! ).  If the end of the current strike can be easily determined - after a correct strike all the balls stop moving, then with the start everything is not so clear.  Of course, you can train a neural network to detect events in the video, including real cue strikes.  And you can make a set of heuristics that analyze the position and angle of the cue, the trajectory and speed of its ends and the cue-ball trajectory after the intended impact.  We went the second way, and the result was a very fast and reliable algorithm that determines the current state of the game. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/72c/2e2/780/72c2e27808d8e45a89cce95c6997e475.gif"><br>  <i>The system is trying to understand whether the game has started or not.</i> <br><br><h2>  And who won in the end? </h2><br>  All data about low-level events (hitting the cue ball, position and collision of balls, falling into pockets) is sent to the module, which, according to their sequence, determines that a foul or correct ball fall into a pocket, a transition or an end to the game has occurred.  The unbiased module keeps score and announces the winner.  Its peculiarity is that it works without any auto-corrections and heuristics, just formally applying the rules of the game.  The block with the rules can be completely replaced, which makes it possible to adapt it to the local tournament rules or to use other types of billiard games without significant intervention in the system. <br>  As unmanned vehicles have not yet completely got rid of a test engineer in the cabin, who monitors safety, so our rule module allows external manual control through a web interface.  Intervention may be required if the automatic system fails.  In addition, manual input of data that is absent in the video stream is required: a novice player, special hits that are announced during a voice game, etc.  One person can potentially watch several games at the same time. <br><br><h2>  How it works </h2><br>  After successfully launching and setting up the system, we not only began to receive the required data, but moreover we found a lot of interesting things.  So, sometimes the judge, being at the table, cannot precisely determine whether the cue-ball got on the aiming ball or on another, standing nearby.  While the objective view of our system allows us to see how the situation actually developed.  In addition, the system collects a lot of useful information for further analysis that a person is simply not able to determine and transmit in real time: the position and speed of the balls, the parameters of the cue strikes by each of the players. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0fc/597/d67/0fc597d67de6a85ab650db9a6b64bc85.gif"><br>  Currently, the system works and is used by the bookmaker.  In the future, it is planned to improve the system, including the addition of automatic identification of players, automatic determination of the results of the first strike. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/KfQTzod34JE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <i>Technical visualization of how the system works.</i>  <i>The ball near the ‚ÄúCue ball‚Äù refers to which first ball the cue ball encountered;</i>  <i>‚ÄúState‚Äù - the state of the system: there may be a ‚Äúwait‚Äù - until the player has hit and ‚Äúplay‚Äù - while the balls are in motion;</i>  <i>‚ÄúPlayer‚Äù is the current player;</i>  <i>the numbers around the balls indicate the velocity in cm / s.</i> </div><p>Source: <a href="https://habr.com/ru/post/430030/">https://habr.com/ru/post/430030/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../430010/index.html">Open lesson "How not to: anti-examples in the analysis of business processes"</a></li>
<li><a href="../430016/index.html">Embarrassed scientists admit that they still do not know the exact value of the gravitational interaction.</a></li>
<li><a href="../430024/index.html">How a plane crash can improve analysis of IT packs</a></li>
<li><a href="../430026/index.html">Nio places 18 battery change stations covering more than 2,000 km of motorways.</a></li>
<li><a href="../430028/index.html">10 upcoming conferences and hackathons in Moscow</a></li>
<li><a href="../430032/index.html">Google Registry Domain Name Registrar and New gTLDs</a></li>
<li><a href="../430034/index.html">How Yandex crowdsourcing platform helps teach Alice and save money</a></li>
<li><a href="../430036/index.html">Publishers have offered Yandex cooperation in protecting digital books</a></li>
<li><a href="../430040/index.html">PostgreSQL syntax highlighting</a></li>
<li><a href="../430042/index.html">Thieves and geeks: Russian and Chinese hacking communities</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>