<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About mass addition of monitoring objects in Zabbix</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I somehow got up in front of me and my colleague a simple, in essence, task - to put under monitoring Zabbix with about half a thousand identical term...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About mass addition of monitoring objects in Zabbix</h1><div class="post__text post__text-html js-mediator-article">  I somehow got up in front of me and my colleague a simple, in essence, task - to put under monitoring Zabbix with about half a thousand identical terminals running Linux, scattered throughout the country.  The terminals belonged to the same network - 10.0.0.0/8.  It would seem that the problem is completely trivial.  In fact, to bungle a template, start auto-detection and all the found hosts automatically add to the group and roll this template on them.  Simply tea from the bag brew.  Rolling up our sleeves, we got down to business ... <br><a name="habracut"></a><br><h4>  Problem birth </h4><br>  In general, nothing happened (in full accordance with the laws of the genre).  We made a template, started autodiscovery and went to a cultural vacation, because it was on Friday.  Returning on Monday, we discovered that over the weekend, our Zabbix ‚Äúautodetect‚Äù is just one host.  Having grieved to this, we began to reflect on the reasons.  And then a simple thought struck us - what is the class A subnet, in fact? <br><br>  Calculator helpfully podkazal that the class A subnetwork contains almost 17 million hosts.  Further, our electronic accountant clarified that if Zabbix spends 3 seconds on disassemblies with a single address (lags in the network, the survey is obviously not our customers, etc.), then it will take him something around a year and a half to bypass the class A subnet.  On one bypass, I emphasize.  This process can be carried out in parallel - for example, checking addresses in batches of 20 pieces each.  But even in this case, one round of the class A subnet will take about a month.  It is obvious that one bypass is not enough - our terminal can be turned off or unavailable at the very moment when Zabbix tries to interrogate it, which means that, for loyalty, it will be necessary to go through the network three or four times more.  In general, we suddenly realized that regular Zabbix autodetection tools work in the normal mode, but they are absolutely not designed for examining large networks. <br><br><h4>  What to do?  ¬© Chernyshevsky </h4><br>  Add hosts in Zabbix by hand?  This meant recognizing shameful surrender in the face of a simple, in essence, problem. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The Internet prompted us that we were not the first to encounter such a task.  <a href="http://www.zabbix.com/forum/showthread.php%3Ft%3D16332">At the official forum Zabbix</a> asked a similar question.  And they got the traditional, alas, answer for this kind of forums - the proposal of the most complex and inefficient way.  Since there was no time to study the Zabbix API, we decided to try our luck again with the database. <br><br><h4>  Algorithm of the decision </h4><br>  The Zabbix database has a table that lists all monitored hosts with their parameters - the hosts table.  In addition, each host in this table corresponds to a unique identifier - an integer.  At the same time, there are not so many parameters for setting the host to control - its identifier in the database, its IP and its name in Zabbix. <br><br>  The approach is simple - first, we find out which index on the database has the most recently added host: <br> <code>select hostid from zabbix.hosts order by hostid desc limit 1;</code> <br>  Hereinafter, queries are given for MySQL, which, in principle, does not affect the essence.  Increase the resulting value by one - ready index on the database for the new host.  We know the host name and its IP address, respectively, we can add a host in Zabbix: <br> <code>insert into zabbix.hosts (hostid,host,useip,ip) values ($hostid,$hostname,1,$IP);</code> <br>  Wherein: <br><ul><li>  $ hostid - a new database index obtained by us earlier; </li><li>  $ hostname is the name of the host; </li><li>  $ IP is his IP address. </li></ul><br>  The above query was made under the assumption that we control the hosts by their address, and not by their DNS name.  However, for this second option, the request will not fundamentally change - only a new field will be added. <br><br>  So, the host is added, but this is not enough - each host must belong to some group.  And this can also be done directly in the database.  Suppose for definiteness that we want to push our terminals into the Linux servers group. <br><br>  All groups in the database are stored in the groups table (trivial, isn't it?).  We will need our group index, which we can find out with a simple query: <br> <code>select groupid from zabbix.groups where name='Linux servers';</code> <br>  To account for the accessory of hosts to groups in the database there is a special table - hosts_groups.  Simple correspondences are stored in this table - a group with an index such and such corresponds to a group with an index such and such.  There are exactly as many matches for each host as there are groups in this host.  And each match, as usual, is assigned a unique index - an integer.  Find out the index of the last match: <br> <code>select hostgroupid from zabbix.hosts_groups order by hostgroupid desc limit 1;</code> <br>  Increasing the resulting value by one - this is the new matching index for our newly added host.  We know the host index, the group index was found out - what prevents us from adding a host to the group? <br> <code>insert into zabbix.hosts_groups (hostgroupid,hostid,groupid) values ($hostgroupid,$hostid,$groupid);</code> <br>  Wherein: <br><ul><li>  $ hostgroupid - new mapping index; </li><li>  $ hostid - index of our new host (we used it above to add the host itself); </li><li>  $ groupid - the index of the group we need (we figured it out above). </li></ul><br>  After all these manipulations, we can look at the Zabbix web interface and find our host in the Linux servers group.  Looking at its parameters, we see that sensors are not associated with a given host, triggers and graphics - there is a host, Zabbix knows about it but does not control it, because no data item has been specified.  We apply to this host a pre-created template and - it's in the bag!  Zabbix independently puts sensors and triggers on our host and starts monitoring. <br><br>  As a result, our problem is solved by a combined approach: <br><ol><li>  database manipulations add all our terminals to Zabbix; </li><li>  using the mass update host function, we attach the corresponding template to the added terminals. </li></ol><br><br>  PS Around in the article the name of the host means the very name by which this host appears in Zabbix.  And it is not related to the DNS-name of the host (although no one bothers them to match).  If you are using a monitoring agent, then the host name is the value of the hostname in its configuration file. <br><br><h4>  Instead of epilogue </h4><br>  The failure of previous generations to manipulate the database, quite obviously, lies in the fact that matching a template to a host in a database is not the same as applying this template from the Zabbix interface.  Obviously, the application of the template creates mappings between the host and sensors, the host and triggers, etc., and the structure of these tables is already becoming too complex. <br><br>  I do not bring here a ready script.  First, because I don‚Äôt have it - the practical part was done by my Perl colleague by parsing a text file with names and IP terminals and creating an SQL script from them.  I would do everything in Ruby, most likely.  Another colleague of mine said that an ordinary shell script would suffice here with ears.  However, the algorithm is simple and can be implemented as you please. <br><br>  And finally ... When we added our terminals, we did not take into account one thing - for Zabbix, the number of monitored sensors suddenly increased from 80 to 4000. The poor animal was stupid from such a turn of events and collapsed.  Therefore, I recommend to disable Zabbix hosts before such a massive addition, at least for reasons of humanity.  And, of course, after adding and applying the Zabbix template, it will take some time to realize and digest the heap of objects under its control, so be patient.  However, this time is by every order less than the time required to bypass the class A subnet. </div><p>Source: <a href="https://habr.com/ru/post/133933/">https://habr.com/ru/post/133933/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../133925/index.html">The best things 2.0</a></li>
<li><a href="../133926/index.html">Correct badge for IT conference</a></li>
<li><a href="../133927/index.html">Apotheosis of copywriting or the beginning of the end of YouTube</a></li>
<li><a href="../133930/index.html">Operation Robin Hood: the redistribution of global finance in favor of 99%</a></li>
<li><a href="../133931/index.html">Introduction to Ruby / Tk. Part one</a></li>
<li><a href="../133934/index.html">Experience creating a distributed office</a></li>
<li><a href="../133935/index.html">ExtJS / Rails CRUD application in 7 minutes</a></li>
<li><a href="../133936/index.html">Solving the problem of installing Openfire on CentOS 64-bit</a></li>
<li><a href="../133938/index.html">Windows 8: New Sidebar and App Store Interface</a></li>
<li><a href="../133939/index.html">LLVM 3.0 Release</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>