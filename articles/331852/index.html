<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Browser online game development</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, habrovchane. My name is Eugene, by profession I am a backend developer and I write in c # in the segment of enterprise applications. In this publi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Browser online game development</h1><div class="post__text post__text-html js-mediator-article">  Hi, habrovchane.  My name is Eugene, by profession I am a backend developer and I write in <b>c #</b> in the segment of enterprise applications.  In this publication, I want to tell you about my experience in a field that is not quite relevant for me - the development of video games, and more specifically, about the development of a browser-based online game. <br><br>  I'm used to referring myself to those lucky people whose hobbies coincide with work - I love software development.  Therefore, it is absolutely normal for me, after returning home, to sit at the computer again, open Visual Studio and continue to develop something ‚Äî I do not need a rest from this activity.  There is only one problem - I need a project that interests me and that I could manage alone in my free time - in the evenings and on weekends. <br><br>  About a year ago, I was shown a fairly popular browser-based online game - sliterio.  After reading, I had an obsession - I wanted to do something similar in approach, but with a little more advanced gameplay.  After a couple of months, the idea was formed in the theme of this publication - the game World of Frogs. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/web/1a8/6f4/b58/1a86f4b58a7f42c69112213cf2f6c2ed.jpg"><br><br>  The essence of the game - you control a frog, you can attack other players, as well as computer-controlled objects - flies, cockroaches, marsh frogs.  Flies do not know how to attack and die with one blow, cockroaches attack only defensively, marsh frogs attack both flies and players. <br><br>  Defeating the enemies you gain experience, grow in levels, learn new abilities and become stronger. <br><br>  <b>The main points from which I repelled:</b> <br><br><ol><li>  On the client side, no <b>Flash</b> , only <b>html + js</b> ; </li><li>  One machine should pull as many online players as possible; </li><li>  The possibility of horizontal scaling; </li><li>  Low threshold of entry into the game and quick start; </li><li>  Slightly more varied gameplay than sliterio; </li><li>  Beautiful and memorable domain; </li></ol><a name="habracut"></a><br>  Further details on each of the items. <br><br><h3>  1) Client code </h3><br>  I did not want to get bogged down in inter-browser differences, as well as in the implementation of primitives, so I immediately pushed the idea of ‚Äã‚Äãworking directly with the <b>canvas</b> away ‚Äî I started by searching for the graphic library (of course, free). <br><br>  Initially, the view fell on <b>pixi.js</b> - this is the engine, on which a lot of documentation, which is positively responded in terms of performance and generally praise in every way. <br>  However, delving into the search, I stopped at <b>phaser.js</b> (there were already articles on <b>Habr√©</b> about it) - this is a higher-level library that allowed me to forget about many nuances and focus directly on the game logic. <br><br>  The engine made it possible to screw animations, background texture, camera, world borders and much more without any problems.  And everything would be fine, but when it came time to check the work on other computers, with other operating systems, the following problems emerged: <br><br>  <b>1.1 The main problem is the background texture (tilesprite) terribly slow on windows 7</b> <br>  I found this out from the work computer after the first deployment to the hosting - the FPS was very, very low - around <b>5</b> .  And so it was in all browsers except, surprisingly, <b>IE</b> - everything worked pretty well in it, albeit not perfect. <br><br>  I didn‚Äôt think about the fact that it slows down the background at once - first of all, I found out using the typing method that the game suddenly stops braking when the browser window size decreases.  I did not manage to google something for such symptoms, so I, for the sake of prevention, decided to introduce some of the practices that the <b>Mozilla</b> guys advise - in particular, the use of the <b>Object Pool</b> (reuse of game objects).  I haven't achieved much success with this kind of optimization, and the profiler still showed that rendering consumes the most resources. <br><br>  Then, resorting to the gradual disabling display of various elements of the game, I identified the culprit - <b>tilesprite</b> . <br><br>  Going along <b>tilesprite,</b> I found out that I don‚Äôt have one problem, and the reason is that the <b>canvas is</b> redrawn completely with any change - i.e.  the small object has moved - we redraw the entire canvas, including the background, which gives us a high drawing expense. <br><br>  In an attempt to solve this problem, I rendered the background on a separate canvas with a smaller <b>z-index</b> so that it was redrawn separately, regardless of moving objects ‚Äî it did not give any special results. <br><br>  In the end, I decided to abandon <b>phaser.js</b> and work directly with <b>canvas</b> created to render the background - as a result, the <b>FPS has</b> grown to about <b>20</b> . <br><br>  <b>1.2 Different <b>phaser</b> versions - different performance in different operating systems</b> <br>  After changing the principle of rendering the background with performance, everything became much better, but <b>20</b> FPS - this is still not the desired <b>60</b> - there was something to be done.  By poking a finger into the sky, it was found that <b>phaser</b> version <b>2.4.6</b> runs faster on <b>windows 7</b> , and version <b>2.6.2</b> runs faster on <b>windows 10</b> .  On both Linux and Mac, both versions performed equally well. <br><br>  I had to add a condition that connected one or another version of the library depending on the user's browser - this increased the FPS on my working machine to <b>25-30</b> .  I never managed to raise the FPS higher - I decided to stop at this, because  after interviewing friends / acquaintances who have a seven, the impression is that the problem is rare and not so serious as it was originally. <br><br>  <i>Described in these two points are not the only ones, but the main and most remembered problems associated with <b>phaser.js</b> - everything else went smoothly in general.</i> <i><br><br></i>  <i>It is also worth noting that on different machines with <b>windows 7 the</b> performance was different - in some places and without all my gestures everything was fine, somewhere there were problems similar to what I watched - I could not establish any correlation</i> <br><br><h3>  2) Performance of one instance of the game server </h3><br>  Here it‚Äôs worth starting with what is the overall architecture of an application that serves as a game server.  It was decided to use the following scheme: <br><br>  In parallel, messages are received from different players via <b>websocket</b> and laid to process the main thread, which updates the game logic.  The main stream works by iterations of <b>40ms</b> , within which it updates the movement, visibility, respawn NPC, the progress of the use of abilities, etc. <br><br>  Data is written to the database asynchronously - the game logic update stream lays the messages into a queue to another background thread, which groups them and writes them into the database in batches. <br><br>  Serialization and sending messages to players also occurs asynchronously - the next background thread deals with this, to which messages are written to the processing queue as part of the iteration, and at the end of the iteration, messages are grouped for each user and sent to the client in a bundle. <br><br>  If you map on the diagram, then the top-level server architecture looks like this: <br><br><img src="https://habrastorage.org/web/781/e39/50f/781e3950ff2646d28fef3d0d918afc78.png"><br><br>  Since  I had more experience with the backend, there were no particularly memorable difficulties here - I caught the non-optimal places by a profiler - somewhere I applied micro-optimization of calculations, somewhere caching, somewhere optimization of a different kind. <br><br>  The most serious boost to performance was the rejection of the use of <b>SignalR</b> , because  it does not support the binary protocol, and the <b>json</b> serialization <b>required</b> more computing resources than the rest of the logic of the game server combined.  Stopped as a result of using <b>Fleck</b> , because  it supports the binary format, and also allows you to disable the Neigl algorithm. <br><br><h3>  3) Possibility of horizontal scaling </h3><br>  Being an optimist, I decided to plan in advance that everyone would like the game and would like to play a lot of people in it.  Within the framework of one machine, you can work on optimizations for a long time, you can upgrade the hardware indefinitely, you can rewrite the application on a pure C with assembler inserts for micro-optimizations, but anyway, sooner or later you will come to the ceiling.  It was decided to have an architecture that allows you to have a lot of low-power servers, each of which has an online ceiling of around <b>200-300</b> people. <br><br>  In order not to have a bottleneck in the form of a network up to any one global proxy, as well as to ensure minimal ping, it was decided on the site side to select one specific server with a minimum of online, assign it to the user session and continue to ensure browser interaction user directly with the game server. <br><br>  At the moment, in the choice of server from the pool, simple logic is used - the server is taken with a minimum of online.  In the future, it is also planned to add logic to the accounting of the location of the client and server. <br><br><h3>  4) Low entry threshold and quick start </h3><br>  I have often had to see games that simply have to have the worst conversion due to interface congestion, or because of the need to enter a million fields in order to enter the game. <br><br>  I wanted to provide one click input from the main page, i.e.  no registration required.  The same approach uses a similar approach, for one small difference - they still want the player to enter a nickname. <br><br>  Since  An online game usually implies the ability to distinguish one player from another, I decided to use the no-generation approach - when entering the game, a random adjective from a predetermined list is taken and combined with a random noun, which gives the nicknames Sleepless Bugay, The Greedy Chipmunk, etc. P‚Ä¶ <br><br><img src="https://habrastorage.org/web/b4f/c03/3af/b4fc033afb6f4e6da570cc825740fc9e.png" alt="image"><br><br>  In the future, if a player likes the game, he is given the opportunity to register, retaining his progress, and also changing his nickname to something more sane. <br><br>  For a quicker immersion, an instructional video was added to the main page, and the tooltips were added to the game itself, which emerge when learning new abilities. <br><br><h3>  5) Slightly more diverse gameplay than in sliterio </h3><br>  As a former fan of the game WoW, I wanted to diversify the game, bringing into it such elements as a set of experience, growth in levels, obtaining new abilities as they grow, PvE, PvP. <br><br>  The player is available to use 6 abilities (1st available immediately, 2-4 become available as they grow in levels, and 5-6 are designed as disposable power ups - they can be raised on the playing field): <br><br><ol><li>  <b>Beat the tongue</b> - the frog shoots his tongue and causes little damage to the first target on the way; </li><li>  <b>Jump</b> - the frog jumps in the indicated direction and causes high damage at the landing site.  High damage ability is compensated by the complexity of the hit, as well as a long delay between uses; </li><li>  <b>Shield</b> - for 3 seconds absorbs 2 next enemy attacks; </li><li>  <b>Spit</b> - a frog spits out a projectile, which inflicts medium damage to all enemies on the trajectory of movement); </li><li>  <b>Healing</b> - restores half the life; </li><li>  <b>Acceleration</b> - increases movement speed by 100% for 4 seconds; </li></ol><br><img src="https://habrastorage.org/web/64e/36d/314/64e36d3149f64f4592f26f982561e3b8.png"><br><br>  To be able to stand out a bit, the ability to choose another model of the game character was added. <br><br><h3>  6) Beautiful and memorable domain; </h3><br>  Initially, the plans were to place the game on the <b>.io domain</b> , similarly to sliterio, agario and many other games of this format.  The <b>commonplace frog.io</b> and <b>frogs.io</b> were busy, but something more appropriate in .io could not be found.  Playing with domains containing frog, I came across a very successful option - <b>frogs.world</b> , on which the project now lives.  A rather unusual first-level domain, but easily remembered. <br><br>  Thanks for attention.  I hope that my experience will be useful to someone. </div><p>Source: <a href="https://habr.com/ru/post/331852/">https://habr.com/ru/post/331852/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331836/index.html">Pr√ºfer code</a></li>
<li><a href="../331838/index.html">What threatens premature automation</a></li>
<li><a href="../331842/index.html">Multicore DSP TMS320C6678. Operational kernels: processor computing resources</a></li>
<li><a href="../331846/index.html">Deskun update: from the ticket system inside Gmail to the multi-channel support system</a></li>
<li><a href="../331848/index.html">How NVIDIA and AMD earn on the rise in cryptocurrency popularity</a></li>
<li><a href="../331854/index.html">PETYA malware. Recovery is possible</a></li>
<li><a href="../331858/index.html">How to beat the Petya virus</a></li>
<li><a href="../331860/index.html">WannaCry and Petya - how does the center for monitoring and response to cyber attacks in case of global incidents work?</a></li>
<li><a href="../331862/index.html">Secure USB flash drive. Myth or Reality</a></li>
<li><a href="../331864/index.html">Sizes of raster images: pixels, DPI, PPI, centimeters - you do not confuse anything?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>