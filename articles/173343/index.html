<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we selected and implemented WebDAV in Yandex.Disk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Already at the time of launch, Yandex.Disk gave many developers the opportunity to use it in their applications and programs. And it ensures that we h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we selected and implemented WebDAV in Yandex.Disk</h1><div class="post__text post__text-html js-mediator-article">  Already at the time of launch, <a href="http://disk.yandex.ru/">Yandex.Disk</a> gave many developers the opportunity to use it in their applications and programs.  And it ensures that we have chosen <a href="http://ru.wikipedia.org/wiki/Webdav">WebDAV</a> as the protocol for Disk's desktop clients. <br><br>  Since the protocol determines how programs and the server communicate with each other, almost everything depends on its choice.  And the way customers will be arranged, and what file handling capabilities they will have. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/740/e40/b89/740e40b89216ee05eb9d42fd76a704d9.jpg" width="554" height="150" alt="Red Button - WebDAV">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Today we want to talk about the reasons that stopped our choice on WebDAV and made it the protocol for <a href="http://disk.yandex.ru/download/">Yandex.Disk clients</a> . <br><a name="habracut"></a><br>  Thanks to the <a href="http://api.yandex.ru/disk/">API</a> implemented on its base, <a href="http://www.abbyy.ru/finereader-touch-ios/features/">ABBYY FineScanner</a> , <a href="http://www.handybackup.ru/reliz-handybackup-7">Handy Backup 7</a> , <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.estrongs.android.pop">ES Explorer</a> and the <a href="http://habrahabr.ru/post/142973/">unofficial Yandex.Disk client for Linux</a> are already working with our service. <br><br>  Before choosing a protocol, we defined for ourselves the most important requirements for it: <br><br><ol><li>  Work speed; </li><li>  Open license; </li><li>  The ability to implement all the necessary actions: authentication, support for file operations, competitive access to files, resuming from the server and resuming downloading to the server; </li><li>  Prevalence - it should work with target operating systems (primarily Windows, Mac OS X, Linux) out of the box or with minimal modifications. </li></ol><br>  We were even ready to develop our own protocol if the existing ones did not suit us.  Changing the protocol after launch would require a lot of man-hours of work, so it was necessary to explore different options and choose the one that best meets our requirements. <br><br>  <b><a href="http://ru.wikipedia.org/wiki/Ftp">FTP</a></b> .  This protocol for remote work with files is time tested.  But it was created without taking into account the requirements of information security, which became for us its significant drawback.  In addition, it does not support many of the operations we need, for example, the transfer of metadata along with the contents of the file.  And it requires special applications to connect. <br><br>  <b><a href="http://ru.wikipedia.org/wiki/Bittorrent">BitTorrent</a></b> .  Since it was about synchronization between devices at once, it would be very useful to use the connection between them without creating a load on the servers, but this would require double development work on the client.  In addition, there would be problems when working through NATs and firewalls, which would greatly reduce the benefits of using this protocol. <br><br>  <b><a href="http://ru.wikipedia.org/wiki/Amazon_S3">Amazon S3</a></b> .  This repository uses its own HTTP-based protocol.  We considered the possibility of using the S3 API, however, we rejected this idea due to the lack of familiar work with directories and the need to use special applications for access. <br><br>  <b><a href="http://ru.wikipedia.org/wiki/Webdav">WebDAV</a></b> .  Based on HTTP and XML and easily extensible, it supports almost everything we need in specifications.  C it works quite well pre-installed packages in all target operating systems.  In addition, the Yandex.Disc desktop client development department, which was working on the Yandex XMPP server, at that time already had experience with open XML-based protocols. <br><br>  The main reason for which we did not want to create our own protocol was that only our applications could work with it, and we wanted openness. <br><br>  In the end, of all the options discussed, we chose WebDAV.  The only thing missing in the protocol is informing the client about changes on the server, a very important synchronization feature.  But since the protocol is extensible, it did not become a problem. <br><br>  After selecting the protocol, work began on a prototype of Yandex.Disk.  We wrote our WebDAV server on <a href="http://erlang.org/">Erlang</a> .  As a framework for the web server, <a href="https://github.com/mochi/mochiweb">mochiweb</a> was chosen, quite lightweight and well-known to our developers library.  It was also used in the well-known article about connecting millions of users to one server - <a href="http://www.metabrew.com/article/a-million-user-comet-application-with-mochiweb-part-1">A million user comet application</a> .  We also thought about using the <a href="http://yaws.hyber.org/">Yaws</a> web server, which can be compared to Apache.  This is a full-fledged web server that can give statics, run CGI scripts, handle special pages with server scripts.  But we did not need all this.  If we started doing the project now, the choice would be <a href="https://github.com/extend/cowboy">Cowboy</a> , as it provides more opportunities to identify connection problems. <br><br>  After studying the WebDAV protocol, work began on listing the files and directories on the server.  As a repository for the prototype used mysql-database, which stored the meta-information and the usual file system for storing the contents of files.  Scaling and high reliability at this stage was not required. <br><br>  The layout was pretty simple, since it was a prototype.  As is usually the case with file systems, there was a question of restrictions on the way.  Since the maximum length of the path to the resource was not specified in the protocol, it was decided to make the path component length 255 characters and the number of nesting levels unlimited.  Approximately the file storage table looked like this: <br><table><tbody><tr><td>  id </td><td>  number, auto increment, unique resource identifier </td></tr><tr><td>  uid </td><td>  user, resource owner </td></tr><tr><td>  path </td><td>  string length 255 resource name </td></tr><tr><td>  type </td><td>  resource type, file or directory </td></tr><tr><td>  parent </td><td>  number, owner id </td></tr><tr><td>  depth </td><td>  number, resource nesting level <br>  used to optimize sample requests </td></tr></tbody></table><br>  One of the first non-trivial tasks was the listing of the root, in which there is nothing.  The difficulty is that <a href="">the PROPFIND method</a> , besides just the listing, also performs the task of reading the properties of the resource.  It was necessary to properly parse the request, to understand what we can give out and what not;  form the correct answer.  As the first client, the gvfs built into Ubuntu was used.  Having debugged the work with it, we decided to check the work of the connection from Windows 7 and found that it does not work with us.  The study of working with other servers showed that the clients built into Windows do not process the ‚ÄúDAV:‚Äù namespace, if it is declared default, without a prefix.  Other standard clients turned out to be more tolerant and easily digested the output, formed especially for Windows clients.  Fortunately, this was the only incompatibility that we managed to find. <br><br>  When the work on the listing was completed, we implemented the trivial operations of creating directories and deleting resus. <br><br>  Further it was required to learn how to upload files, but this operation was not so simple.  And why - if this topic will be interesting to you - we will tell in the next post. </div><p>Source: <a href="https://habr.com/ru/post/173343/">https://habr.com/ru/post/173343/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../173331/index.html">The creators of the Internet received the Queen Elizabeth Award for inventors</a></li>
<li><a href="../173333/index.html">Sort by StackSort</a></li>
<li><a href="../173335/index.html">The American will have to pay 222 thousand dollars for 24 songs uploaded to the network</a></li>
<li><a href="../173339/index.html">Email clients and webmordas. Now what?</a></li>
<li><a href="../173341/index.html">Social Media Monitoring Tools</a></li>
<li><a href="../173345/index.html">A simple programmer once again on Google Glass</a></li>
<li><a href="../173347/index.html">3D integration: what are the difficulties?</a></li>
<li><a href="../173349/index.html">Random Tips</a></li>
<li><a href="../173351/index.html">Whose morphology is better? Yandex vs Google</a></li>
<li><a href="../173353/index.html">About users and permissions: About 66.9% of Android applications track personal information</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>