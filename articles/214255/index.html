<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Gentoo: configuring and connecting via / dev / loop filesystem with compression using Reiser4 as an example</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have several VPS'ok with Gentoo, running under VMWare, for which I, having shabby, allocated only 7G of disk space. Once, after the release of the n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Gentoo: configuring and connecting via / dev / loop filesystem with compression using Reiser4 as an example</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/c33/dd4/16f/c33dd416ff49151ce3cd2f253cd89e1e.jpg" alt="Small is smaller" align="right"><br>  I have several VPS'ok with Gentoo, running under VMWare, for which I, having shabby, allocated only 7G of disk space.  Once, after the release of the next version of gcc, one of them ran out of space.  Rummaging, I discovered that the main consumers were the directories / usr / src and / usr / portage.  Immediately the idea was born to move them to a file system with compression (yeah, to NTFS) and the choice fell on Reiser4, since this data is ideal for it - a lot of files and they are all small. <br><br>  There is a lot of conflicting <a href="http://www.phoronix.com/scan.php%3Fpage%3Darticle%26item%3Dlinux_310_reiser4%26num%3D1">information</a> about this file system on the network (2013), but perhaps you should read the <a href="http://habrahabr.ru/post/108629/">article</a> (2010) by the lead developer. <br>  Quote from the article: <blockquote>  over the past four years, I don‚Äôt remember that someone would lose data on the reiser4 section when the hardware is working properly.  I was approached by several people complaining about the work of fsck.  In the end, they all received both their data and a working fsck. </blockquote>  Do not be afraid of her ... <br><a name="habracut"></a><br>  I want to emphasize that, as they are often confused among themselves, Reiser4 is not the same as ReiserFS.  These are two different file systems!  ReiserFS has long been living in the main kernel of the kernel, but for Reiser4, although it was born back in 2004, it will have to apply a patch, which, it should be noted, is regularly updated for new kernel versions. <br><br>  Download and apply the patch according to your kernel version (on my linux-3.10.25-gentoo system) from this <a href="http://sourceforge.net/projects/reiser4/files/reiser4-for-linux-3.x/">page</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's say it can be done like this: <br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src/linux wget -O reiser4-for-3.10.patch.gz <span class="hljs-string"><span class="hljs-string">'http://downloads.sourceforge.net/project/reiser4/reiser4-for-linux-3.x/reiser4-for-3.10.patch.gz?r=http%3A%2F%2Fsourceforge.net%2Fprojects%2Freiser4%2Ffiles%2Freiser4-for-linux-3.x%2F&amp;ts=1393599138&amp;use_mirror=heanet'</span></span> gunzip reiser4-for-3.10.patch.gz &amp;&amp; patch -p1 &lt; reiser4-for-3.10.patch</code> </pre> <br>  We configure our core.  Please note - ReiserFS support is not required.  The screen of my particular system, yours may have other settings, but now we are only interested in: <br>  <b>File Systems -&gt; Reiser4</b> <br><img src="http://habrastorage.org/getpro/habr/post_images/c55/f93/89f/c55f9389f4dfa9f4f787885b143c6efa.png" alt="image"><br><br>  and do not forget about: <br>  <b>Device Drivers&gt; Block devices -&gt; Loopback device support</b> <br><img src="http://habrastorage.org/getpro/habr/post_images/59c/7a9/92d/59c7a992dd2ce3199409af37b23fa674.png" alt="image"><br><br>  Here is an example of a real sequence of commands and actions that I performed on my server, all of a sudden, someone will come in handy: <br><pre> <code class="bash hljs">;    make menuconfig ;   : ;   ,     make &amp;&amp; make modules_install ;     /boot,   .   : mount /boot &amp;&amp; cp arch/x86_64/boot/bzImage /boot/kernel-3.10.25 &amp;&amp; cp .config /boot/.config-3.10.25</code> </pre><br>  Since I put a completely new kernel, I need to correct the bootloader settings, I use GRUB: <br><pre> <code class="bash hljs">vi /boot/grub/grub.conf</code> </pre><br>  The working entry for the new kernel looks like this (just for example, you may have something completely different): <br><pre> <code class="bash hljs">title Gentoo Linux 3.10.25 md0 root (hd0,0) kernel /boot/kernel-3.10.25 root=/dev/md0 net.ifnames=0</code> </pre><br>  You shouldn‚Äôt do it by default with the default configuration; first, we restart the server and make sure that everything is fine. <br><br>  We make a control measurement of free disk space: <br><pre> <code class="bash hljs">df -h ;  (    ) Filesystem Size Used Avail Use% Mounted on /dev/md0 7.4G 4.1G 2.9G 59% / ;      du --summarize -h /usr/portage ; 2.2G /usr/portage du --summarize -h /usr/src ; 766M /usr/src</code> </pre><br>  We stock up on popcorn with validol and ... <br><pre> <code class="bash hljs">umount /boot &amp;&amp; reboot</code> </pre><br>  Do not forget the pens to choose a new kernel configuration to boot: <br><img src="http://habrastorage.org/files/4a6/fa0/5f0/4a6fa05f085c482999b018d8ae72f5b7.png" alt="image"><br>  I hope your server is still with you ... <br><br>  We have already eaten the first and second, we proceed to the dessert - creating a loop device and mounting a disk image with Reiser4 onto it: <br><pre> <code class="bash hljs">;      Reiser4 emerge reiser4progs ;        <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /mnt &amp;&amp; truncate -s 2G reiser4.img ;      du -h reiser4.img ; 0 reiser4.img du --apparent-size -h reiser4.img ;2.0G reiser4.img ;      /dev/loop0 losetup /dev/loop0 /mnt/reiser4.img ;      gzip (  lzo,    , ,   ,   ).   ,         Reiser4 mkfs.reiser4 -f -o create=ccreg40,compress=gzip1 /dev/loop0</code> </pre><br><img src="http://habrastorage.org/files/ba7/72a/7e1/ba772a7e1a8746a2bfa441f93d56618f.png" alt="image"><br><br>  Finally, we mount our new "drive": <br><pre> <code class="bash hljs">;  ,     /etc/fstab <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'/mnt/reiser4.img /mnt/reiser4 reiser4 loop,noatime 0 0'</span></span> &gt;&gt; /etc/fstab ;    mkdir reiser4 ;  ... ... mount /mnt/reiser4 ; ... ,    mount | grep mnt ;  - /mnt/reiser4.img on /mnt/reiser4 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> reiser4 (rw,noatime)</code> </pre><br>  We move the required directories to a new place of residence (here you can drink a cup of coffee and do other things) <br><pre> <code class="bash hljs">mv /usr/portage /mnt/reiser4 &amp;&amp; ln -s /mnt/reiser4/portage /usr/portage mv /usr/src /mnt/reiser4 &amp;&amp; ln -s /mnt/reiser4/src /usr/src</code> </pre><br>  Everything, you can make a control and calculate the profit: <br><pre> <code class="bash hljs">df -h ;  -      1.2G Filesystem Size Used Avail Use% Mounted on /dev/md0 7.4G 2.9G 4.2G 41% / devtmpfs 1004M 0 1004M 0% /dev tmpfs 201M 392K 201M 1% /run shm 1004M 0 1004M 0% /dev/shm cgroup_root 10M 0 10M 0% /sys/fs/cgroup /dev/loop1 2.0G 1.8G 191M 91% /mnt/reiser4 ;  - reiser4.img  1.8G ;              : mount | grep mnt ;  - /mnt/reiser4.img on /mnt/reiser4 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> reiser4 (rw,noatime) ;   portage,  emerge -p world</code> </pre><br>  <b>Total:</b> our source took 3.9G, after packaging this value decreased to 1.8G, or <b>46%</b> (shrunk more than twice!) From the original size.  Trifle, of course, but nice. <br><br>  I have been using this configuration for about a year without any problems, 2G has never ended, the kernel did not panic, and the CPU did not deal with it during emerge -DNu world.  However, there is still one drawback, if in such a container the place runs out, in order to increase its size, you will have to create a new file of a larger size and pour all the contents from the old file into it.  Unfortunately, the resize_reiser4 utility is still not written by anyone.  Perhaps, if someone knows another way to increase the size of this file system, please share in the comments.  And in what file systems, besides NTFS and BRTFS, is there support for transparent data compression? <br><br>  Quote from the article, a link to which is given at the beginning of the post: <br><blockquote>  It has been shown that it has been a limited number of cases.  There is no major development for users of the Linux system.  At this time, however, it‚Äôs not a formal plan for merging. </blockquote></div><p>Source: <a href="https://habr.com/ru/post/214255/">https://habr.com/ru/post/214255/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../214241/index.html">The logic of thinking. Part 2. Factors</a></li>
<li><a href="../214247/index.html">How the world's largest startup accelerator works</a></li>
<li><a href="../214249/index.html">The draft law on the restriction of Internet payments adopted in first reading</a></li>
<li><a href="../214251/index.html">Visiting hot Finnish guys, or what is the secret to the success of Finnish design?</a></li>
<li><a href="../214253/index.html">Conference ProfsoUX-2013 - review-classification + video</a></li>
<li><a href="../214259/index.html">Notifications of endings of fabric tasks, with decorators and detailed information</a></li>
<li><a href="../214261/index.html">Dragon for MSI</a></li>
<li><a href="../214263/index.html">Send an application to the State Duma regarding the "" anti "terrorist" package of bills</a></li>
<li><a href="../214267/index.html">Imo.im messenger disables all protocols.</a></li>
<li><a href="../214269/index.html">European Commission: ‚ÄúFritupley? Then no in-app purchases! ‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>