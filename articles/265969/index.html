<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Safe dynamic update of records on MS DNS from Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 In the process of setting up AD service clients running Ubuntu Linux, I encountered an untimely update of records on the DNS server usi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Safe dynamic update of records on MS DNS from Linux</h1><div class="post__text post__text-html js-mediator-article"><h2>  Introduction </h2><br>  In the process of setting up <acronym>AD</acronym> service clients running Ubuntu Linux, I encountered an untimely update of records on the DNS server using Samba, as well as the incorrect operation of the ‚Äúnet ads dns register‚Äù command.  What causes problems when working with domain computers. <br><br>  For example, the presence of two DNS servers in dhclient.conf results in the error ‚ÄúERROR_DNS_GSS_ERROR‚Äù after running ‚Äúnet ads dns register -P‚Äù. <br><br>  In search of a solution to this problem, I re-read many articles and bug reports, and came across the article <a href="http://habrahabr.ru/users/warlock_ua/" class="user_link">Warlock_ua</a> <a href="http://habrahabr.ru/post/221843/">"Secure dynamic update of DNS records in the Windows domain from Linux (GSS-TSIG)"</a> .  The idea seemed interesting to me.  But I did not like the solution with the creation of a separate domain user account, which has the right to modify all records of the DNS zone.  Firstly, it is potentially unsafe.  Secondly, in Windows, there is already a ready-made solution: each computer account has the right to change its record on the DNS.  Why not take advantage of this? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I took the learn-address.sh script from Warlock_ua as a <a href="http://habrahabr.ru/users/warlock_ua/" class="user_link">basis</a> , and finalized it to suit my needs. <a name="habracut"></a><br><br><h2>  About infrastructure </h2><br>  We have AD service running Windows Server 2008 R2 Standard, as well as MS DNS server.  They are managed by Windows administrators.  DHCP server is based on Cisco.  This is managed by network administrators.  What is it, for me it is all somewhere in the cloud, and a bit like a black box.  We also have clients running Ubuntu 14.04 (Trusty), with Samba 4.1.6 installed, isc-dhcp-client.  This is my part. <br><br><h2>  Script for updating DNS records </h2><br>  I will not describe the entire procedure for entering into the AD domain computers running Ubuntu, since this is beyond the scope of the article.  I will describe only the key points. <br><br>  The computer that will update its DNS record must be entered into the domain.  Those.  he must have a domain account.  First you need to get a password for your computer account from Trivial DataBase.  This can be done using the <a href="http://manpages.ubuntu.com/manpages/trusty/en/man8/tdbdump.8.html">tdbdump</a> utility: <br><br><pre><code class="bash hljs">sudo tdbdump -k SECRETS/MACHINE_PASSWORD/DOMAIN /var/lib/samba/private/secrets.tdb | sed <span class="hljs-string"><span class="hljs-string">'s/\\\00$//'</span></span></code> </pre> <br>  After that, you need to create a <a href="http://web.mit.edu/Kerberos/krb5-1.12/doc/formats/keytab_file_format.html">keytab file</a> with machine credentials using the <a href="http://manpages.ubuntu.com/manpages/trusty/en/man1/ktutil.1.html">ktutil</a> utility: <br><br><pre> <code class="bash hljs">ktutil &lt;&lt;EOF addent -password -p <span class="hljs-variable"><span class="hljs-variable">$cn</span></span>@DOMAIN.LOCAL -k 1 -e rc4-hmac <span class="hljs-variable"><span class="hljs-variable">$MPAS</span></span> write_kt <span class="hljs-variable"><span class="hljs-variable">$keytab_file</span></span> quit EOF</code> </pre><br>  Next you need to get <a href="http://web.mit.edu/Kerberos/www/krb5-devel/doc/user/tkt_mgmt.html">a kerberos ticket</a> : <br><br><pre> <code class="bash hljs">kinit -k -t <span class="hljs-variable"><span class="hljs-variable">$keytab_file</span></span> <span class="hljs-variable"><span class="hljs-variable">$user</span></span></code> </pre><br>  And you can update the DNS record for a specific computer account. <br><br><h3>  Nsupdate-gsstsig overview </h3><br><pre> <code class="bash hljs">nsupdate-gsstsig update &lt;ip&gt; &lt;hostname&gt;</code> </pre> <br><br><h3>  Listing nsupdate-gsstsig </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash ### ###       ### dnsserver=dc1 fwdzone=domain.local #       . #  ,     . #revzone=115.70.10.in-addr.arpa ttl=300 op=$1 addr=$2 #revaddr=`echo $addr | sed -re 's:([0-9]+).([0-9]+).([0-9]+).([0-9]+):4.3.2.1.in-addr.arpa:'` cn=$3 fqdn=$cn.$fwdzone addfile=add_$addr delfile=del_$addr # ,       AD, # CNAME     user=$cn keytab_file=./machine_krb5.keytab ### ###      ### MPAS=`sudo tdbdump -k SECRETS/MACHINE_PASSWORD/DOMAIN /var/lib/samba/private/secrets.tdb | sed 's/\\\00$//'` ### ###  keytab- ### ktutil &lt;&lt;EOF addent -password -p $cn@DOMAIN.LOCAL -k 1 -e rc4-hmac $MPAS write_kt $keytab_file quit EOF ### ###    DNS ### addRecord() { kinit -k -t $keytab_file $user cat &lt;&lt;EOF &gt; $addfile gsstsig server $dnsserver zone $fwdzone update delete $fqdn a update add $fqdn $ttl a $addr send EOF #zone $revzone #update delete $revaddr ptr #update add $revaddr $ttl ptr $fqdn #send #EOF cat &lt;&lt;EOF &gt; $delfile gsstsig server $dnsserver zone $fwdzone update delete $fqdn a send EOF #zone $revzone #update delete $revaddr ptr #send #EOF nsupdate -v $addfile rm -f $addfile rm -f $delfile } delRecord() { kinit -k -t $keytab_file $user nsupdate -v $delfile rm -f $delfile } case $op in add|update) addRecord ;; delete) delRecord ;; *) echo "Unable to handle operation $op. Exiting" exit 1 esac rm $keytab_file</span></span></code> </pre> <br><h2>  Running script </h2><br>  For easy launch, I placed the script in / bin / nsupdate-gsstsig. <br>  To update the DNS information automatically, I created a regdns script and put it in /etc/network/if-up.d/. <br><br><h3>  Listing regdns </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh #      SHOST=`cat /etc/hostname` #  IP-  lo    IP=$(ifconfig | grep 'inet addr:'| grep -v '127.0.0.1' | cut -d: -f2 | awk '{ print $1}') #    DNS- nsupdate-gsstsig update $IP $SHOST</span></span></code> </pre> <br><br><div class="spoiler">  <b class="spoiler_title">Information sources</b> <div class="spoiler_text"><ul><li>  <a href="http://habrahabr.ru/post/221843/">habrahabr.ru/post/221843</a> </li><li>  <a href="http://help.ubuntu.ru/wiki/%25D0%25B2%25D0%25B2%25D0%25BE%25D0%25B4_%25D0%25B2_%25D0%25B4%25D0%25BE%25D0%25BC%25D0%25B5%25D0%25BD_windows">help.ubuntu.ru/wiki/vvod_v_domen_windows</a> </li><li>  <a href="http://forum.ubuntu.ru/index.php%3Ftopic%3D17941.0">forum.ubuntu.ru/index.php?topic=17941.0</a> </li><li>  <a href="https://help.ubuntu.com/community/ActiveDirectoryWinbindHowto">help.ubuntu.com/community/ActiveDirectoryWinbindHowto</a> </li><li>  <a href="http://manpages.ubuntu.com/manpages/trusty/en/man8/net.8.html">manpages.ubuntu.com/manpages/trusty/en/man8/net.8.html</a> </li><li>  <a href="http://manpages.ubuntu.com/manpages/trusty/man5/dhclient.conf.5.html">manpages.ubuntu.com/manpages/trusty/man5/dhclient.conf.5.html</a> </li><li>  <a href="http://manpages.ubuntu.com/manpages/trusty/en/man8/tdbdump.8.html">manpages.ubuntu.com/manpages/trusty/en/man8/tdbdump.8.html</a> </li><li>  <a href="http://manpages.ubuntu.com/manpages/trusty/en/man1/ktutil.1.html">manpages.ubuntu.com/manpages/trusty/en/man1/ktutil.1.html</a> </li><li>  <a href="http://web.mit.edu/Kerberos/krb5-1.12/doc/formats/keytab_file_format.html">web.mit.edu/Kerberos/krb5-1.12/doc/formats/keytab_file_format.html</a> </li><li>  <a href="http://web.mit.edu/Kerberos/www/krb5-devel/doc/user/tkt_mgmt.html">web.mit.edu/Kerberos/www/krb5-devel/doc/user/tkt_mgmt.html</a> </li></ul></div></div></div><p>Source: <a href="https://habr.com/ru/post/265969/">https://habr.com/ru/post/265969/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../265957/index.html">Optimization of the git-server</a></li>
<li><a href="../265961/index.html">How to disassemble monkey guts into its component parts. We study color deconvolution</a></li>
<li><a href="../265963/index.html">Context Sensors in Windows 10</a></li>
<li><a href="../265965/index.html">API for validator from Yandex. And why do the micro-mark validators give different answers?</a></li>
<li><a href="../265967/index.html">And these people forbid me to pick one's nose ... (in continuation of the theme of the sled for the HDD)</a></li>
<li><a href="../265971/index.html">Small usefulness for a GLPI + FusionInventory bundle</a></li>
<li><a href="../265975/index.html">Entertaining 40 gigabit</a></li>
<li><a href="../265979/index.html">ATM cash withdrawal forecast using a simple neural network</a></li>
<li><a href="../265981/index.html">Program from scratch. Now is the right time to start</a></li>
<li><a href="../265983/index.html">Connecting Asterisk via OKS-7</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>