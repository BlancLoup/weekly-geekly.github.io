<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple masking of the Linux kernel module using DKOM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you know, the task of hiding the kernel module from the ubiquitous "eyes" of the user can have many applications. This article discusses the use of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple masking of the Linux kernel module using DKOM</h1><div class="post__text post__text-html js-mediator-article">  As you know, the task of hiding the kernel module from the ubiquitous "eyes" of the user can have many applications.  This article discusses the use of <a href="http://www.blackhat.com/presentations/win-usa-04/bh-win-04-butler.pdf">DKOM</a> (Direct Kernel Object Manipulation) - one of the techniques that allows you to hide information by modifying the internal structures of the kernel. <br><br>  Next will be considered the features of the use of this technology in order to hide the visible signs of the presence of a module in the system and, as a consequence, the impossibility of unloading. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As the name suggests, the basis of the DKOM is the operation of manipulating the internal structures of the core.  In this case, the structure undergoing change is the internal <a href="">list of modules</a> containing references to all <a href="">modules</a> loaded into the system. <br><br><h4>  Module presentation in the kernel </h4><br><br>  The structure-descriptor of the Linux kernel module is the structure of the same name, described in the <a href="">linux / modules.h</a> file as follows: <br><br><pre><code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">223</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class"> 224 {</span></span> <span class="hljs-number"><span class="hljs-number">225</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> module_state state; <span class="hljs-number"><span class="hljs-number">226</span></span> <span class="hljs-number"><span class="hljs-number">227</span></span> <span class="hljs-comment"><span class="hljs-comment">/* Member of list of modules */</span></span> <span class="hljs-number"><span class="hljs-number">228</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list_head</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-number"><span class="hljs-number">229</span></span> <span class="hljs-number"><span class="hljs-number">230</span></span> <span class="hljs-comment"><span class="hljs-comment">/* Unique handle for this module */</span></span> <span class="hljs-number"><span class="hljs-number">231</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> name[MODULE_NAME_LEN]; ... <span class="hljs-number"><span class="hljs-number">378</span></span> };</code> </pre> <br><br>  Among other things, this structure contains a <code>list</code> field, which is an element of a linked list, by which this module is linked into a general list of kernel modules.  The latter, in turn, is an internal non-exported list, declared in the <a href="">kernel / module.c file</a> and protected by the corresponding (exported) <a href="">mutex</a> : <br><br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">103</span></span> DEFINE_MUTEX(module_mutex); <span class="hljs-number"><span class="hljs-number">104</span></span> EXPORT_SYMBOL_GPL(module_mutex); <span class="hljs-number"><span class="hljs-number">105</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LIST_HEAD</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(modules)</span></span></span></span>;</code> </pre><br><br>  When loading a module, the kernel adds the module to its list.  When unloading - excludes.  In general, all operations requiring enumeration of loaded modules are somehow reduced to the kernel iteration of this internal list. <br><br><h4>  Listing loaded modules </h4><br><br>  In order to list the modules loaded into the system, it is convenient to use the <code>THIS_MODULE</code> macro, which refers to the structure-descriptor of the current module.  The <code>list</code> field considered earlier will be an element of the general list of modules with the head descriptor located somewhere in the core of the kernel.  So, the function of listing the list of modules loaded into the system is <a href="">as follows</a> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">list_modules</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mod</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list_head</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pos</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!mutex_trylock(&amp;module_mutex)) cpu_relax(); debug(<span class="hljs-string"><span class="hljs-string">"List of available modules:\n"</span></span>); list_for_each(pos, &amp;THIS_MODULE-&gt;<span class="hljs-built_in"><span class="hljs-built_in">list</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> head = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)pos &gt;= MODULES_VADDR; mod = container_of(pos, struct <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">list</span></span>); debug(<span class="hljs-string"><span class="hljs-string">" pos:%pK mod:%pK [%s]\n"</span></span>, pos, \ head ? mod : <span class="hljs-number"><span class="hljs-number">0</span></span>, head ? mod-&gt;name : <span class="hljs-string"><span class="hljs-string">"&lt;- looking for"</span></span>); } mutex_unlock(&amp;module_mutex); }</code> </pre><br><br>  As you can see, first of all, you need to capture the corresponding mutex, so that there are no problems with synchronization, if someone tries to unload one of the modules at the time of the listing. <br><br>  Further, an important point in the enumeration is to determine the address of the head of the list - the <a href="">modules</a> structure.  Due to the peculiarities of the organization of linked lists in the Linux kernel, the head is not associated with any of the modules.  Moreover, since  Since the module descriptors are separated from the addresses of the range of modules ( <a href="">MODULES_VADDR</a> - <a href="">MODULES_END</a> ), then the definition of the address belonging to this range is trivial.  Below is the result of this function, obtained on one of the machines: <br><br><pre> <code class="bash hljs">[11025.656372] [findme] List of available modules: [11025.656377] [findme] pos:ffffffffa02a7388 mod:ffffffffa02a7380 [ipheth] [11025.656380] [findme] pos:ffffffffa02b9108 mod:ffffffffa02b9100 [pci_stub] [11025.656382] [findme] pos:ffffffffa01e7028 mod:ffffffffa01e7020 [vboxpci] [11025.656385] [findme] pos:ffffffffa01dd148 mod:ffffffffa01dd140 [vboxnetadp] [11025.656387] [findme] pos:ffffffffa01d4028 mod:ffffffffa01d4020 [vboxnetflt] ... [11025.656477] [findme] pos:ffffffffa00205c8 mod:ffffffffa00205c0 [3c59x] [11025.656480] [findme] pos:ffffffffa000c108 mod:ffffffffa000c100 [r8169] [11025.656483] [findme] pos:ffffffff81c2daf0 mod:0000000000000000 [&lt;- looking <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>]</code> </pre><br><br>  The last line clearly indicates that the desired structure is located at <code>ffffffff81c2daf0</code> , which can be verified by running the command: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># grep -w modules /proc/kallsyms ffffffff81c2daf0 d modules</span></span></code> </pre><br><br>  Thus, using any of the modules, you can easily search through the list elements to find the root structure.  Its distinguishing feature will be an address uncharacteristic for modules ( <code>ffffffff81xxxxxx</code> versus <code>ffffffffa0xxxxxx</code> ), which was <a href="">used</a> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">struct list_head * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_modules_head</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list_head</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pos</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!mutex_trylock(&amp;module_mutex)) cpu_relax(); list_for_each(pos, &amp;THIS_MODULE-&gt;<span class="hljs-built_in"><span class="hljs-built_in">list</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)pos &lt; MODULES_VADDR) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } mutex_unlock(&amp;module_mutex); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pos) { debug(<span class="hljs-string"><span class="hljs-string">"Found \"modules\" head @ %pK\n"</span></span>, pos); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { debug(<span class="hljs-string"><span class="hljs-string">"Can't find \"modules\" head, aborting\n"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pos; }</code> </pre><br><br><h4>  Manipulations of the list of modules </h4><br><br>  Hiding a module is not difficult in principle, since  the operation of excluding an element from the list does not require anything other than this element.  Reinsertion operation requires any of the existing list items.  In this case, the root element of the system is used.  Thus, hiding and re-adding the module is <a href="">as follows</a> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hide_or_show</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">new</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!mutex_trylock(&amp;module_mutex)) cpu_relax(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* 0 -&gt; 1 : hide */</span></span> list_del(&amp;THIS_MODULE-&gt;<span class="hljs-built_in"><span class="hljs-built_in">list</span></span>); debug(<span class="hljs-string"><span class="hljs-string">"Module \"%s\" unlinked\n"</span></span>, THIS_MODULE-&gt;name); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* 1 -&gt; 0 : show */</span></span> list_add(&amp;THIS_MODULE-&gt;<span class="hljs-built_in"><span class="hljs-built_in">list</span></span>, p_modules); debug(<span class="hljs-string"><span class="hljs-string">"Module \"%s\" linked again\n"</span></span>, THIS_MODULE-&gt;name); } mutex_unlock(&amp;module_mutex); }</code> </pre><br><br>  In the first case, to exclude their list, use <a href="">list_del</a> .  In the second - <a href="">list_add</a> .  Both operations are protected by capturing the corresponding mutex. <br><br><h4>  Practical part </h4><br><br>  The prepared <a href="https://github.com/milabs/kmod_hidden">example</a> contains the module code that implements the masking functions.  For verification, you should assemble the module and load it with standard tools via <code>make</code> and <code>insmod</code> <br><br>  Further, immediately after the download, the module will be accessible via <code>lsmod</code> or <code>rmmod</code> .  Next, I present a sequence of actions to check the functions of disguise: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># insmod findme.ko # lsmod | grep findme findme 12697 0 # sysctl -w findme=1 findme = 1 # lsmod | grep findme # rmmod findme libkmod: ERROR ../libkmod/libkmod-module.c:753 kmod_module_remove_module: could not remove 'findme': No such file or directory Error: could not remove module findme: No such file or directory # sysctl -w findme=0 findme = 0 # lsmod | grep findme findme 12697 0 # rmmod findme</span></span></code> </pre><br><br>  Thus, there is the possibility of simply hiding the kernel module from prying eyes.  The presented <a href="https://github.com/milabs/kmod_hidden">example</a> contains the necessary code for the experiments. <br><br><h4>  On read </h4><br><br>  1. <a href="http://www.blackhat.com/presentations/win-usa-04/bh-win-04-butler.pdf">Direct Kernel Object Manipulation</a> <br>  2. <a href="http://isis.poly.edu/kulesh/stuff/src/klist/">Linux Kernel Linked List Explained</a> <br>  3. <a href="http://lwn.net/Articles/336255/">Linux kernel design patterns - part 2</a> </div><p>Source: <a href="https://habr.com/ru/post/205274/">https://habr.com/ru/post/205274/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../205250/index.html">National Geographic has posted over 500 historical maps on Google Maps Engine</a></li>
<li><a href="../205252/index.html">We are at DevGamm, Kiev</a></li>
<li><a href="../205256/index.html">Quod licet Jovi non licet bovi, or Mosfilm decided to sue Rutor.org</a></li>
<li><a href="../205264/index.html">Consider a display with Assertive Display technology in the Nokia Lumia 1520</a></li>
<li><a href="../205268/index.html">Go GUI Notepad</a></li>
<li><a href="../205280/index.html">Access Control System on Wiren Board</a></li>
<li><a href="../205284/index.html">UK e-government fix using Go language</a></li>
<li><a href="../205286/index.html">The digest of interesting news and materials from the world of PHP No. 31 (November 25 - December 8, 2013)</a></li>
<li><a href="../205290/index.html">Fast, economical, steady ...</a></li>
<li><a href="../205294/index.html">Designer - project manager. Reality or Utopia?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>