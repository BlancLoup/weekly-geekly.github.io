<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Batniki against exploits (version for Windows XP)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Somehow I came across a publication on Habr√© - "Batniki against exploits . " It told how to launch a browser from under a specially created user, who ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Batniki against exploits (version for Windows XP)</h1><div class="post__text post__text-html js-mediator-article">  Somehow I came across a publication on Habr√© - <a href="http://habrahabr.ru/company/kaspersky/blog/137304/">"Batniki against exploits</a> . <a href="http://habrahabr.ru/company/kaspersky/blog/137304/">"</a>  It told how to launch a browser from under a specially created user, who does not have rights to run applications.  According to the author, this can protect against exploits and Drive-by attacks. <br><br>  This undoubtedly useful article had one flaw - it was written for Windows 7 (which was honestly written about in it). <br><br>  After Windows XP was removed from support, I had a netbook with pigs and the idea to enhance the security of the system by adapting the solution seemed completely natural. <br><a name="habracut"></a><br><h4>  I wore a magic hat and cast a 10th level billgates </h4><br>  Attempts to adapt the batch file for the existing Russian pig revealed the following flaws in the code: <br><ul><li>  The author is sure that all user profiles are in the c: \ users folder; </li><li>  The author is sure that the desktop folder is always called Desktop; </li><li>  The author constantly forgets that the system folders can contain spaces, so very often forgets to quote the path; </li><li>  The author apparently does not know how to get from the batch file the directory where the profiles are located; </li><li>  The author did not take into account that in the Russian Windows baht files are executed in the 866th code page, and VBS scripts - in the 1251st.  Therefore, Russian letters from batch files are turned into a pumpkin in the scripts. </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After revision, I got the following code batch file: <br><br>  <b>ATTENTION!</b>  The code will work only on WinXP.  For the seven - see the original article. <br><blockquote>  :: Writed by: Sergey.Golovanov at kaspersky.com for habrahabr.ru (enchanted by Alexey Girin - vk.com/alexey.girin) <br>  <i>@</i> echo on <br>  If you want to get access to this file from the Internet files. <br>  Pause <br>  :: Setup new user :: <br>  set safeusername = saferun_user_% random% <br>  set safepassword =% random% Ai% random% <br>  echo Login:% safeusername% <br>  echo Password:% safepassword% <br>  net user% safeusername% / delete <br>  del Browserlist4saferun.txt <br>  net user% safeusername%% safepassword% / add <br><br>  :: init new user profile :: <br>  echo Option explicit&gt; init_new_user_profile.vbs <br>  echo Dim oShell &gt;&gt; init_new_user_profile.vbs <br>  echo set oShell = Wscript.CreateObject ("WScript.Shell") &gt;&gt; init_new_user_profile.vbs <br>  echo oShell.Run "RunAs / profile / user:% safeusername% ping" &gt;&gt; init_new_user_profile.vbs <br>  echo WScript.Sleep 1000 &gt;&gt; init_new_user_profile.vbs <br>  echo oShell.Sendkeys "% safepassword%" &gt;&gt; init_new_user_profile.vbs <br>  echo oShell.Sendkeys "{ENTER}" &gt;&gt; init_new_user_profile.vbs <br>  echo Wscript.Quit &gt;&gt; init_new_user_profile.vbs <br>  call cscript init_new_user_profile.vbs <br>  ping -n 10 localhost &gt;&gt; nul <br>  del init_new_user_profile.vbs <br><br>  :: Setup privileges for new user :: <br>  net localgroup users% safeusername% / delete <br>  cscript "% Programfiles% \ Windows Resource Kits \ Tools \ XCACLS.vbs" "% USERPROFILE% \ .. \% safeusername% \" / D% safeusername% :( OI) (IO) (WDAC, WO, X) <br><br>  :: Setup browsers :: <br>  : FindOpera <br>  if exist "% APPDATA% \ Opera \" xcopy / E / I / C / Y / Q / H / R "% APPDATA% \ Opera \ *" "% USERPROFILE% \ .. \% safeusername% \ AppData \ Roaming \ Opera \ " <br>  if exist "% Programfiles% \ Opera \ Opera.exe" goto run4opera <br>  if exist "% Programfiles (x86)% \ Opera \ Opera.exe" goto run4operax86 <br>  Goto FindFireFox <br>  : run4opera <br>  echo Opera ^ |% Programfiles% \ Opera &gt;&gt; Browserlist4saferun.txt <br>  Goto FindFireFox <br>  : run4operax86 <br>  Set Browsername = Opera <br>  echo Opera ^ |% Programfiles (x86)% \ Opera &gt;&gt; Browserlist4saferun.txt <br>  Goto FindFireFox <br>  : FindFireFox <br>  if exist "% APPDATA% \ Mozilla \" xcopy / E / I / C / Y / Q / H / R "% APPDATA% \ Mozilla \ *" "% USERPROFILE% \ .. \% safeusername% \ AppData \ Roaming \ Mozilla \ " <br>  if exist "% Programfiles% \ Mozilla Firefox \ Firefox.exe" goto run4Firefox <br>  if exist "% Programfiles (x86)% \ Mozilla Firefox \ Firefox.exe" goto run4Firefoxx86 <br>  Goto FindChrome <br>  : run4Firefox <br>  echo Firefox ^ |% Programfiles% \ Mozilla Firefox &gt;&gt; Browserlist4saferun.txt <br>  Goto FindChrome <br>  : run4Firefoxx86 <br>  echo Firefox ^ |% Programfiles (x86)% \ Mozilla Firefox &gt;&gt; Browserlist4saferun.txt <br>  Goto FindChrome <br>  : FindChrome <br>  If exist "% LOCALAPPDATA% \ Google \ Chrome \ Application \ chrome.exe" goto run4chrome <br>  Goto findie <br>  : run4chrome <br>  :: // Chrome by not stable.  Dissabled for performance. <br>  :: xcopy / E / I / C / Y / Q / H / R "% LOCALAPPDATA% \ Google \ Chrome \ *" "% USERPROFILE% \ .. \% safeusername% \ AppData \ Local \ Google \ Chrome \" <br>  :: for / r "% USERPROFILE% \ .. \% safeusername% \ AppData \ Local \ Google \ Chrome \" %% C in (* .exe) do icacls %% C / grant% safeusername% :( X) <br>  :: for / r "% USERPROFILE% \ .. \% safeusername% \ AppData \ Local \ Google \ Chrome \" %% C in (* .dll) do icacls %% C / grant% safeusername% :( X) <br>  :: echo Chrome ^ | "% USERPROFILE% \ .. \% safeusername% \ AppData \ Local \ Google \ Chrome \ Application \" &gt;&gt; Browserlist4saferun.txt <br>  Goto findie <br>  : FindIE <br>  :: // TODO A lot of XCOPYs <br>  if exist "% LOCALAPPDATA% \ Microsoft \ Internet Explorer" ( <br>  xcopy / E / I / C / Y / Q / H / R "% USERPROFILE% \ Favorites \ *" "% USERPROFILE% \ .. \% safeusername% \ Favorites \" <br>  xcopy / E / I / C / Y / Q / H / R "% LOCALAPPDATA% \ Microsoft \ Internet Explorer \ *" "% USERPROFILE% \ .. \% safeusername% \ AppData \ Local \ Microsoft \ Internet Explorer \" <br>  xcopy / E / I / C / Y / Q / H / R "% LOCALAPPDATA% \ Microsoft \ Windows \ History \ *" "% USERPROFILE% \ .. \% safeusername% \ AppData \ Local \ Windows \ History" <br>  xcopy / E / I / C / Y / Q / H / R "% APPDATA% \ Roaming \ Microsoft \ Windows \ Cookies \ *" "% USERPROFILE% \ .. \% safeusername% \ AppData \ Roaming \ Microsoft \ Windows \ Cookies \ " <br>  ) <br>  if exist "% Programfiles (x86)% \ Internet Explorer \ iexplore.exe" goto run4iex86 <br>  if exist "% Programfiles% \ Internet Explorer \ iexplore.exe" goto run4ie <br>  : run4iex86 <br>  echo IExplore ^ |% Programfiles (x86)% \ Internet Explorer &gt;&gt; Browserlist4saferun.txt <br>  goto MakeLinks <br>  : run4ie <br>  echo IExplore ^ |% Programfiles% \ Internet Explorer &gt;&gt; Browserlist4saferun.txt <br><br>  :: Make links :: <br>  : MakeLinks <br>  rd / s / q "% USERPROFILE% \ Downloads \ Browser" <br>  rd / s / q "% USERPROFILE% \ —í –é bv" \ SafeLinks " <br>  "% Programfiles% \ Windows Resource Kits \ Tools \ linkd.exe" / d "% USERPROFILE% \ Downloads \ Browser" "% USERPROFILE% \ .. \% safeusername% \ Downloads" <br>  mkdir "% USERPROFILE% \ —í –é bv" \ SafeLinks " <br>  echo on <br>  For / f "tokens = 1,2 delims = |" %% A in (Browserlist4saferun.txt) do ( <br>  echo Option explicit&gt; "%% B \ %% A.vbs" <br>  echo Dim oShell &gt;&gt; "%% B \ %% A.vbs" <br>  echo set oShell = Wscript.CreateObject ^ ("WScript.Shell" ^) &gt;&gt; "%% B \ %% A.vbs" <br>  echo oShell.Run "RunAs / user:% safeusername% %% A.exe" &gt;&gt; "%% B \ %% A.vbs" <br>  echo WScript.Sleep 1000 &gt;&gt; "%% B \ %% A.vbs" <br>  echo oShell.Sendkeys "% safepassword%" &gt;&gt; "%% B \ %% A.vbs" <br>  echo oShell.Sendkeys "{ENTER}" &gt;&gt; "%% B \ %% A.vbs" <br>  echo Wscript.Quit &gt;&gt; "%% B \ %% A.vbs" <br>  echo Set oWS = WScript.CreateObject ^ ("WScript.Shell" ^)&gt; "% USERPROFILE% \ —í WYE bv" \ SafeLinks \ %% A.lnk.vbs " <br>  echo sLinkFile = "% USERPROFILE% \ Desktop \ SafeLinks \ %% A_saferun.LNK" &gt;&gt; "% USERPROFILE% \ —í –é  bv" \ SafeLinks \ %% A.lnk.vbs " <br>  echo Set oLink = oWS.CreateShortcut ^ (sLinkFile ^) &gt;&gt; "% USERPROFILE% \ —í WYE bv" \ SafeLinks \ %% A.lnk.vbs " <br>  echo oLink. <br>  echo oLink.IconLocation = "%% B \ %% A.exe, 0" &gt;&gt; "% USERPROFILE% \ —í –é  bv" \ SafeLinks \ %% A.lnk.vbs " <br>  echo oLink.WorkingDirectory = "%% B \" &gt;&gt; "% USERPROFILE% \ —í –é bv" \ SafeLinks \ %% A.lnk.vbs " <br>  echo oLink.Save &gt;&gt; "% USERPROFILE% \ —í –é  bv" \ SafeLinks \ %% A.lnk.vbs " <br>  ) <br>  for / r "% USERPROFILE% \ —í –é bv" \ SafeLinks \ "%% p in (* .vbs) do cscript %% p <br>  for / r "% USERPROFILE% \ —í –é bv" \ SafeLinks \ "%% v in (* .vbs) do del %% v <br>  :: Open Explorer with links :: <br>  explorer "% USERPROFILE% \ —í –é bv" \ SafeLinks \ " <br><br>  :: Create Uninstall :: <br>  echo <i>@</i> echo off&gt; uninstall_% ~ n0.bat <br>  echo net user% safeusername% / del &gt;&gt; uninstall_% ~ n0.bat <br>  echo rd / s / q "% USERPROFILE% \ Downloads \ Browser" &gt;&gt; uninstall_% ~ n0.bat <br>  echo rd / s / q "% USERPROFILE% \ —í –é  bv" \ SafeLinks "&gt;&gt; uninstall_% ~ n0.bat <br>  echo rd / s / q "% USERPROFILE% \ .. \% safeusername% \" &gt;&gt; uninstall_% ~ n0.bat <br>  echo For / f "tokens = 1,2 delims = |" %%%% A in (Browserlist4saferun.txt) del "%%%% B \ %%%% A.vbs" &gt;&gt; uninstall_% ~ n0.bat <br>  echo del Browserlist4saferun.txt &gt;&gt; uninstall_% ~ n0.bat <br>  echo del %% 0 &gt;&gt; uninstall_% ~ n0.bat <br><br>  : Exit <br></blockquote><br><br>  This text should be copied to <b>notepad</b> , save it as SaveRun.bat. <br><br>  <b>ATTENTION!</b>  If you plan to run on an English Windows, it is necessary in the code to replicate all the substrings " –é¬´ bv "and" Desktop "(without quotes) on the substring Desktop (well, or just the name of the directory where you have the desktop).  Otherwise, this code will work correctly only in Russian Windows. <br><br>  In addition, you need to download and put on the machine: <br><br>  1. <a href="http://www.microsoft.com/en-us/download/confirmation.aspx%3Fid%3D17657">Windows Server 2003 Resource Kit Tools</a> ; <br>  2. <a href="http://www.microsoft.com/en-us/download/confirmation.aspx%3Fid%3D19419">Extended Change Access Control List Tool (Xcacls)</a> . <br><br>  <b>ATTENTION!</b>  Both must be placed in the default directory where the resource is set -% Programfiles% \ Windows Resource Kits \ Tools \ <br><br>  Or correct this line in the code. <br><br>  Now - you can run. <br><br>  The system works very simple.  She is: <br><ol><li>  It creates a random user, who does not have rights to run applications from the profile, where, according to the author's plan, all viruses will tend to get to start from there; </li><li>  It scans the default paths that all the main browsers ‚Äî fox, chrome, donkey, opera ‚Äî are put on, and if it finds them, it creates a script for each VBS browser that (if launched) generates a link to launch the browser.  If this link is then launched, the browser will start up with the rights of that neutered user; </li><li>  Creates a SafeLinks folder on the desktop where all VBS scripts are put. <br>  There will also get links generated by these scripts to launch browsers; </li><li>  Creates an uninstall_% ~ n0.bat file next to the source batch file.  This batch file (if run) will remove both the castrated user and the scripts and directory.  And myself too. </li></ol><br><br>  All this economy was tested by me on Russian Windows with installed Firefox 33.0. <br><br>  Works. </div><p>Source: <a href="https://habr.com/ru/post/241081/">https://habr.com/ru/post/241081/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../241063/index.html">Emacs 24.4 released with browser</a></li>
<li><a href="../241065/index.html">Scale your hosting on a new level with ISPmanager 5 Business</a></li>
<li><a href="../241069/index.html">Online course ‚ÄúData Visualization. Basics</a></li>
<li><a href="../241073/index.html">Feedback 2014-2015!</a></li>
<li><a href="../241079/index.html">Examine databases using T-SQL</a></li>
<li><a href="../241083/index.html">How we do World of Warships: export automation and content verification</a></li>
<li><a href="../241085/index.html">Development of 3D games for Windows 8 using C ++ and Microsoft DirectX</a></li>
<li><a href="../241087/index.html">Veeam announces free utility for backup of physical machines and servers</a></li>
<li><a href="../241089/index.html">Mobile applications for web developers</a></li>
<li><a href="../241095/index.html">Git as subversion</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>