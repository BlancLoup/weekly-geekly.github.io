<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Yandex cloud platform: Cocaine in action</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We have already told you what Cocaine is and how to deploy it ‚Äúat home‚Äù. Today we will talk about how to use its infrastructure at the programmer leve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Yandex cloud platform: Cocaine in action</h1><div class="post__text post__text-html js-mediator-article">  We have already told you <a href="http://habrahabr.ru/company/yandex/blog/209324/">what</a> Cocaine is and <a href="http://habrahabr.ru/company/yandex/blog/214069/">how to deploy it</a> ‚Äúat home‚Äù.  Today we will talk about how to use its infrastructure at the programmer level.  By the way, on April 26 at 14:00 a <a href="http://tech.yandex.ru/events/meetings/cocaine_lab/">meeting</a> will take place in the Moscow office of Yandex, where you can talk to us live - the team that makes Cocaine.  Come, but do not forget to <a href="http://tech.yandex.ru/events/meetings/cocaine_lab/register/">register</a> . <br><br> <a href="http://habrahabr.ru/company/yandex/blog/220243/"><img src="https://habrastorage.org/getpro/habr/post_images/20d/bdc/014/20dbdc014b76c99188fa05a6a745c6d0.jpg"></a> <br><br>  So, from today's post you will learn: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  how to write applications; </li><li>  how to use applications and services natively using the provided frameworks; </li><li>  how to change the application so that it responds to http, as well as how to test these applications using Cocaine http proxy; </li><li>  how to write your own service. </li></ul><br>  Let us begin our immersion in the programmer‚Äôs cocaine days. <br><a name="habracut"></a><br>  This text is quite voluminous and very technical.  It is understood that you have read our previous posts, and you have access to the cocaine cloud, on which machines the required libraries and programs are installed.  And that you are quite familiar with asynchronous programming and you are not afraid of the words: event loop, callback and cortutina.  For each example, the requirements will be listed under the cut or explicitly.  And yes, for the repetition of everything told, it is not necessary to have a cluster of 50 cars.  One laptop with Mac OS was enough for me. <br><br><h2>  Part 1. We work with Cocaine </h2><br>  Let's start our review by loading into the cloud an already configured ready application, the power of which knows no bounds, <a href="https://github.com/3Hren/cocaine-paper-sources/tree/master/src/echo">echo</a> .  The application is written in Python and represents a typical Hello World for testing the correctness of new frameworks. <br><br><h4>  How to download an application </h4><br>  Virtually the entire article will use the cocaine-tool console utilities, which themselves depend on the installed cocaine-framework-python.  In the magical world of Python, these libraries are set by the command: <br><br><pre><code class="python hljs">pip install cocaine-tools</code> </pre> <br><br>  Download the application to the cloud, go to the directory with the application and run the following command: <br><br><pre> <code class="python hljs">cocaine-tool app upload</code> </pre> <br><br>  <strong>This is important:</strong> before downloading, do not forget to make the input point in your application executable.  In our case: <br><br><pre> <code class="python hljs">chmod u+x echo.py</code> </pre> <br><br>  The result will be displayed: <br><img src="https://habrastorage.org/getpro/habr/post_images/b29/cd5/95d/b29cd595d80a3651f60be0f85b4b3662.png" alt="Download Test Application"><br><br>  To run it, we need a ready profile.  If you have Cocaine configured to use Docker as an isolation system, you can use the profile provided in the previous <a href="http://habrahabr.ru/company/yandex/blog/214069/">article</a> .  If Cocaine is configured for normal process spawn, just use the profile I prepared (profile.json): <br><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"isolate"</span></span>: { <span class="hljs-string"><span class="hljs-string">"args"</span></span>: { <span class="hljs-string"><span class="hljs-string">"spool"</span></span>: <span class="hljs-string"><span class="hljs-string">"/var/spool/cocaine"</span></span> }, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"process"</span></span> } }</code> </pre><br><br>  You can load a profile with a similar command: <br><br><pre> <code class="python hljs">cocaine-tool profile upload --name profile@test --profile ./profile.json</code> </pre> <br><br>  The result of the work should be something like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/e1b/5fa/4ce/e1b5fa4ced58d38891070fa598b6226a.png" alt="Loading profile"><br>  Having a ready profile, it remains only to launch the recently downloaded application: <br><br><pre> <code class="python hljs">cocaine-tool app start --name echo --profile profile@test</code> </pre> <br><br>  If something like this is displayed in the console, then everything was done successfully and our application is now <br>  part of the cloud. <br><img src="https://habrastorage.org/getpro/habr/post_images/192/408/a65/192408a6547488b0d409c484e27f3b7c.png" alt="Run test application"><br>  Let's go back to the example.  Do not really delve into the code yet.  Soon we will write a similar, but more functional application, but this time <br>  already with explanations.  The only thing this application does is respond to an event named <strong>ping</strong> with the same <br>  the very message that was sent to him. <br><br>  Now our task is to write the code that forms the request and accepts the answer from this application.  It is worth noting that cocaine applications can be accessed both via HTTP and directly from client code.  We will look at the first method a little later; the second method involves the use of one of the frameworks provided.  To warm up, we will write the code on Python using the pythonic framework that was supposed to be bundled with the <strong>cocaine-tool</strong> . <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cocaine.futures <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> chain <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cocaine.services <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Service <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tornado.ioloop <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> IOLoop <span class="hljs-comment"><span class="hljs-comment"># Alias for more readability. asynchronous = chain.source if __name__ == '__main__': io_loop = IOLoop.current() service = Service('echo') @asynchronous def invoke(message): result = yield service.enqueue('ping', message) print(result) invoke('Hello World!') invoke('Hello again!') io_loop.start()</span></span></code> </pre><br><br>  After importing the necessary libraries and classes, we simply create a cocaine service object using the library class <code>Service</code> , passing the application name (echo in our case) as a parameter.  This object is a mapping of the methods and events of the cloud service / application to the class methods in the language used.  Our work with it is to <strong>asynchronously</strong> call the <code>enqueue</code> method provided by all applications, passing in the name of the event as the first parameter and the remaining parameters required by the application (all of a sudden);  and then just asynchronously wait for a response.  To do this, we get the object of the event loop using the <a href="http://www.tornadoweb.org/">Tornado</a> library, start it and wait.  When the answer is received, the cycle does not stop explicitly. <br><br>  <strong>This is important:</strong> when the python framework was written, the Asyncio library was not yet completely ready, and it was necessary to choose between Twisted and Tornado.  The choice fell on the Tornado mainly because of its more modern look and functionality.  Now the full rewriting of the pitonach framework on asyncio, or rather on its backport for the second Python - <a href="http://trollius.readthedocs.org/">Trollius,</a> is in full swing. <br><br>  The sequence of calls can be represented as follows: <br><img src="https://habrastorage.org/getpro/habr/post_images/df3/c57/333/df3c57333f550e039f8f310a5ff67e01.gif" alt="Example call sequence"><br><br>  In the cloud, the application will go like this: <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4a5/5c2/93e/4a55c293e573e8e15b8c7862a8abbaa5.jpg" alt="Trekking in the Cloud"></div><br><br>  The mysterious decorator <code>@asynchronous</code> additional actions to the decorated function, namely: <br><ul><li>  adds its call to the event loop; </li><li>  if the function is korutina, it controls its asynchronous promotion process. </li></ul><br>  Check the written code: <br><img src="https://habrastorage.org/getpro/habr/post_images/f68/ef5/898/f68ef5898e6d58349f3e4f6c1a2c4715.png" alt="Application Testing"><br>  <strong>It is worth noting</strong> that in frameworks for dynamic languages, such as Python is, the set of available methods is obtained dynamically while connecting the object of the <code>Service</code> class to Cocaine.  In other languages, one has to write one or other stubs, which will be shown later. <br><br>  Surely you immediately had questions: <br><ul><li>  Why so hard? </li><li>  Why was the asynchronous model chosen? </li></ul>  We will definitely answer them a few paragraphs below, but for now let's see how Cocaine (and the framework, respectively) <br>  responds to erroneous requests.  For example, we set as the name of the application, the transmitted <code>Service</code> object is not <br>  <strong>echo</strong> , and some name of a nonexistent application.  Let's say <strong>42</strong> , that is: <br><br><pre> <code class="python hljs">echo = Service(<span class="hljs-string"><span class="hljs-string">'42'</span></span>)</code> </pre> <br><br>  I sincerely refuse that you do not have such an application in the cloud.  In this case, Cocaine will return an error, and the framework will throw out <br>  an exception. <br><img src="https://habrastorage.org/getpro/habr/post_images/649/350/ab1/649350ab17eb093c408aa7a74ca910aa.png" alt="Forwarding errors"><br>  <strong>It is worth noting</strong> that frameworks are absolutely not obliged to throw exceptions for errors.  The frameworks are specially created to provide the user with a native Cocaine interface for the language, which means that if the considered language is the most preferred (or the only, in the Go case) method of returning an error, for example, returning an error code, then it will be used. <br><br>  Similarly, you can try to request the processing of a non-existent event, pass an incorrect number of arguments, or make a mistake in their types. <br><br><h3>  Cocaine protocol </h3><br>  Let's stop for a moment and look under the hood of our cloud platform.  How does Cocaine know exactly which <br>  request came to him and how to handle it?  In other words, let's briefly review the protocol through which Cocaine communicates with customers. <br><br>  For each call, Cocaine opens a typed channel that allows you to exchange messages with the application.  Messages can be of three types: <br><br><pre> <code class="python hljs"><span class="hljs-number"><span class="hljs-number">0</span></span>, Chunk ::= &lt;Tuple&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, Error ::= (&lt;Number&gt;, &lt;String&gt;) <span class="hljs-number"><span class="hljs-number">2</span></span>, Choke ::= ()</code> </pre> <br><br>  <strong>Chunk</strong> is a regular message, information that the client wants to send to the application, or vice versa.  In the event of any error, the application (or Cocaine itself, if it can recognize the error in advance) responds with the <strong>Error</strong> type, carrying some code and a human-readable description of the error that has occurred.  Finally, each channel must be closed by a message of type <strong>Choke</strong> .  Cocaine guarantees that after such a message there will be no other messages. <br><br>  Why am I doing this?  Under the hood, each framework implements this protocol (and a bit more), masking it under function calls <br>  or methods, the usual formation of the message and, on the other hand, carrying out dispatching, unpacking the received <br>  messages and sending them back to the client. <br><br>  Since the protocol is streaming, and the last message is always <code>Choke</code> , strictly speaking, applications can <br>  return an unknown amount of <code>Chunk</code> 's, thereby organizing a real stream processing of data and their asynchronous <br>  return. <br><br><h3>  Going back to the example </h3><br>  Let's modify our application so that it returns not one Chunk, but several.  Say two.  Consider the code of our super application, from which the logger was dropped: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cocaine.worker <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Worker&lt;/python&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">echo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, response)</span></span></span><span class="hljs-function">:</span></span> message = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> request.read() response.write(message) response.close() W = Worker() W.run({ <span class="hljs-string"><span class="hljs-string">'ping'</span></span>: echo, })</code> </pre><br><br>  As you can see, practically the same processing pattern that we wrote in the client code is used.  For each incoming event named <code>ping</code> , the <code>echo</code> function is called, which takes the already prepared request and response objects as arguments.  By calling the <code>request.read()</code> method, we asynchronously read one Chunk of the request (in our case, it is strictly one), and we respond using the <code>response.write(...)</code> method. <br><br>  Accordingly, in order for our application to respond with several Chunks, it is enough to call this method again.  For example: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">echo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, response)</span></span></span><span class="hljs-function">:</span></span> message = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> request.read() response.write(message) response.write(<span class="hljs-string"><span class="hljs-string">'Additional message'</span></span>) response.close()</code> </pre><br><br>  How to check it?  Well, first of all, the application should be reloaded and restarted: <br><br><pre> <code class="python hljs">cocaine-tool app upload &amp;&amp; cocaine-tool app restart --name echo --profile profile@test</code> </pre><br><br>  <strong>This is important:</strong> if the modified application stubbornly does not want to be updated and works as before, even after reloading, <br>  check the cache settings in the config cocaine-runtime (cache section). <br><br>  After that, we will restart our client, and he will give out ... the same thing as before.  This is normal behavior.  Let me remind you that we have a stream protocol, and we read exactly one Chunk from the channel.  To make it work, change the <code>invoke</code> function as follows: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@asynchronous def invoke(message): result = yield service.enqueue('ping', message) another_result = yield print(result, another_result) io_loop.stop()</span></span></code> </pre><br><br>  If you try to consider another chunk as a framework, a special ChokeEvent <code>ChokeEvent</code> will be thrown, which again <br>  the framework is dependent (in others it may not be, and the notification of a closed channel is carried out in a different way). <br><br><h3>  Asynchrony everywhere </h3><br>  Now that we have reviewed the basic work with the application and the python framework, let's consider the reasons that led us to dwell on the choice of an asynchronous model for working with code. <br><br>  To do this, consider Cocaine and its surrounding frameworks in more detail.  As noted in our first article, the basic model underlying Cocaine is the model of actors.  The frameworks, in turn, are nothing more than wrappers over RPC calls to Cocaine and processing its responses.  Here, we requested something from the <code>Service</code> object.  What is going on with him?  After encoding the message and sending it, it waits.  Waits for a response, waits for an error, waits for the timeout to occur.  All these expectations are normal IO operations that do not waste processor resources.  So why give it one more time to cool, if you can give more work?  Imagine that you are making requests to some application or service not from the client code, but from <strong>another application</strong> .  It is clear that if this application makes stop the world on each such request, it will lead to the rapid spawning of such applications, which subsequently will simply be a waste of system resources. <br><br>  In such cases, two common approaches are used.  In the first of them, each request is processed in a separate thread, and control is returned to the code mainly in the waiting method of the issued future, in the second case, the event-handling cycle and cooperative multitasking are used (callbacks, coroutines, fiberes ‚Äî not important).  But again, in the case of processing thousands of simultaneous requests - which is quite a realistic situation for high-load systems - the first method gives a significant overhead in performance. <br><br>  That is why all cocaine frameworks implement primarily an asynchronous way of interacting with services.  Some also implement the synchronous method in addition, but not all. <br><br><h3>  But what about the other languages? </h3><br>  After we poured the Cocaine application, it became <strong>part of the infrastructure</strong> , or <strong>unified</strong> .  Now you can access it from any convenient language for development and perform all the same actions discussed above, but without restricting yourself in choosing development paradigms and libraries. <br><br>  We demonstrate this by writing clients for several frameworks in various languages.  In this case, we will test the original version of the echo application. <br><br><h4>  C ++ </h4><br>  A similar client in C ++ will look like this: <br><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta">#include </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;cocaine/framework/services/app.hpp&gt;</span></span></span><span class="hljs-meta"> #include </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;cocaine/framework/services/storage.hpp&gt;</span></span></span><span class="hljs-meta"> #include </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt;</span></span></span><span class="hljs-meta"> #include </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;condition_variable&gt;</span></span></span><span class="hljs-meta"> #include </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;mutex&gt;</span></span></span><span class="hljs-meta"> #include </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;atomic&gt;</span></span></span><span class="hljs-meta"> namespace cf = cocaine::framework; int main(int argc, char** argv) { auto manager = cf::service_manager_t::create(cf::service_manager_t::endpoint_t(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"localhost"</span></span></span><span class="hljs-meta">, 10053)); // Get application service object. auto app = manager-&gt;get_service</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;cf::app_service_t&gt;</span></span></span><span class="hljs-meta">(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"echo"</span></span></span><span class="hljs-meta">); std::atomic</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;int&gt;</span></span></span><span class="hljs-meta"> counter(0); std::condition_variable cv; // Call application. auto g1 = app-&gt;enqueue(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ping"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Hello from C++"</span></span></span><span class="hljs-meta">); auto g2 = app-&gt;enqueue(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ping"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Hello again!"</span></span></span><span class="hljs-meta">); auto handler = [&amp;counter, &amp;cv](cf::generator</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;std::string&gt;</span></span></span><span class="hljs-meta">&amp; g) { counter++; try { // Always packed data. std::cout </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; "result: " &lt;&lt; g.next() &lt;&lt; std::endl; } catch (const std::exception&amp; e) { std::cout &lt;&lt; "error: " &lt;&lt; e.what() &lt;&lt; std::endl; } cv.notify_all(); }; g1.then(handler); g2.then(handler); std::mutex m; std::unique_lock&lt;std::mutex&gt;</span></span></span><span class="hljs-meta"> guard(m); while (counter </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; 2) { cv.wait(guard); } return 0; }</span></span></span></span></code> </pre><br><br>  You need to compile as follows (in the case of using clang): <br><br><pre> <code class="hljs swift">clang++ -std=<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>++<span class="hljs-number"><span class="hljs-number">11</span></span> -stdlib=libc++ -lcocaine-core -lcocaine-framework -lmsgpack -lboost_system -lev ../src/clients/echo-client.cpp</code> </pre><br><br>  If you are using GCC, then simply replace clang ++ with g ++, and remove the need to use libc ++ instead of libstdc ++ by removing <code>-stdlib=libc++</code> . <br><br>  I will not particularly comment on the code; in more detail about using the native framework you can read <a href="">here</a> . <br><br><h4>  Ruby </h4><br>  In the case of Ruby, this is completely simple  We use the wonderful <code>eventmachine</code> framework, which provides the opportunity <br>  use Ruby Fiber and write asynchronous code as if it were synchronous.  No callbacks and futures! <br><br><pre> <code class="hljs pgsql">require <span class="hljs-string"><span class="hljs-string">'cocaine'</span></span> require <span class="hljs-string"><span class="hljs-string">'cocaine/synchrony/service'</span></span> require <span class="hljs-string"><span class="hljs-string">'em-synchrony'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> EchoClient EM.synchrony <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> results = [] service = Cocaine::Synchrony::Service.<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-string"><span class="hljs-string">'echo'</span></span> channel = service.enqueue(<span class="hljs-string"><span class="hljs-string">'ping'</span></span>, <span class="hljs-string"><span class="hljs-string">'Hello from Ruby!'</span></span>) channel.<span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> |result| results.push result <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> puts results EM.stop <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br>  As can be seen from the examples, in contrast to CORBA, Cocaine does not need to determine in advance the <a href="http://ru.wikipedia.org/wiki/%25D0%25AF%25D0%25B7%25D1%258B%25D0%25BA_%25D0%25BE%25D0%25BF%25D0%25B8%25D1%2581%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F_%25D0%25B8%25D0%25BD%25D1%2582%25D0%25B5%25D1%2580%25D1%2584%25D0%25B5%25D0%25B9%25D1%2581%25D0%25BE%25D0%25B2">IDL of</a> applications and services used.  In the case of statically typed languages, for ease of use and type checking, you can write stubs for each service, but usually their implementation does not take up very much space.  If a language has at least some normal reflex, then there is even no need to write an implementation ‚Äî only interfaces are sufficient.  In the case of dynamically typed languages, you can generally do without stubs and create a service API dynamically, obtaining it after determining the basic information about it during the work of the Locator method <code>resolve</code> . <br><br><h2>  Part 2. Workers </h2><br>  Spreading the writing of client code for cocaine applications, I propose to go to the other side of the cloud and consider the rules by which the applications themselves and the means for writing them are written.  In fact, there is not much difference between the client code and the application code - you will see soon. <br><br>  Each of the existing frameworks has tools for writing all sorts of applications that will be multiplied by Cocaine under load.  We will use the API API again for the warm-up. <br><br>  As an example, we will write an application that will generate QR codes of a certain size upon request.  To avoid being bored, the application will also cache the largest images in the <code>Storage</code> service, using secondary requests from the application back to Cocaine. <br><br>  In such a simple way, you can build a real web of requests between small but interlinked applications.  In this case, the question of saving resources is very acute.  Remember we considered why all the frameworks are built on an asynchronous event-oriented model?  It is the saving of resources that prompted us to make this choice. <br><br>  Returning to our example, we will give our application an event called <code>generate</code> .  It will return the generated QR code in binary form as some sort of byte array (well, how else?), Which we will feed to a special object in order to convert them into a real picture. <br><br>  <strong>This is important:</strong> when writing this example, we will use the qrcode python library.  It depends on the well-known <code>PIL</code> or <code>pillow</code> , which in turn requires many binary dependencies, such as libpng.  Make sure you have them, and then set <code>qrcode</code> using the same <code>pip</code> : <br><br><pre> <code class="python hljs">&gt;pip install qrcode</code> </pre><br><br>  I will cite immediately the code of the entire application, and then analyze each line in detail, which can cause even the slightest questions: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python import StringIO import msgpack import qrcode from cocaine.exceptions import ServiceError from cocaine.decorators import http from cocaine.logging import Logger from cocaine.services import Service from cocaine.worker import Worker storage = Service('storage') def generate_qr(message, size=10): if size &lt;= 0 or size &gt;= 20: raise ValueError('size argument must fit in [0; 20]') out = StringIO.StringIO() img = qrcode.make(message, box_size=size) img.save(out, 'png') return out.getvalue() def generate(request, response): rq = yield request.read() message, size = msgpack.loads(rq) try: if size &lt; 10: data = generate_qr(message, size) else: key = '{0}size={1}'.format(message, size) try: data = yield storage.read('qr-codes', key) except ServiceError: data = generate_qr(message, size) yield storage.write('qr-codes', key, data) response.write(data) except Exception as err: response.error(1, str(err)) finally: response.close() w = Worker() w.run({ 'generate': generate })</span></span></code> </pre><br><br>  With the line <code>storage = Service('storage')</code> we declare a storage service global for the worker, which, let me remind you, we <br>  configured in the config cocaine-runtime in the second article.  By default it will be file storage.  In this case, it doesn‚Äôt matter to us at all, since we use the cloud infrastructure provided to us. <br><br>  Now pay attention to the last lines: <br><br><pre> <code class="python hljs">w = Worker() w.run({ <span class="hljs-string"><span class="hljs-string">'generate'</span></span>: generate })</code> </pre><br><br>  With this code, we create a worker object that will connect to Cocaine behind the scenes, as well as some other actions.  Then we start the event processing loop, registering the <code>generate</code> event handler along the way.  Now any <code>invoke</code> message with the correct parameters will be redirected to the specified function.  Consider it in more detail. <br><br>  Exactly two parameters are passed to each such function: <br><ul><li>  prepared request object that contains a single <code>read</code> method for deferred reading of data sent <br>  from socket; </li><li>  response object, which is a channel to which you can write (remember the description of the protocol) all <br>  listed message types ( <code>Chunk</code> , <code>Error</code> , <code>Choke</code> ). </li></ul>  Actually, in lines: <br><br><pre> <code class="python hljs">rq = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> request.read() message, size = msgpack.loads(rq)</code> </pre><br><br>  We read the data from the socket and unpack it.  Why make an extra packing, why can't you just write something like: <code>message, size = yield request.read()</code> ?  Do not forget that we have to unpack some structure from raw bytes.  Last time it was a string, this time a tuple.  Need some kind of coder / decoder.  For this purpose it may be useful even <a href="http://www.json.org/">json</a> , at least <a href="http://msgpack.org/">msgpack</a> , even <a href="https://code.google.com/p/protobuf/">protobuf</a> .  We chose msgpack in this example, because its implementations exist for all popular languages ‚Äã‚Äãand it is fast. <br><br>  After unpacking the necessary arguments, the logic of the application itself follows.  Wrapping it in a large try / except block, we guarantee that all exceptions thrown will be caught not by the framework, but by us, and will have the error codes and messages we need. <br><br>  <strong>This is important:</strong> if we do not catch the exception ourselves, the framework will do it. <br><br>  After checking the size of the picture we have branching.  If the size is small enough, then we will generate the QR code again, otherwise with the lines: <br><br><pre> <code class="python hljs">key = <span class="hljs-string"><span class="hljs-string">'{0}size={1}'</span></span>.format(message, size) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: data = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> storage.read(<span class="hljs-string"><span class="hljs-string">'qr-codes'</span></span>, key) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ServiceError: data = generate_qr(message, size) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> storage.write(<span class="hljs-string"><span class="hljs-string">'qr-codes'</span></span>, key, data)</code> </pre><br><br>  We form a key and check if there is such a document in our repository with such a key.  If not, then the method <code>storage.read('qr-codes', key)</code> throw an exception.  In this case, we still generate the image and save it. <br><br>  <strong>This is important: the</strong> <code>read</code> and <code>write</code> operations are performed asynchronously.  Every time when we in our Corout run into the keyword <code>yield</code> , control returns to the event loop.  It returns back only <br>  when our expected event has arrived.  The <strong>rest of the</strong> events are still processed. ,      <br> Storage,        <code>read</code> .   . <br><br>  ,           ,      .     <code>finally</code> . ,     ,   ,      . <br><br>       : <br><div style="text-align:center;"> <a href=""><img src="http://habrastorage.org/getpro/habr/post_images/99a/487/b5b/99a487b5b0ccbdc9e324c26524dc20e8.jpg" alt="   "></a> </div><br><br>         ,   : <br><br><div style="text-align:center;"><img src="http://habrastorage.org/getpro/habr/post_images/437/4c6/ae8/4374c6ae89408246fead965a2c105558.jpg"></div><br><br>    ?  ,    <code>echo</code> .      Cocaine,  <code>cocaine-tool</code> : <br><br><pre> <code class="python hljs">cd src/qr &amp;&amp; cocaine-tool app upload &amp;&amp; cocaine-tool app start --name qr --profile profile@test</code> </pre><br><br>     .   ,       <code>echo</code>  : <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> StringIO <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> msgpack <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> PIL <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Image <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tornado.ioloop <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> IOLoop <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cocaine.futures <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> chain <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cocaine.services <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Service <span class="hljs-comment"><span class="hljs-comment"># Alias for more readability. asynchronous = chain.source if __name__ == '__main__': io_loop = IOLoop.current() service = Service('qr') @asynchronous def invoke(message): try: result = yield service.enqueue('generate', msgpack.dumps([message, 10])) print('Result:', result) out = StringIO.StringIO() out.write(result) out.seek(0) img = Image.open(out) img.save('qr.png', 'png') except Exception as err: print('Error: ', err) finally: io_loop.stop() invoke('What is best in life? To crush your enemies, see them driven before you, and to hear the lamentation of ' 'their women.') io_loop.start()</span></span></code> </pre><br><br>      <code>invoke</code> ,          .     ,      ,   <code>PIL</code> . <br><br> ,  .   -  ,    ,     HTTP. <br><br> <strong> :</strong>         . <br><br>      :       <code>@http</code> .   (      )    <code>request</code>  <code>response</code> .   -    <code>read</code> ,         ,   ,     <code>cocaine.decorators.http._HTTPRequest</code> ,       ‚Äî , ,   ..   ( <code>response</code> )          . <br><br>   : <br><br><pre> <code class="python hljs">&gt;<span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python import StringIO import msgpack import qrcode from cocaine.exceptions import ServiceError from cocaine.decorators import http from cocaine.logging import Logger from cocaine.services import Service from cocaine.worker import Worker storage = Service('storage') log = Logger() def generate_qr(message, size=10): if size &lt;= 0 or size &gt;= 20: raise ValueError('size argument must fit in [0; 20]') out = StringIO.StringIO() img = qrcode.make(message, box_size=size) img.save(out, 'png') return out.getvalue() @http def generate(request, response): request = yield request.read() try: message = request.request['message'] size = int(request.request.get('size', 10)) if size &lt; 10: data = generate_qr(message, size) else: key = '{0}size={1}'.format(message, size) try: data = yield storage.read('qr-codes', key) except ServiceError: data = generate_qr(message, size) yield storage.write('qr-codes', key, data) response.write_head(200, [('Content-type', 'image/png')]) response.write(data) except KeyError: response.write_head(400, [('Content-type', 'text/plain')]) response.write('Query field "message" is required') except Exception as err: response.write_head(400, [('Content-type', 'text/plain')]) response.write(str(err)) finally: response.close() w = Worker() w.run({ 'generate-http': generate })</span></span></code> </pre><br><br>          API  ,     . <br><br> <strong> :</strong>    <code>generate-http</code> ‚Äî         . <br><br>   ?  ,       -  ,   http-,          .       ,      ,        .    cocaine-proxy ‚Äî  ,    HTTP,             .    <a href="http://habrahabr.ru/company/yandex/blog/214069/"></a>     <code>cocaine-native-proxy</code> .  ,    -     ,   <code>cocaine-tool</code> ,       ,   Python,       : <br><br><pre> <code class="python hljs">cocaine-tool proxy start --count=<span class="hljs-number"><span class="hljs-number">32</span></span></code> </pre><br><br>  <code>count</code> ‚Äî  ,     . <br><br> <strong> :</strong>  production       <code>cocaine-native-proxy</code> .  ,     . <br><br> ,  ,      .   ?        . <br><br>      URI .        : <code>&lt;APP&gt;/&lt;METHOD&gt;[?&lt;Args&gt;]</code> . <br><br>           <code>X-Cocaine-Service</code>  <code>X-Cocaine-Event</code> . <br><br>     .    URI  : <code>/qr/generate-http?message=Hello%20World!&amp;size=10</code> . <br><br>    .    ,      -  : <br><br><img src="http://habrastorage.org/getpro/habr/post_images/e27/5b2/1c1/e275b21c116220c42d76259d221d8d19.png"><br><br> <strong> :</strong>  <code>cocaine-proxy</code>     (,  <code>Storage</code> ) ‚Äî   . <br><br><h3>   </h3><br>        , ,     ,       .       ,        . <br><br>        ,    Cocaine  . <br><br>     <a href="httpd.apache.org/docs/2.2/programs/ab.html">ab</a> .  :      , , 100000   32  ( ,  )  ,  Cocaine     . <br><br> ,           ,   <br>    .    <code>cocaine-runtime</code>  ,  <br> : <br><br><pre> <code class="python hljs">cocaine-tool info</code> </pre><br><br>  Cocaine   ,    - : <br><br><img src="http://habrastorage.org/getpro/habr/post_images/738/e5f/285/738e5f285e81aa7ec759d0e73b8f800e.png"><br><br>  ,     .    .  ¬´state¬ª     .      .  ¬´slaves¬ª      ,          ,    Cocaine (  ).  ¬´queue¬ª      ( , )       .   ,     . ,  ¬´sessions¬ª      , ,  . ,      ,  .    ‚Äî  . <br><br>    !     ,     <code>cocaine-runtime</code>  <code>cocaine-tool info</code> : <br><br><pre> <code class="python hljs">ab -n <span class="hljs-number"><span class="hljs-number">100000</span></span> -c <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-string"><span class="hljs-string">'localhost:8080/qr/generate-http?message=Hello%20World!&amp;size=10'</span></span></code> </pre><br><br>     ,  ,   .      100000   32 .      <code>cocaine-runtime</code> ,            6   QR-,      <code>cocaine-runtime</code>  : <br><br><pre> <code class="python hljs">[Tue Apr <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span>:<span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">2014</span></span>] [INFO] app/qr: enlarging the pool <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> to <span class="hljs-number"><span class="hljs-number">6</span></span> slaves</code> </pre><br><br>  <code>cocaine-tool info</code>    -     : <br><img src="http://habrastorage.org/getpro/habr/post_images/ee2/204/c2e/ee2204c2e1b6a79c4ba8050196f0885f.png"><br> ,      6,      10.    ,   7  .    ,  Cocaine    ,   . <br><br> ,    ,           .  -           ‚Äî        <code>SIGTERM</code> ,           . <br><br>        Cocaine. <br><br><h2>       Python! </h2><br>  No problem!           ,   ‚Äî   (  )     ,        . <br><br>           Go,      ,    .      ,          ,    .  ,       ,   . <br><br>   Go ‚Äî     . Have fun! <br><br><pre> <code class="go hljs">&gt;<span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> <span class="hljs-string"><span class="hljs-string">"code.google.com/p/rsc/qr"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/ugorji/go/codec"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/cocaine/cocaine-framework-go/cocaine"</span></span> ) <span class="hljs-comment"><span class="hljs-comment">//msgpack specific var ( mh codec.MsgpackHandle h = &amp;mh ) var ( OkHeaders cocaine.Headers = cocaine.Headers{[2]string{"Content-type", "image/png"}} ErrorHeaders cocaine.Headers = cocaine.Headers{[2]string{"Content-type", "text/plain"}} storage *cocaine.Service ) const ( cacheNamepspace = "qr-code" cacheTag = "qr-tag" ) func qenerate(text string) (png []byte, err error) { res := &lt;-storage.Call("read", cacheNamepspace, text) if res.Err() == nil { err = res.Extract(&amp;png) return } c, err := qr.Encode(text, qr.L) if err != nil { return } png = c.PNG() &lt;-storage.Call("write", cacheNamepspace, text, string(png), []string{cacheTag}) return } func on_generate(request *cocaine.Request, response *cocaine.Response) { defer response.Close() inc := &lt;-request.Read() var task struct { Text string Size int } err := codec.NewDecoderBytes(inc, h).Decode(&amp;task) if err != nil { response.ErrorMsg(-100, err.Error()) return } png, err := qenerate(task.Text) if err != nil { response.ErrorMsg(-200, err.Error()) return } response.Write(png) } func on_http_generate(request *cocaine.Request, response *cocaine.Response) { defer response.Close() r, err := cocaine.UnpackProxyRequest(&lt;-request.Read()) if err != nil { response.ErrorMsg(-200, err.Error()) return } message := r.FormValue("message") if len(message) == 0 { response.Write(cocaine.WriteHead(http.StatusBadRequest, ErrorHeaders)) response.Write("Missing argument `message`") return } png, err := qenerate(message) if err != nil { response.Write(cocaine.WriteHead(http.StatusInternalServerError, ErrorHeaders)) response.Write("Unable to generate QR") return } response.Write(cocaine.WriteHead(http.StatusOK, OkHeaders)) response.Write(png) } func main() { binds := map[string]cocaine.EventHandler{ "generate": on_generate, "generate-http": on_http_generate, } Worker, err := cocaine.NewWorker() if err != nil { panic(err) } storage, err = cocaine.NewService("storage") if err != nil { panic(err) } Worker.Loop(binds) }</span></span></code> </pre><br><br>      ,       !   Cocaine      . <br><br><h2>  Instead of conclusion </h2><br><br>        Cocaine  ,        . ,      . ,   ,     Cocaine Runtime,      . ,    <a href=""></a> ,     ,     .           Cocaine. <br><br>    <a href="http://tech.yandex.ru/events/meetings/cocaine_lab/"></a> ,        .         Cocaine,            , .   ,      , ,  ,  . </div><p>Source: <a href="https://habr.com/ru/post/220243/">https://habr.com/ru/post/220243/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../220233/index.html">Creating a Custom Scope in JEE and Spring</a></li>
<li><a href="../220235/index.html">History of one internationalization</a></li>
<li><a href="../220237/index.html">12 little-known CSS features</a></li>
<li><a href="../220239/index.html">Sandbox Augmented Reality</a></li>
<li><a href="../220241/index.html">Domestic processor "Elbrus-4C" will soon be launched into mass production</a></li>
<li><a href="../220245/index.html">Reverse Engineering for the smallest: breaking keygen</a></li>
<li><a href="../220247/index.html">As we Lenovo ThinkServer met</a></li>
<li><a href="../220249/index.html">Job search with a bear</a></li>
<li><a href="../220253/index.html">Technopark Mail.Ru. First two years</a></li>
<li><a href="../220255/index.html">Minecraft helps upgrade cities</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>