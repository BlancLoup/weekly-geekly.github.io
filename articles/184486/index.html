<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing a useful thread-based log</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are a lot of enthusiastic people among programmers. Show a sincere interest in your work, read special books and forums even in your free time i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing a useful thread-based log</h1><div class="post__text post__text-html js-mediator-article">  There are a lot of enthusiastic people among programmers.  Show a sincere interest in your work, read special books and forums even in your free time in this environment, if not the rule, then definitely and not the exception.  Then why as a result of so many poor-quality software?  How is it that a student, with burning eyes, arguing about the shortcomings of whole programming languages ‚Äã‚Äãand knowing at least a dozen design patterns, suddenly takes an active part in creating a poor-quality system?  Not at the beginning of his career, but year after year. <br><br>  Yes, you can refer to a large number of low-skilled staff, whose salary depends on the number of written lines of code or on the ability to look at the monitor for a long time without blinking.  But such employees exist in almost all industries.  Builders have lower qualifications than architects, but this does not prevent buildings, for the most part, from being suitable for high-grade use without additional patches. <br><br>  In my opinion, there are two main reasons.  From the first, nothing can be done.  This time, or, as they say more often, constant changes.  When developing a software product, even if it meets all customer requirements, further improvements will be required, often unexpected for the contractor.  They are almost inevitable and do not always fit into the system architecture.  Over time, the software complex becomes unusable.  But time destroyed things and bigger - nothing to be surprised about. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The second reason is much more prosaic.  Inattention to trivia.  Especially at the beginning of the project.  And the younger the team, the more catastrophic the effect.  Of course, it is much more interesting to discuss the prospects for using multimethods [1] than to ensure that operators are separated by spaces.  Yes, and to the final functionality of these little things are not particularly relevant.  Isn't it better to first concentrate on top-priority requirements, because the project time and budget are limited ... <br><a name="habracut"></a><br>  It turns out that as if not better.  It is like a house without a foundation.  The customer asked for spacious rooms, an elevator, a bathroom on each floor - he may not know about the foundation.  But a quality foundation that can withstand the entire structure is necessary.  And first of all the performers should take care of it - from architect to builder. <br><br>  In order not to be further unfounded, I will give an example of a shadow, but fundamental and often necessary subsystem.  This is journaling.  Many systems include the ability to display diagnostic messages.  However, it is usually not the main functionality, and therefore does not receive proper attention. <br><br>  At the same time, a well-designed logging subsystem helps to avoid a number of annoying errors from the very beginning of the project, significantly reducing the period between the moment the defect is introduced and its detection.  After all, each mistake missed at the beginning of the work at the time of the project is turned into a huge snowball, which tries to bury the system and all its creators. <br>  To begin with, I will formulate how I see the module of diagnostic messages output that is not deprived of attention. <br><br><ul><li>  Full interface </li><li>  Cross platform </li><li>  Outputting messages to the IDE console </li><li>  Convenience and ease of use </li><li>  Means of attracting the attention of the developer </li></ul><br><br>  <b>Full interface.</b>  The logging module should represent a complete set of operations from the very beginning of development.  The interface may not be fully implemented, but it must be.  So it is very convenient to be able to share diagnostic messages according to the degree of criticality (error, warning, information).  You can not do one kind of message first, and then introduce a division - part of the system will already be developed with this generalized conclusion, even if you force people to dig up everything done, the developers are unlikely to do this work as correctly as they would have done right away. <br><br>  Often a week later you look at your code as someone else‚Äôs.  It is clear that after several months a number of implementation nuances (in particular, what is a critical problem, and what is just an insignificant emergency situation) will be lost forever. <br><br>  <b>Cross platform</b>  The logging subsystem must initially support all the platforms used.  This is especially important when there is no opportunity to fully and constantly test the application on all operating systems.  What worked perfectly on iOS may behave strangely on an Android device and vice versa.  Of course, the message output system does not replace automatic tests.  But they are quite complex, implementation and support requires considerable labor costs and, morally or not, they are often forgotten about tests.  Therefore, I believe that it is better to start with a fully functioning minimum than to do nothing, dreaming about the ideal.  Although in any case, ideally, there should be tests and a convenient logging subsystem. <br><br>  <b>Outputting messages to the IDE console.</b>  Please note that the list of basic requirements does not include ‚ÄúDisplaying messages to the permanent storage (file or database)‚Äù.  Although usually this is just what many expect from the log.  There is a need in the log file when at least a working system is given to testing for future users or a special department.  But at the initial stages it is much more useful to inform programmers about problems, than testers. <br><br>  Because the user interface can be very late for functionality - all this time, developers will ‚Äústew in their own juice.‚Äù  There is a big difference, you saw the problem a few seconds or weeks after you created it. <br><br>  <b>Convenience and ease of use.</b>  Programmer being lazy.  Suppose you need to report a problem: an image with a size of 100 by 120 is received, while the current settings of the application set a limit for the minimum size of 128 by 128. If the ability to output only a simple line is implemented, the developer will need to produce an adequate output <br><br><ol><li>  Cast four numbers to string type </li><li>  From the received parts to make a line </li><li>  Pass string to log </li></ol><br><br>  Even if the language provides means of outputting to a formatted string (for example, sprintf [2] and stringstream [3]), you will need to create various intermediate variables, waste time, blur the main logic ... In general, you shouldn't be surprised if the result is that something like ‚Äúinvalid image size‚Äù.  The meaning of the word "unacceptable", so understandable now, in a couple of weeks will be lost almost completely.  As a result, the designer, instead of correcting the problem picture, will have to contact the programmer for clarification. <br><br>  Therefore, the logging subsystem should provide a means of conveniently formatting the output strings without forcing the developer to manually lead to string at least basic types.  Here in C ++ two directions are possible. <br><br>  The first is a legacy from C. Formatting a string by a pattern.  Those.  The logging function should have an interface and functionality similar to sprintf.  This is a matter of taste, for me personally this option is deeply unsympathetic.  First of all, it pushes away the need to work with a variable number of different types of function parameters.  Those.  the ability to verify the input data is almost none.  In addition, although simplified, the need for manual type casting is present.  For example, you need to remember that to output an unsigned number you should use the% u formatting code instead of% i - you don‚Äôt want to remember this at all when your head is busy solving another task.  Plus, problems that are elusive at the compilation stage are possible, when the number (order, type) of formatting codes and the parameters actually passed do not match. <br><br>  The second option is output streams.  It is devoid of all the shortcomings of the previous solution: there is no dependency on the parameters, if an object is transferred that does not support the output operator - there will be a compilation error, not all sorts of surprises, there is no need to manually allocate buffers, cast types, etc.  And the main thing is that the output of a message string with the inclusion of variables of different types can actually be written in one line.  Yes, and with the implementation of special difficulties is not expected - the standard library already contains a stream of stringstream [3], which suggests the presence of ready-made stream output algorithms in the string. <br><br>  <b>Means of attracting the attention of the developer.</b>  The programmer is busy.  He may not notice the error even in the IDE output console.  The problem can easily get lost among the clouds of informational messages.  Therefore, first of all, the log must support setting the output level.  For example, ‚Äúdisplay only errors and warnings‚Äù.  This is necessary, but it is not enough - the setting is required from time to time.  And the programmer is busy. <br><br>  Here comes the special macro assert [4].  It allows you to interrupt the execution of the program at the problem site.  The result is different - Visual Studio gives you the opportunity to continue running after the window is displayed and the sound is frightening, XCode does not sound scary, but does not allow it to continue.  In general, attention is guaranteed.  At the same time, the diagnostic message itself will appear at the time of the interruption at the end of the IDE output console, often completely eliminating the need to look at the call stack in search of the reason for the shutdown. <br><br><img src="https://habrastorage.org/storage2/b74/72c/1a5/b7472c1a57b199212c37c516341108b2.png"><br>  <b>Figure 1.</b> Program interruption on warning <br><br>  At the end of the article I will give an example of implementation.  Just to show that it does not require much effort, and the effect is difficult to overestimate ‚Äî as a result, a subsystem will be obtained that not only encourages the developer to create detailed problem reports, but also significantly reduces the time interval between the problem and its detection. <br><br>  First, consider the basic interface of the logging class. <br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Log</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>:</code> </pre> <br>  First of all, we enter four levels of log details (in the order of declaration): <br><ol><li>  Complete log off </li><li>  Only error output </li><li>  Display warnings and errors </li><li>  Display all kinds of messages </li></ol><br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> DebugLevel { DEBUG_LEVEL_DISABLED = <span class="hljs-number"><span class="hljs-number">0</span></span>, DEBUG_LEVEL_ERROR = <span class="hljs-number"><span class="hljs-number">1</span></span>, DEBUG_LEVEL_WARNING = <span class="hljs-number"><span class="hljs-number">2</span></span>, DEBUG_LEVEL_MESSAGE = <span class="hljs-number"><span class="hljs-number">3</span></span>, };</code> </pre><br>  Accordingly, we add three more identifiers of permissible types of messages: informational message, warning and error. <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> MessageType { MESSAGE_INFO, MESSAGE_WARNING, MESSAGE_ERROR, };</code> </pre><br>  The following method is for creating an instance of a class.  Direct creation is prohibited by placing the constructor in a protected area. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre><br>  The last available public method is designed to set the log level.  Everything else is closing.  This is a preliminary log interface - in the following we will show how to actually display messages. <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setDebugLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DebugLevel level)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>:</code> </pre><br>  The protected area is opened by the promised closed constructor. <br><br><pre> <code class="cpp hljs"> Log();</code> </pre><br>  The only pure virtual method is for platform-specific output of the IDE console. <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeIDEDebugString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&amp; message, MessageType type)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>:</code> </pre><br>  The following three methods will serve to directly output each type of alert.  So that the programmer does not accidentally use them, they are hidden in a private area of ‚Äã‚Äãthe class. <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&amp; message)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeWarning</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&amp; message)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&amp; message)</span></span></span></span>;</code> </pre><br>  Output method to file.  Here its implementation will not be given, since it has no direct relation to the topic of the article. <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">appendToFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&amp; message)</span></span></span></span>;</code> </pre><br>  Well, you will need a service function to generate a debug message.  Usually a timestamp and a sign of the level of importance of the line are added to each message. <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&amp; message, MessageType type)</span></span></span></span>;</code> </pre><br>  From the data of the class we need to store the level of log detail and its instance. <br><br><pre> <code class="cpp hljs"> DebugLevel mDebugLevel; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Log* sInstance; };</code> </pre><br>  Consider the implementation of some methods <br>  The message output functions are of the same type, so we limit ourselves to considering the source code of the error message as the most complete. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Log::writeError(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&amp; message) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mDebugLevel &gt;= DEBUG_LEVEL_ERROR) { writeMessage(getLogString(message, <span class="hljs-string"><span class="hljs-string">"error"</span></span>), MESSAGE_ERROR); } <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> _DEBUG assert(0); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> exit(EXIT_FAILURE); }</span></span></code> </pre><br>  So, first of all, it is checked that the level of detail permits error output, then the service method writeMessage is called, to which the message and the type of the message are transmitted.  As a result, something like this will be displayed. <br>  <b>error: [message]</b> <br><br>  To attract the attention of the developer, even if the error output is disabled, the assert macro is called.  In addition, at the end of the subroutine, the application terminates.  Such a solution can hardly be called universal, but in our application, an error indicates a problem that is incompatible with further work. <br><br>  The output of the warning is implemented in the same way, only without abnormal termination of the application.  The informational message method also does not contain the assert interrupt. <br><br>  In turn, writeMessage looks like this. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Log::writeMessage(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&amp; message, MessageType type) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">text</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::replace(text.begin(), text.end(), <span class="hljs-string"><span class="hljs-string">'\n'</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>); appendToFile(text); <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> _DEBUG writeIDEDebugString(text, type); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> }</span></span></code> </pre><br>  Its role is to remove line-breaks from the message so that each message of the log is guaranteed to be single-line, to call the write method to the file and, if the debug mode is on, output to the IDE console. <br><br>  Debug mode is defined by the _DEBUG macro, which is usually automatically defined in Visual Studio.  In other development environments, you will most likely need to add it manually.  In any case, it does not cause much difficulty. <br><br><img src="https://habrastorage.org/storage2/b68/427/6fe/b684276fe3081bd47dd005f53f0900e4.png"><br>  <b>Figure 2.</b> Macro debug definition for Xcode <br><br>  Further, for each platform, you need to define your own log class, inherited from the base class with overriding the writeIDEDebugString method.  I will give examples of its implementation for some platforms. <br><br><h6>  Windows (Visual Studio) </h6><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Log_Windows::writeIDEDebugString(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&amp; message, MessageType type) { OutputDebugStringA(message.c_str()); OutputDebugStringA(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>); }</code> </pre><br><h6>  Android (Eclipse) </h6><br>  void Log_Android :: writeIDEDebugString (const String &amp; message, MessageType type) <br><pre> <code class="cpp hljs">{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(type){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MESSAGE_INFO: __android_log_print(ANDROID_LOG_INFO, <span class="hljs-string"><span class="hljs-string">""</span></span>, message.c_str()); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MESSAGE_WARNING: __android_log_print(ANDROID_LOG_WARN, <span class="hljs-string"><span class="hljs-string">""</span></span>, message.c_str()); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MESSAGE_ERROR: __android_log_print(ANDROID_LOG_ERROR, <span class="hljs-string"><span class="hljs-string">""</span></span>, message.c_str()); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre><br>  As you can see, in the case of Android, we get additional visibility: it is possible to display messages in different colors.  The problem, displayed in red, has little chance of escaping attention, even without assert. <br><br><img src="https://habrastorage.org/storage2/a3b/b4e/bc0/a3bb4ebc0205f507c63394f029dba964.png"><br>  <b>Figure 3.</b> Color highlighting messages depending on the type in Eclipse <br><br><h6>  MacOS and iOS (Xcode) </h6><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Log_Mac::writeIDEDebugString(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&amp; message, MessageType type) { NSLog(@<span class="hljs-string"><span class="hljs-string">"%s"</span></span>, message.c_str()); }</code> </pre><br>  With a direct conclusion figured out, the question remains, how to properly pack it into streams.  After all, we have closed all methods of withdrawal. <br><br>  To begin, we define the desired record.  C ++ streams can receive output parameters in the same way that they are passed data.  For example, the message will be displayed in capital letters. <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::uppercase &lt;&lt; <span class="hljs-string"><span class="hljs-string">"test"</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">'\n'</span></span>;</code> </pre><br>  Here, of course, as anyone, but personally I could not accept the mixing of the output information and output parameters.  Therefore, in the example the output will be implemented as follows. <br><br><pre> <code class="cpp hljs">Log::error&lt;&lt;<span class="hljs-string"><span class="hljs-string">"text"</span></span>&lt;&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; Log::warning&lt;&lt;<span class="hljs-string"><span class="hljs-string">"text"</span></span>&lt;&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; Log::message&lt;&lt;<span class="hljs-string"><span class="hljs-string">"text"</span></span>&lt;&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>;</code> </pre><br>  Those.  The message type information will be contained in the stream object itself.  Of course, the standard parameters of streams like std :: uppercase can still be used.  All thread functionality is inherited from the standard library classes. <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Streamer</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::ostream { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Streamer(MessageType messageType); ~Streamer(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StringBuffer</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::stringbuf { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Buffer(MessageType messageType); ~Buffer(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sync</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: MessageType mMessageType; }; };</code> </pre><br>  For each type of flow will be its object, so the constructors take the parameter MessageType.  We inherit the output class itself from std :: ostream [5], the nested class StringBuffer, which in turn inherits from std :: stringbuf [6], will be responsible for forming the string.  Each time a user reports the completion of a message, the <b>sync</b> method will be automatically called, in which we will execute an immediate output.  You can report the completion of the output in standard ways for buffered threads: by calling the <b>flush</b> method <br><br><pre> <code class="cpp hljs">Log::message&lt;&lt;<span class="hljs-string"><span class="hljs-string">"text"</span></span>; Log::message.flush();</code> </pre><br>  or simply adding <b>std :: endl</b> to the stream <br><br><pre> <code class="cpp hljs">Log::message&lt;&lt;<span class="hljs-string"><span class="hljs-string">"text"</span></span>&lt;&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>;</code> </pre><br>  You also need to associate the output stream with a string buffer.  This is done in the constructor. <br><br><pre> <code class="cpp hljs">Log::Streamer::Streamer(Log::MessageType messageType) : <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::ostream(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuffer(messageType)) { }</code> </pre><br>  Accordingly, when destroying, the buffer must be independently destroyed. <br><br><pre> <code class="cpp hljs">Log::Streamer::~Streamer() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delete</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rdbuf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre><br>  In the constructor of the buffer, it is enough to remember the type of the displayed message. <br><br><pre> <code class="cpp hljs">Log::Streamer::StringBuffer:: StringBuffer(Log::MessageType messageType) : mMessageType(messageType) { }</code> </pre><br>  When destroying, just in case, we call its synchronization - this will prevent the message from ‚Äúdisappearing‚Äù if the programmer forgets to call flush or endl. <br><br><pre> <code class="cpp hljs">Log::Streamer::Buffer::~Buffer() { pubsync(); }</code> </pre><br>  In order for the stream to have access to the main interface of the Log class that is closed to the outside world, we will put it inside <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Log</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: ... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Streamer</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::ostream { ... }; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Streamer message; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Streamer warning; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Streamer error; ...</code> </pre><br>  message warning and error are stream instances for each type of message.  The message type is passed to them in the constructor. <br><br><pre> <code class="cpp hljs">Log::Streamer Log::message(Log::MESSAGE_INFO); Log::Streamer Log::warning(Log::MESSAGE_WARNING); Log::Streamer Log::error(Log::MESSAGE_ERROR);</code> </pre><br>  And finally, consider the implementation of the synchronization function of the string buffer of the stream. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Log::Streamer::StringBuffer::sync() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Log::sInstance == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">text</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(str())</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (text.empty()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } str(<span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (mMessageType) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MESSAGE_INFO: Log::sInstance-&gt;writeMessage(text); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MESSAGE_WARNING: Log::sInstance-&gt;writeWarning(text); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MESSAGE_ERROR: Log::sInstance-&gt;writeError(text); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br>  As a nested class <b>Log :: Streamer :: Buffer</b> has access to the private area of ‚Äã‚Äãthe <b>Log</b> .  <b>Only the str ()</b> function needs clarification.  This is a rather strange method of class std :: stringbuf, which simultaneously allows you to get and set the value of the buffer.  In both of its incarnations, it is used - first, using this function, we get a string from the buffer, and then clear the buffer with a call to <b>str ("")</b> . <br>  Everything, now the <b>Streamer</b> class becomes the ‚Äúofficial‚Äù <b>Log</b> interface.  To display the composite message ‚Äúi (6) should be in range [1..5]‚Äù, it is enough for a programmer to write <br><br><pre> <code class="cpp hljs">Log::warning &lt;&lt; <span class="hljs-string"><span class="hljs-string">"i ("</span></span> &lt;&lt; i &lt;&lt; <span class="hljs-string"><span class="hljs-string">") should be in range ["</span></span> &lt;&lt; I_MIN &lt;&lt; <span class="hljs-string"><span class="hljs-string">".."</span></span> &lt;&lt; I_MAX &lt;&lt; <span class="hljs-string"><span class="hljs-string">"]"</span></span> &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>;</code> </pre><br>  It's almost as easy as getting a much more vague "wrong i" <br>  Thus, an example was given of a fairly simple event logging class, which can be easily implemented at the very beginning of even the shortest deadline (when there is no time to either write tests, or persuade programmers, or effectively control them, or breathe, or sleep) of the project, significantly improving its quality. <br><br>  [1] <a href="http://en.wikipedia.org/wiki/Multiple_dispatch">en.wikipedia.org/wiki/Multiple_dispatch</a> <br>  [2] <a href="http://www.cplusplus.com/reference/cstdio/sprintf/">www.cplusplus.com/reference/cstdio/sprintf</a> <br>  [3] <a href="http://www.cplusplus.com/reference/sstream/stringstream/">www.cplusplus.com/reference/sstream/stringstream</a> <br>  [4] <a href="http://www.cplusplus.com/reference/cassert/assert">www.cplusplus.com/reference/cassert/assert</a> <br>  [5] <a href="http://www.cplusplus.com/reference/ostream/ostream/">www.cplusplus.com/reference/ostream/ostream</a> <br>  [6] <a href="http://www.cplusplus.com/reference/sstream/stringbuf/">www.cplusplus.com/reference/sstream/stringbuf</a> </div><p>Source: <a href="https://habr.com/ru/post/184486/">https://habr.com/ru/post/184486/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../184474/index.html">Advanced naval battle</a></li>
<li><a href="../184476/index.html">Product Management: See the product through the user's eyes</a></li>
<li><a href="../184478/index.html">Microsoft is preparing to reorganize</a></li>
<li><a href="../184482/index.html">Creating custom primitives in CAD on the MultiCAD .NET API</a></li>
<li><a href="../184484/index.html">Extending Symfony 2 Forms</a></li>
<li><a href="../184488/index.html">HTML5 circular panorama on three.js</a></li>
<li><a href="../184490/index.html">IBM Simon is the world's first smartphone. What's inside?</a></li>
<li><a href="../184492/index.html">Overview of the smartphone OPPO Find 5: "non-pop" flagship</a></li>
<li><a href="../184494/index.html">Escene US102 IP Phone Review</a></li>
<li><a href="../184496/index.html">Microsoft patents gestures to control the smartphone in the car</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>