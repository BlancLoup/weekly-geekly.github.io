<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Riddles and Myths SPF</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="SPF (Sender Policy Framework), the full name can be translated as "Sender Policy Basics for Authorizing Domain Use in Email" - a protocol through whic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Riddles and Myths SPF</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/edc/c49/db2/edcc49db28b54efb804b6f912fb2f8c4.jpg"></p><br><p>  SPF (Sender Policy Framework), the full name can be translated as "Sender Policy Basics for Authorizing Domain Use in Email" - a protocol through which an email domain can specify which Internet hosts are authorized to use this domain in the SMTP HELO and MAIL FROM commands.  Publication of the SPF policy does not require any additional software and is therefore extremely simple: just add a TXT record containing the policy to the DNS zone, an example of the record is at the end of the article.  To work with SPF there are numerous manuals and even online designers. </p><br><p>  The first version of the SPF standard was adopted more than 10 years ago.  During this time, numerous implementations were created, practical applications were developed, and a new version of the standard appeared.  But the most surprising thing is that for some reason SPF, more than any other standard, has been overgrown in 10 years with an incredible amount of myths and delusions that wander from article to article and with enviable regularity pop up in discussions and answers to questions on the forums.  And the protocol would seem so simple: the implementation takes only a couple of minutes.  Let's try to remember and disassemble the most frequent misconceptions. </p><br><p>  TL; DR - recommendations at the end. </p><a name="habracut"></a><br><h2 id="1-zabluzhdenie-spf-zaschischaet-moy-domen-ot-poddelok">  1. Misconception: SPF protects my domain from fakes </h2><br><p>  <strong>In fact:</strong> SPF does not protect the sender‚Äôs address visible to the user. </p><br><p>  <strong>Explanation:</strong> SPF does not work at all with the content of the letter that the user sees, in particular with the sender's address.  SPF authorizes and checks addresses at the transport mail (SMTP) level between two MTAs (envelope-from, RFC5321.MailFrom aka Return-Path).  These addresses are not visible to the user and may differ from those visible to the user from the From header of the letter (RFC5322.From).  Thus, a letter with a fake sender to From can easily pass SPF authorization. </p><br><h2 id="2-zabluzhdenie-ya-vnedryu-spf-i-stanet-bezopasney-i-menshe-spama">  2. Misconception: I will implement SPF and it will be safer and less spam </h2><br><p>  <strong>In fact:</strong> most likely, you will not notice any changes in security and spam. </p><br><p>  <strong>Explanation:</strong> SPF is initially an altruistic protocol and by itself does not benefit the one who publishes the SPF policy.  Theoretically, your SPF deployment could protect someone else from fake emails from your domain.  But in practice, even this is not the case, because the results of SPF are rarely used directly (see below).  Moreover, even if all domains published SPF, and all recipients forbade receiving letters without SPF authorization, this would hardly lead to a decrease in the level of spam. </p><br><p>  SPF does not protect the sender from spamming or spam directly, however, it is actively used and is very useful in spam filtering systems and for protection against fake emails, since  allows you to bind a letter to a specific domain and its reputation. </p><br><h2 id="3-zabluzhdenie-spf-otricatelno-polozhitelno-vliyaet-na-dostavlyaemost-pisem">  3. Misconception: SPF has a negative (positive) effect on the deliverability of letters. </h2><br><p>  <strong>In fact:</strong> It all depends on the type of letter and the way in which it is delivered. </p><br><p>  <strong>Explanation:</strong> SPF by itself does not affect the deliverability of letters by the normal flow, and negatively affects the wrong implementation or indirect flow of letters (indirect flow), when the user receives letters from the wrong server from which the letter was sent, for example, to redirected letters.  But spam filtering systems and reputation classifiers take into account the presence of SPF, which on the whole, on the main stream of letters, gives a positive result.  Unless, of course, you send spam. </p><br><h2 id="4-zabluzhdenie-spf-avtorizuet-otpravitelya-pisma">  4. Misconception: SPF authorizes the sender of the letter </h2><br><p>  <strong>Actually:</strong> SPF authorizes the mail server sending the letter on behalf of the domain. </p><br><p>  <strong>Explanation:</strong> First, SPF works only at the domain level, not for individual email addresses.  Secondly, even if you are a legal mail user of a specific domain, SPF does not allow you to send an email from anywhere.  In order for a letter to pass SPF validation, you should only send through an authorized server.  Thirdly, if you have authorized a server via SPF (for example, you have allowed sending emails from your domain through some ESP or hosting provider) and it doesn‚Äôt implement additional restrictions, then all users of this server can send emails on behalf of your domain.  All this should be considered when implementing SPF and authentication of letters in general. </p><br><h2 id="5-zabluzhdenie-pisma-ne-proshedshie-avtorizaciyu-spf-otseivayutsya">  5. Misconception: letters that did not pass SPF authorization are eliminated. </h2><br><p>  <strong>Actually:</strong> SPF-authorization or its absence in general does not drastically affect the delivery of letters. </p><br><p> <strong>Explanation: The</strong> SPF standard is only an authorization standard and explicitly indicates that actions applied to unauthorized letters are outside the standard and are determined by the local recipient policy.  The refusal to receive such letters leads to problems with letters going through indirect delivery routes, such as redirects or mailing lists, and this fact should be taken into account in local policy.  In practice, a strict failure due to the failure of SPF authorization is not recommended for use and is possible only when publishing with the <code>-all</code> (hardfail) policy in the absence of other filtering tools.  In most cases, SPF-authorization is used as one of the signs in the classifiers or as one of the factors in the weight systems.  Moreover, the weight of this factor is very small, because violation of SPF-authorization is usually not a reliable sign of spam - many spam letters pass SPF-authorization, but not completely legal - and this situation is unlikely to change drastically sometime.  With this use, there is no difference between <code>-all</code> and <code>~all</code> . </p><br><p>  The fact of having SPF authorization is important not so much for delivering the letter and deciding whether it is spam, but for confirming the sender's address and contacting the domain, which allows the letter to use not the IP reputation, but the reputation of the domain. </p><br><p>  The decision about the action on the letter that has not passed authorization is much more affected by the policy of DMARC.  The DMARC policy allows you to drop (or put in quarantine) all unauthorized emails or their percentage. </p><br><h2 id="6-zabluzhdenie-v-spf-nado-ispolzovat--all-hardfail-eto-bezopasney-chem-all-ili-all">  6. Misconception: in SPF you must use <code>-all</code> (hardfail), is it safer than <code>?all</code> or <code>~all</code> </h2><br><p>  <strong>In fact:</strong> in practice, <code>-all</code> does not affect anyone‚Äôs security, but it negatively affects the deliverability of letters. </p><br><p>  <strong>Explanation:</strong> <code>-all</code> results in blocking emails sent via indirect routes by those few recipients who use the SPF result directly and block emails.  At the same time, this policy will not have a significant effect on most spam and fake emails.  Currently, the most reasonable policy is considered <code>~all</code> (softfail), it is used by almost all large domains, even those that have very high security requirements (paypal.com, for example).  <code>-all</code> can be used for domains that are not sending legal emails.  For DMARC, <code>~</code> and <code>?</code>  are equivalent. </p><br><h2 id="7-zabluzhdenie-dostatochno-propisat-spf-tolko-dlya-domenov-s-kotoryh-otpravlyaetsya-pochta">  7. Misconception: it is enough to register SPF only for domains from which mail is sent. </h2><br><p>  <strong>Actually:</strong> it is also necessary to register SPF for the domains used by HELO mail servers, and it is desirable to prescribe a blocking policy for A-records and wildcard that are not used for sending mail. </p><br><p>  <strong>Explanation:</strong> In some cases, in particular, when delivering an NDR (undeliverable message), DSN (delivery confirmation message) and some auto-responses, the sender's address in the SMTP envelope (envelope-from) is empty.  In this case, the SPF verifies the host name from the HELO / EHLO command.  You need to check what name is used in this command (for example, looking at the server configuration or sending a letter to the public server and looking at the headers) and register the SPF for it. </p><br><p>  Spammers do not have to send spam from the same domains from which you send letters, they can send on behalf of any host with an A or MX record.  Therefore, if you publish SPF for altruistic reasons, then you need to add SPF for all such records, and preferably another wildcard (*) for non-existent records. </p><br><h2 id="8-zabluzhdenie-luchshe-dobavlyat-v-dns-zapis-specialnogo-tipa-spf-a-ne-txt">  8. Misconception: it is better to add a special type of SPF record to the DNS, and not TXT. </h2><br><p>  <strong>Actually:</strong> you need to add a TXT record. </p><br><p>  <strong>Explanation:</strong> In the current version of the SPF standard (RFC 7208), SPF records are deprecated and should not be used anymore. </p><br><h2 id="9-zabluzhdenie-chem-bolshe-vsego-a-mx-ptr-include-ya-vklyuchu-v-spf-zapis-tem-luchshe-potomu-chto-menshe-veroyatnost-oshibitsya">  9. Misconception: the more (a, mx, ptr, include) I include in the SPF record, the better, because there is less chance of a mistake </h2><br><p>  <strong>Actually:</strong> <code>ip4</code> possible, it is necessary to reduce SPF record as much as possible and use in it only network addresses via <code>ip4</code> / <code>ip6</code> . </p><br><p>  <strong>Explanation: A</strong> limit of 10 DNS requests has been assigned to the resolution of the SPF policy.  Exceeding it will result in a permanent policy error (permerror).  In addition, DNS is an unreliable service, and for every request there is a probability of failure (temperror), which increases with the number of requests.  Each additional <code>a</code> or <code>include</code> record requires an additional DNS request; for <code>include</code> also necessary to request everything specified in the include record.  <code>mx</code> requires a request for MX records and an additional request for A-record for each MX server.  <code>ptr</code> requires an additional request, moreover, in principle, it is unsafe.  Only network addresses listed via <code>ip4</code> / <code>ip6</code> do not require additional DNS queries. </p><br><h2 id="10-zabluzhdenie-ttl-dlya-spf-zapisi-sleduet-sdelat-pomenshe-pobolshe">  10. Misconception: the TTL for the SPF record should be made smaller (more) </h2><br><p>  <strong>In fact:</strong> as with most DNS records, it is better to have a TTL in the range from 1 hour to 1 day, reducing it in advance when implementing or planning changes and increasing it with a stable working policy. </p><br><p>  <strong>Explanation: A</strong> higher TTL reduces the likelihood of DNS errors and, as a result, temperror SPF, but increases the response time if you need to make changes to the SPF record. </p><br><h2 id="11-zabluzhdenie-esli-ya-ne-znayu-s-kakih-ip-mogut-uhodit-moi-pisma-to-luchshe-opublikovat-politiku-s-all">  11. Misconception: if I do not know from what IP my letters can leave, then it is better to publish the policy with <code>+all</code> </h2><br><p>  <strong>Actually: a</strong> policy with an explicit <code>+all</code> or implicit rule allowing mailing on behalf of the domain from any IP addresses will negatively affect mail delivery. </p><br><p>  <strong>Explanation:</strong> This policy has no meaning and is often used by spammers to provide SPF authentication on spam emails sent through botnets.  Therefore, a domain that publishes such a policy has a very big chance of being blocked. </p><br><h2 id="12-zabluzhdenie-spf-bespolezen">  12. Misconception: SPF is useless </h2><br><p>  <strong>Actually:</strong> SPF is needed. </p><br><p>  <strong>Explanation:</strong> SPF is one of the sender's authorization mechanisms in email and a way to identify a domain in reputation systems.  Currently, major postal service providers are gradually beginning to require the authorization of letters, and letters that do not have authorization may be subject to "penalties" for their delivery or display to the user.  In addition, emails that have not passed SPF authorization may not return auto-responses and delivery reports or undeliverable.  The reason is that these response categories, as a rule, go to the address of the SMTP envelope and require that it be authorized.  Therefore, SPF is required even if all letters are authorized by DKIM.  Also, SPF is absolutely necessary in IPv6 networks and cloud services: in such networks it is almost impossible to use the reputation of IP addresses and letters from addresses not authorized by SPF, as a rule, are not accepted.  One of the main objectives of SPF, defined in the standard, is the use of domain name reputation instead of IP reputation. </p><br><h2 id="13-zabluzhdenie-spf-samodostatochen">  13. Misconception: SPF is self-sufficient </h2><br><p>  <strong>Actually:</strong> DKIM and DMARC are also needed. </p><br><p>  <strong>Explanation:</strong> DKIM is required for passing letters through various forwarding.  DMARC is required to protect the sender's address from counterfeit.  In addition, DMARC allows you to receive reports of SPF policy violations. </p><br><h2 id="14-zabluzhdenie-esli-server-peresylaet-pisma-neobhodimo-ispolzovat-srs-sender-rewriting-schema-dlya-sohraneniya-spf-avtorizacii">  14. Fallacy: if the server forwards emails, you must use SRS (Sender Rewriting Schema) to save SPF authorization. </h2><br><p>  <strong>In fact:</strong> SRS should be used only if you want to give the redirected letters authorization (and, as a result, reputation) of your domain. </p><br><p>  <strong>Explanation:</strong> SRS rewrites the envelope address of the sender to the address from the domain of the forwarding server, so the SPF authorization is performed for the letter with the domain performing the redirection.  However, the sender's RFC5322.From domain for such a letter will not match the domain of the envelope for which the SPF authorization is being passed.  From the point of view of DMARC, such authorization is not considered valid.  In addition, the forwarded letter receives domain authorization if there are situations in which spam letters are redirected (for example, the general flow of letters is forwarded in which even if there is good spam filtering there is a certain amount of spam) - this negatively affects the reputation of the redirecting domain and vice versa, distributes spam domain reputation.  It makes sense to use SRS where incoming emails go through additional authorization and spam filtering, for example, in mailing lists with restriction by senders, possibly in conjunction with the From rewrite option to preserve DMARC authentication.  In all other cases, it is better to pay attention to the fact that the shipments preserve the integrity of the DKIM signature. </p><br><h2 id="15-zabluzhdenie-spf1-horosho-spf20--luchshe">  15. Misconception: spf1 is good, spf2.0 is better </h2><br><p>  <strong>Actually:</strong> you must use <code>v=spf1</code> . </p><br><p>  <strong>Explanation:</strong> spf2.0 does not exist.  Posting a spf2.0 entry may produce unpredictable results.  spf2.0 never existed and was not a standard, but there is a reference to it in a series of experimental standards, the most famous of which is RFC 4406 (Sender ID).  This series of standards was developed by an independent working group, in parallel with the adoption of the spf standard, which caused confusion.  Sender ID, which was supposed to solve the problem of address spoofing, did not become a generally accepted standard and should be abandoned in favor of DMARC.  Even if you decide to use the Sender ID and publish the spf2.0 record, it will not replace the spf1 record. </p><br><p>  I almost finished writing this article when I was intercepted by the customer support service and I strongly (with the threat of brute force) recommended recalling the following SPF nuances that they often come across when solving problems: </p><br><ol><li>  The SPF policy must end with the <code>all</code> or <code>redirect</code> directive.  After these directives, nothing should go. </li><li>  <code>all</code> or <code>redirect</code> directives can occur in a policy exactly once, they replace each other (that is, in one policy <code>all</code> and <code>redirect</code> cannot be simultaneously). </li><li>  The <code>include</code> directive does not replace the <code>all</code> or <code>redirect</code> directives.  <code>include</code> may occur in a policy several times, but the policy should still be terminated with <code>all</code> or <code>redirect</code> directives.  A policy included in an <code>include</code> or <code>redirect</code> must also be a valid policy ending in an <code>all</code> or <code>redirect</code> directive.  At the same time, it <code>-all</code> not matter for <code>include</code> which rule ( <code>-all</code> , <code>~all</code> <code>?all</code> ) is used for <code>all</code> in the included policy, and for <code>redirect</code> there is a difference. </li><li>  The <code>include</code> directive is used with a colon ( <code>include:example.com</code> ), the <code>redirect</code> directive is with an equal sign ( <code>redirect=example.com</code> ). </li><li>  SPF does not apply to subdomains.  SPF.  Not.  Spreads.  On.  Subdomains.  SPF DOES NOT SPREAD ON SUB-DOMAINS.  (and DMARC, by default, is distributed).  You need to publish SPF for each A or MX record in the DNS, which is (or can be) delivered mail. </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/web/d0e/a24/79c/d0ea2479c97c4c1a887ca0702b4db8c6.jpg"></div><br><h2 id="rezyume">  Summary </h2><br><ul><li>  Be sure to create a policy for all MX and preferably A records. </li><li>  Add SPF policies for names used in the HELO / EHLO mail server. </li><li>  Publish the SPF policy as a TXT record with <code>v=spf1</code> in DNS. </li><li>  In policy, mainly use network addresses specified via <code>ip4</code> / <code>ip6</code> .  Place them at the beginning of the policy to avoid unnecessary DNS queries.  Minimize the use of <code>include</code> , do not use a <code>include</code> , <code>a</code> , without extreme and irresistible need, do not use <code>mx</code> and never use <code>ptr</code> . </li><li>  Specify <code>~all</code> for domains from which emails are actually sent, and <code>-all</code> for unused domains and records. </li><li>  Use small TTLs for implementation and testing, then increase TTL to reasonable values.  Reduce the TTL in advance if you need to make changes. </li><li>  Be sure to test the correctness of the SPF policy, for example, <a href="https://mxtoolbox.com/spf.aspx">here</a> . </li><li>  Do not be limited to SPF, try to implement DKIM and be sure to implement DMARC.  DMARC helps protect your fake emails and allows you to receive information on SPF violations.  This will allow you to identify fakes, indirect flow of letters and configuration errors. </li><li>  After implementing SPF, DKIM and / or DMARC, check them using <a href="https://postmaster.mail.ru/security/">https://postmaster.mail.ru/security/</a> . <br>  SPF and DMARC are checked for the current state, the presence of DKIM is checked against the statistics for the previous day and will only be shown if there are correspondence with mailboxes on Mail.Ru in the previous day or earlier. </li></ul><br><p>  An example SPF policy: <code>@ IN TXT "v=spf1 ip4:1.2.3.0/24 include:_spf.myesp.example.com ~all"</code> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/338700/">https://habr.com/ru/post/338700/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338686/index.html">Endless capacity node for Kubernetes</a></li>
<li><a href="../338690/index.html">Blackmailing programs: a threat to the past or the future?</a></li>
<li><a href="../338692/index.html">MBLTdev 2017: amazing iOS track</a></li>
<li><a href="../338696/index.html">Trust assurance method in blockchains</a></li>
<li><a href="../338698/index.html">Its build system on Linux</a></li>
<li><a href="../338702/index.html">"Open Sunday" at the partner seminar "1C"</a></li>
<li><a href="../338704/index.html">On the classification of Fourier transform methods by examples of their software implementation by means of Python</a></li>
<li><a href="../338710/index.html">Energy efficient data center: familiarity with international experience</a></li>
<li><a href="../338712/index.html">Kali Linux: system protection and monitoring exercises</a></li>
<li><a href="../338714/index.html">How to get to ITMO University Technopark</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>