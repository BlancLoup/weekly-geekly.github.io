<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience of using FPGA boards DE10-Standard and DMA PL330</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Got a Terasic DE10-Standard fee. It has a lot of interesting things: a built-in JTAG programmer, LEDs, switches, buttons, Audio / VGA / USB / Ethernet...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience of using FPGA boards DE10-Standard and DMA PL330</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/25f/841/934/25f8419348224051ac8599c06f9382c0.jpg"><br><br>  Got a Terasic DE10-Standard fee.  It has a lot of interesting things: a built-in JTAG programmer, LEDs, switches, buttons, Audio / VGA / USB / Ethernet connectors.  I think that there is no special need to list all its capabilities, because anyone can read the specification of the board <a href="http://www.terasic.com.tw/cgi-bin/page/archive.pl%3FLanguage%3DEnglish%26CategoryNo%3D205%26No%3D1081%26PartNo%3D2">on the manufacturer‚Äôs website</a> . <br><br>  For me, it is important that the board is an FPGA chip Cyclone V SX - 5CSXFC6D6F31C6N.  This microcircuit contains two ARM Cortex-A9 and 110K FPGA gates.  This is the real SoC HPS: System-On-Chip, Hard Processor System.  With such resources, you can try to do quite complex projects.  Further I will tell about my experience of using the board. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is very easy to download <a href="http://www.terasic.com.tw/cgi-bin/page/archive.pl%3FLanguage%3DEnglish%26CategoryNo%3D205%26No%3D1081%26PartNo%3D4">a Linux image from the site of a web site</a> and prepare a bootable SD card for the DE10-Standard board.  Linux OS boots from SD, the board comes to life and demonstrates its capabilities. <br><br><img src="https://habrastorage.org/web/ace/310/86c/ace31086c99f4fa985beb2aae6dcaca8.jpg"><br><br>  Once Linux has booted, you can find the test application icon on your desktop.  This test GUI application allows you to turn on and off individual LEDs on the board, view the status of switches and buttons, set values ‚Äã‚Äãon 7-segment indicators, and so on.  There are a lot of interesting things.  When I played with this program, you think that now you can quickly make your own project and launch it quickly. <br><br>  I do not consider myself a new FPGA developer.  I did <a href="https://marsohod.org/projects/marsohod2/amber-arm-soc">projects with software processors</a> and imagine what a Linux kernel is.  I myself participate in the development of developer <a href="https://marsohod.org/projects">boards with Altera / Intel FPGAs</a> .  However, to be honest, this is my first experience with SoC HPS-FPGA.  When I started to make my own project for this board, precisely for this FPGA, I realized that in fact it would not be easy. <br><br><img src="https://habrastorage.org/web/8ee/cdf/e23/8eecdfe23f8848e298aa01a77022b6f9.jpg"><br><br>  Of course, the DE10-Standard board itself is not to blame.  There is some illusion of ease of development: here is an image of an SD card from terraces, there are source codes for a sample project for FPGAs and sishny sources for test programs.  It would seem, take adapt to your needs and everything will work.  But no. <br><br>  It is necessary to understand that the first impression of ease of development is deceptive.  What can be seen at first sight is just the tip of the iceberg. <br><br>  I had to read and study a lot, for example: <br><br>  1. A DE10-Standard_v.1.2.0_SystemCD disk is attached to the board and it contains 38 PDF files of various documentation, diagrams and manuals. <br><br>  2. A simple technical description from Intel's ‚Äú <a href="https://www.altera.com/en_US/pdfs/literature/hb/cyclone-v/cv_5v4.pdf">Cyclone V Hard Processor System Technical Reference Manual</a> ‚Äù contains 3536 pages. <br><br>  Of course, I don‚Äôt have to read them all at once, I thought I wouldn‚Äôt read them at all, I‚Äôll manage with my knowledge and experience, but I still had to read and understand. <br><br>  There is still a <a href="https://rocketboards.org/">good resource</a> that contains even more documentation, source codes of examples and even a forum.  It makes life on the one hand easier, and on the other - even more difficult, because you have to read and absorb even more information ... Unfortunately, even on the rocketboard forum, it is not always possible to find answers to your questions. <br><br>  Thus, the development of the project is quite complex, because the subject of the development of SoC HPS is difficult. <br><br><img src="https://habrastorage.org/web/aa9/eee/483/aa9eee483c634a46a53e4986e87d9eea.jpg"><br><br>  Imagine a clock mechanism with lots of gears.  Each gear must exactly match the next one - otherwise nothing will spin.  The same is the case with the HPS-FPGA system.  The system consists of a lot of software and hardware components: Preloader, U-BOOT, Linux kernel and driver, a DTB file is generated from the DTS file, then RootFS must be created and, of course, the hardware system in the FPGA is developed: the FPGA SoC project will contain several IP blocks, hardware registers mapped into memory, clock frequencies and domains, I / O signals and so on and so forth ... <br><br>  I suppose that I know how to create a project for an FPGA for my SoC, and I think that it should work well for about 80% since I do not see obvious errors in the project.  I also think about how to write a DTS file that describes my hardware platform.  Suppose I am sure that I wrote the DTS file correctly at 80%.  A DTB file is generated from the DTS file.  Then, to my FPGA hardware, I have to write a kernel driver.  It's not easy, but I can write drivers.  I hope I did not make a lot of mistakes there?  I hope my driver is correct, well, at least 80%.  But what about the Preloader?  Preloader is the first program to be read and launched from the SD card and it must program the necessary hardware configuration registers of the system on a chip.  Have I made the Preloader correctly?  Well, let's say, I'm 80% sure.  Now, if you think about it, what is the probability that my system will work?  I think that somewhere like this: 0.8 * 0.8 * 0.8 * 0.8 = 0.4096 ... The more components in the system, the worse.  If something does not work or nothing at all (for example, kernel panic), then it is rather difficult to understand where the problem is - it can be everywhere. <br><br>  The purpose of my work was to make an HPS-FPGA project that uses DMA transactions to transfer data from system memory to FPGA and back from FPGA to system memory.  Using DMA should unload the processor.  On Habr√© there <a href="https://habrahabr.ru/company/metrotek/blog/248145/">was</a> already <a href="https://habrahabr.ru/company/metrotek/blog/248145/">an article about the implementation of DMA in FPGA Cyclone V</a> , however, I did not want to go by creating my own controller, as <a href="https://habrahabr.ru/users/des333/" class="user_link">Des333</a> did ... I wanted to use the PL330 controller already in the system. <br><br>  Working with the DE10-Standard Board for a while, I gained invaluable experience.  If I may, I want to give some advice to those who decide to start developing SoC HPS in FPGA. <br><br><h3>  Prepare a fee for development </h3><br>  This is probably an obvious tip.  There is an SD card image that contains the necessary files to start the system: an FPGA image, a DTB file, a U-BOOT, and a Linux kernel zImage.  Additional sections contain Preloader and RootFS.  If I develop a SoC HPS project for the FPGA, I compile it in the Quartus Prime CAD environment and the result (RBF, Raw Binary File) should be written to the SD card.  Then I compile the Linux kernel and my driver as part of the kernel.  I also need to write the resulting files to the SD Card. <br><br>  There is no point in pulling the SD card out of the board, and inserting it into the card reader of a computer or laptop to write files to the card.  This may take too much time.  In addition, frequent plug / unplug may break the SD card slot in the card or laptop.  I recommend configuring U-BOOT so that the necessary files are downloaded from the network from the TFTP server. <br><br>  The board has a UART-to-USB connector for connecting it via a USB cable to the developer's computer.  I open the terminal program, for example, PUTTY, and turn on the board.  We immediately see how the messages from the U-BOOT ran in the terminal.  Download can be interrupted if you immediately press any key in the terminal. <br><br>  I added some variables to the U-BOOT environment: <br><br><pre><code class="hljs sql">ethaddr=fe:cd:12:34:56:67 ipaddr=10.8.0.97 serverip=10.8.0.36 xfpga=tftpboot 100 socfpga.rbf; fpga <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> $filesize; run bridge_enable_handoff; tftpboot 100 socfpga.dtb xload=run xfpga; tftpboot 8000 zImage; bootz 8000 ‚Äì 100</code> </pre> <br>  On the computer of the IP developer 10.8.0.36 I installed the TFTP server.  In the <i>/ tftpboot</i> folder, I store <i>socfpga.rbf</i> (Raw Binary File) - the result of compiling the SoC FPGA project in Quartus Prime.  In addition, I also store <i>socfpga.dtb</i> in the same folder - the corresponding Device Tree Blob and Linux kernel zImage file. <br><br>  Now, when I turn on the power on the board, I immediately interrupt the normal download by pressing any key in the terminal and enter the command: <br> <code>&gt;run xload</code> <br> <br>  With this command, U-BOOT downloads the necessary files from the TFTP server, initializes the FPGA with the latest compiled image of the project and loads my last zImage.  Quick and easy.  When I make a change in the FPGA project, I compile the project with a quarter, copy the result to the <i>/ tftpboot</i> folder.  In the same way, I compile the Linux kernel, I copy the result of the compilation to the <i>/ ftfpboot</i> folder.  Reboot the board, do a ‚Äúrun xload‚Äù and now you can try to debug the new system. <br><br><h3>  2. Try to find the opensource example of the SoC-HPS project as similar as possible to what you are going to do. </h3><br>  Captain obvious.  Of course, a competent engineer can do everything from scratch.  However, you can save some time by finding the source of a project similar to the one you are going to do. <br><br>  The original DE10-Standard_v.1.2.0_SystemCD contains two sample projects for HPS-FPGA.  The first project is the DE10_Standard_GHRD, which is a minimal feature, the Linux console, a simple memory-mapped peripheral, such as I / O ports for LEDs, buttons and switches.  The second example, DE10_Standard_FB, is more complicated.  Here, a framebuffer, a video controller, a device for capturing and decoding a video signal, and a number of other possibilities are already implemented in the FPGA.  This allows you to run a full-fledged desktop Linux.  If you are satisfied with these examples - then everything is fine, take and use. <br><br>  Personally, I wanted to find an example using the DMA controller, since I wanted to unload the CPU during data transfer from system memory to FPGA and back from FPGA to system memory.  I looked for such an example and found it on <a href="https://rocketboards.org/foswiki/view/Documentation/SampleDmaQuartusProjectForFpgaDmaCInTheKernel313">the rocketboards site</a> . <br><br>  An example is actually not very, but at least something, you can try to do something.  Cyclone V HPS has a PL330 built-in DMA controller and I would like to try using it.  I took the IP crust from the Loopback_FIFO example project and inserted it using the Quartus Prime QSYS into my clone of the DE10_Standard_GHRD project.  Unfortunately, I spent a lot of time writing the correct DTS file to my project, the DTS file was not in the sample archive.  Also, I did not immediately realize that the Linux kernel already has an example of a DMA driver in <i>arch / arm / mach-socfpga / fpga-dma.c</i> .  I realized it was too late when I almost wrote my own driver. <br><br>  Despite these difficulties, I still advise you to start your development by searching for existing examples, projects and solutions.  Find a few examples, choose the best one for you - start with it. <br><br><h3>  3. Use the Linux kernel source as documentation </h3><br>  With Cyclone V HPS FPGA, I am developing a new hardware platform.  Most likely I will have to write my own driver for the new hardware in the FPGA.  There are a lot of articles on the Internet on how to write Linux kernel level drivers.  But keep in mind that many of these articles are outdated a long time ago, contain incorrect examples, and call the old kernel API. <br><br>  If you select a specific version of the Linux kernel for a project, then all the information about how to write drivers can be gathered specifically from the sources of this version of the kernel and this will be the most up-to-date information.  Examples of drivers in the <i>./drivers</i> folder, current documentation in the <i>./Documentation</i> folder, examples of writing * .DTS files in the <i>./arch/arm/boot/dts</i> folder <br><br>  In my case, for my project with a DMA controller, the documentation about writing DMA drivers was obtained from <i>./Documentation/dmaengine/*</i> files. <br><br>  The kernel sources can help in writing the DTS file - for me the DTS file was a very big problem.  The DTS file in text form describes the hardware resources of the system.  Then DTS is compiled into a DTB file, which is then used by the kernel in such a way that drivers can know which resources belong to the devices. <br><br>  As I understand it, theoretically, the development should go like this: <br><br><ol><li>  We develop the hardware system in the Quartus Prime QSYS CAD system, configure the HPS parameters, add components and IP cores to the system, connect the components.  Generate the system using QSYS and get the result <i>soc_system.qsys</i> and <i>soc_system.sopsinfo</i> files. </li><li>  Create a DTS file from a * .sopsinfo file using the command line: <br> <code>&gt;sopc2dts --input soc_system.sopcinfo --output socfpga.dts --board soc_system_board_info.xml --board hps_clock_info.xml</code> <br> </li><li>  Create a DTB from a DTS file: <br> <code>&gt;dtc -I dts -O dtb -o socfpga.dtb socfpga.dts</code> <br> </li></ol><br>  I read this manual <a href="https://rocketboards.org/foswiki/view/Documentation/GSRD131DeviceTreeGenerator">on the rocketboards pages</a> , but this method somehow does not work very well (does not work at all).  For myself, I realized that the only working method is to manually correct an existing example of a DTS file by adapting it to your hardware project. <br><br>  As I already wrote, kernel sources can help in writing a DTS file.  I really did not immediately understand this, but when I did, it went faster.  You need to use the kernel source as documentation! <br><br>  Let's see an example of a DMA driver from <i>./driver/dma/fpga-dma.c</i> <br><br>  The driver calls the API function <i>platform_driver_probe ()</i> and passes a pointer to the structure as an argument: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> CONFIG_OF static const struct of_device_id fpga_dma_of_match[] = { {.compatible = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"altr,fpga-dma"</span></span></span><span class="hljs-meta">,}, {}, }; MODULE_DEVICE_TABLE(of, fpga_dma_of_match); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> static struct platform_driver fpga_dma_driver = { .probe = fpga_dma_probe, .remove = fpga_dma_remove, .driver = { .name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"fpga_dma"</span></span></span><span class="hljs-meta">, .owner = THIS_MODULE, .of_match_table = of_match_ptr(fpga_dma_of_match), }, }; static int __init fpga_dma_init(void) { return platform_driver_probe(&amp;fpga_dma_driver, fpga_dma_probe); }</span></span></code> </pre> <br>  This means that in the DTS file there must be a corresponding section with a compatible device name: <br><br> <code>fpga_dma: fpga_dma@0x10033000 { <br> compatible = " <b>altr,fpga-dma</b> ";</code> <br> <br>  That is, apparently the function <i>platform_driver_probe</i> will scan the DTB file to search for a device named fpga-dma from the manufacturer altr. <br><br>  If the driver calls functions <br><br><pre> <code class="cpp hljs">csr_reg = platform_get_resource_byname(pdev, IORESOURCE_MEM, <span class="hljs-string"><span class="hljs-string">"csr"</span></span>); data_reg = platform_get_resource_byname(pdev, IORESOURCE_MEM, <span class="hljs-string"><span class="hljs-string">"data"</span></span>);</code> </pre> <br>  This means that the DTS file must contain named registers with the same exact names ‚Äúcsr‚Äù and ‚Äúdata‚Äù.  Otherwise, the driver will not be able to start. <br><br>  In the same way, the kernel driver can query DMA channels by the name: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fpga_dma_dma_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct fpga_dma_pdata *pdata)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">platform_device</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pdev</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pdata</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pdev</span></span></span><span class="hljs-class">;</span></span> pdata-&gt;txchan = dma_request_slave_channel(&amp;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"tx"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pdata-&gt;txchan) dev_dbg(&amp;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"TX channel %s %d selected\n"</span></span>, dma_chan_name(pdata-&gt;txchan), pdata-&gt;txchan-&gt;chan_id); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> dev_err(&amp;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"could not get TX dma channel\n"</span></span>); pdata-&gt;rxchan = dma_request_slave_channel(&amp;pdev-&gt;dev, <span class="hljs-string"><span class="hljs-string">"rx"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pdata-&gt;rxchan)</code> </pre> <br>  And here is the corresponding fragment of the DTS file, which reflects the correlation of the kernel driver source and the DTS file: <br><br><pre> <code class="hljs xml">fpga_dma: fpga_dma@0x10033000 { compatible = "altr,fpga-dma"; reg = <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">0x00000001</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">0x00033000</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">0x00000020</span></span></span><span class="hljs-tag">&gt;</span></span>, <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">0x00000000</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">0x00034000</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">0x00000010</span></span></span><span class="hljs-tag">&gt;</span></span>; reg-names = "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span>csr<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span>", "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span>data<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span>"; dmas = <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">&amp;hps_0_dma</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span><span class="hljs-tag"> &amp;</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hps_0_dma</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span><span class="hljs-tag">&gt;</span></span>; dma-names = "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span>rx<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span>", "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span>tx<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span>";</code> </pre> <br>  Thus, the DTS file must be written taking into account how the driver requests resources from it.  If the named registers and the DMA channels are used, the names must match in the kernel source and in the DTS file.  Only in this way are the two gears of the system: the kernel driver and the DTS / DTB can work together. <br><br><h3>  4. Remember that your source may not be the freshest. </h3><br>  I needed a compiler and source code for the Linux kernel so that I could start developing my driver and compiling the kernel for my FPGA system.  That is why I downloaded the last (at that time) Intel SoC FPGA Embedded Development Suite v17.0 and installed it. <br><br>  After the full installation, I saw a new folder <i>~ / intelFPGA / 17.0 / embedded / embeddedsw / sources</i> , where the git_clone.sh script was located.  I ran this script and got the kernel source right here <i>~ / intelFPGA / 17.0 / embedded / embeddedsw / sources / linux-sources</i> . <br><br>  Git branch turned out like this: <i>sockfpga-4.1.22-ltsi-16.1-release</i> .  Kernel version 4.1.22 - so be it. <br><br>  I accepted version 4.1.22 as a given and started working with this thread on these sources.  I built a kernel and found that there is a DMA driver, called fpga-dma, and this driver works in general with my LoopbackFIFO IP core in my FPGA project.  However, I noticed that the performance of transferring data from the memory of the system to the FPGA and back is very small - the transfer is carried out by single transfers, one word for several cycles.  I rechecked my FPGA project a hundred times, and I rechecked the <i>fpga-dma.c</i> driver a hundred times, but I still could not understand why there is no burst transfers on the bus.  I already started to deal with the source code of the PL330 DMA driver itself.  Also, I had to read the Cyclone V Hard Processor System Technical Reference Manual about the HPS PL330 DMA controller.  This DMA controller is very complex, it itself has its own set of instructions, you need to write your own program to it.  An assembly language program for a PL330 DMA controller might look like this: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">DMAMOV</span></span> CCR, SB4 SS64 DB4 DS64 DMAMOV SAR, 0x1000 DMAMOV DAR, 0x4000 DMALP <span class="hljs-number"><span class="hljs-number">16</span></span> DMALD DMAST DMALPEND DMAEND</code> </pre> <br>  As a result of all my research, I realized that the driver <i>./drivers/dma/pl330.c</i> never initializes the CCR register of the DMA controller for a burst transfer.  I did not understand what to do, but later I discovered that newer versions of the kernel already <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/%3Fid%3D848e9776fee424b9368c72377de5d3509b17937c">contain a</a> fix for this misunderstanding. <br><br>  I manually added a patch to the source code of the DMA driver and received burst transfers!  Here is a screenshot from the SignalTap screen where I capture the DMA Mem-to-Device transfer: <br><br><img src="https://habrastorage.org/web/7ab/422/09b/7ab42209b6a14155a3ff29da118eaf14.png"><br><br>  Thus, if one day you encounter a technical problem that you don‚Äôt know how to solve, recheck: what if your problem already has a fix in the more recent source code for the Linux kernel?  As I understood, the problem with the block transfer of the DMA controller of PL330 is solved in kernel 4.6. <br><br><h3>  5. Carefully treat the individual parts of the system. </h3><br>  Of course, the development of an FPGA SoC system requires specific knowledge.  Now I do not want to touch on the features and methods of developing IP cores or the syntax Verilog / VHDL.  Of course, the developer should know a lot.  However, I want to note that forcing all parts of the system to work together is not a very simple task.  Too many gears that need to rotate synchronously. <br><br>  I will try to give an example and my practice. <br><br>  I tried to get the PL330 DMA controller driver to work with my IP core.  I encountered such a problem: write operations to the device are successful, but read operations always end with a timeout.  I tried to find a solution on the Internet and saw that many developers also ask about this problem, but there is no solution.  In the system log, I see a message from the fpga-dma driver ‚ÄúTimeout waiting for RX DMA!‚Äù.  But what's the problem?  - unclear.  Why is everything OK with TX transmission, but not with RX transmission?  I swapped the RX and TX channels in the FPGA project, and got the opposite ‚ÄúTimeout waiting for TX DMA!‚Äù.  What is wrong with my second DMA channel? <br><br>  I use Quartus Prime Qsys to edit my SoC.  One of the most important components of the SoC system is hps_0, the ‚ÄúArria V / Cyclone V Hard Processor System‚Äù.  I edited the properties of this component and made sure that I have both DMA channels turned on, and RX and TX: <br><br><img src="https://habrastorage.org/web/651/920/811/651920811f56433a9dda9435d5cd424b.png"><br><br>  is that enough?  In fact, of course not!  Qsys generates soc_system components for Quartus Prime, but it also creates software components in the <i>./hps_isw_handoff/soc_system_hps_0</i> folder. <br><br>  There is a file hps.xml in which you can see the following: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hps</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'DEVICE_FAMILY'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'Cyclone V'</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'DMA_Enable'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'Yes Yes No No No No No No'</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'dbctrl_stayosc1'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'true'</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'main_pll_m'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'73'</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'main_pll_n'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0'</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'main_pll_c0_internal'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'1'</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br>  This means that later I have to generate the Preloader component, and this XML file is used to compile it.  The compiled Preloader must be recorded in a special section of the SD card.  When the system starts, the Preloader starts.  That it includes all the necessary components of the system making the necessary entries in the special hardware registers. <br><br>  Cyclone V HPS Reset Manager registers are located at the physical address 0xFFD05000 (Cyclone V Hard Processor System Technical Reference Manual).  Some bits in the Reset Manager registers must be cleared to enable DMA on individual channels. <br><br>  Oh well.  I am changing the properties of the hps_0 component in Qsys and now I know that probably I should recompile Preloader and write it to SD. <br><br>  But this is not the whole story! <br><br>  If I use two DMA channels, then I need two interrupts for these two channels and they still need to be manually declared in the DTS file. <br><br> <code>hps_0_dma: dma@0xffe01000 { <br> compatible = "arm,pl330-16.1", "arm,pl330", "arm,primecell"; <br> reg = &lt;0xffe01000 0x00001000&gt;; <br> interrupt-parent = &lt;&amp;hps_0_arm_gic_0&gt;; <br> <b>interrupts = &lt;0 104 4&gt;, &lt;0 105 4&gt;;</b> <br> clocks = &lt;&amp;l4_main_clk&gt;;</code> <br> <br>  Where are such strange numbers 104 and 105? <br>  I had to read the Cyclone V HPS Reference Manual.  I see that Generic Interrupt Controller has reserved lines of DMA IRQ 136 and 137: <br><br><img src="https://habrastorage.org/web/367/10a/839/36710a8395dd463bba9aee8831cacdb4.png"><br><br>  However, for some reason the numbering begins ‚Äú32‚Äù.  So I decide that 136-32 = 104 and 137-32 = 105 are the correct numbers.  These magic calculations give the correct values ‚Äã‚Äãfor the DTS file in the interrupts section.  Without declaring the second IRQs for PL330 in the DTS file, the second DMA channel always got a timeout error in the kernel driver ... It turns out that I change the HPS properties in Qsys and because of this I may need to simultaneously change both the Preloader and the DTS file - and that‚Äôs all time to remember. <br><br><h3>  Conclusion </h3><br>  I had an initial project with an example of a DMA project, which I found on the pages of the rocketboard site.  However, I adapted it and made it work on the DE10-Standard board and with the Linux 4.1 kernel. <br><br>  This is probably not a great achievement, however: <br><br><ol><li>  I wrote a DTS file that was not in the original project.  It was quite difficult. </li><li>  I understood that it was necessary to make a kernel patch in order to get a block transfer (burst transfer). </li><li>  I connected the SignalTap analyzer to the FPGA project and now I can see the signals on the bus at the time of the DMA transfer </li><li>  Learned to write DMA kernel driver </li><li>  I hope that I understood the whole road-map of the developer for Cyclone V HPS </li></ol><br>  If someone wants to experiment with DMA in SoC, I recommend starting experiments with the Alter fpga-dma driver.  It uses DebugFS, which allows using simple ‚Äúcat‚Äù, ‚Äúecho‚Äù commands directly in the terminal console to perform transactions in the DMA channel: <br><br><img src="https://habrastorage.org/web/03d/5aa/f2b/03d5aaf2b15c469fbcdbfa2be476963f.png"><br><br>  I hope this article will be useful to those who are just starting to work with the FPSGA SoC HPS Cyclone V. <br><br>  View the source of the project <a href="https://github.com/marsohod4you/DE10_Standard_GHRD_w_FIFO">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/334154/">https://habr.com/ru/post/334154/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../334144/index.html">Virtual machine backup and freeze / thaw scripts InterSystems Cach√©</a></li>
<li><a href="../334146/index.html">A simple family budget tracker with AWS SES, Lambda and DynamoDB (and Route53)</a></li>
<li><a href="../334148/index.html">Enjoy! Isolate authentication server in open source</a></li>
<li><a href="../334150/index.html">Welcome to Tarantool Meetup August 10th</a></li>
<li><a href="../334152/index.html">Innovations of the main Russian Robotic Olympiad in the official video</a></li>
<li><a href="../334156/index.html">Cpp ‚ù§Ô∏è Mobile</a></li>
<li><a href="../334162/index.html">Is there an alternative to MS Windows, IE and CSP when accessing the personal accounts of the portals of the Government Procurement Portal, the Federal Tax Service of Russia and the State Services?</a></li>
<li><a href="../334166/index.html">Add the effect of clicking on Xamarin.Forms</a></li>
<li><a href="../334172/index.html">Tizen: sum up</a></li>
<li><a href="../334174/index.html">‚ÄúData mining now is an advantage in the market‚Äù: about the conference SmartData and Big Data</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>