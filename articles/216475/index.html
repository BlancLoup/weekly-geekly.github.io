<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>REST client and server on Yii</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Everyone who uses the Yii framework in development knows that the most commonly used access to databases is the built-in ORM component ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>REST client and server on Yii</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  Everyone who uses the Yii framework in development knows that the most commonly used access to databases is the built-in ORM component ActiveRecord.  However, at one point, I was faced with the fact that it was necessary to work with data physically located on several remote servers.  It was the development of a centralized management system for FTP and Radius users in a distributed network of the company where I work, connecting branches with the central office. <br><br>  In fact, there may be many situations when it may be necessary to work with data located on servers in different networks.  Short thoughts led to the decision to use the HTTP protocol and the <a href="http://habrahabr.ru/post/144011/">REST</a> approach based on it.  There were two reasons, the first and the main one is to learn how to develop both server and client parts using REST.  The second is the convenience of using the HTTP protocol, and in my case the fact that it is open on the vast majority of firewalls, and can also use proxy servers. <br><br>  Part of the source had to be inserted into the body of the article, because it turned out quite volume. <br><a name="habracut"></a><br><h4>  Getting started </h4><br>  So the decision is made.  At first glance it turns out a strange bunch.  Typically, the REST API is used by mobile applications, not sites.  It turns out that the user makes an HTTP request to my account management page, and the web server serving the page makes another HTTP request further to the server where the accounts are located directly.  And also implemented a REST API for managing them. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Server part </h5><br>  It was possible to use one of the ready-made solutions, for example, <a href="http://www.yiiframework.com/extension/restfullyii/">restfullyii</a> , however, I study and there was a desire to understand how it works or should work from the inside.  So let's invent our Wunderlike bike. <br><br>  How to make the server part yourself very detailed <a href="http://www.yiiframework.com/wiki/175/how-to-create-a-rest-api/">in the official project wiki</a> .  This decision was taken as a basis. <br><br>  The main magic of the REST authentication of the Yii application occurs in the <b>urlManager</b> settings at <i>protected / config / main.php</i> : <br><br><pre><code class="php hljs"><span class="hljs-string"><span class="hljs-string">'urlManager'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'urlFormat'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'path'</span></span>, <span class="hljs-string"><span class="hljs-string">'showScriptName'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-string"><span class="hljs-string">'rules'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-comment"><span class="hljs-comment">// REST patterns array('api/list', 'pattern' =&gt; 'api/&lt;model:\w+&gt;', 'verb' =&gt; 'GET'), array('api/view', 'pattern' =&gt; 'api/&lt;model:\w+&gt;/&lt;id:\d+&gt;', 'verb' =&gt; 'GET'), array('api/update', 'pattern' =&gt; 'api/&lt;model:\w+&gt;/&lt;id:\d+&gt;', 'verb' =&gt; 'PUT'), array('api/delete', 'pattern' =&gt; 'api/&lt;model:\w+&gt;/&lt;id:\d+&gt;', 'verb' =&gt; 'DELETE'), array('api/create', 'pattern' =&gt; 'api/&lt;model:\w+&gt;', 'verb' =&gt; 'POST'), // Other rules '&lt;controller:\w+&gt;/&lt;id:\d+&gt;'=&gt;'&lt;controller&gt;/view', '&lt;controller:\w+&gt;/&lt;action:\w+&gt;/&lt;id:\d+&gt;'=&gt;'&lt;controller&gt;/&lt;action&gt;', '&lt;controller:\w+&gt;/&lt;action:\w+&gt;'=&gt;'&lt;controller&gt;/&lt;action&gt;', ), ),</span></span></code> </pre> <br>  These rules translate the query of the form: <br><br> <code><a href="http://api.domain.ru/api/users"></a> POST api.domain.ru/api/users</code> <br> <br>  at <br><br> <code><a href="http://api.domain.ru/api/create%3Fmodel%3Dusers"></a> POST api.domain.ru/api/create?model=users</code> <br> <br>  What was disliked in this example is the approach when the model is loaded into the switch block in action-ah.  This implies, in the case of adding a new model to the project, modifying the controller, I wanted to make a more universal solution.  As a result, the following construction was used to create a model in action-ah: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_GET[<span class="hljs-string"><span class="hljs-string">'model'</span></span>])) $_model = CActiveRecord::model(ucfirst($_GET[<span class="hljs-string"><span class="hljs-string">'model'</span></span>]));</code> </pre><br>  Next, I give a full listing of the controller, which turned out in my case (I deliberately removed the implementation of the helper methods of the class, which are taken from the example by the link above without changes, and at the end of the chapter there is a link to the full source code for the Yii application): <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> APPLICATION_ID = <span class="hljs-string"><span class="hljs-string">'ASCCPE'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $format = <span class="hljs-string"><span class="hljs-string">'json'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_GET[<span class="hljs-string"><span class="hljs-string">'model'</span></span>])) $_model = CActiveRecord::model(ucfirst($_GET[<span class="hljs-string"><span class="hljs-string">'model'</span></span>])); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_model)) { $_data = $_model-&gt;summary($_GET)-&gt;findAll(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($_data)) <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_sendResponse(<span class="hljs-number"><span class="hljs-number">200</span></span>, sprintf(<span class="hljs-string"><span class="hljs-string">'No items were found for model &lt;b&gt;%s&lt;/b&gt;'</span></span>, $_GET[<span class="hljs-string"><span class="hljs-string">'model'</span></span>])); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $_rows = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($_data <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $_d) $_rows[] = $_d-&gt;attributes; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_sendResponse(<span class="hljs-number"><span class="hljs-number">200</span></span>, CJSON::encode($_rows)); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_sendResponse(<span class="hljs-number"><span class="hljs-number">501</span></span>, sprintf( <span class="hljs-string"><span class="hljs-string">'Error: Mode &lt;b&gt;list&lt;/b&gt; is not implemented for model &lt;b&gt;%s&lt;/b&gt;'</span></span>, $_GET[<span class="hljs-string"><span class="hljs-string">'model'</span></span>])); Yii::app()-&gt;end(); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_GET[<span class="hljs-string"><span class="hljs-string">'model'</span></span>])) $_model = CActiveRecord::model(ucfirst($_GET[<span class="hljs-string"><span class="hljs-string">'model'</span></span>])); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_model)) { $_data = $_model-&gt;findByPk($_GET[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($_data)) <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_sendResponse(<span class="hljs-number"><span class="hljs-number">200</span></span>, sprintf(<span class="hljs-string"><span class="hljs-string">'No items were found for model &lt;b&gt;%s&lt;/b&gt;'</span></span>, $_GET[<span class="hljs-string"><span class="hljs-string">'model'</span></span>])); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_sendResponse(<span class="hljs-number"><span class="hljs-number">200</span></span>, CJSON::encode($_data)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_sendResponse(<span class="hljs-number"><span class="hljs-number">501</span></span>, sprintf( <span class="hljs-string"><span class="hljs-string">'Error: Mode &lt;b&gt;list&lt;/b&gt; is not implemented for model &lt;b&gt;%s&lt;/b&gt;'</span></span>, $_GET[<span class="hljs-string"><span class="hljs-string">'model'</span></span>])); Yii::app()-&gt;end(); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $post = Yii::app()-&gt;request-&gt;rawBody; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_GET[<span class="hljs-string"><span class="hljs-string">'model'</span></span>])) { $_modelName = ucfirst($_GET[<span class="hljs-string"><span class="hljs-string">'model'</span></span>]); $_model = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> $_modelName; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_model)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($post)) { $_data = CJSON::decode($post, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($_data <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $var =&gt; $value) $_model-&gt;$var = $value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($_model-&gt;save()) <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_sendResponse(<span class="hljs-number"><span class="hljs-number">200</span></span>, CJSON::encode($_model)); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Errors occurred $msg = "&lt;h1&gt;Error&lt;/h1&gt;"; $msg .= sprintf("Couldn't create model &lt;b&gt;%s&lt;/b&gt;", $_GET['model']); $msg .= "&lt;ul&gt;"; foreach($_model-&gt;errors as $attribute =&gt; $attr_errors) { $msg .= "&lt;li&gt;Attribute: $attribute&lt;/li&gt;"; $msg .= "&lt;ul&gt;"; foreach($attr_errors as $attr_error) $msg .= "&lt;li&gt;$attr_error&lt;/li&gt;"; $msg .= "&lt;/ul&gt;"; } $msg .= "&lt;/ul&gt;"; $this-&gt;_sendResponse(500, $msg); } } } else { $this-&gt;_sendResponse(501, sprintf( 'Error: Mode &lt;b&gt;create&lt;/b&gt; is not implemented for model &lt;b&gt;%s&lt;/b&gt;', $_GET['model'])); Yii::app()-&gt;end(); } } public function actionUpdate() { $post = Yii::app()-&gt;request-&gt;rawBody; if (isset($_GET['model'])) { $_model = CActiveRecord::model(ucfirst($_GET['model']))-&gt;findByPk($_GET['id']); $_model-&gt;scenario = 'update'; } if (isset($_model)) { if (!empty($post)) { $_data = CJSON::decode($post, true); foreach($_data as $var =&gt; $value) $_model-&gt;$var = $value; if($_model-&gt;save()) { Yii::log('API update -&gt; '.$post, 'info'); $this-&gt;_sendResponse(200, CJSON::encode($_model)); } else { // Errors occurred $msg = "&lt;h1&gt;Error&lt;/h1&gt;"; $msg .= sprintf("Couldn't update model &lt;b&gt;%s&lt;/b&gt;", $_GET['model']); $msg .= "&lt;ul&gt;"; foreach($_model-&gt;errors as $attribute =&gt; $attr_errors) { $msg .= "&lt;li&gt;Attribute: $attribute&lt;/li&gt;"; $msg .= "&lt;ul&gt;"; foreach($attr_errors as $attr_error) $msg .= "&lt;li&gt;$attr_error&lt;/li&gt;"; $msg .= "&lt;/ul&gt;"; } $msg .= "&lt;/ul&gt;"; $this-&gt;_sendResponse(500, $msg); } } else Yii::log('POST data is empty'); } else { $this-&gt;_sendResponse(501, sprintf( 'Error: Mode &lt;b&gt;update&lt;/b&gt; is not implemented for model &lt;b&gt;%s&lt;/b&gt;', $_GET['model'])); Yii::app()-&gt;end(); } } public function actionDelete() { if (isset($_GET['model'])) $_model = CActiveRecord::model(ucfirst($_GET['model'])); if (isset($_model)) { $_data = $_model-&gt;findByPk($_GET['id']); if (!empty($_data)) { $num = $_data-&gt;delete(); if($num &gt; 0) $this-&gt;_sendResponse(200, $num); //this is the only way to work with backbone else $this-&gt;_sendResponse(500, sprintf("Error: Couldn't delete model &lt;b&gt;%s&lt;/b&gt; with ID &lt;b&gt;%s&lt;/b&gt;.", $_GET['model'], $_GET['id']) ); } else $this-&gt;_sendResponse(400, sprintf("Error: Didn't find any model &lt;b&gt;%s&lt;/b&gt; with ID &lt;b&gt;%s&lt;/b&gt;.", $_GET['model'], $_GET['id'])); } else { $this-&gt;_sendResponse(501, sprintf('Error: Mode &lt;b&gt;delete&lt;/b&gt; is not implemented for model &lt;b&gt;%s&lt;/b&gt;', ucfirst($_GET['model']))); Yii::app()-&gt;end(); } } private function _sendResponse($status = 200, $body = '', $content_type = 'text/html') { ... } private function _getStatusCodeMessage($status) { ... } private function _checkAuth() { ... } }</span></span></code> </pre><br>  With this approach, appropriate model preparation is necessary.  For example, the <b>attributes</b> array array embedded in <b>ActiveRecord</b> is formed solely on the basis of the structure of the table in the database.  If there is a need to include fields from linked tables or computable fields in the sample, it is necessary in the model to overload the <b>getAttributes</b> methods and, if necessary, <b>hasAttribute</b> .  As an example, my implementation of <b>getAttributes</b> : <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAttributes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($names = true)</span></span></span><span class="hljs-function"> </span></span>{ $_attrs = <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::getAttributes($names); $_attrs[<span class="hljs-string"><span class="hljs-string">'quota_limit'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;limit[<span class="hljs-string"><span class="hljs-string">'bytes_in_avail'</span></span>]; $_attrs[<span class="hljs-string"><span class="hljs-string">'quota_used'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;tally[<span class="hljs-string"><span class="hljs-string">'bytes_in_used'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $_attrs; }</code> </pre><br>  You also need to create named scope <b>summary</b> in the model for paginal output and sorting to work properly .: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">summary</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($_getvars = null)</span></span></span><span class="hljs-function"> </span></span>{ $_criteria = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CDbCriteria(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_getvars[<span class="hljs-string"><span class="hljs-string">'count'</span></span>])) { $_criteria-&gt;limit = $_getvars[<span class="hljs-string"><span class="hljs-string">'count'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_getvars[<span class="hljs-string"><span class="hljs-string">'page'</span></span>])) $_criteria-&gt;offset = ($_getvars[<span class="hljs-string"><span class="hljs-string">'page'</span></span>]) * $_getvars[<span class="hljs-string"><span class="hljs-string">'count'</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_getvars[<span class="hljs-string"><span class="hljs-string">'sort'</span></span>])) $_criteria-&gt;order = str_replace(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>, $_getvars[<span class="hljs-string"><span class="hljs-string">'sort'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getDbCriteria()-&gt;mergeWith($_criteria); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; }</code> </pre><br>  Full text of the model: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * This is the model class for table "ftpuser". * * The followings are the available columns in table 'ftpuser': * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> string $id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> string $userid * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> string $passwd * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> integer $uid * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> integer $gid * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> string $homedir * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> string $shell * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> integer $count * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> string $accessed * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@property</span></span></span><span class="hljs-comment"> string $modified */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ftpuser</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CActiveRecord</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Additional quota parameters public $quota_limit; public $quota_used; /** * Returns the static model of the specified AR class. * @return ftpuser the static model class */ public static function model($className=__CLASS__) { return parent::model($className); } /** * @return string the associated database table name */ public function tableName() { return 'ftpuser'; } /** * @return array validation rules for model attributes. */ public function rules() { // </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">NOTE:</span></span></span><span class="hljs-comment"> you should only define rules for those attributes that // will receive user inputs. return array( array('uid, gid, count', 'numerical', 'integerOnly' =&gt; true), array('userid, passwd, homedir', 'required'), array('userid, passwd', 'length', 'max' =&gt; 32), array('homedir', 'length', 'max' =&gt; 255), array('shell', 'length', 'max' =&gt; 16), array('accessed, modified, quota_limit, quota_used', 'safe'), //array('userid', 'unique'), // The following rule is used by search(). // Please remove those attributes that should not be searched. array('id, userid, passwd, uid, gid, homedir, shell, count, accessed, modified', 'safe', 'on' =&gt; 'search'), ); } /** * @return array relational rules. */ public function relations() { // </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">NOTE:</span></span></span><span class="hljs-comment"> you may need to adjust the relation name and the related // class name for the relations automatically generated below. return array( 'limit' =&gt; array(self::HAS_ONE, 'FTPQuotaLimits', 'user_id'), 'tally' =&gt; array(self::HAS_ONE, 'FTPQuotaTallies', 'user_id'), ); } /** * @return array customized attribute labels (name=&gt;label) */ public function attributeLabels() { return array( 'id' =&gt; 'Id', 'userid' =&gt; 'Userid', 'passwd' =&gt; 'Passwd', 'uid' =&gt; 'Uid', 'gid' =&gt; 'Gid', 'homedir' =&gt; 'Homedir', 'shell' =&gt; 'Shell', 'count' =&gt; 'Count', 'accessed' =&gt; 'Accessed', 'modified' =&gt; 'Modified', ); } /** * Retrieves a list of models based on the current search/filter conditions. * @return CActiveDataProvider the data provider that can return the models based on the search/filter conditions. */ public function search() { // Warning: Please modify the following code to remove attributes that // should not be searched. $criteria = new CDbCriteria; $criteria-&gt;compare('userid', $this-&gt;userid, true); $criteria-&gt;compare('homedir', $this-&gt;homedir, true); return new CActiveDataProvider('ftpuser', array( 'criteria' =&gt; $criteria, )); } public function summary($_getvars = null) { $_criteria = new CDbCriteria(); if (isset($_getvars['count'])) { $_criteria-&gt;limit = $_getvars['count']; if (isset($_getvars['page'])) $_criteria-&gt;offset = ($_getvars['page']) * $_getvars['count']; } if (isset($_getvars['sort'])) $_criteria-&gt;order = str_replace('.', ' ', $_getvars['sort']); $this-&gt;getDbCriteria()-&gt;mergeWith($_criteria); return $this; } public function getAttributes($names = true) { $_attrs = parent::getAttributes($names); $_attrs['quota_limit'] = $this-&gt;limit['bytes_in_avail']; $_attrs['quota_used'] = $this-&gt;tally['bytes_in_used']; return $_attrs; } protected function afterFind() { parent::afterFind(); $this-&gt;quota_limit = $this-&gt;limit['bytes_in_avail']; $this-&gt;quota_used = $this-&gt;tally['bytes_in_used']; } protected function afterSave() { parent::afterSave(); if ($this-&gt;isNewRecord &amp;&amp; !empty($this-&gt;quota_limit)) { $_quota = new FTPQuotaLimits(); $_quota-&gt;user_id = $this-&gt;id; $_quota-&gt;name = $this-&gt;userid; $_quota-&gt;bytes_in_avail = $this-&gt;quota_limit; $_quota-&gt;save(); } } protected function beforeValidate() { if ($this-&gt;isNewRecord) { if (empty($this-&gt;passwd)) $this-&gt;passwd = $this-&gt;genPassword(); $this-&gt;homedir = Yii::app()-&gt;params['baseFTPDir'].$this-&gt;userid; } elseif ($this-&gt;scenario == 'update') { if (empty($this-&gt;quota_limit)) { FTPQuotaLimits::model()-&gt;deleteAllByAttributes(array('name' =&gt; $this-&gt;userid)); FTPQuotaTallies::model()-&gt;deleteAllByAttributes(array('name' =&gt; $this-&gt;userid)); } else { $_quota_limit = FTPQuotaLimits::model()-&gt;find('name = :name', array(':name' =&gt; $this-&gt;userid)); if (isset($_quota_limit)) { $_quota_limit-&gt;bytes_in_avail = $this-&gt;quota_limit; $_quota_limit-&gt;save(); } else { $_quota_limit = new FTPQuotaLimits(); $_quota_limit-&gt;name = $this-&gt;userid; $_quota_limit-&gt;user_id = $this-&gt;id; $_quota_limit-&gt;bytes_in_avail = $this-&gt;quota_limit; $_quota_limit-&gt;save(); } } } return parent::beforeValidate(); } protected function beforeDelete() { FTPQuotaLimits::model()-&gt;deleteAllByAttributes(array('name' =&gt; $this-&gt;userid)); FTPQuotaTallies::model()-&gt;deleteAllByAttributes(array('name' =&gt; $this-&gt;userid)); return parent::beforeDelete(); } private function genPassword($len = 6) { $chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; $count = mb_strlen($chars); for ($i = 0, $result = ''; $i &lt; $len; $i++) { $index = rand(0, $count - 1); $result .= mb_substr($chars, $index, 1); } return $result; } }</span></span></code> </pre><br>  What is not enough for complete happiness - there is no possibility to make the processing of subqueries of the form <b>/ users / 156 / records</b> , but then this is a framework, not a CMS, if necessary - we finished it ourselves.  My case is simple, this is not required. <br><br>  With the server part done, go to the client.  For those interested, I post the full source code for the Yii server application <a href="http://files.mail.ru/5FD9CE41E2484F1B93F499C2CED26BC5">here</a> .  I do not know how long the link will live, if there are more sensible suggestions where to put it more reliably - please note in the comments. <br><br><h5>  Client part </h5><br>  In order not to write your bike, a little search work was carried out and an excellent <a href="https://github.com/Haensel/ActiveResource">ActiveResource</a> extension was found.  As the author writes, the source of inspiration was the implementation of <b>ActiveResource</b> in Ruby on Rails.  On the page there is a brief description of how to install and how to use. <br><br>  However, almost immediately I came across the fact that it is just a component that is compatible with the <b>ActiveRecord</b> interface, but a component that is compatible with <b>ActiveDataProvider is</b> required for use in Yii <b>GridView</b> or <b>ListView</b> widgets.  A quick search brought me to <a href="https://github.com/Haensel/ActiveResource/tree/QueryCriteria">the</a> improvements made to a <a href="https://github.com/Haensel/ActiveResource/tree/QueryCriteria">separate branch</a> , including <b>EActiveResourceDataProvider</b> and <b>EActiveResourceQueryCriteria</b> , as well as discussing them in the <a href="http://www.yiiframework.com/forum/index.php/topic/21192-activeresource-for-yii/page__st__20">forum thread</a> where the author of the extension participated.  <a href="http://www.yiiframework.com/forum/index.php/topic/21192-activeresource-for-yii/page__view__findpost__p__192528">The</a> corrected versions of <b>ESort</b> and <b>EActiveResourceDataProvider</b> <a href="http://www.yiiframework.com/forum/index.php/topic/21192-activeresource-for-yii/page__view__findpost__p__192528">were also</a> published <b>there</b> . <br><br>  Despite all the elegance of the solution without a file has not done.  The problem was the malfunction of the pagination component in the grid.  A cursory examination of the source showed that the actual offset, expressed in the number of entries, was used as the offset in the extension, whereas the pagination in the <b>GridView</b> uses the page number.  It turned out that when you set up 10 entries per page, when you went to page 2, we were transferred to page 20. We climb into the code and rule.  To do this, in the <i>protected / extensions / EActiveResource / EActiveResourceQueryCriteria.php file</i> in the body of the <b>buildQueryString</b> method, <b>we</b> make the following edit: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;offset&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">// array_push($parameters, $this-&gt;offsetKey.'='.$this-&gt;offset); array_push($parameters, $this-&gt;offsetKey.'='.$this-&gt;offset / $this-&gt;limit);</span></span></code> </pre><br>  After that, it is necessary to remove the overload of the <b>getOffset</b> method from the <b>EActiveResourcePagination</b> as more unnecessary. <br><br>  So when creating an application that uses a REST data source, you need to manually create the necessary models, the rest will be created through the GII without problems. <br><br>  Separately, I would like to mention the work with several servers.  Initially, the connection to the remote REST API is described in the config, so by default we can use only one connection on our site.  In order for the connection information to be stored in the database table and used by the <b>ActiveResource</b> component, from there I had to create a child with the overloaded <b>getConnection</b> method (this is my case with FTP users, server data is stored in the table described by the FTPServers model): <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EActiveResourceSelect</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EActiveResource</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Returns the EactiveResourceConnection used to talk to the service. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> EActiveResourceConnection The connection component as pecified in the config */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getConnection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $_server_id = Yii::app()-&gt;session[<span class="hljs-string"><span class="hljs-string">'ftp_server_id'</span></span>]; $_db_params = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_server_id)) { $_srv = FTPServers::model()-&gt;findByPk($_server_id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_srv)) $_db_params = $_srv-&gt;attributes; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> Yii::log(<span class="hljs-string"><span class="hljs-string">'info'</span></span>, <span class="hljs-string"><span class="hljs-string">"No FTP server with ID: $_server_id were found"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $_srv = FTPServers::model()-&gt;find(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_srv)) { $_db_params = $_srv-&gt;attributes; Yii::app()-&gt;session[<span class="hljs-string"><span class="hljs-string">'ftp_server_id'</span></span>] = $_srv-&gt;id; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> Yii::log(<span class="hljs-string"><span class="hljs-string">"No FTP servers were found"</span></span>, CLogger::LEVEL_INFO); } <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_connection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EActiveResourceConnection(); <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_connection-&gt;init(); <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_connection-&gt;site = $_db_params[<span class="hljs-string"><span class="hljs-string">'site'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_connection-&gt;acceptType = $_db_params[<span class="hljs-string"><span class="hljs-string">'acceptType'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_connection-&gt;contentType = $_db_params[<span class="hljs-string"><span class="hljs-string">'contentType'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_db_params[<span class="hljs-string"><span class="hljs-string">'username'</span></span>]) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_db_params[<span class="hljs-string"><span class="hljs-string">'password'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_connection-&gt;auth = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'basic'</span></span>, <span class="hljs-string"><span class="hljs-string">'username'</span></span> =&gt; $_db_params[<span class="hljs-string"><span class="hljs-string">'username'</span></span>], <span class="hljs-string"><span class="hljs-string">'password'</span></span> =&gt; $_db_params[<span class="hljs-string"><span class="hljs-string">'password'</span></span>], ); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_connection; } }</code> </pre><br>  Further development of the client part is not particularly different from the development using the usual <b>ActiveRecord.</b> What, in my opinion, is the main charm of the <b>ActiveResource</b> extension. <br><br>  I hope the article will be useful. </div><p>Source: <a href="https://habr.com/ru/post/216475/">https://habr.com/ru/post/216475/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216465/index.html">Use of the developer RAWTherapee in applied tasks of the amateur photographer</a></li>
<li><a href="../216467/index.html">Data mining in music. We define a musical instrument with the help of Classification Trees.</a></li>
<li><a href="../216469/index.html">AngularJS - splitting an application into modules and loading components using RequireJS</a></li>
<li><a href="../216471/index.html">We are testing the ARM platform Marvel Armada XP as a hosting for the Python project</a></li>
<li><a href="../216473/index.html">Debugging Android CMake project in an adult</a></li>
<li><a href="../216481/index.html">Show Sound # 7 - Podcast about audio equipment, components, formats and technologies</a></li>
<li><a href="../216483/index.html">CryEngine becomes available as Engine-as-a-Service</a></li>
<li><a href="../216487/index.html">The crisis has reached the clouds!</a></li>
<li><a href="../216489/index.html">Secure Active Directory management. Part 2</a></li>
<li><a href="../216491/index.html">Real-time brain performance: video</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>