<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sending temperature data from the TL-MR3020 router and the Raspberry Pi to People's Monitoring</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 In consequence of the questions, I will allow myself a small comment, a little clarifying the meaning of the article. The article descr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sending temperature data from the TL-MR3020 router and the Raspberry Pi to People's Monitoring</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  In consequence of the questions, I will allow myself a small comment, a little clarifying the meaning of the article.  The article describes two devices that are independent of each other and perform identical tasks for sending data to <a href="http://narodmon.ru/">the People‚Äôs Monitoring</a> site <a href="http://narodmon.ru/">.</a> <br><br>  When I first saw the article on Habr√© <a href="http://habrahabr.ru/qa/4470/">‚ÄúPeople‚Äôs temperature monitoring (vs forecast) in various cities.</a>  <a href="http://habrahabr.ru/qa/4470/">Is it necessary? ‚Äù</a> , Devoted to the monitoring of the parameters of the environment <a href="http://narodmon.ru/">narodmon.ru</a> , I was somehow skeptical about this idea and forgot about it.  Before the new year, I had a <a href="http://www.raspberrypi.org/">Raspberry Pi</a> and some time was spent on its development and <a href="http://habrahabr.ru/post/165153/">review of opportunities</a> , in the end something Malinka would not stand idle, and even so for the general development under the article <a href="http://habrahabr.ru/post/163575/">‚ÄúThe history of interaction between the‚Äú teapot ‚Äùand DS18B20 through Raspberry Pi‚Äù</a> did the same, but taking into account the source of the <a href="http://webshed.org/wiki/RaspberryPI_Multiple_DS1820">original source</a> , which has already been amended on the grounds of the above article with reference to Habr.  The temperature was measured, the graphs were built, but somehow it became boring to watch it, and the use of the raspberry for this purpose is like a cannon on sparrows, and one fine day I remembered People's Monitoring, on which all the information displayed on the site is displayed only on the basis of information about current environmental parameters (temperature, humidity, atmospheric pressure, etc.) transmitted from the client devices of the users of this service.  I started searching and found the article <a href="http://habrahabr.ru/qa/29419/">‚ÄúThe best implementation of UART implementation =&gt; 1-wire and I2C / SPI based on routers‚Äù</a> .  Then I got excited about the idea of ‚Äã‚Äãmaking such a device, though in the hope that someone had already done it, and I will only repeat, since the <a href="http://www.tp-linkru.com/products/details/%3Fmodel%3DTL-MR3020">TL-MR3020 router was</a> already on the farm, and inhuman experiments had been made to screw it to a scooter cart "with a camera based on the article" <a href="http://habrahabr.ru/post/153017/">A simple wifi bot for monitoring premises or a "kitchen" robot-building</a> . <br><a name="habracut"></a><br><h4>  So let's get started </h4><br>  I started with experiments on the router, at that time there was <a href="http://roboforum.ru/wiki/OR-WRT">OR-WRT 0.70</a> firmware based on <a href="https://openwrt.org/">OpenWRT</a> on it.  A temperature sensor is connected to the router via the USB-UART adapter.  The wiring diagram is extremely simple.  Text and photos from the site <a href="http://cyber-place.ru/showpost.php%3Fp%3D2904%26postcount%3D2">http://cyber-place.ru</a> <br>  The sensor can be connected to the UART according to the figure below. <br><br>  Connect RX and TX together and connect the data to them data line 1-Wire sensor DS18B20 <br>  VCC to VCC <br>  GND to GND 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/854/158/6dc/8541586dc6e714a70da1af93167f5835.jpg"><br><br>  When trying to connect and read data through the router's native UART, it turned out that this could not be done with a swoop.  At one bourgeois forum, information was found that the limitation is hardware and the router port itself imposes it, which is sharpened for 8 data bits, and only 6 are used in the digitemp (package for reading data from 1-wire sensors). USB-COM adapter to FT232 or PL2303, another option is possible on the CP2102, but I do not have it, and therefore I will use what I have.  After that, I decided to try my hand at writing a script to send the received data to the ‚ÄúPeople Monitoring‚Äù.  Sending data to this service must be done using two methods to choose from, either telnet TCP / UDP (recommended) or HTTP POST.  Examples of sending data to PHP are available on the website.  PHP is a dark forest for me, but still it's better than nothing.  After the first attempt to install PHP on the router, it became clear that the 4MB of memory available in it was not enough, and the focus would not succeed.  Then I started thinking about increasing the amount of flash memory and came across the same <a href="http://cyber-place.ru/">cyber-place.ru</a> on the topic <a href="http://cyber-place.ru/showthread.php%3Ft%3D387">"Replacing and restoring Flash ROM in the MR3020 and WR703n router"</a> .  But after some hesitation I came to the conclusion that this is not Feng Shui, for me and for the majority it is quite laborious, plus a programmer is needed, which everyone does not have, and scored on this matter.  I decided to write the necessary script on bash, but the tips with Google did not bring results, and a couple of days passed in vain.  As a result, it was decided to put the USB-HUB (I saw on the network successful experiments on implanting these into the inside of the router), and connect an external drive and a USB-UART bridge to it.  It is said - done, but in the future, after successfully completing the experiments with Raspberry Pi and PHP, and at that moment I was thrown to these experiments.  Fast forward to the future, conceived experiments on raspberry and PCP are successfully completed, as I will write below, we will continue experiments with the router.  To increase the amount of memory used to transfer it to an external flash drive, which means that the router that I have been configured to work with ‚Äúscooter cart‚Äù will be permanently transferred to use with additional memory, which I absolutely did not want to do.  The next day, 1 more router and the smallest USB-HUB were bought, as it was a pity to lose the achieved results, especially since they still have to be different devices. <br><br><img src="https://habrastorage.org/storage2/b5b/d53/b23/b5bd53b23f00f6968ac9b7ed8f993621.jpg"><br><br><img src="https://habrastorage.org/storage2/855/913/e61/855913e61b25c3d46c65053e74580f82.jpg"><br><br>  For the "thermometer" I decided to use a clean OpenWRT.  Downloading it when I tried to install in the file name selection field by searching for the first letters I found out that I had as many as 3 firmware with the same size and file name, only the sequence number of the file download was different.  I decided that once I downloaded this firmware and chose one of the three to guess.  After the firmware, I didn‚Äôt manage any of the primary actions from the manual on OpenWRT.  I thought that something had gone wrong during the firmware and began to study methods of extracting the router from the brick through TFTP.  I put the whole evening on it, since the practice didn‚Äôt get my hands on the practice, in theory there was a lot of incomprehensible.  And at the end of the evening, something jerked me to try to perform the initial settings as for OR-WRT 0.70.  I was lucky, it turned out that I filled it with her.  Then, when comparing the names of downloaded files, it turned out that both OpenWRT and OR-WRT have the same name.  Next, I spent an unlimited amount of time trying to expand the memory on an external USB flash drive, after which it was decided to upload another <a href="http://roboforum.ru/wiki/OR-WRT_0.75alpha">OR-WRT 0.75 alpha</a> firmware with the existing flash drive support.  Without problems, I flashed and configured my router according to the instructions and proceeded to further actions. <br>  On the thumb in /etc/opkg.conf changed the repository address to <a href="http://downloads.openwrt.org/snapshots/trunk/ar71xx/packages/">downloads.openwrt.org/snapshots/trunk/ar71xx/packages</a> , updated the list of packages <br><br> <code>opkg update</code> <br> <br>  installed digitemp-a packages <br><br> <code>opkg install digitemp-usb</code> <br> <code>opkg install digitemp</code> <br> <br>  After that, the <code>dmesg</code> found out where the FTDI adapter is connected, I had ttyUSB0.  We search for devices 1-wire <br><br> <code>digitemp_DS9097 -i -s /dev/ttyUSB0</code> <br> <br>  if found, then read the temperature readings and write to the file <br><br> <code>digitemp_DS9097 -a -A -l /tmp/1wire_log</code> <br> <br>  to see the result we enter <br><br> <code>cat /tmp/1wire_log</code> <br> <br>  Everything is working.  Next, install the packages for PHP <br><br> <code>opkg install php5</code> <br> <code>opkg install php5-cgi</code> <br> <br>  And we start writing scripts.  In this case, I'm not a whale, so please do not kick much for the curvature of the code and the huge crutches, substituted, so that it all works.  Two scripts were written, one on bash, the other on php.  Rather, the fact that php was made on the basis of the source code from the site "People's Monitoring".  The first script extracts the data received from the digitemp package and recorded in the 1wire_log file, and fits them into a digestible form.  Then transfers control to the second php script to send data to the server. <br><br><div class="spoiler">  <b class="spoiler_title">The first script get_send.sh</b> <div class="spoiler_text">  #! / bin / bash <br>  rm / temperatura / 1wire_log <br>  rm / temperatura / temp <br>  rm / temperatura / temper <br>  cd / <br>  digitemp_DS9097 -i -s / dev / ttyUSB0 <br>  sleep 1s <br>  digitemp_DS9097 -a -A -l / temperatura / 1wire_log <br>  sleep 2s <br>  cd / temperatura <br>  cut -c29-33 1wire_log |  sed 's / $ //'&gt; temp <br>  cat temp |  tr -d '\ n'&gt; temper <br>  php-cgi /temperatura/send.php <br>  echo "OK \ n" <br></div></div><br>  The second script takes the data from the file prepared by the first script and sends it to the server. <br><br><div class="spoiler">  <b class="spoiler_title">The second script is send.php</b> <div class="spoiler_text">  &lt;? php <br>  $ file_name = "/ temperatura / temper"; <br>  $ file = fopen ("$ file_name", "r"); <br>  $ gradus_out = fread ($ file, filesize ($ file_name)); <br>  echo "$ gradus_out \ n"; <br>  fclose ($ file); <br><br>  $ fp = @fsockopen ("tcp: //narodmon.ru", NNNN, $ errno, $ errstr); <br>  # where NNNN is the port number available after registration <br>  if (! $ fp) exit ("ERROR (". $ errno. "):". $ errstr); <br>  fwrite ($ fp, "# 01-23-45-67-89-AF \ n # 0123456789ABCDEF # $ gradus_out \ n ##"); <br>  fclose ($ fp); <br>  echo "OK \ n"; <br>  ?&gt; <br></div></div><br>  where 01-23-45-67-89-AF is the mac address of the wlan network card (Wi-Fi), and 0123456789ABCDEF is the serial number of the temperature sensor DS16 (x) 20 <br>  For both implementations of the device, I used the wlan mac-address to bind the device on the People's Monitoring website.  To find this address, you can enter the command <code>ifconfig</code> . <br>  Next, we need to automate the receiving and sending data to the server using cron.  At the time of debugging scripts, I sent data to the server at intervals of 5 minutes, but as soon as they were debugged, the period increased to 10 minutes.  To do this, create a simple crontab for the root user with the contents. <br><br><div class="spoiler">  <b class="spoiler_title">Root crontab</b> <div class="spoiler_text">  SHELL = / bin / sh <br>  PATH = / usr / local / sbin: / usr / local / bin: / sbin: / bin: / usr / sbin: / usr / bin <br>  0.10,20,30,40,50 * * * * sh / temperatura/get_send.sh <br></div></div><br>  According to this task, the sensor is polled and data is sent every 10 minutes.  The last line of the script may well be the form <br><br> <code>*/10 * * * * sh /temperatura/get_send.sh</code> <br> <br>  Since at the moment I have two devices for sending temperature data, and the site ignores data coming in more than once every five minutes, the data from one of my devices is ignored.  Therefore, for each of the devices, the time for sending data with an interval of 5 minutes between the devices was clearly set in the crown.  Download scripts and crontab <a href="">here</a> .  Next, copy the root user's crontab to / etc / crontabs and the temperatura folder to / (root filesystem). <br>  To start and enable cron you need to run in the terminal <br><br> <code>/etc/init.d/cron start</code> <br> <br> <code>/etc/init.d/cron enable</code> <br> <br><h4>  Go to the assembly area </h4><br>  After everything has been verified in work, it is time to start assembling the entire farm into a single device.  After opening the USB hub and the router, I began to estimate the layout of the devices inside the case, consulting with Google and peeping at the <a href="http://cyber-place.ru/showthread.php%3Ft%3D384">modding router</a> page.  It turned out that I bought the USB-HUB the same as the author of the first version of the improvements.  Already well, since he managed to do it means and I will succeed.  After the initial layout of the device's internal parts, it became clear that one could try to fit the same USB-UART adapter.  As a USB-UART adapter, a data cable from some old phone on a PL2303 chip was tested and sacrificed, which came to me from nowhere to use as a USB-UART bridge.  Before that, he was working on someone else, not the smallest details were soldered, which set the thickness of the board itself.  After studying the circuits for telephone laces, these dimensional parts have been removed.  The power switch was also removed and the protruding legs of the output elements were bitten off.  Scarf immediately lost weight.  One could use a handkerchief on FTDI, the dimensions of which are at least 2 times smaller than the applied board, but it was a pity because  it has a useful DTR signal used for resetting the Arduino, and in PL2303 it is inverse and for its use you would have to fence an inverter.  And for our purposes, this signal is absolutely not important. <br>  After finalizing the USB-UART adapter, the line came and a USB hub, the sticking conclusions of which were also cut off.  For him, this weight loss turned out to be almost not noticeable, but in general I think it has become useful for the construction.  Based on the experience of people who have already done this, they started a second fitting.  Those options that were offered did not suit me.  would have to remove the fiber.  Threw on the opposite side of the fiber, is better.  But anyway, with the existing flash drive, some of the LEDs will close and you will also have to remove some of the light guide. But according to estimates, you can do without extreme measures by buying a flash drive that is shorter.  I started looking for computer shops and found a decent option at the right price I bought the next day.  As it turned out, the same model of flash drive was already used by the author of another <a href="http://cyber-place.ru/showpost.php%3Fp%3D1661%26postcount%3D5">version of modding</a> .  It turns out that the choice of the parts used is not so great, since I accidentally got 2 times the same, completely independent of the authors ahead of me. <br>  Then I began to think about how to arrange the UART port on the router body to connect an external sensor in the most elegant way.  It turned out that the USB port, which is not used from now on, whose power pins continue to perform the functions assigned to them, and the + D and -D pins that are cut off from the circuit, can be adapted to Rx and Tx.  Fine.  Soldered all together, checked. <br><br><img src="https://habrastorage.org/storage2/3ce/055/69b/3ce05569bc964f80ed2feee7998b27f8.jpg"><br><br><img src="https://habrastorage.org/storage2/500/ea7/661/500ea7661b2eb75fe37b1e3c4ad527dd.jpg"><br><br>  For fixing the boards among themselves, I used the usual 2-sided adhesive tape.  When assembling, you need to be extremely careful, so that nothing would ever go away and not to push the tape with sharp soldered leads.  When gluing the hub, I used two layers of adhesive tape to increase the distance between the boards, 2 strips per layer folded ‚Äúpalenice‚Äù.  For tests, I used the remaining tail from the same hub.  That's what happened in the end <br><br><img src="https://habrastorage.org/storage2/617/e01/76b/617e0176ba9dd34848ea1c263f1adc3a.jpg"><br><br><img src="https://habrastorage.org/storage2/7f8/6f5/12b/7f86f512ba0874b3bfc4701a12f9d89f.jpg"><br><br>  I was pleased with the result, there was even a little space left, and the unused integrated UART remained.  The <a href="http://microsin.ru/content/view/1284/44/">Bluetooth module HC-04</a> was found in the bins and was tried on the possible installation site.  Stood like a native.  It was immediately soldered and glued to the same tape on the USB port of the router. <br><br><img src="https://habrastorage.org/storage2/bef/bab/508/befbab508baed45b5976cc8788235b06.jpg"><br><br><img src="https://habrastorage.org/storage2/e3b/1ca/21d/e3b1ca21d2a6a3fab881a71fcbe6a45c.jpg"><br><br>  Why do I need it?  As already said above, it is a pity that the place disappears and the UART.  Plus, the router will not do anything for 10 minutes, not order.  You can hang some more functions.  For example, the first because of what I did - on the Internet to look at the thermometer is good, but not always convenient.  So I think to put the simplest arduin with a 7-segment indicator.  And maybe the sign-synthesizer, so that the time / date is also shown.  In general, the mass of options. <br>  Close the lid prevented only one pin on it, which should rest against the board, and rests against the USB connector of the hub.  He tried on the eye and cut it in half. <br><br><img src="https://habrastorage.org/storage2/336/197/a8b/336197a8b059118d6f3bae2c0f1ebf59.jpg"><br><br><img src="https://habrastorage.org/storage2/7d2/3e3/256/7d23e3256c3ad1692e9df3384a20a5eb.jpg"><br><br>  After that, the lid is normally in place.  True, it also failed to put it tightly and it is slightly upwardly issued.  But this is a normal phenomenon and all my improvements do not interfere with it.  I have the same thing on the first unmodified router.  As a result, he received a seemingly almost virginal new router, not counting the traces of a neat opening. <br><br><img src="https://habrastorage.org/storage2/ebd/0df/e96/ebd0dfe962790f781eb0a3df94c85ea3.jpg"><br><br><img src="https://habrastorage.org/storage2/c35/d92/f4f/c35d92f4ffea809a3f0b497aacf89b0a.jpg"><br><br>  To remove the sensor to the street, I used a collapsible USB connector on the cable and cord from a Komovka mouse, it is softer than the rest of the cords I had, with a small piece of flat cable soldered to pass it between the window seals when closing the window. <br>  . <br><h5>  Price issue when using the router </h5><br>  Router TL-MR3020 910r. <br>  USB-HUB Ginzzu 210r. <br>  Flash Drive Sandisk Cruzer Fit 8 GB 248r. <br>  Adapter USB-UART to PL2303 from China ~ 50p. <br>  Bluetooth module HC-04 from China ~ $ 7 = 210r. <br>  Temperature sensor DS16 (x) 20 ~ 60r. <br>  Total ~ 1688r. <br><br>  Naturally, the Bluetooth module can be thrown out, and then the price will approach the bar ~ 1500r. <br><br><h5>  Improvement options </h5><br>  The first is the optimization of the scripts given in the article. <br>  Secondly, if you manage to get rid of the PHP script and switch to bash completely, you will get rid of the USB flash drive and USB hub, which will significantly reduce the complexity and cost of the final device. <br>  The third (just an assumption) - perhaps, if you clean the firmware by removing unused modules, you‚Äôll make room for PHP, you will achieve the same results as in the second version. <br>  The fourth is to make the hardware UART work, it will also reduce the cost, but it will slightly increase the labor intensity.  All I could find on this topic is an incomprehensible pastebin script for me without comments, and a link to the recumbent site, where the link to pastebin comes from.  I tried to run this script to no avail. <br>  Fifth, use the GPIO output by writing the appropriate driver. <br><br><h4>  Sending with Raspberry Pi </h4><br>  As I already mentioned, I already had the malinka set up properly for measuring the temperature on two sensors and scheduling.  Thus, it remains for the small, pull out the data on the temperature and send them to the server. <br>  A further description of the process will be based on the fact that you have already set up a malinka to receive data from sensors and build graphs.  However, I will briefly describe the principle of operation of those scripts, and those who wish can download my scripts completely for quick setup.  In the version that I repeated and suggest that you repeat, there are 3 bash scripts, one perl and one database file for RRDTool.  The first bash script runs once and creates a database file.  The second bash script is added to cron, and all it does is run the rest of the scripts.  First of all, it runs the get_temp.pl script, which is responsible for reading the readings from the temperature sensors and putting these readings into the database.  In the second line, it runs the create_graphs.sh script, which takes temperature values ‚Äã‚Äãfrom the database and builds graphs on them.  Based on the fact that my Malinka already knows how to do all this, I proceed to implement the rest of my plans.  Here one PHP script is already used to send data to the server.  Plus, several lines of processing the data received from the sensors are added to the existing get_temp.pl script and one line to the get.sh script. <br>  My script for receiving data from sensors with the addition of processing temperature readings looks like this <br><br><div class="spoiler">  <b class="spoiler_title">get_temp.pl</b> <div class="spoiler_text">  ################################################## ##################### <br>  Here, I ask you to forgive me, whether something interferes with the script, or if there‚Äôs a glitch, but I didn‚Äôt manage to insert it properly under the spoiler, so I‚Äôm giving you a piece of the original code with my modifications. <br>  ################################################## ##################### <br>  foreach $ device (@deviceIDs) <br>  { <br>  $ reading = &amp; read_device ($ device); <br>  if ($ reading == 9999) { <br>  $ reading = "U"; <br>  } <br><br>  push (@ temp_readings, $ reading); <br><br>  } <br><br>  if ($ temp_readings [0] ne 'U') {$ temp_readings [0] - = $ in_correction;} <br>  if ($ temp_readings [1] ne 'U') {$ temp_readings [1] - = $ out_correction;} <br><br>  #update the database <br>  `/ usr / bin / rrdtool update /home/pi/temperature/multirPItemp.rrd N: $ temp_readings [0]: $ temp_readings [1]`; <br>  print "Temp 1 = $ temp_readings [0] Temp 2 = $ temp_readings [1] \ n"; <br>  ################################################## ##################### <br>  # My additions <br>  open (FILE, "&gt; / home / pi / temperature / temp_out"); <br>  print FILE "$ temp_readings [0]"; <br>  close (FILE); <br>  open (FILE, "&gt; / home / pi / temperature / temp_in"); <br>  print FILE "$ temp_readings [1]"; <br>  close (FILE); <br>  ################################################## ##################### <br><br></div></div><br>  The essence of my additions is to retrieve the data on temperature, which are entered into the database, and record them in separate files for each sensor. <br>  After all this has worked, you can do the script to send data to the server.  For this we need to install PHP. <br><br> <code>sudo apt-get install php5-cgi</code> <br> <br>  The script to send data is made from the example presented on the site "People's Monitoring".  It accesses the files created by the previous script, takes temperature data from them and sends them. <br>  My send.php script looks like this <br><br><div class="spoiler">  <b class="spoiler_title">send.php</b> <div class="spoiler_text">  #! / usr / bin / php-cgi -q <br>  &lt;? <br>  $ file_name = "/ home / pi / temperature / temp_out"; <br>  $ file = fopen ("$ file_name", "r"); <br>  $ gradus_out = fread ($ file, filesize ($ file_name)); <br>  echo "$ gradus_out \ n"; <br>  fclose ($ file); <br><br>  $ file_name = "/ home / pi / temperature / temp_in"; <br>  $ file = fopen ("$ file_name", "r"); <br>  $ gradus_in = fread ($ file, filesize ($ file_name)); <br>  echo "$ gradus_in \ n"; <br>  fclose ($ file); <br><br>  $ fp = @fsockopen ("tcp: //narodmon.ru", NNNN, $ errno, $ errstr); <br>  # where NNNN is the port number available after registration <br>  if (! $ fp) exit ("ERROR (". $ errno. "):". $ errstr); <br>  fwrite ($ fp, "# 01-23-45-67-89-AF \ n # 0123456789ABCDEF # $ gradus_out \ n # 0123456789ABCDEF # $ gradus_in \ n ##"); <br>  fclose ($ fp); <br>  ?&gt; <br></div></div><br>  where, just like in the version with the router 01-23-45-67-89-AF, the mac-address of the wlan network card (Wi-Fi) or lan, if the malinka is connected through it, and 0123456789ABCDEF is the serial number of the DS16 temperature sensor ( x) 20. <br>  Then we add a line to the get.sh script indicating the execution of the send.php script. <br><br><div class="spoiler">  <b class="spoiler_title">Get.sh script</b> <div class="spoiler_text">  #! / bin / bash <br>  /home/pi/temperature/get_temp.pl <br>  /home/pi/temperature/create_graphs.sh <br>  ################################################## ##################### <br>  # My addition <br>  /home/pi/temperature/send.php <br>  echo "OK \ n" <br>  ################################################## ##################### <br></div></div><br>  In crown, I changed the schedule for sending data every 10 minutes with a clear time reference, not intersecting with the time the data was sent by the router. <br>  Task in the crown looks like this <br><br> <code>5,15,25,35,45,55 * * * * /home/pi/temperature/get.sh</code> <br> <br>  After that, everything should work.  Download these scripts <a href="">here.</a> <br><br><h5>  Price issue when using the Raspberry Pi </h5><br>  Here it is already impossible to count so unequivocally.  The fact is that the cost of the raspberry itself and the additional components for it can vary greatly from person to person. <br><br><h4>  Conclusion </h4><br>  In my opinion, if you do not have either one or the other, the most rational is to use a router.  Using raspberry makes sense only if you already have it, is always on and performs any tasks. <br>  But in general, the regiment of devices sending data to the People's Monitoring service has arrived, and this is good. <br><br><h4>  UPD </h4><br>  Together, we managed to get rid of the PHP script and write everything in BASH, for which we thank everyone who responded.  I would like to express special gratitude to the <a href="https://geektimes.ru/users/ssar/" class="user_link">Ssar</a> user, his hint was decisive in writing the script for the router.  At the moment, there is only one get_send.sh script, and two auxiliary files. <br><br><div class="spoiler">  <b class="spoiler_title">get_send.sh</b> <div class="spoiler_text">  #! / bin / bash <br>  rm / temperatura / 1wire_log <br>  rm / temperatura / temp <br>  rm / temperatura / out <br>  cd / <br>  digitemp_DS9097 -i -s / dev / ttyUSB0 <br>  sleep 1s <br>  digitemp_DS9097 -a -A -l / temperatura / 1wire_log <br>  sleep 2s <br>  cd / temperatura <br>  cut -c29-33 1wire_log |  sed 's / $ //'&gt; temp <br>  cat / temperatura / mac_id&gt; / temperatura / out <br> cat /temperatura/temp &gt;&gt; /temperatura/out <br> cat /temperatura/end &gt;&gt; /temperatura/out <br> cat /temperatura/out | /usr/bin/nc narodmon.ru NNNN <br> #  NNNN ‚Äî      <br> echo ¬´OK¬ª <br></div></div><br>    <a href=""></a> .            crontab. <br>       ,        . <br><br><h4> UPD 2 </h4><br>  <a href="https://geektimes.ru/users/ssar/" class="user_link">Ssar</a>   <a href="http://habrahabr.ru/post/166373/"> </a>  BASH    mac-         ID .            ,      . </div><p>Source: <a href="https://habr.com/ru/post/166373/">https://habr.com/ru/post/166373/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../166357/index.html">Little Brave Arkanoid (Part 2 - YAML)</a></li>
<li><a href="../166361/index.html">Project ‚ÄúProkaryotic Genome‚Äù - a scientific startup</a></li>
<li><a href="../166363/index.html">A few words about productivity</a></li>
<li><a href="../166367/index.html">Features of using roles with authentication in Oracle since 10.2.0.5</a></li>
<li><a href="../166369/index.html">Living computer museum</a></li>
<li><a href="../166375/index.html">And again about ... LAMP and basic secure mini-hosting with your own hands</a></li>
<li><a href="../166377/index.html">The history of reverse engineering of one fluffy animal</a></li>
<li><a href="../166383/index.html">Looking for the perfect commenting system</a></li>
<li><a href="../166385/index.html">ZFTool, command line for ZF2</a></li>
<li><a href="../166387/index.html">The use of ionistrov for regenerative braking in the subway</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>