<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Port i2cdevlib on STM32 HAL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I was very surprised when I found out that under STM32 there is no such variety of ready-made drivers for all sorts of i2c sensors, as for Arduino. Th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Port i2cdevlib on STM32 HAL</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/593/36f/695/59336f695d7e45f4bcf6e4db31a45fdc.jpg" width="70%"><br>  I was very surprised when I found out that under STM32 there is no such variety of ready-made drivers for all sorts of i2c sensors, as for Arduino.  Those that I managed to find were part of any OS (for example, ChubiOS, FreeRTOS, NuttX) and were more POSIX-like.  And I wanted to write under HAL: ( <br><br>  The Arduino community uses the <a href="https://github.com/jrowberg/i2cdevlib">i2cdevlib</a> library for abstraction from hardware when writing sensor drivers.  Actually, I am sharing my work - the <a href="https://github.com/anvol/i2cdevlib/tree/master/STM32">i2cdevlib port on the STM32 HAL</a> (pull-request has already been sent), and under the cut I will tell you about the pebbles that I collected along the way.  Well, the code examples will be. <br><a name="habracut"></a><br><h4>  What we work with </h4><br>  I have a dev board stm32f429i-disco in my hands, a board with gy-87, arduino uno sensors, EmBitz 0.40 development environment (ex Em :: Blocks) and Arduino. <br>  Arduinka was used to compare the results of reading register values.  The first porting sensor is BMP085 / BMP180.  Selected due to the presence of the sensor and a small amount of code in its driver. <br><br><h4>  Procedure </h4><br><ol><li>  Rewrite code from C ++ to C. For the library and for the driver </li><li>  In i2cdevlib, rewrite the functions of working with i2c on HAL along the way, discarding arduino-related code pieces </li><li>  Testing results, debugging </li></ol>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Rewriting code </h4><br>  For a start, we copy from C ++ to C. No, for a start, I will explain why :) <br>  In the embedded world, pure C is used more often. HAL itself serves as an example.  Popular development environments (EmBlocks, Keil) create projects in C. The code that the STM32CubeMX generates is also generic.  Yes, and using CBS in C ++ project is easier than transferring the entire project to C ++ for the sake of. <br><br>  Go.  Changing the names of functions, for example, <b>I2Cdev :: readByte</b> was <b>I2Cdev_readByte</b> .  Also, do not forget to add such a prefix to all function calls inside the class, where it does not exist ( <b>readByte</b> -&gt; <b>I2Cdev_readByte</b> ).  Routine, nothing special. <br>  At the same time, we understand the architecture of the library - only 4 functions that work with iron: <br><br><pre><code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> I2Cdev_readBytes(<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> devAddr, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> regAddr, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> length, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *data, <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> timeout); <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> I2Cdev_readWords(<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> devAddr, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> regAddr, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> length, <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> *data, <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> timeout); <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> I2Cdev_writeBytes(<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> devAddr, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> regAddr, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> length, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>* data); <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> I2Cdev_writeWords(<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> devAddr, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> regAddr, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> length, <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span>* data);</code> </pre> <br><br>  We perform a similar procedure with the BMP085 driver.  We add the missing inclusions (math.h, stdint.h, stdlib.h, string.h) along the way and declare the bool type.  This is C, baby) Perhaps it would be worth simply rewriting functions with bool -&gt; uint8_t ... <br><br>  Also in I2CDev you need to add a link to the structure with initialized i2c, which we will use for communications: <br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f4xx_hal.h"</span></span></span><span class="hljs-meta"> I2C_HandleTypeDef * I2Cdev_hi2c;</span></span></code> </pre><br><br><h4>  Implementing functions on HAL </h4><br>  The first in line will be I2Cdev_readBytes.  Here is the original listing, without debug pieces and implementations for different libraries / versions <br><br><pre> <code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">/** Read multiple bytes from an 8-bit device register. * @param devAddr I2C slave device address * @param regAddr First register regAddr to read from * @param length Number of bytes to read * @param data Buffer to store read data in * @param timeout Optional read timeout in milliseconds (0 to disable, leave off to use default class value in I2Cdev::readTimeout) * @return Number of bytes read (-1 indicates failure) */</span></span> int8_t I2Cdev::readBytes(uint8_t devAddr, uint8_t regAddr, uint8_t length, uint8_t *data, uint16_t timeout) { int8_t count = <span class="hljs-number"><span class="hljs-number">0</span></span>; uint32_t t1 = millis(); // Arduino v1<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>+, Wire library // Adds official support <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> repeated <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> condition, yay! // I2C/TWI subsystem uses <span class="hljs-type"><span class="hljs-type">internal</span></span> buffer that breaks <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">large</span></span> data requests // so <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> requests more than BUFFER_LENGTH bytes, we have <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> it <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> // smaller chunks <span class="hljs-keyword"><span class="hljs-keyword">instead</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> at once <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint8_t k = <span class="hljs-number"><span class="hljs-number">0</span></span>; k &lt; length; k += min(length, BUFFER_LENGTH)) { Wire.beginTransmission(devAddr); Wire.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(regAddr); Wire.endTransmission(); Wire.beginTransmission(devAddr); Wire.requestFrom(devAddr, (uint8_t)min(length - k, BUFFER_LENGTH)); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; Wire.available() &amp;&amp; (timeout == <span class="hljs-number"><span class="hljs-number">0</span></span> || millis() - t1 &lt; timeout); count++) { data[count] = Wire.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(); } } // <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> timeout <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (timeout &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; millis() - t1 &gt;= timeout &amp;&amp; count &lt; length) count = <span class="hljs-number"><span class="hljs-number">-1</span></span>; // timeout <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> count; }</code> </pre><br>  I don‚Äôt quite understand how this crutch with a cycle works, because in the case of length&gt; BUFFER_LENGTH we will specify the initial register in the new one.  I assume that the code <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Wire</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.beginTransmission</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">devAddr</span></span>); <span class="hljs-selector-tag"><span class="hljs-selector-tag">Wire</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.write</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">regAddr</span></span>); <span class="hljs-selector-tag"><span class="hljs-selector-tag">Wire</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.endTransmission</span></span>(); <span class="hljs-selector-tag"><span class="hljs-selector-tag">Wire</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.beginTransmission</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">devAddr</span></span>);</code> </pre><br>  must be <i>before the</i> loop.  In any case, the meaning is clear, we write under HAL: <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> I2Cdev_readBytes(<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> devAddr, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> regAddr, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> length, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *data, <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> timeout) { <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> tout = timeout &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? timeout : I2CDEV_DEFAULT_READ_TIMEOUT; HAL_I2C_Master_Transmit(I2Cdev_hi2c, devAddr &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>, ¬ÆAddr, <span class="hljs-number"><span class="hljs-number">1</span></span>, tout); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (HAL_I2C_Master_Receive(I2Cdev_hi2c, devAddr &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>, data, length, tout) == HAL_OK) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> length; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; }</code> </pre><br>  Pay attention to the address shift - devAddr &lt;&lt; 1. When I proceeded to testing the library with the driver, the first thing to check the correctness of the module connection was sketched the bus scanner: <br><br><pre> <code class="hljs matlab">uint8_t <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>&lt;<span class="hljs-number"><span class="hljs-number">255</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(HAL_I2C_IsDeviceReady(&amp;hi2c3, <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) == HAL_OK) printf(<span class="hljs-string"><span class="hljs-string">"Ready: 0x%02x"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>); }</code> </pre><br>  You correctly noted, I deliberately took all values ‚Äã‚Äãfrom 0-255, and not just 112 addresses allowed by the specification.  This made it possible to identify an error - each device on the line responded twice in a row, and not to its address: <br><br><img src="https://habrastorage.org/files/d36/a5f/b42/d36a5fb42eed4585b6a9e903191088cc.jpg"><br><br>  <b>Wire.begin ()</b> uses a 7-bit address, and HAL uses an 8-bit representation.  After a minute of reflection and corrections, we get a working scanner code: <br><pre> <code class="hljs matlab">uint8_t <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">15</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>&lt;<span class="hljs-number"><span class="hljs-number">127</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(HAL_I2C_IsDeviceReady(&amp;hi2c3, <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) == HAL_OK) printf(<span class="hljs-string"><span class="hljs-string">"Ready: 0x%02x"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>); }</code> </pre><br>  Conclusion - the device address must be shifted to the left to the left before calling the functions HAL_I2C _ *** <br><br><img src="https://habrastorage.org/files/3d9/9ce/9b9/3d99ce9b91ad42bd89a371f5cbf91bb7.jp"><br><br>  Go back to i2cdevlib.  Next in line is <b>I2Cdev_readWords</b> . <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> I2Cdev_readWords(<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> devAddr, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> regAddr, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> length, <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> *data, <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> timeout) { <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> tout = timeout &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? timeout : I2CDEV_DEFAULT_READ_TIMEOUT; HAL_I2C_Master_Transmit(I2Cdev_hi2c, devAddr &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>, ¬ÆAddr, <span class="hljs-number"><span class="hljs-number">1</span></span>, tout); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (HAL_I2C_Master_Receive(I2Cdev_hi2c, devAddr &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *)data, length*<span class="hljs-number"><span class="hljs-number">2</span></span>, tout) == HAL_OK) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> length; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; }</code> </pre><br><br>  In the original, MSB and LSB are manually read and written to the buffer. <br><div class="spoiler">  <b class="spoiler_title">I'm not lying</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint8_t k = <span class="hljs-number"><span class="hljs-number">0</span></span>; k &lt; length * <span class="hljs-number"><span class="hljs-number">2</span></span>; k += min(length * <span class="hljs-number"><span class="hljs-number">2</span></span>, BUFFER_LENGTH)) { Wire.beginTransmission(devAddr); Wire.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(regAddr); Wire.endTransmission(); Wire.beginTransmission(devAddr); Wire.requestFrom(devAddr, (uint8_t)(length * <span class="hljs-number"><span class="hljs-number">2</span></span>)); // length=words, this wants bytes <span class="hljs-type"><span class="hljs-type">bool</span></span> msb = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; // starts <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> MSB, <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> LSB <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; Wire.available() &amp;&amp; count &lt; length &amp;&amp; (timeout == <span class="hljs-number"><span class="hljs-number">0</span></span> || millis() - t1 &lt; timeout);) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msb) { // first byte <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> bits <span class="hljs-number"><span class="hljs-number">15</span></span><span class="hljs-number"><span class="hljs-number">-8</span></span> (MSb=<span class="hljs-number"><span class="hljs-number">15</span></span>) data[count] = Wire.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>() &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // second byte <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> bits <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> (LSb=<span class="hljs-number"><span class="hljs-number">0</span></span>) data[count] |= Wire.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(); #ifdef I2CDEV_SERIAL_DEBUG <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print(data[count], HEX); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count + <span class="hljs-number"><span class="hljs-number">1</span></span> &lt; length) <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print(" "); #endif count++; } msb = !msb; } Wire.endTransmission(); }</code> </pre><br></div></div><br>  Go to the data recording functions.  Here we are waiting for a bit of work with a dynamic array.  The fact is that the register address to start recording and the data to be written must be in the same transaction START - STOP bits.  And they are transferred to the function separately.  For the arduino library, Wire is not a problem, because the programmer himself writes begin / end and sends data between them.  We need to put it all in one buffer and transfer.  We use <b>malloc</b> and <b>memcpy</b> , which is more efficient than simple copying in a loop. <br><br>  <b>UPD 07/13/2016</b> : already redone, instead of dancing with <b>malloc</b> and <b>memcpy</b> , the function <b>HAL_I2C_Mem_Write</b> is <b>used</b> , which takes the device address, the register address and the data that should be written there.  <a href="https://github.com/anvol/i2cdevlib/commit/94707e766c01c80df311838f6fd77a25c2e6770d">Here is a diff commit</a> <br><br><pre> <code class="hljs haskell">/** <span class="hljs-type"><span class="hljs-type">Write</span></span> multiple bytes to an <span class="hljs-number"><span class="hljs-number">8</span></span>-bit device register. * @param devAddr <span class="hljs-type"><span class="hljs-type">I2C</span></span> slave device address * @param regAddr <span class="hljs-type"><span class="hljs-type">First</span></span> register address to write to * @param length <span class="hljs-type"><span class="hljs-type">Number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes to write * @param <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Buffer</span></span></span><span class="hljs-class"> to copy new </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> from * @return </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Status</span></span></span><span class="hljs-class"> of operation (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">success</span></span></span><span class="hljs-class">) */ uint16_t </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2Cdev_writeBytes</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">devAddr</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">regAddr</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Creating</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dynamic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">array</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">store</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">regAddr</span></span></span><span class="hljs-class"> + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">one</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">buffer</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dynBuffer</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dynBuffer</span></span></span><span class="hljs-class"> = (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> *) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">malloc</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sizeof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class">) * (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">+1)); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dynBuffer</span></span></span><span class="hljs-class">[0] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">regAddr</span></span></span><span class="hljs-class">; // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">copy</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">array</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">memcpy</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dynBuffer</span></span></span><span class="hljs-class">+1, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sizeof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class">) * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HAL_StatusTypeDef</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HAL_I2C_Master_Transmit</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2Cdev_hi2c</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">devAddr</span></span></span><span class="hljs-class"> &lt;&lt; 1, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dynBuffer</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">+1, 1000); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">free</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dynBuffer</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class"> == </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HAL_OK</span></span></span><span class="hljs-class">; }</span></span></code> </pre><br><br>  Similarly for <b>I2Cdev_writeWords</b> , only memory is allocated for uint16_t + one byte for uint8_t regAddr.  HAL'u time that the pointer to uint8_t, but we specify the length of the array correctly :) <br><br><pre> <code class="hljs haskell">/** <span class="hljs-type"><span class="hljs-type">Write</span></span> multiple words to a <span class="hljs-number"><span class="hljs-number">16</span></span>-bit device register. * @param devAddr <span class="hljs-type"><span class="hljs-type">I2C</span></span> slave device address * @param regAddr <span class="hljs-type"><span class="hljs-type">First</span></span> register address to write to * @param length <span class="hljs-type"><span class="hljs-type">Number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> words to write * @param <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Buffer</span></span></span><span class="hljs-class"> to copy new </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> from * @return </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Status</span></span></span><span class="hljs-class"> of operation (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">success</span></span></span><span class="hljs-class">) */ uint16_t </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2Cdev_writeWords</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">devAddr</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">regAddr</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16_t</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Creating</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dynamic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">array</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">store</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">regAddr</span></span></span><span class="hljs-class"> + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">one</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">buffer</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dynBuffer</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dynBuffer</span></span></span><span class="hljs-class"> = (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> *) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">malloc</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sizeof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class">) + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sizeof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16_t</span></span></span><span class="hljs-class">) * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dynBuffer</span></span></span><span class="hljs-class">[0] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">regAddr</span></span></span><span class="hljs-class">; // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">copy</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">array</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">memcpy</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dynBuffer</span></span></span><span class="hljs-class">+1, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sizeof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16_t</span></span></span><span class="hljs-class">) * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HAL_StatusTypeDef</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HAL_I2C_Master_Transmit</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2Cdev_hi2c</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">devAddr</span></span></span><span class="hljs-class"> &lt;&lt; 1, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dynBuffer</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sizeof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class">) + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sizeof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16_t</span></span></span><span class="hljs-class">) * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">, 1000); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">free</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dynBuffer</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class"> == </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HAL_OK</span></span></span><span class="hljs-class">; }</span></span></code> </pre><br><br><h4>  Testing results, debugging </h4><br>  For the test, we need to initialize i2c, assign a pointer to the structure in <b>I2Cdev_hi2c,</b> and then work with driver functions to get data from the sensor.  Here is the actual listing of the program and the result of its work: <br><div class="spoiler">  <b class="spoiler_title">example BMP180</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"stm32f4xx.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"stm32f4xx_hal.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;stdint.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;stdio.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;string.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"I2Cdev.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"BMP085.h"</span></span> <span class="hljs-type"><span class="hljs-type">I2C_HandleTypeDef</span></span> hi2c3; int main(void) { <span class="hljs-type"><span class="hljs-type">SystemInit</span></span>(); <span class="hljs-type"><span class="hljs-type">HAL_Init</span></span>(); <span class="hljs-type"><span class="hljs-type">GPIO_InitTypeDef</span></span> <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>; /**<span class="hljs-type"><span class="hljs-type">I2C3</span></span> <span class="hljs-type"><span class="hljs-type">GPIO</span></span> <span class="hljs-type"><span class="hljs-type">Configuration</span></span> <span class="hljs-type"><span class="hljs-type">PC9</span></span> ------&gt; <span class="hljs-type"><span class="hljs-type">I2C3_SDA</span></span> <span class="hljs-type"><span class="hljs-type">PA8</span></span> ------&gt; <span class="hljs-type"><span class="hljs-type">I2C3_SCL</span></span> */ __GPIOA_CLK_ENABLE(); __GPIOC_CLK_ENABLE(); <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Pin</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_PIN_9</span></span>; <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Mode</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_MODE_AF_OD</span></span>; <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Pull</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_PULLUP</span></span>; <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Speed</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_SPEED_FAST</span></span>; <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Alternate</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_AF4_I2C3</span></span>; <span class="hljs-type"><span class="hljs-type">HAL_GPIO_Init</span></span>(<span class="hljs-type"><span class="hljs-type">GPIOC</span></span>, &amp;<span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>); <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Pin</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_PIN_8</span></span>; <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Mode</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_MODE_AF_OD</span></span>; <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Pull</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_PULLUP</span></span>; <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Speed</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_SPEED_FAST</span></span>; <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Alternate</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_AF4_I2C3</span></span>; <span class="hljs-type"><span class="hljs-type">HAL_GPIO_Init</span></span>(<span class="hljs-type"><span class="hljs-type">GPIOA</span></span>, &amp;<span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>); __I2C3_CLK_ENABLE(); hi2c3.<span class="hljs-type"><span class="hljs-type">Instance</span></span> = <span class="hljs-type"><span class="hljs-type">I2C3</span></span>; hi2c3.<span class="hljs-type"><span class="hljs-type">Init</span></span>.<span class="hljs-type"><span class="hljs-type">ClockSpeed</span></span> = <span class="hljs-number"><span class="hljs-number">400000</span></span>; hi2c3.<span class="hljs-type"><span class="hljs-type">Init</span></span>.<span class="hljs-type"><span class="hljs-type">DutyCycle</span></span> = <span class="hljs-type"><span class="hljs-type">I2C_DUTYCYCLE_2</span></span>; hi2c3.<span class="hljs-type"><span class="hljs-type">Init</span></span>.<span class="hljs-type"><span class="hljs-type">OwnAddress1</span></span> = <span class="hljs-number"><span class="hljs-number">0x10</span></span>; hi2c3.<span class="hljs-type"><span class="hljs-type">Init</span></span>.<span class="hljs-type"><span class="hljs-type">AddressingMode</span></span> = <span class="hljs-type"><span class="hljs-type">I2C_ADDRESSINGMODE_7BIT</span></span>; hi2c3.<span class="hljs-type"><span class="hljs-type">Init</span></span>.<span class="hljs-type"><span class="hljs-type">DualAddressMode</span></span> = <span class="hljs-type"><span class="hljs-type">I2C_DUALADDRESS_DISABLED</span></span>; hi2c3.<span class="hljs-type"><span class="hljs-type">Init</span></span>.<span class="hljs-type"><span class="hljs-type">OwnAddress2</span></span> = <span class="hljs-number"><span class="hljs-number">0x11</span></span>; hi2c3.<span class="hljs-type"><span class="hljs-type">Init</span></span>.<span class="hljs-type"><span class="hljs-type">GeneralCallMode</span></span> = <span class="hljs-type"><span class="hljs-type">I2C_GENERALCALL_DISABLED</span></span>; hi2c3.<span class="hljs-type"><span class="hljs-type">Init</span></span>.<span class="hljs-type"><span class="hljs-type">NoStretchMode</span></span> = <span class="hljs-type"><span class="hljs-type">I2C_NOSTRETCH_DISABLED</span></span>; <span class="hljs-type"><span class="hljs-type">HAL_I2C_Init</span></span>(&amp;hi2c3); <span class="hljs-type"><span class="hljs-type">I2Cdev_hi2c</span></span> = &amp;hi2c3; // init of i2cdevlib. // <span class="hljs-type"><span class="hljs-type">You</span></span> can select other i2c device anytime and // call the same driver functions on other sensors while(!<span class="hljs-type"><span class="hljs-type">BMP085_testConnection</span></span>()) ; <span class="hljs-type"><span class="hljs-type">BMP085_initialize</span></span>(); while (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-type"><span class="hljs-type">BMP085_setControl</span></span>(<span class="hljs-type"><span class="hljs-type">BMP085_MODE_TEMPERATURE</span></span>); <span class="hljs-type"><span class="hljs-type">HAL_Delay</span></span>(<span class="hljs-type"><span class="hljs-type">BMP085_getMeasureDelayMilliseconds</span></span>(<span class="hljs-type"><span class="hljs-type">BMP085_MODE_TEMPERATURE</span></span>)); float t = <span class="hljs-type"><span class="hljs-type">BMP085_getTemperatureC</span></span>(); <span class="hljs-type"><span class="hljs-type">BMP085_setControl</span></span>(<span class="hljs-type"><span class="hljs-type">BMP085_MODE_PRESSURE_3</span></span>); <span class="hljs-type"><span class="hljs-type">HAL_Delay</span></span>(<span class="hljs-type"><span class="hljs-type">BMP085_getMeasureDelayMilliseconds</span></span>(<span class="hljs-type"><span class="hljs-type">BMP085_MODE_PRESSURE_3</span></span>)); float p = <span class="hljs-type"><span class="hljs-type">BMP085_getPressure</span></span>(); float a = <span class="hljs-type"><span class="hljs-type">BMP085_getAltitude</span></span>(p, <span class="hljs-number"><span class="hljs-number">101325</span></span>); printf(<span class="hljs-comment"><span class="hljs-comment">"T: %3.1f P: %3.0f A: %3.2f"</span></span>, t, p ,a); <span class="hljs-type"><span class="hljs-type">HAL_Delay</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>); } } void <span class="hljs-type"><span class="hljs-type">SysTick_Handler</span></span>() { <span class="hljs-type"><span class="hljs-type">HAL_IncTick</span></span>(); <span class="hljs-type"><span class="hljs-type">HAL_SYSTICK_IRQHandler</span></span>(); }</code> </pre><br></div></div><br>  It shows temperature in C, pressure in Pascals and height above sea level in meters <br><br><img src="https://habrastorage.org/files/690/452/46d/69045246d9db491b83a6b7cd9e14cc19.jpg"><br><br><h4>  Result </h4><br>  The library is ported, two drivers are also ready for work - for BMP085 / BMP180 and MPU6050.  I will show the work of the latter in the photo and give an example of the code: <br><div class="spoiler">  <b class="spoiler_title">a photo</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/31e/b19/2e9/31eb192e9a7f45e4af945aaf1a91bc2c.jpg"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">code example</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"stm32f4xx.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"stm32f4xx_hal.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;stdint.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;stdio.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;string.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"I2Cdev.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"BMP085.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"MPU6050.h"</span></span> <span class="hljs-type"><span class="hljs-type">I2C_HandleTypeDef</span></span> hi2c3; int main(void) { <span class="hljs-type"><span class="hljs-type">SystemInit</span></span>(); <span class="hljs-type"><span class="hljs-type">HAL_Init</span></span>(); <span class="hljs-type"><span class="hljs-type">GPIO_InitTypeDef</span></span> <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>; /**<span class="hljs-type"><span class="hljs-type">I2C3</span></span> <span class="hljs-type"><span class="hljs-type">GPIO</span></span> <span class="hljs-type"><span class="hljs-type">Configuration</span></span> <span class="hljs-type"><span class="hljs-type">PC9</span></span> ------&gt; <span class="hljs-type"><span class="hljs-type">I2C3_SDA</span></span> <span class="hljs-type"><span class="hljs-type">PA8</span></span> ------&gt; <span class="hljs-type"><span class="hljs-type">I2C3_SCL</span></span> */ __GPIOA_CLK_ENABLE(); __GPIOC_CLK_ENABLE(); <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Pin</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_PIN_9</span></span>; <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Mode</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_MODE_AF_OD</span></span>; <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Pull</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_PULLUP</span></span>; <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Speed</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_SPEED_FAST</span></span>; <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Alternate</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_AF4_I2C3</span></span>; <span class="hljs-type"><span class="hljs-type">HAL_GPIO_Init</span></span>(<span class="hljs-type"><span class="hljs-type">GPIOC</span></span>, &amp;<span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>); <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Pin</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_PIN_8</span></span>; <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Mode</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_MODE_AF_OD</span></span>; <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Pull</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_PULLUP</span></span>; <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Speed</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_SPEED_FAST</span></span>; <span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>.<span class="hljs-type"><span class="hljs-type">Alternate</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_AF4_I2C3</span></span>; <span class="hljs-type"><span class="hljs-type">HAL_GPIO_Init</span></span>(<span class="hljs-type"><span class="hljs-type">GPIOA</span></span>, &amp;<span class="hljs-type"><span class="hljs-type">GPIO_InitStruct</span></span>); __I2C3_CLK_ENABLE(); hi2c3.<span class="hljs-type"><span class="hljs-type">Instance</span></span> = <span class="hljs-type"><span class="hljs-type">I2C3</span></span>; hi2c3.<span class="hljs-type"><span class="hljs-type">Init</span></span>.<span class="hljs-type"><span class="hljs-type">ClockSpeed</span></span> = <span class="hljs-number"><span class="hljs-number">400000</span></span>; hi2c3.<span class="hljs-type"><span class="hljs-type">Init</span></span>.<span class="hljs-type"><span class="hljs-type">DutyCycle</span></span> = <span class="hljs-type"><span class="hljs-type">I2C_DUTYCYCLE_2</span></span>; hi2c3.<span class="hljs-type"><span class="hljs-type">Init</span></span>.<span class="hljs-type"><span class="hljs-type">OwnAddress1</span></span> = <span class="hljs-number"><span class="hljs-number">0x10</span></span>; hi2c3.<span class="hljs-type"><span class="hljs-type">Init</span></span>.<span class="hljs-type"><span class="hljs-type">AddressingMode</span></span> = <span class="hljs-type"><span class="hljs-type">I2C_ADDRESSINGMODE_7BIT</span></span>; hi2c3.<span class="hljs-type"><span class="hljs-type">Init</span></span>.<span class="hljs-type"><span class="hljs-type">DualAddressMode</span></span> = <span class="hljs-type"><span class="hljs-type">I2C_DUALADDRESS_DISABLED</span></span>; hi2c3.<span class="hljs-type"><span class="hljs-type">Init</span></span>.<span class="hljs-type"><span class="hljs-type">OwnAddress2</span></span> = <span class="hljs-number"><span class="hljs-number">0x11</span></span>; hi2c3.<span class="hljs-type"><span class="hljs-type">Init</span></span>.<span class="hljs-type"><span class="hljs-type">GeneralCallMode</span></span> = <span class="hljs-type"><span class="hljs-type">I2C_GENERALCALL_DISABLED</span></span>; hi2c3.<span class="hljs-type"><span class="hljs-type">Init</span></span>.<span class="hljs-type"><span class="hljs-type">NoStretchMode</span></span> = <span class="hljs-type"><span class="hljs-type">I2C_NOSTRETCH_DISABLED</span></span>; <span class="hljs-type"><span class="hljs-type">HAL_I2C_Init</span></span>(&amp;hi2c3); <span class="hljs-type"><span class="hljs-type">I2Cdev_hi2c</span></span> = &amp;hi2c3; // init of i2cdevlib. // <span class="hljs-type"><span class="hljs-type">You</span></span> can select other i2c device anytime and // call the same driver functions on other sensors while(!<span class="hljs-type"><span class="hljs-type">BMP085_testConnection</span></span>()) ; int16_t ax, ay, az; int16_t gx, gy, gz; int16_t c_ax, c_ay, c_az; int16_t c_gx, c_gy, c_gz; <span class="hljs-type"><span class="hljs-type">MPU6050_initialize</span></span>(); <span class="hljs-type"><span class="hljs-type">BMP085_initialize</span></span>(); <span class="hljs-type"><span class="hljs-type">MPU6050_setFullScaleGyroRange</span></span>(<span class="hljs-type"><span class="hljs-type">MPU6050_GYRO_FS_250</span></span>); <span class="hljs-type"><span class="hljs-type">MPU6050_setFullScaleAccelRange</span></span>(<span class="hljs-type"><span class="hljs-type">MPU6050_ACCEL_FS_2</span></span>); <span class="hljs-type"><span class="hljs-type">MPU6050_getMotion6</span></span>(&amp;c_ax, &amp;c_ay, &amp;c_az, &amp;c_gx, &amp;c_gy, &amp;c_gz); while (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-type"><span class="hljs-type">BMP085_setControl</span></span>(<span class="hljs-type"><span class="hljs-type">BMP085_MODE_TEMPERATURE</span></span>); <span class="hljs-type"><span class="hljs-type">HAL_Delay</span></span>(<span class="hljs-type"><span class="hljs-type">BMP085_getMeasureDelayMilliseconds</span></span>(<span class="hljs-type"><span class="hljs-type">BMP085_MODE_TEMPERATURE</span></span>)); float t = <span class="hljs-type"><span class="hljs-type">BMP085_getTemperatureC</span></span>(); <span class="hljs-type"><span class="hljs-type">BMP085_setControl</span></span>(<span class="hljs-type"><span class="hljs-type">BMP085_MODE_PRESSURE_3</span></span>); <span class="hljs-type"><span class="hljs-type">HAL_Delay</span></span>(<span class="hljs-type"><span class="hljs-type">BMP085_getMeasureDelayMilliseconds</span></span>(<span class="hljs-type"><span class="hljs-type">BMP085_MODE_PRESSURE_3</span></span>)); float p = <span class="hljs-type"><span class="hljs-type">BMP085_getPressure</span></span>(); float a = <span class="hljs-type"><span class="hljs-type">BMP085_getAltitude</span></span>(p, <span class="hljs-number"><span class="hljs-number">101325</span></span>); printf(buf, <span class="hljs-comment"><span class="hljs-comment">"T: %3.1f P: %3.0f A: %3.2f"</span></span>, t, p ,a); <span class="hljs-type"><span class="hljs-type">MPU6050_getMotion6</span></span>(&amp;ax, &amp;ay, &amp;az, &amp;gx, &amp;gy, &amp;gz); printf(<span class="hljs-comment"><span class="hljs-comment">"Accel: %d %d %d"</span></span>, ax - c_ax, ay - c_ay, az - c_az); printf(<span class="hljs-comment"><span class="hljs-comment">"Gyro: %d %d %d"</span></span>, gx - c_gx, gy - c_gy, gz - c_gz); <span class="hljs-type"><span class="hljs-type">HAL_Delay</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>); } } void <span class="hljs-type"><span class="hljs-type">SysTick_Handler</span></span>() { <span class="hljs-type"><span class="hljs-type">HAL_IncTick</span></span>(); <span class="hljs-type"><span class="hljs-type">HAL_SYSTICK_IRQHandler</span></span>(); }</code> </pre><br></div></div><br>  The sensor data was verified with the data obtained through the arduino uno connected to the same sensors. <br>  In the near future I will add drivers for other sensors that I have on hand - ADXL345 and HMC5883L.  The rest, perhaps, you will not be difficult to port if necessary.  If anything - write, help :) <br><br>  I hope my work will save someone time and / or facilitate the transition from Arduinok to STM32. <br>  Thank you for your interest! <br><br>  <b>UPD 07.13.2016</b> : <b>malloc</b> and <b>memcpy</b> removed, using <b>HAL_I2C_Mem_Write</b> .  The original code left to understand the logic of the discussion in the comments.  <a href="https://github.com/anvol/i2cdevlib/commit/94707e766c01c80df311838f6fd77a25c2e6770d">I repeat, here are the changes</a> <br><br>  Materials read: <br>  <a href="http://i2c.info/i2c-bus-specification">I2c specification</a> <br>  <a href="http://www.i2cdevlib.com/">Website library i2cdevlib with drivers and other usefulness</a> </div><p>Source: <a href="https://habr.com/ru/post/259709/">https://habr.com/ru/post/259709/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259677/index.html">Autopilot system for radio-controlled helicopter. Part 1: The Idea</a></li>
<li><a href="../259679/index.html">Native OmniDirectional shadows implementation in DirectX11</a></li>
<li><a href="../259683/index.html">Autopilot system for radio-controlled helicopter. Part 2: Takeover</a></li>
<li><a href="../259691/index.html">Battle "Listener vs Visitor" at the stadium antlr4</a></li>
<li><a href="../259701/index.html">Vim in full: Introduction</a></li>
<li><a href="../259717/index.html">Start using GTKD</a></li>
<li><a href="../259719/index.html">OS Development on Go + asm Part 0x00</a></li>
<li><a href="../259721/index.html">SIP phone from stm32f4-discovery</a></li>
<li><a href="../259723/index.html">How to create Pixel Perfect images in Adobe Illustrator</a></li>
<li><a href="../259725/index.html">Vim in full: Plugin Manager without fatal flaws</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>