<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Log in to VK for people</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What happened? 


 Hello, dear reader. If you at least once worked with the Vkontakte API and at the same time write everything in python , probably t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Log in to VK for people</h1><div class="post__text post__text-html js-mediator-article"><h2>  What happened? </h2><br><p> Hello, dear reader.  If you at least once worked with the Vkontakte API and at the same time write everything in <code>python</code> , probably the authorization of the application made you do several squats, after which you either don‚Äôt feel legs and faint, or you add quadriceps and still punch the API like Van Damm </p><br><p>  For some reason, this seemingly unremarkable stage at first takes a huge amount of time and effort.  My task: to help Habr's readers avoid leg injuries. </p><br><p>  Next, I propose to consider a small library, which allows in one line to authorize your application for a specific user and get <code>access_token</code> .  At the end of the article there is a link to the github repository of this library with quickstart in the <code>README</code> file. <a name="habracut"></a></p><br><h2>  Task </h2><br><p>  We want a small module that allows you to authorize beautifully, universally and as safely as possible, and which is <strong>very</strong> simple to use. <br>  It is worth saying that this solution is an improvement and generalization of the variant proposed in <a href="https://habrahabr.ru/post/143972/">this</a> article. </p><br><p>  So, we use <code>python3.5</code> , a library for html <a href="http://docs.python-requests.org/en/master/">requests</a> and <code>getpass</code> <a href="http://docs.python-requests.org/en/master/">requests</a> for hidden password input. </p><br><p>  Our task: several times contact the correct address, each time parsit <code>&lt;form&gt;</code> , send the answer and finally get the desired <code>access_token</code> . </p><br><h2>  Implementation </h2><br><p>  Let's start by creating a class.  During initialization, we will require a list of "permissions" to which the application wants to access, the id of this application and the version of the VK API.  Plus, add a few optional parameters, the value of each of which is clarified further. </p><br><div class="spoiler">  <b class="spoiler_title">__Init__ method</b> <div class="spoiler_text"><pre> <code class="hljs rust">class VKAuth(object): def __init__(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, permissions, app_id, api_v, email=<span class="hljs-literal"><span class="hljs-literal">None</span></span>, pswd=<span class="hljs-literal"><span class="hljs-literal">None</span></span>, two_factor_auth=False, security_code=<span class="hljs-literal"><span class="hljs-literal">None</span></span>, auto_access=True): <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">" Args: permissions: list of Strings with permissions to get from API app_id: (String) vk app id that one can get from vk.com api_v: (String) vk API version "</span></span><span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.session = requests.Session() <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.form_parser = FormParser() <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.user_id = <span class="hljs-literal"><span class="hljs-literal">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.access_token = <span class="hljs-literal"><span class="hljs-literal">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.response = <span class="hljs-literal"><span class="hljs-literal">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.permissions = permissions <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.api_v = api_v <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.app_id = app_id <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.two_factor_auth= two_factor_auth <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.security_code = security_code <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.email = email <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.pswd = pswd <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.auto_access = auto_access <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> security_code != <span class="hljs-literal"><span class="hljs-literal">None</span></span> and two_factor_auth == False: raise RuntimeError(<span class="hljs-symbol"><span class="hljs-symbol">'Security</span></span> code provided <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> non-two-factor authorization')</code> </pre></div></div><br><p>  As mentioned in the article already mentioned, we need to skillfully roll cookies and redirectes.  All this is done for us by the <code>requests</code> library with an object of the Session class.  We‚Äôll get this one in the field <code>self.session</code> .  To parse the html document, the standard <code>HTMLParser</code> class from the <code>html.parser</code> module is <code>html.parser</code> .  For the parser, a class ( <code>FormParser</code> ) is also written, which doesn't make much sense, since it almost completely repeats the one from the mentioned article.  The only significant difference is that the one used here allows you to gracefully reject the authorization of the application at the last step, if you suddenly change your mind. </p><br><p>  The <code>user_id</code> and <code>access_token</code> will be filled in after successful authorization, <code>response</code> stores the result of the last html request. </p><br><p>  The library user will be provided with a single method - <code>authorize</code> , which performs 3 steps: </p><br><ol><li>  application authorization request </li><li>  user authorization <br>  2.1 the introduction of key-code in the case of two-factor authentication </li><li>  confirmation of permission to use <code>permissions</code> </li></ol><br><p>  Lets go through each step. </p><br><h3>  Step 1. Request to authorize the application </h3><br><p>  Carefully compose the url of the request (you can read about the parameters <a href="https://new.vk.com/dev/auth_mobile">here</a> ), send the request and parse the resulting html. </p><br><div class="spoiler">  <b class="spoiler_title">The authorize method for Step 1</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">authorize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> api_auth_url = <span class="hljs-string"><span class="hljs-string">'https://oauth.vk.com/authorize'</span></span> app_id = self.app_id permissions = self.permissions redirect_uri = <span class="hljs-string"><span class="hljs-string">'https://oauth.vk.com/blank.html'</span></span> display = <span class="hljs-string"><span class="hljs-string">'wap'</span></span> api_version = self.api_v auth_url_template = <span class="hljs-string"><span class="hljs-string">'{0}?client_id={1}&amp;scope={2}&amp;redirect_uri={3}&amp;display={4}&amp;v={5}&amp;response_type=token'</span></span> auth_url = auth_url_template.format(api_auth_url, app_id, <span class="hljs-string"><span class="hljs-string">','</span></span>.join(permissions), redirect_uri, display, api_version) self.response = self.session.get(auth_url) <span class="hljs-comment"><span class="hljs-comment"># look for &lt;form&gt; element in response html and parse it if not self._parse_form(): raise RuntimeError('No &lt;form&gt; element found. Please, check url address')</span></span></code> </pre> </div></div><br><h3>  Step 2. User authorization </h3><br><p>  The <code>_log_in()</code> and <code>_two_fact_auth()</code> methods are implemented for [not] successful authorization of a user in VK if he is not authorized (and he is not authorized).  Both methods use the previously defined <code>email</code> , <code>pswd</code> , <code>two_factor_auth</code> and <code>security_code</code> fields.  If some of the fields were not supplied with an argument when initializing an object of the <code>VKAuth</code> class, they will be asked to enter into the console, and in case of failure they will be asked to enter again.  Two-factor authentication is optional and disabled by default, and our module notifies the user of its presence with an error. </p><br><div class="spoiler">  <b class="spoiler_title">The authorize method for Step 2 (continued from Step 1)</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#look for &lt;form&gt; element in response html and parse it if not self._parse_form(): raise RuntimeError('No &lt;form&gt; element found. Please, check url address') else: # try to log in with email and password (stored or expected to be entered) while not self._log_in(): pass; # handling two-factor authentication # expecting a security code to enter here if self.two_factor_auth: self._two_fact_auth()</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">The _log_in method for Step 2</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_log_in</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.email == <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: self.email = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> self.email.strip() == <span class="hljs-string"><span class="hljs-string">''</span></span>: self.email = input(<span class="hljs-string"><span class="hljs-string">'Enter an email to log in: '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.pswd == <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: self.pswd = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> self.pswd.strip() == <span class="hljs-string"><span class="hljs-string">''</span></span>: self.pswd = getpass.getpass(<span class="hljs-string"><span class="hljs-string">'Enter the password: '</span></span>) self._submit_form({<span class="hljs-string"><span class="hljs-string">'email'</span></span>: self.email, <span class="hljs-string"><span class="hljs-string">'pass'</span></span>: self.pswd}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> self._parse_form(): <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> RuntimeError(<span class="hljs-string"><span class="hljs-string">'No &lt;form&gt; element found. Please, check url address'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># if wrong email or password if 'pass' in self.form_parser.params: print('Wrong email or password') self.email = None self.pswd = None return False elif 'code' in self.form_parser.params and not self.two_factor_auth: raise RuntimeError('Two-factor authentication expected from VK.\nChange `two_factor_auth` to `True` and provide a security code.') else: return True</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">The _two_fact_auth method for Step 2</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_two_fact_auth</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> prefix = <span class="hljs-string"><span class="hljs-string">'https://m.vk.com'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> prefix <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.form_parser.url: self.form_parser.url = prefix + self.form_parser.url <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.security_code == <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: self.security_code = input(<span class="hljs-string"><span class="hljs-string">'Enter security code for two-factor authentication: '</span></span>) self._submit_form({<span class="hljs-string"><span class="hljs-string">'code'</span></span>: self.security_code}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> self._parse_form(): <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> RuntimeError(<span class="hljs-string"><span class="hljs-string">'No &lt;form&gt; element found. Please, check url address'</span></span>)</code> </pre> </div></div><br><h2>  Step 3. Confirming <code>permissions</code> and getting <code>access_token</code> </h2><br><p>  The hardest thing behind.  Now it's up to you.  We use our improvement of the form parser to find in the html document that has just arrived to us a button with the inscription "Allow" and pull out the authorization confirmation url from it.  Nearby is the reject button - we will save its url.  The <code>auto_access</code> field <code>auto_access</code> to <code>True</code> , so this confirmation should not make life difficult for us. </p><br><p>  Finally, we save the received <code>access_token</code> and <code>user_id</code> from the url, which was transmitted after confirmation of authorization. </p><br><p>  Now you can have fun using the VK API. </p><br><blockquote>  <a href="http://redirect_uri/">http: // REDIRECT_URI # access_token</a> = 533bacf01e11f55b536a565b57531ad114461ae8736d6506a3 &amp; expires_in = 86400 &amp; user_id = 8492 </blockquote><br><div class="spoiler">  <b class="spoiler_title">The authorize method for Step 3</b> <div class="spoiler_text"><pre> <code class="python hljs"> <span class="hljs-comment"><span class="hljs-comment"># allow vk to use this app and access self.permissions self._allow_access() # now get access_token and user_id self._get_params()</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">_Allow_access method for step 3</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_allow_access</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> parser = self.form_parser <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'submit_allow_access'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> parser.params <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">'grant_access'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> parser.url: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> self.auto_access: answer = <span class="hljs-string"><span class="hljs-string">''</span></span> msg = <span class="hljs-string"><span class="hljs-string">'Application needs access to the following details in your profile:\n'</span></span> + \ str(self.permissions) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span> + \ <span class="hljs-string"><span class="hljs-string">'Allow it to use them? (yes or no)'</span></span> attempts = <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> answer <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-string"><span class="hljs-string">'yes'</span></span>, <span class="hljs-string"><span class="hljs-string">'no'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> attempts &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>: answer = input(msg).lower().strip() attempts-=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> answer == <span class="hljs-string"><span class="hljs-string">'no'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> attempts == <span class="hljs-number"><span class="hljs-number">0</span></span>: self.form_parser.url = self.form_parser.denial_url print(<span class="hljs-string"><span class="hljs-string">'Access denied'</span></span>) self._submit_form({})</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">_Get_params method for step 3</b> <div class="spoiler_text"><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_get_params</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: params = self.response.url.split(<span class="hljs-string"><span class="hljs-string">'#'</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">'&amp;'</span></span>) self.access_token = params[<span class="hljs-number"><span class="hljs-number">0</span></span>].split(<span class="hljs-string"><span class="hljs-string">'='</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>] self.user_id = params[<span class="hljs-number"><span class="hljs-number">2</span></span>].split(<span class="hljs-string"><span class="hljs-string">'='</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> IndexError(e): print(e) print(<span class="hljs-string"><span class="hljs-string">'Coudln\'t fetch token'</span></span>)</code> </pre> </div></div><br><p>  <strong>github</strong> : <a href="https://github.com/good-move/VKAuth">VKAuth</a> </p><br><p>  Leave comments and reviews here and on github.  Good luck on the battlefield, and take care of your feet. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/306022/">https://habr.com/ru/post/306022/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306012/index.html">How to work from AWS Lambda with Elasticache and DynamoDB</a></li>
<li><a href="../306014/index.html">Grammy Award Winner, Professional Circus and Apple Veteran Change Careers</a></li>
<li><a href="../306016/index.html">Features of installation and update 3CX v15</a></li>
<li><a href="../306018/index.html">Modern Code. Program Modern</a></li>
<li><a href="../306020/index.html">HR work in the eyes of the developer</a></li>
<li><a href="../306024/index.html">Self-employment is not freedom. The myth of the happy life of an entrepreneur</a></li>
<li><a href="../306026/index.html">Connect the HP tape library via Fiber Channel to an ESXi 5.5 host</a></li>
<li><a href="../306028/index.html">CLion 2016.2 release: remote debugging, Doxygen format support, new code generation features and much more</a></li>
<li><a href="../306030/index.html">Software update and initial setup instructions for Nokia 7210 SAS-M</a></li>
<li><a href="../306032/index.html">Introduction to Veeam Agent for Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>