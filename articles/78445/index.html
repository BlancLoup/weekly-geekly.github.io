<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Work with large amounts of data and habraeffekt</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the goals of creating bullshitbingo.ru was to see how the google application engine ( GAE ) behaves in more or less realistic conditions. I was...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Work with large amounts of data and habraeffekt</h1><div class="post__text post__text-html js-mediator-article">  One of the goals of creating <a href="http://bullshitbingo.ru/">bullshitbingo.ru</a> was to see how the google application engine ( <a href="http://code.google.com/intl/ru/appengine/docs/whatisgoogleappengine.html">GAE</a> ) behaves in more or less realistic conditions.  I was especially interested in the possibility of obtaining my own statistics, because what GAE and google analitics give me does not suit me for the reasons that I will give below.  There <a href="http://habrahabr.ru/blogs/i_am_advertising/77726/">was no</a> special reaction to the <a href="http://habrahabr.ru/blogs/i_am_advertising/77726/">post</a> itself, but it came out to the main page and the site received about 15,000 downloads in a day, which was quite enough.  The peak of the load was 3-4 requests per second, as a result, the limit of free resources allocated by GAE was not exceeded. <br><br>  The following is a description of the features of working with statistics in GAE and in the second part of the graphics about the resulting load: your own and those generated by google.  I tried to write so that it was clear to those who did not come across GAE at all. <br><a name="habracut"></a><br><br>  <b>Part One: Statistics</b> <br>  GAE, of course, shows its own graphics, but there are a number of questions: <ul><li>  watch them after some time becomes impossible, the graphics are available only for the last day; </li><li>  data presentation is fixed and not configurable; </li><li>  There is no possibility to build a schedule for some of its conditions, in the case of bullshitbingo, it would be interesting for me to see separate games separately. </li></ul>  Google Analitics is much more interesting in this respect, but with its own problems: javascript, a minimum time interval limited by an hour, etc.  In short, it did not suit me.  Therefore, with each page load, I wrote down information about the request to the database.  The result was approximately 15,000 records of requests for which, say, I want to build a graph. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Problem: <i>GAE is fundamentally unable to return more than 1000 entries</i> .  This is connected with the non-relational data model, and, perhaps, it doesn‚Äôt bother anyone at all, but it hinders much when working with statistics.  Another consideration: it can be very expensive to build some complex queries and calculate something directly on the GAE side, and you will have to pay for processor time and storage of large amounts of data.  Since statistics is, generally speaking, ‚Äúdead‚Äù data that is not necessary for operation, it can be easily retrieved from the GAE servers somewhere, and processed there.  Even more convenient.  Therefore, it was decided to upload statistics in the form of <a href="http://ru.wikipedia.org/wiki/CSV">csv-files</a> and work with it already somehow locally. <br><br>  <b>Data upload</b> <br>  Uploading data is a separate task, because it is also not able to select records with a GAE offset.  It is more able to, but it is actually implemented on the client side (of the application, and not of the http-client, of course).  That is, when I want to get 10 records starting from the 100th, this can be done, and for that, there is even a corresponding parameter to the fetch () call, but in fact all 110 records will be extracted from the database, just the first hundred APIs will keep .  That is just to get 100 records from the 1000th in general is impossible.  This is even written in the documentation, but somehow somewhat vague. <br><br>  You can get out of the situation if you use not the line number as an offset, as I used to in relational databases, but date / time.  Time in GAE is stored as much as six decimal places, so the probability of making several entries with exactly the same time is extremely small.  Strictly speaking, it is possible to create an artificial unique field with monotonously increasing values, but I do not see such a need. <br><br>  All statistics can be sorted by date and choose 1000 pieces, each time remembering what date you managed to get, and the next time you retreat from it.  Once the statistics are guaranteed to be unloaded, it can be deleted.  Then I call these fragments of 1000 records pages.  You can choose another number, but 1000 turned out to be no worse, say 100, so I stopped at 1000. <br><br>  The statistics upload script takes as a parameter the maximum date (the date, without the time) to which the data is to be output.  There are two reasons for this: <br>  1) the statistics comes in constantly, but the data ‚Äúfor yesterday and earlier‚Äù will not change; <br>  2) uploading all the statistics at once may simply not be possible due to the large amount of data and restrictions on the execution time, and it will be possible to unload at least one day. <br><br>  Thus, the algorithm with large strokes is the following: <ol><li>  select the 1000 oldest records with a query like this: SELECT * FROM request where date &lt;date $ 1000 <b>by date</b> limit 1000; </li><li>  create a csv-record for each line; </li><li>  remember $ last_date - maximum received date; </li><li>  execute the query, adding to the condition with the $ last_date: SELECT * FROM request where the date &lt;$ date and date <b>&gt; = $ last_date</b> order by date limit 1000; </li><li>  while the query result is non-empty goto 2. </li></ol> After receiving the csv-file, it is necessary to make sure 10 times that the statistics has been completely unloaded, correctly and for the required period, after which it can be deleted from the GAE database. <br><br>  When comparing with $ last_date, ‚Äúnon-strictly more‚Äù is used because theoretically the possibility of exact coincidence of time in two different queries still exists.  So that the lines at the junction of the pages are not duplicated, you need to verify their unique keys (and GAE generates such a key for any objects stored in the database) and omit the line if it has already been unloaded. <br><br>  In the case of bullshitbingo, the data for the day in which I published the post on Habr√©, was downloaded in about 20 seconds, that is, on the verge of a foul.  If there is a little more data, then you still have to break the uploads not by days, but by hours. <br><br>  <b>Delete statistics.</b>  With this, of course, again problems.  Documentation assures that it is more efficient to delete records from the database in bulk rather than one by one.  When you try to just delete everything that is less than a given date, you always get a timeout.  And when I checked this procedure for comparable volumes locally, it slowly, but worked.  I had to rewrite the procedure for deleting one entry.  For 30 seconds allotted for the script execution time, 400-600 records were deleted.  I rewrote the procedure again and began to delete records of 100 pieces, it seems to be the process has accelerated, to understand what happened there was no longer the strength.  Removes and all right, receptions in 10 everything turned out. <br><br>  <b>Part two: ‚Äúhabraeffekt?‚Äù</b> <br>  There have already been several articles on this topic, for example, <a href="http://habrahabr.ru/blogs/webdev/70324/">here is</a> an article about GAE, but on java and there the picture is simply given, and I have a fully functional project. <br><br>  In general, I would not mention this effect either: at the peak the load was 4 requests per second.  For no more than an hour, the load was about two requests per second, after which it fell steadily, this is all evident from the graphs. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/3b0/ce6/ee5/3b0ce6ee5b183f37b312fb32b7029d28.png"></a> <br>  Complete statistics.  Peak load in 4 queries is not visible here due to averaging. <br><br>  The time is Moscow, the post was published at 14:40, apparently in about an hour he went to the main page.  GAE stores time in GMT, I did the conversion already at the stage of drawing graphs, although it would be possible when loading csv files, perhaps. <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/5e8/b49/fd7/5e8b49fd735f144733d3053980792d6c.png"></a> <br>  Separately statistics on the main page. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/dc1/82d/170/dc182d17064300e48733c4d7662c4d4c.png"></a> <br>  Statistics on <a href="http://bullshitbingo.ru/habr">the game</a> . <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/9f4/059/cad/9f4059cad55cb6cfe1d6d30a08e6bccb.png"></a> <br>  Statistics the next day: by 11 am, the majority of people read up the second page of the habranths. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/fac/000/ffc/fac000ffc548cd9bdc228f6493f227bd.png"></a> <br>  Administrative interface GAE.  It also shows the resources spent, screenshots taken 10 hours after the post was published.  I like my drawings more. <br><br>  There are still <a href="">statistics for two days</a> , you can estimate the scale. <br><br>  It should be noted that I didn‚Äôt do any optimization at all.  That is, with each request, all that is possible (all sorts of signatures, headers, titles and descriptions, all the words for games) was selected from the database, except that it did not arrange artificial empty cycles.  This is done firstly because of laziness, secondly to see what happens.  As a result, spent about 70% of the resources that GAE provides for free.  The CPU turned out to be a bottleneck, from all other resources it was spent on 1-2%.  In addition, several timeout errors were received when accessing the database, so most of the work with the database was later transferred to memcach. <br><br>  <b>Some more statistics</b> <br>  After fasting, about 150 people tried to look at the administrative interface, 90 games were created, almost 30 of them are non-empty and 15 pieces are quite to themselves with meaningful content, their authors - hello. <br><br>  A total of people went (by ip addresses): 6814 <br>  More than one page loaded: 3573 or 52% <br>  More than two pages uploaded: 2334, 34% <br>  More than ten: 215, 3% <br><br>  <b>findings</b> <br>  Working with large amounts of data in GAE is not very convenient, but it is quite possible.  For real work, you will have to write scripts that will unload statistics on a schedule, automate it to check for correctness, and then initialize the cleanup of the unloaded GAE.  That is, this all leads to quite noticeable overhead costs and creates quite definite, but surmountable difficulties. </div><p>Source: <a href="https://habr.com/ru/post/78445/">https://habr.com/ru/post/78445/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../78439/index.html">Samsung Introduces Bada Mobile Platform</a></li>
<li><a href="../78440/index.html">PHOTOROBOT-2A Review (traffic)</a></li>
<li><a href="../78441/index.html">Robo-bowling</a></li>
<li><a href="../78443/index.html">Bookmark All Tabs - Chrome built-in feature, alternative to Session Manager with sync</a></li>
<li><a href="../78444/index.html">Office gadget in winter</a></li>
<li><a href="../78446/index.html">Rejector.ru - Russian OpenDNS</a></li>
<li><a href="../78450/index.html">LJ Notifier - new comment notifications</a></li>
<li><a href="../78452/index.html">Write protection on USB drives</a></li>
<li><a href="../78454/index.html">Google Fusion Tables API</a></li>
<li><a href="../78458/index.html">Interplay still blinks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>