<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Object collections in PHP. Part two</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Almost 3 weeks have passed since the publication of my first post about object collections in PHP . During this time, a lot of work has been done and ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Object collections in PHP. Part two</h1><div class="post__text post__text-html js-mediator-article">  Almost 3 weeks have passed since the publication of my first <a href="http://habrahabr.ru/post/144182/">post about object collections in PHP</a> .  During this time, a lot of work has been done and a lot of experience has been gained that I want to share.  The greatest number of changes have undergone maps, most of the attention will be paid to them. <br><br>  In this post you will see: <br><ul><li>  Project and implementation of collections of objects in PHP. </li><li>  Performance tests </li><li>  Impressions about writing the first Unit tests. </li><li>  Interesting information about working with sets of PHP objects. </li></ul><br><a name="habracut"></a><br><br><h4>  What was done? </h4>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After the publication of my last post and the end of his discussion, I made a plan for further development: <br><ul><li>  Implementing the ability to iterate collections using foreach (). </li><li>  Specialization of the main implementations of collections for more convenient use. </li><li>  Creating a new implementation of the map interface based on a single PHP array. </li><li>  Improving hashing algorithms. </li><li>  Waiver of certain data types for maps.  The final list of supported types is as follows: int, string, object. </li><li>  Testing functionality. </li><li>  Performance Testing </li></ul><br><br>  In addition to the above list, there were also candidates who were not included in the plan for the current release: <br><br><ul><li>  Filtering and sorting functions. </li><li>  Utilitarian functions of collections. </li></ul><br><br><h4>  Collection interfaces </h4><br>  The interfaces of collections developed earlier reacted rather stably to the new development plan.  The interface diagram of the current version looks like this: <br><img src="https://habrastorage.org/storage2/b7f/e2a/b8b/b7fe2ab8b451b934e731e75070e88f7a.jpg"><br><br>  As you can see from the diagram, all collection interfaces inherit the IteratorAggregate interface, which makes it possible to crawl collections using foreach ().  The problem with warning that pops up when processing maps &lt;object - object&gt; with the help of foreach () still remains, but since such situations really happen rarely, I decided to close my eyes to this. <br><br><h4>  Card implementations </h4><br>  Maps are represented by implementations of HashMap, HashSet and HashTable.  Each of these implementations has its own specializations for simplified use. <br><br><img src="https://habrastorage.org/storage2/979/305/8f2/9793058f253316f54d6c8b13831b0fa3.jpg"><br><br><h5>  Hashtable </h5><br>  The internal structure of the HashTable map is based on a single PHP array.  This makes it possible to work quickly using the O (1) key, but it is bad for the ability to work by value, which is performed by the usual search O (n). <br><br>  HashTable map keys are unique.  HashTable map values ‚Äã‚Äãare not unique, which allows you to associate one value with multiple keys. <br><br>  The HashTable map supports strings and integers for keys and strings, integers and objects for values. <br><br>  Key and value hashing is not performed.  The getKeyHash () and getValueHash () methods throw an exception. <br><br>  <a href="">HashTable class diagram.</a> <br><br><h5>  HashMap &amp; HashSet </h5><br>  The internal structure of the HashMap and HashSet maps is based on a network of associative links.  This makes it possible to implement all map operations using associative samples.  The complexity of the card algorithms is O (1), which means that the installation / retrieval time of objects does not change depending on the size of the maps. <br><br>  The keys of the HashMap card are unique.  HashMap map values ‚Äã‚Äãare not unique, which allows you to associate one value with multiple keys. <br><br>  The keys and values ‚Äã‚Äãof the HashSet map are unique, which allows you to organize a repository of unique associations. <br><br>  HashMap and HashSet support strings, integers, and objects for keys and values. <br><br>  <a href="">HashMap class diagram.</a> <br>  <a href="">HashSet class diagram.</a> <br><br><h4>  Implementing Sets, Lists, and Queues </h4><br>  The implementation of the sets has undergone some cosmetic changes and overgrown with specializations for easy use. <br>  <a href="">Chart of classes of sets.</a> <br><br>  The implementation of lists and queues remained virtually unchanged. <br>  <a href="">Chart of lists and queues.</a> <br><br><h4>  Functionality testing </h4><br>  All submitted code is covered with <a href="https://github.com/sebastianbergmann/phpunit/">PHPUnit</a> tests. <br>  These were my first Unit tests and I am very pleased with the experience.  This type of testing allowed me to catch about ten typos and one fundamental error, for fixing which I had to change the implementation. <br>  I would like to note three things: <br><ol><li>  If you do not use Unit tests yet, start right now.  Personally, I had an interesting situation: I spawned quite a lot of code that I had to maintain and I learned, I learned a lot of tricks that should help to do it, but did not write a single Unit test.  Why?  - Just afraid to start.  Only now I realized that my life could have been much easier. </li><li>  Having written the first few tests, I realized that there is a big unknown (for me) world inside.  Of the variety of assert *, I have used only a few.  The test code was often not effective and was duplicated.  After a quick look <a href="http://www.phpunit.de/manual/current/en/index.html">at the PHPUnit documentation</a> , I realized that tests can be much better than those I created. </li><li>  Unit tests do not cure all diseases.  We can test the method, all the logic inside it, we even have a convenient platform to test certain small scenarios, but do not forget about other testing methods.  From what can be adequately automated, I would choose Behavior tests as an additional test option. </li></ol><br><br><h4>  Performance testing </h4><br>  The most interesting for me was how productive the collections were.  I discarded implementations of sets and sequential lists and focused on testing cards. <br><br>  Test objects: <br><ul><li>  Normal PHP array. </li><li>  SPL implementation of an <a href="http://ua.php.net/manual/ru/class.arrayobject.php">ArrayObject</a> array. </li><li>  HashTable map implementation. </li><li>  Implementation of the HashSet card. </li><li>  Implementation of the HashMap card. </li></ul><br>  Testing criteria: <br><ul><li>  The average installation time of a key / value pair. </li><li>  Average time to sample values ‚Äã‚Äãby key. </li><li>  Average key sampling time by value. </li><li>  The amount of consumed RAM. </li></ul><br><br>  I will not describe the testing platform in detail, since I do not see much sense in this.  The fact is that these tests are not intended to determine quantitative characteristics, but rather to demonstrate the ratios.  Ratios of test results practically did not change either on different hardware or on different operating systems. <br>  The test results in this post I shot from my laptop on Windows Vista 32 bit. <br><br><h5>  Testing the installation time of a key / value pair </h5><br>  Schedule: <br><img src="https://habrastorage.org/storage2/92f/22b/693/92f22b69386667f6d03cd243ff551196.png"><br>  Test files: <br><ul><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/set/array.php">Typical PHP Array Test</a> </li><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/set/arrayobject.php">ArrayObject test</a> </li><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/set/hashtable.php">Test hashtable</a> </li><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/set/hashset.php">HashSet Test</a> </li><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/set/hashmap.php">HashMap Test</a> </li></ul><br><h5>  Testing value sampling time by key </h5><br>  Schedule: <br><img src="https://habrastorage.org/storage2/1f5/469/8dd/1f54698dd3a5d802cb6e8b6bf86b766a.png"><br>  Test files: <br><ul><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/get/array.php">Typical PHP Array Test</a> </li><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/get/arrayobject.php">ArrayObject test</a> </li><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/get/hashtable.php">Test hashtable</a> </li><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/get/hashset.php">HashSet Test</a> </li><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/get/hashmap.php">HashMap Test</a> </li></ul><br><h5>  Testing key sampling time by value </h5><br>  Schedule: <br><img src="https://habrastorage.org/storage2/964/272/272/9642722725207662529b134d1a637db7.png"><br>  Test files: <br><ul><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/keyof/array.php">Typical PHP Array Test</a> </li><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/keyof/arrayobject.php">ArrayObject test</a> </li><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/keyof/hashtable.php">Test hashtable</a> </li><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/keyof/hashset.php">HashSet Test</a> </li><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/keyof/hashmap.php">HashMap Test</a> </li></ul><br><h5>  Testing the amount of consumed RAM </h5><br>  Schedule: <br><img src="https://habrastorage.org/storage2/864/546/3af/8645463af7a7d11c4f0440ac671bced4.png"><br>  Test files: <br><ul><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/memory/array.php">Typical PHP Array Test</a> </li><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/memory/arrayobject.php">ArrayObject test</a> </li><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/memory/hashtable.php">Test hashtable</a> </li><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/memory/hashset.php">HashSet Test</a> </li><li>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/www/tests/map/memory/hashmap.php">HashMap Test</a> </li></ul><br><br><h4>  Some interesting facts </h4><br>  In the process, some interesting facts surfaced that I want to share. <br><br><h5>  Inconsistency spl_object_hash () </h5><br>  I think many people know the <a href="http://ua.php.net/manual/ru/function.spl-object-hash.php">spl_object_hash ()</a> function. <br>  It turns out she has one, in my opinion, not a very good feature - the inconstancy of hashes. <br><br>  The variability test of spl_object_hast (): <br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $object1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> stdClass(); $hash1 = spl_object_hash($object1); <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($object1); $object2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> stdClass(); $hash2 = spl_object_hash($object2); var_dump($hash1); var_dump($hash2); var_dump($hash1 === $hash2); <span class="hljs-comment"><span class="hljs-comment">//string '000000004974d03c000000005560c408' (length=32) //string '000000004974d03c000000005560c408' (length=32) //boolean true</span></span></code> </pre> <br>  What follows from this and why is this feature unpleasant? <br><ul><li>  You cannot rely on spl_object_hash () as a unique object identifier, even within a process. </li><li>  You cannot serialize any data structures that store spl_object_hash () hashes without updating the hashes when deserializing. </li></ul><br>  For me and my work, this behavior was not appropriate, since I relied on this function as the source of fast hashing of objects. <br><br><h5>  Internal hashing of array keys </h5><br>  In the comments to my previous post, the user <a href="http://habrahabr.ru/users/athari/" class="user_link">Athari</a> left a valuable comment, part of which I quote: <br><br><blockquote>  Why calculate md5 for strings?  Pohapeshnye arrays - and so hashtables, no need to calculate hashes at two levels.  Only memory and computational resources are wasted. </blockquote><br><br>  This is really a big deal of sense, but still I decided to check it out. <br>  Results: <br><ul><li>  If the string key is small, say 100 characters, then calculating its md5 hash really only consumes resources. </li><li>  If the string key is long enough, say 20k characters, then the size of the RAM consumed by the array grows ~ 70% compared to its md5 hashed analog.  At the same time, the installation and access time remains commensurate, but, of course, in favor of a ‚Äúclean‚Äù key. </li></ul><br><br><h5>  Hash arrays </h5><br>  The same user, <a href="http://habrahabr.ru/users/athari/" class="user_link">Athari,</a> left another <a href="http://habrahabr.ru/users/athari/" class="user_link">good</a> comment on the previous post: <br><blockquote>  The serialize call is fun.  I understand that ‚Äúit is necessary‚Äù to support all types, but not at the same price. </blockquote><br>  To recreate the context, let me remind you that it was a question of supporting the array as the data type of the collection keys.  To do this, it was serialized to cast to a string, and after hashing this string using md5 (). <br><br>  Really "expensive" price.  In the current implementation, I generally refused to support arrays as card keys. <br><br>  The reasons why I refused to support arrays: <br><ul><li>  "Expensive" in performance. </li><li>  Few claimed. </li><li>  Not safe. </li></ul><br><br>  I especially want to stop at the item ‚ÄúUnsafe.‚Äù The point is the lack of feedback between the data and the hash (no matter how ‚Äúexpensive‚Äù we got it).  If the client code saves the reference to the array that we have hashed and changes it, the hash will become obsolete.  Get information that this is the same array of opportunities will not be.  The same applies to other scalar data types. <br><br>  Is there a way out?  The only thing that comes to mind is to use an array through a wrapper object (ArrayObject, etc ...).  In this case, you can at least get a "non-permanent" spl_object_hash (). <br><br><h4>  Conclusion </h4><br>  Perhaps the most important question that needs to be answered is: ‚ÄúAre you ready to pay such a performance price for this decision?‚Äù.  I'm sure no one is ready.  And me as well.  When I created a graph of performance test results, I was surprised.  I expected much smaller ratios in comparison with standard implementations, although I was well aware that this solution was clearly losing in this aspect.  At first I even tried to find a solution to the problems, but, alas, nothing happened.  The main problem is that even a method call is an ‚Äúexpensive‚Äù operation in this case.  As for the amount of consumed RAM, I still do not understand what so many resources are spent on.  The only useful innovation is the two-way hashing of the card, which makes it possible to choose from it by value within O (1). <br><br>  In general, I believe that this project has failed, and the reason for this is the performance aspect. <br><br><h5>  Development </h5><br>  Based on my analytics, a similar solution will appear over time.  The best place for him is <a href="http://ua.php.net/manual/ru/book.spl.php">the SPL package</a> .  Maybe it will not be SPL, but some other PECL module that will eventually go into the standard PHP build.  In any case, something satisfactory or good will come out only with competent implementation in C. By the way, if someone is interested in this project and wants to help implement it as a PECL module, I will be glad to cooperate. <br><br><h5>  What to do next? </h5><br>  Perhaps just be content with what we have at the moment and wait.  Even now everything is pretty good. <br><br>  Personally, I decided to create more lightweight implementations that will just help a little in everyday life and will not be anything more than standard PHP arrays.  Already there are some sketches: <br><br>  Class diagram: <br>  <a href="">MixedArray &amp; ObjectArray UML Diagram</a> <br><br>  Source codes: <br>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/library/Rmk/Util/MixedArray.php">MixedArray</a> <br>  <a href="https://github.com/rmk135/Rmk-Framework/blob/master/library/Rmk/Util/ObjectArray.php">ObjectArray</a> <br><br>  If it is interesting to someone, write, I will tell about the idea in more detail. <br><br><h4>  Source codes </h4><br>  <a href="https://github.com/rmk135/Rmk-Framework">https://github.com/rmk135/Rmk-Framework</a> <br><br><h4>  Acknowledgments </h4><br>  I thank everyone for the constructive comments on the previous post.  They were very helpful.  I will be glad to hear your opinion again. <br><br>  Thank you for reading to the end and sorry for the abundance of graphics, I tried to place it only where necessary. </div><p>Source: <a href="https://habr.com/ru/post/145575/">https://habr.com/ru/post/145575/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145567/index.html">Search social networks based on the behavior of ants</a></li>
<li><a href="../145568/index.html">New design website anyway.com</a></li>
<li><a href="../145570/index.html">The development of e-justice in the arbitration system</a></li>
<li><a href="../145573/index.html">Perl MySQL process monitoring script</a></li>
<li><a href="../145574/index.html">Convenient work with LocalStorage. Well, with SessionStorage at the same time</a></li>
<li><a href="../145576/index.html">Computex 2012 - the fourth day. Informal</a></li>
<li><a href="../145578/index.html">A simple phpMyAdmin replacement for geeks</a></li>
<li><a href="../145579/index.html">Interesting facts about domains from DataGenetics</a></li>
<li><a href="../145580/index.html">The FBI Dossier on Richard Feynman</a></li>
<li><a href="../145581/index.html">Stuxnet, Flame and Duqu used GPL code</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>