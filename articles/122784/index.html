<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Oracle. Row level security</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction to the problem 
 Currently, in any organization there is a delineation of access to information based on certain knowledge of the user. S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Oracle. Row level security</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction to the problem </h4><br>  Currently, in any organization there is a delineation of access to information based on certain knowledge of the user.  Such knowledge can be the role of the user in the organization, his position or the structural unit in which the user works.  Many people know that the problem of restricting access can be solved using the simplest mechanisms based on usernames, tables, views and triggers. <br><a name="habracut"></a><br>  Consider an example: <br>  Provide the manager with information about the organization‚Äôs clients.  At the same time, the manager can only see the clients of his structural unit, but not the entire company: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> clients ( clientid <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, clientname varchar2(<span class="hljs-number"><span class="hljs-number">30</span></span>), clientphone varchar2(<span class="hljs-number"><span class="hljs-number">7</span></span>), clientoffice <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> );</code> </pre> <br><br>  The solution "in the forehead" is to create a separate presentation for each department of the company.  For example: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> clients_10 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> clientid, clientname, clientphone <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> clients <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> clientoffice = <span class="hljs-number"><span class="hljs-number">10</span></span>;</code> </pre> <br><br>  So we will have to keep the number of views equal <br>  <b>&lt;number of filtered tables&gt; * &lt;number of structure divisions&gt;</b> , <br>  as well as each user "send" to the desired data.  Stupid and tedious occupation. <br>  Let's try to improve the previous example: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> v_clients <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> clientid, clientname, clietnphone <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> office <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> clientoffice = (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> useroffice <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> username = <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>);</code> </pre> <br><br>  The solution is undoubtedly more interesting, but what to do when one user needs to ‚Äúsee‚Äù the clients of several departments?  Also, a situation often arises when one user is only allowed to request data from one table, he can edit the other, but not delete, and the third view and delete.  To fence a myriad of representations, triggers and nastoechny tables becomes very uncomfortable ... <br><br><h4>  RLS technology </h4><br>  The RLS ( <b>row-level security</b> or <b>row level security</b> ) technology provides the ability to create security policies that restrict users' access to information in the database.  As mentioned above, security policies allow you to either ‚Äúclose‚Äù information in whole or in part, or to allow only certain operations on it.  The technology was first introduced in Oracle 8i, but in later versions, its capabilities were greatly enhanced. <br>  When a database object is associated with a security policy, access control is performed through logic included in a special PL / SQL function.  Agree that it is much easier to support several software functions than dozens of views, separated by the N-th number of schemes. <br>  When a user directly or indirectly accesses the database object (table, view), the server dynamically modifies the SQL statement, adding to it the WHERE predicate, which is returned by the security function. <br><br><h4>  Safety feature </h4><br>  So, now it's time to consider an example of the simplest security function.  As already noted, the function task is the formation of a predicate that will be automatically added to the user's query. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> policy_func (p_schema varchar2, p_object varchar2) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> varchar2 <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = <span class="hljs-string"><span class="hljs-string">'MGR_10_20_30 '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'clientoffice in (10, 20, 30)'</span></span>; elseif return 'clientoffice = (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> useroffice <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> username = <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>)<span class="hljs-string"><span class="hljs-string">'; end if; end;</span></span></code> </pre> <br><br>  The above function will add the WHERE clientoffice = office_no predicate to the user's SQL query, where office_no is the number of the unit in which the user works.  For the user with the login MGR_10_20_30, the WHERE clientoffice in predicate will be added (10, 20, 30).  Thus, this user will have access to customer information of the three divisions. <br><br><h4>  DBMS_RLS Package Procedures </h4><br><h5>  Add_policy </h5><br>  Well, by now we have done all the necessary preparatory work, and all we have to do is add the security policy to our database.  The security policy is registered with the add_policy DBMS_RLS package procedure: <br><br><pre> <code class="sql hljs">DBMS_RLS.ADD_POLICY ( object_schema IN VARCHAR2 NULL, object_name IN VARCHAR2, policy_name IN VARCHAR2, function_schema IN VARCHAR2 NULL, policy_function IN VARCHAR2, statement_types IN VARCHAR2 NULL, update_check IN BOOLEAN FALSE, enable IN BOOLEAN TRUE, static_policy IN BOOLEAN FALSE, policy_type IN BINARY_INTEGER NULL, long_predicate IN BOOLEAN FALSE, sec_relevant_cols IN VARCHAR2 NULL, sec_relevant_cols_opt IN BINARY_INTEGER NULL );</code> </pre> <br><br>  Add a security policy for the clients table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Begin</span></span> DBMS_RLS.ADD_POLICY ( object_schema =&gt; <span class="hljs-string"><span class="hljs-string">'myuser'</span></span>, object_name =&gt; <span class="hljs-string"><span class="hljs-string">'clients'</span></span>, policy_name =&gt; <span class="hljs-string"><span class="hljs-string">'clients_policy'</span></span>, function_schema =&gt; <span class="hljs-string"><span class="hljs-string">'myuser'</span></span>, policy_function =&gt; <span class="hljs-string"><span class="hljs-string">'policy_func'</span></span>, statement_types =&gt; <span class="hljs-string"><span class="hljs-string">'select, insert, update, delete'</span></span>, update_check =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">End</span></span>;</code> </pre> <br><br>  Now briefly about the procedure parameters we used: <br>  <i>object_schema and object_name</i> are the table, view or synonym for which the policy is added, and the database schema in which the object is located. <br>  <i>policy_name</i> is the name of the security policy to be added.  The name must be unique for each table or view separately. <br>  <i>function_schema and policy_function</i> is the name of the security function that generates the predicate, and the database schema in which the function is located. <br>  <i>statement_types</i> - statements to which the security policy applies. <br>  <i>update_check</i> - the option prevents the INSERT or UPDATE operation if the INSERT or UPDATE violates the search conditions defined in the predicate. <br>  Now we can see the security policy in action: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> username, useroffice <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span>;</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/096/b2e/cb2/096b2ecb28fdabb10105add42097ff44.jpg" alt="image"><br><br><br>  For user MGR_10: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual;</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/fdb/f3a/401/fdbf3a401ed25becf15210e7a395e861.jpg" alt="image"><br><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> clients;</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/9d4/962/6e3/9d49626e3ba9754b396af9a0b511a354.jpg" alt="image"><br><br><br>  For user MGR_20: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual;</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/855/566/b87/855566b87cb7bc4f9a0033fffa5cf2be.jpg" alt="image"><br><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> clients;</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/13a/e0d/61a/13ae0d61a214c6cedf3f04097729ad65.jpg" alt="image"><br><br><br>  For user MGR_10_20_30: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual;</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/597/a29/cef/597a29cef7b34267dd11c47aaffa09ee.jpg" alt="image"><br><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> clients;</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/95b/5e9/b9c/95b5e9b9cd7bd235797b316988e41380.jpg" alt="image"><br><br><br>  Information about views in the database is stored in views user_policies, all_policies, dba_policies.  Perform a query from a user with DBA rights: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dba_policies;</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/d63/a0b/573/d63a0b57362fc1df0e3e2d362bf6c921.jpg" alt="image"><br><br><br><h5>  Drop_policy </h5><br>  Accordingly, since there is a procedure for creating a security policy, there is also a procedure for deleting it: <br><pre> <code class="sql hljs">DBMS_RLS.DROP_POLICY ( object_schema IN VARCHAR2 NULL, object_name IN VARCHAR2, policy_name IN VARCHAR2 );</code> </pre> <br><br>  Let's try to delete our security policy: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Begin</span></span> DBMS_RLS.DROP_POLICY ( object_schema =&gt; <span class="hljs-string"><span class="hljs-string">'myuser'</span></span>, object_name =&gt; <span class="hljs-string"><span class="hljs-string">'clients'</span></span>, policy_name =&gt; <span class="hljs-string"><span class="hljs-string">'clients_policy'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">End</span></span>;</code> </pre> <br><br>  Now let's check the presence of policies in the database by a user with DBA rights: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dba_policies;</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/b12/319/c59/b12319c590798f4d939acedcad2bb56b.jpg" alt="image"><br><br><br><h5>  Enable_policy </h5><br>  In addition to the operations of adding / deleting security policies, it is possible to temporarily suspend the existing policies.  To do this, use the procedure enable_policy, which puts the policy in an inactive state (enable =&gt; false) or resumes the action of the policy (enable =&gt; true): <br><br><pre> <code class="sql hljs">DBMS_RLS.ENABLE_POLICY ( object_schema IN VARCHAR2 NULL, object_name IN VARCHAR2, policy_name IN VARCHAR2, enable IN BOOLEAN TRUE) );</code> </pre> <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dba_policies;</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/b22/696/1ff/b226961ff19bd28c614e3f4a14f9be6e.jpg" alt="image"><br><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Begin</span></span> DBMS_RLS.ENABLE_POLICY ( object_schema =&gt; <span class="hljs-string"><span class="hljs-string">'myuser'</span></span>, object_name =&gt; <span class="hljs-string"><span class="hljs-string">'clients'</span></span>, policy_name =&gt; <span class="hljs-string"><span class="hljs-string">'clients_policy'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">false</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">End</span></span>;</code> </pre> <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dba_policies;</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/c2a/997/788/c2a997788e9bffed9204aed6c80c33be.jpg" alt="image"><br><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Begin</span></span> DBMS_RLS.ENABLE_POLICY ( object_schema =&gt; <span class="hljs-string"><span class="hljs-string">'myuser'</span></span>, object_name =&gt; <span class="hljs-string"><span class="hljs-string">'clients'</span></span>, policy_name =&gt; <span class="hljs-string"><span class="hljs-string">'clients_policy'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">End</span></span>;</code> </pre> <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dba_policies;</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/da4/203/f36/da4203f36ab70e029bb22ca515eb1322.jpg" alt="image"><br><br>  The most attentive, I think, noticed the enable parameter of the add_policy procedure of the dbms_rls package.  This parameter indicates whether the policy will be active or inactive immediately after creation.  The default is true. <br><br><h5>  Refresh_policy </h5><br>  The procedure updates the RLS policy predicate.  If a security policy is defined with a type other than DYNAMIC, the policy predicate may not be updated for some time, because  it is cached in memory.  Therefore, if there is a need to update the policy immediately, then you need to execute the REFRESH_POLICY procedure, which will re-execute the policy function and update the predicate in the cache. <br><br><pre> <code class="sql hljs">DBMS_RLS.REFRESH_POLICY ( object_schema IN VARCHAR2 NULL, object_name IN VARCHAR2 NULL, policy_name IN VARCHAR2 NULL );</code> </pre> <br><br><h4>  Conclusion </h4><br>  This article discusses the simplest example, as they say, "on the fingers."  In the next article, we will look at security using contexts and policy groups. <br><br>  Be secure!  Commit! </div><p>Source: <a href="https://habr.com/ru/post/122784/">https://habr.com/ru/post/122784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../122773/index.html">Xperia Arc banner on Habr√©</a></li>
<li><a href="../122777/index.html">Manage to return - Amazon Kindle 3 Wifi</a></li>
<li><a href="../122778/index.html">Overview of one docking station</a></li>
<li><a href="../122780/index.html">Kinect for Windows SDK, learning resources and usage examples</a></li>
<li><a href="../122783/index.html">Implementing HTTP server push using Server-Sent Events</a></li>
<li><a href="../122788/index.html">Haskell Quest Tutorial - View of the canyon</a></li>
<li><a href="../122789/index.html">Network Tablet Scanner</a></li>
<li><a href="../122790/index.html">Methods of ineffective promotion of Facebook applications</a></li>
<li><a href="../122792/index.html">In the USA, an anti-piracy agreement may be concluded between the RIAA, the MRAA and the country's largest providers.</a></li>
<li><a href="../122793/index.html">On the ISS will install HD cameras for live broadcast</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>