<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Zabbix, we monitor MongoDB</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good time of day! 
 ... the customer requested MongoDB monitoring. Having rummaged through the Internet, I came across an article about the MongoDB (M...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Zabbix, we monitor MongoDB</h1><div class="post__text post__text-html js-mediator-article">  Good time of day! <br>  ... the customer requested <b>MongoDB</b> monitoring.  Having rummaged through the Internet, I came across an article about the <a href="http://habrahabr.ru/post/129381/">MongoDB (MMS)</a> online monitoring system, but this option does not quite fit because: firstly, these statistics should not go further than their servers, secondly, the company raised an excellent in my opinion <a href="http://www.zabbix.com/">Zabbix</a> monitoring system .  On the website of MobgoDB in the monitoring and diagnostics section there was a mention for the ready-made Zabbix plugin from <a href="http://code.google.com/p/mikoomi/wiki/03">Mikoomi "MongoDB Plugin"</a> . <a name="habracut"></a>  It was decided to use it.  Judging by the comments, he earned it from one person and there really were some difficulties in the process.  About the mistakes that I saw wrote to the developer, but he did not respond to one letter. <br><br>  The following inaccuracies were noticed: <br><br>  <u>- incorrect calculation of the number of databases (error in php file)</u> <br>  <u>- in the description of the template, the parameters for retrieving the statistics of the log files were, but in reality they are not (an error in the template)</u> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs vbscript">Journaling: Commits <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> last <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Minute</span></span> Journaling: Commits <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Writelocks <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> last <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Minute</span></span> Journaling: Datafile Write <span class="hljs-built_in"><span class="hljs-built_in">Time</span></span> (ms) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> last <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Minute</span></span> Journaling: Datafile Writes (MB) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> last <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Minute</span></span> Journaling: Early Commits <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> last <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Minute</span></span> Journaling: Journal Write <span class="hljs-built_in"><span class="hljs-built_in">Time</span></span> (ms) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> last <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Minute</span></span> Journaling: Journal Writes (MB) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> last <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Minute</span></span> Journaling: <span class="hljs-built_in"><span class="hljs-built_in">Log</span></span> Buffer Prep <span class="hljs-built_in"><span class="hljs-built_in">Time</span></span> (ms) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> last <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Minute</span></span></code> </pre> <br>  <u>- triggers did not work (also an error in the template)</u> <br><pre> <code class="hljs pgsql">One <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more databases have been created One <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more databases have been destroyed One <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more <span class="hljs-keyword"><span class="hljs-keyword">replication</span></span> members need attention One <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more members have been removed <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the ReplicaSet One <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more members have been added <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the ReplicaSet One <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> shard chunks have been created One <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more shards have been added <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">cluster</span></span> One <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more shards have been removed <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">cluster</span></span> One <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> sharded collections have been created One <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more collections have been dropped One <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more collections have been added One <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more indexes have been dropped One <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more indexes have been added</code> </pre> <br>  Everything is fixed, working and tested. <br><br>  So, what we have: <br>  <b>Debian squeeze</b> <br>  <b>Zabbix 1.8.10</b> <br>  <b>Mongodb-10gen</b> <br>  I will not consider the installation of the OS (operating system), the CM (monitoring system) and the DBMS (database management system) MongoDB as it is beyond the scope of this article.  Documentation on the installation and configuration is more than enough. <br><br>  So, go ahead. <br>  The entire installation takes place only on servers with Zabbix SM.  On the MongoDB server, you only need to open port 27017. <br>  For the operation of the plugin, install <i>zabbix-agen</i> t, which includes the <i>zabbix sender</i> we <i>need</i> . <br><pre> <code class="hljs sql">sudo apt-get <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> zabbix-<span class="hljs-keyword"><span class="hljs-keyword">agent</span></span></code> </pre> <br><br>  Create a directory for <i>ExternalScripts</i> - placing external scripts: <br><br><pre> <code class="hljs dos">sudo <span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> -p /etc/zabbix/externalscripts/</code> </pre> <br><br>  We show Zabbiks where his external scripts live, for this we look for where we have the section <i>‚ÄúExternalScripts‚Äù</i> and fix it to the following view (we rule one line): <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sudo</span></span> nano /etc/zabbix/zabbix_server.conf</code> </pre> <br><pre> <code class="hljs pgsql">### <span class="hljs-keyword"><span class="hljs-keyword">Option</span></span>: ExternalScripts # <span class="hljs-keyword"><span class="hljs-keyword">Location</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> scripts # Mandatory: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>: ExternalScripts=/etc/zabbix/externalscripts</code> </pre> <br><br>  The MongoDB plugin itself works with the MongoDB PHP driver that you need to install.  The following packages will be needed for this: <br><br><pre> <code class="hljs swift">sudo apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install php5-dev php-pear gcc make git</code> </pre> <br><br>  Now directly installing the MongoDB PHP driver itself: <br><br><pre> <code class="hljs sql">sudo pecl <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> mongo</code> </pre> <br><br>  After successful installation, you must enable it.  In <i>php.ini</i> we look for the section " <i>Dynamic Extensions"</i> and add one line there. <br><pre> <code class="hljs swift">sudo <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> /etc/ -name <span class="hljs-string"><span class="hljs-string">"php.ini"</span></span></code> </pre> <br><pre> <code class="hljs">/etc/php5/apache2/php.ini</code> </pre> <br><pre> <code class="hljs">/etc/php5/cli/php.ini</code> </pre> <br><br>  In our cases we add to both found files: <br><pre> <code class="hljs swift">;;;;;;;;;;;;;;;;;;;;;; ; <span class="hljs-type"><span class="hljs-type">Dynamic</span></span> <span class="hljs-type"><span class="hljs-type">Extensions</span></span> ; ;;;;;;;;;;;;;;;;;;;;;; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class">=</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mongo</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">so</span></span></span></span></code> </pre> <br><br>  After editing, so that the changes would take effect restarting the web server: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sudo</span></span> apache2ctl -k graceful</code> </pre> <br><br>  <a href="http://php.net/manual/en/mongo.tutorial.php">We test the driver</a> , for this we will create a file with such contents <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">nano</span></span> ~/test.php</code> </pre> <br><br><pre> <code class="hljs haskell">&lt;?php // connect $m = new <span class="hljs-type"><span class="hljs-type">Mongo</span></span>(); // select a database $db = $m-&gt;comedy; // select a collection (analogous to a relational database's table) $collection = $db-&gt;cartoons; // add a record $obj = array( <span class="hljs-string"><span class="hljs-string">"title"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Calvin and Hobbes"</span></span>, <span class="hljs-string"><span class="hljs-string">"author"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Bill Watterson"</span></span> ); $collection-&gt;insert($obj); // add another record, with a different <span class="hljs-string"><span class="hljs-string">"shape"</span></span> $obj = array( <span class="hljs-string"><span class="hljs-string">"title"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"XKCD"</span></span>, <span class="hljs-string"><span class="hljs-string">"online"</span></span> =&gt; true ); $collection-&gt;insert($obj); // find everything <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the collection $cursor = $collection-&gt;find(); // iterate through the results foreach ($cursor <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $obj) { echo $obj[<span class="hljs-string"><span class="hljs-string">"title"</span></span>] . <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; } ?&gt;</code> </pre> <br>  run the test script <br><pre> <code class="hljs cmake">/usr/bin/php5 <span class="hljs-keyword"><span class="hljs-keyword">test</span></span>.php</code> </pre> <br><br>  If everything works, the result should be: <br><pre> <code class="hljs pgsql">Calvin <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> Hobbes XKCD</code> </pre> <br><h5>  The note: </h5>  if the database is not on localhost, then in the test script the connection string will be: <br>  It was <br><pre> <code class="hljs php">$m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mongo();</code> </pre> <br>  has become <br><pre> <code class="hljs php">$m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mongo( <span class="hljs-string"><span class="hljs-string">"example.com:27017"</span></span> );</code> </pre> <br><br>  We download the plugin itself ( <i>shell</i> and <i>php</i> scripts) and copy the files to the desired folder. <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sudo</span></span> cd <span class="hljs-regexp"><span class="hljs-regexp">~ &amp;&amp;</span></span> git clone git://gist.github.com/2634051.git gist-<span class="hljs-number"><span class="hljs-number">2634051</span></span> &amp;&amp; cp ~/gist-<span class="hljs-number"><span class="hljs-number">2634051</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">mikoomi-mongodb-plugin.*</span></span> /etc/zabbix/externalscripts/</code> </pre><br>  Making both executable <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sudo</span></span> chmod <span class="hljs-number"><span class="hljs-number">755</span></span> /etc/zabbix/externalscripts/<span class="hljs-regexp"><span class="hljs-regexp">mikoomi-mongodb-plugin.*</span></span></code> </pre> <br><br>  we set the owner <br><pre> <code class="hljs perl">sudo <span class="hljs-keyword"><span class="hljs-keyword">chown</span></span> -R zabbix:zabbix /etc/zabbix/externalscripts/</code> </pre> <br><br>  restarting zabbix server <br><pre> <code class="hljs pgsql">sudo /etc/init.d/zabbix-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span></code> </pre> <br><br>  Download the template for Zabbix from <a href="https://gist.github.com/2634062">Miookomi</a> .  And already from the web interface of the CM we import the template <br><ul><li>  Settings-Templates </li><li>  Click the ‚ÄúImport Template‚Äù button in the upper right corner. </li><li>  Find previously downloaded template. </li><li>  Load the template. </li></ul><br>  We connect MongoDB server to CM <br><ul><li>  * Setup - Network nodes </li><li>  * Click on the button in the upper right corner ‚ÄúCreate a host‚Äù </li><li>  * Fill in the required parameters </li><li>  * Click the ‚ÄúAdd‚Äù button and specify ‚ÄúTemplate_MongoDB‚Äù </li></ul><br>  In the macros section, add three macros (if the connection to the database without authorization) <br><pre> <code class="hljs perl">{$MONGODB_HOSTNAME} =   IP    {$MONGODB_PORT} = ,   <span class="hljs-number"><span class="hljs-number">27017</span></span> {$MONGODB_ZABBIX_NAME} =    ()</code> </pre> <br><br>  If the connection is authorized then plus two more macros <br><pre> <code class="hljs perl">{$MONGODB_USER} =   {$MONGODB_PASS} = </code> </pre> <br><br>  And in the end, do not forget to ‚ÄúSave‚Äù. <br>  It should look something like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/688/d15/721/688d157213322bca873c37a1349400e4.jpg" alt="image"><br><br>  Checking the work of the plugin <br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/zabbix/externalscripts/</code> </pre> <br><pre> <code class="hljs">./mikoomi-mongodb-plugin.sh [-D -h 127.0.0.1 -p 27017 -z MongoDB_ZabbixN ]</code> </pre> <br><br>  if everything is OK, the log file should be <br><pre> <code class="hljs pgsql">tail -f /tmp/mikoomi-mongodb-plugin.php_MongoDB_ZabbixN.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span></code> </pre> <br><br><pre> <code class="hljs pgsql"> "response":"success", "info":"Processed 66 Failed 5 Total 71 Seconds spent 0.000747"}] <span class="hljs-keyword"><span class="hljs-keyword">Info</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>: "Processed 66 Failed 5 Total 71 Seconds spent 0.000747" sent: <span class="hljs-number"><span class="hljs-number">71</span></span>; skipped: <span class="hljs-number"><span class="hljs-number">2</span></span>; total: <span class="hljs-number"><span class="hljs-number">73</span></span></code> </pre> <br><br>  Delete the log file and the file with the data not created by the user zabbix <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">rm</span></span> -rf /tmp/mikoomi-mongodb-plugin.php_MongoDB_ZabbixN.*</code> </pre> <br><br>  We are waiting for a minute and the logs will appear again, if the above is there, then it all worked.  Go to the ‚ÄúMonitoring‚Äù web interface - ‚ÄúLatest data‚Äù and admire the result :) <br>  The default pattern is with: <br>  13 groups (which includes 77 data elements) <br>  14 triggers <br>  4 groups of graphs <br><br><h5>  Examples of graphs </h5><br>  "Counting operations in the last minute" <br><img src="https://habrastorage.org/getpro/habr/post_images/3dc/c18/8d9/3dcc188d932c9058cd55edb87a973de7.jpg" alt="image"><br><br>  "Using the Journal" <br><img src="https://habrastorage.org/getpro/habr/post_images/b26/949/342/b2694934233c4a7f39ee2a6dbf5b219b.jpg" alt="image"></div><p>Source: <a href="https://habr.com/ru/post/143498/">https://habr.com/ru/post/143498/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143490/index.html">Benefits of Common Lisp</a></li>
<li><a href="../143492/index.html">Electronic library for PocketBook: automatic processing</a></li>
<li><a href="../143494/index.html">Features of the culture of teaching in universities on computer specialties</a></li>
<li><a href="../143496/index.html">Oh this web</a></li>
<li><a href="../143497/index.html">Implementing an Identity Map Template in the Yii Framework</a></li>
<li><a href="../143499/index.html">Practice of working with time in different time zones in unix-like systems</a></li>
<li><a href="../143500/index.html">Twitter stood up for its user before the court of the state of New York</a></li>
<li><a href="../143501/index.html">The site of the Kremlin has undergone a DDoS attack</a></li>
<li><a href="../143502/index.html">Export exams from Visual CertExam to Anki</a></li>
<li><a href="../143503/index.html">How to learn to read someone else's code</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>