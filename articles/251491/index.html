<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MS Dynamics CRM and PostSharp</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings, Dear Habrochityateli 

 In this article I want to talk about the results of my research on the applicability of PostSharp to MS Dynamics CR...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MS Dynamics CRM and PostSharp</h1><div class="post__text post__text-html js-mediator-article">  Greetings, Dear Habrochityateli <br><br>  In this article I want to talk about the results of my research on the applicability of PostSharp to MS Dynamics CRM in terms of logging. <br><a name="habracut"></a><br><br>  So, there is: <br><ul><li>  MS Dynamics CRM 2013 </li><li>  Nlog </li><li>  Postsharp </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What I want: I want logging (trite, but logging). <br><br>  I decided that I will try to apply logging to the plugin for MS Dynamics CRM. <br><br>  From logging I want the following: <br><br><ul><li>  Log the method that was called </li><li>  Log input arguments </li><li>  Log when method was completed </li><li>  Log exceptions </li></ul><br><br>  First, create a project for our plugin: <br><br><img src="https://habrastorage.org/files/44e/bb0/bcd/44ebb0bcd77f4643a913ff5056f0faf3"><br><br>  Load the nuget package with NLog: <br><br><img src="https://habrastorage.org/files/175/252/8a4/1752528a4294403ea5d9f255d36bf1eb"><br><br>  Do not forget to pick up the PostSharp itself: <br><br><img src="https://habrastorage.org/files/625/382/1f3/6253821f3a014b2ab595fc0bde6a9fbd"><br><br>  We also hook up the CRM SDK assemblies. <br><br>  Now the most interesting: where to store the settings of the logger? <br>  Frankly, for me it is still an open question. <br>  Only three options come to mind: <br><ul><li>  Hardcode is a bad choice. </li><li>  In the case of plugins - in the configuration of the plugin </li><li>  Create an entity to store settings </li></ul><br><br>  Each of these options has its drawbacks and positives. <br>  In my opinion, the most successful option is the entity with the settings of the logger, but in this case you have to pull out this entity every time, since caching the settings is not a very good solution (the plug-in can run for a long time, and I can change the settings at this point). <br><br>  But in this case, the task I have more familiarization, so we went further. <br><br>  Let's write this simple plugin: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">LoggedPlugin</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TestPlugin</span></span>:<span class="hljs-title"><span class="hljs-title">IPlugin</span></span> { [Logging] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SimpleMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> input</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Hello CRM"</span></span>; } [Logging] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MethodThrowsException</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotImplementedException(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceProvider serviceProvider</span></span></span><span class="hljs-function">)</span></span> { SimpleMethod(<span class="hljs-string"><span class="hljs-string">"Hi CRM"</span></span>); MethodThrowsException(); } } }</code> </pre> <br><br>  Aspect we will have the following code: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">LoggedPlugin.Logging</span></span> { [Serializable] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LoggingAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">OnMethodBoundaryAspect</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnException</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MethodExecutionArgs args</span></span></span><span class="hljs-function">)</span></span> { Logger.Instance.Error(<span class="hljs-string"><span class="hljs-string">" "</span></span>,args.Exception); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnEntry</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MethodExecutionArgs args</span></span></span><span class="hljs-function">)</span></span> { Logger.Instance.Trace(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"{0}.{1}:  ."</span></span>, args.Method.DeclaringType.FullName, args.Method.Name)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> argumentInfos = args.Method.GetParameters(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> index = <span class="hljs-number"><span class="hljs-number">0</span></span>; index &lt; args.Arguments.Count; index++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> argument = args.Arguments[index]; Logger.Instance.Trace(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"{0}:{1}"</span></span>, argumentInfos[index].Name, argument)); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnSuccess</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MethodExecutionArgs args</span></span></span><span class="hljs-function">)</span></span> { Logger.Instance.Trace(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"{0}.{1}:  ."</span></span>, args.Method.DeclaringType.FullName, args.Method.Name)); } } }</code> </pre><br><br>  Well, actually logger: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">LoggedPlugin.Logging</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Logger</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> Logger _instance; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> _syncRoot = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> NLog.Logger _logger; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Logger</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoggingConfiguration(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fileTarget = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileTarget(); config.AddTarget(<span class="hljs-string"><span class="hljs-string">"file"</span></span>,fileTarget); fileTarget.FileName = <span class="hljs-string"><span class="hljs-string">@"C:\logs\log.txt"</span></span>; fileTarget.Layout = <span class="hljs-string"><span class="hljs-string">@"${date:format=[HH\:mm\:ss.fff]} ${level:uppercase=true} t[${threadid}] ${message} ${exception:format=ToString}"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> loggingRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoggingRule(<span class="hljs-string"><span class="hljs-string">"*"</span></span>, LogLevel.Trace, fileTarget); config.LoggingRules.Add(loggingRule); LogManager.Configuration = config; _logger = LogManager.GetLogger(<span class="hljs-string"><span class="hljs-string">"FileLogger"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Logger Instance { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_instance == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (_syncRoot) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_instance == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) _instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Logger(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _instance; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Trace</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> message</span></span></span><span class="hljs-function">)</span></span> { _logger.Trace(message); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Error</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> message, Exception e</span></span></span><span class="hljs-function">)</span></span> { _logger.Error(message,e); } } }</code> </pre><br><br>  Logger is with a hardcode, but more is not needed - for academic purposes! <br><br>  Next we sign the build, build it, and merge the three builds using the ILMerge utility: <br>  LoggedPlugin.dll, NLog.dll and PostSharp.dll. <br><br>  Then we publish the result in CRM: <br><br><img src="//habrastorage.org/files/0b3/912/3eb/0b39123ebc4041f296d4c52e5cfd44de"><br><br>  I hung this plugin to create a lead. <br><br>  After creating the lead, I saw this result: <br><br>  ================================================= ======= <br>  [22: 46: 51.816] TRACE t [31] LoggedPlugin.TestPlugin.SimpleMethod: Started method. <br>  [22: 46: 51.863] TRACE t [31] input: Hi CRM <br>  [22: 46: 51.863] TRACE t [31] LoggedPlugin.TestPlugin.SimpleMethod: Completed method. <br>  [22: 46: 51.863] TRACE t [31] LoggedPlugin.TestPlugin.MethodThrowsException: The method started. <br>  [22: 46: 51.863] ERROR t [31] The System.NotImplementedException has crashed: The method or operation is not implemented. <br>  at LoggedPlugin.TestPlugin.MethodThrowsException () <br><br>  ================================================= ======= </div><p>Source: <a href="https://habr.com/ru/post/251491/">https://habr.com/ru/post/251491/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../251473/index.html">The site from scratch on a full stack of BEM technologies. Yandex Methodology</a></li>
<li><a href="../251477/index.html">Honest private properties in the prototype</a></li>
<li><a href="../251479/index.html">We write a bot for MMORPG with assembler and draenei. Part 4</a></li>
<li><a href="../251487/index.html">Draining data 180 thousand users FL.ru</a></li>
<li><a href="../251489/index.html">A router from the operator? - No thanks!</a></li>
<li><a href="../251493/index.html">DevCon Digest # 3. Immerse yourself in Visual Studio</a></li>
<li><a href="../251497/index.html">OpenCage is the most powerful geocoding tool.</a></li>
<li><a href="../251501/index.html">What exactly happens when a user types google.com in the address bar? Part 2</a></li>
<li><a href="../251503/index.html">What should be able to cool call center for IT-parts and what options are there at all</a></li>
<li><a href="../251507/index.html">Apache Spark: What's under the hood?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>