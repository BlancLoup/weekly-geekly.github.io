<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automation of obtaining information from Incorporation using Freepascal</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my work (legal) I am ready to automate everything that only gives in to this. But while the robots pumped by neural networks from the utopia of Ger...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automation of obtaining information from Incorporation using Freepascal</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/xp/n2/lb/xpn2lbf3yf9_ryhoprada0ehl5i.jpeg"><br><br><p>  In my work (legal) I am ready to automate everything that only gives in to this.  But while the <a href="https://www.rbc.ru/business/23/07/2017/5974b7a69a79477896b6708d">robots</a> pumped by neural networks <a href="https://www.rbc.ru/business/23/07/2017/5974b7a69a79477896b6708d">from the utopia of German Gref</a> did not appear and did not take away all the work of ordinary lawyers, the routine will remain our main companion for a long time.  Automation of this routine is what I occasionally do for the past years, be it numerous excel tables with a bunch of formulas allowing you to quickly print out hundreds of similar documents sent to the word, well, or automatically generated reports.  But there are some things that you cannot do with simple formulas and substitutions.  This is where programming comes in, which I have been fond of since childhood, and it just so happened that it started with delphi.  Now it is easier for me than in C # or python, to master which I started recently, to quickly do some kind of project in Lazarus using freepascal.  And yes, I quite seriously believe that the possibilities of this environment are more than enough.  Therefore, automate the Unified Statements, you guessed it, with the help of pascal. <br><a name="habracut"></a><br></p><p>  A lawyer of a consulting firm doing business with dozens of legal entities, a corporate lawyer on free bread, and any other lawyer confronted with ensuring the activities of organizations - they all know how easily dozens and hundreds of different names, TIN numbers, OGRN numbers are mixed together it is easy to forget who is where the manager is, and when the term of extension of office is suitable for him, whether there are any problems with shares in an LLC and with payment of its share capital.  Well, the need to quickly make a document that includes many constantly changing details, leads to periodic errors and typos.  To automate just such processes, I needed a solution with a database that allows you to create documents using templates, keep various registries, track changes and not skip any deadlines.  Well, one of the necessary simplifications of life is the quick receipt of a fresh file with information from the Unified State Register of Legal <a href="http://egrul.nalog.ru/">Services</a> from <a href="http://egrul.nalog.ru/">the Federal Tax Service website</a> .  Of course, no one says that using the site directly is long and difficult, but agree that clicking on one button without leaving the application is much more fun, and you can do it without interrupting a phone call (or a cup of coffee). <br><br></p><p>  So, first we decide what we want to receive.  The site allows you to search in the <abbr title="In this case, the official nature of the source of information is important, since extracts received from the Unified State Register of Unified State Register of Legal Entities received absolutely free of charge are accepted even by the courts as evidence.">official database of</abbr> unregistered for the unique number of OGRN or TIN and give one relevant result in the form of a brief reference about the person and a link to download a pdf-file with an extract.  Also, the search may be fuzzy by name with an additional filter by region (subject of the Russian Federation).  And in this case, the site produces a table with all suitable persons and with the same data set, including links to pdf. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </p><p>  This means that in a specific case, the finished function must return the pdf as a file (or better, a stream), having a face at the entrance to the OGRN or TIN.  But for universalization and the possibility of further expansion, we will not neglect all the capabilities of the site and will also do a fuzzy search function with the return of the data set found by the name of the organization with or without a filter by region.  Let's try to describe the interfaces of these functions: <br><br></p><pre><code class="delphi hljs">IEGRULstreamer = <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetExtractByOGRN</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OGRN: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; ; isLegal: boolean; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">var</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Extract: TStream)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetLegalsListByName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Name</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Region: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; ; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">var</span></span></span></span><span class="hljs-function"><span class="hljs-params"> LegalsList: TCollection)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  In order to understand what the mysterious parameter X and the collection of which will be returned by the second function, let us figure out exactly how the site executes the request. <br><br><p>  1. The site contains a form with input fields for search identifiers and captcha checks: <br><br><img src="https://habrastorage.org/webt/ua/vn/gf/uavngfdababogkh8q7yexvfx-nw.jpeg"><br><br></p><p>  2. A captcha is formed using a previously generated hidden field called captchaToken, which uses a java script to generate a captcha image on a given token. <br><br></p><p>  3. After clicking on the "find" button, a POST request is sent to the server, in the processing results of which JSON is returned with an array of objects.  This JSON response uses a different java script that fills the table, which we see in the search results. <br><br>  So, the first snag is a captcha test.  In order not to burden our methods dealing with interaction with the site, with unnecessary functionality, we will put the captcha processing actions into a separate function.  And in X, we will have a parameter for the callback method, which has a stream with an image of a captcha at the input, and a line with a recognized captcha at the output: <br><br></p><pre> <code class="delphi hljs">TCapthcaRecognizeFunc = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Captha: TStream)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetExtractByOGRN</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OGRN: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; CaptchaFunc: TCapthcaRecognizeFunc; isLegal: boolean; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">var</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Extract: TStream)</span></span></span><span class="hljs-function">;</span></span></code> </pre><br>  The captcha processing function can do it in any way: let the user enter it manually, send the image to the paid automatic recognition server, and self-recognize using the unique know-how of the algorithm.  For simplicity of the picture, and since in my case the flow of captcha on an industrial scale is not expected, we choose the first option: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RecognizeFunc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(captcha: TStream)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> CaptchaImg.Picture.LoadFromStream(captcha); Result := InputBox(<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'    '</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><p>  The second question is the contents of the server JSON response.  Here is an example of what comes in it: <br><br></p><div class="spoiler">  <b class="spoiler_title">The answer is in the formatted JSON format</b> <div class="spoiler_text"><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: {<span class="hljs-attr"><span class="hljs-attr">"captcha"</span></span>:<span class="hljs-string"><span class="hljs-string">"382915"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ogrninnfl"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fam"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"nam"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"otch"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"region"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ogrninnul"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"namul"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"regionul"</span></span>:<span class="hljs-string"><span class="hljs-string">"73"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"kind"</span></span>:<span class="hljs-string"><span class="hljs-string">"ul"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ul"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"searchByOgrn"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"nameEq"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"searchByOgrnip"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>}, <span class="hljs-attr"><span class="hljs-attr">"rows"</span></span>: [ {<span class="hljs-attr"><span class="hljs-attr">"T"</span></span>:<span class="hljs-string"><span class="hljs-string">"ED346E713D4A1AC851F9B589C6D2AECD1D809D5B6B5D1B98E697B6E0FD873E137B828AC59A60D159BB2894F11D00AB5639E2ACEE4E2ED5B7AC7A6EFE28FD987BC288B93C4D3D3EC1008DA0F128BA7E5E"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"INN"</span></span>:<span class="hljs-string"><span class="hljs-string">"7325001144"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"NAME"</span></span>:<span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"OGRN"</span></span>:<span class="hljs-string"><span class="hljs-string">"1027301175110"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ADRESTEXT"</span></span>:<span class="hljs-string"><span class="hljs-string">"432017,  ,  ,  , 1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"CNT"</span></span>:<span class="hljs-string"><span class="hljs-string">"4"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"DTREG"</span></span>:<span class="hljs-string"><span class="hljs-string">"03.12.2002"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"KPP"</span></span>:<span class="hljs-string"><span class="hljs-string">"732501001"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">"T"</span></span>:<span class="hljs-string"><span class="hljs-string">"2ECB284C7682E5F1D1129AA3074FABB4B74BB28EA426AF79C091CEDEA0D9E391CA26FF405A7C9742466E19C78FBE5A59BDCBCD21268FFD8AFD3A8509CCA84541"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"INN"</span></span>:<span class="hljs-string"><span class="hljs-string">"7303007375"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"NAME"</span></span>:<span class="hljs-string"><span class="hljs-string">"      \"   \""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"OGRN"</span></span>:<span class="hljs-string"><span class="hljs-string">"1027301173283"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ADRESTEXT"</span></span>:<span class="hljs-string"><span class="hljs-string">"432063,  ,  ,   , 7"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"CNT"</span></span>:<span class="hljs-string"><span class="hljs-string">"4"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"DTREG"</span></span>:<span class="hljs-string"><span class="hljs-string">"27.11.2002"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"KPP"</span></span>:<span class="hljs-string"><span class="hljs-string">"732501001"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"DTEND"</span></span>:<span class="hljs-string"><span class="hljs-string">"01.09.2010"</span></span>}, ] }</code> </pre><br></div></div><br>  As you can see, the result returns a ‚Äúquery‚Äù object, which contains the original search parameters (so that they remain in the form fields for reuse) and an array of ‚Äúrows‚Äù objects.  The link to the pdf file is combined by a java script with the expression: <pre>  "https://egrul.nalog.ru/download/" </pre>  and the key value "T" of the object.  The lifetime of the generated pdf file is a few minutes. <br><br><p>  The two main difficulties I encountered when creating an http request were the correct header values ‚Äã‚Äãand combining the string with the POST request parameters.  But a simple analysis of the page using the built-in browser tools (in chrome, are called by pressing F12) gave everything you need.  Here is an example of headers with which the server gives the correct answer instead of 400 Bad request: <br><br></p><pre> <code class="hljs pgsql">POST / HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> Host: egrul.nalog.ru <span class="hljs-keyword"><span class="hljs-keyword">Connection</span></span>: keep-alive Accept: application/<span class="hljs-type"><span class="hljs-type">json</span></span>, <span class="hljs-type"><span class="hljs-type">text</span></span>/javascript, *<span class="hljs-comment"><span class="hljs-comment">/*; q=0.01 Origin: https://egrul.nalog.ru X-Requested-With: XMLHttpRequest User-Agent: Chrome/67.0.3396.99 Safari/537.36 Content-Type: application/x-www-form-urlencoded Referer: https://egrul.nalog.ru/ Accept-Encoding: gzip, deflate, br Accept-Language: ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7</span></span></code> </pre><br>  But the line with the parameters: <br><br><pre> <code class="hljs perl">kind=ul&amp;srchUl=name&amp;ogrninnul=<span class="hljs-number"><span class="hljs-number">7716819629</span></span>&amp;namul=%D0%BF%D1%80%D0%B0%D0%B2% D<span class="hljs-number"><span class="hljs-number">0</span></span>%B8%D1%82%D0%B5%D0%BB%D1%8C%D1%81%D1%82%D0%B2%D0%BE&amp;regionul=<span class="hljs-number"><span class="hljs-number">73</span></span> &amp;srchFl=ogrn&amp;ogrninnfl=&amp;fam=&amp;nam=&amp;otch=&amp;region=&amp;captcha=<span class="hljs-number"><span class="hljs-number">449023</span></span>&amp;captchaToken=DAEDA <span class="hljs-number"><span class="hljs-number">7504</span></span>CACAC82CF09E08319B68DF5F9BD62B2F44D33DD679DDE55B5CF58B17FEC84E78CEEB9639 <span class="hljs-number"><span class="hljs-number">84</span></span>D2B2BD8C3AA15</code> </pre> <br><p>  Armed with these initial data, we proceed to the implementation of the task.  I will use the following libraries for freepascal: <br><br></p><p>  <a href="http://wiki.freepascal.org/Synapse">Synapse</a> is a very convenient library with the most simplified (for use) function of sending http requests to the server, it also works with SSL, but this requires the <abbr title="I have enough libeay32.dll and ssleay32.dll libraries on the win32 platform">presence of openSSL libraries</abbr> in the project folder or system, as well as the connection of an additional module.  It is enough to connect the following library modules to our project: httpsend, ssl_openssl, synautil. <br></p><p>  <a href="http://wiki.freepascal.org/fcl-json">The built-in fcl-json library</a> is the necessary modules: fpjson and fpjsonrtti - for maximum convenience in processing returned objects in JSON. <br><br></p><p>  <a href="http://wiki.freepascal.org/fcl-xml">Separate modules of the built-in library fcl-xml</a> - for some functions, it will be necessary to work with parts of HTML as DOM objects, therefore we will connect the modules SAX_HTML, DOM_HTML, DOM. <br><br>  We describe the types and classes of objects that eventually turned out: <br><br></p><pre> <code class="delphi hljs"><span class="hljs-title"><span class="hljs-title">TEGRULItem</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TCollectionItem) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> fT, fINN, fNAME, fOGRN, fADRESTEXT, fCNT, fDTREG, fDTEND, fKPP: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPdfLink</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">published</span></span> <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> T: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> fT <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> fT; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> INN: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> fINN <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> fINN; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> fNAME <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> fNAME; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> OGRN: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> fOGRN <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> fOGRN; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> ADRESTEXT: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> fADRESTEXT <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> fADRESTEXT; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> CNT: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> fCNT <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> fCNT; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> DTREG: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> fDTREG <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> fDTREG; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> DTEND: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> fDTEND <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> fDTEND; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> KPP: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> fKPP <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> fKPP; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><p>  In this class, we will pack objects that will be returned in the rows array in the server's JSON response.  We will read them with the help of JSONToCollection, but for this we need to make each object a member of the collection and declare all related properties as published.  RTTI functions in freepascal (as in delphi) get access to the names of properties only when they are declared in such a scope.  And the JSONToCollection function from the fpjsonrtti module is just an RTTI function that matches the names of keys from a JSON object with the names of the class properties. <br></p><blockquote>  Also in the class interface there is a function GetPdfLink, which returns a link for downloading a pdf-file with information from the Unified Statements Incorporation using the concatenation of the web-address and the value of the property "T". </blockquote><br><br><p>  The main class implementing the interface declared above will be as follows: <br><br></p><pre> <code class="delphi hljs"> <span class="hljs-title"><span class="hljs-title">TEGRULStreamer</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TInterfacedObject, IEGRULStreamer) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> HTTPSender: THTTPSend; Doc: THTMLDocument; Inputs: TDOMNodeList; captchaURL, captchaToken, captcha, Params: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCaptchaToken</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetLegalsList</span></span></span><span class="hljs-function">:</span></span> TCollection; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PrepareHeaders</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessCaptcha</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CaptchaFunc: TCapthcaRecognizeFunc)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetExtractByOGRN</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OGRN: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; CaptchaFunc: TCapthcaRecognizeFunc; isLegal: boolean; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">var</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Extract: TStream)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetLegalsListByName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Name</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Region: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; CaptchaFunc: TCapthcaRecognizeFunc; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">var</span></span></span></span><span class="hljs-function"><span class="hljs-params"> LegalsList: TCollection)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">destructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Destroy</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><br><p>  As you can see, in addition to the implementation of the two main functions of the interface, <a href="https://ru.wikipedia.org/wiki/%25D0%2598%25D0%25BD%25D0%25BA%25D0%25B0%25D0%25BF%25D1%2581%25D1%2583%25D0%25BB%25D1%258F%25D1%2586%25D0%25B8%25D1%258F_(%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)">all other properties and methods of the class will be hidden</a> and are needed only for the internal implementation.  In general, they could be included into the main methods, but we have already passed lessons about duplicate code, visibility and <a href="https://refactoring.guru/ru">refactoring</a> in general. <br></p><p>  Taking into account the encapsulation of preparatory actions, the main methods in general will differ only in the formation of the parameter string of the HTTP request and the returned data type. <br><br></p><div class="spoiler">  <b class="spoiler_title">method code TEGRULStreamer.GetExtractByOGRN</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TEGRULStreamer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetExtractByOGRN</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OGRN: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; CaptchaFunc: TCapthcaRecognizeFunc; isLegal: boolean; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">var</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Extract: TStream)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ProcessCaptcha(CaptchaFunc); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isLegal <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> Params := <span class="hljs-string"><span class="hljs-string">'kind=ul'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> Params := <span class="hljs-string"><span class="hljs-string">'kind=fl'</span></span>; Params += <span class="hljs-string"><span class="hljs-string">'&amp;srchUl=ogrn&amp;srchFl=ogrn&amp;ogrninnul='</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isLegal <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> Params += OGRN; Params += <span class="hljs-string"><span class="hljs-string">'&amp;namul=&amp;regionul=&amp;ogrninnfl='</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isLegal <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> Params += OGRN; Params += <span class="hljs-string"><span class="hljs-string">'&amp;fam=&amp;nam=&amp;otch=&amp;region&amp;captcha='</span></span> + captcha + <span class="hljs-string"><span class="hljs-string">'&amp;captchaToken='</span></span> + captchaToken; WriteStrToStream(HTTPSender.Document, Params); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> HTTPSender.HTTPMethod(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, EGRUL_URL) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> Exception.Create(<span class="hljs-string"><span class="hljs-string">'   '</span></span>); HTTPSender.Headers.Clear; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> HTTPSender.HTTPMethod(<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, TEGRULItem(GetLegalsList.Items[<span class="hljs-number"><span class="hljs-number">0</span></span>]).GetPdfLink) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> Extract := HTTPSender.Document <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> Extract := <span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>;</code> </pre><br></div></div><br><p>  Here, as we see, the method also uses the logical parameter isLegal, and if it is not set to true, the search goes on the basis of entrepreneurs instead of legal entities. <br><br></p><div class="spoiler">  <b class="spoiler_title">method code TEGRULStreamer.GetLegalsListByName</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TEGRULStreamer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetLegalsListByName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Name</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Region: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; CaptchaFunc: TCapthcaRecognizeFunc; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">var</span></span></span></span><span class="hljs-function"><span class="hljs-params"> LegalsList: TCollection)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ProcessCaptcha(CaptchaFunc); Params := <span class="hljs-string"><span class="hljs-string">'kind=ul&amp;srchUl=name&amp;srchFl=ogrn&amp;ogrninnul=&amp;namul='</span></span>; Params += <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> + <span class="hljs-string"><span class="hljs-string">'&amp;regionul='</span></span> + Region + <span class="hljs-string"><span class="hljs-string">'&amp;ogrninnfl=&amp;fam=&amp;nam=&amp;otch=&amp;region'</span></span>; Params += <span class="hljs-string"><span class="hljs-string">'&amp;captcha='</span></span> + captcha + <span class="hljs-string"><span class="hljs-string">'&amp;captchaToken='</span></span> + captchaToken; WriteStrToStream(HTTPSender.Document, Params); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> HTTPSender.HTTPMethod(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, EGRUL_URL) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> Exception.Create(<span class="hljs-string"><span class="hljs-string">'   '</span></span>); LegalsList := GetLegalsList; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br></div></div><br><p>  The role of service methods is as follows: <br><br>  <b>ProcessCaptcha</b> - loads the initial html page of the FTS service, searches for the captcha token, downloads the image generated by this token, and redirects it to the callback-method for captcha recognition.  At the end, the method also sets the correct headers for the subsequent POST request. <br><br>  <b>GetCaptchaToken</b> - loads all input fields from the page into the DOM structure, searches for a hidden field with the identifier capthcaToken and returns its value. <br><br>  <b>GetLegalsList</b> - using the RTTI function, the JSONToCollection returns a collection of objects of type TEGRULItem, described above. <br><br>  <s><b><abbr title="function moved to the implementation of the class TEGRULItem">GetPdfLink</abbr></b></s> - to search by OGRN or TIN, in the right case, only one result will always be returned, therefore in GetExtractByOGRN the function is called for the first element in the collection. <br><br></p><p>  Since this is my first experience with the network in freepascal, I am very glad that everything turned out exactly as I intended.  In working form, the library was made in less than one day (thanks to the members of freepascal.ru who told about synapse). <br><br></p><p>  <a href="https://bitbucket.org/java73/egrulstreamer/src/master/">The archive with the test of the resulting library and its code is here</a> . <br><br></p><p>  As always I will be glad to any constructive criticism of both the project and the implementation.  I understand that there are many factors that can still be taken into account: a delay in responding to an http request, as a result of which the application will hang;  Incorrect http responses and other situations. <br><br></p><p>  In the future, I plan to connect the online library with the FIAS address database and to implement the ability to generate completed application templates, which are generally edited in the <a href="https://www.gnivc.ru/software/fnspo/software_ul_fl/registration/">Program of preparation of documents for state registration</a> . <br><br><img src="https://habrastorage.org/webt/pu/a0/qm/pua0qmeomu83os45u7on8e9picm.gif" align="right"><br>  <i>PS Sorry, Sberbank, for the role of a guinea pig and downloaded statement hundreds of times.</i>  <i>All in the name of science of course.</i> </p></div><p>Source: <a href="https://habr.com/ru/post/419063/">https://habr.com/ru/post/419063/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../419049/index.html">GeekBrains launches free online educational marathon "Find Yourself in Digital"</a></li>
<li><a href="../419051/index.html">How "Flant" helps newcomers</a></li>
<li><a href="../419053/index.html">Testing Adaptec RAID Caching Technology</a></li>
<li><a href="../419055/index.html">In string theory, you can do with a much smaller number of universes.</a></li>
<li><a href="../419061/index.html">What's new in GoLand 2018.2</a></li>
<li><a href="../419065/index.html">Intel Virtual World. Practice</a></li>
<li><a href="../419069/index.html">Global warming will make our world more green, but you shouldn't rejoice</a></li>
<li><a href="../419071/index.html">In the wake of tp-link hacking</a></li>
<li><a href="../419075/index.html">On the formation of sequences in the Collatz hypothesis (3n + 1)</a></li>
<li><a href="../419077/index.html">Localization of applications in iOS. Part 1. What do we have?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>