<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Accidentally deleted production base? What's next?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, an article came to RSS that I wanted to issue a translation - So you just deleted your production database - what now? . However, comments o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Accidentally deleted production base? What's next?</h1><div class="post__text post__text-html js-mediator-article">  Recently, an article came to RSS that I wanted to issue a translation - <a href="http://ostatic.com/blog/so-you-just-deleted-your-production-database-what-now">So you just deleted your production database - what now?</a>  .  However, comments on the article, and the last paragraph made us think - and how easy is it to restore the deleted database. <br>  And in order not to produce unverified information - the translation turned into a study of the method of recovering information from a randomly deleted MySQL database. <br><a name="habracut"></a><br><br><h4>  Test environment </h4><br>  I got a virtual player with CentOS 5.6 x86_64 and mysql 5.0.77 <br>  A test database was created with a pair of tables, both MyISAM and InnoDB.  And a couple of stored procedures to check their recovery: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">DROP</font> <font color="#0000ff">DATABASE</font> prod; <br> <font color="#0000ff">CREATE</font> <font color="#0000ff">DATABASE</font> prod; <br> <font color="#0000ff">USE</font> prod; <br> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> table1 ( <br> id <font color="#0000ff">INTEGER</font> , <br> v <font color="#0000ff">VARCHAR</font> (50), <br> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> (id) <br> ) ENGINE=MyISAM; <br> <br> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> table2 ( <br> id <font color="#0000ff">INTEGER</font> , <br> v <font color="#0000ff">VARCHAR</font> (50), <br> <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> (id) <br> ) ENGINE=InnoDB; <br> <br> DELIMITER // <br> <br> <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> dorepeat(p1 <font color="#0000ff">INT</font> ) <br> <font color="#0000ff">BEGIN</font> <br> <font color="#0000ff">SET</font> @x = 0; <br> REPEAT <font color="#0000ff">SET</font> @x = @x + 1; UNTIL @x &gt; p1 <font color="#0000ff">END</font> REPEAT; <br> <font color="#0000ff">END</font> <br> // <br> <br> DELIMITER ; <br> <br> <font color="#0000ff">CREATE</font> <font color="#0000ff">FUNCTION</font> hello (s <font color="#0000ff">CHAR</font> (20)) <br> <font color="#0000ff">RETURNS</font> <font color="#0000ff">CHAR</font> (50) <font color="#0000ff">DETERMINISTIC</font> <br> <font color="#0000ff">RETURN</font> CONCAT( <font color="#A31515">'Hello, '</font> ,s, <font color="#A31515">'!'</font> );</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Well, create there some data: <br><pre> <code class="bash hljs">( <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(seq 1 100); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"insert into table1 values (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">, '`md5sum &lt;&lt;&lt; "</span></span><span class="hljs-variable"><span class="hljs-variable">$i</span></span><span class="hljs-string"><span class="hljs-string">"`');"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>; ) &gt;&gt; test.sql ( <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(seq 1 100); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"insert into table2 values (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">, '`md5sum &lt;&lt;&lt; "</span></span><span class="hljs-variable"><span class="hljs-variable">$i</span></span><span class="hljs-string"><span class="hljs-string">"`');"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>; ) &gt;&gt; test.sql</code> </pre><br>  The test script is selected very simple in order to consider the principal possibility of recovery. <br><br><h4>  Fur animal crept unnoticed </h4><br>  After we have all created and verified that the database responds and contains some information: <br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> table1; +<span class="hljs-comment"><span class="hljs-comment">----------+ | count(*) | +----------+ | 100 | +----------+ 1 row in set (0.00 sec) mysql&gt; select count(*) from table2; +----------+ | count(*) | +----------+ | 100 | +----------+ 1 row in set (0.00 sec) mysql&gt; select hello('world'); +----------------+ | hello('world') | +----------------+ | Hello, world! | +----------------+ 1 row in set (0.00 sec)</span></span></code> </pre><br>  We emulate a <s>cleaning lady with a mop</s> removing the base with the help of a simple command: <br><pre> # rm -rf / var / lib / mysql / * 
</pre><br>  According to the tips from the article, we do not reboot the server and do not stop mysql in order to keep the file descriptors open (otherwise the information will be lost and recovery may require direct intervention in the file system). <br>  You can immediately check that the one described by the link above does not work at least because the socket has been deleted: <br><pre> # mysql
 ERROR 2002 (HY000): Can't connect to MySQL server through socket '/var/lib/mysql/mysql.sock' (2)
</pre><br>  If you try to connect via tcp, then we will still be disappointed, since mysql already knows nothing about the databases and mysqldump will give an empty output: <br><pre> # mysql --protocol tcp &lt;&lt;&lt; show databases; "
 Database
 information_schema
 # mysqldump - protocol tcp -A
 - MySQL dump 10.11
 -
 - Host: localhost Database: 
 - ------------------------------------------------ ------
 - Server version 5.0.77<font></font>
<font></font>
 / *! 40101 SET @OLD_CHARACTER_SET_CLIENT = @@ CHARACTER_SET_CLIENT * /;
 / *! 40101 SET @OLD_CHARACTER_SET_RESULTS = @@ CHARACTER_SET_RESULTS * /;
 / *! 40101 SET @OLD_COLLATION_CONNECTION = @@ COLLATION_CONNECTION * /;
 / *! 40101 SET NAMES utf8 * /;
 / *! 40103 SET @OLD_TIME_ZONE = @@ TIME_ZONE * /;
 / *! 40103 SET TIME_ZONE = '+ 00:00' * /;
 / *! 40014 SET @OLD_UNIQUE_CHECKS = @@ UNIQUE_CHECKS, UNIQUE_CHECKS = 0 * /;
 / *! 40014 SET @OLD_FOREIGN_KEY_CHECKS = @@ FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS = 0 * /;
 / *! 40101 SET @OLD_SQL_MODE = @@ SQL_MODE, SQL_MODE = 'NO_AUTO_VALUE_ON_ZERO' * /;
 / *! 40111 SET @OLD_SQL_NOTES = @@ SQL_NOTES, SQL_NOTES = 0 * /;
 / *! 40103 SET TIME_ZONE = @ OLD_TIME_ZONE * /;<font></font>
<font></font>
 / *! 40101 SET SQL_MODE = @ OLD_SQL_MODE * /;
 / *! 40014 SET FOREIGN_KEY_CHECKS = @ OLD_FOREIGN_KEY_CHECKS * /;
 / *! 40014 SET UNIQUE_CHECKS = @ OLD_UNIQUE_CHECKS * /;
 / *! 40101 SET CHARACTER_SET_CLIENT = @ OLD_CHARACTER_SET_CLIENT * /;
 / *! 40101 SET CHARACTER_SET_RESULTS = @ OLD_CHARACTER_SET_RESULTS * /;
 / *! 40101 SET COLLATION_CONNECTION = @ OLD_COLLATION_CONNECTION * /;
 / *! 40111 SET SQL_NOTES = @ OLD_SQL_NOTES * /;
</pre><br>  Sometimes also mysqldump can swear that it cannot write to the table mysql.time_zone_name: <br><pre>  mysqldump: Could not execute '/ *! 40103 SET TIME_ZONE =' + 00:00 '* /': Table 'mysql.time_zone_name' doesn't exist (1146) </pre>  , but this is solved by the --skip-tz-utc parameter 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Data recovery </h4><br>  So dive a bit into how MySQL stores database information.  The base in terms of MySQL is the directory inside which the table definitions, indexes and data are stored (for the case of InnoDB, only the table definition is stored in the directory, and the data is stored in a separate file).  For MySQL to see our database, it‚Äôs enough to see the directory inside / var / lib / mysql / <br>  To get the tables and data inside the database - we must restore all the files that were there. <br>  Procedures and functions are not stored in the main database, but lie in the mysql database in the proc table ‚Äî so this database will also need to be restored. <br>  The task is facilitated by the fact that the mysqld process is running and keeps open file descriptors on the deleted files, and the system will not delete the file until the handle is closed.  The / proc file system provides access to these files via links in / proc / [pid] / fd / * <br><pre> # ls -l / proc / 2544 / fd /
 total 0
 lr-x ------ 1 root 64 Jun 22 12:05 0 -&gt; / dev / null
 l-wx ------ 1 root 64 Jun 22 12:05 1 -&gt; /var/log/mysqld.log
 lrwx ------ 1 root 64 Jun 22 12:05 10 -&gt; socket: [9786]
 lrwx ------ 1 root 64 Jun 22 12:05 11 -&gt; / tmp / ibo0UVMZ (deleted)
 lrwx ------ 1 root 64 Jun 22 12:05 12 -&gt; socket: [9787]
 lrwx ------ 1 root 64 Jun 22 12:05 13 -&gt; /var/lib/mysql/mysql/host.MYI (deleted)
 ...
 lrwx ------ 1 root 64 Jun 22 12:05 28 -&gt; /var/lib/mysql/prod/table1.MYI (deleted)
 lrwx ------ 1 root 64 Jun 22 12:05 29 -&gt; /var/lib/mysql/prod/table1.MYD (deleted)
 ...
</pre><br>  We use this to find and restore database names, filter only the directories inside / var / lib / mysql / and create them in the same place: <br><pre> # ls -l / proc / 2544 / fd / |  grep / var / lib / mysql / |  cut -d '' -f11 |  cut -d / -f 5.6 |  grep / |  cut -d / -f1 |  sort -u
 mysql
 prod
 # ls -l / proc / 2544 / fd / |  grep / var / lib / mysql / |  cut -d '' -f11 |  cut -d / -f 5.6 |  grep / |  cut -d / -f1 |  sort -u |  xargs -I {} mkdir -v / var / lib / mysql / {}
 mkdir: created directory `/ var / lib / mysql / mysql '
 mkdir: created directory `/ var / lib / mysql / prod '
</pre><br>  mysql now sees databases: <br><pre> mysql&gt; show databases;
 + -------------------- +
 |  Database |
 + -------------------- +
 |  information_schema | 
 |  mysql | 
 |  prod | 
 + -------------------- +
 3 rows in set (0.00 sec)
</pre><br>  But mysqldump will still export the void.  We will try to fix it, restore the rest of the files that are still open by the process.  To do this, make links from / var / lib / mysql / to files in / proc: <br><pre> # ls -l / proc / 2544 / fd / |  grep / var / lib / mysql / |  cut -d '' -f9,11 |  awk '{cmd = "ln -s / proc / 2544 / fd /" $ 1 "" $ 2; print (cmd); system (cmd);}'
 ln -s / proc / 2544 / fd / 13 /var/lib/mysql/mysql/host.MYI
 ln -s / proc / 2544 / fd / 14 /var/lib/mysql/mysql/host.MYD
 ...
 ln -s / proc / 2544 / fd / 3 / var / lib / mysql / ibdata1
 ...
 ln -s / proc / 2544 / fd / 38 /var/lib/mysql/prod/table1.MYD
 ln -s / proc / 2544 / fd / 9 / var / lib / mysql / ib_logfile1
 ...
</pre><br>  After this operation, mysqldump still returns emptiness, and if you ask to export a specific table, it will swear that such a table does not exist: <br><pre> # mysqldump --protocol tcp --skip-tz-utc prod table2
 mysqldump: Couldn't find table: "table2"<font></font>
<font></font>
 # mysql --protocol tcp
 mysql&gt; use prod;
 Database changed<font></font>
<font></font>
 mysql&gt; show tables;
 Empty set (0.00 sec)
</pre><br>  The problem is that the table description files are not constantly opened by the process and rarely are accessed; accordingly, it was impossible to ‚Äúrestore‚Äù these files in the previous steps.  The decision on whether a particular table is available for export is made on the basis of the table description files, so automatic export failed. <br><br>  However, the absence of a description file does not prevent the direct acquisition of data from the tables: <br><pre> mysql&gt; select count (*) from table1;
 + ---------- +
 |  count (*) |
 + ---------- +
 |  100 | 
 + ---------- +
 1 row in set (0.00 sec)<font></font>
<font></font>
 mysql&gt; select * from table1 limit 0,5;
 + ---- + ------------------------------------- +
 |  id |  v |
 + ---- + ------------------------------------- +
 |  1 |  b026324c6904b2a9cb4b88d6d61c81d1 - | 
 |  2 |  26ab0db90d72e28ad0ba1e22ee510510 - | 
 |  3 |  6d7fce9fee471194aa8b5b6e47267f03 - | 
 |  4 |  48a24b70a0b376535542b996af517398 - | 
 |  5 |  1dcca23355272056f04fe8bf20edfce0 - | 
 + ---- + ------------------------------------- +
 5 rows in set (0.00 sec)<font></font>
<font></font>
 mysql&gt; select * from table2 limit 0,5;
 + ---- + ------------------------------------- +
 |  id |  v |
 + ---- + ------------------------------------- +
 |  1 |  b026324c6904b2a9cb4b88d6d61c81d1 - | 
 |  2 |  26ab0db90d72e28ad0ba1e22ee510510 - | 
 |  3 |  6d7fce9fee471194aa8b5b6e47267f03 - | 
 |  4 |  48a24b70a0b376535542b996af517398 - | 
 |  5 |  1dcca23355272056f04fe8bf20edfce0 - | 
 + ---- + ------------------------------------- +
 5 rows in set (0.00 sec)
</pre><br>  But since tables can have blobs and complex structure, this method of obtaining data is not convenient.  Also because InnoDB tables store in the base directory only the description file, which is not restored in our procedure - therefore, a selection of them is possible only if you know all the table names for the memory. <br>  The latter method can help "save" some small amount of important information in the case of trawling. <br><br><h4>  findings </h4><br>  The ability to fully restore the database described in the article was unworkable (busted!). <br>  Do not trust all the magic methods of information recovery that flash on the open spaces of the network.  Make backups, make a recovery plan and always check possible recovery scenarios before the irreparable happens. </div><p>Source: <a href="https://habr.com/ru/post/122424/">https://habr.com/ru/post/122424/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../122416/index.html">In England, arrested a 19-year-old suspect in the LulzSec case</a></li>
<li><a href="../122418/index.html">The world's largest directory of sites Open Directory Project (dmoz) moved to Creative Commons Attribution</a></li>
<li><a href="../122419/index.html">Adobe added iPhone and iPad support in Flash Builder and Flex framework</a></li>
<li><a href="../122421/index.html">Requires small beta testing from unique specialists</a></li>
<li><a href="../122423/index.html">Unknown attackers uploaded compromised Wordpress plugins to the repository</a></li>
<li><a href="../122425/index.html">Work with KVM virtual machines. Virtual Machine Resource Limiting</a></li>
<li><a href="../122426/index.html">WebMoney Escrow Secure Transaction Service</a></li>
<li><a href="../122428/index.html">Why are the processors so small?</a></li>
<li><a href="../122429/index.html">First Summer Feedback</a></li>
<li><a href="../122432/index.html">RURU: Payment system from Alfa-Bank and Beeline</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>