<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implement security in the development of a large project</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we would like to share our experience of introducing our team of pentesters into the development cycle of the large project ‚ÄúMyOffice...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implement security in the development of a large project</h1><div class="post__text post__text-html js-mediator-article"><p> <a href="https://habrahabr.ru/company/dsec/blog/334692/"><img src="https://habrastorage.org/web/4ed/dda/891/4eddda8913da4e28a3d971ab415fc837.png"><br></a> <br></p><p>  In this article, we would like to share our experience of introducing our team of pentesters into the development cycle of the large project ‚ÄúMyOffice‚Äù.  It is almost impossible to find material of a similar subject with real cases in Russian.  Anyone who is interested in fashion trends pentest, theory, practice, methods, tools and actually found vulnerabilities in the context of secure development - welcome under cat.  The article is replete with useful links to theoretical and practical materials.  But let's order. </p><a name="habracut"></a><br><p>  <strong>Disclaimer:</strong> <strong><br></strong>  <strong>The article consists of two parts.</strong>  <strong>The first part is the organizational one, which defines the problem, tells in general about the approaches to penetration tests and about our ways of solving the set tasks (certainly contains information that many people know).</strong>  <strong>The second is more technical, with a description of the tools used and the vulnerabilities found.</strong> <strong><br></strong>  <strong>If you,% username%, like technical details, you can proceed to the second part.</strong> <strong><br></strong>  <strong>And, of course, do not forget your tea with cookies.</strong> </p><br><h1>  We collect and distribute </h1><br><h2>  Some presentation of approaches to pentest </h2><br><p>  It is worth starting with a short introduction describing approaches to pentests and their features.  Based on our experience covering various companies of a diverse profile, the following division seems optimal. </p><br><h3>  Single penetration test </h3><br><p>  The classic option is when an organization (including banks and public sector companies) comes to a company that provides penetration testing services and issues scopes of addresses to pentesters.  After work, the executing team makes recommendations for fixing vulnerabilities. </p><br><p>  Types of jobs: </p><br><ul><li>  External Perimeter Security Audit </li><li>  Internal Perimeter Security Audit </li><li>  Physical security </li><li>  Mobile applications </li><li>  Code analysis </li><li>  Social engineering </li><li>  In general, everything that you can come up with (but you shouldn't get too carried away) </li></ul><br><p>  In security, as in any complex process, there is no ‚Äúsilver bullet‚Äù - no tool in itself will give full confidence in the security of the system, be it antivirus software, intrusion detection systems, etc.  The same can be said about penetration tests, in which there are no universal approaches, since each of them has its own minuses and advantages. </p><br><p>  A one-time penetration test is effective for assessing the overall state of security ‚Äî Pentesters conduct a simulation of a situation in which an attacker with limited finances and in a short time tries to penetrate the system, and how much damage it can cause to the customer‚Äôs company. </p><br><h3>  Penetration test with repeat N once a year. </h3><br><p>  The approach repeats the ‚Äúone-time pentest‚Äù or its individual parts.  In this case, the security audit is performed several times a year.  Types of work are the same as in the first approach. </p><br><p>  After the first audit with an assessment of common security problems, this approach makes it possible to keep up-to-date with the applied patches to the found vulnerabilities during past audits, problems encountered when applying patches (yes, it happens) and based on the results of the following audits. </p><br><p>  This option allows for a more thorough examination of the company's perimeter by auditors due to their increased awareness of services on the results of past penetration tests. </p><br><h3>  Bagbounty outsource </h3><br><p>  The essence of this approach is in the creation of its own bug-bout program on an open / closed basis, which is managed by an outside organization.  Such a team attracts pentesters to their work on constant conditions and makes payments for each vulnerability separately.  This is a good opportunity for additional income for researchers.  An example of using this approach is the American company SYNACK. </p><br><p>  A reasonable question arises: ‚ÄúHow does this differ from HackerOne?‚Äù The main difference is in the number of researchers and their skills.  To get into the program you need to have an interview and a test task, as when applying for a job in an off-line company.  Consequently, it turns out fewer participants, but above the general level of skills (and the absence of all the well-known characters who like to throw the reports of scanners). </p><br><p>  Types of work (within the framework of this approach): </p><br><ul><li>  External Perimeter Security Audit </li><li>  Mobile applications </li><li>  Binary research </li></ul><br><p>  The approach involves the constant study of their services by dozens of human ‚Äúscanners‚Äù, motivated by rewards for vulnerabilities.  It allows you to provide greater coverage during the work. </p><br><p>  Despite the above advantages, the approach has its drawbacks: </p><br><ul><li>  A limited range of works in comparison with the classical approach to pentest.  This deficiency is a consequence of the distant work of all researchers and the popularity of trends in security. </li><li>  The dependence of work results from payments.  A large number of researchers does not guarantee the involvement of absolutely everyone; the amount of rewards has a strong influence on the popularity of the program. </li><li>  Difficulty in budget planning is a typical problem for any bug-out program. </li></ul><br><h3>  Work on the analysis of security on an ongoing basis </h3><br><p>  This approach is considered in detail in our article.  Its essence is in the constant research of the products being developed from release to release. </p><br><p>  The list of types of work in this case is somewhat broader than the approaches described above.  It includes: </p><br><ul><li>  External Perimeter Security Audit </li><li>  Internal Perimeter Security Audit </li><li>  Mobile applications </li><li>  Desktop applications </li><li>  Hardering (secure server configuration) </li><li>  Developer Training </li></ul><br><p>  As for items such as Desktop applications and Hardering, the task is not to search for binary vulnerabilities (if we talk about desktops) and not to totally tighten the screws (in the case of Hardering).  The main thing is to look at the system from the Pentester side. </p><br><p>  The peculiarity of the approach is that it is as close as possible to the work of security guards on the ground in companies that create protection from within, namely: </p><br><ul><li>  High awareness of work (due to access to documentation and own empirical experience in the study of a particular product) and the development of internal services (the ability to influence the development process and directly observe the timing). </li><li>  Access to source codes of developed products. </li><li>  The opportunity to participate in building architecture.  This allows you to find vulnerabilities before writing code.  For example, CSRF tokens.  Sometimes it happens that people just forget about such an important and simple thing as tokens.  If this problem is revealed after the release is rolled out, fixing it can be a costly and time consuming task (although everything, of course, depends on the size of the system). </li><li>  High relevance of the investigated products.  With the release of a new release or changes to a couple of important lines of code that affect security directly, we can immediately get the changes made and begin to test them all. </li></ul><br><p>  As a result, it turns out that the works are carried out not by black, but by all of us, the beloved white box. </p><br><img src="https://habrastorage.org/web/e7e/89e/9a6/e7e89e9a6538431a99595fa659ab1367.jpg"><br><br><p>  It is important to note that this approach also helps to solve such a problem as the lack of the company's own resources (security specialists) for analyzing application security.  Many researchers prefer off-line companies to work because of the presence of permanent experience in different areas of information security, and outsourcing them can compensate for the lack of resources. </p><br><h2>  A little about SDLC and his friend SecureSDLC </h2><br><h3>  SDLC </h3><br><p>  Let's start with the definitions.  <abbr title="Software Development Lifecycle or Software Development Lifecycle">SDLC</abbr> is the development framework that defines the process organizations use to create an application from the inception of the idea to launch. </p><br><p>  At the moment there are a large number of SDLC models, the most famous of them are Waterfall, Iterative, Agile (for more information about them you can read <a href="https://habrahabr.ru/company/edison/blog/269789/">here</a> ).  All of them have their advantages and disadvantages, each of them is very variable in use;  it all depends on the size of the project, budget, amount of human resources and other features.  All of them are united by the presence of six key stages: </p><br><ul><li>  Planning is one of the main steps at which the definition of the problem being solved, the calculation of resources and costs, the search for alternative solutions, etc. </li><li>  Analysis - development of requirements, implementation of a feasibility study and others, <del>  what we don't like so much </del>  . </li><li>  Design.  At this stage, the architecture is built, components are selected, modules, interfaces, etc. </li><li>  Development and implementation is the largest and most important stage, it is here that the writing of the code, the configuration and tuning of the iron part of the project, if one exists, take place. </li><li>  Testing and integration - here we check how the results correspond to the tasks. </li><li>  System support  Monitoring the relevance of the developed system.  This includes both hardware replacement and updating of various software components. </li></ul><br><img src="https://habrastorage.org/web/00b/e25/35f/00be2535fce44ec88b38652a8d3b754e.jpg" height="500" width="500"><br><br><h3>  Securesdlc </h3><br><p>  SecureSDLC - the same SDLC, but with the prefix Secure.  Just add a prefix, and everything becomes safe (no).  The essence of all this is quite simple: as seen in the beautiful picture from the Internet, safety-related actions (risk calculations, static / dynamic code analysis, fuzzing, training, etc.) are added to each of the development stages. </p><br><p><img src="https://habrastorage.org/web/2af/ee7/a8e/2afee7a8eaa14abbb7568256f75e0743.png" alt="image"></p><br><p>  In the classical SDLC implementations, the security check was limited to the testing phase, if at all. </p><br><p>  Extended implementation aims to: </p><br><ul><li>  Permanent monitoring of existing / detected fixes. </li><li>  Reducing the cost of fixing vulnerabilities by finding them at earlier stages of development. </li><li>  Improving the quality of development through in-depth analysis of applications;  work on training in the field of security of the developers themselves. </li></ul><br><h3>  What is it all based on? </h3><br><p>  Currently there are a large number of companies practicing safe development.  For example, such large and famous, as Microsoft, Cisco, Dell.  Today, any self-respecting vendor monitors the security of their decisions (but this is not always the case).  Absolutely each manufacturer has its own approach, which is formed on the basis of the internal features of the development. </p><br><p> As a skeleton, in building their safe development, many people use common practices in the world: </p><br><ul><li>  Open Security Assurance Maturity Model ( <a href="http://www.opensamm.org/">OpenSAMM</a> ) by OWASP </li><li>  Microsoft Security Development Lifecycle (SDL).  <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/84aed186-1d75-4366-8e61-8d258746bopq.aspx">Process Guidance</a> . </li></ul><br><p>  In the next picture from the Internet, you can see the compliance of business functions and security practices. </p><br><p><img src="https://habrastorage.org/web/b1d/da5/ee6/b1dda5ee67464bd4901fffa7ed1b02aa.jpg"><br></p><br><h2>  Conditions of the problem </h2><br><p>  We are currently conducting a large project (details and features further), working in two major areas: pentest of developed products and binary research.  In this article we will focus on the Pentester part. </p><br><p>  Initially, our process of searching for vulnerabilities in this project went from one-time pentest to pentest, repeating several times a year - both the external perimeter services and the products being developed.  These approaches, in our opinion, proved to be not so effective, in contrast to projects on the analysis of security on an ongoing basis. </p><br><p>  What did not suit us in the classical approaches?  A single pentest has some drawbacks: </p><br><ul><li>  A large number of reporting on the fact of work.  If you have seen the Pentester report at least once, then you know that it is huge and takes an average of a hundred pages.  Its creation requires the involvement of human and time resources.  Instead of searching for vulnerabilities, the researcher prepares reports. </li><li>  Insufficiently coordinated interaction with developers.  The latter can begin to respond to problems found only after the end of pentest.  At the same time, they often have an understanding of the criticality of the found vulnerabilities and ways to correct them, which may differ from the Pentester one. </li><li>  Low awareness of pentesters about the internal features of the studied systems.  Since the researcher is not an employee of the company, the security of which he analyzes, he cannot know all the features of the development process, he simply does not have access to the documentation and source codes. </li><li>  Rotation of auditors.  Due to the presence of other one-time or permanent projects, a situation may arise that the project is not dealt with by the pentester who investigated it last time.  Because of this, the general awareness of services that have already been studied in the past penetration test falls. </li></ul><br><p>  Due to the low awareness of the auditors about the internal features of the products being developed and the absence of any division into components (for a pentester, the products look like a certain scopa of addresses, mobile application packages or desktop binaries), the list of products looks like a bookshelf with a large number of books on the backs Which names are absent - eyes run up from abundance of services. </p><br><img src="https://habrastorage.org/web/146/504/4a5/1465044a5e184a43bbb27a0df294ca40.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>  Because of this, the problem of allocating time appears - it is allocated to the entire project as a whole, and some component may be given less attention.  Resources are allocated inefficiently, and it is not suitable for in-depth study of products.  Therefore, it was decided to divide the products into conditional components. </p><br><h2>  We collect the list of products </h2><br><p>  In our case, we are working with the company "New Cloud Technologies" on their product "MoiOffice", which is a platform for the joint editing of documents, file storage, mail system, messenger.  For all this, there are both mobile and desktop versions. </p><br><p><img src="https://habrastorage.org/web/5a1/587/6af/5a15876aff4b4556ace78f8d005911d0.png" height="700" width="710"><br></p><br><p>  Before starting work on such an extensive product as MoiOffice, it is necessary to single out its main modules and parts (even seemingly indivisible) so as not to have the same bookshelf.  This is also necessary for a better understanding of the internal processes of applications and the distribution of team resources. </p><br><p>  We did it this way: </p><br><ul><li>  Web is a real <abbr title="Single page application">SPA</abbr> application, only js / css / html files.  Services included in this component: Mail, Calendar, Contacts, Disk, Document Editor, Administrator Control Panel, Logos (messenger). </li><li>  Mobile applications - three applications (Document Editor, Mail Client, Logos - messenger) for each of the platforms - iOS, Android, Tizen (yes, do not be surprised). </li><li>  Desktop applications (Documents, Mail, Messenger) for three platforms - Linux, OS X, Windows. </li><li>  Server API, publicly available. </li><li>  Internal services that communicate with each other (Redis, Swift and others). </li></ul><br><p>  All of this together provides a great interest for the researcher: as an opportunity to explore some previously unseen technologies, and to get more into the already studied topic. </p><br><h2>  Sprint planning </h2><br><p>  In order to seamlessly integrate into the process of developing such a product, we need to adapt to its global planning cycles, in our case release cycles.  The release of new versions of "MyOffice" occurs every three months.  Therefore, we live in sprints for just three months.  What is the sprint in our understanding? </p><br><p>  Sprint for us is a cell of time, within the framework of which we try to plan our works as much as possible.  Inside the big sprint we have a smaller unit of measure - a slot, which is equal to one week.  We take the products available to us, we look at the cycles and terms of changes in them, and in the necessary sequence we put the audits of these products in the schedule of our sprint, splitting into slots. </p><br><p>  Naturally, we understand that planning deadlines in the development, to put it mildly, is very bad, because we expect a legitimate question: ‚ÄúAnd if deadlines are coming, what are you doing?‚Äù </p><br><p><img src="https://habrastorage.org/web/be1/97c/471/be197c4715b54ce28fd0bef048f38e23.jpg" height="300" width="300"><br></p><br><p>  Here comes the old game of childhood - ‚Äútag‚Äù.  Remember, there was an empty cell, through which it was possible to move other chips, and thereby change the order, without going beyond the box?  In our case, the box is this ‚Äúsprint‚Äù. </p><br><p>  It was decided to increase the number of empty slots, since there are various ‚Äúunscheduled‚Äù works, re-surveys of third-party solutions used in the products being developed, as well as other works that may be related to the project.  Thus, we are mobile in planning, and empty slots can always be filled. </p><br><p>  An example of one of the sprints (the first number is the week number of the sprint): </p><br><ol><li>  Component Web Applications (Mail, Contacts, Calendar) </li><li>  Component Web Applications (Mail, Contacts, Calendar) </li><li>  Native mobile apps for Android, iOS, Tizen </li><li>  Native mobile apps for Android, iOS, Tizen </li><li>  Authentication server;  Web application backend </li><li>  File server backend, Web panel and admin API </li><li>  Document Editor Web Panel, Backend Editors </li><li>  Desktop client for file server </li><li>  Desktop client for mail, calendar, contacts, documents </li><li>  Messengers for Web, MacOS, Win, Linux and their API </li><li>  Misc </li><li>  Misc </li><li>  Misc </li></ol><br><p>  Misc are just those free slots, their presence is very important.  As you can see, for some, quite large parts (like the Web, where the API part is also checked), we put in more time (10 working days).  Also, Misc includes additional research and joint development of a security-oriented architecture together with the customer‚Äôs specialists. </p><br><h2>  Team of auditors </h2><br><p>  For such a project from our side, it was very important to choose a team that has expertise in all areas of interest at once (all, of course, universals, but everyone understands something more, for example, in the analysis of mobile applications).  In the end, it turned out three people working fulltime on the project and in constant contact with the customer. </p><br><p>  Based on the availability of expertise for everyone in any direction, inside the team there is sharing experience between auditors.  Even with the rotation of auditors with other teams, the experience remains inside, because, if necessary, only one person is replaced.  ‚ÄúNewbie‚Äù during the week learns the organizational peculiarities of the work and after the first sprint has expired gets a complete picture and understanding of the interaction of a large number of components with each other. </p><br><h2>  Stands </h2><br><p>  In our tests, we use a complete copy of what is delivered to customers, with all the latest updates.  Looking ahead, we say that we considered it quite important to fully deploy the entire ‚ÄúMyOffice‚Äù from scratch and understand every step, where, what and how is deployed and configured, along the way trying to compare it with the documentation.  Considering that our specialization is far from system administration, it was a difficult task for the ‚ÄúPadawan of the Young‚Äù. </p><br><h2>  Reporting </h2><br><p>  Since we are big fans of bugbounds and are not like writing reports and generating official texts, it was decided to move away from the reports inherent in the classic penetration tests, and learn from the experience of bugbaunt programs. </p><br><p>  In our approach, we use JIRA to create tickets (developers and testers use this, why not start it, too), where there are absolutely standard fields like on HackerOne: </p><br><ul><li>  Title </li><li>  Ticket type </li><li>  Vulnerability severity </li><li>  What are the components </li><li>  Vulnerability description - actions to repeat </li></ul><br><p><img src="https://habrastorage.org/web/000/6d8/ccd/0006d8ccdd314118b622b384eaf57f96.png"><br></p><br><p>  With such a report of information, absolutely anyone will understand how critical this vulnerability is, even without any qualification in security or in general in IT. </p><br><h1>  Security analysis.  Little practice </h1><br><p>  <strong>Disclaimer: we try to make articles so that everyone can take something new and interesting out of the article.</strong>  <strong>So, from the first part, the manager or team leader can probably learn the tactics of project management, while from the second part, information security researchers and developers can be useful.</strong> </p><br><p>  It looks like the introductory part is revealed.  Let's go directly to the very analysis of security (hooray, technical details). </p><br><p>  One of the interesting components of the work for an experienced pentester is the use of fashionable and modern technologies.  Let's look at them.  Before we begin, we, of course, looked at the Web, registering along the way with the names: </p><br><pre><code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">'‚Äú&gt;&lt;svg onload=alert(1)&gt;{{7*7}}</span></span></code> </pre> <br><p>  Picked files, sent mail, put mobile applications and generally looked around how everything works. <br><br>  Then we went to the development team and together we sat down over the server architecture diagram on a large sheet of A1, which hardly fits on the wall of the office.  We will not insert it here, but on the whole everything is pretty standard and cool: </p><br><ul><li>  The user has two ports (80 and 443).  Everything behind them is considered a cluster and a trusted zone. </li><li>  Cluster - it can be an unlimited number of server machines (in our installation - 2), on which a whole bunch of microservices is running (java, go, c ++ is the core part of the editor, databases, SWIFT and others). </li><li>  Some services are installed from RPM-packages, some - docker-containers (which gives additional isolation, this is especially important when working with converting documents). </li></ul><br><h2>  Web </h2><br><p>  The client part is AngularJS and a full-fledged <abbr title="Single page application">SPA</abbr> without obvious crutches from the server API (such as ‚Äúhere we‚Äôll give back the backend form!‚Äù). </p><br><p>  The server part is different, nginx is used as the front, followed by many java / golang services that process client requests. </p><br><p>  Analyzing SPA-applications is very cool and quite convenient, from the point of view of requests-responses, everything is logical and smooth.  Finding vulnerabilities in the SPA itself is, of course, a rather difficult task. </p><br><h3>  Burp suite </h3><br><p>  Yes, there is no secret, we, like many, use Burp (no Larry Lau, only a license) and its modules to search for all sorts of vulnerabilities (injections, <abbr title="Insecure Direct Object References">IDOR</abbr> , <abbr title="Server-Side Template Injection">SSTI</abbr> and others).  Without this tool in any way. </p><br><p>  Also, developers can use it to check the result after fixing a vulnerability, instead of asking us and stretching the whole process.  For this, a free version and two tabs Proxy and Repeater will suffice. </p><br><p><img src="https://habrastorage.org/web/5d8/63d/300/5d863d300557442894267bba4e396d57.png"><br></p><br><p>  We also use a bunch of custom scripts, consider one of them. </p><br><p>  As you already know, among the products we are researching is mail.  One of the most powerful attacks here can be XSS in letters.  And it is still complicated by the fact that in letters you can use HTML to create beautiful letters in corporate styles, and not just plaintext.  The developer has the task of making it possible to use HTML so that the sender cannot inject his javascript. </p><br><p>  In the security world, there is a researcher Mario Heiderich <a href="https://twitter.com/0x6D6172696F">@ 0x6D6172696F</a> (.mario), who spent a lot of time searching XSS in various large services like Google, participated in the creation of the DOMPurify library for safe unsafe html substitution in the DOM right away (more details will be discussed below).  And most importantly - he published autotests for her, which use various tricks and subtleties of browsers and HTML5.  The ideal solution for testing mail service on the possibility of implementing JS. </p><br><p>  ‚Üí <a href="https://cure53.de/purify">Link</a> to demos and tests <br>  ‚Üí <a href="https://github.com/cure53/H5SC">And don't forget about the special vectors for HTML5</a> </p><br><p>  What have we done?  We took these tests (+ added some of our secret bins) and sent them to the IMAP server with our Python script of ten lines, because usually HTML cannot be sent from the Web client, but only directly to the mail server, simultaneously opening letters in the browser.  JS is over?  We get a ticket. </p><br><p>  Surely everyone knows that it is possible to detect the opening of a letter by the user using the image (img tag) in the letter, but other tags may allow us to do this.  Here again, the <a href="https://github.com/cure53/HTTPLeaks">Cure53</a> repository will help <a href="https://github.com/cure53/HTTPLeaks">us</a> .  With it, you can find tags that merge information about users. </p><br><p>  The restriction of schemes for some tags, for example, why file: /// cannot be used for the same "img src" (for details on the <a href="https://habrahabr.ru/post/306810/">link</a> from <a href="https://habrahabr.ru/users/valdikss/" class="user_link">ValdikSS</a> ), were immediately taken into account during development. </p><br><p>  The next problem is investments.  Be sure to test attachments of different formats with XSS-load, you can take them <a href="https://github.com/cure53/H5SC/tree/master/attachments">here</a> .  By this we check how the server stores and sends the attached files in letters. </p><br><h2>  Mobile applications </h2><br><p>  All applications for each of the platforms are classic native applications. </p><br><p>  Both approaches are used to study iOS and Android: automated and manual.  For Tizen - only manual.  Pro automated - <a href="https://github.com/MobSF/Mobile-Security-Framework-MobSF">MobSF</a> is very helpful in removing ‚Äúlow-hanging fruits‚Äù. </p><br><p><img src="https://habrastorage.org/web/d40/4d5/622/d404d5622264490382bab8d4eb0578d1.png"><br></p><br><p>  It allows you to automatically collect typical problems, revise receivers, services, etc.  things in Android and even performs some sort of source code analysis (after decompiling).  It also checks for flags (Stack smashing protection, PIE ...) when compiling. </p><br><p>  Manual analysis - Android (+ root), iOS + jailbreak (at the moment we are using the latest available jail for iOS 9.3.3). </p><br><p>  But with Tizen is not so simple.  He himself is very strange and unaccustomed.  The system is one big browser with support for HTML5, has been in development for a long time and is also of interest to security researchers as something new and unexplored. </p><br><p>  For starters, the question is - how much did you keep phones with TizenOS?  Here are the same articles and security tools for this platform.  We went through the developer way - we downloaded the Tizen SDK, connected to the phone and debugged the application.  In this mode, you can browse the file system, get a debug console, and do other things that let you find problems in security.  Unfortunately, the functionality is rather limited, and there is no direct console access to the OS. </p><br><p>  The tool is on the official <a href="https://developer.tizen.org/">Tizen</a> website.  You can use the emulator if you want to get acquainted with this operating system. </p><br><p><img src="https://habrastorage.org/web/113/c8b/d69/113c8bd693d04871986b0c05041c8be8.jpg"><br></p><br><p>  The Tizen platform itself currently has a large number of security flaws.  We can recall the recent news about <a href="https://xakep.ru/2017/04/05/tizen/">forty grain makers</a> in the platform and this <a href="https://www.viva64.com/ru/b/0519/">publication</a> .  Also about some vulnerabilities in SmartTV, where TizenOS was affected, told <a href="https://habrahabr.ru/users/belove/" class="user_link">BeLove</a> - the <a href="http://2015.zeronights.org/assets/files/07-Belov.pdf">presentation</a> . </p><br><h2>  Desktop </h2><br><p>  There will be a separate article about binary fuzzing about desktop applications ‚ÄúMoyOfis‚Äù.  Within the framework of these works (specifically in pentest), such areas as interaction with the file system (temporary folders, rights to them, etc.), DLL hijacking, work with the network (data transfer via secure channels - TLS), storage tokens and the like. </p><br><p>  Many desktop applications are based on Electron, on which GitHub, Slack, Discord, and many other solutions are created.  Electron itself is an open project and is a webview, that is, a small browser that cannot be visually distinguished from a native application. </p><br><h2>  Research third-party products.  DOMPurify and where does Safari </h2><br><p>  Often, when studying the safety of a product, there is a problem related to the fact that it is not always transparent and understandable where the vulnerability was found: in the customer‚Äôs custom written code or in a third-party product, libraries, and frameworks that are used in development.  We also had such a case. </p><br><p>  In the study of one of the components, we found a rather critical client-side vulnerability - JS code injection, well, or just XSS.  Initially, it was not clear why this happened, because this component used the very JS DOMPurify library to protect against XSS. </p><br><p>  DOMPurify is a DOM-only, ultra-fast, uber-tolerant XSS disinfecting solution for HTML, MathML and SVG (a little bit of the description from Gita).  MathML is an XML-based markup language for representing mathematical symbols and formulas.  All this, of course, works in the context of HTML5 chips.  That is, this product contains all the newest and most modern. </p><br><p>  It is written in JavaScript and works in all popular browsers: </p><br><ul><li>  Safari </li><li>  Opera (15+) </li><li>  Internet Explorer (10+) </li><li>  Firefox </li><li>  Chrome </li><li>  Everything Blink or WebKit uses </li></ul><br><p>  The tool is developed by the Cure53 company, in particular, Mario Heiderich <a href="https://twitter.com/0x6D6172696F">@ 0x6D6172696F</a> (.mario), and such famous guys as <a href="https://twitter.com/filedescriptor">@filedescriptor</a> , <a href="https://twitter.com/shafigullin">@shafigullin</a> and others <a href="https://twitter.com/shafigullin">donate to</a> it.  It turns out that such a team of the coolest web security researchers is working on open source software to protect against client-side vulnerabilities. </p><br><p>  A reference to <a href="https://github.com/cure53/DOMPurify">Git</a> . </p><br><p>  Having a little thought about it, we came to the conclusion that the vulnerability is not really in the developed application, but in the connected JS-library. </p><br><p>  Next, we checked the vulnerability on the latest version of DOMPurify and were very surprised that such a simple payload worked without any tricks, but only under Safari. </p><br><pre> <code class="javascript hljs">Payload: <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">svg</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onload</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">alert(document.domain)</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><p><img src="https://habrastorage.org/web/aee/f41/386/aeef41386ebb4866a0f75606a535bd9e.jpg"><br></p><br><p>  The guys quickly fixed the vulnerability, and the company FastMail, which took DOMPurify under the wing of its bug-out program, paid us a little bit of money ‚Äúfor beer‚Äù. </p><br><p>  But this was not the end, since the hole worked only for Safari, we dug up a little in his direction and it turned out that the DOMParser function does not work correctly, and when parsing the html page it executes JS, which no popular browser does (yes, yes, IE), which we reported to Apple. </p><br><pre> <code class="javascript hljs">Payload: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DOMParser().parseFromString(<span class="hljs-string"><span class="hljs-string">'&lt;svg onload=alert(document.domain)&gt;'</span></span>, <span class="hljs-string"><span class="hljs-string">'text/html'</span></span>);</code> </pre> <br><p><img src="https://habrastorage.org/web/5d7/f71/7c2/5d7f717c251544f584e42980bf82d9d1.jpg"><br></p><br><p>  And just the other day, Apple issued CVE-2017-7038 - something very similar to <abbr title="Universal cross-site scripting">UXSS ‚Äî</abbr> vulnerability, but without <abbr title="Same Origin Policy">SOP</abbr> bypass.  In more detail about all possible vulnerable functions, perhaps, we will sometime describe in separate article. </p><br><p>  As a result, such a non-trivial scheme turned out: XSS in the application ‚ÄúMoyOffice‚Äù was possible due to the connection of the DOMPurify library, which did not process SVG tags (although it should have been), but gave directly to the standard browser function DOMParser, which was implemented with an error. </p><br><p>  In this long way, we fixed the vulnerability not only for our client, but also made the world a bit safer. </p><br><h2>  Real vulnerabilities </h2><br><p>  It is impossible to write something big and not to allow any bugs, there is no such methodology.  Therefore, we analyze a couple of real vulnerabilities with a high level of criticality. </p><br><h3>  Implementing external XML entities </h3><br><p>  Since we have the storage and editing of documents, we somehow have to draw the document to the user and make changes to them, if necessary.  As you may know, modern office documents are a collection of XML files packed into an archive.  And what is editing documents without an XML parser? </p><br><p>  Every Web browser immediately thinks about <a href="https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Processing">XXE</a> .  How to see this vulnerability in action in this case? </p><br><ul><li>  Load the document </li><li>  Server unpack archive </li><li>  Tries to convert XML to internal format. </li><li>  Keeps the right format on the server </li></ul><br><p>  That's just step number three is dangerous, it is carried out using an open source library in which it was possible to connect external entities.  What we did: </p><br><ul><li>  Created a valid .docx document </li><li>  Unpacked </li><li>  In one of the xml files added </li></ul><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE foo [ &lt;!ELEMENT foo ANY &gt; &lt;!ENTITY xxe SYSTEM "file:///etc/passwd" &gt;]&gt;</span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">foo</span></span></span><span class="hljs-tag">&gt;</span></span>&amp;xxe;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">foo</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><ul><li>  Packed back, renamed to .docx </li><li>  Uploaded to server </li></ul><br><p>  And after processing, we saw the contents of / etc / passwd.  But using this vulnerability can not only read files on the server. </p><br><p><img src="https://habrastorage.org/web/261/1d3/49b/2611d349b6e54b599b56774a5258cd65.png"><br></p><br><p>  Anyway, we did not manage to read anything important, since all the parsing takes place in an isolated container (docker).  Vulnerability was promptly closed. </p><br><p>  By the way, to generate such files and check XXE you can use the <a href="https://github.com/BuffaloWill/oxml_xxe">tool</a> .  With its help, some researchers have found the XXE and in the bug-out programs too. </p><br><h3>  Remote Command Execution via EL Injection </h3><br><p>  Let's tell about honest RCE - remote execution of OS commands on the server.  Some microservices are written in Java, including using Spring.  Vulnerabilities of this kind ( <abbr title="Expression Language Injection">EL Injection</abbr> ) for Spring (and not only) are very well fuzzy, if you send {{7 * 7}} to the server, then in the answer on the page you will receive a mathematical function equal to 49. </p><br><p>  Next, you can already try to perform the functions of the language and even run the command with: </p><br><pre> <code class="java hljs">${T(java.lang.Runtime).getRuntime().exec(<span class="hljs-string"><span class="hljs-string">"ls"</span></span>)}</code> </pre> <br><p>  More details about a similar vulnerability in the Spring Boot Oauth module can be found <a href="http://secalert.net/">here</a> .  And <a href="https://github.com/spring-projects/spring-boot/issues/4763">then the</a> ticket on the gita, describing the problem that caused the execution of the code in our case. </p><br><p>  But in our particular situation, such a simple sending of payload did not work, because when sending a request to the Web server, our quotes passed the URL-encode and were not perceived by the Spring as special characters.  What to do in this situation?  Everything is quite simple: you can, using standard language tools, encode from numeric values ‚Äã‚Äãto characters using the java.lang.Character.toString () function and concatenate all characters.  About this trick you can read <a href="https://deadpool.sh/2017/RCE-Springs/">here</a> . </p><br><p>  As a result, we got a big and scary payload (read / etc / passwd /): </p><br><pre> <code class="java hljs">${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(<span class="hljs-number"><span class="hljs-number">99</span></span>).concat(T(java.lang.Character).toString(<span class="hljs-number"><span class="hljs-number">97</span></span>)).concat(T(java.lang.Character).toString(<span class="hljs-number"><span class="hljs-number">116</span></span>)).concat(T(java.lang.Character).toString(<span class="hljs-number"><span class="hljs-number">32</span></span>)).concat(T(java.lang.Character).toString(<span class="hljs-number"><span class="hljs-number">47</span></span>)).concat(T(java.lang.Character).toString(<span class="hljs-number"><span class="hljs-number">101</span></span>)).concat(T(java.lang.Character).toString(<span class="hljs-number"><span class="hljs-number">116</span></span>)).concat(T(java.lang.Character).toString(<span class="hljs-number"><span class="hljs-number">99</span></span>)).concat(T(java.lang.Character).toString(<span class="hljs-number"><span class="hljs-number">47</span></span>)).concat(T(java.lang.Character).toString(<span class="hljs-number"><span class="hljs-number">112</span></span>)).concat(T(java.lang.Character).toString(<span class="hljs-number"><span class="hljs-number">97</span></span>)).concat(T(java.lang.Character).toString(<span class="hljs-number"><span class="hljs-number">115</span></span>)).concat(T(java.lang.Character).toString(<span class="hljs-number"><span class="hljs-number">115</span></span>)).concat(T(java.lang.Character).toString(<span class="hljs-number"><span class="hljs-number">119</span></span>)).concat(T(java.lang.Character).toString(<span class="hljs-number"><span class="hljs-number">100</span></span>))).getInputStream())}</code> </pre> <br><p>  It is worth noting that the RCE was also inside the docker-container, and although it was not created for protection, it still provides some sort of isolation. </p><br><h1>  Conclusion </h1><br><p>  Phew, that‚Äôs the end of the article.  Let's now summarize how our approach differs from the classic penetration tests: </p><br><ul><li>  Auditors know more about the development process and the operation of the product.  Awareness is achieved through access to documentation and the ability to monitor the pace of development. </li><li>  Ability to participate in building architecture, which allows you to find problems and vulnerabilities at the planning stage. </li><li>  Access to source codes. </li><li>  Offset works from black box to white box.  Classical tests are usually very limited in this regard. </li><li>  Eliminate the problem of generating large reports. </li><li>  Competent allocation of auditor resources.  Everything is painted weekly, time is used efficiently, and people who are aware of the internal features of the components are always involved in the project. </li><li>  Increasing the level of expertise due to the study of a large number of various services. </li><li>  Having the ability to search for vulnerabilities in third-party products that are used in development, and to make the world ‚Äúcleaner and more pleasant‚Äù. </li><li>  More detailed study of the system.  Due to the transition from the surface collection of ‚Äúlow-hanging fruits‚Äù to the study of each component separately, it is therefore possible to search for more complex vulnerabilities. </li></ul><br><p>  Each approach should be improved and, for the sake of completeness, you can expand the team with highly targeted specialists, add more vigorous action to the developers and engage in their training in the field of security. </p><br><p>  Of course, this approach also does not give one hundred percent confidence in the safety of products, but it is more methodical and extensive than the classic penetration tests.  It is aimed at responding as quickly as possible to the release of a new code and the elimination of vulnerabilities as early as possible. </p><br><p>  We hope that you were able to bring out something new for yourself and have gained an understanding of how work is done on finding vulnerabilities in large projects. </p><br><h1>  useful links </h1><br><ul><li>  7 basic development <a href="https://habrahabr.ru/company/edison/blog/269789/">techniques</a> . </li><li>  Open Security Assurance Maturity Model ( <a href="http://www.opensamm.org/">OpenSAMM</a> ) from OWASP. </li><li>  Microsoft Security Development Lifecycle (SDL).  <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/84aed186-1d75-4366-8e61-8d258746bopq.aspx">Process Guidance</a> . </li><li>  <a href="https://github.com/cure53/DOMPurify">DOMPurify</a> . </li><li>  XSS <a href="https://cure53.de/purify">vectors and</a> DOMPurify <a href="https://cure53.de/purify">demos</a> . </li><li>  XSS <a href="https://github.com/cure53/H5SC">vectors</a> for HTML5. </li><li>  User <a href="https://github.com/cure53/HTTPLeaks">tracking</a> through various HTML tags. </li><li>  <a href="https://github.com/cure53/H5SC/tree/master/attachments">Files</a> with XSS vectors for attachments. </li><li>  <a href="https://habrahabr.ru/post/306810/">De-anonymization of</a> Windows users through file. </li><li>  <a href="https://github.com/MobSF/Mobile-Security-Framework-MobSF">Tulsa</a> to automatically check mobile applications for vulnerabilities. </li><li>  Developer Toolkit <a href="https://developer.tizen.org/">Tizen</a> . </li><li>  <a href="https://xakep.ru/2017/04/05/tizen/">Fasting</a> about 40 Graders in Tizen. </li><li>  <a href="https://www.viva64.com/ru/b/0519/">The publication</a> about errors Tizen OS. </li><li>  Vulnerabilities <a href="http://2015.zeronights.org/assets/files/07-Belov.pdf">SmartTV</a> . </li><li>  Vulnerability to <a href="https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Processing">implement external entities</a> . </li><li>  <a href="https://github.com/BuffaloWill/oxml_xxe">Tools</a> for automatically generating files with XXE vectors. </li><li>  <a href="http://secalert.net/">Spring Boot RCE</a> . </li><li>  <a href="https://deadpool.sh/2017/RCE-Springs/">Spring Boot RCE Tricks</a> . </li></ul><br><p>  PS I express my gratitude for the help in the preparation of the material <a href="https://habrahabr.ru/users/belove/" class="user_link">BeLove</a> . </p></div><p>Source: <a href="https://habr.com/ru/post/334692/">https://habr.com/ru/post/334692/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../334680/index.html">Apache Curator for Apache Zookeeper features overview</a></li>
<li><a href="../334682/index.html">Rapid deployment containers</a></li>
<li><a href="../334684/index.html">Juniper Node Slicing and Universal Chassis</a></li>
<li><a href="../334688/index.html">Flash is dead: who's next?</a></li>
<li><a href="../334690/index.html">Galley hackathon</a></li>
<li><a href="../334694/index.html">Testing prototypes in software development</a></li>
<li><a href="../334696/index.html">Machine learning in skiing</a></li>
<li><a href="../334698/index.html">Three laws of configydynamics</a></li>
<li><a href="../334700/index.html">Vulnerability in Alfa-Bank Ukraine: getting the full name of the client by phone number</a></li>
<li><a href="../334702/index.html">Development under Sailfish OS in the eyes of an iOS developer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>