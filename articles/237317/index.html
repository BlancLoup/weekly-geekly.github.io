<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Flask Mega-Tutorial, Part 16: Debugging, Testing and Profiling</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the sixteenth article in the series, where I describe my experience of writing a Python web application using the Flask mic framework. 

 The ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Flask Mega-Tutorial, Part 16: Debugging, Testing and Profiling</h1><div class="post__text post__text-html js-mediator-article">  This is the sixteenth article in the series, where I describe my experience of writing a <a href="http://python.org/">Python</a> web application using the <a href="http://flask.pocoo.org/">Flask</a> mic framework. <br><br>  The purpose of this guide is to develop a fairly functional microblog application, which I decided to call microblog, in the absence of originality. <br><br><div class="spoiler">  <b class="spoiler_title">Table of contents</b> <div class="spoiler_text">  <a href="http://habrahabr.ru/post/193242/">Part 1: Hello, World!</a> <br>  <a href="http://habrahabr.ru/post/193260/">Part 2: Templates</a> <br>  <a href="http://habrahabr.ru/post/194062/">Part 3: Forms</a> <br>  <a href="http://habrahabr.ru/post/196810/">Part 4: Database</a> <br>  <a href="http://habrahabr.ru/post/222983/">Part 5: User Login</a> <br>  <a href="http://habrahabr.ru/post/223375/">Part 6: Profile Page and Avatars</a> <br>  <a href="http://habrahabr.ru/post/223783/">Part 7: Unit Testing</a> <br>  <a href="http://habrahabr.ru/post/230643/">Part 8: Subscribers, Contacts and Friends</a> <br>  <a href="http://habrahabr.ru/post/230897/">Part 9: Pagination</a> <br>  <a href="http://habrahabr.ru/post/234613/">Part 10: Full Text Search</a> <br>  <a href="http://habrahabr.ru/post/234737/">Part 11: Email Support</a> <br>  <a href="http://habrahabr.ru/post/234785/">Part 12: Reconstruction</a> <br>  <a href="http://habrahabr.ru/post/236753/">Part 13: Date and Time</a> <br>  <a href="http://habrahabr.ru/post/236861/">Part 14: I18n and L10n</a> <br>  <a href="http://habrahabr.ru/post/237065/">Part 15: Ajax</a> <br>  <a href="http://habrahabr.ru/post/237317/">Part 16: Debugging, Testing, and Profiling (this article)</a> <br>  <a href="http://habrahabr.ru/post/237489/">Part 17: Deploying to Linux (and even to Raspberry Pi!)</a> <br>  <a href="http://habrahabr.ru/post/237517/">Part 18: Deploying to Heroku Cloud</a> <br></div></div><br><a name="habracut"></a><br>  Our humble application is starting to show signs of release readiness, so it's time to put it in order as much as possible.  Not so long ago, one of the readers of this blog (hello, George!) Reported a strange database behavior, which we will try to debug today.  This should help us realize that no matter how carefully we wrote the code and how often we tested it, some errors sometimes go unnoticed.  Unfortunately, they are usually detected by the end users. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Instead of simply correcting this error and waiting for the next one to be discovered, we will take some preventive measures to be ready to detect possible errors. <br><br>  In the first part of this article, we will look at <i>debugging</i> and I will show you some of the techniques and techniques that I use to debug complex problems. <br><br>  Later, we will see how we can evaluate the effectiveness of our testing strategy.  We measure what part of our code our unit tests cover, this is what is called <i>test coverage</i> . <br><br>  And finally, we will reflect on another class of problems that many applications often encounter ‚Äî the lack of performance.  We will look at the <i>profiling</i> techniques to find the slow parts of our application. <br><br>  Sounds good?  Then let's get started. <br><br><h4>  <b>Mistake</b> </h4><br>  The problem was discovered by the reader of this blog, after he implemented a new feature that allows users to delete their posts.  The official version of microblog does not include this function, so we will implement it quickly so that we can debug it. <br>  View function that removes posts (file app / views.py): <br><br><pre><code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@app.route('/delete/&lt;int:id&gt;') @login_required def delete(id): post = Post.query.get(id) if post == None: flash('Post not found.') return redirect(url_for('index')) if post.author.id != g.user.id: flash('You cannot delete this post.') return redirect(url_for('index')) db.session.delete(post) db.session.commit() flash('Your post has been deleted.') return redirect(url_for('index'))</span></span></code> </pre> <br>  To enable this feature, we will add a delete link to all posts owned by the current user (file app / templates / post.html): <br><br><pre> <code class="html hljs xml">{% if post.author.id == g.user.id %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ url_for('delete', id = post.id) }}"</span></span></span><span class="hljs-tag">&gt;</span></span>{{ _('Delete') }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> {% endif %}</code> </pre><br>  There is nothing new for us, we have done this many times before. <br><br>  Let's move on and run our application with debug mode turned off (debug = False) to view it with the user's eyes. <br>  Linux and Mac users, run in the console: <br><br><pre> <code class="bash hljs">$ ./runp.py</code> </pre><br>  Windows users, run this command in a command shell: <br><br><pre> <code class="bash hljs">flask/Scripts/python runp.py</code> </pre><br>  Now, as a user, create a post, and then try to delete it.  And as soon as you click on the delete link ... Wham! <br><br>  We received a brief message that some error occurred and the administrator will be notified about it.  In fact, this message is our 500.html template.  With debug mode disabled, Flask returns this pattern to all errors that occurred during the processing of a request.  Since  we are in "production" mode, we will not see either the real error message or the call stack. <br><br><h4>  <b>Debugging problems "in the field"</b> </h4><br>  If you remember the <a href="http://habrahabr.ru/post/223783/">article</a> on unit testing, we activated several debugging services to run in the production version of our application.  Then we created a logger that writes errors and diagnostic messages to the log file while the application is running.  Flask itself records the stack of calls for any incident and not processed, until the request is completed, an exception.  In addition, we have configured a logger that sends all members of the list of administrators emails when writing errors to the log. <br><br>  So, in the event of an error like what happened above, we will have some information about its nature in two places at once: in the log file and in the email. <br><br>  The contents of the call stack may not be enough to correct the error, but this is in any case better than nothing.  Suppose we know nothing about an existing problem.  And now we need to determine what happened, based only on the printout of the call stack.  Here is the call stack: <br><br><pre> <code class="bash hljs">127.0.0.1 - - [03/Mar/2013 23:57:39] <span class="hljs-string"><span class="hljs-string">"GET /delete/12 HTTP/1.1"</span></span> 500 - Traceback (most recent call last): File <span class="hljs-string"><span class="hljs-string">"/home/microblog/flask/lib/python2.7/site-packages/flask/app.py"</span></span>, line 1701, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> __call__ <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> self.wsgi_app(environ, start_response) File <span class="hljs-string"><span class="hljs-string">"/home/microblog/flask/lib/python2.7/site-packages/flask/app.py"</span></span>, line 1689, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> wsgi_app response = self.make_response(self.handle_exception(e)) File <span class="hljs-string"><span class="hljs-string">"/home/microblog/flask/lib/python2.7/site-packages/flask/app.py"</span></span>, line 1687, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> wsgi_app response = self.full_dispatch_request() File <span class="hljs-string"><span class="hljs-string">"/home/microblog/flask/lib/python2.7/site-packages/flask/app.py"</span></span>, line 1360, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> full_dispatch_request rv = self.handle_user_exception(e) File <span class="hljs-string"><span class="hljs-string">"/home/microblog/flask/lib/python2.7/site-packages/flask/app.py"</span></span>, line 1358, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> full_dispatch_request rv = self.dispatch_request() File <span class="hljs-string"><span class="hljs-string">"/home/microblog/flask/lib/python2.7/site-packages/flask/app.py"</span></span>, line 1344, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dispatch_request <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> self.view_functions[rule.endpoint](**req.view_args) File <span class="hljs-string"><span class="hljs-string">"/home/microblog/flask/lib/python2.7/site-packages/flask_login.py"</span></span>, line 496, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> decorated_view <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> fn(*args, **kwargs) File <span class="hljs-string"><span class="hljs-string">"/home/microblog/app/views.py"</span></span>, line 195, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> delete db.session.delete(post) File <span class="hljs-string"><span class="hljs-string">"/home/microblog/flask/lib/python2.7/site-packages/sqlalchemy/orm/scoping.py"</span></span>, line 114, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> getattr(self.registry(), name)(*args, **kwargs) File <span class="hljs-string"><span class="hljs-string">"/home/microblog/flask/lib/python2.7/site-packages/sqlalchemy/orm/session.py"</span></span>, line 1400, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> delete self._attach(state) File <span class="hljs-string"><span class="hljs-string">"/home/microblog/flask/lib/python2.7/site-packages/sqlalchemy/orm/session.py"</span></span>, line 1656, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _attach state.session_id, self.hash_key)) InvalidRequestError: Object <span class="hljs-string"><span class="hljs-string">'&lt;Post at 0xff35e7ac&gt;'</span></span> is already attached to session <span class="hljs-string"><span class="hljs-string">'1'</span></span> (this is <span class="hljs-string"><span class="hljs-string">'3'</span></span>)</code> </pre><br>  If you have already engaged in reading similar error messages when using other programming languages, then keep in mind that Python shows the call stack in reverse order, that is, the frame that caused the error is at the bottom. <br><br>  How are we going to figure this out now? <br><br>  Judging by the printout of the call stack, the exception was thrown by the SQLAlchemy session processing code in the sqlalchemy / orm / session.py file. <br><br>  When working with a call stack, it is always helpful to find the last expression executed from our own code.  If we start at the bottom and gradually, frame by frame, go up the track, we find the fourth frame in our app / views.py file, or rather, in the expression db.session.delete (post) of our view function delete (). <br><br>  Now we know that SQLAlchemy cannot delete this post in the current database session.  But we still do not know why. <br><br>  If you look at the text of the exception at the very bottom, it seems that the problem is that the Post object belongs to session "1", and we are trying to attach the same object to another session "3". <br><br>  If you ask Google for help, you will find that most of these problems occur when using multi-threaded web servers that perform two requests trying to attach an object to two different sessions at the same time.  But we are using a single-threaded Python debug server, so this is not our case.  So there is some other problem that creates two active sessions instead of one. <br><br>  To learn more about the problem, we must try to repeat the mistake in a more controlled environment.  Fortunately, this error manifests itself in the ‚Äúdevelopment‚Äù version of our application, which is somewhat better, since it gives us access to the web version of the call stack provided by Flask itself instead of the 500.html template. <br><br>  The web version of the call stack is noteworthy in that it allows us to see the code and immediately look at the result of the expressions and all this right from the browser.  Not having a sufficiently deep understanding of what is happening in the code, we guess that there is a session '1' (we can only assume that this is the very first session created) which, for some reason, was not deleted like any normal session when the request that created this session.  So, to move forward in solving a problem, it would be nice to know who is creating this unclosed session. <br><br><h4>  <b>Using the Python Debugger</b> </h4><br>  The easiest way to find out who creates an object is to set <i>a breakpoint</i> in the object's constructor.  A breakpoint is a command that suspends program execution when a certain condition is met.  And then at this point there is an opportunity to explore the program, view the call stack at this particular point of execution, view and even change the contents of variables, etc. Breakpoints are one of the basic features of <i>debuggers</i> .  This time we use the debugger that comes with the Python interpreter, called pdb. <br><br>  But what class are we looking for?  Let's go back to the web version of the track and look around.  At the bottom of each frame of the route there are links to the code viewer and to the Python console (the icons are located on the right and become visible when you hover the mouse over the frame) with which we can find the class that uses the session.  In the code panel, we see that we are inside the Session class, which, apparently, is the base class for SQLAlchemy database sessions.  Since the context of the lower frame stack is inside the session object, we can get the actual session class in the console: <br><br><pre> <code class="bash hljs">&gt;&gt;&gt; <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> self &lt;flask_sqlalchemy._SignallingSession object at 0xff34914c&gt;</code> </pre><br>  Now we know that the sessions we use are defined in Flask-SQLAlchemy, because it looks like this extension defines its own session class, which inherits the SQLAlchemy Session class. <br><br>  Now we can explore the source code for the Flask-SQLAlchemy extension located in the flask / lib / python2.7 / site-packages / flask_sqlalchemy.py file and find the __init __ () constructor of the _SignallingSession class.  Now we are fully ready to debug. <br><br>  There are several ways to set a breakpoint in a python application.  The simplest is to add the following code in the place where we want to stop the program: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pdb; pdb.set_trace()</code> </pre><br>  Which we will do by temporarily adding a breakpoint to the _SignallingSession class constructor (flask / lib / python2.7 / site-packages / flask_sqlalchemy.py): <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_SignallingSession</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Session)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, db, autocommit=False, autoflush=False, **options)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pdb; pdb.set_trace() <span class="hljs-comment"><span class="hljs-comment"># &lt;-- this is temporary! self.app = db.get_app() self._model_changes = {} Session.__init__(self, autocommit=autocommit, autoflush=autoflush, extension=db.session_extensions, bind=db.engine, binds=db.get_binds(self.app), **options) # ...</span></span></code> </pre><br>  Now let's run the application again and see what happens: <br><br><pre> <code class="bash hljs">$ ./run.py &gt; /home/microblog/flask/lib/python2.7/site-packages/flask_sqlalchemy.py(198)__init__() -&gt; self.app = db.get_app() (Pdb)</code> </pre><br>  Since  the message ‚ÄúRunning on ...‚Äù did not appear, we understand that the server did not start up to the end.  The execution of the program was interrupted, because in some part of the code someone requested the creation of our "mysterious" session! <br><br>  The most important question we must answer immediately is where we are now in the application, since this should tell us who requested the creation of the very session '1' which we can‚Äôt get rid of later in the course of the program.  We use the bt command (abbreviation for backtrace) to get the contents of the call stack: <br><br><pre> <code class="bash hljs">(Pdb) bt /home/microblog/run.py(2)&lt;module&gt;() -&gt; from app import app /home/microblog/app/__init__.py(44)&lt;module&gt;() -&gt; from app import views, models /home/microblog/app/views.py(6)&lt;module&gt;() -&gt; from forms import LoginForm, EditForm, PostForm, SearchForm /home/microblog/app/forms.py(4)&lt;module&gt;() -&gt; from app.models import User /home/microblog/app/models.py(92)&lt;module&gt;() -&gt; whooshalchemy.whoosh_index(app, Post) /home/microblog/flask/lib/python2.6/site-packages/flask_whooshalchemy.py(168)whoosh_index() -&gt; _create_index(app, model)) /home/microblog/flask/lib/python2.6/site-packages/flask_whooshalchemy.py(199)_create_index() -&gt; model.query = _QueryProxy(model.query, primary_key, /home/microblog/flask/lib/python2.6/site-packages/flask_sqlalchemy.py(397)__get__() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> type.query_class(mapper, session=self.sa.session()) /home/microblog/flask/lib/python2.6/site-packages/sqlalchemy/orm/scoping.py(54)__call__() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> self.registry() /home/microblog/flask/lib/python2.6/site-packages/sqlalchemy/util/_collections.py(852)__call__() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> self.registry.setdefault(key, self.createfunc()) &gt; /home/microblog/flask/lib/python2.6/site-packages/flask_sqlalchemy.py(198)__init__() -&gt; self.app = db.get_app() (Pdb)</code> </pre><br>  As before, we start from the bottom and move upwards in search of our code.  And this turns out to be line 92 in our models.py models file, in which our full-text search is initialized: <br><br><pre> <code class="python hljs">whooshalchemy.whoosh_index(app, Post)</code> </pre><br>  Strange.  We are not creating a database session and are not doing anything that should create this session, but it seems that the initialization of Flask-WhooshAlchemy itself creates a session. <br><br>  It seems that this is not our mistake, but rather some kind of conflict between the wrapper extensions for SQLAlchemy and Whoosh.  We could stop here and just ask for help from the developers of these two great extensions or from their communities.  Or we can continue debugging and see if we can solve the problem here and now.  So, I will continue debugging, and you, if you are not interested, can freely proceed to the next section. <br><br>  Let's take another look at the call stack.  We call call whoosh_index (), which, in turn, calls _create_index ().  The specific _create_index () line looks like this: <br><br><pre> <code class="python hljs">model.query = _QueryProxy(model.query, primary_key, searcher, model)</code> </pre><br>  The model variable in this context represents our Post class, and we pass it as an argument to the whoosh_index () function.  Given this, it appears that Flask-WhooshAlchemy creates a Post.query wrapper that accepts the original Post.query as an argument, plus some Whoosh-specific content.  But this is already interesting.  Judging by the route presented above, the next function in the queue is __get __ (), one of the <a href="http://docs.python.org/2/howto/descriptor.html">methods-descriptors</a> of the python language. <br><br>  The __get __ () method is used to implement descriptors that are attributes that have a specific behavior besides the value.  Each time a descriptor is mentioned, the function __get __ () is called.  Then the function should return the value of the attribute.  The only attribute mentioned in this line of code is query, so now we know that the seemingly simple attribute that we previously used to generate queries to the database is actually a descriptor and not an attribute.  The remainder of the call stack is responsible for calculating the value of the model.query expression, preparing to create the constructor for the _QueryProxy object. <br><br>  Now let's go down the stack a little lower to see what happens next.  The instruction from the __get __ () method is presented below: <br><br>  return type.query_class (mapper, session = self.sa.session ()) <br><br>  And this is a pretty curious piece of code.  When we call, for example, User.query.get (id), we indirectly call the __get __ () method to get the request object, and with it we get the session! <br><br>  When Flask-WhooshAlchemy executes model.query, a session is created and bound to the request object.  But the request object requested by Flask-WhooshAlchemy is not as short-lived as the ones we run inside our presentation functions.  Flask-WhooshAlchemy wraps this request object in its own request object, which is saved back to model.query.  Since  The __set __ () method does not exist, the new object is saved as an attribute.  For our Post class, this means that after the completion of the Flask-WhooshAlchemy initialization, we will have a descriptor and an attribute with the same name.  In accordance with the priority, in this case the attribute wins, which is quite expected, because if this were not the case, our search for Whoosh would not work. <br><br>  An important detail of this is that the above code establishes a permanent attribute that contains the session '1' inside the session.  Even in spite of the fact that the first request processed by the application uses this session and forgets about it immediately upon completion, the session itself is not going anywhere since the Post.query attribute continues to refer to it.  This is the very mistake! <br>  This error is caused by the confusing (in my opinion) nature of the descriptors.  They look like ordinary attributes and people use them.  The developer of Flask-WhooshAlchemy just wanted to create an extended request object to store some useful information to fulfill its requests, but did not fully realize that using the attribute of the query model does a little more than it seems because it has hidden session opening behavior. with a database. <br><br><h4>  <b>Regression tests</b> </h4><br>  For many, most likely, the most logical step in this situation seems to correct the error Flask-WhooshAlchemy and move on.  But if we do that, which guarantees us the absence of such an error in the future?  For example, what happens if in a year we decide to update Flask-WhooshAlchemy to the new version and forget about our editing? <br><br>  The best way to detect any error is to create a unit test for it in order to prevent the occurrence of an error (the so-called <i>regression</i> ) in the future. <br><br>  However, there is some difficulty in creating a test for this error, since we have to emulate two queries inside one test.  The first request will refer to the Post object, emulating the request we make to display data on the page.  And since this is the first request, it will use the session '1'.  Then we have to forget this session and create a new one exactly as Flask-SQLAlchemy does.  Attempting to delete the Post object in the second session should raise this error again, since the first session is not over as expected. <br><br>  Looking back at the Flask-SQLAlchemy source code again, we see that new sessions are created with the db.create_scoped_session () function, and after the request is completed, the session is destroyed by calling the db.session.remove () function.  Knowing this, it is quite simple to write a test for this error: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_delete_post</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># create a user and a post u = User(nickname = 'john', email = 'john@example.com') p = Post(body = 'test post', author = u, timestamp = datetime.utcnow()) db.session.add(u) db.session.add(p) db.session.commit() # query the post and destroy the session p = Post.query.get(1) db.session.remove() # delete the post using a new session db.session = db.create_scoped_session() db.session.delete(p) db.session.commit()</span></span></code> </pre><br>  And, of course, when running the tests, we will receive a message about the failed test: <br><br><pre> <code class="bash hljs">$ ./tests.py .E.... ====================================================================== ERROR: test_delete_post (__main__.TestCase) ---------------------------------------------------------------------- Traceback (most recent call last): File <span class="hljs-string"><span class="hljs-string">"./tests.py"</span></span>, line 133, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> test_delete_post db.session.delete(p) File <span class="hljs-string"><span class="hljs-string">"/home/microblog/flask/lib/python2.7/site-packages/sqlalchemy/orm/scoping.py"</span></span>, line 114, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> getattr(self.registry(), name)(*args, **kwargs) File <span class="hljs-string"><span class="hljs-string">"/home/microblog/flask/lib/python2.7/site-packages/sqlalchemy/orm/session.py"</span></span>, line 1400, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> delete self._attach(state) File <span class="hljs-string"><span class="hljs-string">"/home/microblog/flask/lib/python2.7/site-packages/sqlalchemy/orm/session.py"</span></span>, line 1656, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _attach state.session_id, self.hash_key)) InvalidRequestError: Object <span class="hljs-string"><span class="hljs-string">'&lt;Post at 0xff09b7ac&gt;'</span></span> is already attached to session <span class="hljs-string"><span class="hljs-string">'1'</span></span> (this is <span class="hljs-string"><span class="hljs-string">'3'</span></span>) ---------------------------------------------------------------------- Ran 6 tests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 3.852s FAILED (errors=1)</code> </pre><br><h4>  <b>Correction</b> </h4><br>  To solve this problem, we must find an alternative way to bind the Flask-WhooshAlchemy query object to the model. <br><br>  The Flask-SQLAlchemy documentation mentions the <a href="http://pythonhosted.org/Flask-SQLAlchemy/api.html">model.query_class</a> attribute, which contains the class used to execute queries.  In fact, this is a much more transparent and straightforward way to force Flask-SQLAlchemy to use a modified query class than the Flask-WhooshAlchemy used.  If we set up Flask-SQLAlchemy to create queries using the Whoosh query class (which inherits the BaseQuery class from Flask-SQLAlchemy), then the result does not change, but the error disappears. <br><br>  I created a fork of the Flask-WhooshAlchemy project on github where I implemented these changes.  If you want to review the changes, you can look at my commit's <a href="https://github.com/miguelgrinberg/Flask-WhooshAlchemy/commit/1e17350ea600e247c0094cfa4ae7145f08f4c4a3">github diff</a> , or you can <a href="https://raw.github.com/miguelgrinberg/Flask-WhooshAlchemy/1e17350ea600e247c0094cfa4ae7145f08f4c4a3/flask_whooshalchemy.py">download the</a> whole of the fixed extension and replace it with the original flask_whooshalchemy.py file. <br><br>  I sent the changes I made to the developer Flask-WhooshAlchemy, and now I dare to hope that in time they will be included in the official version. <br><br><h4>  <b>Test coverage</b> </h4><br>  One way to critically reduce the likelihood of an error after deploying our application on a server is dense test coverage.  We already have a testing framework, but how do we know which part of the application is actually being tested when it is used? <br><br>  The test <i>coverage</i> measurement tool is able to examine the running application and mark running and non-running lines of code.  After the execution is complete, it issues a report showing the lines of code that did not run.  Having received such a report for our tests, we would be able to determine exactly which part of our code remained unaffected by the executed tests. <br><br>  Python has its own test coverage measurement tool, simply named <a href="http://nedbatchelder.com/code/coverage/">coverage</a> .  Let's install it: <br><br><pre> <code class="bash hljs">flask/bin/pip install coverage</code> </pre><br>  You can use this tool from the command line or embed the call directly into the script.  In order to accidentally forget to run it, we will choose the last option. <br><br>  Here are the changes that need to be added to our tests to generate a report (tests.py file): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> coverage <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> coverage cov = coverage(branch = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, omit = [<span class="hljs-string"><span class="hljs-string">'flask/*'</span></span>, <span class="hljs-string"><span class="hljs-string">'tests.py'</span></span>]) cov.start() <span class="hljs-comment"><span class="hljs-comment"># ... if __name__ == '__main__': try: unittest.main() except: pass cov.stop() cov.save() print "\n\nCoverage Report:\n" cov.report() print "HTML version: " + os.path.join(basedir, "tmp/coverage/index.html") cov.html_report(directory = 'tmp/coverage') cov.erase()</span></span></code> </pre><br>  We start by initializing the coverage module at the beginning of the script.  The branch = True parameter indicates the need to analyze the execution branches in addition to the usual line-by-line verification of coverage.  The omit parameter is necessary to exclude from the test all third-party modules installed in our virtual environment and the testing framework itself, since we are only interested in analyzing the code of our application. <br><br>    ,   cov.start(),     unit .           ,             .   ,   coverage   cov.stop(),      cov.save().  , cov.report()    , cov.html_report()    HTML     ,  cov.erase()   . <br><br>         (,    ): <br><br><pre> <code class="bash hljs">$ ./tests.py .....F ====================================================================== FAIL: test_translation (__main__.TestCase) ---------------------------------------------------------------------- Traceback (most recent call last): File <span class="hljs-string"><span class="hljs-string">"./tests.py"</span></span>, line 143, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> test_translation assert microsoft_translate(u<span class="hljs-string"><span class="hljs-string">'English'</span></span>, <span class="hljs-string"><span class="hljs-string">'en'</span></span>, <span class="hljs-string"><span class="hljs-string">'es'</span></span>) == u<span class="hljs-string"><span class="hljs-string">'Ingl√©s'</span></span> AssertionError ---------------------------------------------------------------------- Ran 6 tests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 3.981s FAILED (failures=1) Coverage Report: Name Stmts Miss Branch BrMiss Cover Missing ------------------------------------------------------------ app/__init__ 39 0 6 3 93% app/decorators 6 2 0 0 67% 5-6 app/emails 14 6 0 0 57% 9, 12-15, 21 app/forms 30 14 8 8 42% 15-16, 19-30 app/models 63 8 10 1 88% 32, 37, 47, 50, 53, 56, 78, 90 app/momentjs 12 5 0 0 58% 5, 8, 11, 14, 17 app/translate 33 24 4 3 27% 10-36, 39-56 app/views 169 124 46 46 21% 16, 20, 24-30, 34-37, 41, 45-46, 53-67, 75-81, 88-109, 113-114, 120-125, 132-143, 149-164, 169-183, 188-198, 203-205, 210-211, 218 config 22 0 0 0 100% ------------------------------------------------------------ TOTAL 388 183 74 61 47% HTML version: /home/microblog/tmp/coverage/index.html</code> </pre><br>  ,    47%  .      ,    ,           ,     . <br><br>   ,    app/models.py   (88%), . .        .   app/views.py   (21%) . .           . <br><br>      ,      <i>  </i>   Branch  BrMiss.    : <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>: x = x + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x f(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br>    coverage    ,   100% , . .    1,    3 .          0,       .    ,     . <br><br>                    , , ,   . <br><br>  coverage    HTML ,              . <br><br>    ,      ,       app/models.py    .    ,  HTML ,      : <br><ul><li> User.make_valid_nickname() </li><li> User.is_authenticated() </li><li> User.is_active() </li><li> User.is_anonymous() </li><li> User.get_id() </li><li> User.__repr__() </li><li> Post.__repr__() </li></ul><br> User.make_unique_nickname() (   ,        ) <br><br>         : <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_user</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># make valid nicknames n = User.make_valid_nickname('John_123') assert n == 'John_123' n = User.make_valid_nickname('John_[123]\n') assert n == 'John_123' # create a user u = User(nickname = 'john', email = 'john@example.com') db.session.add(u) db.session.commit() assert u.is_authenticated() == True assert u.is_active() == True assert u.is_anonymous() == False assert u.id == int(u.get_id())</span></span></code> </pre><br>  __repr__()     ,      .  ,      : <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__repr__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># pragma: no cover return '&lt;User %r&gt;' % (self.nickname)</span></span></code> </pre><br>  ,     make_unique_nickname()      ,             .           : <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_make_unique_nickname</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># create a user and write it to the database u = User(nickname = 'john', email = 'john@example.com') db.session.add(u) db.session.commit() nickname = User.make_unique_nickname('susan') assert nickname == 'susan' nickname = User.make_unique_nickname('john') assert nickname != 'john' #...</span></span></code> </pre><br>     ,    100%    models.py. <br><br>     . , -               ,      ,      ,    . <br><br><h4> <b> </b> </h4><br>     .        ,    .         ,    ,             . <br><br>       <b></b> .       ,    coverage,       ,           .   ,              .    ,                  . <br><br> Python     <a href="http://docs.python.org/2/library/profile.html">cProfile</a> .          ,     ,    .     ¬´Flask profiler¬ª  ,  Werkzeug,  Flask-,       ,       . <br><br>    Werkzeug,        run.py.    profile.py: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!flask/bin/python from werkzeug.contrib.profiler import ProfilerMiddleware from app import app app.config['PROFILE'] = True app.wsgi_app = ProfilerMiddleware(app.wsgi_app, restrictions = [30]) app.run(debug = True)</span></span></code> </pre><br>          30       (  restrictions     <a href="http://docs.python.org/dev/library/profile.html"></a> ). <br><br>   ,      .  Here is an example: <br><br><pre> <code class="bash hljs">-------------------------------------------------------------------------------- PATH: <span class="hljs-string"><span class="hljs-string">'/'</span></span> 95477 <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> calls (89364 primitive calls) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.202 seconds Ordered by: internal time, call count List reduced from 1587 to 30 due to restriction &lt;30&gt; ncalls tottime percall cumtime percall filename:lineno(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span>) 1 0.061 0.061 0.061 0.061 {method <span class="hljs-string"><span class="hljs-string">'commit'</span></span> of <span class="hljs-string"><span class="hljs-string">'sqlite3.Connection'</span></span> objects} 1 0.013 0.013 0.018 0.018 flask/lib/python2.7/site-packages/sqlalchemy/dialects/sqlite/pysqlite.py:278(dbapi) 16807 0.006 0.000 0.006 0.000 {isinstance} 5053 0.006 0.000 0.012 0.000 flask/lib/python2.7/site-packages/jinja2/nodes.py:163(iter_child_nodes) 8746/8733 0.005 0.000 0.005 0.000 {getattr} 817 0.004 0.000 0.011 0.000 flask/lib/python2.7/site-packages/jinja2/lexer.py:548(tokeniter) 1 0.004 0.004 0.004 0.004 /usr/lib/python2.7/sqlite3/dbapi2.py:24(&lt;module&gt;) 4 0.004 0.001 0.015 0.004 {__import__} 1 0.004 0.004 0.009 0.009 flask/lib/python2.7/site-packages/sqlalchemy/dialects/sqlite/__init__.py:7(&lt;module&gt;) 1808/8 0.003 0.000 0.033 0.004 flask/lib/python2.7/site-packages/jinja2/visitor.py:34(visit) 9013 0.003 0.000 0.005 0.000 flask/lib/python2.7/site-packages/jinja2/nodes.py:147(iter_fields) 2822 0.003 0.000 0.003 0.000 {method <span class="hljs-string"><span class="hljs-string">'match'</span></span> of <span class="hljs-string"><span class="hljs-string">'_sre.SRE_Pattern'</span></span> objects} 738 0.003 0.000 0.003 0.000 {method <span class="hljs-string"><span class="hljs-string">'split'</span></span> of <span class="hljs-string"><span class="hljs-string">'str'</span></span> objects} 1808 0.003 0.000 0.006 0.000 flask/lib/python2.7/site-packages/jinja2/visitor.py:26(get_visitor) 2862 0.003 0.000 0.003 0.000 {method <span class="hljs-string"><span class="hljs-string">'append'</span></span> of <span class="hljs-string"><span class="hljs-string">'list'</span></span> objects} 110/106 0.002 0.000 0.008 0.000 flask/lib/python2.7/site-packages/jinja2/parser.py:544(parse_primary) 11 0.002 0.000 0.002 0.000 {posix.stat} 5 0.002 0.000 0.010 0.002 flask/lib/python2.7/site-packages/sqlalchemy/engine/base.py:1549(_execute_clauseelement) 1 0.002 0.002 0.004 0.004 flask/lib/python2.7/site-packages/sqlalchemy/dialects/sqlite/base.py:124(&lt;module&gt;) 1229/36 0.002 0.000 0.008 0.000 flask/lib/python2.7/site-packages/jinja2/nodes.py:183(find_all) 416/4 0.002 0.000 0.006 0.002 flask/lib/python2.7/site-packages/jinja2/visitor.py:58(generic_visit) 101/10 0.002 0.000 0.003 0.000 flask/lib/python2.7/sre_compile.py:32(_compile) 15 0.002 0.000 0.003 0.000 flask/lib/python2.7/site-packages/sqlalchemy/schema.py:1094(_make_proxy) 8 0.002 0.000 0.002 0.000 {method <span class="hljs-string"><span class="hljs-string">'execute'</span></span> of <span class="hljs-string"><span class="hljs-string">'sqlite3.Cursor'</span></span> objects} 1 0.002 0.002 0.002 0.002 flask/lib/python2.7/encodings/base64_codec.py:8(&lt;module&gt;) 2 0.002 0.001 0.002 0.001 {method <span class="hljs-string"><span class="hljs-string">'close'</span></span> of <span class="hljs-string"><span class="hljs-string">'sqlite3.Connection'</span></span> objects} 1 0.001 0.001 0.001 0.001 flask/lib/python2.7/site-packages/sqlalchemy/dialects/sqlite/pysqlite.py:215(&lt;module&gt;) 2 0.001 0.001 0.002 0.001 flask/lib/python2.7/site-packages/wtforms/form.py:162(__call__) 980 0.001 0.000 0.001 0.000 {id} 936/127 0.001 0.000 0.008 0.000 flask/lib/python2.7/site-packages/jinja2/visitor.py:41(generic_visit) -------------------------------------------------------------------------------- 127.0.0.1 - - [09/Mar/2013 19:35:49] <span class="hljs-string"><span class="hljs-string">"GET / HTTP/1.1"</span></span> 200 -</code> </pre><br>      : <br><ul><li> ncalls:     . </li><li> tottime: ,   . </li><li> percall:  tottime   ncalls. </li><li> cumtime:          . </li><li> percall: cumtime   ncalls. </li><li> filename:lineno(function):         . </li></ul><br><br> ,         .   ,  Jinja2       Python.  ,          ,     ! <br><br>          , ,         . ,      ,     sqlite3    Jinja2,   .  ,   ,       0.2 , ..      . <br><br>    ,            ,     . <br><br><h4> <b>  </b> </h4><br>     ,      .    ,           ,               ( )          . <br><br>   Flask-SQLAlchemy   <a href="http://pythonhosted.org/Flask-SQLAlchemy/api.html">get_debug_queries</a> ,         . <br><br>    .    ‚Äî         ,      -    ,       ,        . <br><br>      ,         ( config.py): <br><br><pre> <code class="python hljs">SQLALCHEMY_RECORD_QUERIES = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span></code> </pre><br>  ,       ,     ,  ¬´¬ª ( config.py): <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># slow database query threshold (in seconds) DATABASE_QUERY_TIMEOUT = 0.5</span></span></code> </pre><br>     ,      .   Flask  ,     after_request ( app/views.py): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask.ext.sqlalchemy <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> get_debug_queries <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> config <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> DATABASE_QUERY_TIMEOUT @app.after_request <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">after_request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(response)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> query <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> get_debug_queries(): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> query.duration &gt;= DATABASE_QUERY_TIMEOUT: app.logger.warning(<span class="hljs-string"><span class="hljs-string">"SLOW QUERY: %s\nParameters: %s\nDuration: %fs\nContext: %s\n"</span></span> % (query.statement, query.parameters, query.duration, query.context)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response</code> </pre><br>  ,     ,    .      SQL ,   ,      ,     . <br><br>     ,    ,         ,       ,        ,      .      ,      - . <br><br><h4>  <b>Conclusion</b> </h4><br>      ,   ,      .        : <br><br>  <a href="">microblog-0.16.zip</a> . <br><br>    GitHub,     <a href=""></a> . <br><br>  ,        , . .         .  ,  ,             . <br>       ,        ,      . <br><br>  See you later! <br><br>  Miguel </div><p>Source: <a href="https://habr.com/ru/post/237317/">https://habr.com/ru/post/237317/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../237303/index.html">Cardiwear: Domestic Smart Electrocardiograph T-shirt</a></li>
<li><a href="../237305/index.html">Show Sound # 16 - Podcast about audio equipment, formats and technologies</a></li>
<li><a href="../237307/index.html">How to deal with repost or a couple of words about perceptual hashes</a></li>
<li><a href="../237309/index.html">Paradise tax corners for data centers in the United States</a></li>
<li><a href="../237313/index.html">7 little tricks when working in Windows</a></li>
<li><a href="../237323/index.html">Overload and specialization. Subtle moment</a></li>
<li><a href="../237331/index.html">3D displays for smartphones</a></li>
<li><a href="../237333/index.html">WinJS + universal applications. Learn FlipView</a></li>
<li><a href="../237335/index.html">Anonymization on the Internet and the use of self-hosted services</a></li>
<li><a href="../237339/index.html">Sentence</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>