<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitoring channel status via jitter / packet loss</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, colleagues. 

 Gathering with thoughts, I decided to make a decision that was born to me. 

 So, the statement of the problem : 

 The...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitoring channel status via jitter / packet loss</h1><div class="post__text post__text-html js-mediator-article"> Good afternoon, colleagues. <br><br>  Gathering with thoughts, I decided to make a decision that was born to me. <br><br>  So, the <u>statement of the problem</u> : 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There are two channels between points A and B, most often from different providers.  It is necessary to take into account the quality of service on these channels, namely: <br>  1. With losses&gt; 0.5% per channel, the channel should not be used. <br>  2. When jitter&gt; 10ms, the channel should not be used. <br><br>  This problem arose in my work, because the two cities are connected by two channels, through which a large number of votes run, which, as is well known, are quite capricious with respect to the indicators described above.  To whom it is interesting - you are welcome under the cat. <br><a name="habracut"></a><br>  <u>Initial decision</u> . <br><br>  Initially, there were even two clumsy options.  <u>The first</u> was to raise a pingule on the ziska, which checks the channel survivability and switching on his death.  The solution was managed until we had problems with jitter in the absence of losses. <br><br>  <u>The second solution</u> was to create a monitor based on udp packets that mimic the G729 codec.  The monitor showed losses and jitter, in case of problems with communication, the administrator climbed to the cat, observed the current values ‚Äã‚Äãof jitter and losses on it, and, depending on the circumstances, decided to turn off the channel.  It worked, of course.  But this is some kind of semi-automatic system.  Therefore, I pulled myself together and brought this situation to some final solution. <br><br>  <u>The current solution</u> . <br>  So, as in the second case, we create a udp monitor for channel quality that simulates the G729a codec (the so-called SLA monitor). <br> <code>ip sla 33 <br> udp-jitter 172.16.1.66 49333 source-ip 172.16.1.65 codec g729a codec-size 20 <br> tos 70 <br> threshold 10</code> <br>  This monitor will send 1000 packets at intervals of one minute to port 49333 at the destination point, labeled tos = 70 = 0x46 = EF.  The destination must be enabled. <br> <code>ip sla responder</code> <br>  Next, create a stub track (created specifically to control it using applets, and not tied tightly to an SLA monitor): <br> <code>track 20 stub-object <br> default-state up</code> <br> <br>  Now our task is to remove the results from the SLA monitor and, by their values, leave track 20 in the UP state or put it.  This can be done for example with the help of Cisco EEM (Embedded Event Manager), which allows you to monitor the current state of your piece of iron and perform certain actions. <br>  To do this, create two applets.  One will put the track in the Down state, if at least one of the parameters (jitter or the number of losses) does not suit us.  The second will raise it back if BOTH parameters are normal. <br><br>  <u>Configuration</u> <br>  1. Create the first applet: <br> <code>event manager applet LB trap</code> <br>  Create two events based on SNMP OID for RTT and jitter From our SLA monitor: <br> <code>event tag jitter snmp oid 1.3.6.1.4.1.9.9.42.1.5.2.1.46.33 get-type exact entry-op ge entry-val "10" entry-type value poll-interval 4 <br> event tag loss snmp oid 1.3.6.1.4.1.9.9.42.1.5.2.1.1.33 get-type exact entry-op le entry-val "994" entry-type value poll-interval 4</code> <br>  Here, the last digit 33 in the SNMP OID is the number of the SLA instance.  10 is the threshold for jitter (in ms), 994 is the minimum number of packets returned from the thousand sent (1000 - packet_loss).  poll-interval - the interval with which the cat polls the state of values.  Here 4c. <br>  We indicate that our applet should work with ANY of the events, i.e.  logical OR is used. <br> <code>trigger <br> correlate event loss or event jitter</code> <br>  Next action: <br> <code>action 20 track set 20 state down</code> <br>  Those.  our track fits into the Down state. <br><br>  The second applet is similar: <br><br> <code>event manager applet LB2 trap <br> event tag jitter snmp oid 1.3.6.1.4.1.9.9.42.1.5.2.1.46.33 get-type exact entry-op lt entry-val "10" entry-type value poll-interval 4 <br> event tag loss snmp oid 1.3.6.1.4.1.9.9.42.1.5.2.1.1.33 get-type exact entry-op gt entry-val "994" entry-type value poll-interval 4 <br> trigger <br> correlate event loss and event jitter <br> action 20 track set 20 state up <br></code> <br>  Only the applet is triggered by a logical AND between events.  And the track is cocked up. <br><br>  It can be seen that polling occurs at 4s intervals and the current state of the track is not taken into account, i.e.  traps are triggered constantly, every 4s.  I tried to tighten the monitoring of the state of the track itself, but it worked very buggy, it did not always work.  So I donated a couple of percent of the money and left it like that. <br><br>  Additionally, there are applets informing me about the problems on the channel and their disappearance: <br><br> <code>event manager applet LB_info <br> event syslog pattern "20 stub Up-&gt;Down" <br> action 10 syslog msg "applet works!" <br> action 11 cli command "enable" <br> action 12 cli command "show ip sla stat 33" <br> action 13 mail server "192.168.6.20" to "ilya@tut_domen.ru" from "alert@tut_domen.ru" subject "Frame loss or high jitter on NiS channel" body "$_cli_result"</code> <br>  and <br>  The $ _cli_result variable contains the output of the last command, i.e.  in our case, show ip sla stat 33. <br><br> <code>event manager applet LB2_info <br> event syslog pattern "20 stub Down-&gt;Up" <br> action 10 syslog msg "applet 2 works!" <br> action 11 cli command "enable" <br> action 12 cli command "show ip sla stat 33" <br> action 13 mail server "192.168.6.20" to "ilya@tut_domen.ru" from "alert@tut_domen.ru" subject "NiS channel is correct" body "$_cli_result"</code> <br> <br>  In other words, we send ourselves a letter in which the body is the result of the last launch of the SLA monitor, which actually caused the switching of the track. <br><br>  So, now actually <u>how to take this into account</u> .  I see two ways: <br><br>  1. line in the route-map (as it works for me, actually, but there is just a tricky scheme) <br> <code>set ip next-hop verify-availability 172.16.1.66 1 track 20</code> <br>  2. tracking statics when we have a route of the form <br> <code>ip route 172.16.0.0 255.255.255.0 192.168.1.1 track 20</code> <br>  In case of losses or jitter on the channel, this route will simply be removed from the routing table and traffic will follow an alternate path. <br><br>  It may be clumsy, but after suffering a week I did not invent anything better.  Than rich, as they say. <br><br>  PS I mean the reader is a little familiar with the basics of the Cisco console. <br>  PPS The ip sla command syntax differs by 12.4T and 12.4, but the meaning is the same. <br>  PPS If you need explanations that do not go beyond the border of several lines - write, add. <br><br>  Respectfully, <br>  Podkopaev Ilya <br><br>  _________ <br>  <b>UPD</b> : about the CPU.  In general, under load without applets, I have a router load (ISR 3845) of about 42% on average, with an applet - 43-44. </div><p>Source: <a href="https://habr.com/ru/post/108519/">https://habr.com/ru/post/108519/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../108511/index.html">How not to write documentation</a></li>
<li><a href="../108514/index.html">Two in one: spring-mobile & spring-android</a></li>
<li><a href="../108515/index.html">Removing dead code for beginners</a></li>
<li><a href="../108516/index.html">Do you use PHP on a 64-bit platform? So lost in performance!</a></li>
<li><a href="../108518/index.html">C Birthday, Windows!</a></li>
<li><a href="../108521/index.html">Intelligent vending machines appeared in Japan</a></li>
<li><a href="../108522/index.html">I want an update Habra-Habra</a></li>
<li><a href="../108523/index.html">How would you solve this compatibility problem? Answer</a></li>
<li><a href="../108524/index.html">New All-in-One PC: MSI Wind Top AC1900</a></li>
<li><a href="../108525/index.html">What means of publishing and viewing photo-panoramas exist for those who do not use the services of external hosting?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>