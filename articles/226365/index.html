<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitoring Oracle Database via ODBC in Zabbix</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article will discuss the possibility of monitoring the database using the tools built into Zabbix to support ODBC using c Autodiscover objects. 

...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitoring Oracle Database via ODBC in Zabbix</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/f62/e01/45c/f62e0145c500b55cfedcc41315d75b29.png" alt="image"><br>  The article will discuss the possibility of monitoring the database using the tools built into Zabbix to support ODBC using c Autodiscover objects. <br><a name="habracut"></a><br>  To begin with, we will look at the database monitoring methods available for Zabbix, which were used before ODBC support. <br>  Since the article is about monitoring Oracle, then we will look at this section. <br><br>  1. Using the <a href="https://www.zabbix.com/wiki/howto/monitor/db/orcale/oracle">zabora</a> script <br><br>  In principle, the script is good for everyone, but the main thing is that it did not suit me: the script is on each machine from the database, and when adding a request, you had to go to this machine and edit the config. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It supports query parameters, that is, you can pass a parameter to the key and, on the basis of it, make a query to the database. <br>  That is, the same query can be used to collect metrics of different objects. <br><br>  2. <a href="http://www.smartmarmot.com/wiki/index.php/Orabbix">Orabbix</a> or <a href="http://www.smartmarmot.com/product/dbforbix/">DBforBIX</a> <br><br>  It is also a good product, is a java daemon, creates several connections and supports automatically adding new requests to the config without rebooting.  It works like a Zabbix trapper, that is, it sends data to a Zabbix server at regular intervals. <br><br>  Disadvantages: <br>  - does not support parameters, that is, a separate query is created for each metric. <br>  Imagine you have 10 tablespaces and you need to remove from each 4 parameters - it turns out 40 requests in a file.  The request interval receiving metrics is also set in the config, which is not very convenient. <br><br>  Having tried all these solutions I decided to use ODBC support in Zabbix, and here's why: <br><ul><li>  query to the database is the standard Zabbix key, it follows from this that we configure such parameters as the polling frequency in the interface itself </li><li>  editing requests in the Zabbix interface </li><li>  allows you to use macros </li><li>  the most important thing is to automate the process of adding new objects to monitoring </li></ul><br><br>  First I will describe what is in the farm: <br><br>  1. 6 Oracle databases - 1 DB - 1 server + 1 backup server under the database: total: 12 servers are obtained. <br>  2. Servers for each database are combined in a cluster - a total of 6 clusters <br>  3. Zabbix agent for AIX is installed on every server. <br>  4. On each server according to the zabora script <br><br>  Zabbix monitoring configuration: <br><ol><li>  Zabbix server on CentOS 6.5 + TokuDB - 20,000 items - 380 nps (new values ‚Äã‚Äãper second) </li><li>  Especially for monitoring the database, Zabbix Proxy was raised, since requests can be executed long enough, I would not want to suspend the data collection processes of the main Zabbix, also CentOS 6.5 + TokuDB </li></ol><br><br>  In this article, I will not touch on the configuration of TokuDB, since I am planning another article on why we switched from InnoDB to TokuDB, and what it gave us. <br><br><h4>  Installing Oracle Instant Client </h4><br><br>  First you need to install Oracle Instant Client on the machine with Zabbix Proxy: <br><br>  We use Oracle 11g, so we download the corresponding version of RMP packages from <a href="http://www.oracle.com/technetwork/topics/linuxx86-64soft-092277.html">the Oracle website</a> . <br>  We need: <br><ul><li>  oracle-instantclient11.2-basic-11.2.0.4.0-1.x86_64.rpm - main libraries </li><li>  oracle-instantclient11.2-jdbc-11.2.0.4.0-1.x86_64.rpm - drivers for java, for our task are not needed, but it is useful on the farm :) </li><li>  oracle-instantclient11.2-sqlplus-11.2.0.4.0-1.x86_64.rpm - SQLplus client </li><li>  oracle-instantclient11.2-odbc-11.2.0.4.0-1.x86_64.rpm - library for working with ODBC </li><li>  You can still heap: oracle-instantclient11.2-devel-11.2.0.4.0-1.x86_64.rpm :) </li></ul><br><br>  in the folder where we downloaded all these files we do: <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># rpm -i oracle-*.rpm</span></span></code> </pre> <br><br><h4>  Configure SQLplus to access Oracle database. </h4><br><br>  In order for the client to work, it is necessary to set the necessary variables in the environment parameters, to begin with, we set them in our profile by writing to the <code>$HOME/.bash_profile</code> file: <br><pre> <code class="bash hljs">ORACLE_HOME=/usr/lib/oracle/11.2/client64 LD_LIBRARY_PATH=<span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/lib:/usr/lib64:<span class="hljs-variable"><span class="hljs-variable">$LD_LIBRARY_PATH</span></span> TNS_ADMIN=<span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/network/admin&gt; PATH=<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span>:<span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/bin:<span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/bin <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ORACLE_HOME <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> LD_LIBRARY_PATH <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> TNS_ADMIN <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PATH</code> </pre><br><br>  Let us log and see if our variables are in <pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># env</span></span></code> </pre> <br>  Note the variable <code>TNS_ADMIN=$ORACLE_HOME/network/admin</code> <br>  This path must be created, there we put the tnsnames.ora file which is used by the client libraries to connect to the database. <br><br>  Create a connection to the database with the name TESTDB for example. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#cat $ORACLE_HOME/network/admin/tnsnames.ora</span></span></code> </pre> <br><pre> <code class="bash hljs">TESTDB = (DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = oratestdb)(PORT = 1521)) (CONNECT_DATA = (SERVER = DEDICATED) (SERVICE_NAME = testdb) ) )</code> </pre><br><br>  It is necessary to substitute the necessary values ‚Äã‚Äãin HOST and SERVICE_NAME. <br>  HOST - you can register an IP address or DNS name (check only that it resolves to IP) <br><br>  Check the client configuration, just pre-create a zabbix account in Oracle. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># sqlplus zabbix/zabbix@TESTDB</span></span></code> </pre> <br><pre> <code class="sql hljs">SQL*Plus: <span class="hljs-keyword"><span class="hljs-keyword">Release</span></span> <span class="hljs-number"><span class="hljs-number">11.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> Production <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> Sat May <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span> <span class="hljs-number"><span class="hljs-number">2014</span></span> Copyright (c) <span class="hljs-number"><span class="hljs-number">1982</span></span>, <span class="hljs-number"><span class="hljs-number">2013</span></span>, Oracle. All rights reserved. Connected <span class="hljs-keyword"><span class="hljs-keyword">to</span></span>:&lt;/code&gt; <span class="hljs-keyword"><span class="hljs-keyword">Oracle</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Database</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>g <span class="hljs-keyword"><span class="hljs-keyword">Enterprise</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Edition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Release</span></span> <span class="hljs-number"><span class="hljs-number">11.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> - <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-built_in"><span class="hljs-built_in">bit</span></span> Production <span class="hljs-keyword"><span class="hljs-keyword">With</span></span> the Partitioning, OLAP, <span class="hljs-keyword"><span class="hljs-keyword">Data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Mining</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Real</span></span> Application Testing options <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>&gt;</code> </pre><br><br>  We see that the client issued an invitation, it means the connection was successful, and just to be sure, we will make a simple request: <br><pre> <code class="sql hljs">SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> banner <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> v$<span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rownum</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><pre> <code class="sql hljs">BANNER <span class="hljs-comment"><span class="hljs-comment">-------------------------------------------------------------------------------- Oracle Database 11g Enterprise Edition Release 11.2.0.2.0 - 64bit Production SQL&gt;</span></span></code> </pre><br><br><h4>  ODBC configuration. </h4><br><br>  The official Zabbix Server and Zabbix Proxy packages in CentoOS are compiled with unixODBC support, so after installing them you should have the unixODBC package installed, check: <pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># yum info *ODBC</span></span></code> </pre> <br>  The output should contain the following packages: <code>unixODBC</code> and <code>oracle-instantclient11.2-odbc</code> . <br><br>  Rule files: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /etc/odbcinst.ini</span></span></code> </pre> <br><pre> <code class="bash hljs">[OracleDriver] Description=Oracle ODBC driver <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Oracle 11g Driver=/usr/lib/oracle/11.2/client64/lib/libsqora.so.11.1</code> </pre><br>  And we immediately do this check: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ldd /usr/lib/oracle/11.2/client64/lib/libsqora.so.11.1</span></span></code> </pre> <br><pre> <code class="bash hljs">ldd: warning: you <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> not have execution permission <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> `/usr/lib/oracle/11.2/client64/lib/libsqora.so.11.1` linux-vdso.so.1 =&gt; (0x00007fff1a58f000) libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007f89d6d4d000) libm.so.6 =&gt; /lib64/libm.so.6 (0x00007f89d6ac8000) libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x00007f89d68ab000) libnsl.so.1 =&gt; /lib64/libnsl.so.1 (0x00007f89d6692000) libclntsh.so.11.1 =&gt; /usr/lib/oracle/11.2/client64/lib/libclntsh.so.11.1 (0x00007f89d3d22000) libodbcinst.so.1 =&gt; /lib64/libodbcinst.so.1 (0x00007f89d3b11000) libc.so.6 =&gt; /lib64/libc.so.6 (0x00007f89d377d000) /lib64/ld-linux-x86-64.so.2 (0x00007f89d711c000) libnnz11.so =&gt; /usr/lib/oracle/11.2/client64/lib/libnnz11.so (0x00007f89d33af000) libaio.so.1 =&gt; /lib64/libaio.so.1 (0x00007f89d31ae000) libltdl.so.7 =&gt; /usr/lib64/libltdl.so.7 (0x00007f89d2fa5000)</code> </pre><br><br>  <code>libodbcinst.so.1 =&gt; not found</code> likely, you will get <code>libodbcinst.so.1 =&gt; not found</code> , so you need to make a sim link: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ls -lah /lib64 | grep odbc</span></span></code> </pre> <br><pre> <code class="bash hljs">lrwxrwxrwx. 1 root root 31 May 18 00:45 libodbcinst.so.1 -&gt; /usr/lib64/libodbcinst.so.2.0.0 lrwxrwxrwx. 1 root root 16 May 20 11:41 libodbcinst.so.2 -&gt; libodbcinst.so.1</code> </pre><br><br>  Then edit the file: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /etc/odbc.ini</span></span></code> </pre> <br><pre> <code class="bash hljs">[ORA_TESTDB] Driver= OracleDriver DSN= TESTDB ServerName= TESTDB UserID= zabbix Password= zabbix</code> </pre><br><br>  After that, we should be able to connect to the Oracle database through the ODBC client (always use the -v parameter, if there is a connection error, tell in detail what the problem is): <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># isql -v ORA_TESTDB</span></span></code> </pre> <br><pre> <code class="sql hljs">+<span class="hljs-comment"><span class="hljs-comment">---------------------------------------+ | Connected! | | | | sql-statement | | help [tablename] | | quit | | +---------------------------------------+ SQL&gt;</span></span></code> </pre><br><br>  Just to clear our conscience that everything works for us, we make a request: <br><pre> <code class="sql hljs">SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> banner <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> v$<span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rownum</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>; +<span class="hljs-comment"><span class="hljs-comment">---------------------------------------------------------------------------------+ | BANNER | +---------------------------------------------------------------------------------+ | Oracle Database 11g Enterprise Edition Release 11.2.0.2.0 - 64bit Production | +---------------------------------------------------------------------------------+ SQLRowCount returns -1 1 rows fetched SQL&gt;</span></span></code> </pre><br><br>  Congratulations, you have configured ODBC. <br><br>  Now we need to ensure that Zabbix Proxy can also make requests via ODBC. <br><br>  For this, it is necessary that the variables mentioned above are available in the environment of the zabbix_proxy process, for this we add to the file: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /etc/init.d/functions</span></span></code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Set up a default search path. PATH="/sbin:/usr/sbin:/bin:/usr/bin" ORACLE_HOME=/usr/lib/oracle/11.2/client64 LD_LIBRARY_PATH=$ORACLE_HOME/lib:/usr/lib64:$LD_LIBRARY_PATH TNS_ADMIN=$ORACLE_HOME/network/admin&lt;/code&gt; PATH=$PATH:$ORACLE_HOME/bin:$HOME/bin&lt;/code&gt; export ORACLE_HOME export LD_LIBRARY_PATH export TNS_ADMIN export PATH</span></span></code> </pre><br><br>  After this, be sure to restart zabbix_proxy: <pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># service zabbix-proxy restart</span></span></code> </pre> <br><br>  Now we will immediately move on to setting autodiscovery rules in Zabbix terminology - this is a low level discovery rule. <br><br>  What is LLD? <br>  In principle, this is any element in Zabbix that can return data in JSON format. <br>  So the built-in database monitoring in Zabbix always returns only 1 column and 1 row.  For some reason, the Zabbix team will not write an LLD generator for the DB until then. <br><br>  Who needs this feature, <a href="https://support.zabbix.com/browse/ZBXNEXT-2321">please vote</a> . <br><br>  We'll have to write a script that will give us a list of objects in JSON format. <br><br>  Template and script can be taken on <a href="https://github.com/nucleusv/zabbix/tree/master/oracle-lld">GitHub</a> <br><br>  The script is written in php, so bash lovers, please turn away to the side :) <br>  I will not comment on the script itself, I think everything is clear from the code, I will only say that it should be placed in the folder that is specified in the zabbix_proxy.conf config (or zabbix_server.conf): <pre> <code class="bash hljs"> ExternalScripts=/usr/lib/zabbix/externalscripts</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Oracle.odbc.discovery script</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/php &lt;?php if(!isset($argv[1]) &amp;&amp; !isset($argv[2])) exit("ZBX_NOTSUPPORTED"); $connected_dsn = odbc_connect($argv[1],"",""); if(!$connected_dsn) exit('SQL connection erorr | ZBX_NOTSUPPORTED'); switch ($argv[2]) { case "tablespaces": $result=odbc_exec($connected_dsn,"SELECT tablespace_name FROM dba_tablespaces;"); $tablespaces = array("data"=&gt;array()); while(odbc_fetch_row($result)){ $tablespaces['data'][]=array('{#TBSNAME}'=&gt;odbc_result($result,1)); } echo json_encode($tablespaces); break; case "jobs": $result=odbc_exec($connected_dsn,"SELECT job_name, owner FROM dba_scheduler_jobs WHERE state != 'DISABLED';"); $jobs = array("data"=&gt;array()); while(odbc_fetch_row($result)){ $jobs['data'][]=array( '{#JOBNAME}'=&gt;odbc_result($result,1), '{#JOBOWNER}'=&gt;odbc_result($result,2)); } echo json_encode($jobs); break; } exit(); ?&gt;</span></span></code> </pre><br></div></div><br><br>  Two parameters are passed to the script: <br>  1. DSN - which you specified in the /etc/odbc.ini file in square brackets, in the case of the example it is ORA_TESTDB <br>  2. type of objects to return the list: tablespaces or jobs <br><br>  In the case of jobs, the script will also return {#JOBOWNER}, that is, the job owner. <br><br>  Add permissions to the script and try to run it: <br>  <code># /usr/lib/zabbix/externalscripts/oracle.odbc.discovery ORA_TESTDB tablespaces</code> , the script will return approximately such an array: <br><pre> <code class="php hljs">{ <span class="hljs-string"><span class="hljs-string">"data"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"{#TBSNAME}"</span></span>: <span class="hljs-string"><span class="hljs-string">"SYSTEM"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"{#TBSNAME}"</span></span>: <span class="hljs-string"><span class="hljs-string">"SYSAUX"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"{#TBSNAME}"</span></span>: <span class="hljs-string"><span class="hljs-string">"UNDOTBS1"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"{#TBSNAME}"</span></span>: <span class="hljs-string"><span class="hljs-string">"TEMP"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"{#TBSNAME}"</span></span>: <span class="hljs-string"><span class="hljs-string">"USERS"</span></span> } ] }</code> </pre><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /usr/lib/zabbix/externalscripts/oracle.odbc.discovery ORA_TESTDB jobs</span></span></code> </pre> <br><pre> <code class="php hljs">{ <span class="hljs-string"><span class="hljs-string">"data"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"{#JOBNAME}"</span></span>: <span class="hljs-string"><span class="hljs-string">"PURGE_LOG"</span></span>, <span class="hljs-string"><span class="hljs-string">"{#JOBOWNER}"</span></span>: <span class="hljs-string"><span class="hljs-string">"SYS"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"{#JOBNAME}"</span></span>: <span class="hljs-string"><span class="hljs-string">"ORA$AUTOTASK_CLEAN"</span></span>, <span class="hljs-string"><span class="hljs-string">"{#JOBOWNER}"</span></span>: <span class="hljs-string"><span class="hljs-string">"SYS"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"{#JOBNAME}"</span></span>: <span class="hljs-string"><span class="hljs-string">"DRA_REEVALUATE_OPEN_FAILURES"</span></span>, <span class="hljs-string"><span class="hljs-string">"{#JOBOWNER}"</span></span>: <span class="hljs-string"><span class="hljs-string">"SYS"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"{#JOBNAME}"</span></span>: <span class="hljs-string"><span class="hljs-string">"BSLN_MAINTAIN_STATS_JOB"</span></span>, <span class="hljs-string"><span class="hljs-string">"{#JOBOWNER}"</span></span>: <span class="hljs-string"><span class="hljs-string">"SYS"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"{#JOBNAME}"</span></span>: <span class="hljs-string"><span class="hljs-string">"RSE$CLEAN_RECOVERABLE_SCRIPT"</span></span>, <span class="hljs-string"><span class="hljs-string">"{#JOBOWNER}"</span></span>: <span class="hljs-string"><span class="hljs-string">"SYS"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"{#JOBNAME}"</span></span>: <span class="hljs-string"><span class="hljs-string">"SM$CLEAN_AUTO_SPLIT_MERGE"</span></span>, <span class="hljs-string"><span class="hljs-string">"{#JOBOWNER}"</span></span>: <span class="hljs-string"><span class="hljs-string">"SYS"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"{#JOBNAME}"</span></span>: <span class="hljs-string"><span class="hljs-string">"RLM$EVTCLEANUP"</span></span>, <span class="hljs-string"><span class="hljs-string">"{#JOBOWNER}"</span></span>: <span class="hljs-string"><span class="hljs-string">"EXFSYS"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"{#JOBNAME}"</span></span>: <span class="hljs-string"><span class="hljs-string">"RLM$SCHDNEGACTION"</span></span>, <span class="hljs-string"><span class="hljs-string">"{#JOBOWNER}"</span></span>: <span class="hljs-string"><span class="hljs-string">"EXFSYS"</span></span> } ] }</code> </pre><br><br>  Finally, we proceed to the addition of monitoring the Oracle database in Zabbix. <br><br>  First, a few words about the template: <br>  1. Oracle shared monitoring keys are taken from the zabora script. <br>  2. for the template to work it is necessary in the Macros tab of the host itself, add 3 user macros: <br>  - {$ DSN1} - DSN which is registered in square brackets of the /etc/odbc.ini file (in the example of ORA_TESTDB) <br>  - {$ ORA_USER} - the user with the rights of which will connect to the Oracle database <br>  - {$ ORA_PASSWORD} - password to connect to Oracle database <br><br><img src="https://habrastorage.org/files/eed/832/6b9/eed8326b9daf4c59806f858a85267b78.png"><br><br><img src="https://habrastorage.org/files/db9/f57/5a3/db9f575a35cf48139e2c424c32985fc4.png"><br><br>  So the list of LLD rules: <br><img src="https://habrastorage.org/getpro/habr/post_images/f7b/48a/832/f7b48a832324a7127f0f57d9df18a881.jpg"><br><br>  For the rules to work for the first time, set the interval in the rules themselves, suppose 300 seconds, and after 5 minutes new data elements should be created in your data elements. <br><br>  Consider the rules themselves and start with Tablespaces. <br><img src="https://habrastorage.org/getpro/habr/post_images/ee8/77c/dd2/ee877cdd2640180f5d194600c9cea0ee.jpg"><br><br>  In principle, everything is clear here, I want to draw attention to the ‚ÄúFilter‚Äù field. <br>  Using this field, you can filter the list that returns the element itself; in our example, we do not need to add system tablespaces to the monitoring.  Filtering is based on the regexp rule.  As you can see in the pictures, the {#TBSNAME} field must comply with the regexp Oracle System Excluded Tablespaces rule.  General rules for regexp are described in <code> &gt;  &gt;  </code> and are called in the filter using the @ symbol. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/937/7fe/8eb/9377fe8eb8f9982cec225b5555591492.jpg"><br><br>  Similarly, all for job'ov: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a00/d76/980/a00d769802dae61d6a3a87b0b99d47b4.jpg"><br><br>  Go to the prototype data <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d32/96d/8ab/d3296d8ab9f1feea0a4b7e04d7e7d58d.jpg"><br><br>  Prototype itself <br><img src="https://habrastorage.org/getpro/habr/post_images/111/0a3/1fa/1110a31fa7df8301ab21dee0567da3e6.png"><br><br>  The picture speaks for itself, but I want to draw on one nuance, namely, on the ‚ÄúUnit of Measurement‚Äù field, by default, Zabbix uses the 10th numeral system, which is to be expected, therefore, all prefixes are Kilo, Mega, Giga, etc. .  this is a division by 1000, which is not entirely correct from the point of view of calculating the amount of data, so in Zabbix you get ‚Äúspecial‚Äù units of measurement in the ‚ÄúLatest data‚Äù tab: B and Bps are bytes and bytes per second ( <a href="https://www.zabbix.com/documentation/ru/2.2/manual/config/items/item">more</a> ). <br>  But there is a funny moment (bug), in the latest data the prefixes K (ilo), M (ega), G (iga) are translated into K, M, G, but the unit itself is not, therefore, in the case of gigabytes, you will have GB. <br><br>  Trigger prototypes for tablespaces: <br><img src="https://habrastorage.org/getpro/habr/post_images/bfd/949/50a/bfd94950a36562be552456ac1f84f81b.jpg"><br><br>  The ranges are as follows: <br><ul><li>  with a size less than 3TB limit in percent </li><li>  from 3TB to 10TB in gigabytes </li><li>  from 10TB in gigabytes </li></ul><br><br>  Note that the values ‚Äã‚Äãin conditions are used in bytes, and also draw on the order and values ‚Äã‚Äãused. <br>  At first glance, the condition ‚ÄúMaximum size&gt; 0‚Äù may seem superfluous. <br><br>  But this is done in order to come more informative letter for DBA. <br>  In the actions you specify: <br><pre> <code class="php hljs"><span class="hljs-number"><span class="hljs-number">1.</span></span> {ITEM.NAME1} ({HOSTNAME1}:{TRIGGER.KEY1}): {ITEM.VALUE1} <span class="hljs-number"><span class="hljs-number">2.</span></span> {ITEM.NAME2} ({HOSTNAME1}:{TRIGGER.KEY2}): {ITEM.VALUE2} <span class="hljs-number"><span class="hljs-number">3.</span></span> {ITEM.NAME3} ({HOSTNAME1}:{TRIGGER.KEY3}): {ITEM.VALUE3}</code> </pre><br><br>  We can‚Äôt get the key values ‚Äã‚Äãthat were created automatically into action, it‚Äôs not that we can‚Äôt get it, we just don‚Äôt know its name, for this you need to extract the name of the tablespace from the key, but there are no such Zabbix functions. <br><br>  With such action settings, you will receive something like this: <br><pre> <code class="php hljs"><span class="hljs-number"><span class="hljs-number">1.</span></span>   tablespace BG_Z_LOB_TBS (ODB.odbc.select[tbs_size_BG_Z_LOB_TBS,ORA_ODB]): <span class="hljs-number"><span class="hljs-number">2</span></span> GB <span class="hljs-number"><span class="hljs-number">2.</span></span>       tablespace BG_Z_LOB_TBS (ODB.odbc.select[tbs_used_percent_BG_Z_LOB_TBS,ORA_ODB]): <span class="hljs-number"><span class="hljs-number">99</span></span> % <span class="hljs-number"><span class="hljs-number">3.</span></span>    tablespace BG_Z_LOB_TBS (ODB.odbc.select[tbs_maxsize_BG_Z_LOB_TBS,ORA_ODB]): <span class="hljs-number"><span class="hljs-number">32</span></span> GB</code> </pre><br><br>  Prototypes of data for job: <br><img src="https://habrastorage.org/getpro/habr/post_images/673/42f/496/67342f496ca052efecc1c7fc8dca1974.jpg"><br><br>  Prototypes for job triggers: <br><img src="https://habrastorage.org/getpro/habr/post_images/67a/abe/aa7/67aabeaa7b72acbf7d8962f09ec641e2.jpg"><br><br>  Triggers work if: <br><ul><li>  job'a over 720 minutes </li><li>  if job ended with status not equal to "SUCCEEDED" </li></ul><br><br>  Enjoy your discoveries in the Oracle database :) </div><p>Source: <a href="https://habr.com/ru/post/226365/">https://habr.com/ru/post/226365/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../226355/index.html">Master or work?</a></li>
<li><a href="../226357/index.html">Implementation of cloud data backup based on Android Backup Service</a></li>
<li><a href="../226359/index.html">Sharp Infrared Range Finder</a></li>
<li><a href="../226361/index.html">Create Shaman Tambourines</a></li>
<li><a href="../226363/index.html">No cards. We pay bracelets, jackets, sounds and phones</a></li>
<li><a href="../226367/index.html">SteamBoy - a portable console for running video games from Steam (and not only)</a></li>
<li><a href="../226371/index.html">Rosetta interplanetary station performs a series of maneuvers to reset the speed</a></li>
<li><a href="../226373/index.html">Making backups: how to stop worrying about your data</a></li>
<li><a href="../226375/index.html">OpenXcom 1.0 released - free version of X-COM</a></li>
<li><a href="../226377/index.html">Next generation of browsers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>