<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Collecting advanced upstream statistics using nginx-sla</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Improving customer service consistently leads to higher loyalty. And not only in the sense of adherence to a specific online product, b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Collecting advanced upstream statistics using nginx-sla</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  Improving customer service consistently leads to higher loyalty.  And not only in the sense of adherence to a specific online product, but also in the sense of tolerance for its disadvantages, provided, of course, that the advantages are speed, usability, functionality, etc.  - they are outweighed. <br><br>  Of course, we cannot measure the quality of service directly; however, even such an ephemeral value can in principle be reduced to a set of quantitative characteristics, one way or another indirectly affecting quality.  Profit, number of customers, percentage of converted leads (leads - registered or interested users), etc.  - all this is quite objective indicators.  In addition, these values ‚Äã‚Äãcan be included in the performance monitoring system as KPIs - key performance indicators. <br><br>  From our engineering point of view, similar characteristics are the response time and the HTTP code of the upstream response.  Indeed, product design, product functionality, marketing efforts, and customer calling are outside our area of ‚Äã‚Äãexpertise.  Therefore, we need to focus on what is in our power ‚Äî accelerating the operation of the application infrastructure and processing client requests. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Analysis of the response and HTTP-codes is conveniently carried out on the basis of some collected statistical database, and here we smoothly approach the topic of the article. <br><a name="habracut"></a><br><h4>  What and why we measure </h4><br>  As mentioned above, our task is to assess the quality of the application, and not the actual measurement of the speed of its work (profiling) or optimization.  For this there are specialized tools.  The main indicators of the quality of the application are the upstream response time and the HTTP response code, since it is upstream that performs the main function of generating product content and processing user requests. <br><br>  On the other hand, the analysis of the transfer rate of an upstream page through channels to the client‚Äôs computer does not interest us in this context, since  tells us nothing about the quality of the product itself.  A client network can have a different architecture and speed, and the low bandwidth of a client can only mean that it works, for example, via a 3G modem. <br><br>  In the same sense, analysis of page rendering speed in the browser is hardly applicable at this stage.  The share of upstream in the process of displaying a particular page to the user from the moment of receiving a request from him and until the end of loading of all components of the page and rendering it by the browser is about 5-10%.  It turns out that, taking into account these factors, we will reduce the entire measurement result to a significantly and difficult to calculate error.  However, this is a topic for a completely separate conversation. <br><br>  Thus, statistics should be collected on two basic parameters: <br><ol><li>  <b>Upstream response time to request.</b> <br>  Analyzing the statistics on this parameter, we will not only be able to assess the overall speed of the upstream, but also to identify certain patterns (patterns) in changing the load, varying the average response time at different times of day, etc. </li><li>  <b>HTTP response code</b> <br>  It is clear that it will not be possible to identify and eliminate all errors - no one has yet canceled external links.  However, it is certainly worth striving to reduce the number of errors.  Both the ‚Äúaverage hospital temperature‚Äù (codes 2xx, 4xx) and the exact distribution of all HTTP codes should be saved and analyzed.  The predominance, for example, of the 5xx codes in the statistics, will indicate our mistake (and therefore the reduction in the quality of the application), which needs to be corrected. </li></ol><br><h4>  Features of measurement </h4><br>  When analyzing the response time, it would be nice to take into account the nature of the request, processing and analyzing statistics on various types of requests separately.  Indeed, a heavy SQL query can significantly increase the page formation time, while small AJAX queries performed by users only ‚Äúload‚Äù upstream slightly.  In this regard, it would be most expedient to distinguish categories of requests with different response time limits, for example: <br><ul><li>  AJAX request - 200ms </li><li>  Page generation - 1s </li><li>  Error - 5s </li><li>  Timeout or no response - 7s </li></ul><br>  Unfortunately, it is not always possible to explicitly separate these or other work scenarios.  For example, the same script can generate different content, depending on the working conditions, which will lead to an incorrect interpretation of measurement results. <br><br>  In this case, it is possible to formulate general rules for estimating response time based on percentage time ranges.  For example: <br><ul><li>  90% &lt;200ms </li><li>  95% &lt;500ms </li><li>  99% &lt;1s </li><li>  100% &lt;2s </li></ul><br>  Thus, the output of statistical values ‚Äã‚Äãbeyond the boundary of one of the ranges will serve as an indicator of a decrease in the quality of the application‚Äôs work. <br><br><h4>  How to evaluate the measurement result </h4><br>  Collect statistics (as below) and get the results of measurements of response time - this is only half the battle.  Without further analysis and evaluation of the result (good, bad), all this does not make any sense.  Fortunately, industry standards come to the rescue of us at the response time of the system: <br><ul><li>  ESD / MITRE (ESD-TR-86-278, ‚ÄúGuidelines for Designing User Interface Software‚Äù, 1986, <a href="http://www.dfki.de/~jameson/hcida/papers/smith-mosier.pdf">www.dfki.de/~jameson/hcida/papers/smith-mosier.pdf</a> ) </li><li>  TAFIM ("Technical Architecture Framework for Information Management", 1996, volume 8, "DoD Human Computer Interface Style Guide," <a href="http://www.everyspec.com/DoD/DOD-General/DISA_TAFIM_VOL8_7545/">www.everyspec.com/DoD/DOD-General/DISA_TAFIM_VOL8_7545</a> ) </li><li>  MIL-STD 1472 (Revision G, 2012, <a href="http://www.everyspec.com/MIL-STD/MIL-STD-1400-1499/MIL-STD-1472F_208/">www.everyspec.com/MIL-STD/MIL-STD-1400-1499/MIL-STD-1472F_208</a> ) </li></ul><br>  In accordance with these standards, the maximum user wait time should not exceed 10-15 seconds, the average request processing time should be no more than 2-5 seconds, and the system response time should be 0.2-0.5 seconds (the standards were written on the basis of the capabilities of the technology of those times which has now well increased its productivity). <br><br>  Another source is ‚ÄúDesigning and Engineering Time: The Psychology of Time Perception in Software‚Äù (2008, <a href="http://www.amazon.com/Designing-Engineering-Time-Psychology-Perception/dp/0321509188">www.amazon.com/Designing-Engineering-Time-Psychology-Perception/dp/0321509188</a> ) - examines an approach based on user timeout: <br><ul><li>  The system should show the instant reaction (0.1 - 0.2 s) when pressing buttons, calling the menu, interacting with other interface elements. </li><li>  Immediate response (0.5 - 1 s) should follow in response to a simple user request. </li><li>  An uninterrupted reaction (2‚Äì5 s) is the time during which the user retains attention to the task, in other words, the feedback time. </li><li>  Forcing reaction (7 - 10 s) - when after 7 seconds the user switches to another task or leaves the page. </li></ul><br>  Thus, comparing statistical data with the indicated values, we can carry out the conversion of a quantitative characteristic (upstream response time) into a qualitative one ‚Äî compliance of the system‚Äôs response to the standards and subjective perception of the user. <br><br>  We proceed to the direct measurement. <br><br><h4>  What to measure </h4><br>  Consider solving the problem of collecting statistics for the popular nginx server. <br><br>  When using nginx as a front end, all the information we need is available in the logs.  The classic way of collecting statistics through the analysis of logs involves a detailed analysis (parsing) of the contents of the logs for a specified period of time.  This path has several disadvantages: <br><ul><li>  the analysis of logs in itself requires a significant investment of time and resources; </li><li>  log analyzers are often expensive, and writing your own solution requires the additional involvement of developers; </li><li>  exporting parsing results for further analysis is difficult. </li></ul><br>  The second approach is the use of additional modules.  Consider a number of options. <br><ul><li>  <a href="https://github.com/groe/nginx-statsd"><b>nginx-statsd</b></a> <br>  A module for nginx that collects statistics and redirects it to the StatsD daemon using UDP protocol.  This approach, firstly, requires a separate server, and secondly, leads to an increase in service traffic.  In addition, StatsD is tied to Graphite, and the integration of other monitoring systems with it is difficult. </li><li>  <a href="http://pinba.org/wiki/Main_Page"><b>pinba</b></a> <br>  A module for nginx that collects statistical data at the time when the request is completed and sends them via UDP to a separate statistics collection server.  In fact, the disadvantages of this solution are due to the very principle of its work: the need for a separate server, ‚Äúextra‚Äù UDP traffic.  In addition, the module actually fixes the time from the moment of receiving the request to its completion (shutdown), i.e.  measures the execution time of the request, not the upstream response time we need. </li><li>  <a href="https://github.com/goldenclone/nginx-sla"><b>nginx-sla</b></a> <br>  The nginx-sla module implements the collection of upstream statistics without the involvement of an additional server.  These statistics are generated on request to nginx in plain text format, therefore, neither a separate server nor UDP is needed. </li></ul><br>  It should be noted that the described disadvantages of the above methods of collecting statistics, of course, in no way limit the usefulness of these approaches in general.  However, it is for our task that the most simple and flexible tool is nginx-sla. <br><br><h4>  Benefits of nginx-sla </h4><br>  As already noted, the use of the nginx-sla module does not require a dedicated server for collecting and analyzing statistics.  Statistics is collected by direct analysis of nginx logs and recorded in plain text.  Obviously, in the context of further analysis, both standard tools and third-party tools (for example, zabbix), such a presentation of upstream statistics is much more profitable. <br><br>  Example of statistics collected by nginx-sla, with default configuration: <br><pre><code class="nginx hljs">main.all.<span class="hljs-attribute"><span class="hljs-attribute">http</span></span> = <span class="hljs-number"><span class="hljs-number">1024</span></span> main.all.http_200 = <span class="hljs-number"><span class="hljs-number">914</span></span> ... main.all.http_xxx = <span class="hljs-number"><span class="hljs-number">2048</span></span> main.all.http_2xx = <span class="hljs-number"><span class="hljs-number">914</span></span> ... main.all.time.avg = <span class="hljs-number"><span class="hljs-number">125</span></span> main.all.time.avg.mov = <span class="hljs-number"><span class="hljs-number">124</span></span> main.all.<span class="hljs-number"><span class="hljs-number">300</span></span> = <span class="hljs-number"><span class="hljs-number">233</span></span> main.all.<span class="hljs-number"><span class="hljs-number">300</span></span>.agg = <span class="hljs-number"><span class="hljs-number">233</span></span> main.all.<span class="hljs-number"><span class="hljs-number">500</span></span> = <span class="hljs-number"><span class="hljs-number">33</span></span> main.all.<span class="hljs-number"><span class="hljs-number">500</span></span>.agg = <span class="hljs-number"><span class="hljs-number">266</span></span> main.all.<span class="hljs-number"><span class="hljs-number">2000</span></span> = <span class="hljs-number"><span class="hljs-number">40</span></span> main.all.<span class="hljs-number"><span class="hljs-number">2000</span></span>.agg = <span class="hljs-number"><span class="hljs-number">306</span></span> main.all.inf = <span class="hljs-number"><span class="hljs-number">0</span></span> main.all.inf.agg = <span class="hljs-number"><span class="hljs-number">306</span></span> main.all.<span class="hljs-number"><span class="hljs-number">25</span></span>% = <span class="hljs-number"><span class="hljs-number">124</span></span> main.all.<span class="hljs-number"><span class="hljs-number">75</span></span>% = <span class="hljs-number"><span class="hljs-number">126</span></span> main.all.<span class="hljs-number"><span class="hljs-number">90</span></span>% = <span class="hljs-number"><span class="hljs-number">126</span></span> main.all.<span class="hljs-number"><span class="hljs-number">99</span></span>% = <span class="hljs-number"><span class="hljs-number">130</span></span></code> </pre> <br>  As you can see, the data displays the statistics of all processed HTTP responses with different statuses.  For example, the value main.all.http_200 (main.all.http_404, main.all.http_500) denotes the number of processed responses with the corresponding status. <br>  And the field main.all.http_2xx contains the number of all upstream responses that have the status ‚ÄúSuccess‚Äù. <br><br>  Statistics on response time is collected in the variables main.all.300 (main.all.200, main.all.500, main.all.2000).  For example, the number of requests processed by upstream in the time from 300 milliseconds to 500 milliseconds is 33. And the aggregated number of requests processed in 500 ms or less is 266. <br><br>  In addition to the explicit statistics of upstream response time, nginx-sla lists information on percentiles.  In particular, the time for which the Upstream is responsible for 90% of requests is 126 milliseconds in this example. <br><br>  The percentile representation of the statistics, as well as the values ‚Äã‚Äãof the average (main.all.time.avg) and moving average (main.all.time.avg.mov) response times, allow analyzing the behavior of the upstream under various load scenarios.  For example: <br><img src="https://habrastorage.org/storage2/4e0/54d/8d6/4e054d8d6942928dcdf3603b448b83a8.png"><br><br><img src="https://habrastorage.org/storage2/6b6/a61/85f/6b6a6185f277c335ac5bea865b528a02.png"><br><br><h4>  Conclusion and conclusions </h4><br>  Now it is time to return to the beginning of the article and remember that our goal was to improve the quality of the product.  What information can we gather from the collected statistics?  Analyzing the statistics obtained for a certain period, it is natural to ask: has it become better or worse?  After all, our goal, as we indicated earlier, is to convert quantitative characteristics into qualitative ones. <br><br>  Here it is appropriate to recall two simple laws: <br><ol><li>  The Weber-Fechner law, which states that the intensity of the sensation is proportional to the logarithm of the intensity of the stimulus.  Or otherwise: the difference in sensations appears if the stimuli differ by a certain fraction of their magnitude, and not by an absolute value. </li><li>  The absolute threshold of human perception of time is approximately 15 ms. </li></ol><br>  For periods of time lasting up to 30 s, the threshold of perception of the difference is approximately 20%.  In other words, users do not notice regression or acceleration within 20% of the current value.  The user can detect the difference of more than 20%, but if this difference is less than the minimum perception threshold of time, then it will pass unnoticed. <br><br><h4>  findings </h4><br><ol><li>  The quality of the application can be reduced to a set of quantitative characteristics.  In our case, the quality of upstream work can be reduced to response time and HTTP responses with different statuses. </li><li>  Analysis of these characteristics is conveniently carried out by modules for nginx. </li><li>  As a working tool, we use nginx-sla as the most flexible and undemanding module in comparison with analogues. </li><li>  nginx-sla allows you to group statistical information and, thus, convert quantitative data into values ‚Äã‚Äãsuitable for qualitative analysis (mean, floating average, quantile). </li><li>  The collected statistics are analyzed in order to exceed the limit values ‚Äã‚Äãspecified by the standard and are compared with the human time perception threshold.  The conclusion is made about the need for further action. </li></ol><br>  <b>PS</b> The module has enough time without any complaints in production.  Feedback, bugs, pull-requests are welcome. </div><p>Source: <a href="https://habr.com/ru/post/177215/">https://habr.com/ru/post/177215/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../177191/index.html">Zingaya's free iOS mobile app</a></li>
<li><a href="../177197/index.html">Turing's biggest test</a></li>
<li><a href="../177201/index.html">Porting the Genode OS Framework to a new hardware platform</a></li>
<li><a href="../177203/index.html">22 years in orbit</a></li>
<li><a href="../177209/index.html">High-capacity 3600mAh HLI-820XL Battery for Nokia Lumia 820</a></li>
<li><a href="../177217/index.html">Knowledge Base. Part 2. Freebase: making requests to the Google Knowledge Graph</a></li>
<li><a href="../177219/index.html">ASP.NET MVC and unobtrusive validation with Backbone.js</a></li>
<li><a href="../177221/index.html">MS SQL: generating pseudo-random data using newID (). Opportunities and pitfalls</a></li>
<li><a href="../177223/index.html">Racoon vs. OpenSWAN: Configuring IPSEC VPN HOST-TO-SITE Tunnel with Cisco and L2TP over IPSEC for Windows, iOS and Android</a></li>
<li><a href="../177225/index.html">Time management on a personal example: 10 theses</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>