<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Second order virtualization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="UPDATE (2016-01-28) : now there is a Docker for this. 

 What to do when you need a bunch of small and cheap servers to test different versions of dif...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Second order virtualization</h1><div class="post__text post__text-html js-mediator-article">  <b>UPDATE (2016-01-28)</b> : now there is a <a href="https://habrahabr.ru/post/277699/">Docker</a> for this. <br><br>  What to do when you need a bunch of small and cheap servers to test different versions of different sites?  You can buy a Dedik and put OpenVZ on it.  Although, OpenVZ will be somehow rather small - there is a lot of memory.  Better put XEN.  Or KVM.  Or even VMWare. <br><a name="habracut"></a>  And we start all this admin?  - Of course not. <br><br><h4>  Virtualization my love </h4><br>  I'll start from afar, the first post is.  More than six years ago, I did change one huge and expensive iron server into several small virtual ones.  At that time, the masterhost was still a cake, and he had virtuals only under Virtuozzo (however, as now).  So met.  Time passed, the technology of containers fascinated me with its simplicity: the file system in a simple folder, full backups with one click, stable kernels from the hoster and, most importantly, no problems with hardware.  A dream come true man who never collected the server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But when it becomes necessary to go beyond the limitations of twuh-three convenient tariffs for the hoster, grief begins.  In my case, it took a lot of small servers created on the fly that run different versions of the site for each branch in the repository.  It takes a bit of memory, a little disk too, the processor and the network are used occasionally.  And most importantly, the server must be able to create from a script.  And best of all, fast. <br><br>  And with this there are difficulties.  First of all, serious guys with their API (Linode, Amazon) use XEN from 20 bucks for a server with a bunch of everything superfluous.  This is not an option.  Secondly, cheap hosting services constantly lag and fall off, even if they learn to create servers from them automatically.  Also not an option.  And all this is logical, because expensive hosters are expensive because they can do everything and work stably. <br><br>  And what if to get cheap containers on an expensive hosting?  Beginning with ubuntu 12.04, this is easier to do with steamed turnips: using Linux Containers, which have been living in the vanilla kernel for several years.  In the case of the server from Linode, this is a pair of <code>apt-get</code> s, a small patch, a reboot and 300 MB of space. <br><br><h4>  Vanilla core </h4><br>  Let's start: <br><pre> <code class="bash hljs">sudo apt-get update &amp;&amp; sudo apt-get upgrade</code> </pre><br>  Put the LXC scripts: <br><pre> <code class="bash hljs">sudo apt-get install lxc</code> </pre><br>  And check for Linux Containers kernel support: <br><pre> <code class="bash hljs">sudo lxc-checkconfig</code> </pre><br>  The current pre-default core of the linods supports containers in a very partial way.  Put the vanilla core from ubunt: <br><pre> <code class="bash hljs">sudo apt-get install linux-virtual</code> </pre><br>  <code>virtual</code> because you need XEN support. <br><br>  Moving on according <a href="http://www.linode.com/wiki/index.php/PV-GRUB">to the PV-GRUB</a> instructions: <br><pre> <code class="bash hljs">sudo apt-get install grub-legacy-ec2</code> </pre><br>  When the hornbeam installer asked the question "where to put", I chose xvda. <br><br>  Next we package `/ boot / grub / menu.lst` (towards the end of the file): <br><pre> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">- # defoptions=console=hvc0 + # defoptions=console=hvc0 rootflags=nobarrier</span></span></code> </pre><br>  and update the hornbeam config: <br><pre> <code class="bash hljs">sudo update-grub-legacy-ec2</code> </pre><br><br>  Everything, the container is ready to load the vanilla kernel.  It remains only to ask our linode to boot in accordance with the hornbeam config.  To do this, go to the virtual server profile editor, look at the kernel bit size (I have the <code>Latest 32 bit</code> ) and select the corresponding <code>pv-grub-*</code> (I have <code>pv-grub-x86_32</code> ).  Next, save the profile and restart the server. <br><br><h4>  Container </h4><br>  Now you can check the LXC support in the kernel: <br><pre> <code class="bash hljs">sudo lxc-checkconfig</code> </pre><br>  and enjoy all the green points. <br><br>  A new network interface will appear in the system: <br><pre> <code class="bash hljs">ifconfig | grep lxc</code> </pre><br>  which will combine all the containers and release them on the Internet. <br><br>  Finally, create the first container: <br><pre> <code class="bash hljs">sudo lxc-create -t ubuntu -n demo1</code> </pre><br>  For the first time, this process will take about five minutes, since <code>lxc-create</code> will collect a new ubuntu in the <code>/var/cache/lxc/</code> , and then copy it to the <code>/var/lib/lxc/demo1/rootfs/</code> , where it will live our new container. <br><br>  You can launch the container and get into its console like this ( <code>ubuntu</code> login and password): <br><pre> <code class="bash hljs">sudo lxc-start -n demo1</code> </pre><br>  Go out, offer by pressing <code>Ctrl+AQ</code> .  It is not possible to exit <code>lxc-start</code> this way, but you can simply close the terminal window.  In the future, you can open the container console like this (login and password are the same): <br><pre> <code class="bash hljs">sudo lxc-console -n demo1</code> </pre><br>  It remains only to configure the launch of the container at startup: <br><pre> <code class="bash hljs">sudo ln -s /var/lib/lxc/demo1/config /etc/lxc/auto/demo1.conf</code> </pre><br><br><h4>  Container window </h4><br>  Now you need to somehow get to the site inside the container.  Since it does not have a public IP, you will have to be wise. <br>  You can pick <code>iptables</code> , because the containers are still on the same machine.  Or disable network virtualization altogether, then all containers will have a common network interface with a virtual machine.  But today, I am not ready to smoke such strong mana.  Better, we will do the same as with any other private cluster: we will proxy HTTP requests to internal nodes.  Today I have experience only with nginx proxying, and I will describe it.  But if your site uses web sockets, then you need to proxy using <a href="http://haproxy.1wt.eu/">HAproxy</a> , since nginx is going to gain their support only in early 2013. <br><br>  So, the config for nginx: <br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">user</span></span> nobody nogroup; <span class="hljs-attribute"><span class="hljs-attribute">worker_processes</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-section"><span class="hljs-section">events</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">worker_connections</span></span> <span class="hljs-number"><span class="hljs-number">1024</span></span>; } <span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">keepalive_timeout</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> demo.example.com; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> <span class="hljs-number"><span class="hljs-number">10.3.0.2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_redirect</span></span> http://localhost/ http://<span class="hljs-variable"><span class="hljs-variable">$host</span></span>:<span class="hljs-variable"><span class="hljs-variable">$server_port</span></span>/; <span class="hljs-attribute"><span class="hljs-attribute">proxy_buffering</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; } } }</code> </pre><br>  Everything is simple: nginx receives a request for port 80 of the virtual machine and sends it to port 80 of the container with the address 10.3.0.2.  The answer is not buffering, and then nginx likes to add pictures first to disk, and then to the network.  The <code>server</code> section will need to be repeated for each site / container pair, changing <code>server_name</code> and <code>proxy_pass</code> to suit your situation.  I am sure everyone can write a script for this. <br><br><h4>  Performance </h4><br>  On the one hand, what is there to talk about?  Well this is a server for demos and developer research.  On the other hand, the containers are so good that they do not add complex abstractions.  The processor all receive in its original form, memory, too.  Probably a bit spent on the file system isolation logic, and then only when opening a file.  Here is the network, yes, virtual, but only at the IP level, no one emulates a network card.  In the comments <a href="https://habrahabr.ru/users/inkvizitor68sl/" class="user_link">inkvizitor68sl</a> calls 1-2% loss.  I believe that for an ordinary site there will be even less.  Of course, if you enable quoting, then a lot will change.  But accounting and limiting resource consumption is always worth something.  Because my containers are not limited to anything, they are simply isolated, so that it is more convenient to deploy a bunch of small sites from the script.  That's all. <br><br><h4>  Deep conclusions </h4><br>  Cool! <br><br>  Oh yes.  Solaris and Frya, a hundred years already, they know how out of the box.  And the same can be done on OpenVZ (even inside LXC). </div><p>Source: <a href="https://habr.com/ru/post/162105/">https://habr.com/ru/post/162105/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../162093/index.html">EPAM IT Share # 3: Search for related images. Define Cloud Computing</a></li>
<li><a href="../162095/index.html">Answers Minister of Communications to the questions of users: part 1</a></li>
<li><a href="../162097/index.html">Far Cry 3 video review</a></li>
<li><a href="../162101/index.html">This country can not be defeated. Post of Russia</a></li>
<li><a href="../162103/index.html">2013: Countdown to Rails 4</a></li>
<li><a href="../162107/index.html">Browser performance for Android. Part 1: Calculations on pure javascript</a></li>
<li><a href="../162109/index.html">MegaCloud - alternative to Dropbox</a></li>
<li><a href="../162115/index.html">Revel - a high-performance web framework in the language of Go</a></li>
<li><a href="../162117/index.html">Channel One goes to HD</a></li>
<li><a href="../162121/index.html">How much does it cost to create an application or the whole truth about money</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>