<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Binary serialization in Unity3d</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Faced with a rather trivial problem. Serialize and de-serialize data. 

 Task 
 There is a client server application. Client - Unity3d server PhotonSe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Binary serialization in Unity3d</h1><div class="post__text post__text-html js-mediator-article">  Faced with a rather trivial problem.  Serialize and de-serialize data. <br><br><h5>  Task </h5><br>  There is a client server application.  Client - Unity3d server PhotonServer.  There is a model that must be equivalent on both the client and the server.  It is required to synchronize the state of the model and, possibly, additional classes. <br><br><h5>  Decision </h5><br><h6>  Protobuf </h6><br>  The most logical solution is to use a binary protocol.  This is a clear favorite - ptotobuf (using proto-net 668).  It does not support web build, but it is a valid victim.  Mark out the required classes.  I check.  Everything works, small size and fast in work.  Gorgeous.  But! <br><a name="habracut"></a><br>  At one point, Protobuf spat out an ekzepchen, saying that such a class was not found.  Like this? <br>  <a href="https://code.google.com/p/protobuf-net/issues/detail%3Fid%3D455%26start%3D200">Bug</a> detail with sample code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      He began to solve this problem in various ways.  There is an option to feed the Protobuf types.  Which is no longer good.  You can make a lot of mistakes or forget to specify one or another type.  Moreover, Protobuf does not support multi-dimensional arrays. <br><br>  Sadly, but Protobuf will have to the side.  By the way, I once tried to use Protobuf in a bunch of php and Unity.  From the php side, the implementation of Protobuf turned out to be quite buggy.  As a result, in php and Unity used json.  It worked, because between php and Unity there were pretty simple data structures. <br><br><h6>  Message pack </h6><br>  There is another remarkable serializer.  There are implementations for a huge number of languages.  Wonderful.  Decided to try.  The primitive type was serializing normally.  The size is 18 bytes against my 41 bytes, against 19 bytes of protobuf and against 44 bytes of json.  Excellent result.  What is the trick?  The official site has an example of how it actually packs everything.  Here is the <a href="">link</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Serializable, ProtoContract()</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TTT</span></span> { [TDataMember, ProtoMember(<span class="hljs-number"><span class="hljs-number">1</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s = <span class="hljs-string"><span class="hljs-string">"compact"</span></span>; [TDataMember, ProtoMember(<span class="hljs-number"><span class="hljs-number">2</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> f = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; [TDataMember, ProtoMember(<span class="hljs-number"><span class="hljs-number">3</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s2 = <span class="hljs-string"><span class="hljs-string">"schema"</span></span>; [TDataMember, ProtoMember(<span class="hljs-number"><span class="hljs-number">4</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br></div></div><br>  But a complex example that will not be further mastered by the message pack and protobuf. <br><br>  Examples of errors. <br><br><div class="spoiler">  <b class="spoiler_title">Message pack</b> <div class="spoiler_text"><pre> <code class="cs hljs">PlatformNotSupportedException: On-the-fly <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> serializer generation <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> not supported <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Unity iOS. Use pre-generated serializer instead. MsgPack.Serialization.ReflectionSerializers.ReflectionSerializerHelper.CreateReflectionEnuMessagePackSerializer[State] (MsgPack.Serialization.SerializationContext context) MsgPack.Serialization.MessagePackSerializer.CreateReflectionInternal[State] (MsgPack.Serialization.SerializationContext context) MsgPack.Serialization.MessagePackSerializer.CreateReflectionInternal (MsgPack.Serialization.SerializationContext context, System.Type targetType) MsgPack.Serialization.SerializationContext.GetSerializer (System.Type targetType, System.Object providerParameter) MsgPack.Serialization.ReflectionSerializers.ReflectionSerializerHelper.GetMetadata (MsgPack.Serialization.SerializationContext context, System.Type targetType, System.Func`<span class="hljs-number"><span class="hljs-number">2</span></span>[]&amp; getters, System.Action`<span class="hljs-number"><span class="hljs-number">2</span></span>[]&amp; setters, System.Reflection.MemberInfo[]&amp; memberInfos, MsgPack.Serialization.DataMemberContract[]&amp; contracts, MsgPack.Serialization.IMessagePackSerializer[]&amp; serializers) MsgPack.Serialization.ReflectionSerializers.ReflectionObjectMessagePackSerializer`<span class="hljs-number"><span class="hljs-number">1</span></span>[TestS+TestC]..ctor (MsgPack.Serialization.SerializationContext context) MsgPack.Serialization.MessagePackSerializer.CreateReflectionInternal[TestC] (MsgPack.Serialization.SerializationContext context) MsgPack.Serialization.SerializationContext.GetSerializer[TestC] (System.Object providerParameter) MsgPack.Serialization.SerializationContext.GetSerializer[TestC] () <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> [,] string ArgumentException: 'System.String[,]' is not compatible for 'System.String[]'. Parameter name: objectTree MsgPack.Serialization.MessagePackSerializer`1[System.String[]].MsgPack.Serialization.IMessagePackSerializer.PackTo (MsgPack.Packer packer, System.Object objectTree) MsgPack.Serialization.ReflectionSerializers.ReflectionObjectMessagePackSerializer`1[TestS+TestC].PackMemberValue (MsgPack.Packer packer, .TestC objectTree, Int32 index) MsgPack.Serialization.ReflectionSerializers.ReflectionObjectMessagePackSerializer`1[TestS+TestC].PackToCore (MsgPack.Packer packer, .TestC objectTree) MsgPack.Serialization.MessagePackSerializer`1[TestS+TestC].PackTo (MsgPack.Packer packer, .TestC objectTree) MsgPack.Serialization.MessagePackSerializer`1[TestS+TestC].Pack (System.IO.Stream stream, .TestC objectTree) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> etc SerializationException: Non generic collection may contain only MessagePackObject type. MsgPack.Serialization.DefaultSerializers.NonGenericEnumerableSerializerBase`1[T].PackToCore (MsgPack.Packer packer, .T objectTree) MsgPack.Serialization.MessagePackSerializer`1[T].MsgPack.Serialization.IMessagePackSerializer.PackTo (MsgPack.Packer packer, System.Object objectTree) MsgPack.Serialization.ReflectionSerializers.ReflectionCollectionSerializer`1[System.Collections.ArrayList].PackToCore (MsgPack.Packer packer, System.Collections.ArrayList objectTree) MsgPack.Serialization.MessagePackSerializer`1[System.Collections.ArrayList].MsgPack.Serialization.IMessagePackSerializer.PackTo (MsgPack.Packer packer, System.Object objectTree) MsgPack.Serialization.ReflectionSerializers.ReflectionObjectMessagePackSerializer`1[TestS+TestC].PackMemberValue (MsgPack.Packer packer, .TestC objectTree, Int32 index) MsgPack.Serialization.ReflectionSerializers.ReflectionObjectMessagePackSerializer`1[TestS+TestC].PackToCore (MsgPack.Packer packer, .TestC objectTree) MsgPack.Serialization.MessagePackSerializer`1[TestS+TestC].PackTo (MsgPack.Packer packer, .TestC objectTree) MsgPack.Serialization.MessagePackSerializer`1[TestS+TestC].Pack (System.IO.Stream stream, .TestC objectTree)</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Protobuf-net</b> <div class="spoiler_text"><pre> <code class="cs hljs">NotSupportedException: Multi-dimension arrays are supported ProtoBuf.Meta.MetaType.ResolveListTypes (ProtoBuf.Meta.TypeModel model, System.Type type, System.Type&amp; itemType, System.Type&amp; defaultType) ProtoBuf.Meta.MetaType.ApplyDefaultBehaviour (Boolean isEnum, ProtoBuf.ProtoMemberAttribute normalizedAttribute) ProtoBuf.Meta.MetaType.ApplyDefaultBehaviour () ProtoBuf.Meta.RuntimeTypeModel.FindOrAddAuto (System.Type type, Boolean demand, Boolean addWithContractOnly, Boolean addEvenIfAutoDisabled) ProtoBuf.Meta.RuntimeTypeModel.GetKey (System.Type type, Boolean demand, Boolean getBaseKey)</code> </pre><br></div></div><br><h6>  Json </h6><br>  So, Protobuf is not suitable.  What to use?  Json?  Why not.  Here is the second problem: Jason does not know how to serialize interface type fields and abstract classes.  It does not matter, using Google found how to "teach" him to do it.  In the final file there was data on the type of the field and its data (with the assembly indicated, this is important; why - it is written further).  But for deserialization, this field is for some reason zero.  Google again.  After all, if taught to serialize, then you can deserialize.  It turns out the same crutch as with Protobuf.  This option is not suitable.  I used the JSON assembly .NET For Unity, which is in the assetmarket. <br><br>  Bottom line: Json is good for non-complex structures.  But when there are fields like abstract class or interface, problems arise with it. <br><br><h6>  XML </h6><br>  In any variation of xml - quite cumbersome.  Therefore, I decided not to consider.  Although part of the project in xml.  For example, the localization system. <br><br><h6>  BinaryFormatter </h6><br>  Decided to turn to standard tools.  Marked up the code, serialized.  Success!  A large file size, however, is not good.  Do not worry, go through more and compression.  Used LZMA.  Won a little in size, but lost on the speed of work.  Valid sacrifice.  Now build.  Drumroll.  Web not supported, trouble ... <br><br>  Now arrange the exchange between the client and the server.  And ... Another FAIL.  The fact is that the assemblies of the classes are different, although the classes are the same.  In a unit its own assembly on its own photon.  Can be solved through the crutch method.  Zabindit assemblies and manually rename them, but the assembly falls into a binary file.  Why is she needed there? <br><br>  I decided that I would come back to this method, I looked through a couple more serializers.  One of them is Sharpe the serializer.  I was able to serialize the interface type fields, but also prescribe the assembly and is not supported on the web.  Then I decided to first formulate the requirements for the serializer. <br><br><div class="spoiler">  <b class="spoiler_title">Primitive type test</b> <div class="spoiler_text"><pre> <code class="cs hljs"> TTT c = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TTT(); TSerizalization serizalization = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TSerizalization(); bytes = serizalization.Serizalize(c, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); System.IO.File.WriteAllBytes(<span class="hljs-string"><span class="hljs-string">"d:\\s.dat"</span></span>, bytes); Debug.LogError(<span class="hljs-string"><span class="hljs-string">"T complete "</span></span> + bytes.Length ); json = JsonConvert.SerializeObject(c); System.IO.File.WriteAllText(<span class="hljs-string"><span class="hljs-string">"d:\\s.json"</span></span>, json); Debug.LogError(<span class="hljs-string"><span class="hljs-string">"J complete "</span></span> + json.Length); System.Runtime.Serialization.Formatters.Binary.BinaryFormatter formater = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Runtime.Serialization.Formatters.Binary.BinaryFormatter(); formater.AssemblyFormat = System.Runtime.Serialization.Formatters.FormatterAssemblyStyle.Full; System.IO.MemoryStream mstream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.IO.MemoryStream(); formater.Serialize(mstream, c); Debug.LogError(<span class="hljs-string"><span class="hljs-string">"B complete "</span></span> + mstream.ToArray().Length); System.IO.File.WriteAllBytes(<span class="hljs-string"><span class="hljs-string">"d:\\s2.dat"</span></span>, mstream.ToArray()); mstream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.IO.MemoryStream(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serializer = MsgPack.Serialization.SerializationContext.Default.GetSerializer&lt;TTT&gt;(); serializer.Pack(mstream, c); System.IO.File.WriteAllBytes(<span class="hljs-string"><span class="hljs-string">"d:\\s3.dat"</span></span>, mstream.ToArray()); Debug.LogError(<span class="hljs-string"><span class="hljs-string">"M complete "</span></span> + mstream.ToArray().Length); mstream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.IO.MemoryStream(); ProtoBuf.Serializer.Serialize&lt;TTT&gt;(mstream, c); System.IO.File.WriteAllBytes(<span class="hljs-string"><span class="hljs-string">"d:\\s4.dat"</span></span>, mstream.ToArray()); Debug.LogError(<span class="hljs-string"><span class="hljs-string">"P complete "</span></span> + mstream.ToArray().Length);</code> </pre><br></div></div><br><h4>  Serializer requirements </h4><br>  The required serializer should be able to: <br><ul><li>  Serialize to binary format; </li><li>  Serialize to small size; </li><li>  Serialize classes using specific assemblies (the assembly information is not necessarily needed in the file); </li><li>  Serialize custom classes; </li><li>  Maintain arrays; </li><li>  Work in the web version of the unit; </li><li>  Work with a photon. </li></ul><br>  From those serializers that I tried.  These requirements more or less corresponded only to Json and protobuf of the earlier version. <br><br><h4>  Own serializer </h4><br>  Began to google.  But to no avail.  What to do? <br>  Using a standard solution is not a good option.  Big size.  Platform problems. <br>  Then I decided, under the above written requirements, to write my own serializer.  Why not.  It turned out to be much more efficient than disassembling and testing one or another serializer. <br><br>  Where better to start? <br><br>  How to save objects and how to load them.  In this regard, I liked the protobuf-net 668 approach. Namely, mark the required fields and properties.  Also mark and methods that will be called before serialization and after deserialization. <br><br><h6>  Map </h6><br>  First you need to save the map.  Namely - the key and type.  So that on this map you can then restore the object.  For standard types, the value is &lt;0 and for user types, respectively&gt; 0. Key size is int16. <br><br><div class="spoiler">  <b class="spoiler_title">Map</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TMap</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;Type, <span class="hljs-keyword"><span class="hljs-keyword">short</span></span>&gt; StandartTypes { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;Type, <span class="hljs-keyword"><span class="hljs-keyword">short</span></span>&gt; DataBase { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">short</span></span>, Type&gt; DataBaseTags { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } ... }</code> </pre><br></div></div><br>  Collections rendered into separate tags to logically separate. <br><br><h6>  TData many objects </h6><br>  Now you need to get all the fields and properties.  Pack them in your structure to assign tags to them. <br><br><div class="spoiler">  <b class="spoiler_title">Many objects</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TData</span></span> : <span class="hljs-title"><span class="hljs-title">TContainerBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;TData&gt; childrens = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;TData&gt;(); ... }</code> </pre><br></div></div><br>  Since there may be arrays, I add information about the array measure to the container. <br><br><div class="spoiler">  <b class="spoiler_title">Base Container Description</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TContainerBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> Tag { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ArrayRank { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; ArrayDimension { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } ...</code> </pre><br></div></div><br>  I did not specifically divide into a container of type a collection and a container of type an object.  All data is presented as a set.  What is an array, if the object means the rank and dimension in zeros. <br><br>  Now you need a container in which the object itself will be restored. <br><br><div class="spoiler">  <b class="spoiler_title">Container</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TContainer</span></span> : <span class="hljs-title"><span class="hljs-title">TContainerBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Size { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; List { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } ...</code> </pre><br></div></div><br>  Further.  With data structures complete.  Now you need to fill them. <br><br>  First type map and object map.  For this you need a class that will unite all this.  I create additional abstract classes for writing and reading.  This is in case, for example, if you need to add another format.  Same json or xml. <br><br><div class="spoiler">  <b class="spoiler_title">Reading write</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TReaderBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> T Read&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytes, Assembly assembly); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TWriterBase</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Write</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TMap map, TData data</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br></div></div><br>  Perhaps, then they will have additional methods to write to the stream and read from the stream.  But so far it is not necessary.  Now we glue it all into one class. <br><br><div class="spoiler">  <b class="spoiler_title">T serialization</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TSerizalization</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> TMap map; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> TWriterBase writer; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> TReaderBase reader; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TSerizalization</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { writer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TBinaryWriter(); reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TBinaryReader(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Serialize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> target, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> callBeforeSerializationMethods = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> T Deserialize&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytes, Assembly assembly, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> callAfterDeserializationMethods = <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> TData </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Read</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> obj</span></span></span><span class="hljs-function">) }</span></span></code> </pre><br></div></div><br><h4>  Test </h4><br>  Is done.  We now turn to the tests.  Caution many data sets. <br><br><div class="spoiler">  <b class="spoiler_title">Test</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IClass</span></span> { } [System.Serializable ] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TestC</span></span> : <span class="hljs-title"><span class="hljs-title">IClass</span></span> { [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = <span class="hljs-number"><span class="hljs-number">10</span></span>; [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b = <span class="hljs-number"><span class="hljs-number">12</span></span>; [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s= <span class="hljs-string"><span class="hljs-string">"Hello World"</span></span>; [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> State state = State.Close; [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime dt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(); [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Type type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IClass); [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[,] arr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[,] { {<span class="hljs-string"><span class="hljs-string">"1111"</span></span>, <span class="hljs-string"><span class="hljs-string">"2222"</span></span>, <span class="hljs-string"><span class="hljs-string">"3333"</span></span>, <span class="hljs-string"><span class="hljs-string">"4444"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"aaaa"</span></span>, <span class="hljs-string"><span class="hljs-string">"bbbb"</span></span>, <span class="hljs-string"><span class="hljs-string">"cccc"</span></span>, <span class="hljs-string"><span class="hljs-string">"dddd"</span></span> }, {<span class="hljs-string"><span class="hljs-string">"321"</span></span>, <span class="hljs-string"><span class="hljs-string">"32"</span></span>, <span class="hljs-string"><span class="hljs-string">"2qfs"</span></span>, <span class="hljs-string"><span class="hljs-string">"12f"</span></span> } }; [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> classD = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestC2(); [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TestC1[] array1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestC1[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestC1(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestC2(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestC2() }; [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayList arr2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[]{ <span class="hljs-string"><span class="hljs-string">"list1"</span></span>, <span class="hljs-string"><span class="hljs-string">"list2"</span></span> }); [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; list = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;() { <span class="hljs-string"><span class="hljs-string">"list Item 1"</span></span>, <span class="hljs-string"><span class="hljs-string">"List Item 2"</span></span> }; [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; dic = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;() { {<span class="hljs-string"><span class="hljs-string">"one"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-string"><span class="hljs-string">"two"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>}, {<span class="hljs-string"><span class="hljs-string">"three"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>}, {<span class="hljs-string"><span class="hljs-string">"four"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>} }; [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Hashtable ht = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Hashtable() { {<span class="hljs-string"><span class="hljs-string">"H one"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-string"><span class="hljs-string">"H two"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>}, {<span class="hljs-string"><span class="hljs-string">"H three"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>}, {<span class="hljs-string"><span class="hljs-string">"H four"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>} }; [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> SortedList&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; sl = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SortedList&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;() { {<span class="hljs-string"><span class="hljs-string">"S one"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-string"><span class="hljs-string">"S two"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>}, {<span class="hljs-string"><span class="hljs-string">"S three"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>}, {<span class="hljs-string"><span class="hljs-string">"S four"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>} }; [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt; dic3 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>,List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt;() { {<span class="hljs-string"><span class="hljs-string">"&gt;&gt; 1"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(){<span class="hljs-string"><span class="hljs-string">"a1"</span></span>, <span class="hljs-string"><span class="hljs-string">"a2"</span></span>, <span class="hljs-string"><span class="hljs-string">"a3"</span></span>} }, {<span class="hljs-string"><span class="hljs-string">"&gt;&gt; 2"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(){<span class="hljs-string"><span class="hljs-string">"b1"</span></span>, <span class="hljs-string"><span class="hljs-string">"b2"</span></span>, <span class="hljs-string"><span class="hljs-string">"b3"</span></span>} }, {<span class="hljs-string"><span class="hljs-string">"&gt;&gt; 3"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(){<span class="hljs-string"><span class="hljs-string">"c1"</span></span>, <span class="hljs-string"><span class="hljs-string">"c2"</span></span>, <span class="hljs-string"><span class="hljs-string">"c3"</span></span>} } }; [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt; l = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(){<span class="hljs-string"><span class="hljs-string">"a1"</span></span>, <span class="hljs-string"><span class="hljs-string">"a2"</span></span>, <span class="hljs-string"><span class="hljs-string">"a3"</span></span>}, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(){<span class="hljs-string"><span class="hljs-string">"b1"</span></span>, <span class="hljs-string"><span class="hljs-string">"b2"</span></span>, <span class="hljs-string"><span class="hljs-string">"b3"</span></span>}, }; [ProtoMember(<span class="hljs-number"><span class="hljs-number">16</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt; dic4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt;() { {<span class="hljs-string"><span class="hljs-string">"&gt;&gt; 1"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;() { { <span class="hljs-string"><span class="hljs-string">"a1"</span></span>, <span class="hljs-string"><span class="hljs-string">"a2"</span></span>}, { <span class="hljs-string"><span class="hljs-string">"a2"</span></span>, <span class="hljs-string"><span class="hljs-string">"a3"</span></span>} } }, {<span class="hljs-string"><span class="hljs-string">"&gt;&gt; 2"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;() { { <span class="hljs-string"><span class="hljs-string">"a1"</span></span>, <span class="hljs-string"><span class="hljs-string">"a2"</span></span>}, { <span class="hljs-string"><span class="hljs-string">"a2"</span></span>, <span class="hljs-string"><span class="hljs-string">"a3"</span></span>} } } }; [ProtoMember(<span class="hljs-number"><span class="hljs-number">17</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt; Dic4 {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} [ProtoMember(<span class="hljs-number"><span class="hljs-number">18</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; dic333 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;() { {<span class="hljs-string"><span class="hljs-string">":@"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(){<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-string"><span class="hljs-string">"3"</span></span>}}, {<span class="hljs-string"><span class="hljs-string">":@2"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestC2()}, {<span class="hljs-string"><span class="hljs-string">":@222"</span></span>, <span class="hljs-string"><span class="hljs-string">"sff"</span></span>} }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestC</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Dic4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>,Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt;() { {<span class="hljs-string"><span class="hljs-string">"&gt;&gt; 1"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;() { { <span class="hljs-string"><span class="hljs-string">"a1"</span></span>, <span class="hljs-string"><span class="hljs-string">"a2"</span></span>}, { <span class="hljs-string"><span class="hljs-string">"a2"</span></span>, <span class="hljs-string"><span class="hljs-string">"a3"</span></span>} } }, {<span class="hljs-string"><span class="hljs-string">"&gt;&gt; 2"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;() { { <span class="hljs-string"><span class="hljs-string">"a1"</span></span>, <span class="hljs-string"><span class="hljs-string">"a2"</span></span>}, { <span class="hljs-string"><span class="hljs-string">"a2"</span></span>, <span class="hljs-string"><span class="hljs-string">"a3"</span></span>} } } }; } } [Serializable] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TestC1</span></span> : <span class="hljs-title"><span class="hljs-title">IClass</span></span> { [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> value1 = <span class="hljs-number"><span class="hljs-number">10</span></span>; [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> value2 = <span class="hljs-number"><span class="hljs-number">12</span></span>; } [Serializable ] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TestC2</span></span> : <span class="hljs-title"><span class="hljs-title">TestC1</span></span> { [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> a1 = <span class="hljs-number"><span class="hljs-number">10</span></span>; [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> b2 = <span class="hljs-number"><span class="hljs-number">12</span></span>; [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> str = <span class="hljs-string"><span class="hljs-string">"Class 1"</span></span>; [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> State state = State.Close; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestC2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } [TAfterDeserialization] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">After</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } [TBeforeSerialization] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Before</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TestC33</span></span> { [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> b2 = <span class="hljs-number"><span class="hljs-number">12</span></span>; [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TestC2 tt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestC2(); [ To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TestC1[] array1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestC1[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestC1(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestC2(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestC2() }; [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> classD = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestC2(); [To2dnd.TDataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Type type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IClass); }</code> </pre><br></div></div><br><br>  Video test: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/QhyGAYzRG5g%3Ffeature%3Doembed&amp;xid=17259,15700021,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjYRll_Jxf5lJeQ0vO30IYzdVUElA" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  Total </h4><br>  In terms of file size, of course, Protobuf and messagepack lose.  After all, I save the type map and do not use clever frauds with bit shifting or string conversion ‚Äúbyte [] bytes = Encoding.UTF7.GetBytes ((string) data.value)‚Äù.  This is an additional burden, perhaps later expand in the form of variation.  Tested data exchange between photon and unit.  Works as expected.  After all, I create a type relative to the assembly, which is a parameter in the Deserialize method. <br><br>  Ready-made solutions, which are so many on the Internet, did not fit the requirements.  So I had to invent a bicycle.  Who justified the time spent on him.  It can be expanded to improve. <br><br><h4>  Conclusion </h4><br>  If you use primitive types, then any of the considered serializers will suit you.  For primitives, I would still prefer Protobuf.  But for complex data types, ready-made solutions are not always suitable. <br><br><h4>  Links </h4><br>  <a href="https://code.google.com/p/protobuf-net">Protobuf</a> <br>  <a href="https://www.assetstore.unity3d.com/en/">Unity3d json</a> <br>  <a href="https://msdn.microsoft.com/en-us/library/system.runtime.serialization.serializationbinder.aspx">MSDN binary formatter</a> <br>  <a href="http://msgpack.org/">Message pack</a> <br>  <a href="http://theburningmonk.com/2011/12/performance-test-binary-serializers-part-ii/">Checkmarks</a> </div><p>Source: <a href="https://habr.com/ru/post/255399/">https://habr.com/ru/post/255399/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255387/index.html">Application of parallel algorithms in the 1C Enterprise environment</a></li>
<li><a href="../255389/index.html">Exploring JavaScript Symbols. Use of symbols</a></li>
<li><a href="../255391/index.html">Ubiquiti EdgeRouter X</a></li>
<li><a href="../255393/index.html">We invite students to Imagine Day: April 18 in Moscow</a></li>
<li><a href="../255397/index.html">We built RecyclerView in CardView</a></li>
<li><a href="../255403/index.html">Version Control for Designers</a></li>
<li><a href="../255405/index.html">ThinkServer RD650: Anatomy of a New Generation Server from Lenovo</a></li>
<li><a href="../255407/index.html">Real-world tasks: how in practice do systems consider reliability (reliability, MTTF, failure rate)?</a></li>
<li><a href="../255409/index.html">Backup and Restore Virtualized Microsoft Exchange Using Veeam Backup & Replication</a></li>
<li><a href="../255411/index.html">Overview of wireless Wi-Fi camera Oco for office and home</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>