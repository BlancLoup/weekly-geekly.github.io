<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Zabbix Review: how to organize code review for monitoring configuration</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Code review - engineering practice in terms of flexible development methodology. This analysis (inspection) of the code in order to identify errors, s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Zabbix Review: how to organize code review for monitoring configuration</h1><div class="post__text post__text-html js-mediator-article"><p>  Code review - engineering practice in terms of flexible development methodology.  This analysis (inspection) of the code in order to identify errors, shortcomings, discrepancies in the style of writing the code and understanding whether the code solves the task. </p><br><p><img src="https://habrastorage.org/webt/ek/rm/ur/ekrmurfptreli-wzvyrdbwm6ycg.png"></p><br><p>  Today I will talk about how we organized the review process for monitoring configuration in Zabbix.  The article will be useful to those who work with the monitoring system Zabbix, both in a large team and alone, even if you have ‚Äúten hosts, what is there to review‚Äù. </p><a name="habracut"></a><br><h1 id="kakie-problemy-reshaem">  What problems we solve </h1><br><p>  We use Zabbix to monitor our internal services and build infrastructure.  We have a naming convention - <strong>name convention</strong> (we <a href="https://habr.com/company/pt/blog/325276/">use a role model with Role allocation, Profile</a> templates for monitoring), but there is no dedicated monitoring team (there are senior engineers who ‚Äúate the dog‚Äù in monitoring matters), there are engineers and junior engineers, ~ 500 hosts, ~ 150 templates (small, but very dynamic infrastructure). </p><br><p>  This infrastructure is used to support and <a href="https://habr.com/company/pt/blog/343884/">automate the development processes in the company</a> , in addition to its support, we also develop automation and integration tools, so we have little experience and understanding of the development processes from the inside. </p><br><p>  With the increase in the number of employees and the changes introduced into the monitoring system, more and more common errors that were difficult to track were encountered: </p><br><ol><li>  Binding item, trigger directly to the hosts, outside the templates (and some of the hosts are left without monitoring). </li><li>  Wrong value of triggers (sort of agreed on an accessible place of 3 GB, but a typo, we get a never-working trigger of 34 GB). </li><li>  Non-compliance with the <strong>name convention</strong> - and we get an incomprehensible trigger name <strong>Script failed</strong> (although this means that the update delivery system does not work) or the template - <strong>Gitlab Templates</strong> (monitoring what, server or agent?). </li><li>  Trigger off, temporary, for tests.  As a result, missed a warning on the infrastructure and stood up. </li></ol><br><p>  In the world of programmers, all these problems are solved quite simply: linters, modereview.  So why not take these bestpractices for a Zabbix configuration review?  We take! </p><br><p><img src="https://habrastorage.org/webt/4e/x5/gp/4ex5gpgcbqruon7lg2ogwgiz-iq.png"></p><br><p>  We already wrote earlier about the advantages and examples of code review: <a href="https://habr.com/company/pt/blog/148884/">Implementation of code inspections in the development process</a> , <a href="https://habr.com/company/pt/blog/149303/">Practical example of the implementation of code inspections, Code</a> <a href="https://habr.com/company/pt/blog/153359/">inspection.</a>  <a href="https://habr.com/company/pt/blog/153359/">Results</a> </p><br><p>  Why you may need to review the Zabbix configuration: </p><br><ul><li>  Check that the hosts and patterns are named as is customary in the command ( <strong>name convention</strong> ). </li><li>  Train new employees and check that they have done the task as discussed. </li><li>  Transfer knowledge between experienced employees. </li><li>  To notice accidentally or temporarily off triggers. </li><li>  Check for incorrect values ‚Äã‚Äãin item or trigger - <strong>last (0)</strong> instead of <strong>min (5m)</strong> . </li></ul><br><p>  Add your own problems in the comments, try to figure out together how to solve them with the help of review. </p><br><h1 id="kak-u-zabbix--s-otslezhivaniem-izmeneniy">  Like Zabbix with change tracking </h1><br><p>  Zabbix has an <a href="https://www.zabbix.com/documentation/4.0/manual/web_interface/frontend_sections/reports/audit">Audit</a> subsystem, with its help we are looking at who made the configuration changes.  Its major drawback is a large number of saved events, as it saves every user event. </p><br><p>  Imagine that any code change remains in the git history, you tried to find the name of a variable for an hour, tried 40 options and all of them are now saved, each change is a separate commit, and then you review the history of these commits without reviewing the initial and final version.  Awful, right? </p><br><p>  And in Zabbix Audit exactly like this.  With it, you can track changes, but it does not allow you to quickly see the difference (diff) between the two states of the system (at the beginning of the week and at the end).  In addition, her actions are divided by type: add, change, delete need to look in different windows.  An example can be found in your Zabbix on the Audit tab (or look at the screenshot).  It is difficult to understand what the initial state, what the current, what changes were in a week.  The situation becomes more complicated when we have dozens of changes in a week. </p><br><p><img src="https://habrastorage.org/webt/l9/if/s3/l9ifs3scz-iuc-q_pgypr8ue4zg.png"></p><br><p>  I would like a mechanism that will allow: </p><br><ol><li>  Once a week or after completing the task of changing the monitoring logic, take a snapshot of the system state. </li><li>  Compare the current configuration snapshot with the previous diff (). </li><li>  Automatically check the name convention. </li><li>  Check the quality of the task, give recommendations, tips, discuss solutions. </li><li>  Check that the changes are legitimate - all made in accordance with the task. </li><li>  Use familiar tools for developers - git, diff, mergerequest. </li><li>  Roll back to some state of the system, but not lose data (therefore, backup is not suitable). </li><li>  Control entities Zabbix - host, templates, action, macros, screen, map. </li></ol><br><p>  Now let's talk about how we implemented the mechanism and how it can be useful to you for your Zabbix infrastructure. </p><br><h1 id="delaem-zabbix-configuration-review">  Making Zabbix configuration review </h1><br><p>  For storage of Zabbix configuration we use the following formats: </p><br><ol><li>  Original <strong>XML</strong> - exported using original <a href="https://www.zabbix.com/documentation/4.0/manual/xml_export_import">Zabbix Export</a> .  Use for objects host, template, screen.  There are features: <br><ul><li>  XML is difficult to read and view changes; </li><li>  contain all fields, including blank; </li><li>  contain the <strong>date</strong> field - the export date, we cut it out. </li></ul></li><li>  Raw <strong>JSON</strong> - some types of <a href="https://support.zabbix.com/browse/ZBXNEXT-3281">Zabbix</a> objects are <a href="https://support.zabbix.com/browse/ZBXNEXT-3281">not able to export</a> (actions, mediatypes), but they are important and I want to see the changes, so we take raw data from ZabbixAPI and save them in JSON. </li><li>  Readable <strong>YAML</strong> - we process exported XML and raw JSON and save to human-readable, convenient vanilla YAML.  It is easy to handle large volumes of changes with his eyes.  We add there small processing: <br><ul><li>  We delete fields with no values ‚Äã‚Äã- a controversial moment, so we can skip an empty field, although it should be filled, for example, a field describing the problem of a trigger (trigger.description).  After discussion, we decided that it would be better to remove empty fields, there are too many of them.  If you wish, you can put an exception on some empty fields and not delete them. </li><li>  We delete dates - they change every time and with merge requesting they are shown as changes for each host. </li><li>  You can optionally add other operations on filling with information - userid is written in action instead of users, for example. </li></ul></li></ol><br><p>  Select three git repositories (we use gitlab for storage, but any VCS will do): </p><br><ol><li>  <strong>zabbix-review-export</strong> - the <strong>export</strong> code (Python scripts) and parameters for gitlab-ci jobs will be stored here. </li><li>  <strong>zabbix-xml</strong> - store XML + JSON, all in one thread.  Revising this business is hard and time consuming.  It is used to restore the status of a Zabbix configuration for a certain time. </li><li>  <strong>zabbix-yaml</strong> is our main repository, here we make merge requests, we look at the changes, we discuss the decisions made, merjim to <strong>master</strong> if there are no comments. </li></ol><br><p>  In these repositories we save configuration data, the rules are as follows: </p><br><ul><li>  Grouping by object type by folder - full list: <a href="https://gitlab.com/devopshq/zabbix-review-export">https://gitlab.com/devopshq/zabbix-review-export#supported-objects</a> </li><li>  one object - one file. </li></ul><br><p>  Now we clearly see what type of object has changed, and it is clear which object has changed;  in the example below, the <strong>Profile</strong> template has changed <strong>.</strong>  <strong>ScmDev.</strong>  <strong>FlusContinuousTest</strong> . </p><br><p><img src="https://habrastorage.org/webt/yy/8x/h0/yy8xh07pa2sfxnqqtxqlk3g6_8a.png"></p><br><h1 id="pokazhem-na-primerah">  Let's show by examples </h1><br><p>  To view the changes, we use the merge-request mechanism in gitlab. </p><br><p>  Changed the profile <strong>template.</strong>  <strong>DevOps.</strong>  <strong>Test</strong> - changed the trigger expression.  Template, as it is located in the <strong>templates</strong> folder: <br><img src="https://habrastorage.org/webt/zv/z_/dz/zvz_dzedyfkdsahqpqhr7qmmshq.png"></p><br><p>  Changed the expression in the trigger and priority: <br><img src="https://habrastorage.org/webt/ek/rm/ur/ekrmurfptreli-wzvyrdbwm6ycg.png"></p><br><p>  Linked to one pattern of another: <br><img src="https://habrastorage.org/webt/ly/hn/iq/lyhniqxqsgapehc2w9xqznu-0pa.png"></p><br><p>  Changed the action - added a new line to the end of the default text: <br><img src="https://habrastorage.org/webt/p8/oa/lf/p8oalfrprqn-uyl3eeustwhrlfc.png"></p><br><p>  An example of discussions in merge requests (everything is like that of programmers!) - you can see that you have connected the standard template directly to the host, but it is worth highlighting a separate role for the future.  Screenshot from the old review, then still using the XML representation of the configuration. <br><img src="https://habrastorage.org/webt/ms/pf/6e/mspf6ewwco3yvycc_qi3b5g6adq.png"></p><br><p>  In general, everything is simple: </p><br><ol><li>  Added a new host or other object - a new file was created. </li><li>  Changed the host or other object - looked diff. </li><li>  Delete - the file is deleted. </li></ol><br><p>  Suppose you have completed the task and want to ask a colleague to see if you have forgotten nothing.  We request a review: to do this in the <strong>zabbix-review-export</strong> repository, launch the gitlab-ci job with manual launch. <br><img src="https://habrastorage.org/webt/wn/9i/v8/wn9iv8ffc_nrvaibw41parqidu8.png"></p><br><p>  We assign a merge-request to a colleague who watches, discusses and rules the monitoring infrastructure code. </p><br><p>  Once a week, a new review is launched to track small changes. To do this, the <a href="https://docs.gitlab.com/ee/user/project/pipelines/schedules.html">Schedule</a> exports and saves the configuration to the git repository (a new commit), and the monitoring guru reviews the changes. </p><br><h1 id="myagko-stelesh-no-nado-poprobovat">  Gently crawl, but you have to try </h1><br><p>  Now we‚Äôll tell you how to set up this system with a review of the Zabbix configuration ( <a href="https://habr.com/company/pt/blog/327957/">we love open source</a> and try to share experiences with the community). </p><br><p>  There are two possible uses: </p><br><ol><li> Just run the export script with your hands - run the script, see the changes, do <code>git add * &amp;&amp; git commit &amp;&amp; git push</code> .  This option is suitable for rare changes or when you are working with a monitoring system alone. </li><li>  Use gitlab-ci to automate - then you just need to click on the start button (see above screenshot).  The option is more suitable for large <del>  lazy </del>  commands or with frequent changes. </li></ol><br><p>  Both options are described in the <a href="https://gitlab.com/devopshq/zabbix-review-export">https://gitlab.com/devopshq/zabbix-review-export</a> repository, everything you need is stored there - scripts, gitlab-ci settings and README.md, how to put into your infrastructure. </p><br><p>  To get started, try the first option (or if you do not have the gitlab-ci infrastructure): use the manual mode ‚Äî run the <a href="https://gitlab.com/devopshq/zabbix-review-export/blob/master/zabbix-export.py">zabbix-export.py</a> script to export (backup) the configuration, <code>git add * &amp;&amp; git commit &amp;&amp; git push</code> on your working machine.  When you get tired, go to the second option - automate automation! </p><br><h1 id="problemy-i-vozmozhnye-uluchsheniya">  Problems and possible improvements </h1><br><p>  Now the changes are impersonal and to find out who made the changes, you need to use the <a href="https://www.zabbix.com/documentation/4.0/manual/web_interface/frontend_sections/reports/audit">Audit</a> system, which causes pain and suffering.  But not everything is so scary, and Audit is rarely needed, usually there is enough message in the team chat to find the right employee. </p><br><p>  Another problem: if you change the item or trigger host, it is not contained in XML.  That is, we can turn off all the triggers on a particular host or change their priority to a lower one - and no one will know about it and correct us!  We are waiting for this fix at <a href="https://support.zabbix.com/browse/ZBX-15175">https://support.zabbix.com/browse/ZBX-15175</a> </p><br><p>  Not yet invented an automatic recovery mechanism.  Suppose a template or host is greatly changed, we understand that the changes are incorrect and you need to return everything as it was.  Now we are looking for the necessary XML for the corresponding host, import it manually into the UI, and I would just like to click the ‚ÄúRoll back TemplateName template to commit-hash commit state‚Äù. </p><br><p>  You can implement two-way synchronization - when changes in the Zabbix configuration are created when changes are made in YAML, then you don‚Äôt have to go to the Zabbix web interface.  On github we met a similar project, but somehow it quickly faded away and the community did not accept the idea;  Apparently, it is not so easy to implement in YAML that which can be clicked with the mouse in the web interface.  Therefore, we stopped on the interaction in one direction. </p><br><p>  <strong>The ideal option</strong> is to embed this configuration saving system as a code, at least just in XML format, in Zabbix.  As it is done <a href="https://confluence.jetbrains.com/display/TCD10/Storing%2BProject%2BSettings%2Bin%2BVersion%2BControl">in the TeamCity CI server</a> : configurations configured via the UI make commits on behalf of the user who changed the configuration.  It turns out a very handy tool for viewing changes, and also eliminates the problem of depersonalization of changes. </p><br><h1 id="poprobuyte">  Try </h1><br><p>  Start exporting your Zabbix configuration, commit to the repository (local enough), wait a week and start again.  Now the changes are under your control!  <a href="https://gitlab.com/devopshq/zabbix-review-export">https://gitlab.com/devopshq/zabbix-review-export</a> </p><br><p>  Who would be interested in this functionality in the box Zabbix - please vote for the issue <a href="https://support.zabbix.com/browse/ZBXNEXT-4862">https://support.zabbix.com/browse/ZBXNEXT-4862</a> </p><br><p>  All 100% uptime! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/433126/">https://habr.com/ru/post/433126/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../433112/index.html">Entertaining JavaScript: Snowy Day</a></li>
<li><a href="../433114/index.html">PMP Certification: Commuter Style Exam Preparation</a></li>
<li><a href="../433116/index.html">Flamethrowers, Santa Claus on the tank, Bigfoot, Baba Yaga on Endurik (and, possibly, Jetpack) - all for the kids for the new year</a></li>
<li><a href="../433118/index.html">Benchmark testing and quick analysis of permutations algorithms</a></li>
<li><a href="../433122/index.html">React-Hot-Loader v4.6</a></li>
<li><a href="../433128/index.html">What IT professionals play and do not play (summary 2018)</a></li>
<li><a href="../433130/index.html">May the force be with us: our own immunity against cancer</a></li>
<li><a href="../433132/index.html">"Calendar tester" for December. Try a different approach</a></li>
<li><a href="../433136/index.html">System.Transactions infrastructure in the .NET world</a></li>
<li><a href="../433138/index.html">Five principles of product design in Booking</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>