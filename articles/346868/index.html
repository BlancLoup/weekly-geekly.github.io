<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>One-cloud - OS-level data center in Odnoklassniki</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aloha, People! My name is Oleg Anastasyev, I work in Odnoklassniki in the Platform team. And besides me, a lot of iron works in Odnoklassniki. We have...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>One-cloud - OS-level data center in Odnoklassniki</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/up/-b/8y/up-b8yeoiwzjhkngkq1b7myw8fs.jpeg"></p><br><p>  Aloha, People!  My name is Oleg Anastasyev, I work in Odnoklassniki in the Platform team.  And besides me, a lot of iron works in Odnoklassniki.  We have four data centers, they have about 500 racks with more than 8 thousand servers.  At a certain point, we realized that the introduction of a new management system would allow us to more efficiently load equipment, facilitate access management, automate (re) distribution of computing resources, speed up the launch of new services, speed up reactions to large-scale accidents. </p><br><p>  What came of it? </p><a name="habracut"></a><br><p>  In addition to me and the heaps of iron, there are still people who work with this iron: engineers who are directly in the data centers;  networkers who set up network support;  admins, or SREs, that provide infrastructure resiliency;  and development teams, each of which is responsible for part of the portal‚Äôs functions.  The software they create works something like this: </p><br><p><img src="https://habrastorage.org/webt/qk/cp/rl/qkcprlxw4tcta9y0kotdvsefcbq.png"></p><br><p>  User requests are received both on the fronts of the main portal <a href="http://www.ok.ru/">www.ok.ru</a> , and on others, for example, on the fronts of the music API.  For processing business logic, they invoke an application server, which, when processing a request, calls the necessary specialized microservices - one-graph (social networking graph), user-cache (user profile cache), etc. </p><br><p>  Each of these services is deployed on a variety of machines, and each of them has responsible developers responsible for the functioning of the modules, their operation and technological development.  All these services run on iron servers, and until recently we ran exactly one task per server, that is, it was specialized for a specific task. </p><br><p>  Why is that?  This approach had several advantages: </p><br><ul><li>  <strong>Mass control is</strong> facilitated.  Suppose a task requires some libraries, some settings.  And then the server is assigned to exactly one specific group, the cfengine policy for this group is described (or it has already been described), and this configuration is centrally and automatically rolled out to all servers of this group. </li><li>  Simplified <strong>diagnosis</strong> .  Suppose you are looking at the increased load on the CPU and you realize that only the task that runs on this iron processor could have generated this load.  The search for the culprit ends very quickly. </li><li>  <strong>Monitoring is</strong> simplified.  If something is wrong with the server, the monitor reports this, and you know exactly who is to blame. </li></ul><br><p>  A service consisting of several replicas is allocated several servers, one for each.  Then the computing resource for the service is very simple: how many servers have the service, so much can it consume the most resources.  ‚ÄúJust‚Äù is not in the sense that it is easy to use, but in the fact that the distribution of resources is done manually. </p><br><p>  This approach also allowed us to make <strong>specialized iron configurations</strong> for a task running on this server.  If the task stores large amounts of data, then we use a 4U server with a chassis of 38 disks.  If the task is purely computational, then we can buy a cheaper 1U server.  This is effective in terms of computing resources.  Including this approach allows us to use four times fewer machines with a load comparable to one friendly social network. </p><br><p>  Such efficiency in the use of computational resources should also ensure economic efficiency, assuming that the most expensive is servers.  For a long time, it was iron that cost the most, and we invested a lot of effort in reducing the price of iron, inventing fault tolerance algorithms to reduce equipment reliability requirements.  And today we have reached the stage at which the server price has already ceased to be decisive.  If you do not consider the freshest exotic, then the specific configuration of servers in the rack does not matter.  Now we have another problem - the price of the space occupied by the server in the data center, i.e. the space in the rack. </p><br><p>  Realizing that this is so, we decided to calculate how effectively we use the rack. <br>  We took the price of the most powerful server out of the economically sound ones, calculated how many such servers we can put in racks, how many tasks we would run on them based on the old model ‚Äúone server = one task‚Äù and how much such tasks could utilize the equipment.  Counted - wept.  It turned out that the efficiency of using racks in our country is about 11%.  The conclusion is obvious: it is necessary to increase the efficiency of using data centers.  It would seem that the solution is obvious: you need to run several tasks on one server at once.  But here begins the complexity. </p><br><p>  Mass configuration becomes more complicated - now it is impossible to assign any one group to the server.  After all, now several tasks of different teams can be run on the same server.  In addition, the configuration may be conflicting for different applications.  Diagnostics is also complicated: if you see an increased consumption of processors or disks on the server, then you do not know which of the tasks is causing trouble. </p><br><p>  But the main thing is that there is no isolation between tasks running on the same machine.  Here, for example, the graph of the average response time of the server task before and after another calculation program not related to the first one was launched on the same server - the response time from the main task has greatly increased. </p><br><p><img src="https://habrastorage.org/webt/nu/4z/9k/nu4z9kcijx6pawpoowdyqil6byo.png"></p><br><p>  Obviously, you need to run tasks either in containers or in virtual machines.  Since almost all tasks are run under one OS (Linux) or are adapted for it, we do not need to support many different operating systems.  Accordingly, virtualization is not needed, because of the additional overhead, it will be less efficient than containerization. </p><br><p>  As a container implementation for running tasks directly on Docker servers, this is a good candidate: file system images solve problems with conflicting configurations well.  The fact that images can be composed of several layers allows us to significantly reduce the amount of data required for their deployment on the infrastructure, highlighting the common parts into separate basic layers.  Then the basic (and most voluminous) layers will be cached quite quickly across the entire infrastructure, and for the delivery of many different types of applications and versions, only small-sized layers will need to be transferred. </p><br><p>  Plus, a ready registry and image tagging in Docker give us ready-made primitives for versioning and delivering code in production. </p><br><p>  Docker, like any other similar technology, provides us with some level of isolation of containers out of the box.  For example, memory isolation ‚Äî each container is given a limit on the use of machine memory, above which it will not consume.  You can also isolate containers by CPU usage.  For us, however, standard insulation was not enough.  But more about that - below. </p><br><p>  Running containers directly on servers is only part of the problem.  The other part is related to the placement of containers on servers.  You need to understand which container on which server you can put.  This is not such an easy task, because containers should be placed on servers as tightly as possible, without slowing down their work.  This placement can be difficult in terms of fault tolerance.  Often we want to place replicas of the same service in different racks or even in different halls of the data center, so that if a rack or hall fails, we will not lose all the replicas of the service at once. </p><br><p>  Manually distributing containers is not an option when you have 8 thousand servers and 8-16 thousand containers. </p><br><p>  In addition, we wanted to give developers more autonomy in the allocation of resources so that they could themselves place their services on production, without the help of the administrator.  At the same time, we wanted to keep control so that some secondary service would not consume all the resources of our data centers. </p><br><p>  Obviously, we need a control layer that would do this automatically. </p><br><p>  Here we come to a simple and clear picture that all architects adore: three squares. </p><br><p><img src="https://habrastorage.org/webt/lr/dg/lf/lrdglfhsgzyb4dwdwetygsmkmme.png"></p><br><p>  one-cloud masters is a failover cluster responsible for cloud orchestration.  The developer sends to the master manifest, which contains all the information necessary for hosting the service.  The wizard on its basis gives commands to selected minions (machines intended for launching containers).  On the minions there is our agent, who receives the command, gives up his Docker commands, and Docker configures the linux kernel to launch the corresponding container.  In addition to executing commands, the agent continuously informs the master about changes in the state of both the minion machine and the containers running on it. </p><br><h2 id="raspredelenie-resursov">  Resource allocation </h2><br><p>  And now let's deal with the task of a more complex resource allocation for many minions. </p><br><p>  The computing resource in one-cloud is: </p><br><ul><li>  The computing power of the processor consumed by a specific task. </li><li>  The amount of memory available to the task. </li><li>  Network traffic  Each of the minions has a specific network interface with a limited bandwidth, so you cannot distribute tasks without taking into account the amount of data transmitted by them. </li><li>  Discs.  In addition to, obviously, space for these tasks, we also highlight the type of drive: HDD or SSD.  Disks can serve a finite number of requests per second - IOPS.  Therefore, for tasks that generate more IOPS than a single disk can serve, we also allocate ‚Äúspindles‚Äù ‚Äîthat is, disk devices that need to be reserved exclusively for the task. </li></ul><br><p>  Then for some service, for example, for user-cache, we can record the consumed resources in this way: 400 processor cores, 2.5 TB of memory, 50 Gbit / s of traffic in both directions, 6 TB of space on the HDD, located on 100 spindles .  Or in a more familiar form: </p><br><pre><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">alloc</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">cpu</span></span>: 400 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mem</span></span>: 2500 <span class="hljs-selector-tag"><span class="hljs-selector-tag">lan_in</span></span>: 50<span class="hljs-selector-tag"><span class="hljs-selector-tag">g</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lan_out</span></span>: 50<span class="hljs-selector-tag"><span class="hljs-selector-tag">g</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">hdd</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:100x6T</span></span></code> </pre> <br><p>  User-cache service resources consume only a fraction of all available resources in the production-infrastructure.  Therefore, I want to make it so that suddenly, due to an operator error or not, user-cache does not consume more resources than it has been allocated.  That is, we must limit resources.  But to what could we tie the quota? </p><br><p>  Let's go back to our highly simplified scheme of interaction between components and redraw it with more details ‚Äî like this: </p><br><p><img src="https://habrastorage.org/webt/qh/yf/yw/qhyfywkrqp9zd8nmk9rwegr4xgy.png"></p><br><p>  What catches your eye: </p><br><ul><li>  Web frontend and music use isolated clusters of the same application server. </li><li>  You can select the logical layers to which these clusters belong: fronts, caches, data storage and management layer. </li><li>  The frontend is heterogeneous; these are different functional subsystems. </li><li>  Caches can also be scattered on the subsystem, the data of which they cache. </li></ul><br><p>  Redraw the image again: </p><br><p><img src="https://habrastorage.org/webt/ut/-e/al/ut-eal49miexvyj4ejguqgogr70.png"></p><br><p>  Bah!  Yes, we see the hierarchy!  This means that it is possible to allocate resources in larger chunks: assign the responsible developer to the node of this hierarchy corresponding to the functional subsystem (like ‚Äúmusic‚Äù in the picture), and assign a quota to the same hierarchy level.  This hierarchy also allows us to more flexibly organize services for ease of management.  For example, all the web, since this is a very large grouping of servers, we divide into several smaller groups, shown in the picture as group1, group2. </p><br><p>  By removing the extra lines, we can write each node of our image in a more flat form: <strong>group1.web.front</strong> , <strong>api.music.front</strong> , <strong>user-cache.cache</strong> . </p><br><p>  So we come to the concept of "hierarchical queue."  It has a name like "group1.web.front".  It is assigned a quota for resources and user rights.  We give the person from DevOps the right to send the service to the queue, and such an employee can run something in the queue, and the person from OpsDev - admin rights, and now he can manage the queue, assign people there, give these people rights, etc. The services running in this queue will run within the quota quota.  If the computational quota of the queue is not enough for one-time execution of all services, then they will be executed sequentially, thus forming the actual queue. </p><br><p>  Consider the services in more detail.  The service has a full name, which always includes the name of the queue.  Then the front web service will have the name <strong>ok-web.group1.web.front</strong> .  And the application server service to which it accesses will be called <strong>ok-app.group1.web.front</strong> .  Each service has a manifest, which indicates all the necessary information for placement on specific machines: how many resources this task consumes, what configuration is needed for it, how many replicas should be, properties for handling failures of this service.  And after placing the service directly on the machines appear his copies.  They are also uniquely named - as the instance number and service name: <strong>1.ok-web.group1.web.front, 2.ok-web.group1.web.front, ...</strong> </p><br><p>  This is very convenient: looking only at the name of the running container, we can immediately find out a lot. </p><br><p>  And now let's take a closer look at what these instances actually do: with tasks. </p><br><h2 id="klassy-izolyacii-zadach">  Task isolation classes </h2><br><p>  All tasks in the OK (and, probably, everywhere) can be divided into groups: </p><br><ul><li>  <strong>Tasks with a short delay - prod</strong> .  For such tasks and services it is very important to delay the response (latency), how quickly each of the requests will be processed by the system.  Examples of tasks: web fronts, caches, application servers, OLTP storage, etc. </li><li>  <strong>Calculated tasks - batch</strong> .  Here, the processing speed of each specific request is unimportant.  For them it is important how many calculations for a certain (large) period of time this task will do (throughput).  These will be any tasks MapReduce, Hadoop, machine learning, statistics. </li><li>  <strong>Background tasks - idle</strong> .  Neither latency nor throughput are very important for such tasks.  This includes various tests, migrations, recounts, converting data from one format to another.  On the one hand, they are similar to calculated ones, on the other hand, it is not very important for us how quickly they will be completed. </li></ul><br><p>  Let's see how such tasks consume resources, for example, the central processor. </p><br><p>  <strong>Tasks with a short delay.</strong>  For such a task, the CPU consumption pattern will look like this: </p><br><p><img src="https://habrastorage.org/webt/fe/jd/ww/fejdwwnkqluyob07p9mmslsdwgy.png"></p><br><p>  A request from the user arrives for processing, the task begins to use all available CPU cores, executes, returns an answer, waits for the next request and stands.  Received the following request - again, they chose everything that was, cheated, waiting for the next one. </p><br><p>  To guarantee the minimum delay for such a task, we must take the maximum resources it consumes and reserve the necessary number of cores on the minion (the machine that will perform the task).  Then the reservation formula for our task will be: </p><br><pre> <code class="hljs swift">alloc: cpu = <span class="hljs-number"><span class="hljs-number">4</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>)</code> </pre> <br><p>  and if we have a minion machine with 16 cores, then exactly four such tasks can be placed on it.  We note in particular that the average processor consumption for such tasks is often very low - which is obvious, since the task is waiting for a request for a significant portion of the time and does nothing. </p><br><p>  <strong>Calculated tasks.</strong>  They will have a slightly different pattern: </p><br><p><img src="https://habrastorage.org/webt/dm/tn/z-/dmtnz-seihetoqxiitjntygbg9w.png"></p><br><p>  The average CPU consumption for such tasks is quite high.  Often we want the design task to be completed in a certain time, so you need to reserve the minimum number of processors that it needs in order for the whole calculation to end in a reasonable time.  Its reservation formula will look like this: </p><br><pre> <code class="hljs">alloc: cpu = [1,*)</code> </pre> <br><p>  <em>"Please place it on the minion, where there is at least one free core, and then how much is there - it will devour everything."</em> </p><br><p>  Here, with efficiency of use, it is much better than on tasks with a short delay.  But the gain will be much greater if you combine both types of tasks on the same minion machine and distribute its resources on the go.  When a task with a short delay requires a processor - it receives it immediately, and when resources are no longer needed - they are transferred to the calculated task, that is, something like this: </p><br><p><img src="https://habrastorage.org/webt/3z/wj/xd/3zwjxdnlnivl7bvg4oicloglkn0.png"></p><br><p>  But how to do that? </p><br><p>  First, let's take a look at prod and its alloc: cpu = 4. We need to reserve four cores.  In the Docker run, this can be done in two ways: </p><br><ul><li>  Using the option <code>--cpuset=1-4</code> , i.e., to allocate the task four specific kernels on the machine. </li><li>  Use <code>--cpuquota=400_000 --cpuperiod=100_000</code> , assign a quota for processor time, i.e., indicate that every 100 ms of real time the task consumes no more than 400 ms of processor time.  The same four cores are obtained. </li></ul><br><p>  But which of these methods will work? </p><br><p>  It looks pretty attractive cpuset.  The task has four dedicated cores, which means that processor caches will work as efficiently as possible.  This has a downside: we would have to take on the task of distributing the calculations over the unloaded kernels of the machine instead of the OS, which is quite a non-trivial task, especially if we try to place batch tasks on such a machine.  Tests have shown that the quota option is better suited here: this is how the operating system has more freedom in choosing the kernel to perform the task at the moment and the processor time is distributed more efficiently. </p><br><p>  Let's figure out how to docker in the docker for the minimum number of cores.  The quota for batch tasks is already inapplicable, because it is not necessary to limit the maximum, you just need to guarantee a minimum.  And here the <code>docker run --cpushares</code> option <code>docker run --cpushares</code> . </p><br><p>  We agreed that if batch requires a warranty of at least one core, then we specify <code>--cpushares=1024</code> , and if at least two cores, then we specify <code>--cpushares=2048</code> .  Cpu shares do not interfere in the distribution of CPU time as long as it is enough.  Thus, if prod does not currently use all of its four cores - nothing restricts batch tasks, and they can use additional processor time.  But in a situation of processor shortage, if prod consumed all its four bark and rested on the quota - the remaining processor time will be divided proportionally to cpushares, i.e. in a situation of three free cores one will receive a task from 1024 cpushares, and the other two - a problem from 2048 cpushares </p><br><p>  But using quota and shares is not enough.  We need to make the task with a short delay receive priority over the batch task when allocating processor time.  Without such prioritization, the batch task will take all the CPU time at the moment when it is needed by prod.  There are no container prioritization options in the Docker run, but the CPU scheduler policies on Linux come to the rescue.  You can read about them in detail <a href="http://man7.org/linux/man-pages/man2/sched_setscheduler.2.html">here</a> , and in the framework of this article we will take a brief look at them: </p><br><ul><li>  <strong>SCHED_OTHER</strong> <br>  By default, all normal user processes on a Linux machine are obtained. </li><li>  <strong>SCHED_BATCH</strong> <br>  Designed for demanding processes.  When a task is placed in the processor, a so-called activation fee is introduced: such a task is less likely to receive processor resources if the task with SCHED_OTHER is currently using it </li><li>  <strong>SCHED_IDLE</strong> <br>  The background process has a very low priority, even lower than the nice ‚Äì19.  We use our open source <a href="https://github.com/odnoklassniki/one-nio">one-nio</a> library to set the necessary policy when launching a container by calling </li></ul><br><pre> <code class="java hljs">one.nio.os.Proc.sched_setscheduler( pid, Proc.SCHED_IDLE )</code> </pre> <br><p>  But even if you do not program in Java, you can do the same with the chrt command: </p><br><pre> <code class="bash hljs">chrt -i 0 <span class="hljs-variable"><span class="hljs-variable">$pid</span></span></code> </pre> <br><p>  Let us reduce all our isolation levels in one table for clarity: </p><br><table><thead><tr><th>  Insulation class </th><th>  Example alloc </th><th>  Docker run options </th><th>  sched_setscheduler chrt * </th></tr></thead><tbody><tr><td>  Prod </td><td>  cpu = 4 </td><td>  <code>--cpuquota=400000</code> <code>--cpuperiod=100000</code> </td><td>  SCHED_OTHER </td></tr><tr><td>  Batch </td><td>  Cpu = [1, *) </td><td> <code>--cpushares=1024</code> </td> <td>  SCHED_BATCH </td></tr><tr><td>  Idle </td><td>  Cpu = [2, *) </td><td> <code>--cpushares=2048</code> </td> <td>  SCHED_IDLE </td></tr></tbody></table><br><p>  * If you do chrt from inside the container, you may need the capability sys_nice, because by default Docker this capability takes away when the container is started. </p><br><p>  But tasks consume not only the processor, but also traffic, which affects the delay of the network task even more than the incorrect allocation of processor resources.  Therefore, we naturally want to get exactly the same picture for traffic.  That is, when the prod-task sends some packets to the network, we quote the maximum speed (formula <em>alloc: lan = [*, 500mbps)</em> ), with which prod can do it.  And for batch, we guarantee only the minimum bandwidth, but do not limit the maximum (formula <em>alloc: lan = [10Mbps, *)</em> ) At the same time, prod traffic should receive priority over batch tasks. <br>  Here, the Docker has no primitives that we could use.  But <a href="http://lartc.org/">Linux Traffic Control</a> comes to the rescue.  We were able to achieve the desired result with the discipline of the <a href="http://linux-ip.net/articles/hfsc.en/">Hierarchical Fair Service Curve</a> .  With its help, we distinguish two classes of traffic: high-priority prod and low-priority batch / idle.  As a result, the configuration for outgoing traffic is obtained like this: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ei/pn/ur/eipnurxqn_9ar2fiboncfx1jmms.png"></a> </p><br><p>  here 1: 0 is the "root qdisc" of the hsfc discipline;  1: 1 - a child class hsfc with a total bandwidth limit of 8 Gbit / s, under which the child classes of all containers are placed;  1: 2 is a child class hsfc common to all batch and idle tasks with a ‚Äúdynamic‚Äù limit, which is described below.  The remaining child classes of hsfc are dedicated classes for the currently working prod containers with limits corresponding to their manifests ‚Äî 450 and 400 Mbit / s.  Each hsfc class is assigned a qdisc fq or fq_codel queue, depending on the linux kernel version, in order to avoid packet loss during traffic spikes. </p><br><p>  Typically, tc disciplines serve to prioritize only outgoing traffic.  But we want to prioritize the incoming traffic too - after all, some batch task can easily select the entire incoming channel, receiving, for example, a large packet of input data for map &amp; reduce.  To do this, we use the <a href="https://serverfault.com/questions/350023/tc-ingress-policing-and-ifb-mirroring">ifb</a> module, which creates a virtual ifbX interface for each network interface and redirects incoming traffic from the interface to the outgoing to ifbX.  Further, for ifbX, all the same disciplines for controlling outgoing traffic work, for which the hsfc configuration will be very similar: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/zb/uk/fh/zbukfhvy0ut5hmy7frerpxa2kr4.png"></a> </p><br><p>  In the course of the experiments, we found out that the best results for hsfc are shown when the 1: 2 class of non-priority batch / idle traffic is limited to minion-machines not more than to some free band.  Otherwise, non-priority traffic is too much affect on the delay of prod-tasks.  The miniond determines the current free bandwidth every second, measuring the average traffic consumption of all the minion's prod tasks. <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>T</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>p</mi><mi>r</mi><mi>o</mi><mi>d</mi></mrow></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.815ex" height="2.66ex" viewBox="0 -780.1 2073.3 1145.2" role="img" focusable="false" style="vertical-align: -0.848ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-54" x="0" y="0"></use><g transform="translate(584,-150)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-72" x="503" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-6F" x="955" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-64" x="1440" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>T</mi><mrow class="MJX-TeXAtom-ORD"><mi>p</mi><mi>r</mi><mi>o</mi><mi>d</mi></mrow></msub></math></span></span><script type="math/tex" id="MathJax-Element-1"> T_ {prod} </script>  and subtracting it from the bandwidth of the network interface <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>C</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>e</mi><mi>t</mi><mi>h</mi></mrow></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.201ex" height="2.419ex" viewBox="0 -780.1 1808.6 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-43" x="0" y="0"></use><g transform="translate(715,-150)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-65" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-74" x="466" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-68" x="828" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>C</mi><mrow class="MJX-TeXAtom-ORD"><mi>e</mi><mi>t</mi><mi>h</mi></mrow></msub></math></span></span><script type="math/tex" id="MathJax-Element-2"> C_ {eth} </script>  with a small margin, i.e. </p><br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>T</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>b</mi><mi>a</mi><mi>t</mi><mi>c</mi><mi>h</mi></mrow></msub><mo>=</mo><msub><mi>C</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>e</mi><mi>t</mi><mi>h</mi></mrow></msub><mo>&amp;#x2212;</mo><mtext>&amp;#xA0;</mtext><mi>s</mi><mi>u</mi><mi>m</mi><msub><mi>T</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>p</mi><mi>r</mi><mi>o</mi><mi>d</mi></mrow></msub><mspace width=&quot;mediummathspace&quot; /><mo>&amp;#x2217;</mo><mn>1.1</mn></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="31.096ex" height="2.66ex" viewBox="0 -780.1 13388.5 1145.2" role="img" focusable="false" style="vertical-align: -0.848ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-54" x="0" y="0"></use><g transform="translate(584,-150)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-62" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-61" x="429" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-74" x="959" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-63" x="1320" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-68" x="1754" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMAIN-3D" x="2610" y="0"></use><g transform="translate(3666,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-43" x="0" y="0"></use><g transform="translate(715,-150)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-65" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-74" x="466" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-68" x="828" y="0"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMAIN-2212" x="5697" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-73" x="6948" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-75" x="7417" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-6D" x="7990" y="0"></use><g transform="translate(8868,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-54" x="0" y="0"></use><g transform="translate(584,-150)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-72" x="503" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-6F" x="955" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMATHI-64" x="1440" y="0"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMAIN-2217" x="11386" y="0"></use><g transform="translate(12108,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMAIN-2E" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/odnoklassniki/blog/346868/&amp;xid=17259,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgI7QC4Fid514aKnb07NCASmqe-Yw#MJMAIN-31" x="779" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi>T</mi><mrow class="MJX-TeXAtom-ORD"><mi>b</mi><mi>a</mi><mi>t</mi><mi>c</mi><mi>h</mi></mrow></msub><mo>=</mo><msub><mi>C</mi><mrow class="MJX-TeXAtom-ORD"><mi>e</mi><mi>t</mi><mi>h</mi></mrow></msub><mo>‚àí</mo><mtext>&nbsp;</mtext><mi>s</mi><mi>u</mi><mi>m</mi><msub><mi>T</mi><mrow class="MJX-TeXAtom-ORD"><mi>p</mi><mi>r</mi><mi>o</mi><mi>d</mi></mrow></msub><mspace width="mediummathspace"></mspace><mo>‚àó</mo><mn>1.1</mn></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-3"> T_ {batch} = C_ {eth} - \ sum T_ {prod} \: * 1.1 </script></p><br><p>  Bands are defined for incoming and outgoing traffic independently.  And according to the new values, miniond reconfigures the non-priority class 1: 2 limit. </p><br><p>  Thus, we implemented all three isolation classes: prod, batch and idle.  These classes greatly influence the performance characteristics of tasks.  Therefore, we decided to place this feature at the top of the hierarchy, so that when looking at the name of the hierarchical queue it is immediately clear what we are dealing with: </p><br><p><img src="https://habrastorage.org/webt/xl/3e/me/xl3emek07twd-0vwqdsfq2ekfzq.png"></p><br><p>  All of our familiar <strong>web</strong> and <strong>music</strong> fronts are then placed in the hierarchy under prod.  For example, under the batch, let's place the <strong>music catalog</strong> service, which periodically makes a catalog of tracks from the set of mp3 files uploaded to Odnoklassniki.  An example of a service under idle is <strong>music transformer</strong> , which normalizes the volume of music. </p><br><p>  Removing unnecessary lines again, we can write the names of our services more flatly by adding the isolation class to the end of the full name of the service: <strong>web.front.prod</strong> , <strong>catalog.music.batch</strong> , <strong>transformer.music.idle</strong> . </p><br><p>  And now, looking at the name of the service, we understand not only what function it performs, but also its isolation class, which means its criticality, etc. </p><br><p>  Everything is great, but there is one bitter truth.  It is impossible to completely isolate tasks running on the same machine. </p><br><p>  What we have been able to achieve: if batch intensively consumes <strong>only</strong> processor resources, then the built-in Linux CPU scheduler does its job very well, and there is practically no influence on the prod-task.  But if this batch task begins to work actively with memory, then the mutual influence is already manifested.  This happens because the prod-tasks "flush out" the processor memory caches - as a result, the errors in the cache increase, and the processor processes the prod-task more slowly.  Such a batch task can increase the latency of our typical prod container by 10%. </p><br><p>  Isolating traffic is even more difficult due to the fact that modern network cards have an internal packet queue.  If the packet from the batch task gets there first, it means that it will be the first to be transferred via cable, and there is nothing you can do. </p><br><p>  In addition, we have so far managed to solve only the problem of prioritizing TCP traffic: for UDP, the approach with hsfc does not work.  And even in the case of TCP traffic, if a batch task generates a lot of traffic, this also gives about a 10% increase in the delay of the prod task. </p><br><h2 id="otkazoustoychivost">  fault tolerance </h2><br><p>  One of the goals in the development of one-cloud was to improve the resiliency of Odnoklassniki.  Therefore, I would like to discuss in more detail possible scenarios of failures and accidents.  Let's start with a simple script ‚Äî container failure. </p><br><p>  The container itself can fail in several ways.  This could be some kind of experiment, bug, or error in the manifest, due to which the prod-task begins to consume more resources than specified in the manifest.  We had a case: the developer implemented one complex algorithm, reworked it many times, overworked himself and got confused so that in the end the task was very nontrivially looping.  And since the prod task is of higher priority than all the others on the same minions, it began to consume all available processor resources.  In this situation, the isolation has saved, or rather the quota for processor time.  If a quota is allocated to a task, the task will not consume more.  Therefore, batch- and other prod-tasks that worked on the same machine did not notice anything. </p><br><p>  The second possible trouble is the fall of the container.  And here restart policies save us, everyone knows them, Docker does it perfectly well.  Almost all prod-tasks have a restart policy always.  Sometimes we use on_failure for batch tasks or for debugging prod containers. </p><br><p>  And what can be done if the whole minion is not available? </p><br><p>  Obviously, run the container on another machine.  The most interesting thing here is what happens to the IP address (s) assigned to the container. </p><br><p>  We can assign containers the same IP addresses as the minion machines on which these containers run.  Then when you start the container on another machine, its IP address changes, and all customers need to understand that the container has moved, now you need to go to another address, which requires a separate Service Discovery service. </p><br><p>  Service Discovery is convenient.  There are many solutions on the market with varying degrees of fault tolerance for organizing a registry of services.  Often in such solutions the logic of the load balancer is implemented, the storage of the additional configuration in the form of a KV stack, etc. <br>  However, we would like to do without the need to implement a separate registry, because it would mean entering a critical system that is used by all services in production.  So, this is a potential point of failure, and you need to choose or develop a very fault-tolerant solution, which is obviously very difficult, time consuming and expensive. </p><br><p>  And another big drawback: for our old infrastructure to work with a new one, we would have to rewrite absolutely all the tasks for using some kind of Service Discovery system.  There is a lot of work, and in some places it is impossible when it comes to low-level devices operating at the kernel level of the OS or directly with hardware.  Implementing this functionality with the help of well-established decision patterns, such as a <a href="https://linkerd.io/">side-car,</a> would in some places mean additional workload, and in some places - complication of operation and additional failure scenarios.  We did not want to complicate things, so we decided to make the use of Service Discovery optional. </p><br><p>  In one-cloud IP follows the container, i.e., each instance of the task has its own IP address.   ¬´¬ª:            .          ‚Äî         IP-,    . </p><br><p>     :             production. IP-     .      ,      . </p><br><p>  ,       IP-   .        ,       ( <strong>1.ok-web.group1.web.front.prod, 2.ok-web.group1.web.front.prod, ‚Ä¶</strong> ),   ,    FQDN,   DNS.   ,        IP-   DNS-.   DNS    IP-   ‚Äî  ,   (,   ,        ‚Äî    ). ,   ,        ‚Äî     ,  .       ,      DNS,  Service Discovery,  ,             .  ,   ,      ,      DNS,      IP-. </p><br><p>    IP      ‚Äî     ,   ,   : </p><br><p><img src="https://habrastorage.org/webt/3m/km/yn/3mkmynj8dvuvwbvhjyzruh78jrw.png"></p><br><p> , one-cloud     M1  <strong>1.ok-web.group1.web.front.prod</strong>   1.1.1.1.    <a href="https://en.wikipedia.org/wiki/Bird_Internet_routing_daemon">BIRD</a> ,        <a href="https://en.wikipedia.org/wiki/Route_reflector">route reflector</a> .    BGP-   ,       1.1.1.1  M1. M1        Linux.  route reflector ,        one-cloud ‚Äî     one-cloud   .      ,       -,       . </p><br><p>   ,     one-cloud   1 .  one-cloud   ,   ,  1  .      2  <strong>web.group1.web.front.prod</strong>      1.1.1.1.           1.1.1.1:  1   2.      ,   Multi Exit Discriminator,    BGP-.  ,     .         MED.  one-cloud  MED    IP- .         MED = 1 000 000.          MED,  2      1.1.1.1 c MED = 999 999.  ,   M1,     ,             ,        . </p><br><h2 id="avarii">  </h2><br><p>    -     .   ‚Äî    . </p><br><p>  ,    ,         -. </p><br><p>       -?         ,         .     ,    ,          ,     -   100 % . </p><br><p>       .    -     ,   - ,    ,        . </p><br><p>      ? </p><br><p>   ,       ,   .      - ,         ,      . .  ,        . </p><br><p>           ,        . </p><br><p><img src="https://habrastorage.org/webt/83/rw/ca/83rwca_tjws3wowcul43fqrk1h4.png"></p><br><p> ,   ,       , . . prod.       <strong> </strong> ‚Äî ,     .   -   ,      . </p><br><p>  prod    , 0;  batch ‚Äî  , 100;  idle ‚Äî  , 200.   .         .  ,   prod    ,     cache = 0   front  = 1.  , ,  ,         ,  music   ,       ‚Äî 10. </p><br><p>   ‚Äî  . ,      ,   -,     ,       .  ,   ,     . </p><br><p><img src="https://habrastorage.org/webt/1x/ld/pc/1xldpc87gu7zu76xeuur-bul-sy.png"></p><br><p>     ,       batch-,       .     <strong> </strong> .         , . .      ,     .      , ,    , . .            . </p><br><p>         ,  prod-  batch-    idle-,    ,   idle ,  200.  ,       ,      ,     . , ,     ,        -,      : 10. </p><br><h2 id="avarii-dc-celikom">    </h2><br><p>     -? .   ,  <a href="https://habrahabr.ru/company/dataline/blog/333578/">    -</a> .    ,   -    ,  -      .        :    ,   - .    -  .  , -  ‚Äî   .        . </p><br><p>     ,   #    . </p><br><p>   ‚Äî .   one-cloud        -.     -      ‚Äî     -.    :   ,          -.         . <br>      -,     ,    one-cloud. </p><br><p>        ,       . </p><br><p>        ?     -     ,        ,  ,    . ,   -         ‚Äî       ,        . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ba/m1/no/bam1nofjz0ujokfgy52xdqdd0v0.png"></a> </p><br><h2 id="itogi">  Results </h2><br><p>   one-cloud: </p><br><ul><li> <strong>       </strong> ,     ,    ,            . </li><li>    <strong>  prod-  batch-</strong>   ,      .  cpuset   CPU quotas, shares,   CPU  Linux QoS. </li><li>   ,    ,    ,         20 %. </li><li>            <strong>   </strong> . </li></ul><br><h2 id="chavo">  </h2><br><p>      . </p><br><ul><li>           .  prod-     ,  batch  idle  ,      -. </li><li>      , : <br><ul><li>   ; </li><li>   ¬´¬ª . </li></ul></li><li>       ,      ,        one-cloud. </li><li>              </li><li>     Service Discovery;      ,    , ‚Äî ,   ¬´¬ª IP-,   , ,  ,       . </li></ul><br><p>           , ,   ,  ,          .          ‚Äî     ,    . </p><br><p> ,    , ‚Äî     ! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/346868/">https://habr.com/ru/post/346868/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346848/index.html">How to cache AVURLAsset data downloaded by AVPLayer</a></li>
<li><a href="../346850/index.html">More about validation in ASP.NET</a></li>
<li><a href="../346852/index.html">Simulating iridissension: shader CD-ROM</a></li>
<li><a href="../346862/index.html">IPsec vs TLS / SRTP for VoIP Security</a></li>
<li><a href="../346864/index.html">Connect Fanvil phones to 3CX via L2TP tunnel on Mikrotik</a></li>
<li><a href="../346870/index.html">How to replace the restaurant director with a robot?</a></li>
<li><a href="../346872/index.html">Things that cause mistrust and alienate your customers from the site</a></li>
<li><a href="../346876/index.html">How to take notes as a programmer</a></li>
<li><a href="../346878/index.html">Which diagram to use?</a></li>
<li><a href="../346880/index.html">Flask Mega-Tutorial, Part 7: Error Handling (Edition 2018)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>