<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Attention! S in Ethereum stands for Security. Part 3. Solidity in practice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We present the third part of the cycle devoted to typical vulnerabilities, attacks and problem areas inherent in smart contracts in the Solidity langu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Attention! S in Ethereum stands for Security. Part 3. Solidity in practice</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/ud/ke/hi/udkehi5ugmqlp7wbnpqlxch8cbm.jpeg"></p><br><p>  We present the third part of the cycle devoted to typical vulnerabilities, attacks and problem areas inherent in smart contracts in the Solidity language, and the Ethereum platform as a whole.  Here we will talk about what features Solidity has and what vulnerabilities they can turn into in the right hands. </p><a name="habracut"></a><br><p>  In the <a href="https://habrahabr.ru/company/dsec/blog/345196/">first</a> part, we discussed the front-running attack, various random number generation algorithms and network resiliency with the Proof-of-Authority consensus.  The <a href="https://habrahabr.ru/company/dsec/blog/346408/">second</a> talked about Integer overflow, ABI encoding / decoding, Uninitialized storage pointer, Type Confusion and how to make a backdoor.  And in this part we will discuss several distinctive features of Solidity and look at the logical vulnerabilities that can occur in contracts. </p><br><h2 id="evolyuciya-perevoda-ether">  Ether translation evolution </h2><br><p>  To begin with, smart contracts exchange values ‚Äã‚Äãand user addresses with each other.  At the beginning, the broadcasts were transmitted by calling another contract: </p><br><pre><code class="hljs pgsql">msg.sender.<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>(<span class="hljs-number"><span class="hljs-number">42</span></span>) //    msg.sender.<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>(<span class="hljs-number"><span class="hljs-number">42</span></span>)()</code> </pre> <br><p>  However, when calling a contract without specifying a signature, its fallback function will be called, in which there can be an arbitrary code.  Such an unusual logic of work led to the famous reentrancy, with the help of which <a href="http://hackingdistributed.com/2016/06/18/analysis-of-the-dao-exploit/">TheDAO</a> was hacked. </p><br><p>  After that, the <code>send</code> function appeared, which is also just syntactic sugar, - under the hood it has the same call, only the amount of gas is limited, so reentrancy cannot be done. </p><br><pre> <code class="hljs pgsql">msg.sender.send(<span class="hljs-number"><span class="hljs-number">42</span></span>) // msg.sender.<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>(<span class="hljs-number"><span class="hljs-number">42</span></span>).gas(<span class="hljs-number"><span class="hljs-number">2300</span></span>)() -  , ?</code> </pre> <br><p>  However, if something goes wrong and the broadcast cannot be sent, then send will not interrupt the flow of execution.  This behavior can also be critical.  For example, the broadcast was not sent, and the contract status has already changed.  <a href="https://github.com/pertsev/solidity_tricks/tree/master/MoneyTransfer">Someone will be left without ethers</a> . </p><br><p>  Therefore, transfer appeared, and it will raise an exception if something goes wrong. </p><br><pre> <code class="hljs objectivec">msg.sender.transfer(<span class="hljs-number"><span class="hljs-number">42</span></span>) <span class="hljs-comment"><span class="hljs-comment">// if (!msg.sender.send(42)) revert()</span></span></code> </pre> <br><p>  But she is not a silver bullet.  Imagine that we have an array of addresses to which we need to broadcast, and if you use <code>transfer</code> , the success of the whole operation will depend on each of the recipients - if one person does not accept the broadcast, then all changes will be rolled back completely. </p><br><p>  And the last moment with sending the ether is the <code>selfdestruct</code> function. </p><br><pre> <code class="hljs lisp">selfdestruct(<span class="hljs-name"><span class="hljs-name">where</span></span>)</code> </pre> <br><p>  In fact, this is a function for the destruction of the contract, but all the air that remained on the contract will be sent to the address that is specified as an argument.  And this can not be avoided - the air will go away, even if the receiving address is a contract, and the fallback function is not <code>payable</code> (the fallback is simply not called).  The air will be sent even to the not <a href="https://ethereum.stackexchange.com/questions/760/how-is-the-address-of-an-ethereum-contract-computed">yet created</a> contract! </p><br><h2 id="nasledovanie">  Inheritance </h2><br><p>  In Solidity, to resolve multiple inheritance, the <a href="https://en.wikipedia.org/wiki/C3_linearization">C3 linearization</a> algorithm is used (the same as in Python, for example).  And for those who had the good fortune not to step on the multiple inheritance rake, the final graph will most likely not seem obvious.  Consider an example: </p><br><pre> <code class="hljs actionscript">contract Grandfather { bool <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> grandfatherCalled; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pickUpFromKindergarten</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">internal</span></span></span><span class="hljs-function"> </span></span>{ grandfatherCalled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } contract Mom <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Grandfather { bool <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> momCalled; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pickUpFromKindergarten</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">internal</span></span></span><span class="hljs-function"> </span></span>{ momCalled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } contract Dad <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Grandfather { bool <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> dadCalled; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pickUpFromKindergarten</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">internal</span></span></span><span class="hljs-function"> </span></span>{ dadCalled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.pickUpFromKindergarten(); } } contract Son <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Mom, Dad { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sonWannaHome</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.pickUpFromKindergarten(); } }</code> </pre> <br><p>  Continue the call graph starting from Son.sonWannaHome (). </p><br><div class="spoiler">  <b class="spoiler_title">Answer</b> <div class="spoiler_text"><p>  Dad will be called, and then Mom.  Total, inheritance is as follows. <br>  Son -&gt; Dad -&gt; Mom -&gt; Grandfather </p></div></div><br><p>  An example of a more or less plausible contract with a bug regarding multiple inheritance was presented at the <a href="https://pdaian.com/blog/solidity-anti-patterns-fun-with-inheritance-dag-abuse/">Underhanded Solidity Coding Contest</a> . </p><br><h2 id="logicheskie">  brain teaser </h2><br><p>  Smart contracts are written by people, and people are often mistaken ... in the name of variables, <a href="https://www.reddit.com/r/ethereum/comments/4omdlf/to_kickstart_the_building_safer_smart_contracts/">constructors</a> ;  they forget to restrict access to some functions (as, for example, in <a href="https://youtu.be/P8_oh1zjA84%3Ft%3D1786">Parity Multisig</a> ), etc. Also, the developer should closely monitor the possible onset of a race condition, since any function of a smart contract can be called from any address at any time.  It must itself implement the necessary synchronization primitives and access modifiers so that the smart contract can control the sequence of the call.  In addition, there are things that no code analyzer can find ‚Äî domain errors.  Therefore, this section will address the author's vulnerabilities. </p><br><h3 id="implicit-math">  Implicit math </h3><br><p>  In the overwhelming majority of contracts that need to work with mathematics, for example, the <a href="">SafeMath</a> library is used to calculate how many tokens the user receives for <a href="">sending air</a> .  However, the name may be deceptive - in fact, SafeMath only cares about <a href="https://habrahabr.ru/company/dsec/blog/346408/">overflows</a> .  We propose to consider the following piece of contract: </p><br><pre> <code class="hljs cs">contract Crowdsale <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Ownable { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> SafeMath <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>; Token <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> token; address <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> beneficiary; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> collectedWei; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> tokensSold; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> tokensForSale = <span class="hljs-number"><span class="hljs-number">7000000000</span></span> * <span class="hljs-number"><span class="hljs-number">1</span></span> ether; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> priceTokenWei = <span class="hljs-number"><span class="hljs-number">1</span></span> ether / <span class="hljs-number"><span class="hljs-number">200</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> crowdsaleFinished = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">purchase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) payable</span></span> { require(!crowdsaleFinished); require(tokensSold &lt; tokensForSale); require(msg.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &gt;= <span class="hljs-number"><span class="hljs-number">0.001</span></span> ether); <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> sum = msg.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> amount = sum.div(priceTokenWei).mul(<span class="hljs-number"><span class="hljs-number">1</span></span> ether); <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> retSum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(tokensSold.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(amount) &gt; tokensForSale) { <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> retAmount = tokensSold.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(amount).sub(tokensForSale); retSum = retAmount.mul(priceTokenWei).div(<span class="hljs-number"><span class="hljs-number">1</span></span> ether); amount = amount.sub(retAmount); sum = sum.sub(retSum); } tokensSold = tokensSold.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(amount); collectedWei = collectedWei.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(sum); beneficiary.transfer(sum); token.mint(msg.sender, amount); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(retSum &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { msg.sender.transfer(retSum); } LogNewContribution(msg.sender, amount, sum); } }</code> </pre> <br><p>  Noticed anything suspicious?  Most likely not, and this is absolutely normal.  Let's figure it out.  Pay attention to the expression <code>sum.div(priceTokenWei).mul(1 ether)</code> - from the point of view of logic, everything is very smooth: and then multiply by 1 ether to get the units you want. " </p><br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>a</mi><mi>m</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi><mo>=</mo><mo stretchy=&quot;false&quot;>(</mo><mi>s</mi><mi>u</mi><mi>m</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mn>5000000000000000</mn><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x2217;</mo><mn>1000000000000000000</mn></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="61.373ex" height="2.66ex" viewBox="0 -832 26424.5 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMATHI-61" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMATHI-6D" x="529" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMATHI-6F" x="1408" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMATHI-75" x="1893" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMATHI-6E" x="2466" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMATHI-74" x="3066" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-3D" x="3705" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-28" x="4762" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMATHI-73" x="5151" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMATHI-75" x="5621" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMATHI-6D" x="6193" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-2F" x="7072" y="0"></use><g transform="translate(7572,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-35"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="1501" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="2002" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="2502" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="3003" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="3503" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="4004" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="4504" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="5005" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="5505" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="6006" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="6506" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="7007" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="7507" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-29" x="15580" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-2217" x="16192" y="0"></use><g transform="translate(16915,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="1501" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="2002" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="2502" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="3003" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="3503" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="4004" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="4504" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="5005" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="5505" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="6006" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="6506" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="7007" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="7507" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="8008" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="8508" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/347110/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhitov-G5vrvDarvffFa6nOWba8n0Q#MJMAIN-30" x="9009" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>a</mi><mi>m</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi><mo>=</mo><mo stretchy="false">(</mo><mi>s</mi><mi>u</mi><mi>m</mi><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mn>5000000000000000</mn><mo stretchy="false">)</mo><mo>‚àó</mo><mn>1000000000000000000</mn></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> amount = (sum / 5000000000000000) * 1000000000000000000 </script></p><br><p>  But there is a nuance.  Each library call (and there are two of them here) will receive two uint and return also uint, and this, in turn, means that the fractional part of the first operation will be legitimately rejected completely. </p><br><pre> <code class="hljs pgsql">//     SafeMath <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> div(uint256 a, uint256 b) <span class="hljs-type"><span class="hljs-type">internal</span></span> pure <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> (uint256) { uint256 c = a / b; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c; }</code> </pre> <br><p>  Thus, by sending not an integer number of airs to this crowdsale contract, the investor will lose tokens, and ICO can collect more than expected: D The full contract can be found in <a href="https://github.com/pertsev/solidity_tricks/tree/master/ImplicitMath">solidity_tricks</a> . </p><br><h3 id="multiple-voting-through-circular-mining-history-manipulation">  Multiple Voting Through Circular Mining History Manipulation </h3><br><p>  Behind such a long name is a funny vulnerability discovered during the audit of the PoA network contracts.  According to the rules of the network, it has 12 or more validators, which can hold various votes, including the change of key (and, accordingly, addresses) of the validator.  In order that the validator could not change the key and vote twice, the smart contract keeps a history of all the keys.  And when validating a vote, it checks that there is no ancestor among those who voted. </p><br><p>  So, each time the key changes, it is placed in the mapping, where it refers to the previous key.  Therefore, with each new change, the contract has the opportunity to go through the history of keys.  However, in this configuration, without additional checks, the validator can loop the key history and thereby cut off the old keys: </p><br><p>  1) A validator with key A registers the vote X, then requests a change of key.  After that, he has B. in his hands. If he tries to vote with his new key right now, he will fail, because key A is in history B: <br> <code>History(B): B =&gt; A =&gt; 0x</code> </p> <br><p>  2) Therefore, the validator requests the change of the key again, gets the key C. Again, right now the trick will not work for the same reason: <br> <code>History(C): C =&gt; B =&gt; A =&gt; 0x</code> </p> <br><p>  3) Then the validator requests the change of key C to key B. After this, the history of the keys is fixed between B and C, and does not contain A: <br> <code>History(B): B =&gt; C =&gt; B =&gt; C =&gt; B =&gt; ...</code> </p> <br><p>  Now the validator can use the key B or C to vote in the voting X a second time.  <a href="https://github.com/poanetwork/wiki/wiki/POA-Network-Contract-Audit">Fix and original report</a> , as well as other vulnerabilities. </p><br><p>  Right now you may reasonably have two questions: </p><br><ul><li>  Why can a validator change its key so easily? <br>  Answer: In fact, not simply, but through <a href="">voting</a> .  However, there is no verification that the key was already in place (at least, the authors of the report thought so). </li><li>  Why, in theory, the infinite sequence obtained in step 3 does not generate an infinite loop during verification (which should lead to an out-of-gas exception)? <br>  Answer: take a look at the <a href="">check</a> function </li></ul><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">areOldMiningKeysVoted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">uint256 _id, address _miningKey</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">view</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bool</span></span></span><span class="hljs-function">) </span></span>{ VotingData storage ballot = votingState[_id]; IKeysManager keysManager = IKeysManager(getKeysManager()); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint8 i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; maxOldMiningKeysDeepCheck; i++) { address oldMiningKey = keysManager.miningKeyHistory(_miningKey); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (oldMiningKey == address(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ballot.voters[oldMiningKey]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { _miningKey = oldMiningKey; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre> <br><p>  In any case, the cycle size will be no more than 256 repetitions due to the fact that the variable i is defined as uint8. </p><br><p>  The real possibility of exploitation of this vulnerability raises questions from the author, however, it will still be useful to those who are going to keep a unidirectional list in the mapping after it learns in the <a href="https://t.me/eth_ru">chatover</a> on stackoverflow that arrays are expensive :) </p><br><h3 id="generous-refund">  Generous refund </h3><br><p>  The following vulnerability is more likely to ignorance / lack of understanding of the values ‚Äã‚Äãof global variables.  We propose to take a look at one of the possible implementations of the <a href="https://habrahabr.ru/company/dsec/blog/345196/">commit-reveal</a> scheme: </p><br><pre> <code class="hljs php">pragma solidity ^<span class="hljs-number"><span class="hljs-number">0.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span>; import <span class="hljs-string"><span class="hljs-string">'common/Object.sol'</span></span>; import <span class="hljs-string"><span class="hljs-string">'token/Recipient.sol'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@title</span></span></span><span class="hljs-comment"> Random number generator contract */</span></span> contract Random is Object, Recipient { struct Seed { bytes32 seed; uint256 entropy; uint256 blockNum; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@dev</span></span></span><span class="hljs-comment"> Random seed data */</span></span> Seed[] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> randomSeed; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@dev</span></span></span><span class="hljs-comment"> Get length of random seed data */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">randomSeedLength</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">constant</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint256)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> randomSeed.length; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@dev</span></span></span><span class="hljs-comment"> Minimal count of seed data parts */</span></span> uint256 <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> minEntropy; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@dev</span></span></span><span class="hljs-comment"> Set minimal count of seed data * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> _entropy Count of seed data parts */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setMinEntropy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint256 _entropy)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onlyOwner</span></span></span><span class="hljs-function"> </span></span>{ minEntropy = _entropy; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@dev</span></span></span><span class="hljs-comment"> Put new seed data part * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> _hash Random hash */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">put</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bytes32 _hash)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (randomSeed.length == <span class="hljs-number"><span class="hljs-number">0</span></span>) randomSeed.push(Seed(<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> latest = randomSeed[randomSeed.length - <span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (latest.entropy &lt; minEntropy) { latest.seed = sha3(latest.seed, _hash); latest.entropy += <span class="hljs-number"><span class="hljs-number">1</span></span>; latest.blockNum = block.number; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { randomSeed.push(Seed(_hash, <span class="hljs-number"><span class="hljs-number">1</span></span>, block.number)); } <span class="hljs-comment"><span class="hljs-comment">// Refund transaction gas cost if (!msg.sender.send(msg.gas * tx.gasprice)) throw; } /** * @dev Get random number * @param _id Seed ident * @param _range Random number range value */ function get(uint256 _id, uint256 _range) constant returns (uint256) { var seed = randomSeed[_id]; if (seed.entropy &lt; minEntropy) throw; return uint256(seed.seed) % _range; } }</span></span></code> </pre> <br><p>  Did you notice that the smart contract returns the spent gas when committing the next part of the seed (see the put function)?  In itself, the desire to return the spent commission does not fit into the paradigm of the Ethereum platform, but this is not the worst.  The vulnerability here is that the value of msg.gas is controlled by the sender and means the <a href="http://solidity.readthedocs.io/en/v0.4.20/units-and-global-variables.html%3Fhighlight%3Dmsg.gas">remaining</a> gas.  Thus, the attacker, by manipulating the gas of the transaction and its price, can withdraw all funds from the contract. </p><br><h2 id="vmesto-zaklyucheniya">  Instead of conclusion </h2><br><p>  In this article, we examined only a few logical vulnerabilities in order to form the reader‚Äôs intuition about the places where you can make mistakes when writing smart contracts.  In fact, such logical (copyright) vulnerabilities in contracts the most.  They are associated primarily with business logic or subject area.  It also suggests that most contract vulnerabilities cannot be detected by automatic means, at least until they begin to allow the user to describe the criteria for "misbehavior."  By the way, in the next part we will look at what tools still exist, and what they are suitable for in their current state. </p><br><p>  PS I am grateful to <a href="https://habrahabr.ru/users/raz0r/" class="user_link">Raz0r</a> for an example of Generous refund :) </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/347110/">https://habr.com/ru/post/347110/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347098/index.html">Kubernetes success stories in production. Part 7: BlackRock</a></li>
<li><a href="../347100/index.html">#NotNULL Series - Twig</a></li>
<li><a href="../347104/index.html">Report c St. Petersburg Scala MeetUp 2017.3</a></li>
<li><a href="../347106/index.html">As I wrote a telegram bot and uploaded it to a remote server</a></li>
<li><a href="../347108/index.html">Peter Hinchens: The Psychology of Software Architecture</a></li>
<li><a href="../347112/index.html">US exchanges accused of illegally providing benefits to high-frequency traders</a></li>
<li><a href="../347114/index.html">Let there be rock: PHDays 8 will host a music festival</a></li>
<li><a href="../347118/index.html">VMware Dispatch: a new framework for working with serverless applications</a></li>
<li><a href="../347120/index.html">Own pix2code with blackjack, but without neurons</a></li>
<li><a href="../347124/index.html">How dtraceasm works in JMH</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>