<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Kalman, Matlab, and State Space Models</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kuznetsovin recently published a post about using Python to analyze time series in the economy. As a model, the "workhorse" of econometrics was chosen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Kalman, Matlab, and State Space Models</h1><div class="post__text post__text-html js-mediator-article">  <a href="https://habrahabr.ru/users/kuznetsovin/" class="user_link">Kuznetsovin</a> recently published a <a href="http://habrahabr.ru/post/207160/">post</a> about using Python to analyze time series in the economy.  As a model, the "workhorse" of econometrics was chosen - ARIMA, perhaps, one of the most common models for time data.  At the same time, the main disadvantage of ARIMA-like models is that they are not adapted for working with non-stationary rows.  For example, if there is a trend or seasonality in the data, the expectation will have a different meaning in different parts of the series - <img src="https://habrastorage.org/getpro/habr/post_images/582/dda/a4c/582ddaa4cdc1feca2d42daab4d29a29e.png" height="25">  that is not good.  To avoid this, ARIMA expects to work not with the original data, but with their difference (the so-called differentiation - from ‚Äútaking a difference‚Äù).  Everything would be fine, but two problems arise here - (a) we may lose significant information by taking the difference of a series, and (b) the opportunity to decompose a series of data into its constituent components ‚Äî trend, cycle, etc. ‚Äî is missed.  Therefore, in this article I would like to give an alternative method of analysis - State Space Modeling (SSM), in Russian translation - the State Space Model. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  For many English-language names in this area, the translation is either absent or different from different translators, or clumsy until it is completely impossible to use it in a decent society.  Therefore, many names will be given in the English version.  For those interested - one of the best <a href="http://www.amazon.com/Series-Analysis-Methods-Statistical-Science/dp/019964117X">books</a> on SSM modeling.  It also turned out that in the Russian-language translation there are practically no good books on the topic.  As an option - the <a href="http://quantile.ru/09/09-Literacy.pdf">work of</a> Alexander Tsyplakov, which, although published as a separate article, is actually a copy of the book in an extremely abridged version. </div></div><br><br>  So let's get started. <br><br><h4>  1. Initial data analysis </h4><br>  This part is one of the most important parts of the process, because if you make a mistake now, then the rest of the work may simply be a waste of time.  We open the <a href="">data</a> on the shipment of goods at one of the warehouse complexes in the Moscow region, which were used in the previous article.  Build a graph: <br><img src="https://habrastorage.org/getpro/habr/post_images/f88/a0d/1dd/f88a0d1ddb85be8134bcd2797dfbc6c8.jpg"><br>  First, there is clearly a trend and cycle with an order of about 300 days.  Now close the chart.  Let's go smoke.  We will come, we will open it again and look at the numbers themselves.  The date of shipment is in format 01.09.2009, so we open it in Excel and if we translate the data into the format <i>[$ -F800] dddd, mmmm dd, yyyy]</i> so that the day of the week is shown, we note that usually on Saturday the shipping values ‚Äã‚Äãare much lower than the rest of the week.  For example, two weeks are shown in Graph 1. In general, the loader Uncle Vasya goes home on Saturday to watch football early, and because of this, we will have to take into account the presence of a microcycle with a seasonality of 7 days.  By the way, we will not translate the data into a weekly interval, as in the previous article, but continue to work with daily data. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Chart 1</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/517/bb8/b8b/517bb8b8b52f86d24cea89867bf60a0a.jpg" width="600"><br></div></div><br><h4>  2. State Space Modes </h4><br>  Here I will try to give a minimum of theory, more detailed why and where all the formulas come from can be found in the book or I will answer in the comments. <br>  Suppose there is a certain time series <img src="https://habrastorage.org/getpro/habr/post_images/842/84b/dbf/84284bdbf413eff949618e34843b455a.png" height="25">  In our case - the data on the shipment of goods.  As <a href="https://habrahabr.ru/users/kuznetsovin/" class="user_link">kuznetsovin</a> correctly pointed out in the previous article, the data are clearly non-stationary next to the integration order of 1, and the ARIMA procedure would require differentiation of the series.  But since we do not want to do this, then following Harvey [1993], let us assume that this series can be represented as a model with unobservable components (Unobservable Component model): <br><img src="https://habrastorage.org/getpro/habr/post_images/b0f/bf2/500/b0fbf25002b312a48f6831b526264a84.png" width="600"><br>  Where <img src="https://habrastorage.org/getpro/habr/post_images/842/84b/dbf/84284bdbf413eff949618e34843b455a.png" height="25">  - the observed series at time <i>t</i> , which consists of unobservable components: the trend <img src="https://habrastorage.org/getpro/habr/post_images/5ec/c31/1dc/5ecc311dcc0d901785277b79e5347932.png" height="25">  cycle <img src="https://habrastorage.org/getpro/habr/post_images/fc8/4e0/afb/fc84e0afb2a46ce1931fc52625268577.png" height="25">  seasonal variable <img src="https://habrastorage.org/getpro/habr/post_images/cd0/4f9/aa9/cd04f9aa9c8526748b185a31b887e88e.png" height="25">  (in our case equal to one week), and errors <img src="https://habrastorage.org/getpro/habr/post_images/a1a/6c3/9d6/a1a6c39d637153ac6990ce7cb8717929.png" height="25">  which is normally distributed as white noise <img src="https://habrastorage.org/getpro/habr/post_images/e5c/15d/b5d/e5c15db5d3ba676e25d43efcd306345a.png" height="30">  . <br><br>  You can diversify a trend by building it as a model of a local linear trend: <br><img src="https://habrastorage.org/getpro/habr/post_images/828/686/294/8286862948b7c265fbe1699c36375b6b.png" width="600"><br>  where (2) is the actual trend and (3) is the slope of the trend, each with its own mistakes.  This model provides many options for modeling the trend, from random walk with drift to the integrated random walk model.  Many econometricians often remove an error in (2) to get a smooth, smooth trend, and assign random inclination to all random errors. <br><br>  The stochastic cycle is modeled as the sum of trigonometric functions and their derivatives: <br><img src="https://habrastorage.org/getpro/habr/post_images/cb8/1aa/157/cb81aa15745c92b931e4465daa5b2986.png" width="600"><br>  Where <img src="https://habrastorage.org/getpro/habr/post_images/6ba/6f8/f67/6ba6f8f67c455c27615c61f7b3f6168e.png" height="22">  denotes the frequency of the cycle, which is measured in radians <img src="https://habrastorage.org/getpro/habr/post_images/bac/a53/441/baca5344187e46f28295c597cd1cff68.png" height="25">  with the cycle period respectively <img src="https://habrastorage.org/getpro/habr/post_images/f5d/dbc/ea5/f5ddbcea54049c5e67b59002c20d9014.png" height="25">  .  If there is a mood and extra time, we can assume that the frequency changes with time: <img src="https://habrastorage.org/getpro/habr/post_images/f6b/1da/7bc/f6b1da7bc21bed3672570329d49b7d58.png" height="25">  but we will close our eyes and assume that the cycle is completely stationary.  The attenuation coefficient is responsible for ensuring that our cycle does not fly beyond reasonable limits: <img src="https://habrastorage.org/getpro/habr/post_images/31c/81e/101/31c81e101ef82fbbb2adf4851bbcd476.png" height="30">  . <br><br>  And finally, a weekly microcycle with a period of s = 7 will also be built on the basis of the sum of trigonometric functions: <br><img src="https://habrastorage.org/getpro/habr/post_images/ee4/705/fee/ee4705feed38c8519a168e7a766f1e24.png" width="600"><br><br>  Now all the above formulas are left organized in a so-called structural format suitable for the Kalman filter: <br>  The measurement equation describes the data we observe: <br><img src="https://habrastorage.org/getpro/habr/post_images/962/ff2/7bc/962ff27bc9e40f03ed50dd2704be4bec.png" width="600"><br>  and the transition equation - describes the dynamics of the variables that make up <img src="https://habrastorage.org/getpro/habr/post_images/842/84b/dbf/84284bdbf413eff949618e34843b455a.png" height="25">  , but we do not see them (the so-called unobserved or latent variables): <br><img src="https://habrastorage.org/getpro/habr/post_images/061/835/92f/06183592f63d58723b8ef74c119eebf8.png" width="600"><br><br>  In our case, there are 10 latent variables that were defined in equations (2) - (6): <br><img src="https://habrastorage.org/getpro/habr/post_images/831/034/c34/831034c34ac44f80e839f814b5b2fc7c.png" width="600"><br><br>  Now we will translate all the above formulas into a matrix format. <br>  Transition matrix in (7): <br><img src="https://habrastorage.org/getpro/habr/post_images/e7a/c1b/b78/e7ac1bb78f5a28a722c69d10946c0441.png" width="600"><br><br>  A weak matrix of the dynamics of latent variables in (8): <br><img src="https://habrastorage.org/getpro/habr/post_images/165/8e2/df6/1658e2df6262cc5c4065c8beea6675b0.png" width="600"><br><br>  The vector of all errors of all states (2) - (6): <br><img src="https://habrastorage.org/getpro/habr/post_images/a1b/3a6/219/a1b3a62196956acb6d694598bc53cd64.png" width="600"><br>  which is embedded in the equations of dynamics (8) using a matrix <img src="https://habrastorage.org/getpro/habr/post_images/3c9/5c0/e18/3c95c0e18c33072feb720916177e1e69.png" height="25">  . <br><br>  And finally, the matrix of variations of all errors and perturbations in (8): <br><img src="https://habrastorage.org/getpro/habr/post_images/f4f/d72/ea1/f4fd72ea1ba1af1114b45e2374b63c1e.png" width="600"><br><br><h4>  3. Filter and Kalman Smoother </h4><br>  Ok, now we are ready to smoke Kalman.  The filter algorithm has already been <a href="http://habrahabr.ru/post/140274/">repeatedly</a> <a href="http://habrahabr.ru/post/166693/">written</a> , except that we have slightly changed the <s>names and surnames of</s> variable designations.  Therefore, we will not dwell on the theory, only briefly for about forty minutes.  So, there is a visible variable <img src="https://habrastorage.org/getpro/habr/post_images/842/84b/dbf/84284bdbf413eff949618e34843b455a.png" height="25">  and a set of invisible <img src="https://habrastorage.org/getpro/habr/post_images/5eb/89e/fbf/5eb89efbfffe9881e7768ac47ca4410b.png" height="25">  , for which we invented the dynamics and structure in (8) - (14), and which we try to calculate <s>in parrots</s> using the Kalman filter.  Since the latent states are invisible, the model may not be particularly true, and various measurement errors are sure to occur, <img src="https://habrastorage.org/getpro/habr/post_images/5eb/89e/fbf/5eb89efbfffe9881e7768ac47ca4410b.png" height="25">  we are unlikely to meet, and only its expectation at time <i>t</i> based on the observed data <i>1, .., t-1</i> : <img src="https://habrastorage.org/getpro/habr/post_images/01e/d36/34a/01ed3634a5afb3db2e44309fa059ef76.png" height="30">  which has a variance <img src="https://habrastorage.org/getpro/habr/post_images/c8f/39f/a01/c8f39fa0111ea896251c1a25f38f0842.png" height="25">  . <br><br>  Suppose the initial values <img src="https://habrastorage.org/getpro/habr/post_images/358/a15/f1a/358a15f1af2e54f5401d9a78701881bc.png" height="25">  known (in the practical part of the implementation of the algorithm, we simply specify values ‚Äã‚Äãfrom the ceiling), the Kalman filter consists of a set of iterations: <br><img src="https://habrastorage.org/getpro/habr/post_images/43d/a97/4c9/43da974c91ce506e25569de57adbebca.png" width="600"><br>  Where <img src="https://habrastorage.org/getpro/habr/post_images/733/fe6/f05/733fe6f05e2b4570016b9da9b21462d4.png" height="25">  - one-time forecast error with variation <img src="https://habrastorage.org/getpro/habr/post_images/dca/225/13c/dca22513c08d337ac47c01a9c3582327.png" height="25">  , <img src="https://habrastorage.org/getpro/habr/post_images/75b/251/179/75b2511792215504a3683bf7ec76cf78.png" height="25">  - Kalman gain, and so on.  In general, the theory in Africa is the same - that in physics, that in geolocation.  Only the variable notation is changed at the request of the author. <br><br>  In addition to calculating the state vector, we are also interested in finding individual model parameters, such as error variation, cycle frequency, and cycle attenuation parameter.  Call the vector of the required parameters as <img src="https://habrastorage.org/getpro/habr/post_images/cb4/6df/d4c/cb46dfd4c5c4bc9c3e118ab3be5df1d4.png" height="35">  .  Then if <img src="https://habrastorage.org/getpro/habr/post_images/806/1c6/921/8061c692170d4a55f7d331ff96bed617.png" height="25">  and <img src="https://habrastorage.org/getpro/habr/post_images/3c9/e32/7b1/3c9e327b11cf3cf7ca71d97dfc100fd3.png" height="20">  distributed according to Gauss, then the logarithmic likelihood function (Log-likelihood function) of the parameters for our data will be: <br><img src="https://habrastorage.org/getpro/habr/post_images/ff9/96a/7f7/ff996a7f76c8cd044bf3090b54eaeae1.png" width="600"><br><br>  Because <img src="https://habrastorage.org/getpro/habr/post_images/642/88b/51d/64288b51d9b0d57cbaa28450680e76e9.png" height="23">  and <img src="https://habrastorage.org/getpro/habr/post_images/d31/9eb/690/d319eb690c14daf3c42e424f48fda8fd.png" height="23">  then the result from the Kalman filter can be used to calculate the likelihood function based on filter errors: <br><img src="https://habrastorage.org/getpro/habr/post_images/d48/da1/bbd/d48da1bbd036b8b18c22703a62fe5eab.png" width="600"><br>  By maximizing this function, we can find estimates of the required parameters. <img src="https://habrastorage.org/getpro/habr/post_images/3fd/b66/5c8/3fdb665c892de8edd9c3690f3566ce0f.png" height="25">  .  In practice, it is always easier to minimize functions, so we added minus signs in (22), and we will minimize it. <br><br>  Now a few words about another wunderwaffe - Kalman Smoothing (Kalman smoother), [Durbin, J., and Koopman, 2003], which has not yet been mentioned in Habr√©.  In general, the idea is similar, only the Kalman filter calculates each subsequent value. <img src="https://habrastorage.org/getpro/habr/post_images/3c9/55e/444/3c955e444c34b19c7a651535d51e0848.png" height="22">  at time <i>t</i> based on previous data <i>1..t-1</i> : <img src="https://habrastorage.org/getpro/habr/post_images/4ec/0fa/6d5/4ec0fa6d5f9eb7d5c1ccb08e743c9f88.png" height="25">  .  And Kalman Smoother reads a little, and, assuming that we already have all the data, makes it possible to clarify <img src="https://habrastorage.org/getpro/habr/post_images/3c9/55e/444/3c955e444c34b19c7a651535d51e0848.png" height="22">  looking at the whole time series <img src="https://habrastorage.org/getpro/habr/post_images/6e8/710/9fc/6e87109fc48c23ca65065d850a3391e8.png" height="30">  that is, in simple words, it computes <img src="https://habrastorage.org/getpro/habr/post_images/85d/976/e13/85d976e137a2dd5fe6515eb711b3f211.png" height="30">  .  This works well when we already have all the observations and are not interested in future estimates, but rather <s>it is better to dress the</s> exact values ‚Äã‚Äãof the latent variables that make up the dynamics of the series. <br><br>  Kalman smoothing is a reverse recursion: <br><img src="https://habrastorage.org/getpro/habr/post_images/97b/2d6/f09/97b2d6f098a9b56aaf1e2dff35832c6a.png" width="600"><br>  where is the smooth state vector <img src="https://habrastorage.org/getpro/habr/post_images/85d/976/e13/85d976e137a2dd5fe6515eb711b3f211.png" height="25">  will have the smallest variance <img src="https://habrastorage.org/getpro/habr/post_images/528/ce2/d7d/528ce2d7d56fc7261e8538ad0ba3b20d.png" height="25">  .  Smoothing recursion begins at time <i>t = N</i> , and is started backwards, setting zero values ‚Äã‚Äãto the vector <img src="https://habrastorage.org/getpro/habr/post_images/26f/dc5/732/26fdc57328e79c440eeed5f593499f64.png" height="25">  and its dispersions <img src="https://habrastorage.org/getpro/habr/post_images/507/73a/5d2/50773a5d2a16de97a2c7e6061c0ff333.png" height="25">  .  Forecast error values <img src="https://habrastorage.org/getpro/habr/post_images/e72/dff/992/e72dff9929c119b24ebf7958719b5413.png" height="25">  its dispersion <img src="https://habrastorage.org/getpro/habr/post_images/dca/225/13c/dca22513c08d337ac47c01a9c3582327.png" height="25">  and Kalman gain <img src="https://habrastorage.org/getpro/habr/post_images/75b/251/179/75b2511792215504a3683bf7ec76cf78.png" height="25">  taken from the filter, which is driven in the first run. <br><br>  In general, you can still write about the theory for a long time, but already itching to test.  So, let's move on to empirical materialism. <br><br><h4>  4. Regression </h4><br>  I do not pretend to the optimality and speed of the following programs in Matlab, I am not a real welder, all the code was written for myself.  Unaesthetic, but cheap, reliable and practical.  Also, the code for the filter and the smoother is somewhat redundant, since it is written for different initialization variants and so on.  Attempting to throw out part of the code inevitably led to Matlab's departures getting lost in the matrices and cycles, and so I decided to leave everything as it is. <br><br>  Everything works like this: <br><ol><li>  The main program <b>otgr_ssm.m</b> loads data, prepares the <b>ssmopt</b> structure, which contains many valuable comments and important variables that will be transmitted to different places in the code.  The last 70 values ‚Äã‚Äãfor shipment (10 weeks) will be set aside for comparison with the forecast, which we will definitely build at the end. </li><li>  The data is uploaded to the maximization routine Log-likelihood function.  The latter procedure is often used in econometrics, so it was quickly written on the knee in general form as a separate function <b>mle_my.m</b> so as not to litter the main code. </li><li>  since the desired parameters include the dispersions of states, they must be strictly positive, which is not always obtained in the course of numerical optimization.  Therefore, we change pawns to ryumash and all input values ‚Äã‚Äãof the variances will be transformed as <img src="https://habrastorage.org/getpro/habr/post_images/44e/df9/226/44edf922641e860cc1892c573e8dcaef.png" height="25">  and the value of the attenuation coefficient is normalized in the range <img src="https://habrastorage.org/getpro/habr/post_images/fa1/523/3f8/fa15233f8316e07408e74ecd31784842.png" height="25">  as <img src="https://habrastorage.org/getpro/habr/post_images/7a8/466/058/7a846605898d2bd0b00999fd865396a1.png" height="20">  .  Well, at the output, it is transformed back to get the correct values ‚Äã‚Äã- <img src="https://habrastorage.org/getpro/habr/post_images/102/7ad/b54/1027adb54a8ba76fd00f2ffd12436cf8.png" height="25">  for variations and <img src="https://habrastorage.org/getpro/habr/post_images/07d/be9/519/07dbe951914dc5f65e3e516825c74dc4.png" height="25">  for attenuation coefficient.  The ssmopt.trans value indicates whether to transform (1) or not (0), and which way is 'in', or 'out'.  All this happens with the help of a separate function <b>transform.m</b> </li><li>  <b>mle_my.m</b> calls the object function <b>f_obj.m</b> , which <b>runs the</b> Kalman filter (15) - (22) using <b>kfmy2.m</b> , calculates the value of the Log-likelihood function (22), and, in order not to get up, calculates the Kalman Smoother (23 ) - (27) using <b>ksmy2.m</b> .  This is all sent back to <b>mle_my.m</b> , which checks <b>whether</b> we have reached the maximum of function (22) or not.  If yes, then everything is on the way out, to point 5. If not, then repeat steps 2-4. <br>  The very first start of the filter begins with the assumption that <img src="https://habrastorage.org/getpro/habr/post_images/735/6d5/6a1/7356d56a1687b26a43a97d5c3e408058.png" height="20">  .  Here you can play, because there are a lot of variables, and we are searching for the global maximum of the six-dimensional function, therefore many local extremes are possible.  In an amicable way, one could construct graphs of possible values ‚Äã‚Äãof the log function and look at possible extremes. </li><li>  We display the results - found parameters and graphs.  At the same time let's calculate the prediction for 70 days and compare it with real data using <b>frcst.m</b> </li></ol><br>  Actually, the code: <br><div class="spoiler">  <b class="spoiler_title">otgr_ssm.m</b> <div class="spoiler_text"><pre><code class="matlab hljs">clear all; clc; close all; format long; <span class="hljs-comment"><span class="hljs-comment">%------------------- 1. Load and prepare data ------------------------------ load otgruzka.mat; % Structure ssmopt contains several important records used throughout the code ssmopt.frcst=70; % forecast length yend=y(end-ssmopt.frcst+1:end); % saved last observation for the forecast comparison y=y(1:end-ssmopt.frcst); ssmopt.N=length(y); ssmopt.trans=1; % transform estimated parameters to preserve positiveness of variances ssmopt.sv=[5e+8;500;5e+8;5e+8;0.05;0.9]; % starting values ssmopt.mle='f_obj'; % name of the objective function for the maximization ssmopt.sv=transform(ssmopt.sv,'in',ssmopt); ssmopt.filter='kfmy2'; % name of the function computing Kalman Filter ssmopt.smooth='ksmy2'; % name of the function computing Kalman Smoother %------------------- 2. Estimate the model ------------------------------ result=mle_my(y,ssmopt); % call Maximum Likelihood maximization function b=transform(result.b,'out',ssmopt); % transform parameters back % recompute data based on the correct non-transformed parameters ssmopt.trans=0; ssmopt.sv=b; [LH,KF_out,Ksm_out] = feval(ssmopt.mle,b,y, ssmopt); % Recover filtered states series - trend, cycle, and seasonal a_trend=KF_out.Afilt(1,:); a_cycle=KF_out.Afilt(3,:); a_seas=KF_out.Afilt(5,:)+KF_out.Afilt(7,:)+KF_out.Afilt(9,:); y_filt=a_trend+a_cycle+a_seas; % build the estimated filtered series Y % Recover smoothed states series - trend, cycle, and seasonal a_trendsm=Ksm_out.Asm(1,:); a_cyclesm=Ksm_out.Asm(3,:); a_seassm=Ksm_out.Asm(5,:)+Ksm_out.Asm(7,:)+Ksm_out.Asm(9,:); y_smooth=a_trendsm+a_cyclesm+a_seassm; % build the estimated smoothed series Y result=mle_my(y,ssmopt); % find correct Hessian for non-transformed parameters %------------------- 3. Compute estimation statistics ------------------------------ %Find standard errors, and p-values se=sqrt(abs(diag(inv(result.hessian)/ssmopt.N))); % se(b) tstat=b./se; % t-statistics pval=2*(1-tcdf(abs(tstat),ssmopt.N-length(ssmopt.sv))); % p-value % Display output fprintf('Estimated parameters and p-values:\n'); out=[b pval] period=2*pi/b(end-1) % Compute R-squared resid=y-y_filt; % estimation errors SSE=resid*resid'; % Sum of Squared Errors SST=(y-mean(y))*(y-mean(y))'; % Sum of Squares Total R2=1-SSE/SST % R-squared' %------------------- 4. Make Forecast ------------------------------ af0=KF_out.Afilt(:,end-ssmopt.frcst); [yf,af]=frcst(b,y,ssmopt, af0); %------------------- 5. Plot results ------------------------------ %p=ssmopt.N; p=600; t=[1:1:p]; figure(1) plot(t,y(1:p),'k',t,y_filt(1:p),'b',t,y_smooth(1:p),'r--') title('Original, Filtered, and Smoothed data') legend('y(t)','y filtered','y smoothed'); figure(2) plot(t,y(1:p),'k',t,a_trend(1:p),'b',t,a_trendsm(1:p),'r--') title('Original data, Filtered and Smoothed trend') legend('y(t)','Filtered trend','Smoothed trend'); figure(3) plot(t,a_cycle(1:p),'b',t,a_cyclesm(1:p),'r--') title('Filtered and Smoothed cycle') legend('Filtered cycle','Smoothed cycle'); figure(4) % Filtered + smoothed seasonal plot(t,a_seas(1:p),'b',t,a_seassm(1:p),'r--') title('Filtered and Smoothed weekly seasonal') legend('Filtered seasonal','Smoothed seasonal'); t=[1:1:ssmopt.frcst]; figure(5) plot(t,yend,'b',t,yf,'r--') title('Original data and Forecast') legend('Original data','Forecast'); RMSE=sqrt(sum((yend - yf).^2)/ssmopt.frcst) % Root Mean Squared Error</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">mle_my.m</b> <div class="spoiler_text"><pre> <code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">result_mle</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mle_my</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(y,mleopt)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">warning</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">off</span></span></span><span class="hljs-function">; %---------------- 1. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Set</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">up</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">minimization</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">options</span></span></span><span class="hljs-function"> ---------------- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">options</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">optimset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('fminunc')</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">options</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">optimset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('LargeScale', 'off' , ... 'HessUpdate', 'bfgs' , ... 'LineSearchType', 'quadcubic' , ... 'GradObj' , 'off' , ... 'Display','off' , ... 'MaxIter' , 1000 , ... 'TolX', 1e-12 , ... 'TolFun' , 1e-12, ... 'DerivativeCheck' , 'off' , ... 'Diagnostics' , 'off' , ... 'MaxFunEvals', 1000)</span></span></span><span class="hljs-function">; %---------------- 2. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">minimization</span></span></span><span class="hljs-function"> ---------------- </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[b,fval,exitflag,output,grad,hessian]</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fminunc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mleopt.mle,mleopt.sv,options,y,mleopt)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">warning</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">result_mle</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">result_mle</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fval</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fval</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">result_mle</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">output</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">output</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">result_mle</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hessian</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hessian</span></span></span><span class="hljs-function">;</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">f_obj.m</b> <div class="spoiler_text"><pre> <code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[obj,KF_out,Ksm_out]</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f_obj_tr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b,y,ssmopt)</span></span></span><span class="hljs-function">; %---------------- 1. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Recover</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parameters</span></span></span><span class="hljs-function"> ------------------------------------ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transform</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b,'out',ssmopt)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s2_irr</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s2_tr</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(2)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s2_cyc</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(3)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s2_seas</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(4)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">freq</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(5)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rho</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(6)</span></span></span><span class="hljs-function">; %---------------- 2. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Build</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">the</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model</span></span></span><span class="hljs-function"> ------------------------------------ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmopt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmodel</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">states</span></span></span><span class="hljs-function">=10; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmopt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmodel</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Z</span></span></span><span class="hljs-function">=</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[1 0 1 0 1 0 1 0 1 0]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">T1</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[1 1 0 0; 0 1 0 0; 0 0 rho*cos(freq) rho*sin(freq); 0 0 -rho*sin(freq) rho*cos(freq)]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">T2</span></span></span><span class="hljs-function">=</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[cos(2*pi/7) sin(2*pi/7) 0 0 0 0;... -sin(2*pi/7) cos(2*pi/7) 0 0 0 0;... 0 0 cos(4*pi/7) sin(4*pi/7) 0 0;... 0 0 -sin(4*pi/7) cos(4*pi/7) 0 0;... 0 0 0 0 cos(6*pi/7) sin(6*pi/7);... 0 0 0 0 -sin(6*pi/7) cos(6*pi/7)]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmopt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmodel</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">T</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[T1 zeros(rows(T1),cols(T2));zeros(rows(T2),cols(T1)) T2]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmopt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmodel</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eye</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(10)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmopt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmodel</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1,1)</span></span></span><span class="hljs-function">=0; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">H</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s2_irr</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Q</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zeros</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(10,10)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Q</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(2,2)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s2_tr</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Q</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(3,3)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s2_cyc</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Q</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(4,4)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s2_cyc</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Q</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(5,5)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s2_seas</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Q</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(6,6)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s2_seas</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Q</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(7,7)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s2_seas</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Q</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(8,8)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s2_seas</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Q</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(9,9)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s2_seas</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Q</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(10,10)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s2_seas</span></span></span><span class="hljs-function">; %---------------- 3. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Suggest</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">starting</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">conditions</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">the</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">states</span></span></span><span class="hljs-function"> ------------------------ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a0</span></span></span><span class="hljs-function">=</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[y(1);0;0;0;0;0;0;0;0;0]</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">P0</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eye</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ssmopt.ssmodel.states)</span></span></span><span class="hljs-function">*1</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e</span></span></span><span class="hljs-function">+10; %---------------- 4. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kalman</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filter</span></span></span><span class="hljs-function"> ------------------------ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KF_out</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">feval</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ssmopt.filter,y, ssmopt, Q, H, a0, P0)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">obj</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KF_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LH</span></span></span><span class="hljs-function">; %---------------- 5. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kalman</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">smoother</span></span></span><span class="hljs-function"> ------------------------ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nargout</span></span></span><span class="hljs-function">&gt;2 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmopt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmodel</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">num_etas</span></span></span><span class="hljs-function">=3; % </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">number</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">of</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">the</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">state</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">variances</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(required for Kalman smoother)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ksm_out</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">feval</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ssmopt.smooth,KF_out, ssmopt)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">kfmy2.m</b> <div class="spoiler_text"><pre> <code class="matlab hljs"><span class="hljs-comment"><span class="hljs-comment">% Kalman filter % y[t] = Z*alpha[t] + eps, eps ~ N(0,H). % alpha[t] = T*alpha[t-1] + R*eta, eta ~ N(0,Q). % v[t]=y[t]-E(y[t]) = y[t]-Z*a[t] % F[t]=var(v[t]) function KF_out = kfmy_koop(y, ssmopt, Q, H, a, P); N=ssmopt.N; m=ssmopt.ssmodel.states; %---------------- 1. Recover parameters and prepare matrices ---------------- T=ssmopt.ssmodel.T; Z=ssmopt.ssmodel.Z; R=ssmopt.ssmodel.R; KF_out.Vmat=zeros(1,N); KF_out.Fmat=zeros(1,N); KF_out.Afilt=zeros(m,N); KF_out.Pfilt=zeros(m,m,N); KF_out.Kmat=zeros(m,N); KF_out.Lmat=zeros(m,m,N); LHmat=zeros(1,N); if ~isfield(ssmopt,'exactcheck'); ssmopt.exactcheck=1; % set exact filter initialization by default end; %---------------- 2. Set default starting values for a and P , if none provided ---------------- Pinf=eye(m); if nargin &lt; 6 if ssmopt.exactcheck==1 P=zeros(m,m); else P=eye(m)*1000000000; end end if nargin &lt; 5 a=[y(1); zeros(m-1,1)]; end KF_out.Afilt(:,1)= a; KF_out.Pfilt(:,:,1) = P; d=0; %---------------- 3. Exact Filtering ---------------- if ssmopt.exactcheck==1 evals=10; % number of time steps to evaluate until Pinf converges to zero KF_out.exact.F1=zeros(1,evals); KF_out.exact.F2=zeros(1,evals); KF_out.exact.L1=zeros(m,m,evals); KF_out.exact.Pinf=zeros(m,m,evals); KF_out.exact.Pinf(:,:,1)=Pinf; for i=1:evals if sum(sum(Pinf))&lt;1e-20; d=i-1; % time point after which Pinf--&gt;0, and after which we may start regular Kalman filter break; else if sum(Pinf*Z')&gt;0 % Pinf is not singular F1=inv(Z*Pinf*Z'); F2=-F1*(Z*P*Z'+H)*F1; K=T*Pinf*Z'*F1; K1=T*(P*Z'*F1+Pinf*Z'*F2); L=TK*Z; L1=-K1*Z; P=T*Pinf*L1' + T*P*L' + R*Q*R'; Pinf=T*Pinf*L'; else F1=Z*P*Z'+H; F2=F1; K=T*P*Z'/F1; L=TK*Z; L1=L; P=T*P*L' + R*Q*R'; Pinf=T*Pinf*T'; end v=y(i) - Z*a; a=T*a+K*v; %save filtered estimates KF_out.Afilt(:,i+1)=a; KF_out.Pfilt(:,:,i+1)=P; KF_out.Vmat(i)=v; KF_out.Fmat(i)=F1; KF_out.Kmat(:,i)=K; KF_out.Lmat(:,:,i)=L; LHmat(i) = -0.5*(log(2*pi*F1) + v^2/F1); %save exact values for smoother KF_out.exact.F1(i)=F1; KF_out.exact.F2(i)=F2; KF_out.exact.L1(:,:,i)=L1; KF_out.exact.Pinf(:,:,i+1)=Pinf; end end end %---------------- 4. Regular Filtering ---------------- for i=d+1:N v=y(i) - Z*a; f=Z*P*Z' + H; K=T*P*Z'/f; L=TK*Z; a=T*a+K*v; P=T*P*L'+R*Q*R'; if i&lt;N KF_out.Afilt(:,i+1)=a; KF_out.Pfilt(:,:,i+1)=P; end KF_out.Vmat(i)=v; KF_out.Fmat(i)=f; KF_out.Kmat(:,i)=K; KF_out.Lmat(:,:,i)=L; LHmat(i) = -0.5*(log(2*pi*f) + v^2/f); end %---------------- 5. Prepare output ---------------- KF_out.LH=-sum(LHmat); KF_out.Q=Q; KF_out.H=H; KF_out.exact.d=d; end</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">ksmy2.m</b> <div class="spoiler_text"><pre> <code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[Ksm_out, Kdism_out]</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ksmy2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(KF_out, ssmopt)</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[m,N]</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(KF_out.Afilt)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">meta</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmopt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmodel</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">num_etas</span></span></span><span class="hljs-function">; %---------------- 1. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Recover</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filtered</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">matrices</span></span></span><span class="hljs-function"> ---------------- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Fmat</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KF_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Fmat</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Vmat</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KF_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Vmat</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pfilt</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KF_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pfilt</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Afilt</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KF_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Afilt</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Q</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KF_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Q</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">H</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KF_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">H</span></span></span><span class="hljs-function">; %---------------- 2. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Recover</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Model</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">structure</span></span></span><span class="hljs-function"> ---------------- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Z</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmopt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmodel</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Z</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">T</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmopt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmodel</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">T</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmopt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmodel</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Asm</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zeros</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(m,N)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Psm</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zeros</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(m,m,N)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rmat</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zeros</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(m,N)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Nmat</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zeros</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(m,m,N)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Eps</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zeros</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1,N)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Eta</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zeros</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(meta,N)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kmat</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KF_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kmat</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KF_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> ~</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isfield</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(KF_out,'exact')</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KF_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exact</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-function">=0; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KF_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exact</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KF_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exact</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-function">&gt;0 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L1</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KF_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exact</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L1</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">F1</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KF_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exact</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">F1</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">F2</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KF_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exact</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">F2</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pinf</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KF_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exact</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pinf</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> %---------------- 3. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Regular</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Smoothing</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N</span></span></span><span class="hljs-function">..</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-function">+1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">observations</span></span></span><span class="hljs-function"> ---------------- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N</span></span></span><span class="hljs-function">:-1:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-function">+1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Z</span></span></span><span class="hljs-function">'/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Fmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Vmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i)</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Z</span></span></span><span class="hljs-function">'/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Fmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Z</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Nmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Asm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Afilt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pfilt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Psm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pfilt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pfilt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pfilt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i</span></span></span><span class="hljs-function">&gt;1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i-1)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Nmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i-1)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nargout</span></span></span><span class="hljs-function">&gt;1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Eps</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">H</span></span></span><span class="hljs-function">*</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1/(Fmat(i)</span></span></span><span class="hljs-function">)*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Vmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i)</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function">); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Eta</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Q</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> %---------------- 4. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Exact</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Smoothing</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-function">..1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">observations</span></span></span><span class="hljs-function"> ---------------- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KF_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exact</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-function">&gt;0 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r1</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zeros</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(m,1)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N1</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zeros</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(m,m)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N2</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zeros</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(m,m)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">d</span></span></span><span class="hljs-function">:-1:1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Pinf(:,:,i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Z</span></span></span><span class="hljs-function">')&gt;0 %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cond</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Pinf)</span></span></span><span class="hljs-function">&lt;1</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e</span></span></span><span class="hljs-function">+12 % </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pinf</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">not</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">singular</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r1</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Z</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">F1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Vmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i)</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r1</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N2</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Z</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">F2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Z</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N2</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N1</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N1</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Nmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N1</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Z</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">F1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Z</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N1</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Nmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r1</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Nmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nargout</span></span></span><span class="hljs-function">&gt;1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Eps</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i)</span></span></span><span class="hljs-function">=-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">H</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Eta</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Q</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">else</span></span></span><span class="hljs-function"> % </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pinf</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">singular</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r1</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">T</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N2</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">T</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N2</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">T</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N1</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">T</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N1</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Z</span></span></span><span class="hljs-function">'/</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Fmat(i)</span></span></span><span class="hljs-function">)*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Vmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i)</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Z</span></span></span><span class="hljs-function">'/</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Fmat(i)</span></span></span><span class="hljs-function">)*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Z</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Nmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nargout</span></span></span><span class="hljs-function">&gt;1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Eps</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">H</span></span></span><span class="hljs-function">*</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1/Fmat(i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Vmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i)</span></span></span><span class="hljs-function"> - </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function">); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Eta</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Q</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R</span></span></span><span class="hljs-function">'*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i</span></span></span><span class="hljs-function">&gt;1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i-1)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Nmat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i-1)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Asm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Afilt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,i)</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pfilt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pinf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r1</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Psm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pfilt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pfilt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pfilt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function"> - </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Pinf(:,:,i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N1</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pfilt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">)' - </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pinf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N1</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pfilt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function"> - </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pinf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">N2</span></span></span><span class="hljs-function">*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pinf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(:,:,i)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> %---------------- 5. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Prepare</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">output</span></span></span><span class="hljs-function"> ---------------- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ksm_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Asm</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Asm</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ksm_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Psm</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Psm</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ksm_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kmat</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kmat</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ksm_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lmat</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ksm_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Nmat</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Nmat</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ksm_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rmat</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rmat</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kdism_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Eps</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Eps</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kdism_out</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Eta</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Eta</span></span></span><span class="hljs-function">;</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">transform.m</b> <div class="spoiler_text"><pre> <code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transform</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b,howto,ssmopt)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">k</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">length</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">strcmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(howto,'in')</span></span></span><span class="hljs-function"> % </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">in</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transformation</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmopt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trans</span></span></span><span class="hljs-function">==0 % </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">no</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transformation</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmopt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trans</span></span></span><span class="hljs-function">==1 % </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transformation</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">preserve</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">the</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">positiveness</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">of</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">variances</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1:k-1,:)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b(1:k-1,:)</span></span></span><span class="hljs-function">); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(k)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1/b(k)</span></span></span><span class="hljs-function">-1); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">else</span></span></span><span class="hljs-function"> % </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">out</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transformation</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmopt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trans</span></span></span><span class="hljs-function">==0 % </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">no</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transformation</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssmopt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trans</span></span></span><span class="hljs-function">==1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1:k-1,:)</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b(1:k-1,:)</span></span></span><span class="hljs-function">); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(k)</span></span></span><span class="hljs-function">=1/</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1+exp(b(k)</span></span></span><span class="hljs-function">)); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span></span></code> </pre><br></div></div><br><h4>  5. Results </h4><br>  (p-values ‚Äã‚Äãof the found estimates are shown in brackets) <br><table border="1" width="400"><tbody><tr><td>  The variance of the error of the observed series <img src="https://habrastorage.org/getpro/habr/post_images/838/7eb/1ce/8387eb1ceecb4475b7ab056a535b570a.png" height="30"></td><td>  1.77E + 009 (0.00) </td></tr><tr><td>  Trend Error Dispersion <img src="https://habrastorage.org/getpro/habr/post_images/7b4/feb/bb1/7b4febbb1bc4f2e373d79c9d9645598d.png" height="30"></td><td>  348.73 (0.00) </td></tr><tr><td>  Cycle variance <img src="https://habrastorage.org/getpro/habr/post_images/684/5ef/6dc/6845ef6dc79108f1fc3418c843f29ccd.png" height="30"></td><td>  6.07E + 008 (0.00) </td></tr><tr><td>  Seasonal component error variance <img src="https://habrastorage.org/getpro/habr/post_images/2eb/143/2ad/2eb1432adb43d5f7fc59a6cf9e530a2e.png" height="30"></td><td>  3.91E + 006 (0.00) </td></tr><tr><td>  Cycle frequency <img src="https://habrastorage.org/getpro/habr/post_images/064/7c8/2e0/0647c82e00b4223868c9135176930c2c.png" height="25"></td><td>  3.91E + 006 (0.00) </td></tr><tr><td>  Cycle period (days) </td><td>  362.6 (0.00) </td></tr><tr><td>  Cycle attenuation coefficient <img src="https://habrastorage.org/getpro/habr/post_images/3be/c8c/d5d/3bec8cd5dec32cd8942567cf28ba14d8.png" height="30"></td><td>  0.891 (0.00) </td></tr><tr><td>  R-squared regression </td><td>  0.78 </td></tr></tbody></table><br><h4>  6. Charts </h4><br>  For convenience of perception, the graphs are shown only for the first 600 days, hidden for spoilers for the whole series. <br>  <b>a.</b>  <b>Original, filtered, and smoothed data</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/3a9/5e2/0b3/3a95e20b3fab1f22ac3d4a67ad8248b2.png"><br><div class="spoiler">  <b class="spoiler_title">Whole row</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/389/63d/dad/38963ddad940b1f4002ca8b5638c171f.png"></div></div><br><br>  <b>b.</b>  <b>Baseline, filtered trend, smoothed trend</b> <br>  As you can see, the Kalman filter tries to guess the trend based on previous values, and therefore oscillates along with the batch line, but is a bit late, trying to guess where our data will go further.  The Kalman smoother ‚Äúsees‚Äù the entire series, and therefore the trend looks much smoother and calmer: <br><img src="https://habrastorage.org/getpro/habr/post_images/62e/1ab/09a/62e1ab09a33325591f7e0407f1ccc618.png"><br><div class="spoiler">  <b class="spoiler_title">Whole row</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/c33/185/a69/c33185a691ab0dd9a8ccf4f106c4fd82.png"></div></div><br><br>  <b>c.</b>  <b>Filtered and smoothed cycle</b> <br>  As can be seen from the table with the results, the average cycle length is about 362 days, or almost one year (who would be surprised).  It also shows how at the very beginning the filter begins to be calibrated and completely misses the data, because we set the initial values ‚Äã‚Äãof the latent variables to zero and a very large variance of about 1e + 10.  But usually a few (2-5) first attempts are enough to filter the rhythm.  By the way, exact initialization of the filter (exact initialization) was used in this work, which helps the filtered values ‚Äã‚Äãto run faster with the data. <br><img src="https://habrastorage.org/getpro/habr/post_images/e7d/908/57a/e7d90857a201b40077a58673e2e6b40b.png"><br><div class="spoiler">  <b class="spoiler_title">Whole row</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/c0b/1d2/6a0/c0b1d26a09e676a7608f5f557005c15f.png"></div></div><br><br>  <b>d.</b>  <b>Filtered and smoothed weekly seasonal factor</b> <br>  The number of shipments is gradually increasing, and the daily volatility increases: <br><img src="https://habrastorage.org/getpro/habr/post_images/ea1/204/8d7/ea12048d78422d27660d041be6a49e51.png"><br><div class="spoiler">  <b class="spoiler_title">Whole row</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/687/3d1/5da/6873d15da2130973c1d4f10ebdf1f623.png"></div></div><br><br><h4>  6. Forecast </h4><br>  Based on the obtained parameters and using the latest values ‚Äã‚Äãof the filtered states, we build a forecast for 70 days (10 weeks) and compare it with the existing data.  In general, the forecast looks good, that's what the life-giving filter does.  Especially pleased guessed volatility on days of the week.  If you look at the entire length of the forecast and turn on the imagination, you can also see how the forecast bends under the annual cycle of shipment.  The only time where the forecast did not work - from 26 to 32 days.  But there was clearly an almost weekly drop in shipments, as well as a sharp jump immediately behind it, which it was hardly possible to foresee, since such a case occurred only once at the very beginning of the series.  In general, and what fell, so from cloudiness. <br><img src="https://habrastorage.org/getpro/habr/post_images/8bc/ee6/e70/8bcee6e7063ed1f2944c67582ade05f2.png"><br>  The forecast RMSE is 1.112e + 005, in case we want to compare the model. <br><br>  Well that's all. <br><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  State Space Models should not be taken as something worthwhile in Econometrics.  On the contrary, they represent a generic version for many more specific models.  For example, MA (1) process <br><img src="https://habrastorage.org/getpro/habr/post_images/d20/bf3/813/d20bf3813166bfabe346d13115c84cdf.png" width="600"><br>  easy to imagine in SSM form: <br><img src="https://habrastorage.org/getpro/habr/post_images/7ea/a95/e7b/7eaa95e7bd766ec630d4f1d691b585fb.png" width="600"><br>  Or ARMA (2,1) process: <br><img src="https://habrastorage.org/getpro/habr/post_images/4bd/ea0/e11/4bdea0e11ebadf465288b22609b556a3.png" width="600"><br>  Packed in SSM format: <br><img src="https://habrastorage.org/getpro/habr/post_images/3fc/ac5/ea1/3fcac5ea1de4d90c9f19b9f4bbe90aaf.png" width="600"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Related Literature</b> <div class="spoiler_text"><ul><li>  Durbin, J., and Koopman, SJ, Time Series Analysis by State Space Methods.  Oxford: Oxford University Press, 2001. </li><li>  Durbin, J., and Koopman, SJ ‚ÄúA simple and efficient simulation for state space time analysis‚Äù Biometrika vol.  89, issue 3, 2002. </li><li>  Harvey, AC, and Jaeger, A. ‚ÄúDetrending, stylized facts and the business cycle.‚Äù Journal of Applied Econometrics (8), 1993. </li><li>  Harvey, AC Forecasting, Structural Time Series Models and the Kalman Filter.  Cambridge: Cambridge University Press, 1989. </li></ul><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/209640/">https://habr.com/ru/post/209640/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../209616/index.html">Role-playing technology. Part 3. Technology in the entourage and mastering</a></li>
<li><a href="../209618/index.html">Why not use RJS</a></li>
<li><a href="../209624/index.html">Panorama of the Moon from "Chang'e 3" and the failure of the main color camera of the landing module</a></li>
<li><a href="../209626/index.html">Lightpack. Unboxing and installation</a></li>
<li><a href="../209630/index.html">Bird stole camera and aerial photo of penguin colony</a></li>
<li><a href="../209642/index.html">Mail Encryption in Outlook 2010</a></li>
<li><a href="../209644/index.html">SELinux - description and features of working with the system. Part 1</a></li>
<li><a href="../209646/index.html">Experience does not matter</a></li>
<li><a href="../209650/index.html">Mobile game: where is the money?</a></li>
<li><a href="../209652/index.html">What nobody says to newbies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>