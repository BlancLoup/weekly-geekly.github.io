<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How Passport.js works</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="PassportJS is the middleware for authorization under node.js. Passport supports authorization using a huge number of services, including VKontakte and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How Passport.js works</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://passportjs.org/"><img src="https://habrastorage.org/getpro/habr/post_images/7de/295/6b4/7de2956b40fe944f455aae15838f7fe6.png"></a> <br>  PassportJS is the middleware for authorization under node.js.  Passport supports authorization using a huge number of services, including VKontakte and other twitter.  The list of services can be viewed <a href="http://passportjs.org/guide/providers/">here</a> .  I want to talk a little bit about how this middleware works on the example of the most common authorization using a login and password. <br><br>  For the most impatient - the finished project can be viewed <a href="https://github.com/shuvalov-anton/passport-auth-example">here</a> . <br><a name="habracut"></a><br><h4>  Dependencies: </h4><br><ul><li>  "Express": "3.3.7", </li><li>  "Passport": "~ 0.1.17", </li><li>  "Passport-local": "~ 0.1.6", </li><li>  "Mongoose": "~ 3.8.0", </li></ul><br><br>  Also, I will use for convenience a few additional utilities.  You can do without them: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  "Jade": "*" </li><li>  "Bootable": "~ 0.1.0" </li><li>  "Nconf": "~ 0.6.8" </li><li>  "Require-tree": "~ 0.3.2" </li><li>  "Winston": "~ 0.7.2" </li></ul><br><br><h4>  User Model </h4><br>  To begin with, I think you can create a user model: <br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> UserSchema = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> mongoose.Schema({ <span class="hljs-attr"><span class="hljs-attr">username</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, <span class="hljs-attr"><span class="hljs-attr">unique</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">required</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, <span class="hljs-attr"><span class="hljs-attr">password</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, <span class="hljs-attr"><span class="hljs-attr">required</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, }); mongoose.model(<span class="hljs-string"><span class="hljs-string">'user'</span></span>, UserSchema);</code> </pre> <br><br>  Here you could salt the password, and add a bit of security magic to the god of security, but I leave it to you =). <br><br><h4>  Authorization strategy </h4><br><br><h5>  Verification </h5><br>  We connect and configure an authorization strategy. <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> passport = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'passport'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> LocalStrategy = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'passport-local'</span></span>).Strategy; passport.use(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LocalStrategy({ <span class="hljs-attr"><span class="hljs-attr">usernameField</span></span>: <span class="hljs-string"><span class="hljs-string">'email'</span></span>, <span class="hljs-attr"><span class="hljs-attr">passwordField</span></span>: <span class="hljs-string"><span class="hljs-string">'password'</span></span> }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">username, password,done</span></span></span><span class="hljs-function">)</span></span>{ User.findOne({ <span class="hljs-attr"><span class="hljs-attr">username</span></span> : username},<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err,user</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err ? done(err) : user ? password === user.password ? done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, user) : done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, { <span class="hljs-attr"><span class="hljs-attr">message</span></span>: <span class="hljs-string"><span class="hljs-string">'Incorrect password.'</span></span> }) : done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, { <span class="hljs-attr"><span class="hljs-attr">message</span></span>: <span class="hljs-string"><span class="hljs-string">'Incorrect username.'</span></span> }); }); }));</code> </pre><br><br>  LocalStrategy takes 2 parameters: an object with options and middleware for user verification. <br>  By default, if you don‚Äôt pass any options in `LocalStrategy`, the strategy will look for parameters for authorizing the user in the forms named` username` and `password`.  If you wish, you can specify your form names, as I actually did. <br>  The second argument, middleware, takes the parameters `username`,` passport` and `done`.  In done, the second argument is passing the user object, if there is one. <br><br><h5>  Binding authorization to the user </h5><br>  In a typical web application, the credentials used to authenticate the user will be transmitted only during authorization.  If everything is in order, and the user exists, then information about him is stored in the session, and the session identifier, in turn, is saved in the browser cookies. <br><br>  Each subsequent request will contain cookies, by which passport will be able to identify the user, and retrieve his data from the session.  In order to save or retrieve user data from the session, the passport uses the functions `passport.serializeUser ()` and `passport.deserializeUser ()`. <br><br><pre> <code class="javascript hljs">passport.serializeUser(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user, done</span></span></span><span class="hljs-function">) </span></span>{ done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, user.id); }); passport.deserializeUser(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id, done</span></span></span><span class="hljs-function">) </span></span>{ User.findById(id, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err,user</span></span></span><span class="hljs-function">)</span></span>{ err ? done(err) : done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>,user); }); });</code> </pre><br><br><h4>  Connect Passport to Express </h4><br>  Okay, we figured it out, now you need to connect Passport to Express: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Middlewares,      passport: app.use(express.cookieParser()); app.use(express.bodyParser()); app.use(express.session({ secret: 'SECRET' })); // Passport: app.use(passport.initialize()); app.use(passport.session());</span></span></code> </pre><br><br><h4>  Creating a router and controllers </h4><br>  It is time to configure the router.  We tie requests to the appropriate controllers: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Auth system app.post('/login', controllers.users.login); app.post('/register', controllers.users.register); app.get('/logout', controllers.users.logout);</span></span></code> </pre><br><br>  Now we create the controllers themselves: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   ,       ,    . // , passport.authenticate()   req.logIn ,      .     . ,    console.log(),  ,  ... //         req.user module.exports.login = function(req, res, next) { passport.authenticate('local', function(err, user, info) { return err ? next(err) : user ? req.logIn(user, function(err) { return err ? next(err) : res.redirect('/private'); }) : res.redirect('/'); } )(req, res, next); }; //    =) module.exports.logout = function(req, res) { req.logout(); res.redirect('/'); }; //  .     ,   ,  ,   `req.logIn`,   module.exports.register = function(req, res, next) { var user = new User({ username: req.body.email, password: req.body.password}); user.save(function(err) { return err ? next(err) : req.logIn(user, function(err) { return err ? next(err) : res.redirect('/private'); }); }); };</span></span></code> </pre><br><br><h4>  Authorization check </h4><br>  Authorization checks can be done using req.isAuthenticated ().  I will check out the middleware. <br><br><pre> <code class="javascript hljs">exports.mustAuthenticatedMw = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">)</span></span>{ req.isAuthenticated() ? next() : res.redirect(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); };</code> </pre><br><br>  And add in routes. <br><br><pre> <code class="javascript hljs"> App.all(<span class="hljs-string"><span class="hljs-string">'private'</span></span>, mustAuthenticatedMw); App.all(<span class="hljs-string"><span class="hljs-string">'private/*'</span></span>, mustAuthenticatedMw);</code> </pre><br><br><h4>  HTML </h4><br>  It remains to create a registration form, authorization, and logout button. <br><br>  Check in: <br><pre> <code class="javascript hljs">h4 Register your account form(action=<span class="hljs-string"><span class="hljs-string">'/register'</span></span> method=<span class="hljs-string"><span class="hljs-string">'post'</span></span>) fieldset label(<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>=<span class="hljs-string"><span class="hljs-string">'email'</span></span>) Email input(type=<span class="hljs-string"><span class="hljs-string">'email'</span></span> name=<span class="hljs-string"><span class="hljs-string">'email'</span></span> placeholder=<span class="hljs-string"><span class="hljs-string">'Your Email'</span></span>) label(<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>=<span class="hljs-string"><span class="hljs-string">'password'</span></span>) Password input(type=<span class="hljs-string"><span class="hljs-string">'password'</span></span> name=<span class="hljs-string"><span class="hljs-string">'password'</span></span> placeholder=<span class="hljs-string"><span class="hljs-string">'Your Password'</span></span>) button(type=<span class="hljs-string"><span class="hljs-string">'Register'</span></span>)</code> </pre><br><br>  Login <br><pre> <code class="javascript hljs">h4 Login to your account form(action=<span class="hljs-string"><span class="hljs-string">'/login'</span></span> method=<span class="hljs-string"><span class="hljs-string">'post'</span></span>) fieldset label(<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>=<span class="hljs-string"><span class="hljs-string">'email'</span></span>) Email input(type=<span class="hljs-string"><span class="hljs-string">'email'</span></span> name=<span class="hljs-string"><span class="hljs-string">'email'</span></span> placeholder=<span class="hljs-string"><span class="hljs-string">'Your Email'</span></span>) label(<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>=<span class="hljs-string"><span class="hljs-string">'password'</span></span>) Password input(type=<span class="hljs-string"><span class="hljs-string">'password'</span></span> name=<span class="hljs-string"><span class="hljs-string">'password'</span></span> placeholder=<span class="hljs-string"><span class="hljs-string">'Your Password'</span></span>) button(type=<span class="hljs-string"><span class="hljs-string">'Login'</span></span>)</code> </pre><br><br>  Logout <br><pre> <code class="javascript hljs">a(href=<span class="hljs-string"><span class="hljs-string">'/logout'</span></span>) logout</code> </pre><br><br>  Well, you can run and test the work.  In order not to rewrite hundreds of code, you can fork a <a href="https://github.com/shuvalov-anton/passport-auth-example">repository on GitHub</a> . </div><p>Source: <a href="https://habr.com/ru/post/201206/">https://habr.com/ru/post/201206/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../201190/index.html">HTML5 No Screenshots</a></li>
<li><a href="../201196/index.html">Have fun together: Single sign-up to the Windows app stores and Windows Phone</a></li>
<li><a href="../201200/index.html">New free courses of virtual academy of Microsoft Virtual Academy</a></li>
<li><a href="../201202/index.html">Migrating to a new version of API</a></li>
<li><a href="../201204/index.html">Hadoop Part 2: Collecting Data with Flume</a></li>
<li><a href="../201208/index.html">In South Australia, earned a wave power plant with a capacity of 1 MW</a></li>
<li><a href="../201210/index.html">How to sign java applet</a></li>
<li><a href="../201212/index.html">About how I accidentally dropped the browser game server from EA</a></li>
<li><a href="../201214/index.html">Life Cycle Activity Stack (Part 1)</a></li>
<li><a href="../201218/index.html">What personal GTD / To-Do services lack</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>