<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimization of long arithmetic in C ++</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Happy New Year! I will describe a classic plot - optimization of long arithmetic in C ++ with the help of assembly inserts. However, on Habr√© it was n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimization of long arithmetic in C ++</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/73e/42e/09a/73e42e09afe3c2fe89a60bdf36937863.jpg" align="right"><br>  Happy New Year!  I will describe a classic plot - optimization of long arithmetic in C ++ with the help of assembly inserts.  However, on Habr√© it was not there yet, so after some hesitation I decided to post it here, you will forgive if you yourself once wrote the same thing and advanced further than me :-) <br><br><a name="habracut"></a><br>  Suppose that in the BigInt class, which represents a long integer, the fields void * words are declared - mass words, int wc is the number of words in the array (the word length in bytes is specified at the compilation stage).  Then the implementation of addition on pure C ++ can be like this: <br><pre><code class="cpp hljs">... <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> uInt; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> uLong; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAX_uInt ((uInt)(-1)) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MUL ((uLong)MAX_uInt) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// MUL: Max_uInt in Unsigned Long int BigInt::WS = sizeof(uInt); BigInt &amp; BigInt::operator+=(const BigInt &amp;rhs) { ... //  ,   uLong carry = 0; for ( uInt *th = (uInt*)words, *oz = (uInt*)rhs.words, *limit = oz + rhs.wc, *thl = th + wc; oz &lt; limit || carry &amp;&amp; th &lt; thl; oz++, th++) { uLong t = carry + *th; t += oz &lt; limit ? *oz : 0; if (t &gt; MUL) { carry = 1; t &amp;= MUL; } else carry = 0; *th = (uInt)t; } if (carry) { ... //     } return *this; }</span></span></span></span></code> </pre> <br>  It can be seen that C is not very suitable for solving our problem: it is impossible to add 8 bytes at a time, because there is no space left for a single bit of overflow. <br><br>  We will consider how many clock cycles the processor spends on adding each 4 bytes from the array of words of a long integer.  Like that: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timespec</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t2</span></span></span><span class="hljs-class">;</span></span> BigInt *a = ..., *b = ...; <span class="hljs-comment"><span class="hljs-comment">//    - 400 clock_gettime(CLOCK_MONOTONIC_RAW, &amp;t1); for (int j = 0; j &lt; 10000000; j++) { *a += *b; *a -= *b; } clock_gettime(CLOCK_MONOTONIC_RAW, &amp;t2); printf(...); //   t1  t2</span></span></code> </pre><br>  Here is the progress on the GCC optimization keys: <br><table><tbody><tr><td>  -O1 </td><td>  -O2 </td><td>  -O3 </td></tr><tr><td>  7 </td><td>  6 </td><td>  6 </td></tr></tbody></table>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Rewrite the body of the addition method using assembly inserts: <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// uInt  int  long long int BigInt &amp; BigInt::operator+=(const BigInt &amp;rhs) { ... //  ,   uInt *th = (uInt*)words, *oz = (uInt*)rhs.words; asm goto ( "clc\n" "l1:\t" "mov\t(%[oz]), %[ax]\n\t" "adc\t%[ax], (%[th])\n\t" "lahf\n\t" "add\t%[ws], %[th]\n\t" "add\t%[ws], %[oz]\n\t" "sahf\n\t" "loop\tl1\n\t" "jnc\t%l[nocarry]\n" : : [th] "r" (th), [oz] "r" (oz), [ws] "I" (sizeof(uInt)), [ax] "a" ((uInt)0), "c" (wc) : : nocarry ); ... //     nocarry: return *this; }</span></span></code> </pre><br><br>  In the future, I will immediately write the result of the compilation (for uInt ‚â° long long int): <br><pre> <code class="hljs perl">... clc lo: mov (%rbx), %rax adc %rax, (%rdx) lahf add $8, %rdx add $8, %rbx sahf loop lo jnc nocarry ...</code> </pre><br>  Briefly about what is happening here: in the bx and dx registers there are pointers to the current word, adc is a very convenient instruction that adds the source, the receiver and the overflow flag, what you need!  lahf and sahf save and load the base flags ‚Äî these instructions are needed because add clears the overflow flag.  loop iterates as many times as it is in the cx register. <br><br>  This is exactly (honestly) what I wrote first.  This variant is performed in <b>7</b> cycles in both variants, respectively in <b>3.5</b> cycles for every four bytes in the ‚Äúlong version‚Äù.  GCC is still high, but the resulting assembler is still optimized and optimized. <br><br>  . <br><br>  Bad rumors go around loop instructions.  We must try without it, especially since it costs almost nothing: <br><pre> <code class="hljs perl">... clc lo: mov (%rbx), %rax adc %rax, (%rdx) lahf add $8, %rdx add $8, %rbx sahf dec %rcx jnz lo jnc nocarry ...</code> </pre><br><br>  The result is <b>5 (2.5)</b> cycles!  Never use loop - it saves the line, but it spends as much as 2 bold cycles on each iteration. <br><br>  . <br><br>  I would like to deal with the increase in pointers - is there any way not to touch the CF (carry flag - flag ‚Äúcarry‚Äù, overflow)?  Fortunately, there is - the lea instruction calculates the reference to the memory and puts it into the receiver register, without touching the flags.  Here's how to use it for pointer increments: <br><pre> <code class="hljs perl">... clc lo: mov (%rbx), %rax adc %rax, (%rdx) lea <span class="hljs-number"><span class="hljs-number">8</span></span>(%rdx), %rdx lea <span class="hljs-number"><span class="hljs-number">8</span></span>(%rbx), %rbx dec %rcx jnz lo jnc nocarry ...</code> </pre><br><br>  In fact <pre>  lea 8 (% rdx),% rdx </pre>  does the same thing as <pre>  add $ 8,% rdx </pre>  - adds the word size to the register. <br><br>  The processor spends <b>2</b> clocks on this variant (that is, <b>1</b> clock per 4 bytes).  Frankly, I did not expect that lahf / sahf take so much time. <br><br>  . <br><br>  What to do next?  <a href="http://ru.wikipedia.org/wiki/SSE">SSE</a> , unfortunately, are not helpers here: as long as the 64-bit architecture is used, a nonexistent padc <i>xmm</i> instruction <i>, xmm</i> would generate essentially the same flow of microinstructions as the sequence of two ordinary additions, it is impossible to parallelize addition with overflow.  Similarly, it means that it is necessary to write two additions in a row, to unfold the assembler cycle.  Golden reception optimization. <br><pre> <code class="hljs perl">// WS = <span class="hljs-number"><span class="hljs-number">16</span></span> ... clc lo: mov (%rbx), %rax adc %rax, (%rdx) mov <span class="hljs-number"><span class="hljs-number">8</span></span>(%rbx), %rax adc %rax, <span class="hljs-number"><span class="hljs-number">8</span></span>(%rdx) lea <span class="hljs-number"><span class="hljs-number">16</span></span>(%rbx), %rbx lea <span class="hljs-number"><span class="hljs-number">16</span></span>(%rdx), %rdx dec %rcx jnz lo jnc nocarry ...</code> </pre><br><br>  Now, one iteration is performed in <b>3</b> clocks, which corresponds to <b>0.75</b> clocks per 4 bytes. <br><br>  Hooray!  GCC -O2 made 8 times!  There is no time to think further!  Once again, everyone with the coming! </div><p>Source: <a href="https://habr.com/ru/post/135590/">https://habr.com/ru/post/135590/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../135580/index.html">Wonderful New Year Greetings - v.2012 (feat.MSP)</a></li>
<li><a href="../135581/index.html">Do you like to receive New Year greetings from companies and services by e-mail?</a></li>
<li><a href="../135582/index.html">Happy New Year!</a></li>
<li><a href="../135583/index.html">Sintel: about the technological art</a></li>
<li><a href="../135587/index.html">Go: gorutin performance</a></li>
<li><a href="../135593/index.html">First Raspberry Pi boards exhibited at Ebay auction</a></li>
<li><a href="../135594/index.html">Happy New World!</a></li>
<li><a href="../135595/index.html">Yii 1.1.9</a></li>
<li><a href="../135596/index.html">Base GeoIP - countries and cities, December 2011</a></li>
<li><a href="../135597/index.html">Connect an electric motor to the Arduino</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>