<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We count network traffic using netflow and lightsquid</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once in our small office it was necessary to set up a traffic accounting system for linux. Skimming through the ready-made solutions, I decided to use...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We count network traffic using netflow and lightsquid</h1><div class="post__text post__text-html js-mediator-article">  Once in our small office it was necessary to set up a traffic accounting system for linux.  Skimming through the ready-made solutions, I decided to use something simpler.  Googling, <a href="https://www.google.ru/search%3F%26q%3Dnetflow%2520lightsquid">I liked the approach to</a> use a samopisny script that would convert netflow statistics into a squid-compatible log, which you can then analyze with anything.  I didn‚Äôt use a ready-made script walking around Google, because  it uses ipcad, which is absent in debian and ubuntu.  I wrote my own version using any netflow sensor and flow-tools as a collector.  The script gradually became more complicated and, as a result, grew into a small traffic accounting system.  The archive of this pleasure weighs about 50kb, while: <br><br><ul><li>  installed using deb for debian-based distributions or using your own installer for the rest </li><li>  can count Internet traffic on the router for all ip v4 protocols and ports </li><li>  can limit access to unregistered users </li><li>  instead of bare statistics of ip-addresses, netflow can detail reports using dig and squid </li><li>  can selectively block traffic </li><li>  has a web interface to manage users and user groups </li><li>  configured a little harder than lightsquid, which uses in work </li><li>  does not use the access.log intermediate log; own parser converts netflow statistics directly into lightsquid report </li></ul><br><img src="https://habrastorage.org/files/a45/696/0d1/a456960d14f141cd911f2b736808a2be.png"><br><a name="habracut"></a><br>  It looks like this: user management and access to statistics is carried out through a web interface ( <a href="http://lightwrapper.sf.net/">demo</a> ).  Each user can be authorized via ip, mac or ip + mac.  Unauthorized users see the ‚Äúaccess denied‚Äù error.  Each user can be assigned a ‚Äúsquid‚Äù flag to redirect web traffic to transparent squid.  Each user can be assigned an ‚Äúipblock‚Äù flag to block any traffic through ipset.  Manage lock lists and other fine-tuning settings are done through the console.  Installing and configuring everything is not necessary, you can configure only the necessary components. <br>  The name was chosen as the name lightwrapper (derived from the lightsquid wrapper) and a project at <a href="https://sourceforge.net/projects/lightwrapper/">sourceforge was created</a> .  How to try: <br><br><ol><li>  install recommended dependencies: apache2 softflowd ipset lightsquid perl iptables flow-tools dnsutils conntrack iptables-persistent </li><li>  download <a href="https://sourceforge.net/projects/lightwrapper/files/">archive</a> , install deb or run installer. </li></ol><br>  Actually, there are quite a lot of dependencies, and many of them require tuning - this is a minus.  But with this approach it is unlikely that this is possible.  Briefly, the setup is as follows: <br><ol><li><div class="spoiler">  <b class="spoiler_title">configure netflow sensor and collector (one line in the config of both)</b> <div class="spoiler_text"><div class="spoiler">  <b class="spoiler_title">Setting up flow-tools</b> <div class="spoiler_text">  Enter in the configuration file (in debian - /etc/flow-tools/flow-capture.conf) <br>  -N 0 -w / tmp -R / usr / sbin / lw-export -n 95 0 / 127.0.0.1 / 2055 </div></div><br><div class="spoiler">  <b class="spoiler_title">Softflowd setup</b> <div class="spoiler_text">  Enter in the configuration file (in debian - / etc / default / softflowd): <br>  INTERFACE = "name of the local network interface, for example, eth0" <br>  OPTIONS = "- n 127.0.0.1:2055" </div></div>  Softflowd is easy to configure, but can lose packets.  If you are not <a href="http://habrahabr.ru/post/138292/">satisfied with</a> its performance, try <a href="http://habrahabr.ru/post/138292/">ipt-netflow</a> . </div></div></li><li><div class="spoiler">  <b class="spoiler_title">configure lightsquid</b> <div class="spoiler_text"><div class="spoiler">  <b class="spoiler_title">Apache2 setup</b> <div class="spoiler_text">  The archive contains examples: lightwrapper.conf - virtualhost configuration for apache2 and access_denied.html - stub for displaying to non-users.  Examples are in / usr / share / doc / lightwrapper / examples.  You must turn off the virtualhost settings for lightsquid (because they give access without a password) and enable the settings for lightwrapper.  In debian, you can replace the /etc/apache2/sites-enabled/000-default.conf file with the one given.  You must also enable the cgi module.  In debian, you need to make a link with /etc/apache2/mods-available/cgi.load in / etc / apache2 / mods-enabled.  After that, you need to enable access with password protection.  Install the apache2-utils package, if you do not have the htpasswd utility, create an etc directory in the site root and set the administrator password: htpasswd -c / www / etc / passwd administrator <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Configuring lightsquid</b> <div class="spoiler_text">  It is necessary to delete cron jobs for lightparser.pl, if they are present in the system. <br>  The configuration file is configured automatically by installation scripts.  You can configure lightsquid to your taste, except for the following parameters, which can not be changed: <br>  $ graphmaxuser = 1 <br>  $ graphmaxall = 1 <br>  $ showgroupid = 0 <br>  $ showputpost = 1 <br>  $ templatename = 'lightwrapper' <br>  $ logpath = '/ var / log / lightwrapper' <br>  $ lang = 'lw-eng' <br>  or another language (lw-ru) <br></div></div></div></div></li><li><div class="spoiler">  <b class="spoiler_title">edit config file.</b>  <b class="spoiler_title">In the simplest version, you only need to enter the names of 2x network interfaces</b> <div class="spoiler_text">  / etc / lightwrapper / cfg: <br>  in_if and out_if <br></div></div></li><li><div class="spoiler">  <b class="spoiler_title">run the iptables configuration script (it does everything automatically, you only need it once)</b> <div class="spoiler_text">  Run lw-geniprules.  Make sure that ip v4 forwarding is enabled (add net.ipv4.ip_forward = 1 in /etc/sysctl.conf and apply the changes to sysctl --system). </div></div></li><li><div class="spoiler">  <b class="spoiler_title">install and configure additional dependencies, if any</b> <div class="spoiler_text">  Installation of transparent squid is not described;  ipset setting for blocking traffic is not described.  Detailed instructions can be found in man or on the wiki. </div></div></li><li>  Restart all services to apply the settings or reboot. </li></ol><br>  Statistics is updated by default every 15 minutes.  The sensor can give out streams with some delay. <br>  Details are described step by step <s>in broken English</s> in the <a href="https://sourceforge.net/p/lightwrapper/wiki/Home/">wiki</a> and in man lightwrapper.  There are examples of configuration files of everything you can, in most cases, you can simply copy them to your system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A little bit about the detail reports.  Netflow gives the following information: ip addresses, source and destination ports, protocol. <br><br><img src="https://habrastorage.org/files/b56/ae7/953/b56ae79530d84566bc1fa3acd86a2f93.png"><br><br>  If for a pair (protocol: destination port) there is a service name in / etc / services, then lightwrapper displays it in statistics.  If the dig utility is installed, ip-addresses are automatically resolved to names (if there is such a match in dns). <br><br><img src="https://habrastorage.org/files/919/794/73f/91979473fefa45fe8acf49220f5ef476.png"><br><br>  If transparent squid is installed and some users are redirected to it, then lightwrapper scans the squid log and assigns the names to the found ip-addresses.  You can configure the lightwrapper so that it resolves ip-addresses in the names for users who are <i>not redirected</i> to squid.  At the same time, for obvious reasons, it is impossible to vouch for the accuracy of such recognition. <br><br><img src="https://habrastorage.org/files/2d3/6bc/d58/2d36bcd581894d52b4a7264d6e072d56.png"><br><br>  I will be glad to any reviews and bug reports. </div><p>Source: <a href="https://habr.com/ru/post/232719/">https://habr.com/ru/post/232719/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../232697/index.html">Allure - a framework from Yandex for creating simple and clear autotest reports [for any language]</a></li>
<li><a href="../232701/index.html">Promising e-commerce markets</a></li>
<li><a href="../232705/index.html">In Ukraine, will not block sites?</a></li>
<li><a href="../232707/index.html">Point me in the credits of Avatar! or About society as co-author of any work</a></li>
<li><a href="../232711/index.html">The origami robot folds itself</a></li>
<li><a href="../232721/index.html">Down with trinkets - 5 useful things in life that can be printed in 3D</a></li>
<li><a href="../232723/index.html">Spyware is officially used by police in 30 countries.</a></li>
<li><a href="../232727/index.html">Modding: History. Difficult way from the case to the flash drive</a></li>
<li><a href="../232729/index.html">Usb web notifier in backlight</a></li>
<li><a href="../232731/index.html">Your Game is our answer. Retro Games Battle</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>