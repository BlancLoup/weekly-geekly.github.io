<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Python typing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today, only a lazy person does not speak (write, think) about machine learning, neural networks, and artificial intelligence in general. Just last yea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Python typing</h1><div class="post__text post__text-html js-mediator-article"><p>  Today, only a lazy person does not speak (write, think) about machine learning, neural networks, and artificial intelligence in general.  Just last year, ML was compared with teenage sex - everyone wants it, but no one does it.  Today, everyone is concerned that the AI ‚Äã‚Äãwill leave us without work.  Although, judging by the <a href="https://www.gartner.com/newsroom/id/3837763">latest research by Gartner</a> , you can calm down, because by 2020, thanks to AI, there will be more jobs than it is eliminated.  So, dear friend, learn ML, and you will be happy. </p><br><p><img src="https://habrastorage.org/webt/ec/qg/ai/ecqgaiuzrj-81vipgsqw7ztmazg.jpeg"><a name="habracut"></a></p><br><p>  <i>Note: we continue the series of publications of the full versions of articles from the magazine Hacker.</i>  <i>Spelling and punctuation of the author saved.</i> </p><br><pre><code class="hljs pgsql">   ** ML- Python   Azure <span class="hljs-keyword"><span class="hljs-keyword">Functions</span></span>**, ,      ,      . :)</code> </pre> <br><p>  In this article we want to show ML on a practical case - using the example of a project that we did for <strong>Aktion-press</strong> (online subscription service).  I am sure that this example can be useful to many.  Why many?  Yes, because the problem we solved was called ‚Äúsorting and sending to the address a huge number of emails‚Äù.  The problem of gigantic correspondence, which managers have to sort and forward to the appropriate departments, is almost universal, and this problem must be solved in modern ways. </p><br><p>  So, after consulting with the customer, we decided to develop a machine learning model to automate the sorting of letters as much as possible. </p><br><h2>  Machine learning model </h2><br><p>  I think it will not surprise you that we have chosen Python as the language for this solution.  It happened so historically, it is high-level, and most importantly - it has many useful libraries for machine learning.  I will tell about them below. </p><br><p>  Honestly, there‚Äôs nothing much to say about ML in this case.  A set of simple binary classifiers based on logistic regression showed promising results and allowed several to abstract from the model itself, focusing on the preparation of data and the construction of the attached text.  But the repository itself has already been used as the basis for three other independent projects, it has shown itself well in several classification experiments and has established itself as a reliable foundation for a quick transition to development.  Therefore, the task of this section is not to demonstrate the "know-how", it is needed as a basis for the next section dedicated to operationalization. </p><br><p>  Here I will share my experience and give some recommendations to you so that you can experiment with this code yourself or reuse it. </p><br><p>  <em>To preserve confidentiality, the original dataset has been replaced with a similar publicly available set for categorizing <a href="https://www.crowdflower.com/data-for-everyone/">McDonalds feedback</a> .</em>  <em>See <a href="">data / data.csv file</a> .</em> </p><br><p>  The data itself was presented in CSV files with three columns: <code>Id</code> , <code>Text</code> and <code>Class</code> .  And since NLTK does not provide built-in support for reading data from files in CSV format, we wrote our own module that allows you to read files from a folder as a single dataframe pandas or to extract text in the form of lists of paragraphs, sentences, words, and so on in NLTK format. </p><br><p>  And here is the code for initializing this self-written <code>CsvCorpusReader</code> reader <code>CsvCorpusReader</code> with client data.  The implementation of the class can be seen in the file <a href="https://github.com/evgri243/ap-sample/blob/master/lib/corpus.py">lib \ corpus.py</a> .  We strongly recommend that you familiarize yourself with the contents of the file <a href="https://github.com/evgri243/ap-sample/blob/master/Experiments/TrainingExperiment.py">Experiments \ TrainingExperiment.py</a> . </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#%% create corpus corpus = CsvCorpusReader(".\data", ["data.csv"], encoding="utf8", default_text_selector=lambda row: row["Text"])</span></span></code> </pre> <br><p>  After the initialization is complete, you need to extract the words from the documents and normalize them.  In our case, after a series of experiments, we decided to use a set of support functions as a wrapper for the entire process to hide the calls to the NLTK and Gensim libraries inside an easy-to-use configuration level. </p><br><p>  Below, we give the extractor a command to return documents in the form of a list of words, discarding the structure of paragraphs or sentences (see <code>keep_levels=Levels.Nothing</code> ).  Then we translate each word into lower case, discard any stop words and highlight the basics of words.  At the final stage, we remove the low-frequency words, assuming that these are just typos or that they do not have a significant effect on the classification. </p><br><p>  Please note that the code below focuses exclusively on data samples in English, while the original version implemented Russian lemmatization using PyMorphy2, which made it possible to achieve a more accurate classification for the Russian language. </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#%% tokenize the text stop_words = ['would', 'like', 'mcdonald'] text_processor = generate_processor(keep_alpha_only=True, to_lower=True, stopwords_langs=['english'], add_stopwords=stop_words, stemmer_langs=['english']) docs_factory = lambda: corpus.words(keep_levels=Levels.Nothing, **text_processor) word_frequencies = Counter((word for doc in docs_factory() for word in doc)) min_word_freq = 3 docs = [ [ word for word in doc if word_frequencies[word] &gt;= min_word_freq ] for doc in docs_factory() ]</span></span></code> </pre> <br><p>  As soon as we tokenize our body, the next step is to build the attachment.  The code below is needed to convert each document into a series of meaningless digits for use in a classifier. </p><br><p>  We tested several different approaches (including BoW, TF-IDF, LSI, RP, and w2v), but the classic <a href="https://en.wikipedia.org/wiki/Latent_semantic_analysis">LSI</a> model with 500 extracted topics gave the best results ( <a href="https://en.wikipedia.org/wiki/Receiver_operating_characteristic">AUC</a> = 0.98) in our case.  First, the code checks for the existence of an existing serialized model in the shared folder.  If there is no model, the code trains the new model using pre-prepared data and saves the result to disk.  If a model is detected, it is simply loaded into memory.  The code then converts the dataset and repeats the stream with the next attachment. </p><br><p>  In terms of efficiency, the LSI model has surpassed the much more powerful vector2-based vectorization algorithm and other more complex approaches, and this may be due to several possible reasons. </p><br><p>  The most obvious of these is that the letters of the types we were looking for had predictable and repetitive patterns of words, as in the case of auto-answers (for example, <em>‚ÄúThank you for your letter ... I will not be in the office until ... If the question is urgent ... "</em> ).  Therefore, to process them is quite enough something simple, for example TF-IDF.  LSI supports a common ideology, and this model can be viewed as a way to add synonyms suitable for processing.  At the same time, the word2vec algorithm, which was trained on Wikipedia, probably generates unnecessary noise due to complex synonymous structures, thereby "blurring" the patterns in the messages and, consequently, reducing the classification accuracy. </p><br><p>  This approach has shown that old and fairly simple methods are still worth trying, even in the era of word2vec and recurrent neural networks. </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#%% convert to Bag of Words representation dictionary_path = os.path.join(preprocessing_path, 'dictionary.bin') if os.path.exists(dictionary_path): dictionary = corpora.Dictionary.load(dictionary_path) else: dictionary = corpora.Dictionary(docs) dictionary.save(dictionary_path) docs_bow = [dictionary.doc2bow(doc) for doc in docs] nested_partial_print(docs_bow) #%% convert to tf-idf representation tfidf_path = os.path.join(preprocessing_path, 'tfidf.bin') if os.path.exists(tfidf_path): model_tfidf = models.TfidfModel.load(tfidf_path) else: model_tfidf = models.TfidfModel(docs_bow) model_tfidf.save(tfidf_path) docs_tfidf = nested_to_list(model_tfidf[docs_bow]) #%% train and convert to LSI representation lsi_path = os.path.join(preprocessing_path, 'lsi.bin') lsi_num_topics = 500 if os.path.exists(lsi_path): model_lsi = models.LsiModel.load(lsi_path) else: model_lsi = models.LsiModel(docs_tfidf, id2word=dictionary, num_topics=lsi_num_topics) model_lsi.save(lsi_path) docs_lsi = model_lsi[docs_tfidf]</span></span></code> </pre> <br><p>  As always, it is impossible to get rid of the mandatory routine code.  Then it will be useful to us when preparing data for machine learning using skit-learn. </p><br><p>  As I said above, we use several binary instead of one multi-class classifier.  That is why we create a binary target for one of the classes (in this sample, this is SlowService).  You can change the value of the <code>class_to_find</code> variable and <code>class_to_find</code> -execute the code below to train each classifier separately.  The assessment script is designed to work with several models, and automatically loads them from the selected folder.  Finally, a training and test data set is formed, the lines with gaps are completely excluded. </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#%% create target class_to_find = "SlowService" df["Target"] = df.apply(lambda row: 1 if class_to_find in row["Class"] else 0, axis=1) df.groupby(by=["Target"]).count() #%% create features and targets dataset features = pd.DataFrame(docs_features, columns=["F" + str(i) for i in range(lsi_num_topics)]) notnul_idx = features.notnull().all(axis=1) features = features[notnul_idx] df_notnull = df[notnul_idx] target = df_notnull[["Target"]] plot_classes_scatter(features.values, target["Target"].values) #%% split dataset to train and test train_idx, test_idx = train_test_split(df_notnull.index.values, test_size=0.3, random_state=56) df_train = df_notnull.loc[train_idx] features_train = features.loc[train_idx] target_train = target.loc[train_idx] df_test = df_notnull.loc[test_idx] features_test = features.loc[test_idx] target_test = target.loc[test_idx]</span></span></code> </pre> <br><p>  Now we proceed to the training of the classifier (in our case, this is logistic regression), then we will save the model in the same general catalog that we used earlier to embed the transformations. </p><br><p>  As you can see, in the code below, we follow a special format for the model name: <code>class_{0}_thresh_{1}.bin</code> .  This is necessary to determine the class name and the corresponding threshold value in the course of further evaluation. </p><br><p>  And one final note before we continue.  As a development tool, I chose Visual Studio Code.  It is an easy-to-use, lightweight editor that even provides the basic IntelliSense features (code completion and hints) for a dynamic language like Python.  At the same time, the <a href="https://marketplace.visualstudio.com/items%3FitemName%3Ddonjayamanne.jupyter">Jupyter</a> and <a href="https://marketplace.visualstudio.com/items%3FitemName%3Dms-python.python">Python</a> extensions in combination with the IPython core allow you to execute code on the cell and visualize the result without re-running the script, which is always convenient for ML tasks.  Yes, it looks like a standard Jupyter, but with IntelliSense and code / git orientation.  I recommend that you try, at least while you are working with the sample, because many other possibilities related to VS Code are used for productive development. </p><br><p>  As for the code below, the line with <em>plot ROC threshold values</em> are examples of using the <em>Jupyter</em> extension.  You can click the special <code>Run cell</code> button above the cell to see the TP and FP values ‚Äã‚Äãand compare them with the Threshold threshold value in the results panel on the right.  We actively used this diagram during our work, because due to a pronounced imbalance in the data set, the optimal cutoff level was always around 0.04 instead of the usual 0.5.  If you cannot use VS Code for testing, you can simply run the script using standard Python tools and, after viewing the results in a separate window, make changes directly to the file name. </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#%% train logistic classifier classifier = LogisticRegression() classifier.fit(features_train, target_train) #%% score on test scores_test = classifier.predict_proba(features_test)[:, 1] #%% plot ROC threshold values pd.DataFrame(nested_to_list(zip(tsh, tp_test, fp_test, fp_test-tp_test)), columns=['Threshold', 'True Positive Rate', 'False Positive Rate', 'Difference']).plot(x='Threshold') plt.xlim(0, 1) plt.ylim([0,1]) plt.grid() plt.show() #%% save model threshold = 0.25 model_filename = 'class_{0}_thresh_{1}.bin'.format(class_to_find, threshold) joblib.dump(classifier, os.path.join(model_path, model_filename))</span></span></code> </pre> <br><p>  Now it‚Äôs time for the assessment script: <a href="https://github.com/evgri243/ap-sample/blob/master/Score/run.py">Score \ run.py.</a>  New in it is very small, most of the code taken from the original teaching experiment, discussed earlier.  Check out the contents of this file in <a href="https://github.com/evgri243/ap-sample/">the GitHub repository</a> . </p><br><p>  The input file is a CSV file for evaluation, at the output we get two different files, one contains the estimated classes, the other - the row identifiers, which cannot be assessed.  I will explain the reason for using the file later when we talk about operationalization. </p><br><p>  At the end of this section, I want to explain why we use several binary instead of one multi-class classifier.  First, it was much easier to start, to work and optimize performance on classes separately.  This approach also allows you to use different mathematical models for different classes, as is the case with auto-answers, which often have a fairly rigid structure, and can be processed using a simple bag of words.  At the same time, from the point of view of an IT professional, something like the code below can simplify deployment, allowing you to connect new ones or change existing models without affecting others. </p><br><pre> <code class="python hljs">model_paths = [path <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> path <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> os.listdir(os.path.join(<span class="hljs-string"><span class="hljs-string">'..'</span></span>, <span class="hljs-string"><span class="hljs-string">'model'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> path.startswith(<span class="hljs-string"><span class="hljs-string">'class_'</span></span>) ] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> model_path <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> model_paths: model = joblib.load(os.path.join(<span class="hljs-string"><span class="hljs-string">'..'</span></span>, <span class="hljs-string"><span class="hljs-string">'model'</span></span>, model_path)) res = model.predict_proba(features_notnull)[:, <span class="hljs-number"><span class="hljs-number">1</span></span>] class_name = model_path.split(<span class="hljs-string"><span class="hljs-string">'_'</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>] threshold = float(model_path.rsplit(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].split(<span class="hljs-string"><span class="hljs-string">'_'</span></span>)[<span class="hljs-number"><span class="hljs-number">-1</span></span>]) result.loc[:, <span class="hljs-string"><span class="hljs-string">"class_"</span></span> + class_name] = res &gt; threshold result.loc[:, <span class="hljs-string"><span class="hljs-string">"class_"</span></span> + class_name + <span class="hljs-string"><span class="hljs-string">"_score"</span></span>] = res</code> </pre> <br><p>  You can even try out the code right now, using your own data from your local PC, and completely without operationalization: </p><br><ul><li>  clone the <a href="https://github.com/evgri243/ap-sample/">repository</a> , follow the instructions for deploying the local Anaconda environment and install the Visual Studio Code with the necessary extension; </li><li>  place your data in a supported format in the file <em>data \ data.csv</em> and open the file <em>Experiment \ TrainingExperiment.py</em> to train the model on any class that you want to evaluate; </li><li>  do not forget to delete the entire folder <em>models</em> , because otherwise the code will try to reuse the transformations and models from the sample; </li><li>  go to <em>Score \ run.py</em> , <em>replace the</em> data in the <em>Score \ debug \ input.csv file with</em> your own and execute the script line by line using the <em>Jupyter</em> extension. </li></ul><br><p>  In VS Code, you can even open the <em>Debug</em> section <em>(Ctrl + Alt + D)</em> , select <em>Score (Python)</em> as the configuration and click <em>Start Debugging</em> to perform line-by-line analysis of the code in the editor.  When the algorithms have completed their work, the results can be found in the files <em>input.scores.csv</em> and <em>input.unscorable.csv</em> in the folder <em>\ Debug</em> . </p><br><h2>  Operationalization </h2><br><p>  Python support in Azure Functions is still in an early preview, so using it for mission critical tasks is undesirable.  But often ML does not apply to these, and therefore the convenience of implementation may outweigh the difficulty of adapting the preliminary version. </p><br><p>  So, at this stage we had two scripts.  The <a href="https://github.com/evgri243/ap-sample/blob/master/Experiments/TrainingExperiment.py">Experiments \ TraintExperiment.py script</a> trains the model, then it stores the converted and trained model in a shared directory, and it is assumed that this training script is restarted on the local machine as needed.  The <a href="https://github.com/evgri243/ap-sample/blob/master/Score/run.py">Score \ run.py script</a> runs daily, it sorts new emails as they arrive. </p><br><p>  In this section, we‚Äôll talk about process operationalization using Azure Functions.  The functions are easy to use, they allow you to bind the script to a variety of different triggers (HTTP, queues, storage BLOB objects, WebHooks, and so on), provide several automatic output bindings and are inexpensive: having chosen Consumption plan, you pay only 0.000016 dollars for each gigabyte of RAM used per second.  But there are limitations: your function cannot run for more than ten minutes and use more than 1.5 GB of RAM.  If this does not suit you, you can always switch to a special tariff plan based on App Service, while maintaining access to other benefits of the serverless approach.  However, for our simple logistic regression and packages of several hundred letters, the chosen plan turned out to be optimal. </p><br><p>  From the programmer‚Äôs point of view, a function is a folder that bears the name of the function itself (in our case it‚Äôs just the <a href="https://github.com/evgri243/ap-sample/tree/master/Score">Score</a> ) and contains two different files: </p><br><ul><li>  <code>function.json</code> is a file describing the configuration of the function (see the format <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference">here</a> ); </li><li>  <code>run.py</code> is a Python script that runs when a trigger is triggered. </li></ul><br><p>  <a href="">You</a> can manually create <a href="">function.json</a> or configure it with the Azure Portal tool.  The code that we received in this case is presented below.  The first binding, <em>inputcsv</em> , runs the script each time a file with the name corresponding to the <code>mail-classify/input/{input_file_name}.csv</code> appears in the default Azure BLOB storage.  The remaining two bindings save the output files after successful execution of the function.  In this case, we save them to a separate <em>output</em> folder, their names correspond to the name of the input file with the suffixes <em>scored</em> or <em>unscorable</em> .  Thus, you can place a file with any name-identifier, for example GUID, in the <code>input</code> folder, and two new files with the name derived from GUID will appear in the <code>output</code> folder after some time. </p><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"bindings"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"inputcsv"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"blobTrigger"</span></span>, <span class="hljs-string"><span class="hljs-string">"path"</span></span>: <span class="hljs-string"><span class="hljs-string">"mail-classify/input/{input_file_name}.csv"</span></span>, <span class="hljs-string"><span class="hljs-string">"connection"</span></span>: <span class="hljs-string"><span class="hljs-string">"apmlstor"</span></span>, <span class="hljs-string"><span class="hljs-string">"direction"</span></span>: <span class="hljs-string"><span class="hljs-string">"in"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"scoredcsv"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"blob"</span></span>, <span class="hljs-string"><span class="hljs-string">"path"</span></span>: <span class="hljs-string"><span class="hljs-string">"mail-classify/output/{input_file_name}.scored.csv"</span></span>, <span class="hljs-string"><span class="hljs-string">"connection"</span></span>: <span class="hljs-string"><span class="hljs-string">"apmlstor"</span></span>, <span class="hljs-string"><span class="hljs-string">"direction"</span></span>: <span class="hljs-string"><span class="hljs-string">"out"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"unscorablecsv"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"blob"</span></span>, <span class="hljs-string"><span class="hljs-string">"path"</span></span>: <span class="hljs-string"><span class="hljs-string">"mail-classify/output/{input_file_name}.unscorable.csv"</span></span>, <span class="hljs-string"><span class="hljs-string">"connection"</span></span>: <span class="hljs-string"><span class="hljs-string">"apmlstor"</span></span>, <span class="hljs-string"><span class="hljs-string">"direction"</span></span>: <span class="hljs-string"><span class="hljs-string">"out"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"disabled"</span></span>: false }</code> </pre> <br><p>  The <code>run.py</code> script for Azure features is almost the same as our original ‚Äúnon-operationalized‚Äù version.  The only change relates to how functions pass through incoming and outgoing data flows.  Regardless of the type of input and output data selected (HTTP request, message in queue, BLOB file ...), the content will be stored in a temporary file, and its path will be recorded in the environment variable with the name of the corresponding binding.  For example, in our case, each time the function is executed, a file is created with the name " <em>... \ Binding [GUID] \ inputcsv</em> " and this path will be stored in the <em>inputcsv</em> environment <em>variable</em> .  A similar operation will be performed for each outgoing file.  Given this logic, we made a few small changes to the script. </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># read file input_path = os.environ['inputcsv'] input_dir = os.path.dirname(input_path) input_name = os.path.basename(input_path) corpus = CsvCorpusReader(input_dir, [input_name], encoding="utf8", default_text_selector=lambda row: row["Text"]) [...] # write unscorables unscorable_path = os.environ['unscorablecsv'] ids_null.to_csv(unscorable_path, index=False) # pandas DataFrame [...] # write scored emails output_path = os.environ['scoredcsv'] result.to_csv(output_path) # pandas DataFrame</span></span></code> </pre> <br><p>  These are all the changes needed to start the service when a CSV file appears in the BLOB storage and, as a result, the files containing the forecast are received. </p><br><p>  To be honest, we tested other triggers, but found that the most powerful function of Python ‚Äî modules ‚Äî becomes its curse in a serverless system.  A module in Python is not a static library that needs to be included, as in many other languages, but code that runs every time it is run.  For durable solutions such as services, this is almost imperceptible, but from the point of view of Azure functions, the complete execution of the script entails quite large costs each time.  This makes it difficult to use HTTP triggers in Python, but batch-processing on the basis of CSV files, which is popular in many ML scenarios, makes it possible to reduce these costs per data line to a reasonable minimum. </p><br><p>  If you can‚Äôt do without real-time triggers with Python, you can try switching to the dedicated Azure App Service tariff plan, as this allows you to significantly increase the computing resources of the host and speed up the import.  In our case, the ease of implementation and the low cost of the consumption plan outweighed the benefits of a quick implementation. </p><br><p>  Before proceeding, let's see how to simplify development using Visual Studio Code.  At the time of this writing, the <a href="https://www.npmjs.com/package/azure-functions-cli">Functions CLI interface</a> provided the initial generation of Python templates, but there were no debugging functions.  However, the runtime environment is not so difficult to imitate using the built-in VS Code functions.  We will be helped by the <a href="">.vscode \ launch.json file</a> , which allows you to configure debugging options.    JSON ,   debug   <em>Score (Python)</em>   VS Code    <code>${workspaceRoot}/Score/run.py</code>    <code>${workspaceRoot}/Score</code> ,  ,       -  .    ,        Azure Functions ( <em>        </em> ).           <em>Debug (Ctrl + Alt + D)</em>  VS Code,  <em>Score (Python)</em>      <em>Start Debugging</em> ,      . </p><br><pre> <code class="python hljs">[...] { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Score (Python)"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"python"</span></span>, <span class="hljs-string"><span class="hljs-string">"request"</span></span>: <span class="hljs-string"><span class="hljs-string">"launch"</span></span>, <span class="hljs-string"><span class="hljs-string">"stopOnEntry"</span></span>: true, <span class="hljs-string"><span class="hljs-string">"pythonPath"</span></span>: <span class="hljs-string"><span class="hljs-string">"${config:python.pythonPath}"</span></span>, <span class="hljs-string"><span class="hljs-string">"console"</span></span>: <span class="hljs-string"><span class="hljs-string">"integratedTerminal"</span></span>, <span class="hljs-string"><span class="hljs-string">"program"</span></span>: <span class="hljs-string"><span class="hljs-string">"${workspaceRoot}/Score/run.py"</span></span>, <span class="hljs-string"><span class="hljs-string">"cwd"</span></span>: <span class="hljs-string"><span class="hljs-string">"${workspaceRoot}/Score"</span></span>, <span class="hljs-string"><span class="hljs-string">"env"</span></span>: { <span class="hljs-string"><span class="hljs-string">"inputcsv"</span></span>: <span class="hljs-string"><span class="hljs-string">"${workspaceRoot}/Score/debug/input.csv"</span></span>, <span class="hljs-string"><span class="hljs-string">"outputcsv"</span></span>: <span class="hljs-string"><span class="hljs-string">"${workspaceRoot}/Score/debug/output.csv"</span></span>, <span class="hljs-string"><span class="hljs-string">"unscorablecsv"</span></span>: <span class="hljs-string"><span class="hljs-string">"${workspaceRoot}/Score/debug/unscorable.csv"</span></span> }, <span class="hljs-string"><span class="hljs-string">"debugOptions"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"RedirectOutput"</span></span>, <span class="hljs-string"><span class="hljs-string">"WaitOnAbnormalExit"</span></span> ] } [...]</code> </pre> <br><p>      Jupyter      ,       . ,      .      IPython,        Debug . </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">"IPython"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sys.modules <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">'Score'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> os.getcwd(): os.environ[<span class="hljs-string"><span class="hljs-string">'inputcsv'</span></span>] = os.path.join(<span class="hljs-string"><span class="hljs-string">'debug'</span></span>, <span class="hljs-string"><span class="hljs-string">'input.csv'</span></span>) os.environ[<span class="hljs-string"><span class="hljs-string">'scoredcsv'</span></span>] = os.path.join(<span class="hljs-string"><span class="hljs-string">'debug'</span></span>, <span class="hljs-string"><span class="hljs-string">'input.scores.csv'</span></span>) os.environ[<span class="hljs-string"><span class="hljs-string">'unscorablecsv'</span></span>] = os.path.join(<span class="hljs-string"><span class="hljs-string">'debug'</span></span>, <span class="hljs-string"><span class="hljs-string">'input.unscorable.csv'</span></span>) os.chdir(<span class="hljs-string"><span class="hljs-string">'Score'</span></span>)</code> </pre> <br><h2>   </h2><br><p> ,         ,      Azure.       Python   Azure       ,      .       Python  2.7.       3.6,    <a href="https://github.com/Azure/azure-webjobs-sdk-script/wiki/Using-a-custom-version-of-Python">   wiki</a>       Python (   )      <em>D:\home\site\tools</em> .    .         Python 2.7   PATH    python.exe  . </p><br><p>           Kudu,    ,   ,        .  <a href="https://github.com/evgri243/ap-sample/blob/master/Setup/run.py">setup</a> ,         .   ,    3.6,  ,       (.zip)  Python      <em>D:\home\site\tools</em> . </p><br><pre> <code class="python hljs">tools_path = <span class="hljs-string"><span class="hljs-string">'D:\\home\\site\\tools'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> sys.version.startswith(<span class="hljs-string"><span class="hljs-string">'3.6'</span></span>): <span class="hljs-comment"><span class="hljs-comment"># in python 2.7 import urllib print('Installing Python Version 3.6.3') from zipfile import ZipFile if not os.path.exists(tools_path): os.makedirs(tools_path) print("Created [{}]".format(tools_path)) python_url = 'https://apmlstor.blob.core.windows.net/wheels/python361x64.zip' python_file = os.path.join(tools_path, 'python.zip') urllib.urlretrieve(python_url, python_file) print("Downloaded Python 3.6.3") python_zip = ZipFile(python_file, 'r') python_zip.extractall(tools_path) python_zip.close() print("Extracted Python to [{}]".format(tools_path)) print("Please rerun this function again to install required pip packages") sys.exit(0)</span></span></code> </pre> <br><p>      pip. Pip   API  Python,      Python   ,     .    ,     Python  ( <em>langid</em> , <em>pymorphy</em> ) ,        .     ,    C++.   App Service   Visual C++,        (wheels).        pip (  <a href="https://pythonwheels.com/"></a> ),    ML-    wheel <a href="https://www.lfd.uci.edu/~gohlke/pythonlibs/"></a> .      Azure Blob Storage,        Azure.              . </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">install_package</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(package_name)</span></span></span><span class="hljs-function">:</span></span> pip.main([<span class="hljs-string"><span class="hljs-string">'install'</span></span>, package_name]) install_package(<span class="hljs-string"><span class="hljs-string">'https://apmlstor.blob.core.windows.net/wheels/numpy-1.13.1%2Bmkl-cp36-cp36m-win_amd64.whl'</span></span>) install_package(<span class="hljs-string"><span class="hljs-string">'https://apmlstor.blob.core.windows.net/wheels/pandas-0.20.3-cp36-cp36m-win_amd64.whl'</span></span>) install_package(<span class="hljs-string"><span class="hljs-string">'https://apmlstor.blob.core.windows.net/wheels/scipy-0.19.1-cp36-cp36m-win_amd64.whl'</span></span>) install_package(<span class="hljs-string"><span class="hljs-string">'https://apmlstor.blob.core.windows.net/wheels/scikit_learn-0.18.2-cp36-cp36m-win_amd64.whl'</span></span>) install_package(<span class="hljs-string"><span class="hljs-string">'https://apmlstor.blob.core.windows.net/wheels/gensim-2.3.0-cp36-cp36m-win_amd64.whl'</span></span>) install_package(<span class="hljs-string"><span class="hljs-string">'https://apmlstor.blob.core.windows.net/wheels/nltk-3.2.4-py2.py3-none-any.whl'</span></span>) install_package(<span class="hljs-string"><span class="hljs-string">'langid'</span></span>) install_package(<span class="hljs-string"><span class="hljs-string">'pymorphy2'</span></span>)</code> </pre> <br><p>           .    ,    ,   NLTK.         install_packages. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> nltk; nltk_path = os.path.abspath(os.path.join(<span class="hljs-string"><span class="hljs-string">'..'</span></span>, <span class="hljs-string"><span class="hljs-string">'lib'</span></span>, <span class="hljs-string"><span class="hljs-string">'nltk_data'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> os.path.exists(nltk_path): os.makedirs(nltk_path) print(<span class="hljs-string"><span class="hljs-string">"INFO: Created {0}"</span></span>.format(nltk_path)) nltk.download(<span class="hljs-string"><span class="hljs-string">'punkt'</span></span>, download_dir=os.path.join(<span class="hljs-string"><span class="hljs-string">'..'</span></span>, <span class="hljs-string"><span class="hljs-string">'lib'</span></span>, <span class="hljs-string"><span class="hljs-string">'nltk_data'</span></span>)) nltk.download(<span class="hljs-string"><span class="hljs-string">'stopwords'</span></span>, download_dir=os.path.join(<span class="hljs-string"><span class="hljs-string">'..'</span></span>, <span class="hljs-string"><span class="hljs-string">'lib'</span></span>, <span class="hljs-string"><span class="hljs-string">'nltk_data'</span></span>))</code> </pre> <br><p>      Setup ,            .  ,  <em>       : ,    Python 3.6,  ,    </em> . </p><br><h2>  Conclusion </h2><br><p>      ,    , Azure Functions          ML- Python.        ,   ML          .         <a href="https://github.com/evgri243/ap-sample">  GitHub</a> . </p><br><p> ,     <a href="https://xakep.ru/2017/12/19/python-ml/">   </a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/343670/">https://habr.com/ru/post/343670/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343654/index.html">Why do Russian cybersecurity exhibitions die?</a></li>
<li><a href="../343656/index.html">Report from the Android Devs Meetup Meeting on September 22</a></li>
<li><a href="../343658/index.html">Dagger 2 for novice Android developers. The introduction of dependencies. Part 2</a></li>
<li><a href="../343660/index.html">Must-have documentation for a mobile developer. Part 1</a></li>
<li><a href="../343666/index.html">Must-have documentation for a mobile developer. Part 2</a></li>
<li><a href="../343672/index.html">Video surveillance in the entrance on their own</a></li>
<li><a href="../343674/index.html">Outbound call center call center: create a predictive dialer in 3CX Call Flow Designer</a></li>
<li><a href="../343676/index.html">Write your insurance agent: Ingosstrakh organizes hackathon</a></li>
<li><a href="../343678/index.html">Is it true that the future of CPaaS is for ‚ÄúServerless‚Äù technologies?</a></li>
<li><a href="../343680/index.html">Secrets of React and Redux in the development of web applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>