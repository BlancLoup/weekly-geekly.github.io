<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Don't shoot yourself in the foot using LINQ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the article, I described several examples of unobvious moments when using LINQ to SQL. If you're a .NET guru, you might find it boring, the rest is...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Don't shoot yourself in the foot using LINQ</h1><div class="post__text post__text-html js-mediator-article">  In the article, I described several examples of unobvious moments when using LINQ to SQL.  If you're a .NET guru, you might find it boring, the rest is welcome! <br>  Let's start with this example.  Suppose we have an entity ‚Äútype of action‚Äù.  The type of action has a human-readable name and a system name ‚Äî some unique identifier by which we can work with objects of this entity from code.  This is the structure in the form of objects in the code: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ActionType</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> systemname; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name; }</code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ActionTypes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActionType[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActionType { id = <span class="hljs-number"><span class="hljs-number">1</span></span>, systemname = <span class="hljs-string"><span class="hljs-string">"Registration"</span></span>, name = <span class="hljs-string"><span class="hljs-string">""</span></span> }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActionType { id = <span class="hljs-number"><span class="hljs-number">2</span></span>, systemname = <span class="hljs-string"><span class="hljs-string">"LogOn"</span></span>, name = <span class="hljs-string"><span class="hljs-string">"  "</span></span> }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActionType { id = <span class="hljs-number"><span class="hljs-number">3</span></span>, systemname = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, name = <span class="hljs-string"><span class="hljs-string">"     "</span></span> } };</code> </pre><br>  For the same structure with similar data, a table was created in the database and auxiliary objects for using LINQ to SQL.  Suppose we need to find out if we have an action type with the system name <i>NotExistingActionType</i> .  The question is what will be displayed on the screen after following these instructions: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultForObjects = ActionTypes.All(actionType =&gt; actionType.systemname != <span class="hljs-string"><span class="hljs-string">"NotExistingActionType"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinqForHabr.DataClasses1DataContext(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultForLTS = context.ActionTypes.All(actionType =&gt; actionType.SystemName != <span class="hljs-string"><span class="hljs-string">"NotExistingActionType"</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Result for objects: "</span></span> + resultForObjects + <span class="hljs-string"><span class="hljs-string">"\nResult for Linq to sql: "</span></span> + resultForLTS); Console.ReadLine();</code> </pre> <a name="habracut"></a><br>  The answer in this case is strange at first sight.  The result of the application will be: <br><blockquote>  Result for objects: True <br>  Result for LINQ to sql: False </blockquote>  Why does ‚Äúthe same method‚Äù return different values ‚Äã‚Äãfor the same data?  The thing is that this is not the same method at all, but different methods with the same names.  The first iterates over objects in memory, the second is converted to a SQL query that will be executed on the server and will return another result.  Results differ due to the presence of one of our actions with an undefined system name.  And at this moment, specific differences between the two <i>runtimes appear</i> : for .NET, the expression <i>null! = ObjRef</i> is true (unless of course <i>objRef is</i> not <i>null</i> ), and therefore the value of the expression ‚Äúsystem names of all types of actions are not equal <i>NotExistingActionType</i> ‚Äù is true in our situation. <br>  But LINQ to SQL expressions are converted to SQL and executed on the server, and in SQL the comparison with <i>NULL</i> works differently.  Expression values <i>NULL == Something, NULL! = Something</i> and even <i>NULL == NULL</i> will always be false, this is the standard, therefore the expression "system names for all types of actions are not equal <i>NotExistingActionType</i> " and will not be true, as <i>NULL! = 'Not ExistingActionType'</i> - Lying. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now consider another example.  Suppose we have users with their current balance: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">User</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> balance; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name; }</code> </pre><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User { id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">""</span></span>, balance = <span class="hljs-number"><span class="hljs-number">0</span></span> }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User { id = <span class="hljs-number"><span class="hljs-number">2</span></span>, name = <span class="hljs-string"><span class="hljs-string">""</span></span>, balance = <span class="hljs-number"><span class="hljs-number">0</span></span> } };</code> </pre><br>  The question is, what should return the amount on an empty set of elements.  For me, for example, the obvious value is 0, but here, too, is not so simple.  Let's do something like this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultForObjects = users.Where(user =&gt; user.id &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>).Sum(user =&gt; user.balance); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinqForHabr.DataClasses1DataContext(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultForLTS = context.Users.Where(user =&gt; user.Id &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>).Sum(user =&gt; user.Balance); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Result for objects: "</span></span> + resultForObjects + <span class="hljs-string"><span class="hljs-string">"\nResult for Linq to sql: "</span></span> + resultForLTS); Console.WriteLine(context.ActionTypes.First().Name); Console.ReadLine();</code> </pre><br>  The result will again be unusual.  Generally speaking, we will not be able to execute these instructions in this form, since an exception will be raised when executing: <blockquote>  System.InvalidOperationException: "A NULL value cannot be assigned to a member that is a System.Int32 type that does not allow NULL values." </blockquote><br>  The reasons for what is happening again in the translation of our calls to SQL.  For the usual <i>IEnumerable</i> extension, <i>Sum</i> returns 0 for an empty set, which is easy to verify without calculating the <i>resultForLTS</i> (or, finally, after reading this here <a href="http://msdn.microsoft.com/ru-ru/library/bb549046">msdn.microsoft.com/ru-ru/library/bb549046</a> ).  However, the DBMS calculates the sum of the empty set as <i>NULL</i> (this is correct or not - the question is quite holivar, but now it is just a fact), and LINQ, trying to return <i>null</i> instead of an integer, immediately fails.  To fix this place is extremely simple, but you need to keep your ears open: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultForLTS = context.Users.Where(user =&gt; user.Id &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>).Sum(user =&gt; (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>?)user.Balance) ?? <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre> <br>  Here, the return value of the <i>Sum</i> function becomes not an <i>int</i> , but a <i>nullable int</i> (this can be achieved by explicitly indicating the type of generic), which allows LINQ to return <i>null</i> , but the operator ??  will turn this <i>null</i> into 0. <br><br>  Well, the last example.  Surprisingly, the translation in SQL gives us some syntactic sugar.  Consider this example.  Add a <i>Location</i> object, and users will now have a link to their city: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">User</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> balance; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Location location; } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Location</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name; }</code> </pre><br>  We will not create any <i>Location</i> objects and modify users, of interest is the following code: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultForObjects = users.Select(user =&gt; user.location == <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? <span class="hljs-string"><span class="hljs-string">"  "</span></span> : user.location.Name == <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? <span class="hljs-string"><span class="hljs-string">"  "</span></span> : user.location.Name) .First(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinqForHabr.DataClasses1DataContext(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultForLTS = context.Users.Select(user =&gt; user.Location == <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? <span class="hljs-string"><span class="hljs-string">"  "</span></span> : user.Location.name == <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? <span class="hljs-string"><span class="hljs-string">"  "</span></span> : user.Location.name) .First();</code> </pre><br>  In both cases, the result will be the string ‚ÄúLocation not specified‚Äù, since it is not really indicated, but what will happen if you write like this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultForLTS = context.Users.Select(user =&gt; user.Location.name ?? <span class="hljs-string"><span class="hljs-string">"  "</span></span>);</code> </pre> <br>  You might think that this will not work, since there is an explicit <i>NullReferenceException</i> (no user has a <i>Location</i> object a priori, we did not create them, did not write them to the database), but do not forget that this code will not be run in the environment .NET, but will be translated to SQL and running the DBMS.  In fact, the query that comes out of this code will look like this (LINQPad to help): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>([t1].[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>],@p0) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Users</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [t0] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [Locations] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [t1] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [t1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [t0].[LocationId]</code> </pre><br>  This ‚Äútrick‚Äù allows us not to write a wild number of ternary operators in LINQ queries. <br><br><h4>  Conclusion: </h4><br>  When we write code, we constantly rely on lower-level functions and we believe that these functions work correctly.  It is great that there is such a way to reduce complexity, but you should always be aware of whether we understand well enough what a particular function that we use will do.  And for this - RTFM! </div><p>Source: <a href="https://habr.com/ru/post/203836/">https://habr.com/ru/post/203836/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../203824/index.html">ICANN deprived accreditation of a famous spammer</a></li>
<li><a href="../203828/index.html">How to safely read Habr at work using our information security screens</a></li>
<li><a href="../203830/index.html">Creative Commons 4.0 licenses approved</a></li>
<li><a href="../203832/index.html">Genetic algorithms in Matlab playfully</a></li>
<li><a href="../203834/index.html">"Backups" in a living organism</a></li>
<li><a href="../203840/index.html">Creating a brickwork for the site</a></li>
<li><a href="../203842/index.html">Started pre-orders for YotaPhone for 20 000 rubles</a></li>
<li><a href="../203846/index.html">Overview of the mobile application "Ostrovok" for the Android platform</a></li>
<li><a href="../203848/index.html">Runetology (212): Vladimir Bakuteev, CEO of LiveTex</a></li>
<li><a href="../203850/index.html">Open data is here</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>