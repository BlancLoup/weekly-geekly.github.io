<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>My Internet of Things: Guest Castle</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So there were circumstances that I have a one-room apartment in which I do not live, but I don‚Äôt care to rent it in the ‚Äúusual way‚Äù. I tried to pass i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>My Internet of Things: Guest Castle</h1><div class="post__text post__text-html js-mediator-article">  So there were circumstances that I have a one-room apartment in which I do not live, but I don‚Äôt care to rent it in the ‚Äúusual way‚Äù.  I tried to pass it through the Airbnb service, I liked it.  And not that it is more profitable, but definitely more interesting, the process is exciting.  But I'm not talking about that ... <br><br>  I had a situation a couple of times when I could not personally meet a guest and hand him the key.  Usually in such situations one has to invent various ways, from laying the key under the carpet to transmission through the concierge.  I do not want to initiate outsiders into my business and somehow hide the key under the rug. <br><a name="habracut"></a><br>  I wanted something high-tech.  I thought like this: today, many have smartphones, and if you look at my potential guests, then almost everyone has.  Really nothing is thought up for iPhone and Android to open the door lock from the smartphone?  It turns out, very much invented.  Found two interesting solutions. <br><br>  1. <a href="https://lockitron.com/">Lockitron Bolt</a> <br><div class="spoiler">  <b class="spoiler_title">Details about the gadget</b> <div class="spoiler_text">  Physically, it is a servo-plate on a regular door lock, controlled via Bluetooth.  Additionally, there is a Bridge module, on the one hand, connected to the Internet, and on the other hand, it is controlled via a wireless channel by a servo drive.  It is controlled by all through the application for smartphones and through the web-muzzle.  You can send electronic keys to your friends so that they enter, you can open the door for them through the Internet. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The price of the issue is $ 99 per servo + $ 79 for Bridge + shipping. <br><br>  In general, the gadget is interesting, but there are a couple of problems.  First, he is not ready yet.  Acceptance of pre-orders for the beta version.  Secondly, the servo is designed for unlocking and locking the lock in a half-turn, it is such locks that are popular in its homeland in the USA.  I have a cylinder-type European type lock in my apartment, for opening / closing you need to make at least 1 full turn of the cylinder.  You can, of course, insert an additional lock into the door, but see ‚Äúfirst‚Äù. <br></div></div><br>  2. <a href="http://www.kwikset.com/kevo">Kevo Smart Lock</a> <br><div class="spoiler">  <b class="spoiler_title">Details about the gadget</b> <div class="spoiler_text">  This is a self-contained device, a lock with a built-in servo drive, a Bluetooth interface and a touch sensor.  Looks more attractive.  As a ‚Äúkey‚Äù, an application for a smartphone, a special key chain, or an ordinary key is used.  The principle of operation is similar to the standard signaling of some modern cars.  If in the range of the wireless connection there is a necessary phone or key chain, then it is enough just to touch the lock to open it.  Very impressive. <br><br>  Price issue $ 202 + shipping. <br><br>  I even began to place an order, as I thought, but can I insert it into my metal door.  And here I was in for an unpleasant surprise.  I can not.  The thickness of the door is more than necessary, and the distance from the end of the door to the lining is not enough. <br></div></div><br>  It turned out that heavy metal doors with a thickness of 60 mm in human homes in the United States are not very popular, as a result of which smart locks for such doors are also not very popular.  The ‚ÄúAmerican‚Äù type of lock is installed in a door up to 55 mm thick, usually wooden. <br><br>  This was all the rationale for the project.  <b>Now the actual development itself.</b> <br><br>  A little bit about yourself.  I work in the field of IT, but my work has nothing to do with controllers.  I have a basic education in robotics, I did not work in my specialty, but I did not manage to forget all of the university education.  The architecture of the ‚Äúproduct‚Äù in my head appeared immediately, without my verbal participation. <br><br>  She looked like this: <br><br>  <i>Command Server &lt;=&gt; Controller &lt;=&gt; Actuator</i> <br><br>  I started the project without a specific plan, without functional requirements, as a research one.  A little googling revealed that I needed an Arduino platform.  Then there was almost a month of exploring the capabilities of the platform, various examples of implemented projects and a short course of recalling programming skills in C ++. <br><br>  In parallel, I thought about the choice of the actuator.  In all the examples found on the web, the cylinder of the lock was rigidly connected to the servo drive, and it categorically did not suit me, since  it was necessary that the lock could be opened from the outside with a key, and a rigid connection would exclude such a possibility.  Well, again, to open / close my lock, you need at least one full turn of the cylinder, and the servos usually turn only 180 ¬∞.  There were thoughts to make a complex servo drive consisting of a drive motor, a clutch and an angle sensor, but I rejected it due to the lack of metalworking equipment, which would certainly be required to accomplish this task. <br><br>  The ideal variant was seen by me as a standard European cylinder for a lock, but only electromechanical, so that it could be opened from the outside, with a handle from the inside and with an electric drive upon a command from the controller.  But, unfortunately, I did not find such a ready solution. <br><br>  I came across an CISA electromechanical lock worth 35 tr.  It was possible to change your lock (of the same manufacturer) for it, since the dimensions are standard, but the price is ... <br><br>  Another parallel process is the development of functional requirements for the system.  Hereinafter we will call the system ‚ÄúGuest Castle‚Äù.  So: <br><ol><li>  The guest lock is not the main lock ensuring the safety of the apartment; </li><li>  The guest lock is used only for guests to enter the apartment for the first time in the absence of the owner and in the absence of the owner to leave the apartment for the last time, without having to transfer the key through the mailbox or in any other unsafe way; </li><li>  The rest of the time the apartment is locked with the usual locks with the usual metal keys, respectively, the Guest lock can be in an active and inactive state; </li><li>  The guest lock must be safe from the point of view of fire safety, not to impede evacuation when the power supply is off; </li><li>  The owner must be able to open the Guest lock remotely via the Internet, transfer it to an active or inactive state; </li><li>  The guest can use the ‚Äúguest key‚Äù received from the host to open the lock; </li><li>  "Guest key" works only in the immediate vicinity of the castle; </li><li>  "Guest key" is limited in time of action. </li></ol><br>  It was necessary to make a painful choice of controller between the Arduino Ethernet and Arduino Yun.  It would seem, Yun - the very thing that the doctor ordered.  We raise a web server on the Linux part, we implement all the logic of high order on it and at the right moment we give commands to the microcontroller part.  It remains only to buy a real IP address from the provider and it will work.  But something stopped me from such a choice.  At first, there were disturbing doubts that a real IP should be spent in the apartment, and then I realized that scalability really stops me.  One lock on Yun earns one-two, and two locks?  And if the two castles have different owners and guests?  Etc. <br><br>  Thus, the final choice fell on the Arduino Ethernet. <br><br>  In the meantime, the issue with the executive mechanism was resolved.  As such, YLI electric girder lock was chosen for access control systems, at the price of a little more than 3 tr.  These are in offices, warehouses, etc.  premises, usually complete with a bunch of other access control equipment. <br><br>  Power supply 12V, the maximum starting current of the solenoid 900 mA.  A special feature for users of metal doors: it can be embedded in the door frame, width 37 mm (boxes usually 40-50 mm). <br><br>  These locks are of two types, open without power (NO) and closed without power (NC).  In rooms for people, it is strongly recommended to use only type NO, so that in an emergency situation, accompanied by a power outage, people inside the room could easily leave the danger zone. <br><br>  From the castle is 5 wires: <br>  Red: + 12V <br>  Black: Earth <br>  Orange: Discovery.  It is usually +4.8 V. In order to open the lock, you need to close the wire to the ground. <br>  Green and White: Door Closing Sensor.  When the door is open, the wires are open, when closed - closed. <br><br><h4>  So, we will assemble the first prototype </h4><br>  We will control the 12 V supply circuit of the lock through the field effect transistor.  The opening wire will be connected to ground through the NPN transistor.  For beauty, we put a two-color LED to light green when the lock is not active and red when active.  To give drama to the whole scene, we will put a piezo squeaker.  For manual opening from the inside, as on the doors with intercom, we put the clock button. <br><br>  Sketch accepts commands on the UART, recognizes them and is able to activate, deactivate and open the lock.  In addition, it responds to inquiries about the current status of the lock (active or not) and the state of the door (open or closed) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f0c/9e7/e76/f0c9e7e76f67e4658ec1b03709832ded.png" alt="image"><br><br><div class="spoiler">  <b class="spoiler_title">Sketch</b> <div class="spoiler_text"><pre><code class="hljs lua">#include &lt;EEPROM.h&gt; //    / #define BEEPER <span class="hljs-number"><span class="hljs-number">5</span></span> //  #define BUTTON <span class="hljs-number"><span class="hljs-number">2</span></span> //  #define LED_RED <span class="hljs-number"><span class="hljs-number">6</span></span> //    #define LED_GREEN <span class="hljs-number"><span class="hljs-number">3</span></span> //    #define LOCK_POWER <span class="hljs-number"><span class="hljs-number">7</span></span> //   ,     #define LOCK_OPEN <span class="hljs-number"><span class="hljs-number">9</span></span> //   ,   #define NO_PIN <span class="hljs-number"><span class="hljs-number">8</span></span> //    //      loop() #define EVENT_NONE <span class="hljs-number"><span class="hljs-number">0</span></span> //    #define EVENT_BUTTON <span class="hljs-number"><span class="hljs-number">1</span></span> //   #define EVENT_ACTIVATE <span class="hljs-number"><span class="hljs-number">2</span></span> //     #define EVENT_DEACTIVATE <span class="hljs-number"><span class="hljs-number">3</span></span> //     #define EVENT_OPEN <span class="hljs-number"><span class="hljs-number">4</span></span> //     #define EVENT_SERIAL <span class="hljs-number"><span class="hljs-number">99</span></span> //    UART <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> deviceID[<span class="hljs-number"><span class="hljs-number">12</span></span>]; int eventButton = EVENT_NONE; int lockActive = LOW; String inputString = <span class="hljs-string"><span class="hljs-string">""</span></span>; void pressButton(){ //     eventButton = EVENT_BUTTON; } void setup(){ pinMode(BEEPER, OUTPUT); pinMode(LED_RED, OUTPUT); pinMode(LED_GREEN, OUTPUT); pinMode(LOCK_POWER, OUTPUT); pinMode(LOCK_OPEN, OUTPUT); pinMode(BUTTON, INPUT); pinMode(NO_PIN, INPUT); Serial.begin(<span class="hljs-number"><span class="hljs-number">9600</span></span>); inputString.reserve(<span class="hljs-number"><span class="hljs-number">30</span></span>); attachInterrupt(<span class="hljs-number"><span class="hljs-number">0</span></span>, pressButton, RISING); eventButton = EVENT_NONE; lockActive = EEPROM.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); //     <span class="hljs-string"><span class="hljs-string">" "</span></span> digitalWrite(LOCK_POWER, lockActive); digitalWrite(LED_RED, lockActive); digitalWrite(LED_GREEN, !lockActive); } int commandProcessor(String incomingString){ incomingString.trim(); incomingString.toUpperCase(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (incomingString == <span class="hljs-string"><span class="hljs-string">"OPEN"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> EVENT_OPEN; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (incomingString == <span class="hljs-string"><span class="hljs-string">"ACTIVATE"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> EVENT_ACTIVATE; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (incomingString == <span class="hljs-string"><span class="hljs-string">"DEACTIVATE"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> EVENT_DEACTIVATE; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> EVENT_NONE; } } void loop(){ //      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eventButton == EVENT_SERIAL){ //      Serial inputString.trim(); inputString.toUpperCase(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inputString == <span class="hljs-string"><span class="hljs-string">"STATUS"</span></span>) { //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lockActive == HIGH) { Serial.println(<span class="hljs-string"><span class="hljs-string">"ACTIVE"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Serial.println(<span class="hljs-string"><span class="hljs-string">"NOTACTIVE"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inputString == <span class="hljs-string"><span class="hljs-string">"DOOR"</span></span>) { //      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(NO_PIN) == HIGH) { Serial.println(<span class="hljs-string"><span class="hljs-string">"CLOSE"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Serial.println(<span class="hljs-string"><span class="hljs-string">"OPEN"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inputString == <span class="hljs-string"><span class="hljs-string">"NORMAL OPEN"</span></span>) { //     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (EEPROM.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>) != LOW) { EEPROM.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, LOW); delay(<span class="hljs-number"><span class="hljs-number">10</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inputString == <span class="hljs-string"><span class="hljs-string">"NORMAL CLOSE"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (EEPROM.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>) != HIGH) { EEPROM.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, HIGH); delay(<span class="hljs-number"><span class="hljs-number">10</span></span>); } } //    eventButton = commandProcessor(inputString); inputString = <span class="hljs-string"><span class="hljs-string">""</span></span>; } //    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eventButton == EVENT_BUTTON) { eventButton = EVENT_OPEN; //           } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eventButton == EVENT_ACTIVATE) { lockActive = HIGH; digitalWrite(LOCK_POWER, HIGH); digitalWrite(LED_RED, HIGH); digitalWrite(LED_GREEN, LOW); tone(BEEPER, <span class="hljs-number"><span class="hljs-number">700</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eventButton == EVENT_DEACTIVATE) { lockActive = LOW; digitalWrite(LOCK_POWER, LOW); digitalWrite(LED_RED, LOW); digitalWrite(LED_GREEN, HIGH); tone(BEEPER, <span class="hljs-number"><span class="hljs-number">700</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eventButton == EVENT_OPEN) { digitalWrite(LOCK_OPEN, HIGH); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lockActive == HIGH) { tone(BEEPER, <span class="hljs-number"><span class="hljs-number">750</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>); } delay(<span class="hljs-number"><span class="hljs-number">10</span></span>); digitalWrite(LOCK_OPEN, LOW); eventButton = EVENT_NONE; } eventButton = EVENT_NONE; } void serialEvent() { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Serial.available()) { <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> inChar = (<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>)Serial.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(); inputString += inChar; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inChar == <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) { eventButton = EVENT_SERIAL; } } }</code> </pre> <br></div></div><br>  Conclusions on the first iteration of the project. <br><ol><li>  Arduino is Vesch! </li><li>  Engineering skills do not drink, it turns out, I remember a lot of things; </li><li>  Ethernet Shield reserves a lot of Arduino Uno outputs, if you miss the LEDs, you'll have to save.  For example, the field-effect transistor gate and the red LED can be connected to the same pin, the opening button does not have to be entered into the controller, you can go directly to the lock or transistor key. </li></ol><br><br><h4>  Add some distribution </h4><br>  The results of googling for the query ‚Äúmanagement of arduino internet‚Äù basically tell you how to make a simple web server to display sensor readings, or how to build a cat selfie booth on Yun. <br><br>  Habr√© had an interesting <a href="http://habrahabr.ru/post/219107/">overview of the Ninja Blocks cloud service</a> .  It seems that when I read this review, the service worked somehow wrong. <br><br>  The same author <a href="http://geektimes.ru/users/ivizil/" class="user_link">ivizil</a> just recently published a <a href="http://habrahabr.ru/post/257115/">way to control via HTTP requests</a> .  I tried this method about a month before this publication and rejected it for aesthetic reasons.  Bombing hosting every 5-10 seconds with the same request waiting for one single team per day is somehow not aesthetically pleasing. <br><br>  The perfect option I saw in the use of XMPP.  The client on the Arduino connects to the server and receives commands from it: ‚Äúturn on‚Äù, ‚Äúturn off‚Äù, ‚Äúopen‚Äù or requests ‚Äústate‚Äù, ‚Äúdoor‚Äù.  The guest also connects as an XMPP client, the server restricts access and controls who can send a command to where. <br><br>  Alas, there were no ready-made libraries for implementing XMPP client on the Arduino.  We will be content with the good old Telnet. <br><br><h4>  Second prototype </h4><br>  In order to save digital outputs, I tried to put the gate of the field effect transistor and the LED on one output.  The lock was suddenly lacking tension to pull the bolt.  Measurements showed that the lock instead of the required 12V is slightly less than 11V.  The problem is that when the gate is 5V, there is 11.8V between the source and the ground, and when 4.8V - 10.9V.  We'll have to put a bipolar transistor in the 12V circuit before the gate, well, and take into account the nuance that this transistor will invert the signal a little. <br><br>  For the second prototype, we need a telnet server.  You can write it a lot on what, I decided to do it in Python.  I admit, my acquaintance with Python is very nimble.  I read that it is very fast and convenient to work on it, that it is cross platform and even could write ‚ÄúHello World!‚Äù From the first attempt. <br><br>  I started to google examples of working with Telnet in Python and rather quickly came across the Twisted library.  Based on an example of a simple chat server and refined it to a ‚Äúcommand server‚Äù. <br><br>  The script works like this: <br><br>  When enabled, the controller tries to connect to the server.  If the attempt is unsuccessful, the next one is repeated after a certain time interval  let's say 10 seconds. <br><br>  With a successful connection, we first check if our server is ours.  We send a randomly generated code to it, the server adds a secret word to it, which is stored in the mySQL table, calculates MD5 and sends it back.  The controller compares the received MD5 with a similarly calculated by itself and if they match the connection is considered reliable and we are ready to receive commands from the server, to mark which we will light the orange LED.  The command syntax is the same as for the UART. <br><br>  On the server, we mark a client that connects in such a way as ‚Äúlock‚Äù. <br><br>  "Keys" are connected in a similar way.  After connection, the client sends a request to the server to become a ‚Äúkey‚Äù.  The same request authorization: the server responds with a random sequence of characters, you need to add a secret word to it, which the key must know, calculate MD5 and send back.  If the result sent by the client matches the result calculated by the server, the client is defined as a ‚Äúkey‚Äù and he is allowed to send commands to the ‚Äúlocks‚Äù. <br><br>  In the event handler of the protocol event, the parsim received from the client line and send back and forth commands. <br><br><div class="spoiler">  <b class="spoiler_title">Python server code</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> twisted.protocols <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> basic <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> twisted.internet <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> reactor <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> twisted.internet.protocol <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ServerFactory <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> twisted.protocols.basic <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> LineOnlyReceiver <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> twisted.application <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> service, internet <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> hashlib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> threading <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MySQLdb <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> MySQLdb <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Error <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> random <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChatProtocol</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(LineOnlyReceiver)</span></span></span><span class="hljs-class">:</span></span> name = <span class="hljs-string"><span class="hljs-string">""</span></span> isKey = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> authKey = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSecret</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,isKey)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> self.factory.conn: self.factory.mySQLdbConnect() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isKey: reqTable = <span class="hljs-string"><span class="hljs-string">"lockkeys"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: reqTable = <span class="hljs-string"><span class="hljs-string">"locks"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: cursor = self.factory.conn.cursor() cursor.execute(<span class="hljs-string"><span class="hljs-string">"SELECT `secret` FROM `"</span></span> + reqTable + <span class="hljs-string"><span class="hljs-string">"` WHERE id='"</span></span> + self.getName() + <span class="hljs-string"><span class="hljs-string">"'"</span></span>) rows = cursor.fetchall() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cursor.rowcount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>: cursor.close() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rows[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>].strip() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: cursor.close() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Error <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: print(e) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: cursor.close() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self,lockID)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> self.isKey: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.transport.getPeer().host == <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> self.factory.conn: self.factory.mySQLdbConnect() <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: cursor = self.factory.conn.cursor() cursor.execute(<span class="hljs-string"><span class="hljs-string">"SELECT `rights` FROM `hosts` WHERE (`lock`='"</span></span> + lockID + <span class="hljs-string"><span class="hljs-string">"') AND (`lockkey`='"</span></span>+ self.getName() + <span class="hljs-string"><span class="hljs-string">"')"</span></span>) rows = cursor.fetchall() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cursor.rowcount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>: cursor.close() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rows[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: cursor.close() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Error <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: print(e) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: cursor.close() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.name!=<span class="hljs-string"><span class="hljs-string">""</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.name <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.transport.getPeer().host <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connectionMade</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"New connection from "</span></span>+self.getName() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.transport.getPeer().host == <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>: self.isKey = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> d = {self.getName() : self} self.factory.clients.update(d) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connectionLost</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, reason)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Lost connection from "</span></span>+self.getName() self.factory.clients.pop(self.getName()) self.factory.sendMessageToAllclients(self.getName()+<span class="hljs-string"><span class="hljs-string">" has disconnected."</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lineReceived</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, line)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#print self.getName()+" said "+line #if line[:3] == "/OK" if line[:5]=="/KEY:": str1 = '123456789' str2 = 'qwertyuiopasdfghjklzxcvbnm' str3 = str2.upper() str4 = str1+str2+str3 ls = list(str4) random.shuffle(ls) self.authKey = ''.join([random.choice(ls) for x in range(12)]) self.sendLine("ANSW:"+self.authKey) oldName = self.getName() self.name = line[5:].strip() self.factory.clients.pop(oldName) self.factory.clients.update({self.getName() : self}) self.isKey = False print oldName+" has requested to be Key ID:"+self.getName() elif line=="/EXIT": self.transport.loseConnection() elif line[:6]=="/ANSW:": secret = self.getSecret(True) if secret: m = hashlib.md5() m.update(self.authKey + secret) if m.hexdigest() == line[6:].strip(): self.isKey = True print self.getName() + " was authorisated as Key" else: self.sendLine("Authorisation fail") self.transport.loseConnection() else: self.sendLine("Authorisation fail") self.transport.loseConnection() if self.isKey: #Only from keys if line[:6]=="/OPEN:": if self.validKey(line[6:]): adresat = self.factory.clients.get(line[6:],None) if adresat: adresat.sendLine("OPEN:" + self.getName() + "\r\n") else: self.sendLine("DeviceID="+ line[6:] + " is not online\r\n") elif line[:10]=="/ACTIVATE:": if self.validKey(line[10:]): adresat = self.factory.clients.get(line[10:],None) if adresat: adresat.sendLine("ACTIVATE:" + self.getName() + "\r\n") else: self.sendLine("DeviceID="+ line[10:] + " is not online\r\n") elif line[:12]=="/DEACTIVATE:": if self.validKey(line[12:]): adresat = self.factory.clients.get(line[12:],None) if adresat: adresat.sendLine("DEACTIVATE:" + self.getName() + "\r\n") else: self.sendLine("DeviceID="+ line[12:] + " is not online\r\n") else: # Only from locks if line[:4]=="/ID:": oldName = self.getName() self.name = line[4:].strip() self.factory.clients.pop(oldName) self.factory.clients.update({self.getName() : self}) print oldName+" changed name to "+self.getName() elif line[:4]=="/RE:": secret = self.getSecret(self.isKey) if secret == None: self.sendLine("Your Device ID is not register in Command Server") self.transport.loseConnection() else: requestCode = line[4:] m = hashlib.md5() m.update(requestCode + secret) self.sendLine("AUTH:" + m.hexdigest() + "\r\n") elif line[:4]=="/OK:": adresat = self.factory.clients.get(line[4:],None) if adresat: adresat.sendLine("OK:" + self.getName()) else: self.factory.sendMessageToAllclients(self.getName()+" says "+line) def sendLine(self, line): self.transport.write(line+"\r\n") class ChatProtocolFactory(ServerFactory): protocol = ChatProtocol clients = {} def mySQLdbConnect(self): try: self.conn = MySQLdb.connect(host='127.0.0.1',user='guestlock',passwd='passw',db='guestlock') except Error as e: print(e) return False else: return True def __init__(self): print "Starting server..." self.clients = {} if self.mySQLdbConnect(): print "Server ready!" else: print "Data base error. Server doesn't work correctly." def sendMessageToAllclients(self, mesg): for client in self.clients.values(): client.sendLine(mesg) factory = ChatProtocolFactory() application = service.Application("CommandServer") internet.TCPServer(12345, factory).setServiceParent(application)</span></span></code> </pre><br></div></div><br>  The server should be started as a daemon using the standard twistd demonization utility <br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$twistd</span></span> -y CommandServer.py</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Sketch</b> <div class="spoiler_text"><pre> <code class="hljs lua">#include &lt;EEPROM.h&gt; #include &lt;SPI.h&gt; #include &lt;Ethernet.h&gt; #include &lt;MD5.h&gt; //    / #define BEEPER <span class="hljs-number"><span class="hljs-number">5</span></span> //  #define BUTTON <span class="hljs-number"><span class="hljs-number">2</span></span> //  #define LOCK_POWER <span class="hljs-number"><span class="hljs-number">7</span></span> //   #define LED_DEACTIVE <span class="hljs-number"><span class="hljs-number">6</span></span> //   #define LOCK_OPEN <span class="hljs-number"><span class="hljs-number">9</span></span> //   #define LED_ETHERNET <span class="hljs-number"><span class="hljs-number">8</span></span> //     #define NO_PIN A0 // NO   //      loop() #define EVENT_NONE <span class="hljs-number"><span class="hljs-number">0</span></span> #define EVENT_ETHERNET <span class="hljs-number"><span class="hljs-number">98</span></span> #define EVENT_SERIAL <span class="hljs-number"><span class="hljs-number">99</span></span> #define RECONNECT_TIME <span class="hljs-number"><span class="hljs-number">5000</span></span> //     ,  <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> deviceID[<span class="hljs-number"><span class="hljs-number">12</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> mac[] = { <span class="hljs-number"><span class="hljs-number">0xDE</span></span>, <span class="hljs-number"><span class="hljs-number">0xAD</span></span>, <span class="hljs-number"><span class="hljs-number">0xBE</span></span>, <span class="hljs-number"><span class="hljs-number">0xEF</span></span>, <span class="hljs-number"><span class="hljs-number">0xFE</span></span>, <span class="hljs-number"><span class="hljs-number">0xED</span></span>}; EthernetClient client; IPAddress server(<span class="hljs-number"><span class="hljs-number">192</span></span>,<span class="hljs-number"><span class="hljs-number">168</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>); long port = <span class="hljs-number"><span class="hljs-number">12345</span></span>; unsigned long lastConnectionTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; unsigned long disconnectTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; boolean lastConnected = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; volatile int eventButton = EVENT_NONE; //      loop() int lockActive = LOW; String inputString = <span class="hljs-string"><span class="hljs-string">""</span></span>; String ethernetString = <span class="hljs-string"><span class="hljs-string">""</span></span>; long requestCode; void pressButton(){ //     lockOpen(); } void majorBeep() { tone(BEEPER, <span class="hljs-number"><span class="hljs-number">750</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>); } void minorBeep() { tone(BEEPER, <span class="hljs-number"><span class="hljs-number">300</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } void lockActivate(boolean lockState){ digitalWrite(LOCK_POWER, lockState); digitalWrite(LED_DEACTIVE, !lockState); lockActive = lockState; majorBeep(); } void lockOpen() { digitalWrite(LOCK_OPEN, HIGH); delay(<span class="hljs-number"><span class="hljs-number">50</span></span>); digitalWrite(LOCK_OPEN, LOW); majorBeep(); } void lockSetDefaultState(int state){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (EEPROM.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>) != state) { EEPROM.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, state); delay(<span class="hljs-number"><span class="hljs-number">10</span></span>); } majorBeep(); } boolean serverAuthRequest() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!client.connected()){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } client.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"/ID:"</span></span>); client.println(deviceID); delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> rCode[<span class="hljs-number"><span class="hljs-number">6</span></span>]; ultoa(<span class="hljs-built_in"><span class="hljs-built_in">random</span></span>(<span class="hljs-number"><span class="hljs-number">99999</span></span>),rCode,<span class="hljs-number"><span class="hljs-number">16</span></span>); unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* hash=MD5::make_hash(rCode); <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *md5str = MD5::make_digest(hash, <span class="hljs-number"><span class="hljs-number">16</span></span>); client.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"/RE:"</span></span>); client.println(md5str); String answerHash = md5str; answerHash.trim(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i=<span class="hljs-number"><span class="hljs-number">0</span></span>; EEPROM.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>+i) != <span class="hljs-number"><span class="hljs-number">0</span></span>; i++){ answerHash += <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(EEPROM.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>+i)); } <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *aCode = (<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>*)malloc(answerHash.length()+<span class="hljs-number"><span class="hljs-number">1</span></span>); ; answerHash.toCharArray(aCode,answerHash.length()+<span class="hljs-number"><span class="hljs-number">1</span></span>); hash=MD5::make_hash(aCode); md5str = MD5::make_digest(hash, <span class="hljs-number"><span class="hljs-number">16</span></span>); answerHash = md5str; free(md5str); free(aCode); unsigned long mm = millis(); ethernetString = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (millis()-mm &lt; RECONNECT_TIME) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.available()) { <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> inChar = client.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(); ethernetString += inChar; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inChar == <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) { ethernetString.trim(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ethernetString.startsWith(<span class="hljs-string"><span class="hljs-string">"AUTH:"</span></span>)) { ethernetString = ethernetString.substring(<span class="hljs-number"><span class="hljs-number">5</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { ethernetString = <span class="hljs-string"><span class="hljs-string">""</span></span>; } } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (ethernetString == answerHash); } boolean serverConnect() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.connect(server, port)) { lastConnectionTime = millis(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serverAuthRequest()) { Serial.println(<span class="hljs-string"><span class="hljs-string">"Server autenfication sucsesseful"</span></span>); majorBeep(); digitalWrite(LED_ETHERNET, HIGH); ethernetString = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ Serial.println(<span class="hljs-string"><span class="hljs-string">"Server autenfication fail"</span></span>); minorBeep(); digitalWrite(LED_ETHERNET, LOW); ethernetString = <span class="hljs-string"><span class="hljs-string">""</span></span>; client.stop(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Serial.println(<span class="hljs-string"><span class="hljs-string">"Connection fail"</span></span>); client.stop(); digitalWrite(LED_ETHERNET, LOW); disconnectTime = millis(); ethernetString = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } void setup(){ pinMode(BEEPER, OUTPUT); pinMode(LOCK_OPEN, OUTPUT); pinMode(BUTTON, INPUT); pinMode(LOCK_POWER, OUTPUT); pinMode(LED_DEACTIVE, OUTPUT); pinMode(LED_ETHERNET, OUTPUT); lockActivate(EEPROM.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)); Serial.begin(<span class="hljs-number"><span class="hljs-number">9600</span></span>); randomSeed(analogRead(A1)); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i=<span class="hljs-number"><span class="hljs-number">1</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">12</span></span>; i++) { deviceID[i<span class="hljs-number"><span class="hljs-number">-1</span></span>] = EEPROM.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(i); } Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Device ID: "</span></span>); Serial.println(deviceID); delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); // start the Ethernet connection using a DNS server: Ethernet.begin(mac); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"My IP address: "</span></span>); Serial.println(Ethernet.localIP()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!serverConnect()) { disconnectTime = millis(); } inputString.reserve(<span class="hljs-number"><span class="hljs-number">30</span></span>); attachInterrupt(<span class="hljs-number"><span class="hljs-number">0</span></span>, pressButton, RISING); eventButton = EVENT_NONE; } boolean commandProcessor(String incomingString, int commandSource){ boolean result = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; String report = <span class="hljs-string"><span class="hljs-string">"OK"</span></span>; incomingString.trim(); incomingString.toUpperCase(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (incomingString.startsWith(<span class="hljs-string"><span class="hljs-string">"OPEN"</span></span>)) { lockOpen(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (incomingString.startsWith(<span class="hljs-string"><span class="hljs-string">"ACTIVATE"</span></span>)) { lockActivate(HIGH); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (incomingString.startsWith(<span class="hljs-string"><span class="hljs-string">"DEACTIVATE"</span></span>)) { lockActivate(LOW); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (incomingString.startsWith(<span class="hljs-string"><span class="hljs-string">"STATUS"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lockActive == HIGH) { report = <span class="hljs-string"><span class="hljs-string">"ACTIVE"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { report = <span class="hljs-string"><span class="hljs-string">"NOTACTIVE"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (incomingString.startsWith(<span class="hljs-string"><span class="hljs-string">"DOOR"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (analogRead(NO_PIN) &gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>) { report = <span class="hljs-string"><span class="hljs-string">"CLOSE"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { report = <span class="hljs-string"><span class="hljs-string">"OPEN"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { result = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result &amp;&amp; (commandSource == EVENT_ETHERNET) &amp;&amp; client.connected()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (incomingString.indexOf(<span class="hljs-string"><span class="hljs-string">":"</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { client.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"/"</span></span> + report + incomingString.substring(incomingString.indexOf(<span class="hljs-string"><span class="hljs-string">":"</span></span>))); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { client.println(<span class="hljs-string"><span class="hljs-string">"/"</span></span> + report); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result &amp;&amp; (commandSource == EVENT_SERIAL)) { Serial.println(report); } } void ethernetEvent() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.available()) { <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> inChar = client.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(); ethernetString += inChar; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inChar == <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) { eventButton = EVENT_ETHERNET; } } } void loop(){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eventButton == EVENT_ETHERNET) { commandProcessor(ethernetString, eventButton); ethernetString = <span class="hljs-string"><span class="hljs-string">""</span></span>; eventButton = EVENT_NONE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eventButton == EVENT_SERIAL) { commandProcessor(inputString, eventButton); inputString = <span class="hljs-string"><span class="hljs-string">""</span></span>; eventButton = EVENT_NONE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!client.connected() &amp;&amp; lastConnected) { Serial.println(<span class="hljs-string"><span class="hljs-string">"Disconnecting."</span></span>); minorBeep(); digitalWrite(LED_ETHERNET, LOW); disconnectTime = millis(); client.stop(); } lastConnected = client.connected(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((!lastConnected) &amp;&amp; (millis() &gt; disconnectTime+RECONNECT_TIME)) { disconnectTime = millis(); serverConnect(); } ethernetEvent(); } void serialEvent() { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Serial.available()) { <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> inChar = (<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>)Serial.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(); inputString += inChar; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inChar == <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) { eventButton = EVENT_SERIAL; } } }</code> </pre><br></div></div><br><h4>  ProtoShield </h4><br>  In the hardware, the controller seems to me logically complete, if I want to add something, it is a pair of LEDs to indicate any important or not so much events or conditions, which means it's time to assemble it humanly.  Now it all looks like an art installation called ‚ÄúWhat wire to cut? !!‚Äù. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/723/89d/918/72389d918ef169ed459fe8a14a6e77d6.jpg" alt="image"><br><br>  We buy Arduino ProtoShield for 240 rubles.  Soldering iron, flux and solder is. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/688/000/833/6880008334c7f95bd9d2344847a7db35.png" alt="image"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e05/d88/ebc/e05d88ebc9932801b9f308a2dca77ced.jpg" alt="Castle shield"><br><br>  Conclusions on the second iteration: <br><ol><li>  Python is powerful but unusual; </li><li>  I have not forgotten how to solder; </li><li>  The server will run on a Rapsberry Pi; </li><li>  You must order a real IP address from the provider; </li><li>  You can install the "product" on the "object" and receive guests. </li></ol><br>  Now we are ready to install the system.  At a minimum, I can open the door for the guest while at work.  The question of management from guests' smartphones remains unsolved. <br><br>  <a href="http://geektimes.ru/post/259908/">To be continued...</a> </div><p>Source: <a href="https://habr.com/ru/post/259127/">https://habr.com/ru/post/259127/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259117/index.html">"Jetpack" is not so reactive, or how to do without it</a></li>
<li><a href="../259119/index.html">Automatic update of IP phones in 3CX. Part two. Practice</a></li>
<li><a href="../259121/index.html">Little tricks of passport collection</a></li>
<li><a href="../259123/index.html">Android M and Developer Tools</a></li>
<li><a href="../259125/index.html">Lectures Technopark. Semester 2 Java</a></li>
<li><a href="../259129/index.html">Positive Hack Days V WAF Bypass Contest</a></li>
<li><a href="../259133/index.html">IBM cloud grant up to $ 120,000 awaits you at Startup Village</a></li>
<li><a href="../259135/index.html">What was on PHDays V: signs of interception of GSM-signal, the best time to hack Wi-Fi, the future of encryption</a></li>
<li><a href="../259137/index.html">VKontakte launches BugBounty program</a></li>
<li><a href="../259139/index.html">UniFi Controller, displaying RADIUS logins</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>