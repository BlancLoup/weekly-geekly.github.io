<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic monitoring using Nagios and Puppet</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. 
 I want to write about the problem I encountered about a year ago. For our project, allocate an account on AWS and it was decided to transf...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic monitoring using Nagios and Puppet</h1><div class="post__text post__text-html js-mediator-article">  Good day. <br>  I want to write about the problem I encountered about a year ago.  For our project, allocate an account on AWS and it was decided to transfer the development process to the cloud.  Everything is convenient, virtual servers are deployed and configured smartly, but the further we moved into production, the more acutely the issue of monitoring was emphasized.  New servers were added every day, and autoscaling was planned in production. <br><br>  Just in case, short description: <br><a name="habracut"></a><br>  Nagios is a program for monitoring open source computer systems and networks.  It is intended for monitoring, monitoring the status of computing nodes and services, notifies the administrator in the event that some of the services stop (or resume) their work. <br>  Puppet is a cross-platform client-server application that allows you to centrally manage the configuration of operating systems and programs installed on multiple computers.  Puppet is written in the Ruby programming language. <br><br>  Most puppet manifests for project components were already written then, and the current way of adding new nodes was a bottleneck in this system.  And to my great surprise, I discovered that puppet began to support such resources as nagios_host, nagios_contact, etc. <br>  <a href="http://docs.puppetlabs.com/references/latest/type.html">puppet type reference</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As a result, there are puppet-server, nagios-servers (dev / stage / production), and a bunch of nodes.  It was necessary to say something like nagios server that we have a new node. <br>  The algorithm is as follows: <br>  Bootstrap new node =&gt; Launch Puppet agent on node =&gt; Launch Puppet agent on node with nagios (every 30 minutes by default). <br>  Puppet can perfectly store the exported node resources in the database (puppetdb / mysql / postgress / etc?).  Exported resources help to extract variables from the facter node, such as fqdn, ip_address, etc ... This was what I needed. <br><br>  Let's proceed to the puppetdb installation, <br>  In fact, everything is simple <br>  Add a repository Puppetlabs <a href="http://docs.puppetlabs.com/guides/puppetlabs_package_repositories.html">Puppet Labs Package Repositories</a> <br><br>  This method works for me <br><br><blockquote>  wget <a href="">apt.puppetlabs.com/puppetlabs-release-precise.deb</a> <br>  sudo dpkg -i puppetlabs-release-precise.deb <br>  sudo apt-get update <br>  sudo puppet resource package puppetdb ensure = latest <br>  sudo puppet resource service puppetdb ensure = running enable = true <br></blockquote><br><br>  /etc/puppet/puppet.conf <br><blockquote>  [master] <br>  storeconfigs = true <br>  storeconfigs_backend = puppetdb <br></blockquote><br><br>  /etc/puppet/puppetdb.conf <br><blockquote>  [main] <br>  server = puppet # dns name <br>  port = 8081 <br></blockquote><br><br>  How to install mysql or postgresql instead of puppetdb described in detail <a href="http://projects.puppetlabs.com/projects/1/wiki/using_stored_configuration">here</a> <br><br><h5>  Example </h5><br><br>  For an example of using exported resources.  Take 2 classes <br><br><blockquote>  class test { <br><br>  file {"/ tmp / 1": <br>  ensure =&gt; present, <br>  content =&gt; "$ :: ipaddress", <br>  } <br><br>  } <br></blockquote><br><br><blockquote> class test { <br><br>  <code>@@file</code> {"/ tmp / 1": <br>  ensure =&gt; present, <br>  content =&gt; "$ :: ipaddress", <br>  } <br><br>  } <br></blockquote><br><br>  In the first case, when the node applies the test manifest, the contents of the $ :: ipaddress variable from the facter are copied to the / tmp / 1 file.  In the second case, the file on the node is not created, and the <code>@@file</code> resource is stored in puppetdb for later recall. <br>  You can call it using constructs <br><br><blockquote>  class export_test { <br><br>  File &lt;&lt; |  | &gt;&gt; { <br>  } <br><br>  } <br></blockquote><br><br>  it is declared in class and says: Give me all the export resources in the File view. <br><br>  site.pp <br><blockquote>  node 'firstnode' { <br>  include test <br>  } <br>  node 'secondnode' { <br>  include exporttest <br>  } <br></blockquote><br><br>  As a result, resources from fistnode will be copied to the secondnode. <br>  We do the same with nagios resources. <br><br>  Config from nagios <br><br><blockquote>  define host { <br>  address 23.253.222.185 <br>  alias magnetodb-1 <br>  host_name magnetodb-1 <br>  use linux-server <br>  hostgroups dev <br>  } <br><br>  define service { <br>  service_description ssh <br>  use local-service <br>  check_command check_ssh <br>  servicegroups GENERIC_GROUP <br>  host_name magnetodb-1 <br>  } <br><br>  define service { <br>  service_description PING <br>  use nagios-graph-service <br>  check_command check_ping! 100.0.20%! 500.0.60% <br>  servicegroups GENERIC_GROUP <br>  host_name magnetodb-1 <br>  } <br><br></blockquote><br><br>  We are writing a class for a client that will add a host and 2 checks to puppetdb <br><blockquote>  class nagios :: host :: generic { <br><br>  <code>@@nagios_host</code> {"$ nagios_hostname": <br>  ensure =&gt; present, <br>  alias =&gt; $ nagios_hostname, <br>  host_name =&gt; "$ nagios_hostname", <br>  address =&gt; $ ipaddress, <br>  hostgroups =&gt; $ env, <br>  use =&gt; 'linux-server', <br>  target =&gt; "$ nagios :: params :: nagios_base / hosts / $ {env} _ $ {nagios_hostname} .cfg", # the location of the resource at the node where it will be exported <br>  tag =&gt; $ :: deployment_id, <br>  notify =&gt; Service ["nagios"], <br>  require =&gt; File [$ nagios :: params :: nagios_dirs], <br>  } <br><br>  <code>@@nagios_service</code> {"ssh $ ipaddress": <br>  ensure =&gt; present, <br>  check_command =&gt; 'check_ssh', <br>  host_name =&gt; $ nagios_hostname, <br>  servicegroups =&gt; 'GENERIC_GROUP', <br>  service_description =&gt; 'ssh', <br>  use =&gt; 'local-service', <br>  target =&gt; "$ nagios :: params :: nagios_base / hosts / services / $ {env} _ $ {nagios_hostname} .cfg", <br>  tag =&gt; $ :: deployment_id, <br>  notify =&gt; Service ["nagios"], <br>  require =&gt; File [$ nagios :: params :: nagios_dirs] <br>  } <br><br>  <code>@@nagios_service</code> {"ping $ ipaddress": <br>  ensure =&gt; present, <br>  check_command =&gt; 'check_ping! 100.0.20%! 500.0.60%', <br>  host_name =&gt; $ nagios_hostname, <br>  servicegroups =&gt; 'GENERIC_GROUP', <br>  service_description =&gt; 'PING', <br>  use =&gt; 'nagios-graph-service', <br>  target =&gt; "$ nagios :: params :: nagios_base / hosts / services / $ {env} _ $ {nagios_hostname} .cfg", <br>  tag =&gt; $ :: deployment_id, <br>  notify =&gt; Service ["nagios"], <br>  } <br><br>  } <br></blockquote><br><br>  The headers of the exported resources must be unique for each node, otherwise we get an error about the duplicate parameter in exported resources.  To do this, add a unique $ ipaddress or $ fqdn. <br><br>  Class for server <br><br><blockquote>  class nagios_server { <br>  Nagios_host &lt;&lt; |  tag == $ :: deployment_id | &gt;&gt; { <br>  } <br>  Nagios_service &lt;&lt; |  tag == $ :: deployment_id | &gt;&gt; { <br>  } <br><br>  #tag == $ :: deployment_id means that we select all resources with a specific tag from the database, this is convenient when we have several nagios that must be checked by different hosts. <br>  # variable $ deployment_id will need to be pre-declared in site.pp <br><br>  } <br></blockquote><br><br>  site.pp <br><blockquote>  $ deployment_id = "dev" <br>  $ env = "dev" <br><br>  node "nagios-1" { <br>  $ nagios_hostname = "$ {hostname}" <br>  class {'nagios :: server': <br>  } <br>  } <br><br>  node "nagios-client-1" { <br>  $ nagios_hostname = "$ hostname_ $ ipaddress" <br>  class {'nagios :: hosts :: generic':} <br><br>  } <br></blockquote><br>  In order to clean all the resources of the node from puppetdb <br><blockquote>  puppet node clean "node_certname" <br></blockquote><br><br>  At one time, this method helped me save a lot of time in servicing 100 nodes in AWS. <br>  I hope this article will help someone.  Thanks for attention <br><br>  References: <br><blockquote>  <a href="http://docs.puppetlabs.com/puppetdb/1/connect_puppet_master.html">docs.puppetlabs.com/puppetdb/1/connect_puppet_master.html</a> <br>  <a href="http://projects.puppetlabs.com/projects/1/wiki/using_stored_configuration">projects.puppetlabs.com/projects/1/wiki/using_stored_configuration</a> <br>  <a href="http://docs.puppetlabs.com/guides/exported_resources.html">docs.puppetlabs.com/guides/exported_resources.html</a> <br></blockquote></div><p>Source: <a href="https://habr.com/ru/post/219249/">https://habr.com/ru/post/219249/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../219237/index.html">Navigator campus travels to Volgograd, Taganrog, Krasnodar, Yaroslavl, St. Petersburg to communicate with the iron workers</a></li>
<li><a href="../219241/index.html">A selection of high-tech fitness innovations on Kickstarter</a></li>
<li><a href="../219243/index.html">Creating term analysis networks based on text analysis</a></li>
<li><a href="../219245/index.html">Long-awaited check of Unreal Engine 4</a></li>
<li><a href="../219247/index.html">Twitter: Revolutions Continue?</a></li>
<li><a href="../219251/index.html">Connecting the VFD Futaba GP1183A01B display to the Raspberry Pi</a></li>
<li><a href="../219253/index.html">Quadcopter DJI Phantom FC40 - mini-stripping and first flight</a></li>
<li><a href="../219255/index.html">L√ñVE + Android + AdMob = friendship</a></li>
<li><a href="../219257/index.html">Eron-dong-dong or what else could your Windows Phone do?</a></li>
<li><a href="../219259/index.html">5 The most exciting events that occurred in space [translation]</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>