<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How can you simplify your life using Telegram-bot</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What is this article about? 
 This article is a brief story about how you can successfully integrate a Telegram bot and an external service with the h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How can you simplify your life using Telegram-bot</h1><div class="post__text post__text-html js-mediator-article"><h1>  What is this article about? </h1><br>  This article is a brief story about how you can successfully integrate a Telegram bot and an external service with the help of available tools (Firefox) and Python. <br><br>  The material will be interesting to those who have heard about Telegram bots, but do not know how to approach them and what tasks can be solved with their help.  Knowledge of Python is assumed. <br><br>  Picture to attract attention: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="http://imgs.xkcd.com/comics/twitter_bot.png" alt="writing a twitter bot" title="PYTHON FLAG ENABLE THREE LAWS"><br>  ( <em><a href="http://xkcd.com/1646/">link to the original</a></em> ) <br><br><h1>  TL; DR </h1><br>  From the article you will learn: <br><br>  1. How can I use the browser to find out which request is sent to the server when a button is clicked? <br><br><div class="spoiler">  <b class="spoiler_title">Answer</b> <div class="spoiler_text">  <em>Using the web tool of your favorite browser, you can see all requests that are sent from the open page to the server.</em> <br><br></div></div><br>  2. How easy is it to send a request to the server using Python? <br><br><div class="spoiler">  <b class="spoiler_title">Answer</b> <div class="spoiler_text"> <em>A convenient wrapper over the standard <a href="https://docs.python.org/2/library/urllib2.html"><code>urllib2</code></a> module is the <a href="http://docs.python-requests.org/en/master/"><code>requests</code></a> library.</em>  <em>More on Habr√©: <a href="https://habrahabr.ru/post/126262/">"Library to simplify HTTP requests</a> . <a href="https://habrahabr.ru/post/126262/">"</a></em> <br><br></div></div><br>  3. How to write a bot in Python? <br><br><div class="spoiler">  <b class="spoiler_title">Answer</b> <div class="spoiler_text">  <em>A full-featured wrapper is implemented in the <a href="https://github.com/python-telegram-bot/python-telegram-bot/"><code>python-telegram-bot</code></a> library.</em>  <em>While on Habr√© this library was not mentioned.</em> <br><br></div></div><a name="habracut"></a><br><h1>  Problem </h1><br>  There is a <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D1%2580%25D0%25B5%25D0%25BB%25D0%25BA%25D0%25B0_%2528%25D0%25B5%25D0%25B4%25D0%25B8%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2582%25D1%2580%25D0%25B0%25D0%25BD%25D1%2581%25D0%25BF%25D0%25BE%25D1%2580%25D1%2582%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BA%25D0%25B0%25D1%2580%25D1%2582%25D0%25B0%2529">single transport card "Strelka"</a> , which allows you to save a lot on trips from Moscow to the region.  The reason for the savings is that the fare when paying in cash is 20-30% higher than when paying by the mentioned transport card. <br><br>  You cannot find out the balance on the account when making a payment.  Probably due to the reader‚Äôs lack of constant communication with processing servers.  <a href="http://strelkacard.ru/">Http://strelkacard.ru</a> and mobile applications for popular platforms are provided for information on the status of the account. <br><br>  After updating the phone to Android 6, something unpleasant happened: the official application became stable to fly out at launch.  Quite a few decent users left a corresponding message on <a href="https://play.google.com/store/apps/details%3Fid%3Dru.bytemax.vezdehod">the application page</a> in Google Play.  But things are there. <br><br><div class="spoiler">  <b class="spoiler_title">Screenshot of reviews on March 5</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/a18/d55/656/a18d55656e6e416da1ee07df1f9ee8b5.png" alt="" title="Developers are asleep"><br><br></div></div><br>  The need to obtain information about the balance usually appears at the time of payment of the trip.  It‚Äôs not very convenient to do this from a mobile device through the site, even when using a personal account. <br><br>  The question arose: "Is it possible to find out the balance of the card without unnecessary gestures?" <br><br><h1>  We investigate interfaces </h1><br>  There are at least two places where you can get information about the card balance: <br><br><ol><li>  Mobile app </li><li>  Official site </li></ol><br>  Find out what requests the application generates can be, but not trivial.  It is much easier to use the familiar browser and its web developer tools.  The plugin for Firefox <a href="https://addons.mozilla.org/en-US/firefox/addon/firebug/">Firebug is</a> very convenient for use. <br><br>  Go to the page <a href="http://strelkacard.ru/">http://strelkacard.ru/</a> and activate the panel Firebug.  Go to the tab <code>Net</code> .  If you now enter the card number and request a balance, you can see the request generated to receive this data: <br><br><img src="https://habrastorage.org/files/d0c/318/dd6/d0c318dd65a748fd98c585f7a5cf6e3d.png" alt="Firebug 'Net'"><br><br>  Right click on this request and select the <code>'Copy as cURL'</code> .  This action will lead to the fact that the clipboard will be the command to call the console utility <a href="https://en.wikipedia.org/wiki/CURL"><code>curl</code></a> with the parameters that allow you to send exactly the same request, which was generated by the browser. <br><br>  Example: <br><br><pre> <code class="hljs 1c">curl 'http://strelkacard.ru/api/cards/status/?cardnum=<span class="hljs-number"><span class="hljs-number">1234567890</span></span>1&amp;cardtypeid=3ae427a1-0f17-<span class="hljs-number"><span class="hljs-number">4524</span></span>-acb1-a3f<span class="hljs-number"><span class="hljs-number">5009</span></span>0a8f3' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Encoding: gzip, deflate' -H 'Accept-Language: en-US,en;q=0.5' -H 'Connection: keep-alive' -H 'Host: strelkacard.ru' -H 'Referer: http://strelkacard.ru/' -H 'User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:44.0) Gecko/<span class="hljs-number"><span class="hljs-number">20100101</span></span> Firefox/44.0'</code> </pre> <br>  If you enter this command without changes in the console, you will receive the expected response in <a href="https://en.wikipedia.org/wiki/JSON">JSON format</a> : <br><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"cardactive"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>,<span class="hljs-attr"><span class="hljs-attr">"balance"</span></span>:<span class="hljs-number"><span class="hljs-number">100100</span></span>,<span class="hljs-attr"><span class="hljs-attr">"baserate"</span></span>:<span class="hljs-number"><span class="hljs-number">3000</span></span>,<span class="hljs-attr"><span class="hljs-attr">"cardblocked"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>,<span class="hljs-attr"><span class="hljs-attr">"numoftrips"</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>}</code> </pre> <br>  Let us postpone the question of analyzing this answer for later, and now we will try to understand what arguments are really needed to get the correct answer. <br><br>  Since these actions are available to the user without authorization, you can most likely remove headers from the query without risking an incorrect answer.  Remove all the <code>-H</code> arguments and try sending a simple GET request: <br><br><pre> <code class="hljs ruby">$ curl <span class="hljs-string"><span class="hljs-string">'http://strelkacard.ru/api/cards/status/?cardnum=12345678901&amp;cardtypeid=3ae427a1-0f17-4524-acb1-a3f50090a8f3'</span></span> {<span class="hljs-string"><span class="hljs-string">"cardactive"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:false</span></span>,<span class="hljs-string"><span class="hljs-string">"balance"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">100100</span></span>,<span class="hljs-string"><span class="hljs-string">"baserate"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">3000</span></span>,<span class="hljs-string"><span class="hljs-string">"cardblocked"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:false</span></span>,<span class="hljs-string"><span class="hljs-string">"numoftrips"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">0</span></span>}</code> </pre> <br>  The answer still meets expectations.  Among the parameters transmitted with the request is <code>cardnum</code> , which is responsible for the card number, and <code>cardtypeid</code> , the name of which suggests that it is responsible for the type of card.  If the need for the first parameter is not in doubt, then the significance of the card type is questionable.  Especially provided that the user does not choose it.  Let's try to get rid of him: <br><br><pre> <code class="hljs ruby">$ curl <span class="hljs-string"><span class="hljs-string">'http://strelkacard.ru/api/cards/status/?cardnum=12345678901'</span></span> {<span class="hljs-string"><span class="hljs-string">"__all__"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span>[<span class="hljs-string"><span class="hljs-string">" "</span></span>]}</code> </pre> <br>  The expectations were not met.  This means that the type of card somehow participates in the formation of the answer.  A quick overview of js-scripts revealed the fact that this parameter is static, and it can be simply remembered and used later when communicating with the server. <br><br><h2>  Description of the server response </h2><br>  Let's take a closer look at the server response: <br><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"cardactive"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>,<span class="hljs-attr"><span class="hljs-attr">"balance"</span></span>:<span class="hljs-number"><span class="hljs-number">100100</span></span>,<span class="hljs-attr"><span class="hljs-attr">"baserate"</span></span>:<span class="hljs-number"><span class="hljs-number">3000</span></span>,<span class="hljs-attr"><span class="hljs-attr">"cardblocked"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>,<span class="hljs-attr"><span class="hljs-attr">"numoftrips"</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>}</code> </pre> <br>  Obviously, the value we need is <code>balance</code> .  If at the same time we compare the number with the fact that it was displayed in the browser after the execution of the request, it will become obvious that this value has the dimension of kopecks. <br><br><h2>  We communicate with the interface from Python </h2><br>  <code>curl</code> certainly good, but it's not enough for us to send a request and receive an answer in the form of text.  We need to be able to process this text.  The Python language supports the conversion of json into its own structure of objects <a href="https://docs.python.org/2/library/json.html">from the box</a> .  It also comes standard with a library for sending HTTP <a href="https://docs.python.org/2/library/urllib2.html"><code>urllib2</code></a> .  Sending a request using this library looks like this: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urllib2 &gt;&gt;&gt; f = urllib2.urlopen(<span class="hljs-string"><span class="hljs-string">'http://strelkacard.ru/api/cards/status/?cardnum=12345678901&amp;cardtypeid=3ae427a1-0f17-4524-acb1-a3f50090a8f3'</span></span>) &gt;&gt;&gt; print(f.read()) {<span class="hljs-string"><span class="hljs-string">"cardactive"</span></span>:false,<span class="hljs-string"><span class="hljs-string">"balance"</span></span>:<span class="hljs-number"><span class="hljs-number">100100</span></span>,<span class="hljs-string"><span class="hljs-string">"baserate"</span></span>:<span class="hljs-number"><span class="hljs-number">3000</span></span>,<span class="hljs-string"><span class="hljs-string">"cardblocked"</span></span>:false,<span class="hljs-string"><span class="hljs-string">"numoftrips"</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>}</code> </pre> <br>  Looks nice.  But we are going to change the <code>cardnum</code> parameter, so it would be great to rise one level of abstraction higher and not form the parameter string on our own.  Put the <a href="http://docs.python-requests.org/en/master/"><code>requests</code></a> library and use it: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests &gt;&gt;&gt; CARD_TYPE_ID = <span class="hljs-string"><span class="hljs-string">'3ae427a1-0f17-4524-acb1-a3f50090a8f3'</span></span> &gt;&gt;&gt; card_number=<span class="hljs-string"><span class="hljs-string">'12345678901'</span></span> &gt;&gt;&gt; payload = {<span class="hljs-string"><span class="hljs-string">'cardnum'</span></span>:card_number, <span class="hljs-string"><span class="hljs-string">'cardtypeid'</span></span>: CARD_TYPE_ID} &gt;&gt;&gt; r = requests.get(<span class="hljs-string"><span class="hljs-string">'http://strelkacard.ru/api/cards/status/'</span></span>, params=payload) &gt;&gt;&gt; print(<span class="hljs-string"><span class="hljs-string">"Get info for card %s: %d %s"</span></span> % (card_number, r.status_code, r.text)) Get info <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> card <span class="hljs-number"><span class="hljs-number">12345678901</span></span>: <span class="hljs-number"><span class="hljs-number">200</span></span> {<span class="hljs-string"><span class="hljs-string">"cardactive"</span></span>:false,<span class="hljs-string"><span class="hljs-string">"balance"</span></span>:<span class="hljs-number"><span class="hljs-number">100100</span></span>,<span class="hljs-string"><span class="hljs-string">"baserate"</span></span>:<span class="hljs-number"><span class="hljs-number">3000</span></span>,<span class="hljs-string"><span class="hljs-string">"cardblocked"</span></span>:false,<span class="hljs-string"><span class="hljs-string">"numoftrips"</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>}</code> </pre> <br>  The <code>requests</code> library provides a <a href="http://docs.python-requests.org/en/master/user/quickstart/"><code>json()</code></a> method for converting a json-formatted server response to a Python data structure. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>r.json() {<span class="hljs-string"><span class="hljs-string">u'cardactive'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, <span class="hljs-string"><span class="hljs-string">u'balance'</span></span>: <span class="hljs-number"><span class="hljs-number">100100</span></span>, <span class="hljs-string"><span class="hljs-string">u'numoftrips'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">u'baserate'</span></span>: <span class="hljs-number"><span class="hljs-number">3000</span></span>, <span class="hljs-string"><span class="hljs-string">u'cardblocked'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>} &gt;&gt;&gt; r.json()[<span class="hljs-string"><span class="hljs-string">'balance'</span></span>] <span class="hljs-number"><span class="hljs-number">100100</span></span></code> </pre> <br><h1>  Create your own wrapper </h1><br>  We already know how to get the information we need using a couple of lines of Python code.  Let's create a function to get information about the card balance.  Write the following code in the <code>checker.py</code> file: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python import logging import requests CARD_TYPE_ID = '3ae427a1-0f17-4524-acb1-a3f50090a8f3' logger = logging.getLogger(__name__) def get_status(card_number): payload = {'cardnum':card_number, 'cardtypeid': CARD_TYPE_ID} r = requests.get('http://strelkacard.ru/api/cards/status/', params=payload) logger.info("Get info for card %s: %d %s" % (card_number, r.status_code, r.text)) if r.status_code == requests.codes.ok: return r.json() raise ValueError("Can't get info about card with number %s" % card_number) def get_balance(card_number): r = get_status(card_number) return r['balance']/100.</span></span></code> </pre> <br>  <em>The code is suitable for both Python 2.x and Python 3.x.</em> <br><br>  Now, in order to obtain data on the balance, two lines are enough for us: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> checker &gt;&gt;&gt; checker.get_balance(<span class="hljs-string"><span class="hljs-string">'12345678901'</span></span>) <span class="hljs-number"><span class="hljs-number">1001.0</span></span></code> </pre> <br>  The presented code also uses the <a href="https://docs.python.org/2/library/logging.html"><code>logging</code></a> library.  With examples of its use in Russian can be found on <a href="https://habrahabr.ru/post/144566/">Habr√©</a> . <br><br>  Here I will only note that in order for the logging messages to be displayed on the screen, you need to do something like: <br><br><pre> <code class="python hljs">logging.basicConfig( format=<span class="hljs-string"><span class="hljs-string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span></span>, level=logging.INFO)</code> </pre> <br><h1>  Wrap there.  What's next? </h1><br>  Initially, the task was to conveniently receive information about the balance from a mobile device.  If you write a separate application, then it should have the functionality to add a map (input text field + button) and get information about the balance on the added maps (button + output text field).  The interface does not contain any special elements. <br><br>  The required functionality can be implemented using the Telegram API for bots. <br><br><h2>  Is it difficult to write a bot? </h2><br>  In general, no.  We now do not need to bot knew how to conduct small talk.  He is only expected to support a limited number of teams. <br><br>  Details and with pictures about Telegram bots can be found in the official blog: <a href="https://telegram.org/blog/bot-revolution">"Telegram Bot Platform"</a> .  What is important to us: the mobile application has the ability to suggest which teams are supported by the bot and send the necessary literally in a couple of clicks. <br><br><h2>  Create a bot </h2><br><h3>  Step 1. We get a token </h3><br>  A detailed description of bots and their capabilities is on the <a href="https://core.telegram.org/bots">"Bots: An introduction for developers"</a> page.  There is also information on how to create your bot.  To do this, you need to ask for help from the authority among bots: bot <a href="https://telegram.me/botfather"><code>@BotFather</code></a> . <br><br><img src="https://core.telegram.org/file/811140934/1/tbDSLHSaijc/fdcc7b6d5fb3354adf" alt="The bot feed"><br><br>  The main thing that you need to get as a result of communication with <code>@BotFather</code> - token to use the API. <br><br><h3>  Step 2. We are looking for a suitable wrapper library. </h3><br>  We have already started using Python.  And even we are able to send requests to the server.  You can implement your methods of interaction with the Telegram API.  But if we can do it, then surely someone made it before us.  Let's look for a suitable library for working with the Telegram bot API.  A search <a href="http://ddg.gg/%3Fq%3Dpython%2Btelegram%2Bbot">in your favorite search engine</a> for the keywords "python telegram bot" showed that there is a <a href="https://pypi.python.org/pypi/python-telegram-bot/"><code>python-telegram-bot</code></a> wrapper library.  Version of the library at the time of publication: 3.3. <br><br>  Using a wrapper is extremely simple: you need to create methods with the correct signature and register them via the <a href="http://python-telegram-bot.readthedocs.org/en/latest/telegram.dispatcher.html"><code>addTelegramCommandHandler</code></a> method <a href="http://python-telegram-bot.readthedocs.org/en/latest/telegram.dispatcher.html"><code>addTelegramCommandHandler</code></a> the correct object.  Examples of use are given in the <a href="https://pypi.python.org/pypi/python-telegram-bot/">library description</a> . <br><br><h3>  Step 3. Implement the logic of the bot </h3><br>  Our bot in its minimum working configuration must support the following commands: <br><br><ol><li>  add card by its number </li><li>  card removal by its number </li><li>  getting information about the balance on the cards </li></ol><br>  Next to the <code>checker.py</code> will create the <code>checker.py</code> file <code>strelka_bot.py</code> follows: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python from telegram import Updater, User import logging import checker TOKEN = 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx' # Enable Logging logging.basicConfig( format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO) logger = logging.getLogger(__name__) logger.setLevel(logging.DEBUG) # Dictionary to store users by its id users = {} class UserInfo: def __init__(self, telegram_user): self.user = telegram_user self.cards = {} def add_card(self, card_number): card = CardInfo(card_number) self.cards[card_number] = CardInfo(card_number) class CardInfo: def __init__(self, card_number): self.card_number = card_number def balance(self): logger.info("Getting balance for card %s" % self.card_number) json = checker.get_status(self.card_number) return json['balance']/100. def log_params(method_name, update): logger.debug("Method: %s\nFrom: %s\nchat_id: %d\nText: %s" % (method_name, update.message.from_user, update.message.chat_id, update.message.text)) def help(bot, update): log_params('help', update) bot.sendMessage(update.message.chat_id , text="""Supported commands: /help - Show help /addcard - Add a card to the list of registered cards /removecard - Remove a card to the list of registered cards /getcards - Returns balance for all registered cards""") def add_card(bot, update, args): log_params('add_card', update) if len(args) != 1: bot.sendMessage(update.message.chat_id, text="Usage:\n/addcard 1234567890") return card_number = args[0] telegram_user = update.message.from_user if not users.has_key(telegram_user.id): users[telegram_user.id] = UserInfo(telegram_user) user = users[telegram_user.id] if not user.cards.has_key(card_number): user.add_card(card_number) bot.sendMessage(update.message.chat_id, text="Card %s has been added successfully" % (card_number)) else: bot.sendMessage(update.message.chat_id, text="Card %s has been already added. Do nothing" % (card_number)) def remove_card(bot, update, args): log_params('remove_card', update) if len(args) != 1: bot.sendMessage(update.message.chat_id, text="Usage:\n/removecard 1234567890") return card_number = args[0] telegram_user = update.message.from_user if not users.has_key(telegram_user.id): bot.sendMessage(update.message.chat_id, text="There are no cards saved for you") return user = users[telegram_user.id] if user.cards.has_key(card_number): user.cards.pop(card_number) bot.sendMessage(update.message.chat_id, text="Card %s has been successfully removed" % (card_number)) else: bot.sendMessage(update.message.chat_id, text="Card %s has not been added. Do nothing" % (card_number)) def get_cards(bot, update): log_params('get_cards', update) telegram_user = update.message.from_user if not users.has_key(telegram_user.id) or len(users[telegram_user.id].cards) == 0: bot.sendMessage(update.message.chat_id , text="There are no saved cards for you. Please add a card by typing /addcard CARD_NUMBER") return user = users[telegram_user.id] cards = user.cards response = "" for card in cards.values(): if len(response) != 0: response += '\n' response += "Card %s balance: %.2f"%(card.card_number, card.balance()) bot.sendMessage(update.message.chat_id, text=response) def main(): updater = Updater(TOKEN) # Get the dispatcher to register handlers dp = updater.dispatcher # Add handlers for Telegram messages dp.addTelegramCommandHandler("help", help) dp.addTelegramCommandHandler("addcard", add_card) dp.addTelegramCommandHandler("removecard", remove_card) dp.addTelegramCommandHandler("getcards", get_cards) updater.start_polling() updater.idle() if __name__ == '__main__': main()</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">python 3 version</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python3 from telegram import Updater, User import logging import checker TOKEN = 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx' # Enable Logging logging.basicConfig( format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO) logger = logging.getLogger(__name__) logger.setLevel(logging.DEBUG) # Dictionary to store users by its id users = {} class UserInfo: def __init__(self, telegram_user): self.user = telegram_user self.cards = {} def add_card(self, card_number): card = CardInfo(card_number) self.cards[card_number] = CardInfo(card_number) class CardInfo: def __init__(self, card_number): self.card_number = card_number def balance(self): logger.info("Getting balance for card %s" % self.card_number) json = checker.get_status(self.card_number) return json['balance']/100. def log_params(method_name, update): logger.debug("Method: %s\nFrom: %s\nchat_id: %d\nText: %s" % (method_name, update.message.from_user, update.message.chat_id, update.message.text)) def help(bot, update): log_params('help', update) bot.sendMessage(update.message.chat_id , text="""Supported commands: /help - Show help /addcard - Add a card to the list of registered cards /removecard - Remove a card to the list of registered cards /getcards - Returns balance for all registered cards""") def add_card(bot, update, args): log_params('add_card', update) if len(args) != 1: bot.sendMessage(update.message.chat_id, text="Usage:\n/addcard 1234567890") return card_number = args[0] telegram_user = update.message.from_user if telegram_user.id not in users: users[telegram_user.id] = UserInfo(telegram_user) user = users[telegram_user.id] if card_number not in user.cards: user.add_card(card_number) bot.sendMessage(update.message.chat_id, text="Card %s has been added successfully" % (card_number)) else: bot.sendMessage(update.message.chat_id, text="Card %s has been already added. Do nothing" % (card_number)) def remove_card(bot, update, args): log_params('remove_card', update) if len(args) != 1: bot.sendMessage(update.message.chat_id, text="Usage:\n/removecard 1234567890") return card_number = args[0] telegram_user = update.message.from_user if telegram_user.id not in users: bot.sendMessage(update.message.chat_id, text="There are no cards saved for you") return user = users[telegram_user.id] if card_number in user.cards: user.cards.pop(card_number) bot.sendMessage(update.message.chat_id, text="Card %s has been successfully removed" % (card_number)) else: bot.sendMessage(update.message.chat_id, text="Card %s has not been added. Do nothing" % (card_number)) def get_cards(bot, update): log_params('get_cards', update) telegram_user = update.message.from_user if telegram_user.id not in users or len(users[telegram_user.id].cards) == 0: bot.sendMessage(update.message.chat_id , text="There are no saved cards for you. Please add a card by typing /addcard CARD_NUMBER") return user = users[telegram_user.id] cards = user.cards response = "" for card in list(cards.values()): if len(response) != 0: response += '\n' response += "Card balance for %s: %.2f"%(card.card_number, card.balance()) bot.sendMessage(update.message.chat_id, text=response) def main(): updater = Updater(TOKEN) # Get the dispatcher to register handlers dp = updater.dispatcher # Add handlers for Telegram messages dp.addTelegramCommandHandler("help", help) dp.addTelegramCommandHandler("addcard", add_card) dp.addTelegramCommandHandler("removecard", remove_card) dp.addTelegramCommandHandler("getcards", get_cards) updater.start_polling() updater.idle() if __name__ == '__main__': main()</span></span></code> </pre> <br></div></div><br>  The <code>TOKEN</code> variable <code>TOKEN</code> be placed in the token received from <code>@BotFather</code> . <br><br><h3>  Step 4. Run the bot </h3><br>  Running the resulting <code>strelka_bot.py</code> brings our bot to life. <br><br><pre> <code class="hljs python">$ python simple_strelka_bot.py <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-03</span></span><span class="hljs-number"><span class="hljs-number">-06</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">706</span></span> - telegram.dispatcher - INFO - Dispatcher started <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-03</span></span><span class="hljs-number"><span class="hljs-number">-06</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">706</span></span> - telegram.updater - INFO - Updater thread started <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-03</span></span><span class="hljs-number"><span class="hljs-number">-06</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">26</span></span>,<span class="hljs-number"><span class="hljs-number">123</span></span> - telegram.bot - INFO - Getting updates: [<span class="hljs-number"><span class="hljs-number">645839879</span></span>] <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-03</span></span><span class="hljs-number"><span class="hljs-number">-06</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">26</span></span>,<span class="hljs-number"><span class="hljs-number">173</span></span> - __main__ - DEBUG - Method: get_cards From: {<span class="hljs-string"><span class="hljs-string">'username'</span></span>: <span class="hljs-string"><span class="hljs-string">u'username'</span></span>, <span class="hljs-string"><span class="hljs-string">'first_name'</span></span>: <span class="hljs-string"><span class="hljs-string">u'Firstname'</span></span>, <span class="hljs-string"><span class="hljs-string">'last_name'</span></span>: <span class="hljs-string"><span class="hljs-string">u'Lastname'</span></span>, <span class="hljs-string"><span class="hljs-string">'id'</span></span>: <span class="hljs-number"><span class="hljs-number">12345678</span></span>} chat_id: <span class="hljs-number"><span class="hljs-number">12345678</span></span> Text: /getcards</code> </pre> <br>  Now he will respond to messages and write in the console information about which messages the bot comes in and what errors occur.  The bot can be terminated using the <code>Ctrl+C</code> combination, which sends an interrupt signal ( <code>SIGINT</code> ). <br><br>  After adding the cards of interest to us, information about their balances can be obtained with the help of a single <code>/getcards</code> . <br><br><img src="https://habrastorage.org/files/0fc/fff/492/0fcfff492a85437f8f70f649f621a375.png" alt="communication with the bot"><br><br>  You can also add saving <code>users</code> variable when changing, so as not to lose state when restarting the bot.  The <a href="https://docs.python.org/2/library/shelve.html"><code>shelve</code></a> module is great for this.  Examples of use are listed at the end of the documentation page.  Its use should not cause difficulties. <br><br><h2>  Exploring the capabilities of the <code>python-telegram-bot</code> library </h2><br>  Let's look at the <a href="https://github.com/python-telegram-bot/python-telegram-bot/"><code>python-telegram-bot</code></a> library description.  There is an interesting <a href="https://github.com/python-telegram-bot/python-telegram-bot/">JobQueue</a> functionality.  It allows you to perform pending and repeatable tasks. <br><br>  How can I use the ability to perform periodically running tasks?  The following possible improvements are seen: <br><br><ol><li>  Periodically (once a day) send the user a message with information about the current balance on the registered cards. </li><li>  Periodically (several times per hour) check the balance on the cards and report on its change. <br>  To do this, you need to add to <code>CardInfo</code> field that stores the current balance and its value until the last update.  And the method for the update itself: some <code>update()</code> . </li><li>  The previous version, but with the ability to set a threshold value that determines whether it is worth saying something to the user or not to disturb it. </li></ol><br>  Here you will need to add to the user a field that stores this threshold: <code>threshold</code> .  To set the value for this field, you will need a separate command for the bot. <br><br>  The implementation of option number 3 can be seen in <a href="https://github.com/spitty/strelka_telegram_bot">the bot repository on Github</a> . <br><br><h1>  Summary </h1><br>  Using the <a href="http://docs.python-requests.org/en/master/"><code>requests</code></a> library, the Telegram bot API and the <a href="https://github.com/python-telegram-bot/python-telegram-bot/"><code>python-telegram-bot</code></a> library managed to create a bot that notifies users in time that the balance on their cards has dropped to critically low values.  The task of replenishing the card has remained beyond the scope, but the functionality of the "personal account" on the official website allows it to be comfortably solved with a PC. <br><br>  On Github you can see a more complete bot implementation using the <a href="https://docs.python.org/2/library/shelve.html"><code>shelve</code></a> module and <a href="https://github.com/python-telegram-bot/python-telegram-bot/">JobQueue</a> functionality: <a href="https://github.com/spitty/strelka_telegram_bot">strelka_telegram_bot</a> . <br><br><h1>  UPD </h1><br>  The user <a href="https://habrahabr.ru/users/itspers/" class="user_link">itspers</a> in the <a href="https://habrahabr.ru/post/278847/">comments</a> suggested that returning the application "Arrow" to life can be an explicit indication of the required rights in the settings.  By the selection method it was established that the rights of 'Location' and 'Phone' are required. <br><br><h1>  UPD2 </h1><br>  Added code for Python 3 based on the <a href="https://habrahabr.ru/users/prefrontalcortex/" class="user_link">prefrontalCortex</a> <a href="https://habrahabr.ru/post/278847/">comment</a> . <br></div><p>Source: <a href="https://habr.com/ru/post/278847/">https://habr.com/ru/post/278847/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278837/index.html">Game Gomoku (tic-tac-toe, 5 in a row)</a></li>
<li><a href="../278839/index.html">Gigabit Wi-Fi in Russia</a></li>
<li><a href="../278841/index.html">Database Testing Developer Version</a></li>
<li><a href="../278843/index.html">Installing and configuring GitLab + Redmine collaboration on Debian 8 jessie + Nginx - Part 1</a></li>
<li><a href="../278845/index.html">Alljoyn: embedded view of the developer. Part 2: Linux to help us</a></li>
<li><a href="../278849/index.html">How Cloud@mail.ru saved all * my files and what came of it</a></li>
<li><a href="../278853/index.html">Obstacle Chase</a></li>
<li><a href="../278855/index.html">Do not miss the details about the new SQL Server 2016 and Linux support, see the online event on March 10 at 18:00 (MCK)</a></li>
<li><a href="../278857/index.html">Microsoft fixed another Stuxnet-like vulnerability in Windows</a></li>
<li><a href="../278859/index.html">Asterisk and information about incoming calls in the browser via Notifications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>