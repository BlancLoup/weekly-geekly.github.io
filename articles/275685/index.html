<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tips on how to write in C in 2016</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If language C was a weapon 

 From the author: The outline for this article appeared at the beginning of 2015, however, it never came to the publicati...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tips on how to write in C in 2016</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/da2/e08/e17/da2e08e172854d3ea0b0db284a03685a.png"><br>  <i>If language C was a weapon</i> <br><br>  <i>From the author: The outline for this article appeared at the beginning of 2015, however, it never came to the publication of materials.</i>  <i>Finally, having decided that in the drawer of my desk from the aforementioned ‚Äúdraft‚Äù there will be no benefit, I present it to your attention in its original form.</i>  <i>The only thing that has changed in the text is the year, from 2015 to 2016.</i> <i><br><br></i>  <i>And I am always happy to hear comments on the necessary corrections, clarifications or even your complaints.</i> <i>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </i>  <i>So, the article ...</i> <br><br>  The first rule of C programming - do not use it if you can do with other tools. <br><br>  When it is not possible to find an alternative method, it's time to recall the modern commandments of the programmer. <br><a name="habracut"></a><br>  The C programming language has been around since the early 1970s.  Experts had to ‚Äústudy C‚Äù at different stages of its evolution, and closer acquaintance often led to a dead end.  So different programmers had their own idea of ‚Äã‚Äãthe world C, due to the first experience of using algorithms of a given language. <br><br>  Faced with C programming, it is very important not to get stuck at the level of ‚Äútruths learned in the 80s / 90s‚Äù. <br><br>  If you are reading this article, most likely you are working on modern platforms, adhere to current standards and I do not need to refer to an infinite number of conventions for old software.  It makes no sense to perpetuate ancient standards only because individual companies have not bothered to update the system, which, at best, 20 years. <br><br><h4>  Introduction </h4><br>  Standard C99 (here C99 is ‚ÄúProgramming Standard for Since 1999‚Äù; C11 - ‚ÄúProgramming Standard for Since 2011‚Äù, which means 11&gt; 99). <br><br> <code>clang, default</code> <br> <ul><li>  By default, clang uses the advanced version of C11 ( <code> GNU C11</code> ), so no additional options are required for modern programs. </li><li>  If you need the <code>C11</code> standard, specify <code>-std=c11;</code>  if you prefer to work with the C99 standard, mark - <code>std=c99</code> . </li><li>  clang compiles source files faster than <code>gcc</code> . </li><li>  When choosing <code>gcc</code> , it is important to specify <code>-std=c99</code> or <code>-std=c11</code> </li><li>  <code>gcc</code> creates source files slower than <code>clang</code> , but sometimes generates faster code.  A comparative characteristic of performance and regression testing results is indicative. </li><li>  By default, <code>gcc-5</code> works in <code>GNU 11</code> mode (like <code>clang</code> ), but if you need C11 or C99, you will again have to specify <code>-std=c11</code> or <code>-std=c99</code> . </li></ul><br><br><h4>  Optimization </h4><br><h5>  -O2, -O3. </h5><br>  Usually, <code>-O2</code> fits you, but sometimes you need <code>-O3</code> Test both versions (including for different compilers), and then save the most efficient executable files. <br><h5>  - Os </h5><br>  <code>-Os</code> helps out when there are issues with cache performance (and this is no accident). <br><br><h4>  Warnings </h4><br> <code>-Wall -Wextra -pedantic</code> <br>  The latest versions of compilers offer the <code>-Wpedantic</code> option, although you can also refer to the ancient <code>-pedantic</code> if necessary, in particular, to enhance the possibilities of backward compatibility. <br><br>  During the testing phase, add <code>-Werror</code> and <code>-Wshadow</code> for all platforms. <br><br>  Appealing to <code>-Werror</code> can make the programming process somewhat difficult, since different platforms, compilers and libraries can issue some warnings.  I do not think that you want to neglect the development of the customer just because his version of <code>GCC</code> on a platform with which you have not come across before, attacks with new and new malicious notifications. <br><br>  Additional fun options include <code>Wstrict-overflow -fno-strict-aliasing</code> . <br><br>  Either you enable <code>-fno-strict-aliasing</code> , or you can work with objects exclusively in the form in which they were created.  Since C programming involves the use of different pseudonyms, it is better to choose <code>-fno-strict-aliasing</code> , unless it is a question of the need to control the entire source tree. <br><br>  To prevent <code>Clang</code> from sending warnings that you use, yes, yes, the appropriate syntax, just add <code>-Wno-missing-field-initializers</code> . <br><br>  in <code>GCC 4.7.0</code> and later, this strange warning has been eliminated. <br><br><h4>  Development </h4><br><h5>  Compilation units </h5><br>  For the development of projects in C, most often they simply select it in each source file - an object file, and then assemble the resulting objects into one.  This scheme is perfect for phased development, but it can hardly be called optimal when it comes to performance and optimization.  With this approach, your compiler does not recognize the need for optimization by analyzing many object files. <br><br><h5>  LTO - Link Time Optimization </h5><br>  <code>LTO</code> performs ‚Äúanalysis and optimization of the source as part of problems with compilation units‚Äù, creating annotations for object files in the form of intermediate notes, which makes it possible to make appropriate adjustments to the source data in the process of merging objects. <br><br>  <code>LTO</code> can significantly slow down the merge process.  Rescues <code>make -j</code> , but only if the development consists of independent, not related to each other end-users (.a, .so, .dylib, executable test files, executable applications, etc.). <br><br>  <a href="http://llvm.org/docs/LinkTimeOptimization.html">clang lto</a> . <br>  <a href="https://gcc.gnu.org/onlinedocs/gccint/LTO-Overview.html">GCC LTO</a> . <br><br>  By 2016, <code>clang  gcc</code> took care of creating an auxiliary <code>LTO</code> , which you can take advantage of by adding <code>-flto</code> to the list of commands when compiling objects and final merging of library / program elements.  However, <code>LTO</code> still needs an eye and an eye.  Sometimes, if the program uses code that is not run directly, but through additional libraries, <code>LTO</code> can eliminate the corresponding functions or code, because during the general analysis, the utility detects that they are not used, which means that they are not needed in the final version of the product. <br><br> <code>Arch <br> -march=native</code> <br>  Let the compiler use all the functions of your processor and remember: performance testing and regression testing are important (followed by a comparative analysis of the results for different compilers and / or their versions), because with their help you can make sure that optimization elements do not have negative side effects. <br><br>  <code>-msse2  -msse4.2</code> may be needed if you are working with options prepared by other developers. <br><br><h4>  Code creation </h4><br><h5>  Types </h5><br>  If you find something like <code>char, int, short, long  unsigned</code> in the new code, here are some bugs. <br>  In modern programs it is necessary to specify <code>#include &lt;stdint.h&gt;</code> and only then choose standard data types. <br>  Detailed descriptions you will find here: <a href="http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/stdint.h.html">stdint.h specification.</a> <br>  Among the most common standard data types are the following: <br><br><ul><li>  <code>int8_t, int16_t, int32_t, int64_t</code> are signed integers; </li><li>  <code>uint8_t, uint16_t, uint32_t, uint64_t</code> are unsigned integers; </li><li>  <code>float</code> - 32-bit floating point standard; </li><li>  <code>double</code> - 64-bit floating point standard. </li></ul><br>  Please note: no more <code>char</code> .  Usually, in the C programming language, the <code>char</code> command is not only named, but also used incorrectly. <br><br>  Software developers continually use the <code>char</code> command to refer to "byte", even when unsigned byte operations are performed.  Much more correctly for individual unsigned byte / octet values ‚Äã‚Äãspecify <code>uint8_t</code> , and for a sequence of unsigned byte / <a href="https://ru.wikipedia.org/wiki/%25D0%259E%25D0%25BA%25D1%2582%25D0%25B5%25D1%2582_(%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2582%25D0%25B8%25D0%25BA%25D0%25B0)">octet</a> values ‚Äã‚Äãselect <code>uint8_t</code> *. <br><br><h5>  Should I invoke int </h5><br>  Some of our readers admit that they just love <code>int</code> , which their cold frozen fingers will tell you.  It is worth noting that it is technically impossible to program correctly if the sizes of data types change as they like. <br><br>  Also read the <i><a href="http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/inttypes.h.html">rationale</a></i> voiced during the discussion of <a href="http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/inttypes.h.html">inttypes.h</a> : it <a href="http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/inttypes.h.html">makes it</a> clear here why it is unsafe to use types of non-fixed width.  If you have already noticed that in the development process on individual platforms <code>int</code> 16-bit, on others - 32-bit, and also tested the problem areas on 16 and 32 bits for each use case of <code>int</code> , you can continue in the same vein. <br><br>  The rest, who have not yet mastered the wisdom of retaining in their head entire complexes of technical conditions for platforms with a multilevel structure when performing a regular puzzle, I advise you to focus on fixed width types, which will automatically allow you to write more correct code with significantly fewer conceptual errors, for which testing additional efforts will be required.  Or, as the description briefly states: ‚ÄúThe ISO C rule for promoting standard integer data may lead to completely unexpected changes.‚Äù <br><br>  No luck here is not enough. <br><br><h5>  Exception to the rule ‚Äúnever use <code>char</code> ‚Äù </h5><br>  The only case where the <code>char</code> command can be accessed in 2016 is if the selected API requests a <code>char</code> (for example, <code>strncat, printf'ing "%s", ...</code> ) or if you specify strings for reading only (for example, <code>const char *hello = "hello";</code> ), because in the C programming language, string literals ("hello") look like <code>char</code> []. <br>  EXCEPT TOGO: C11 provides support for native unicode, and for UTF-8 string literals <code>char</code> is still used, even if you have to work with multibyte sequences like <code>const char *abcgrr = u8"abc";</code>  . <br><br><h5>  Exception to the rule ‚Äúnever use <code>{int,long,etc}</code> ‚Äù </h5><br>  If you access functions with result types or native parameters, use the types according to the function class or API characteristics. <br><br><h5>  Signedness </h5><br>  Do not try to use <code>unsigned</code> in your code.  Now you know how to write a decent code without the unreasonable conventions of C with numerous data types that not only make the content unreadable, but also call into question the effectiveness of using the finished product.  Who would like to introduce <code>unsigned long long int</code> if you can restrict <code>uint64_t</code> to a simple <code>uint64_t</code> ?  Files of the type &lt;stdint.h&gt; are much more specific and precise in meaning, they better convey the intentions of the author, are compact - which is important for operation and readability. <br><br><h5>  Integer pointers </h5><br>  Perhaps one of you will argue: "But what about without pointers for a <code>long</code> , without them all the mathematics will be covered!" <br><br>  Of course, you can say this, but who says that the statement is true? <br><br>  The correct type for pointers in this case is <code>uintptr_t</code> , it is specified by the files <code>&lt;stdint.h&gt;</code> .  At the same time, it is important to note that the very useful <code>ptrdiff_t</code> is defined by <code>stddef.h</code> . <br><br>  Instead: <br> <code>long diff = (long)ptrOld - (long)ptrNew;</code> <br> <br>  Use: <br> <code>ptrdiff_t diff = (uintptr_t)ptrOld - (uintptr_t)ptrNew;</code> <br> <br>  And: <br> <code>printf("%p is unaligned by %" PRIuPTR " bytes.\n", (void *)p, ((uintptr_t)somePtr &amp; (sizeof(void *) - 1)));</code> <br> <br><h4>  System-dependent data types </h4><br>  You are still arguing that ‚Äúon a 32-bit platform I need 32-bit <code>long</code> , and on the 64th platform, 64-bit!‚Äù. <br><br>  If you omit the reasoning during which you obviously find it difficult to explain the reason for using two different sizes in the code depending on the platform, I think that in the end you still don‚Äôt want to dwell on <code>long</code> oriented system-dependent data types. <br><br>  In such situations, it is reasonable to refer to <code>intptr_t</code> , an integer data type responsible for storing the pointer value for your platform. <br><br>  On modern 32-bit platforms, <code>intptr_t</code> transformed to <code>int32_t</code> . <br><br>  On modern 64-bit platforms, <code>intptr_t</code> takes the form <code>int64_t</code> . <br><br>  Also <code>intptr_t</code> is found in the <code>uintptr_t</code> variant. <br><br>  To store information about the pointer offset, use <code>ptrdiff_t</code> ‚Äî it is this data type that allows you to memorize the parameters of the subtracted pointers. <br><br><h4>  Maximum Value </h4><br>  Are you looking for an integer data type capable of processing any integer values ‚Äã‚Äãin your system? <br><br>  As a rule, programmers prefer the most well-known alternatives, in particular, the unsightly <code>uint64_t</code> , and in fact there is a more efficient technical solution, thanks to which any variable can be used to store all sorts of values.  Safe storage of integer data is guaranteed by <code>intmax_t</code> (or <code>uintmax_t</code> ).  You can entrust any <code>intmax_t</code> value <code>intmax_t</code> , being sure that the accuracy of the data will not be affected by this.  Similarly with unsigned integers delegated by <code>uintmax_t</code> . <br><br><h4>  Other data type </h4><br>  If we are talking about common system-dependent data types, <code>size_t</code> , guaranteed <code>stddef.h</code> takes first place in the list of favorites. <br><br>  In essence, <code>size_t</code> is something like ‚Äúan integer value capable of storing huge array indices‚Äù, which means it can capture impressive indicators of bias in the program being created. <br><br>  In practice, <code>size_t</code> acts as a result type for the sizeof operator. <br><br>  In any case, on modern platforms, <code>size_t</code> has practically the same characteristics as <code>uintptr_t</code> , and therefore, on 32-bit versions, <code>size_t</code> transformed into <code>uint32_t</code> , and on 64-bit <code>uint64_t</code> - into <code>uint64_t</code> . <br><br>  There is also <code>ssize_t</code> , which is a signed <code>size_t</code> , used as a result type for library functions ‚Äî in the event of an error, we get 1. (Note: <code>ssize_t</code> belongs to the POSIX package and is not suitable for Windows). <br><br>  So is it worth using <code>size_t</code> for arbitrary system-specific sizes, setting the parameters of your own functions?  Technically, <code>size_t</code> is the result type of <code>sizeof</code> , so any functions that determine the size of a value in the form of a specific number of bytes can take the form <code>size_t</code> . <br><br>  Other uses are: <code>size_t</code> is the argument type for malloc, and <code>ssize_t</code> is the result type for <code>read()</code> and <code>write()</code> (except for Windows interfaces, in which <code>ssize_t</code> not provided and only int is used for result values). <br><br><h4>  Types of data output to print (Printing Types) </h4><br><br>  Do not refer to data types during printing.  Always use the appropriate type pointers as advised on <a href="http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/inttypes.h.html">inttypes.h</a> . <br><br>  This list includes (of course, this is only a brief excerpt): <br><ul><li>  size_t -% zu </li><li>  ssize_t -% zd </li><li>  ptrdiff_t -% td </li><li>  the initial pointer value is% p (in modern compilers it is displayed in hexadecimal; initially sends a pointer to void *) </li><li>  int64_t - "%" PRId64 </li><li>  uint64_t - "%" PRIu64 </li></ul><br><br>  64-bit data types are printed using only the PRI [udixXo] 64 style macro. <br>  Why? <br><br>  On some platforms, 64-bit values ‚Äã‚Äãare represented by the <code>long</code> function, on others - <code>long long</code> . These macros provide optimal basic format characteristics for various platforms. <br><br>  Without these format macros, it is practically impossible to create a formatting string suitable simultaneously for all platforms, since data types change, regardless of your actions (and remember, setting the above values ‚Äã‚Äãbefore printing starts is not safe, but illogical). <br><br>  <code>intptr_t</code> - "%" PRIdPTR <br>  <code>uintptr_t</code> - "%" PRIuPTR <br>  <code>intmax_t</code> - "%" PRIdMAX <br>  <code>uintmax_t</code> -% PRIUMAX <br><br>  One addition to the PRI * format specifiers: these are macros, and, depending on the specific platform, they expand to the appropriate printf class specifiers.  And, therefore, you can not specify: <br><br> <code>printf("Local number: %PRIdPTR\n\n", someIntPtr);</code> <br> <br>  Instead, knowing that we are dealing with macros, we write: <br><br> <code>printf("Local number: %" PRIdPTR "\n\n", someIntPtr);</code> <br> <br>  Note:% falls into the body of a formatting string literal, while the type pointer remains outside of it, since all adjacent lines are combined by the preprocessor in one final combined string literal. <br><br>  C99 allows you to use variable descriptions anywhere. <br><br>  We do NOT do this: <br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> test(uint8_t input) { uint32_t b; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (input &gt; <span class="hljs-number"><span class="hljs-number">3</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } b = input; }</code> </pre><br><br>  Instead, we write as follows: <br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> test(uint8_t input) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (input &gt; <span class="hljs-number"><span class="hljs-number">3</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } uint32_t b = input; }</code> </pre><br><br>  Warning: if program cycles are limited, check the position of the initializers.  Sometimes unsystematic descriptions lead to an unexpected decrease in the speed of work.  For normal, not accelerated, code (which, in fact, is used in most cases) it is best to focus on clarity.  So, by defining data types immediately after completing work on initializers, you will noticeably increase readability. <br><br>  In C99, you can use for loops to create embedded descriptions of the counters. <br><br>  Never write: <br><pre> <code class="objectivec hljs">uint32_t i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++)</code> </pre><br><br>  It will be right: <br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint32_t i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++)</code> </pre><br><br>  One exception: if you want to save the value of your counter after exiting the cycle, of course, you should not insert the corresponding description into the body of the cycle. <br><br>  Modern compilers support #pragma once. <br><br>  WRONG option: <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#ifndef PROJECT_HEADERNAME #define PROJECT_HEADERNAME . . . #endif /* PROJECT_HEADERNAME */</span></span></code> </pre><br><br>  Instead, use <br> <code>#pragma once</code> <br> <br>  <code>#pragma once</code> notifies the compiler to request a header only once, therefore, you no longer have to write additional lines to protect it.  This function is supported by all compilers, and on different platforms, and is much more efficient mechanism than manually entering the header code. <br>  A detailed description of the option can be found in the list of compilers that support pragma once. <br><br>  The C programming language allows for static initialization of automatically created arrays. <br><br>  So, we do not write: <br><pre> <code class="objectivec hljs"> uint32_t numbers[<span class="hljs-number"><span class="hljs-number">64</span></span>]; memset(numbers, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(numbers));</code> </pre><br><br>  It will be right: <br><pre> <code class="objectivec hljs"> uint32_t numbers[<span class="hljs-number"><span class="hljs-number">64</span></span>] = {<span class="hljs-number"><span class="hljs-number">0</span></span>};</code> </pre><br><br>  Working on C, you can perform static initialization of automatically generated structures. <br><br>  Classic error: <br><pre> <code class="objectivec hljs"> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> thing { uint64_t index; uint32_t counter; }; <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> thing localThing; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> initThing(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { memset(&amp;localThing, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(localThing)); }</code> </pre><br><br>  Correctly: <br><pre> <code class="objectivec hljs"> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> thing { uint64_t index; uint32_t counter; }; <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> thing localThing = {<span class="hljs-number"><span class="hljs-number">0</span></span>};</code> </pre><br><br>  IMPORTANT: If internal alignment is provided in your structure, the {0} method will not clear the extra bytes destined for this purpose.  So, for example, it happens if a struct thing has 4 bytes of padding after counter (on a 64-bit platform), because structures are filled in increments equal to one word.  If you need to zero the entire structure including unused bytes of indents, specify <code>memset(&amp;localThing, 0, sizeof(localThing))</code> , since sizeof (localThing) == 16 bytes, even though only 8 + 4 = 12 bytes are available. <br><br>  If you need to reinitialize previously selected structures, use a common null structure to determine the values: <br><pre> <code class="objectivec hljs"> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> thing { uint64_t index; uint32_t counter; }; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> thing localThingNull = {<span class="hljs-number"><span class="hljs-number">0</span></span>}; . . . <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> thing localThing = {.counter = <span class="hljs-number"><span class="hljs-number">3</span></span>}; . . . localThing = localThingNull;</code> </pre><br><br>  If you're lucky enough to work on C99 (or later versions), you can choose composite literals instead of messing around with the basic ‚Äúzero structure‚Äù (see <a href="http://www.drdobbs.com/the-new-c-compound-literals/184401404">The New C: Compound Literals 2001</a> ). <br><br>  Compound literals allow the compiler to automatically create temporary anonymous structures, and then copy them into the appropriate value field: <br> <code>localThing = (struct thing){0};</code> <br> <br>  In C99, arrays of variable length appeared (in C11, they can be chosen at will). <br><br>  Therefore, do NOT write like this (if you are dealing with a miniature array or just conduct rapid testing): <br><pre> <code class="objectivec hljs">uintmax_t arrayLength = strtoumax(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *array[]; array = malloc(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(*array) * arrayLength); / *    ()     * /</code> </pre><br><br>  Instead, we specify: <br><pre> <code class="objectivec hljs"> uintmax_t arrayLength = strtoumax(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *array[arrayLength]; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span></code> </pre><br><br>  IMPORTANT: variable-length arrays (as a rule) are created on the stack, just like regular arrays.  If you cannot create a regular array of 3 million elements statically, do not try to generate a dynamic array of the same size using this syntax.  These are not scalable Python / Ruby automatic lists.  If you specify the length of the array during program startup and it is too large for your stack, a mess will start (malfunctions, security problems).  Variable length arrays are ideal for individual situations designed to perform specific tasks, but should not be used to develop all types of software.  If once you need to generate an array of 3 elements, and the other - 3 million, it is hardly worth resorting to using variable-length arrays. <br><br>  Yes, it's a good idea to understand the syntax of the VLA, knowing that it may be useful to you (or if you need to carry out a one-time express test of a product).  At the same time, such undertakings often turn into tragedies when entire programs crash, one has only to forget the exact parameters for checking the size of an element or to lose sight of the fact that you are faced with an unfamiliar target platform on which no additional stack space is provided. <br><br> :    ,     <code>arrayLength</code> ‚Äì   (    ;       4    ).       (  ), , ,      ,     99 VLA,           <code>malloc</code> . <br><br>  :       ,  ,       ,   VLA. -    VLA , ,     ,      , ,  . <br><br> C99       . <br><br><h4>   </h4><br>          ,     . <br><br>  : <br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> processAddBytesOverflow(uint8_t *bytes, uint32_t len) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint32_t i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { bytes[<span class="hljs-number"><span class="hljs-number">0</span></span>] += bytes[i]; } }</code> </pre><br>   : <br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> processAddBytesOverflow(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *input, uint32_t len) { uint8_t *bytes = input; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint32_t i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { bytes[<span class="hljs-number"><span class="hljs-number">0</span></span>] += bytes[i]; } }</code> </pre><br><br>        ,      .     ¬´     ¬ª,         <code>uint8_t</code> . , ,        ,  <code>char *</code> ,  -  .    ,  <code>void *</code> ,           ,      ,   ,        ,     . <br><br>         , ,         ,     .         , ,   .  -        Unaligned Memory Access (:               ,     , ,        ). <br><br><h4>    </h4><br> C99      <code>&lt;stdbool.h&gt;</code> ,  true  1,  false ‚Äî 0. <br>    /      true or false,     <code>int32_t</code> ,    1  0 (,   , 1  -1;   : 0 ‚Äì success,  1 ‚Äî failure?  0 ‚Äì success,  -1 ‚Äî failure?). <br><br>           ,  ,    ,  API     ,     ,  .  ,        ,    ,   ¬´  ,      ¬ª. <br><br>    : <br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *growthOptional(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *grow, size_t currentLen, size_t newLen) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newLen &gt; currentLen) { <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *newGrow = realloc(grow, newLen); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newGrow) { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> grow = newGrow; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*    ,     ,      */</span></span> free(grow); grow = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> grow; }</code> </pre><br><br><br>  : <br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">/*  : * - 'true'  newLen &gt; currentLen     * -    'true'     ,      '*_grow' * - 'false'  newLen &lt;= currentLen */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> growthOptional(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> **_grow, size_t currentLen, size_t newLen) { <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *grow = *_grow; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newLen &gt; currentLen) { <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *newGrow = realloc(grow, newLen); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newGrow) { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> *_grow = newGrow; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> free(grow); *_grow = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   , * 'true'     ,       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre><br><br> ,   ,  : <br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> growthResult { GROWTH_RESULT_SUCCESS = <span class="hljs-number"><span class="hljs-number">1</span></span>, GROWTH_RESULT_FAILURE_GROW_NOT_NECESSARY, GROWTH_RESULT_FAILURE_ALLOCATION_FAILED } growthResult; growthResult growthOptional(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> **_grow, size_t currentLen, size_t newLen) { <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *grow = *_grow; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newLen &gt; currentLen) { <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *newGrow = realloc(grow, newLen); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newGrow) { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> *_grow = newGrow; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GROWTH_RESULT_SUCCESS; } <span class="hljs-comment"><span class="hljs-comment">/*    ,   ,          */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GROWTH_RESULT_FAILURE_ALLOCATION_FAILED; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GROWTH_RESULT_FAILURE_GROW_NOT_NECESSARY; }</code> </pre><br><br><h4>  </h4><br>      ,   . <br><br>         50     ,   -    .     ,      . <br><br>  ‚Äì     . <br><br>  ,   2016    ,    , ‚Äî clang-format.   clang-format        C-.  ,        . <br><br>       clang-format: <br> <code>#!/usr/bin/env bash</code> <br> <br> <code>clang-format -style="{BasedOnStyle: llvm, IndentWidth: 4, AllowShortFunctionsOnASingleLine: None, KeepEmptyLinesAtTheStartOfBlocks: false}" "$@"</code> <br> <br>    (     <code>cleanup-format</code> ): <br> <code>matt@foo:~/repos/badcode% cleanup-format -i *.{c,h,cc,cpp,hpp,cxx}</code> <br> <br>  -i          ,        . <br><br>     ,        : <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#!/usr/bin/env bash #  : clang-tidy      ,       #    . find . \( -name \*.c -or -name \*.cpp -or -name \*.cc \) |xargs -n1 -P4 cleanup-tidy # clang-format     ,      12 #  ()    . find . \( -name \*.c -or -name \*.cpp -or -name \*.cc -or -name \*.h \) |xargs -n12 -P4 cleanup-format -i</span></span></code> </pre><br><br>  ,        cleanup-tidy.  , , : <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#!/usr/bin/env bash clang-tidy \ -fix \ -fix-errors \ -header-filter=.* \ --checks=readability-braces-around-statements,misc-macro-parentheses \ $1 \ -- -I.</span></span></code> </pre><br><br> <code>clang-tidy</code> ‚Äî   .      : <br><br> <code>readability-braces-around-statements</code> ‚Äì    if/while/for    ; <br><br>  ,           ¬´ ¬ª      .             .    , , ¬´     !¬ª,  ‚Äì       ,      - .       ,   ,      ,      ,    ,      . <br><br> <code>misc-macro-parentheses</code> ‚Äì      ,    . <br><br> <code>clang-tidy</code> ‚Äì  , , ,  ,          .  , <code>clang-tidy</code> ‚Äî   ,      <code>clang-format</code>  ,      . <br><br><h4>  </h4><br>  , , ‚Ä¶ <br><br><h4>  Comments </h4><br>       . <br><br><h4>   </h4><br>     1000  (1500    ).       (     ..),    . <br><br><h4>    </h4><br><h5>    malloc </h5><br>   <code>calloc</code> .           .      <code>calloc(object count, size per object)</code> ,     <code>#define mycalloc(N) calloc(1, N)</code> . <br><br>        : <br><br><ul><li> alloc   ,        ; </li><li> calloc    ,     (  ,  ,   30- ,  ..); </li><li>    calloc(element count, size of each element)   ; </li><li>    malloc()   ,         ,     ; </li><li>  calloc    valgrind,        /    ,   calloc   0; </li><li>   ‚Äì  .       ,          , ,     ; </li><li>     calloc ()   ,  ,    malloc(), calloc(), ‚Äî         ,           ,     .       , calloc()        .         ,       calloc(element count, size of each element). </li></ul><br><br>    ,         , ,         . <br><br>   ,    <code>calloc()</code>    ,    : <br><br> <a href="https://blogs.fau.de/hager/archives/825">Benchmarking fun with calloc() and zero pages (2007)</a> <br> <a href="https://en.wikipedia.org/wiki/Copy-on-write">Copy-on-write in virtual memory management</a> <br><br>  2016   -      <code>calloc()</code>     ( ,  64  ,  ,   ,       ).    ¬´ ¬ª  ,     ¬´ ¬ª,     . <br><br> :     <code>calloc()</code>  ‚Äì  ,    .   <code>calloc()</code>   <code>realloc()</code> ,        .             .         <code>realloc()</code> ,    <code>memset()</code> . <br><br><h5>    <code>memset</code> (    ) </h5><br>     <code>memset</code> (ptr, 0, len,       ()    (   ,           ). <br>     <code>memset()</code> ‚Äî   ,    ,     (  {0}         ,   ). <br><br><h4>  Conclusion </h4><br>       , , .       ,     ,    ,       , ,       RAM       ¬´¬ª. <br><br> ,     ‚Äî   ,  ,        -   . </div><p>Source: <a href="https://habr.com/ru/post/275685/">https://habr.com/ru/post/275685/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275671/index.html">High-performance long polling chat</a></li>
<li><a href="../275673/index.html">Compilation: Over 800 resources for front-end developers</a></li>
<li><a href="../275675/index.html">QA: Conference invites speakers</a></li>
<li><a href="../275677/index.html">ABAP: Beautiful</a></li>
<li><a href="../275679/index.html">Can I make a game without an artist in 2 days? Devstory of my game Neobug Rush 2 Players</a></li>
<li><a href="../275687/index.html">FT Clustering - everRun by Stratus Technologies</a></li>
<li><a href="../275691/index.html">How to block my app on Google Play</a></li>
<li><a href="../275693/index.html">Security Week 03 or patch week: Linux, OpenSSH, Cisco, Yahoo Mail, Apple</a></li>
<li><a href="../275695/index.html">Skype began to hide the default IP addresses</a></li>
<li><a href="../275699/index.html">Digest of the game industry: December</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>