<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>In-app purchasing or internal payments in Android applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What is it all about? 

 With the version of the application Android Market 2.3.0 for developers of applications for the Android platform, it has been...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>In-app purchasing or internal payments in Android applications</h1><div class="post__text post__text-html js-mediator-article"><h4>  What is it all about? </h4><br><br>  With the version of the application Android Market 2.3.0 for developers of applications for the Android platform, it has been possible to provide users with payments within the applications themselves.  Now you can sell levels and artifacts, videos, music, plug-ins, etc., using only the built-in tools of the platform.  Let's see how this can be done. <br><br><h4>  What do we need? </h4>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As usual, the favorite IDE, Android SDK and <a href="http://developer.android.com/guide/market/billing/billing_integrate.html">sample application</a> . <br>  It will also be useful to imagine what a Service, BroadcastReceiver and, of course, Activity are. <br><br>  We also need permission in the manifest file - <br><br>  <code>&lt;uses-permission android:name="com.android.vending.BILLING"/&gt;</code> , nothing will work without it. <br><br><h4>  How does this work in principle? </h4><br><br><a name="habracut"></a><br>  Everything works through the service in the Android Market application.  He is able to send requests for details of a certain thing that the user wants to buy, to purchase, to receive answers about the success or failure of the purchase, and so on.  All information about the things you sell should be entered through the <a href="https://market.android.com/publish/Home">Developer Console</a> for a specific application.  As soon as we received a signal of a successful purchase, we can start downloading content from our server. <br><br><h4>  How does all this work? </h4><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c82/52f/400/c8252f4003940da3c46474c0ff1671ab.png" alt="image"><br><br>  On the server in the market information is stored about things that you can buy.  The client application of the market interacts with the server.  Our application interacts with it. <br><br>  Our application will consist of at least: <br><ol><li>  BillingService.  This is a service that is associated with the application of the market, and sends him all the information about the operations and receives answers to them, in case they are synchronous. </li><li>  BillingReceiver.  Receives asynchronous responses from the market app. </li><li>  PurchaseObserver.  An entity that will notify the UI of changes in the status of purchases. </li></ol><br><br><h4>  What messages do we send to the market? </h4><br><br>  First, we need to connect our BillingService with the market application in order to call the MarketBillingService's sendBillingRequest method.  The service interface is described in the IMarketBillingService.aidl file, you can download it <img src="http://developer.android.com/guide/market/billing/billing_integrate.html#billing-download" alt="image">  From here, you need to put it in the com.android.vending.billing package of your application.  The IDE should immediately generate the IMarketBillingService.java file we need to call the above method. <br><br>  The method itself takes a parameter Bundle, in which all information is stored.  The most important is the parameter with the key "BILLING_REQUEST".  It defines the type of request.  They are: <br><br>  ‚Ä¢ <code>CHECK_BILLING_SUPPORTED</code> ‚Äî check availability of in-app billing. <br>  ‚Ä¢ <code>REQUEST_PURCHASE</code> ‚Äî Purchase request. <br>  ‚Ä¢ <code>GET_PURCHASE_INFORMATION</code> - getting information about changes in the purchase status. <br>  ‚Ä¢ <code>CONFIRM_NOTIFICATIONS</code> ‚Äî Confirmation that a notification has been received from the market application. <br>  ‚Ä¢ <code>RESTORE_TRANSACTIONS</code> - recovery of transactions for items already purchased. <br><br><h4>  What are the answers? </h4><br><br>  The method synchronously returns a response, which is also a Bundle.  It contains: <br><br>  ‚Ä¢ <code>RESPONSE_CODE</code> - response code <br>  ‚Ä¢ <code>PURCHASE_INTENT</code> - <code>PendingIntent</code> , in order to start activating a purchase. <br>  ‚Ä¢ <code>REQUEST_ID</code> ‚Äî The ID of the request sent. <br><br>  In the case of asynchronous responses (received through the BillingReceiver), they contain the following: <br><br>  ‚Ä¢ <code>com.android.vending.billing.RESPONSE_CODE</code> <br>  Answer code.  The market confirms the success or failure of sending the request. <br><br>  ‚Ä¢ <code>com.android.vending.billing.IN_APP_NOTIFY</code> <br>  Alert that purchase status has changed.  After this message you need to send a request with the type <code>GET_PURCHASE_INFORMATION</code> to get the info. <br><br>  ‚Ä¢ <code>com.android.vending.billing.PURCHASE_STATE_CHANGED</code> <br>  And here comes the detailed information about the purchase.  It includes a nonce, a list of orders, with product identifiers, their states, and so on. <br><br>  The sequence in the purchase will be as follows: <br><br>  1. We send <code>REQUEST_PURCHASE</code> <br>  2. We get a synchronous answer <br>  3. Launch the Shopping Activity (also built into the Market app) <br>  4. We receive asynchronous message <code>IN_APP_NOTIFY</code> <br>  5. <code>GET_PURCHASE_INFORMATION</code> <br>  6. We get a synchronous answer <br>  7. We receive the asynchronous answer <code>PURCHASE_STATE_CHANGED</code> <br>  8. Ship <code>CONFIRM_NOTIFICATIONS</code> <br>  9. We get a synchronous answer <br><br><h4>  Or maybe look better at the code? </h4><br><br>  So, the main points in the code: <br><br><h5>  1. Connect to the market. </h5><br><br>  In onCreate () in BillingService we write: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">try</font> { <br> boolean bindResult = getApplicationContext().bindService( <br> <font color="#0000ff">new</font> Intent( <font color="#A31515">"com.android.vending.billing.MarketBillingService.BIND"</font> ), <br> <font color="#0000ff">this</font> , <br> Context.BIND_AUTO_CREATE); <br> <font color="#0000ff">if</font> (bindResult) { <br> Log.i(TAG, <font color="#A31515">"Service bind successful."</font> ); <br> } <font color="#0000ff">else</font> { <br> Log.e(TAG, <font color="#A31515">"Could not bind to the MarketBillingService."</font> ); <br> } <br> } <font color="#0000ff">catch</font> (SecurityException e) { <br> Log.e(TAG, <font color="#A31515">"Security exception: "</font> + e); <br> } <br> <br> <font color="#008000">//  :</font> <br> @Override <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onServiceConnected(ComponentName componentName, IBinder iBinder) { <br> Log.i(TAG, <font color="#A31515">"MarketBillingService connected."</font> ); <br> marketService = IMarketBillingService.Stub.asInterface(iBinder); <br> runPendingRequests(); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><h5>  2. Sending requests. </h5><br><br>  In the sample application, a class hierarchy has been created for queries, and this is correct.  The most important thing about them is deferred shipping.  The fact is that bindService happens asynchronously, which means we get the link to MarketBillingService much later than onCreate () ends, and even later than trying to execute queries for the first time.  Therefore, we do this: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">/**</font> <br> <font color="#008000">* Run the request, starting the connection if necessary.</font> <br> <font color="#008000">*</font> <br> <font color="#008000">* @return this request if the request was not executed in order to queue it.</font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> final AbstractRequest runRequest() { <br> <font color="#0000ff">if</font> (runIfConnected()) { <br> <font color="#0000ff">return</font> <font color="#0000ff">null</font> ; <br> } <br> <font color="#0000ff">return</font> <font color="#0000ff">this</font> ; <br> } <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">* Try running the request directly if the service is already connected.</font> <br> <font color="#008000">*</font> <br> <font color="#008000">* @return true if the request ran successfully; false if the service</font> <br> <font color="#008000">*     is not connected or there was an error when trying to use it</font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> boolean runIfConnected() { <br> <font color="#0000ff">if</font> (service.isConnected()) { <br> <font color="#0000ff">try</font> { <br> requestId = run(); <br> <font color="#0000ff">if</font> (requestId &gt;= 0) { <br> service.addRequest(requestId, <font color="#0000ff">this</font> ); <br> } <br> <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; <br> } <font color="#0000ff">catch</font> (MyException e) { <br> onException(e); <br> } <br> } <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Returning the request is necessary to remember it in the list of pending requests in the service.  Then, when we get a link to MarketBillingService in onServiceConnected (), we will try to send all requests again. <br><br><h5>  3. UI Alert </h5><br><br>  In BillingService we will store a link to a certain entity that stores a Handler from our UI.  Then upon receiving the answers you can do the following: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">private</font> <font color="#0000ff">void</font> notifyGui( <font color="#0000ff">int</font> messageId, PurchasedItem item) { <br> <font color="#0000ff">if</font> (observer != <font color="#0000ff">null</font> ) { <br> observer.notifyGui(messageId, item); <br> } <font color="#0000ff">else</font> { <br> <font color="#008000">//     NotificationBar</font> <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Important: do not forget to reset the observer of the service from your Activity when you exit it and restore this link.  This is done like this: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">@Override <br> <font color="#0000ff">protected</font> <font color="#0000ff">void</font> onUserLeaveHint() { <br> <font color="#0000ff">if</font> (billingService != <font color="#0000ff">null</font> ) { <br> unbindService( <font color="#0000ff">this</font> ); <br> billingService.resetEventDispatcher(); <br> billingService = <font color="#0000ff">null</font> ; <br> } <br> super.onUserLeaveHint(); <br> } <br> <br> @Override <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onServiceConnected(ComponentName componentName, IBinder iBinder) { <br> <font color="#008000">//Connected to BillingService</font> <br> <font color="#0000ff">if</font> (componentName.getShortClassName().equals(serviceClassName)) { <br> billingService = ((BillingService.LocalBinder) iBinder).getService(); <br> billingService.setObserver( <font color="#0000ff">new</font> PurchaseObserver()); <br> <font color="#0000ff">try</font> { <br> billingService.checkBillingAvailability(); <br> } <font color="#0000ff">catch</font> (MyException e) { <br> Log.e(TAG, <font color="#A31515">"Billing unavailable"</font> , e); <br> Toast.makeText( <font color="#0000ff">this</font> , <font color="#A31515">"Billing unavailable"</font> , Toast.LENGTH_LONG).show(); <br> } <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br><h5>  4. Launch an Activity Purchase. </h5><br><br>  Take a look at the PurchaseObserver class example.  There is a public void startBuyPageActivity method (PendingIntent pendingIntent, Intent intent).  PendingIntent - this is what we received a response from the market.  And Intent is just new Intent (). <br>  What does this method do? <br>  In fact, an instance of your Activity is passed to this class.  Further away from her, through reflection, an attempt is made to get the startInstentSender method.  This method appeared only in Android 2.0.  If it is, then the method is invoked, and the Activity is launched in the Activity stack of our application.  If the method is not found, then the Activity starts in a separate stack. <br><br><h4>  But what about security? </h4><br><br>  The issue of security is a topic for a separate article, and there are already many.  In the sample application, the Security class is responsible for security.  I can only say that you need to verify purchases not in the application (as was done in the example), but on your own server, in order not to give the verification logic to the hands of potential owners of apk. <br><br>  PS Based on <a href="http://developer.android.com/guide/market/billing/billing_overview.html">developer.android.com/guide/market/billing/billing_overview.html</a> </div><p>Source: <a href="https://habr.com/ru/post/117944/">https://habr.com/ru/post/117944/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../117938/index.html">Innotech 2011 was held in Moscow</a></li>
<li><a href="../117939/index.html">Published Russian translation of the ‚Äúpublic domain‚Äù tool ‚ÄúCC0‚Äù</a></li>
<li><a href="../117940/index.html">What DNS server do you use on your computer?</a></li>
<li><a href="../117941/index.html">RIF 2011: Ivy, Merkurov and RIA-Novosti</a></li>
<li><a href="../117942/index.html">118. Socialization of memory</a></li>
<li><a href="../117946/index.html">Digest of the best vacancies of Runet startups (April 18-22)</a></li>
<li><a href="../117947/index.html">How to stop living in the mud</a></li>
<li><a href="../117948/index.html">Participants of the torrent file sharing, how many files do you currently share?</a></li>
<li><a href="../117950/index.html">Interfaces of mobile applications: design and ergonomics</a></li>
<li><a href="../117954/index.html">Tele2 launches sales in Moscow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>