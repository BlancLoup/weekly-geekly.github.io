<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We understand WeChat - the second most popular messenger in the world</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="- A little excursion to WeChat; 
- About the platform, version of the application, utilities used and decryption of the executable file; 
- About two ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We understand WeChat - the second most popular messenger in the world</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/59/cd/15/59cd1568a46fc367639644.png"><br><br><ul><li>  A little excursion to WeChat; </li><li>  About the platform, version of the application, utilities used and decryption of the executable file; </li><li>  About two protocols (old and new); </li><li>  About serialization of objects; </li><li>  Used cryptography and key exchange; </li><li>  About headers and hash functions; </li><li>  About found vulnerabilities. </li></ul><br><a name="habracut"></a><br><h2>  Messenger WeChat from the Chinese company Tencent </h2><br>  WeChat is the second most popular messenger in the world.  Official data on the number of users is very difficult to find, but you can make a rough estimate. <br>  We are talking about about 800 million users worldwide, 90% of which are in China. <br><br>  In China, almost every smartphone owner uses WeChat (Chinese self-Weixin), since it is not only the instant messenger in the classical sense, but the whole system, including a mobile wallet, an integrated browser, an online store, etc. It represents all Chinese government agencies.  Pay for a receipt or make an appointment with a doctor through an instant messenger. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      An urgent task was the integration of CRM systems of customers actively working in China with WeChat.  This was facilitated by the prevalence of WeChat in China, as well as the lack of an official API.  SMS information in China is expensive and, most importantly, it is unstable, besides there is no ‚Äúread‚Äù status.  The customer, using the API, will be able through his CRM system to notify WeChat users (subscribed to receive information from the customer number, we will tell about it below) about the delivery of goods, new orders and other service information. <br><br><h2>  Protocol study </h2><br>  It was decided to study the messenger "from the inside", to understand the code of the 32-bit version of the messenger for iOS.  We have an old, old-fashioned, iPhone 4S with iOS 7.2.1. <br><br>  As MITM we use <a href="https://portswigger.net/burp/freedownload">Burp Suite Free Edition</a> . <br>  We download the application and with the help of the wonderful utility <a href="https://github.com/stefanesser/dumpdecrypted">dumpdecrypted we</a> decrypt the executable file. <br>  At the time of the beginning of the reverse engineering WeChat version 6.3.13 was relevant. <br><br>  Now it remains to copy the file from the device, disassemble it into IDA, and you can start. <br><br>  Consider the key exchange algorithm on the example of registration. <br>  Run the application and see the offer to enter the phone number for registration. <br><br>  Enter the phone number and see the HTTP request to MITM at <a href="http://hkshort.weixin.qq.com/bindopmobileforreg">hkshort.weixin.qq.com/bindopmobileforreg</a> . <br><br><img src="https://habrastorage.org/webt/59/cd/1b/59cd1b3370271202887510.png"><br><br>  The request body consists of: <br><br><ul><li>  Header (yellow); </li><li>  Encrypted data (blue color). </li></ul><br>  After a very long static code analysis, we managed to find out that the client communicates with the server using serialized objects.  Objects are serialized using the <a href="https://developers.google.com/protocol-buffers/docs/overview">Protocol Buffers</a> library. <br><br>  The first message is the following data: <br><br><ul><li>  Phone number ; </li><li>  Phone system language; </li><li>  Device ID; </li><li>  Client version; </li><li>  Key for decrypting the response (random 16 bytes); </li><li>  Other data (not very interesting for us). </li></ul><br>  The message is serialized and encrypted with the server's public key using the RSA algorithm.  The server response is decrypted by the AES-key transmitted in the request.  The response states that everything is all right, or an error is indicated. <br><br>  We receive SMS and enter the code.  The same request is formed, only with the code from SMS, and in the answer we get the so-called ticket.  Now, having a ticket, you can send a request for registration.  Enter the name and click OK. <br><br>  The key exchange takes place according to the Diffie-Hellman algorithm using an elliptic curve over a finite field ‚Äúsecp224r1‚Äù.  The private and public keys are generated and a request is sent to <a href="http://hkshort.weixin.qq.com/newreg">hkshort.weixin.qq.com/newreg</a> .  The server generates its keys, and also gives us the so-called CryptUin and ServerID, which will be discussed later.  In response, the server sends us its public key and session key. <br><br>  Now we have the public key of the server, and we calculate the common key with which we decrypt the session key.  From this point on, client-server communication is performed using the AES symmetric algorithm with a key length of 128 bits. <br><br>  In general, the algorithm for establishing connections and key exchange is nothing supernatural.  Properly encrypting data and exchanging keys is half the task; you also need to correctly create a header for each message.  Even if you serialize the data correctly and encrypt it, then if the header is incorrect, the server will send a response with an error.  The headline looks like this: <br><br> <code>bfa65f16050520252cb6b770021001754cc8fd5e57e085457800fb0242420001aeb890f40b010a0080</code> <br> <br><img src="https://habrastorage.org/webt/59/ce/1b/59ce1b516f801369378462.png"><br><br>  Now we will tell more about each field: <br><br>  1. Protocol identifier.  Each packet starts with this byte. <br><br>  2. Flags.  Stores information about the length of the SrvID, the length of the header itself and the compression of the original message. <br><br><img src="https://habrastorage.org/webt/59/cd/1f/59cd1f854ad8d137001121.png"><br><br>  The compression flag is set to 0b10, if the message is not compressed, otherwise set to 0b01. <br><br>  3. Application Version.  No comments. <br><br>  4. CryptUin.  After registration, each account is assigned a unique identifier of four bytes. <br><br>  5. SrvID.  ID of the current session.  Changes with each new connection. <br><br>  6. uiCgi.  Command code  Each team has its own uiCgi and url.  For example, for the bindopmobileforreg command, uiCgi is 0x91, and for newreg it is 0x7e.  Most numbers are packed using the following algorithm: <br><br><pre> <code class="hljs pgsql">private static <span class="hljs-type"><span class="hljs-type">void</span></span> Write7BitEncodedInt(BinaryWriter store, <span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>(store != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); // <span class="hljs-keyword"><span class="hljs-keyword">Write</span></span> <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> an <span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> bits at a <span class="hljs-type"><span class="hljs-type">time</span></span>. The high <span class="hljs-type"><span class="hljs-type">bit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the byte, // <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>, tells reader <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> reading more bytes. uint v = (uint)<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; // support negative numbers <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (v &gt;= <span class="hljs-number"><span class="hljs-number">0x80</span></span>) { store.<span class="hljs-keyword"><span class="hljs-keyword">Write</span></span>((byte)(v | <span class="hljs-number"><span class="hljs-number">0x80</span></span>)); v &gt;&gt;= <span class="hljs-number"><span class="hljs-number">7</span></span>; } store.<span class="hljs-keyword"><span class="hljs-keyword">Write</span></span>((byte)v); }</code> </pre> <br><br>  In this example, uiCgi is equal to 0x17b, and in packaged form - fb02. <br><br>  7. The length of the original message.  The length of the serialized data.  The number is also packed, but since it is less than 0x80, it remains unchanged. <br><br>  8. The length of the compressed message.  Compression was not made, so it does not differ from the previous one. <br><br>  9. Flag. <br><br>  10. Hash. <br><br>  Calculated as follows: <br><br> <code>hash1 = md5(cryptUin.shareKey); <br> hash2 = md5( strlen(data).shareKey.hash1.data) <br> resultHash = adler32(hash2)</code> <br> <br>  <code>sharedKey</code> is a shared key obtained during a handshake. <br>  The hash is also packed. <br><br>  11. Flags.  The meaning of these flags remains a mystery, but they are static, so there was no sense to study them separately. <br><br>  Now another protocol is being used, which we will write about in subsequent publications.  In fact, it is a wrapper over the above.  The old protocol is still supported - for this you need to clear the MmtlsCtrlFlag flag in the debugger. <br><br>  Spam protection. <br>  To protect against spam, the user can enable the "confirmation of friendship" option.  In this case, you can write a message to him only after he confirms that you are friends.  A request for confirmation of friendship may contain a welcome message. <br><br>  Send a lot of welcome messages will not work.  After sending fifteen requests, all the rest stop sending and enter the queue.  The sixteenth request will be sent only when one of the previous fifteen adds you as a friend.  But the user does not know this, and the application interface does not report about it either.  We managed to figure this out with the help of traffic analysis and experiments. <br><br>  In the process, an interesting vulnerability was also discovered.  The application has the ability to find the user by phone number.  The server either responds that there is no such user, or returns information about it (name, gender, city, photo, etc.).  But if you send these requests too often, the server responds with the message ‚ÄúToo many attempts.  Try again later. ‚Äù  This can be used, because if the user does not exist, the server will always inform about this, and if the answer comes ‚ÄúToo many attempts.  Try again later ‚Äû- this means that the user exists.  Using this, you can build a user base.  By the way, there were very ‚Äúinteresting‚Äù users who use WeChat, but they cannot be detected in the usual way, and it is even impossible to send them an invitation, most likely they are the ‚Äúspecial‚Äù people of China.  Even if you request registration for an ‚Äúinteresting‚Äù number, the server will inform you that this user is already registered and offers to restore the account, but not via SMS. <br><br>  Using 20,000 streams it is possible to collect the entire WeChat database in China from one account per day, account lockdown does not occur. <br><br>  Also separately I would like to inform you that End-to-End encryption between users does not occur.  Messages are encrypted only with a symmetric key, the server <b>decrypts</b> them and re-encrypts them with the symmetric key of the recipient and sends them to the recipient. <br><br>  This article is introductory, if there is interest from the Habr community, the following WeChat publications may appear, since any event in WeChat (for example, object serialization) is worthy of separate articles. </div><p>Source: <a href="https://habr.com/ru/post/338940/">https://habr.com/ru/post/338940/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338928/index.html">In Search of Performance, Part 2: Java Profiling for Linux</a></li>
<li><a href="../338930/index.html">V8 under the hood</a></li>
<li><a href="../338932/index.html">React v16.0 released</a></li>
<li><a href="../338934/index.html">Prototype cheat ASO promotion</a></li>
<li><a href="../338938/index.html">Classic 2D quest or how our two years of development went. Part 2</a></li>
<li><a href="../338942/index.html">Micromaster's degree as a new form of education. Overview of the first pilot program</a></li>
<li><a href="../338944/index.html">Internet where there is none, or Fixed connection based on 3G-LTE</a></li>
<li><a href="../338946/index.html">We write our book again</a></li>
<li><a href="../338948/index.html">Time management for kinesthetics</a></li>
<li><a href="../338950/index.html">Symfony + RabbitMQ Quick start for young</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>