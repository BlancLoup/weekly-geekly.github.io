<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unsuccessful software deployment led to failure of the Cloudflare service</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is a small temporary article, in the place of which there will later be a full analysis and comprehensive information about what happened today. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unsuccessful software deployment led to failure of the Cloudflare service</h1><div class="post__text post__text-html js-mediator-article"><p>  This is a small temporary article, in the place of which there will later be a full analysis and comprehensive information about what happened today. </p><br><p>  Today, for about 30 minutes, visitors to Cloudflare sites could see an error 502 caused by a sharp jump in the CPU load on our network.  This happened due to unsuccessful software deployment.  We rolled back the changes, and now the service is functioning normally, as before, and all domains using Cloudflare have returned to normal traffic levels. </p><a name="habracut"></a><br><p>  We assure you that there was no attack, and we offer our deepest apologies for what happened.  Our developers are already conducting a detailed error analysis and are trying to figure out what needs to be done in order to avoid similar incidents in the future. </p><br><p>  <strong>Added at 20:09 UTC:</strong> </p><br><p>  Today at 13:42 UTC, a failure in our network was discovered, as a result of which visitors of the Cloudflare domains saw error 502 ("Bad Gateway").  The reason for this failure was the deployment of an incorrectly configured rule in Cloudflare Web Application Firewall (WAF) during the standard deployment process of the new managed Cloudflare WAF rules. </p><br><p>  The new rules were intended to improve the blocking mechanism of embedded JavaScript used in hacker attacks.  These rules were deployed in simulation mode, in which errors are usually detected and logged without blocking user traffic, which allows you to measure the number of false positives and make sure that the new rules will work normally when deployed within the framework of this project. </p><br><p>  Unfortunately, one of these rules contained a regular expression that led to a jump in CPU utilization of up to 100% on our computers everywhere.  It is because of this jump, users of our service witnessed error 502, and traffic fell to 82%. </p><br><p>  The graph below shows a jump in CPU utilization in one of our PoPs: </p><br><p><img src="https://habrastorage.org/webt/to/mj/q1/tomjq1qowdfvsn_nbvx0d_3ei5s.png"></p><br><p>  We first encountered the problem of complete exhaustion of CPU resources, which was extremely unexpected for us. </p><br><p>  We constantly carry out software deployment in our network and have already developed automated systems for running tests and a phased deployment procedure in order to prevent unpleasant situations.  Unfortunately, the global deployment of WAF rules was carried out in one action, which caused today's failure. </p><br><p>  At 14:02 UTC, we realized what had happened and decided to completely disable the WAF rule sets, which immediately normalized the CPU load and restored traffic.  We made it at 2:09 PM UTC. </p><br><p>  After that, we analyzed the problematic pull request, rolled back the changes in the relevant rules, tested our actions to be 100% sure that the error was found correctly, and then restored the WAF rule sets at 14:52. </p><br><p>  We realize how much damage our users cause such incidents.  In this case, our testing mechanism did not cope with the task, and we are already working on improving it and optimizing the deployment process in order to avoid similar errors in the future. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/458660/">https://habr.com/ru/post/458660/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../45865/index.html">We recognize the operator and the region of the mobile phone</a></li>
<li><a href="../458650/index.html">Cybercall. New level. Online competition from Rostelecom-Solar</a></li>
<li><a href="../458652/index.html">RamblerFront & Meetup # 7</a></li>
<li><a href="../458654/index.html">The Lurk virus hacked into banks while it was being written by ordinary remote workers for hire</a></li>
<li><a href="../458658/index.html">Switching from virtual machines to LXC containers: reasons, advantages and ready-to-use instructions</a></li>
<li><a href="../458662/index.html">EMI plans to introduce tests of air transport on "dronestoykost"</a></li>
<li><a href="../458666/index.html">Stupid brains, hidden emotions, insidious algorithms: the evolution of face recognition</a></li>
<li><a href="../458668/index.html">What is the secret meaning of free legal advice on the Internet?</a></li>
<li><a href="../45867/index.html">Communicator Qigi i6</a></li>
<li><a href="../458670/index.html">How processors are designed and manufactured: the future of computer architectures</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>