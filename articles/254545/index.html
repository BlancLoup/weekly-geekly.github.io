<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Damage to the stack in one of the NSString methods</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to write about one strange crash with whom I understood at work. 

 Crash occurred stably when entering the folder with Korean characters. The ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">ğŸ”</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">ğŸ“œ</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">â¬†ï¸</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">â¬‡ï¸</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Damage to the stack in one of the NSString methods</h1><div class="post__text post__text-html js-mediator-article">  I want to write about one strange crash with whom I understood at work. <br><br>  Crash occurred stably when entering the folder with Korean characters.  The problem was in the seemingly innocent code of the following form: <br><br><pre><code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSURLComponents</span></span>* urlComp = [[<span class="hljs-built_in"><span class="hljs-built_in">NSURLComponents</span></span> new] autorelease]; ... urlComp.path = path; urlComp.user = username; ...</code> </pre> <br><a name="habracut"></a><br>  Falls when setting user - EXC_BAD_ACCESS inside the setter when sending objc_msgSend to someone.  All variables are in order, nothing could break.  At the same time, the crash is reproduced in the release configuration, but not in the release configuration.  Cursing for the poor performance of the debugger in the release box, let's go look further. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Although the debugger often cannot print variables in the release, it is easy to see in which register, which variables should be in the disassembled listing, and the debugger is able to output objects normally (for example, po $ r0).  It quickly becomes clear that the username is dead (in my case, the r10 register) - po $ r10 prints a number, not an object.  Somewhat less quickly, it becomes clear that the value in the r10 register changed after setting the path. <br><br>  Okay, let's look at what happens in the method "- [__ NSConcreteURLComponents setPath:]".  Fortunately, it is small and it is clear that the register r10 flies when you call "- [NSString (NSURLUtilities) stringByAddingPercentEncodingWithAllowedCharacters:]" - i.e.  when escaped transmitted path.  This function is already large, and the customer will reject the head for its analysis, but at least we will look at the input-output <br><br><pre> <code class="hljs perl"><span class="hljs-number"><span class="hljs-number">0x2ca50aec</span></span>: push.w {r8, r1<span class="hljs-number"><span class="hljs-number">0</span></span>, r11} <span class="hljs-number"><span class="hljs-number">0x2ca50af0</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">w</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sp</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sp</span></span></span><span class="hljs-function">, #0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x1020</span></span></span><span class="hljs-function"> 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x2ca50af4</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sp</span></span></span><span class="hljs-function">, #0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x10</span></span></span><span class="hljs-function"> ... 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x2ca50e7a</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">w</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sp</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sp</span></span></span><span class="hljs-function">, #0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x1020</span></span></span><span class="hljs-function"> 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x2ca50e7e</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sp</span></span></span><span class="hljs-function">, #0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x10</span></span></span><span class="hljs-function"> 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x2ca50e80</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">w</span></span></span><span class="hljs-function"> </span></span>{r8, r1<span class="hljs-number"><span class="hljs-number">0</span></span>, r11}</code> </pre><br>  On entry, our r10 is saved to the stack, and on exit it is restored.  The stack pointer (sp) is in the order that it was, then returned, but the stack contents themselves are not the same - the value of r10 was restored incorrectly.  Thus, in the system function for percent encoding, there is a stack damage. <br><br>  For clarity, I brought the code-sample to a clean test project: <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span>* obj1 = [[<span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> new] autorelease]; <span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span>* obj2 = [[<span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> new] autorelease]; <span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span>* obj3 = [[<span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> new] autorelease]; <span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span>* obj4 = [[<span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> new] autorelease]; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>* str = <span class="hljs-string"><span class="hljs-string">@"/Users/zaryanov/Movies/rootfolder/ì‹œí‹° ì˜¤ë¸Œ íˆì–´ë¡œ (City of Heroes)/ë¡œë‹ˆ ë¦¬ ê°€ë“œë„ˆ (1961ë…„ë¶€í„° 2010ë…„ê¹Œì§€)ëŠ” 1985 ë…„ì— ì‚´ì¸ì£„ë¡œ ì‚¬í˜•ì„ë°›ì€ ìœ íƒ€ ì£¼ì—ì„œ ì´ì‚´í˜• ëœ ë¯¸êµ­ì˜ ì•…ë‹¹ì´ì—ˆë‹¤. 1984 ë…„ì— ê·¸ëŠ” ì†”íŠ¸ ë ˆì´í¬ ì‹œí‹°ì—ì„œ ê°•ë„ ë™ì•ˆ ë°”í…ë”ë¥¼ ì‚´í•´.m4v"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"%s str %@"</span></span>, __func__, str); <span class="hljs-built_in"><span class="hljs-built_in">NSCharacterSet</span></span>* charSet = [<span class="hljs-built_in"><span class="hljs-built_in">NSCharacterSet</span></span> URLPathAllowedCharacterSet]; str = [str stringByAddingPercentEncodingWithAllowedCharacters:charSet]; <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"%s str %@"</span></span>, __func__, str); <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"%s obj1 %@ obj2 %@ obj3 %@ obj4 %@"</span></span>, __func__, obj1, obj2, obj3, obj4);</code> </pre><br>  In this case, the crash did not occur during the output to the log, as I expected, but in the most problematic function (escaping).  The abort function worked in the __stack_chk_fail function - the fact is that the arm64 architecture was resolved in a clean test project, and there appears to be a stack check.  If you leave only armv7, then a crash occurs when objects are output to the log, as I expected.  In any case, the stack is damaged. <br><br>  Further, the google by â€œstringByAddingPercentEncodingWithAllowedCharacters crashâ€ gives some confirming results: <br><br>  <a href="https://github.com/Alamofire/Alamofire/issues/206">https://github.com/Alamofire/Alamofire/issues/206</a> - here, however, complain about the high memory consumption, but the function is the same; <br>  <a href="https://gist.github.com/clowwindy/0d800f07a5e95e5c4dd0">https://gist.github.com/clowwindy/0d800f07a5e95e5c4dd0</a> - here is an example that tears down the stack completely, and not a couple of registers. <br><br>  Actually, I took a logical solution from the first link provided - using CFURLCreateStringByAddingPercentEscapes, less convenient, but it works.  Moreover, NSURLComponents can be set by themselves already zaekapelenny path. <br><br>  The problem is reproduced on iOS 8.2, so itâ€™s worth keeping a notch on the subcortex.  As can be seen in my case, the crash may be slightly hidden and not obvious due to the implicit call of the problem function through another function.  Well, with damage to the stack can get lucky in different ways, if it hooks only registers, then it may not immediately show up. <br><br>  <b>UPD:</b> <br>  Not finding such a bug in the openradar, I decided to post it.  At the same time, I copied the example (not from the browser, but it can have the same result) and ... did not get a crash.  It turned out that these hieroglyphs can be encoded in UTF-8 in different ways, and in one case it falls, but not in the other.  So, the hieroglyph can be encoded as a composite of two elements (6 bytes will turn out - E1 84 89 E1 85 B5), or it can be encoded as already assembled (3 bytes will turn out - EC 8B 9C).  In the second case, with such a line did not fall. <br><br>  Bug posted - <a href="http://www.openradar.me/20404230">http://www.openradar.me/20404230</a> , there is also a link to the example in github, where the bug is reproduced. </div><p>Source: <a href="https://habr.com/ru/post/254545/">https://habr.com/ru/post/254545/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../254531/index.html">Programming Philosophy 6 - Product and Project</a></li>
<li><a href="../254533/index.html">Tarantool 1.6 - let's get started</a></li>
<li><a href="../254537/index.html">Document generator docx and xlsx</a></li>
<li><a href="../254541/index.html">We work with Compound File</a></li>
<li><a href="../254543/index.html">Research on IT leadership factors</a></li>
<li><a href="../254549/index.html">Coub goes to strike</a></li>
<li><a href="../254551/index.html">4th generation SCADA system: AggreGate SCADA / HMI</a></li>
<li><a href="../254555/index.html">CLRium # 2 accepts DevExpress CodeRush and runs the kernel on Ubuntu Linux. And it's not a joke</a></li>
<li><a href="../254559/index.html">Evolution of data transfer speed in Wi-Fi networks</a></li>
<li><a href="../254561/index.html">Warehouse management: on the "waves" of operations</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>