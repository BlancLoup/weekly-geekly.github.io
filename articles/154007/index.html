<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a module in C ++ for nodejs using the example of working with MySQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Many have already managed to try Node.js, in my opinion, this is a very convenient tool for solving a wide range of tasks. I am most at...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a module in C ++ for nodejs using the example of working with MySQL</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/f0d/9bb/b9c/f0d9bbb9c0d4c82e6c10e3f3fbb4e5a6.png" align="right"><br><h4>  Introduction </h4><br>  Many have already managed to try Node.js, in my opinion, this is a very convenient tool for solving a wide range of tasks.  I am most attracted to Node.js by the ability to write JavaScript code and a large set of built-in modules to solve common problems.  If something was not in the standard package, then a huge number of additional modules can be found in the <a href="https://npmjs.org/">npmjs.org</a> repository <a href="https://npmjs.org/">.</a> <br><br>  However, there are situations when everything that is there, works or not as you like, or does not work at all in the given conditions, or everything is more banal - just what is necessary for a particular case is missing.  I needed a module that can synchronously perform queries to MySQL, with the fourth version.  The first tested module worked exclusively with the fifth version; later, of course, there were others, but it was not possible to find the one that allows you to execute queries synchronously. <br><br>  After studying the documentation, I came to the conclusion that I can write the module I need in C ++ and issue it as addon to node.js, if you are interested in the module creation process, welcome under cat. <br><a name="habracut"></a><br><h4>  Instruments </h4><br>  We will write the module under Linux.  From the tools we need: <br><ul><li>  mysql </li><li>  node </li><li>  node-gyp </li><li>  Gcc </li></ul><br>  How all this is put in your distribution, you should know for yourself, except for node-gyp, it is put through npm which comes with the node installation: <br> <code>npm install node-gyp</code> <br> <br><h4>  Writing a module </h4><br>  So node.js is a platform built on a JavaScript engine from Google V8.  Accordingly, in our module we will have to deal with objects of the V8 engine.  To simplify your life, it is advisable to have some kind of cheat sheet on the objects of this engine, I chose <a href="http://bespin.cz/~ondras/html/index.html">this one</a> , as well as a reference book on C functions for working with MySQL, for example, you can look <a href="http://www.mysql.ru/docs/man/C_API_functions.html">here</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  How do modules start </h5><br>  First you need to create a file, in my case it will be <b>mysql_sync.cc</b> , after we describe the necessary headers and set the namespace: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;node.h&gt; #include &lt;node_buffer.h&gt; #include &lt;v8.h&gt; #include &lt;mysql.h&gt; using namespace v8;</span></span></span></span></code> </pre><br>  The operation of any module for node.js begins with the execution of the <b>NODE_MODULE</b> macro, to which the module name and the function name will be passed, which will be executed when the module is connected. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Handle&lt;Object&gt; target)</span></span></span><span class="hljs-function"> </span></span>{ target-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"create"</span></span>), FunctionTemplate::New(create)-&gt;GetFunction()); } NODE_MODULE(mysql_sync, init)</code> </pre><br>  So, we see that, the <b>init</b> function returns nothing, but an object is passed to it.  We add a property to this object with the name <b>create</b> , using the <b>Set</b> method, the name is an object of the V8 String class and created using the static NewSymbol function, into which we pass the required string.  The value of this property will be a function that will be created from a function with the name <b>create</b> . <br>  Everything is quite simple, but there is one thing, this function will be called only once when the module is first loaded, after which the node will cache the object that was received at the output of the <b>init</b> function, and will not call it anymore. <br>  If now to add the <b>create</b> function, compile the module, and execute the following code in node <br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./mysql_sync.node'</span></span>));</code> </pre> <br>  As a result, we will see the following result on the screen: <br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">create</span></span>: [<span class="hljs-built_in"><span class="hljs-built_in">Function</span></span>] }</code> </pre> <br>  The first stage is ready, go to the <b>create</b> function. <br><br><h5>  Creating the object of our module </h5><br>  The code of the <b>create</b> function is no different: <br><pre> <code class="cpp hljs">Handle&lt;Value&gt; create(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Arguments&amp; args) { HandleScope scope; Handle&lt;Object&gt; ret = Object::New(); node::Buffer *buf; buf = node::Buffer::New((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)mysql_init(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(MYSQL)); ret-&gt;SetHiddenValue(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"MYSQL"</span></span>), buf-&gt;handle_); ret-&gt;SetHiddenValue(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"connected"</span></span>), Boolean::New(<span class="hljs-number"><span class="hljs-number">0</span></span>)); ret-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"connect"</span></span>), FunctionTemplate::New(connect)-&gt;GetFunction()); ret-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"query"</span></span>), FunctionTemplate::New(query)-&gt;GetFunction()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope.Close(ret); }</code> </pre><br>  The return value of this code is an object of class V8 Value.  This class is returned by all JavaScript functions, as well as C ++, if they are called from JavaScript.  Create a new <b>ret</b> object in which we will store the properties of the object returned by the function.  Here, it is desirable for us to initialize a pointer to the <b>MYSQL</b> structure, which will be needed to work with the rest of MySQL functions and somehow store it in our object.  Of all that, the Buffer object, which is described in the node.js itself, was the most found for storing the structure.  Using the node :: Buffer :: New construction, we created a new object of the required size and put an initialized <b>MYSQL</b> structure there <i>(I know that it would be good to check the returned result, but I don‚Äôt want to over-complicate, so some checks will be omitted later)</i> . <br>  In order to store MYSQL in our object but not to give the user access to it, the option of storing the structure in the hidden field of the object was selected using the SetHiddenValue method; it is completely similar to the Set method except for what it creates not a regular property, but a hidden one inaccessible from javascript code.  We will also store the <b>connected</b> property in a hidden field, it will come in handy later, and now we will put a V8 Boolean object in it (with the value False).  After we add two more functions: <b>connect</b> and <b>query</b> .  And at the end we return our object, the function that called it, using scope.Close (ret); <br>  In the intermediate result, we obtain a function that creates a new object, adding to it two hidden properties with service data for this object, and two public properties that store the functions we need. <br>  If you make a stub on the two specified functions and execute the specified code: <br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./mysql_sync.node'</span></span>).create());</code> </pre> <br>  Then we get the following result: <br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">connect</span></span>: [<span class="hljs-built_in"><span class="hljs-built_in">Function</span></span>], <span class="hljs-attr"><span class="hljs-attr">query</span></span>: [<span class="hljs-built_in"><span class="hljs-built_in">Function</span></span>]}</code> </pre> <br><h5>  Methods of our module </h5><br>  Now, we will describe the methods of our module: <br>  <b>Connect</b> method: <br><pre> <code class="cpp hljs">Handle&lt;Value&gt; connect(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Arguments&amp; args) { HandleScope scope; Handle&lt;Object&gt; ret = Object::New(); Handle&lt;Object&gt; err = Object::New(); MYSQL *mysql; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> ok=<span class="hljs-literal"><span class="hljs-literal">true</span></span>; mysql = (MYSQL *)args.Holder()-&gt;GetHiddenValue(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"MYSQL"</span></span>))-&gt; ToObject()-&gt;GetIndexedPropertiesExternalArrayData(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(args.Length()==<span class="hljs-number"><span class="hljs-number">4</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">4</span></span>; i++) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!args[i]-&gt;IsString()) ok=<span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { ok=<span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ok == <span class="hljs-literal"><span class="hljs-literal">true</span></span>){ String::<span class="hljs-function"><span class="hljs-function">AsciiValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">host</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(args[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">]-&gt;ToString())</span></span></span></span>; String::<span class="hljs-function"><span class="hljs-function">AsciiValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">user</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(args[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">]-&gt;ToString())</span></span></span></span>; String::<span class="hljs-function"><span class="hljs-function">AsciiValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(args[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">]-&gt;ToString())</span></span></span></span>; String::<span class="hljs-function"><span class="hljs-function">AsciiValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">db</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(args[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">3</span></span></span></span><span class="hljs-function"><span class="hljs-params">]-&gt;ToString())</span></span></span></span>; mysql_real_connect(mysql, *host, *user, *pass, *db, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); args.Holder()-&gt;SetHiddenValue(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"connected"</span></span>), Boolean::New(<span class="hljs-number"><span class="hljs-number">1</span></span>)); err-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"id"</span></span>), Uint32::New(mysql_errno(mysql))); err-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"text"</span></span>), String::NewSymbol(mysql_error(mysql))); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { err-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"id"</span></span>), Uint32::New(<span class="hljs-number"><span class="hljs-number">65535</span></span>)); err-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"text"</span></span>), String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"Incorect parametrs of function"</span></span>)); } ret-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"err"</span></span>), err); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope.Close(ret); }</code> </pre><br>  Then I ran into the first difficulty, we obviously don‚Äôt pass the object that caused this method, but the object contains two hidden fields that we need for further work.  But the arguments to the function are passed by the V8 Arguments object; after digging into its description, we find that it stores a reference to the object that passed it.  To get it, we use the <b>Holder ()</b> method, after which we get a hidden field with the <b>MYSQL</b> structure and, using the GetIndexedPropertiesExternalArrayData () method, we get a pointer to the structure itself.  Then there is nothing remarkable in the code, there are checks on how many parameters were transmitted and what type.  If everything correctly <b>calls the mysql_real_connect ()</b> function, we get mysql errors, create an <b>err</b> object and add errors to it as field values.  If the parameters are not what we expected, we add our error to the <b>err</b> object.  Then we add the <b>err</b> object as the ‚Äúerr‚Äù field to the <b>ret</b> object and return this object. <br><br>  <b>Query</b> method: <br><pre> <code class="cpp hljs">Handle&lt;Value&gt; query(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Arguments&amp; args) { HandleScope scope; Handle&lt;Object&gt; ret = Object::New(); Handle&lt;Object&gt; err = Object::New(); Handle&lt;Array&gt; rows = Array::New(); Handle &lt;Script&gt; script; Handle&lt;Object&gt; obj_row; node::Buffer *buf; MYSQL *mysql; MYSQL_RES *res; MYSQL_ROW row; MYSQL_FIELD *fields; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> num_fields; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> ok=<span class="hljs-literal"><span class="hljs-literal">true</span></span>; mysql = (MYSQL *)args.Holder()-&gt;GetHiddenValue( String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"MYSQL"</span></span>))-&gt;ToObject()-&gt;GetIndexedPropertiesExternalArrayData(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!args.Holder()-&gt;GetHiddenValue(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"connected"</span></span>))-&gt;BooleanValue()){ err-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"id"</span></span>), Uint32::New(<span class="hljs-number"><span class="hljs-number">65534</span></span>)); err-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"text"</span></span>), String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"You need to connect before any query"</span></span>)); ret-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"err"</span></span>), err); ok = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ok == <span class="hljs-literal"><span class="hljs-literal">true</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(args.Length()!=<span class="hljs-number"><span class="hljs-number">1</span></span>){ ok=<span class="hljs-literal"><span class="hljs-literal">false</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!args[<span class="hljs-number"><span class="hljs-number">0</span></span>]-&gt;IsString()) ok=<span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ok == <span class="hljs-literal"><span class="hljs-literal">false</span></span>){ err-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"id"</span></span>), Uint32::New(<span class="hljs-number"><span class="hljs-number">65535</span></span>)); err-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"text"</span></span>), String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"Incorect parametrs of function"</span></span>)); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ok == <span class="hljs-literal"><span class="hljs-literal">true</span></span>){ String::<span class="hljs-function"><span class="hljs-function">AsciiValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(args[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">]-&gt;ToString())</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(mysql_query(mysql, *query)==<span class="hljs-number"><span class="hljs-number">0</span></span>){ res = mysql_store_result(mysql); num_fields = mysql_num_fields(res); fields = mysql_fetch_fields(res); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( (row = mysql_fetch_row(res)) ){ obj_row = Object::New(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;num_fields; i++){ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(fields[i].type){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MYSQL_TYPE_DECIMAL: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MYSQL_TYPE_TINY: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MYSQL_TYPE_SHORT: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MYSQL_TYPE_LONG: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MYSQL_TYPE_LONGLONG: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MYSQL_TYPE_INT24: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MYSQL_TYPE_FLOAT: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MYSQL_TYPE_DOUBLE: obj_row-&gt;Set(String::NewSymbol(fields[i].name), Number::New( (row[i])? atof(row[i]):<span class="hljs-number"><span class="hljs-number">0</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MYSQL_TYPE_TIMESTAMP: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MYSQL_TYPE_DATE: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MYSQL_TYPE_TIME: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MYSQL_TYPE_DATETIME: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MYSQL_TYPE_YEAR: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MYSQL_TYPE_NEWDATE: script = Script::Compile( String::NewSymbol(<span class="hljs-string"><span class="hljs-string">""</span></span>)-&gt;Concat( String::NewSymbol(<span class="hljs-string"><span class="hljs-string">""</span></span>)-&gt;Concat( String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"new Date(Date.parse('"</span></span>), String::NewSymbol( (row[i])? row[i]:<span class="hljs-string"><span class="hljs-string">""</span></span> ) ), String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"'))"</span></span>)) ); obj_row-&gt;Set(String::NewSymbol(fields[i].name), script-&gt;Run()); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MYSQL_TYPE_TINY_BLOB: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MYSQL_TYPE_MEDIUM_BLOB: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MYSQL_TYPE_LONG_BLOB: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MYSQL_TYPE_BLOB: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((fields[i].flags &amp; BINARY_FLAG)){ buf = node::Buffer::New(row[i], mysql_fetch_lengths(res)[i]); obj_row-&gt;Set(String::NewSymbol(fields[i].name), buf-&gt;handle_); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: obj_row-&gt;Set(String::NewSymbol(fields[i].name), String::NewSymbol( (row[i])? row[i]:<span class="hljs-string"><span class="hljs-string">""</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } rows-&gt;Set(rows-&gt;Length(),obj_row); } mysql_free_result(res); }; ret-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"inserted_id"</span></span>), Uint32::New(mysql_insert_id(mysql))); ret-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"info"</span></span>), String::NewSymbol( (mysql_info(mysql)) ? mysql_info(mysql) :<span class="hljs-string"><span class="hljs-string">""</span></span> )); ret-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"affected_rows"</span></span>), Uint32::New(mysql_affected_rows(mysql))); err-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"id"</span></span>), Uint32::New(mysql_errno(mysql))); err-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"text"</span></span>), String::NewSymbol(mysql_error(mysql))); } ret-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"err"</span></span>), err); ret-&gt;Set(String::NewSymbol(<span class="hljs-string"><span class="hljs-string">"rows"</span></span>), rows); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope.Close(ret); }</code> </pre><br>  From the <b>query</b> function, I initially wanted to get the full result of the sample in and not pull it out one line at a time, so after all the checks for incoming parameters, and for the connection.  We execute the query, and add the response to the V8 object. Array <b>rows</b> .  Each response line is entered into an object, whose property names are the names of the fields of the query result, and the values ‚Äã‚Äãof the actual data.  Initially, I did this, all data was converted to a V8 String, but then I wanted a more convenient result. <br>  As a result, it was decided that the fields with types: <br><ul><li>  MYSQL_TYPE_DECIMAL </li><li>  MYSQL_TYPE_TINY </li><li>  MYSQL_TYPE_SHORT </li><li>  MYSQL_TYPE_LONG </li><li>  MYSQL_TYPE_LONGLONG </li><li>  MYSQL_TYPE_INT24 </li><li>  MYSQL_TYPE_FLOAT </li><li>  MYSQL_TYPE_DOUBLE </li></ul>  are converted to a V8 Number which corresponds to a javascript number. <br><br>  Fields with types: <br><ul><li>  MYSQL_TYPE_TINY_BLOB </li><li>  MYSQL_TYPE_MEDIUM_BLOB </li><li>  MYSQL_TYPE_LONG_BLOB </li><li>  MYSQL_TYPE_BLOB </li></ul>  checked for binary and if it is binary, BLOBs are converted to Buffer, if not, then V8 String. <br><br>  And fields with types: <br><ul><li>  MYSQL_TYPE_TIMESTAMP </li><li>  MYSQL_TYPE_DATE </li><li>  MYSQL_TYPE_TIME </li><li>  MYSQL_TYPE_DATETIME </li><li>  MYSQL_TYPE_YEAR </li><li>  MYSQL_TYPE_NEWDATE </li></ul>  It was decided to convert to V8 Date.  And here there was a snag.  To create a V8 Date object, pass unix timestamp, and mysql returns a field in the format YYYY-MM-DD HH: MM: SS.  I didn‚Äôt want to write a string parsing and further conversion.  At the same time, I remembered that by itself, JavaScript perfectly converts such an entry into a unix timestamp.  And since V8 is available to us, then why not use it.  To do this, we create a <b>script</b> object of the V8 Script class, using the Script :: Compile method, to which we pass the script string to the <nobr>new Date (Date.parse (field_m_mysql))</nobr> .  After that, we call the Run () method, which will return to us the object obtained when executing the JavaScript code.  And we in turn will put it in our V8 Array rows.  Maybe not very nice, but quite interesting. <br>  Now all that remains is to compile, for this we need to create a <b>binding.gyp</b> file with the following content: <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"targets"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"target_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"mysql_sync"</span></span>, <span class="hljs-string"><span class="hljs-string">"sources"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"mysql_sync.cc"</span></span> ], <span class="hljs-string"><span class="hljs-string">"include_dirs"</span></span>: [ <span class="hljs-string"><span class="hljs-string">'/server/daemons/mysql/include/mysql/'</span></span> ], <span class="hljs-string"><span class="hljs-string">"link_settings"</span></span>: { <span class="hljs-string"><span class="hljs-string">'libraries'</span></span>: [<span class="hljs-string"><span class="hljs-string">'-lmysqlclient -L/server/daemons/mysql/lib/mysql/'</span></span>], <span class="hljs-string"><span class="hljs-string">'library_dirs'</span></span>: [<span class="hljs-string"><span class="hljs-string">'/server/daemons/mysql/lib/mysql/'</span></span>], }, } ] }</code> </pre>  I ask you to pay attention to the fact that strange ways are indicated here (you may be different with you), you can use the command to get them: <br> <code>mysql_config --include --libs</code> <br>  Now it is necessary to execute: <br> <code>node-gyp configure</code> <br> <code>node-gyp build</code> <br> <code>cp build/Release/mysql_sync.node ./</code> <br>  Our module is ready to use, for the test we will write the following code: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mysql = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./mysql_sync.node'</span></span>).create(); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(mysql.connect(<span class="hljs-string"><span class="hljs-string">"localhost"</span></span>, <span class="hljs-string"><span class="hljs-string">"login"</span></span>, <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, <span class="hljs-string"><span class="hljs-string">"test"</span></span>)); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(mysql.query(<span class="hljs-string"><span class="hljs-string">"select * from tmp"</span></span>);</code> </pre><br><div class="spoiler">  <b class="spoiler_title">In the presence of such a user, database and table, we obtain approximately the same result.</b> <div class="spoiler_text"><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">err</span></span>: { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> } } { <span class="hljs-attr"><span class="hljs-attr">inserted_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">info</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">affected_rows</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">err</span></span>: { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> }, <span class="hljs-attr"><span class="hljs-attr">rows</span></span>:[ { <span class="hljs-attr"><span class="hljs-attr">number</span></span>: <span class="hljs-number"><span class="hljs-number">1558.235</span></span>, <span class="hljs-attr"><span class="hljs-attr">varchar</span></span>: <span class="hljs-string"><span class="hljs-string">'test1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-string"><span class="hljs-string">'blob text2, blod: &lt;SlowBuffer 31&gt;, date: Wed Oct 03 2012 00:00:00 GMT+0400 (MSK), boolean: 1, tst: &lt;SlowBuffer &gt; } , { number: 2225, varchar: '</span></span>test2<span class="hljs-string"><span class="hljs-string">', text: '</span></span>blob text2, <span class="hljs-attr"><span class="hljs-attr">blod</span></span>: &lt;SlowBuffer 32&gt;, date: Wed Oct 04 2012 00:00:00 GMT+0400 (MSK), boolean: 0, tst: &lt;SlowBuffer &gt; } ] }</code> </pre>  Result for a table created with: <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`tmp`</span></span> ( <span class="hljs-string"><span class="hljs-string">`number`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">`varchar`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">`text`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`blod`</span></span> longblob <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`date`</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'0000-00-00 00:00:00'</span></span>, <span class="hljs-string"><span class="hljs-string">`boolean`</span></span> tinyint(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">`tst`</span></span> longblob )</code> </pre><br></div></div><br><h4>  Total: </h4><br><ol><li>  We got a module ready for use, maybe not the best, but it does what we need, sometimes it‚Äôs the most important </li><li>  Learned how to write your own C ++ modules for Node.js </li><li>  Learned from the modules to call arbitrary JavaScript code </li><li>  We can write any other module if we need it. </li><li>  Gained experience with V8 JavaScript objects </li></ol><br>  The article was longer than I expected, but I think that it may come in handy for many people when writing their own module, or when trying to figure out what is happening in the modules of other developers, which is sometimes equally important.  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/154007/">https://habr.com/ru/post/154007/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../153997/index.html">DEV {web} - Highload Web Development Conference</a></li>
<li><a href="../153999/index.html">Roaming in Europe - the Internet and talk, a little bit of practice</a></li>
<li><a href="../154001/index.html">Paper layouts of browser interfaces, smartphones and tablets</a></li>
<li><a href="../154003/index.html">Writing a complex application on knockoutjs</a></li>
<li><a href="../154005/index.html">Responding to incidents in Internet banking systems - instructions from Group-IB</a></li>
<li><a href="../154009/index.html">Clustering in the Rambler-Maps API</a></li>
<li><a href="../154011/index.html">How to speed up insert in sqlite</a></li>
<li><a href="../154013/index.html">Is the possibility of free editing a wiki an open door for proving the FSB?</a></li>
<li><a href="../154015/index.html">Game "Life" and the simulation of natural selection</a></li>
<li><a href="../154017/index.html">NAMT team car robot at Robokross 2012</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>