<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MarsBoard. Debian. Router. HOWTO</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, community! I already wrote about the remarkable board on the Allwinner A10 chip - MarsBoard. That post was something like ‚ÄúGetting Started‚Äù,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MarsBoard. Debian. Router. HOWTO</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/7a8/5fc/a3f/7a85fca3f20ee376bb8318428d29e564.jpg"><br>  Good day, community!  I already <a href="http://habrahabr.ru/post/193390/">wrote</a> about the remarkable board on the Allwinner A10 chip - MarsBoard.  That post was something like ‚ÄúGetting Started‚Äù, the same will be devoted entirely to the transformation of this miracle of <s>hostile</s> technology into a full-fledged WiFi access point and a part-time router.  To create a point, the Debian Server build will help me (by the way, we will build the kernel too :)) and the TP-Link TL7200ND USB adapter.  Type of connection with the provider - PPPoE.  Interested?  Welcome under cat. <a name="habracut"></a><br><br><h4>  Instead of the preface </h4><br>  To be honest, as soon as I came up with this idea, I didn‚Äôt even think that I would have to meet with so many pitfalls.  Well, then he probably is Linux ... By the way, all the manipulations in the article will be performed using a computer running Ubuntu OS and a card reader for an SD card.  And I immediately advise you to perform <code>sudo su</code> in the terminal session, from which we will perform all actions. <br><br><h4>  System </h4><br>  For my experiments, I decided to abandon the bulldozer that brings slippers to the bed, which offers us offsite.  I managed to find a pre-built Debian Server build, but I had to mess around with the kernel.  But more about that later.  In fact, the installation is reduced to recording the image on 2 (or more) GB SDCard and installing the bootloader (from the offsite of the board). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So let's go.  Connect the SDCard to the computer and use the <code>fdisk -l</code> find out the name of the card device.  I have <code>/dev/sdc</code> .  Further, the device card in the article will be denoted as <code>sdX</code> .  Instead of <code>X</code> substitute your letter. <br>  We download everything you need.  <a href="https://romanrm.net/dl/a10/debian/">System</a> (I will consider actions with the assembly <u>2013-Sep-20 10:32:33</u> ), <a href="">uboot.bin</a> , <a href="">sunxi-spl.bin</a> . <br>  Further: <br><ol><li>  Go to the folder with the downloaded files </li><li>  We write the system on the card: <pre> <code class="bash hljs">bzip2 -dc a10-debian-server-2gb.2013-09-20.img.bz2 &gt; /dev/sdX</code> </pre></li><li>  We write bootloader: <pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=spl/sunxi-spl.bin of=/dev/sdX bs=1024 seek=8 dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=u-boot.bin of=/dev/sdX bs=1024 seek=32</code> </pre></li></ol><br>  System set, great, go ahead. <br><br><h4>  The beginning of dance - driver </h4><br>  Actually, this is where the whole epic began to stumble on those very pitfalls.  It turned out that the drivers for Ralink chips, for which the adapter works, there are 2 types - ‚Äúold‚Äù and ‚Äúnew‚Äù.  Older drivers are installed automatically via apt-get and work out of the box, but they only work in Managed mode, i.e.  the adapter can only connect to an existing point, but cannot create this point itself.  To create a point, you need to transfer the adapter to the Master mode, and for this you need those ‚Äúnew‚Äù drivers.  Only now these new cool firewood need ... to collect.  Well, collect so collect. <br><br>  Go here: <a href="http://www.ralinktech.com/support.php%3Fs%3D2">www.ralinktech.com/support.php?s=2</a> and download RT2870_Firmware_V22.  Unpack and write to / lib / firmware <b>in the file system on the SDcard</b> . <br>  Next, download compat-wireless: <a href="http://www.orbit-lab.org/kernel/compat-wireless-2.6/">www.orbit-lab.org/kernel/compat-wireless-2.6</a> .  This is actually what we need to compile. <br><br>  But not everything is so simple.  Since I still understand Linux, I was very surprised when I discovered that to compile the drivers I would need the source code for my current kernel.  And even more surprised when I did not find them in the system.  Fortunately, the author of the assembly kindly provided the configuration of the kernel used there.  We will take it to collect the source code.  So, let's digress a bit from the drivers and review the reassembly of the kernel. <br><br><h4>  Core </h4><br>  As I said, we need kernel sources for building firewood, and for building specific sources we need ... universal sources linux-sunxi.  We will also need to slightly adjust the configuration in order to bring the kernel versions of the drivers built into the modules.  So we can replace them with compat-wireless. <br><br>  First of all, we put everything necessary on the computer: <br><pre> <code class="bash hljs">apt-get install git build-essential fakeroot kernel-package u-boot-tools zlib1g-dev libncurses5-dev</code> </pre><br>  And we add this repository to the <code>/etc/apt/sources.list</code> file: <br><pre> <code class="bash hljs">deb http://www.emdebian.org/debian/ unstable main</code> </pre><br>  Next, update apt and set the cross compiler: <br><pre> <code class="bash hljs">apt-get update apt-get install emdebian-archive-keyring apt-get install gcc-4.7-arm-linux-gnueabihf ln -sf `<span class="hljs-built_in"><span class="hljs-built_in">which</span></span> arm-linux-gnueabihf-gcc-4.7 ` /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/arm-linux-gnueabihf-gcc</code> </pre><br>  Next, we need to download the kernel source code from the githaba.  Clone the repository yourself, go to the source folder and switch to version 3.4: <br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/linux-sunxi/linux-sunxi linux-sunxi <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> linux-sunxi git checkout sunxi-3.4</code> </pre><br>  Next, download the base kernel configuration <a href="https://romanrm.net/dl/a10/kernels/server-3.4/3.4.43-r2-s-rm3%252B/config-3.4.43-r2-s-rm3%252B.txt">file</a> , rename it to <code>.config</code> and put it in the root folder of the source code.  Now a little configuration.  We need to set everything related to 80211 to module mode.  To do this, perform: <br><pre> <code class="bash hljs">ARCH=arm make menuconfig</code> </pre><br>  This command builds the pseudographic kernel configuration utility.  We select in it <code>Networking</code> , then <code>Wireless</code> .  Select the following lines one by one and press the M key on the keyboard: <br><pre> <code class="bash hljs">cfg80211 - wireless configuration API Common routines <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> IEEE802.11 drivers Generic IEEE 802.11 Networking Stack (mac80211)</code> </pre><br>  As a result, there should be something like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/7d9/181/4b4/7d91814b4c83a04dc5e3d27983ffe9d0.jpg"><br>  Next, click <code>Exit</code> and <code>Exit</code> again.  We get to the main menu, scroll down and click <code>Save an Alternate Configuration File</code> .  Confirm and exit the utility. <br>  Everything, we have configured a kernel, now it is possible to collect.  We execute the following commands: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ARCH=arm <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> DEB_HOST_ARCH=armhf <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> CONCURRENCY_LEVEL=`grep -m1 cpu\ cores /proc/cpuinfo | cut -d : -f 2` fakeroot make-kpkg --arch arm --cross-compile arm-linux-gnueabihf- --initrd --append-to-version=-mykernel kernel_image kernel_headers make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- EXTRAVERSION=-mykernel uImage cp arch/arm/boot/uImage ../uImage</code> </pre><br>  As a result, after compilation in the directory level up there will be 3 files: a package with a kernel, a package with sources, and a uImage.  The flash drive with the image has not yet been disabled?  We go there, fill all 3 files somewhere in the root root.  Next, insert the USB flash drive into the board, with the help of SSH we put the kernel and source packages.  Turning off, stick back into the computer.  Next, go to the section with the kernel (there are files script.bin, uImage, etc.) and copy there with the replacement of the new uImage from the root of the second section.  Boot with the new kernel and again, in the SSH terminal, we prescribe the commands: <br><pre> <code class="bash hljs">ln -s /usr/src/linux-headers-$(uname -r) /lib/modules/$(uname -r)/<span class="hljs-built_in"><span class="hljs-built_in">source</span></span> ln -s /usr/src/linux-headers-$(uname -r) /lib/modules/$(uname -r)/build</code> </pre><br>  Everything, now the system is ready to compile drivers. <br><br><h4>  We continue to collect drivers </h4><br>  Go to the folder to the unpacked compat-wireless (remember downloaded?).  We carry out: <br><pre> <code class="bash hljs">./scripts/driver-select rt2x00 make make install</code> </pre><br>  Next you need to write in the blacklist "old" driver.  We add the following lines to the <code>/etc/modprobe.d/blacklist.conf</code> file: <br><pre> <code class="bash hljs">blacklist rt2870sta blacklist rt5370sta</code> </pre><br>  We are overloaded. <br><br><h4>  Configuring the router itself </h4><br>  So, it's time to install everything you need to distribute the Internet and the organization of the local network.  I chose dnsmasq as the DHCP server, hostapd will control the access point, and the connection with the provider will be provided by the pppoeconf utility.  I will not consider setting up a firewall using iptables here, since there is a lot of information on this case on the Internet, but I‚Äôll show only basic forwarding.  He is vital to us.  So, drove. <br>  We connect again via SSH and put everything you need: <br><pre> <code class="bash hljs">apt-get install hostapd dnsmasq pppoeconf</code> </pre><br><br><h5>  1. Configure hostapd </h5><br>  hostapd - utility for creating and managing software WiFi access point.  It has 2 places from which you can customize it. <br>  The first is <code>/etc/default/hostapd</code> .  Setup autorun.  Replace all the scribbling there with the following lines: <br><pre> <code class="bash hljs">RUN_DAEMON = yes DAEMON_CONF=<span class="hljs-string"><span class="hljs-string">"/etc/hostapd/hostapd.conf"</span></span></code> </pre><br>  Second place - <code>/etc/hostapd/hostapd.conf</code> .  Basic settings.  You can configure a lot of parameters here, but I will only give my configuration and explain what and why I entered there: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ,    : interface=wlan0 #   : driver=nl80211 #   : ssid=MyAP #  ,       : country_code=RU #  : hw_mode=g # ,     : channel=8 #       : macaddr_acl=0 auth_algs=1 wpa=2 wpa_key_mgmt=WPA-PSK wpa_pairwise=TKIP rsn_pairwise=CCMP #   : wpa_passphrase=superpass</span></span></code> </pre><br><br><h5>  2. Configure dnsmasq </h5><br>  dnsmasq - DHCP-DNS-TFTP-server with an intuitive configuration file and a number of cookies.  It also has a configuration file in <code>/etc/default/</code> , but we will not touch it, because there is nothing interesting there.  Let's deal with the main config - <code>/etc/dnsmasq.conf</code> .  As with hostapd, I will show and tell you about my configuration option: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ,   : interface=wlan0 # ,         (    ,    ): except-interface=ppp0 #  : bind-interfaces cache-size=1000 domain-needed bogus-priv #          : dhcp-authoritative # . -    : dhcp-lease-max=100 #    (c, ,  ): dhcp-range=192.168.1.5,192.168.1.100,12h</span></span></code> </pre><br><br>  3. Configuring Interfaces <br>  The next step is to configure the interfaces, since their configuration is needed to properly configure a PPPoE connection.  As you know, interfaces are configured in the / etc / network / interfaces file.  We bring him to this form: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  ,  : auto lo iface lo inet loopback # ,  : auto eth0 iface eth0 inet dhcp #  : auto wlan0 iface wlan0 inet static #     : address 192.168.1.1 #  : netmask 255.255.255.0 #  : broadcast 192.168.1.255</span></span></code> </pre><br><br><h5>  4. Configure PPPoE </h5><br>  The pppoeconf utility provides a pseudographic interface for semi-automatic configuration of the connection with the provider.  This is done by typing the same command in the terminal: <br><pre> <code class="bash hljs">pppoeconf</code> </pre><br>  Then everything is intuitively clear, after a successful configuration, the following entry is added to the network interface configuration file: <br><pre> <code class="bash hljs">auto ppp0 iface ppp0 inet ppp pre-up /sbin/ifconfig eth0 up provider dsl-provider</code> </pre><br><br><h5>  5. Basic forwarding </h5><br>  The last step is setting up packet forwarding from the local network to the external network and back ( <a href="http://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B0%25D1%2581%25D0%25BA%25D0%25B0%25D1%2580%25D0%25B0%25D0%25B4%25D0%25B8%25D0%25BD%25D0%25B3">masquerading</a> ). <br>  Perform the following to install this very MASQUERADE and autoload the configuration in iptables at system startup: <br><pre> <code class="bash hljs">iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE iptables -A FORWARD -o eth0 -j ACCEPT iptables -A FORWARD -o ppp0 -j ACCEPT iptables-save &gt; /etc/wifi-iptables.conf <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'#!/bin/sh'</span></span> &gt; /etc/network/<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-up.d/iptables <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'iptables-restore &lt; /etc/wifi-iptables.conf'</span></span> &gt;&gt; /etc/network/<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-up.d/iptables chmod +x /etc/network/<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-up.d/iptables</code> </pre><br>  Rebooting ... <br><br><h4>  Instead of conclusion </h4><br>  Fuuuhhh, well, that's all.  Are you tired?  But now we have a working router based on a rather smart board, and with such a good adapter.  According to my tests, ping in online games does not exceed 15-25ms, and in 2 weeks of uptime, the entire system has stopped once, which has been cured by jerking power. <br>  Speaking of nutrition.  It turned out that for stable operation of the device together with an adapter, a power supply is required that is designed for a power of at least 1000mA.  Please note, <b>impulse</b> chargers <b>are not suitable</b> !  Do not get fooled by the coincidence of the plugs! <br><br>  Finally, I want to express my gratitude to the person with the nickname RM and his wonderful <a href="https://romanrm.net/ru">resource</a> . <br>  PS: I will be very grateful for constructive criticism, but I will <u>emphasize that it is not necessary to spit on foam here</u> .  If you know how to reduce the number of steps or make something better, share it, I will update the article. </div><p>Source: <a href="https://habr.com/ru/post/197862/">https://habr.com/ru/post/197862/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../197846/index.html">Luxoft launches a series of free IT webinars with famous speakers</a></li>
<li><a href="../197854/index.html">ARM64 and you</a></li>
<li><a href="../197856/index.html">Price collapse! Dedicated servers in the Netherlands and the United States with a channel guarantee of 100 Mbit / s from $ 49 / month!</a></li>
<li><a href="../197858/index.html">Art. Lebedev Studio began selling Optimus Popularis keyboard</a></li>
<li><a href="../197860/index.html">What is MANET or why WiFi is not the solution to all telecommunication problems</a></li>
<li><a href="../197864/index.html">Decentralization of site content</a></li>
<li><a href="../197866/index.html">Kindle Paperwhite 2013 review: the second generation is better</a></li>
<li><a href="../197870/index.html">Github for governments</a></li>
<li><a href="../197874/index.html">Term for torrents or the Lopukhov family case. Judicial precedent for new law enforcement practice</a></li>
<li><a href="../197878/index.html">Lightweight FPV tricopter: development, assembly, configuration</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>