<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write our simplified OpenGL on Rust - part 1 (draw a line)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continued : 
 We write our simplified OpenGL on Rust - part 2 (wire rendering) . 
 We write our simplified OpenGL on Rust - part 3 (rasterizer) 

 Pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write our simplified OpenGL on Rust - part 1 (draw a line)</h1><div class="post__text post__text-html js-mediator-article">  <b>Continued</b> : <br>  <a href="http://habrahabr.ru/post/261739/">We write our simplified OpenGL on Rust - part 2 (wire rendering)</a> . <br>  <a href="http://habrahabr.ru/post/262235/">We write our simplified OpenGL on Rust - part 3 (rasterizer)</a> <br><br>  Probably, few people in Habr√© are not aware of what Rust is - a new programming language from Mozilla.  Already, it has attracted a lot of interest, and recently the first stable version of Rust 1.0 has finally come out, which marks the stabilization of language capabilities.  I have always been impressed with system PL, and the idea of ‚Äã‚Äãa system language offering security that exceeds superior high-level languages ‚Äã‚Äãis even more interesting.  I wanted to try a new language in business and, at the same time, have an interesting time, programming something exciting.  While I was thinking what to write about such a thing, I recalled a recent <a href="http://habrahabr.ru/post/248153/">series of articles</a> on computer graphics, which I just skimmed.  And it would be very interesting to try to still write all these beautiful things on your own.  This is how the idea of ‚Äã‚Äãthis hobby project, as well as this article, was born. <br><br>  Since the original article thoroughly chews all the nuances related to programming directly the graphic component, I will focus in my article series mainly on what concerns Rust directly.  I will try to describe those rakes, which had a chance to stumble, as well as how to solve the problems that arise.  I will tell about personal impressions from acquaintance with language.  And, of course, I will mention the list of resources that I used during development.  So, anyone interested, welcome under cat. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Warning: the article is written from the perspective of a novice and describes the stupid mistakes of a novice.  If you are a rasta pros, perhaps looking at my attempts, you will want to hurt me with something heavy.  In this case, I recommend to refrain from reading it. <br><br><img src="https://habrastorage.org/files/b91/b69/e03/b91b69e03d194248ab653a4019314d13.jpg"><br>  <i>Here is the Rust, which i hope to get at the end.</i>  <i>(pun, Rust in English "rust")</i> <br><a name="habracut"></a><br><h2>  Training </h2><br>  I will not describe the installation of the compiler, everything is quite obvious there.  The installation package from the official site was installed on my Ubuntu 14.04 pair of commands.  It should only be noted that there is a <a href="https://launchpad.net/~hansjorg/%2Barchive/ubuntu/rust">repository</a> for Ubuntu, using which you can also theoretically install Rust.  However, I have not wondered with this repository.  For some reason, Rust was installed, but without Cargo.  Synaptic did not even show Cargo in the list of available packages.  Rust without Cargo is a pretty pointless thing, so I did not use the specified PPA. <br><br>  So, as always, we begin our acquaintance with the new language with Hello World.  Create the file main.rs: <br><br><div class="spoiler">  <b class="spoiler_title">Hello world</b> <div class="spoiler_text"><pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() { <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span>); }</code> </pre> <br>  The result of running this in the console is obvious: <br><pre> <code class="bash hljs">user@user-All-Series:~$ rustc main.rs user@user-All-Series:~$ ./main Hello World! user@user-All-Series:~$</code> </pre><br></div></div><br>  You can write code using gedit.  Rust syntax coloring for this editor can be found at the following <a href="https://github.com/rust-lang/gedit-config">link</a> .  It did not work <a href="https://github.com/rust-lang/gedit-config/issues/6">right away</a> , but there was a <a href="https://github.com/rust-lang/gedit-config/issues/6">bug report</a> in the tracker that explained the cause of the problem.  A simple <a href="https://github.com/rust-lang/gedit-config/pull/7">pull request</a> solved the problem, so now you have to earn the colors without any extra dancing with a tambourine. <br><br>  Usually, a new project is created using the <code>cargo new rust_project --bin</code> , but I still didn‚Äôt know about it, so I created the whole structure manually, since it‚Äôs not difficult: <br><br><div class="spoiler">  <b class="spoiler_title">The structure of the new project</b> <div class="spoiler_text"><pre> <code class="bash hljs">Cargo.toml src/main.rs</code> </pre><br>  Content Cargo.toml: <br><pre> <code class="bash hljs">[package] name = <span class="hljs-string"><span class="hljs-string">"rust_project"</span></span> version = <span class="hljs-string"><span class="hljs-string">"0.0.1"</span></span> authors = [ <span class="hljs-string"><span class="hljs-string">"Cepreu &lt;cepreu.mail@gmail.com&gt;"</span></span> ]</code> </pre><br>  This project is launched by the <code>cargo run</code> team. <br></div></div><br>  To display the image, I decided not to rewrite the TGAImage, which is provided by the author of the original article.  I wanted to output the result using SDL.  In fact, we only need from this library to create a window and display a point with the specified color according to the given coordinates.  We draw all the other graphic primitives ourselves, so if you wish, you can change the image output backend simply by implementing 2 functions: <code>set(x, y, color);</code>  and <code>new(xsize, ysize)</code> .  Why SDL?  In the future, I would like to be able to change the point of view from the keyboard.  It may even be a simple toy to write ... TGA will not allow this. <br><br>  The very first link to Google led me to the site of the project <a href="https://github.com/AngryLawyer/rust-sdl2">Rust-SDL2</a> - binding to SDL2 for Rust.  To enable this library, add the following dependency declaration to the end of cargo.toml: <br><br><pre> <code class="bash hljs">[dependencies] sdl2 = <span class="hljs-string"><span class="hljs-string">"0.5.0"</span></span></code> </pre><br>  This adds to the project so-called.  container (crate) sdl2.  The library uses SDL header files for compilation, so you need to remember to install them.  On Ubuntu 14.04, the command does this: <br><br><pre> <code class="bash hljs">sudo apt-get install libsdl2-dev</code> </pre><br>  After this, the <code>cargo build</code> team will successfully <code>cargo build</code> us a project with all the necessary dependencies. <br><br><pre> <code class="bash hljs">user@user-All-Series:~/temp/rust_project$ cargo build Updating registry `https://github.com/rust-lang/crates.io-index` Downloading num v0.1.25 Downloading rustc-serialize v0.3.15 Compiling sdl2-sys v0.5.0 Compiling rustc-serialize v0.3.15 Compiling libc v0.1.8 Compiling bitflags v0.2.1 Compiling rand v0.3.8 Compiling num v0.1.25 Compiling sdl2 v0.5.0 Compiling rust_project v0.1.0 (file:///home/user/temp/rust_project) user@user-All-Series:~/temp/rust_project$</code> </pre><br><h2>  SDL Experiments </h2><br>  I decided to bring all the functionality related to the interaction with SDL (or another graphic library in perspective) into a separate class, canvas.rs.  At first, just to test the library, I copied the contents of the <a href="">test there</a> from the Rust-SDL2 repository, going to write a finished class on the basis of it. <br><br>  Here I had the first rake.  It turned out that any <code>extern crate package_name</code> in the library should also be duplicated in the main.rs application.  It took time to figure it out, but after all the torment, I finally got a project that you can see in the <a href="https://github.com/cepreu2github/rust-3d-renderer/tree/fdc82f2f05804b403f432feffcbf9ce64dd85a7f">snapshot on github</a> . <br><br>  As a result, the following code in the canvas.rs file was: <br><br><pre> <code class="rust hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright (C) Cepreu &lt;cepreu.mail@gmail.com&gt; under GPLv2 and higher extern crate sdl2; use sdl2::pixels::PixelFormatEnum; use sdl2::rect::Rect; use sdl2::keyboard::Keycode; pub fn test() { let mut sdl_context = sdl2::init().video().unwrap(); let window = sdl_context.window("rust-sdl2 demo: Video", 800, 600) .position_centered() .opengl() .build() .unwrap(); let mut renderer = window.renderer().build().unwrap(); // </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">FIXME:</span></span></span><span class="hljs-comment"> rework it let mut texture = renderer.create_texture_streaming(PixelFormatEnum::RGB24, (256, 256)).unwrap(); // Create a red-green gradient texture.with_lock(None, |buffer: &amp;mut [u8], pitch: usize| { for y in (0..256) { for x in (0..256) { let offset = y*pitch + x*3; buffer[offset + 0] = x as u8; buffer[offset + 1] = y as u8; buffer[offset + 2] = 0; } } }).unwrap(); renderer.clear(); renderer.copy(&amp;texture, None, Some(Rect::new_unwrap(100, 100, 256, 256))); renderer.copy_ex(&amp;texture, None, Some(Rect::new_unwrap(450, 100, 256, 256)), 30.0, None, (false, false)); renderer.present(); let mut running = true; while running { for event in sdl_context.event_pump().poll_iter() { use sdl2::event::Event; match event { Event::Quit {..} | Event::KeyDown { keycode: Some(Keycode::Escape), .. } =&gt; { running = false }, _ =&gt; {} } } } }</span></span></code> </pre><br>  This code displays such a wonderful window: <br><div class="spoiler">  <b class="spoiler_title">Screenshot</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/da2/fc9/730/da2fc973036f4fffb56ffe382a758fef.png"><br></div></div><br><h2>  Write the code </h2><br>  If you look at the code itself, there are obvious 3 parts: initialization, drawing, waiting for input.  The next item we have processing of the specified code in order to obtain a Canvas object, which has: <br><ul><li>  constructor making the necessary initialization </li><li>  point output function (instead of current texture output) </li><li>  keyboard input Esc hold function </li></ul><br>  I know that keyboard input is not the most suitable function for the Canvas class, but the problem was that sdl_context is used to wait for input, which after such a change would become a Canvas field.  Which in any case leads to the fact that either the Keyboard object will depend on the Canvas, or both of them will have to depend on some 3rd class.  In order not to complicate everything excessively, while he stopped at how to leave everything in one class.  If the load on the Canvas increases, then I will take some of the functions out of it and still do the work described above. <br><br>  It is worth noting that before this, my development process was well characterized by the words ‚ÄúStack Overflow Driven Development‚Äù.  I just pulled different pieces of code from different places and put them together without even knowing the syntax of the language.  This is a typical way for me to learn a new language or technology - just start writing code.  I refer to various resources as a reference book in order to understand how to make a specific piece I need.  Need a cycle, read the article about cycles in the language.  It is necessary IoC, the good answer on Stackoverflow.  Well, you understand.  Most languages ‚Äã‚Äãand technologies are quite similar, so there are no problems with this approach.  You can start programming right away, even without really knowing the language.  With Rust, this number did not work.  The language is rather peculiar and already trying to understand how to make a class or an object, a plug has occurred.  In the <a href="https://doc.rust-lang.org/book/">book of Rasta</a> there were no articles with the name Classes / Objects / Constructors, etc. It became clear that at first it was necessary to learn a little about the hardware.  Therefore, in order to get a general impression of the syntax of the language, the lessons of <a href="https://doc.rust-lang.org/book/guessing-game.html">Guessing Game</a> and <a href="https://doc.rust-lang.org/book/dining-philosophers.html">Dining Philosophers</a> from Rust‚Äôs official documentation were taken.  She is in English, it is worth noting the existence of a <a href="https://www.gitbook.com/book/kgv/rust_book_ru/details">translation into Russian</a> .  But then I did not know this, I read it in the original language. <br><br>  In general, after that, the work went.  Although still had to make war with the system of ownership and borrowing Rust.  The official documentation notes that every beginner goes through this stage, but encourages us that, as far as practice goes, the code can be written easily and naturally, getting used to the restrictions imposed by the compiler.  The introduction states that the complexity of learning is the price that has to be paid for security without overhead.  Specifically, the problem was that in the new () method that creates the structure, the fields of the newly created structure need to be initialized with several objects from the SDL in order to use them in the structure methods.  If I tried to initialize the field with a link, the compiler cursed what variable borrowing could not do.  Here in this code: <br><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Canvas</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'_</span></span>&gt; { renderer: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'_</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Renderer&lt;<span class="hljs-symbol"><span class="hljs-symbol">'_</span></span>&gt;, } ... <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span></span>(x: <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>, y: <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>) -&gt; Canvas&lt;<span class="hljs-symbol"><span class="hljs-symbol">'_</span></span>&gt; { ... <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> renderer = window.renderer().build().unwrap(); Canvas { renderer: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> renderer } }</code> </pre><br>  By the way, on Habr√©, the syntax highlighting of Rust is broken, which is why the code above does not color up, although it should.  The problem with this piece is: <code>&lt;'_&gt;</code> .  If you remove it, then everything is colored normal.  But you can‚Äôt remove it here.  This designation of lifetime (lifetime) is quite a correct syntax for Rust.  I do not know where to write it, so I wrote here.  Hope repaired. <br>  Just <code>name: mut type</code> in structures cannot be written.  Then I tried to make the variable immutable, but this broke another code: <br><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Canvas</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'_</span></span>&gt; { renderer: Renderer&lt;<span class="hljs-symbol"><span class="hljs-symbol">'_</span></span>&gt;, } ... <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span></span>(x: <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>, y: <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>) -&gt; Canvas&lt;<span class="hljs-symbol"><span class="hljs-symbol">'_</span></span>&gt; { ... <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> renderer = window.renderer().build().unwrap(); Canvas { renderer: renderer } } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">point</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, x: <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>, y: <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>) { ... <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.renderer.clear(); ... }</code> </pre><br>  The compiler complained that it cannot borrow the immutable field renderer as changeable ( <code>error: cannot borrow immutable field `self.renderer` as mutable</code> ).  Casket opened simply.  It turns out in Rust all fields in the structure are considered as changeable or immutable, depending on whether the structure itself was passed to the method as changeable or unchangeable.  So the correct code is: <br><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Canvas</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'_</span></span>&gt; { renderer: Renderer&lt;<span class="hljs-symbol"><span class="hljs-symbol">'_</span></span>&gt;, } ... <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span></span>(x: <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>, y: <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>) -&gt; Canvas&lt;<span class="hljs-symbol"><span class="hljs-symbol">'_</span></span>&gt; { ... <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> renderer = window.renderer().build().unwrap(); Canvas { renderer: renderer } } <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">point</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, x: <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>, y: <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>) { ... <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.renderer.clear(); ... }</code> </pre><br>  As you can see, here I have changed the signature of the point method. <br><br>  <b>Now a little more about the rake:</b> <br>  There were great difficulties in working with code interacting with the Rust-SDL2 library.  She has documentation, but so far there is little to say, and the existence of some methods is generally silent.  For example, there is nothing about the sdl2 :: init () method in the documentation.  As if it does not exist.  The automatic type inference system Rust simplifies and speeds up writing code, but it also played a cruel joke on me when I needed to figure out what type the call returns to sdl2 :: init (). Video (). Unwrap (), because this the result had to be stored in the field in the structure, and there the type is clearly indicated always.  I had to read the library source, although a little later I found a less laborious way out.  You simply indicate any arbitrary type of the field, Rust when compiling swears at the type mismatch, displaying the type that should be in the error message.  Voila! <br><br>  Special mention deserves such a thing as the lifetime (lifetime) in Rust.  I fought with her for a long time.  Generally speaking in Rust each variable and link has its lifetime.  Simply, it is output automatically by the compiler based on certain rules.  However, sometimes it needs to be explicitly indicated  Reading an <a href="https://doc.rust-lang.org/book/lifetimes.html">article</a> about the lifetime from the book of rasta did not clarify anything for me.  (although I re-read it 3 times) I did not understand why in my case Rust asked for a lifetime.  In fact, I simply added these strange <code>&lt;'_&gt;</code> wherever the compiler pointed out an error with an unspecified lifetime, without understanding why he needed it from me.  If there are knowledgeable people, I will be glad if you enlighten in the comments.  Why exactly underlined, and not some other sign after the apostrophe?  Just in the error message about the type mismatch was <code>sdl2::render::Renderer&lt;'_&gt;</code> .  At first, I tried to designate the field as just <code>renderer: Renderer</code> , but the compiler scolded me: <code>error: wrong number of lifetime parameters: expected 1, found 0</code> .  <b>UPD:</b> <a href="https://habrahabr.ru/users/googolplex/" class="user_link">Googolplex</a> explained this point in his <a href="http://habrahabr.ru/post/261629/">comments</a> .  The call to <code>window.renderer().build().unwrap()</code> returns <code>sdl2::video::Renderer&lt;'static&gt;</code> .  The focus on the lifetime parameter is' static.  This is a special lifetime, denoting something that can live to the end of the entire program.  Thus, the correct structure declaration looks like this: <br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Canvas</span></span></span></span> { renderer: Renderer&lt;<span class="hljs-symbol"><span class="hljs-symbol">'static</span></span>&gt;, ... }</code> </pre><br>  In other parts of the code, all references to the lifetime can be removed. <br><br><img src="https://habrastorage.org/files/6c9/357/c1c/6c9357c1c66843dda5ad6b0c9867d21f.png"><br><br>  I think my troubles may seem to someone as experiments of a monkey with a grenade.  But I warned you. <br><br><h2>  Write the line </h2><br>  In general, after solving all the problems described above, the result of my work was what you can see in the <a href="https://github.com/cepreu2github/rust-3d-renderer/tree/799332229a4d75300b375f30e616018b712f1dc8">repository section</a> .  Oh, that feeling of delight when I finally saw on the screen a black window with a small white dot in the center ... <br><div class="spoiler">  <b class="spoiler_title">Point</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/26f/31c/5b3/26f31c5b396e48cb8569ba73136272fe.png"><br></div></div><br>  Then it went easier, because serious interaction with the Rust-SDL2 library was no longer required.  Its unobvious and undocumented, sometimes even unfinished API was a constant source of difficulties.  Any arithmetic and control constructs in Rust are not too different from other PLs.  Therefore, the line was written in just a few hours (as opposed to a few days in the previous stages).  And most of the work was due to the fact that I decided not to implement the finished algorithm, but to write my own, using the equation of the straight line <i>y = kx + b</i> , as a basis, and deriving all the other formulas myself.  This is the function I got in the end: <br><br><pre> <code class="rust hljs"> <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">line</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, x1: <span class="hljs-built_in"><span class="hljs-built_in">i32</span></span>, y1: <span class="hljs-built_in"><span class="hljs-built_in">i32</span></span>, x2: <span class="hljs-built_in"><span class="hljs-built_in">i32</span></span>, y2: <span class="hljs-built_in"><span class="hljs-built_in">i32</span></span>, color: <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x1 == x2) &amp;&amp; (y1 == y2) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.set(x1, y1, color); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x1-x2).abs() &gt; (y1-y2).abs() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x1 &lt; x2 { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> yi = y1; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> xi <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> x1..x2+<span class="hljs-number"><span class="hljs-number">1</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> p = (y2-y1)*xi + x2*y1 - x1*y2; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> yi*(x2-x1) &lt; p + (y2-y1)/<span class="hljs-number"><span class="hljs-number">2</span></span> { yi = yi+<span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.set(xi, yi, color); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> yi = y2; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> xi <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> x2..x1+<span class="hljs-number"><span class="hljs-number">1</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> p = (y1-y2)*xi + x1*y2 - x2*y1; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> yi*(x1-x2) &lt; p + (y1-y2)/<span class="hljs-number"><span class="hljs-number">2</span></span> { yi = yi+<span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.set(xi, yi, color); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> y1 &lt; y2 { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> xi = x1; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> yi <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> y1..y2+<span class="hljs-number"><span class="hljs-number">1</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> p = yi*(x2-x1) - x2*y1 + x1*y2; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> xi*(y2-y1) &lt; p + (y2-y1)/<span class="hljs-number"><span class="hljs-number">2</span></span> { xi = xi+<span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.set(xi, yi, color); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> xi = x2; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> yi <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> y2..y1+<span class="hljs-number"><span class="hljs-number">1</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> p = yi*(x1-x2) - x1*y2 + x2*y1; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> xi*(y1-y2) &lt; p + (y1-y2)/<span class="hljs-number"><span class="hljs-number">2</span></span> { xi = xi+<span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.set(xi, yi, color); } } } }</code> </pre><br>  I know she is ugly, long, ineffective.  But his own - my own.  :) I almost immediately came to write the integer version without using real arithmetic.  Rust has no implicit type conversions, and explicit ones are very verbose.  Therefore, I refused to write the idea of ‚Äã‚Äãwriting the real version first.  It is a lot of code, and then all the same as a result to rewrite it, so that it does not slow down. <br><br><div class="spoiler">  <b class="spoiler_title">But the photo of my calculations on a piece of paper (for history)</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/d95/e9f/93e/d95e9f93e5b243198bf69b9b60c184a1.jpg"><br>  Connoisseurs of mathematics, please do not kick.  Everything was done just for fun. <br></div></div><br>  In the course of writing this footcloth, I needed logging, as there is no time-tested IDE for Rust.  There are some fresh ones, but I didn‚Äôt want to stick to their beta (alpha?) Test.  If someone has used it and saw that it is stable and works well, please post it in the comments.  Using a <a href="http://stackoverflow.com/a/15877760">debugger from the console</a> is not my joy.  And in general logging thing is useful.  I try to train myself to use the logs instead of the debugger, because it helps to write logs, which then really understand what the end user has a problem (at least if he can run debug in the logging mode). <br><br>  So logging.  For logging, Rust has a log library.  But this is just an abstract API, and you have to choose the concrete implementation of it yourself.  I used env_logger, which is offered in the log documentation.  We write the following in cargo.toml: <br><br><pre> <code class="bash hljs">[dependencies] sdl2 = <span class="hljs-string"><span class="hljs-string">"0.5.0"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> = <span class="hljs-string"><span class="hljs-string">"0.3"</span></span> env_logger = <span class="hljs-string"><span class="hljs-string">"0.3"</span></span></code> </pre><br>  Using this set is very simple: <br><br><pre> <code class="rust hljs"><span class="hljs-meta"><span class="hljs-meta">#[macro_use]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">crate</span></span> log; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">crate</span></span> env_logger; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() { env_logger::init().unwrap(); info!(<span class="hljs-string"><span class="hljs-string">"starting up"</span></span>);</code> </pre><br>  You just need to remember that the container (crate) env_logger is configured using environment variables.  I use the following command before starting the project: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span> RUST_LOG=rust_project=debug</code> </pre><br>  This sets the rust_project module with a debug logging level.  All other modules remain with the default level, so the log when the program starts is not clogged with any debugging garbage from cargo or sdl.  The result of work at this stage can be seen in the <a href="https://github.com/cepreu2github/rust-3d-renderer/tree/37376e7711bd8a94503862e4bf91019b2e268fd8">repository section</a> .  When launching, our program displays this beauty: <br><br><img src="https://habrastorage.org/files/b46/e60/ad6/b46e60ad63f54792a9c996323543ced2.png"><br><br>  Just what was needed in accordance with the original article.  Only the color of the second line I changed to blue.  The article has already turned out quite long, so for today I‚Äôm finishing.  Future plans: <br><ul><li>  rewrite your scary line () function to the one proposed in the original article as an end result </li><li>  write wire render </li><li>  Continue on the lessons of the Short Course in Computer Graphics. </li></ul><br>  Finally, a small portion of personal impressions of the language. <br><br><h2>  Impressions </h2><br>  All these are my subjective pros and cons.  I do not write about what I read somewhere.  And only with what he personally encountered during the development.  For example, I know that Rust is safe, but so far this chip of his shot has not saved me anywhere in the leg (as far as I can tell), so far I can not appreciate it. <br>  Cons programming on Rust: <br><ul><li>  Hard to learn. </li><li>  There is still little easy to understand documentation, third-party libraries are generally documented anyway. </li></ul><br>  Pros: <br><ul><li>  The compiler will check the stylistic characteristics of the code and display warnings if the style is different from the one proposed by the developers.  I, as a lover of maintaining the same style in the project, are very impressed. </li><li>  Many things are also easily written, as in high-level languages, but the language is compiled and systemic. </li><li>  Love for good practice in the standard library.  For example, env_logger is configured from environment variables, which corresponds to one of the <a href="http://habrahabr.ru/post/258739/">12 factors from Heroku</a> . </li><li>  Cargo.  Then you and the project life cycle management and dependency resolution and testing.  All this is relatively new, but already recognized utility.  And it is in the standard language delivery.  Not bad meets the definition of "System language of the 21st century." </li></ul><br><br><h2>  At last </h2><br>  If I do not weaken, do not tear, do not be angry, I will write a sequel.  :) And, of course, if I‚Äôm not sent to Read-only for this article. </div><p>Source: <a href="https://habr.com/ru/post/261629/">https://habr.com/ru/post/261629/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261619/index.html">Release of the Qt 5.5 framework</a></li>
<li><a href="../261621/index.html">Corporate Laboratories - Information Security Training Program</a></li>
<li><a href="../261623/index.html">StorIO - human API for working with SQLiteDatabase and ContentResolver</a></li>
<li><a href="../261625/index.html">Effective resizing of images using ImageMagick</a></li>
<li><a href="../261627/index.html">Changes in the PMP exam in 2015</a></li>
<li><a href="../261631/index.html">Ciklum Kiev invites to Speakers' Corner dedicated to the development for the Apple Watch</a></li>
<li><a href="../261637/index.html">Google Developer Launchpad - Google Startup Program</a></li>
<li><a href="../261641/index.html">Compile-time reflection D, practice</a></li>
<li><a href="../261647/index.html">Apple released iOS 8.4</a></li>
<li><a href="../261649/index.html">Misunderstanding about async / await and multithreading in C #</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>