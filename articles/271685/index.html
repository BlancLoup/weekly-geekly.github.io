<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Spreadsheets under the hood</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There may be multiple tables in our document. The tables have columns, rows, cells, and each of these elements can be pasted, deleted, moved, and edit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Spreadsheets under the hood</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/7f7/afd/c52/7f7afdc52c404bcca1e0e86bf55d911f.jpg"><br><br>  There may be multiple tables in our document.  The tables have columns, rows, cells, and each of these elements can be pasted, deleted, moved, and edited.  As a result of some such operations, it becomes necessary to recalculate formulas.  The highlight of our editor is that we can recalculate only those formulas that really need to be recounted.  That is, the formula, the value of which could change.  In this way, we improve efficiency when editing large documents, and also avoid situations where the value of a cell containing, for example, the RAND function, changes with every editing of a document. <br><a name="habracut"></a><br><h5>  HOW TO CALCULATE FORMULAS? </h5><br>  Before starting the calculations, we need to collect information about the changes in the table, determine which particular formulas should be recounted, and establish the order of calculation. <br>  Consider the simplest option: the formula ‚Äú= 2 + 2‚Äù is entered into an empty cell.  In this case, you just need to calculate the value of this formula. <br>  A more complicated option is when the formula refers to another cell, as shown in Figure 1. Suppose that the value of cell B2 has changed.  Then you need to somehow determine that there is a formula in B1 that refers to our cell, and calculate it, and then calculate the formula in A1. <br><br><img src="https://habrastorage.org/files/abe/676/af0/abe676af0e7247219ef011c6e175bdcd.png"><br>  <i>Fig.</i>  <i>1. An example of a simple relationship between formulas.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this case, the formulas must be calculated strictly in the order in which they refer to each other.  Otherwise, we will use the value of the cell that is not yet counted. <br>  But this option can be complicated if the formulas form a cycle, as shown in Figure 2. <br><br><img src="https://habrastorage.org/files/0dd/06d/462/0dd06d4628e241dfb2bb16196f2ea954.png"><br>  <i>Fig.</i>  <i>2. An example of a cyclic relationship between formulas</i> <br><br>  Before proceeding to the calculation, it is necessary to find the cycles and determine the order in which the formulas are calculated.  Because the cycle may not be like a ring, but be a strongly connected graph, where each vertex depends on each.  Different order of calculation of formulas in the same cycle can lead to different results.  We always guarantee the same result when recalculating cyclic formulas, which most other editors don‚Äôt do. <br><br>  There are two criteria for exiting the cycle: the achievement of the maximum number of iterations and the achievement of a certain accuracy of the result of the calculation.  Until the cycle is computed, we cannot continue to calculate the formulas dependent on it. <br><br>  Additional problems arise with functions of type <b>INDIRECT</b> , which are not directly dependent on the cell.  To determine what determines the formula containing a similar function, you must first calculate the value of the function parameter.  And if this formula falls into a cycle that changes the value of the function parameter and with it the dependence of the formula at each iteration, it turns out that the dependency graph between the formulas can change dynamically during the calculation. <br><br>  From the above we compose the following algorithm for calculating the formulas: <br><ol><li>  Determine which cells have been modified. </li><li>  Find formulas that reference these cells. </li><li>  Build a dependency graph between formulas. </li><li>  Find cycles in the graph. </li><li>  Establish the procedure for calculating formulas. </li><li>  Calculate formulas with the possibility of parallelization of the calculation. </li><li>  If an implicit link is found in the formula and this link has changed as a result of the calculation, it is necessary to run the algorithm from the beginning. </li></ol><br><br><h5>  HOW TO FIND FORMULAS FOR RECEIPT </h5><br>  In the above formula calculation algorithm, the first item is trivial.  Let's take a closer look at the second step: how to determine which formulas refer to our cell. <br><br>  Since the table size is huge - 1.7 * 10 ^ 10 cells, and the formula can refer to a whole column or a whole line, for example, ‚Äú= A: B‚Äù, it does not make sense to store feedback from each cell to the formula.  Rechecking all formulas every time a cell is changed is also inefficient.  We decided to store data on which cells each formula refers to.  Thus, for each table, we store references as coordinates of the upper left and lower right corner of the range.  Now for reference A: B coordinates will look like (0, 0; 1, 1 048 576), where 1 048 576 is the <a href="https://support.office.com/ru-ru/article/%25D0%25A2%25D0%25B5%25D1%2585%25D0%25BD%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B5-%25D1%2585%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D1%2581%25D1%2582%25D0%25B8%25D0%25BA%25D0%25B8-%25D0%25B8-%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BD%25D0%25B8%25D1%2587%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F-Microsoft-Excel-16c69c74-3d6a-4aaf-ba35-e6eb276e8eaa">maximum possible number of rows</a> .  When we find out that a cell has changed (COL, ROW), we can determine which ranges it falls into. <br><br>  Suppose that we have in the document there are N links, and M cells have changed.  Then the maximum possible size of the answer to the question ‚ÄúWhich formulas should be recalculated?‚Äù Can be M * N, if it suddenly turns out that all the ranges overlap and all the cells fall into each of the ranges.  But this is a rare case.  Most often, ranges are sparse and we can think about how to optimize the search so as not to go through all the ranges for each of the cells.  A simple and <a href="http://e-maxx.ru/algo/intersecting_segments">straightforward</a> way to speed up the search a bit - the <a href="http://e-maxx.ru/algo/intersecting_segments">algorithm of a sweeping straight</a> . <br><br>  Let each range have two events - the beginning and the end.  Sort events by the X coordinate. We also sort all changed cells (points) by X. Next, we represent the vertical line that we move along the X axis from point to point, and we support the collection of ranges with which our line intersects.  For the range collection, we chose a hash table, because it is most effective if you want to add and remove items in a random order.  When the event crosses the beginning of the range, add it to the collection; when the end crosses, we delete it.  Thus, for each of the points, we always know which ranges it falls along the X axis. Among them, we will find those that fit on Y by an ordinary search. <br><br>  Consider the example in the figure.  The colored squares indicate the ranges, and the dots on the X axis are events.  Let's go through the list of events to point 1 and see that we entered the red, blue and green ranges.  After that, check each of them along the Y axis and determine that the point falls only in red and blue.  Then we move to point 2 through X. First we see that the red range is over, remove it from the list, then delete the green.  Add yellow.  Point 2 falls in the yellow and blue ranges on the X axis, the same is done for Y. <br><br><img src="https://habrastorage.org/files/08f/72c/ab0/08f72cab05b6487289b8e85a1aee9041.jpg"><br>  <i>Fig.</i>  <i>3. The scheme of the algorithm of the sweeping straight line as applied to the search for the occurrence of points in two-dimensional ranges</i> <br><br>  Although in the worst case, the running time of the algorithm is M * N, on average, the algorithm should work much faster.  Under conditions of a sparse table, the running time may approach N + M * log (M).  Data storage requires M + N memory.  Obviously, this is the lowest possible cost.  There is also a field for further optimizations, which we decided to postpone if we don‚Äôt run into performance problems. <br><br>  Above, we mentioned that the search for ranges along the Y-axis is performed by brute force.  But if a large number of points and ranges coincide along the X axis, you can apply the sweeping straight algorithm to search along the Y axis. To do this, create a list of events sorted along the Y axis for the current ranges.  You do not need to sort the points, it is assumed that they have already been sorted earlier by X and Y. Then the search time along the Y axis will be N * log (N) + M, the optimization can be applied with such M and N, when the condition N * log is satisfied ( N) + M &lt;M * N. <br><br>  In the following articles, we will continue to talk about how we solved the problems of building a dependency graph between formulas, searched for cycles and set the order for calculating formulas in cycles and in a graph, about possible problems and their solutions when calculating functions with implicit dependencies, as well as about parallelizing calculations. <br><br>  See you. </div><p>Source: <a href="https://habr.com/ru/post/271685/">https://habr.com/ru/post/271685/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../271675/index.html">Return support for Windows XP in the new assembly Vivaldi 1.0.334.3</a></li>
<li><a href="../271677/index.html">Bitwise sorting with a human face</a></li>
<li><a href="../271679/index.html">What's new in the field of data storage</a></li>
<li><a href="../271681/index.html">Young hackers 414s</a></li>
<li><a href="../271683/index.html">Come November 26th to Visual Studio Workshop</a></li>
<li><a href="../271687/index.html">Httplug - abstraction from HTTP client for PHP</a></li>
<li><a href="../271689/index.html">Developing your own solution: risks and responsibilities</a></li>
<li><a href="../271693/index.html">We write software for generating music card data. Part one: parse the MIDI file</a></li>
<li><a href="../271695/index.html">Developer Economics Tenth Study</a></li>
<li><a href="../271697/index.html">Machine Learning Hackathon: Come. To train a model. To win</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>