<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using V8</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="V8 is a JavaScript engine from Google that is used in the Chrome browser. It is fast and is available in source codes (C ++) for Linux (more precisely...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using V8</h1><div class="post__text post__text-html js-mediator-article"> V8 is a JavaScript engine from Google that is used in the Chrome browser.  It is fast and is available in source codes (C ++) for Linux (more precisely for gcc) and under Windows. <br><br>  In the light of the growing popularity of using V8, I decided to share my (one-year) experience of using it on the Windows platform as a server-side scripting engine. <br><br>  Part 1. Introduction and the simplest program that uses V8. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  <b>- Installation, assembly and addition to your project</b> <br><br>  So, V8 is a fast JavaScript engine (ECMA-262) from Google, used in the Chrome browser: <br><br>  <a href="http://code.google.com/p/v8/">code.google.com/p/v8</a> <br><br>  V8 is available in source code under BSD license: <br><br>  <a href="http://code.google.com/intl/ru-RU/apis/v8/terms.html">code.google.com/intl/en-RU/apis/v8/terms.html</a> <br><br>  I'll tell you how to build it under MS Visual Studio Express Edition 2008. Installation for Windows is described here: <br><br>  <a href="http://code.google.com/p/v8/wiki/BuildingOnWindows">code.google.com/p/v8/wiki/BuildingOnWindows</a> <br><br>  So, install: <br><br>  python <br><br>  <a href="http://www.python.org/download/windows/">www.python.org/download/windows</a> <br><br>  scons <br><br>  <a href="http://www.scons.org/download.php">www.scons.org/download.php</a> <br><br>  subversion <br><br>  for example, <a href="">www.sliksvn.com/pub/Slik-Subversion-1.6.5-win32.msi</a> <br><br>  Then add paths to the python, scons and subversion binaries in the PATH. <br><br>  Download the current V8 sources from the trunk branch (stable): <br><br> <code><a href="http://v8.googlecode.com/svn/trunk/"></a> svn checkout v8.googlecode.com/svn/trunk v8 <br></code> <br>  The tools \ visual studio folder contains V8 projects for Visual Studio. <br>  It is convenient to study the code in them, but it is better to build V8 from the command line (from the root folder where SConstruct), for example, like this: <br><br> <code>scons msvcltcg=off mode=release library=static snapshot=on env="INCLUDE:C:\Program Files\Microsoft SDKs\Windows\v6.0A\Include;C:\Program Files\Microsoft Visual Studio 9.0\VC\include,LIB:C:\Program Files\Microsoft SDKs\Windows\v6.0A\Lib;C:\Program Files\Microsoft Visual Studio 9.0\VC\lib" <br></code> <br><br>  (the path to the installation of the default MS VS EE 2008). <br><br>  msvcltcg is Link Time Optimization.  It is recommended to include only for final releases, otherwise the size of v8.lib will increase by 3-4 times and the link speed of your project will fall. <br><br>  As you can see, we collect the static library v8.lib, which will soon appear in the same folder. <br><br>  We take v8.h from the include and v8.lib folder and add it to our MS Visual Studio 2008 project. <br><br>  Also do not forget to do in the project: <br><br> <code>#pragma comment(lib, "ws2_32.lib") <br> #pragma comment(lib, "winmm.lib") <br></code> <br><br>  Otherwise there will be problems when linking.  Actually, now the V8 engine is available in our project and you can start exploring the Embedder's Guide <br><br>  <a href="http://code.google.com/intl/ru-RU/apis/v8/embed.html">code.google.com/intl/en-RU/apis/v8/embed.html</a> <br><br>  <b>- Introduction to using V8</b> <br><br>  Open v8.h and study. <br><br>  V8 provides its functionality using C ++ classes that are declared in the namespace (namespace) v8.  All important javascript structures are wrapped with the corresponding C ++ class.  For example, the class v8 :: Integer is an integer (i64) in JavaScript. <br><br>  v8.h <br><br> <code>... <br> class Context; <br> class String; <br> class Value; <br> class Utils; <br> class Number; <br> class Object; <br> class Array; <br> class Int32; <br> class Uint32; <br> class External; <br> class Primitive; <br> class Boolean; <br> class Integer; <br> class Function; <br> class Date; <br> ... <br></code> <br><br>  The most important class is the context (v8 :: Context), that is, the place within which javascript code is compiled and executed.  In fact, this is also the place where the global javascript object is stored.  It is difficult to imagine interaction with v8, which does not require context (but, probably, it is possible). <br><br>  Inside itself, the V8 maintains its own stack where the V8 stack objects are placed.  For example, to use the context you need to ‚Äúenter it‚Äù.  To do this, use the special class C ++ Context :: Scope (more details below).  The constructor of this class places a V8 stack object on top of the V8 stack to enter the context.  Calling the destructor of the class Context :: Scope removes the corresponding stack object from the top of the V8 stack.  The exception catching structures (TryCatch), temporary handles storage pools (HandleScope) and other V8 objects are also placed on the V8 stack.  All C ++ classes that manage these objects are the same: in the constructor we place the object on the V8 stack, in the destructor we remove it. <br><br>  V8 (like any javascript runtime environment) contains a garbage collector that removes V8 objects that no one refers to.  Therefore, interaction with V8 objects from C ++ code occurs through handles (v8 :: Handle), I mean pointers to pointers.  Simplified it can be represented as: <br><br>  handle ---&gt; link ---&gt; V8 slot (with usage counter) -&gt; V8 object <br><br>  Implemented handles in the form of C ++ template classes: v8 :: Handle, v8 :: Local, v8 :: Persistent. <br>  By the time of life handles are divided into temporary (v8 :: Local) and permanent (v8 :: Persistent). <br>  We can assume that these are analogs of C ++ stack and hip objects, that is, the lifetime of temporary handles is tied to the stack, and the permanent ones live until they are clearly not destroyed. <br><br>  Further, I assume that we are in the v8 and STL namespace ("using namespace v8; using namespace std;"). <br><br>  So, temporary V8 handles (v8 :: Local).  Used most often.  Let's compare their lifetime with a C ++ stack object: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">V8                                       C++ <br> {                                        { <br> HandleScope handle_scope; <br> Local&lt;Integer&gt; a = Integer::New(1); <font color="#0000ff">int</font> a = 1; <br> }                                         } <br> // a  </font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  As you can see, to store temporary V8 handles, we need a HandleScope object.  This is a V8 stack object for storing those very references to V8 objects.  Simplified, this is an analogue of the beginning of a block of stack variables.  Creating a new temporary handle always results in creating a link in the HandleScope object that is closest to the top of the stack (V8 stack, of course).  You cannot create a temporary handle without a HandleScope! <br><br>  You will use temporary handles very often.  For example, we need to convert a C ++ string to a V8 string.  For a UTF-8 string, this is done as follows: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">string</font> some_utf8_string; <br> Local&lt; <font color="#2B91AF">String</font> &gt; s = <font color="#2B91AF">String</font> ::New(some_utf8_string.data(), some_utf8_string.size()); <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Many classes (for example, Integer, String, Boolean, Date) provide the static New method (which returns a temporary handle), which allows you to create a new V8 object of this class and enter data from C ++ into it.  For example (see v8.h): <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">class</font> <font color="#2B91AF">String</font> <br> ... <br> <font color="#0000ff">static</font> Local&lt; <font color="#2B91AF">String</font> &gt; New( <font color="#0000ff">const</font> <font color="#0000ff">char</font> * data, <font color="#0000ff">int</font> length = -1); <br> ... <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  However, an object of type Value can be returned: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">... <br> <font color="#0000ff">class</font> V8EXPORT Date : <font color="#0000ff">public</font> Value { <br> <font color="#0000ff">public</font> : <br> <font color="#0000ff">static</font> Local&lt;Value&gt; New( <font color="#0000ff">double</font> time); <br> ... <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br><br>  The Value class stores an arbitrary V8 type.  This is what the javascript variable can point to: number, string, object, function, array, etc. Value provides methods for checking its type (IsUndefined (), IsNull (), IsString (), IsFunction (), etc.).  Value conversion to the desired type is performed using the Cast method of the class that interests us.  For example: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">Local&lt;Value&gt; foo; <br> Local&lt;Function&gt; bar; <br> <br> <font color="#0000ff">if</font> (foo-&gt;IsFunction()) <br> bar = Handle&lt;Function&gt;::Cast(foo); <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  At the same time, Value is the base C ++ class for classes Integer, String, etc. Therefore, you can do this: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">Local&lt;Value&gt; foo = Local&lt; <font color="#2B91AF">String</font> &gt; bar;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  <b>- Permanent V8 handles</b> <br><br>  There are several cases where temporary handles cannot be used.  Sometimes we need to manage the life span of V8 objects ourselves. <br><br>  First case: V8 context.  We create the context ourselves and destroy it when it is no longer needed. <br><br>  The second case: a V8 object uses an instance of a C ++ object and contains a reference to that instance within itself.  Clearly, if the garbage collector suddenly decides to clean up a V8 object, then we lose the reference to the C ++ object and a memory leak occurs.  However, we want the V8 objects to be destroyed!  We just need to be notified that this will happen now. <br><br>  All this is possible with the help of persistent handles V8 (Persistent). <br><br>  I will give again the code for V8 and the analog (in the sense of lifetime) of the code in C ++. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">Persistent&lt;Integer&gt; p; <font color="#0000ff">int</font> *p = 0; <br> {                                                 { <br> HandleScope handle_scope; <br> Local&lt;Integer&gt; a = Integer::New(1); <font color="#0000ff">int</font> a = 1; <br> p = Persistent&lt;Integer&gt;::New(a);                 p = <font color="#0000ff">new</font> <font color="#0000ff">int</font> (a); <br> }                                                 } <br> <br> Persistent&lt;Integer&gt; q = p; <font color="#0000ff">int</font> * q = p; <br> p.Dispose();                                     delete p; <br> p.Clear();                                        p = 0; <br> <br> <font color="#0000ff">int</font> a = q-&gt;Int32Value(); <font color="#0000ff">int</font> a = *q; <br> <font color="#008000">// !  !                        // !  !</font> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  So, the main way to get a permanent handle (from a temporary) is to use the Persistent :: New () call.  Context is the only class that, when created (New), immediately returns a permanent handle.  I hope everyone already understands why he is doing this. <br><br>  We will postpone the issue of receiving notifications when destroying constant handles, but for now let's try to build the first working program that executes javascript. <br><br>  To do this, we need to extract strings from the String V8 object in C ++ code.  We will use the simplest method - the class String :: AsciiValue. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//    Value;   ,   </font> <br> <font color="#0000ff">string</font> to_string(Local&lt;Value&gt; v) <br> { <br> <font color="#2B91AF">String</font> ::AsciiValue data(v); <br> <font color="#0000ff">const</font> <font color="#0000ff">char</font> * p = *data; <br> <font color="#0000ff">if</font> (p == 0) <font color="#0000ff">return</font> <font color="#0000ff">string</font> (); <br> <font color="#0000ff">return</font> <font color="#0000ff">string</font> (p); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  A function that executes arbitrary javascript code will look like this: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">string</font> v8_exec( <font color="#0000ff">const</font> <font color="#0000ff">char</font> * javascript) <br> { <br> HandleScope handle_scope; <font color="#008000">//      </font> <br> Persistent&lt;Context&gt; context = Context::New(); <font color="#008000">//       </font> <br> Context::Scope context_scope(context); <font color="#008000">//   ""  ;      </font> <br> TryCatch try_catch; <font color="#008000">//     javascript-</font> <br> Local&lt; <font color="#2B91AF">String</font> &gt; source = <font color="#2B91AF">String</font> ::New(javascript); <font color="#008000">//       V8</font> <br> Local&lt;Script&gt; script = Script::Compile(source); <font color="#008000">// </font> <br> <font color="#0000ff">if</font> (try_catch.HasCaught()) <font color="#0000ff">throw</font> to_string(try_catch.Message()-&gt;Get()); <font color="#008000">//  ?  </font> <br> Local&lt;Value&gt; result = script-&gt;Run(); <font color="#008000">// </font> <br> <font color="#0000ff">if</font> (try_catch.HasCaught()) <font color="#0000ff">throw</font> to_string(try_catch.Message()-&gt;Get()); <font color="#008000">//  ?  </font> <br> context.Dispose(); <font color="#008000">//   -   </font> <br> <font color="#0000ff">return</font> to_string(result); <font color="#008000">//     </font> <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Add the code for main () and get a console application that executes the javascript code passed in the first parameter: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">int</font> main( <font color="#0000ff">int</font> argc, <font color="#0000ff">char</font> *argv[]) <br> { <br> <font color="#0000ff">if</font> (argc &lt; 2) <font color="#0000ff">return</font> -1; <br> <font color="#0000ff">try</font> <br> { <br> <font color="#0000ff">string</font> res = v8_exec(*++argv); <br> printf( <font color="#A31515">"result: %s"</font> , res.data()); <br> } <br> <font color="#0000ff">catch</font> ( <font color="#0000ff">string</font> &amp; err) <br> { <br> printf( <font color="#A31515">"error: %s"</font> , err.data()); <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Run: <br><br>  XXX.exe ‚Äúvar s = 0;  for (var i = 1; i &lt;100; i ++) s + = i;  s; " <br><br>  And we see: <br><br>  result: 4950 <br><br></div><p>Source: <a href="https://habr.com/ru/post/72474/">https://habr.com/ru/post/72474/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../72469/index.html">Is there such a GMail? If not, it would be nice.</a></li>
<li><a href="../72470/index.html">Encyclopedia of probabilities</a></li>
<li><a href="../72471/index.html">Video version of the master class "Branding and identification of the present and the future" (3.5 hours)</a></li>
<li><a href="../72472/index.html">Mozilla launches Firefox‚Äôs ‚Äúthird-party‚Äù add-on verification service.</a></li>
<li><a href="../72473/index.html">Participation in the creation of the official habrasborki Opera 10</a></li>
<li><a href="../72475/index.html">How I defended the interests of the studio in court</a></li>
<li><a href="../72479/index.html">Absolutely useless test number 1: PHP vs Groovy</a></li>
<li><a href="../72481/index.html">Evil and poor Russian online shopping</a></li>
<li><a href="../72482/index.html">Scanned the brain of a Quake mouse</a></li>
<li><a href="../72485/index.html">Volery - Service for creating an installation package with free / partly free software.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>