<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Convenient downloading from Books.ru or attaching to WWW :: Mechanize</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If there is a book, it is good 
 And when the opposite is bad 
 Instead of an epigraph 
 As everyone knows, there has recently been a campaign with th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Convenient downloading from Books.ru or attaching to WWW :: Mechanize</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/a55/67e/76e/a5567e76ea09433fa53943bc7fc103ed.png" alt="Picture to attract attention"><br><blockquote>  If there is a book, it is good <br>  And when the opposite is bad <br>  <i>Instead of an epigraph</i> </blockquote><br>  As everyone knows, there has recently been a campaign with the possibility of acquiring a large number of electronic books on books.ru <a href="http://habrahabr.ru/post/235765/">at a fair price</a> .  The user <a href="https://habrahabr.ru/users/icoz/" class="user_link">icoz</a> made a <a href="https://github.com/icoz/books_ru_download_links">script for batch downloading</a> , but the script is not very convenient, since the books are stored under inconvenient names and need to be downloaded by hand. <br>  In general, I told myself that everything should be convenient and automatic, as is well known ‚Äúsaid-done‚Äù, which is especially important in the light of the upcoming sale tomorrow. <br><a name="habracut"></a><br>  <u>Step 1</u> .  We connect the necessary modules. <br>  We will need <br><pre><code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> WWW::Mechanize; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> HTTP::Request::Common; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> LWP; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> LWP::UserAgent;</code> </pre> <br>  The module itself and several service modules on which it depends.  If you, like me, are using Ubuntu, then downloading WWW :: Mechanize with CPAN is contraindicated, but instead, it‚Äôs better to say <br><pre> <code class="bash hljs">sudo apt-get install libwww-mechanize-perl</code> </pre><br>  <u>Step 2</u> .  We create the object of mechanization and collect the script parameters from the command line: login and password. <br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $mech = WWW::Mechanize-&gt;new(); $booklog = $ARGV[<span class="hljs-number"><span class="hljs-number">0</span></span>]; $bookpsw = $ARGV[<span class="hljs-number"><span class="hljs-number">1</span></span>];</code> </pre><br>  <u>Step 3</u> .  Login on site <br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $resp = $mech-&gt;get(<span class="hljs-string"><span class="hljs-string">'http://www.books.ru/member/login.php'</span></span>); $mech-&gt;cookie_jar-&gt;set_cookie(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'cookie_first_timestamp'</span></span>,DateTime-&gt;now-&gt;epoch, <span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-string"><span class="hljs-string">'www.books.ru'</span></span>); $mech-&gt;cookie_jar-&gt;set_cookie(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'cookie_pages'</span></span>, <span class="hljs-string"><span class="hljs-string">'1'</span></span>, <span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-string"><span class="hljs-string">'www.books.ru'</span></span>); $resp = $mech-&gt;post(<span class="hljs-string"><span class="hljs-string">'http://www.books.ru/member/login.php'</span></span>,[ <span class="hljs-string"><span class="hljs-string">'login'</span></span> =&gt; $mail, <span class="hljs-string"><span class="hljs-string">'password'</span></span> =&gt; $password, <span class="hljs-string"><span class="hljs-string">'go'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'login'</span></span>, <span class="hljs-string"><span class="hljs-string">'x'</span></span> =&gt; rand_from_to(<span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>), <span class="hljs-string"><span class="hljs-string">'y'</span></span> =&gt; rand_from_to(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>), <span class="hljs-string"><span class="hljs-string">'token'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span> ]);</code> </pre><br>  I draw attention to lines 2 and 3. In the original code, these cookies are formed using JavaScript, but only for the sake of calculating the two parameters, connecting JavaScript is not rational and easier to rewrite it on pearl. <br>  <u>Step 4</u> .  We get a general list of our orders and create an iterator for it: <br><pre> <code class="perl hljs">$resp = $mech-&gt;get(<span class="hljs-string"><span class="hljs-string">'http://www.books.ru/member/orders/'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> @order_list = mkGunz($resp-&gt;content) =~ <span class="hljs-regexp"><span class="hljs-regexp">/\&lt;a\shref=\"http:\/\/www\.books\.ru\/order.php\?order\=(\d+)\"\&gt;/gi</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $order_id (@order_list) {...}</code> </pre><br>  I draw attention to the function mkGunz, which automatically expands the data if the server has packed them with gzip. <br>  <u>Step 5</u> .  Now we need to extract the authors of the book and its title from the page.  Since we use the HTML :: TokeParser module to parse the page, the easiest way is to stream the data we need using the URL. <br><pre> <code class="perl hljs"> <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $fname = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $authors = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $token = $stream-&gt;get_token) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($token-&gt;[<span class="hljs-number"><span class="hljs-number">0</span></span>] eq <span class="hljs-string"><span class="hljs-string">'S'</span></span> &amp;&amp; $token-&gt;[<span class="hljs-number"><span class="hljs-number">1</span></span>] eq <span class="hljs-string"><span class="hljs-string">'a'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $href = $token-&gt;[<span class="hljs-number"><span class="hljs-number">2</span></span>]{<span class="hljs-string"><span class="hljs-string">'href'</span></span>}; $authors .= $stream-&gt;get_trimmed_text(<span class="hljs-string"><span class="hljs-string">'/a'</span></span>).<span class="hljs-string"><span class="hljs-string">','</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($href =~ <span class="hljs-regexp"><span class="hljs-regexp">/\/author\//</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($href =~ <span class="hljs-regexp"><span class="hljs-regexp">/show\=1/</span></span>) { $fname = $stream-&gt;get_trimmed_text(<span class="hljs-string"><span class="hljs-string">'/a'</span></span>); $fname =~ <span class="hljs-regexp"><span class="hljs-regexp">s/\(\sPDF\)//gi</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($href =~ <span class="hljs-regexp"><span class="hljs-regexp">/download\/\?file_type\=pdf/</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">chop</span></span>($authors); $fname = trim($authors.<span class="hljs-string"><span class="hljs-string">','</span></span>.$fname); $fname =~ <span class="hljs-regexp"><span class="hljs-regexp">tr/\//_/</span></span>; $fname .= <span class="hljs-string"><span class="hljs-string">'.pdf'</span></span>; .... } }</code> </pre><br>  <u>Step 6</u> .  Retrieve and save PDF.  There are several interesting points at once: if you don‚Äôt make a clone, then only one book is downloaded, apparently a bug on the site books.ru.  To save files with Russian letters, you cannot use the IO :: File module, a bug in the module for the version of Pearl v5.14.2.  Well, call binmode, so as not to break the PDF files. <br><pre> <code class="perl hljs"> <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $gbm = $mech-&gt;clone(); $resp = $gbm-&gt;get($href); $resp = $gbm-&gt;submit_form(<span class="hljs-string"><span class="hljs-string">with_fields =&gt;</span></span> {<span class="hljs-string"><span class="hljs-string">'agreed'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Y'</span></span>, <span class="hljs-string"><span class="hljs-string">'go'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $pdfFile = $resp-&gt;content; $pdfFile = mkGunz($resp-&gt;content) <span class="hljs-keyword"><span class="hljs-keyword">unless</span></span> ($resp-&gt;content =~ <span class="hljs-regexp"><span class="hljs-regexp">/^\%PDF/</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Saving "</span></span>.$fname.<span class="hljs-string"><span class="hljs-string">" as "</span></span>.length($pdfFile).<span class="hljs-string"><span class="hljs-string">" bytes.\n"</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $fh, <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>, $fname); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $fh) { <span class="hljs-keyword"><span class="hljs-keyword">binmode</span></span>($fh); <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> $fh $pdfFile; <span class="hljs-keyword"><span class="hljs-keyword">close</span></span>($fh); }</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">And finally, all in the collection.</b> <div class="spoiler_text"><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl use WWW::Mechanize; use HTTP::Request::Common; use LWP; use LWP::UserAgent; use URI::Escape; use HTML::TokeParser; use DateTime; use Compress::Raw::Zlib; use Encode qw(decode encode); use warnings; sub trim($); my $mech = WWW::Mechanize-&gt;new(); $booklog = $ARGV[0]; $bookpsw = $ARGV[1]; #die "Usage: books.su.pl &lt;login&gt; &lt;password&gt; \n" if (scalar @ARGV &lt; 2); $mail = $booklog; $password = $bookpsw; $mech-&gt;agent_alias("Linux Mozilla"); #$mech-&gt;proxy('https', 'http://127.0.0.1:8888/'); #$mech-&gt;proxy('http', 'http://127.0.0.1:8888/'); my $resp = $mech-&gt;get('http://www.books.ru/member/login.php'); $mech-&gt;cookie_jar-&gt;set_cookie(0, 'cookie_first_timestamp',DateTime-&gt;now-&gt;epoch, '/', 'www.books.ru'); $mech-&gt;cookie_jar-&gt;set_cookie(0, 'cookie_pages', '1', '/', 'www.books.ru'); #print mkGunz($resp-&gt;content)."\n"; $resp = $mech-&gt;post('http://www.books.ru/member/login.php',[ 'login' =&gt; $mail, 'password' =&gt; $password, 'go' =&gt; 'login', 'x' =&gt; rand_from_to(40, 50), 'y' =&gt; rand_from_to(1, 20), 'token' =&gt; '' ]); #print mkGunz($resp-&gt;content)."\n"; $resp = $mech-&gt;get('http://www.books.ru/member/orders/'); my @order_list = mkGunz($resp-&gt;content) =~ /\&lt;a\shref=\"http:\/\/www\.books\.ru\/order.php\?order\=(\d+)\"\&gt;/gi; foreach my $order_id (@order_list) { $resp = $mech-&gt;get('http://www.books.ru/order.php?order='.$order_id); my $hcont = mkGunz($resp-&gt;content); my $stream = HTML::TokeParser-&gt;new(\$hcont); $stream-&gt;empty_element_tags(1); my $fname = ''; my $authors = ''; while (my $token = $stream-&gt;get_token) { if ($authors eq '' &amp;&amp; $fname ne "" &amp;&amp; $token-&gt;[0] eq 'S' &amp;&amp; $token-&gt;[1] eq 'br') { $authors .= cnv($stream-&gt;get_trimmed_text('/p')).','; } if ($token-&gt;[0] eq 'S' &amp;&amp; $token-&gt;[1] eq 'a') { my $href = $token-&gt;[2]{'href'}; if ($href =~ /show\=1/) { $fname = cnv($stream-&gt;get_trimmed_text('/a')); $fname =~ s/\(\sPDF\)//gi; } if ($href =~ /download\/\?file_type\=pdf/) { chop($authors); $fname = trim($authors.','.$fname); $fname =~ tr/\//_/; $fname .= '.pdf'; my $gbm = $mech-&gt;clone(); $resp = $gbm-&gt;get($href); $resp = $gbm-&gt;submit_form(with_fields =&gt; {'agreed' =&gt; 'Y', 'go' =&gt; 1}); my $pdfFile = $resp-&gt;content; $pdfFile = mkGunz($resp-&gt;content) unless ($resp-&gt;content =~ /^\%PDF/); print "Saving ".$fname." as ".length($pdfFile)." bytes.\n" ; open(my $fh, "&gt;", $fname); if (defined $fh) { binmode($fh); print $fh $pdfFile; close($fh); } else { die "Unable to open:".$fname."\n"; } $authors = ''; $fname = ''; } } } } sub cnv {return shift;}#encode('cp1251', decode('UTF-8', shift));} sub rand_from_to { my($from, $to) = @_; return int(rand($to - $from)) + $from; } sub mkGunz { my ($ind) = @_; return $ind if($ind =~ /html/); my $gun = new Compress::Raw::Zlib::Inflate(WindowBits =&gt; WANT_GZIP); { my $out; my $status = $gun-&gt;inflate($ind, $out); if ($status == Z_OK || $status == Z_STREAM_END) { return $out; } else { die $status.":".$ind; } }; } sub trim($) { my $string = shift; $string =~ s/^\s+//; $string =~ s/\s+$//; return $string; }</span></span></code> </pre><br></div></div><br><br>  <u>Note for Windows lovers</u> : <br>  Most likely, you need to change the string $ fname = ~ tr / \ // _ /;  on $ fname = ~ tr / \ / \: \ * \? \\ / _ /;  since NTFS has more prohibited characters than ext4 and fiddles with the encoding, for which the cnv function is provided. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Required wishes for the reader</b> : I wish <a href="http://www.books.ru/news/id.php%3Fid%3D3191">not to miss the sale</a> , buy a lot of books, download them on your tablet and quietly read the weekend at the cottage without the Internet. <br><br>  <b>Legal disclaimer</b> : Since it is <a href="http://habrahabr.ru/post/235765/">forbidden to</a> rename files after the license agreement, you should download them immediately under the correct and convenient name, which this script does! </div><p>Source: <a href="https://habr.com/ru/post/236519/">https://habr.com/ru/post/236519/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../236507/index.html">Summation of divergent series by the methods of Abel, Borel, Cesaro and Dirichlet</a></li>
<li><a href="../236509/index.html">Epson Photo Contest - not just yet another photo contest</a></li>
<li><a href="../236511/index.html">Introduction to the Content Delivery Network</a></li>
<li><a href="../236513/index.html">Conversion optimization: where is the best place to place a call to action? [case]</a></li>
<li><a href="../236515/index.html">About blocking the Yota mobile application by MTS</a></li>
<li><a href="../236523/index.html">Disadvantages of RDBMS or RDBMS vs NoSQL</a></li>
<li><a href="../236529/index.html">News DerbyJS 09.2014</a></li>
<li><a href="../236531/index.html">What is ‚ÄúDark web‚Äù?</a></li>
<li><a href="../236533/index.html">ASUS Gladius - review of the game mouse from the Republic Of Gamers series</a></li>
<li><a href="../236535/index.html">Sys.adminstvo as leisure or "Son, make already at home wi-fi"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>