<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to find out which ports on the switches are no longer used</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A little more than a year ago I ran into a problem familiar to every admin, probably: almost all the free ports ended in one of the communication cabi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to find out which ports on the switches are no longer used</h1><div class="post__text post__text-html js-mediator-article">  A little more than a year ago I ran into a problem familiar to every admin, probably: almost all the free ports ended in one of the communication cabinets.  Visually, it was obvious that almost every port had a cable connected, only one or two ports remained free, and about ten new devices were required to be connected. <br><br>  It was clearly clear to me that not all ports were actually used: some of them were most likely connected temporarily and then forgot to disconnect, network printers could be moved and connected to another switch, some of the ports were connected for users who changed their cabinets, etc. <br><br>  Disabling inactive ports was unacceptable, since the fact that a port is not active at the moment does not mean that it was not used 10 minutes ago, and the user simply turned off his computer, and, say, left for a meeting. <br><a name="habracut"></a><br>  At that time, all user switches were Cisco models 3560, which had 100Mbps ports for users and SFP jacks for a fast channel to concentrating switches, so spend at least $ 2500 on an additional switch when I‚Äôm sure that this is not really necessary. just did not raise a hand. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Task </h4><br>  Find out which ports on the switches were not used during the last month. <br><br><h4>  Decision </h4><br>  All switches were configured to send their messages to a central syslog server.  In my example, we used Syslog-NG on Arch Linux, but, of course, you can use any other syslog solution and / or Linux distribution.  Logrotate was used to rotate logs and logs older than one month were erased.  Also about switches: I suppose that on any managed switch you can configure sending messages to a remote syslog server - except Cisco, I have experience only with Nortel and HP - as I recall, they also support this feature. <br><br><h5>  Principle of operation </h5><br>  Cisco switches by default generate messages during activation and deactivation of ports, and since all switches were configured to send messages to a central syslog server, all that was left was to analyze the files that store messages from the switches.  Let me remind you that the server was configured logrotate, so that messages were not stored for more than one month.  I think that we can safely assume that the port, which is not used during the month, most likely is no longer needed, and it can be used for other needs. <br><br><h5>  Settings Examples </h5><br>  Configuring a Cisco switch to send messages to a remote syslog server is very simple; you should go to the configure terminal and enter just one command: <br><br> <code>logging 10.20.100.12</code> <br> <br>  (10.20.100.12 - address of the syslog server) <br><br>  Here are the lines from syslog-ng.conf responsible for receiving messages over the network: <br><br> <code>source remote_udp { <br> udp(); <br> }; <br> <br> destination d_switches { file("/var/log/remote/switches.log"); }; <br> <br> filter f_switches { netmask("10.20.120.0/255.255.255.0") or netmask("10.30.120.0/255.255.255.0"); }; <br> <br> log { source(remote_udp); filter(f_switches); destination(d_switches); };</code> <br> <br>  As you can see from the example, only messages from certain subnets are placed in /var/log/remote/switches.log.  This is done to ensure that messages from different equipment are not mixed into a mess in a single log file.  I prefer that the messages from equipment with different functionalities are placed in different files: user switches separately, concentrating switches separately, routers separately, data storage systems separately, etc.  In this example, 10.20.120.0/24 and 10.30.120.0/24 are the network segments in which the service IP addresses of the user switches are located. <br><br>  Every time the equipment is connected to the switch port, a similar message pops up: <br><br> <code>Apr 27 16:38:44 switch1 330827: Apr 27 15:39:27.317: %LINK-3-UPDOWN: Interface FastEthernet0/4, changed state to up</code> <br> <br>  Here is an example of a message in case of equipment shutdown: <br><br> <code>Apr 27 16:38:53 switch1 330830: Apr 27 15:39:37.635: %LINK-3-UPDOWN: Interface FastEthernet0/4, changed state to down</code> <br> <br>  Here is the algorithm for analyzing log files: <br><br>  1. Select only messages originating from a specific switch. <br>  2. Select only messages that include the string ‚ÄúLINK-3-UPDOWN‚Äù <br>  3. Cut the unnecessary parts of the lines (time, name of the switch, etc.), leaving only the name of the port and its number <br>  4. Select only messages that include the ‚ÄúFastEthernet‚Äù line (in my case, all user ports were 100Mbps, only connections to concentrating switches were gigabit) <br>  5. Cut everything except the port number <br>  6. Sort <br>  7. Keep only unique strings. <br><br>  Implementation on bash: <br><br> <code>#!/bin/bash <br> <br> cat /var/log/remote/switches.log* | grep $1 | grep LINK-3-UPDOWN | cut -d ':' -f 8 | cut -d ' ' -f 3 | grep FastEthernet | cut -d '/' -f 2 | cut -d ',' -f 1 | sort -n | uniq</code> <br> <br><h5>  Usage example </h5><br> <code># ./usedports.sh switch1 <br> 1 <br> 3 <br> 4 <br> 5 <br> 6 <br> 8 <br> 9 <br> 10 <br> 11 <br> 12 <br> 13 <br> 14 <br> 15 <br> 17 <br> 23 <br> 24 <br> 25 <br> 29 <br> 38 <br> 39 <br> 41 <br> 43</code> <br> <br>  As you can see, the script issued all ports, whose status (active / inactive) has changed during the last month.  But what to do if any of the above ports has been continuously active all this time and its status has not changed?  Connect to the correct switch, and execute the following command: <br><br> <code>show interface description | include down</code> <br> <br>  This command lists all inactive ports.  If the port is inactive, and its status has not changed during the last month, it means that it can look for another use. <br><br><h5>  Addition </h5><br>  This solution works fine with individual switches that have all user ports of 100Mbps.  But soon we began to add new switches models 2975 and 2960, produced by the same Cisco.  They all have Gigabit ports, as well as they are equipped with stack modules that allow you to combine several switches into one managed unit, and this led to a change in the name of the ports, since not only the port number, but the number of the switch in the stack was taken into account. <br><br>  Here is a modified implementation. <br><br> <code>#!/bin/bash <br> <br> cat /var/log/remote/switches.log* | grep $1 | grep LINK-3-UPDOWN | cut -d ':' -f 8 | cut -d ' ' -f 3 | grep GigabitEthernet | cut -d 't' -f 4 | cut -d ',' -f 1 | sort -t '/' -k 1,1n -k 3,3n | uniq</code> <br> <br><h4>  Conclusion </h4><br>  The described solution has been successfully working in our organization for more than a year, without any modifications.  Its advantages are low price (in our case, absolutely free, since the syslog server already existed), easy setup (in our case, no configuration was required, since all the switches were already configured to send messages to the remote syslog server) and very simple use.  This decision has saved us the purchase of additional switches, which actually did not need and helps in planning our network, because now we can find out the number of free ports on any switch at any time, which allows us to prepare in time for the needs of a growing organization. <br><br>  I hope this article will be useful to someone. <br><br>  Good luck! </div><p>Source: <a href="https://habr.com/ru/post/121890/">https://habr.com/ru/post/121890/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../121878/index.html">Visual cryptography for color images</a></li>
<li><a href="../121882/index.html">Digital paradise in each district. Governor Tkachev announced yesterday on Twitter a program for the development of free Internet for WiFi in the Krasnodar Territory</a></li>
<li><a href="../121884/index.html">9 most important points when selling</a></li>
<li><a href="../121885/index.html">We use php-cgi in our applications</a></li>
<li><a href="../121888/index.html">What dreams of orange carts</a></li>
<li><a href="../121893/index.html">Django Dash 2011</a></li>
<li><a href="../121894/index.html">Most popular passcodes on smartphones</a></li>
<li><a href="../121895/index.html">Site concept: how and why to create it</a></li>
<li><a href="../121896/index.html">A couple of sentences</a></li>
<li><a href="../121898/index.html">Weekend not at the cottage</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>