<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We win GPRS module from Amperki</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We did not have time to defeat the CAN bus , as we had to defeat another piece of hardware, namely, the GPRS module. This is the life of the developer...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We win GPRS module from Amperki</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/f8d/d05/ce9/f8dd05ce94d24dc283d1abcbffdb5906.jpg" alt="image"><br>  We did not have time to defeat <a href="http://geektimes.ru/post/277868/">the CAN bus</a> , as we had to defeat another piece of hardware, namely, the GPRS module.  This is the life of the developer - all the time someone has to win (there must be a forbidden smile). <br><br>  For one of the custom projects I needed to add the ability to control and receive GSM telemetry via SMS.  I looked at the list of available options and stopped at GPRS Shield from Amperki.  Why not?  It looks decent, is produced by a well-known company, has technical support, is not very different in price from its competitors and generally produces a very pleasant impression. <br><br>  But it was not there.  You can learn about that quest and incredible advanced training courses that I had to integrate this GPRS module with the <a href="http://hi-lab.ru/arduino-mega-server/details/download">Arduino Mega Server</a> by clicking the button below. <br><a name="habracut"></a><br><h2>  Module itself </h2><br>  As I have already said, <a href="http://amperka.ru/product/arduino-gprs-shield">the module itself</a> makes a very pleasant impression with its accuracy of execution and affinity with a well-known company.  Again, on the manufacturer's website there are examples of use and the native library.  Since the module is branded, there is hope for adequate support in case of any problems with it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/files/332/bf2/2b2/332bf22b21a64277b46f78d65e580b13.jpg" alt="image"></div><br>  Looking ahead, I‚Äôll say that tech support regularly answered my questions for two weeks, searched for bugs in my library and even released its new version based on the communication with me.  But ... I had to make the module work on my own. <br><br><h2>  Project </h2><br>  A few words about the <a href="http://hi-lab.ru/arduino-mega-server/ams-pro/projects/project-chicken">GSM Coop project</a> for which the GPRS module was required.  It took the development of automation to manage the coop.  Truly, at an amazing time, we live, now the chicken coop requires control via a web browser, wireless smart sensors and telemetry via GSM.  Directly strategic object of some kind, not a chicken coop. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a91/e3a/6a4/a91e3a6a4cd94a2cabc35ca7ebb381b1.png" alt="image"></div><br>  But if it is necessary - it means it is necessary.  We buy components, including the GPRS module, and proceed. <br><br><h2>  Achilles' heel </h2><br>  Now about the features of the module.  Basically, it works.  He works with examples presented on the manufacturer's website and on its basis one can even create some simple sketch.  But there are three "but." <br><br>  <i><strong>Note.</strong></i>  <i>The project used two boards: the <strong>Arduino Mega 2560</strong> and the <strong>Arduino Due,</strong> and all of the following applies to them and only to them.</i> <br><br>  <strong>The first "but" hardware.</strong>  Module does not work with Arduino Due.  No  Not even the multi-day correspondence with Amperka's technical support did not help.  Making me work with GPRS Shield with Arduino Due failed neither to me nor to the company's specialists.  And this is very disappointing because Due is an excellent controller with great capabilities and would love to be able to use it with GPRS Shield. <br><br>  <strong>The second "but" system.</strong>  The module requires the SoftwareSerial library to work.  When I started my communication with GPRS Shield and Amperka technical support, this was the only solution.  After our trials, a revised version of the library was released with support for the work on the iron serial, but ... it never earned either Due or Mega.  What is difficult to explain at all - if the module works on SoftSerial, then what prevents it from working on the iron Serial? <br><br>  <strong>The third "but" conceptual.</strong>  That's not all.  the main ambush lies in the principle of the library module.  It works in a closed mode, that is, it blocks the operation of the controller while waiting for an SMS (and this is 99% of the time) and during all other operations of the module.  What does it mean?  This means that you cannot build anything except a test sketch on the standard library from the manufacturer.  A strategic chicken coop does not shine for you, as thousands more cool applications like security systems, greenhouse management, GSM home control, etc., etc. do not shine. <br><br><h2>  More about SoftwareSerial </h2><br>  On the Arduino Due module does not work, so we will talk about the Arduino Mega.  The piquancy of the situation lies in the fact that having Mega's three free hardware ports Serial1, Serial2 and Seria3, we are forced to connect and use the SoftwareSerial library.  No imaginable and unthinkable ways, including rearranging the jumpers on the module and interrogating with Amperka's technical support addiction, failed to get GPRS Shield to work with hardware ports on the Arduino Mega. <br><br>  Okay ... We use the SoftwareSerial, but even here an ambush awaits us.  SoftwareSerial can work on many Arduino Mega pins, but for some reason it works with the module only on the 62-m and 63-m pins.  Why only on them?  This riddle is great there.  We, apparently, will never know the answer to this question. <br><br><h2>  Flour choice </h2><br>  And so, as usual, we come to the understanding that the standard library is unsuitable for practical use.  By blocking the controller for the time it sends it to wait for a response from the GPRS module, the library blocks all other processes.  The controller simply drops out of reality 99% of the time, waiting for a request or an answer to arrive or the timeout will not end. <br><br>  This puts an end to any application of GPRS Shield, except for the test: sent a request to turn on the outlet - it turned on, sent a request to turn off - it turned off.  There is no question of any web server work, work with sensors, actuators control, etc. None of this will work. <br><br>  The question came up with an edge - either we refuse the manufacturer‚Äôs library and write our GPRS Shield control code (easy to say), or we abandon the module itself and look for an alternative solution.  But the module is already there, so it was decided to abandon the library and write its own control code for the module. <br><br><h2>  Conquest of Everest </h2><br>  I miss the whole process of creating code that replaces the standard library from Amperka, I will only note that it was very, very difficult and required considerable research, a sophisticated algorithm and considerable effort to test the resulting solution. <br><br>  For you, everything will be simple - a little magic and the ready-made working code of the AMS module for GPRS Shield support is ready. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/557/a58/157/557a58157e7b45589395e0a9d867ee52.jpg" alt="image"></div><br><div class="spoiler">  <b class="spoiler_title">Full code of the AMS module, replacing the standard library</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* Modul GPRS part of Arduino Mega Server project */</span></span> #ifdef GPRS_FEATURE #include &lt;SoftwareSerial.h&gt; #define ALWAYS <span class="hljs-number"><span class="hljs-number">1</span></span> #define GPRS_ON_PIN <span class="hljs-number"><span class="hljs-number">2</span></span> #define GPRS_STATE_PIN <span class="hljs-number"><span class="hljs-number">3</span></span> #define GPRS_RX_PIN <span class="hljs-number"><span class="hljs-number">62</span></span> #define GPRS_TX_PIN <span class="hljs-number"><span class="hljs-number">63</span></span> #define MASTER <span class="hljs-string"><span class="hljs-string">"+7yyyxxxxxxx"</span></span> #define MESSAGE <span class="hljs-string"><span class="hljs-string">"Hello"</span></span> #define CHECK_ERROR <span class="hljs-number"><span class="hljs-number">0</span></span> #define CHECK_MARKER <span class="hljs-number"><span class="hljs-number">1</span></span> #define CHECK_OK <span class="hljs-number"><span class="hljs-number">2</span></span> #define NO_CHECK <span class="hljs-number"><span class="hljs-number">3</span></span> #define MARKER_OK <span class="hljs-string"><span class="hljs-string">"OK"</span></span> #define MARKER_NO_CHECK <span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-comment"><span class="hljs-comment">// GPRS commands #define DATA_TEMP1 "temp1" #define DATA_CONT1 "cont1" #define DATA_LEAK1 "leak1" #define DATA_SMOKE1 "smoke1" #define DATA_ALL "all" #define DATA_RELAY1 "relay1" #define DATA_SERVO1 "servo1" #define DATA_PERIOD "period" #define CMD_RELAY1 "relay1=" #define CMD_SERVO1 "servo1=" #define CMD_PERIOD "period=" byte gprsPeriod = 24; SoftwareSerial GPRS(GPRS_RX_PIN, GPRS_TX_PIN); #define MAX_SOFT_SERIAL 128 char bufferGprs[MAX_SOFT_SERIAL]; int curBuf = 0; #define MESSAGE_LENGTH 20 char message[MESSAGE_LENGTH]; char phone[16]; char datetime[24]; void gprsInit() { initStart("GPRS", true); GPRS.begin(9600); gprsOnOff(); gprsStart(); sendGprs("AT+CFUN=1", "OK"); sendGprs("AT+CNMI=2,1", "OK"); sendGprs("AT+CMGF=1", "OK"); sendGprs("AT+CLIP=1", "OK"); modulGprs = MODUL_ENABLE; initDone(true); } void clearBufferGprs() { for (int i = 0; i &lt; curBuf; i++) { bufferGprs[i] = 0; } } void gprsStart() { while (ALWAYS) { delay(1000); curBuf = 0; GPRS.println("AT"); if (GPRS.available() &gt; 0) { while (GPRS.available() &gt; 0) { bufferGprs[curBuf++] = GPRS.read(); } bufferGprs[curBuf] = '\0'; if (strcmp(bufferGprs, "AT\r\n\r\nOK\r\n") == 0) { timeStamp(); Serial.println(" GPRS ON"); break; } else { Serial.print("."); } } clearBufferGprs(); } } // gprsStart() void gprsOnOff() { pinMode(GPRS_ON_PIN, OUTPUT); if (digitalRead(GPRS_STATE_PIN) != HIGH) { digitalWrite(GPRS_ON_PIN, HIGH); delay(3000); } digitalWrite(GPRS_ON_PIN, LOW); } bool clearSoftwareSerial() { if (GPRS.available() &gt; 0) { while (GPRS.available() &gt; 0) { char c = GPRS.read(); } } } #define DELAY_GPRS_COMMAND 2000 byte sendGprs(String command, char marker[]) { unsigned long timer = millis(); bool success = false; clearSoftwareSerial(); clearBufferGprs(); Serial.print(F("Send command: ")); //Serial.println(command); while (ALWAYS) { if (millis() - timer &gt; DELAY_GPRS_COMMAND) { Serial.print(F("Send error: ")); Serial.println(command); //clearBufferGprs(); return CHECK_ERROR; } curBuf = 0; GPRS.println(command); delay(280); if (GPRS.available() &gt; 0) { while (GPRS.available() &gt; 0) { char c = GPRS.read(); if (curBuf &gt; MAX_SOFT_SERIAL - 2) {break;} bufferGprs[curBuf++] = c; Serial.print(c); } Serial.println(); bufferGprs[curBuf] = '\0'; if (marker == MARKER_NO_CHECK) { Serial.print(F("Send no check, ")); Serial.println(millis() - timer); return NO_CHECK; } else if (StrContains(bufferGprs, marker)) { Serial.print(F("Send success, ")); Serial.println(millis() - timer); return CHECK_MARKER; } else if (StrContains(bufferGprs, MARKER_OK)) { Serial.print(F("Send success, ")); Serial.println(millis() - timer); return CHECK_OK; } else { Serial.println("."); } } // if (GPRS.available() &gt; 0) delay(500); } // while (ALWAYS) } // sendGprs( ) // +CMGR: "REC READ", "XXXXXXXXXXX", "", "16/10/01,10:00:00+12" // SMS text void parseSms(char *message, char *phone, char *datetime) { int i = 0; int j = 0; while (bufferGprs[i] != '\"') {i++;} i++; while (bufferGprs[i] != '\"') {i++;} i++; while (bufferGprs[i] != '\"') {i++;} i++; while (bufferGprs[i] != '\"') {phone[j++] = bufferGprs[i++];} phone[j] = '\0'; i++; while (bufferGprs[i] != '\"') {i++;} i++; while (bufferGprs[i] != '\"') {i++;} i++; while (bufferGprs[i] != '\"') {i++;} i++; j = 0; while (bufferGprs[i] != '\"') {datetime[j++] = bufferGprs[i++];} datetime[j] = '\0'; i++; while (bufferGprs[i] != '\n') {i++;} i++; j = 0; //Serial.print(F("strlen(bufferGprs): ")); Serial.println(strlen(bufferGprs)); while (i &lt; strlen(bufferGprs) - 1) { if (j &gt; MESSAGE_LENGTH - 1) {break;} if ((byte)bufferGprs[i] == 13) {break;} message[j++] = bufferGprs[i++]; } Serial.print(F("strlen(message1): ")); Serial.println(strlen(message)); message[j] = '\0'; Serial.print(F("strlen(message2): ")); Serial.println(strlen(message)); for (int z = 0; z &lt; strlen(message); z++) { Serial.print((byte)message[z]); Serial.print(F(" ")); } Serial.println(); } void deleteSms() { if (sendGprs("AT+CMGDA=\"DEL ALL\"", "OK")) { Serial.println(F("All SMS deleted")); } else { Serial.println(F("Error delete all SMS")); } } String stringSens(byte v) { String s = ""; switch (v) { case 0: s = (F("OFF")); break; case 1: s = (F("ON")); break; default: s = (F("?")); } return s; } String stringLeak(byte v) { String s = ""; switch (v) { case 0: s = (F("LEAK!")); break; case 1: s = (F("OK")); break; default: s = (F("?")); } return s; } String stringSmoke(byte v) { String s = ""; switch (v) { case 0: s = (F("OK")); break; case 1: s = (F("SMOKE!")); break; default: s = (F("?")); } return s; } String mkTemp1() {String s = DATA_TEMP1; s += '='; s += String(lpTempTemp); s += '\n'; return s;} String mkCont1() {String s = DATA_CONT1; s += '='; s += stringSens(lpContCont1); s += '\n'; return s;} String mkLeak1() {String s = DATA_LEAK1; s += '='; s += stringLeak(lpLeakLeak1); s += '\n'; return s;} String mkSmoke1() {String s = DATA_SMOKE1; s += '='; s += stringSmoke(smokeSmoke); s += '\n'; return s;} String mkRelay1() {String s = DATA_RELAY1; s += '='; s += stringSens(relayRelay); s += '\n'; return s;} String mkServo1() {String s = DATA_SERVO1; s += '='; s += stringSens(servoState); s += '\n'; return s;} String mkPeriod() {String s = DATA_PERIOD; s += '='; s += String(gprsPeriod); s += '\n'; return s;} String mkAll() { String s = ""; s += mkTemp1(); s += mkCont1(); s += mkLeak1(); s += mkSmoke1(); s += mkRelay1(); s += mkServo1(); s += mkPeriod(); return s; } void gprsSetRelay(byte v) { switch (v) { case 0: if (relayRelay) { relayRelay = STATE_OFF; } break; case 1: if (!relayRelay) { relayRelay = STATE_ON; } break; } } void gprsSetServo(byte v) { switch (v) { case 0: servoState = STATE_OFF; break; case 1: servoState = STATE_ON; break; } } void gprsAnswer() { String s = ""; String mess = String(message); String data = ""; if (mess == DATA_TEMP1) {s += mkTemp1();} else if (mess == DATA_CONT1) {s += mkCont1();} else if (mess == DATA_LEAK1) {s += mkLeak1();} else if (mess == DATA_SMOKE1) {s += mkSmoke1();} else if (mess == DATA_RELAY1) {s += mkRelay1();} else if (mess == DATA_SERVO1) {s += mkServo1();} else if (mess == DATA_PERIOD) {s += mkPeriod();} else if (mess == DATA_ALL) {s += mkAll();} else if (mess.indexOf(F("=")) &gt;= 0) { byte p = mess.indexOf(F("=")); if (mess.indexOf(CMD_RELAY1) &gt;= 0) {data = mess.substring(p + 1); gprsSetRelay(data.toInt()); s += DATA_RELAY1; s += '='; s += stringSens(relayRelay);} else if (mess.indexOf(CMD_SERVO1) &gt;= 0) {data = mess.substring(p + 1); gprsSetServo(data.toInt()); s += DATA_SERVO1; s += '='; s += stringSens(servoState);} else if (mess.indexOf(CMD_PERIOD) &gt;= 0) {data = mess.substring(p + 1); gprsPeriod = data.toInt(); s += DATA_PERIOD; s += '='; s += String(gprsPeriod);} } else { Serial.println(F("Not command!")); } //Serial.print(F("mess: ")); Serial.println(mess); //Serial.print(F("answ: ")); Serial.println(s); if (s == "") {s = "Error";} Serial.println(F("Send answer... ")); if (sendSms(MASTER, s)) { Serial.println(F("success")); } else { Serial.println(F("error")); } } void readSms() { byte result = sendGprs("AT+CMGR=1,1", "+CMGR:"); if (result == CHECK_MARKER) { parseSms(message, phone, datetime); Serial.print(F("Number: ")); Serial.println(phone); Serial.print(F("Datetime: ")); Serial.println(datetime); Serial.print(F("Message: ")); Serial.println(message); deleteSms(); if (String(phone) == String(MASTER)) { Serial.println(F("Message from MASTER!")); gprsAnswer(); } } else if (result == CHECK_OK) { Serial.println(F("No SMS")); } else { Serial.println(F("Error read SMS")); } } bool sendSms(char *number, String data) { String numstr = "AT+CMGS=\"" + String(number) + "\""; String messtr = data + String((char)26); if (sendGprs(numstr, "&gt;")) { if (sendGprs(messtr, MARKER_NO_CHECK)) { return true; } } return false; } void sendPeriod() { Serial.println(F("Send period SMS... ")); if (sendSms(MASTER, mkAll())) { Serial.println(F("success")); } else { Serial.println(F("error")); } } void gprsWorks() { if (cycle20s) { readSms(); } switch (gprsPeriod) { case 1: if (cycle1h) {sendPeriod();} break; case 6: if (cycle6h) {sendPeriod();} break; case 12: if (cycle12h) {sendPeriod();} break; default: if (cycle24h) {sendPeriod();} break; } } #endif // GPRS_FEATURE</span></span></code> </pre> <br></div></div><br>  The module was developed and tested on AMS version 0.16 for Arduino Mega.  Testing showed absolutely stable and reliable operation of GPRS Shield under the control of this module. <br><br><h2>  Connect to the AMS module support GPRS Shield </h2><br>  In order to connect the GPRS Shield module to the Arduino Mega Server, you need to perform a few simple steps.  First, add the following lines to the AMS main file. <br><br><pre> <code class="java hljs">#define GPRS_FEATURE</code> </pre><br>  and <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> modulGprs = MODUL_NOT_COMPILLED;</code> </pre><br>  in the appropriate sections.  There you also need to add test variables that in your real project will be responsible for the controlled parameters (temperature, contact status, etc.). <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> lpTempTemp; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> lpContCont1; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> lpLeakLeak1; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> smokeSmoke; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> relayRelay; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> servoState;</code> </pre><br><h2>  Explanation of supported features </h2><br>  The module contains a basic set of requests and commands, but you can replace these commands with any others and / or extend the basic set with commands and requests you need. <br><br><h3>  Requests </h3><br>  Requests are sent via SMS, the system sends replies (also via SMS) containing information about the requested parameter.  Very simple: we send a request ‚Äútemp1‚Äù from the phone, the system in response sends the current temperature value <code>temp1=20.50</code> . <br><br><blockquote>  <strong>temp1</strong> - temperature request <br>  <strong>cont1</strong> - request for contact status <br>  <strong>leak1</strong> - request for leakage sensor status <br>  <strong>smoke1</strong> - request for smoke sensor status <br>  <strong>relay1</strong> - request for relay status (key) <br>  <strong>servo1</strong> - request servo servo status <br>  <strong>period</strong> - request for the period of automatic telemetry parcels <br>  <strong>all</strong> - request of all system parameters </blockquote><br>  In response to the ‚Äúall‚Äù request, the system sends a list of all parameters.  In the case of sending an unregistered command, the system will send the answer ‚ÄúError‚Äù.  If the monitored parameters are outside the normal range, the system itself can send alarm messages to the operator‚Äôs smartphone. <br><br>  In order to manage the system, only a registered operator could control the system from unauthorized access - it responds only to commands from a specific phone number (s). <br><br><h3>  Teams </h3><br>  Commands are sent via SMS, accepting a command, the system changes its state and sends answers with information about the new status of its actuators or settings. <br><br><blockquote>  <strong>relay1 =</strong> - relay control command (key) <br>  <strong>servo1 =</strong> - servo drive control command <br>  <strong>period =</strong> - command to change the telemetry auto-posting period </blockquote><br>  Example.  Command <code>relay1=1</code> , response <code>relay1=ON</code> .  Command <code>relay1=0</code> , response <code>relay1=OFF</code> . <br><br><h2>  Explanation of the code </h2><br>  Initialization of the GPRS module.  The standard initialization of the AMS module, the launch of the SoftwareSerial, and some GSM-AT commands.  The purpose of this block is to bring the GPRS module to life and return it from nirvana if it has gone to it for some reason beyond our control. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gprsInit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ initStart(<span class="hljs-string"><span class="hljs-string">"GPRS"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); GPRS.begin(<span class="hljs-number"><span class="hljs-number">9600</span></span>); gprsOnOff(); gprsStart(); sendGprs(<span class="hljs-string"><span class="hljs-string">"AT+CFUN=1"</span></span>, <span class="hljs-string"><span class="hljs-string">"OK"</span></span>); sendGprs(<span class="hljs-string"><span class="hljs-string">"AT+CNMI=2,1"</span></span>, <span class="hljs-string"><span class="hljs-string">"OK"</span></span>); sendGprs(<span class="hljs-string"><span class="hljs-string">"AT+CMGF=1"</span></span>, <span class="hljs-string"><span class="hljs-string">"OK"</span></span>); sendGprs(<span class="hljs-string"><span class="hljs-string">"AT+CLIP=1"</span></span>, <span class="hljs-string"><span class="hljs-string">"OK"</span></span>); modulGprs = MODUL_ENABLE; initDone(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); }</code> </pre><br>  The main working function of the module.  Every 20 seconds, the Arduino Mega Server checks for incoming SMS messages and, if any requests or commands arrive, executes them.  As a result, the average delay in the execution of a command is 10 seconds (without taking into account the delay in transmission by the SMS service provider).  This interval can be adjusted, 20 seconds are chosen as a compromise between the speed of response to SMS commands and the system load. <br><br>  These 20 seconds AMS can do everything that it needs, and SMS that arrives during this period of time is not lost.  When using the standard library, the system can do nothing except wait for the arrival of SMS, otherwise it just loses them (and the controller at this time also can not do anything). <br><br>  Immediately there is a telemetry sending code with a specified interval of 1 hour, 6 hours, 12 hours or 24 hours.  This interval can be changed by sending an appropriate command via SMS. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gprsWorks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cycle20s) { readSms(); } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (gprsPeriod) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cycle1h) {sendPeriod();} <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cycle6h) {sendPeriod();} <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cycle12h) {sendPeriod();} <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cycle24h) {sendPeriod();} <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre><br>  The interaction between the GPRS module and the controller is performed using special AT commands and the following functions form the GPRS commands to the module in codes that are understandable to it. <br><br>  The function of sending SMS.  In the parameters of the function, the destination phone number and the command itself or the request are transmitted in text form. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">bool </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendSms</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *number, String data)</span></span></span><span class="hljs-function"> </span></span>{ String numstr = <span class="hljs-string"><span class="hljs-string">"AT+CMGS=\""</span></span> + String(number) + <span class="hljs-string"><span class="hljs-string">"\""</span></span>; String messtr = data + String((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)<span class="hljs-number"><span class="hljs-number">26</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sendGprs(numstr, <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sendGprs(messtr, MARKER_NO_CHECK)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre><br>  SMS reading function.  Accepted values ‚Äã‚Äãare placed in the message, phone, and datetime variables, which contain, respectively, the incoming command, phone number, and the time of the parcel. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readSms</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> result = sendGprs(<span class="hljs-string"><span class="hljs-string">"AT+CMGR=1,1"</span></span>, <span class="hljs-string"><span class="hljs-string">"+CMGR:"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == CHECK_MARKER) { parseSms(message, phone, datetime); Serial.print(F(<span class="hljs-string"><span class="hljs-string">"Number: "</span></span>)); Serial.println(phone); Serial.print(F(<span class="hljs-string"><span class="hljs-string">"Datetime: "</span></span>)); Serial.println(datetime); Serial.print(F(<span class="hljs-string"><span class="hljs-string">"Message: "</span></span>)); Serial.println(message); deleteSms(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String(phone) == String(MASTER)) { Serial.println(F(<span class="hljs-string"><span class="hljs-string">"Message from MASTER!"</span></span>)); gprsAnswer(); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == CHECK_OK) { Serial.println(F(<span class="hljs-string"><span class="hljs-string">"No SMS"</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Serial.println(F(<span class="hljs-string"><span class="hljs-string">"Error read SMS"</span></span>)); } }</code> </pre><br>  The function of forming a response to SMS requests and commands.  This function is specific to each project and you can change it in your projects in accordance with the logic of your system. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gprsAnswer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ String s = <span class="hljs-string"><span class="hljs-string">""</span></span>; String mess = String(message); String data = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess == DATA_TEMP1) {s += mkTemp1();} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess == DATA_CONT1) {s += mkCont1();} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess == DATA_LEAK1) {s += mkLeak1();} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess == DATA_SMOKE1) {s += mkSmoke1();} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess == DATA_RELAY1) {s += mkRelay1();} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess == DATA_SERVO1) {s += mkServo1();} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess == DATA_PERIOD) {s += mkPeriod();} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess == DATA_ALL) {s += mkAll();} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess.indexOf(F(<span class="hljs-string"><span class="hljs-string">"="</span></span>)) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> p = mess.indexOf(F(<span class="hljs-string"><span class="hljs-string">"="</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess.indexOf(CMD_RELAY1) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) {data = mess.substring(p + <span class="hljs-number"><span class="hljs-number">1</span></span>); gprsSetRelay(data.toInt()); s += DATA_RELAY1; s += <span class="hljs-string"><span class="hljs-string">'='</span></span>; s += stringSens(relayRelay);} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess.indexOf(CMD_SERVO1) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) {data = mess.substring(p + <span class="hljs-number"><span class="hljs-number">1</span></span>); gprsSetServo(data.toInt()); s += DATA_SERVO1; s += <span class="hljs-string"><span class="hljs-string">'='</span></span>; s += stringSens(servoState);} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess.indexOf(CMD_PERIOD) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) {data = mess.substring(p + <span class="hljs-number"><span class="hljs-number">1</span></span>); gprsPeriod = data.toInt(); s += DATA_PERIOD; s += <span class="hljs-string"><span class="hljs-string">'='</span></span>; s += String(gprsPeriod);} } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Serial.println(F(<span class="hljs-string"><span class="hljs-string">"Not command!"</span></span>)); } <span class="hljs-comment"><span class="hljs-comment">//Serial.print(F("mess: ")); Serial.println(mess); //Serial.print(F("answ: ")); Serial.println(s); if (s == "") {s = "Error";} Serial.println(F("Send answer... ")); if (sendSms(MASTER, s)) { Serial.println(F("success")); } else { Serial.println(F("error")); } }</span></span></code> </pre><br>  Functions forming answers.  These are the functions that form the answers that the system sends via SMS to the user's smartphone in response to a request or at its discretion, in accordance with the program. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stringSens</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stringLeak</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stringSmoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mkTemp1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mkCont1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mkLeak1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mkSmoke1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mkRelay1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mkServo1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mkPeriod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mkAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span></code> </pre><br>  And the function of executing commands.  These are functions that are performed by SMS commands and change the state of the system, i.e., change its settings or enable or disable actuators. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gprsSetRelay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gprsSetServo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span></span></code> </pre><br>  The remaining functions are purely technical, doing all the rough work of maintaining the interaction between the GPRS Shield and the microcontroller. <br><br><h2>  More about SoftwareSerial </h2><br>  All of the above is not enough for GPRS Shield to work in transparent mode and stop blocking other processes running on the microcontroller.  It is necessary to modify the code of the SoftwareSerial library.  The fact is that its standard buffer of 64 bytes is not enough to digest most AT GSM commands and maintain dynamic interaction between the module and the controller. <br><br>  You need to increase this buffer to at least 128 bytes, and only after that the magic will work and GPRS Shield will begin to work normally in transparent mode.  This is done in the file <code>SoftwareSerial.h</code> .  Row <br><br><pre> <code class="java hljs">#define _SS_MAX_RX_BUFF <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-comment"><span class="hljs-comment">// RX buffer size</span></span></code> </pre><br>  need to change to <br><br><pre> <code class="java hljs">#define _SS_MAX_RX_BUFF <span class="hljs-number"><span class="hljs-number">128</span></span> <span class="hljs-comment"><span class="hljs-comment">// RX buffer size</span></span></code> </pre><br><h2>  Conclusion </h2><br>  You see the exchange of operator commands and system responses on the smartphone screen.  And at the same time, the system performs dozens of processes in a pseudo-multitasking mode.  And GPRS Shield began to occupy less than 1% of the processor time, instead of 99% as before, freeing up the rest of the time for the web server and other tasks for managing the chicken coop. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/2e1/615/a08/2e1615a08e2a4a29802805066509d3e4.png" alt="image"></div><br>  That's all, we integrated GPRS Shield into <a href="http://hi-lab.ru/arduino-mega-server/documentation">AMS</a> , overcame all obstacles, forced it to work in transparent mode, without blocking other processes like a web server, wireless sensors and actuators, and this opens up attractive prospects for building a huge number of systems with GSM SMS control and control on the basis of AMS - greenhouses, security and heating systems, various options for a smart home, etc., etc., almost to infinity. </div><p>Source: <a href="https://habr.com/ru/post/401721/">https://habr.com/ru/post/401721/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../401709/index.html">"Lin Industrial" does not give up</a></li>
<li><a href="../401711/index.html">Valve teaches AI to detect cheaters in CS: GO</a></li>
<li><a href="../401713/index.html">What to do when the plane is boring - run Google Chrome on the back of the chair</a></li>
<li><a href="../401715/index.html">Space Fishing by Robert Winglee (NASA)</a></li>
<li><a href="../401719/index.html">Cyclone 10 - FPGA branded Intel</a></li>
<li><a href="../401723/index.html">Art-renovation of old computer equipment</a></li>
<li><a href="../401725/index.html">The history of implantable technology. Dentures</a></li>
<li><a href="../401727/index.html">Choosing a gift geek for February 23: Guide Madrobots</a></li>
<li><a href="../401729/index.html">What is useful (and dangerous) around us "noise"</a></li>
<li><a href="../401731/index.html">The court authorized the extradition of the founder Megaupload Kim Dotkom in the US</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>