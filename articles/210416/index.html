<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Clear cookies</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! In the light of the information on the security of large portals' accounts, which appeared recently, I decided to revise a little cookie aut...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Clear cookies</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/321/ad3/415/321ad341555df6cf316edcf9e33df3db.jpg" align="right">  Hi, Habr!  In the light of the information on the security of large portals' accounts, which appeared recently, I decided to revise a little cookie authorization in my projects.  First of all, he was questioned with a predilection of Google on the topic of ready-made solutions.  Nothing sensible was found, although it may be that I do not know how to use the search.  After that, I decided to see what they actually write about how to chew cookies correctly.  To my surprise, there were no limits when most of the articles from the category of ‚Äúbad advice‚Äù, and what I read more than 5 years ago. <br>  This article is an attempt to rectify the situation. <br><a name="habracut"></a><br>  For many, the following will seem obvious, but I think there are quite a few for whom this information will be useful.  In the course of research and reflection on the topic ‚Äúhow to act as mere mortals who have no subdomains,‚Äù a <s>bike</s> approach was invented, for which I do not pretend to be authorship, because, as stated above, there is a non-zero likelihood that I do not know how to use search .  The examples will use PHP, as this is the most popular language among me, but people with more subtle mental organization should have no problems understanding what is happening.  So let's get started. <br><br>  Cookies will be stored in the best houses of Philadelphia: in a beautiful tin box.  That is, during authorization, a cookie is set for a single directory other than document root.  Later this cookie is used only when the session is not established or the data (the IP address of the <s>victim</s> user) is not valid.  There should be no dynamic content on the cookie verification page. <br><br>  Now let's take a look at the algorithm in more detail. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First we need a SQL table with the following structure: <br><pre><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`user_auth_cookies`</span></span> ( <span class="hljs-string"><span class="hljs-string">`key`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`user_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`logged_in`</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`key`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`user_id`</span></span> (<span class="hljs-string"><span class="hljs-string">`user_id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`logged_in`</span></span> (<span class="hljs-string"><span class="hljs-string">`logged_in`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8;</code> </pre> <br>  Some presets, and a small User class: <br><pre> <code class="php hljs">$db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> mysqli(<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, <span class="hljs-string"><span class="hljs-string">'test'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'test'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($db-&gt;connect_errno) <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(<span class="hljs-string"><span class="hljs-string">'    MySQL: ('</span></span>.$db-&gt;connect_errno.<span class="hljs-string"><span class="hljs-string">') '</span></span>.$db-&gt;connect_error); <span class="hljs-comment"><span class="hljs-comment">//     define('DOMAIN', ($_SERVER['HTTP_HOST'] !== 'localhost' ? $_SERVER['HTTP_HOST'] : false)); //   .  localhost,  false (       ) define('AUTO_AUTH_URL', '/auth/auto'); //      define('AUTH_URL', '/auth'); //     define('AUTH_COOKIE_DURATION', 20); //    ,      define('USE_HTTPS', false); //  HTTPS    (    ) class User { private $_id; public $isGuest = true; public $name = ''; public function __construct() { GLOBAL $db; if (!isset($_SESSION['user']) || $_SESSION['user']['ip'] !== $_SERVER['REMOTE_ADDR']) return; $query = 'SELECT * FROM users WHERE `id` = '.(int)$_SESSION['user']['id']; if (($res = $db-&gt;query($query)) !== false &amp;&amp; $res-&gt;num_rows) { $user = $res-&gt;fetch_assoc(); $this-&gt;_id = $user['id']; $this-&gt;name = $user['name']; $this-&gt;isGuest = false; if (isset($_SESSION['last_request'])) { $_POST = $_SESSION['last_request']['data']; unset($_SESSION['last_request']); } } else { unset($_SESSION['user']); } } public function getId() { return $this-&gt;_id; } }</span></span></code> </pre><br>  As you can see, two session variables are used, one of them (user) directly for authorization, and the second (last_request) to save the URI from which the authorization request was required, and the POST parameters so that the data of the submitted forms, if any, are not lost. <br><br>  For authorization, the class Auth is used, containing 4 static methods. <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Auth</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loginRequired</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $_SESSION[<span class="hljs-string"><span class="hljs-string">'last_request'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'url'</span></span> =&gt; $_SERVER[<span class="hljs-string"><span class="hljs-string">'REQUEST_URI'</span></span>], <span class="hljs-string"><span class="hljs-string">'data'</span></span> =&gt; $_POST ); header(<span class="hljs-string"><span class="hljs-string">'Location: '</span></span>.AUTO_AUTH_URL); <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(<span class="hljs-string"><span class="hljs-string">'...'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($login, $password, $remember = false)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">GLOBAL</span></span> $db; $query = <span class="hljs-string"><span class="hljs-string">"SELECT * FROM users WHERE `login` = '"</span></span>.$db-&gt;real_escape_string($login).<span class="hljs-string"><span class="hljs-string">"';"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($res = $db-&gt;query($query)) === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> || !$res-&gt;num_rows) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; $user = $res-&gt;fetch_assoc(); <span class="hljs-comment"><span class="hljs-comment">//   ,      if ($user['password'] !== md5($login.md5($password))) return false; if ($remember) { do { $key = md5(mcrypt_create_iv(30)); $query = "SELECT COUNT(*) AS `cnt` FROM user_auth_cookies WHERE `key` = '".$key."';"; $count = 0; if (($res = $db-&gt;query($query)) !== false &amp;&amp; $res-&gt;num_rows) { $row = $res-&gt;fetch_assoc(); $count = (int)$row['cnt']; } else die('   .'); } while ($count &gt; 0); $db-&gt;query("INSERT INTO user_auth_cookies VALUES ('".$key."', ".$user['id'].", NOW());"); setcookie('key', $key, strtotime('+'.AUTH_COOKIE_DURATION.' days'), AUTO_AUTH_URL, DOMAIN, USE_HTTPS, true); } $_SESSION['user'] = array( 'id' =&gt; $user['id'], 'ip' =&gt; $_SERVER['REMOTE_ADDR'], ); return true; } public static function loginByCookie() { GLOBAL $db; $location = AUTH_URL; if (isset($_COOKIE['key'])) { $query = "SELECT user_id FROM user_auth_cookies WHERE `key` = '".$db-&gt;real_escape_string($_COOKIE['key'])."';"; if (($res = $db-&gt;query($query)) !== false &amp;&amp; $res-&gt;num_rows) { $row = $res-&gt;fetch_assoc(); $_SESSION['user'] = array( 'id' =&gt; $row['user_id'], 'ip' =&gt; $_SERVER['REMOTE_ADDR'] ); $location = '/'; if (isset($_SESSION['last_request'])) $location = $_SESSION['last_request']['url']; } } header('X-Frame-Options: DENY'); //     FRAME/IFRAME header('Location: '.$location); die('...'); } public static function logout() { if (!isset($_SESSION['user'])) return; if (mb_strlen($_SESSION['user']['key']) === 32) $db-&gt;query("DELETE FROM user_auth_cookies WHERE `key` = '".$db-&gt;real_escape_string($_SESSION['user']['key'])."';"); setcookie('key', '', 0, AUTO_AUTH_URL, DOMAIN, USE_HTTPS, true); unset($_SESSION['user']); header('Location: /'); die('...'); } }</span></span></code> </pre><br>  Auth :: loginRequired () is called if the user is not authorized and goes to the page that requires authorization.  The method saves the current URI and POST request parameters to the session variable (saving the POST data is necessary if the user wrote a long angry post and his IP was changed at that moment), and redirects to the automatic cookie authorization page. <br>  In the context of the User class: <br><pre> <code class="php hljs">‚Ä¶‚Ä¶ $user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($user-&gt;isGuest) Auth::loginRequired(); ‚Ä¶‚Ä¶</code> </pre><br>  Auth :: login ($ login, $ password, $ remember = false) is called if the login form is received.  The $ login parameter suddenly contains the received login, $ password no less suddenly - the password, $ remember - the flag responsible for setting the cookie. <br>  Usage example: <br><pre> <code class="php hljs">‚Ä¶‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'login'</span></span>]) &amp;&amp; Auth::login($_POST[<span class="hljs-string"><span class="hljs-string">'login'</span></span>], $_POST[<span class="hljs-string"><span class="hljs-string">'password'</span></span>], !!$_POST[<span class="hljs-string"><span class="hljs-string">'remember_me'</span></span>])) { $location = <span class="hljs-string"><span class="hljs-string">'/'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_SESSION[<span class="hljs-string"><span class="hljs-string">'last_request'</span></span>])) $location = $_SESSION[<span class="hljs-string"><span class="hljs-string">'last_request'</span></span>][<span class="hljs-string"><span class="hljs-string">'url'</span></span>]; header(<span class="hljs-string"><span class="hljs-string">'Location: '</span></span>.$location); <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(<span class="hljs-string"><span class="hljs-string">'...'</span></span>); } ‚Ä¶‚Ä¶</code> </pre><br>  Auth :: loginByCookie () is invoked on the automatic login page.  Let me remind you that in order to avoid unpleasant situations on this page there should be no dynamic output, and you should not load anything from other directories, especially domains.  In general, it would not be bad to install a RewriteRule on the script directory, redirecting absolutely all requests for this script.  Suppose so: <br>  <i>.htaccess</i> <br><pre> <code class="apache hljs"><span class="hljs-section"><span class="hljs-section">&lt;ifModule mod_rewrite.c&gt;</span></span> <span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">RewriteEngine</span></span></span></span> <span class="hljs-literal"><span class="hljs-literal">On</span></span> RewriteCond <span class="hljs-variable"><span class="hljs-variable">%{REQUEST_FILENAME}</span></span> !-U RewriteRule ^.*$ index.php<span class="hljs-meta"><span class="hljs-meta"> [L,QSA] &lt;/ifModule&gt;</span></span></code> </pre><br>  Auth :: logout () is called to "un-login" the user.  Clears the cookie and session peremnuyu, removes the key from the base as needed, and redirects to the main one. <br><br>  Stayed the final touch.  It is necessary to periodically (by cron) clear the table of obsolete keys. <br><pre> <code class="php hljs">‚Ä¶‚Ä¶ $db-&gt;query(<span class="hljs-string"><span class="hljs-string">"DELETE FROM user_auth_cookies WHERE `logged_in` &lt; DATE_SUB(NOW(), INTERVAL "</span></span>.AUTH_COOKIE_DURATION.<span class="hljs-string"><span class="hljs-string">" DAYS);"</span></span>); ‚Ä¶‚Ä¶</code> </pre><br>  You can also add to the site a button like: ‚ÄúLog me out on all devices‚Äù, when clicked, all authorization keys are deleted from the user_auth_cookies table by user_id.  This is necessary if the user, for example, forgot to click on "Logout" on another computer, or a mobile device from which he visited your site was stolen from him. <br><pre> <code class="php hljs">‚Ä¶‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'signout_all'</span></span>]) { $db-&gt;query(<span class="hljs-string"><span class="hljs-string">"DELETE FROM user_auth_cookies WHERE `user_id` = "</span></span>.$user-&gt;getId()); Auth::logout(); } ‚Ä¶‚Ä¶</code> </pre><br><br>  For an amateur, you can add a user agent check, or something else like that, but, in my opinion, there is no point in it because if the cookie decides to hijack, then it will be done with the user agent and other similar attributes. <br><br>  That's all, I wish your liver to remain always fresh and crispy. </div><p>Source: <a href="https://habr.com/ru/post/210416/">https://habr.com/ru/post/210416/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../210390/index.html">7 simple optimizations that reduce the CPU load from 80% to 27%</a></li>
<li><a href="../210406/index.html">Lexand Capella: a smartphone with Full HD-screen and support for two SIM-cards for 9,600 rubles ($ 280)</a></li>
<li><a href="../210408/index.html">Forgotten zoom</a></li>
<li><a href="../210410/index.html">Implement an L2TP / IPsec VPN server using standard Windows 7/8 tools for connecting Windows / iOS / Android systems to an internal network</a></li>
<li><a href="../210412/index.html">The legacy of Konrad Zuse: Architecture Z1 and Z3 [Translation]</a></li>
<li><a href="../210418/index.html">Accident Alert Info Panel Project (Part 1)</a></li>
<li><a href="../210420/index.html">We write monitoring the availability of tickets for Russian Railways</a></li>
<li><a href="../210422/index.html">We try Audio API on an example of writing a visualizer</a></li>
<li><a href="../210424/index.html">Post preparation for printing</a></li>
<li><a href="../210426/index.html">Convenient switching wifi in access point mode</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>