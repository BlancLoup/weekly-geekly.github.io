<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Third check of Qt 5 with PVS-Studio</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From time to time, our team re-checks projects about which we have already written articles. The next such rechecked project was Qt. Last time we chec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Third check of Qt 5 with PVS-Studio</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dd9/87d/907/dd987d90784865f850555bc198a97b81.png" alt="PVS-Studio &amp; Qt"></div><br>  From time to time, our team re-checks projects about which we have already written articles.  The next such rechecked project was Qt.  Last time we checked it with PVS-Studio in 2014.  Starting in 2014, the project began to be regularly checked using Coverity.  It is interesting.  Let's see if we can now find some interesting errors with PVS-Studio. <br><a name="habracut"></a><br><h2>  Qt </h2><br>  Previous articles: <br><br><ul><li>  " <a href="https://www.viva64.com/ru/a/0075/">How to reduce the likelihood of errors at the stage of writing code,</a> " July 2011. </li><li>  " <a href="https://www.viva64.com/ru/b/0251/">Checking the Qt 5 Framework</a> ", April 2014. </li></ul><br>  This time, <a href="">Qt Base</a> (Core, Gui, Widgets, Network, ...) and <a href="">Qt5 super module were tested</a> .  About Qt Creator, we plan to write a separate article later.  For the test, we used the PVS-Studio static analyzer, the trial version of which you can <a href="https://www.viva64.com/ru/pvs-studio-download/">download</a> from the site. <br><br>  In my subjective opinion, the Qt code has become better.  Over the years since the last check, many new diagnostics have appeared in the PVS-Studio analyzer.  Despite this, during the review of the warnings, I found not too many errors for a project of this size.  I repeat once again that this is my personal impression.  I did not do any special research on the density of errors then or now. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Regular checks using the Coverity static analyzer were most likely to have a positive effect on the quality of the code.  From 2014, the Qt project ( <a href="https://scan.coverity.com/projects/qt-project">qt-project</a> ) began to be checked with the help of Coverity, and from 2016 - Qt Creator ( <a href="https://scan.coverity.com/projects/qt-creator">qt-creator</a> ).  My opinion: if you are developing an open source project, then <a href="https://scan.coverity.com/">Coverity Scan</a> can be a good free solution that will significantly improve the quality and reliability of your projects. <br><br>  However, as the reader can guess, if I had not noticed anything interesting in the PVS-Studio report, then there would have been no article :).  And if there is an article, there are defects.  Let's look at them.  I wrote a total of 96 errors. <br><br><h2>  Bad Copy-Paste and Typos </h2><br>  Let's start with the classics of the genre, when the cause of the error is inattention.  These errors are underestimated by programmers.  Those who have not read, I recommend to see these two articles: <br><br><ul><li>  <a href="https://www.viva64.com/ru/b/0260/">Last line effect</a> </li><li>  <a href="https://www.viva64.com/ru/b/0509/">Evil lives in comparison functions.</a> </li></ul><br>  These are language errors.  For example, the second article gives a lot of examples of errors in comparison functions written in C, C ++, and C # languages.  Now, implementing Java language support in PVS-Studio, we encounter all the same error patterns.  Here, for example, is the error we recently found in the <a href="http://hibernate.org/">Hibernate</a> library: <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> boolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object other)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other instanceof Id) { Id that = (Id) other; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> purchaseSequence.equals(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.purchaseSequence) &amp;&amp; that.purchaseNumber == <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.purchaseNumber; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }</code> </pre> <br>  If you look closely, it turns out that the <i>purchaseSequence</i> field is compared to itself.  The correct option is: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> that.purchaseSequence.equals(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.purchaseSequence) &amp;&amp; that.purchaseNumber == <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.purchaseNumber;</code> </pre> <br>  In general, everything is as usual, and the PVS-Studio analyzer will have to ‚Äúrake the Augean stables‚Äù in Java projects.  By the way, we invite everyone to take part in the testing of the Beta-version of PVS-Studio for Java, which should appear soon.  To do this, <a href="https://www.viva64.com/ru/about-feedback/">write to us</a> (select "I want an analyzer for Java"). <br><br>  Now back to the errors in the Qt project. <br><br>  <b>Defect n1</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">windowDpiAwareness</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HWND hwnd)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> QWindowsContext::user32dll.getWindowDpiAwarenessContext &amp;&amp; QWindowsContext::user32dll.getWindowDpiAwarenessContext ? QWindowsContext::user32dll.getAwarenessFromDpiAwarenessContext( QWindowsContext::user32dll.getWindowDpiAwarenessContext(hwnd)) : <span class="hljs-number"><span class="hljs-number">-1</span></span>; }</code> </pre> <br>  PVS-Studio Warning: V501 CWE-571 There are identical sub-expressions of QWindowsContext :: user32dll.getWindowDpiAwarenessContext of the operator.  qwindowscontext.cpp 150 <br><br>  Any special explanation besides the analyzer message is not required here.  It seems to me that the expression should have been like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> QWindowsContext::user32dll.getAwarenessFromDpiAwarenessContext &amp;&amp; QWindowsContext::user32dll.getWindowDpiAwarenessContext ? QWindowsContext::user32dll.getAwarenessFromDpiAwarenessContext( QWindowsContext::user32dll.getWindowDpiAwarenessContext(hwnd)) : <span class="hljs-number"><span class="hljs-number">-1</span></span>;</code> </pre> <br>  <b>Defect N2, N3</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> QReadWriteLockPrivate::release() { Q_ASSERT(!recursive); Q_ASSERT(!waitingReaders &amp;&amp; !waitingReaders &amp;&amp; !readerCount &amp;&amp; !writerCount); freelist-&gt;release(id); }</code> </pre> <br>  PVS-Studio warning: V501 CWE-571 operator:! WaitingReaders &amp;&amp;! WaitingReaders qreadwritelock.cpp 632 <br><br>  The error is inside the condition of the <i>Q_ASSERT</i> macro, so it is not significant.  But still this is a mistake.  The <i>waitingReaders</i> variable is checked <i>twice</i> .  And some other variable apparently forgot to check. <br><br>  An identical error is found in the 625 line of the qreadwritelock.cpp file.  Long live Copy-Paste!  :) <br><br>  <b>Defect n4</b> <br><br><pre> <code class="cpp hljs">QString QGraphicsSceneBspTree::debug(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node-&gt;type == Node::Horizontal) { tmp += debug(firstChildIndex(index)); tmp += debug(firstChildIndex(index) + <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { tmp += debug(firstChildIndex(index)); tmp += debug(firstChildIndex(index) + <span class="hljs-number"><span class="hljs-number">1</span></span>); } .... }</code> </pre> <br>  PVS-Studio Warning: V523 CWE-691 The 'then' statement is equivalent to the 'else' statement.  qgraphicsscene_bsp.cpp 179 <br><br>  Most likely, the text block was copied, but forgot to fix it. <br><br>  <b>Defect n5</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> FillRule { OddEvenFill, WindingFill }; QDataStream &amp;<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>&gt;&gt;(QDataStream &amp;s, QPainterPath &amp;p) { .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fillRule; s &gt;&gt; fillRule; Q_ASSERT(fillRule == Qt::OddEvenFill || Qt::WindingFill); .... }</code> </pre> <br>  PVS-Studio warning: V768 CWE-571 The enumeration constant 'WindingFill' is used as a variable of a Boolean-type.  qpainterpath.cpp 2479 <br><br>  Agree, this is a beautiful blooper!  <i>Q_ASSERT</i> does not check anything, since the condition is always true.  True condition due to the fact that the <i>Qt :: WindingFill</i> named constant is 1. <br><br>  <b>Defect n6</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> QVariant::canConvert(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> targetTypeId) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentType == QMetaType::SChar || currentType == QMetaType::Char) currentType = QMetaType::UInt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (targetTypeId == QMetaType::SChar || currentType == QMetaType::Char) targetTypeId = QMetaType::UInt; .... }</code> </pre> <br>  Before reading the warning, try to notice a typo yourself.  Having added a picture, I will help you not to read the message of the analyzer immediately :). <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/86f/f1d/7c5/86ff1d7c55cdc0fb71cbce45f2f84f05.png" alt="Time to think"></div><br><br>  PVS-Studio warning: V560 CWE-570 A part of conditional expression is always false: currentType == QMetaType :: Char.  qvariant.cpp 3529 <br><br>  The condition ‚ÄúcurrentType == QMetaType :: Char‚Äù is checked in the first <i>if</i> .  If the condition is met, the <i>currentType</i> variable is assigned the value <i>QMetaType :: UInt</i> .  Therefore, the <i>currentType</i> variable can no longer be equal to <i>QMetaType :: Char</i> .  Therefore, the analyzer reports that in the second <i>if the</i> subexpression ‚ÄúcurrentType == QMetaType :: Char‚Äù is always false. <br><br>  In fact, the second <i>if</i> should be like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (targetTypeId == QMetaType::SChar || targetTypeId == QMetaType::Char) targetTypeId = QMetaType::UInt;</code> </pre> <br><br>  <b>V560 Diagnostic Note</b> <br><br>  The report turned out to be a lot of warnings V560.  However, I didn‚Äôt review them more, as soon as I found an interesting case for an article that was considered above as defect N6. <br><br>  The vast majority of messages V560 can not be called false, but there is no use for them.  In other words, to describe them in the article is not interesting.  To understand exactly what I mean, consider one such case. <br><br><pre> <code class="cpp hljs">QString QTextHtmlExporter::findUrlForImage(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QTextDocument *doc, ....) { QString url; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!doc) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> url; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (QTextDocument *parent = qobject_cast&lt;QTextDocument *&gt;(doc-&gt;parent())) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> findUrlForImage(parent, cacheKey, isPixmap); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (doc &amp;&amp; doc-&gt;docHandle()) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... }</span></span></code> </pre> <br>  Warning PVS-Stuidio: V560 CWE-571 A part of the conditional expression is always true: doc.  qtextdocument.cpp 2992 <br><br>  The analyzer is absolutely right that the <i>doc</i> pointer is not equal to <i>nullptr</i> when re-checking.  But this is not a mistake, just a programmer reinsured.  You can simplify the code by writing: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (doc-&gt;docHandle()) {</code> </pre> <br>  <b>Defect n7</b> <br><br>  And the last case, which can be classified as a typo.  The error occurs because of confusion in the names of constants, which differ only in the case of the first letter. <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QWindowsCursor</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> QPlatformCursor { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> CursorState { CursorShowing, CursorHidden, CursorSuppressed }; .... } QWindowsCursor::CursorState QWindowsCursor::cursorState() { <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> { cursorShowing = <span class="hljs-number"><span class="hljs-number">0x1</span></span>, cursorSuppressed = <span class="hljs-number"><span class="hljs-number">0x2</span></span> }; CURSORINFO cursorInfo; cursorInfo.cbSize = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(CURSORINFO); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GetCursorInfo(&amp;cursorInfo)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cursorInfo.flags &amp; CursorShowing) .... }</code> </pre> <br>  PVS-Studio Warning: V616 CWE-480 The "CursorShowing" is used in the bitwise operation.  qwindowscursor.cpp 669 <br><br>  I have already analyzed this error in more detail in a separate small note: " <a href="https://www.viva64.com/ru/b/0582/">Once again, the PVS-Studio analyzer turned out to be more attentive</a> than a <a href="https://www.viva64.com/ru/b/0582/">person</a> ." <br><br><h2>  Security flaws </h2><br>  In fact, all the errors that are considered in this article can be called security defects.  All of them are classified according to the <a href="https://cwe.mitre.org/">Common Weakness Enumeration</a> (see CWE ID in the analyzer messages).  If errors are classified as CWE, then they are potentially a security threat.  This is explained in more detail on the <a href="https://www.viva64.com/ru/sast/">PVS-Studio SAST page</a> . <br><br>  However, a number of errors and want to highlight a separate group.  Let's take a look at them. <br><br>  <b>Defect N8, N9</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> QLocalServerPrivate::addListener() { .... SetSecurityDescriptorOwner(pSD.data(), pTokenUser-&gt;User.Sid, FALSE); SetSecurityDescriptorGroup(pSD.data(), pTokenGroup-&gt;PrimaryGroup, FALSE); .... }</code> </pre> <br>  PVS-Studio warnings: <br><br><ul><li>  V530 CWE-252 The Return Value of Function SetSecurityDescriptorOwner 'is required to be utilized.  qlocalserver_win.cpp 167 </li><li>  V530 CWE-252 The Return Value of Function SetSecurityDescriptorGroup 'is required to be utilized.  qlocalserver_win.cpp 168 </li></ul><br>  There are various functions related to access control.  The functions <i>SetSecurityDescriptorOwner</i> and <i>SetSecurityDescriptorGroup</i> are among them. <br><br>  It is necessary to work with such functions very carefully.  For example, be sure to check the status that they return.  What happens if the call to these functions fails?  No need to guess, you need to write code to handle such a case. <br><br>  It is not necessary to take advantage of the lack of verification and turn such errors into vulnerabilities.  However, this is in no case a place for risk, and you need to write more secure code. <br><br>  <b>Defect N10</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> QLocalServerPrivate::addListener() { .... InitializeAcl(acl, aclSize, ACL_REVISION_DS); .... }</code> </pre> <br>  PVS-Studio warning: V530 CWE-252 The return value of the 'InitializeAcl' is required to be utilized.  qlocalserver_win.cpp 144 <br><br>  The situation is similar to that discussed above. <br><br>  <b>Defect N11, N12</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sha1ProcessChunk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... quint8 chunkBuffer[<span class="hljs-number"><span class="hljs-number">64</span></span>]; .... <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> SHA1_WIPE_VARIABLES .... memset(chunkBuffer, 0, 64); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> }</span></span></code> </pre> <br>  PVS-Studio warning: V597 CWE-14 The compiler could delete the memset function call, which is used to flush the chunkBuffer buffer.  The RtlSecureZeroMemory () function should be used to erase the private data.  sha1.cpp 189 <br><br>  The compiler will remove the <i>memset</i> function call.  Already many times in articles I analyzed this situation.  I do not want to repeat.  I refer to the article " <a href="https://www.viva64.com/ru/b/0388/">Secure cleaning of private data</a> ." <br><br>  And one more error is in the same sha1.cpp file, on line 247. <br><br><h2>  Null pointers </h2><br>  It's time to talk about pointers.  There are a lot of mistakes on this topic. <br><br>  <b>Defect n13</b> <br><br><pre> <code class="cpp hljs">QByteArray &amp;QByteArray::append(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *str, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (len &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) len = qstrlen(str); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (str &amp;&amp; len) { .... }</code> </pre> <br>  PVS-Studio Warning: V595 CWE-476 The 'str' pointer was used against nullptr.  Check lines: 2118, 2119. qbytearray.cpp 2118 <br><br>  The classic situation is when the pointer is used at the beginning, and then checked for equality <i>nullptr</i> .  This is a very common pattern of error, and we <a href="https://www.viva64.com/ru/examples/v595/">meet</a> it regularly in almost all projects. <br><br>  <b>Defect N14, N15</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> QMetaObjectPrivate *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">priv</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> uint* data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QMetaObjectPrivate*&gt;(data); } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> QMetaEnum::isFlag() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> offset = priv(mobj-&gt;d.data)-&gt;revision &gt;= <span class="hljs-number"><span class="hljs-number">8</span></span> ? <span class="hljs-number"><span class="hljs-number">2</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mobj &amp;&amp; mobj-&gt;d.data[handle + offset] &amp; EnumIsFlag; }</code> </pre> <br>  PVS-Studio warning: V595 CWE-476 The 'mobj' pointer was used against it.  Check lines: 2671, 2672. qmetaobject.cpp 2671 <br><br>  Just in case, I <i>provide the priv</i> function <i>body</i> .  For some reason, sometimes readers begin to invent situations in which the code will work.  I don‚Äôt understand where this distrust and desire to see a cunning feature in an error come from :).  For example, someone may comment in the comments that <i>priv</i> is a macro like: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> priv(A) foo(sizeof(A))</span></span></code> </pre> <br>  Then everything will work. <br><br>  To avoid a place for such discussions, I try to provide code snippets, where all the information confirming the presence of an error is provided. <br><br>  So, the pointer <i>modj is</i> dereferenced and then checked. <br><br>  Next on the scene goes "mighty and terrible¬ª Copy-Paste.  Because of what exactly the same error is found in the <i>isScoped</i> function: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> QMetaEnum::isScoped() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> offset = priv(mobj-&gt;d.data)-&gt;revision &gt;= <span class="hljs-number"><span class="hljs-number">8</span></span> ? <span class="hljs-number"><span class="hljs-number">2</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mobj &amp;&amp; mobj-&gt;d.data[handle + offset] &amp; EnumIsScoped; }</code> </pre> <br>  PVS-Studio warning: V595 CWE-476 The 'mobj' pointer was used against it.  Check lines: 2683, 2684. qmetaobject.cpp 2683 <br><br>  <b>Defect N16-N21</b> <br><br>  Consider another example and, I think, is enough. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> QTextCursor::insertFragment(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QTextDocumentFragment &amp;fragment) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!d || !d-&gt;priv || fragment.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; d-&gt;priv-&gt;beginEditBlock(); d-&gt;remove(); fragment.d-&gt;insert(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); d-&gt;priv-&gt;endEditBlock(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fragment.d &amp;&amp; fragment.d-&gt;doc) d-&gt;priv-&gt;mergeCachedResources(fragment.d-&gt;doc-&gt;docHandle()); }</code> </pre> <br>  PVS-Studio warning: V595 CWE-476 The 'fragment.d'  Check lines: 2238, 2241. qtextcursor.cpp 2238 <br><br>  All the same.  Pay attention to the sequence of working with the pointer stored in the <i>fragment.d</i> variable. <br><br>  Other errors of this type: <br><br><ul><li>  V595 CWE-476 The 'window' pointer was used before it was verified against nullptr.  Check lines: 1846, 1848. qapplication.cpp 1846 </li><li>  V595 CWE-476 The 'window' pointer was used before it was verified against nullptr.  Check lines: 1858, 1860. qapplication.cpp 1858 </li><li>  V595 CWE-476 The 'reply' pointer was used before it was verified against nullptr.  Check lines: 492, 502. qhttpnetworkconnectionchannel.cpp 492 </li><li>  V595 CWE-476 The 'newHandle' pointer was used against nullptr.  Check lines: 877, 883. qsplitter.cpp 877 </li><li>  V595 CWE-476 The 'widget' pointer was used before it was verified against nullptr.  Check lines: 2320, 2322. qwindowsvistastyle.cpp 2320 </li><li>  Actually there are more mistakes.  I was quickly tired of studying the V595 warnings, and for the article I wrote out a sufficient number of code fragments. </li></ul><br>  <b>Defect N22-N33</b> <br><br>  There is a code where the pointer is checked, which returns a <i>new</i> operator.  This is especially amusing because there are lots of places where the result of the <i>malloc</i> function is not checked (see the next group of errors). <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> QTranslatorPrivate::do_load(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString &amp;realname, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString &amp;directory) { .... d-&gt;unmapPointer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[d-&gt;unmapLength]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (d-&gt;unmapPointer) { file.seek(<span class="hljs-number"><span class="hljs-number">0</span></span>); qint64 readResult = file.read(d-&gt;unmapPointer, d-&gt;unmapLength); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (readResult == qint64(unmapLength)) ok = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } .... }</code> </pre> <br>  PVS-Studio warning: V668 CWE-571 against-un un un un pointer pointer pointer against pointer pointer pointer pointer pointer pointer.  The exception will be generated in the case of memory allocation error.  qtranslator.cpp 596 <br><br>  Checking the pointer does not make sense, since in case of a memory allocation error, the exception <i>std :: bad_alloc</i> will be generated.  If you want the <i>new</i> operator to return <i>nullptr</i> when there is a shortage of memory, then you should write: <br><br><pre> <code class="cpp hljs">d-&gt;unmapPointer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::nothrow) <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[d-&gt;unmapLength];</code> </pre> <br>  The analyzer knows about this use case of the <i>new</i> operator and would not issue a warning in this case. <br><br>  Other errors: I will give them the <a href="http://cppfiles.com/qt5_3/qt-V668.txt">qt-V668.txt file</a> . <br><br>  <b>Defect N34-N70</b> <br><br>  As promised, it‚Äôs now the error queue when the result of calling the functions <i>malloc</i> , <i>calloc</i> , <i>strdup</i> , etc. is not checked.  These errors are more serious than it seems at first glance.  More: " <a href="https://www.viva64.com/ru/b/0558/">Why is it important to check that the malloc function returned</a> ?" <br><br><pre> <code class="cpp hljs">SourceFiles::SourceFiles() { nodes = (SourceFileNode**)<span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(SourceFileNode*)*(num_nodes=<span class="hljs-number"><span class="hljs-number">3037</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = <span class="hljs-number"><span class="hljs-number">0</span></span>; n &lt; num_nodes; n++) nodes[n] = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; }</code> </pre> <br>  PVS-Studio warning: V522 CWE-690 There might be a null pointer 'nodes' dereferencing.  Check lines: 138, 136. makefiledeps.cpp 138 <br><br>  The pointer is used without prior verification. <br><br>  All these errors are of the same type, so I will not dwell on them in more detail.  I will give the rest of the warning list: <a href="http://cppfiles.com/qt5_3/qt-V522-V575.txt">qt-V522-V575.txt</a> . <br><br><h2>  Logical errors in conditions </h2><br>  <b>Defect n71</b> <br><br><pre> <code class="cpp hljs">QString QEdidParser::parseEdidString(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> quint8 *data) { <span class="hljs-function"><span class="hljs-function">QByteArray </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buffer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">reinterpret_cast</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *&gt;(data), </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">13</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// Erase carriage return and line feed buffer = buffer.replace('\r', '\0').replace('\n', '\0'); // Replace non-printable characters with dash for (int i = 0; i &lt; buffer.count(); ++i) { if (buffer[i] &lt; '\040' &amp;&amp; buffer[i] &gt; '\176') buffer[i] = '-'; } return QString::fromLatin1(buffer.trimmed()); }</span></span></code> </pre> <br>  PVS-Studio warning: V547 CWE-570 Expression 'buffer [i] &lt;' \ 040 '&amp;&amp; buffer [i]&gt;' \ 176 '' is always false.  qedidparser.cpp 169 <br><br>  The function must perform the following action ‚ÄúReplace non-printable characters with dash‚Äù.  However, she does not.  Take a close look at this condition: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buffer[i] &lt; <span class="hljs-string"><span class="hljs-string">'\040'</span></span> &amp;&amp; buffer[i] &gt; <span class="hljs-string"><span class="hljs-string">'\176'</span></span>)</code> </pre> <br>  It does not make sense.  A character cannot be less than '\ 040' and no longer '\ 176'.  In the condition it is necessary to use the operator '||'.  The correct code is: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buffer[i] &lt; <span class="hljs-string"><span class="hljs-string">'\040'</span></span> || buffer[i] &gt; <span class="hljs-string"><span class="hljs-string">'\176'</span></span>)</code> </pre> <br>  <b>Defect n72</b> <br><br>  A similar error, due to which Windows users are unlucky. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined(Q_OS_WIN) static QString driveSpec(const QString &amp;path) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (path.size() </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; 2) return QString(); char c = path.at(0).toLatin1(); if (c &lt; 'a' &amp;&amp; c &gt; 'z' &amp;&amp; c &lt; 'A' &amp;&amp; c &gt; 'Z') return QString(); if (path.at(1).toLatin1() != ':') return QString(); return path.mid(0, 2); } #endif</span></span></span></span></code> </pre> <br>  The analyzer generates two warnings at once: <br><br><ul><li>  V590 CWE-571 Consider inspecting the 'c &lt;' a '&amp;&amp; c&gt;' z '&amp;&amp; c &lt;' A '&amp;&amp; c&gt;' Z '' expression.  The expression is misprint.  qdir.cpp 77 </li><li>  V560 CWE-570 A part of conditional expression is always false: c&gt; 'z'.  qdir.cpp 77 </li></ul><br>  The logical error is in the condition: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c &lt; <span class="hljs-string"><span class="hljs-string">'a'</span></span> &amp;&amp; c &gt; <span class="hljs-string"><span class="hljs-string">'z'</span></span> &amp;&amp; c &lt; <span class="hljs-string"><span class="hljs-string">'A'</span></span> &amp;&amp; c &gt; <span class="hljs-string"><span class="hljs-string">'Z'</span></span>)</code> </pre> <br>  As I understand it, the programmer wanted to find a character that is not a letter of the Latin alphabet.  In this case, the condition should be: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((c &lt; <span class="hljs-string"><span class="hljs-string">'a'</span></span> || c &gt; <span class="hljs-string"><span class="hljs-string">'z'</span></span>) &amp;&amp; (c &lt; <span class="hljs-string"><span class="hljs-string">'A'</span></span> || c &gt; <span class="hljs-string"><span class="hljs-string">'Z'</span></span>))</code> </pre> <br>  <b>Defect n73</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> SelectionMode { NoSelection, SingleSelection, MultiSelection, ExtendedSelection, ContiguousSelection }; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> QAccessibleTableCell::unselectCell() { QAbstractItemView::SelectionMode selectionMode = view-&gt;selectionMode(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!m_index.isValid() || (selectionMode &amp; QAbstractItemView::NoSelection)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; .... }</code> </pre> <br>  PVS-Studio warning: V616 CWE-480 The 'QAbstractItemView :: NoSelection' is used in the bitwise operation.  itemviews.cpp 976 <br><br>  The <i>QAbstractItemView :: NoSelection</i> named constant is zero.  Therefore, the subexpression <i>(selectionMode &amp; QAbstractItemView :: NoSelection)</i> does not make sense.  It will always get 0. <br><br>  I think it should be written here: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!m_index.isValid() || (selectionMode == QAbstractItemView::NoSelection))</code> </pre> <br>  <b>Defect N74</b> <br><br>  The following code is hard for me to understand.  He is wrong, but what he should be I do not know.  A comment on a function does not help me either. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Re-engineered from the inline function _com_error::ErrorMessage(). // We cannot use it directly since it uses swprintf_s(), which is not // present in the MSVCRT.DLL found on Windows XP (QTBUG-35617). static inline QString errorMessageFromComError(const _com_error &amp;comError) { TCHAR *message = nullptr; FormatMessage( FORMAT_MESSAGE_ALLOCATE_BUFFER | FORMAT_MESSAGE_FROM_SYSTEM, NULL, DWORD(comError.Error()), MAKELANGID(LANG_NEUTRAL,SUBLANG_DEFAULT), message, 0, NULL); if (message) { const QString result = QString::fromWCharArray(message).trimmed(); LocalFree(static_cast&lt;HLOCAL&gt;(message)); return result; } if (const WORD wCode = comError.WCode()) return QString::asprintf("IDispatch error #%u", uint(wCode)); return QString::asprintf("Unknown error 0x0%x", uint(comError.Error())); }</span></span></code> </pre> <br>  PVS-Studio warning: V547 CWE-570 Expression 'message' is always false.  qwindowscontext.cpp 802 <br><br>  The programmer probably assumes that the <i>FormatMessage</i> function will change the value of the <i>message</i> pointer.  But it is not.  The <i>FormatMessage function</i> cannot change the pointer value, since it is passed to the function by value.  Here is the prototype of this function: <br><br><pre> <code class="cpp hljs">DWORD __<span class="hljs-function"><span class="hljs-function">stdcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FormatMessageW</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( DWORD dwFlags, LPCVOID lpSource, DWORD dwMessageId, DWORD dwLanguageId, LPWSTR lpBuffer, DWORD nSize, va_list *Arguments )</span></span></span></span>;</code> </pre> <br><br><h2>  Potential memory leaks </h2><br>  <b>Defect N75-N92</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SourceDependChildren</span></span></span><span class="hljs-class"> {</span></span> SourceFile **children; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> num_nodes, used_nodes; SourceDependChildren() : children(<span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>), num_nodes(<span class="hljs-number"><span class="hljs-number">0</span></span>), used_nodes(<span class="hljs-number"><span class="hljs-number">0</span></span>) { } ~SourceDependChildren() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (children) <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(children); children = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addChild</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SourceFile *s)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(num_nodes &lt;= used_nodes) { num_nodes += <span class="hljs-number"><span class="hljs-number">200</span></span>; children = (SourceFile**)<span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(children, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(SourceFile*)*(num_nodes)); } children[used_nodes++] = s; } };</code> </pre> <br>  PVS-Studio warning: V701 CWE-401 realloc () possible leak: when realloc () fails in allocating memory, original pointer 'children' is lost.  Consider assigning realloc () to a temporary pointer.  makefiledeps.cpp 103 <br><br>  Increasing the buffer is implemented in a dangerous way.  If the <i>realloc</i> function cannot allocate memory, it will return <i>NULL</i> .  This <i>NULL</i> will be immediately placed in the <i>children</i> variable and there will be no possibility to somehow free the buffer allocated earlier.  There is a memory leak. <br><br>  Similar errors: <a href="http://cppfiles.com/qt5_3/qt-701.txt">qt-701.txt</a> . <br><br><h2>  miscellanea </h2><br>  <b>N93 defect</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GradientBase</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">typename</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BlendType</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BlendType</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QT_FASTCALL</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">qt_fetch_linear_gradient_template</span></span></span><span class="hljs-class">(....) {</span></span> .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t+inc*length &lt; qreal(INT_MAX &gt;&gt; (FIXPT_BITS + <span class="hljs-number"><span class="hljs-number">1</span></span>)) &amp;&amp; t+inc*length &gt; qreal(INT_MIN &gt;&gt; (FIXPT_BITS + <span class="hljs-number"><span class="hljs-number">1</span></span>))) { .... }</code> </pre> <br>  PVS-Studio warning: V610 CWE-758 Unspecified behavior.  Check the shift operator '&gt;&gt;'.  The left operand '(- 2147483647 - 1)' is negative.  qdrawhelper.cpp 4015 <br><br>  You cannot move a negative <i>INT_MIN</i> value.  This is an unspecified behavior, and one cannot rely on the result of such an operation.  The upper bits can be either 0 or 1. <br><br>  <b>Defect n94</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> QObjectPrivate::addConnection(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> signal, Connection *c) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (signal &gt;= connectionLists-&gt;count()) connectionLists-&gt;resize(signal + <span class="hljs-number"><span class="hljs-number">1</span></span>); ConnectionList &amp;connectionList = (*connectionLists)[signal]; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (signal &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { .... }</code> </pre> <br>  PVS-Studio warning: V781 CWE-129  Perhaps there is a mistake in program logic.  Check lines: 397, 413. qobject.cpp 397 <br><br>  A check <i>(signal &lt;0)</i> indicates that the value of the <i>signal</i> argument may be negative.  However, this argument was previously used to index the array.  It turns out that the check is performed too late.  The program will already be disrupted. <br><br>  <b>Defect N95</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> QXmlStreamWriterPrivate::finishStartElement(<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> contents) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inEmptyElement) { write(<span class="hljs-string"><span class="hljs-string">"/&gt;"</span></span>); QXmlStreamWriterPrivate::Tag &amp;tag = tagStack_pop(); lastNamespaceDeclaration = tag.namespaceDeclarationsSize; lastWasStartElement = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { write(<span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>); } inStartElement = inEmptyElement = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; lastNamespaceDeclaration = namespaceDeclarations.size(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hadSomethingWritten; }</code> </pre> <br>  PVS-Studio warning: V519 CWE-563 The 'lastNamespaceDeclaration' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 3188, 3194. qxmlstream.cpp 3194 <br><br>  I will highlight the essence of the error: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inEmptyElement) { lastNamespaceDeclaration = tag.namespaceDeclarationsSize; } lastNamespaceDeclaration = namespaceDeclarations.size();</code> </pre> <br>  <b>Defect N96</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> QRollEffect::scroll() { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentHeight != totalHeight) { currentHeight = totalHeight * (elapsed/duration) + (<span class="hljs-number"><span class="hljs-number">2</span></span> * totalHeight * (elapsed%duration) + duration) / (<span class="hljs-number"><span class="hljs-number">2</span></span> * duration); <span class="hljs-comment"><span class="hljs-comment">// equiv. to int((totalHeight*elapsed) / duration + 0.5) done = (currentHeight &gt;= totalHeight); } done = (currentHeight &gt;= totalHeight) &amp;&amp; (currentWidth &gt;= totalWidth); .... }</span></span></code> </pre> <br>  V519 CWE-563 The 'done' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 509, 511. qeffects.cpp 511 <br><br>  All the same as in the previous case.  Notice the <i>done</i> variable. <br><br><h2>  Conclusion </h2><br>  Even superficially looking at the report, I wrote out almost 100 errors.  I am pleased with the results of the work of PVS-Studio. <br><br>  Of course, such rare code checks have nothing to do with improving the quality and reliability of the code.  They only demonstrate the capabilities of the code analyzer.  Static analysis tools should be used regularly.  In this case, they reduce the cost of fixing errors and protect applications from many potential vulnerabilities. <br><br>  Thanks for attention.  To keep abreast of our new publications, I invite you to subscribe to one of our channels: <ol><li>  VK.com: <a href="https://vk.com/pvsstudio_rus">pvsstudio_rus</a> </li><li>  Old School RSS: <a href="http://feeds.feedburner.com/viva64-blog-ru">viva64-blog-en</a> </li><li>  Twitter: <a href="https://twitter.com/pvsstudio_rus">@pvsstudio_rus</a> </li><li>  Instagram: <a href="https://www.instagram.com/pvsstudio_rus/">@pvsstudio_rus</a> </li><li>  Telegram: <a href="https://t.me/pvsstudio_rus">@pvsstudio_rus</a> </li></ol><br><p> <a href="https://www.viva64.com/en/b/0584/"><img src="https://habrastorage.org/webt/ts/z9/km/tsz9kmyjtteajhd4x1au60rsrvq.png" align="left"></a> </p><br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Andrey Karpov.  <a href="https://www.viva64.com/en/b/0584/">A Third Check of Qt 5 with PVS-Studio</a> </div><p>Source: <a href="https://habr.com/ru/post/426485/">https://habr.com/ru/post/426485/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../426475/index.html">Miya - helper from the smartphone</a></li>
<li><a href="../426477/index.html">The whole truth about the RTOS. Article # 15. Memory sections: services and data structures</a></li>
<li><a href="../426479/index.html">Homemade test bench for motherboards</a></li>
<li><a href="../426481/index.html">Unity Hexagon Maps: Path Search, Player Squads, Animation</a></li>
<li><a href="../426483/index.html">The one who overtakes Tesla. For more profitable</a></li>
<li><a href="../426487/index.html">Test automation from scratch. Part 1</a></li>
<li><a href="../426489/index.html">On the relationship of prime and irrational numbers</a></li>
<li><a href="../426491/index.html">Security Week 39: on the death of Google+</a></li>
<li><a href="../426493/index.html">Permanent discounts from hosters for VPS and VPS.today Search visitors</a></li>
<li><a href="../426495/index.html">Solo designer. How to build a career when you work alone</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>