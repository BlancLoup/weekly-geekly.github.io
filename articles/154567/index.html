<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Solving the problem of operational image resizing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are cases when you need to display a small copy of the image on the site. Possible solutions: 

 1. In the image tag specify other sizes: 
 <img...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Solving the problem of operational image resizing</h1><div class="post__text post__text-html js-mediator-article"> There are cases when you need to display a small copy of the image on the site.  Possible solutions: <br><br>  <b>1.</b> In the image tag specify other sizes: <br> <code>&lt;img src='/path/to/image.jpg' width: 100px height:150px&gt;</code> <br>  <i>Obviously, in this case too much unnecessary traffic is loaded.</i>  <i>Not everyone has high-speed Internet, and it‚Äôs stupid somehow.</i> <br><a name="habracut"></a><br>  <b>2. The</b> site placeholder resizes itself and loads both images. <br>  <i>Extremely dreary way.</i>  <i>But do not be surprised if this is practiced anywhere.</i> <br><br>  <b>3.</b> In the administrative part, when downloading an image, a resize is done and the processed images are placed in the right folders - xs, s, l, xl and the required image is inserted in the right place <br>  <i>Dimensions are not always appropriate for the task - sometimes you have to go back to n1.</i>  <i>(but already with less losses)</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>4.</b> Register the path to the picture along with the size: <code><a href=""></a> path/to/100x150/image.jpg</code>  <code><a href=""></a> path/to/100x150/image.jpg</code> .  To set nginx on such paths, if there is no picture, then resize and save.  (script) <br><br>  <i>The disadvantage of this approach can be an excessive load on the server, in case the attacker decides to create a script in which he will cyclically substitute various paths, causing the server to resazit.</i>  <i>If you wish, you can put a server, or to fill the entire free space.</i> <br><br>  <b>5.</b> Write a view helper such as <code>getImage(100,150,'image.jpg')</code> that will check for the presence of the image and, if it is not there, remove the original and produce the desired path. <br><br>  <i>The disadvantage of this approach is redundant code, and in case of deleting the original image, the recovered images will remain stored on the hard disk.</i> <br><br>  <b>6.</b> This is the way that I think solves the problems I found. <br><br><pre> <code class="dos hljs">/tmp/ /origin/ /crop/<span class="hljs-number"><span class="hljs-number">100</span></span>x150/ /crop/<span class="hljs-number"><span class="hljs-number">200</span></span>x300/</code> </pre><br><br>  origin - the folder for storing the original downloaded images, <br>  crop is the folder in which folders for resized images are stored. <br>  tmp - temporary data folder <br><br>  The demon looks at the origin folder, compares the date of its last change with the memorized date, and if the change date is later than the one he remembers, then the daemon starts the synchronization mode. <br><br>  To do this, it goes through the crop folder - pulls out folders from there, the names of which coincide with 000x000 and compares the files from this folder with the files from the original (only the names).  If there are extras in the crooked - removes them; if not, it launches imagic and converts.  Size takes from the folder name. <br>  The <code>tmp/temp_file</code> saves the last timestamp of the change. <br><br>  I will give an example of the implementation of this demon.  I wrote it in python.  But I warn you right away that I am a newbie in python, so solution curves are possible.  In my opinion the best way to learn a language is to write a good project on it.  This demon is part of the project.  If you see gaps, please report it.  For demonization, the python-daemon package is used, and imagic should be installed on the server. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- import logging import time import os import re from daemon import runner from sets import Set _PATH = os.path.abspath(os.path.dirname(__file__)) LOG_PATH = os.path.abspath(os.path.join(_PATH, '../', 'files', 'logs')) PID_PATH = os.path.abspath(os.path.join(_PATH, '../', 'files', 'tmp')) class Azazel(): '''  ,    .     origin (   )          -    000x000    crop       add_sync_folders  origin_folder -   sync_folder    add_sync_folders -   pidfile_path -   pid  file_save_last_sync_data          LOG_PATH -     PID_PATH -   pid  ''' #    sync_folder = os.path.abspath( os.path.join(_PATH, '../', 'files', 'media', 'crop')) #      #   file_save_last_sync_data = PID_PATH + "/last_update" #    , #    origin_folder = os.path.abspath( os.path.join(_PATH, '../', 'files', 'media', 'origin')) # ,   #  add_sync_folders = [ os.path.abspath(os.path.join(_PATH, '../', 'files', 'tmp', '100x100')), ] pidfile_path = PID_PATH + '/azazel.pid' stdin_path = '/dev/null' stdout_path = '/dev/tty' stderr_path = '/dev/tty' pidfile_timeout = 5 def __init__(self): self.last_time_update = self.get_last_sync_date() def get_last_update_origin_folder(self): '''       ''' last_update = str(os.path.getmtime(self.origin_folder)) return last_update def set_last_update(self, time): '''       ''' #    self.last_time_update = time #    f = open(self.file_save_last_sync_data, 'w') f.write(str(time)) f.close() def get_last_sync_date(self): '''       ''' f = open(self.file_save_last_sync_data, 'r') last_sync = f.read() f.close() return last_sync def get_folders_to_sync(self): '''   ,   .    dir (   )    (-,    -  )         000x000 ''' folders = map( lambda folder_name: self.sync_folder + '/' + folder_name, os.listdir(self.sync_folder)) + self.add_sync_folders logger.info("folders list:" + str(folders)) return filter( lambda folder: re.match('^\d{,4}x\d{,4}$', folder.split('/')[-1]), folders) def folder_sync(self, folder): '''  .  ,             ,    -     ,     ''' logger.info("   :" + folder) #    folder_image_list = os.listdir(folder) #     origin_image_list    folder_image_list new_files = Set(self.origin_image_list) - Set(folder_image_list) logger.info("  :" + str(new_files)) #  for file_to_sync in new_files: #       size = folder.split('/')[-1] command = 'convert "%s" -resize %s "%s"' % ( self.origin_folder + '/' + file_to_sync, size, folder + '/' + file_to_sync, ) logger.info(command) result = os.system(command) logger.info(result) #     folder_image_list    origin_image_list delte_files = Set(folder_image_list) - Set(self.origin_image_list) logger.info(" :" + str(delte_files)) #  for file_to_sync in delte_files: logger.info('delete ' + folder + '/' + file_to_sync) os.remove(folder + '/' + file_to_sync) def sunc_folders(self): '''          ''' #      self.origin_image_list = os.listdir(self.origin_folder) #       for folder in self.get_folders_to_sync(): self.folder_sync(folder) def run(self): logger.info("start daemon azazel") self.sunc_folders() while True: last_update = self.get_last_update_origin_folder() if self.last_time_update &lt; last_update: logger.info(" ") self.sunc_folders() self.set_last_update(last_update) time.sleep(10) daemon = Azazel() logger = logging.getLogger("DaemonLog") logger.setLevel(logging.DEBUG) formatter = logging.Formatter("%(asctime)s - %(name)s - %(levelname)s - %(message)s") handler = logging.FileHandler(LOG_PATH + "/azazel.log") handler.setFormatter(formatter) logger.addHandler(handler) daemon_runner = runner.DaemonRunner(daemon) daemon_runner.daemon_context.files_preserve = [handler.stream] daemon_runner.do_action()</span></span></code> </pre><br><br>  - The demon works perfectly, I did not observe any problems, except for ideological ones - a question arose, because if I don‚Äôt load photos so often, why do I need a demon and I rewrote it.  I took into account the comments and discussions and wrote as a ‚Äúcelery task‚Äù which starts when I upload a photo.  As though the general demonization remained, but in other plan. </div><p>Source: <a href="https://habr.com/ru/post/154567/">https://habr.com/ru/post/154567/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../154555/index.html">Litdektekte: "rainy" idioms in English</a></li>
<li><a href="../154557/index.html">Global Office has become a partner of ‚ÄúSimple Business‚Äù, we are open for cooperation!</a></li>
<li><a href="../154559/index.html">We invite you to the conference MUK, Oracle and Siemens - participation is free</a></li>
<li><a href="../154561/index.html">Section "Mamba" on RIW: online dating today and tomorrow</a></li>
<li><a href="../154565/index.html">New "1C-Bitrix: Site Management 12.0" - with preference and poetess!</a></li>
<li><a href="../154571/index.html">Kyocera - applications and tools. Part 2 - admins</a></li>
<li><a href="../154573/index.html">Installing Gitorious on Centos 6</a></li>
<li><a href="../154575/index.html">Office Ozon.ru</a></li>
<li><a href="../154577/index.html">What you need to know about the promotion of mobile applications in iOS 6</a></li>
<li><a href="../154579/index.html">Tt eSPORTS Level 10 M - just a mouse?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>