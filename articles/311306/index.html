<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We work in the cloud based on Hyper-V, Part 2: Deploying Exchange Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Part 1: Introduction to the Control Panel 
 Part 2: Deploying Exchange Server 
 Part 3: Storage Spaces 

 Last week, we met with the Azure Pack-based ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We work in the cloud based on Hyper-V, Part 2: Deploying Exchange Server</h1><div class="post__text post__text-html js-mediator-article">  <a href="https://habrahabr.ru/company/dataline/blog/310730/">Part 1: Introduction to the Control Panel</a> <br>  Part 2: Deploying Exchange Server <br>  <a href="https://habrahabr.ru/company/dataline/blog/315472/">Part 3: Storage Spaces</a> <br><br>  Last week, we met <a href="https://habrahabr.ru/company/dataline/blog/310730/">with</a> the Azure Pack-based cloud infrastructure <a href="https://habrahabr.ru/company/dataline/blog/310730/">management portal</a> , learned how to create a virtual network and virtual machines.  Today will deploy and configure Exchange Server from a template. <br><br>  <b>Content</b> <br><blockquote>  <a href="https://habr.com/ru/company/dataline/blog/311306/">Expand virtual machine with Active Directory role</a> <br>  <a href="https://habr.com/ru/company/dataline/blog/311306/">Deploy a virtual machine with the role of Exchange Server 2013</a> <br>  <a href="https://habr.com/ru/company/dataline/blog/311306/">Verify that Exchange Server services start correctly</a> <br>  <a href="https://habr.com/ru/company/dataline/blog/311306/">Configuring DNS zones and port forwarding rules</a> <br>  <a href="https://habr.com/ru/company/dataline/blog/311306/">Configuring Exchange Server Database Cluster</a> <br>  <a href="https://habr.com/ru/company/dataline/blog/311306/">Configure Client Access</a> <br>  <a href="https://habr.com/ru/company/dataline/blog/311306/">Mail Transport Configuration</a> </blockquote><br><img src="https://habrastorage.org/files/20f/234/fdd/20f234fdd98a4f259a2a1567342f798d.jpg"><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the course of our experiment, we will create an IT infrastructure with the following characteristics: <br><br><blockquote>  <b>Active Directory Domain Name:</b> cloud-v.datalinecentre.ru <br>  <b>External DNS name:</b> cloud-v.datalinecentre.ru <br>  <b>Domain controller 1:</b> MSK-DC01 (2 CPU / 2Gb RAM / 40 HDD) <br>  <b>Domain controller 2:</b> MSK-DC02 (2 CPU / 2Gb RAM / 40 HDD) <br>  <b>Exchange server with the role of mailboxes and client access 1:</b> MSK-EXH01 (4CPU / 8Gb RAM / 50Gb + 170Gb HDD) <br>  <b>Exchange server with mailbox and client access 2:</b> MSK-EXH02 (4CPU / 8Gb RAM / 50Gb + 170Gb HDD) <br>  <b>Virtual organization network:</b> 10.10.10.0/24 <br>  <b>Balancing Method:</b> DNS </blockquote><br>  As part of this material, we will not create a DMZ network, but for the safe operation of the combat system and protection from outside attacks, it is necessary to have a buffer between the external network and the intranet. <br><br><img src="https://habrastorage.org/files/34b/c46/293/34bc4629366641e0b4568b6202511988.png"><br>  <i>Scheme of our IT infrastructure.</i> <br><br><a name="AD"></a><h3>  Expand virtual machine with Active Directory role </h3><br>  Before installing Microsoft Exchange Server 2013, you need to prepare your Active Directory forest and its domains.  Information about user mailboxes and the configuration of Exchange servers should be stored somewhere.  We will use an Active Directory domain controller for this. <br><br><ol><li>  In <a href="https://my.cloud-v.ru/">the management portal,</a> go to the <i>Virtual Machines</i> section and click <i>Create</i> . <br><br><img src="https://habrastorage.org/files/4b7/8c3/cff/4b78c3cff5624270aec0f0bfef1c3a44.png"><br><br></li><li>  Select the <i>role of the virtual machine</i> , <i>from the collection.</i> <br><br><img src="https://habrastorage.org/files/c42/eb5/987/c42eb5987fda49edb6d82e07b9aba0a2.png"><br><br></li><li>  Choose a template for a <i>Windows 2012 R2 Domain Controller.</i> <br><br><img src="https://habrastorage.org/files/552/fa5/a53/552fa5a5335a4dacbcddb93bebac09d3.png"><br><br></li><li>  Specify the name of the role of the virtual machine. <br><br><img src="https://habrastorage.org/files/f6e/340/eeb/f6e340eeb341401e8eabf882e162dcb1.png"><br><br></li><li>  Specify the parameters of the virtual machine: <br><br><ul><li>  Size (CPU, RAM, HDD) </li><li>  Local Administrator Password and Login </li><li>  Timezone </li><li>  Virtual machine name </li><li>  Virtual network </li></ul><br><img src="https://habrastorage.org/files/8e5/338/fa8/8e5338fa8003442e9e0a0b0b6d1f97a5.png"><br><br></li><li>  Enter the parameters of the Active Directory forest being created and click <i>OK</i> . <br><br><img src="https://habrastorage.org/files/def/f4d/140/deff4d140c2945baa7b88df12c6866ca.png"><br><br></li><li>  Is done.  Active Directory role virtual machine is deployed. <br><br><img src="https://habrastorage.org/files/910/309/f07/910309f076db4538a300d6304f6e1db7.png"><br><br>  To ensure fault tolerance, we recommend deploying at least two domain controllers in your infrastructure.  Let's create the second virtual machine with the Active Directory role.  To do this, we use the scaling function, which is in the panel. <br><br></li><li>  We select the necessary <i>Virtual machine</i> from the list.  Go to the <i>Scaling</i> tab and select the desired number of instances on the slider.  Click <i>Save</i> . <br><br><img src="https://habrastorage.org/files/b7c/85d/57a/b7c85d57a55f431fa5858fc940e84bb9.png"><br><br></li><li>  Is done.  The <i>Instances</i> tab has a second virtual machine with the role of a domain controller attached to an existing Active Directory domain. <br><br><img src="https://habrastorage.org/files/e9a/de4/afe/e9ade4afef0b404ebdbc50c95dbff686.png"><br><br></li></ol><br><a name="ES"></a><h3>  Deploy a virtual machine with the role of Exchange Server 2013 </h3><br>  Active Directory we have.  Usually, before deploying Exchange Server, you need <a href="https://technet.microsoft.com/ru-ru/library/bb125224(v%3Dexchg.160).aspx">to expand your Active Directory schemas and prepare domains</a> .  When you deploy an Exchange Server virtual machine from a template, all actions for schema extension and domain preparation are performed automatically.  As with Active Directory, we create the role of a virtual machine. <br><ol><li>  Select <i>From the collection of</i> Exchange Server 2013 SP1 CU9. <br><br><img src="https://habrastorage.org/files/f65/aae/951/f65aae95163647c4b1594bea56f7e032.png"><br><br></li><li>  We set the name of the role of the virtual machine. <br><br><img src="https://habrastorage.org/files/da5/cd7/895/da5cd7895bc247c2b4c3389fb2373105.png"><br><br></li><li>  We set parameters of the virtual machine. <br><br><ul><li>  Size (CPU, RAM, HDD) </li><li>  Local Administrator Password and Login </li><li>  Timezone </li><li>  Virtual machine name </li><li> Virtual network - we connect the virtual machine to the same network in which we created the VM with Active Directory. </li></ul><br><img src="https://habrastorage.org/files/e05/3d9/24a/e053d924aab646fcac91dd1c0111dff6.png"><br><br></li><li>  Set the account settings. <br><br><img src="https://habrastorage.org/files/3f0/ee9/8c0/3f0ee98c054d43fdad500d3ef4a0e4b4.png"><br><br></li><li>  Is done. <br><br><img src="https://habrastorage.org/files/dbe/1a6/da6/dbe1a6da6dee411c93edfd9a416d9aac.png"><br><br></li><li>  As in the case of Active Directory, we create an additional Exchange Server virtual machine using the scaling function. <br><br><img src="https://habrastorage.org/files/761/841/5e6/7618415e65204436b1e2926fa7666baa.png"><br></li></ol><br><a name="check"></a><h3>  Verify that Exchange Server services start correctly </h3><br>  We connect to our virtual machines with Exchange Server through the RDP console. <br><ol><li>  Select the virtual machine and click on the <i>Connect</i> , <i>Console</i> command bar. <br><br><img src="https://habrastorage.org/files/58d/5e9/6da/58d5e96dac544cda93bf93c5c03b413f.png"><br><br></li><li>  Through the saved RDP file, we connect to the virtual machine. <br><br><img src="https://habrastorage.org/files/2de/301/6d0/2de3016d0ee84a1f8181917255ea3b25.png"><br><br></li><li>  Check the status of Exchange Server services through the Exchange Management Shell (EMS). <br><br><img src="https://habrastorage.org/files/41f/c11/11f/41fc1111f1474755be736dfe9ca130f5.png"><br><br></li><li>  <i><b>Run the test-servicehealth ‚ÄìServer ‚ÄúExchange Server Name‚Äù</b></i> command. <br><br><img src="https://habrastorage.org/files/91d/14c/212/91d14c21277d48cfa5a5971e4ae800af.png"><br><br></li><li>  Also, after deploying a virtual machine with Exchange, we recommend running through the logs for errors. <br><br><img src="https://habrastorage.org/files/dc3/397/ab4/dc3397ab4f284518803335546ef01adf.png"><br><br></li></ol><br><a name="DNS"></a><h3>  Configuring DNS zones and port forwarding rules </h3><br>  <b>DNS records</b>  In order for Exchange Server to send and receive mail, pass anti-spam checks, you need to add the following DNS records to the external zone.  In our case, the entries will look like this: <br><br><blockquote>  <b>A-records:</b> <br><ul><li>  Autodiscover.cloud-v.datalinecentre.ru 185.99.13.17 </li><li>  Autodiscover.cloud-v.datalinecentre.ru 185.99.13.19 </li><li>  Mail.cloud-v.datalinecentre.ru 185.99.13.17 </li><li>  Mail.cloud-v.datalinecentre.ru 185.99.13.19 </li></ul>  <b>MX record:</b> <br>  Mail.cloud-v.datalinecentre.ru 5 <br>  <b>Txt record:</b> <br>  "V = spf1 ip4: 185.99.13.19 ip4: 185.99.13.17 -all" </blockquote><br>  Do not forget for A-records to add PTR-records in the reverse zone of the provider, which owns external IP-addresses.  They are needed to pass anti-spam checks. <br><br>  <b>Creating port forwarding rules.</b>  For the correct operation of the server, we need the following ports: <br><br><ul><li>  25 / 587‚Äì SMTP </li><li>  80/443 - HTTP / HTTPS </li></ul><br>  Here we also add ports of POP3 110/995 and IMAP 143/993 protocols, if we plan to use them to connect clients. <br><br><ol><li>  In the management portal, go to the <i>Networks</i> section and select the network in which the Exchange machines are running.  Go to the <i>Rules</i> tab <i>.</i> <br><br><img src="https://habrastorage.org/files/09c/cc2/e23/09ccc2e2387947e5af07b085faaaeb55.png"><br><br></li><li>  Click <i>Add Rule</i> . <br><br><img src="https://habrastorage.org/files/d24/9ae/977/d249ae9777c747cdae262e7b7732c193.png"><br><br></li><li>  Fill in the fields and save. <br><br><img src="https://habrastorage.org/files/af7/0a4/605/af70a46056754dd58faa970c74401278.png"><br><br></li><li>  By analogy, we add rules for each external IP address: we have two (185.99.13.19 and 185.99.13.17), since two Exchange servers are deployed.  This is what should happen in the end: <br><br><img src="https://habrastorage.org/files/e49/e5c/1fa/e49e5c1fae07470b864e4b716784a50e.png"><br><br></li></ol><br><a name="DB"></a><h3>  Configuring Exchange Server Database Cluster </h3><br>  We have deployed two Exchange servers to ensure greater availability.  Based on them, we will configure a failover cluster - <a href="https://technet.microsoft.com/ru-ru/library/dd979799(v%3Dexchg.150).aspx">Database Availability Group (DAG)</a> . <br><br>  DAGs can be created through the Exchange Management Shell or the Exchange Control Panel.  We will continue to work with EMS. <br><br><ol><li>  Connect to the virtual machine via the console, enter the command <br>  <i><b>New-DatabaseAvailabilityGroup</b></i> , where: <br><ul><li>  <i>Name</i> - the name of the availability group; </li><li>  <i>WitnessServer</i> - server witness; </li><li>  <i>WitnessDirectory</i> - directory on the witness server in which service information will be stored; </li><li>  <i>DatabaseAvailabilityGroupIpAddress</i> - cluster IP address. </li></ul><br><img src="https://habrastorage.org/files/bd7/8d3/fb6/bd78d3fb66c94b9dba4d0e441d128709.png"><br><br>  <b>Important:</b> with an even number of servers in the DAG, you must have a server witness that will determine the <a href="https://technet.microsoft.com/en-us/library/cc731739(v%3Dws.11).aspx">quorum in the cluster</a> .  This server cannot be one of the cluster members.  The Exchange Trusted Subsystem group must be included in the local administrators group of this server.  In our case, the role of server witness will be performed by a domain controller.  In a productive environment, you cannot do this and it‚Äôs better to use a dedicated server. <br>  With an odd number of servers in the DAG server witness is not needed. <br><br></li><li>  Add the msk-exh01 and msk-exh02 servers to the DAG.  We execute the command <br>  <i><b>Add-DatabaseAvailabilityGroupServer</b></i> , where: <br><ul><li>  Identity - the name of the DAG group; </li><li>  MailboxServer is a mailbox server that we want to add to the cluster. </li></ul><br></li><li>  Check that the servers are added to the cluster.  <i><b>Get-DatabaseAvailabilityGroup</b></i> command <i><b>.</b></i> <br><br><img src="https://habrastorage.org/files/ae2/10c/d78/ae210cd7880e4449b82c15ef02afd57b.png"><br><br></li><li>  Add a passive copy of our mailbox database.  The <i><b>Add-MailboxDatabaseCopy</b></i> command, where: <br><br><ul><li>  <i>Identity</i> - the name of the database for which you want to create a copy; </li><li>  <i>Mailboxserver</i> - the name of the server on which to place a copy; </li><li>  <i>ActivationPreference</i> is a value that indicates the order in which the copy is activated in the event of an unplanned failure of the active copy. <br><br></li></ul><img src="https://habrastorage.org/files/1b0/78a/ba6/1b078aba64584fb586922398463d54af.png"><br><br></li><li>  Check the status of a copy of the database with the command <i><b>Get-mailboxDatabaseCopy.</b></i> <br><br><img src="https://habrastorage.org/files/20e/714/d91/20e714d913bc4aa094123755e5a6f95c.png"><br><br></li></ol>  Our DAG group is ready. <br><br><a name="client"></a><h3>  Configure Client Access </h3><br>  Clients can connect to the Exchange server in various ways: <br><br><ul><li>  <i>Outlook Anywhere</i> is a protocol that has replaced the RPC / TCP protocol, which is inaccessible since Exchange Server 2013. In fact, it is the same RPC, but wrapped in HTTP, with traffic encryption using SSL / TLS. </li><li>  <i>Outlook Web Access (browser access)</i> </li><li>  <i>POP3 protocol</i> </li><li>  <i>IMAP protocol</i> </li><li>  <i>Exchange ActiveSync (for connecting mobile clients)</i> </li></ul><br>  All specified connection methods use an encrypted connection that requires a <a href="https://technet.microsoft.com/en-us/library/dd351044(v%3Dexchg.160).aspx">SAN or Wildcard SSL certificate</a> . <br><br>  To work correctly with the mail server, we need at least 2 names in the SSL certificate.  In our case, this is the name for SMTP, HTTPS, POP, IMAP services, as well as the name for the Autodiscover service (autodiscover): Mail.cloud-v.datalinecentre.ru and Autodiscover.cloud-v.datalinecentre.ru. <br><br>  <b>Install certificate.</b>  To issue a certificate, you must create a <i>Certificate Signing Request (CSR)</i> .  This procedure is easiest to perform through the Exchange Control Panel (ECP): <br><br><ol><li>  We go in the ECP. <br><br><img src="https://habrastorage.org/files/0ff/a34/cc7/0ffa34cc74e54087b323cfaa9cb4e936.png"><br><br></li><li>  Go to the <i>Servers</i> section, the <i>Certificates</i> tab.  Choose one of our servers, <br>  click ‚Äú+‚Äù. <br><br><img src="https://habrastorage.org/files/b0d/6aa/9e3/b0d6aa9e3648425592658961416fb361.png"><br><br></li><li>  Select the option <i>Create a request for certification from certification authority.</i> <br><br><img src="https://habrastorage.org/files/b89/d83/d4b/b89d83d4b46c4ccd92b87a0467ced9f0.png"><br><br></li><li>  We enter Friendly name. <br><br><img src="https://habrastorage.org/files/5ff/458/663/5ff45866364d483d8d22ec15782059e4.png"><br><br></li><li>  Remove the check mark to request a wildcard certificate, since we will use the SAN certificate. <br><br><img src="https://habrastorage.org/files/bdb/339/917/bdb3399173fb411e97a6ea9740683d39.png"><br><br></li><li>  Specify which server to save the request to. <br><br><img src="https://habrastorage.org/files/e23/e4c/531/e23e4c531aa247a3a8dbb5745968ef3f.png"><br><br></li><li>  Specify the names that will contain our SAN certificate. <br><br><img src="https://habrastorage.org/files/d31/0d3/d76/d310d3d763e7437abc3dbe4d6c534cbc.png"><br><br></li><li>  Fill in the required fields. <br><br><img src="https://habrastorage.org/files/1ad/7fc/566/1ad7fc566f4848439527193f9b099e2d.png"><br><br></li><li>  Specify the path where our CSR will be stored.  Click <i>Finish</i> . <br><br><img src="https://habrastorage.org/files/4dd/7bc/2f8/4dd7bc2f81854d20b160dd2e6727ad36.png"><br><br></li><li>  Is done.  CSR is created.  Based on our CSR, we issue a certificate and install it on the server. <br><br><img src="https://habrastorage.org/files/667/004/054/6670040542db4d9791b2e0ca4dba4f3a.png"><br><br></li><li>  Create a ‚Äúshared‚Äù folder on any of the created servers and save the certificate there. <br><br></li><li>  Go to the console ECP.  In the Servers section, go to the <i>Certificates</i> tab.  In the <i>Status</i> field, click <i>Complete</i> . <br><br><img src="https://habrastorage.org/files/96b/5aa/1c2/96b5aa1c27ef4798a06e0ff4c1633368.png"><br><br></li><li>  Specify the path to the folder in which our certificate lies. <br><br><img src="https://habrastorage.org/files/f5d/149/7a3/f5d1497a327142f48a17f6a49b016949.png"><br><br></li><li>  Certificate added.  It is important that the status of the certificate is valid. <br><br><img src="https://habrastorage.org/files/d13/d41/047/d13d41047f9c4e0fbcb6d9c1d27ea76c.png"><br><br></li><li>  Now let's assign SMTP, IIS, POP, IMAP services to it.  Double click on our certificate, go to Services and tick the services we need. <br><br><img src="https://habrastorage.org/files/b5c/4f3/ddc/b5c4f3ddc08c442ebfec2953dca60a3a.png"><br><br></li><li>  Click <i>Yes</i> when the warning appears. <br><br><img src="https://habrastorage.org/files/fb7/467/71e/fb746771eb344a38b8547e33e8a1f548.png"></li></ol><br>  We installed the certificate on one of the Exchange servers.  To install the certificate on other servers, go to the server where the certificate is already installed, and export it with a private key. <br><br><ol><li>  Open the Microsoft Management Console (MMC), add the computer certificate management snap-in. <br><br><img src="https://habrastorage.org/files/a48/3a6/d5a/a483a6d5a4bc482e844185c848149091.png"><br><br></li><li>  Go to the personal certificates tab, export. <br><br><img src="https://habrastorage.org/files/099/7fc/138/0997fc138c7c490eb4ae24fee7e26674.png"><br><br></li><li>  We perform the export of a private key. <br><br><img src="https://habrastorage.org/files/2dd/669/dfc/2dd669dfc8bc483cb332f7afa1867f70.png"><br><br><img src="https://habrastorage.org/files/ebd/32c/0df/ebd32c0df814420cbe1229e425fa3b5d.png"><br><br></li><li>  Specify a secure password that must be entered when importing the certificate. <br><br><img src="https://habrastorage.org/files/781/47b/754/78147b7549fb4868ac3346fe123067f8.png"><br><br></li><li>  Specify the place where the certificate will be saved.  Click <i>Finish</i> . <br><br><img src="https://habrastorage.org/files/a58/03c/034/a5803c0349834ef3a0a307454967f2ff.png"><br><br></li><li>  The exported certificate is transferred to the remaining server.  In our case, this is msk-exh02.  Open the MMC, add the computer certificate management snap-in, go to the personal certificates tab, import. <br><br><img src="https://habrastorage.org/files/edb/eb0/f16/edbeb0f16f0c431cb335b94482ac6f55.png"><br><br></li><li>  Specify the path to the certificate. <br><br><img src="https://habrastorage.org/files/2b8/cde/607/2b8cde607a924753923e50fe9597378d.png"><br><br></li><li>  Specify the password that we set when exporting.  You can also check the option to export the private key. <br><br><img src="https://habrastorage.org/files/3a7/22d/3fe/3a722d3feb0547f494f9ca06f0a127d6.png"><br><br></li><li>  Is done.  The certificate is imported along with the private key. <br><br><img src="https://habrastorage.org/files/879/6b4/475/8796b4475190469bb9457e39d024f312.png"><br><br><img src="https://habrastorage.org/files/05f/5f4/df8/05f5f4df8ce244a889eba2bf81600543.png"><br><br></li><li>  In ECP, we assign services to it, as we did for the first server. <br><br></li><li>  Is done.  Our SSL certificate is imported to both Exchange servers. <br><br></li><li>  Verify that when logging into OWA, the correct certificate appears in the browser. <br><br><img src="https://habrastorage.org/files/dee/993/a20/dee993a20c574c1c8c2b7f082401149f.png"><br><br><img src="https://habrastorage.org/files/7cb/5ee/030/7cb5ee0303664d7b8d7a83563f9fee7f.png"><br><br></li></ol><br>  <b>Setting up virtual directories.</b>  Using virtual directories, clients get access to OWA, ECP, address book (OAB), ActiveSync protocol, Web services (EWS). <br><br>  In our case, we set the ExternalURL parameter to configure virtual directories.  The autodiscover service will give it to clients.  You can also specify the InternalURL parameter if your organization has domain clients connecting to Exchange within the organization's local area networks. <br><br>  Open the EMS and alternately configure the virtual directories using the commands: <br><br><ol><li>  <i><b>Get-EcpVirtualDirectory |</b></i>  <i><b>Set-EcpVirtualDirectory ‚ÄìexternalURL ‚ÄúExternal URL of the directory‚Äù</b></i> </li><li>  <i><b>Get-OwaVirtualDirectory |</b></i>  <i><b>Set-OwaVirtualDirectory ‚ÄìexternalURL ‚ÄúExternal URL of the directory‚Äù</b></i> </li><li>  <i><b>Get-WebServicesVirtualDirectory |</b></i>  <i><b>Set-WebServicesVirtualDirectory ‚ÄìExternalURL ‚ÄúExternal URL of the directory‚Äù</b></i> </li><li>  <i><b>Set-OabVirtualDirectory |</b></i>  <i><b>Set-OabVirtualDirectory ‚ÄìexternalURL ‚ÄúExternal URL of the directory‚Äù</b></i> </li><li>  <i><b>Get-ActiveSyncVirtualDirectory |</b></i>  <i><b>Set-ActiveSyncVirtualDirectory ‚ÄìExternalURL ‚ÄúExternal URL of the directory‚Äù</b></i> </li></ol><br>  <b>Configure Autodiscover Services.</b>  Autodiscover automatically configures Microsoft Outlook clients and transfers server connection parameters, which makes life easier for administrators.  Read more about this service <a href="https://technet.microsoft.com/en-us/library/bb124251(v%3Dexchg.150).aspx">here</a> and <a href="https://msdn.microsoft.com/en-us/library/office/jj900169(v%3Dexchg.150).aspx">here</a> . <br><br>  <a href="https://technet.microsoft.com/ru-ru/library/bb123741(v%3Dexchg.150).aspx">Outlook Anywhere</a> allows you to configure Remote Access to Exchange and Outlook Mobile App. <br><br>  For Outlook Anywhere to work, you need to specify the name of the connection to the service, in our case, it is Mail.cloud-v.datalinecentre.ru.  Open the EMS and execute the command: <br><br>  <i><b>Get-OutLookAnyWhere |</b></i>  <i><b>Set-OutlookAnyWhere ‚ÄìExternalHostName ‚Äúexternal connection name to the service‚Äù ‚ÄìExternalClientRequireSsl: $ true ‚ÄìIISAuthenticationMethods ‚ÄúBasic‚Äù, ‚ÄùNTLM‚Äù, ‚ÄùNegotiate‚Äù ‚ÄìExternalClientAuthenticationMethod ‚ÄúNegotiate‚Äù</b></i> <br><br>  To ensure the operation of Autodiscover, we added 2 A-records in the external DNS zone pointing to the Exchange server: <br><br><ul><li>  Autodiscover.cloud-v.datalinecentre.ru 185.99.13.17 </li><li>  Autodiscover.cloud-v.datalinecentre.ru 185.99.13.19 </li></ul><br>  Verify that Microsoft Outlook clients connect.  Create a profile, specify the email address and password: <br><br><img src="https://habrastorage.org/files/bff/d7c/c8f/bffd7cc8f5a841e0bf628fce8de92d25.png"><br><br><img src="https://habrastorage.org/files/3b5/22e/6cf/3b522e6cf0dd4d09b643833b6d03be8e.png"><br><br><img src="https://habrastorage.org/files/ecb/4a2/da9/ecb4a2da92b44b01b56d429cee5f525b.png"><br><br>  Outlook clients connect correctly. <br><br><a name="transport"></a><h3>  Mail Transport Configuration </h3><br>  Out of the box, the Exchange server allows you to send mail only within the organization.  To send mail to the Internet you need: <br><br><ul><li>  Create <a href="https://technet.microsoft.com/en-us/library/bb124423(v%3Dexchg.150).aspx">accepted domains</a> .  This is the address space that serves our Exchange mail server.  You can create multiple domains. </li><li>  Create a <a href="https://technet.microsoft.com/en-us/library/aa998662(v%3Dexchg.160).aspx">send connector</a> .  With it, we can manage the mail flow by specifying various settings. </li></ul><br><ol><li>  In ECP, in the <i>mail flow</i> section, go to the <i>accepted domains</i> tab.  Click ‚Äú+‚Äù.  Specify the name of our domain, choose the type <i>Authoritative</i> .  We save. <br><br><img src="https://habrastorage.org/files/326/71a/f55/32671af5514b4857bfa00cf8b79c32a1.png"><br><br></li><li>  In the <i>mail flow</i> section, go to the <i>send connectors</i> tab.  Click ‚Äú+‚Äù.  Set the name and specify the type <i>Custom</i> . <br><br><img src="https://habrastorage.org/files/3ae/6c6/9bf/3ae6c69bf5e84fb9b67384a3cd500fcf.png"><br><br></li><li>  Specify sending via MX records. <br><br><img src="https://habrastorage.org/files/d9e/29f/995/d9e29f9951e149a5b3c0109fa23d4595.png"><br><br></li><li>  Specify the address space.  In our case, this is ‚Äú*‚Äù, meaning the entire domain name space. <br><br><img src="https://habrastorage.org/files/745/e91/4e3/745e914e36f24f4ab17f3e75536d3eb7.png"><br><br></li><li>  Specify the server from which mail will be sent outside the Exchange organization.  In our case, these are both servers.  Click <i>Add</i> . <br><br><img src="https://habrastorage.org/files/aac/8a6/3be/aac8a63be4434684a4fb57b5a2db4efc.png"><br><br><img src="https://habrastorage.org/files/658/310/764/658310764c2442f6a2fa710de59ddc1e.png"><br><br></li><li>  In order for our server to successfully pass an anti-spam check, we specify the <i>FQDN HELO</i> parameter in the send connector.  This is the name that will be presented to our server when creating an SMTP session.  The receiving mail server will perform reverse dns lookup, matching the name of the PTR record with the name we specified in the send connector.  If the names do not match, the sending server will not pass the anti-spam check. <br><br>  To configure the name HELO, go to the send connector parameters and enter the name of our server. <br><br><img src="https://habrastorage.org/files/5f1/c23/e54/5f1c23e5407944f38b6f80fa77194445.png"></li></ol><br>  These are all the steps required for the basic configuration of the mail server from the Exchange Server 2013 template. Ask questions in the comments if something remains unclear. </div><p>Source: <a href="https://habr.com/ru/post/311306/">https://habr.com/ru/post/311306/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../311296/index.html">8 myths about deduplication</a></li>
<li><a href="../311298/index.html">The book "Graphic Design. Basic concepts "</a></li>
<li><a href="../311300/index.html">Do you remember a wonderful moment?</a></li>
<li><a href="../311302/index.html">How Yahoo moved from Flash to HTML5 to video</a></li>
<li><a href="../311304/index.html">CSN-Ajax programming template</a></li>
<li><a href="../311308/index.html">Dino Esposito: "Here, developers are more in demand, and their work is paid higher"</a></li>
<li><a href="../311310/index.html">Samsung Pay launched at its own risk in Russia - expert opinions</a></li>
<li><a href="../311312/index.html">Cellular radiation: dangerous?</a></li>
<li><a href="../311314/index.html">Purple screen videos and other 3 Dell abilities</a></li>
<li><a href="../311316/index.html">Reference algorithm in Excel by VF Shatalov</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>