<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Proxy Cookies on Nginx using the lua-nginx module</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I already wrote about how to transform content on the fly using Nginx. Since the publication of the article based on the described method, a real ecom...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Proxy Cookies on Nginx using the lua-nginx module</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/ee3b2566/290ccc61/0c0df625/4108c0fb.jpg"><br><br>  I already wrote about how to <a href="http://habrahabr.ru/blogs/nginx/114845/">transform content on the fly</a> using Nginx.  Since the publication of the article based on the described method, a real ecommerce project has been launched and developed.  In addition to translation and transformation, SEO rewrite is also implemented according to the precepts <a href="https://sites.google.com/site/webmasterhelpforum/ru/stati/rukovodstvo-po-poiskovoj-optimizacii-dla-nacinausih-ot-google">of the Google beginner's guide</a> . <br><br>  However, until the complete victory of the product of Russian programmers over foreign content, one small, but very important thing was missing - proxying <b>Cookies</b> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  What is the problem? </h4><br>  The problem is that any normal application server always exposes a cookie, for example, in order to save a client session or shopping cart with its product.  If this server (or rather its administrator) is concerned with maintaining a certain level of security, then it puts a domain and path in the body of the cookie, for example <b>domain = backend.org;</b>  <b>path = / path1</b> .  Our Nginx running in <i>Reverse Proxy</i> mode remarkably changes all the links in the document body from <i>backend.org</i> to <i>frontend.org</i> , but does not do this for cookies!  This means that the client browser will reject such cookies. <br><br>  For a long time this question has been worrying the minds of nginx administrators, it pops up on mailings 1-2 times a year.  Most of the questioners, apparently, solved their problems by twisting the logic of the <i>backend</i> , but not me!  After the next update of the original site, it became clear that the crutch with PHP + Curl can no longer be pulled and you should definitely find a solution using Nginx! <br><br>  I returned the topic to the newsletter, going through the options from the <i>ngx_http_perl_module</i> and the <i>$ upstream_http_set_cookie</i> variable, even looked into the wilds of the sorts with a ghostly hope to write the module myself.  But all was unsuccessful until one fine day I received a letter from <b>Mikhail Mazursky</b> , who gave valuable advice.  Thanks to this advice, I not only solved the cookie proxying problem with ease, but also received a new tool with which you can create version 2.0 of your project. <br><br><h4>  Decision </h4><br>  The name of this tool is <a href="https://github.com/chaoslawful/lua-nginx-module">lua-nginx-module</a> , which is written by <a href="https://github.com/chaoslawful">another Chinese nugget</a> with roots from <b>Taobao</b> .  From the title it is easy to understand that we are talking about the <b>Lua</b> scripting <b>language</b> embedded in Nginx - but this is more than just an interpreter!  These guys created a completely non-blocking implementation with a performance of tens of thousands of operations per second, which has hooks to all the events inside Nginx.  The fact that before it was possible to implement only by writing your own module in C, you can now make a few lines on Lua.  Interested? <br><a name="habracut"></a><br><br><h4>  Installation </h4><br>  To get started, download the latest version of Nginx <a href="http://nginx.org/ru/download.html">yourself you know where</a> .  Suddenly, who forgot? <br><br>  Then we download the latest version of lua-nginx-module from the <a href="https://github.com/chaoslawful/lua-nginx-module">project page</a> . <br><br>  Libraries will be required: <br><br> <code>apt-get install libpcre3 libpcre3-dev libperl-dev lua5.1 liblua5.1-dev</code> <br> <br>  How to collect Nginx should already know by heart, looking at the speed of release of new releases.  I will result a config from my kukbuk: <br><br> <code>./configure --with-cc-opt="-I /usr/include" --with-ld-opt="-L /usr/lib" --with-http_sub_module --with-http_ssl_module --prefix=/home/nginx/data --user=nginx --group=nginx --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/ --add-module=../substitutions4nginx/ --add-module=../chaoslawful-lua-nginx-module-* <br></code> <br><br><h4>  Configuration </h4><br>  After make install, do not forget to restart nginx.  And look what happened?  And it turned out such a great thing: <a href="http://wiki.nginx.org/HttpLuaModule">http://wiki.nginx.org/HttpLuaModule</a> , which, according to its creators on an average desktop PC, pulls 25 thousand requests per second.  Having carefully studied the documentation, it becomes clear that all events and Nginx internal handlers are available in the Lua runtime.  Specifically for our task, we will use the directive <b>header_filter_by_lua</b> .  Open the configuration file, select the desired <b>location</b> and add simple code: <br><br><pre> <code class="lua hljs">header_filter_by_lua <span class="hljs-string"><span class="hljs-string">' local headers = ngx.header["Set-Cookie"] if headers then if type(headers) == "string" then headers = {headers} end for i, header in ipairs(headers) do local cookie = ngx.re.match(header, "JSESSIONID=([^;]+);", "io") if cookie then headers[i] = "JSESSIONID=" .. cookie[1] .. "; domain=.frontend.com; path=/newpath;" end end ngx.header["Set-Cookie"] = headers end '</span></span>;</code> </pre><br><br>  Here is the simplest version of the handler - the first code on lua that I saw in my life.  You can and should write a universal Set-Cookie parser, the country is already waiting for its hero in the comments! <br><br><h4>  What's next? </h4><br>  When the problem is solved, and even in such a simple way, I immediately want to set a new goal.  What ideas did I have for applying a new tool? <br><br><ol><li>  Visitor counter.  The counter inside the web server itself will be free from a lot of software code due to direct access to the desired variables.  If you connect a NoSQL system like Redis directly to Nginx, then we will get rid of a lot of SQL code.  It will be completely invisible and damn fast counter! </li><li>  Anti-DDoS.  With the help of the language in which the AI ‚Äã‚Äãof most modern games is written, it is easy to make an intelligent filter of unwanted requests to the web server. </li><li>  Automatic SEO generator revrayt.  Instead of manually setting the rules and adding meta tags, we write a script that generates meta tags on the fly, for example, as <a href="http://livestreet.ru/blog/addons/5928.html">in the module for livestreet</a> . </li><li>  And, of course, translation-2.0, with elements of recognition of html blocks and selective content filtering. </li></ol><br><br>  And what did you come up with, dear habraiser? <br><br>  PS Boring post, no pictures at all.  As an announcement, I‚Äôll add a picture of how SEO rewriting with Nginx changed the position in Google search.  Need an article about this? <br><br><img src="https://habrastorage.org/storage1/b07580d1/396f30d4/87583179/d638ff67.png"></div><p>Source: <a href="https://habr.com/ru/post/130861/">https://habr.com/ru/post/130861/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../130853/index.html">Codeigniter: we make sessions finally stable (first of all for authorizations)</a></li>
<li><a href="../130854/index.html">Bitcoin protection word</a></li>
<li><a href="../130856/index.html">Live bait</a></li>
<li><a href="../130859/index.html">Overview of twenty-two free fonts from the Open Font Library website: 16 fonts with Cyrillic + 6 ornamental and special character fonts</a></li>
<li><a href="../130860/index.html">Non dull forms</a></li>
<li><a href="../130862/index.html">BlackBerry Bold 9900 - the last hero?</a></li>
<li><a href="../130865/index.html">Google Reader, finally!</a></li>
<li><a href="../130866/index.html">One of the most sought-after windows features was found in LXDE.</a></li>
<li><a href="../130867/index.html">iOS 5 Tech Talk World Tour 2011</a></li>
<li><a href="../130868/index.html">I want to take and shoot, or an educational program about why you should not use make install</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>