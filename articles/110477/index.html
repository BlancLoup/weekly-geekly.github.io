<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cooking Fugu Fish at Home or OpenBSD on a Home Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Of course, it will not be about cooking a well-known Japanese delicacy. And it will go about setting up several services that I have defined for 
 you...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cooking Fugu Fish at Home or OpenBSD on a Home Server</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/103756f0/562edf9e/a7187026/16a929f8.jpg"><br>  Of course, it will not be about cooking a well-known Japanese delicacy.  And it will go about setting up several services that I have defined for <br>  yourself as needed, on the home server.  The operating system of which will be OpenBSD. <br>  Many will exclaim, but why do you need this little-known OS, because there is Linux, FreeBSD.  Yes, indeed, I could set everything up on others <br>  unix like, but it would not have brought me as much pleasure as I experienced while studying and configuring OpenBSD.  And then, I always attract complex <br>  and non-standard solutions. <br>  Let's finish with the introduction and return to the topic of the title. <br>  I hasten to introduce you to the menu, dear reader. <br><a name="habracut"></a><br>  <b>Today in the menu:</b> <b><br></b>  <b>1. Initial setup.</b> <b><br></b>  <b>2. DNS (forwarding requests to the provider).</b> <b><br></b>  <b>3. Soft RAID 1 (archive of family photos, music, travel videos and other important information).</b> <b><br></b>  <b>4. rtorrent + rutorrent (different torrents are needed, different torrents are important).</b> <b><br></b>  <b>5. NFS server (network folder for access from LAN computers).</b> <b><br></b>  <b>6. VPN tunnel with work.</b>  <b>FreeBSD (mpd5) OpenBSD (ppp) (I love, you know, sometimes working from home).</b> <b><br></b>  <b>7. NUT + UPS Ippon Back power pro 400 (unexpected power outage is not a problem for us).</b> <b><br></b>  <b>8. Firewall (great PF packet filter).</b> <br><br><h3>  And so, let's get started. </h3><br><br><h4>  1. Initial setup. </h4><br>  I will describe the setting based on the fact that the system is already installed. <br>  I will stop only on adjustment of network interfaces.  There are two of them in my system: re0, rl0. <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /etc/hostname.re0 inet 192.168.254.1 255.255.255.0 inet alias 192.168.254.10 255.255.255.255 #      # cat /etc/hostname.rl0 inet 10.110.1.103 255.255.255.224</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To install the software, I use both packages and ports, so first of all we download the ports tree <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cd /tmp # ftp http://ftp://ftp.openbsd.org/pub/OpenBSD/4.7/ports.tar.gz # cd /usr # tar -zxvf /tmp/ports.tar.gz</span></span></code> </pre> <br><br>  In order to be able to update the ports tree, install cvsup: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cd /usr/ports # make search key=cvsup Port: cvsup-16.1hp2-no_x11 Path: net/cvsup,-main,no_x11 Info: network file distribution system Maint: The OpenBSD ports mailing-list &lt;ports@openbsd.org&gt; Index: net devel L-deps: B-deps: :lang/ezm3 R-deps: Archs: i386 # cd net/cvsup # make show=FLAVORS no_x11 # env FLAVOR="no_x11" make install</span></span></code> </pre> <br><br>  clear the port working directories <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># make clean # make clean=depends</span></span></code> </pre> <br><br>  In order not to put it off indefinitely, immediately configure cvsup config to update ports <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#cat /etc/cvsup-file-ports *default release=cvs *default delete use-rel-suffix *default umask=002 *default host=obsd.cec.mtu.edu *default base=/usr *default prefix=/usr *default tag=OPENBSD_4_7 OpenBSD-ports</span></span></code> </pre> <br><br>  Lists of available anonymous cvs servers can be found <a href="http://www.openbsd.org/anoncvs.html">here.</a> <br>  to update, just use the command <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cvsup -g -L 2 /etc/cvsup-file-ports</span></span></code> </pre> <br><br>  On this with ports, for now, finish. <br>  Let's go to the packages, in this step I will install all the software I need from the packages <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#export PKG_PATH=http://ftp.gamma.ru/pub/OpenBSD/`uname -r`/packages/`machine -a`/ #pkg_add libxml mod_scgi nut p5-XML-Parser php5-core php5-extensions\ php5-xmlrpc pptp screen xmlrpc-c bash</span></span></code> </pre> <br>  * It may well be that the list is incomplete, since the server has been set up for a long time, something I could miss <br><br><h4>  2. DNS (forwarding requests to the provider). </h4><br><br>  Make changes to /etc/rc.conf.local to run named <br><pre> <code class="bash hljs">named_flags=<span class="hljs-string"><span class="hljs-string">""</span></span> named_user=named named_chroot=/var/named</code> </pre> <br><br>  To forward requests by provider DNS, it is enough to make <br>  /var/named/etc/named.conf (in options) <br>  following lines <br><pre> <code class="bash hljs"> forwarders { 10.5.0.2;};</code> </pre> <br><br>  and /etc/resolv.conf will contain <br><pre> <code class="bash hljs">namesrver 127.0.0.1</code> </pre> <br><br><h4>  3. Soft RAID 1 (archive of family photos, music, travel videos and other important information). </h4><br><br>  To organize the soft raid in OpenBSD, let's do the following. <br>  (The array will be assembled from two Western Digital HDDs of 500GB each) <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># dmesg |grep WD wd2 at pciide0 channel 1 drive 0: WDC WD5000AAKS-00UU3A0 wd3 at pciide0 channel 1 drive 1: WDC WD5000AAKS-00UU3A0</span></span></code> </pre> <br><br>  Further, everything is strictly according to man softraid, we initialize the disks (we will overwrite the MBR bootcode and MBR partition table) <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># fdisk -iy wd2 # fdisk -iy wd3</span></span></code> </pre> <br><br>  create RAID partitions on disks <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># printf "a\n\n\n\nRAID\nw\nq\n\n" | disklabel -E wd2 # printf "a\n\n\n\nRAID\nw\nq\n\n" | disklabel -E wd3</span></span></code> </pre> <br><br>  we collect an array <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># bioctl -c 1 -l /dev/wd2a,/dev/wd3a softraid0</span></span></code> </pre> <br><br>  cleaning the beginning / title of a disc before using it is considered good form <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># dd if=/dev/zero of=/dev/rsd0c bs=1m count=1</span></span></code> </pre> <br><br>  initialize and format the array <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># fdisk -iy sd0 # printf "a\n\n\n\n4.2BSD\nw\nq\n\n" | disklabel -E sd0 # newfs /dev/rsd0a</span></span></code> </pre> <br><br>  The attentive reader will notice that when I cleaned the beginning of the newly created array, I used the name rsd0, whereas when creating the partition on the disk I indicated <br>  sd0.  To understand the differences, let's turn to the excellent book Absolute OpenBSD: UNIX for the Practical Paranoid by Michael Lucas <br><img src="https://habrastorage.org/storage/61eed949/ad4b0942/18bc841f/3ed2901f.png"><br>  As you can see in the table two types of devices are designated - ‚Äúraw‚Äù devices and block devices.  There are programs that are written to work with raw <br>  devices, and they can not work with block devices and, accordingly, vice versa. <br>  When writing / reading to / from block devices, the data is buffered, and upon reaching a certain limit (buffer size) the disk is accessed. <br>  When writing / reading to / from raw devices, data is transferred to the device immediately. <br>  M.Lukas gives the following example to facilitate the understanding of these mechanisms. <br><br>  Imagine that in front of you is a bottle that you need to fill with pills.  You take the pill with your right hand and shift it to the left, and <br>  so until the left hand is filled, then pour all the pills from your left hand into the bottle - this will work with block devices.  Your left hand <br>  played the role of a buffer.  Now put each tablet in a bottle, one at a time - this is working with raw devices. <br>  * I really hope that my clumsy translation of explanations will be clear <br><br>  The final step is to mount the array and fix / etc / fstab for automatic mounting when the system boots. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#mkdir /raid #mount /deb/sd0a /raid #cat /etc/fstab ---skip--- /dev/sd0a /raid ffs rw,nodev,nosuid 1 2 ---skip---</span></span></code> </pre> <br><br><h4>  4. rtorrent + rutorrent + apache2 (different torrents are needed, different torrents are important). </h4><br><br>  Even when preparing the first dish (aka the initial setting), we installed the necessary components for the torrent rocking, except for herself. <br>  We will install it from the ports. <br><br>  In order for rtorrent to work in conjunction with the rutorrent, you need to build it with the configure script option --with-xmlrpc-c, for this we move into the directory <br>  the port <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cd /usr/ports/net/rtorrent/</span></span></code> </pre> <br><br>  and correct the parameter CONFIGURE_ARGS in the Makefile <br><pre> <code class="bash hljs">CONFIGURE_ARGS= <span class="hljs-variable"><span class="hljs-variable">${CONFIGURE_SHARED}</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-debug --with-xmlrpc-c</code> </pre> <br>  * a small hint, a wonderful mechanism of Flavors, is nothing more than the options of the configure script, which is not difficult to guess by looking at the Makefile <br>  www / php5 / extensions, for example. <br><br>  I consider the rtorrent config to be redundant, I can only say that the torrents are added to a separate disk mounted to / data, which is exported by <br>  NFS.  Folder rights <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ls -la /data/ total 16 drwxr-xr-x 4 root wheel 512 Dec 11 18:41 . drwxr-xr-x 16 root wheel 512 Dec 20 13:13 .. drwxr-xr-x 12 p2p p2p 1024 Dec 20 20:19 torrents</span></span></code> </pre> <br><br>  Create a user from whom rtorrent will work <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># adduser Use option ``-silent'' if you don't want to see all warnings and questions. Reading /etc/shells Check /etc/master.passwd Check /etc/group Ok, let's go. Don't worry about mistakes. There will be a chance later to correct any input. Enter username []: p2p ---skip---</span></span></code> </pre> <br><br>  start rtorrent automatically, add to /etc/rc.local <br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -x /etc/rtorrent.sh ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -n <span class="hljs-string"><span class="hljs-string">' rtorrent'</span></span>; /etc/rtorrent.sh <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br><br>  rtorrent.sh <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /etc/rtorrent.sh su p2p -c '/usr/local/bin/screen -m -d -S rtorrent /usr/local/bin/rtorrent'</span></span></code> </pre> <br><br>  Next on the list is rutorrent. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cd /var/www/ # mkdir sites/ # cd sites/ # wget http://rutorrent.googlecode.com/files/rutorrent-3.2.tar.gz # tar xzvf rutorrent-3.2.tar.gz # chown -R www:www rutorrent # chmod -R 777 rutorrent/share/</span></span></code> </pre> <br><br>  Now let's tackle apache2 setup, it is already present in the system.  Automatic start at system start with the necessary parameters is solved as follows. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#cat /etc/rc.conf.local httpd_flags="-u"</span></span></code> </pre> <br>  * -u flag I added to disable apache chroot <br><br>  For rutorrent, I made a separate alias (which is mentioned in the first paragraph) and VirtualHost <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /var/www/conf/Includes/rutorrent.home.local.conf &lt;VirtualHost 192.168.254.10:80&gt; DocumentRoot /var/www/sites/rutorrent ServerName rutorrent.home.local ServerAlias www.rutorrent.home.local ErrorLog "|/usr/local/sbin/rotatelogs2 /var/log/httpd/http.rutorrent.home.local-error_log.%Y-%m-%d-%H_%M_%S 86400" CustomLog "|/usr/local/sbin/rotatelogs2 /var/log/httpd/http.rutorrent.home.local-access_log.%Y-%m-%d-%H_%M_%S 86400" common VirtualHost &lt;b&gt;!!! - ,      &lt;/b&gt; &lt;Directory /&gt; AllowOverride AuthConfig DirectoryIndex index.html Order Deny,Allow Deny from all Allow from 192.168.0.0/16 Directory &lt;b&gt;!!! - ,      &lt;/b&gt; SCGIMount /RPC2 127.0.0.1:5000</span></span></code> </pre> <br><br>  The final feature of this dish will be setting up password access to the rutorrent web interface. <br>  In the folder rutorrent'a create a file .htaccess <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /var/www/sites/rutorrent/.htaccess AuthName "Ololo can be found here!" AuthType Basic AuthUserFile /home/onotole/.htpasswd</span></span></code> </pre> <br><br>  and the password file at the specified path <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#htpasswd -c /home/onotole/.htpasswd admin</span></span></code> </pre> <br><br>  We start apache and check the fruits of our labors. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#apachectl start</span></span></code> </pre> <br><br>  A couple of screenshots =) <br><img src="https://habrastorage.org/storage/4d8773c5/a7a5ca65/652c3020/a1fbb631.png"><br><img src="https://habrastorage.org/storage/ec761d42/e20c1c31/b0790a53/9c55b2f0.png"><br><br><h4>  5. NFS server (network folder for access from LAN computers). </h4><br><br>  Folders available to clients for NFS mount <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># sed '/ *#/d; /^$/d' /etc/exports /data -alldirs -mapall=nobody -network=192.168.254 -mask=255.255.255.0 /raid -alldirs -mapall=nobody -network=192.168.254 -mask=255.255.255.0</span></span></code> </pre> <br><br>  Access rights <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#chmod 777 /raid</span></span></code> </pre> <br><br>  Run nfsd at system startup <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># grep nfs /etc/rc.conf.local nfs_server=YES</span></span></code> </pre> <br><br>  I have FreeBSD installed on my desktop by editing / etc / fstab mounting folders <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#grep gateway /etc/fstab gateway:/data /home/onotole/data nfs ro 0 0 gateway:/raid /home/onotole/share nfs rw 0 0 #mount ~/data #mount ~/share</span></span></code> </pre> <br><br><h4>  6. VPN tunnel with work.  FreeBSD (mpd5) OpenBSD (ppp) (I love, you know, sometimes working from home). </h4><br><br>  I need access to the local network at work all the time, so I set up a VPN tunnel between the server at work and the home server. <br><br>  Config mpd5 looks like this <br><pre> <code class="bash hljs">startup: <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> user onotole ololo admin <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> console self 127.0.0.1 5005 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> console open <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> web self 192.168.0.1 5006 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> web open default: load pptp_vpn pptp_vpn: create bundle static pptp1 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ipcp ranges 10.255.255.1/32 10.255.255.2/32 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> iface route 192.168.254.0/24 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> iface <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> proxy-arp <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> iface <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> on-demand <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> bundle <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> compression <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> bundle <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> crypt-reqd <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ccp yes mppc <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> mppc yes compress <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> mppc yes e128 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> mppc yes stateless create link static lpptp1 pptp <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> link action bundle pptp1 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> link no pap <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> link yes chap <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> auth authname <span class="hljs-string"><span class="hljs-string">"ololo"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> auth password <span class="hljs-string"><span class="hljs-string">"123"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> link mtu 1460 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> link keep-alive 0 0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> link max-redial -1 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> pptp self 1.2.3.4 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> pptp peer 0.0.0.0/0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> link <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> incoming</code> </pre><br><br>  In OpenBSD, do the following: <br>  change the <u>net.inet.gre.allow</u> parameter <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># sysctl -w net.inet.gre.allow=1 net.inet.gre.allow: 0 -&gt; 1</span></span></code> </pre> <br><br>  also change the value of the parameter in /etc/sysctl.conf <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># grep gre /etc/sysctl.conf net.inet.gre.allow=1</span></span></code> </pre> <br><br>  ppp daemon, main config <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># sed '/ *#/d; /^$/d' /etc/ppp/ppp.conf default: set log Phase Chat LCP IPCP CCP tun command disable ipv6cp vpn: set device "!/usr/local/sbin/pptp --nolaunchpppd work-onotole.com" set timeout 0 set lqrperiod 600 set redial 30 set authname ololo set authkey 123 set dial set login set mppe 128 stateless accept chap enable mssfixup disable acfcomp protocomp deny acfcom #</span></span></code> </pre><br><br>  when raising the link (add routes and distort pf.conf) <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /etc/ppp/ppp.linkup vpn: add work-onotole.com 10.110.1.97 add 192.168.0.0 255.255.255.0 10.255.255.1 ! sh -c "/sbin/pfctl -f /etc/pf.conf"</span></span></code> </pre> <br><br>  in case of a fall (delete routes and distort pf.conf) <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /etc/ppp/ppp.linkdown vpn: delete 192.168.0.0/24 delete work-onotole.com ! sh -c "/sbin/pfctl -f /etc/pf.conf"</span></span></code> </pre> <br><br>  Raise the link when starting the system <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /etc/hostname.tun0 !/usr/sbin/ppp -ddial vpn &gt;/dev/null 2&gt;&amp;1</span></span></code> </pre> <br><br><h4>  7. NUT + UPS Ippon Back power pro 400 (unexpected power outage is not a problem for us). </h4><br><br>  Create configs for demons. <br>  ups.conf <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /etc/nut/ups.conf [myups] driver = megatec port = /dev/tty00 #   com1 desc = "Server"</span></span></code> </pre> <br><br>  upsd.users <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /etc/nut/upsd.users [admin] password = ups123 allowfrom = localhost actions = SET instcmds = ALL [monuser] password = mon123 allowfrom = localhost upsmon master</span></span></code> </pre> <br><br>  upsd.conf <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /etc/nut/upsd.conf LISTEN 127.0.0.1 3493</span></span></code> </pre> <br><br>  upsmon.conf <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /etc/nut/upsmon.conf MONITOR myups@localhost 1 monuser mon123 master MINSUPPLIES 1 #      SHUTDOWNCMD "/sbin/shutdown -h now" #  POLLFREQALERT 5 #       DEADTIME 15 #  ,        POWERDOWNFLAG /etc/killpower #     FINALDELAY 60 # ,      </span></span></code> </pre> <br><br>  Set correct permissions on tty00 and load the driver <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># chown _ups:wheel /dev/tty00 # chmod 600 /dev/tty00 # /usr/local/bin/upsdrvctl start</span></span></code> </pre> <br><br>  Run the demons <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /usr/local/sbin/upsd # /usr/local/sbin/upsmon</span></span></code> </pre> <br><br>  Check the status of the UPS <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># upsc myups@localhost battery.charge: 97.5 battery.voltage: 13.60 battery.voltage.nominal: 12.0 driver.name: megatec driver.parameter.pollinterval: 2 driver.parameter.port: /dev/tty00 driver.version: 2.4.1 driver.version.internal: 1.6 input.frequency: 50.1 input.frequency.nominal: 50.0 input.voltage: 221.5 input.voltage.fault: 221.5 input.voltage.maximum: 245.0 input.voltage.minimum: 206.8 input.voltage.nominal: 220.0 output.voltage: 221.5 ups.beeper.status: enabled ups.delay.shutdown: 0 ups.delay.start: 2 ups.load: 19.0 ups.mfr: unknown ups.model: unknown ups.serial: unknown ups.status: OL #   ,     OB -    LB -   ups.temperature: 25.0 ups.type: standby</span></span></code> </pre> <br><br>  Add to autostart <br>  In /etc/rc.local prescribe autostart nut <br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -x /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/upsdrvctl ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -n <span class="hljs-string"><span class="hljs-string">' nut'</span></span> chown _ups:wheel /dev/tty00 chmod 600 /dev/tty00 /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/upsdrvctl start &gt; /dev/null 2&gt;&amp;1 /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/upsd &gt; /dev/null 2&gt;&amp;1 /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/upsmon &gt; /dev/null 2&gt;&amp;1 <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br><br>  Turning off the power after the data on the disks are synchronized, we will add the following to rc.shutdown <br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -f /etc/killpower ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/upsdrvctl shutdown sleep 60 <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br><br><h4>  8. Firewall (great PF packet filter). </h4><br><br>  We include packet forwarding <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#sysctl -w net.inet.ip.forwarding=1</span></span></code> </pre> <br><br>  make the appropriate changes in /etc/sysctl.conf <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#grep ip.forwarding /etc/sysctl.conf net.inet.ip.forwarding=1 # 1=Permit forwarding (routing) of IPv4 packets</span></span></code> </pre> <br><br>  PF config is more than simple <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># sed '/ *#/d; /^$/d' /etc/pf.conf ext_if="rl0" int_if="re0" vpn_if="tun0" set block-policy return set skip on lo0 match in all scrub (no-df) block all pass on $int_if pass on $vpn_if pass out on $ext_if #    pass out on $ext_if from $int_if:network to any nat-to ($ext_if) #  3333(tcp,udp)  dc++ pass in on $ext_if proto {tcp,udp} from any port 3333 rdr-to 192.168.254.2 synproxy state</span></span></code> </pre> <br><br>  Everything!  OpenBSD is staffed =) <br><img src="https://habrastorage.org/storage/b85fbce8/a4249bfd/f65cf15c/3095b2a4.jpg"><br>  That turned out to be my home servachok. <br>  I really like working with OpenBSD, I like it without compromise, simplicity and reliability.  By the way, I really appreciated the value of the man command. <br>  only now and thanks to this OS.  The system documentation is beyond praise.  Developers bow low and deepest gratitude. <br><br>  When preparing, I used the following sources: <br>  1. man) <br>  2. <a href="http://openbsd.org/faq/index.html">http://openbsd.org/faq/index.html</a> <br>  3. <a href="http://unixadmins.su/index.php/topic,196.0.html">http://unixadmins.su/index.php/topic,196.0.html</a> <br>  4. <a href="http://www.openbsd.ru/docs/steps/nut.html">www.openbsd.ru/docs/steps/nut.html</a> <br>  5. <a href="http://mpd.sourceforge.net/doc5/mpd.html">mpd.sourceforge.net/doc5/mpd.html</a> <br>  6. Absolute OpenBSD: Unix for the practical paranoid <br>  Michael Lucas special thanks for his, without a doubt, masterpiece books! </div><p>Source: <a href="https://habr.com/ru/post/110477/">https://habr.com/ru/post/110477/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../110469/index.html">So you meant to be a programmer ...</a></li>
<li><a href="../110470/index.html">FAS vs. Ru-Center</a></li>
<li><a href="../110474/index.html">From HTC Desire to HD: Is it worth it?</a></li>
<li><a href="../110475/index.html">Report on the second meeting of the Apple Developers Community</a></li>
<li><a href="../110476/index.html">What is the difference between real testers and fake?</a></li>
<li><a href="../110478/index.html">5 major mistakes online stores</a></li>
<li><a href="../110479/index.html">3D buildings from OpenStreetMap</a></li>
<li><a href="../11048/index.html">A little bit about yourself</a></li>
<li><a href="../110480/index.html">Adobe (ADBE): the fourth quarter of 2010 (August - November)</a></li>
<li><a href="../110482/index.html">Data Deduplication - NetApp Approach</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>