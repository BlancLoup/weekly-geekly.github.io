<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Archiving Microsoft SQL Server Databases</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On duty, I come across MSSQL database servers. Often it is necessary to quickly set up a database backup, on test servers, and in production as well. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Archiving Microsoft SQL Server Databases</h1><div class="post__text post__text-html js-mediator-article">  On duty, I come across MSSQL database servers.  Often it is necessary to quickly set up a database backup, on test servers, and in production as well.  At the same time, you can find many separate monosyllabic sources in the network, as it is necessary or not necessary to archive, but nowhere are there any more or less universal ready-made solutions.  At the new place of work I again encountered this problem.  For certain reasons, all the databases in the company (for now) are in the simple recovery model mode, because the solution given in the text is not complete, but judging by the questions on the forums, beginners and just developers and administrators far from these tasks, it is quite suitable decision, well, in the process, everyone can add it himself. <br><a name="habracut"></a><br>  The script archives the specified databases, taking into account on which days of the week to make full copies, how much to store the last full and differential archives.  Designed for archiving databases with a simple recovery model, if you need to archive logs too, then by analogy you can easily add the script yourself.  Perhaps, when I need it, I will add this script.  At the end of archiving, obsolete database archives are deleted from the disk. <br><br>  This code can be immediately added to the assigned task and run it once a day or more often, as you like, while setting some parameters, the script is sufficiently commented, I‚Äôll stop only briefly: <br><br>  Specify the paths where we will store our archives, at the moment of starting the archiving in these folders, subfolders will be created for each archived database: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--    declare @FullPath varchar(500) = 'D:\Work\Full' declare @DiffPath varchar(500) = 'D:\Work\Diff'</span></span></code> </pre> <br>  If we do not specify a list of specific databases in @IncludeBase for archiving, then all databases are taken and the databases specified in @ExcludeBase are excluded from them: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--       declare @IncludeBase varchar(500) = '' --   ,     ,       declare @ExcludeBase varchar(500) = 'master, model, tempdb'</span></span></code> </pre><br>  Here we specify the days of the week separated by commas for the full archives: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--      declare @FullDay varchar(13) = '7'</span></span></code> </pre><br>  How many last copies for each type of archives to leave on the disk: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--     declare @MinFull int = 3 declare @MinDiff int = 3</span></span></code> </pre><br>  When the script is running on the server, compression of archives is enabled and the ability to run the xp_cmdshell procedure.  The service must have read / write / delete permissions to directories with archives. <br><br>  Script text: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--    declare @FullPath varchar(500) = 'D:\Work\Full' declare @DiffPath varchar(500) = 'D:\Work\Diff' --       declare @IncludeBase varchar(500) = '' --   ,     ,       declare @ExcludeBase varchar(500) = 'model, tempdb' --      declare @FullDay varchar(13) = '7' --     declare @MinFull int = 3 declare @MinDiff int = 3 --   EXEC sp_configure 'show advanced options', 1; EXEC sp_configure 'backup compression default', 1; RECONFIGURE WITH OVERRIDE; --  xp_cmdshell EXEC sp_configure 'show advanced options', 1; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE WITH OVERRIDE; set datefirst 1 declare @tempcmd varchar(500) ='' declare @tempname varchar(500) ='' --   set @tempcmd= 'md '+@FullPath exec xp_cmdshell @tempcmd, no_output set @tempcmd= 'md '+@DiffPath exec xp_cmdshell @tempcmd, no_output --      declare @BaseListIncl table (name varchar(200)) declare @BaseListExcl table (name varchar(200)) if @IncludeBase='' insert into @BaseListIncl select name from sys.databases where state_desc='ONLINE' else while len(@IncludeBase)&gt;0 begin if CHARINDEX (',',@IncludeBase)&gt;0 begin insert into @BaseListIncl select name from sys.databases where state_desc='ONLINE' and name = SUBSTRING(@IncludeBase,1, CHARINDEX (',',@IncludeBase)-1) set @IncludeBase=LTRIM(RTRIM(SUBSTRING(@IncludeBase,CHARINDEX (',',@IncludeBase)+1, LEN(@IncludeBase)))) end else begin insert into @BaseListIncl select name from sys.databases where state_desc='ONLINE' and name = @IncludeBase set @IncludeBase='' end end if @ExcludeBase='' insert into @BaseListIncl select name from sys.databases where state_desc='ONLINE' else while len(@ExcludeBase)&gt;0 begin if CHARINDEX (',',@ExcludeBase)&gt;0 begin insert into @BaseListExcl select name from sys.databases where state_desc='ONLINE' and name = SUBSTRING(@ExcludeBase,1, CHARINDEX (',',@ExcludeBase)-1) set @ExcludeBase=LTRIM(RTRIM(SUBSTRING(@ExcludeBase,CHARINDEX (',',@ExcludeBase)+1, LEN(@ExcludeBase)))) end else begin insert into @BaseListExcl select name from sys.databases where state_desc='ONLINE' and name = @ExcludeBase set @ExcludeBase='' end end --      delete from @BaseListIncl where name in (select name from @BaseListExcl) declare BaseList cursor for select name from @BaseListIncl declare @BaseName varchar(500) ='' -- ,      declare @type bit = 0 declare @notexistfull bit = 0 if CHARINDEX(CAST(DATEPART(weekday,getdate()) as varchar(1)),@FullDay)&gt;0 set @type=1 open BaseList fetch next from BaseList into @BaseName while @@FETCH_STATUS = 0 begin -- ,         if EXISTS (SELECT * FROM msdb.dbo.backupset s INNER JOIN msdb.dbo.backupmediafamily mf ON s.media_set_id = mf.media_set_id WHERE s.database_name=@BaseName and s.TYPE='D' ) set @notexistfull=0 else set @notexistfull=1 --    if @type=1 OR @BaseName='master' OR @notexistfull=1 set @tempcmd= 'md '+@FullPath+'\'+@BaseName else set @tempcmd= 'md '+@DiffPath+'\'+@BaseName exec xp_cmdshell @tempcmd, no_output if @type=1 OR @BaseName='master' OR @notexistfull=1 begin -- full backup set @tempname = @FullPath+'\'+@BaseName+'\'+@BaseName+'_'+CONVERT(varchar(8), GETDATE(), 112)+ '-' + REPLACE(CONVERT(varchar, GETDATE(),114),':','') +'.FULL' backup database @BaseName to disk = @tempname end else begin -- diff backup set @tempname = @DiffPath+'\'+@BaseName+'\'+@BaseName+'_'+CONVERT(varchar(8), GETDATE(), 112)+ '-' + REPLACE(CONVERT(varchar, GETDATE(),114),':','') +'.DIFF' backup database @BaseName to disk = @tempname with differential end --    declare @delpath varchar(500)='' declare delbackup cursor for SELECT mf.physical_device_name FROM msdb.dbo.backupset s INNER JOIN msdb.dbo.backupmediafamily mf ON s.media_set_id = mf.media_set_id WHERE s.database_name=@BaseName and s.TYPE='D' and not s.backup_set_id in ( SELECT TOP (@MinFull) s.backup_set_id FROM msdb.dbo.backupset s INNER JOIN msdb.dbo.backupmediafamily mf ON s.media_set_id = mf.media_set_id WHERE s.database_name=@BaseName and s.TYPE='D' ORDER BY s.backup_finish_date desc ) union all SELECT mf.physical_device_name FROM msdb.dbo.backupset s INNER JOIN msdb.dbo.backupmediafamily mf ON s.media_set_id = mf.media_set_id WHERE s.database_name=@BaseName and s.TYPE='I' and not s.backup_set_id in ( SELECT TOP (@MinDiff) s.backup_set_id FROM msdb.dbo.backupset s INNER JOIN msdb.dbo.backupmediafamily mf ON s.media_set_id = mf.media_set_id WHERE s.database_name=@BaseName and s.TYPE='I' ORDER BY s.backup_finish_date desc ) open delbackup fetch next from delbackup into @delpath while @@FETCH_STATUS = 0 begin set @tempcmd= 'del /f /q '+QUOTENAME(@delpath,'"') exec xp_cmdshell @tempcmd, no_output fetch next from delbackup into @delpath end close delbackup deallocate delbackup fetch next from BaseList into @BaseName end close BaseList deallocate BaseList --   MSDB     ( 120 ) declare @oldest DATETIME SET @oldest = DATEADD(DAY, -120, GETDATE()) EXEC msdb.dbo.sp_delete_backuphistory @oldest_date = @oldest</span></span></code> </pre><br>  This script is written for specific tasks, it‚Äôs impossible to discuss that in production, and so on, I think it makes no sense, it‚Äôs published in order to give unprepared people an opportunity to get a ready-made solution. <br><br>  I <a href="https://habrahabr.ru/users/ideatum/" class="user_link">‚Äôll</a> add from the <a href="https://habrahabr.ru/users/ideatum/" class="user_link">ideatum</a> user <a href="https://habrahabr.ru/users/ideatum/" class="user_link">note</a> that the xp_cmdshell procedure is disabled by default in Microsoft SQL Server, for security reasons. <br><br>  UPDATE <br>  The script is modified to create a full backup for the database at startup, if it is missing, even if today is not the day to create it <br><br>  UPDATE2 <br>  Added check on the state of the database (ONLINE) </div><p>Source: <a href="https://habr.com/ru/post/316658/">https://habr.com/ru/post/316658/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316646/index.html">State programming in UIControl</a></li>
<li><a href="../316648/index.html">Monopoly on DDoS: Two hackers have created a botnet of 1 million devices based on Mirai</a></li>
<li><a href="../316650/index.html">Pseudo-encapsulation of legacy include when there is no time to refactor</a></li>
<li><a href="../316652/index.html">Using memcached and redis in high-load projects</a></li>
<li><a href="../316654/index.html">How to become a product manager. Part 2</a></li>
<li><a href="../316660/index.html">AWS Snowmobile: transporting petabyte of data to the cloud on ... trucks from Amazon</a></li>
<li><a href="../316662/index.html">Amazon announced new projects for developers and "mere mortals"</a></li>
<li><a href="../316664/index.html">We are broadcasting on Facebook beautifully: captions and their customizer</a></li>
<li><a href="../316666/index.html">We write interactive Telegram bots on Python</a></li>
<li><a href="../316668/index.html">Hype driven development</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>