<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write interactive Telegram bots on Python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think everyone here is more or less aware of the Telegram messenger. The creator declares that it is the safest messenger with a self-developed kill...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write interactive Telegram bots on Python</h1><div class="post__text post__text-html js-mediator-article">  I think everyone here is more or less aware of the <a href="http://telegram.me/">Telegram</a> messenger.  The creator declares that it is the safest messenger with a self-developed killer encryption algorithm, but we, the developers, of course, are much more interested in something else.  Bots! <br><br>  This theme, of course, did not just rise on Habr√©: bots were written <a href="https://habrahabr.ru/post/262247/">in Python with tornado</a> , <a href="https://habrahabr.ru/post/276389/">Node.js</a> , <a href="https://habrahabr.ru/post/264707/">Ruby with a special gem</a> , <a href="https://habrahabr.ru/post/279179/">Ruby on Rails</a> , <a href="https://habrahabr.ru/sandbox/103396/">C #</a> , <a href="https://habrahabr.ru/post/304822/">C # with WCF,</a> and even <a href="https://habrahabr.ru/post/264035/">PHP</a> ;  bots wrote for <a href="https://habrahabr.ru/post/302688/">RSS feeds</a> , <a href="https://habrahabr.ru/post/316148/">monitoring sites</a> , <a href="https://habrahabr.ru/post/265305/">remotely turning on the computer</a> and, probably, for many, many other things. <br><br>  And yet I will take the liberty to travel this topic again and in addition to this show some Python magic.  We will write the framework ‚Ñ¢ for easy writing non-trivial conversational bots based on the <a href="https://github.com/python-telegram-bot/python-telegram-bot">python-telegram-bot</a> package. <br><a name="habracut"></a><br><h1>  How to conceive a bot? </h1><br>  This question is best answered by <a href="https://core.telegram.org/bots">official documentation</a> .  The process looks like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/5b4/bff/0e1/5b4bff0e1bfc4f89b414dc7d27745a41.png"><br><br>  Simple, isn't it?  (Be prudent and do not take good nicknames without a good reason!) <br><br><h1>  The easiest bot </h1><br>  First, we will look at the <a href="https://github.com/python-telegram-bot/python-telegram-bot/wiki/Extensions-%25E2%2580%2593-Your-first-Bot">tutorial of</a> our basic package in order to understand how a simple bot begins.  Following code <br><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- from telegram.ext import Updater #   python-telegram-bot,  Python- from telegram.ext import CommandHandler #  -  telegram ¬Ø\_(„ÉÑ)_/¬Ø def start(bot, update): #    update: https://core.telegram.org/bots/api#update bot.sendMessage(chat_id=update.message.chat_id, text=".") updater = Updater(token='TOKEN') #  ,     ! start_handler = CommandHandler('start', start) #    #    /start updater.dispatcher.add_handler(start_handler) #     updater.start_polling() # !</span></span></code> </pre> <br>  creates a bot that dryly answers ‚ÄúHello.‚Äù when you click on the Start button (or manually enter the <code>/start</code> command) and is meaningfully silent during any subsequent actions on your part. <br><br>  Accordingly, if we want to hang up the handlers of any text messages or any commands, we will need to write <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram.ext <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Filters, MessageHandler <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle_text</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bot, update)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... def handle_command(bot, update): # ... # MessageHandler --   ,      text_handler = MessageHandler(Filters.text, self.handle_text) command_handler = MessageHandler(Filters.command, self.handle_command) #      updater.dispatcher.add_handler(text_handler) #    , updater.dispatcher.add_handler(command_handler) #      ()</span></span></code> </pre> <br>  (For further details, with a clear conscience, refer to the <a href="https://github.com/python-telegram-bot/python-telegram-bot/wiki/Introduction-to-the-API">documentation python-telegram-bot</a> .) <br><br>  Loaded with this theoretical minimum, we can finally think about how to write our nontrivial bot.  First, let's get back to the problem statement.  By a dialogue bot, I mean a bot that mostly conducts a simple textual dialogue with a user ‚Äî with questions, answers, a non-linear storyline, disappointing endings, and everyone like that (played ‚Äú <a href="http://telegram.me/everlastingsummerbot">Endless Summer</a> ‚Äù?). On the contrary, <em>they do not</em> fall into the sphere of our current interests bots that extend Telegram functionality in various ways (like a <a href="https://telegram.me/like">bot for likes</a> );  accordingly, we omit the addition of all sorts of <a href="https://core.telegram.org/bots">buns</a> like <a href="https://core.telegram.org/bots">inline mode</a> , <a href="https://core.telegram.org/bots">games</a> , <a href="https://core.telegram.org/bots">updating controls on the fly</a> and all that stuff. <br><br>  The problem with complex conversational bots is that non-trivial dialogue requires state storage.  The work of asynchronous dialogs requires constant interruptions to wait for a message from the user;  the state must be saved, then restored, jumped to the code responsible for processing the next message, and so on;  in general, code organization becomes a rather depressing problem.  Interrupt, continue ... nothing like?  Well, let's see how this problem can be more gracefully circumvented using magic <code>yield</code> . <br><br><h1>  50 shades yield </h1><br>  What do we know about <code>yield</code> ?  Well, we all know that this is such a thing to write generators, that is, such lazy and potentially endless lists: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fibonacci</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> a, b = <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> a a, b = b, a + b f = fibonacci()</code> </pre><br>  Now the object <code>f</code> is such a magic box;  it is necessary <s>to put a hand into it</s> to write <code>next(f)</code> , and we get the next Fibonacci number, but it is worth <s>turning it up</s> to write <code>list(f)</code> , as we go into an infinite loop, which most likely ends in a tragic death of the system from a lack of RAM. <br><br>  We know that generators are fast, convenient and very Python-style.  We have a module <code>itertools</code> , offering generators for every taste and color.  But we have something else. <br><br>  Where the less well known skills of the word <code>yield</code> are the abilities ... to return values ‚Äã‚Äãand throw exceptions!  Yes, yes, if we write: <br><br><pre> <code class="python hljs">f.throw(Exception)</code> </pre> <br>  That calculation of Fibonacci numbers will break in the most tragic way - the exception in the line with <code>yield</code> . <br><br>  In turn, calling <code>f.send(something)</code> will force the <code>yield</code> construct to return a value, and then immediately return <code>next(f)</code> .  It is enough to equate the <code>yield</code> variable in order to catch the passed value: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doubler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(start)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: start = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> (start, start) d = doubler(<span class="hljs-number"><span class="hljs-number">42</span></span>) print(next(d)) <span class="hljs-comment"><span class="hljs-comment">#  (42, 42) print(next(d)) #  (None, None),     - ! print(d.send(43)) #  (43, 43) -- yield  43,      yield</span></span></code> </pre><br>  But that's not all.  Starting in Python 3.3, generators can delegate execution to each other using the <code>yield from</code> construct: instead of <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">concatenate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(iterable1, iterable2)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> iterable1: <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> iterable2: <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> item</code> </pre> <br>  she lets us write <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">concatenate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(iterable1, iterable2)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> iterable1 <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> iterable2</code> </pre> <br>  But it would be an understatement to say that <code>yield from</code> allows us to only save lines of code on cycles.  The fact is that it also takes care of <code>send</code> and <code>throw</code> ‚Äî when called, they will interact not with the function <code>concatenate</code> , but with one of two generators to which it transfers control.  (If it turns out not to be generators ... well, oops.) <br><br>  And <code>yield from</code> also knows how to return a value: for this, the right to non-trivial (that is, returning something, and not just terminating execution) <code>return</code> generator functions: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">despaired_person</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"I'm tired of my uselessness"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">despair_expresser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> despaired_person() print(result) print(list(f())) <span class="hljs-comment"><span class="hljs-comment">#  # I'm tired of my uselessness # [None, None, None]</span></span></code> </pre><br>  Why am I doing all this?  Oh yes.  These tricks, taken together, will allow us to easily and naturally write our interactive bots. <br><br><h1>  We write a wrapper </h1><br>  So, let the dialogue with each user is conducted by the generator.  <code>yield</code> will issue a message to the outside, which must be sent to the user, and return the answer to it (as soon as it appears).  Let's write a simple class that knows how to do it. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> collections <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram.ext <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Filters <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram.ext <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MessageHandler <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram.ext <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Updater <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DialogBot</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, token, generator)</span></span></span><span class="hljs-function">:</span></span> self.updater = Updater(token=token) <span class="hljs-comment"><span class="hljs-comment">#   handler = MessageHandler(Filters.text | Filters.command, self.handle_message) self.updater.dispatcher.add_handler(handler) #      self.handlers = collections.defaultdict(generator) #   "id  -&gt; " def start(self): self.updater.start_polling() def handle_message(self, bot, update): print("Received", update.message) chat_id = update.message.chat_id if update.message.text == "/start": #    /start,     --  #     ,    self.handlers.pop(chat_id, None) if chat_id in self.handlers: #    ,    .send(),  #      try: answer = self.handlers[chat_id].send(update.message) except StopIteration: #      --  ,     del self.handlers[chat_id] # ( ,    ,     ) return self.handle_message(bot, update) else: #   . defaultdict      # ,          .next() # (.send()     yield) answer = next(self.handlers[chat_id]) #     print("Answer: %r" % answer) bot.sendMessage(chat_id=chat_id, text=answer)</span></span></code> </pre><br>  Well, it remains to compose the dialogue, which we will play!  Let's talk about Python. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dialog</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> answer = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-string"><span class="hljs-string">"!    ,    ?"</span></span> <span class="hljs-comment"><span class="hljs-comment">#    ,   #   ,      name = answer.text.rstrip(".!").split()[0].capitalize() likes_python = yield from ask_yes_or_no(" , %s.   ?" % name) if likes_python: answer = yield from discuss_good_python(name) else: answer = yield from discuss_bad_python(name) def ask_yes_or_no(question): """    ,  ¬´¬ª  ¬´¬ª. : bool """ answer = yield question while not ("" in answer.text.lower() or "" in answer.text.lower()): answer = yield "   ?" return "" in answer.text.lower() def discuss_good_python(name): answer = yield "  , %s,  !       ?" % name likes_article = yield from ask_yes_or_no(".   , ,   ? ?") if likes_article: answer = yield "!" else: answer = yield "." return answer def discuss_bad_python(name): answer = yield "--. %s,   !      ?" % name likes_article = yield from ask_yes_or_no( "     .  " "  ,  ,   ?") if likes_article: answer = yield "  ." else: answer = yield " ¬´¬ª? ¬´,  ¬ª  ¬´, ¬ª?" answer = yield ",     ." return answer if __name__ == "__main__": dialog_bot = DialogBot(sys.argv[1], dialog) dialog_bot.start()</span></span></code> </pre><br>  And it works!  The result looks like this: <br><br><img src="https://habrastorage.org/files/100/5ff/7b6/1005ff7b66ab40a18670e1bddc517066.png"><br><br><h1>  Add markup </h1><br>  Telegram bots are strong because they can throw HTML and Markdown markup into their users;  this opportunity to pass us by would be impermissible.  To understand how to send a markup message, let's take a look at the description of the <code>Bot.sendMessage</code> function: <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, chat_id, text, parse_mode=None, disable_web_page_preview=None, disable_notification=False, reply_to_message_id=None, reply_markup=None, timeout=None, **kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Use this method to send text messages. Args: chat_id (str): ... text (str): ... parse_mode (Optional[str]): Send Markdown or HTML, if you want Telegram apps to show bold, italic, fixed-width text or inline URLs in your bot's message. disable_web_page_preview (Optional[bool]): ... disable_notification (Optional[bool]): ... reply_to_message_id (Optional[int]): ... reply_markup (Optional[:class:`telegram.ReplyMarkup`]): Additional interface options. A JSON-serialized object for an inline keyboard, custom reply keyboard, instructions to hide reply keyboard or to force a reply from the user. timeout (Optional[float]): ... ... """</span></span></code> </pre><br>  Aha  It is enough to pass the argument <code>parse_mode="HTML"</code> or <code>parse_mode="Markdown"</code> .  One could just add this to our challenge, but let's make it a bit more deadly: add special objects that need to be raised to trigger the use of markup: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Message</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, text, **options)</span></span></span><span class="hljs-function">:</span></span> self.text = text self.options = options <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Markdown</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Message)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, text, **options)</span></span></span><span class="hljs-function">:</span></span> super(Markup, self).__init__(text, parse_mode=<span class="hljs-string"><span class="hljs-string">"Markdown"</span></span>, **options) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HTML</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Message)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, text, **options)</span></span></span><span class="hljs-function">:</span></span> super(HTML, self).__init__(text, parse_mode=<span class="hljs-string"><span class="hljs-string">"HTML"</span></span>, **options)</code> </pre><br>  Now sending messages will look like this: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, bot, update)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ...... print("Answer: %r" % answer) self._send_answer(bot, chat_id, answer) def _send_answer(self, bot, chat_id, answer): if isinstance(answer, str): answer = Message(answer) bot.sendMessage(chat_id=chat_id, text=answer.text, **answer.options)</span></span></code> </pre><br>  To demonstrate, let's modify <code>ask_yes_or_no()</code> : <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ask_yes_or_no</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(question)</span></span></span><span class="hljs-function">:</span></span> answer = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> question <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> (<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> answer.text.lower() <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> answer.text.lower()): answer = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> HTML(<span class="hljs-string"><span class="hljs-string">" &lt;b&gt;&lt;/b&gt;  &lt;b&gt;&lt;/b&gt;?"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> answer.text.lower()</code> </pre><br>  The result is obvious: <br><br><img src="https://habrastorage.org/files/d60/18c/55e/d6018c55e2674881af3d9924e41fa16c.png"><br><br><h1>  Add buttons </h1><br>  The only thing we lack and that would be quite useful for writing interactive bots is a keyboard with a choice of answer options.  To create a keyboard, we just need to add the <code>reply_markup</code> key to <code>reply_markup</code> ;  but let's try to simplify and abstract our code inside the generators as much as possible.  Here the decision is easier.  Let, for example, <code>yield</code> returns not one object, but several at once;  if among them there is a list or a list of lists with lines, for example: <br><br><pre> <code class="python hljs">answer = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> ( <span class="hljs-string"><span class="hljs-string">"   1  9"</span></span>, [ [<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-string"><span class="hljs-string">"3"</span></span>], [<span class="hljs-string"><span class="hljs-string">"4"</span></span>, <span class="hljs-string"><span class="hljs-string">"5"</span></span>, <span class="hljs-string"><span class="hljs-string">"6"</span></span>], [<span class="hljs-string"><span class="hljs-string">"7"</span></span>, <span class="hljs-string"><span class="hljs-string">"8"</span></span>, <span class="hljs-string"><span class="hljs-string">"9"</span></span>], ] )</code> </pre> <br>  , then we think that these are keyboard buttons, and we want to get something like the following result: <br><br><img src="https://habrastorage.org/files/0a9/b60/405/0a9b6040517e4c74ba7e7a1ad4832431.png"><br><br>  <code>_send_answer()</code> then converted to something like this: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_send_answer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, bot, chat_id, answer)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">"Sending answer %r to %s"</span></span> % (answer, chat_id)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(answer, collections.abc.Iterable) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isinstance(answer, str): <span class="hljs-comment"><span class="hljs-comment">#     --     answer = list(map(self._convert_answer_part, answer)) else: #     --      answer = [self._convert_answer_part(answer)] #  ,    ,     # ¬´¬ª --       - current_message = None for part in answer: if isinstance(part, Message): if current_message is not None: #     ,    #    (   ) options = dict(current_message.options) options.setdefault("disable_notification", True) bot.sendMessage(chat_id=chat_id, text=current_message.text, **options) current_message = part if isinstance(part, ReplyMarkup): # ,    !   . #   --  ,  . current_message.options["reply_markup"] = part #       . if current_message is not None: bot.sendMessage(chat_id=chat_id, text=current_message.text, **current_message.options) def _convert_answer_part(self, answer_part): if isinstance(answer_part, str): return Message(answer_part) if isinstance(answer_part, collections.abc.Iterable): # ? answer_part = list(answer_part) if isinstance(answer_part[0], str): # !     . # ,     --   . return ReplyKeyboardMarkup([answer_part], one_time_keyboard=True) elif isinstance(answer_part[0], collections.abc.Iterable): #  ? if isinstance(answer_part[0][0], str): # ! return ReplyKeyboardMarkup(map(list, answer_part), one_time_keyboard=True) return answer_part</span></span></code> </pre> <br>  As a demonstration, change the <code>ask_yes_or_no()</code> and <code>discuss_bad_python()</code> : <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ask_yes_or_no</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(question)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""    ,  ¬´¬ª  ¬´¬ª. : bool """</span></span> answer = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> (question, [<span class="hljs-string"><span class="hljs-string">"."</span></span>, <span class="hljs-string"><span class="hljs-string">"."</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> (<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> answer.text.lower() <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> answer.text.lower()): answer = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> HTML(<span class="hljs-string"><span class="hljs-string">" &lt;b&gt;&lt;/b&gt;  &lt;b&gt;&lt;/b&gt;?"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> answer.text.lower() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">discuss_bad_python</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name)</span></span></span><span class="hljs-function">:</span></span> answer = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-string"><span class="hljs-string">"--. %s,   !      ?"</span></span> % name likes_article = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ask_yes_or_no( <span class="hljs-string"><span class="hljs-string">"     .  "</span></span> <span class="hljs-string"><span class="hljs-string">"  ,  ,   ?"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> likes_article: answer = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-string"><span class="hljs-string">"  ."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: answer = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> ( <span class="hljs-string"><span class="hljs-string">" ¬´¬ª? ¬´,  ¬ª  ¬´, ¬ª?"</span></span>, [<span class="hljs-string"><span class="hljs-string">",  !"</span></span>, <span class="hljs-string"><span class="hljs-string">", !"</span></span>] ) answer = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-string"><span class="hljs-string">",     ."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> answer</code> </pre><br>  Result: <br><br><img src="https://habrastorage.org/files/03e/992/bfa/03e992bfabcf47cbb2a04d929d44c146.png"><br><br><h1>  Conclusion </h1><br>  Generators in Python are a powerful tool, and using it in the right situations can significantly reduce and simplify code.  See how beautifully we, for example, carried the question ‚Äúyes or no‚Äù into a separate function, while leaving him the right to conduct additional communication with the user.  We could also put a name in question into a separate function, and teach him to clarify with the user, whether we understood him correctly, and so on and so forth.  The generators themselves keep the state of the dialogue for us, and they themselves are able to continue it from the required moment.  All for us! <br><br>  I hope this article was useful to someone.  As usual, feel free to report all typos, spelling and grammatical errors in PM.  All the code for the article is in the <a href="https://github.com/Saluev/python-telegram-dialog-bot/tree/habrahabr-316666">repository on Github</a> ( <code>habrahabr-316666</code> ).  I will not give the link to the bot and I will not keep it alive, of course, in the near future, otherwise the habraeffect will cover it with my computer.  Successes in creating their interactive bots üòâ </div><p>Source: <a href="https://habr.com/ru/post/316666/">https://habr.com/ru/post/316666/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316654/index.html">How to become a product manager. Part 2</a></li>
<li><a href="../316658/index.html">Archiving Microsoft SQL Server Databases</a></li>
<li><a href="../316660/index.html">AWS Snowmobile: transporting petabyte of data to the cloud on ... trucks from Amazon</a></li>
<li><a href="../316662/index.html">Amazon announced new projects for developers and "mere mortals"</a></li>
<li><a href="../316664/index.html">We are broadcasting on Facebook beautifully: captions and their customizer</a></li>
<li><a href="../316668/index.html">Hype driven development</a></li>
<li><a href="../316670/index.html">We build PVS-Studio in Eclipse CDT (Linux)</a></li>
<li><a href="../316672/index.html">Unity: squeezing compressed</a></li>
<li><a href="../316674/index.html">Veeam 9.5 and VMware vCloud Director backup</a></li>
<li><a href="../316676/index.html">Front-end and ad blockers (for example, Adblock Plus)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>