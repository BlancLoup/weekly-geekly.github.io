<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The best architecture based on Docker and Kubernetes - myth or reality?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How has the software world changed in the era of Docker and Kubernetes? Is it possible to build an architecture once and for all based on these techno...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The best architecture based on Docker and Kubernetes - myth or reality?</h1><div class="post__text post__text-html js-mediator-article"><p>  How has the software world changed in the era of Docker and Kubernetes?  Is it possible to build an architecture once and for all based on these technologies?  Is it possible to unify the development and integration processes when everything is ‚Äúpacked‚Äù into containers?  What are the requirements for such solutions?  What restrictions do they carry with them?  Will they make life easier for simple developers or will it make it harder? </p><br><p><img src="https://habrastorage.org/webt/cq/tj/9q/cqtj9qdfa8wbrcf-d5si7bjxona.png"></p><br><p>  It's time to answer all these and not only these questions!  (In the text and original illustrations) </p><a name="habracut"></a><br><p>  This article will lead you in a circle from real life to development processes and through architecture will bring you back to real life, answering the most important questions in each of these sectors.  I will also try to identify a number of components and principles that should become part of the architecture, without going into specific implementations, but only giving examples of possible available solutions. </p><br><p>  The final conclusion about the question from the headline of the article can upset you, just as much to please other readers - everything will depend on your experience, how you take the following story from three chapters and, quite likely, the mood on this day, so do not hesitate to healthy discussions and questions after reading! </p><br><h2 id="oglavlenie">  Table of contents </h2><br><ul><li>  <a href="https://habr.com/ru/post/321810/">From real life to development processes</a> <br><ul><li>  <a href="https://habr.com/ru/post/321810/">Installing a Developer Environment</a> </li><li>  <a href="https://habr.com/ru/post/321810/">Automated Testing</a> </li><li>  <a href="https://habr.com/ru/post/321810/">Shipping Systems</a> </li><li>  <a href="https://habr.com/ru/post/321810/">Continuity in integration and delivery</a> </li><li>  <a href="https://habr.com/ru/post/321810/">Rollback system</a> </li><li>  <a href="https://habr.com/ru/post/321810/">Information security and audit</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/321810/">From processes to architecture</a> <br><ul><li>  <a href="https://habr.com/ru/post/321810/">Microservice architecture</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/321810/">Essential components and ecosystem solutions</a> <br><ul><li>  <a href="https://habr.com/ru/post/321810/">Identity service</a> </li><li>  <a href="https://habr.com/ru/post/321810/">Automated server provisioning</a> </li><li>  <a href="https://habr.com/ru/post/321810/">Git repository and task tracker</a> </li><li>  <a href="https://habr.com/ru/post/321810/">Docker registry</a> </li><li>  <a href="https://habr.com/ru/post/321810/">CI / CD service and service delivery system</a> </li><li>  <a href="https://habr.com/ru/post/321810/">Log collection and processing system</a> </li><li>  <a href="https://habr.com/ru/post/321810/">Tracing System</a> </li><li>  <a href="https://habr.com/ru/post/321810/">Monitoring and alerting</a> </li><li>  <a href="https://habr.com/ru/post/321810/">API Gateway and Single Sign-on</a> </li><li>  <a href="https://habr.com/ru/post/321810/">Event Bus and Event Integration / Service Bus</a> </li><li>  <a href="https://habr.com/ru/post/321810/">Databases and other stateful services</a> </li><li>  <a href="https://habr.com/ru/post/321810/">Dependency mirrors</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/321810/">From architecture to real life</a> </li></ul><br><h2 id="ot-realnoy-zhizni-k-processam-razrabotki">  From real life to development processes </h2><br><p><img src="https://habrastorage.org/webt/zs/a_/yc/zsa_yc5ayvpjd6mse34qaxel8sw.png" alt="https://hsto.org/webt/cq/tj/9q/cqtj9qdfa8wbrcf-d5si7bjxona.png"></p><br><p>  For the most part, all the development processes that I have ever seen or been given to install / configure serve, in fact, one simple goal - to reduce the time between the birth of an idea and its delivery to the ‚Äúcombat‚Äù environment with a given, generally case of constant, the value of the quality code. </p><br><p>  But a bad idea or a good one is completely irrelevant.  Bad ideas are usually accelerated in order to check and then give up and, possibly, quickly disintegrate.  What is important to say here is that the process of rolling back to the previous version (without this ‚Äúcrazy‚Äù idea) also falls on the shoulders of the robot, which automated your processes. </p><br><p>  Continuous integration and delivery usually seem like a lifeline in the design world.  What would seem easier?  There is an idea, there is a code - let's go!  All is good, if not for one big "BUT".  As my experience shows, the process of integration and delivery is rather difficult to formalize in isolation from the technologies and business processes that take place in the company. </p><br><p>  In spite of all the seeming complexity of the task, the world is constantly throwing up great ideas and technologies that bring us (well, me personally for sure ...) to the utopian and ideal mechanism that would fit in almost any occasion.  The next step towards this is Docker and Kubernetes.  The level of abstraction and the ideological approach give me the right to say that 80% of the problems can now be solved by practically the same methods. </p><br><blockquote>  20% nowhere, of course, do not share.  But this is exactly the area where it is interesting to work and create, and not to engage in the same routine problems of architecture and processes.  Therefore, having concentrated once on the ‚Äúarchitectural framework‚Äù, we can forget (without prejudice to the cause) about the need to return to these 80% of the problems solved. </blockquote><p>  What does all this mean, and how does Docker solve the problems of our development processes? <br>  Let's take a simple development process, which I also propose to consider as being quite sufficient in most cases: </p><br><p><img src="https://habrastorage.org/webt/mt/xn/zb/mtxnzbxxak1gbrlqacs1x32okc4.png"></p><br><p>  Everything that should be automated from a given sequence of stages of any task can be completely unified to itself and not require changes with the proper approach over time. </p><br><h3 id="ustanovka-sredy-razrabotchika">  Installing a Developer Environment </h3><br><p><img src="https://habrastorage.org/webt/yg/sg/oh/ygsgoho29wnrrx7okfifpgaxmli.png"></p><br><p> Any project must contain <code>docker-compose.yml</code> .  It will easily save the developer from having to think about how and what he needs to do in order to run your application / service on the local machine.  A simple <code>docker-compose up</code> should include this application with all dependencies, populate the database with fixtures, connect the local code to the inside of the container, spy on the code for compilation on the fly, and ultimately respond to the expected port. </p><br><p>  If we are talking about creating a new service, then the developer also should not be asked questions about how to start, where to commit or what frameworks to choose.  All this should be described in advance in the instructions-standards and dictated by service templates for different cases: <code>frontend</code> , <code>backend</code> , <code>worker</code> and other types. </p><br><h3 id="avtomatizirovannoe-testirovanie">  Automated Testing </h3><br><p><img src="https://habrastorage.org/webt/pg/og/a5/pgoga55ph1cjbeqgduy8ukzxgac.png"></p><br><p>  All that I want to know about the "black box" ( <em>why I will tell the container a little later</em> ) is the fact that everything is okay inside it.  Yes or no.  1 or 0. If you have a finite number of commands that need to be executed inside the container, and <code>docker-compose.yml</code> , which describes dependencies, this can be easily automated and unified especially without immersing yourself in the implementation details. </p><br><p>  For example, <a href="https://gist.github.com/paunin/3303c8cb8dd231f961c01c0b69188c59">like this</a> ! </p><br><blockquote>  Here, by testing, I mean not only, and not so much a unit, but any other testing, including functional, integration, code testing for code ( <code>code style</code> ) and duplication, checking outdated dependencies, violation of licenses of used packages, and much more.  Emphasis should be placed on the fact that all this should be encapsulated inside your Docker image. </blockquote><br><h3 id="dostavka-sistem">  Shipping Systems </h3><br><p><img src="https://habrastorage.org/webt/ee/bf/42/eebf42hxm-q9pyo7cgapzm8e7ha.png"></p><br><p>  No matter when and where you want to install your child.  The result, exactly as the installation process, must always be the same.  There is also no difference what part of the whole ecosystem or from which git repository you will do it.  Idempotency here is the most important component.  The only thing that needs to be set is the installation control variables. </p><br><p>  The algorithm, which seems to me the most effective, for solving this problem: </p><br><ol><li>  Collect images from all <code>Dockerfile</code> (For example, <a href="https://github.com/paunin/images-builder">like this</a> ) </li><li>  With the help of a meta-project, deliver these images to Kubernetes via <a href="https://kubernetes.io/docs/reference/generated/kube-apiserver/">Kube API</a> .  Delivery start usually requires several input parameters: <br><ul><li>  Kube API endpoint </li><li>  resource of secrets - they usually differ in different contexts (local / showroom / staging / production) </li><li>  names of systems for display and Docker tags of images for these systems (obtained in the previous step) </li></ul></li></ol><br><blockquote>  As such a single meta project for all systems and services (a project describing how an ecosystem works and how changes are delivered to it), I prefer to use <a href="https://www.ansible.com/">Ansible</a> <code>playbook</code> and with <a href="https://github.com/paunin/ansible-kubernetes-module">this module</a> to integrate with KubeAPI.  However, sophisticated automators can afford many other options - I will give my own below.  The only thing you should not forget is a centralized / unified way to manage architecture.  This allows you to conveniently and consistently manage all services / systems and stop any manifestations of the upcoming zoo from technologies and systems performing similar functions on takeoff. </blockquote><p>  Usually setting the environment is required in: </p><br><ul><li>  "ShowRoom" - for some manual checks or debugging of the system </li><li>  "Staging" - for near-combat environments and integration with external systems (usually located in the DMZ as opposed to <code>ShowRoom</code> ) </li><li>  "Production" - the actual environment for the end user </li></ul><br><h3 id="nepreryvnost-v-integracii-i-dostavke">  Continuity in integration and delivery </h3><br><p><img src="https://habrastorage.org/webt/v4/af/so/v4afsowqbq59roipnajhm2uwld8.png"></p><br><p>  Having a unified way of testing "black boxes" - our Docker images, we must assume that the result obtained by such tests allows us to seamlessly integrate a <code>feature-branch</code> into an <code>upstream</code> or <code>master</code> branch of the git repository with a clear conscience. </p><br><p>  The only sticking point with this approach is the sequence in which we have to do the integration and delivery.  And in the absence of releases, the question of how to prevent the "race condition" on the same system with multiple parallel <code>feature-branch</code> . </p><br><p>  The following process must be launched in the non-competitive mode, otherwise the "race condition" will not give you peace of mind: </p><br><ol><li>  Trying to upgrade <code>feature-branch</code> to <code>upstream</code> ( <code>git rebase/merge</code> ) </li><li>  We collect images from <code>Dockerfile-</code> </li><li>  We test all collected images </li><li>  Run and wait for the delivery of the required systems with the images from step 2 </li><li>  If the previous step fails or due to external factors, we roll back the eco-system to the previous state. </li><li>  Merge <code>feature-branch</code> into <code>upstream</code> and send to repository </li></ol><br><p>  Any failure and at any step should interrupt the delivery process and return the task to the developer to solve the problem, be it "not passed" tests or problems merging branches. </p><br><blockquote>  The same recipe implies the ability to work with more than one repository.  For this, the whole process should be carried out for all repositories in order of the steps of the algorithm, rather than repeatedly and iteratively for each repository separately. </blockquote><p>  In addition, Kubernetes allows you to roll out updates in part for various AB tests and problem analysis.  This is achieved by internal means and separation of services (access points) and applications directly.  You can always balance the new and old version of the component in the right proportions for analyzing problems and possible rollbacks. </p><br><h3 id="sistema-otkata">  Rollback system </h3><br><p>  Any deployment must be reversible - it is a mandatory requirement that applies to our architectural framework.  This entails a lot of obvious and not very nuances of developing systems. </p><br><p>  Here are some of the most important ones: </p><br><ul><li>  The service should be able to customize its environment exactly as it rolls back changes.  For example: database migrations, schema in RabbitMQ, etc. </li><li>  If it is impossible to roll back the environment, it must be polymorphic and support both the old and the new version of the code.  For example: database migrations should not disrupt the operation of the old version of the service in several generations (usually 2 or 3 generations are enough) </li><li>  Backward compatibility of any service update.  Usually these are: API compatibility, message formats, etc. </li></ul><br><blockquote>  Rolling back states in the Kubernetes cluster is quite simple ( <code>kubectl rollout undo deployment/some-deployment</code> and kubernetes will restore the previous "cast"), but the meta project must contain information about this as well.  More complex delivery rollback algorithms are highly discouraged, although sometimes necessary. </blockquote><p>  What can cause the launch of this mechanism: </p><br><ul><li>  High percentage of application errors after release </li><li>  Signals from key monitoring points </li><li>  Not passed <a href="https://en.wikipedia.org/wiki/Smoke_testing_(software)"><code>smoke</code> tests</a> </li><li>  Manual Mode - Human Solution </li></ul><br><h3 id="obespechenie-informacionnoy-bezopasnosti-i-audit">  Information security and audit </h3><br><p>  It is impossible to isolate a separate process that will ‚Äúcreate‚Äù one hundred percent safety of your ecosystem from both external and internal threats, but it is worth noting that the architectural framework must be made with an eye to the company's standards and security policies at each level and in all subsystems. </p><br><blockquote>  Next, I will consider in more detail all three levels of the proposed solution when I describe monitoring and alert, which are also cross-cutting and have fundamental significance in terms of the integrity of the system. </blockquote><p>  Kubernetes has a set of very good built-in mechanisms for differentiating <a href="https://kubernetes.io/docs/admin/authorization/">access rights</a> , <a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/">network policies</a> , <a href="https://kubernetes.io/docs/tasks/debug-application-cluster/audit/">event auditing</a> and other powerful tools related to information security.  With proper perseverance, you will be able to build an excellent perimeter of defense that can stand up and prevent a single attack or data leak from being successful. </p><br><h2 id="ot-processov-k-arhitekture">  From processes to architecture </h2><br><p>  This hard link between the development processes and the eco-environment that you are trying to build should not give you peace of mind.  By adding to the classical requirements for the architecture of information systems (flexibility, scalability, availability, reliability, protection from threats, etc.), a request for good integration with the development and delivery processes, you multiply the value of such an architecture. </p><br><p>  The tight integration of development processes and the ecosystem has long given rise to such a thing as DevOps ( <strong>Dev</strong> elopment <strong>Op</strong> eration <strong>s</strong> ), which in fact is a logical step towards total automation and infrastructure optimization.  However, if you have a well-thought-out architecture and high-quality subsystems of your platform, DevOps tasks should be kept to a minimum. </p><br><h3 id="mikroservisnaya-arhitektura">  Microservice architecture </h3><br><p>  I suppose there is no need to go into the details of the benefits of the Service Oriented Architecture ( <a href="https://www.google.com/search%3Fq%3DSOA">SOA</a> ), but also why these services should be micro.  Let me just say that if you decide to use Docker and Kubernetes, you should most likely understand (and accept) that in this world it is very difficult to be a huge monolith and, I would say, ideologically wrong. </p><br><p>  Docker, which is designed to run a single process and work with persistence, forces us to think in the framework of DDD (Domain Driven Development) and treats the packaged code as a black box with access ports sticking out. </p><br><h2 id="vazhneyshie-komponenty-i-resheniya-ekosistemy">  Essential components and ecosystem solutions </h2><br><p>  From my practice of designing systems of increased availability and reliability, I would single out several components that are practically necessary for the operation of microservices. </p><br><p>  Despite the fact that all the components and their descriptions below are shown in the context of the Kubernetes environment (which is key in terms of approach and architecture in this article), you can refer to this list and as a checklist for any other platform. </p><br><blockquote>  If you (like me) come to the conclusion that it would be nice to manage the service services described below as usual Kubernetes services, then the recommendation would be for this to be a stand-alone cluster or a cluster other than "production".  For example, you can use a "staging" cluster, which will protect you from a situation where the "combat" environment is not stable, but should still have a source of code, code or monitoring.  In other words, this way you solve the problem of "chicken and eggs" </blockquote><br><h3 id="identity-servis">  Identity service </h3><br><p><img src="https://habrastorage.org/webt/nv/ne/9h/nvne9hm4sjl9ayj4uteytkxypcy.png"></p><br><p>  Everything usually begins with access, access to servers, virtual machines, applications, office mail, etc.  If you are (or want to become) a client of one of the large corporate platforms (such as IBM, Google or Microsoft), then most likely this problem will be solved for you by the corresponding services of these vendors.  But what to do if this is not your way, and you want to have your own solution that is managed only by you and preferably accessible on a budget? </p><br><p>  <a href="https://en.wikipedia.org/wiki/List_of_single_sign-on_implementations">This list</a> should help you decide on the necessary option and understand the labor costs for installation and maintenance.  This choice must be unconditionally coordinated with the company's security policy and approved by the (information) security service. </p><br><h3 id="avtomatizirovannyy-provizhining-serverov">  Automated server provisioning </h3><br><p><img src="https://habrastorage.org/webt/nv/0h/jj/nv0hjj-wqi94nl21dckhxcmbmw8.png"></p><br><p>  Although Kubernetes requires a very small number of components on physical machines / cloud VMs (docker, kubelet, kube proxy, etcd cluster), you should automate the addition of new machines and cluster management.  Several options for mechanisms to make it easy and simple: </p><br><ul><li>  <a href="https://github.com/kubernetes/kops">KOPS</a> - the tool allows you to install a cluster on one of two cloud providers - AWS or GCE </li><li>  <a href="https://www.terraform.io/">Teraform</a> - as a whole allows to manage the infrastructure for any environment and follows the ideology of IAC ( <strong>I</strong> nfrastructure <strong>a</strong> s <strong>C</strong> ode, infrastructure as a code) </li><li>  <a href="https://www.ansible.com/">Ansible</a> is a tool of even wider range of applications and serves for automation of any kind. </li></ul><br><blockquote>  I want to note that from the proposed list, as mentioned above - in the section on system delivery, I prefer the latter option (with a small <a href="https://github.com/paunin/ansible-kubernetes-module">module for integration with Kubernetes</a> ), since it allows the most flexibility to work with servers, and with k8s objects, and generally implement any kind of automation.  However, nothing prevents you from using, for example, Teraform and <a href="https://www.terraform.io/docs/providers/kubernetes/">its module for Kubernetes</a> .  KOPS is not fully applicable to work on bare metal, however, in my opinion, the ideal tool for working with AWS / GCE! </blockquote><br><h3 id="git-repozitoriy-i-task-treker">  Git repository and task tracker </h3><br><p><img src="https://habrastorage.org/webt/cx/_l/f1/cx_lf1--7mbvforf6j6bbcsjcui.png"></p><br><p>  Needless to say, for the full-fledged work of developers and other related roles, it is necessary to have a place for collaboration, discussions of storing code.  It is difficult to answer the question about the best service for this, I can only mention that for me as a task tracker classically is a free <a href="https://www.redmine.org/">redmine</a> or paid <a href="https://www.atlassian.com/software/jira">Jira</a> and a free old-school <a href="https://www.gerritcodereview.com/">gerrit</a> or paid <a href="https://bitbucket.org/">bitbucket</a> </p><br><blockquote>  It is worth paying attention to the two most consistent, but commercial, stacks for collaborative corporate work: <a href="https://www.atlassian.com/software">Atlassian</a> and <a href="https://www.jetbrains.com/products.htm">Jetbrains</a> .  You can use one of them completely or combine different components in your solution. </blockquote><p>  To ensure the greatest effect of using the tracker and repository, you should keep in mind the strategies for working and integrating these two entities.  For example, a couple of tips to ensure the integrity of the code and related tasks (of course you can choose your strategies): </p><br><ul><li>  The ability to "push" to a remote repository should only be in the branch with the task number ( <code>TASK-1</code> / <code>feature-34</code> ) </li><li>  Any branch should be blocked and not available for updates if the corresponding task is not in the "In Progress" status or similar. </li><li>  The branch should be available for merging only after a certain number of positive review codes. </li><li>  Any steps intended for automation should not be available to developers directly. </li><li>  <code>master</code> branch should be available for direct modification only by privileged developers - everything else is available only to the ‚Äúautomaton‚Äù robot. </li><li>  The branch should not be available for merging if the corresponding task is in a status other than "For Delivery" or the like. </li></ul><br><h3 id="docker-registry">  Docker registry </h3><br><p><img src="https://habrastorage.org/webt/fz/uh/0t/fzuh0t6smd69boiacwu-yhao70c.png"></p><br><p>  The function of managing <code>Docker</code> images must be separately identified, as it is of great importance for the storage and delivery of services.  In addition to this, such a system should support work with users, groups and access, be able to delete old and unnecessary images, provide a GUI and a restful API. </p><br><p>  You can use both cloud solutions (for example, <a href="http://hub.docker.com/">hub.docker.com</a> ), and any private service that can be installed even within the Kubernetes cluster itself.  <a href="https://github.com/vmware/harbor">Vmware Harbor</a> , which is positioned as a corporate solution for the Docker Registry, can become a rather interesting service for this.  At the worst, you can do the usual <a href="https://docs.docker.com/registry/">Docker Registry</a> if you don‚Äôt really need a complex system and just want to store images. </p><br><h3 id="cicd-servis-i-sistema-dostavki-servisov">  CI / CD service and service delivery system </h3><br><p><img src="https://habrastorage.org/webt/9v/ax/ya/9vaxyaswdkdkey47lwkhydnreny.png"></p><br><p>  All the components we talked about before (git repository, task tracker, meta-project with Ansible Playbooks, external dependencies) cannot exist separately suspended in a vacuum.  To fill this vacuum should be just the service of continuous integration and delivery. </p><br><blockquote>  CI - Continuous Integration - Continuous Integration <br>  CD - Continuous Delivery - Continuous Delivery </blockquote><p>  The service should be fairly simple and have no logic related to the delivery methods or system configuration.  All that the CI / CD service has to do is respond to events from the outside world (change in the git repository, transition of the task to the task tracker), and start some actions described in the meta project.  It is also a place that is the point of control of all repositories and a tool for managing them (merging branches, updates from <code>upstream/master</code> ) </p><br><blockquote>  I am historically used to using quite a powerful and at the same time very simple tool from Jetbrains - <a href="https://www.jetbrains.com/teamcity/">TeamCity</a> , but I don‚Äôt see any problems if you decide to use, for example, free <a href="https://jenkins-ci.org/">Jenkins</a> . </blockquote><p>  Based on the foregoing, in essence, in the whole scheme, there are only four main and one auxiliary process that the integration service should launch: </p><br><ul><li>  Automatic testing of services - usually for a single repository, by changing the state of the branch or upon the occurrence of the status "Awaiting Autotests" (or similar) </li><li>  Service delivery - usually from a meta-project for a number of services (and therefore repositories), upon the occurrence of the "Awaiting Showroom" and "Awaiting Delivery" statuses for deploying the QA and "production" environments, respectively </li><li>  Rollback - usually from a meta-project for a specific part of a single service or a whole service upon the occurrence of an external event or trigger from a failed delivery process </li><li>  Deletion of services - required to completely remove the entire ecosystem from a single test environment ( <code>showroom</code> ), after the status of <code>In QA</code> , when the environment is no longer needed </li><li>  Assembling images (auxiliary process) - can be used either in the process for delivering services or independently, if you just need to assemble <code>Docker</code> images and send them to the Docker Registry, often used for some widely used images (DB, shared services, not frequently changing services) </li></ul><br><h3 id="sistema-sbora-i-obrabotki-logov">  Log collection and processing system </h3><br><p><img src="https://habrastorage.org/webt/er/2o/_z/er2o_znz_nv6w8oz3v7p6zfzhfy.png"></p><br><p>  The only way for any Docker container to make its own logs accessible is to write them in STDOUT or STDERR of the root process running in this container itself.  In fact, for the developer of the service, it does not matter what happens next with this data, the main thing is that they are available when needed and preferably to a predictable point in the past.  All responsibility here for fulfilling these expectations lies with the Kubernetes and those people who support the ecosystem. </p><br><p>  In the <a href="https://kubernetes.io/docs/concepts/cluster-administration/logging/">official documentation,</a> you can find a description of the basic, and generally not bad, strategy of working with logs, which will help you choose the necessary service for the aggregation and storage of a huge number of text data. </p><br><p>     ,       <a href="https://www.fluentd.org/">fluentd</a>  ,       ,  <a href="https://kubernetes.io/docs/user-guide/logging/elasticsearch">Elasticsearch</a>     .        ,      ,     ,       . </p><br><blockquote> Elasticsearch     ,        Docker           . </blockquote><br><h3 id="tracing-sistema"> Tracing  </h3><br><p><img src="https://habrastorage.org/webt/ub/gl/oh/ubglohfdo6kninfzpim5ttpc3eq.png"></p><br><p>       ,       ""       "     ,     ?!".    ,   ,       ,     -,        ‚Äî   ,                . </p><br><p> <a href="http://opentracing.io/">Opentracing</a>  <a href="https://zipkin.io/">Zipkin</a>                  .   , ,        ,      <a href=""> </a> . </p><br><blockquote> ,        "Trace Id"   ,  ,    ..,       ,          . </blockquote><br><h3 id="monitoring-i-alerting">    </h3><br><p><img src="https://habrastorage.org/webt/ek/cm/yg/ekcmygpuwbfliajrfyvdzxx8fcm.png"></p><br><p> <a href="https://prometheus.io/">Prometheus</a>   -          Kubernetes <a href="https://coreos.com/blog/monitoring-kubernetes-with-prometheus.html"> " "</a> .     <a href="https://kubernetes.io/docs/tasks/debug-application-cluster/core-metrics-pipeline/">  Kubernetes</a> ,        . </p><br><blockquote> , ,      ,      ,      .     (   )     (    "staging" ). "-"               . </blockquote><p>          ,    ,   ,      : </p><br><ul><li>  : <br><ul><li>      </li><li>  (i/o,  ) </li><li>     (CPU, RAM, LA) </li></ul></li><li>  : <br><ul><li>        (kubelet, kubeAPI, DNS, etcd,  ..) </li><li>        </li><li>        </li><li>  <code>pod</code> - </li></ul></li><li>  : <br><ul><li>            API </li><li>   HTTP   API  </li><li>     <code>worker</code> - </li><li>     ( ,    ,  , ..) </li><li>     HTTP  </li><li>    - (     ) </li></ul></li></ul><br><p>          ,            ,      email, SMS     . </p><br><p>     <a href="https://www.opsgenie.com/">OpsGenie</a>    <a href="https://prometheus.io/docs/alerting/configuration/"><code> c alertmanager</code> -</a>  Prometheus. </p><br><blockquote> OpsGenie       ,      ,  ,       .        .  ,        /:  ‚Äî Infra+Devops,  ‚Äî Devops,  ‚Äî   . </blockquote><br><h3 id="api-shlyuz-i-single-sign-on"> API   Single Sign-on </h3><br><p><img src="https://habrastorage.org/webt/nx/8y/xn/nx8yxnxrsnjzqjssvvk8go_kgu0.png"></p><br><p>  , ,  (,     "Identity ",     - ),           ,     ,        API .       ,      "Identity ",               . </p><br><p>               ,     .           ,     .        ""  ,  HTTP   . </p><br><blockquote>         API ,       - ‚Äî .        :  UI , -    .   (    ),   ,     UI     .             UI  ( TTL)   (    TTL) </blockquote><p>  ,   API : </p><br><ul><li>            (      ) </li><li>  c Single Sign-on : <br><ul><li>      HTTP      (ID, ,  )    </li><li>  (/)          Single Sign-on </li></ul></li><li>     HTTP  </li><li>  API     (,  <a href="https://swagger.io/">Swagger</a> json/yaml ) </li><li>             URI </li><li>            </li></ul><br><h3 id="shina-sobytiyevent-bus-i-shina-integraciy-enterprise-integrationservice-bus">  (Event Bus)    (Enterprise Integration/Service Bus) </h3><br><p><img src="https://habrastorage.org/webt/fp/px/yn/fppxyncubi4gafqurqc9jgsrpsy.png"></p><br><p>      ,       -,               .              ,               ,         .  ,     ,       -         . </p><br><blockquote>         ,      : <a href="https://www.rabbitmq.com/">RabbitMQ</a> , <a href="http://kafka.apache.org/">Kafka</a> , <a href="http://activemq.apache.org/">ActiveMQ</a>  .              ,  <a href="https://en.wikipedia.org/wiki/CAP_theorem">CAP </a>     -       . </blockquote><p>  ,         ,          ,         " ",         ,      "Dumb pipe ‚Äî Smart Consumer" ,  . </p><br><p>        <a href="https://en.wikipedia.org/wiki/Enterprise_service_bus">"Enterprise Integration/Service Bus"</a> ,        - .     ,   : </p><br><ul><li>    </li><li>      </li><li> /      </li><li>  ,        </li><li>      </li><li>         (  ) </li><li>      </li></ul><br><blockquote>          ,    <a href="http://servicemix.apache.org/">Apache ServiceMix</a> ,                . </blockquote><br><h3 id="bazy-dannyh-i-drugie-stateful-servisy">     Stateful  </h3><br><p><img src="https://habrastorage.org/webt/_u/7t/dg/_u7tdg9fnevvn41gby5ul_hjlk0.png"></p><br><p> Docker,    Kubernetes,      ,        .  ,      "" -      ‚Ä¶  ,            ""  "",   ,         ,        Docker . </p><br><p>   ,           ,              Kubernetes . </p><br><p>       ,      Stateful         ,     "": </p><br><ul><li>     ‚Äî <a href="https://github.com/paunin/PostDock">PostDock</a>        Postgresql   Docker  </li><li>  / ‚Äî <a href="https://hub.docker.com/_/rabbitmq/">RabbitMQ</a>          ,  <code>cluster_formation</code>           </li><li>   ‚Äî <a href="https://github.com/paunin/redis">redis</a>              </li><li>   ‚Äî      <a href="https://hub.docker.com/_/elasticsearch/">Elasticsearch</a> ,        ,                    </li><li>    ‚Äî            (ftp, sftp  ..) </li></ul><br><h3 id="zerkala-zavisimostey">   </h3><br><p><img src="https://habrastorage.org/webt/gl/ff/sc/glffsc_ttkc0frmd3ys8hav13ka.png"></p><br><p>       ,              ,         .  ,        ,         ‚Äî "          ".             : Docker , rpm ,   , python/go/js/php . </p><br><p>            .       , ,   " <a href="https://www.google.com/search%3Fq%3Dprivate%2Bdependency%2Bmirror%2Bfor%2Bgolang">private dependency mirror for ...</a> " </p><br><h2 id="ot-arhitektury-k-realnoy-zhizni">      </h2><br><p><img src="https://habrastorage.org/webt/vi/x0/7u/vix07u-o0i3utouugrs0f7o9wce.png"></p><br><p>   ,    ,      .   :    (1-5 ),    ‚Äî  (5-10 ),      ‚Äî (10-20 ),     . </p><br><p>     ,        -  ,        ,     ,    ,    ,          ,            . </p><br><p>    ,             ,       .   ,         .             . </p><br><p>       ,       .    ‚Äî    , ,    .. ,           ,  ,        (   ),              ,    " ",     ,           ! </p><br><p>      "    ?"‚Ä¶ <br>  ‚Äî     ,        - ,   ,    ! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/321810/">https://habr.com/ru/post/321810/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321798/index.html">Dynamic Shadow Tactics Detection</a></li>
<li><a href="../321800/index.html">Omnichannel: facilitating communication to customers and employees</a></li>
<li><a href="../321802/index.html">Dmitry Sorin, Senior Software Engineer at Atlassian, shared his impressions of five years of work at Yandex</a></li>
<li><a href="../321804/index.html">Acquaintance with Styled components</a></li>
<li><a href="../321808/index.html">Webinar: Introduction to Singularity</a></li>
<li><a href="../321812/index.html">Welcome to Tarantool Meetup March 2</a></li>
<li><a href="../321814/index.html">Check the open-source server World of Warcraft CMaNGOS</a></li>
<li><a href="../321816/index.html">Practical techniques for using multi-thread computing when working with the Revit API</a></li>
<li><a href="../321818/index.html">Online store at 1C-Bitrix and box office: the requirements of the law 54-FZ</a></li>
<li><a href="../321820/index.html">Has MVC died for the frontend?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>