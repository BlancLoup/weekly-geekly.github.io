<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About configuring Open vSwitch a difficult language</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From translator 
 SDN ‚Äî software defined networks ‚Äî have become firmly established in our lives, but there is not a lot of materials about their low-l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About configuring Open vSwitch a difficult language</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/1ee/158/42f/1ee15842f09640e5a3a79c7818a82741.png" align="left">  <i><b>From translator</b></i> <i><br></i>  <i>SDN ‚Äî software defined networks ‚Äî have become firmly established in our lives, but there is not a lot of materials about their low-level work in Russian.</i>  <i>I bring to your attention a translation of the tutorial <a href="http://docs.openvswitch.org/en/latest/tutorials/ovs-advanced/">article</a> , which shows an example of creating an autonomous virtual switch with VLAN support.</i>  <i>Such a switch in its basic functionality can work without a network controller.</i>  <i>It is assumed.</i>  <i>that the reader is familiar with the basics and terminology of building networks in general, and also has a general understanding of software-defined networks.</i> <i><br><br></i>  <i><b>Terms used:</b></i> <i><br><br></i>  <i>OpenFlow is a protocol for controlling data transfer over a network.</i>  <i>It describes the process of interaction between the controller and the switch, as well as the format of the rules loaded into the switch.</i> <i><br></i>  <i>Open vSwitch is a software implementation of the switch compatible with the OpenFlow protocol.</i>  <i>It is used to manage traffic in virtualization systems, for example, OpenStack and oVirt (experimentally).</i> <i><br></i>  <i>802.1Q (VLAN) is a mechanism for delimiting traffic both within a single switch and in a local network.</i>  <i>Based on embedding VLAN tag (number) in data packet</i> <i><br></i>  <i>802.1p (QoS) is a traffic prioritization control mechanism.</i>  <i>Part of the 802.1Q standard</i> <i><br></i>  <i>A port of aggregation (trunk port) is a switch port connected to an upstream switch.</i>  <i>The aggregation port allows sending packets with any VLAN number</i> <i><br></i>  <i>Access port (access port) - the switch port, allowing work with packets only certain VLAN.</i> <br><a name="habracut"></a><br><h2>  Introduction </h2><br>  There are many openflow tutorials on the web, but this article is about something else.  However, for understanding this article, basic knowledge about OpenFlow is required.  If you do not fully understand how OpenFlow rules work, <a href="https://habrahabr.ru/post/149126/">please learn the</a> <a href="https://habrahabr.ru/post/242741/">basics</a> , and then return to this article. <br>  Also, you will need knowledge of the basics of Open vSwitch.  If you have never used the <a href="http://openvswitch.org/support/dist-docs/ovs-vsctl.8.txt">ovs-vsctl</a> or <a href="http://openvswitch.org/support/dist-docs/ovs-ofctl.8.txt">ovs-ofctl management utilities</a> , you should read a little about them before we proceed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Most of the features described in this guide relate to the enhanced version of the OpenFlow protocol implemented in the Open vSwitch. If you use a hardware implementation as a switch based on an ASIC chip, this guide is unlikely to help you. <br><br>  We will not consider in detail <a href="https://habrahabr.ru/company/webzilla/blog/124310/">all the ins and outs of the technologies</a> that will be discussed.  For details, you can refer to the Open vSwitch documentation, in particular, to the <a href="http://openvswitch.org/support/dist-docs/ovs-vsctl.8.txt">ovs-vsctl</a> help files, as well as the comments in the <a href="">include / openflow / nicira-ext.h</a> and <a href="">include / openvswitch / meta-flow.h files</a> . <br><br><h2>  Getting started </h2><br>  We assume that the Open vSwitch executable files are already installed on your system.  Any specialized hardware other than the computer itself is not required.  Instead, we will use the ovs-sandbox script, which can be found <a href="https://github.com/openvswitch/ovs/tree/master/tutorial">here</a> .  This script is needed to create a software-defined network environment based on Open vSwitch. <br><br>  You can use the ovs-sandbox in three ways: <br><br><ul><li>  If you have already installed Open vSwitch on your system, you can simply run the ovs-sandbox script, without specifying any parameters. </li><li> If you do not have Open vSwitch installed (and you do not want to install it), then you can build an Open vSwitch without installation according to the instructions for <a href="http://docs.openvswitch.org/en/latest/intro/install/general">Linux, FreeBSD and NetSBD</a> .  Then run ovs-sandbox and point it to the directory with Open vSwitch <code>./ovs-sandbox -b &lt;&gt;</code> </li><li>  Alternatively, you can run the make sandbox command from the directory in which Open vSwitch is built </li></ul><br>  The script does the following: <br><br><ol><li>  ATTENTION: deletes all subdirectories from the subdirectory named sandbox of the current directory and all files in this subdirectory </li><li>  Creates a new ‚Äúsandbox‚Äù directory in the current directory. </li><li>  Sets the environment variables so that the Open vSwitch utilities use the ‚Äúsandbox‚Äù as the current directory, rather than the Open vSwitch installation directory </li><li>  If you compiled Open vSwitch, but did not install it, copies the help files to the ‚Äúsandbox‚Äù subdirectory and writes the name of this subdirectory to the MANPATH environment variable.  This means that when you use, for example, the man ovs-vsctl command, you will see the help for the version of Open vSwitch that you compiled. </li><li>  Creates an empty Open vSwitch configuration database in the ‚Äúsandbox‚Äù directory </li><li>  Runs the ovsdb-server in the ‚Äúsandbox‚Äù directory </li><li>  It launches ovs-vswitchd in the ‚Äúsandbox‚Äù directory and sends it parameters for a special test mode. </li><li>  Starts an interactive shell session from the sandbox directory. </li></ol><br>  From this point on, you can run all the familiar Open vSwitch commands from a shell session.  For example, you can run ovs-vsctl and create a virtual switch: <br><br><pre> <code class="bash hljs">$ ovs-vsctl add-br br0</code> </pre> <br>  From the point of view of Open vSwitch, the switch you created is just as real as any other.  For example, you can connect it to an OpenFlow controller or use ovs-ofctl to check and modify traffic control rules.  On the other hand, the switch does not appear in the network configuration of the host, so ifconfig and ip utilities cannot work with it.  In addition, the ping and tcpdump utilities will not work either.  But this has a good side - you can‚Äôt knock down the host‚Äôs network settings by changing the switch settings in the sandbox. <br><br>  When you need to finish working with Open vSwitch, just type in the shell ‚Äúexit‚Äù command or press Ctrl + D.  This will complete the processes started by the ovs-sandbox script, but leave in place the sandbox directory itself with all its contents. <br><br>  The ‚Äúsandbox‚Äù directory contains log files for all Open vSwitch services, so that you can review them after you have finished working with Open vSwitch. <br><br><h2>  Using the GDB Debugger </h2><br>  This training material does not require the use of the GDB debugger without fail, however you can use GDB to figure out the internal structure of the Open vSwitch utilities. <br><br>  GDB can be used to debug any process that is already running using the gdb &lt;process-id&gt; command. <br><br>  The ovs-sandbox script has the -g option to run ovs-vswitchd under GDB.  The parameter can be used if you need to set breakpoints before executing ovs-vswitchd or to debug a crash early in the service startup.  In addition, there is the -d parameter, which runs the ovsdb-server service under GDB.  Both parameters can be used simultaneously. <br><br>  There is also the -e option, which also runs the ovs-vswitchd service under GDB, but does not display the gdb&gt; prompt and does not wait for commands to be entered, but immediately starts the execution of the service.  The -r option causes the ovsdb-server service to start under GDB right away, like ovs-vswitchd. <br><br>  To avoid incorrect terminal behavior when starting GDB, the ovs-sandbox script opens a new xterm session for each GDB session.  For systems without a graphical X Windows server, GDB support is disabled. <br><br>  When you run the test environment from the makefile, you can pass the -g parameter to the script via the SANDBOXFLAGS environment variable.  Thus, the make sandbox command SANDBOXFLAGS = -g runs the test environment with the ovs-vswitchd service under the GDB debugger in a separate X-terminal. <br><br><h2>  Formulation of the problem </h2><br>  The main goal of this tutorial is to demonstrate the extensive capabilities of Open vSwitch in traffic management.  In the course of work, we will build a switch capable of storing MAC addresses and having access and aggregation ports separated by VLANs.  If you do not consider the functions of Open vSwitch, which we will talk about below, OpenFlow offers at least two ways to implement such a switch. <br><br><ul><li>  Use OpenFlow controller to memorize MAC addresses in traffic post-processing mode.  Each new connection is first analyzed by the controller, which forms permitting rules for it.  Whenever a new MAC address appears on a port or ‚Äúmoves‚Äù from one port to another, the controller must change the corresponding switch rule table. </li><li>  ‚ÄúNormal‚Äù (NORMAL) behavior.  OpenFlow defines such behavior as ‚Äúthe work of a regular switch without OpenFlow‚Äù.  If the rule provides for this behavior, the packet passes through the switch as if OpenFlow is not configured on the switch. </li></ul><br>  Unfortunately, both approaches are not without flaws.  In the first case, the use of the controller leads to a significant reduction in bandwidth and increased delays.  In addition, the controller does not scale well to service a large number of switches, which is especially important in an environment with thousands of hypervisors, each of which has its own OpenFlow switch.  Naturally, memorizing MAC addresses using a controller will not work if the controller is out of order, slowly processes requests, or is unavailable due to network problems. <br><br>  In the second case (NORMAL) we deal with problems of a different kind.  Firstly, only a small part of the ‚Äúnormal‚Äù behavior is standardized and works differently on the equipment of different manufacturers.  The available functions and methods for configuring them (as a rule, not through OpenFlow) differ from different manufacturers.  Secondly, the NORMAL mode does not work well with other OpenFlow rules.  NORMAL implements the concept of ‚Äúall or nothing‚Äù and has a very narrow potential for customizing its behavior or interaction with other functions. <br><br><h2>  Test script </h2><br>  We will build an OpenFlow switch and configure its tables for storing MAC addresses and working with VLANs.  The switch will have 4 ports: <br><br><ul><li>  p1 - ‚Äã‚Äãaggregation port for all VLANs on port 1 of the switch </li><li>  p2 - access port for untagged VLAN 20 on switch port 2 </li><li>  p3, p4 - access ports for untagged VLAN 30 on ports 2 and 3 of the switch, respectively </li></ul><br><blockquote>  The names of the ports do not matter, you can call them eth1-eth4 or some other way you wish. <br>  The OpenFlow switch also has one port, visible on the host as a local interface.  Our script does not provide for its use. <br></blockquote><br>  Our switch will include 5 tables with rules, each of which implements its part of the traffic processing pipeline. <br><br><ul><li>  Table 0: Input Control </li><li>  Table 1: Input VLAN Processing </li><li>  Table 2: Remembering the MAC and VLAN for the input port </li><li>  Table 3: Port Search for Output MAC and VLAN </li><li>  Table 4: Exit Package Processing </li></ul><br>  Below you will see how to create such a switch table by table. <br><br>  You can copy the ovs-vsctl and ovs-ofctl commands with the parameters from the examples below and paste them into the command shell created by ovs-sandbox.  The ovs-appctl command with parameters is intended for tests and should not be used separately from other examples. <br><br><h2>  Installation </h2><br>  Run the ovs-sandbox and in the opened interactive shell enter the following command: <br><br><pre> <code class="bash hljs">$ ovs-vsctl add-br br0 -- <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> Bridge br0 fail-mode=secure</code> </pre> <br>  This command creates a new virtual switch br0 and puts it into the so-called fail-secure mode.  For us, for the time being, it will only mean that the switch will start with empty tables. <br><br><blockquote>  If we do not do this, the switch will start with the only rule that works out the NORMAL behavior.  We can use this feature to build the same switch as ours, but with the limitations described above in the ‚ÄúProblem Definition‚Äù section. <br></blockquote><br>  The new switch has only one port so far - the local br0.  We need to add ports p1, p2, p3 and p4.  The for shell command is one way to do this: <br><br><pre> <code class="bash hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 1 2 3 4; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ovs-vsctl add-port br0 p<span class="hljs-variable"><span class="hljs-variable">$i</span></span> -- <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> Interface p<span class="hljs-variable"><span class="hljs-variable">$i</span></span> ofport_request=<span class="hljs-variable"><span class="hljs-variable">$i</span></span> ovs-ofctl mod-port br0 p<span class="hljs-variable"><span class="hljs-variable">$i</span></span> up <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br>  The commands not only add ports, but also set the ofport_request attribute so that port p1 corresponds to port 1 OpenFlow, port 2 to port 2 OpenFlow, and so on. <br><br>  We can skip the setting of the attribute ofport_request and let OpenFlow choose ports itself, but for learning purposes we will assign port numbers ourselves to talk, for example, about port 1 of OpenFlow and to know that it refers to port p1. <br><br>  The ovs-ofctl command, using the OpenFlow request, runs the interfaces that are disabled during creation.  The same effect is caused by running the ifconfig up command, but the test environment interfaces are not displayed in the host OS and ifconfig cannot manage them. <br><br>  We have not yet configured the VLANs and MAC address memorization, as we plan to do this below using the traffic management tables. <br><br>  To see the result of our work, you can use the commands ovs-vsctl show or ovs-ofctl show br0. <br><br><h2>  Create table 0: Input control </h2><br>  Table 0 includes packets that have just arrived at the switch.  We will use it to reject packets for one reason or another.  For example, the packet with the sender's broadcast address is incorrect, so we can drop it at the entrance to the switch. <br><br><pre> <code class="bash hljs">$ ovs-ofctl add-flow br0 <span class="hljs-string"><span class="hljs-string">"table=0, dl_src=01:00:00:00:00:00/01:00:00:00:00:00, actions=drop"</span></span></code> </pre> <br>  The switch also does not have to forward any further IEEE 802.1D Spanning Tree Protocol (STP) packets, so we add a rule to discard such packets and packets of other reserved multicast protocols: <br><br><pre> <code class="bash hljs">$ ovs-ofctl add-flow br0 <span class="hljs-string"><span class="hljs-string">"table=0, dl_dst=01:80:c2:00:00:00/ff:ff:ff:ff:ff:f0, actions=drop"</span></span></code> </pre> <br>  We can add rules for rejecting packets of other protocols according to the principle shown above. <br><br>  We need another rule with priority below the default priority, so that packets that are not rejected by the higher rules go to the next stage ‚Äî in Table 1 of OpenFlow. <br><br><pre> <code class="bash hljs">$ ovs-ofctl add-flow br0 <span class="hljs-string"><span class="hljs-string">"table=0, priority=0, actions=resubmit(,1)"</span></span></code> </pre> <br><blockquote>  The resubmit action is part of the Open vSwitch extension for OpenFlow. <br></blockquote><br><h2>  Check table 0 </h2><br>  If we use Open vSwitch to configure a physical or virtual switch, we need to test it by sending packets in different ways, for example, using the well-known ping and tcpdump utilities or more specialized tools like Scapy.  This is difficult for our virtual switch because it is invisible to the operating system. <br><br>  However, the virtual switch has several special tools for testing.  The widest functionality offers ofproto / trace.  Taking the switch name and traffic description as input, ofproto / trace demonstrates step by step which rules will be affected by it. <br><br><h4>  Example 1 </h4><br>  Try the command: <br><br><pre> <code class="bash hljs">$ ovs-appctl ofproto/trace br0 in_port=1,dl_dst=01:80:c2:00:00:05</code> </pre> <br>  The output will be something like this: <br><br><pre> <code class="bash hljs">Bridge: br0 Flow: in_port=1,vlan_tci=0x0000,dl_src=00:00:00:00:00:00,dl_dst=01:80:c2:00:00:05,dl_type=0x0000 Rule: table=0 cookie=0 dl_dst=01:80:c2:00:00:00/ff:ff:ff:ff:ff:f0 OpenFlow actions=drop Final flow: unchanged Megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:80:c2:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Datapath actions: drop</code> </pre><br>  The first line shows the parameters of the package being processed in a more detailed form than we write on the command line. <br><br>  The second few lines show the packet path inside the br0 switch.  We see that in table 0 a corresponding rule was found with a certain priority and a given action.  If a package falls under several rules, there will be several such lines. <br><br>  The last group of lines displays the result.  which we will not discuss in detail here. <br><br><h4>  Example 2 </h4><br>  Let's try to execute the command <br><br><pre> <code class="bash hljs">$ ovs-appctl ofproto/trace br0 in_port=1,dl_dst=01:80:c2:00:00:10</code> </pre> <br>  Its output will be as follows: <br><br><pre> <code class="bash hljs">Bridge: br0 Flow: in_port=1,vlan_tci=0x0000,dl_src=00:00:00:00:00:00,dl_dst=01:80:c2:00:00:10,dl_type=0x0000 Rule: table=0 cookie=0 priority=0 OpenFlow actions=resubmit(,1) Resubmitted flow: in_port=1,vlan_tci=0x0000,dl_src=00:00:00:00:00:00,dl_dst=01:80:c2:00:00:10,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:80:c2:00:00:10/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=254 cookie=0 priority=0,reg0=0x2 OpenFlow actions=drop Final flow: unchanged Megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:80:c2:00:00:10/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Datapath actions: drop</code> 0x0 reg2 = 0x0 reg3 = 0x0 reg4 = 0x0 reg5 = 0x0 reg6 = 0x0 reg7 = 0x0 reg8 = 0x0 reg9 = 0x0 reg10 = 0x0 reg11 = 0x0 reg12 = 0x0 reg13 = 0x0 reg14 = 0x0 reg15 = <code class="bash hljs">Bridge: br0 Flow: in_port=1,vlan_tci=0x0000,dl_src=00:00:00:00:00:00,dl_dst=01:80:c2:00:00:10,dl_type=0x0000 Rule: table=0 cookie=0 priority=0 OpenFlow actions=resubmit(,1) Resubmitted flow: in_port=1,vlan_tci=0x0000,dl_src=00:00:00:00:00:00,dl_dst=01:80:c2:00:00:10,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:80:c2:00:00:10/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=254 cookie=0 priority=0,reg0=0x2 OpenFlow actions=drop Final flow: unchanged Megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=01:80:c2:00:00:10/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Datapath actions: drop</code> </pre> <br>  In this case, the packet does not match any rule with the ‚Äúdrop‚Äù action in table 0, so that it falls under the rule with the resubmit action.  The resubmit action redirects the packet to table 1, which is shown in row <br><br><pre> <code class="bash hljs">OpenFlow actions=resubmit(,1)</code> </pre> <br>  We have not yet added any rules to OpenFlow Table 1, so the package will not match any of the rules.  Thus, the packet will be dropped, so that from the side the result will be the same as in the first example. <br><br><h2>  Create a table 1: Processing VLANs at the entrance </h2><br>  The packets that arrive in Table 1 have already passed all the basic checks in Table 0. Table 1 is for attaching packets to VLANs.  The check is based on a comparison of the VLAN and the port through which the packets enter the switch.  We will also use the table to attach the VLAN header to the packet that goes to the aggregation port, which will allow postponing the processing stages related to the VLAN, since the VLAN number will always be part of the header (except in special cases). <br><br>  Start by adding a low priority rule that will drop all packets.  Before it, we add rules that let us pass the packets we need.  Let it be a ‚Äúdrop by default‚Äù rule. <br><br><pre> <code class="bash hljs">$ ovs-ofctl add-flow br0 <span class="hljs-string"><span class="hljs-string">"table=1, priority=0, actions=drop"</span></span></code> </pre> <br>  The p1 aggregation port (or OpenFlow port 1, which is simpler) accepts any packets, regardless of whether they have a VLAN header or not, and what the header is.  Thus, we can add a rule that redirects all traffic from port 1 to the following table: <br><br><pre> <code class="bash hljs">$ ovs-ofctl add-flow br0 <span class="hljs-string"><span class="hljs-string">"table=1, priority=99, in_port=1, actions=resubmit(,2)"</span></span></code> </pre> <br>  On access ports, we can receive any packets without a VLAN header, assign them the appropriate VLAN and transfer them to the next step. <br><br><pre> <code class="bash hljs">$ ovs-ofctl add-flows br0 - &lt;&lt;<span class="hljs-string"><span class="hljs-string">'EOF'</span></span> table=1, priority=99, in_port=2, vlan_tci=0, actions=mod_vlan_vid:20, resubmit(,2) table=1, priority=99, in_port=3, vlan_tci=0, actions=mod_vlan_vid:30, resubmit(,2) table=1, priority=99, in_port=4, vlan_tci=0, actions=mod_vlan_vid:30, resubmit(,2) EOF</code> </pre> <br>  We will not write the rules.  processing packets with existing VLAN tags (802.1Q) that arrive at access ports, so these packets will be discarded by the default rule.  This is the behavior we expect from access ports. <br><br>  In other cases, access ports pass packets belonging to VLAN 0 (that is, packets marked according to the 802.1p traffic prioritization mechanism).  To allow such packages, replace vlan_tci = 0 with vlan_tci = 0 / 0xfff in the rule above. <br><br><h2>  Testing table 1 </h2><br>  The utility ofproto / trace allows us to check the added rules for managing VLANs at the entrance to the switch. <br><br><h4>  Example 1. Package on an aggregation port </h4><br>  Checking the packet that came to the switch from the aggregation port: <br><br><pre> <code class="bash hljs">$ ovs-appctl ofproto/trace br0 in_port=1,vlan_tci=5</code> </pre> <br>  From the output of the command, it follows that the packet passes table 0, is sent to table 1, and then to table 2 (in which there are no rules yet). <br><br><pre> <code class="bash hljs">Bridge: br0 Flow: in_port=1,vlan_tci=0x0005,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Rule: table=0 cookie=0 priority=0 OpenFlow actions=resubmit(,1) Resubmitted flow: in_port=1,vlan_tci=0x0005,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=1 cookie=0 priority=99,in_port=1 OpenFlow actions=resubmit(,2) Resubmitted flow: unchanged Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=254 cookie=0 priority=0,reg0=0x2 OpenFlow actions=drop Final flow: unchanged Megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Datapath actions: drop</code> 0x0 reg2 = 0x0 reg3 = 0x0 reg4 = 0x0 reg5 = 0x0 reg6 = 0x0 reg7 = 0x0 reg8 = 0x0 reg9 = 0x0 reg10 = 0x0 reg11 = 0x0 reg12 = 0x0 reg13 = 0x0 reg14 = 0x0 reg15 = <code class="bash hljs">Bridge: br0 Flow: in_port=1,vlan_tci=0x0005,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Rule: table=0 cookie=0 priority=0 OpenFlow actions=resubmit(,1) Resubmitted flow: in_port=1,vlan_tci=0x0005,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=1 cookie=0 priority=99,in_port=1 OpenFlow actions=resubmit(,2) Resubmitted flow: unchanged Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=254 cookie=0 priority=0,reg0=0x2 OpenFlow actions=drop Final flow: unchanged Megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Datapath actions: drop</code> 0x0 reg2 = 0x0 reg3 = 0x0 reg4 = 0x0 reg5 = 0x0 reg6 = 0x0 reg7 = 0x0 reg8 = 0x0 reg9 = 0x0 reg10 = 0x0 reg11 = 0x0 reg12 = 0x0 reg13 = 0x0 reg14 = 0x0 reg15 = <code class="bash hljs">Bridge: br0 Flow: in_port=1,vlan_tci=0x0005,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Rule: table=0 cookie=0 priority=0 OpenFlow actions=resubmit(,1) Resubmitted flow: in_port=1,vlan_tci=0x0005,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=1 cookie=0 priority=99,in_port=1 OpenFlow actions=resubmit(,2) Resubmitted flow: unchanged Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=254 cookie=0 priority=0,reg0=0x2 OpenFlow actions=drop Final flow: unchanged Megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Datapath actions: drop</code> </pre> <br><h4>  Example 2. Correct packet on the access port </h4><br>  We are testing the correct packet (i.e., a packet without the 802.1Q header) coming on port p2: <br><br><pre> <code class="bash hljs">$ ovs-appctl ofproto/trace br0 in_port=2</code> </pre> <br>  The output of this command is similar to the output of the previous one, except that a packet is assigned a VLAN tag 20 before being sent to Table 2. <br><br><pre> <code class="bash hljs">Bridge: br0 Flow: in_port=2,vlan_tci=0x0000,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Rule: table=0 cookie=0 priority=0 OpenFlow actions=resubmit(,1) Resubmitted flow: in_port=2,vlan_tci=0x0000,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=2,vlan_tci=0x0000,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=1 cookie=0 priority=99,in_port=2,vlan_tci=0x0000 OpenFlow actions=mod_vlan_vid:20,resubmit(,2) Resubmitted flow: in_port=2,dl_vlan=20,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=2,vlan_tci=0x0000,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=254 cookie=0 priority=0,reg0=0x2 OpenFlow actions=drop Final flow: in_port=2,dl_vlan=20,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Megaflow: recirc_id=0,in_port=2,vlan_tci=0x0000,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Datapath actions: drop</code> 0x0 reg2 = 0x0 reg3 = 0x0 reg4 = 0x0 reg5 = 0x0 reg6 = 0x0 reg7 = 0x0 reg8 = 0x0 reg9 = 0x0 reg10 = 0x0 reg11 = 0x0 reg12 = 0x0 reg13 = 0x0 reg14 = 0x0 reg15 = <code class="bash hljs">Bridge: br0 Flow: in_port=2,vlan_tci=0x0000,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Rule: table=0 cookie=0 priority=0 OpenFlow actions=resubmit(,1) Resubmitted flow: in_port=2,vlan_tci=0x0000,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=2,vlan_tci=0x0000,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=1 cookie=0 priority=99,in_port=2,vlan_tci=0x0000 OpenFlow actions=mod_vlan_vid:20,resubmit(,2) Resubmitted flow: in_port=2,dl_vlan=20,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=2,vlan_tci=0x0000,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=254 cookie=0 priority=0,reg0=0x2 OpenFlow actions=drop Final flow: in_port=2,dl_vlan=20,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Megaflow: recirc_id=0,in_port=2,vlan_tci=0x0000,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Datapath actions: drop</code> 0x0 reg2 = 0x0 reg3 = 0x0 reg4 = 0x0 reg5 = 0x0 reg6 = 0x0 reg7 = 0x0 reg8 = 0x0 reg9 = 0x0 reg10 = 0x0 reg11 = 0x0 reg12 = 0x0 reg13 = 0x0 reg14 = 0x0 reg15 = <code class="bash hljs">Bridge: br0 Flow: in_port=2,vlan_tci=0x0000,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Rule: table=0 cookie=0 priority=0 OpenFlow actions=resubmit(,1) Resubmitted flow: in_port=2,vlan_tci=0x0000,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=2,vlan_tci=0x0000,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=1 cookie=0 priority=99,in_port=2,vlan_tci=0x0000 OpenFlow actions=mod_vlan_vid:20,resubmit(,2) Resubmitted flow: in_port=2,dl_vlan=20,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=2,vlan_tci=0x0000,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=254 cookie=0 priority=0,reg0=0x2 OpenFlow actions=drop Final flow: in_port=2,dl_vlan=20,dl_vlan_pcp=0,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Megaflow: recirc_id=0,in_port=2,vlan_tci=0x0000,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Datapath actions: drop</code> </pre> <br><h4>  Example 3. Invalid packet (with header 801.2Q) on port p2 </h4><br><pre> <code class="bash hljs">$ ovs-appctl ofproto/trace br0 in_port=2,vlan_tci=5</code> </pre> <br>  The output of the command shows that the packet arrives in table 1 and is discarded by the default rule. <br><br><pre> <code class="bash hljs">Bridge: br0 Flow: in_port=2,vlan_tci=0x0005,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Rule: table=0 cookie=0 priority=0 OpenFlow actions=resubmit(,1) Resubmitted flow: in_port=2,vlan_tci=0x0005,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=2,vlan_tci=0x0005,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=1 cookie=0 priority=0 OpenFlow actions=drop Final flow: unchanged Megaflow: recirc_id=0,in_port=2,vlan_tci=0x0005,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Datapath actions: drop</code> 0x0 reg2 = 0x0 reg3 = 0x0 reg4 = 0x0 reg5 = 0x0 reg6 = 0x0 reg7 = 0x0 reg8 = 0x0 reg9 = 0x0 reg10 = 0x0 reg11 = 0x0 reg12 = 0x0 reg13 = 0x0 reg14 = 0x0 reg15 = <code class="bash hljs">Bridge: br0 Flow: in_port=2,vlan_tci=0x0005,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Rule: table=0 cookie=0 priority=0 OpenFlow actions=resubmit(,1) Resubmitted flow: in_port=2,vlan_tci=0x0005,dl_src=00:00:00:00:00:00,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=2,vlan_tci=0x0005,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=1 cookie=0 priority=0 OpenFlow actions=drop Final flow: unchanged Megaflow: recirc_id=0,in_port=2,vlan_tci=0x0005,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Datapath actions: drop</code> </pre> <br><h2>  Create table 2: remember the MAC + VLAN pair on the incoming port </h2><br>  Table 2 allows the switch to remember which sender MAC address matches the specified port and packet VLAN tag. <br><br>  This table is a good illustration of why VLAN tags are added to packets that come to the switch through the access port, specifically in Table 1. We want to match a pair of VLAN + MAC with a port, regardless of whether the packet already belonged to VLAN when it came into the switch, or the VLAN tag was put in the packet by the switch itself. <br><br>  It takes only one rule to realize our idea.  Here it is: <br><br><pre> <code class="bash hljs">$ ovs-ofctl add-flow br0 \ <span class="hljs-string"><span class="hljs-string">"table=2 actions=learn(table=10, NXM_OF_VLAN_TCI[0..11], \ NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[], \ load:NXM_OF_IN_PORT[]-&gt;NXM_NX_REG0[0..15]), \ resubmit(,3)"</span></span></code> </pre> <br>  The ‚Äúlearn‚Äù action changes the table with rules based on the contents of the package that is being processed at the moment.      OpenFlow,   Open vSwitch. <br><br>   ‚Äúlearn‚Äù    : <br><br><pre> <code class="bash hljs">table=10</code> </pre> <br>   10.       MAC- <br><br><pre> <code class="bash hljs">NXM_OF_VLAN_TCI[0..11]</code> </pre> <br>     10,       VLAN,  VLAN  .    MAC    VLAN,        VLAN <br><br><pre> <code class="bash hljs">NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[]</code> </pre> <br>      ‚ÄúMAC- ‚Äù,    MAC-   . <br><br><pre> <code class="bash hljs">load:NXM_OF_IN_PORT[]-&gt;NXM_NX_REG0[0..15]</code> </pre>     ,   ,       .     ,    ,   0 ( ,   Open vSwitch   OpenFlow) <br><blockquote>     MAC-     . -,  ‚Äúlearn‚Äù    hard_timeout    ,    ‚Äú‚Äù MAC-,            . -,    ,      10    Flow_Table     Open vSwitch. </blockquote><br> ,        <br><br><h2>   2 </h2><br><h4>  1 </h4><br>    : <br><br><pre> <code class="bash hljs">$ ovs-appctl ofproto/trace br0 in_port=1,vlan_tci=20,dl_src=50:00:00:00:00:01 -generate</code> </pre> <br>    ,   ‚Äúlearn‚Äù     10   . <br><br><pre> <code class="bash hljs">Bridge: br0 Flow: in_port=1,vlan_tci=0x0014,dl_src=50:00:00:00:00:01,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Rule: table=0 cookie=0 priority=0 OpenFlow actions=resubmit(,1) Resubmitted flow: in_port=1,vlan_tci=0x0014,dl_src=50:00:00:00:00:01,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=1 cookie=0 priority=99,in_port=1 OpenFlow actions=resubmit(,2) Resubmitted flow: unchanged Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=2 cookie=0 OpenFlow actions=learn(table=10,NXM_OF_VLAN_TCI[0..11],NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:NXM_OF_IN_PORT[]-&gt;NXM_NX_REG0[0..15]),resubmit(,3) Resubmitted flow: unchanged Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,vlan_tci=0x0014/0x0fff,dl_src=50:00:00:00:00:01,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=254 cookie=0 priority=0,reg0=0x2 OpenFlow actions=drop Final flow: unchanged Megaflow: recirc_id=0,in_port=1,vlan_tci=0x0014/0x1fff,dl_src=50:00:00:00:00:01,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Datapath actions: drop</code> </pre> <br>     -generate.  , ofproto/trace    :  ‚Äúoutput‚Äù      ,  ‚Äúlearn‚Äù      .   -generate  ofproto/trace     ‚Äúlearn‚Äù.  ,       ‚Äúlearn‚Äù   10. <br><br>  : <br><br><pre> <code class="bash hljs">$ ovs-ofctl dump-flows br0 table=10</code> </pre> <br>    : <br><br><pre> <code class="bash hljs">NXST_FLOW reply (xid=0x4): cookie=0x0, duration=4315.181s, table=10, n_packets=0, n_bytes=0, idle_age=4315, vlan_tci=0x0014/0x0fff,dl_dst=50:00:00:00:00:01 actions=load:0x1-&gt;NXM_NX_REG0[0..15]</code> </pre> <br>  ,    VLAN 20    50:00:00:00:00:01    ,     VLAN 20    50:00:00:00:00:01.     1,     ,   0. <br><br><h4>  2 </h4><br>   : <br><br><pre> <code class="bash hljs">$ ovs-appctl ofproto/trace br0 in_port=2,dl_src=50:00:00:00:00:01 -generate</code> </pre> <br><pre> <code class="bash hljs">Bridge: br0 Flow: in_port=2,vlan_tci=0x0000,dl_src=50:00:00:00:00:01,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Rule: table=0 cookie=0 priority=0 OpenFlow actions=resubmit(,1) Resubmitted flow: in_port=2,vlan_tci=0x0000,dl_src=50:00:00:00:00:01,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=2,vlan_tci=0x0000,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=1 cookie=0 priority=99,in_port=2,vlan_tci=0x0000 OpenFlow actions=mod_vlan_vid:20,resubmit(,2) Resubmitted flow: in_port=2,dl_vlan=20,dl_vlan_pcp=0,dl_src=50:00:00:00:00:01,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=2,vlan_tci=0x0000,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=2 cookie=0 OpenFlow actions=learn(table=10,NXM_OF_VLAN_TCI[0..11],NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:NXM_OF_IN_PORT[]-&gt;NXM_NX_REG0[0..15]),resubmit(,3) Resubmitted flow: unchanged Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=2,vlan_tci=0x0000,dl_src=50:00:00:00:00:01,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=254 cookie=0 priority=0,reg0=0x2 OpenFlow actions=drop Final flow: in_port=2,dl_vlan=20,dl_vlan_pcp=0,dl_src=50:00:00:00:00:01,dl_dst=00:00:00:00:00:00,dl_type=0x0000 Megaflow: recirc_id=0,in_port=2,vlan_tci=0x0000,dl_src=50:00:00:00:00:01,dl_dst=00:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Datapath actions: drop</code> </pre> <br> ,   ,    VLAN  MAC,     ,           VLAN.             802.1Q.     10 <br><br><pre> <code class="bash hljs">$ ovs-ofctl dump-flows br0 table=10 NXST_FLOW reply (xid=0x4): cookie=0x0, duration=4355.977s, table=10, n_packets=0, n_bytes=0, idle_age=4355, hard_age=15, vlan_tci=0x0014/0x0fff,dl_dst=50:00:00:00:00:01 actions=load:0x2-&gt;NXM_NX_REG0[0..15]</code> </pre> <br>  ,   ,   ,      2.      . <br><br><h2>   3:    </h2><br>      ,     ,   MAC-    VLAN.    2          ,              . <br><br>         <br><br><pre> <code class="bash hljs">$ ovs-ofctl add-flow br0 <span class="hljs-string"><span class="hljs-string">"table=3 priority=50 actions=resubmit(,10), resubmit(,4)"</span></span></code> </pre> <br>        10,     ‚Äúlearn‚Äù.    ,        0.        ,      10  ,   ‚Äúresubmit‚Äù  .     ,     0  ‚Ññ0   ,           . <br><br>   ‚Äî     4,    . <br><br>      ,      10     ,        . <br><br><pre> <code class="bash hljs">$ ovs-ofctl add-flow br0 <span class="hljs-string"><span class="hljs-string">"table=3 priority=99 dl_dst=01:00:00:00:00:00/01:00:00:00:00:00 actions=resubmit(,4)"</span></span></code> </pre> <br><blockquote>       ,         10,       0 ,    . </blockquote><br><br><h2>   3 </h2><br><h4>  Example </h4><br>     ,  Open vSwitch   f0:00:00:00:00:01   p1 VLAN' 20: <br><br><pre> <code class="bash hljs">$ ovs-appctl ofproto/trace br0 in_port=1,dl_vlan=20,dl_src=f0:00:00:00:00:01,dl_dst=90:00:00:00:00:01 -generate</code> </pre> <br>   ,    ,    10     . <br><br><pre> <code class="bash hljs">Bridge: br0 Flow: in_port=1,dl_vlan=20,dl_vlan_pcp=0,dl_src=f0:00:00:00:00:01,dl_dst=90:00:00:00:00:01,dl_type=0x0000 Rule: table=0 cookie=0 priority=0 OpenFlow actions=resubmit(,1) Resubmitted flow: in_port=1,dl_vlan=20,dl_vlan_pcp=0,dl_src=f0:00:00:00:00:01,dl_dst=90:00:00:00:00:01,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=90:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=1 cookie=0 priority=99,in_port=1 OpenFlow actions=resubmit(,2) Resubmitted flow: unchanged Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=90:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=2 cookie=0 OpenFlow actions=learn(table=10,NXM_OF_VLAN_TCI[0..11],NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:NXM_OF_IN_PORT[]-&gt;NXM_NX_REG0[0..15]),resubmit(,3) Resubmitted flow: unchanged Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,vlan_tci=0x0014/0x0fff,dl_src=f0:00:00:00:00:01,dl_dst=90:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=3 cookie=0 priority=50 OpenFlow actions=resubmit(,10),resubmit(,4) Resubmitted flow: unchanged Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,vlan_tci=0x0014/0x0fff,dl_src=f0:00:00:00:00:01,dl_dst=90:00:00:00:00:01,dl_type=0x0000 Rule: table=254 cookie=0 priority=0,reg0=0x2 OpenFlow actions=drop Resubmitted flow: unchanged Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,vlan_tci=0x0014/0x0fff,dl_src=f0:00:00:00:00:01,dl_dst=90:00:00:00:00:01,dl_type=0x0000 Rule: table=254 cookie=0 priority=0,reg0=0x2 OpenFlow actions=drop Final flow: unchanged Megaflow: recirc_id=0,in_port=1,dl_vlan=20,dl_src=f0:00:00:00:00:01,dl_dst=90:00:00:00:00:01,dl_type=0x0000 Datapath actions: drop</code> </pre> <br>    ,     .   ‚Äî    10   : <br><br><pre> <code class="bash hljs">$ ovs-ofctl dump-flows br0 table=10</code> </pre> <br>    : <br><br><pre> <code class="bash hljs">NXST_FLOW reply (xid=0x4): cookie=0x0, duration=54.661s, table=10, n_packets=0, n_bytes=0, idle_age=54, vlan_tci=0x0014/0x0fff,dl_dst=f0:00:00:00:00:01 actions=load:0x1-&gt;NXM_NX_REG0[0..15]</code> </pre> <br><blockquote>     ,      ,       .         ,    ,        ovs-ofctl del-flows br0 table=10 </blockquote><br>   ‚Äî   ,     . ,       p2,          p1. <br><br><pre> <code class="bash hljs">$ ovs-appctl ofproto/trace br0 in_port=2,dl_src=90:00:00:00:00:01,dl_dst=f0:00:00:00:00:01 -generate</code> </pre> <br>    .    ,     ‚Äúresubmit(,10)‚Äù.      ,    ,     MAC-,   ,       p1   0. <br><br><pre> <code class="bash hljs">Bridge: br0 Flow: in_port=2,vlan_tci=0x0000,dl_src=90:00:00:00:00:01,dl_dst=f0:00:00:00:00:01,dl_type=0x0000 Rule: table=0 cookie=0 priority=0 OpenFlow actions=resubmit(,1) Resubmitted flow: in_port=2,vlan_tci=0x0000,dl_src=90:00:00:00:00:01,dl_dst=f0:00:00:00:00:01,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=2,vlan_tci=0x0000,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=f0:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=1 cookie=0 priority=99,in_port=2,vlan_tci=0x0000 OpenFlow actions=mod_vlan_vid:20,resubmit(,2) Resubmitted flow: in_port=2,dl_vlan=20,dl_vlan_pcp=0,dl_src=90:00:00:00:00:01,dl_dst=f0:00:00:00:00:01,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=2,vlan_tci=0x0000,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=f0:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=2 cookie=0 OpenFlow actions=learn(table=10,NXM_OF_VLAN_TCI[0..11],NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:NXM_OF_IN_PORT[]-&gt;NXM_NX_REG0[0..15]),resubmit(,3) Resubmitted flow: unchanged Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=2,vlan_tci=0x0000,dl_src=90:00:00:00:00:01,dl_dst=f0:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=3 cookie=0 priority=50 OpenFlow actions=resubmit(,10),resubmit(,4) Resubmitted flow: unchanged Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=2,vlan_tci=0x0000,dl_src=90:00:00:00:00:01,dl_dst=f0:00:00:00:00:01,dl_type=0x0000 Rule: table=10 cookie=0 vlan_tci=0x0014/0x0fff,dl_dst=f0:00:00:00:00:01 OpenFlow actions=load:0x1-&gt;NXM_NX_REG0[0..15] Resubmitted flow: reg0=0x1,in_port=2,dl_vlan=20,dl_vlan_pcp=0,dl_src=90:00:00:00:00:01,dl_dst=f0:00:00:00:00:01,dl_type=0x0000 Resubmitted regs: reg0=0x1 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,reg0=0/0xffff,in_port=2,vlan_tci=0x0000,dl_src=90:00:00:00:00:01,dl_dst=f0:00:00:00:00:01,dl_type=0x0000 Rule: table=254 cookie=0 priority=0,reg0=0x2 OpenFlow actions=drop Final flow: reg0=0x1,in_port=2,dl_vlan=20,dl_vlan_pcp=0,dl_src=90:00:00:00:00:01,dl_dst=f0:00:00:00:00:01,dl_type=0x0000 Megaflow: recirc_id=0,in_port=2,vlan_tci=0x0000,dl_src=90:00:00:00:00:01,dl_dst=f0:00:00:00:00:01,dl_type=0x0000 Datapath actions: drop</code> </pre> <br>       ,  ,     ,  MAC-     .  ,       ovs-appctl <br><br><pre> <code class="bash hljs">$ ovs-appctl ofproto/trace br0 in_port=1,dl_vlan=20,dl_src=f0:00:00:00:00:01,dl_dst=90:00:00:00:00:01 -generate</code> </pre> <br>  ,     ‚Äúload‚Äù   10     : <br><br><pre> <code class="bash hljs">Bridge: br0 Flow: in_port=1,dl_vlan=20,dl_vlan_pcp=0,dl_src=f0:00:00:00:00:01,dl_dst=90:00:00:00:00:01,dl_type=0x0000 Rule: table=0 cookie=0 priority=0 OpenFlow actions=resubmit(,1) Resubmitted flow: in_port=1,dl_vlan=20,dl_vlan_pcp=0,dl_src=f0:00:00:00:00:01,dl_dst=90:00:00:00:00:01,dl_type=0x0000 Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=90:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=1 cookie=0 priority=99,in_port=1 OpenFlow actions=resubmit(,2) Resubmitted flow: unchanged Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,dl_src=00:00:00:00:00:00/01:00:00:00:00:00,dl_dst=90:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=2 cookie=0 OpenFlow actions=learn(table=10,NXM_OF_VLAN_TCI[0..11],NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:NXM_OF_IN_PORT[]-&gt;NXM_NX_REG0[0..15]),resubmit(,3) Resubmitted flow: unchanged Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,vlan_tci=0x0014/0x0fff,dl_src=f0:00:00:00:00:01,dl_dst=90:00:00:00:00:00/ff:ff:ff:ff:ff:f0,dl_type=0x0000 Rule: table=3 cookie=0 priority=50 OpenFlow actions=resubmit(,10),resubmit(,4) Resubmitted flow: unchanged Resubmitted regs: reg0=0x0 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,in_port=1,vlan_tci=0x0014/0x0fff,dl_src=f0:00:00:00:00:01,dl_dst=90:00:00:00:00:01,dl_type=0x0000 Rule: table=10 cookie=0 vlan_tci=0x0014/0x0fff,dl_dst=90:00:00:00:00:01 OpenFlow actions=load:0x2-&gt;NXM_NX_REG0[0..15] Resubmitted flow: reg0=0x2,in_port=1,dl_vlan=20,dl_vlan_pcp=0,dl_src=f0:00:00:00:00:01,dl_dst=90:00:00:00:00:01,dl_type=0x0000 Resubmitted regs: reg0=0x2 reg1=0x0 reg2=0x0 reg3=0x0 reg4=0x0 reg5=0x0 reg6=0x0 reg7=0x0 reg8=0x0 reg9=0x0 reg10=0x0 reg11=0x0 reg12=0x0 reg13=0x0 reg14=0x0 reg15=0x0 Resubmitted odp: drop Resubmitted megaflow: recirc_id=0,reg0=0/0xffff,in_port=1,vlan_tci=0x0014/0x0fff,dl_src=f0:00:00:00:00:01,dl_dst=90:00:00:00:00:01,dl_type=0x0000 Rule: table=254 cookie=0 priority=0,reg0=0x2 OpenFlow actions=drop Final flow: reg0=0x2,in_port=1,dl_vlan=20,dl_vlan_pcp=0,dl_src=f0:00:00:00:00:01,dl_dst=90:00:00:00:00:01,dl_type=0x0000 Megaflow: recirc_id=0,in_port=1,dl_vlan=20,dl_src=f0:00:00:00:00:01,dl_dst=90:00:00:00:00:01,dl_type=0x0000 Datapath actions: drop</code> </pre> <br><h2>   4:    </h2><br>      4     0,    ,     ,  0       .   ,     VLAN (802.1Q),            . <br><br>     ‚Äî   .        p1: <br><br><pre> <code class="bash hljs">$ ovs-ofctl add-flow br0 <span class="hljs-string"><span class="hljs-string">"table=4 reg0=1 actions=1"</span></span></code> </pre> <br>          VLAN   : <br><br><pre> <code class="bash hljs">$ ovs-ofctl add-flows br0 - &lt;&lt;<span class="hljs-string"><span class="hljs-string">'EOF'</span></span> table=4 reg0=2 actions=strip_vlan,2 table=4 reg0=3 actions=strip_vlan,3 table=4 reg0=4 actions=strip_vlan,4 EOF</code> </pre> <br>     ,     MAC-    .      ,        VLAN-      802.1Q       ,     : <br><br><pre> <code class="bash hljs">$ ovs-ofctl add-flows br0 - &lt;&lt;<span class="hljs-string"><span class="hljs-string">'EOF'</span></span> table=4 reg0=0 priority=99 dl_vlan=20 actions=1,strip_vlan,2 table=4 reg0=0 priority=99 dl_vlan=30 actions=1,strip_vlan,3,4 table=4 reg0=0 priority=50 actions=1 EOF</code> </pre> <br>       OpenFlow,          ,    .,      p1,        p1,         actions=1,          ,    . ,        . <br><br><h2>   4 </h2><br><h4>  1 </h4><br>   ,     p1  VLAN 30: <br><br><pre> <code class="bash hljs">$ ovs-appctl ofproto/trace br0 in_port=1,dl_dst=ff:ff:ff:ff:ff:ff,dl_vlan=30</code> </pre><br>         ,      802.1Q       p3  p4,      VLAN: <br><br><pre> <code class="bash hljs">Datapath actions: pop_vlan,3,4</code> </pre> <br>    ,      ,    p3: <br><br><pre> <code class="bash hljs">$ ovs-appctl ofproto/trace br0 in_port=3,dl_dst=ff:ff:ff:ff:ff:ff</code> </pre> <br>   ,      p1   802.1Q    p4  . <br><br><pre> <code class="bash hljs">Datapath actions: push_vlan(vid=30,pcp=0),1,pop_vlan,4</code> </pre> <br><blockquote> Open vSwitch       4,push_vlan(vid=30,pcp=0),       </blockquote><br>      ,  ,    VLAN      p1. <br><br><pre> <code class="bash hljs">$ ovs-appctl ofproto/trace br0 in_port=1,dl_dst=ff:ff:ff:ff:ff:ff $ ovs-appctl ofproto/trace br0 in_port=1,dl_dst=ff:ff:ff:ff:ff:ff,dl_vlan=55</code> </pre> <br>      : <br><br><pre> <code class="bash hljs">$ ovs-appctl ofproto/trace br0 in_port=1,dl_dst=ff:ff:ff:ff:ff:ff,dl_vlan=20 $ ovs-appctl ofproto/trace br0 in_port=2,dl_dst=ff:ff:ff:ff:ff:ff $ ovs-appctl ofproto/trace br0 in_port=4,dl_dst=ff:ff:ff:ff:ff:ff</code> </pre> <br>          ,       : <br><br><pre> <code class="bash hljs">$ ovs-appctl ofproto/trace br0 in_port=4,dl_dst=01:00:00:00:00:00 $ ovs-appctl ofproto/trace br0 in_port=1,dl_dst=90:12:34:56:78:90,dl_vlan=20 $ ovs-appctl ofproto/trace br0 in_port=1,dl_dst=90:12:34:56:78:90,dl_vlan=30</code> </pre> <br><h4>  2:  MAC- </h4><br>    ,       3.    MAC-   p1  VLAN 30 <br><br><pre> <code class="bash hljs">$ ovs-appctl ofproto/trace br0 in_port=1,dl_vlan=30,dl_src=10:00:00:00:00:01,dl_dst=20:00:00:00:00:01 -generate</code> </pre><br>      ,     ,        p3  p4,    VLAN 30 <br><br><pre> <code class="bash hljs">Datapath actions: pop_vlan,3,4</code> </pre> <br>    MAC-          p4 <br><br><pre> <code class="bash hljs">$ ovs-appctl ofproto/trace br0 in_port=4,dl_src=20:00:00:00:00:01,dl_dst=10:00:00:00:00:01 -generate</code> </pre> <br>     ,       ‚Äî p1,       <br><br><pre> <code class="bash hljs">Datapath actions: push_vlan(vid=30,pcp=0),1</code> </pre> <br>      : <br><br><pre> <code class="bash hljs">$ ovs-appctl ofproto/trace br0 in_port=1,dl_vlan=30,dl_src=10:00:00:00:00:01,dl_dst=20:00:00:00:00:01 -generate</code> </pre> <br>  ,       ,         ‚Äî p4. <br><br><pre> <code class="bash hljs">Datapath actions: pop_vlan,4</code> </pre> <br>      . </div><p>Source: <a href="https://habr.com/ru/post/325560/">https://habr.com/ru/post/325560/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325546/index.html">Setting up replication in FreeIPA 4.4 with domain level 1</a></li>
<li><a href="../325550/index.html">7 cases of using Big Data technologies in production</a></li>
<li><a href="../325552/index.html">How automatic testing is arranged in Mail.Ru Mail for iOS</a></li>
<li><a href="../325554/index.html">What will block your site? Roskomnadzor and resource bank in a nutshell</a></li>
<li><a href="../325558/index.html">Oblakoteka has selected Lenovo servers as a platform for the latest IaaS services</a></li>
<li><a href="../325564/index.html">R, GIS and fuzzyjoin: restore statistics for the NUTS regions</a></li>
<li><a href="../325566/index.html">Why the cloud does not take off: how loyalty systems work in stores</a></li>
<li><a href="../325568/index.html">Full development environment automation with docker-compose</a></li>
<li><a href="../325570/index.html">How to test docker image for half a second</a></li>
<li><a href="../325572/index.html">Users convinced GitLab not to leave the cloud</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>