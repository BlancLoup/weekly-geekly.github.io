<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Geant4 Continuation Check</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wrote the right article about checking the Geant4 project. Let me remind you the background. Recently, the old version of the Geant4 library was teste...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Geant4 Continuation Check</h1><div class="post__text post__text-html js-mediator-article">  Wrote the right article about checking the Geant4 project.  Let me remind you the background.  Recently, the old version of the Geant4 library was tested and the article " <a href="http://habrahabr.ru/company/pvs-studio/blog/202154/">Copy-Paste and Muons</a> " was written.  Why was the old version checked?  People are not perfect.  The essence of the mistake can be found in the previous article.  Now, however, we offer you a brief report on the verification of Geant4 version 10.0-beta. <br><br><a name="habracut"></a><br><br><h2>  Summary of the previous article </h2><br>  The article ‚ÄúCopy-Paste and Muons‚Äù describes the benefits of using the <a href="http://www.viva64.com/ru/t/0046/">static analysis</a> methodology and the capabilities of <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> .  The bearded project Geant4 version 4.9.4 was tested.  Many suspicious code fragments were found, which were described in the article. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b><i>Geant4</i></b> <i>is a program for simulating the passage of elementary particles through matter using Monte Carlo methods.</i>  <i>Developed at CERN in the object-oriented programming language C ++.</i>  <i>It is a further development of previous versions of GEANT, substantially reworked and expanded.</i> <br><br>  Project website: <a href="http://geant4.org/">http://geant4.org</a> . <br><br>  In the previous article, 16 highly suspicious code fragments were described.  New check revealed only 10 of them.  The rest are either visible or fixed, or this code no longer exists.  I will not re-describe these code fragments in a new article.  They can be seen in the previous article.  It indicates whether the analyzer warning disappeared or not in the new version. <br><br>  I apologize for such a strange research format.  But I hope this does not hurt to correct a number of flaws in the Geant4 project and to draw people's attention to the PVS-Studio tool. <br><br>  If I'm not mistaken, the previous version of the library refers to 2011.  During this time, much has changed, and it is not surprising that some new strange places have been found in the code.  Let's see what is new or what I did not notice earlier. <br><br><h2>  New suspicious code snippets </h2><br>  A complete list of suspicious places that I noticed is in the <a href="http://www.viva64.com/external-pictures/txt/geant4_new.txt">geant4_new.txt</a> file.  I want to emphasize that you should not rely solely on this list.  It is much better to check the project yourself and analyze all the warnings.  We are ready to provide a key to the developers of Geant4 for this: <a href="http://www.viva64.com/ru/about-feedback/">a feedback form</a> . <br><br><h3>  Same functions </h3><br><pre><code class="cpp hljs">G4double G4CsvAnalysisManager::GetH2Xmin(G4int <span class="hljs-comment"><span class="hljs-comment">/*id*/</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { ExceptionForHistograms(<span class="hljs-string"><span class="hljs-string">"GetH2Xmin"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } G4double G4CsvAnalysisManager::GetH2Xmax(G4int <span class="hljs-comment"><span class="hljs-comment">/*id*/</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { ExceptionForHistograms(<span class="hljs-string"><span class="hljs-string">"GetH2Xmin"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  PVS-Studio warning: V524 It is odd that the body of the GetH2Xmax function is fully equivalent to the body of the GetH2Xmin function.  _G4analysis-archive g4csvanalalysismanager.cc 933 <br><br>  The GetH2Xmax () function, most likely, should call ExceptionForHistograms () with a different parameter: <br><pre> <code class="cpp hljs">ExceptionForHistograms(<span class="hljs-string"><span class="hljs-string">"GetH2Xmax"</span></span>);</code> </pre> <br>  The error does not look serious.  As I understand it, this is an exception handling.  Nevertheless, I decided to mention this Copy-Paste error. <br><br><h3>  Energy is zero </h3><br>  The functions CalculateTotalEnergy () summarizes the values ‚Äã‚Äãin the 'Etot' variable.  Suddenly, this variable is reset.  This is very suspicious. <br><pre> <code class="cpp hljs">G4double G4RKFieldIntegrator::CalculateTotalEnergy(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> G4KineticTrackVector&amp; Barions) { G4double Etot = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(G4int c2 = c1 + <span class="hljs-number"><span class="hljs-number">1</span></span>; c2 &lt; nBarion; c2++) { .... <span class="hljs-comment"><span class="hljs-comment">// Esk2 Etot += t1*std::pow(Alpha/pi, 3/2)* std::exp(-Alpha*r12*r12); // Eyuk Etot += ....; // Ecoul Etot += 1.44*p1-&gt;GetDefinition()-&gt;GetPDGCharge()* p2-&gt;GetDefinition()-&gt;GetPDGCharge()/r12* Erf(std::sqrt(Alpha)*r12); // Epaul Etot = 0; .... } .... }</span></span></code> </pre> <br>  PVS-Studio warning: V519 The 'Etot' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 80, 83. _G4processes-archive g4rkfieldintegrator.cc 83 <br><br><h3>  Suspicious logic </h3><br><pre> <code class="cpp hljs">G4double G4EmBiasingManager::ApplySecondaryBiasing(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span> == nsplit) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(safety &gt; fSafetyMin) .... } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span> == nsplit) { weight = ApplyRussianRoulette(vd, index); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { G4double tmpEnergy = pPartChange-&gt;GetProposedKineticEnergy(); G4ThreeVector tmpMomDir = .... weight = ApplySplitting(vd, track, currentModel, index, tcut); pPartChange-&gt;SetProposedKineticEnergy(tmpEnergy); pPartChange-&gt;ProposeMomentumDirection(tmpMomDir); } .... }</code> </pre> <br>  PVS-Studio warning: V646 Consider inspecting the application's logic.  It's possible that 'else' keyword is missing.  _G4processes-archive g4embiasingmanager.cc 299 <br><br>  The code is designed as if the ‚Äúelse if‚Äù construct is used.  But it is not.  If we arrange the code correctly, we get this: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span> == nsplit) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(safety &gt; fSafetyMin) .... } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span> == nsplit) { weight = ApplyRussianRoulette(vd, index); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { G4double tmpEnergy = pPartChange-&gt;GetProposedKineticEnergy(); G4ThreeVector tmpMomDir = .... weight = ApplySplitting(vd, track, currentModel, index, tcut); pPartChange-&gt;SetProposedKineticEnergy(tmpEnergy); pPartChange-&gt;ProposeMomentumDirection(tmpMomDir); }</code> </pre> <br>  Note that the block related to the 'else' branch is always executed if "1! = Nsplit".  There is a suspicion that a different logic of work was conceived. <br><br>  A similar situation can be seen here: <br><br>  V646 Consider inspecting the application's logic.  It's possible that 'else' keyword is missing.  _G4processes-archive g4embiasingmanager.cc 347 <br><br><h3>  Unfinished code? </h3><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> G4MolecularDecayTable::AddExcitedState(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> G4String&amp; label) { channelsMap::iterator channelsIter = fDecayChannelsMap.find(label); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(channelsIter != fDecayChannelsMap.end()) { G4String errMsg = <span class="hljs-string"><span class="hljs-string">"Excited state"</span></span> + label + <span class="hljs-string"><span class="hljs-string">" already registered in the decay table."</span></span>; G4Exception(<span class="hljs-string"><span class="hljs-string">"G4MolecularDecayTable::AddExcitedState"</span></span>, <span class="hljs-string"><span class="hljs-string">"G4MolecularDecayTable003"</span></span>, FatalErrorInArgument, errMsg); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } fDecayChannelsMap[label] ; }</code> </pre> <br>  PVS-Studio warning: V607 Ownerless expression 'fDecayChannelsMap [label]'.  _G4processes-archive g4moleculardecaytable.cc 140 <br><br>  The end of the function looks very suspicious: <br><pre> <code class="cpp hljs">fDecayChannelsMap[label] ;</code> </pre> <br>  What is it?  Is something missing here?  What did you want to do with the cell array? <br><br><h3>  Kinematics </h3><br>  The following example is quite long.  Unfortunately, it is difficult for me to cut it even more.  See what values ‚Äã‚Äãthe variable 'id' can take. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> G4QMDCollision::CalKinematicsOfBinaryCollisions( G4double dt) { .... G4int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( secs ) { .... id++; .... } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">abs</span></span> ( eini - efin ) &lt; fepse*<span class="hljs-number"><span class="hljs-number">10</span></span> ) .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( G4int i0i = <span class="hljs-number"><span class="hljs-number">0</span></span> ; i0i &lt; id<span class="hljs-number"><span class="hljs-number">-1</span></span> ; i0i++ ) { theSystem-&gt;DeleteParticipant( i0i+n0 ); } .... } .... }</code> </pre> <br>  PVS-Studio warning: V621 Consider inspecting the 'for' operator.  It is possible that you will not be executed at all.  _G4processes-archive g4qmdcollision.cc 228 <br><br>  If the condition "if (secs)" fails, the variable 'id' will remain zero.  Then, a loop of the form may occur: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( G4int i0i = <span class="hljs-number"><span class="hljs-number">0</span></span> ; i0i &lt; <span class="hljs-number"><span class="hljs-number">-1</span></span> ; i0i++ )</code> </pre> <br>  It will be a very strange cycle.  I think it is worth checking the logic of the function CalKinematicsOfBinaryCollisions (). <br><br><h3>  Other </h3><br>  There are a number of warnings that I did not describe in the last article.  I will not be in this.  For example, I will show one case: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">G4HadronicException</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception { .... }; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> G4double G4GeneralPhaseSpaceDecay::Pmx( G4double e, G4double p1, G4double p2) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e-p1-p2 &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> ) { G4HadronicException(__FILE__, __LINE__, <span class="hljs-string"><span class="hljs-string">"G4GeneralPhaseSpaceDecay::Pmx "</span></span> <span class="hljs-string"><span class="hljs-string">"energy in cms &gt; mass1+mass2"</span></span>); } .... }</code> </pre> <br>  PVS-Studio warning.  V596 The object was not used.  The 'throw' keyword could be missing: throw G4HadronicException (FOO);  _G4processes-archive g4generalphasespacedecay.hh 116 <br><br>  There are several errors when the 'throw' statement is forgotten.  As a result, an object having the type 'G4HadronicException' is created and immediately destroyed.  And then the program continues to work with incorrect data. <br><br>  These are the typos that are not described in the article, can be found in the file <a href="http://www.viva64.com/external-pictures/txt/geant4_new.txt">geant4_new.txt</a> .  There are also warnings related to micro-optimizations. <br><br><h2>  Conclusion </h2><br>  On the pointlessness of checking the old project.  You see, and I cut it.  :) <br><br>  A good reason to potrolit. </div><p>Source: <a href="https://habr.com/ru/post/202158/">https://habr.com/ru/post/202158/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../202144/index.html">Start Sandbox Championship Russian AI Cup</a></li>
<li><a href="../202146/index.html">It seems to me that the software hell is already close ...</a></li>
<li><a href="../202150/index.html">About cloud backups: use Rackspace CloudFiles</a></li>
<li><a href="../202152/index.html">Life hacking: in any incomprehensible situation, multiply by three</a></li>
<li><a href="../202154/index.html">Copy-Paste and muons</a></li>
<li><a href="../202162/index.html">Implicit predicates</a></li>
<li><a href="../202164/index.html">Well, Pebble, wait a minute</a></li>
<li><a href="../202166/index.html">Live broadcast launch Visual Studio 2013 in Russia!</a></li>
<li><a href="../202168/index.html">Added support for Yandex.Maps version 2.1 in angular.js module yaMap</a></li>
<li><a href="../202170/index.html">Video of October Python Meetup Reports</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>