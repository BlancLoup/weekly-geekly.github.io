<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We are friends of Check Point and GOST encryption</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habrovchane! 

 In this article we will tell you about the process of setting up IPSec VPN on Check Point R75.40VS gateways using Russian cryptoal...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We are friends of Check Point and GOST encryption</h1><div class="post__text post__text-html js-mediator-article"> Hi, Habrovchane! <img align="right" src="https://habrastorage.org/storage2/959/0ed/038/9590ed038fa25da017da4ae5388d18e3.png"><br><br>  In this article we will tell you about the process of setting up IPSec VPN on Check Point R75.40VS gateways using Russian cryptoalgorithms.  This article will be of interest first of all to engineers involved in setting up and supporting Check Point products. <br><br>  When I had the task to configure Check Point IPSec VPN gateways using Russian cryptography, I was faced with the problem of a lack of information describing this process.  On this topic, you can find the official guides, describing the process in general terms, and a little scattered information on the Internet.  Personally, after studying them, I still have a lot of questions that we tried to highlight in this article. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  The use of GOST encryption allows organizations to fulfill the requirements for the cryptographic protection of communication channels in cases when this is dictated by the requirements of the Russian legislation.  It should be noted that for the time being, Check Point gateways are still being certified by the FSB as SKZI (information encryption tool), but the manufacturer promises to receive a certificate in the foreseeable future.  Although the crypto-libraries themselves have a certificate from the FSB, the question remains of controlling their embedding. <br><br>  The topic of control over embedding of cryptographic tools is rather ambiguous and only the FSB can give a definitive answer to some questions. <br><br>  An interesting post on this topic can be read here: <br><br>  <a href="http://www.cryptopro.ru/forum2/default.aspx%3Fg%3Dposts%26t%3D1534">www.cryptopro.ru/forum2/default.aspx?g=posts&amp;t=1534</a> <br><br>  In a few words about this topic can be found at the end of the article. <br><br>  Support for GOST encryption on Check Point gateways has been around for quite a while for certified and upcoming FSTEC versions of firewall screens from this manufacturer.  The ability to use GOST encryption on Check Point gateways appears due to the installation of a special patch (hotfix in Check Point terminology) and crypto libraries of the CryptoPro company.  For all versions except R65.50, only building an IPSec Site-to-Site Domain Based VPN is available; for version R65.50, the option of building an IPSec Site-to-Site Route Based VPN is also available.  Currently hotfixes for GOST IPSec encryption exist for the following Check Point versions: <br><br>  ‚Ä¢ R65.50 (CryptoPro CSP 3.6 crypto libraries are used); <br>  ‚Ä¢ R71.20 (CryptoPro CSP 3.6 R2 crypto library is used); <br>  ‚Ä¢ R75.30 (CryptoPro CSP 3.6 R3 crypto library is used); <br>  ‚Ä¢ R75.40VS (CryptoPro CSP 3.6 R3 crypto library is used). <br><br>  Versions R65.50 and R71.20 are certified by the FSTEC of Russia for a firewall in the third class of protection, and version R71.20 is additionally certified for an intrusion detection system and certified for the absence of undeclared capabilities in the fourth level. <br><br>  It should also be noted that multi-threading support is implemented in the GOST-pack versions for the R75.30 and R75.40VS, which should have a good impact on performance. <br><br>  This article will describe the process of setting up GOST encryption on the latest available version (R75.40VS). <br><br>  The description of setting GOST encryption for version R71.20 is described quite well in this article: <br><br>  <a href="http://www.masterlab.ru/CheckPoint/Knowledgebase/GOST-VPN-on-Check-Point/">www.masterlab.ru/CheckPoint/Knowledgebase/GOST-VPN-on-Check-Point</a> <br><br>  In order to make the description more informative, not the easiest deployment option was chosen.  The description includes setting up a Site-to-Site Domain Based VPN with authentication of partners for GOST certificates and password (PSK).  To configure the authentication of partners in the state-of-the-art certificates, a certification authority is needed to ensure their release; this description uses the Microsoft Certification Authority with an installed CryptoPro Pro CSP.  Description of the integration of CryptoPro CSP with Microsoft Certification Authority deserves a separate discussion and will not be presented in this article.  For test purposes, if you do not want to deploy a certificate authority for issuing GOST certificates, you can use the CryptoPro test certificate authority located at this address: <br><br>  <a href="http://www.cryptopro.ru/certsrv/">www.cryptopro.ru/certsrv</a> <br><br>  The process of setting up the Microsoft Certification Authority with CryptoPro, for example, is well described by the guys from S-Terra in the admin guides on the CSP VPN Gate and CSP VPN Client, which can be found here: <br><br>  <a href="http://www.s-terra.com/documents/R31/Gate/CSP_VPN_Appendix.pdf">www.s-terra.com/documents/R31/Gate/CSP_VPN_Appendix.pdf</a> <br>  <a href="http://www.s-terra.com/documents/R311/Client/CSP_VPN_Client_Admin_Guide_cp.pdf">www.s-terra.com/documents/R311/Client/CSP_VPN_Client_Admin_Guide_cp.pdf</a> <br><br>  In general, the whole process can be divided into the following stages: <br><br>  1. Preliminary steps related to the installation and initial configuration of Check Point and the certification authority; <br>  2. Generate an external gamma file for pseudo-random number sensors used on gateways; <br>  3. Installing hotfix and crypto library; <br>  4. Creating and configuring a pseudo-random number sensor; <br>  5. Configure VPN: <br>  5.1.  Configure VPN using certificates; <br>  5.2.  Set up a VPN using a password. <br><br>  Below the points will be considered all the above stages. <br><br>  Stand scheme: <br><table><tbody><tr><th>  Node name <br></th><th>  operating system <br></th><th>  Role <br></th></tr><tr><td>  CPMS <br></td><td>  Check Point Gaia R75.40VS <br></td><td>  Check Point Gateway Management Server (Primary Management Server) <br>  Controlled gateways: FW1-Node-1, FW1-Node-2 <br></td></tr><tr><td>  FW1-Node-1 <br></td><td>  Check Point Gaia R75.40VS <br></td><td>  Check Point (Security gateway), cluster member FW1-Cluster, cluster mode: Multicast load sharing <br></td></tr><tr><td>  FW1-Node-2 <br></td><td>  Check Point Gaia R75.40VS <br></td><td>  Check Point (Security gateway), cluster member FW1-Cluster, cluster mode: Multicast load sharing <br></td></tr><tr><td>  Fw2 <br></td><td>  Check Point Gaia R75.40VS <br></td><td>  Check Point Gateway Management Server (Primary Management Server), Check Point Gateway (Security gateway) <br></td></tr><tr><td>  PC <br></td><td>  Windows 7 <br></td><td>  The machine used to check traffic between gateways <br></td></tr><tr><td>  CA-Srv <br></td><td>  Windows Server 2003 Enterprise <br></td><td>  Certificate Authority (Microsoft CA with installed CryptoPro) <br></td></tr></tbody></table><br><br><img src="https://habrastorage.org/storage2/b33/ffe/830/b33ffe83043dd6312fe003607f445e3c.png" alt="image"><br><br>  To configure GOST encryption on Check Point gateways, you need the following software: <br><br>  ‚Ä¢ CryptoPro CSP 3.6 R3 distribution for Windows (x86 / x64), you can download it here (registration is required): <br><br>  <a href="">www.cryptopro.ru/sites/default/files/private/csp/36R3/7491/CSPSetup.exe</a> <br><br>  ‚Ä¢ CryptoPro CSP 3.6 R3 distribution for Check Point SPLAT / GAiA (x86 / x64), you can download it here (registration is required): <br><br>  <a href="">www.cryptopro.ru/sites/default/files/private/csp/36R3/7491/splat-gaia.tgz</a> <br><br>  ‚Ä¢ Check Point R75.40VS Gaia distribution, you can download it here (registration is required): <br><br>  <a href="https://supportcenter.checkpoint.com/supportcenter/portal/user/anon/page/default.psml/media-type/html%3Faction%3Dportlets.DCFileAction%26eventSubmit_doGetdcdetails%3D%26fileid%3D18503">supportcenter.checkpoint.com/supportcenter/portal/user/anon/page/default.psml/media-type/html?action=portlets.DCFileAction&amp;eventSubmit_doGetdcdetails=&amp;fileid=18503</a> <br><br>  ‚Ä¢ Universal hotfix (patch) for GOST support on Check Point gateways and control servers and a special version of the Check Point SmartConsole control utility, with support for GOST settings, can be downloaded here (If you need an official source, you can request from distributors or the manufacturer): <br><br>  <a href="http://ngfw.ru/2013/gost-ipsec-v4-r75-40vs">ngfw.ru/2013/gost-ipsec-v4-r75-40vs</a> <br><br>  Unlike the R65.50 and R71.20 versions, the GOST encryption setting for the R75.30 and R75.40VS versions does not require an additional Check Point license (free license for the GOST encryption functionality) and the test configuration can be fully performed on trial licenses. <br><br><h4>  <b>1. Preliminary actions</b> </h4><br>  ‚Ä¢ Install and initialize Check Point Gateways and Management Server; <br>  ‚Ä¢ Configure the Microsoft Certification Authority with the CryptoPro CSP. <br><br><h4>  <b>2. Generate an external gamma file</b> </h4><br>  In this description, the external gamma file is created on the CA-Srv machine using a biological random number sensor included in the CryptoPro Pro CSP 3.6 for Windows installed on the machine to create a certification authority.  To create a certified solution in real conditions, an external gamut file must be created on a machine that meets the requirements of the External Gamma Workstation document (ZTYAI.00050-03 90 05), which can be downloaded here (registration is required): <br><br>  <a href="">www.cryptopro.ru/sites/default/files/private/csp/36R3/7491/doc.zip</a> <br><br>  This file contains a gamut for initializing a software pseudo-random number sensor used to generate private encryption keys. <br><br>  To generate a gamma, perform the following sequence of actions: <br><br>  1) Create directories for source material files (In the case described, this is a separate directory for each gateway, since using the same file on different gateways is NOT ALLOWED, although technically it is possible); <br><br>  2) From the command line of the machine with CryptoPro CSP 3.6 installed, go to the C: \ Program Files \ CryptoPro \ CSP directory and run the following command: <br><br><pre><code class="bash hljs">genkpim.exe yn &lt;p&gt;</code> </pre> <br><br>  where: <br><br><pre> <code class="bash hljs">o y ‚Äì     (      2 ,        10       ,  1000   ); o n ‚Äì     (8   16- ),       ,  11111111; o &lt;p&gt; -      ( ,    1).</code> </pre><br><br>  Command entry example: <br><br><img src="https://habrastorage.org/storage2/5cc/449/311/5cc44931165a31577f0ef76bca8c3b9c.png" alt="image"><br><br>  3) The ‚Äúcorrect‚Äù AWP of the external gamut uses a hardware pseudo-random number sensor included in the Sable electronic lock, in the test case a biological pseudo-random number sensor is used and you will be asked to click on the keys or move the mouse, it looks like this: <br><br><img src="https://habrastorage.org/storage2/fe1/541/189/fe1541189cb2eabd53d3d035b4db0d6a.png" alt="image"><br><br>  If the genkpim.exe utility is successfully launched, the following message will be displayed in the command line: <br><br><img src="https://habrastorage.org/storage2/5d7/477/8c8/5d74778c8aa0f2967e9bcf871def2f8a.png" alt="image"><br><br>  Upon completion of the biological random number sensor operation, a given number of gamma segments of 36 bytes each will be created (32 bytes of the pseudo-random sequence and 4 bytes of the CRC to the segment).  In the directory specified in the command, two directories will be created with the names db1 and db2, each containing one file with the name kis_1, these files are identical and duplicated for reliability. <br><br><h4>  <b>3. Installing hotfix and crypto libraries</b> </h4><br>  Crypto-libraries should be installed only on gateways.  On a machine that performs the role of the Check Point Management Server exclusively, the installation of cryptoblocks is optional.  Hotfix needs to be installed on both the gateways and the management server. <br><br>  To install a hotfix on a machine that performs the role of the Check Point Management Server exclusively, complete the following steps: <br><br>  1) Copy the hotfix file (archive named VPN_R75.40VS_HF_GOST_V4.0_EA) to the temporary directory on the server; <br>  To transfer / download files from Check Point, it is convenient to use the WinSCP utility.  In order to use the WinSCP utility to connect to Check Point, you need to specify the user using bash as standard when authenticating.  To do this, you must either temporarily change the settings used by the user that you are logging in to, or create a user to which you will hang this one on a permanent basis.  In Gaia OS, this can be done via a web interface, here‚Äôs an example of how a window with user settings should look like: <br><br><img src="https://habrastorage.org/storage2/3df/ad5/be1/3dfad5be1cf523528d7deae0763934c9.png" alt="image"><br><br>  2) Log in to the server via SSH; <br><br>  3) Switch to expert mode; <br><br>  4) Unpack the archive in the current directory; <br><br>  5) Run the installation script by running the command: <br><br><pre> <code class="bash hljs">./UnixInstallScript</code> </pre><br><br>  6) Installing a hotfix will cause an interruption of the services provided by the management server, agree with the warning about this: <br><br><img src="https://habrastorage.org/storage2/89a/d88/7aa/89ad887aa6d9f6dfaf84fe90f6cf7308.png" alt="image"><br><br>  7) After the installation is completed, you will receive the following message and asked to restart the server, agree: <br><br><img src="https://habrastorage.org/storage2/b3b/af1/f1a/b3baf1f1ae613280ace9a7228e44dd59.png" alt="image"><br><br>  8) After the reboot, the installation of the hotfix on the management server can be considered complete, it is necessary to install the hotfix and crypto libraries on the gateways; <br><br>  9) To install the hotfix and crypto-library on the machine acting as a gateway or a gateway combined with the management server, perform the following steps: <br><br>  ‚Ä¢ Log into the gateway through SSH; <br><br>  ‚Ä¢ Switch to expert mode; <br><br>  ‚Ä¢ Create the following directories on the gateway: <br><br><pre> <code class="bash hljs">/var/gost_install/rpm /var/gost_install/kis</code> </pre><br><br>  ‚Ä¢ Copy the rmp files included in the CryptoPro CSP 3.6 R3 distribution kit for Check Point SPLAT / GAiA (x86 / x64) to the gateway / var / gost_install / rpm; <br><br>  ‚Ä¢ Copy the corresponding external gamma file kis_1 to the / var / gost_install / kis directory on the gateway, it can be any file and the advising directory db1 or db2 of the directory specified in the command genkpim.exe ynp, since the files are identical; <br><br>  ‚Ä¢ Copy the hotfix (archive named VPN_R75.40VS_HF_GOST_V4.0_EA) to the temporary directory on the gateway; <br><br>  ‚Ä¢ Unpack the archive in the current directory; <br><br>  ‚Ä¢ Run the installation script by running the following command: <br><br><pre> <code class="bash hljs">./UnixInstallScript</code> </pre><br><br>  ‚Ä¢ Installing a hotfix will cause interruption of services provided by the gateway (including the transfer of traffic through the gateway), agree with the warning about this; <br><br>  ‚Ä¢ Upon completion of the installation, you will be presented with the following message and asked to restart the gateway, agree. <br><br>  For a machine acting as a gateway, the message will look like this: <br><br><img src="https://habrastorage.org/storage2/2ce/344/317/2ce3443175c8abb253090ff00e11dea0.png" alt="image"><br><br>  For a machine acting as a gateway combined with a management server, the following: <br><br><img src="https://habrastorage.org/storage2/f15/2c2/af7/f152c2af7f399b43fed5871970acec94.png" alt="image"><br><br>  10) After the installation is completed, you will need to enter the license key for CryptoPro.  You can do this with the following command: <br><br><pre> <code class="bash hljs">/opt/cprocsp/sbin/ia32/cpconfig -license -<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> &lt; &gt;</code> </pre><br><br>  To view the license status, use the following command: <br><br><pre> <code class="bash hljs">/opt/cprocsp/sbin/ia32/cpconfig -license -view</code> </pre><br><br>  In the test environment, this item can be skipped and use the trial license for CryptoPro. <br><br>  11) If you are using the 64-bit version of the Gaia OS, you need to disable SecureXL technology using the cpconfig utility launched from the command line. <br><br><h4>  <b>4. Creating and configuring a pseudo-random number sensor</b> </h4><br>  These actions are performed on gateways, including gateways that are combined with the management server. <br><br>  1) Log in to the gateway via SSH; <br><br>  2) Switch to expert mode; <br><br>  3) Copy the file kis_1 from the / var / gost_install / kis directory to the directories / var / opt / cprocsp / dsrf / db1 / and / var / opt / cprocsp / dsrf / db2 /; <br><br>  4) Create a pseudo-random number sensor by running the following command: <br><br><pre> <code class="bash hljs">/opt/cprocsp/sbin/ia32/cpconfig -hardware rndm -add cpsd -name <span class="hljs-string"><span class="hljs-string">'CPSDRNG'</span></span> -level 0</code> </pre><br><br>  5) Configure the created pseudo-random number sensor to use the external gamma file by executing the following commands: <br><br><pre> <code class="bash hljs">/opt/cprocsp/sbin/ia32/cpconfig -hardware rndm -configure cpsd -add string /db1/kis_1 /var/opt/cprocsp/dsrf/db1/kis_1 /opt/cprocsp/sbin/ia32/cpconfig -hardware rndm -configure cpsd -add string /db2/kis_1 /var/opt/cprocsp/dsrf/db2/kis_1</code> </pre><br><br>  You can verify that a new pseudo-random number sensor has been created using the following command: <br><br><pre> <code class="bash hljs">/opt/cprocsp/sbin/ia32/cpconfig -hardware rndm -view</code> </pre><br><br>  The output of the command will look like this and should contain information about the sensor with the name CPSDRNG and the maximum priority level equal to zero: <br><br><img src="https://habrastorage.org/storage2/483/d1c/fa3/483d1cfa3b62d0e9389a51ee2daf9d45.png" alt="image"><br><br>  The kis_1 file will be consumed when the sensor is initialized, for example, to create a private key container, adding a certificate takes 2 segments of the sequence.  Segments of the sequence are taken from the end of the file, used segments are deleted. <br><br>  For example: <br><br>  File size before adding certificate: <br><br><img src="https://habrastorage.org/storage2/ff3/e50/593/ff3e505939263876d6efaf506923526c.png" alt="image"><br><br>  File size after adding certificate: <br><br><img src="https://habrastorage.org/storage2/6c1/8be/38d/6c18be38d210aa7144c7ccbbfdd3ae47.png" alt="image"><br><br><h4>  <b>5. Configure VPN</b> </h4><br><h5>  5.1.  Configuring VPN using certificates </h5><br>  To configure GOST encryption with the authentication of certificate partners, you must perform the following sequence of actions: <br><br>  1) Install a special version of Check Point SmartConsole (file named: SmartConsole_GOST_R75.40VS_EA); <br><br>  2) Login to the management server using this utility; <br><br>  3) Create a new VPN Community: <br><br><img src="https://habrastorage.org/storage2/c13/411/733/c13411733a08485bda06fbb12e380eb4.png" alt="image"><br><br>  4) Put the gateways in the VPN Community being created, between which the VPN connection will be built: <br><br><img src="https://habrastorage.org/storage2/62c/5d6/c95/62c5d6c957ffeec697f1e6019fb1adca.png" alt="image"><br><br>  5) Configure the VPN Community to use GOST encryption: <br><br><img src="https://habrastorage.org/storage2/897/05b/329/89705b32915b5740f8d40b3465517647.png" alt="image"><br><br>  There are 3 options: <br><br>  Set 1 and Set 2 - differing in the used encryption modes, you can use any (supported by all versions for which there is a GOST, except R65.50); <br><br>  Legacy - compatibility mode with GOST on Check Point R65.50, if there is a need to build VPN tunnels with gateways operating on this version of Check Point. <br><br>  6) Click the "OK" button, thereby creating a new VPN Community; <br><br>  The VPN Community list will look something like this: <br><br><img src="https://habrastorage.org/storage2/bb8/4c3/003/bb84c3003c29eaf1543a3fd71e973143.png" alt="image"><br><br>  7) After creating the VPN Community and adding gateways to it, it is necessary to make in the configuration of the management server information about the GOST Certificate Authority that will issue certificates for our gateways.  Add a new trusted certificate authority to the configuration: <br><br><img src="https://habrastorage.org/storage2/5e1/3f4/7e5/5e13f47e5606f770308feab9797cee8d.png" alt="image"><br><br>  8) If the CRL Distribution Point (in the example, it is a certificate authority server) is behind one of the gateways and the other gateways will connect to it via a VPN connection, these gateways will not be able to load the CRL, because they will not be able to build a VPN because of the impossibility checking the certificate of the first gateway.  Get a vicious circle.  In this case, you must disable the CRL check for this certificate authority.  To do this, uncheck all the checkboxes in the ‚ÄúRetrieve CRL From‚Äù section of the OPSEC PKI tab: <br><br><img src="https://habrastorage.org/storage2/bd7/1f6/6f5/bd71f66f503ccab4897c59bc8dd91c83.png" alt="image"><br><br>  Or you can take the CRL Distribution Point outside the VPN domain of the gateway protecting it so that other gateways will not access it through a VPN connection. <br><br>  9) Upload the certification authority root certificate in DER format and add it to the Check Point configuration: <br><br><img src="https://habrastorage.org/storage2/167/2e8/ef2/1672e8ef2422eef9ba33443885730206.png" alt="image"><br><img src="https://habrastorage.org/storage2/ae2/518/5c7/ae25185c796bdb842e2596bf20721362.png" alt="image"><br><br>  10) After adding a new certification authority, it is necessary to issue certificates for gateways.  The order of issuance and addition of certificates for the cluster and nonclustered gateways is slightly different. <br><br>  In the case of a cluster of gateways, certificates are issued to EVERY member of the cluster.  To issue a certificate, follow these steps: <br><br>  ‚Ä¢ Open the properties of the gateway cluster object; <br><br>  ‚Ä¢ Go to the ‚ÄúCluster Members‚Äù tab; <br><br>  ‚Ä¢ Double-click the cluster member object; <br><br>  ‚Ä¢ In the ‚ÄúCluster Member Properties‚Äù window that opens, go to the ‚ÄúVPN‚Äù tab and click the ‚ÄúAdd‚Äù button in the ‚ÄúCertificates List with keys stored on Security Gateway‚Äù field: <br><br><img src="https://habrastorage.org/storage2/d3f/80c/ab8/d3f80cab802800acd4428f8b1930e245.png" alt="image"><br><br>  ‚Ä¢ Enter the certificate name; <br><br>  ‚Ä¢ In the ‚ÄúCA to enroll from‚Äù field, select the added GOST certification authority and click the Generate button; <br><br>  ‚Ä¢ Fill in the Distinguished Name for the request, for example: <br><br><img src="https://habrastorage.org/storage2/5c5/918/7d9/5c59187d9d37d2155d0a395e33622fce.png" alt="image"><br><br>  ‚Ä¢ A certificate request will be generated, click ‚ÄúCopy to Clipboard‚Äù: <br><br><img src="https://habrastorage.org/storage2/b09/931/d83/b09931d837ef487f7ff1d7e0d81d1c95.png" alt="image"><br><br>  ‚Ä¢ Paste the certificate request in the ‚ÄúSaved Request‚Äù field on the certification authority portal and click issue: <br><br><img src="https://habrastorage.org/storage2/357/9f1/fee/3579f1fee516b0985457e24e0e07b33e.png" alt="image"><br><br>  ‚Ä¢ Save the certificate file in DER format: <br><br><img src="https://habrastorage.org/storage2/789/945/b49/789945b496ccc33392e7457306e94e07.png" alt="image"><br><br>  ‚Ä¢ In the field ‚ÄúCertificates List with keys for Security Gateway‚Äù click the button ‚ÄúComplete‚Äù, in the opened window select the saved certificate file: <br><br><img src="https://habrastorage.org/storage2/cc8/bd0/455/cc8bd045559db633073760c880a644f4.png" alt="image"><br><br>  ‚Ä¢ Accept the certificate: <br><br><img src="https://habrastorage.org/storage2/e92/5dc/aac/e925dcaacfbf4eb4ea8b04b511fbdbda.png" alt="image"><br><br>  ‚Ä¢ Repeat this sequence for each cluster member. <br><br>  In the case of issuing a certificate for a nonclustered gateway, a certificate request is created in the gateway properties window, section ‚ÄúIPSec VPN‚Äù, column ‚ÄúRepository of Certificates Available to the Gateway‚Äù.  Also press the ‚ÄúAdd‚Äù key, only in the case of a nonclustered gateway there will be a choice of where the encryption keys will be stored.  In this case, select the ‚ÄúStore keys on the Module‚Äù column, otherwise the procedure is completely similar to the one described above. <br><br><img src="https://habrastorage.org/storage2/d96/07c/33f/d9607c33f45f5101205d259c38ce168a.png" alt="image"><br><br>  After adding certificates, a nonclustered gateway is ready to build a GOST VPN after policy installation, but in the case of a cluster, this is not all.  CryptoPro encrypts traffic sent between cluster members and between libraries on the gateway using a Site Key or Site Certificate.  In the case of a nonclustered gateway, the certificate that was issued and added to the gateway is used as the Site Certificate.  In the case of a cluster, only the Site Key can be used for these purposes and must be generated and added to the configuration; <br><br>  11) To generate a Site Key, you must perform the following sequence of actions: <br><br>  ‚Ä¢ Open the gateway object properties window, in the ‚ÄúIPSec VPN‚Äù section in the ‚ÄúRepository of Certificates Available to the Gateway‚Äù column, select the certificate issued by the Gateway internal certification authority (Check Point internal_ca) and click the ‚ÄúView‚Äù button; <br><br><img src="https://habrastorage.org/storage2/5b1/d6c/ce7/5b1d6cce7a3c441c9019b7cf4e6b6abd.png" alt="image"><br><br>  ‚Ä¢ In the certificate properties window that opens, you need to find the first line with the SHA-1 certificate hash, you will need it to generate the Site Key; <br><br><img src="https://habrastorage.org/storage2/e09/dd5/fe8/e09dd5fe88dfa113f037fb4c279492fc.png" alt="image"><br><br>  ‚Ä¢ On any gateway with CryptoPro installed from expert mode, the following command must be executed: <br><br><pre> <code class="bash hljs">bash /opt/cprocsp/bin/ia32/cp-genpsk.sh &lt;machine_name&gt; &lt;net_id&gt; &lt;expiry&gt; &lt;Site_ID&gt;</code> </pre><br><br>  where: <br><br><pre> <code class="bash hljs">o &lt;machine_name&gt; -  ; o &lt;net_id&gt; - ,   ,   Net, ,    Net   ,    ,   Site Key   ; o &lt;expiry&gt; -     ,   6; o &lt;Site_ID&gt; -    SHA-1  .</code> </pre><br><br>  Example of command execution and output: <br><br>  [Expert @ FW1-Node-1: 0] # bash /opt/cprocsp/bin/ia32/cp-genpsk.sh FW1-Cluster Net 6 32: 56: 3E: 12: A8: D6: 6C: EF: 47: 23: 30: 7C: 17: 53: ED: 47: 1E: BD: 7F: 7D <br>  genpsk <br>  UTC Wed Jun 26 12:15:53 ‚Äã‚Äã2013 <br><br>  FW1-Cluster.  Net.  Number of stations 1. <br>  Stations: 32563E12A8D66CEF4723307C1753ED471EBD7F7D <br>  Part 0. Valid for (months) 6. <br><br>  FW1-Cluster UTC Wed Jun 26 12:15:53 ‚Äã‚Äã2013 <br>  32563E12A8D66CEF4723307C1753ED471EBD7F7D part 0 valid for (months) 6 <br>  <font color="green">W6426WLHP3C8TM</font> <br>  W6426WLHP3C8TM <br>  W6426WLHP3C8TM <br><br>  genpsk <br>  UTC Wed Jun 26 12:15:53 ‚Äã‚Äã2013 <br><br>  FW1-Cluster.  Net.  Number of stations 1. <br>  Stations: 32563E12A8D66CEF4723307C1753ED471EBD7F7D <br>  Part 1. Valid for (months) 6. <br><br>  FW1-Cluster UTC Wed Jun 26 12:15:53 ‚Äã‚Äã2013 <br>  32563E12A8D66CEF4723307C1753ED471EBD7F7D part 1 valid for (months) 6 <br>  <font color="red">41NKET2QC6B3NW</font> <br>  41NKET2QC6B3NW <br>  41NKET2QC6B3NW <br><br>  ‚Ä¢ The output of the command contains two parts of the generated Site Key, which must be combined and entered into the cluster configuration.  The first part is marked green, the second part is marked red.  You need to combine them as follows: <br><br>  <font color="green">W6426WLHP3C8TM</font> <font color="red">41NKET2QC6B3NW</font> <br><br>  Site Key must be regenerated in the following cases: <br><br>  ‚Ä¢ Site Key has expired; <br>  ‚Ä¢ VPN was turned on and off; <br>  ‚Ä¢ Certificate issued by an internal certification authority (internal_ca) has been updated. <br><br>  ‚Ä¢ After you have a Site Key, you need to make it into the cluster configuration.  Open the properties of the cluster object, the ‚ÄúIPSec VPN‚Äù section, the ‚ÄúVPN Advanced‚Äù column and click the ‚ÄúPre-Shared Secret‚Äù button in the ‚ÄúGOST Standard‚Äù section: <br><br><img src="https://habrastorage.org/storage2/d26/1b3/15d/d261b315d8b71439795c94e33fc961d7.png" alt="image"><br><br>  ‚Ä¢ In the window that opens, enter the Site Key and click OK: <br><br><img src="https://habrastorage.org/storage2/e18/8c9/7f6/e188c97f60cc0747ceaee121d5b78063.png" alt="image"><br><br>  12) Now you can install policies on gateways and check the logs for the fact that the VPN is successfully assembled.  The logs must contain messages on the successful installation of a Site Key or Site Certificate and the initialization of cryptographic libraries and messages of the Encrypt / Decrypt type for traffic transmitted through a VPN connection.  Examples of messages: <br><br><img src="https://habrastorage.org/storage2/556/b63/344/556b6334460e16015cea6708c8c06b0b.png" alt="image"><br><img src="https://habrastorage.org/storage2/f7c/c8a/ff5/f7cc8aff54596082e18f524442f414fd.png" alt="image"><br><img src="https://habrastorage.org/storage2/f76/7b5/7b4/f767b57b450648e546bc7248cad266de.png" alt="image"><br><br>  13) If the policy has been established without errors and these messages are present in the logs, then congratulations, you have successfully managed to configure the VPN using GOST encryption. <br><br><h5>  5.2.  Setting up a VPN using a password </h5><br>  If, by coincidence, you have no desire or ability to bother with certificates, you can configure partner authentication using a passphrase.  It is not recommended to use this option with a large number of gateways due to the complexity of working with a large number of passwords, and since the password must be specified for each pair of gateways, their number can be truly enormous.  So, to configure a GOST VPN using a password, you must perform the following sequence of actions: <br><br>  1) Install a special version of Check Point SmartConsole (file named: SmartConsole_GOST_R75.40VS_EA); <br><br>  2) Login to the management server using this utility; <br><br>  3) Create a new VPN Community: <br><br><img src="https://habrastorage.org/storage2/c13/411/733/c13411733a08485bda06fbb12e380eb4.png" alt="image"><br><br>  4) Put the gateways in the VPN Community being created, between which the VPN connection will be built: <br><br><img src="https://habrastorage.org/storage2/62c/5d6/c95/62c5d6c957ffeec697f1e6019fb1adca.png" alt="image"><br><br>  5) Configure the VPN Community to use GOST encryption: <br><br><img src="https://habrastorage.org/storage2/897/05b/329/89705b32915b5740f8d40b3465517647.png" alt="image"><br><br>  There are 3 options: <br><br>  Set 1 and Set 2 - differing in the used encryption modes, you can use any (supported by all versions for which there is a GOST, except R65.50); <br><br>  Legacy - compatibility mode with GOST on Check Point R65.50, if there is a need to build VPN tunnels with gateways operating on this version of Check Point. <br><br>  6) Set the password for authentication in the VPN Community settings.  This is done in the properties of the VPN Community in the section ‚ÄúAdvanced Settings‚Äù, item ‚ÄúShared Secret‚Äù: <br><br><img src="https://habrastorage.org/storage2/40f/6dd/4fb/40f6dd4fbb4e9f15b15945e580941509.png" alt="image"><br><br>  7) Click the "OK" button, thereby creating a new VPN Community; <br><br>  The VPN Community list will look something like this: <br><br><img src="https://habrastorage.org/storage2/bb8/4c3/003/bb84c3003c29eaf1543a3fd71e973143.png" alt="image"><br><br>  8) Generate a Site Key for EACH gateway, as specified in section 5.1, paragraph 11. In the case of a cluster of gateways, one Site Key is generated per cluster.  If you have an established GOST certificate on a nonclustered gateway, then the Site Key for this gateway can be not generated.  For nonclustered gateways, both the Site Key and Site Certificate can be used.  Site Certificate is preferable and, if there is a certificate, it will be used; <br><br>  9) After generating and installing the Site Key, you need to generate a password for a pair of gateways.  Unlike the ‚Äútraditional‚Äù VPN setting on Check Point, when setting up a GOST VPN, you cannot use an arbitrary password, you need to generate it by analogy with the Site Key.  To generate a password for a pair of gateways, follow these steps: <br><br>  ‚Ä¢ On any gateway with CryptoPro installed from expert mode, the following command must be executed: <br><br><pre> <code class="bash hljs">bash /opt/cprocsp/bin/ia32/cp-genpsk.sh &lt;pair_name&gt; &lt;net_id&gt; &lt;expiry&gt; &lt;GW_1_Site_ID&gt; &lt;GW_2_Site_ID&gt;</code> </pre><br><br>  where: <br><br><pre> <code class="bash hljs">o &lt;pair_name&gt; -   ; o &lt;net_id&gt; -    ,   Net,     Net       ,      ; o &lt;expiry&gt; -     ,   6; o &lt;GW_1_Site_ID&gt; -    SHA-1     ; o &lt;GW_2_Site_ID&gt; -    SHA-1     .</code> </pre><br><br>  There is no fundamental difference in which gateway is first and which second is not; the &lt;pair_name&gt; field can be filled in arbitrarily. <br><br>  Example of command execution and output: <br><br>  Expert @ FW1-Node-1: 0] # bash /opt/cprocsp/bin/ia32/cp-genpsk.sh FW1-FW2 Net 6 32: 56: 3E: 12: A8: D6: 6C: EF: 47: 23 : 30: 7C: 17: 53: ED: 47: 1E: BD: 7F: 7D A6: F0: 24: 9A: 16: AA: 7F: 42: 9A: 3A: A2: 83: 66: FA: 67: E9: 75: 08: 46: 1B <br>  genpsk <br>  UTC Sat Jun 29 11:17:26 2013 <br><br>  FW1-FW2.  Net.  Number of stations 2. <br>  Stations: 32563E12A8D66CEF4723307C1753ED471EBD7F7D A6F0249A16AA7F429A3AA28366FA67E97508461B <br>  Part 0. Valid for (months) 6. <br><br>  FW1-FW2 UTC Sat Jun 29 11:17:26 2013 <br>  32563E12A8D66CEF4723307C1753ED471EBD7F7D part 0 valid for (months) 6 <br>  <font color="green">BC1HGFATY4N6QM</font> <br>  BC1HGFATY4N6QM <br>  BC1HGFATY4N6QM <br><br>  FW1-FW2 UTC Sat Jun 29 11:17:26 2013 <br>  A6F0249A16AA7F429A3AA28366FA67E97508461B part 0 valid for (months) 6 <br>  <font color="red">ZPYLCHU36QNZNM</font> <br>  ZPYLCHU36QNZNM <br>  ZPYLCHU36QNZNM <br><br>  genpsk <br>  UTC Sat Jun 29 11:17:26 2013 <br><br>  FW1-FW2.  Net.  Number of stations 2. <br>  Stations: 32563E12A8D66CEF4723307C1753ED471EBD7F7D A6F0249A16AA7F429A3AA28366FA67E97508461B <br>  Part 1. Valid for (months) 6. <br><br>  FW1-FW2 UTC Sat Jun 29 11:17:26 2013 <br>  32563E12A8D66CEF4723307C1753ED471EBD7F7D part 1 valid for (months) 6 <br>  <font color="blue">WKDHN8MRYD599U</font> <br>  WKDHN8MRYD599U <br>  WKDHN8MRYD599U <br><br>  FW1-FW2 UTC Sat Jun 29 11:17:26 2013 <br>  A6F0249A16AA7F429A3AA28366FA67E97508461B part 1 valid for (months) 6 <br>  <font color="orange">FN4T4X8Z5YRT0U</font> <br>  FN4T4X8Z5YRT0U <br>  FN4T4X8Z5YRT0U <br><br>  ‚Ä¢ The output of the command contains four parts of the generated password that need to be combined and entered into the configuration.  The first part is marked green, the second part is marked red, the third honor is marked blue, the fourth - orange, but they are combined, unlike the Site Key, not in order, and so: part 1 + part 3 + part 2 + part 4, combination example parts: <br><br>  <font color="green">BC1HGFATY4N6QM</font> <font color="blue">WKDHN8MRYD599U</font> <font color="red">ZPYLCHU36QNZNM</font> <font color="orange">FN4T4X8Z5YRT0U</font> <br><br>  The password must be regenerated in the following cases: <br><br>  ‚Ä¢ The password has expired; <br>  ‚Ä¢ VPN was turned on and off; <br>  ‚Ä¢ Certificate issued by an internal certification authority (internal_ca) has been updated. <br><br>  10) After you have a password, it must be entered into the configuration.  Open the gateway properties window, the ‚ÄúIPSec VPN‚Äù section, click the ‚ÄúTraditional mode configuration‚Äù button, select the ‚ÄúPre-Shared Secret‚Äù checkbox: <br><br><img src="https://habrastorage.org/storage2/23d/056/608/23d0566084527cebe54aa396eec0c2ed.png" alt="image"><br><br>  11) Click the Edit Secrets button, enter the generated key for another member of the gateway pair, and click OK: <br><br><img src="https://habrastorage.org/storage2/fd3/116/524/fd31165241e8366c619a80090975cbba.png" alt="image"><br><br>  12) If you have gateways that are managed by other management servers, as in the example, repeat the operation of adding a key to them; <br><br>  13) Now you can install policies on gateways and check the logs for the fact that the VPN is successfully assembled.  The logs must contain messages on the successful installation of a Site Key or Site Certificate and the initialization of cryptographic libraries and messages of the Encrypt / Decrypt type for traffic transmitted through a VPN connection. <br><br> 14)           ,   ,     VPN    . <br><br><h4> <b>PS      ?</b> </h4><br>  ¬´     ?¬ª      .  ¬´ -2005¬ª             ,       . ,   ¬´                     ¬ª,    5             .   , ,           .   ,  ,       ,   ,       , ,      -2005      . </div><p>Source: <a href="https://habr.com/ru/post/185930/">https://habr.com/ru/post/185930/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../185916/index.html">Instruments for treason</a></li>
<li><a href="../185920/index.html">‚ÄúChaos Engine - I‚Äôll be back for some and didn‚Äôt wait‚Äù - the original position of the developers regarding the remake of the game</a></li>
<li><a href="../185922/index.html">Distribution of paid applications in honor of the unofficial 5th anniversary of the App Store</a></li>
<li><a href="../185926/index.html">Automatic scaling of websites, cloud services and virtual machines</a></li>
<li><a href="../185928/index.html">‚ÄúCross-Platform mobile development technology‚Äù meeting in Kiev Ciklum on July 19</a></li>
<li><a href="../185932/index.html">Find similar projects on github</a></li>
<li><a href="../185936/index.html">The first high-level programming language for quantum computers</a></li>
<li><a href="../185938/index.html">Tablet for the elderly. Part one</a></li>
<li><a href="../185940/index.html">Modification of stock firmware for Android. Part 3</a></li>
<li><a href="../185942/index.html">Highscreen Omega Prime XL - Russia's first chameleon smartphone</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>