<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>First impressions of the development under Android - we write handsfree</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most recently I got an androphone (LG Optimus) and decided to try my hand at writing software for it. Having read about the platform device, at first ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>First impressions of the development under Android - we write handsfree</h1><div class="post__text post__text-html js-mediator-article">  Most recently I got an androphone (LG Optimus) and decided to try my hand at writing software for it.  Having read about the platform device, at first I was very happy for its simplicity, convenience and consistency.  But in practice, everything turned out to be not so rosy ... <br><br>  As a sample, the pen took up an application that would automatically answer incoming calls when the headset is connected.  It is strange, of course, that such a simple function is not in the out-of-box system.  And in the market there was only one application that could do it, and not very reliable.  Let's try to correct this misunderstanding. <br><br>  At first glance, the application should be very simple: <br><ol><li>  In the manifest, we hang the receiver on messages about changing the status of the line ( <i>TelephonyManager.ACTION_PHONE_STATE_CHANGED</i> ) and monitor incoming calls. </li><li>  When a call arrives, we check if the headset is connected.  First of all, I was interested in bluetooth, but it would also be good to track a wired headset. </li><li>  If the headset is connected, we tell the phone to answer the call. </li></ol><br>  With the first paragraph there were no special problems.  But the other two were not so trivial. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Answer call </h4><br>  I'll start with the third item.  In Android, there is no API for answering an incoming call.  If in versions 1.x it was still possible to reach some undocumented classes and methods that allowed this, then in my 2.2 all these holes were securely closed.  Pretty googling found the same way: to portray the press of a button on a headset ( <i>Intent.ACTION_MEDIA_BUTTON</i> , <i>KeyEvent.KEYCODE_HEADSETHOOK</i> ).  True, there are some subtleties.  This event must be sent via <i>sendOrderedBroadcast</i> (not <i>sendBroadcast</i> ).  Otherwise, it will get to all the receivers, and among them there may be, for example, an audio player, which will start up cheerfully if it finds something to play.  Interestingly, the player runs in the emulator even when using ordered broadcast, although everything works as it should on the phone.  Another difference between the emulator and the hardware: in the first one, it‚Äôs enough to send a message about the release of the button (by the way, the player starts only by the press message).  In the phone, it is necessary to generate both pressing and releasing.  They say that in 1.x it was possible to get to the function injectKeyEvent (or some similar one) and that would be more correct.  But in 2.2, the protection of this function was repaired and it is not available. <br><br><h4>  Headset Status </h4><br>  Now the most difficult thing is point 2. Check if the headset is connected.  The problem is the same - in Android there is no ready-made API to find out.  And what's even more interesting, the actions for wired and wireless headsets will be noticeably different. <br><br>  In principle, for both headsets, you can track the connection / disconnection messages, which is where I started.  For wired, this is <i>Intent.ACTION_HEADSET_PLUG</i> (the headset status is transmitted as an extra parameter), for wireless - a pair of <i>BluetoothDevice.ACTION_ACL_CONNECTED</i> and <i>BluetoothDevice.ACTION_ACL_DISCONNECTED</i> messages. <br><br>  The first thing you want to do is to register the receivers of these messages right in the manifest so that you do not miss anything.  With a wireless headset, this number passes, but <i>for</i> some reason <i>ACTION_HEADSET_PLUG</i> is sent with the <i>FLAG_RECEIVER_Riced_ONLY</i> flag, that is, receivers do not receive it from the manifest (the documentation says nothing about it, so it‚Äôs very similar to an error).  It is necessary to register them in the code.  This means that you have to start a service that will programmatically register the desired receiver and will remain running all the time.  Here, however, there is also a rake: such a service can be killed by the system at any time (which is what happened in my testing process), as a result of which we can skip some messages.  Apparently, a similar approach was used in the only application from the market, which I mentioned at the beginning of the article - it was not always the right time to determine the connection of the headset.  I had to run it by hand. <br><br>  An exit was found.  It comes to the aid of the fact that the message <i>ACTION_HEADSET_PLUG</i> is sticky.  That is, the latest state of the headset is reported to all newly registered listeners.  It turns out that the state of the wireless headset can be checked at any time by calling the <i>registerReceiver (null, headsetPlugFilter)</i> and checking the returned Intent.  This makes me happy.  Service is not needed, point 2 for a wired headset is implemented. <br><br>  Go to the wireless headset.  There will definitely have to track the connection / disconnection messages - the current state of the headset at any time can not be checked.  But you can use the manifest for registering the receiver.  Another inconvenience is that the current state should be stored somewhere, and the usual variable cannot be used for this, since no code is executed between calls.  I chose for this purpose a hidden parameter in the application settings.  Hidden in the sense that it is not displayed in the settings window (I will not view this window - everything is simple there). <br><br><h4>  Call waiting </h4><br>  I almost forgot about another important point.  If a person is already on the phone, then most likely he does not need new incoming calls to be answered automatically.  I made for this a separate option in the settings.  Accordingly, before answering, we must check whether we had an active conversation at the time of the call.  Again, the API does not provide any means for this.  All that is available is a working receiver for calls.  We can track the change in the status of the phone in offhook or idle.  But using this application to store this state (as for the state of a wireless headset) can be quite expensive.  Therefore, again, we need a working service that will store the state of offhook in memory.  And in order to reduce the probability of a system killing a service at the wrong time, you can temporarily run it through startForeground.  When calls are completed, the service can be suspended by calling stopForeground. <br><br><h4>  Impressions </h4><br>  As a result, the plans were implemented, although for this we had to write more code than planned, and the result does not look very neat.  Honestly, I still don‚Äôt understand why the API doesn‚Äôt have any ready-made functions like <i>isHeadsetConnected</i> and <i>answerCall</i> that would greatly simplify life. <br><br>  By the way, in my original plan there was another option to announce the caller using <i>TextToSpeech</i> .  But it turned out that it is impossible to redirect the sound from the TTS to the wireless headset at the time of the call (if someone knows a way, share it), and there is no special meaning in talking to the phone in your pocket.  I did not bother - I just threw out this function entirely.  Although, of course, a little pity. <br><br>  In general, the convenience of the platform has so far proved only a theory.  In practice, you constantly stand against strange and illogical restrictions, and it is not always possible to bypass them.  But the idea is good.  Let's see what will happen next.  I hope that they will bring the API to the mind and use it will be really nice. </div><p>Source: <a href="https://habr.com/ru/post/112295/">https://habr.com/ru/post/112295/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../112289/index.html">Digital signatures in executable files and circumvention of this protection in malware</a></li>
<li><a href="../112290/index.html">NetUP CAS and Middleware certified by the Ministry of Communications of the Russian Federation</a></li>
<li><a href="../112291/index.html">jQuery plugin for Ajax video upload on YouTube</a></li>
<li><a href="../112292/index.html">Evolution of the Python programmer</a></li>
<li><a href="../112294/index.html">Experience of implementing 1C UAT at a distribution center</a></li>
<li><a href="../112297/index.html">The Chinese have created a virus that blocks the connection of client PCs with cloud antivirus software.</a></li>
<li><a href="../112298/index.html">About weird icons HTML5</a></li>
<li><a href="../112300/index.html">Natural randomness</a></li>
<li><a href="../112302/index.html">More evidence that Android contains copied Java code.</a></li>
<li><a href="../112304/index.html">Tesla Motors develops new versions of electric vehicles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>