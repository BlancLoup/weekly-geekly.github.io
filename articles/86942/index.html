<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Leak hunt</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this post, I described my experience in dealing with one particular leak in a large project. Many mistakes were made, but it may be useful to someo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Leak hunt</h1><div class="post__text post__text-html js-mediator-article">  <i>In this post, I described my experience in dealing with one particular leak in a large project.</i>  <i>Many mistakes were made, but it may be useful to someone.</i> <br><br>  For a long time I did not encounter memory leaks, but the other day our plus demon began to flow.  At what valgrind.memcheck does not show anything intelligible - the server starts for a long time, it does not give a big load - watchdog, which checks for server hangs under such a load under valgrind - quickly nailed the server. <br>  It flows strongly - 7 gigs in 3 days.  Although earlier in the operating mode, more than 1 gig did not require (it was launched even for 2 weeks without restarting). <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It was thought that either cyclic references or data from some kind of container are not deleted. <br>  Well, I decided to use the good old google perf tools to take a snapshot of the memory at the time of work.  Hm  Under ubuntu amd64 for some reason only the old version.  And it hangs when the application is unpaired (although google perf tools is specifically made for multi-threaded applications). <br>  In the debager you can see that all the threads are hanging on the backs. <br><br>  I decided to upgrade to the latest version - but I did not want to compile the version from the site.  I found packages on packages.debian.org - and surprisingly everything was installed without problems. <br>  But when entering the multi-threaded daemon, it is again hanging. <br>  Yes, and the demon itself is loaded under 15-20 minutes - since it took the base from the production, and there is a lot of data. <br><br>  I looked for some good debugging allocators - the one I needed (google perf tools - heap peofiler, which wouldn't hang) did not exist. <br>  Well, maybe there are some keys in valgrind.memcheck to dump the memory state not at the end of the program, but in the middle?  Not.  But ... There are valgrind.massif - which is what it does.  Hooray! <br><br>  Ruthlessly clearing the database of data (so that at least the load tests could work, and they require a real game and at least some valid data), I started picking valgrind.massif. <br>  I started it and drove the load tests - everything works, nothing flows.  Very interesting. <br>  In general, the tulza did not give me any answer - probably the synthetic load did not provoke an error involving a memory leak.  It is necessary to include mosk;) <br>  Unfortunately, since the last stable pouring, a lot of code has changed, and I was to blame: I did refactoring, affecting almost half of the whole code;) <br><br>  I thought of memory and see what was there, but I did not want to understand the 7 gig file.  And here - a crazy idea came - to analyze statistics on demons (for the benefit of the current demons, we have 3 in the cluster) that I could collect from both the OS and the internal monitoring of demons. <br><br>  Quite by chance I saw the proportion between the amount of leaked memory and the number of executed commands of the same type.  The team was old, but I remembered that in this pouring we began to use it much more actively.  I checked the proportion on the calculator (python in the shell;) - everything is the same.  This is eating memory. <br><br>  The problem is that a similar team was used only in billing, there was no load test for it.  And recently they made a similar command that uses similar features as the first command, but it is executed many times more.  It is used exclusively in social networks and has not been added to the load test either.  This is such a bad situation. <br><br>  Having added this command to the load test - in 10 seconds I consumed 50% of the memory of my laptop.  And then the matter of technology - I didn‚Äôt even use massif - I read the code - I found a place where a cyclic link might not be created - I changed the policy from Strong to Weak - I crashed it - I ran the test - hurray, the scouts died. <br><br>  Well, what conclusions did I draw from the dead day for debug?  Actually here: <br><ol><li>  It is necessary to drive tests for memory leaks more often. </li><li>  Even if the leak is small - in the future the code may start to be used more actively - then a small leak will turn into a severe headache. </li><li>  It is necessary to have a representative database of functional similar production, but with a smaller amount of data.  Without this, debugging under the memory debugger will be almost impossible. </li><li>  I made sure once again - the absence of bare pointers does not guarantee the absence of leaks (this applies to both java and c #, as well as using smart pointers in C ++) </li><li>  When nothing helps, chance can solve everything. </li><li>  Accidents are not accidental ¬© =) - without looking for some regularities in statistics, I would not find them, although I did not hope to find something </li></ol></div><p>Source: <a href="https://habr.com/ru/post/86942/">https://habr.com/ru/post/86942/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../86936/index.html">How to create an application on iPhone without Mac OS X and SDK?</a></li>
<li><a href="../86938/index.html">ActiveModel: let any Ruby object feel like ActiveRecord</a></li>
<li><a href="../86939/index.html">About hackers, cadabra and TM</a></li>
<li><a href="../86940/index.html">Last.fm Scrobbling</a></li>
<li><a href="../86941/index.html">Three mobile games that turned my ideas about mobile games in general</a></li>
<li><a href="../86944/index.html">SuperTux 0.3.3 released</a></li>
<li><a href="../86945/index.html">Proxeterium. Chapter 1. Part 3: School</a></li>
<li><a href="../86946/index.html">Fully mobile video studio</a></li>
<li><a href="../86947/index.html">Working day schedule</a></li>
<li><a href="../86948/index.html">How we use Yandex Direct</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>