<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>RSA encryption through the OpenSSL library in Delphi</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On duty, the developers met the task of encrypting text strings with the RSA algorithm using public and private keys in PEM format. When studying this...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>RSA encryption through the OpenSSL library in Delphi</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/63e/38c/dc5/63e38cdc545c4eb0995687d2c7c63a0a.PNG"><br><br>  On duty, the developers met the task of encrypting text strings with the RSA algorithm using public and private keys in PEM format.  When studying this issue, the choice fell on the use of the OpenSSL library.  I want to share examples of the implementation of encryption functionality in Delphi.  Actions were performed in Windows, Borland Delphi 7 development environment. <br><a name="habracut"></a><br><h4>  Where to begin? </h4><br>  First of all, the openssl package is needed, or rather the libeay32.dll library.  And to connect the library, we need a ready-made unit of <a href="">libeay32.pas</a> , which needs to be connected to the project.  In my example, there is no functionality for generating keys from a project, how to do this can be read in the material at the link below the article.  To generate a key pair, I used openssl myself with the following commands from cmd: <br>  <i>We generate a private key and retrieve it from it with a public key.</i> <br><pre><code class="bash hljs">openssl genrsa 1024 &gt; private.pem openssl rsa -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> private.pem -pubout &gt; public.pem</code> </pre> <br>  Where 1024 is the key bit.  I note that the length of the string for encryption also depends on the bit depth of the key.  If the key is 1024 bits, then we can encrypt a total of 128 bytes, the same size that is equal to the size of the key.  Below I show the function that determines the size of the RSA key structure.  But that's not all.  This buffer will decrease by 11 bytes if during encryption you specify the <b>padding</b> parameter responsible for data alignment - <b>PKCS # 1</b> . <br><br>  Having generated the key in 2048 bits, we can encrypt 256 bytes.  This increases the size of the output encrypted text, even if only 1 byte is encrypted. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For my task, 117 bytes were enough to fit the card data, the size of the rows in the database, of course, increased significantly.  But that requires security. <br><br><h4>  Main functions </h4><br>  The main thing that we will use for encryption is: <br><br><h6>  Initialization of crypto functions </h6><br><pre> <code class="delphi hljs">OpenSSL_add_all_algorithms; OpenSSL_add_all_ciphers; OpenSSL_add_all_digests; ERR_load_crypto_strings; ERR_load_RSA_strings;</code> </pre><br>  Destroy <br><br><pre> <code class="delphi hljs">EVP_cleanup; ERR_free_strings;</code> </pre><br><h6>  Key reading </h6><br><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">//     PEM,   RSA // bp  ,   RSA   x, cb ‚Äì      . function PEM_read_bio_PrivateKey(bp: pBIO; var x: pEVP_PKEY; cb: TPWCallbackFunction; u: pointer): pEVP_PKEY; cdecl; //     PEM,   RSA function PEM_read_bio_PUBKEY(bp: pBIO; var x: pEVP_PKEY; cb: TPWCallbackFunction; u: pointer): pEVP_PKEY; cdecl;</span></span></code> </pre><br><h6>  And encryption / decryption functions </h6><br><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">/// flen   from   _to   RSA       // padding.   /   -1   //   function RSA_public_encrypt(flen: integer; from: PCharacter; _to: PCharacter; rsa: pRSA; padding: integer): integer; cdecl; //   function RSA_private_encrypt(flen: integer; from: PCharacter; _to: PCharacter; rsa: pRSA; padding: integer): integer; cdecl; //   function RSA_public_decrypt(flen: integer; from: PCharacter; _to: PCharacter; rsa: pRSA; padding: integer): integer; cdecl; //   function RSA_private_decrypt(flen: integer; from: PCharacter; _to: PCharacter; rsa: pRSA; padding: integer): integer; cdecl;</span></span></code> </pre><br><h4>  Let's start the implementation </h4><br>  So, we have the generated keys, the dll is in the project folder, liblea32.pas is connected in uses.  Call openssl initialization procedures: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadSSL</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> OpenSSL_add_all_algorithms; OpenSSL_add_all_ciphers; OpenSSL_add_all_digests; ERR_load_crypto_strings; ERR_load_RSA_strings; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FreeSSL</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> EVP_cleanup; ERR_free_strings; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><h5>  We write functions of loading of keys. </h5><br>  KeyFile - up to the key ('C: \ key.pem'): <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadPublicKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(KeyFile: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> :</span></span>pEVP_PKEY ; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mem: pBIO; k: pEVP_PKEY; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> k:=<span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>; mem := BIO_new(BIO_s_file()); <span class="hljs-comment"><span class="hljs-comment">//BIO   BIO_read_filename(mem, PAnsiChar(KeyFile)); //     BIO try result := PEM_read_bio_PUBKEY(mem, k, nil, nil); // BIO   pEVP_PKEY,    nil,        finally BIO_free_all(mem); end; end; function LoadPrivateKey(KeyFile: string) :pEVP_PKEY; var mem: pBIO; k: pEVP_PKEY; begin k := nil; mem := BIO_new(BIO_s_file()); BIO_read_filename(mem, PAnsiChar(KeyFile)); try result := PEM_read_bio_PrivateKey(mem, k, nil, nil); finally BIO_free_all(mem); end; end;</span></span></code> </pre><br><h6>  Calling key reading and error handling </h6><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> FPublicKey: pEVP_PKEY; FPrivateKey: pEVP_PKEY; err: Cardinal; ‚Ä¶ FPublicKey := LoadPublicKey(<span class="hljs-string"><span class="hljs-string">'C:\public.key'</span></span>); FPrivateKey := LoadPrivateKey(<span class="hljs-string"><span class="hljs-string">'C:\private.key'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//if FPrivateKey = nil then //    ,    if FPublicKey = nil then begin err := ERR_get_error; repeat log.Lines.Add(string(ERR_error_string(err, nil))); err := ERR_get_error; until err = 0; end;</span></span></code> </pre><br><h5>  Encryption (Public Key) </h5><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rsa: pRSA; <span class="hljs-comment"><span class="hljs-comment">//  RSA size: Integer; FCryptedBuffer: pointer; //   b64, mem: pBIO; str, data: AnsiString; len, b64len: Integer; penc64: PAnsiChar; size: Integer; err: Cardinal begin rsa := EVP_PKEY_get1_RSA(FPrivateKey); //  RSA  EVP_PKEY_free(FPrivateKey); //  pEVP_PKEY size := RSA_size(rsa); //    GetMem(FCryptedBuffer, size); //     str := AnsiString('Some text to encrypt'); //    // len := RSA_public_encrypt(Length(str), //     PAnsiChar(str), //   FCryptedBuffer, //   rsa, //   RSA_PKCS1_PADDING //   ); if len &gt; 0 then //     begin //       base64 b64 := BIO_new(BIO_f_base64); // BIO  base64 mem := BIO_push(b64, BIO_new(BIO_s_mem)); // Stream try BIO_write(mem, FCryptedBuffer, len); //   Stream    BIO_flush(mem); b64len := BIO_get_mem_data(mem, penc64); //    base64 SetLength(data, b64len); //     Move(penc64^, PAnsiChar(data)^, b64len); //    data   base64 finally BIO_free_all(mem); end; end else begin //  ,     -1 err := ERR_get_error; repeat log.Lines.Add(string(ERR_error_string(err, nil))); err := ERR_get_error; until err = 0; end; RSA_free(rsa); end;</span></span></code> </pre><br><h5>  Decryption (secret key) </h5><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rsa: pRSA; out_: AnsiString; str, data: PAnsiChar; len, b64len: Integer; penc64: PAnsiChar; b64, mem, bio_out, bio: pBIO; size: Integer; err: Cardinal; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-comment"><span class="hljs-comment">//ACryptedData : string; //   base64 rsa := EVP_PKEY_get1_RSA(FPublicKey); size := RSA_size(rsa); GetMem(data, size); //       GetMem(str, size); //        base64 //Decode base64 b64 := BIO_new(BIO_f_base64); mem := BIO_new_mem_buf(PAnsiChar(ACryptedData), Length(ACryptedData)); BIO_flush(mem); mem := BIO_push(b64, mem); BIO_read(mem, str , Length(ACryptedData)); //       BIO_free_all(mem); //  len := RSA_private_decrypt(size, PAnsiChar(str), data, rsa, RSA_PKCS1_PADDING); if len &gt; 0 then begin //   data    ¬´¬ª  , ,    out_         data SetLength(out_, len); Move(data^, PAnsiChar(out_ )^, len); end else begin //  ,     -1 err := ERR_get_error; repeat log.Lines.Add(string(ERR_error_string(err, nil))); err := ERR_get_error; until err = 0; end; end;</span></span></code> </pre><br><h5>  And the conclusion is an example of reading the key "wired" in the application </h5><br>  In the example, the private key and its reading are specified, it is ‚Äúsewn up‚Äù with the same success and the public key is read by the function <b>PEM_read_bio_PUBKEY</b> <br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mem, keybio: pBIO; k: pEVP_PKEY; keystring: AnsiString; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> keystring := <span class="hljs-string"><span class="hljs-string">'-----BEGIN RSA PRIVATE KEY-----'</span></span> + <span class="hljs-string"><span class="hljs-string">#10</span></span> + <span class="hljs-string"><span class="hljs-string">'MIICXgIBAAKBgQCfydli2u2kJfb2WetkOekjzQIg7bIuU7AzAlBUPuA72UYXWnQ/'</span></span> + <span class="hljs-string"><span class="hljs-string">#10</span></span> + <span class="hljs-string"><span class="hljs-string">'XcdSzEEMWSBLP7FO1vyVXR4Eb0/WqthF0ZViOK5bCN9CnR/1GMMiSqmIdByv/gUe'</span></span> + <span class="hljs-string"><span class="hljs-string">#10</span></span> + <span class="hljs-string"><span class="hljs-string">'Z/UjGrKmxeQOoa2Yt0MJC64cNXgnKmYC7ui3A12LlvNdBBEF3WpcDbv+PQIDAQAB'</span></span> + <span class="hljs-string"><span class="hljs-string">#10</span></span> + <span class="hljs-string"><span class="hljs-string">'AoGBAJnxukKHchSHjxthHmv9byRSyw42c0g20LcUL5g6y4Zdmi29s+moy/R1XOYs'</span></span> + <span class="hljs-string"><span class="hljs-string">#10</span></span> + <span class="hljs-string"><span class="hljs-string">'p/RXdNfkQI0WnWjgZScIij0Z4rSs39uh7eQ5qxK+NH3QIWeR2ZNIno9jAXPn2bkQ'</span></span> + <span class="hljs-string"><span class="hljs-string">#10</span></span> + <span class="hljs-string"><span class="hljs-string">'odS8FPzbZM9wHhpRvKW4FNPXqTc3ZkTcxi4zOwOdlECf9G+BAkEAzsJHgW1Isyac'</span></span> + <span class="hljs-string"><span class="hljs-string">#10</span></span> + <span class="hljs-string"><span class="hljs-string">'I61MDu2qjMUwOdOBYS8GwEBfi/vbn/duwZIBXG/BZ7Pn+cBwImfksEXwx0MTkgF3'</span></span> + <span class="hljs-string"><span class="hljs-string">#10</span></span> + <span class="hljs-string"><span class="hljs-string">'gyaChUSu+QJBAMXX3d94TwcF7lG9zkzc+AR/Onl4Z5UAb1GmUV57oYIFVgW1RIOk'</span></span> + <span class="hljs-string"><span class="hljs-string">#10</span></span> + <span class="hljs-string"><span class="hljs-string">'vqynXWrTjTOg9C9j+VEpBG67LcnkwU16JmUCQH7pukKz9kAhnw43PcycDmhCUgvs'</span></span> + <span class="hljs-string"><span class="hljs-string">#10</span></span> + <span class="hljs-string"><span class="hljs-string">'zCn/V8GCwiOHAZT7qLyhBrzazHj/cZFYknxMEZAyHk3x2n1w8Q9MACoVsuECQQDF'</span></span> + <span class="hljs-string"><span class="hljs-string">#10</span></span> + <span class="hljs-string"><span class="hljs-string">'U7cyara31IyM7vlS5JpjMdrKyPLXRKXDFFXYHQtLubLA4rlBbBHZ9txP7kzJj+G9'</span></span> + <span class="hljs-string"><span class="hljs-string">#10</span></span> + <span class="hljs-string"><span class="hljs-string">'WsOS1YxcPUlAM28xrYGZAkEArVKJHX4dF8UUtfvyv78muXJZNXTwmaaFy02xjtR5'</span></span> + <span class="hljs-string"><span class="hljs-string">#10</span></span> + <span class="hljs-string"><span class="hljs-string">'uXWT1QjVN2a6jv6AW7ukXiSoE/spgfvdoriMk2JSs88nUw=='</span></span> + <span class="hljs-string"><span class="hljs-string">#10</span></span> + <span class="hljs-string"><span class="hljs-string">'-----END RSA PRIVATE KEY-----'</span></span> ; k := <span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>; keybio := BIO_new_mem_buf(Pchar(keystring), -<span class="hljs-number"><span class="hljs-number">1</span></span>); mem := BIO_new(BIO_s_mem()); BIO_read(mem, PAnsiChar(keystring), length(PAnsiChar(keystring))); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> result := PEM_read_bio_PrivateKey(keybio, k, <span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> BIO_free_all(mem); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br>  This is where my implementation examples end.  Project sources are available on <a href="https://github.com/ddlencemc/RSA-via-OpenSSL-libeay32">Github</a> . <br><br><h5>  Sources: </h5><br><ul><li>  Article by Vladimir Meshkov <a href="https://www.opennet.ru/docs/RUS/use_openssl/">"We use the OpenSSL library tools for cryptographic data protection"</a> </li><li>  <a href="http://www.disi.unige.it/person/FerranteM/delphiopenssl/RSAEncrypt.html">File Encryption Example</a> </li><li>  <a href="http://www.disi.unige.it/person/FerranteM/delphiopenssl/AskPassphrase.html">An example of reading the key with a password request from the author libeay32.pas</a> </li><li>  <a href="http://www.disi.unige.it/person/FerranteM/delphiopenssl/">Creating a pair of keys, checking the fingerprint SHA1 and something else</a> </li></ul><br><br>  <b>UPD</b> <br>  From the discussions in the comments I will make additions: if we encrypt the string we need with a <b>public</b> key, then it is decrypted only with a <b>secret</b> key and vice versa - if it is secret, then it can be decrypted only with a public key.  In my case, the client has a public key with which he encrypts the data and only on the server can they be decrypted with a private key. </div><p>Source: <a href="https://habr.com/ru/post/280302/">https://habr.com/ru/post/280302/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280292/index.html">Linux for beginners or what can a girl teach?</a></li>
<li><a href="../280294/index.html">Not IoT, but raspberry! We build the IoT-project on Raspberry Pi with Windows 10 and DeviceHive</a></li>
<li><a href="../280296/index.html">How to clean up the mailbox using a neural network. Part 2</a></li>
<li><a href="../280298/index.html">Pitfalls .load () and .get ()</a></li>
<li><a href="../280300/index.html">Beeline Data School: Spring, Knowledge, New Course</a></li>
<li><a href="../280304/index.html">Implement a try macro for gcc under win32</a></li>
<li><a href="../280306/index.html">Learn to command</a></li>
<li><a href="../280308/index.html">Hackathon Angelhack 2016: a week later in the first of 4 cities</a></li>
<li><a href="../280310/index.html">Simple Yii2 application to send mail</a></li>
<li><a href="../280312/index.html">On the value of cards in the game "Drunkard"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>