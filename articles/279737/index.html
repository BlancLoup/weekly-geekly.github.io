<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Replacing jitter exceptions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I bring to your attention a translation of the article " Replace Throw With Notification " by Martin Fowler. Examples are adapted for .NET. 

 If we v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Replacing jitter exceptions</h1><div class="post__text post__text-html js-mediator-article">  <i>I bring to your attention a translation of the article " <a href="http://martinfowler.com/articles/replaceThrowWithNotification.html">Replace Throw With Notification</a> " by Martin Fowler.</i>  <i>Examples are adapted for .NET.</i> <br><br>  If we validate the data, we usually should not use exceptions to report validation errors.  Here I will describe how to refactor such a code using the ‚ÄúNotification‚Äù pattern. <br><br><img src="https://habrastorage.org/files/4b8/ca6/efd/4b8ca6efdcc848d3892d9c096a9bd3e8.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Recently I looked at the code that did the basic validation of incoming JSON messages.  It looked like this ... <br><a name="habracut"></a><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> heck() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Date == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"  "</span></span>); DateTime parsedDate; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { parsedDate = DateTime.Parse(Date); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (FormatException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"    "</span></span>, e); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parsedDate &lt; DateTime.Now) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"     "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NumberOfSeats == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"   "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NumberOfSeats &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"     "</span></span>); }</code> </pre> <br>  This is a general approach to the implementation of validation.  A series of checks is started for some data (in the example above, two parameters are validated).  If any check fails, an exception is thrown with an error message. <br><br>  This approach has several drawbacks.  First, we should not use exceptions in this way.  Exceptions signal that something has gone beyond the boundaries of the expected behavior code.  But if we do checks on input parameters, it is because we expect an error message, and if the error is the expected behavior, then we should not use exceptions. <br><blockquote>  If the error is the expected behavior, then we should not use exceptions. <br></blockquote><br>  The second problem with this code is that it crashes with the first error found, but it is usually better to report all errors with the input data, not only with the first one.  In this case, the client can choose to show all errors to the user so that he can correct them in one go.  This is better than giving the user the impression that he is playing a sea battle with a computer. <br><br>  Preferably, in the cases above, use the ‚ÄúNotification‚Äù pattern.  A notification is an object that collects errors.  Each validation error adds an error to the notification.  The validation object returns a notification that we can integrate to get the information.  A simple example of use is as follows. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValidateNumberOfSeats</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Notification note</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (numberOfSeats &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) note.addError(<span class="hljs-string"><span class="hljs-string">"     "</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  ,    }</span></span></code> </pre><br>  Then we can simply call the Notification.hasErrors () method to respond to errors.  Other Notification methods can provide more error details. <br><br>  <s>if (numberOfSeats &lt;1) throw new ArgumentException ("The number of places must be a positive number");</s> <s><br></s> <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (numberOfSeats &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) note.addError(<span class="hljs-string"><span class="hljs-string">"     "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> note;</code> </pre><br><br><h2>  When to use this refactoring </h2><br>  I should note that I do not advocate avoiding the use of exceptions in your code.  Exceptions are a very useful technique for handling an unexpected situation and separating it from the main flow of logic.  This refactoring makes sense when the output signal as an exception is not an exceptional situation, and therefore must be processed by the main logic of the program.  The code above is a common example of such a situation. <br><br>  A good rule for using exceptions is found in the Pragmatic Programmers book: <br><br><blockquote>  We believe that exceptions should rarely be used as part of the normal flow of the program: exceptions should be reserved for unexpected situations.  Imagine that an unhandled exception completes your program and ask yourself: ‚ÄúWill this code still work if I remove all exception handlers?‚Äù If the answer is ‚Äúno,‚Äù then perhaps exceptions were used as part of the normal program flow. <br><br>  - Dave Thomas and Andy Hunt <br></blockquote><br>  An important conclusion to be drawn from this is that the decision whether to apply exceptions for a specific task depends on the context.  Reading a file that does not exist may or may not be an exceptional situation.  If we are trying to read a file in a well-known path, for example, / etc / hosts in Unix, then we can assume that the file should be here, so throwing an exception makes sense.  On the other hand, if we read the file along the path passed by the user via the command line, then we should expect that there is probably no file here and use a different mechanism for interacting with a non-exclusive error in nature. <br><br>  There are cases where the use of exceptions for validation errors may be appropriate.  These are situations where there is data that has already been validated during processing, but we want to run the validation again to secure <br>  yourself from a program error that allows invalid data to slip through. <br><br>  This article is about replacing exceptions with notifications in the context of validating raw input.  You can also find this technique useful in other situations where notifications are a better choice than throwing an exception, but focus on the validation case, since it is most often found. <br><br><h2>  Starting point </h2><br>  So far we have not mentioned the business logic, since it was important to concentrate on the general form of the code.  But for further discussion, we need to get some information about business logic.  In this case, some code receives JSON messages with reserved seats in the theater.  The code is in the BookingRequest class, derived from JSON using the JSON.NET library. <br><br><pre> <code class="cs hljs"> JsonConvert.DeserializeObject&lt;BookingRequest&gt;(json);</code> </pre><br>  The BookingRequest class contains only two elements that we validate here: the date of the performance and how many seats were requested. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">BookingRequest</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? NumberOfSeats { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Date { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  Validation has already been shown above. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> heck() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Date == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"  "</span></span>); DateTime parsedDate; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { parsedDate = DateTime.Parse(Date); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (FormatException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"    "</span></span>, e); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parsedDate &lt; DateTime.Now) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"     "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NumberOfSeats == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"   "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NumberOfSeats &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"     "</span></span>); }</code> </pre><br><h2>  Create notification </h2><br>  To use notifications, we need to create a Notification object.  Notification can be quite simple, sometimes just a List. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> notification = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NumberOfSeats &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) notification.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">"      5"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   // ‚Ä¶ if (notification.Any()) //  </span></span></code> </pre><br>  Although the implementation above also allows the use of a pattern, it is preferable to do a little more, creating a simple class instead. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Notification</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;String&gt; errors = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddError</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> message</span></span></span><span class="hljs-function">)</span></span> { errors.Add(message); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> HasErrors { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> errors.Any(); } } }</code> </pre><br>  Using a special class we make our intentions more obvious - the reader does not need to create a mental map between ideas and its implementation. <br><br><h2>  We divide method Check </h2><br>  Our first step will be to divide the Check method into two parts, the internal part will deal only with notifications and not throw exceptions, and the external part will keep the current behavior of the Check method, which throws exceptions, if any error is detected. <br><br>  Using the method "selection method", we put the body of the function Check into the function Validation. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> heck() { Validation(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Validation</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Date == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"  "</span></span>); DateTime parsedDate; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { parsedDate = DateTime.Parse(Date); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (FormatException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"    "</span></span>, e); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parsedDate &lt; DateTime.Now) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"     "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NumberOfSeats == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"   "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NumberOfSeats &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"     "</span></span>); }</code> </pre><br>  Then we extend the Validation method with creating Notification and returning it from the function. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Notification </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Validation</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> notification = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Notification(); <span class="hljs-comment"><span class="hljs-comment">//... return notification; }</span></span></code> </pre><br>  Now I can check Notification and throw an exception if it contains errors. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> heck() { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> notification = Validation(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (notification.HasErrors) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(notification.ErrorMessage); }</code> </pre><br>  We have made the Validation method open, as it is expected that most users in the future will prefer to use this method rather than Check. <br><br>  By the current moment, we have not changed the behavior of the code at all, all the validation checks that have fallen will continue to throw exceptions, but we have created a base to begin replacing the emission of exceptions with notifications. <br><br><blockquote>  Separating the original method allowed us to separate validation from reaction to its results. <br></blockquote><br>  Before we continue, a few words should be said about the error messages.  When we do refactoring, it is important to avoid changes in the observed behavior.  This rule leads us to the question of what behavior is observable.  Obviously, throwing an exception is what the external program will observe, but to what extent do they care about the error message?  Notification will collect many error messages and merge them into one, for example in this way. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ErrorMessage { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">", "</span></span>, errors); } }</code> </pre><br>  But there may be a problem with the higher layers of the program, which rely on getting only the first error detected.  In this case, we should implement it as follows. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ErrorMessage { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> errors[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } }</code> </pre><br>  We should look not only at the called function, but also at the existing handlers to determine the correct behavior in a particular situation. <br><br><h2>  Validation number </h2><br>  The obvious thing to do is replace the first check. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Notification </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Validation</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> notification = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Notification(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Date == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) notification.AddError(<span class="hljs-string"><span class="hljs-string">"  "</span></span>); <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre><br>  Obvious replacement, but bad, because it breaks the code.  If we pass null as an argument for Date, we add an error to the Notification object, the code will continue to run, and when parsed we get a NullReferenceException in the DateTime.Parse method.  This is not what we want to get. <br><br>  Unobvious, but more effective, what needs to be done in this case is to go from the end of the method. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Notification </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Validation</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//... if (NumberOfSeats &lt; 1) notification.AddError("     "); }</span></span></code> </pre><br>  The next check is a check for null, so we must add a condition to avoid a NullReferenceException <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Notification </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Validation</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//... if (NumberOfSeats == null) notification.AddError("   "); else if (NumberOfSeats &lt; 1) notification.AddError("     "); }</span></span></code> </pre><br>  As we can see, the following checkout includes another field.  And these checks should also be taken into account in the checks of another field.  The verification method becomes too complicated.  Therefore, we put the NumberOfSeats checks into a separate method. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Notification </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Validation</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//... ValidateNumberOfSeats(notification); } private void ValidateNumberOfSeats(Notification notification) { if (NumberOfSeats == null) notification.AddError("   "); else if (NumberOfSeats &lt; 1) notification.AddError("     "); }</span></span></code> </pre><br>  When we look at the highlighted validation for a number, it doesn‚Äôt look very natural.  Using if-then-else blocks for validation can easily lead to overly nested code.  It is more preferable to use a linear code that breaks if it cannot go further, which we can implement using the protection condition. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValidateNumberOfSeats</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Notification notification</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NumberOfSeats == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { notification.AddError(<span class="hljs-string"><span class="hljs-string">"   "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NumberOfSeats &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) notification.AddError(<span class="hljs-string"><span class="hljs-string">"     "</span></span>); }</code> </pre><br>  Our decision to go from the end of the method to leave the code to the workers demonstrates the basic principle of refactoring.  Refactoring is a special technique of code restructuring through a series of behavior-preserving transformations.  Therefore, when we refactor, we should always try to take the smallest steps that preserve behavior.  By doing this, we reduce the likelihood of an error that will cause us to debug. <br><br><h2>  Date validation </h2><br>  Let's start with the removal of checks for the date in a separate method. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Notification </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Validation</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ValidateDate(notification); ValidateNumberOfSeats(notification); }</code> </pre><br>  Then, as in the case of the number, we begin to replace the exception at the end of the method. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValidateNumberOfSeats</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Notification notification</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//... if (parsedDate &lt; DateTime.Now) notification.AddError("     "); }</span></span></code> </pre><br>  In the next step, there is a slight difficulty in catching the exception, since the released exception includes the original exception.  To handle this, we need to change the Notification class to accept the exception. <br><br>  Add the Exception parameter to the AddError method and set the default value to null. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddError</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> message, Exception exc = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { errors.Add(message); }</code> </pre><br>  This means we accept the exception, but ignore it.  To put it somewhere we need to change the type of error inside the Notification class from string to a more complex object.  Create an Error class inside Notification. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Error</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Message { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Exception Exception { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Error</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> message, Exception exception</span></span></span><span class="hljs-function">)</span></span> { Message = message; Exception = exception; } }</code> </pre><br>  Now we have a class and it remains for us to change the Notification to use it. <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//... private List&lt;Error&gt; errors = new List&lt;Error&gt;(); public void AddError(string message) { errors.Add(new Error(message, null)); } public void AddError(string message, Exception exception = null) { errors.Add(new Error(message, exception)); } //... public string ErrorMessage { get { return string.Join(", ", errors.Select(e =&gt; e.Message)); } }</span></span></code> </pre><br>  With a new notice in place, we can now make changes to the booking request. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValidateDate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Notification notification</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Date == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"  "</span></span>); DateTime parsedDate; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { parsedDate = DateTime.Parse(Date); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (FormatException e) { notification.AddError(<span class="hljs-string"><span class="hljs-string">"    "</span></span>, e); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parsedDate &lt; DateTime.Now) notification.AddError(<span class="hljs-string"><span class="hljs-string">"     "</span></span>); }</code> </pre><br>  And the last change is quite simple. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValidateDate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Notification notification</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Date == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) notification.AddError(<span class="hljs-string"><span class="hljs-string">"  "</span></span>); DateTime parsedDate; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { parsedDate = DateTime.Parse(Date); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (FormatException e) { notification.AddError(<span class="hljs-string"><span class="hljs-string">"    "</span></span>, e); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parsedDate &lt; DateTime.Now) notification.AddError(<span class="hljs-string"><span class="hljs-string">"     "</span></span>); }</code> </pre><br><h2>  Conclusion </h2><br>  Once we have converted the method using the notification mechanism, the next task will be to look at the places where the Check method is invoked and think about the possibility of using Validate instead.  To do this, it is necessary to analyze how the validation falls into the current implementation of the application; this goes beyond the scope of refactoring discussed here.  But in the medium term, there should be a goal: to exclude the use of exceptions in all circumstances where validation errors are expected. <br><br>  In many cases, this should lead to getting rid of the Check method completely.  In this case, any tests for this method should be updated using the Validation method.  We may also want to add tests that validate the correct collection of multiple errors using a notification. </div><p>Source: <a href="https://habr.com/ru/post/279737/">https://habr.com/ru/post/279737/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../279727/index.html">ActiveResource, prefix and nested resources</a></li>
<li><a href="../279729/index.html">Deep Reinforcement Learning (or what you bought DeepMind for)</a></li>
<li><a href="../279731/index.html">Qt 5.6 framework release</a></li>
<li><a href="../279733/index.html">ECMA-262 standard (JavaScript) in pictures, part 2</a></li>
<li><a href="../279735/index.html">Productivity in the development of Office Add-ins</a></li>
<li><a href="../279739/index.html">Processing ‚Äúvideo 360‚Äù, image cleaning: algorithm and its implementation in C #</a></li>
<li><a href="../279743/index.html">NetApp StorageGrid object storage</a></li>
<li><a href="../279745/index.html">Template Turing Machine</a></li>
<li><a href="../279747/index.html">Porting FreeModbus 1.5 under STM32 HAL rs485 without RTOS</a></li>
<li><a href="../279749/index.html">Study: DDR4, considered ‚Äúinvulnerable‚Äù, is vulnerable to Rowhammer vulnerability</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>