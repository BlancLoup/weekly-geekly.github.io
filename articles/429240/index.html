<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I tried to fix the search on the cards for drivers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is a story about how I tried to solve a strange problem that prevented me from doing so. Looking ahead, I will say - I am satisfied with the resu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I tried to fix the search on the cards for drivers</h1><div class="post__text post__text-html js-mediator-article">  This is a story about how I tried to solve a strange problem that prevented me from doing so.  Looking ahead, I will say - I am satisfied with the resulting decision and brought the application to its logical end.  However, in order to run it fully, you need more resources, so I decided to take a pause and ask people if it was needed by someone else.  To this end (and also just to speak out) and write here. <br><a name="habracut"></a><br>  Two words about myself: I live in Dublin, Ireland, I work as a programmer.  It‚Äôs not exactly sitting in place, so in my free time I saw different projects at home, mostly on the table.  I write on Habr√© for the first time, although I have been reading for many years. <br><br><h3>  Problem </h3><br>  Quite a long time ago, when at work I had to travel a lot to unfamiliar places, I began to notice that the standard search on any maps today is absolutely inapplicable to drivers.  Look: you are driving behind the wheel in an unfamiliar area, and you have a gasoline arrow at zero.  Your actions?  If at this moment I am not alone in the car, then I tell the passenger: ‚ÄúWell, look near the gas station while I am on my way‚Äù.  Because if you do it yourself, then you need to perform the following actions: <br><br><ol><li>  Stay </li><li>  In the maps application, enter ‚Äúgasoline‚Äù in the search (or click on one of the quick buttons that some cards now offer) </li><li>  The application does a search and shows you a huge map with a dozen refills </li><li>  You try to figure out which one is closest to you, and click on it to build a route. </li></ol><br>  In my opinion, a nightmare.  First, you need to stop, or at least wait for the traffic light.  Because the cards are complex, and the icons are small.  Secondly, the map does not tell you what the next gas station is.  In this regard, Google is the worst of all: even in the results in the form of a list, he stubbornly pushes up not the nearest place, but I have no idea what is the most rated / with photos / paid. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/nc/kj/mu/nckjmuxsfajkjffvk8bx0ksjtse.png" width="300"><br><br>  Well, the third factor: we are moving.  The result, which the cards were issued, was relevant for a certain point, but we are already far from it.  Have you noticed that even the route laid out by Google is not automatically updated if we have shifted?  Only if the navigation has already been launched - then it will rebuild. <br><br>  In general, the problem is clear.  Logic, which works for pedestrians and their needs, for drivers about nothing.  I do not care about the rating of the place and what kind of kitchen there is - I need, without being distracted from the road, in real time to get a route to the nearest gas station, charging, parking, ATM and so on. <br><br><h3>  Idea </h3><br>  Let us now try to determine the ideal search script.  The following criteria: <br><br><ul><li>  the interaction is short and understandable so as not to distract the driver </li><li>  transparent distance-based delivery </li><li>  real time update </li></ul><br>  The first thing that suggests itself is to replace the standard one-time search with a scan.  That is, a chain of actions is approximately as follows: <br><br><ol><li>  Run a scan </li><li>  You go, you look at the updated results in real time </li><li>  When I liked something, I clicked and paved the route. </li></ol><br>  You define the search criteria in advance - in fact, this is the type of location and the scan radius.  Further, while the car moves, the application works as a radar.  It quickly became clear that, first, the radius was not round, but in the form of an isoline.  Secondly, it should be built not by distance, but by time, because minutes are much easier for perception than kilometers. <br><br>  Then I thought about the method of issuing results.  More precisely, do I need a map at all?  The driver looks at the application with one eye and interacts with one finger - he needs not a map, but large text and large buttons.  Therefore, I immediately decided that the main screen would be a list, and I might add a map at first and see if I left it. <br><br><h3>  Plan </h3><br>  Knowing my peculiarity of stretching projects, I decided to take 2 months for myself - as a result, I got into 3. In principle, the application is quite simple: <br><br><ol><li>  A client of a pair of screens (search, list and map) </li><li>  Periodically sends to the server its coordinates, search radius and type of places </li><li>  The server builds the isoline in time (by the way, it has its name in English - isochrone), does a search in places and returns a list </li></ol><br>  Sounds like lighter.  I already had some previous experience in cartography (a couple of years ago I made a real estate portal where the search was on the map), so the stack on the backend was immediately clear: <br><br><ul><li>  import data from OpenStreetMaps to Elasticsearch </li><li>  OpenTripPlanner for contouring </li></ul><br>  On the client, on reflection, I decided to use the new Google framework - Flutter.  It is cross-platform, quite flexible, and allows you to make full-fledged applications with a minimum of code.  Of course, it‚Äôs raw and incomprehensible in production, but it looks perfect for prototyping.  It is necessary to clarify that by this time I had the experience of native development for android (was the team leader) and decided, so to speak, to look the enemy in the face.  The enemy was not so terrible. <br><br><h3>  Implementation </h3><br>  The first prototype of the application was ready very quickly - Flutter has a low threshold for entry and an understandable redux-like philosophy.  The declarative description of the interfaces, oddly enough, also liked, as well as the hot reboot (React Native, your card is a bit).  In general, the impression was that the Google team took into account most of the congenital diseases of previous attempts.  However, I understand people who may not have it all - someone doesn‚Äôt like the dart, a limited number of widgets, and the ‚Äúvisual debug‚Äù that is being offered here is something very raw. <br><br>  On the backend, I did the following: <br><br><ol><li> I put Nominatim, filled OpenStreetMaps data extract into its database (I took it <a href="http://download.geofabrik.de/">here</a> ), using its osm2pgsql utility.  Why did you turn to <a href="https://github.com/komoot/photon">Photon</a> , a small but very pleasant open source geocoder.  Earlier, I used it in a couple of projects - it generates the Elasticsearch index, imports data from the Nominatim database and searches by this index.  I like it with speed and clean mapping (for example, I tried Pelias and I liked it less).  His main problem is the old version of elastic, but in my case I didn‚Äôt need the functionality of the geocoder itself, only the data, so after importing, I transferred the index to the installation of the latest version elastic.  By the way, why did I choose Elasticsearch?  It is very fast, and it has a function to find coordinates by polygon. </li><li>  Polygon - it is isochrone - for me at first generated <a href="http://www.opentripplanner.org/">OpenTripPlanner</a> .  This is quite a good open source route planner.  It works as follows: it takes the same extract of OpenStreetMaps and compiles it into a large graph of roads, which, as a separate object, saves to disk.  When the server starts, this graph is loaded into RAM and all routes are searched through it.  Pros: quickly raise, rich functionality (for example, generates isolines out of the box) and a good speed of work.  Minuses: this speed of work directly depends on the amount of RAM, and the documentation is extremely disgusting.  Just monstrous documentation.  Vietnamese flashbacks. </li><li>  On the python, I sketched a small api, which takes the type of place and the search radius in seconds, requests the polygon from OpenTripPlanner, then searches for it in Elasticsearch.  For each place found, it requests a route (again from OpenTripPlanner), takes its length and time.  After that, all the collected data beautifully packs and returns. </li></ol><br>  I did the update of the results by shifting the device coordinates by 5 meters.  The map is static - I just used Google's google maps (as you can see, this is the only place where the corporation crawled into our cozy world of sorts).  The first implementation looked like this: <br><br><img src="https://habrastorage.org/webt/uu/re/ti/uuretiwzesv31fig6voucz43jx0.png" width="300"><br><br><img src="https://habrastorage.org/webt/_u/6y/ll/_u6yllx-mdeso0qlfdeaho65epg.png" width="300"><br><br><img src="https://habrastorage.org/webt/qt/le/ho/qtlehoo18mjchlj4eiybao_aei0.png" width="300">  ÔøºÔøºÔøº <br><br>  Having played with the application, I decided to hide the map.  She did a good job of understanding what search ground was being made, and she looked entertaining - it was interesting to see how this octopus changes shape in real time.  However, this entertainment did not help the application to perform its functions and occupied a third of the screen. <br><br>  It also occurred to me to add an arrow, which indicated the direction to each result.  It worked like this: <br><br><ol><li>  We remember our previous coordinates </li><li>  At the offset we plot the route from the previous position to the current one. </li><li>  We take the last segment of our route and compare it with the first segment of the route of each result.  Since they are laid on the same road grid, with a 99% probability the angle between them is close either to 0 or to 180. </li></ol><br>  This very simple trick makes it much easier to understand whether we are already heading towards a place or need to turn around. <br><br><img src="https://habrastorage.org/webt/rb/mp/h5/rbmph5eycajawl1s5b83eamgtwy.gif" width="300"><br>  Ôøº <br>  At this point, I was quite pleased with the resulting application and decided to try to deploy it to several countries.  Still, Ireland is a very small state, respectively, and the elastic index and the graph of roads were small.  For the test, I decided to connect the neighboring UK.  It is about 4 times longer and has a much denser road grid (especially the capital and major cities).  And there was a problem. <br><br>  Elasticsearch expectedly digested the increased index well, but with OpenTripPlanner there was a complete failure.  It is written in Java and, as I said above, it generates a graph of roads in order to load it into RAM afterwards.  The count for Ireland was 1 gigabyte, for the UK it was already 5. You could, of course, break into countries, regions and even areas, and then redirect to the desired graph, depending on the coordinates of the user.  However, this made it impossible to create routes between areas, and most importantly - did not solve the need to keep all these graphs in memory.  Finally, simply compiling each such object took up VERY many resources and lasted forever.  For interest, I started on my machine (16 GB frames) the assembly of the count of France, waited 24 hours and canceled. <br><br>  It is obvious that the technology, which performed well in small tasks, is absolutely not designed for scaling (at least not with my resources).  So one should either admit defeat or crawl to another technology.  I took a pause for a couple of days and began to study what other open source solutions exist in the world.  It turned out that there are basically two of them: <br><br><ul><li>  Opentripplanner </li><li>  <a href="https://github.com/Project-OSRM">Project OSRM</a> </li></ul><br>  If the first is written in Java and loads the graph of roads into RAM, then OSRM - the Open Source Routing Machine - is already written on the pros and keeps its (not less monstrous) intermediate files on the disk.  Thus, the need to have a huge amount of RAM has changed to the requirement of a large and fast disk.  This is already more real. <br><br><h3>  Finish line </h3><br>  After a couple of nights of picking in the documentation, the entire server code was transferred to a new solution.  It really worked, and worked well.  It was possible to connect several countries, and even the search speed increased.  The general principles were the same: from the extract of OpenStreetMaps, intermediate files were compiled for the ‚Äúmachine‚Äù profile (the profile is a set of weights and instructions for the graph edges - there are ‚Äúfoot‚Äù, ‚Äúbicycle‚Äù, etc.).  Then these files were added to the directory, and OSRM api already read them from the disk.  By the way, Api turned out to be rather big - both the contour lines and the routing with various nuances were supported, there was even a generation of tiles for the map.  At the last I decided to stop in more detail. <br><br>  Returning to the application and continuing to test it, I realized a couple more things: <br><br><ul><li>  the menu at the top is no good </li><li>  I don‚Äôt need a shared map, it just ties me to Google </li><li>  scorecards are boring and monotonous </li></ul><br>  I gladly threw out a Google map (hooray, now 100% open source and my data), simplified the menu, moved it down.  I started thinking what to do with the cards.  And here, by the way, turned up the api tiles, which I mentioned above.  It allows you to generate a vector tile for given coordinates and zoom level.  The result is given in the form of a binary blob of the type application / x-protobuf ‚Äî a data type that is rather inconvenient for manipulations.  I will not go into details (I had to sweat a little), but in short my actions looked like this: <br><br><ol><li>  Pick up the line of the constructed route to the point in the form of polyline </li><li>  Polyline -&gt; GeoJSON </li><li>  Get the bounding box of this shape. </li><li>  Request all tiles that this bounding box captures </li><li>  Convert tile data from binary format to GeoJSON </li><li>  Glue the tiles, cut along the bounding box, combine with the route line, paint </li><li>  Convert GeoJSON into a bitmap image </li></ol><br>  In the course of the action, there were various nuances, for example, indenting a bounding box or marking points with colored rings (and making their radius constant for all zoom levels).  The resulting picture looked like this: <br>  Ôøº <br><img src="https://habrastorage.org/webt/r2/za/2u/r2za2us1ntmhvdfshs4hsnu2rj8.png" width="300"><br><br><h3>  Finishing touches </h3><br>  When I attached a visual route to each result, the list began to play with new colors.  In addition, realizing that each picture defaults to the north, I made them spinning in relation to the compass.  Thus, in addition to the visual effect, this chip has also become functional - replacing the direction arrow.  Now, when you move behind the wheel, you can see exactly which side of you or other result is located. <br><br>  The third month of development was expiring, and it was necessary to wrap up already.  The more you add, the more you want, so at some point you just need to pull yourself together and release the project.  I have a little more corrected and painted the interface, and for the feeling of completion I sketched the application logo: <br><br>  Ôøº <img src="https://habrastorage.org/webt/kt/pv/hq/ktpvhqnibjmjewucwszvopdmgoe.png" width="150"><br><br>  and introductory page: <br><br>  Ôøº <img src="https://habrastorage.org/webt/rq/no/l1/rqnol1usdtcguhyktktrowbdbdk.png" width="300"><br><br>  And finally, the final version of the application: <br><br>  ÔøºÔøºÔøºÔøº <img src="https://habrastorage.org/webt/ue/4p/og/ue4pogbsgbzaqbinhj3mjmronha.png" width="300"><br><br><img src="https://habrastorage.org/webt/wo/34/sw/wo34swgdxsfk6tk6uw1njgwg90a.png" width="300"><br><br><img src="https://habrastorage.org/webt/17/5p/xr/175pxr7hgipc6dpylbejnxv5hb0.png" width="300"><br><br><img src="https://habrastorage.org/webt/6r/e1/xr/6re1xrvrtcmp2udr4lyc4iqai5u.png" width="300"><br><br><h3>  Total </h3><br>  Well, thank you for your attention.  I hope this stream of consciousness will be interesting to someone, and maybe even useful.  At this stage, I consider the application ready: it is fast, without any special bugs and will be able to work in any country in the world.  By the way, you may have noticed that the screenshots were from both iPhone and Android, because thanks to Flutter, the application works exactly the same on both platforms. <br><br>  Nevertheless, so far I decided to freeze everything - I changed jobs, new concerns appeared.  After a couple of months I shook off the dust and decided to write a retrospective.  Your feedback is interesting: whether you would like it, use it, what can be changed. <br><br>  <b>PS</b> Of course, about the readiness of the application is nonsense.  It is ready as a prototype - if you approach a serious production, then you need to do data synchronization scripts with OpenStreetMaps, check the work at the zoo devices, localize interfaces and so on.  The same backend on the node and python will fall under some serious load. </div><p>Source: <a href="https://habr.com/ru/post/429240/">https://habr.com/ru/post/429240/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../429230/index.html">Report: Epson projectors at Integrated Systems Russia 2018</a></li>
<li><a href="../429232/index.html">Career steroids. Dogs</a></li>
<li><a href="../429234/index.html">Creating a game "Like coins" on Godot Engine. Part 1</a></li>
<li><a href="../429236/index.html">How many Data Scientists do you need to twist the light bulb (or which team will force the data to work on the business)</a></li>
<li><a href="../429238/index.html">Once again about Tier levels</a></li>
<li><a href="../429242/index.html">‚ÄúDo not be shy. Try it! Interviews about life, compilers and compiler life with Alexandre Mutel from Unity</a></li>
<li><a href="../429244/index.html">Greedy Dwarf: As I wrote market analytics in Lineage 2</a></li>
<li><a href="../429246/index.html">Summer Internship at Mars IS: An Inside Look</a></li>
<li><a href="../429248/index.html">Tips polyglot: how to learn any language without tears and curses</a></li>
<li><a href="../429250/index.html">One hundred digital accounting recipes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>