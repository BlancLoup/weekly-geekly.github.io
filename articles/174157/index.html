<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to run a program without an operating system: part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part of our article, we talked about how you can get a simple ‚ÄúHello World‚Äù program that runs without an operating system and prints a me...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to run a program without an operating system: part 2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/df1/f22/da0/df1f22da00fdada9703701fa2f48e499.jpg"><br><br>  <a href="http://habrahabr.ru/company/neobit/blog/173263/">In the first part of our</a> article, we talked about how you can get a simple ‚ÄúHello World‚Äù program that runs without an operating system and prints a message on the screen. <br><br>  In this part of the article, I want to develop the <i>resulting code in the first part</i> so that it can be debugged through GDB, compiled through the Visual Studio shell and printed on the screen a list of PCI devices. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>!</b>  <b>IMPORTANT!</b>  : All further actions can be successfully carried out only after successful completion of all 6 steps described in the first part of the article). <br><br><a name="habracut"></a><br><h4>  We learn to debug the program </h4><br><br>  <b>Main article</b> : <a href="http://habrahabr.ru/company/neobit/blog/141067/">Using the GDB debugger to the maximum</a> <br><br>  How to debug kernel.bin code?  To do this, add debugging symbols to kernel.bin and start the debugger: <br><br>  1. Add the compiler option in the makefile so that it generates debugging symbols: <br><pre><code class="cpp hljs">CFLAGS = -Wall -fno-builtin -nostdinc -nostdlib -ggdb3</code> </pre> <br><br>  2. Add a couple of lines at the build stage so that the kernel.bin is written to disk without characters (such a file can be made using the strip utility).  To do this, fix the kernel.bin target in the makefile: <br><pre> <code class="cpp hljs">kernel.bin: $(OBJFILES) $(LD) -T linker.ld -o $@ $^ cp $@ $@.dbg strip $@</code> </pre><br>  then: <br>  <b>kernel.bin</b> - does not contain characters - it can be run; <br>  <b>kernel.bin.dbg</b> - contains both symbols and code - you can feed it to the debugger. <br><br>  3. Install the debugger: <br><pre> <code class="bash hljs">sudo apt-get install cgdb</code> </pre><br><br>  4. Recompile the program: <br><pre> <code class="bash hljs">make clean make all sudo make image</code> </pre><br><br>  5. Run qemu with the debugger wait option: <br><pre> <code class="bash hljs">sudo qemu-system-i386 -s -S -hda hdd.img &amp;</code> </pre><br><br>  6. Run the debugger with a file with symbols: <br><pre> <code class="bash hljs">cgdb kernel.bin.dbg</code> </pre><br><br>  7. In the debugger, connect to qemu and set the breakpoint directly to the main function: <br><pre> <code class="bash hljs">(gdb) target remote localhost:1234 (gdb) <span class="hljs-built_in"><span class="hljs-built_in">break</span></span> main</code> </pre><br><br><img src="https://habrastorage.org/storage2/6ee/c8b/283/6eec8b2833e2e2e9ad4e5397eb96452a.jpg"><br><br>  8. Get into main and debug it: <br><pre> <code class="bash hljs">(gdb) c (gdb) n (gdb) n</code> </pre><br><br><img src="https://habrastorage.org/storage2/8bb/4cb/9fa/8bb4cb9fa7a51fe3d8fbd5debdbae324.jpg"><br><br>  Thus, a powerful debugging tool is obtained.  This method will work for QEMU, and in order to debug the program directly on the hardware, you need to connect the debugger module to our program - we will look at it in one of the following articles. <br><br><h4>  Compiling from Visual Studio </h4><br><br>  <b>Main article</b> : <a href="http://habrahabr.ru/company/neobit/blog/151712/">Using Visual Studio 2010 shell to compile projects using gcc on Linux</a> <br><br>  How to work with the received code from Visual Studio?  Following the instructions in the article, we assemble the Visual Studio project without creating a project on Linux - it already exists. <br><br>  1. Install on the ssh system: <br><pre> <code class="bash hljs">sudo apt-get install ssh</code> </pre><br><br>  2. We have the source of the project from <b>kernel.bin</b> on the <b>shared directory</b> for the virtual machine. <br><br>  3. Install the <b>plink</b> utility in the <b>tools</b> folder and check its operation. <br><br>  4. Create a Visual Studio project following the instructions and get the following tree: <br><br>  <b>\ proj \ kernel.c</b> <b><br></b>  <b>\ proj \ loader.s</b> <b><br></b>  <b>\ proj \ common \ printf.c</b> <b><br></b>  <b>\ proj \ common \ screen.c</b> <b><br></b>  <b>\ proj \ include \ printf.h</b> <b><br></b>  <b>\ proj \ include \ stdarg.h</b> <b><br></b>  <b>\ proj \ include \ screen.h</b> <b><br></b>  <b>\ proj \ include \ types.h</b> <b><br></b>  <b>\ proj \ makefile</b> <b><br></b>  <b>\ proj \ linker.ld</b> <b><br></b>  <b>\ proj \ tools \ plink.exe</b> <b><br></b>  <b>\ proj \ kernel \ kernel.sln</b> <b><br></b>  <b>\ proj \ kernel \ kernel.suo</b> <b><br></b>  <b>\ proj \ kernel \ kernel.sdf</b> <b><br></b>  <b>\ proj \ kernel \ vs \ kernel.vcxproj</b> <b><br></b>  <b>\ proj \ kernel \ vs \ kernel.vcxproj.filters</b> <b><br></b>  <b>\ proj \ kernel \ vs \ make_vs.props</b> <br><br>  5. Build the file ‚Äù\ proj \ kernel \ vs \ make_vs.props‚Äù as per the instructions: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/developer/msbuild/2003"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Label</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"RemoteBuildLocals"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RblFolder</span></span></span><span class="hljs-tag">&gt;</span></span>proj<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RblFolder</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RblIncludePath</span></span></span><span class="hljs-tag">&gt;</span></span>$(SolutionDir)\include\<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RblIncludePath</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RblExecute</span></span></span><span class="hljs-tag">&gt;</span></span>sudo make image; sudo qemu-system-i386 -hda hdd.img<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RblExecute</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Label</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"RemoteBuildSettings"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbHost</span></span></span><span class="hljs-tag">&gt;</span></span>192.168.1.8<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbHost</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbUser</span></span></span><span class="hljs-tag">&gt;</span></span>user<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbUser</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbPassword</span></span></span><span class="hljs-tag">&gt;</span></span>123456<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbPassword</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbRoot</span></span></span><span class="hljs-tag">&gt;</span></span> ~/Desktop/_habr<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbRoot</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Label</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"RemoteBuild"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbToolArgs</span></span></span><span class="hljs-tag">&gt;</span></span> -pw $(RbPassword) $(RbUser)%40$(RbHost) cd $(RbRoot); cd $(RblFolder);<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbToolArgs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbToolExe</span></span></span><span class="hljs-tag">&gt;</span></span>$(SolutionDir)tools\plink -batch $(RbToolArgs)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbToolExe</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbBuildCmd</span></span></span><span class="hljs-tag">&gt;</span></span>$(RbToolExe) make all<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbBuildCmd</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbRebuildAllCmd</span></span></span><span class="hljs-tag">&gt;</span></span>$(RbToolExe) make rebuild<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbRebuildAllCmd</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbCleanCmd</span></span></span><span class="hljs-tag">&gt;</span></span>$(RbToolExe) make cleanall<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbCleanCmd</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbExecuteCmd</span></span></span><span class="hljs-tag">&gt;</span></span>$(RbToolArgs) $(RblExecute)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbExecuteCmd</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbIncludePath</span></span></span><span class="hljs-tag">&gt;</span></span>$(RblIncludePath)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RbIncludePath</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(Configuration)|$(Platform)'=='Debug|Win32'"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NMakeBuildCommandLine</span></span></span><span class="hljs-tag">&gt;</span></span>$(RbBuildCmd)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NMakeBuildCommandLine</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NMakeReBuildCommandLine</span></span></span><span class="hljs-tag">&gt;</span></span>$(RbRebuildAllCmd)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NMakeReBuildCommandLine</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NMakeCleanCommandLine</span></span></span><span class="hljs-tag">&gt;</span></span>$(RbCleanCmd)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NMakeCleanCommandLine</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IncludePath</span></span></span><span class="hljs-tag">&gt;</span></span>$(RbIncludePath)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IncludePath</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LocalDebuggerCommand</span></span></span><span class="hljs-tag">&gt;</span></span>$(SolutionDir) tools\plink<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LocalDebuggerCommand</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LocalDebuggerCommandArguments</span></span></span><span class="hljs-tag">&gt;</span></span>$(RbExecuteCmd)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LocalDebuggerCommandArguments</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(Configuration)|$(Platform)'=='Release|Win32'"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NMakeBuildCommandLine</span></span></span><span class="hljs-tag">&gt;</span></span>$(RbBuildCmd)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NMakeBuildCommandLine</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NMakeReBuildCommandLine</span></span></span><span class="hljs-tag">&gt;</span></span>$(RbRebuildAllCmd)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NMakeReBuildCommandLine</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NMakeCleanCommandLine</span></span></span><span class="hljs-tag">&gt;</span></span>$(RbCleanCmd)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NMakeCleanCommandLine</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IncludePath</span></span></span><span class="hljs-tag">&gt;</span></span>$(RbIncludePath)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IncludePath</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LocalDebuggerCommand</span></span></span><span class="hljs-tag">&gt;</span></span>$(SolutionDir)tools\plink<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LocalDebuggerCommand</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LocalDebuggerCommandArguments</span></span></span><span class="hljs-tag">&gt;</span></span>$(RbExecuteCmd)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LocalDebuggerCommandArguments</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  6. Change the file ‚Äù\ proj \ kernel \ vs \ kernel.vcxproj‚Äù as per the instructions: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Import</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Project</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(VCTargetsPath)\Microsoft.Cpp.props"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Import</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Project</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SolutionDir)\vs\make_vs.props"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ImportGroup</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Label</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ExtensionSettings"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  7. In the end, you should get something like the following: <br><br><img src="https://habrastorage.org/storage2/2a9/77e/de4/2a977ede410c4eaca872174cda30faa2.jpg"><br><br>  8. Check that everything works: <br><br><img src="https://habrastorage.org/storage2/006/4da/981/0064da9810211bc47381e733008ce169.jpg"><br><br>  Thus, for the further development of our program, you can use the Visual Studio shell, albeit a GCC compiler on Linux. <br><br><h4>  Scanning PCI devices </h4><br><br>  <b>Main article</b> : <a href="http://habrahabr.ru/company/neobit/blog/162769/">How to find PCI devices without an operating system</a> <br><br>  How can I scan the PCI system bus for devices now?  Following the instructions in the article, we perform the following actions (the boot image is already ready, so just add the PCI scan code): <br><br>  1. Add the following type definition to the <b>include \ types.h</b> file: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> u32; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> u16; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> u8;</code> </pre><br><br>  2. Add the file <b>include \ io.h</b> , which without any changes can be taken from the bitvisor project from the directory (include \ io.h). <br><br>  3. Add the <b>include \ pci.h file,</b> which contains the basic definitions for functions for working with PCI.  It has the following contents: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> _PCI_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _PCI_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"types.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PCI_CONFIG_PORT 0x0CF8 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PCI_DATA_PORT 0x0CFC #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PCI_MAX_BUSES 255 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PCI_MAX_DEVICES 32 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PCI_MAX_FUNCTIONS 8 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PCI_HEADERTYPE_NORMAL 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PCI_HEADERTYPE_BRIDGE 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PCI_HEADERTYPE_CARDBUS 2 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PCI_HEADERTYPE_MULTIFUNC 0x80 typedef union { struct { u16 vendorID; u16 deviceID; u16 commandReg; u16 statusReg; u8 revisionID; u8 progIF; u8 subClassCode; u8 classCode; u8 cachelineSize; u8 latency; u8 headerType; u8 BIST; } __attribute__((packed)) option; u32 header[4]; } __attribute__((packed)) PCIDevHeader; void ReadConfig32(u32 bus, u32 dev, u32 func, u32 reg, u32 *data); char *GetPCIDevClassName(u32 class_code); void PCIScan(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre><br><br>  4. Add the <b>pci.c</b> file to the root of the project, with the following contents (we have slightly improved this code compared to the main article): <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"types.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"printf.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"io.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pci.h"</span></span></span><span class="hljs-meta"> typedef struct { u32 class_code; char name[32]; } PCIClassName; static PCIClassName g_PCIClassNames[] = { { 0x00, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"before PCI 2.0"</span></span></span><span class="hljs-meta">}, { 0x01, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"disk controller"</span></span></span><span class="hljs-meta">}, { 0x02, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"network interface"</span></span></span><span class="hljs-meta">}, { 0x03, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"graphics adapter"</span></span></span><span class="hljs-meta">}, { 0x04, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"multimedia controller"</span></span></span><span class="hljs-meta">}, { 0x05, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"memory controller"</span></span></span><span class="hljs-meta">}, { 0x06, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"bridge device"</span></span></span><span class="hljs-meta">}, { 0x07, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"communication controller"</span></span></span><span class="hljs-meta">}, { 0x08, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"system device"</span></span></span><span class="hljs-meta">}, { 0x09, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"input device"</span></span></span><span class="hljs-meta">}, { 0x0a, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"docking station"</span></span></span><span class="hljs-meta">}, { 0x0b, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CPU"</span></span></span><span class="hljs-meta">}, { 0x0c, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"serial bus"</span></span></span><span class="hljs-meta">}, { 0x0d, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wireless controller"</span></span></span><span class="hljs-meta">}, { 0x0e, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"intelligent I/O controller"</span></span></span><span class="hljs-meta">}, { 0x0f, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"satellite controller"</span></span></span><span class="hljs-meta">}, { 0x10, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"encryption controller"</span></span></span><span class="hljs-meta">}, { 0x11, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"signal processing controller"</span></span></span><span class="hljs-meta">}, { 0xFF, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"proprietary device"</span></span></span><span class="hljs-meta">} }; typedef union { struct { u32 zero : 2; u32 reg_num : 6; u32 func_num : 3; u32 dev_num : 5; u32 bus_num : 8; u32 reserved : 7; u32 enable_bit : 1; }; u32 val; } PCIConfigAddres; void ReadConfig32(u32 bus, u32 dev, u32 func, u32 reg, u32 *data) { PCIConfigAddres addr; addr.val = 0; addr.enable_bit = 1; addr.reg_num = reg; addr.func_num = func; addr.dev_num = dev; addr.bus_num = bus; out32(PCI_CONFIG_PORT, addr.val); in32(PCI_DATA_PORT, data); return; } char *GetPCIDevClassName(u32 class_code) { int i; for (i = 0; i </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; sizeof(g_PCIClassNames)/sizeof(g_PCIClassNames[0]); i++) { if (g_PCIClassNames[i].class_code == class_code) return g_PCIClassNames[i].name; } return NULL; } int ReadPCIDevHeader(u32 bus, u32 dev, u32 func, PCIDevHeader *p_pciDevice) { int i; if (p_pciDevice == 0) return 1; for (i = 0; i &lt; sizeof(p_pciDevice-&gt;header)/sizeof(p_pciDevice-&gt;header[0]); i++) ReadConfig32(bus, dev, func, i, &amp;p_pciDevice-&gt;header[i]); if (p_pciDevice-&gt;option.vendorID == 0x0000 || p_pciDevice-&gt;option.vendorID == 0xffff || p_pciDevice-&gt;option.deviceID == 0xffff) return 1; return 0; } void PrintPCIDevHeader(u32 bus, u32 dev, u32 func, PCIDevHeader *p_pciDevice) { char *class_name; printf("bus=0x%x dev=0x%x func=0x%x venID=0x%x devID=0x%x", bus, dev, func, p_pciDevice-&gt;option.vendorID, p_pciDevice-&gt;option.deviceID); class_name = GetPCIDevClassName(p_pciDevice-&gt;option.classCode); if (class_name) printf(" class_name=%s", class_name); printf("\n"); } void PCIScan(void) { int bus; int dev; for (bus = 0; bus &lt; PCI_MAX_BUSES; bus++) for (dev = 0; dev &lt; PCI_MAX_DEVICES; dev++) { u32 func = 0; PCIDevHeader pci_device; if (ReadPCIDevHeader(bus, dev, func, &amp;pci_device)) continue; PrintPCIDevHeader(bus, dev, func, &amp;pci_device); if (pci_device.option.headerType &amp; PCI_HEADERTYPE_MULTIFUNC) { for (func = 1; func &lt; PCI_MAX_FUNCTIONS; func++) { if (ReadPCIDevHeader(bus, dev, func, &amp;pci_device)) continue; PrintPCIDevHeader(bus, dev, func, &amp;pci_device); } } } }</span></span></span></span></code> </pre><br><br>  5. Add the launch of scanning PCI devices in kernel.c: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"printf.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"screen.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"types.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pci.h"</span></span></span><span class="hljs-meta"> void main() { clear_screen(); printf(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\n&gt;&gt;&gt; Hello World!\n"</span></span></span><span class="hljs-meta">); PCIScan(); }</span></span></code> </pre><br><br>  6. Make the necessary changes to the makefile: <br><pre> <code class="cpp hljs">OBJFILES = \ loader.o \ common/<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>.o \ common/screen.o \ pci.o \ kernel.o</code> </pre><br><br>  7. Now you can rebuild the project: <br><pre> <code class="bash hljs">make rebuild sudo make image</code> </pre><br><br>  8. Run the project to make sure everything works: <br><pre> <code class="bash hljs">sudo qemu-system-i386 -hda hdd.img</code> </pre><br><br><img src="http://habrastorage.org/storage2/4e3/a30/c32/4e3a30c32c8ff56d8d018b133489b0f6.jpg"><br><br>  So we got a list of PCI devices on the computer.  It will also work on a regular computer by booting from a flash drive. <br><br>  After going through all the steps in this article, you can personally understand everything and see a working program that can be fully debugged. <br><br>  Links to the following articles of the cycle: <br>  " <b>How to run a program without an operating system: <a href="http://habrahabr.ru/company/neobit/blog/176707/">part 3: Graphics</a></b> " <br>  " <b>How to run a program without an operating system: <a href="http://habrahabr.ru/company/neobit/blog/181626/">part 4. Parallel computing</a></b> " <br>  " <b>How to run a program without an operating system: <a href="http://habrahabr.ru/company/neobit/blog/211470/">part 5. Accessing the BIOS from the OS</a></b> " <br>  " <b>How to run a program without an operating system: <a href="http://habrahabr.ru/company/neobit/blog/203706/">part 6. Support for working with disks with the FAT file system</a></b> " </div><p>Source: <a href="https://habr.com/ru/post/174157/">https://habr.com/ru/post/174157/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../174141/index.html">Mobile image capture: talk alone or more?</a></li>
<li><a href="../174145/index.html">DARPA intends to revolutionize machine learning</a></li>
<li><a href="../174147/index.html">How we chose hosting</a></li>
<li><a href="../174151/index.html">Development for Blackberry 10. First impressions</a></li>
<li><a href="../174153/index.html">Professional Audio / Video over Ethernet, a completely new approach</a></li>
<li><a href="../174159/index.html">Canadian sells his house for Bitcoins</a></li>
<li><a href="../174167/index.html">Do you know static routing well?</a></li>
<li><a href="../174169/index.html">Droppers Gapz and Redyms are based on the Power Loader code</a></li>
<li><a href="../174171/index.html">Nokia's research project - a ready-made prototype of the phone, charged by the energy of radio waves</a></li>
<li><a href="../174173/index.html">Windows Azure Update: Hadoop, Dropbox, Mercurial, PhoneGap</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>