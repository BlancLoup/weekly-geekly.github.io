<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Processing pcntl signals in PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Signal processing in PHP has already been written a few articles . But there this topic is described only indirectly. 

 At once I will make a reserva...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Processing pcntl signals in PHP</h1><div class="post__text post__text-html js-mediator-article">  Signal processing in PHP has already been <a href="http://habrahabr.ru/post/148596/">written a</a> <a href="http://habrahabr.ru/post/40432/">few</a> <a href="http://habrahabr.ru/post/134620/">articles</a> .  But there this topic is described only indirectly. <br><br>  At once I will make a reservation that I know that PHP 5.5 and 5.2 has already been released is morally obsolete, but the task needed to be solved in PHP 5.2.  For those lucky ones who use a newer version of PHP, I will also write, but closer to the end of the article. <br><br>  Processing pcntl signals in PHP is done by passing the handler function to the <a href="http://php.net/pcntl_signal">pcntl_signal ()</a> function, and only one handler can be hung for each signal.  Each next handler will replace the previous one, and there will not be any notes. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Those.  if you use several third-party libraries and each need to process some signal, then only one library will handle the signal.  It turns out that third-party libraries should only provide callbacks for signal processing, and the library user should call these callbacks in the signal handler. <br><br>  I will give an example: <br>  Suppose that in two third-party libraries two different libraries are used for logging and both libraries must process the SIGHUP signal in order to rediscover the log file as it rotates.  It happens as follows.  A daemon that is responsible for the rotate of the logs. Movit log files and sends a SIGHUP signal to all processes that use this log file.  After moving the log file, but before processing the signal, the process continues to write to the same file.  After correct processing of this signal, the process should start writing to a new file. <br>  The signal handler should not belong to one of these libraries, but should be part of the application.  It should call the signal handlers of the libraries themselves. <br><br><h2>  declare (ticks = 1) </h2><br>  Before version 5.3, in order for a signal handler to be called, it is imperative to use the <a href="http://www.php.net/manual/ru/control-structures.declare.php">declare</a> construction <a href="http://www.php.net/manual/ru/control-structures.declare.php">(ticks = 1)</a> .  Normal php-programmer such a design introduces bewilderment.  When reading the manual, it becomes not much clearer how it works, especially for those who are not professional in C ++ and other languages ‚Äã‚Äãthat have execution control constructs: <br><blockquote>  The declare construct can be used in the global scope, affecting all the code following it (however, if the file with declare was included, then it has no effect on the parent file). </blockquote>  There clearly need to consider examples. <br><br><h2>  Performance </h2><br>  How this design affects the performance is not written, so I made benchmarks.  Files: <br>  Example.php: <br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Example</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; <span class="hljs-number"><span class="hljs-number">10000000</span></span>; $i++); } }</code> </pre> <br>  testWithTicksSpeed.php: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span>(ticks = <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/Example.php'</span></span>; $example = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Example(); $example-&gt;run();</code> </pre><br>  testWithoutTicksSpeed.php: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/Example.php'</span></span>; $example = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Example(); $example-&gt;run();</code> </pre><br>  I must say that the test is synthetic, because  it has no access to the database, reading files, etc.  performance of which declare (ticks = 1) does not affect. <br>  Results: <br><pre> <code class="bash hljs">mougrim@mougrim-pc:pcntls-signals$ time php testWithTicksSpeed.php complete, process time: 11 real 0m10.186s user 0m4.448s sys 0m5.732s mougrim@mougrim-pc:pcntls-signals$ time php testWithoutTicksSpeed.php complete, process time: 2 real 0m1.515s user 0m1.504s sys 0m0.008s</code> </pre><br>  The difference is ~ 6.7 times.  In a real project, the difference will of course be smaller, but I don‚Äôt want to waste resources and time where there is no need to catch signals. <br><br>  To understand how to save resources (not always cause declare) you need to understand how this declare works.  During the experiments, it turned out the following. <br>  This code works: <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Test_Signal</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    public function declareTicks() { echo "declare ticks\n"; declare(ticks = 1); } public function run() { //    pcntl_signal //     } } $test = new Test_Signal(); $test-&gt;run();</span></span></code> </pre><br>  This code does not work: <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Test_Signal</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;declareTicks(); <span class="hljs-comment"><span class="hljs-comment">//    pcntl_signal //     } public function declareTicks() { echo "declare ticks\n"; declare(ticks = 1); } } $test = new Test_Signal(); $test-&gt;run();</span></span></code> </pre><br>  Those.  if no specific block of code is specified for declare, then it is valid for the entire code following it.  And here it means the code processed by the interpreter and turned into an OP code. <br>  To be clearer, consider the example from the benchmark. <br>  In class Example, signals are processed: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span>(ticks = <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/Example.php'</span></span>; $example = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Example(); $example-&gt;run();</code> </pre><br>  In the class Example, signals are not processed: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/Example.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span>(ticks = <span class="hljs-number"><span class="hljs-number">1</span></span>); $example = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Example(); $example-&gt;run();</code> </pre><br><br><h2>  Subtleties </h2><br>  When testing signal handlers, strange things came to light.  At some point, the daemon started processing the same signal many times so that the main script code was practically not executed.  When a single SIGTERM signal was sent, the daemon also began to process it many times.  After talking with knowledgeable people, it turned out that the signal handler should be as small as possible and not allocate memory.  This is due to the fact that the signal handler can be called during memory allocation and memory allocation in the processor can lead to its damage and unpredictable consequences.  A signal handler is obtained when using declare (ticks = 1) should be minimal, for example, put some flag, and direct processing should be in the main script loop. <br><br>  Check this I do not have enough knowledge, because  I do not develop in C / C ++, but when using the Mougrim_Pcntl_SignalHandler described below and which does not allocate memory during signal processing, this problem is no longer reproduced. <br><br><h2>  Signal processing in PHP 5.3 </h2><br>  PHP 5.3 has a great pcntl_signal_dispatch () function.  The bottom line is that if you do not declare declare (ticks = 1), then the signals are copied into the queue and if you call the pcntl_signal_dispatch () function, then the accumulated signal handlers will be called.  If the same signal was sent several times, the handler will also be called several times.  This function solves performance problems and minimizes the signal handler, since  processing does not occur anywhere, but only during the pcntl_signal_dispatch () call. <br><br><h2>  Signalhandler </h2><br>  Example of a signal handler for 5.2, src / lt5.3 / Mougrim / Pcntl / SignalHandler.php file: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span>(ticks = <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@author</span></span></span><span class="hljs-comment"> Mougrim &lt;rinat</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@mougrim</span></span></span><span class="hljs-comment">.ru&gt; */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mougrim_Pcntl_SignalHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> callable[] */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $handlers = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $toDispatch = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-comment"><span class="hljs-comment">/** *    * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $signalNumber  ,  SIGTERM * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> callable $handler -  $signalNumber * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> bool $isAdd  true,     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($signalNumber, $handler, $isAdd = true)</span></span></span><span class="hljs-function"> </span></span>{ $isHandlerNotAttached = <span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handlers[$signalNumber]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($isAdd) <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handlers[$signalNumber][] = $handler; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handlers[$signalNumber] = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($handler); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($isHandlerNotAttached &amp;&amp; function_exists(<span class="hljs-string"><span class="hljs-string">'pcntl_signal'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;toDispatch[$signalNumber] = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; pcntl_signal($signalNumber, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>, <span class="hljs-string"><span class="hljs-string">'handleSignal'</span></span>)); } } <span class="hljs-comment"><span class="hljs-comment">/** *    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;toDispatch <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $signalNumber =&gt; $isNeedDispatch) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!$isNeedDispatch) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;toDispatch[$signalNumber] = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handlers[$signalNumber] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $handler) call_user_func($handler, $signalNumber); } } <span class="hljs-comment"><span class="hljs-comment">/** *      * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $signalNumber  ,  SIGTERM */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleSignal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($signalNumber)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;toDispatch[$signalNumber] = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } }</code> </pre><br>  The handler solves two problems: <br>  1) it emulates pcntl_signal_dispatch (); <br>  2) allows the use of multiple handler functions for a single signal. <br><br>  Example of a signal handler for 5.3 and higher, src / gte5.3 / Mougrim / Pcntl / SignalHandler.php file: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Mougrim</span></span>\<span class="hljs-title"><span class="hljs-title">Pcntl</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@package</span></span></span><span class="hljs-comment"> Mougrim\Pcntl * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@author</span></span></span><span class="hljs-comment"> Mougrim &lt;rinat</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@mougrim</span></span></span><span class="hljs-comment">.ru&gt; */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SignalHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> callable[] */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $handlers = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $toDispatch = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-comment"><span class="hljs-comment">/** *    * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $signalNumber  ,  SIGTERM * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> callable $handler -  $signalNumber * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> bool $isAdd  true,     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($signalNumber, $handler, $isAdd = true)</span></span></span><span class="hljs-function"> </span></span>{ $isHandlerNotAttached = <span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handlers[$signalNumber]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($isAdd) <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handlers[$signalNumber][] = $handler; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handlers[$signalNumber] = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($handler); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($isHandlerNotAttached &amp;&amp; function_exists(<span class="hljs-string"><span class="hljs-string">'pcntl_signal'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;toDispatch[$signalNumber] = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; pcntl_signal($signalNumber, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>, <span class="hljs-string"><span class="hljs-string">'handleSignal'</span></span>)); } } <span class="hljs-comment"><span class="hljs-comment">/** *    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ pcntl_signal_dispatch(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;toDispatch <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $signalNumber =&gt; $isNeedDispatch) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!$isNeedDispatch) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;toDispatch[$signalNumber] = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handlers[$signalNumber] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $handler) call_user_func($handler, $signalNumber); } } <span class="hljs-comment"><span class="hljs-comment">/** *      * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $signalNumber  ,  SIGTERM */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleSignal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($signalNumber)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;toDispatch[$signalNumber] = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } }</code> </pre><br>  This handler solves only one problem - it allows you to use several signal handler functions.  At the same time, the class interface is identical to the Mougrim_Pcntl_SignalHandler class interface. <br><br><h2>  Usage example </h2><br>  Lastly, an example of using files: <br>  signalExampleRun.php: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//    SignalHandler,     declare(ticks = 1); require_once dirname(__FILE__) . "/src/lt5.3/Mougrim/Pcntl/SignalHandler.php"; require_once dirname(__FILE__) . "/SignalExample.php";; $signalHandler = new Mougrim_Pcntl_SignalHandler(); $signalExample = new SignalExample($signalHandler); $signalExample-&gt;run();</span></span></code> </pre><br>  SignalExample.php: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SignalExample</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $signalHandler; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Mougrim_Pcntl_SignalHandler $signalHandler)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;signalHandler = $signalHandler; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    SIGTERM $this-&gt;signalHandler-&gt;addHandler(SIGTERM, array($this, 'terminate')); //    SIGINT $this-&gt;signalHandler-&gt;addHandler(SIGINT, array($this, 'terminate')); while(true) { $this-&gt;signalHandler-&gt;dispatch(); //   echo " \n"; usleep(300000); } } public function terminate() { //  SIGTERM  // ... echo "terminate\n"; exit(0); } }</span></span></code> </pre><br>  For 5.3 and above, the example is similar, only you need to connect src / gte5.3 / Mougrim / Pcntl / SignalHandler.php and use the class \ Mougrim \ Pcntl \ SignalHandler. <br><br><h2>  findings </h2><br>  1) If you are using PHP 5.3 or higher and want to avoid implicit problems, <b>do not use the declare clause (ticks = 1);</b> <br>  2) declare (ticks = 1);  works independently of conditional constructions and function calls and works in the code that was ‚Äúloaded‚Äù into the interpreter after the declaration declare (ticks = 1); <br>  3) If you use Mougrim_Pcntl_SignalHandler in PHP 5.2, then it should connect to a file with a class or code with the main program loop in which you need to process signals; <br>  4) Since  With declare (ticks = 1), the application is slower, so you only need to declare this construct where there is signal processing. <br><br>  Who cares, the source codes of the classes \ Mougrim \ Pcntl \ SignalHandler and Mougrim_Pcntl_SignalHandler are given on the <a href="https://github.com/mougrim/php-pcntl-signal-handler">github</a> . <br><br>  * UPD. * In the <a href="http://habrahabr.ru/post/179075/">first comment,</a> PsychodelEKS suggests that even if the signal handler is called when pcntl_signal_dispatch () is called, it is still a handler and if you run a program from under it, for example through system (), then the running program cannot process signals, .to.  It will itself be a signal handler.  Therefore, I will slightly change the code of the \ Mougrim \ Pcntl \ SignalHandler class so that the handlers are called separately, as is done in Mougrim_Pcntl_SignalHandler. <br><br>  * UPD2. * Fixed bugs, as well as according to the <a href="http://habrahabr.ru/post/179075/">first commentary,</a> corrected the \ Mougrim \ Pcntl \ SignalHandler class so that direct signal processing would occur outside the handler passed to pcntl_signal () (such immediate handlers are re-entry). </div><p>Source: <a href="https://habr.com/ru/post/179075/">https://habr.com/ru/post/179075/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../179063/index.html">YouTube introduced Trends Map: visualizing user preferences on a map.</a></li>
<li><a href="../179065/index.html">Second beta released elementary OS Luna</a></li>
<li><a href="../179067/index.html">We explore the game with an arcade machine Part 1</a></li>
<li><a href="../179069/index.html">Multiple Branches and Rules Template</a></li>
<li><a href="../179071/index.html">Surprisingly, 3DS is now the best gaming platform.</a></li>
<li><a href="../179077/index.html">Why the "Great Gatsby" is still not in the public domain</a></li>
<li><a href="../179081/index.html">Speed ‚Äã‚Äãup your code and find a needle in a haystack</a></li>
<li><a href="../179083/index.html">Unicorn is again ready to communicate with C ++ programmers</a></li>
<li><a href="../179087/index.html">Turkish company captured top-level domain?</a></li>
<li><a href="../179089/index.html">Something more complicated factorial</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>