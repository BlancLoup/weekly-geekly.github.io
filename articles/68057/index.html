<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Continuous integration and code metrics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article discusses the configuration of continuous integration process with code metrics. It is supposed to work with java code and libraries: jun...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Continuous integration and code metrics</h1><div class="post__text post__text-html js-mediator-article">  This article discusses the configuration of continuous integration process with code metrics.  It is supposed to work with java code and libraries: junit, cobertura, findbugs.  We use ant as the build system, and the process will be controlled from the cruise control.  As scm there will be some git. <br><br>  What do we get in the end?  Java project with ant'ovskim build script.  The build will result in a compiled project and a set of metrics: reports on junit tests, the percentage of code covered by tests, and a report on potential errors.  In addition, the entire build process will be done daily automatically and the entire history of the metrics is saved for group reports. <br><img src="https://habrastorage.org/getpro/habr/post_images/1cb/15d/2ee/1cb15d2ee6d308a5ee7e0eb853733a6f.png" alt="image"><br><a name="habracut"></a><br><br><h4>  Raw material </h4><br>  As a starting point we take any java project.  The project must contain at least several classes with several unit tests.  You do not need to cover 100% of the code - so as not to see the absolute values ‚Äã‚Äãin the reports. <br>  An example of a finished project can be downloaded <a href="">HERE</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  What we need and where to download </h4><br>  We assume you already have java, if not, then it's time to install the package. <br>  Install ant.  Download <a href="http://ant.apache.org/">HERE</a> , unpack and add the path to ant / bin in PATH <br><br>  JUnit we swing <a href="http://www.junit.org/">HERE</a> and we place junit.jar in ant / lib <br>  Findbugs download <a href="http://findbugs.sourceforge.net/">here</a> , unpack and add finbugs-ant.jar to ant / lib <br>  Cobertura <a href="http://cobertura.sourceforge.net/">from here</a> , and just unpack it on the screw. <br><br><h4>  Build setup </h4><br>  First, we configure the project to compile from the command line.  To do this, create a build.xml in the root of the project and place it in it <br><br> <code>&lt;target name="compile" depends="init"&gt; <br> &lt;javac destdir="bin" debug="yes"&gt; <br> &lt;src path="src" /&gt; <br> &lt;/javac&gt; <br> &lt;/target&gt; <br></code> <br><br>  We define the goal ‚Äúcompile‚Äù, and we can accomplish it by calling the command line <br> <code>ant compile</code> <br>  The depends attribute causes the init target to be compiled to compile.  The preliminary target creates all the necessary directories. <br><br><h4>  Adding tests </h4><br>  As many already know, in the modern world of software development it is impossible to do without unit testing.  Our test project is no exception.  It contains several JUnit tests for some of the functionality. <br>  The automatic build should run all the tests and write a report: how many tests in total, how many were completed successfully. <br>  When working with large customers, there is a requirement for a percentage of code coverage of tests.  To calculate this metric, we will use cobertura. <br>  Cobertura can work as a standalone application, generating html reports.  But for automated testing we will use ant plugin and reporting in xml format. <br>  A few words about the mechanism for calculating coverage. <br>  First, there are two types of coatings: code lines covering, and branches covering.  Line coverage simply counts the total number of lines in a project, and how many of them were affected by the tests.  Branch coverage allows for branching code. <br>  To calculate statistics on coverage, we must compile the code in a special way so that cobertura adds its markers to it.  During junit work, these markers calculate the coverage. <br>  Adding markers is an extremely simple process; it is enough to add the cobertura library to the classpath. <br>  Let's do it. <br>  The previous ant target simply compiled the project, the next target does the same, but with markers and saves the classes in a separate folder: <br><br> <code>&lt;target name="cobertura" depends="compile"&gt; <br> &lt;javac destdir="bin-cob" debug="yes"&gt; <br> &lt;classpath refid="cobertura.classpath" /&gt; <br> &lt;src path="src" /&gt; <br> &lt;/javac&gt; <br> &lt;cobertura-instrument&gt; <br> &lt;fileset dir="./bin-cob"&gt; <br> &lt;include name="**/*.class" /&gt; <br> &lt;exclude name="**/*Test.class" /&gt; <br> &lt;/fileset&gt; <br> &lt;/cobertura-instrument&gt; <br> &lt;/target&gt; <br></code> <br><br>  In addition, we exclude test classes from coverage calculation. <br><br>  The next step is testing: <br><br> <code>&lt;target name="test" depends="cobertura"&gt; <br> &lt;junit fork="yes" printsummary="yes"&gt; <br> &lt;sysproperty key="net.sourceforge.cobertura.datafile" file="cobertura.ser" /&gt; <br> &lt;classpath refid="cobertura.classpath" /&gt; <br> &lt;!-- Note! Test are run against classes compiled with cobertura marks --&gt; <br> &lt;classpath refid="classpath.bin-cob" /&gt; <br> &lt;formatter type="xml"/&gt; <br> &lt;batchtest fork="yes" todir="reports"&gt; <br> &lt;fileset dir="./src"&gt; <br> &lt;include name="**/*Test.java"/&gt; <br> &lt;/fileset&gt; <br> &lt;/batchtest&gt; <br> &lt;/junit&gt; <br> &lt;!-- make xml report --&gt; <br> &lt;cobertura-report srcdir="${src.dir}" destdir="reports" format="xml" /&gt; <br> &lt;!-- make html report --&gt; <br> &lt;cobertura-report destdir="coveragehtml"&gt; <br> &lt;fileset dir="./src"&gt; <br> &lt;include name="**/*.java"/&gt; <br> &lt;/fileset&gt; <br> &lt;/cobertura-report&gt; <br> &lt;/target&gt; <br></code> <br><br>  This target performs two steps: testing the code and generating a coverage report. <br>  Thanks to the markers, cobertura writes the test execution process to the cobertura.ser file.  The next step uses ser to generate the xml report in the reports folder.  Also generated html report. <br><br><h4>  Adding Error Detector </h4><br>  Testing and coverage are already quite important metrics that indirectly speak about the quality of development.  The next plugin will not just give an informational report, it will help to avoid programming errors. <br><br>  Findbugs is a system for analyzing code for programming errors, it notices duplication of code, incorrect design of methods, and so on. <br><br>  Add another target: <br><br> <code>&lt;target name="findbugs" depends="test"&gt; <br> &lt;findbugs home="${findbugs.home}" <br> output="xml" <br> outputFile="reports/findbugs.xml" &gt; <br> &lt;sourcePath path="./src/" /&gt; <br> &lt;class location="./bin/" /&gt; <br> &lt;/findbugs&gt; <br> &lt;/target&gt; <br></code> <br><br>  The result of the work will be an xml report of potential problems.  If html is specified as output, then the report will be presented in a more readable form. <br><br><h4>  Saving history </h4><br>  At this point, you have finished build.xml, with the project build and metrics.  With each build, the system will do a new build and rewrite reports.  We will tune up the system for keeping a history of changes.  For this we will use the web service <a href="http://www.codemetric.org/">codemetric.org</a> and our reports will be available in the form: <a href="http://demo.codemetric.org/">demo.codemetric.org</a> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1cb/15d/2ee/1cb15d2ee6d308a5ee7e0eb853733a6f.png" alt="image"><br><br>  First, you need to register at <a href="http://www.codemetric.org/">www.codemetric.org</a> , create a space, group and build.  After that, your profile will display the name of the build with its ID and token.  These numbers along with your id are needed to configure the next ant plugin <br>  First, download the plugin for the report service and write it to the lib of your ant. <br>  <a href="">http://www.codemetric.org/codemet.jar</a> <br><br>  Add another target: <br><br> <code>&lt;taskdef name="publish" classname="org.codemetric.ant.Publish"/&gt; <br> &lt;target name="success"&gt; <br> &lt;publish <br> user="123456" <br> build="234567" <br> token="345678" <br> reports="reports" <br> /&gt; <br> &lt;/target&gt; <br></code> <br><br>  Specify user, build and token values ‚Äã‚Äãfrom your profile.  reports is the path to previously generated reports. <br>  Fulfill our goal <br> <code>ant success</code> <br>  The script should confirm that the history was saved to the server, after which you can see it in your .codemetric.org <br><br><h4>  Let's go to cruise </h4><br>  So.  At the moment we have a Java project with an assembly script that performs tests, calculates metrics and saves history.  The only inconvenience is that this happens in manual mode. <br>  Let's automate this process. <br>  Continuous integration is the practice of automatically building a project based on a certain schedule ‚Äî for example, once a day.  So  the whole team makes successful commits, and the server can check at the end of the day that there are no conflicts and so on. <br>  Read more about CI in wikipedia. <br><br>  Set up a CruiseControl to check our project every minute. <br>  The scenario is as follows: <br><ul><li>  pick up changes from a certain repository </li><li>  check for changes </li><li>  build </li><li>  if successful, send report </li></ul><br><br>  Recall that we have: there is a project, there is a build script, there is a goal for publishing a report.  And we lack a certain central repository. <br>  In principle, any scm system will do, but we will try git. <br>  We assume that git is already installed <br>  Copy your project to the root of the disk. <br>  Go to <b>/ testproject</b> and execute <br> <code>git init</code> <br>  - this will create a new repository.  The project should contain only the src and build.xml folder <br>  Add all project files: <br> <code>git add <br> git commit -m "init import"</code> <br>  Now you have your repository with the project inside.  Let's go to the setting of cruisecontrol. <br>  First, download it <a href="http://cruisecontrol.sourceforge.net/">here</a> and unpack it. <br>  In the projects folder you need to create a working copy of your project using git.  Run in the projects folder <br> <code>git clone /testpoject</code> <br>  You will see a new working copy.  Now you can go directly to writing configuration for cruise. <br>  Open the config.xml file in the cruise folder and delete or comment out the project available by default.  The resulting configuration file is: <br><br> <code>&lt;cruisecontrol&gt; <br> <br> &lt;project name="testproject"&gt; <br> <br> &lt;bootstrappers&gt; <br> &lt;gitbootstrapper localWorkingCopy="projects/${project.name}/" /&gt; <br> &lt;/bootstrappers&gt; <br> <br> &lt;modificationset quietperiod="30"&gt; <br> &lt;git LocalWorkingCopy="projects/${project.name}"/&gt; <br> &lt;/modificationset&gt; <br> <br> &lt;schedule interval="60"&gt; <br> &lt;ant anthome="/home/andrew/temp/apache-ant-1.7.1" antWorkingDir="projects/${project.name}/"/&gt; <br> &lt;/schedule&gt; <br> <br> &lt;publishers&gt; <br> &lt;onsuccess&gt; <br> &lt;antpublisher anthome="/home/andrew/temp/apache-ant-1.7.1" target="success" antWorkingDir="projects/${project.name}/" /&gt; <br> &lt;/onsuccess&gt; <br> &lt;/publishers&gt; <br> <br> &lt;/project&gt; <br> &lt;/cruisecontrol&gt; <br></code> <br><br>  We describe what each group does: <br>  Bootstrappers is executed before the build cycle and actually takes the changes from the native repository. <br>  After this modificationset checks if the files in the local copy have been changed.  If there are no changes, the assembly will be postponed. <br>  Schedule is the actual scheduler - bootstrappers and modificationset are automatically executed before the steps described in the schedule. <br>  Last group of publishers.  It depends on the result of the assembly, and is executed if successful.  Ideally, you need to prescribe logic for reporting errors ‚Äî for example, a letter from team lead. <br><br>  ps <br><br>  If you want to use another scm (cvs, svn), just mark the bootstrapper and modification set. <br><br>  More information about all the options cruise can be read <a href="http://cruisecontrol.sourceforge.net/main/configxml.html">here</a> . <br><br>  Andrew Romanenco <br>  <a href="http://www.romanenco.com/">www.romanenco.com</a> </div><p>Source: <a href="https://habr.com/ru/post/68057/">https://habr.com/ru/post/68057/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../68044/index.html">YouSticker - 14 days later</a></li>
<li><a href="../68045/index.html">Mobile story. ARM, Atom, X86, PDA, UMPC and other letters and numbers ...</a></li>
<li><a href="../68047/index.html">32-bit Java 6 for Mac</a></li>
<li><a href="../68050/index.html">TED showed wireless electricity</a></li>
<li><a href="../68053/index.html">What will we see in Visio 2010?</a></li>
<li><a href="../68059/index.html">ŒúTorrent automatic speed control based on user activity</a></li>
<li><a href="../68061/index.html">WebOS Development - First Steps</a></li>
<li><a href="../68065/index.html">Black hole market in the range of cost sites?</a></li>
<li><a href="../68066/index.html">WPF Browser</a></li>
<li><a href="../68067/index.html">Convenient addition to IE when writing reviews</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>