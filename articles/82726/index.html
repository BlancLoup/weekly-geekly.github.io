<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>XSS protection in Rails 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most likely you already know that, by default, Rails 3 adds protection against XSS attacks. This means that from now on you will never have to manuall...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>XSS protection in Rails 3</h1><div class="post__text post__text-html js-mediator-article"> Most likely you already know that, by default, Rails 3 adds protection against XSS attacks.  This means that from now on you will never have to manually filter user input using the <code>h</code> helper, because rails will always do it for you. <br><br>  However, everything is not as simple as it seems at first glance.  Consider the following code: <br><blockquote> <code> &lt;strong&gt;&lt;/strong&gt;! <br> <br> &lt;%= tag(:p, some_text) %&gt; <br> &lt;%= some_text %&gt; <br></code> <br></blockquote><a name="habracut"></a>  In the example above, we have several different cases involving the use of HTML tags.  In the first case, Rails should not filter the <code>&lt;strong&gt;</code> that surrounds the word <code></code> , because  The result is clearly not what the user entered.  In the second case, Rails should filter <code>some_text</code> inside the <code>&lt;p&gt;</code> (but not the whole <code>&lt;p&gt;</code> ).  Finally, in the third case, <code>some_text</code> in some parent tag must be filtered. <br><br>  In case <code>some_text</code> looks like the result will be: <blockquote> <code> &lt;strong&gt;&lt;/strong&gt;! <br> <br> &lt;p&gt;&amp;lt;script&amp;gt;evil_js&amp;lt;/script&amp;gt;&lt;/p&gt; <br> &amp;lt;script&amp;gt;evil_js&amp;lt;/script&amp;gt;</code> </blockquote>  In order for this to work everywhere in Rails applications, we have implemented a new approach called <b><code>html_safe</code></b> .  So, if the string is <code>html_safe</code> (as determined by calling the <code>html_safe?</code> method <code>html_safe?</code> On the string), the ERB leaves it untouched.  If the string is not <code>html_safe</code> , the ERB will filter it before inserting it into the page. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote> <code>def tag(name, options = nil, open = false, escape = true) <br> "&lt;#{name}#{tag_options(options, escape) if options}#{open ? "&gt;" : " /&gt;"}".html_safe <br> end</code> </blockquote>  Here, Rails creates the tag, <code>teg_options</code> filter the contents, and then marks the entire body of the tag as safe.  As a result, <code>&lt;p&gt;</code> and <code>&lt;/p&gt;</code> will remain untouched, while user-inserted content will be subject to filtering. <br><br>  In the first implementation, in <a href="http://github.com/nzkoz/rails_xss" title="rails xss">the</a> <a href="http://www.koziarski.com/" title="Michael Koziarski">Koz</a> rails-xss plugin, the specified conditions were fulfilled by adding a special flag to all lines.  The Rails application marked the lines as safe, while Rails itself redefined the <code>+</code> and <code>&lt;&lt;</code> methods so that, if the line was changed, it marked the resulting one accordingly. <br><br>  However, during my last performance test of rails, I noticed that redefining each string concatenation results in a rather severe drop in performance.  Moreover, this drop depended linearly on the number of inserts <code>&lt;%= %&gt;</code> in the template, i.e.  large templates did not absorb the cost (as if it were one call <code>&lt;%= %&gt;</code> per template), but only increased it. <br><br>  Thinking more about the problem, it became clear (as Koz, Jeremy and Evan Phoenix from Rubunius confirmed later) that we could implement exactly the same features in a more productive way, with even less impact on the Ruby API.  Since the problem itself is quite complicated, I will not go into details describing the old implementation, but I will explain how to use the new XSS protection.  If you happened to use the Koz plugin earlier or you are already working with preliminary releases of Rails, you will notice that this commit doesn‚Äôt change much. <br><br><h4>  Safe buffer </h4><br>  In Rails 3, the ERB buffer is an instance of <code>ActiveSupport::SafeBuffer</code> .  SafeBuffer is inherited from <code>String</code> 'a, overriding <code>+</code> , <code>concat</code> and <code>&lt;&lt;</code> in such a way that: <br><ul><li>  if the other string is safe (i.e., is SafeBuffer), the buffer simply concatenates </li><li>  if the other string is unsafe (i.e., is a simple String), the buffer performs filtering and then concatenation </li></ul>  Calling <code>html_safe</code> on a simple string returns a <code>SafeBuffer</code> wrapper.  Since <code>SafeBuffer</code> inherited from the timeline, Ruby creates a wrapper extremely efficiently (only by sharing the internal storage <code>char*</code> ). <br><br>  As a result of this implementation, I started to see this way of recording: <br><blockquote> <code>buffer &lt;&lt; other_string.html_safe</code> </blockquote>  Here, Rails creates a new <code>SafeBuffer</code> for <code>other_string</code> , then passes it to the <code>&lt;&lt;</code> source <code>SafeBuffer</code> 's method, which (method) checks if the new <code>SafeBuffer</code> safe.  For such cases, <code>safe_concat</code> was written - a new method for the buffer, which uses the original concat method, eliminating the need to create a new <code>SafeBuffer</code> and check it for security. <br><br>  Similarly, concat and <code>safe_concat</code> in <code>ActionView</code> are proxies for concat and <code>safe_buffer</code> over the buffer, so you can use safe_concat in the helper if you have HTML text that needs to be combined with the buffer without checking and filtering. <br><br>  ERB internally uses <code>safe_concat</code> everywhere on the template outside the <code>&lt;% %&gt;</code> <code>safe_concat</code> <code>&lt;% %&gt;</code> tags.  This means that, in my today's commit, the XSS protection code does not affect the performance in such cases (i.e., scanning, in fact, all your plain text). <br><br>  Finally, ERB now knows about the <code>raw</code> helper, so if you write something like <code>&lt;%= raw some_stuff %&gt;</code> , ERB quietly uses <code>safe_concat</code> , skipping the creation of <code>SafeBuffer</code> 'a and <code>html_safety</code> checks. <br><br><h4>  findings </h4><br>  In short, ‚ÄúXSS protection‚Äù means the following: <br><ul><li>  if a regular string is supplied to <code>&lt;%= %&gt;</code> , Rails will always filter it </li><li>  if <code>SafeBuffer</code> is served in <code>&lt;%= %&gt;</code> , Rails does not filter it.  To get <code>SafeBuffer</code> from a string, you need to call the <code>html_safe</code> method on it.  Does the XSS protection system have a very small impact on speed, limited only by the <code>html_safe?</code> method <code>html_safe?</code> </li><li>  if you pass <code>raw</code> helper in <code>&lt;%= %&gt;</code> , then Rails will detect this at the stage of compiling the template, without affecting the performance (i.e. in this case, no <code>html_safe</code> checks <code>html_safe</code> ) </li><li>  at <i>runtime,</i> Rails does not filter any parts of the template outside of <code>&lt;% %&gt;</code> , since it copes with this at compile time, resulting, again, in the absence of an impact on performance </li></ul>  For comparison, in the original XSS implementation, it affected every concatenation or <code>+</code> for strings;  influenced even if the application used <code>raw</code> helper, or any other concatenation outside <code>&lt;% %&gt;</code> inside the template. <br><br>  However, I would like to express my personal thanks to Michael Koziarsky, who provided a draft implementation of his idea.  She worked, demonstrated the concept, and the community tested it to the full.  In the end, she gave a good start. </div><p>Source: <a href="https://habr.com/ru/post/82726/">https://habr.com/ru/post/82726/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../82720/index.html">Aerial view service interface</a></li>
<li><a href="../82721/index.html">Multitouch in Wacom interactive displays: a new evolution?</a></li>
<li><a href="../82722/index.html">NIXP.RU v3.0 Beta - portal for UNIX / Linux / FLOSS enthusiasts</a></li>
<li><a href="../82724/index.html">Introduction to Continuous Integration</a></li>
<li><a href="../82725/index.html">Rubik's Cube is back</a></li>
<li><a href="../82727/index.html">Dante, we learn any software to work through socks proxy</a></li>
<li><a href="../82728/index.html">Equilateral triangle of A4 paper</a></li>
<li><a href="../82730/index.html">Wooden toys or How I wrote mobile games from my phone</a></li>
<li><a href="../82731/index.html">CSS template for writing Drupal admin styles</a></li>
<li><a href="../82732/index.html">Golden Grid CSS: PSD Template</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>