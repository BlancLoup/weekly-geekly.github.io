<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Changing the code of system assemblies or "leak". Net Framework 5.0</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Here I will demonstrate the opportunity, which in its essence is a real hack. The question is why this may be needed? In fact, the goals for this can ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Changing the code of system assemblies or "leak". Net Framework 5.0</h1><div class="post__text post__text-html js-mediator-article">  Here I will demonstrate the opportunity, which in its essence is a real hack.  The question is why this may be needed?  In fact, the goals for this can be a huge set.  So our task is to change the code of the <b>mscorlib</b> library so that all the programs that use it get these changes.  Not runtime, of course, but during the start (for runtime, you need to do other things, and here we must make a reservation that these changes should not break the current state of the library).  I took Mscorlib as an example, because everyone has it on the computer.  But you can hack any other. <br><br>  We all know that in order to avoid the ‚Äúhell dll‚Äù, in addition to the regular versions and library names, Microsoft was given the opportunity to sign assemblies with a key, the public key of which guarantees that a specific assembly ‚Äúcame‚Äù from a specific developer, and not from other.  Therefore, if for some reasonably bona fide reason we want to change the code of the existing library so that it is loaded into the foreign process and the public key remains the same, we will not succeed.  Because we can not sign it, we do not have a private key. <br><br>  Our mini goal is for the program to display the text on the console: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/8c6/0f0/e3d/8c60f0e3d36248ce86ae82a76f5d6997.png"><br><br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">To begin with, the full list of articles posted on this cycle in Habr√©</b> <div class="spoiler_text"> <a href="http://habrahabr.ru/company/luxoft/blog/247491/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/247491/">We make shipped assemblies: we interact between domains without marshalling</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/219619/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/219619/">Getting a pointer to a .Net object</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/238947/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/238947/">Manual stream cloning.</a>  <a href="http://habrahabr.ru/company/luxoft/blog/238947/">When Assembler + C # or Java = Love</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/239005/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/239005/">Changing the code of system assemblies or "leak". Net Framework 5.0</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/244095/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/244095/">How does decompilation in .Net or Java using the example .Net</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/247433/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/247433/">Continuing to shred CLR: .Net object pool outside SOH / LOH heaps</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/247447/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/247447/">Remove objects dump from .Net application memory</a> <br></div></div><br>  Summary: <br><ol><li>  <a href="https://habr.com/ru/company/luxoft/blog/239005/">Introduction</a> </li><li>  <a href="https://habr.com/ru/company/luxoft/blog/239005/">Driver Development</a> </li><li>  <a href="https://habr.com/ru/company/luxoft/blog/239005/">Conclusions on driver development</a> </li><li>  <a href="https://habr.com/ru/company/luxoft/blog/239005/">Writing a Windows service</a> </li><li>  <a href="https://habr.com/ru/company/luxoft/blog/239005/">Code change mscorlib.dll</a> </li><li>  <a href="https://habr.com/ru/company/luxoft/blog/239005/">Research results</a> </li></ol><br><a name="Intro"></a><br><h2>  <font color="#0e3d78">Introduction</font> </h2><br>  Today we will talk about assemblies that are in the GAC and in the NAC.  I found out that the .NET Framework is very sensitive to the structure of the GAC.  He trusts her so much that he loads the assemblies from there, without really checking the version number.  Therefore, in order to make a substitution, we need not so much: we need to write a kernel-level driver in order to redirect calls to certain files to another place.  I used the filesystem filters feature for this.  The essence is simple: in order not to write a lot of code in the driver itself, a protocol is written between Kernel-space and user-space.  From the user-space side, a windows - service application appears.  It communicates with the driver, gives him commands, what to redirect.  And that in turn redirects.  In order to change the code of an existing library, for example, mscorlib, you can use either Reflexil or Mono :: Cecil. <br><br>  Procedure: <br><ul><li>  Change the assembly (Reflexil or Mono :: Cecil) by assembling mscorlib and get the modified assembly.  For example, we build in it logging; </li><li>  Put the result in the tmp directory; </li><li>  Add the redirection "C: \ Windows \ Microsoft .NET \ assembly \ GAC_64 \ mscorlib \ v4.0_4.0.0.0__b77a5c561934e089 \ mscorlib.dll" to, for example, "C: \ tmp \ mscorlib64.dll" - the modified assembly. </li></ul><br>  And we receive on subsequent launches of all applications on .net logging of the system library.  For order, it is necessary that the driver also filters by process numbers, to whom specifically to give the "leftist", and to whom - the original library. <br><br><a name="Driver"></a><br><h2>  <font color="#0e3d78">Driver Development</font> </h2><br>  To begin, install VirtualBox.  We need it to debug the driver.  We don‚Äôt want to restart every time our driver addresses the wrong addresses and crashes with an error (naturally, with a BSOD).  On virtualki we roll images of Windows XP and Windows 7, x86 and x64 and remove snapshots so that there is much to roll back. <br><br>  Next, install on the developer machine VisualDDK, WinDDK, and other infrastructure for developing drivers. <br><br>  Next, write the driver itself.  I will not post full listings, but only their important parts.  I will make a reservation just write we Minifilter Filesystem Driver. <br><br>  1) Filter Registration: <br><pre><code class="hljs ruby">const FLT_OPERATION_REGISTRATION Callbacks[] = { { IRP_MJ_CREATE, <span class="hljs-number"><span class="hljs-number">0</span></span>, PbPreOperationCreateCallback, PbPostOperationCreateCallback }, { IRP_MJ_NETWORK_QUERY_OPEN, <span class="hljs-number"><span class="hljs-number">0</span></span>, PbPreOperationNetworkQueryOpenCallback, NULL }, { IRP_MJ_OPERATION_END } }; CONST FLT_REGISTRATION FilterRegistration = { sizeof( FLT_REGISTRATION ), <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Size FLT_REGISTRATION_VERSION, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Version <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Flags NULL, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Context Callbacks, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Operation callbacks PtFilterUnload, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> FilterUnload PtInstanceSetup, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> InstanceSetup PtInstanceQueryTeardown, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> InstanceQueryTeardown PtInstanceTeardownStart, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> InstanceTeardownStart PtInstanceTeardownComplete, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> InstanceTeardownComplete PtGenerateFileName, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> GenerateFileName PtNormalizeNameComponent /<span class="hljs-regexp"><span class="hljs-regexp">/ NormalizeNameComponent };</span></span></code> </pre> <br><br>  It's simple.  Enter the structure for registering the filter driver.  The filter will work on all volumes, and intercept the CreateFile operation (create / open file) <br><br>  Driver initialization should also not cause questions from experienced people.  Just list what happens here: <br><ul><li>  the driver is registered in the system </li><li>  notification is made that will notify us of new processes in the system </li><li>  Communitation Port rises to communicate with the user level (3 protection ring, Windows applications), where the Windows service awaits us, which will be described below </li></ul><br><br><pre> <code class="cpp hljs">CPP_DRIVER_ENTRY ( __in PDRIVER_OBJECT DriverObject, __in PUNICODE_STRING RegistryPath ) { <span class="hljs-comment"><span class="hljs-comment">/* locals */</span></span> NTSTATUS status; OBJECT_ATTRIBUTES attr; UNICODE_STRING portName; PSECURITY_DESCRIPTOR securityDescriptor; <span class="hljs-comment"><span class="hljs-comment">/* unused */</span></span> UNREFERENCED_PARAMETER( RegistryPath ); <span class="hljs-comment"><span class="hljs-comment">/* code */</span></span> __try { <span class="hljs-comment"><span class="hljs-comment">// Set DRIVER_DATA to zeroes memset(&amp;DRIVER_DATA, 0, sizeof(DRIVER_DATA)); /* Setup process creation callback */ status = Xu(&amp;PsProcessNotify, FALSE); if( !NT_SUCCESS( status )) __leave; SetFlag(DRIVER_DATA.initialized, FILTER_SUBSYSTEM_PROCESS); // Get exported OS functions DECLARE_CONST_UNICODE_STRING( Func1, L"IoReplaceFileObjectName" ); // Win7+ DRIVER_DATA.pfnIoReplaceFileObjectName = (PIOREPLACEFILEOBJECTNAME) MmGetSystemRoutineAddress((PUNICODE_STRING) &amp;Func1 ); // Register filter status = FltRegisterFilter( DriverObject, &amp;FilterRegistration, &amp;DRIVER_DATA.fltHandle ); if ( !NT_SUCCESS( status )) __leave; SetFlag(DRIVER_DATA.initialized, FILTER_SUBSYSTEM_DRIVER); FltInitializePushLock(&amp;DRIVER_DATA.Sync); SetFlag(DRIVER_DATA.initialized, FILTER_SUBSYSTEM_LOCK); // Setup security descriptor status = FltBuildDefaultSecurityDescriptor( &amp;securityDescriptor, FLT_PORT_ALL_ACCESS ); if ( !NT_SUCCESS( status )) __leave; RtlInitUnicodeString( &amp;portName, PbCommPortName ); InitializeObjectAttributes( &amp;attr, &amp;portName, OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE, NULL, securityDescriptor ); status = FltCreateCommunicationPort( DRIVER_DATA.fltHandle, &amp;DRIVER_DATA.Connection.ServerPort, &amp;attr, NULL, CommPortConnect, CommPortDisconnect, CommPortMessageNotify, 1 ); if ( !NT_SUCCESS( status )) __leave; SetFlag(DRIVER_DATA.initialized, FILTER_SUBSYSTEM_COMPORT); // Free the security descriptor in all cases. It is not needed once the call to FltCreateCommunicationPort( ) is made. FltFreeSecurityDescriptor( securityDescriptor ); if ( !NT_SUCCESS( status )) __leave; // Start filtering i/o status = FltStartFiltering( DRIVER_DATA.fltHandle ); if ( !NT_SUCCESS( status )) __leave; ASSERT( NT_SUCCESS( status ) ); DRIVER_DATA.State = DRIVER_STATE_STARTED; } __finally { if(!NT_SUCCESS( status )) { DeregisterFilter(); } } return status; }</span></span></code> </pre><br><br>  Exiting the filter is also simple: <br>  I can only say that <b>DeregisterFilter</b> is engaged in the release of all resources.  based on the set flags in DRIVER_DATA.Initialized (see code above) <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">NTSTATUS </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PtFilterUnload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( __in FLT_FILTER_UNLOAD_FLAGS Flags )</span></span></span><span class="hljs-function"> </span></span>{ UNREFERENCED_PARAMETER( Flags ); PAGED_CODE(); DeregisterFilter(); DbgPrint(<span class="hljs-string"><span class="hljs-string">"PoliciesSandbox!PtFilterUnload: Entered\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> STATUS_SUCCESS; }</code> </pre><br><br>  Further.  Now we need to know what and where to redirect.  What file and where.  For this, I made a small protocol between the kernel-mode and user-mode via communication port, which we raised in DriverEntry <br><br>  Define a set of commands: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> { <span class="hljs-comment"><span class="hljs-comment">// From verson = v1.0 // From User-space to Kernel-space GetVersion, GetFilesystemRedirections, AddFilesystemByPIDRedirection, RemoveFilesystemByPIDRedirection, GetRegistryRedirections, AddRegistryByPIDRedirection, RemoveRegistryByPIDRedirection, // From Kernel-space to User-space ProcessAttached, CancelIOCompletionPort // Version v2.0 is here } COMM_COMMAND;</span></span></code> </pre><br><br>  We determine the structure of the base of all commands: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> COMM_COMMAND Command; USHORT Data[]; } COMM_MESSAGE, *PCOMM_MESSAGE;</code> </pre><br><br>  We define the structure sent to the Windows service to notify about the new process in the system: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> ULONG Pid; } COMM_PROCESS_ATTACHED, *PCOMM_PROCESS_ATTACHED;</code> </pre><br><br>  We define the structure of the response: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> USHORT NeedToMonitor; USHORT IsCompleted; <span class="hljs-comment"><span class="hljs-comment">// true, if this packet contains all redirections, needed by driver. Otherwice, driver needs to ask more USHORT PairsCount; // redirections count. Actually, count of null-terminated strings in Data struct { // positions of redirections to make searching fast USHORT From; USHORT To; } Positions[64]; WCHAR Data[]; } COMM_FS_REDIRECTIONS, *PCOMM_FS_REDIRECTIONS;</span></span></code> </pre><br><br>  We also introduce structures for storing data in the driver: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MAPPING_ENTRY</span></span></span><span class="hljs-class"> {</span></span> UNICODE_STRING OldName; UNICODE_STRING NewName; _MAPPING_ENTRY *Next; } MAPPING_ENTRY, *PMAPPING_ENTRY; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PROCESSES_MAP_ENTRY</span></span></span><span class="hljs-class"> {</span></span> ULONG Pid; PMAPPING_ENTRY entries; _PROCESSES_MAP_ENTRY *Prev, *Next; } PROCESSES_MAP_ENTRY, *PPROCESSES_MAP_ENTRY;</code> </pre><br><br>  Now, when everything is determined, it is necessary at the start of a new process (and we are already intercepting it) to notify about this service, which, as an answer, will give us a set of rules for redirecting files and folders depending on this process. <br><br>  I will not include the code of memory-clearing functions, since  it's not so interesting. <br>  When a function is called, it is passed to the process that created it, created it and whether the process is created or it dies.  Those.  the function notifies us of the creation and death of the process. <br><br>  Inside it, if a process is being created, we notify the Windows service of this by passing the PID of the process.  Therefore, the PID service finds a list of the redirect rules and gives them to us as an answer: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">VOID </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PsProcessNotify</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( IN HANDLE ParentId, IN HANDLE ProcessId, IN BOOLEAN Create )</span></span></span><span class="hljs-function"> </span></span>{ NTSTATUS status; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( HandleToULong( ProcessId ) &lt;= <span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Check exsisting data */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Create) { LARGE_INTEGER liTimeout; DbgPrint(<span class="hljs-string"><span class="hljs-string">"Process created: %x"</span></span>, ProcessId); liTimeout.QuadPart = -((LONGLONG)<span class="hljs-number"><span class="hljs-number">1</span></span> * <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>); ULONG SenderBufferLength = MESSAGE_BUFFER_SIZE; ULONG ReplyLength = MESSAGE_BUFFER_SIZE; PCOMM_MESSAGE message = (PCOMM_MESSAGE)myNonPagedAlloc(MESSAGE_BUFFER_SIZE); message-&gt;Command = ProcessAttached; ((PCOMM_PROCESS_ATTACHED)(&amp;message-&gt;Data[<span class="hljs-number"><span class="hljs-number">0</span></span>]))-&gt;Pid = HandleToULong(ProcessId); status = FltSendMessage(DRIVER_DATA.fltHandle, &amp;DRIVER_DATA.Connection.ClientPort, message, SenderBufferLength, message, &amp;ReplyLength, &amp;liTimeout); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ReplyLength &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { PCOMM_FS_REDIRECTIONS Redirections = (PCOMM_FS_REDIRECTIONS)&amp;message-&gt;Data[<span class="hljs-number"><span class="hljs-number">0</span></span>]; DbgPrint(<span class="hljs-string"><span class="hljs-string">"Recieved reply from user-mode: NeedToMonitor = %s\n"</span></span>, Redirections-&gt;NeedToMonitor ? <span class="hljs-string"><span class="hljs-string">"TRUE"</span></span> : <span class="hljs-string"><span class="hljs-string">"FALSE"</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Redirections-&gt;NeedToMonitor) { PbRepInitializeMapping(HandleToULong(ProcessId), Redirections); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { DbgPrint(<span class="hljs-string"><span class="hljs-string">"Thread %d not needed to be monitored. Skipping."</span></span>, HandleToULong(ProcessId)); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!message) myFree(message); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { DbgPrint(<span class="hljs-string"><span class="hljs-string">"Process destroyed: %x\n"</span></span>, ProcessId); PPROCESSES_MAP_ENTRY entry = DRIVER_DATA.Mapping; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>( entry != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(entry-&gt;Pid == HandleToULong(ProcessId)) { PbRepDeleteMapping(entry); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } }</code> </pre><br><br>  The code below simply initializes the internal structures relative to the data that came from the Windows service: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">NTSTATUS </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PbRepInitializeMapping</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( __in ULONG pid, __in PCOMM_FS_REDIRECTIONS Redirections )</span></span></span><span class="hljs-function"> </span></span>{ NTSTATUS status = STATUS_SUCCESS; FltAcquirePushLockExclusive( &amp;DRIVER_DATA.Sync ); __try { DbgPrint(<span class="hljs-string"><span class="hljs-string">"PlociesSandbox!PbRepInitializeMapping: redirections count: %d\n"</span></span>, Redirections-&gt;PairsCount); PMAPPING_ENTRY current = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Lookup PID in map PPROCESSES_MAP_ENTRY currentProcess = DRIVER_DATA.Mapping; while(currentProcess != NULL) { if(currentProcess-&gt;Pid == pid) { DbgPrint("PlociesSandbox!PbRepInitializeMapping: Already initialized; skipping"); return STATUS_SUCCESS; } currentProcess = currentProcess-&gt;Next; } currentProcess = (PPROCESSES_MAP_ENTRY)myNonPagedAlloc(sizeof(PROCESSES_MAP_ENTRY)); currentProcess-&gt;Pid = pid; currentProcess-&gt;Next = DRIVER_DATA.Mapping; currentProcess-&gt;Prev = NULL; if(DRIVER_DATA.Mapping != NULL) DRIVER_DATA.Mapping-&gt;Prev = currentProcess; DRIVER_DATA.Mapping = currentProcess; for(int i=0; i &lt; Redirections-&gt;PairsCount; i++) { // Copying a pair of pathes From-&gt;To to internal mapping structure int FromLen = wcslen(&amp;Redirections-&gt;Data[Redirections-&gt;Positions[i].From]); int ToLen = wcslen(&amp;Redirections-&gt;Data[Redirections-&gt;Positions[i].To]); PMAPPING_ENTRY mappingEntry = (PMAPPING_ENTRY)myAlloc(NonPagedPool, sizeof(MAPPING_ENTRY)); mappingEntry-&gt;OldName.Buffer = (WCHAR*)myAlloc(NonPagedPool, (FromLen + 1) * sizeof(WCHAR)); wcscpy(mappingEntry-&gt;OldName.Buffer, &amp;Redirections-&gt;Data[Redirections-&gt;Positions[i].From]); mappingEntry-&gt;OldName.Length = mappingEntry-&gt;OldName.MaximumLength = wcslen(mappingEntry-&gt;OldName.Buffer) * sizeof(WCHAR); mappingEntry-&gt;NewName.Buffer = (WCHAR*)myAlloc(NonPagedPool, (ToLen + 1) * sizeof(WCHAR)); wcscpy(mappingEntry-&gt;NewName.Buffer, &amp;Redirections-&gt;Data[Redirections-&gt;Positions[i].To]); mappingEntry-&gt;NewName.Length = mappingEntry-&gt;NewName.MaximumLength = wcslen(mappingEntry-&gt;NewName.Buffer) * sizeof(WCHAR); if(current == NULL) { current = mappingEntry; currentProcess-&gt;entries = current; } else { current-&gt;Next = mappingEntry; current = mappingEntry; } current-&gt;Next = NULL; } } __finally { FltReleasePushLock( &amp;DRIVER_DATA.Sync ); } DbgPrint("PlociesSandbox!PbRepInitializeMapping: done\n"); return status; }</span></span></code> </pre><br><br>  And, finally, the search function redirect rules.  If a rule is found, returns STATUS_SUCCESS and the modified path: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PbIsFolder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PUNICODE_STRING path)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> path-&gt;Buffer[path-&gt;Length/<span class="hljs-number"><span class="hljs-number">2</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>] == L'\\<span class="hljs-string"><span class="hljs-string">'; } NTSTATUS PbLookupRedirection(__in PUNICODE_STRING FilePath, __out PUNICODE_STRING *FileFound) { // Possible redirections: // Full change: \Device\HarddiskVolume2\InternalPath\Path\To\Some\File.Ext -&gt; \Device\.\Temporary\File.ext // Partial change: \Device\HarddiskVolume2\InternalPath\ -&gt; \Device\HarddiskVolume2\Temporary\ // in this case all pathes, starts with ..\InternalPath should be changed. For ex.: // \Device\HarddiskVolume2\InternalPath\Some\Path\To\File.Ext -&gt; \Device\HarddiskVolume2\Temporary\Some\Path\To\File.Ext ULONG Pid = HandleToULong(PsGetCurrentProcessId()); FltAcquirePushLockShared( &amp;DRIVER_DATA.Sync ); __try { PPROCESSES_MAP_ENTRY currentProcess = DRIVER_DATA.Mapping; while(currentProcess != NULL) { if(currentProcess-&gt;Pid == Pid) { PMAPPING_ENTRY current = currentProcess-&gt;entries; while(current != NULL) { if(PbIsFolder(&amp;current-&gt;OldName)) { // Folders prefixes are identical, please note that all lengthes are double-sized if(wcsncmp(current-&gt;OldName.Buffer, FilePath-&gt;Buffer, current-&gt;OldName.Length / 2) == NULL) { int newlength = (FilePath-&gt;Length - current-&gt;OldName.Length) + current-&gt;NewName.Length; PUNICODE_STRING ret = PbAllocUnicodeString(newlength + 2); RtlCopyUnicodeString(ret, &amp;current-&gt;NewName); RtlCopyMemory( Add2Ptr(ret-&gt;Buffer, ret-&gt;Length), Add2Ptr(FilePath-&gt;Buffer, current-&gt;OldName.Length), (FilePath-&gt;Length - current-&gt;OldName.Length) + 2); ret-&gt;Length = wcslen(ret-&gt;Buffer) * 2; *FileFound = ret; return STATUS_SUCCESS; } } else { if(wcscmp(current-&gt;OldName.Buffer, FilePath-&gt;Buffer) == NULL) { PUNICODE_STRING ret = PbAllocUnicodeString(current-&gt;NewName.Length + 2); RtlCopyUnicodeString(ret, &amp;current-&gt;NewName); *FileFound = ret; return STATUS_SUCCESS; } } current = current-&gt;Next; } } currentProcess = currentProcess-&gt;Next; } return STATUS_NOT_FOUND; } __finally { FltReleasePushLock( &amp;DRIVER_DATA.Sync ); } }</span></span></code> </pre><br><br><a name="DriverResults"></a><br><h3>  Conclusions on driver development </h3><br><br>  We have a driver that notifies the external service of creating new processes in the operating system.  Service receiving information about the process decides whether to include monitoring on it or not.  If so, also sends a list of redirection rules on the file system. <br><br><a name="WinService"></a><br><h2>  <font color="#0e3d78">Writing a Windows service</font> </h2><br>  Again, I will not go into any particular details.  This is a regular service.  The only feature is that he should expect from the driver commands and respond to them.  We will wait using IoCompletionPort.  This mechanism requires (in general, it is clear for what) that several threads are hanging while waiting for completion of I / O on the port.  When the data comes, one of the tasks wakes up and can process this data.  We in this task will send a list of redirects. <br><br>  The code may be a little unclean, but oh well.  The main thing is doing what is necessary: <br><ul><li>  FilterConnectCommunicationPort connects us with the driver </li><li>  CreateIoCompletionPort creates an i / o completion port, all links where you can read about it in the code </li><li>  MessagingManagerThread - class that controls the flow of message processing from the driver </li><li>  Stop (Stop) sends a completion command to all threads through the io completion port, otherwise everything will hang </li></ul><br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MessagingManager</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FilterCommunicationPortName = <span class="hljs-string"><span class="hljs-string">"\\PoliciesInjectorCom0"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IntPtr m_filterPortHandle; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IntPtr m_ioCompletionPortHandle; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IntPtr[] m_buffers; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MessagingManagerThread[] m_threads; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> CancellationTokenSource m_cancellationToken; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsafe</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MessagingManager</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Dictionary&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; redirections</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> hr = WinApi.FilterConnectCommunicationPort(FilterCommunicationPortName, <span class="hljs-number"><span class="hljs-number">0</span></span>, IntPtr.Zero, <span class="hljs-number"><span class="hljs-number">0</span></span>, IntPtr.Zero, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> m_filterPortHandle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(hr != <span class="hljs-number"><span class="hljs-number">0x0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> WinApi.CreateWin32Exception(String.Format(<span class="hljs-string"><span class="hljs-string">"Cannot connect to driver via '{0}' port"</span></span>, FilterCommunicationPortName)); } Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Connected to {0}"</span></span>, FilterCommunicationPortName); <span class="hljs-comment"><span class="hljs-comment">// For more info, ENG: http://msdn.microsoft.com/en-us/library/windows/desktop/aa365198(v=vs.85).aspx // For more info, RUS: http://www.rsdn.ru/article/baseserv/threadpool.xml int threadsCount = Environment.ProcessorCount * 2; m_ioCompletionPortHandle = WinApi.CreateIoCompletionPort(m_filterPortHandle, IntPtr.Zero, IntPtr.Zero, threadsCount); if(m_ioCompletionPortHandle == IntPtr.Zero) { throw WinApi.CreateWin32Exception("Cannot create I/O Completeon port"); } // Make thread for each processor and threads cancellation token m_threads = new MessagingManagerThread[threadsCount]; m_buffers = new IntPtr[threadsCount]; m_cancellationToken = new CancellationTokenSource(); Console.WriteLine("Number of threads to monitor: {0}", threadsCount); for(int i=0; i&lt;m_threads.Length; i++) { m_threads[i] = new MessagingManagerThread(m_ioCompletionPortHandle, m_cancellationToken.Token, m_filterPortHandle, redirections); unsafe { m_buffers[i] = Marshal.AllocHGlobal( sizeof(F2U.IncomingMessagePacket) ); WinApi.RtlZeroMemory( m_buffers[i], sizeof(F2U.IncomingMessagePacket) ); var buffer = (F2U.IncomingMessagePacket *) m_buffers[i]; // Make street magic (see DDK Examples-&gt;mini filters-&gt;scanner) hr = WinApi.FilterGetMessage( m_filterPortHandle, out buffer-&gt;Header, Marshal.SizeOf(typeof(F2U.IncomingMessagePacket)), ref buffer-&gt;Overlapped ); if ( hr != WinApi.HRESULT_FROM_WIN32( WinApi.ERROR_IO_PENDING ) ) { throw WinApi.CreateWin32Exception( String.Format("Cannot get filter message. 0x{0:X}", hr )); } } } } public unsafe bool Stop() { bool successfull = true; m_cancellationToken.Cancel(); Console.WriteLine("Starting to cancel I/O."); if (!WinApi.CancelIoEx(m_filterPortHandle, IntPtr.Zero)) { var errstr = String.Format("Cannot cancel I/O operations (0x{0:X}).", Marshal.GetLastWin32Error()); Console.WriteLine(errstr); successfull = false; // throw WinApi.CreateWin32Exception(errstr); } foreach(var thread in m_threads.AsEnumerable()) { var overlapped = new F2U.IncomingMessagePacket(); IntPtr *completionKey; overlapped.Message.Command = Command.CancelIOCompletionPort; WinApi.PostQueuedCompletionStatus(m_ioCompletionPortHandle, (uint)sizeof(F2U.IncomingMessagePacket), out completionKey, (NativeOverlapped *) &amp;overlapped); } foreach(var thread in m_threads.AsEnumerable()) { if(!thread.WaitHandle.WaitOne(2000)) { Console.WriteLine("Failed while waiting for thread {0} is stopped", thread.ThreadId); successfull = false; // </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> kill thread and report confusing bug } } return successfull; } }</span></span></code> </pre><br><br>  And finally, the flow service class: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MessagingManagerThread</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ManualResetEvent m_resetEvent; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IntPtr m_ioCompletionPortHandle; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IntPtr m_filterPortHandle; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> CancellationToken m_cancelToken; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Thread m_thread; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Int32 m_threadId; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; m_redirections; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> timeoutCompletionStatus = <span class="hljs-number"><span class="hljs-number">5000</span></span>; <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Builds MessagingManagerThread object </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="handle"&gt;</span></span></span><span class="hljs-comment">I/O Completion Port Handle (Win32)</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> public MessagingManagerThread(IntPtr ioCompletionPortHandle, CancellationToken token, IntPtr filterPortHandle, Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string,string&gt;</span></span></span><span class="hljs-comment"> redirections) { m_ioCompletionPortHandle = ioCompletionPortHandle; m_filterPortHandle = filterPortHandle; m_cancelToken = token; m_redirections = redirections; m_resetEvent = new ManualResetEvent(false); m_thread = new Thread( Start ); m_thread.Start(); } public WaitHandle WaitHandle { get { return m_resetEvent; } } public Int32 ThreadId { get { return m_threadId; } } public unsafe void Start() { try { // Get current thread id (unmanaged) m_threadId = WinApi.GetCurrentThreadId(); Console.WriteLine("Monitoring thread {0} is started", m_threadId); // Messages processing queue while(true) { // If cancellation requested, we should to leave thread if(m_cancelToken.IsCancellationRequested) { Console.WriteLine("Cancellation on thread {0} is requested", m_threadId); return; } // Otherwise, we should read completion port uint numberOfBytesTransferred; UIntPtr lpCompletionKey; NativeOverlapped* lpOverlapped; Console.WriteLine("Starting waiting for message at {0}... ", m_threadId); if(!WinApi.GetQueuedCompletionStatus(m_ioCompletionPortHandle, out numberOfBytesTransferred, out lpCompletionKey, out lpOverlapped, -1)) { // Something wrong happend var error = Marshal.GetLastWin32Error(); if(error == WinApi.ERROR_OPERATION_ABORTED) { return; } if(error == WinApi.WAIT_TIMEOUT) { Console.WriteLine("Time out {0}", m_threadId); continue; } Console.WriteLine("WinApi.GetQueuedCompletionStatus returns error code: {0:X}", error); throw WinApi.CreateWin32Exception("GetQueuedCompletionStatus", (uint)error); } Console.WriteLine("GetQueuedCompletionStatus finished successfully, Message is recieved"); // Message recieved var request = (F2U.IncomingMessagePacket *)lpOverlapped; if(request-&gt;Message.Command == Command.ProcessAttached) { Run_ProcessAttached(request); } else if(request-&gt;Message.Command == Command.CancelIOCompletionPort) { Console.WriteLine("Thread destroying requested"); } // Queue a new request completion. WinApi.RtlZeroMemory( (IntPtr) request, Marshal.SizeOf(request-&gt;GetType())); uint hr = WinApi.FilterGetMessage( m_filterPortHandle, out request-&gt;Header, Marshal.SizeOf(request-&gt;GetType()), ref request-&gt;Overlapped ); if (hr != WinApi.HRESULT_FROM_WIN32(WinApi.ERROR_IO_PENDING)) { throw WinApi.CreateWin32Exception( "Cannot get filter message", hr ); } } } finally { // Send signal to owner m_resetEvent.Set(); } } private unsafe void Run_ProcessAttached(F2U.IncomingMessagePacket *data) { var pid = ((F2U.ProcessAttached *)data-&gt;Message.Data)-&gt;ProcessId; Console.WriteLine("Incoming request for PID = {0}", pid); var reply = new IncomingMessagePacketReply(); reply.Header.NtStatus = 0; reply.Header.MessageId = data-&gt;Header.MessageId; reply.Message.Command = Command.ProcessAttached; int size= Message.MAX_DATA_SIZE; var pAttachedReply = ((ProcessAttachedReply *)(&amp;reply.Message.Data[0])); pAttachedReply-&gt;NeedToMonitor=1; Process process = null; try { process = Process.GetProcessById(pid); Console.WriteLine("Retrieved name by pid: {0}; Managed: ???", process.ProcessName); } catch(ArgumentException ex) { pAttachedReply-&gt;NeedToMonitor=0; } if(!process.ProcessName.Contains("testredir")) pAttachedReply-&gt;NeedToMonitor = 0; if(pAttachedReply-&gt;NeedToMonitor==1) { int pos = 0, index = 0; Console.WriteLine("Redirections registered: {0}", m_redirections.Count); foreach(var redirection in m_redirections ) { Console.WriteLine(" -- Trying to add redirection: \n {0}\n {1}", redirection.Key, redirection.Value); unchecked { ((ProcessAttachedReply_Positions *)&amp;pAttachedReply-&gt;Positions[index])-&gt;From = (ushort)pos; AppendStringToArray(&amp;pAttachedReply-&gt;Data, redirection.Key, ref pos); ((ProcessAttachedReply_Positions *)&amp;pAttachedReply-&gt;Positions[index])-&gt;To = (ushort)pos; AppendStringToArray(&amp;pAttachedReply-&gt;Data, redirection.Value, ref pos); index++; } } pAttachedReply-&gt;PairsCount = (ushort)m_redirections.Count; } uint status = WinApi.FilterReplyMessage(m_filterPortHandle, ref reply.Header, (int)size); Console.WriteLine("Making reply: Command = ProcessAttached, NeedToMonitor = True, Size = {0}, ReplyStat=0x{1:X}", size, status); } private unsafe void AppendStringToArray(ushort *arr, string str, ref int position) { foreach(var ch in str) { arr[position] = ch; position++; } arr[position]=0; position++; } }</span></span></code> </pre><br><br>  The setting is the following not tricky: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> redir = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RedirectionsManager(); redir.Add(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Environment).Assembly.GetName(), <span class="hljs-string"><span class="hljs-string">"\\temp\\GAC32\\mscorlib.dll"</span></span>);</code> </pre><br>  This means that any access to the assembly <b>mscorlib.dll</b> in the GAC will result in a redirect to the folder ‚ÄúC: \ temp \ GAC32 \ mscorlib.dll‚Äù for a 32-bit system.  For 64-bit, do the same, but for another folder. <br><br><a name="Mscorlib"></a><br><h2>  <font color="#0e3d78">Modify mscorlib.dll</font> </h2><br>  To modify mscorlib, you can use .Net Reflector + Reflexil, the old freeware versions. <br>  In them, I replaced System.Environment.get_Version () so that the version number was "5.0.40930.0" <br><br><a name="Results"></a><br><h2>  <font color="#0e3d78">Checking results</font> </h2><br>  For testing, we will create a .Net Framework 4.0 application and call it <b>testredir</b> , since our driver expects such a process name. <br><br>  The text of the application is simple to impossible <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">testredir</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">testredir</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Ver: {0}!"</span></span>, System.Environment.Version); Console.Write(<span class="hljs-string"><span class="hljs-string">"Press any key to continue . . . "</span></span>); Console.ReadKey(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); } } }</code> </pre><br><br>  The output of the program: <br> <code>Ver: 5.0.40930.0! <br></code> <br><br>  The note: <br>  Changing the system library code is necessary carefully.  For example, our example crashes a piece of software, because it checks the version number on which it runs.  A good example is the creation of a logger of internal events, which I now do <br><br>  Sources: <br><ul><li>  <a href="http://fsfilters.blogspot.com/">http://fsfilters.blogspot.com/</a> </li><li>  DDK Examples-&gt; mini filters-&gt; scanner </li><li>  <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa365198">msdn.microsoft.com/en-us/library/windows/desktop/aa365198</a> (v = vs.85) .aspx </li><li>  <a href="">www.rsdn.ru/article/baseserv/threadpool.xml</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/239005/">https://habr.com/ru/post/239005/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../238991/index.html">The first hackathon Yandex.Money in St. Petersburg</a></li>
<li><a href="../238995/index.html">Dell's four-legged employee</a></li>
<li><a href="../238997/index.html">IT artifacts of our back room</a></li>
<li><a href="../238999/index.html">Microsoft is collecting suggestions for improving Internet Explorer</a></li>
<li><a href="../239001/index.html">BlackEnergy Lite aims at Ukraine and Poland</a></li>
<li><a href="../239009/index.html">Two special models for splitting numbers</a></li>
<li><a href="../239011/index.html">Testing Effort Planning - Report from SQA Days 15</a></li>
<li><a href="../239013/index.html">Caesar III: game loop</a></li>
<li><a href="../239015/index.html">New Ruby Books</a></li>
<li><a href="../239023/index.html">The FLIR One: What can a thermal imager for a phone?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>