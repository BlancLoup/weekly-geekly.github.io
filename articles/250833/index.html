<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make friends OpenHAB and Arduino. Method # 3: MQTT</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article shows another way to interact with the Arduino microcontroller with a universal platform for combining all the home-made "smart" technolo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make friends OpenHAB and Arduino. Method # 3: MQTT</h1><div class="post__text post__text-html js-mediator-article">  This article shows another way to interact with the Arduino microcontroller with a universal platform for combining all the home-made "smart" technology into a single <a href="http://habrahabr.ru/post/232969/">openHAB</a> control <a href="http://habrahabr.ru/post/232969/">system</a> .  On Habr√© already presented articles about the interaction using <a href="http://habrahabr.ru/post/248569/">Serial</a> and <a href="http://habrahabr.ru/post/248219/">HTTP</a> .  For my new project, I chose <a href="http://mqtt.org/">MQTT</a> , because  I have already tried the two previous methods and wanted to try something else. <br><br>  Let's start ... <br><a name="habracut"></a><br>  MQTT is a protocol for exchanging messages between devices.  It is assumed that there is one MQTT server (the so-called MQTT-broker) and client devices connected to it.  Messages consist of a header (topic) and the text of the message.  Connecting to the server gives us two main features: send messages and subscribe to topics of interest to us.  At the same time the tree structure of topics works.  It is easier to show by example.  For sensors that transmit data from the bedroom, you can use the following headings: <br><pre><code class="cpp hljs">/myhome/bedroom/temperature /myhome/bedroom/humidity /myhome/bedroom/luminosity</code> </pre> <br>  Similarly for the kitchen: <br><pre> <code class="cpp hljs">/myhome/kitchen/temperature</code> </pre> <br>  Now, subscribing to any of these topics, we will receive messages about the status of each specific sensor.  But the protocol also allows you to subscribe to the entire branch at once.  To receive data from all bedroom sensors in a single subscription, you can subscribe to a topic. <br><pre> <code class="cpp hljs">/myhome/bedroom/#</code> </pre> <br>  This structure is convenient for human understanding, but further use of MQTT has shown that it is much easier to use only two branches: one for updating the status of elements and the other for sending commands.  But more on that later. <br><br>  In my project, I used the <a href="http://roboparts.ru/products/15880466">Raspberry Pi model B +</a> with <a href="http://www.raspberrypi.org/downloads/">Raspbian</a> installed as the platform for openHAB and <a href="http://roboparts.ru/products/4027771">Arduino MEGA 2560</a> with <a href="http://roboparts.ru/products/4096839">Ethernet Shield w5100</a> installed on it.  Also experimented with Arduino Yun - all the same, just use YunClient instead of EthernetClient. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We leave behind the installation process openHAB, because  Many articles are devoted to this.  We proceed immediately to the installation of MQTT.  Everything is simple here, open the console and install: <br><pre> <code class="cpp hljs">sudo apt-get install mosquitto</code> </pre> <br>  Reboot and check the operability (when I first installed, mosquitto did not want to start when the system was started): <br><pre> <code class="cpp hljs">sudo shutdown -r now</code> </pre> <br>  After reboot: <br><pre> <code class="cpp hljs">sudo service mosquitto status</code> </pre> <br>  In response, should receive: <br><pre> <code class="cpp hljs">[ ok ] mosquitto is running.</code> </pre> <br>  Now you need to set the binding for openHAB.  To do this, perform: <br><pre> <code class="cpp hljs">sudo apt-get install openhab-addon-binding-mqtt</code> </pre> <br>  Or simply copy the file org.openhab.binding.mqtt-1.6.2.jar (current version) to the / usr / share / openhab / addons / folder <br><br>  Let's go to openHAB setup: <br><pre> <code class="cpp hljs">sudo nano /etc/openhab/configurations/openhab.cfg</code> </pre> <br>  Here we add the following lines: <br><pre> <code class="cpp hljs">mqtt:mybroker.url=tcp:<span class="hljs-comment"><span class="hljs-comment">//localhost:1883 mqtt-eventbus:broker=mybroker mqtt-eventbus:commandPublishTopic=/myhome/in/${item} mqtt-eventbus:stateSubscribeTopic=/myhome/out/${item}</span></span></code> </pre> <br>  We also need two Items that are responsible for turning on / off the lights in the kitchen: <br><pre> <code class="cpp hljs">Switch Kitchen_light1 <span class="hljs-string"><span class="hljs-string">".  1"</span></span> &lt;light&gt; Switch Kitchen_light2 <span class="hljs-string"><span class="hljs-string">".  2"</span></span> &lt;light&gt;</code> </pre> <br>  Do not forget to add them to the sitemap in any convenient place.  Restart openHAB: <br><pre> <code class="cpp hljs">sudo service openhab restart</code> </pre> <br>  You can start experimenting!  We connect from any device to the MQTT server and subscribe to the topic / myhome / #.  Each time you change the status of any Item, we will receive a message, in the topic of which the name Item will be indicated, and in the text of the message - its new status.  That's enough for us, let's move on to the programming of the microcontroller. <br><br><div class="spoiler">  <b class="spoiler_title">The code should look something like this.</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;SPI.h&gt; // Ethernet shield #include &lt;Ethernet.h&gt; // Ethernet shield #include &lt;PubSubClient.h&gt; // MQTT #define light1_pin 25 #define light2_pin 27 byte mac[] = { 0x01, 0x23, 0x45, 0x67, 0x89, 0x12 }; byte server[] = { 192, 168, 1, 11 }; byte ip[] = { 192, 168, 1, 12 }; EthernetClient ethClient; PubSubClient client(server, 1883, callback, ethClient); unsigned long lastMqtt = 0; void callback(char* topic, byte* payload, unsigned int length) { payload[length] = '\0'; Serial.print(topic); Serial.print(" "); String strTopic = String(topic); String strPayload = String((char*)payload); Serial.println(strPayload); if (strTopic == "/myhome/in/Kitchen_light1") { if (strPayload == "OFF") digitalWrite(light1_pin, LOW); else if (strPayload == "ON") digitalWrite(light1_pin, HIGH); } else if (strTopic == "/myhome/in/Kitchen_light2") { if (strPayload == "OFF") digitalWrite(light2_pin, LOW); else if (strPayload == "ON") digitalWrite(light2_pin, HIGH); } } void setup() { Serial.begin(57600); Serial.println("start"); pinMode(light1_pin, OUTPUT); digitalWrite(light1_pin, LOW); pinMode(light2_pin, OUTPUT); digitalWrite(light2_pin, LOW); Ethernet.begin(mac, ip); if (client.connect("myhome-kitchen")) { client.publish("/myhome/out/Kitchen_light1", "OFF"); client.publish("/myhome/out/Kitchen_light2", "OFF"); client.subscribe("/myhome/in/#"); } } void loop() { if (lastMqtt &gt; millis()) lastMqtt = 0; client.loop(); //  -     , ,      if (millis() &gt; (lastMqtt + 60000)) { if (!client.connected()) { if (client.connect("myhome-kitchen")) client.subscribe("/myhome/in/#"); } if (client.connected()) { if (digitalRead(light1_pin)) client.publish("/myhome/out/Kitchen_light1", "ON"); else client.publish("/myhome/out/Kitchen_light1", "OFF"); if (digitalRead(light2_pin)) client.publish("/myhome/out/Kitchen_light2", "ON"); else client.publish("/myhome/out/Kitchen_light2", "OFF"); } lastMqtt = millis(); } }</span></span></span></span></code> </pre> </div></div><br><br>  The missing library can be downloaded here: <a href="https://github.com/knolleary/pubsubclient">https://github.com/knolleary/pubsubclient</a> <br><br>  That's all.  I will comment on only the last piece of code.  If the lighting control takes place directly through the microcontroller, then it is necessary to transfer the new state to openHAB.  This can be done immediately after the change of state, or once a minute you can transfer the state of all controlled loads. <br><br>  In conclusion, I want to give a link to an amazing article that really helped me figure it all out: <a href="http://www.instructables.com/id/Uber-Home-Automation-w-Arduino-Pi/%3FALLSTEPS">‚ÄúUber Home Automation w / Arduino &amp; Pi‚Äù</a> </div><p>Source: <a href="https://habr.com/ru/post/250833/">https://habr.com/ru/post/250833/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../250821/index.html">The quality of data networks. Software and hardware measurements</a></li>
<li><a href="../250823/index.html">Pebble: accelerometer, example of use</a></li>
<li><a href="../250825/index.html">Web technologies through the eyes of a C ++ programmer</a></li>
<li><a href="../250829/index.html">Computer Interfaces in Cinema - Evolution of Imagination</a></li>
<li><a href="../250831/index.html">Bottle and plugins</a></li>
<li><a href="../250835/index.html">High Frequency Trading Next Door - Part V (Beginning)</a></li>
<li><a href="../250837/index.html">Introducing the new version of Kerio Control 8.5</a></li>
<li><a href="../250841/index.html">JIT compiler as an academic project at the Academic University</a></li>
<li><a href="../250845/index.html">Anti-patterns of design: Dead End</a></li>
<li><a href="../250847/index.html">The tools that allowed us to speed up the development of the game</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>