<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Firebase + Angular Universal = impossible possible</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Firebase great tool for rapid application development. However, when using Firebase and Angular Universal , the following questions may arise: 


- Wh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Firebase + Angular Universal = impossible possible</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/hy/hu/gv/hyhugveoyaozhp8zqd039xooyue.png" alt="image"><br>  <code>Firebase</code> great tool for rapid application development.  However, when using <code>Firebase</code> and <code>Angular Universal</code> , the following questions may arise: </p><br><ul><li>  Which firebase package to use in the user's browser and which one to use on the server? </li><li>  What mechanism to use for asynchronous operations? </li><li>  How to transfer data from the server to the browser, avoiding duplication of requests? </li></ul><a name="habracut"></a><br><p>  When we started developing our <a href="https://angularcommerce.io/%3Futm_source%3Dhabr%26utm_medium%3Darticles%26utm_campaign%3Duniversal_firebase">Angular Commerce</a> , the main requirement was SEO optimization of the application for search engines.  For this, the search robot must be able to recognize the content on the pages visited.  The application server returns external data (XMLHttpRequest, fetch) at the user's request, embedding their results directly into HTML.  But when we deal with complex SPAs we make various asynchronous requests.  Therefore, when you open the source code of the SPA page, you will see something close to: </p><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Home Page<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">base</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">app-root</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">app-root</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"inline.8f218e778038a291ea60.bundle.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"polyfills.bfe9b544d7ff1fc5d078.bundle.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"main.5092b018fbcb0e59195e.bundle.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  The search engine does not know what content to index, due to the lack of content on the selected page, so our application cannot get to the top search engines. </p><br><p>  We started looking for a server-side SPA rendering solution and stumbled upon <code>Angular Universal</code> .  This is the universal (isomorphic) JavaScript support for Angular.  In other words, our Angular application is rendered on the server and the browser receives SEO friendly pages in response to a request.  You can add meta tags to your page, get asynchronous data from a database or api and all this information will be presented in a rendered page. </p><br><p>  However, we had an unexpected problem that we were stuck on.  Angular Universal is not friendly with WebSockets.  Since we use Firebase as a backend for our <a href="https://angularcommerce.io/%3Futm_source%3Dhabr%26utm_medium%3Darticles%26utm_campaign%3Duniversal_firebase">Angular Commerce</a> project, for us it was a very unpleasant fact.  Therefore, we want to talk about some of the pitfalls that we met in the development process and how we solved them. </p><br><h2 id="ispolzovanie-klientskogo-i-servernogo-firebase">  Using Client and Server Firebase </h2><br><p>  The "client Firebase" package opens a WebSocket for authorization ('firebase.auth ()') which supports a persistent connection, so Universal does not know when to finish rendering on the server.  Thus, the rendering process was not completed when some pages were requested. </p><br><p>  We solved this using the <code>client Firebase</code> package in the client module and the <code>node Firebase</code> in the server module.  Thus, the providers in <code>app.module.ts</code> look like this: </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> firebaseClient from <span class="hljs-string"><span class="hljs-string">'firebase'</span></span>; <span class="hljs-meta"><span class="hljs-meta">@NgModule( // declarations, imports and others... providers: [ { provide: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'Firebase'</span></span></span><span class="hljs-meta">, useFactory: firebaseFactory } ], bootstrap: [AppComponent] })</span></span> export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppModule</span></span></span><span class="hljs-class"> </span></span>{ } export function firebaseFactory() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> config = { apiKey: <span class="hljs-string"><span class="hljs-string">'API_KEY'</span></span>, authDomain: <span class="hljs-string"><span class="hljs-string">'authDomain'</span></span>, databaseURL: <span class="hljs-string"><span class="hljs-string">'databaseURL'</span></span>, projectId: <span class="hljs-string"><span class="hljs-string">'projectId'</span></span>, storageBucket: <span class="hljs-string"><span class="hljs-string">'storageBucket'</span></span>, messagingSenderId: <span class="hljs-string"><span class="hljs-string">'messagingSenderId'</span></span> }; firebaseClient.initializeApp(config); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firebaseClient; }</code> </pre> <br><p>  And in <code>app.server.module.ts</code> : </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> firebaseServer from <span class="hljs-string"><span class="hljs-string">'firebase-admin'</span></span>; <span class="hljs-meta"><span class="hljs-meta">@NgModule( // declarations, imports and others... providers: [ { provide: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'Firebase'</span></span></span><span class="hljs-meta">, useFactory: firebaseFactory } ], bootstrap: [AppComponent] })</span></span> export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppServerModule</span></span></span><span class="hljs-class"> </span></span>{ } export function firebaseFactory() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firebaseServer; }</code> </pre> <br><p>  Initialization of <code>firebaseServer</code> is presented in <code>server.ts</code> .  You must also provide the credential key from the <code>Firebase Console</code> (the server and client versions of the library use different initialization mechanisms): </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> firebaseServer <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'firebase-admin'</span></span>; firebaseServer.initializeApp({ credential: firebase.credential.cert(<span class="hljs-string"><span class="hljs-string">'./src/app/key.json'</span></span>), databaseURL: <span class="hljs-string"><span class="hljs-string">'https://pond-store.firebaseio.com'</span></span> });</code> </pre> <br><p>  Now on the server we use the <code>node Firebase</code> package only with the <code>Firebase Realtime Database</code> , and the <code>client Angular</code> uses the <code>client Firebase</code> package with all the necessary functionality. </p><br><h2 id="ispolzovanie-observables-vmesto-promises">  Using Observables instead of Promises </h2><br><p>  <code>Angular Universal</code> does not work well with <code>promises</code> .  But the query methods of the <code>Firebase Realtime Database</code> Library return <code>promises</code> .  That's why we wrapped these method calls in <code>RxJs Observables</code> .  Below is an example of a simple query to the <code>Firebase Realtime Database</code> : </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ref = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.firebase.database().ref(<span class="hljs-string"><span class="hljs-string">'products'</span></span>); Observable .fromPromise(ref.once(<span class="hljs-string"><span class="hljs-string">'value'</span></span>)) .map(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">val</span></span>()) .subscribe( products =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.products = products; ref.off(); <span class="hljs-comment"><span class="hljs-comment">// closing listener of reference });</span></span></code> </pre> <br><p>  The transition to <code>observables</code> allowed <code>Angular Universal</code> correctly determine when the request was completed. </p><br><h2 id="peredacha-dannyh-servera-brauzeru">  Transferring server data to the browser </h2><br><p>  How does <code>Angular Universal</code> ?  When a user makes a request, the server starts the <code>renderModuleFactory</code> method, which <code>renderModuleFactory</code> application bundle built for the server and immediately returns html with the rendered data on the page.  Then the browser begins to render the browser assembly of Angular.  When rendering is complete, <code>Universal</code> will replace the rendered code on the server with a new, rendered in the browser.  Interestingly, the server and browser assemblies perform almost the same work.  This is noticeable on asynchronous database queries, when the data is visible, then disappears (because <code>Universal</code> deletes the code rendered on the server), and then reappears when the new request is completed in the browser. </p><br><p>  In <code>Angular 5</code> , the <code>@angular/platform-server</code> module has a <code>TransferStateModule</code> .  This module helps you transfer status from the server to the browser, eliminating the need to re-request data in the browser. </p><br><p>  Since we are working with <code>Angular 4</code> , we have found a solution how to transfer data from the server to the browser without <code>Transfer State</code> . </p><br><p>  The <code>renderModuleFactory method</code> has an optional <code>options</code> argument: </p><br><pre> <code class="hljs delphi"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> declare <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderModuleFactory</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">T</span></span></span><span class="hljs-function">&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(moduleFactory: NgModuleFactory&lt;T&gt;, options: </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">{ document?: string; url?: string; extraProviders?: Provider[]; }</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> Promise&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;;</code> </pre> <br><p>  Through <code>extraProviders</code> you can transfer providers that will be added to the server module and will be present in the server application.  Thus, we created a <code>serverStore</code> object that will store the data we want to pass to the client application. </p><br><p>  Callback <code>app.engine</code> in <code>server.ts</code> will look like this: </p><br><pre> <code class="hljs coffeescript">app.engine(<span class="hljs-string"><span class="hljs-string">'html'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_, options, callback)</span></span></span><span class="hljs-function"> =&gt;</span></span> { let serverStore = {}; const opts = { document: template, url: options.req.url, extraProviders: [ { provide: <span class="hljs-string"><span class="hljs-string">'serverStore'</span></span>, useValue: { set: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data)</span></span></span><span class="hljs-function"> =&gt;</span></span> { serverStore = data; } } } ] }; renderModuleFactory(AppServerModuleNgFactory, opts) .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(html: string)</span></span></span><span class="hljs-function"> =&gt;</span></span> { const position = html.indexOf(<span class="hljs-string"><span class="hljs-string">'&lt;/app-root&gt;'</span></span>); html = [ html.slice(<span class="hljs-number"><span class="hljs-number">0</span></span>, position), `<span class="javascript"><span class="javascript">&lt;script type=</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"text/javascript"</span></span></span><span class="javascript">&gt;</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.store = ${</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">JSON</span></span></span><span class="javascript">.stringify(serverStore[</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'store'</span></span></span><span class="javascript">])}&lt;</span><span class="hljs-regexp"><span class="javascript"><span class="hljs-regexp">/script&gt;</span></span></span></span>`, html.slice(position)] .join(<span class="hljs-string"><span class="hljs-string">''</span></span>); callback(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, html); }); });</code> </pre> <br><p>  Finally, we install our <code>serverStore</code> in <code>Window.store</code> before importing other scripts.  Data acquisition in the browser occurs in the AppModule: </p><br><pre> <code class="hljs coffeescript">@NgModule({ <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> declarations, imports <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> others... providers: [ { provide: <span class="hljs-string"><span class="hljs-string">'store'</span></span>, useValue: <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>[<span class="hljs-string"><span class="hljs-string">'store'</span></span>] } ] }) <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppModule</span></span></span><span class="hljs-class"> {}</span></span></code> </pre> <br><h2 id="poluchenie-servernyh-dannyh-v-brauzere">  Getting server data in a browser </h2><br><p>  How about using pre-rendered data in components?  When rendering on the server, the data is received and installed in the storage.  In the browser presentation, we need to check if there is the necessary information in the repository and get it.  Below is a simple example of how to get products from the <code>Firebase Realtime Database</code> in the <code>ngOnInit</code> method: </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Component({ selector: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'app-home'</span></span></span><span class="hljs-meta">, templateUrl: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'./home.component.html'</span></span></span><span class="hljs-meta">, styleUrls: [</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'./home.component.scss'</span></span></span><span class="hljs-meta">] })</span></span> export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HomeComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnInit</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> products: any; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( <span class="hljs-meta"><span class="hljs-meta">@Inject(PLATFORM_ID)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> platformId, <span class="hljs-meta"><span class="hljs-meta">@Inject(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'Firebase'</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> firebase, <span class="hljs-meta"><span class="hljs-meta">@Optional()</span></span> <span class="hljs-meta"><span class="hljs-meta">@Inject(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'serverStore'</span></span></span><span class="hljs-meta"> )</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> serverStore, <span class="hljs-meta"><span class="hljs-meta">@Inject(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'store'</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> store ) { } ngOnInit() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isPlatformServer(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.platformId)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ref = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.firebase.database().ref(<span class="hljs-string"><span class="hljs-string">'products'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> obs = Observable.fromPromise(ref.once(<span class="hljs-string"><span class="hljs-string">'value'</span></span>)) .subscribe( <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>[<span class="hljs-string"><span class="hljs-string">'val'</span></span>](); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> products = Object.keys(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>).map(key =&gt; <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>[key]); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.products = products; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.serverStore.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(products); } ref.off(); obs.unsubscribe(); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.products = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.store; } } }</code> </pre> <br><p>  Please note that the <code>serverStore</code> provider exists only in <code>server build</code> , so it is declared using the <code>@Optional</code> decorator to prevent browser errors: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">No</span></span> provider <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> serverStore!</code> </pre> <br><p>  Thus, using <code>Angular Universal</code> with <code>Firebase</code> is not quite obvious, but there are ways to live with it. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/341044/">https://habr.com/ru/post/341044/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341026/index.html">What is Spring Cloud and how to cook it - an interview with Evgeny Borisov and Kirill Tolkachev</a></li>
<li><a href="../341028/index.html">Prototyping on production technologies</a></li>
<li><a href="../341030/index.html">What is the difference between cool networkers and performing in public? 5 qualities that can be envied</a></li>
<li><a href="../341034/index.html">Harm of small functions</a></li>
<li><a href="../341042/index.html">Choose a file system independent of the OS</a></li>
<li><a href="../341046/index.html">Mars IS transition to a single IT service provider</a></li>
<li><a href="../341048/index.html">What every C programmer should know about Undefined Behavior. Part 1/3</a></li>
<li><a href="../341050/index.html">Full cycle of creating a character model for the game</a></li>
<li><a href="../341056/index.html">Who is a fullstack designer</a></li>
<li><a href="../341058/index.html">JAVA 9. What's new?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>