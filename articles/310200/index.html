<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We implement Brotli with the help of Nginx - we save bytes almost for free</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is useful to anyone who is not indifferent to the speed of delivery of your web application to the user and wants to squeeze out an extra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We implement Brotli with the help of Nginx - we save bytes almost for free</h1><div class="post__text post__text-html js-mediator-article">  This article is useful to anyone who is not indifferent to the speed of delivery of your web application to the user and wants to squeeze out an extra millisecond and kilobytes of savings. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a7d/d8e/bfa/a7dd8ebfa6d94f6583e66f66b6b49948.jpg"></div><br><a name="habracut"></a><br><h3>  What is brotli? </h3><br>  This is a new data compression standard developed by Google.  <a href="https://blog.cloudflare.com/results-experimenting-brotli/">Clouflare</a> has a good description and comparison with other algorithms. <br><br>  In a nutshell: this is a new kind of compression that is optimized for web applications (HTML, CSS, JS, etc.) through the use of a static dictionary and other optimizations.  It shows comparable speed with better compression compared to gzip and much better compression with maximum settings (and very low speed).  A detailed study of the speed and compression ratios, see the specified article from Cloudflare. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I will provide a small table with real files (JS, CSS) of a live website.  Before compression, all files were minified.  Let's <a href="https://github.com/google/zopfli">compare zopfli</a> (i500) - compatible with gzip compressor and brotli with compression setting 11 (maximum). <br><table><tbody><tr><th>  File type and compression </th><th>  Size (bytes) </th><th>  Size (% of original) </th></tr><tr><td>  CSS source files </td><td>  334 937 </td><td>  100% </td></tr><tr><td>  CSS zopfli </td><td>  60 771 </td><td>  18.1% </td></tr><tr><td>  CSS brotli </td><td>  56 168 </td><td>  16.7% </td></tr><tr><td>  Js source files </td><td>  477 393 </td><td>  100% </td></tr><tr><td>  Js zopfli </td><td>  149 905 </td><td>  31.4% </td></tr><tr><td>  Js brotli </td><td>  135 766 </td><td>  28.4% </td></tr></tbody></table><br>  From this table, you can estimate the savings for the use case in static mode (when the files are compressed in advance and given to Nginx as is).  Compression of dynamic content is a bit more complicated - you need to maintain a balance between the degree of compression and compression time. <br><br>  For myself, I derived the following rule: at the expense of <b>zopfli,</b> you can save about 10% compared to <b>gzip 9</b> , and <b>brotli</b> gives you another 10% savings. <br><br><h3>  Browser Support </h3><br>  Good enough to use now.  According to <a href="http://caniuse.com/">caniuse.com,</a> that's about 50% of the audience.  In fact, I think more, because brotli is supported in Chrome 51+, Firefox 47+ and mobile Chrome.  Important addition: since brotli is incompatible with gzip, it is supported <b>only for HTTPS resources</b> .  This is so all sorts of stupid proxies do not beat the content. <br><br>  It‚Äôs simple to look at customer support: it should specify accept-encoding <b>br</b> in the request header, which means ‚Äúbrotli‚Äù.  For example: <br><br><pre><code class="bash hljs">accept-encoding: gzip, deflate, sdch, br</code> </pre> <br><h3>  We include support in Nginx </h3><br>  Unfortunately, there is no standard module to support <b>brotli</b> in <b>Nginx</b> .  But we can't stop us with this: there are third-party modules from Google itself and from Cloudflare.  We will use the option from Google, as it is normally documented and has all the necessary features. <br><br>  Here you need to decide how you will use <b>brotli</b> : only in a static version ( <b>brotli_static</b> ) or in a dynamic version (compression on the fly - brotli).  Building the module in brotli_static mode is simpler, since a library is not required for brotli compression: <a href="https://github.com/bagder/libbrotli">libbrotli</a> . <br><br><h4>  We use a ready-made package from PPA </h4><br>  We will use <b>Ubuntu</b> 16.04 as a server.  This is where PPA comes to the rescue: <a href="https://launchpad.net/~hda-me/%2Barchive/ubuntu/nginx-stable">https://launchpad.net/~hda-me/+archive/ubuntu/nginx-stable</a> .  From the PPA, we get <b>Nginx</b> Stable branches with many additional modules.  Most of them are dynamic, that is, they can be connected at will.  If you are satisfied with this option, you can set and go to the configuration. <br><br><h4>  We collect Nginx independently </h4><br>  In this case, the process is similar to building Nginx with any other modules.  First, download and unpack the Nginx sources (the current version is listed at the time of publication). <br><br><pre> <code class="bash hljs">wget https://nginx.org/download/nginx-1.11.4.tar.gz</code> </pre> <br>  Get the code for the ngx_brotli module: <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/google/ngx_brotli.git</code> </pre> <br>  If we want to use brotli in dynamic mode, download libbrotli: <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/bagder/libbrotli.git</code> </pre> <br>  And collect (in the folder libbrotli): <br><br><pre> <code class="bash hljs">./autogen.sh ./configure make</code> </pre> <br>  Or we can install libbrotli from the <a href="https://launchpad.net/~hda-me/%2Barchive/ubuntu/nginx-stable">PPA</a> specified earlier. <br><br><pre> <code class="bash hljs">sudo add-apt-repository ppa:hda-me/nginx-stable sudo apt-get update sudo apt-get install libbrotli</code> </pre> <br>  If we only need brotli_static, before building Nginx we talk about this: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> NGX_BROTLI_STATIC_MODULE_ONLY=1</code> </pre> <br>  Now go to the folder with the Nginx source code and build it (with the option <b>--add-module = [path to ngx_brotli]</b> ): <br><br><pre> <code class="bash hljs">./configure --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/error.log --http-log-path=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_stub_status_module --with-http_auth_request_module --with-http_xslt_module=dynamic --with-http_image_filter_module=dynamic --with-http_geoip_module=dynamic --with-http_perl_module=dynamic --with-threads --with-stream --with-stream_ssl_module --with-stream_geoip_module=dynamic --with-http_slice_module --with-mail --with-mail_ssl_module --with-file-aio --with-ipv6 --with-http_v2_module --with-cc-opt=<span class="hljs-string"><span class="hljs-string">'-g -O2 -fstack-protector-strong -Wformat -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2'</span></span> --with-ld-opt=<span class="hljs-string"><span class="hljs-string">'-Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,--as-needed'</span></span> --add-module=/home/db/ngx_brotli make</code> </pre> <br>  Next, you can install Nginx ( <b>make install</b> ) or build a deb package: <br><br><pre> <code class="bash hljs">sudo checkinstall --pkgname=nginx --pkgversion=1.11.4 --nodoc</code> </pre> <br><h3>  Nginx configuration </h3><br>  So, we finally have <b>Nginx</b> with <b>brotli</b> support.  To use static <b>brotli</b> files (compressed in advance), it is enough to include one directive in the <b>nginx.conf</b> configuration (section <b>http</b> ): <br><br><pre> <code class="bash hljs">brotli_static on;</code> </pre> <br>  Now nginx will look for a version of the file with the <b>.br</b> suffix if the client declares support for <b>brotli</b> .  If it does not, then the gzip_static module will work (if enabled). <br><br>  To activate the dynamic mode, specify the following parameters: <br><br><pre> <code class="bash hljs">brotli on; brotli_comp_level 6; brotli_types text/plain text/css text/xml application/x-javascript;</code> </pre> <br>  Here we use compression level <b>6</b> , because it has a good quality / performance ratio.  The compression level will be better than with <b>gzip 9</b> .  The following are <b>MIME</b> content types for compression.  Refine the configuration of your <b>MIME</b> types on the server so that compression is applied to the desired content types.  <b>Brotli</b> has priority over <b>gzip</b> , so it will be used in case of support (also for static mode). <br><br>  Checking brotli is easy: look at the response headers, it should be there: <br><br><pre> <code class="bash hljs">content-encoding:br</code> </pre> <br>  That's all: success in optimizing and use new technologies! <br><br>  <strong>PS</strong> If you are using Ubuntu 16.04, then installing the brotli console compression utility is very simple: <br><br><pre> <code class="bash hljs">sudo apt-get install brotli</code> </pre> </div><p>Source: <a href="https://habr.com/ru/post/310200/">https://habr.com/ru/post/310200/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310186/index.html">Responsive Font Size</a></li>
<li><a href="../310188/index.html">Registration is now open for Russia's first international Testathon</a></li>
<li><a href="../310192/index.html">Another way to get around PornHub lock</a></li>
<li><a href="../310196/index.html">MapReduce from scrap materials. Part II - Basic Implementation Interfaces</a></li>
<li><a href="../310198/index.html">8 signs of infantilism in business</a></li>
<li><a href="../310202/index.html">Installing your SSL certificates on the D-Link DNS-320L file storage</a></li>
<li><a href="../310204/index.html">New plugin from Stepik.org for IntelliJ IDEA</a></li>
<li><a href="../310206/index.html">How I spent the holidays on my first application</a></li>
<li><a href="../310208/index.html">How the search is arranged</a></li>
<li><a href="../310210/index.html">Our browsers are smaller, or We need to seriously talk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>