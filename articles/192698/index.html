<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Another plasmoid creation guide: configuration, events and notifications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dr.Konqi, we are friends with him, I often see him%) 
 Instead of the preface 
 Hello! 
 On Habr√© already wrote about the fact that all the plasmoids ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Another plasmoid creation guide: configuration, events and notifications</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage3/76f/e1d/79d/76fe1d79dbbba49fcf34ceca69d6fcc3.png"><br>  <sub>Dr.Konqi, we are friends with him, I often see him%)</sub> <br><h4>  Instead of the preface </h4><br>  Hello! <br>  On Habr√© already <a href="http://habrahabr.ru/post/185266/">wrote</a> about the fact that all the plasmoids need to port to QML / JS, but I still continue to mock at the <i>CPP corpse</i> and write plasma widgets on the pros.  But maybe not everything is so bad,% username%? <br><br>  For a simpler example of writing a plasmoid in C ++, you can refer to <a href="http://habrahabr.ru/post/76371/">this</a> article.  In this article we will try to add a few features (in ascending order) to the naked widget ‚Äî the configuration interface, processing of some events and notifications. <br>  If anyone is interested - continued below. <br><a name="habracut"></a><br><h4>  Widget idea </h4><br>  Since the task for me was exclusively educational and self-educational, the idea of ‚Äã‚Äãthe widget is simple: take and fork the <a href="http://gnome-look.org/content/show.php/Oblique%2BStrategies%3Fcontent%3D78405">Oblique Strategies</a> widget for GNOME.  Thus, in our widget will be: <br><ul><li>  Label with text from <a href="http://www.rtqe.net/ObliqueStrategies/">cards</a> </li><li>  Copyright Label (used primarily to indicate the current edition) </li><li>  Configuration interface, including text setup and editorial selection </li><li>  Update text by mouse click </li><li>  Optional auto update feature </li><li>  Optional function to display the current message when automatically changing to standard notifications </li></ul><br><h4>  Components </h4><br><h5>  Widget </h5><br><div class="spoiler">  <b class="spoiler_title">Heder</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> OBLIKUESTRATEGIES_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> OBLIKUESTRATEGIES_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Plasma/Applet&gt; #include &lt;Plasma/Label&gt; #include &lt;ui_configwindow.h&gt; class QGraphicsLinearLayout; class oblikuestrategies : public Plasma::Applet { Q_OBJECT public: oblikuestrategies(QObject *parent, const QVariantList &amp;args); ~oblikuestrategies(); int setMessagesText(); void init(); public slots: int autoUpdateEvent(); int sendNotification(QString eventId, int num); int updateEvent(); void mousePressEvent(QGraphicsSceneMouseEvent *event); // for configuration interface int setAutoUpdate(); void configAccepted(); void configChanged(); protected: void createConfigurationInterface(KConfigDialog *parent); private: // ui Plasma::Label *main_label; Plasma::Label *info_label; QTimer *timer; // variables bool autoUpdate_bool, notify_bool; int autoUpdate_int, edition, fontSize, fontWeight; QString fontFamily, fontColor, fontStyle; QStringList formatLine, copyright; QList&lt;QStringList&gt; mess; // configuration interface Ui::ConfigWindow uiConfig; }; K_EXPORT_PLASMA_APPLET(oblikue-strategies, oblikuestrategies) #endif /* OBLIKUESTRATEGIES_H */</span></span></span></span></code> </pre> </div></div><br>  This will be a kind of "card".  The essence of <b>K_EXPORT_PLASMA_APPLET is</b> described in the above article (this is the only fundamentally important thing in the hider).  We connect the original libraries, declare the class and destructor <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"oblikue-strategies.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;QGraphicsLinearLayout&gt; #include &lt;plasma/theme.h&gt; oblikuestrategies::oblikuestrategies(QObject *parent, const QVariantList &amp;args) : Plasma::Applet(parent, args) { setBackgroundHints(DefaultBackground); setHasConfigurationInterface(true); } oblikuestrategies::~oblikuestrategies() { delete info_label; delete main_label; delete timer; }</span></span></span></span></code> </pre> <br>  nothing particularly interesting.  I note only that we have here established that the applet has a configuration interface.  The essence of the variables will be clear just below.  Next, we collect the initialization function: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> oblikuestrategies::init() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (setMessagesText() != <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-comment"><span class="hljs-comment">// generate ui // layout QGraphicsLinearLayout *layout = new QGraphicsLinearLayout(this); layout-&gt;setOrientation(Qt::Vertical); // label layout-&gt;addStretch(1); main_label = new Plasma::Label(this); main_label-&gt;setSizePolicy(QSizePolicy::Expanding, QSizePolicy::Expanding); main_label-&gt;setToolTip(qApp-&gt;translate("tooltip", "Click here to update message")); layout-&gt;addItem(main_label); layout-&gt;addStretch(1); // copyright label info_label = new Plasma::Label(this); layout-&gt;addItem(info_label); }</span></span></code> </pre> <br>  The <b>int setMessagesText ()</b> function clogs the <i>copyright</i> variables and the actual text of the cards ( <i>mess</i> ), in the <i>process</i> creates a list of two <i>formatLine</i> elements.  Then we create a Layout, there are two labels on it - one for text, the other for copyright - and we throw <b>stretch</b> for a beautiful look.  Next, go to the configuration interface. <br><h5>  Configuration </h5><br>  Draw a mold.  Let it be like this: <br><img src="https://habrastorage.org/storage3/94c/0e4/7f6/94c0e47f6f818a4ab2cf1de0e403d1a2.png"><br>  Now fasten the function.  Read config: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> oblikuestrategies::configChanged() { KConfigGroup cg = config(); edition = cg.readEntry(<span class="hljs-string"><span class="hljs-string">"edition"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); fontFamily = cg.readEntry(<span class="hljs-string"><span class="hljs-string">"font_family"</span></span>, <span class="hljs-string"><span class="hljs-string">"Terminus"</span></span>); ... }</code> </pre> <br>  I‚Äôll draw your attention to how variables are read.  The <b>readEntry</b> method has two arguments - the first variable name in the configuration file (in the depth of the hamster <i>plasma-desktop-appletrc</i> ), the second - the default value.  Settings recorded using <b>KConfigGroup</b> will be saved in the file specified above.  I will add that this function will be automatically called if the widget settings have been changed. <br>  Do not forget to write the config: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> oblikuestrategies::configAccepted() { KConfigGroup cg = config(); cg.writeEntry(<span class="hljs-string"><span class="hljs-string">"edition"</span></span>, uiConfig.comboBox_edition-&gt;currentIndex()+<span class="hljs-number"><span class="hljs-number">1</span></span>); cg.writeEntry(<span class="hljs-string"><span class="hljs-string">"font_family"</span></span>, uiConfig.fontComboBox_font-&gt;currentFont().family()); ... }</code> </pre> <br>  Similar to reading.  The <b>writeEntry</b> method also has 2 arguments - the name and where to get the values.  Now we fasten the interface itself: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> oblikuestrategies::createConfigurationInterface(KConfigDialog *parent) { QWidget *configwin = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QWidget; uiConfig.setupUi(configwin); uiConfig.comboBox_edition-&gt;setCurrentIndex(edition<span class="hljs-number"><span class="hljs-number">-1</span></span>); ... parent-&gt;addPage(configwin, i18n(<span class="hljs-string"><span class="hljs-string">"Oblikue Strategies"</span></span>), Applet::icon()); connect(parent, SIGNAL(okClicked()), <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, SLOT(configAccepted())); }</code> </pre> <br>  Declared an interface, set values ‚Äã‚Äã(variables are already read in <b>init () by</b> calling the <b>configChanged ()</b> method).  Then they added an interface to the window (the <b>addPage</b> method is the first argument, the second is the third icon).  And tied the button with saving settings.  Next fasten events. <br><h5>  Event handling </h5><br>  Suppose we have some method that is responsible for updating the text.  Call it <b>int updateEvent ()</b> (returns the number of the message that was called).  Attach the processing of a mouse click: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> oblikuestrategies::mousePressEvent(QGraphicsSceneMouseEvent *event) { <span class="hljs-comment"><span class="hljs-comment">// mouse click event if (event-&gt;buttons() == Qt::LeftButton) updateEvent(); }</span></span></code> </pre> <br>  If you double-click, you need to inherit from <b>mouseDoubleClickEvent</b> and, obviously, check for a button is not needed.  Now add autoupdate.  First we add a timer declaration to the <b>init ()</b> method: <br><pre> <code class="cpp hljs">... <span class="hljs-comment"><span class="hljs-comment">// timer timer = new QTimer(this); timer-&gt;setSingleShot(false); ...</span></span></code> </pre> <br>  Set it to ‚Äúreusable‚Äù use ( <b>setSingleShot (false)</b> ).  Next, we screw off and on the timer in the <b>configChanged ()</b> method: <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (autoUpdate_bool == <span class="hljs-literal"><span class="hljs-literal">true</span></span>) { disconnect(timer, SIGNAL(timeout()), <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, SLOT(autoUpdateEvent())); timer-&gt;stop(); } <span class="hljs-comment"><span class="hljs-comment">//   ... if (autoUpdate_bool == true) { connect(timer, SIGNAL(timeout()), this, SLOT(autoUpdateEvent())); timer-&gt;start(autoUpdate_int * MSEC_IN_MIN); }</span></span></code> </pre> <br>  Just in case: the <b>start ()</b> method has an argument period in ms.  Add an auto-update feature: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> oblikuestrategies::autoUpdateEvent() { <span class="hljs-comment"><span class="hljs-comment">// auto update text int num = updateEvent(); if (notify_bool == true) if (sendNotification(QString("newMessage"), num) != 0) return 1; return 0; }</span></span></code> </pre> <br>  This is where we needed the value returned by the <b>updateEvent ()</b> method.  This method causes the text to be updated, then, if set to <i>notify_bool == true,</i> calls the method that sends notifications to KDE. <br><h5>  Notifications </h5><br>  First, create the plasma_applet_oblikue-strategies.notifyrc file <br><pre> <code class="bash hljs">[Global] IconName=oblikue-strategies Name=Oblikue Strategies Comment=Oblikue Strategies [Event/newMessage] Name=New message Comment=There is auto updated message <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> widget Action=Popup</code> </pre><br>  The first is general settings, you can leave them without comments.  Next comes the listing of events and what they are.  Now back to the source.  One single method: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> oblikuestrategies::sendNotification(QString eventId, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> num) { <span class="hljs-comment"><span class="hljs-comment">// send notification KNotification *notification = new KNotification(eventId); notification-&gt;setComponentData(KComponentData("plasma_applet_oblikue-strategies")); notification-&gt;setTitle(QString(i18n("Oblikue Strategies"))); notification-&gt;setText(mess[edition-1][num]); notification-&gt;sendEvent(); delete notification; return 0; }</span></span></code> </pre> <br>  eventId is actually our event.  In the <b>setComponentData</b> method <b>,</b> specify the name of the applet (so as not to be confused and to simplify).  We put the signature, the text and send the message to the system. <br><h5>  Assembly </h5><br><div class="spoiler">  <b class="spoiler_title">ls -1 sources</b> <div class="spoiler_text"><pre> <code class="bash hljs">CMakeLists.txt configwindow.ui oblikue-strategies.cpp oblikue-strategies.h oblikue-strategies.png plasma-applet-oblikue-strategies.desktop plasma_applet_oblikue-strategies.notifyrc</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">CMakeLists.txt</b> <div class="spoiler_text"><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">project</span></span> (plasma_applet_oblikue-strategies) <span class="hljs-keyword"><span class="hljs-keyword">find_package</span></span> (KDE4 REQUIRED) <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> (KDE4Defaults) <span class="hljs-keyword"><span class="hljs-keyword">add_definitions</span></span> (<span class="hljs-variable"><span class="hljs-variable">${QT_DEFINITIONS}</span></span> <span class="hljs-variable"><span class="hljs-variable">${KDE4_DEFINITIONS}</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">include_directories</span></span> (<span class="hljs-variable"><span class="hljs-variable">${CMAKE_SOURCE_DIR}</span></span> <span class="hljs-variable"><span class="hljs-variable">${CMAKE_BINARY_DIR}</span></span> <span class="hljs-variable"><span class="hljs-variable">${KDE4_INCLUDES}</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> (PLUGIN_NAME <span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> (GLOB PROJECT_DESKTOP *.desktop) <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> (GLOB PROJECT_ICON *.png) <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> (GLOB PROJECT_NOTIFY *.notifyrc) <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> (GLOB PROJECT_SOURCE *.cpp) <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> (GLOB PROJECT_UI *.ui) kde4_add_ui_files (PROJECT_SOURCE <span class="hljs-variable"><span class="hljs-variable">${PROJECT_UI}</span></span>) kde4_add_plugin (<span class="hljs-variable"><span class="hljs-variable">${PLUGIN_NAME}</span></span> <span class="hljs-variable"><span class="hljs-variable">${PROJECT_SOURCE}</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">target_link_libraries</span></span> (<span class="hljs-variable"><span class="hljs-variable">${PLUGIN_NAME}</span></span> <span class="hljs-variable"><span class="hljs-variable">${KDE4_PLASMA_LIBS}</span></span> <span class="hljs-variable"><span class="hljs-variable">${KDE4_KDEUI_LIBS}</span></span>) <span class="hljs-comment"><span class="hljs-comment"># install install (TARGETS ${PLUGIN_NAME} DESTINATION ${PLUGIN_INSTALL_DIR}) install (FILES ${PROJECT_DESKTOP} DESTINATION ${SERVICES_INSTALL_DIR}) install (FILES ${PROJECT_ICON} DESTINATION ${ICON_INSTALL_DIR}) install (FILES ${PROJECT_NOTIFY} DESTINATION ${DATA_INSTALL_DIR}/${PLUGIN_NAME})</span></span></code> </pre></div></div><br>  The file is not quite correct (from the point of view of the human factor, for example), but universal (change only the name of the project to the one you need).  From differences from regular build files, call <b>kde4_add_ui_files</b> to create a configuration interface.  And setting the file with notifications. <br><h4>  P.S </h4><br>  <a href="https://github.com/arcan1s/oblikuestrategies">Sources of</a> this disgrace. <br>  What happened: <br><img src="https://habrastorage.org/storage3/4b6/e0c/662/4b6e0c6621fa86159f313f08791056c5.png"><br>  <a href="https://projects.kde.org/projects/kde/kdeplasma-addons/repository/revisions/master/show/applets">According to the materials</a> <br><br>  Thanks for attention! </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/192698/">https://habr.com/ru/post/192698/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../192672/index.html">Started pre-order Tessel</a></li>
<li><a href="../192676/index.html">Unification of interfaces: the experience of e-commerce projects</a></li>
<li><a href="../192684/index.html">Hesperbot - a new banking trojan discovered in-the-wild</a></li>
<li><a href="../192686/index.html">Expiration of certificates on Windows XP and Office 2003 as the reason for the future growth of sales of Microsoft products?</a></li>
<li><a href="../192690/index.html">Features of the calibrator i1 Display Pro</a></li>
<li><a href="../192700/index.html">Lenovo's new products at IFA 2013</a></li>
<li><a href="../192704/index.html">How was the competition flying robots: flights and errors</a></li>
<li><a href="../192706/index.html">Tell-Don't-Ask</a></li>
<li><a href="../192708/index.html">Desktop apps in the Chrome store</a></li>
<li><a href="../192710/index.html">Japanese robot cosmonaut says hello from space</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>