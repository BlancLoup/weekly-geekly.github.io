<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Alpha-blending per one-pixel multiplication on Windows Mobile</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Those who were engaged in graphics on Windows Mobile, probably heard about the graphics library GapiDraw . If you look at their Feature List , then in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Alpha-blending per one-pixel multiplication on Windows Mobile</h1><div class="post__text post__text-html js-mediator-article">  Those who were engaged in graphics on Windows Mobile, probably heard about the graphics library <a href="http://gapidraw.com/">GapiDraw</a> .  If you look at their <a href="http://gapidraw.com/features.php">Feature List</a> , then in the High Performance section you can find the following words: "drawing surfaces with opacity".  That is, they claim that it takes only one multiplication per pixel to draw translucent images. <br><br>  In this article I will try to explain how this is possible. <br><a name="habracut"></a><br>  First, most Windows Mobile devices have a screen with 65 thousand colors.  That is, for each pixel on the screen, 2 bytes are allocated in memory.  Secondly, such devices have a 32-bit processor.  On such a processor, the speed of performing mathematical operations with 2-byte numbers differs little from the speed of working with 4-byte numbers.  This is where one of the computation optimizations is hidden.  The graphics library processes 2 pixels at a time. <br><br>  Let's see how the 16-bit pixel works.  The upper 5 bits are reserved for red, then 6 bits - for green and the remaining 5 bits - for blue. <br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">P</span></span> = [RRRR RGGG GGGB BBBB] <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  At the same time, the colors themselves can be obtained using shifts and masks according to the formulas: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> R = (P &gt;&gt; <span class="hljs-number"><span class="hljs-number">11</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x1f</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> G = (P &gt;&gt; <span class="hljs-number"><span class="hljs-number">5</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x3f</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> B = P &amp; <span class="hljs-number"><span class="hljs-number">0x1f</span></span>;</code> </pre><br>  And the pixel is obtained by the inverse transformation: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> P = (R &lt;&lt; <span class="hljs-number"><span class="hljs-number">11</span></span>) + (G &lt;&lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) + B;</code> </pre><br>  When we try to draw one pixel on top of another with transparency, the colors are mixed.  Both pixels are divided into 3 components: red, blue, green.  Then the components are mixed, the red is mixed with red, the blue with blue, and the green with green.  And from the obtained values ‚Äã‚Äãa new pixel is composed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In general, the color mixing looks like this: <br><pre> <code class="cpp hljs">C = C1*Œ± + C2*(<span class="hljs-number"><span class="hljs-number">1</span></span> - Œ±)</code> </pre><br>  C1 - the value of red, green or blue from the first pixel. <br>  C2 - the value of the same color in the second pixel. <br>  C is the resulting color. <br>  Œ± - coefficient of transparency, takes values ‚Äã‚Äãfrom 0 to 1. <br><br>  It‚Äôs quite expensive to store the real value of Œ±, especially on handheld computers, so it is limited to a certain integer range.  Usually, values ‚Äã‚Äãof 0-255 are used, but for 5-bit color, 5-bit Œ± will suffice. <br><br>  First, let's pay attention to how colors are mixed with 50% transparency: <br><pre> <code class="cpp hljs">C = C1/<span class="hljs-number"><span class="hljs-number">2</span></span> + C2/<span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre><br>  The division by 2 can be replaced by a shift: <br><pre> <code class="cpp hljs">C = (C1 &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) + (C2 &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br>  Now let's see what happens when two pixels are mixed one by one: <br><pre> <code class="cpp hljs">P = (R1 &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> + R2 &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">11</span></span> + (G1 &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> + G2 &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">5</span></span> + (B1 &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> + B2 &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br>  Opening the brackets we get: <br><pre> <code class="cpp hljs">P = (P1 &amp; <span class="hljs-number"><span class="hljs-number">0xf7de</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> + (P2 &amp; <span class="hljs-number"><span class="hljs-number">0xf7de</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  The mask 0xf7de appears to ensure the correct shift by 1 in each color component.  Compare: <br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">RRRR RGGG GGGB BBBB</span></span>] = P [<span class="hljs-number"><span class="hljs-number">0</span></span>RRR RRGG GGGG BBBB] = P &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-comment"><span class="hljs-comment">//         [RRRR RGGG GGGB BBBB] = P [1111 0111 1101 1110] = 0xf7de [RRRR 0GGG GG0B BBB0] = P &amp; 0xf7de //      [0RRR R0GG GGG0 BBBB] = P &amp; 0xf7de &gt;&gt; 1</span></span></code> </pre><br>  Similar to this method, you can do the same operations for mixing pixels 1 to 3, 1 to 7 ... But in this respect, this method is completely ineffective, mainly due to the fact that the division goes before multiplication.  Therefore, you must first make room for multiplication.  Note that multiplying the m-bit unsigned number by n-bit, we get a number occupying no more than m + n bits.  That is, it is necessary to release 5 bits before each color, and for this you can divide the pixel colors into even and odd and operate with them.  So we come to the following blending procedure using 2 multiplications per pixel: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> Shift(p) ((p)&gt;&gt;5) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> OddCol(p) ((p) &amp; 0x07E0F81F) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> EvenCol(p) ((p) &amp; 0xF81F07E0) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//      2  register unsigned int p1 = *dst; register unsigned int p2 = *(src++); //  4 ,    2   *(dst++) = OddCol( Shift(OddCol(p1)*a + OddCol(p2)*(32 - a)) ) | EvenCol( Shift(EvenCol(p1))*a + Shift(EvenCol(p2))*(32 - a) );</span></span></span></span></code> </pre><br>  How to get rid of another multiplication?  Let's try to open the brackets and regroup the items: <br><pre> <code class="cpp hljs">C = (C1*Œ± + C2*(<span class="hljs-number"><span class="hljs-number">32</span></span> - Œ±)) &gt;&gt; <span class="hljs-number"><span class="hljs-number">5</span></span> = (C1 - C2)*Œ± &gt;&gt; <span class="hljs-number"><span class="hljs-number">5</span></span> + C2</code> </pre><br>  But in parentheses you can get a negative number, and arithmetic operations with negative numbers are based on overflow.  Thus, it is impossible to apply the formula in this form to parallelize the calculations.  Therefore, we get rid of negative values ‚Äã‚Äãby adding the maximum possible: <br><pre> <code class="cpp hljs">C = (C1 - C2 + <span class="hljs-number"><span class="hljs-number">32</span></span> - <span class="hljs-number"><span class="hljs-number">32</span></span>)*Œ± &gt;&gt; <span class="hljs-number"><span class="hljs-number">5</span></span> + C2 = (C1 - C2 + <span class="hljs-number"><span class="hljs-number">32</span></span>)*Œ± &gt;&gt; <span class="hljs-number"><span class="hljs-number">5</span></span> + C2 - Œ±</code> </pre><br>  Using this formula and a trick with even and odd colors, you can get a pixel blending procedure that uses just one multiplication per pixel: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> OddCol(p) ((p) &amp; 0x07E0F81F) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> EvenCol(p) ((p) &amp; 0xF81F07E0) register unsigned int p1 = *dst; register unsigned int p2 = *(src++); register unsigned int oddA = (a</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt;22) | (a&lt;&lt;11) | (a); register unsigned int evenA = (a&lt;&lt;27) | (a&lt;&lt;16) | (a&lt;&lt;6); register unsigned int oddP2 = OddCol(p2); register unsigned int evenP2 = EvenCol(p2); // 2    2  oddCol = (((OddCol(p1) - oddP2 + 0x08010020) * a) &gt;&gt; 5) + oddP2 - oddA; evenCol = ((( (EvenCol(p1)&gt;&gt;5) - (evenP2&gt;&gt;5) + 0x08010040) * a) + evenP2 - evenA ); *(dst++) = OddCol(oddCol) | EvenCol(evenCol);</span></span></span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/128773/">https://habr.com/ru/post/128773/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../128766/index.html">Modder was able to combine PSP and GameCube</a></li>
<li><a href="../128768/index.html">Image segmentation</a></li>
<li><a href="../128769/index.html">Stored procedures. Who is faster</a></li>
<li><a href="../128770/index.html">VRRP in Linux</a></li>
<li><a href="../128772/index.html">What is an ‚Äúasynchronous event model‚Äù, and why is it now ‚Äúin fashion‚Äù</a></li>
<li><a href="../128774/index.html">Modding the USB-to-SATA converter for your own needs</a></li>
<li><a href="../128775/index.html">Samsung Galaxy Tab 10.1 - how to disassemble the tablet and what it consists of</a></li>
<li><a href="../128776/index.html">Over 270 video reports from BUILD conference are available.</a></li>
<li><a href="../128777/index.html">Is your ICQ UIN running on another computer? Keep communicating on this!</a></li>
<li><a href="../128778/index.html">Energy efficient synergy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>