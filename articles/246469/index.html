<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Yet another AOP in .NET</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many .NET developers, who used WPF, Silverlight or Metro UI in their practice, somehow had the question ‚Äúhow can I simplify the implementation of INot...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Yet another AOP in .NET</h1><div class="post__text post__text-html js-mediator-article">  Many .NET developers, who used WPF, Silverlight or Metro UI in their practice, somehow had the question ‚Äúhow can I simplify the implementation of INotifyPropertyChanged interface and properties, which changes should be signaled?‚Äù. <br><br>  The simplest "classic" version of the description of a property that supports notification of its change is as follows: <br><a name="habracut"></a><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _name; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(_name != <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) { _name = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; NotifyPropertyChanged(‚ÄúName‚Äù); } } }</code> </pre> <br>  In order not to repeat similar strings in each setter, you can make an auxiliary function.  Moreover - starting with .NET 4.5, it is possible to use the [CallerMemberName] attribute in it, in order not to explicitly specify the name of the property that calls it.  But this does not solve the main problem - all the same, for each new property it is necessary to explicitly describe the field and the getter with the setter.  Such mechanical work is uninteresting, tedious and can lead to errors when copying and pasting. <br><br>  I would like a bit of ‚Äúmagic‚Äù, which will allow with a little effort (for example, with a single line of code) to make this class compatible with INotifyPropertyChanged: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Person</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FirstName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> LastName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime Birth { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  It should be noted that this is not the only task in which I would like to simplify my life while adding end-to-end functionality.  Typical tasks of logging of called methods of a certain class, measurements of their runtime, checking the availability of rights to call are all that require a common solution, eliminating the need to write similar pieces of code in every place where it is needed. <br><br>  A more or less experienced developer will immediately say - ‚ÄúIt's the same aspect-oriented programming!‚Äù And he will be right.  And if you start listing existing libraries for the .NET platform, in which in one way or another it is possible to use AOP, the list will not be so short: PostSharp, Unity, Spring .NET, Castle Windsor, Aspect .NET ... And this not all, but here you should think about the mechanisms that implement the insertion of end-to-end functionality, about their advantages and disadvantages.  There are two main ways: <br><br><ul><li>  Compile substitution (PostSharp) </li><li>  Generating proxy classes at runtime (Unity, Spring .NET, Castle Windsor) </li></ul><br>  Substitution at compile time is the most profitable way, since it does not require any additional computational power when executing a program, which is especially important for mobile devices.  The usual generation of proxy classes is easier to implement, but in addition to the computational costs, it also has limitations - methods or properties must be contained in the interface or be virtual so that they can be intercepted through the proxy class. <br><br>  PostSharp offers very large possibilities for using aspect-oriented programming, but it is a commercial product, which for many projects may be unacceptable.  As an alternative, we have developed and continue to improve the <a href="https://github.com/pamidur/aspect-injector">Aspect Injector</a> - a framework that allows you to apply aspects at the compilation stage and has a simple, but at the same time flexible interface. <br><br>  The simplest example of using Aspect Injector is logging method calls.  First you need to describe the aspect class: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MethodTraceAspect</span></span> { [Advice(InjectionPoints.Before, InjectionTargets.Method)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Trace</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[AdviceArgument(AdviceArgumentSource.TargetName</span></span></span><span class="hljs-function">)] </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> methodName)</span></span> { Console.WriteLine(methodName); } }</code> </pre><br>  This description suggests that when applying this aspect to any other class, at the beginning of each of its public methods, a call to Trace () will be added with the name of the method itself as a parameter. <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Aspect(typeof(MethodTraceAspect))</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Target</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Delete</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> } }</code> </pre><br>  After such a declaration, Create, Update, Delete will print their names to the console on each call.  It should be noted that the Aspect attribute can be applied not only to classes, but also to specific members of a class, if a ‚Äúpoint insert‚Äù is needed.  Here is an example of decompiled code obtained after compiling the example above: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Target</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> MethodTraceAspect __a$_MethodTraceAspect; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.__a$_MethodTraceAspect.Trace(<span class="hljs-string"><span class="hljs-string">"Create"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.__a$_MethodTraceAspect.Trace(<span class="hljs-string"><span class="hljs-string">"Update"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Delete</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.__a$_MethodTraceAspect.Trace(<span class="hljs-string"><span class="hljs-string">"Delete"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Target</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.__a$_MethodTraceAspect = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodTraceAspect(); } }</code> </pre><br>  You may also notice here that the Aspect attribute was deleted during code generation, which allows the resulting assembly not to refer to the Aspect Injector assembly. <br><br>  If you go back to the original task of implementing the INotifyPropertyChanged interface, you can create and successfully use the following aspect using Aspect Injector: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">AdviceInterfaceProxy(typeof(INotifyPropertyChanged))</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NotifyPropertyChangedAspect</span></span> : <span class="hljs-title"><span class="hljs-title">INotifyPropertyChanged</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> PropertyChangedEventHandler PropertyChanged = (s, e) =&gt; { }; [Advice(InjectionPoints.After, InjectionTargets.Setter)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RaisePropertyChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> [AdviceArgument(AdviceArgumentSource.Instance</span></span></span><span class="hljs-function">)] </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> targetInstance, [</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AdviceArgument</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">AdviceArgumentSource.TargetName</span></span></span><span class="hljs-function">)] </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> propertyName)</span></span> { PropertyChanged(targetInstance, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PropertyChangedEventArgs(propertyName)); } }</code> </pre><br>  All public properties of all classes to which this aspect will be tied will RaisePropertyChanged at the end of the setter.  Moreover, the interface specified in the AdviceInterfaceProxy attribute will be added to the class by the framework during compilation. <br><br>  On <a href="https://github.com/pamidur/aspect-injector">the project page</a> you can find more detailed information about the attributes and their parameters currently available.  We would be grateful for any feedback and suggestions on the development of Aspect Injector! </div><p>Source: <a href="https://habr.com/ru/post/246469/">https://habr.com/ru/post/246469/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../246459/index.html">Interval repetition of foreign words: Anki, LinguaLeo, Memrise</a></li>
<li><a href="../246461/index.html">I am a certified PHP specialist</a></li>
<li><a href="../246463/index.html">We write the most effective test case</a></li>
<li><a href="../246465/index.html">Integration Testing in Java EE, Adam Bean</a></li>
<li><a href="../246467/index.html">A simple solution for using EDS</a></li>
<li><a href="../246471/index.html">My personal Sony Hack</a></li>
<li><a href="../246473/index.html">Club of anonymous Santa Clauses in Habr√© 2014-2015</a></li>
<li><a href="../246477/index.html">Yii 1.1.16</a></li>
<li><a href="../246481/index.html">Quick Rollback in Veeam Backup & Replication: a new mode for fast recovery of virtual machine disks</a></li>
<li><a href="../246483/index.html">Google's Quantum Online Sandbox</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>