<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bidirectional rendering with diacritics support</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 In this article I will share the experience of how bi-directional text was added to your own TextBox with the correct display of diacri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bidirectional rendering with diacritics support</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  In this article I will share the experience of how bi-directional text was added to your own TextBox with the correct display of diacritics using FriBidi and HarfBuzz.  This is the second article on this topic, and the first was <a href="https://habrahabr.ru/post/262987/">Adding support for bidirectional text to your own TextBox</a> .  In it, I described the features of adding Arabic to my own text using <a href="http://fribidi.org/">FriBidi.</a> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/06d/927/4eb/06d9274ebcef08ffdcb5acdd95248db7.png" alt="Sample Arabic Text"><br><br><a name="habracut"></a><br><h4>  What is the problem? </h4><br>  Diacritic marks (diacritics (professional-slang)) in typography are writing elements that modify the character pattern and are usually typed separately.  In the previous sentence, the accent marks on a and a are the diacritical marks.  For example, in Russian language two points can be considered as diacritics above ‚Äú‚Äù and briefly above ‚Äú‚Äù.  But the addition of these diacritics led to the creation of new letters, although for e two points are often omitted. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In most languages, when working with text, there are no special problems with the rendering of diacritics (unless of course you specify the emphasis on each letter), since  letters with a diacritic are either a separate letter in the alphabet or in font files, they appear as a separate character.  In other words, the TextBox does not need to separately place the diacritics above the letters. <br><br>  But in Arabic (and for example, in Hindi) is not so simple.  In Arabic, the <a href="https://ru.wikipedia.org/wiki/%25D0%259E%25D0%25B3%25D0%25BB%25D0%25B0%25D1%2581%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B8_%25D0%25B2_%25D0%25B0%25D1%2580%25D0%25B0%25D0%25B1%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BC_%25D0%25BF%25D0%25B8%25D1%2581%25D1%258C%25D0%25BC%25D0%25B5">vocabulary</a> is an accent mark.  They can be used with almost every letter, and even a single letter can have several voices. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/06d/927/4eb/06d9274ebcef08ffdcb5acdd95248db7.png" alt="Sample Arabic Text"><br><br>  <i>The black color represents the letters of the Arabic alphabet, while the gray color represents the vowels (diacritics).</i> <br><br>  As you understand, no one went through all possible combinations of letters and public announcements and did not start a separate character for each combination.  That is, for the correct rendering of the Arabic text, it is necessary to draw an Arabic letter and separately draw a diacritic above or below it. <br><br>  FreeType, which we used, allows you to get the image of the diacritic from the font file and even tells us the shifts.  But these shifts are incorrect, i.e.  it is impossible to figure out by one symbol how to arrange the diacritic.  Below is a case in point - a few diacritics above the letter.  For the correct positioning it is necessary to analyze the entire text. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/88b/310/0fd/88b3100fd050e5366db54cd451cc4b08.png" alt="Arabic letter with diacritic"><br><br>  To calculate the position of the diacritics above the letters, we used the <a href="https://www.freedesktop.org/wiki/Software/HarfBuzz/">HarfBuzz</a> library.  The library allows you to get glyph numbers in the font and their shifts for further rendering. <br><br><h4>  How to use <a href="https://www.freedesktop.org/wiki/Software/HarfBuzz/">HarfBuzz</a> </h4><br>  HarfBuzz receives a font and a line as input, and returns the position of each letter and additional information (for example, the number of the glyph). <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">hb_buffer_t</span></span> *buf; <span class="hljs-comment"><span class="hljs-comment">// harfbuzz . hb_buffer_create/hb_buffer_destroy hb_font_t *hb_ft_font; // harfbuzz ,    hb_font_create,   hb_font_destroy hb_script_t script; //   .  hb_unicode_script   . hb_direction_t dir = hb_script_get_horizontal_direction(script); hb_buffer_set_direction(buf, dir); //       hb_buffer_set_script(buf, script); hb_buffer_add_utf32(buf, (const uint32_t*)text,length, 0,length); //     harfbuzz . hb_shape(hb_ft_font, buf, NULL, 0); //  unsigned int glyph_count = 0; hb_glyph_info_t *glyph_info = hb_buffer_get_glyph_infos(buf, &amp;glyph_count); //    . hb_glyph_position_t *glyph_pos = hb_buffer_get_glyph_positions(buf, &amp;glyph_count); //   .</span></span></code> </pre> <br><br>  It should be noted that the above code should be applied only to text that uses the same font and has the same script.  To implement the splitting of the text into such parts, you can use the function hb_unicode_script, which returns the script of the symbol. <br><br>  Since we were faced with the task of supporting not just Arabic, but also bidirectional text (for example, Arabic and Latin may be present in one line), we used FriBidi for correct positioning.  But this was described in more detail in the first article <a href="https://habrahabr.ru/post/262987/">Adding support for bidirectional text to your own TextBox</a> . <br><br><h4>  TextBox changes </h4><br>  So, Text Boxing has already supported bidirectional text.  Characters are stored in memory in the order of input, but each of them has a corresponding position in the order of rendering. <br><br><img src="https://habrastorage.org/files/faf/05d/21d/faf05d21d56744f4ad5dda2f8285f433.png" alt="Storing bidirectional text in the program"><br><br>  With the addition of daikritics, the situation became a bit more complicated, since  several letters entered could correspond to one letter.  In order for the cursor positioning code to work independently of diacritics, the letters had to be slightly more complicated.  Now, each letter kept a list of glyphs that are included in it. <br><br><img src="https://habrastorage.org/files/0b2/cce/51f/0b2cce51f3e244e0b49560f3c33effd3.png" alt="Splitting bidirectional text with diacritics"><br><br>  With this approach, the implementation of editing functions, including copying and pasting, has been simplified.  But such an approach does not make it possible to remove a separate diacritic, since the cursor can only be placed in front of or behind the letter. <br><br><h4>  Example </h4><br>  You can find an example of the bidirectional text rendering here <a href="https://github.com/UnickSoft/ex-sdl-freetype-harfbuzz-fribidi">GitHub / ex-sdl-freetype-harfbuzz-fribidi</a> .  The example uses: SDL2 - to create a visualization window;  Freetype - for rendering letters;  fribidi - for proper positioning;  harfbuzz - to get glyphs and their positions. <br><br><img src="https://habrastorage.org/files/398/f2b/7d0/398f2b7d060342e995735fcdf0037f5e.png" alt="Example of the example"><br><br><h4>  Disclaimer </h4><br>  Yes, we write our bike, so we implement our TextBox from scratch.  And we did not use the Pango, because with him was a bad experience before.  Maybe it would be easier with Pango. <br><br><h4>  useful links </h4><br><ul><li>  <a href="http://behdad.org/text/">behdad.org/text</a> - about text rendering </li><li>  <a href="http://www.freedesktop.org/wiki/Software/HarfBuzz/">www.freedesktop.org/wiki/Software/HarfBuzz</a> - HarfBuzz Library. </li><li>  <a href="http://fribidi.org/">fribidi.org</a> - library FriBidi. </li><li>  <a href="https://ru.wikipedia.org/wiki/%25D0%259E%25D0%25B3%25D0%25BB%25D0%25B0%25D1%2581%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B8_%25D0%25B2_%25D0%25B0%25D1%2580%25D0%25B0%25D0%25B1%25D1%2581%25D0%25BA%25D0%25BE%25D0%25BC_%25D0%25BF%25D0%25B8%25D1%2581%25D1%258C%25D0%25BC%25D0%25B5">ru.wikipedia.org/wiki/Oblasov____Arabic_written</a> - about the diacritics in the Arabic letter. </li><li>  <a href="https://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B8%25D0%25B0%25D0%25BA%25D1%2580%25D0%25B8%25D1%2582%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B5_%25D0%25B7%25D0%25BD%25D0%25B0%25D0%25BA%25D0%25B8">ru.wikipedia.org/wiki/Diacritical_a</a> signs are about accents. </li><li>  <a href="https://github.com/UnickSoft/ex-sdl-freetype-harfbuzz-fribidi">ex-sdl-freetype-harfbuzz-fribidi</a> - my example of using fridibi + harfbuzz, was based on <a href="https://github.com/lxnt/ex-sdl-freetype-harfbuzz">https://github.com/lxnt/ex-sdl-freetype-harfbuzz</a> . </li><li>  <a href="http://www.unicode.org/reports/tr9/">www.unicode.org/reports/tr9</a> - bidirectional text display algorithm. </li><li>  <a href="http://www.pango.org/">www.pango.org</a> - Pango library. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/277525/">https://habr.com/ru/post/277525/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277513/index.html">Rip network dictionaries using Node.js, part 2: dynamic pages; connect nw.js</a></li>
<li><a href="../277515/index.html">Creating a system of placing objects by level using the blueprint editor</a></li>
<li><a href="../277517/index.html">How I transferred the working Ubuntu MATE 14.04 system to a new SSD disk</a></li>
<li><a href="../277519/index.html">About MongoDB Online University</a></li>
<li><a href="../277521/index.html">Setting Safebrowsing from Yandex to Firefox</a></li>
<li><a href="../277527/index.html">The benefits of big data technology in everyday life</a></li>
<li><a href="../277529/index.html">Fake Novella: a small game, the development of which taught me a lot and another ban from Google</a></li>
<li><a href="../277533/index.html">Creating a user interface for Blend4Web (Part 1)</a></li>
<li><a href="../277535/index.html">Robotic arm control with Intel RealSense cameras</a></li>
<li><a href="../277537/index.html">Vision-based SLAM: monocular SLAM</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>