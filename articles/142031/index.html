<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimizing pseudo-streaming FLV video</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the projects of our company is an online-video service similar to youtube. For streaming and streaming capabilities, a wonderful nginx web serv...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimizing pseudo-streaming FLV video</h1><div class="post__text post__text-html js-mediator-article">  One of the projects of our company is an online-video service similar to youtube.  For streaming and streaming capabilities, a wonderful nginx web server with the ngx_http_flv_module module is used. <br><br>  Everything was fine until the number of views reached a level, when not only the network channels of the servers were overloaded, but the disk subsystem of servers ceased to cope with read requests. <br><a name="habracut"></a><br>  Problems with the disk subsystem solved simply installing the 10th raid.  But it was necessary to do something with the network and the idea appeared to upload files for viewing not in one stream, but discretely, in chunks of the same size.  Fortunately in flash, it was implemented all that is needed.  According to the documentation in the NetStream object, there is an appendBytes () method with the necessary functionality.  Here is an excerpt from the official documentation: <br><br>  ‚ÄúSends a ByteArray object to the NetStream instance for playback.  Call this method for a NetStream object in data creation mode.  To put a NetStream object into data creation mode, call the NetStream.play (null) method for the NetStream instance created for the NetConnection object that is connected to null.  The appendBytes () method cannot be called for a NetStream object that is not in data creation mode, otherwise an exception is thrown. ‚Äù 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It would seem, we take a class Loader, we register the heading Range, but we are waiting for mine here from Adobe developers.  The standard Action Script classes that work with the HTTP protocol do not use the Range header.  Again, from official sources it becomes known that the Range header is blocked in the code of classes that work in the HTTP protocol, for security reasons, in player version 9. But one thing was pleasing: that the lock is not native, but in the classes themselves, from which it followed that You can write your HTTP client using the Socket base class.  Fortunately, in the google <a href="httpclient">bins</a> there was a ready-made class <a href="httpclient">HTTPClientLib</a> .  The code below loads the first megabyte of the video file and plays it: <br><br><pre><code class="javascript hljs">private <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ns:NetStream; private <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> video:Video; private <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> meta:<span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>; private <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client:HttpClient; private <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filesize:<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; private <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> loadedBytes:<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; private <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data:ByteArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ByteArray(); private <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> datadelta:<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> = <span class="hljs-number"><span class="hljs-number">1024</span></span>*<span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    - private var file:String = %   %; private function init():void{ // ,      var nsClient: Object = {}; //       nsClient.onMetaData = metaDataHandler; //   ;          null       - var nc:NetConnection = new NetConnection(); nc.connect(null); // ,          ns = new NetStream(nc); ns.client = nsClient; //     ns.addEventListener(NetStatusEvent.NET_STATUS,netStatusHandler); //   ns.addEventListener(IOErrorEvent.IO_ERROR,nsIOErrorHandler); //      video = new Video(); video.attachNetStream(ns); //  .  ,       video.smoothing = true; uic.addChild(video); // ,      NetStream client = new HttpClient(); //     loadData(); //     NetStream ns.play(null); } private function loadData():void{ //     var uri:URI = new URI(file); //,      var request:HttpRequest = new Get(); //maxdata      //loadedBytes -     var maxdata:Number = loadedBytes+datadelta; //    ,           if (maxdata&gt;=filesize and filesize&gt;0){ request.addHeader('Range','bytes='+loadedBytes+'-'); } else { request.addHeader('Range','bytes='+loadedBytes+'-'+maxdata); } //    ,       data //        //         NetStream  //     client.listener.onData = function(e:HttpDataEvent):void { var bytes:ByteArray = new ByteArray(); bytes = e.bytes; bytes.position = 0; data.writeBytes(bytes); }; //      client.listener.onComplete = function(e:HttpResponseEvent ):void{ //       loadedBytes+=data.length;       filesize = Number(e.response.header.getValue('Content-Length'))/1024; //     ns.appendBytes(data); //  data.clear(); //  .      inLoaded = false; }; //    client.request(uri,request); }</span></span></code> </pre> <br><br>  One important point for the code to work: the NetStram object must be in data creation mode, which is turned on so NetStream.play (null).  This must be done before the first video data arrives. <br><br>  Further, as needed, the remaining parts of the file should be loaded in the same pieces of 1 megabyte.  The size of 1 mb (equal to about 15 seconds of video) was obtained experimentally during a large number of tests for our system.  The upload is controlled by a timer that executes the following code on the event. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((!inLoaded) &amp;&amp; (ns.bufferLength &lt;= <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.ceil(loadtime+timeDelta)) &amp;&amp; (loadedBytes &lt; filesize)){ inLoaded = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; loadData(); }</code> </pre><br><br>  Download will run, subject to the following conditions: <br>  inLoaded = false - status indicator, stream true - data is loaded, false - not; <br>  ns.bufferLength &lt;= Math.ceil (loadtime + timeDelta) - in the playback buffer, the remaining time is less than or equal to the time of the previous load (loadtime) plus the delta for the stock (timeDelta); <br>  loadedBytes &lt;filesize - the end of the played file is not reached; <br><br>  An important point in the data creation mode is not generating events NetStream.Play.Start, NetStream.Play.Stop.  Therefore, it is necessary to monitor the amount of downloaded data or the video time played. <br><br>  The variable timeDelta allows you to adjust to the quality of the user's channel: in the event that the playback buffer is empty before the next data fragment is loaded, the delta increases. <br><br><h5>  A bit about rewinding </h5><br>  In data creation mode, some methods of the NetStream class change their normal functionality.  This also applies to the seek () method - it searches for a keyframe (the so-called I-frame) located closest to the specified point.  In the data creation mode, after calling the seek method, the class starts to ignore all the data transmitted by the appendBytes () method, before calling the appendBytesAction () method.  The method argument can have the following NetStreamAppendBytesAction.RESET_BEGIN or NetStreamAppendBytesAction.RESET_SEEK values, the first implies the presence in the fresh data of the new flv file header and zeroes the playback counters in the class.  Here is an example of the video rewind code: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    ,   - -,               for (var i:Number=0;i&lt;positions.length;i++){ if ((positions[i]&lt;=seekpositions)&amp;&amp;(positions[i+1]&gt;=seektpositions)){ //                loadedBytes = positions[i]; break; } } // seek       ns.seek(seektime); //C  NetStream         ,      ns.appendBytesAction(NetStreamAppendBytesAction.RESET_SEEK); //    loadData();</span></span></code> </pre><br><br>  times is an array of navigation points in time; <br>  positions - an array of byte-shifting navigation points; <br><br><h5>  A couple of notes </h5><br>  One feature of the HTTPClientLib library is that a file with a socket security policy (crossdomain.xml) for cross-domain work is requested from port 843 of the server, unlike standard objects that can pick it up from the 80th.  Therefore, the following entry was added to the nginx server configuration: <br><br><pre> <code class="javascript hljs">server { listen <span class="hljs-number"><span class="hljs-number">843</span></span>; server_name localhost; location / { rewrite ^(.*)$ /crossdomain.xml; } error_page <span class="hljs-number"><span class="hljs-number">400</span></span> /crossdomain.xml; location = <span class="hljs-regexp"><span class="hljs-regexp">/crossdomain.xml { root /</span></span>home/www-root; default_type text/x-cross-domain-policy; } }</code> </pre><br><br><h5>  Results </h5><br>  The use of a player that downloads videos using this technique has significantly reduced the amount of ‚Äúunnecessary - parasitic‚Äù traffic, and reduced the load on streaming servers.  An average of 200,000 traffic views decreased by 30%.  However, the above methodology has a ‚Äúnegative‚Äù side, namely: the user has at least 10.1 Flash Player versions. <br><br>  <a href="">Full code example</a> </div><p>Source: <a href="https://habr.com/ru/post/142031/">https://habr.com/ru/post/142031/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../142024/index.html">APT fashion trend - carelessness and how to deal with it</a></li>
<li><a href="../142026/index.html">The full version of the interview of Bill Gates channel "Yahoo! News "(Russian translation)</a></li>
<li><a href="../142028/index.html">Why is JBoss AS 7 so fast?</a></li>
<li><a href="../142029/index.html">New NOOK Simple with built-in backlit screen</a></li>
<li><a href="../142030/index.html">Information Relations. How to extract experience from the environment</a></li>
<li><a href="../142032/index.html">Synology Network Storage System XS Video</a></li>
<li><a href="../142033/index.html">Java Startup Promotion</a></li>
<li><a href="../142034/index.html">How to add dynamism in Python 2.7?</a></li>
<li><a href="../142035/index.html">Special project ‚ÄúFriend to Friend‚Äù for RIF + KIB</a></li>
<li><a href="../142038/index.html">Some examples of creative approach when creating ‚ÄúError 404‚Äù pages</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>