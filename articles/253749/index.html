<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>RAII and unhandled exceptions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Surely everyone knows the capital (in the books about C ++) the truth about the wonderful methodology of RAII, if not - I will give a brief descriptio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>RAII and unhandled exceptions</h1><div class="post__text post__text-html js-mediator-article">  Surely everyone knows the capital (in the books about C ++) the truth about the wonderful methodology of RAII, if not - I will give a brief description from Wikipedia. <br><br><div class="spoiler">  <b class="spoiler_title">This is a sample description of this technique.</b> <div class="spoiler_text">  Resource Acquisition Is Initialization (RAII) is a software idiom of object-oriented programming, the meaning of which is that using various software mechanisms, obtaining a certain resource is inextricably combined with initialization, and releasing it with destruction object. <br><br>  A typical (though not the only) way to implement is to organize access to the resource in the constructor, and the release in the destructor of the corresponding class.  Since the destructor of an automatic variable is called when it goes out of scope, the resource is guaranteed to be freed when the variable is destroyed.  This is true in situations where exceptions occur.  This makes RAII a key concept for writing safe with code exceptions in programming languages, where constructors and destructors of automatic objects are called automatically, first of all in C ++. <br></div></div><br>  The last sentence seems to promise a 100% guaranteed result, but as always in life, and especially in C ++, there is a nuance. <br><a name="habracut"></a><br>  Sample code using RAII: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Suppose there is some class that encapsulates network access: <br><br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Network</span></span></span><span class="hljs-class">{</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Network(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> URL &amp;url) : m_url(url) { } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: Url m_url; };</code> </pre> <br>  Create a class that will implement RAII: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LockNet</span></span></span><span class="hljs-class">{</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: LockNet(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Url &amp;url){ m_net = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Network(url); } ~LockNet (){ <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> m_net; } <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> Network * (){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> network; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: Network *m_net; };</code> </pre><br>  Now in the main function we can safely use this resource: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *argv[])</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-function">LockNet </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">net</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"http://habrahabr.ru"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">// -  , //    return 0; }</span></span></span></span></code> </pre><br>  Everything seems to be normal, as RAII promises, even if an exception is generated, the m_net pointer in the LockNet class will be correctly deleted.  Right? <br><br>  Unfortunately no. <br><br>  For some reason, in the description of RAII, it is usually forgotten to write that for the operation of this technique, an exception MUST be intercepted by an exception handler of this type, otherwise, if the handler is not found, std :: terminate () will be terminated, which will crash the program.  Stroustrup describes this in the C ++ (03) Programming Language book, chapter 14.7. <br><br>  Deleting local objects depends on the implementation, somewhere they will be deleted, somewhere on the contrary, so that the developer can see the state of local objects at the time of the exception in the debugger when it loads coredump.  And recommends if you need guaranteed removal of local objects to wrap the code in the main function with a try block - catch (...), which catches any exceptions. <br><br>  T.ch.  in the code of the main function, if there is an exception before the operator return 0 ;, we get the usual leakage of resources. <br>  It is not fatal, since the OS will save coredump and free up the resources occupied by the program. <br><br>  How to make sure of it?  Writing a verification code! <br><br>  In this code, we use smart pointers that implement the RAII technique: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; #include &lt;vector&gt; #include &lt;memory&gt; #include &lt;string&gt; #include &lt;exception&gt; using namespace std; class MyExc { }; class Slot { public: Slot(const std::string &amp;str = "NONAME") : m_name(str) { cout &lt;&lt; "Constructor of slot: " &lt;&lt; m_name &lt;&lt; endl; } virtual ~Slot() { cout &lt;&lt; "Destructor of slot: " &lt;&lt; m_name &lt;&lt; endl; } void sayName() { cout &lt;&lt; "Slot name is: " &lt;&lt; m_name &lt;&lt; endl; throw MyExc(); } private: string m_name; }; void testShared(shared_ptr&lt;Slot&gt; &amp; m_share) { m_share-&gt;sayName(); } int main() { vector&lt;shared_ptr&lt;Slot&gt;&gt; vec {make_shared&lt;Slot&gt;("0"), make_shared&lt;Slot&gt;("1"), make_shared&lt;Slot&gt;("2"), make_shared&lt;Slot&gt;("3"), make_shared&lt;Slot&gt;("4")}; for (auto&amp; x:vec) testShared(x); return 0; }</span></span></span></span></code> </pre><br>  Compiling and running this program, we get the output: <br><br><blockquote>  Constructor of slot: 0 <br>  terminate called after throwing an instance of 'MyExc' <br>  Constructor of slot: 1 <br>  Constructor of slot: 2 <br>  Constructor of slot: 3 <br>  Constructor of slot: 4 <br>  Slot name is: 0 </blockquote><br>  We rewrite the main function, wrapping the call to the function that generates an exception in the try - catch block: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;Slot&gt;&gt; vec{make_shared&lt;Slot&gt;(<span class="hljs-string"><span class="hljs-string">"0"</span></span>), make_shared&lt;Slot&gt;(<span class="hljs-string"><span class="hljs-string">"1"</span></span>), make_shared&lt;Slot&gt;(<span class="hljs-string"><span class="hljs-string">"2"</span></span>), make_shared&lt;Slot&gt;(<span class="hljs-string"><span class="hljs-string">"3"</span></span>), make_shared&lt;Slot&gt;(<span class="hljs-string"><span class="hljs-string">"4"</span></span>)}; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> &amp;x:vec) testShared(x); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception &amp; ex){ <span class="hljs-built_in"><span class="hljs-built_in">cout</span></span>&lt;&lt;ex.what()&lt;&lt;<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (...){ <span class="hljs-built_in"><span class="hljs-built_in">cout</span></span>&lt;&lt;<span class="hljs-string"><span class="hljs-string">"Unexpected exception"</span></span>&lt;&lt;<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; }</code> </pre><br>  And, voila - everything starts working as it should. <br><br>  Not only constructors are called, but also destructors of objects stored in smart pointers. <br><br>  The output of the program: <br><br><blockquote>  Constructor of slot: 0 <br>  Constructor of slot: 1 <br>  Constructor of slot: 2 <br>  Constructor of slot: 3 <br>  Constructor of slot: 4 <br>  Slot name is: 0 <br>  Unexpected exception <br>  Destructor of slot: 0 <br>  Destructor of slot: 1 <br>  Destructor of slot: 2 <br>  Destructor of slot: 3 <br>  Destructor of slot: 4 <br></blockquote><br><br>  However, everything is according to the standard: <br><br>  <i>15.2 Constructors and destructors</i> <i><br><br></i>  <i>1. As control passes from a throw-expression to a handler, destructors are invoked for all automatic objects.</i> <i><br></i>  <i>constructed since the try block was entered.</i>  <i>The automatic objects are destroyed.</i> <i><br></i>  <i>completion of their construction.</i> <i><br><br></i>  <i>3. Try the block to a</i> <i><br></i>  <i>throw-expression is called ‚Äústack unwinding.‚Äù If a destructor called during stack unwinding exits with an</i> <i><br></i>  <i>exception, std :: terminate is called (15.5.1).</i> <i><br><br></i>  <i>15.3 Handling an exception</i> <i><br><br></i>  <i>9 If no matching handler is found, the function std :: terminate () is called;</i>  <i>whether or not the stack is</i> <i><br></i>  <i>call this std :: terminate () is implementation-defined (15.5.1).</i> <br><br>  It was tested on g ++ (Ubuntu 4.9.2-0ubuntu1 ~ 14.04) 4.9.2, Visual Studio 2013 CE. <br><br><h4>  Links </h4><br>  <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D0%25BB%25D1%2583%25D1%2587%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D1%2580%25D0%25B5%25D1%2581%25D1%2583%25D1%2580%25D1%2581%25D0%25B0_%25D0%25B5%25D1%2581%25D1%2582%25D1%258C_%25D0%25B8%25D0%25BD%25D0%25B8%25D1%2586%25D0%25B8%25D0%25B0%25D0%25BB%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">RAII</a> <br>  <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2013/n3690.pdf">ISO C ++</a> </div><p>Source: <a href="https://habr.com/ru/post/253749/">https://habr.com/ru/post/253749/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253737/index.html">Expansion of system (and not only) tables in MODX Revolution</a></li>
<li><a href="../253739/index.html">Crowdin: anesthetic for localization</a></li>
<li><a href="../253741/index.html">Low Cost SAN Storage on LSI Syncro Part 2</a></li>
<li><a href="../253743/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ152 (March 16 - 22, 2015)</a></li>
<li><a href="../253745/index.html">Creating full-fledged applications on Max 7. Part 1 - Task setting, visual programming</a></li>
<li><a href="../253751/index.html">We connect SAP Solution Manager and SAP WPB to the joy of users and support services</a></li>
<li><a href="../253755/index.html">Machine learning - 3. Poisson random process: views and clicks</a></li>
<li><a href="../253759/index.html">Linux file system entirely on tmpfs - speed without compromise</a></li>
<li><a href="../253761/index.html">Pattern-matching (one more) in coffeescript</a></li>
<li><a href="../253763/index.html">Testing the Intel¬Æ Storage System JBOD 2000 Family Shelf</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>