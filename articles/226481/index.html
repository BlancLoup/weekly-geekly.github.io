<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Restoring a PostgreSQL database from a WAL backup with skipping part of records</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introductory 
 In PostgreSQL, there is such an interesting technical solution - before actually starting to change something in the files of the datab...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Restoring a PostgreSQL database from a WAL backup with skipping part of records</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introductory </h4><br>  In PostgreSQL, there is such an interesting technical solution - before actually starting to change something in the files of the database itself, the DBMS writes already translated commands to the internal format in a special log - Write-Ahead Log, and after successful completion of the transaction makes a mark in this log.  This was done to recover from failures, but in the end, the inquisitive mind of the developers came to the idea of ‚Äã‚Äãusing this log for backup and replication.  In principle, it is logical, all the moves in it are recorded, moreover, you can not just restore the data from the backup, but also restore the state of the database to a certain point in time, interrupting the playback of the WAL-log records at the right moment. <br><br>  However, let's consider such a scenario - let's say on Monday you made a basic backup and started archiving WAL logs, on Wednesday you fulfilled a deletion request with an erroneous mask, and found it only on Friday, when the manager reported about the disappearance of some necessary record.  In this situation, we can only recover from the backup until Wednesday, losing all the work of managers for Thursday and Friday. <br><br>  A logical question arises, is it possible to make the playback of WAL logs from Monday to Friday, while excluding our ‚Äúerroneous‚Äù request? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Normally, I would limit myself to a forum question, but I had 2 distributions of FreeBSD, 10 tarballs with PostgreSQL source codes of different versions, 10GB of space on the screw, gcc, two relatively unloaded weeks, as well as tequila, rum, a box of beer and fragmentary memories of the syntax of the C language. Not that it was the necessary supply for a solution, but since I looked into the source codes, it was difficult to stop ... <br><a name="habracut"></a><br>  So, for the experiments, FreeBSD 10 and PostgreSQL 9.2.8 are taken from its ports.  The client of the corresponding version can be set up using pkg, there is no need to change anything in it  I apologize in advance for possible captaincy, but the text was written both for beginners and for quickly refreshing everything in my head if necessary, so all the teams are detailed. <br><br><h4>  Server setup and basic setup </h4><br><pre><code class="bash hljs">root@leninzhiv&gt; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/ports/databases/postgresql92-server root@leninzhiv&gt; make fetch root@leninzhiv&gt; make extract</code> </pre> <br><br>  The downloaded source file is deployed to the work folder in the port directory.  I honestly did not understand how to rebuild the source code after the changes, there is no sort of make rebuild, make clean in turn simply demolishes this folder with all the changes.  So I just copied the work folder to my home directory, made changes there, then copied it to the port folder and ran make install. <br><br>  So far, we are not changing anything, just set postgres: <br><pre> <code class="bash hljs">root@leninzhiv&gt; make install</code> </pre><br><br>  Create folders for archives: <br><pre> <code class="bash hljs">root@leninzhiv&gt; mkdir -p /usr/db_archive/wal root@leninzhiv&gt; mkdir -p /usr/db_archive/data root@leninzhiv&gt; chown -R pgsql:wheel /usr/pg_archive</code> </pre><br><br>  Postgres requires that the data directory has access only for the user to the poet, changing the rights: <br><pre> <code class="bash hljs">root@leninzhiv&gt; chmod 0700 /usr/pg_archive/data</code> </pre><br><br>  We make a primitive setting.  It makes sense to go under pgsql postgresovuyu uchetku so that there is less trouble with file permissions. <br><br><pre> <code class="bash hljs">root@leninzhiv&gt; su - pgsql pgsql@leninzhiv&gt; initdb -D /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/pgsql/data</code> </pre><br><br>  Uncomment and edit the archiving parameters of WAL logs in /usr/local/pgsql/data/postgresql.conf: <br>  archive_mode = on <br>  wal_level = archive <br>  archive_command = 'test!  -f / usr / db_archive / wal /% f &amp;&amp; cp% p / usr / db_archive / wal /% f ' <br>  (An example is there in the cells) <br>  max_wal_senders = 1 <br><br>  In /usr/local/pgsql/data/pg_hba.conf uncomment the line <br>  local replication pgsql trust <br><br>  We start the server <br><pre> <code class="bash hljs">pgsql@leninzhiv&gt; /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/rc.d/postgresql start</code> </pre><br><br>  Making a base backup <br><pre> <code class="bash hljs">pgsql@leninzhiv&gt; pg_basebackup -D /usr/db_archive/data/</code> </pre><br><br>  We check that the / usr / db_archive / data / folder should contain a copy of the data directory, and / usr / db_archive / wal / should contain WAL files of the type approximately 000000010000000000000003 <br><br>  Copy to the folder with backup data directory config for recovery <br><pre> <code class="bash hljs">cp /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/share/postgresql/recovery.conf.sample /usr/db_archive/data/recovery.conf</code> </pre><br>  and in it we will uncomment and edit the recovery command (the example is also close in the comments). <br>  restore_command = 'cp / usr / db_archive / data /% f% p' <br><br>  Make entries: <br><pre> <code class="bash hljs">pgsql@leninzhiv&gt; psql -U pgsql -d postgres</code> </pre><br><pre> <code class="sql hljs">postgres=<span class="hljs-comment"><span class="hljs-comment"># CREATE TABLE z (z_id serial, z_text character(50)); postgres=# INSERT INTO z (z_text) VALUES ('Karlin'); postgres=# INSERT INTO z (z_text) VALUES ('Petrov'); postgres=# INSERT INTO z (z_text) VALUES ('Ivanov'); postgres=# INSERT INTO z (z_text) VALUES ('Kaplan'); postgres=# INSERT INTO z (z_text) VALUES ('Karas'); postgres=# INSERT INTO z (z_text) VALUES ('Bukova'); postgres=# INSERT INTO z (z_text) VALUES ('Sidorova'); postgres=# INSERT INTO z (z_text) VALUES ('Karman'); postgres=# INSERT INTO z (z_text) VALUES ('Nikolaev');</span></span></code> </pre><br><br>  Delete the entries: <br><pre> <code class="sql hljs">postgres=<span class="hljs-comment"><span class="hljs-comment"># DELETE FROM z WHERE z_text ILIKE 'Ka%';</span></span></code> </pre><br><br>  We change records, we introduce new, disco <br><pre> <code class="sql hljs">postgres=<span class="hljs-comment"><span class="hljs-comment"># UPDATE z SET z_text='Petrova' WHERE z_text='Sidorova'; postgres=# INSERT INTO z (z_text) VALUES ('Kruglov'); postgres=# UPDATE z SET z_text='Alexeeva' WHERE z_text='Bukova'; postgres=# INSERT INTO z (z_text) VALUES ('Kvadrat');</span></span></code> </pre><br><br>  We discover that deleting records by mask was not a very good idea, and together with Karlin we deleted Kaplan, Karas and Karman. <br><br>  Stop the server <br><pre> <code class="bash hljs">pgsql@leninzhiv&gt; /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/rc.d/postgresql stop pgsql@leninzhiv&gt; <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> root@leninzhiv&gt;</code> </pre><br>  and start thinking what to do. <br><br><h4>  Go to the source </h4><br>  As you remember, after make extract, I copied the work folder from the port directory to my home folder, and made changes to it.  Therefore, go there.  If someone can tell how to make changes in the source in the port folder itself, everything will be rebuilt normally after the changes made to the code will be extremely grateful. <br><br>  First, I set myself the goal to find the place where they are read from the WAL-logs recording file. <br><br>  I found the file with WAL-related code by searching for the string "WAL" in the contents of the files in the work / postgresql-9.2.8 / src directory and common sense, it turned out to be xlog.c <br><br>  I do not know how to trace programs in C, so just at the beginning of each function I added a record of its name to the file, I assembled it and launched it. <br><br>  The file has the following result: <br><pre> <code class="hljs vala"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> check_wal_buffers(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *newval, <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> **extra, GucSource source) <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> assign_xlog_sync_method(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> new_sync_method, <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *extra) Size XLOGShmemSize(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> XLOGChooseNumBuffers(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> check_wal_buffers(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *newval, <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> **extra, GucSource source) <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> XLOGShmemInit(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) Size XLOGShmemSize(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ReadControlFile(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> StartupXLOG(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ReadControlFile(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * str_time(pg_time_t tnow) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ValidateXLOGDirectoryStructure(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> readRecoveryCommandFile(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> List * readTimeLineHistory(TimeLineID targetTLI) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> read_backup_label(XLogRecPtr *checkPointLoc, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> *backupEndRequired, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> *backupFromStandby) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> XLogRecord * ReadCheckpointRecord(XLogRecPtr RecPtr, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> whichChkpt) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> XLogRecord * ReadRecord(XLogRecPtr *RecPtr, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> emode, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> fetching_ckpt) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> XLogPageRead(XLogRecPtr *RecPtr, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> emode, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> fetching_ckpt, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> randAccess) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> XLogFileReadAnyTLI(<span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span> log, <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span> seg, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> emode, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sources) ... <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> XLogRecord * ReadRecord(XLogRecPtr *RecPtr, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> emode, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> fetching_ckpt) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> XLogPageRead(XLogRecPtr *RecPtr, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> emode, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> fetching_ckpt, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> randAccess) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> RecordIsValid(XLogRecord *record, XLogRecPtr recptr, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> emode) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> recoveryStopsHere(XLogRecord *record, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> *includeThis) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CheckRecoveryConsistency(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> XLogRecord * ReadRecord(XLogRecPtr *RecPtr, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> emode, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> fetching_ckpt) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> XLogPageRead(XLogRecPtr *RecPtr, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> emode, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> fetching_ckpt, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> randAccess) ...</code> </pre><br><br>  In general, I got the impression that the main action takes place in the ReadRecord -&gt; XLogPageRead -&gt; RecordIsValid -&gt; RecoveryStopsHere -&gt; CheckRecoveryConsistency cycle. <br><br>  A closer acquaintance with the ReadRecord function showed that it returns a record in two places - as a return record and as a return (XLogRecord *) buffer, with the above simple method we specify that in the recovery process from WAL-logs, the return goes through the return (XLogRecord *) buffer.  Perfectly!  We write the result to the file. <br><br>  The structure of the XLogRecord type can be viewed in the xlog.h file and it is rather laconic: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XLogRecord</span></span></span><span class="hljs-class"> {</span></span> pg_crc32 xl_crc; <span class="hljs-comment"><span class="hljs-comment">/* CRC for this record */</span></span> XLogRecPtr xl_prev; <span class="hljs-comment"><span class="hljs-comment">/* ptr to previous record in log */</span></span> TransactionId xl_xid; <span class="hljs-comment"><span class="hljs-comment">/* xact id */</span></span> uint32 xl_tot_len; <span class="hljs-comment"><span class="hljs-comment">/* total len of entire record */</span></span> uint32 xl_len; <span class="hljs-comment"><span class="hljs-comment">/* total len of rmgr data */</span></span> uint8 xl_info; <span class="hljs-comment"><span class="hljs-comment">/* flag bits, see below */</span></span> RmgrId xl_rmid; <span class="hljs-comment"><span class="hljs-comment">/* resource manager for this record */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* ACTUAL LOG DATA FOLLOWS AT END OF STRUCT */</span></span> } XLogRecord;</code> </pre><br><br>  Well, if we have a length, then we use it to output the contents of the record to the file, before adding (XLogRecord *) buffer we add the buffer: <br><br><pre> <code class="cpp hljs">FILE *pf2 = fopen(<span class="hljs-string"><span class="hljs-string">"/usr/local/pgsql/data/log3.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"a"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *buf_poi = buffer; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint32 i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; record-&gt;xl_tot_len; i++) {fputc(*buf_poi, pf2); buf_poi++;} <span class="hljs-built_in"><span class="hljs-built_in">fprintf</span></span>(pf2, <span class="hljs-string"><span class="hljs-string">"\n crc32: %u \n xl_xid=%i \n"</span></span>, record-&gt;xl_crc, record-&gt;xl_xid); fclose(pf2);</code> </pre><br><br>  We demolish the old Postgres, collect and install a new one: <br><br><pre> <code class="bash hljs">root@leninzhiv&gt; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/ports/databases/postgresql92-server root@leninzhiv&gt; make deinstall</code> </pre><br><br>  I remind that we copied the work directory into the home folder and made all changes to the code there.  Now copy it to the place of the work folder in the port directory. <br><pre> <code class="bash hljs">root@leninzhiv&gt; rm -R /usr/ports/databases/postgresql92-server/work root@leninzhiv&gt; cp -R ~/work /usr/ports/databases/postgresql92-server/work root@leninzhiv&gt; make install</code> </pre><br><br>  Delete the database files and copy the base backup in their place.  WAL-files themselves catch up. <br><pre> <code class="bash hljs">root@leninzhiv&gt; su - pgsql pgsql@leninzhiv&gt; /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/rc.d/postgresql stop pgsql@leninzhiv&gt; rm -R /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/pgsql/data pgsql@leninzhiv&gt; cp -R /usr/db_archive/data /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/pgsql/data pgsql@leninzhiv&gt; /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/rc.d/postgresql start pgsql@leninzhiv&gt; psql -U pgsql -d postgres</code> </pre><br><pre> <code class="sql hljs">postgres=<span class="hljs-comment"><span class="hljs-comment"># select * from z; postgres=# \q</span></span></code> </pre><br><br><pre> <code class="bash hljs">pgsql@leninzhiv&gt; /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/rc.d/postgresql stop</code> </pre><br><br>  We look at the contents of the log3.txt file, first we go through many large records, apparently creating service tables and data, towards the end we see: <br><br><pre> <code class="hljs smalltalk">#{####<span class="hljs-type"><span class="hljs-type">T</span></span>####<span class="hljs-symbol"><span class="hljs-symbol">#r</span></span>##<span class="hljs-symbol"><span class="hljs-symbol">#R</span></span>#### ###### ####<span class="hljs-number"><span class="hljs-number">0</span></span>###@###### <span class="hljs-symbol"><span class="hljs-symbol">#e</span></span>######## ##<span class="hljs-symbol"><span class="hljs-symbol">#gNikolaev</span></span> crc32: <span class="hljs-number"><span class="hljs-number">3682278083</span></span> l_xid=<span class="hljs-number"><span class="hljs-number">1002</span></span> <span class="hljs-type"><span class="hljs-type">W</span></span># ####<span class="hljs-symbol"><span class="hljs-symbol">#U</span></span>#####,### ###`#######‚Ä∫–å%—õ###### crc32: <span class="hljs-number"><span class="hljs-number">3423214679</span></span> xl_xid=<span class="hljs-number"><span class="hljs-number">1002</span></span> r<span class="hljs-comment"><span class="hljs-comment">" ####xU#####5######## ###### ####0###@########## crc32: 2698322546 xl_xid=1003 #%2####U#####5######## ###### ####0###@########## crc32: 841341184 xl_xid=1003 #W####U#####5######## ###### ####0###@########## crc32: 3881244668 xl_xid=1003 Z7######V#####5######## ###### ####0###@########## crc32: 4028315482 xl_xid=1003 ¬µ–Ñ–à—í####PV#####,### ###`########–Ñ–å%—õ###### crc32: 2426645173 xl_xid=1003 —ö-B####‚Ç¨V#####y###Y###@ ###### ####0###@########I##### ####–Ç#(######gPetrova crc32: 1110285523 xl_xid=1004</span></span></code> </pre><br><br>  We see that between the familiar names of Nikolaev and Petrov there are 4 similar entries and one dissimilar, under one transaction number.  Apparently, these are delete commands, which means that commands like ‚Äúerase row 50 in table 64822‚Äù are already recorded in the WAL-log.  Basically, as expected.  We add a check, which, when xl_xid = 1003, returns NULL instead of a record. <br><br>  Again, delete the old Postgres, build and install a new one, start the recovery ... <br><br>  Deleted recordings on the spot!  True, everything that should have happened after the deletion did not happen :( Well, it didn‚Äôt work out of a rush. In general, this is understandable, because before playing the record, integrity checks and all that happens are performed. <br><br>  So goal number 2 is to find where the record is ‚Äúplaying‚Äù.  A quick search for the use of readRecord in the same file led me to the void StartupXLOG (void) function ... And here I clearly understood that I had gone the wrong way until now, because almost immediately after the second or third appearance of the readRecord call in this function (they are next) immediately comes firstly a chic diagnostic piece, and secondly, immediately after the comment ‚ÄúNow apply the WAL record itself‚Äù - the record play command RmgrTable [record-&gt; xl_rmid] .rm_redo (EndRecPtr, record); <br><br>  Change this piece of code to <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (record-&gt;xl_xid==<span class="hljs-number"><span class="hljs-number">1003</span></span>) {} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> RmgrTable[record-&gt;xl_rmid].rm_redo(EndRecPtr, record);</code> </pre><br><br>  Again we reassemble, we start, we check ... Victory!  Deleted records in place and changes made after deletion are also in place! <br><br><h4>  Focusing on the terrain </h4><br>  Well, this is undoubtedly good, but we solved the problem on a very limited set of data, but how to find the necessary entry in the logs of the working database? <br><br>  Let's return to the mentioned smart diagnostic piece in the StartupXLOG function: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> WAL_DEBUG </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (XLOG_DEBUG || (rmid == RM_XACT_ID &amp;&amp; trace_recovery_messages </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;= DEBUG2) || (rmid != RM_XACT_ID &amp;&amp; trace_recovery_messages &lt;= DEBUG3)) { StringInfoData buf; initStringInfo(&amp;buf); appendStringInfo(&amp;buf, "REDO @ %X/%X; LSN %X/%X: ", ReadRecPtr.xlogid, ReadRecPtr.xrecoff, EndRecPtr.xlogid, EndRecPtr.xrecoff); xlog_outrec(&amp;buf, record); appendStringInfo(&amp;buf, " - "); RmgrTable[record-&gt;xl_rmid].rm_desc(&amp;buf, record-&gt;xl_info, XLogRecGetData(record)); elog(LOG, "%s", buf.data); pfree(buf.data); } #endif</span></span></span></span></code> </pre><br><br>  You can simply include the output in the logs, uncommenting #define WAL_DEBUG in pg_config_manual.h and adding wal_debug = on to the postgresql.conf file, but I, by habit, sent the output to a separate file.  This piece, as I understand it, displays the command description using the rm_desc function (in this case, RmgrTable is an array of functions?), It looks like this: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">REDO</span></span> @ <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3015500</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">LSN</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3015578</span></span>: prev <span class="hljs-number"><span class="hljs-number">0</span></span>/30154D0; <span class="hljs-attribute"><span class="hljs-attribute">xid</span></span> <span class="hljs-number"><span class="hljs-number">1002</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">len</span></span> <span class="hljs-number"><span class="hljs-number">82</span></span>: Heap - insert: rel <span class="hljs-number"><span class="hljs-number">1663</span></span>/<span class="hljs-number"><span class="hljs-number">12318</span></span>/<span class="hljs-number"><span class="hljs-number">16386</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">tid</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">9</span></span> REDO @ <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3015578</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">LSN</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/30155A8: prev <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3015500</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">xid</span></span> <span class="hljs-number"><span class="hljs-number">1002</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">len</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>: Transaction - commit: <span class="hljs-number"><span class="hljs-number">2014</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>.<span class="hljs-number"><span class="hljs-number">537874</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span> REDO @ <span class="hljs-number"><span class="hljs-number">0</span></span>/30155A8; <span class="hljs-attribute"><span class="hljs-attribute">LSN</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/30155E0: prev <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3015578</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">xid</span></span> <span class="hljs-number"><span class="hljs-number">1003</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">len</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>: Heap - delete: rel <span class="hljs-number"><span class="hljs-number">1663</span></span>/<span class="hljs-number"><span class="hljs-number">12318</span></span>/<span class="hljs-number"><span class="hljs-number">16386</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">tid</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> REDO @ <span class="hljs-number"><span class="hljs-number">0</span></span>/30155E0; <span class="hljs-attribute"><span class="hljs-attribute">LSN</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3015618</span></span>: prev <span class="hljs-number"><span class="hljs-number">0</span></span>/30155A8; <span class="hljs-attribute"><span class="hljs-attribute">xid</span></span> <span class="hljs-number"><span class="hljs-number">1003</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">len</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>: Heap - delete: rel <span class="hljs-number"><span class="hljs-number">1663</span></span>/<span class="hljs-number"><span class="hljs-number">12318</span></span>/<span class="hljs-number"><span class="hljs-number">16386</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">tid</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">4</span></span> REDO @ <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3015618</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">LSN</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3015650</span></span>: prev <span class="hljs-number"><span class="hljs-number">0</span></span>/30155E0; <span class="hljs-attribute"><span class="hljs-attribute">xid</span></span> <span class="hljs-number"><span class="hljs-number">1003</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">len</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>: Heap - delete: rel <span class="hljs-number"><span class="hljs-number">1663</span></span>/<span class="hljs-number"><span class="hljs-number">12318</span></span>/<span class="hljs-number"><span class="hljs-number">16386</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">tid</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">5</span></span> REDO @ <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3015650</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">LSN</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3015688</span></span>: prev <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3015618</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">xid</span></span> <span class="hljs-number"><span class="hljs-number">1003</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">len</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>: Heap - delete: rel <span class="hljs-number"><span class="hljs-number">1663</span></span>/<span class="hljs-number"><span class="hljs-number">12318</span></span>/<span class="hljs-number"><span class="hljs-number">16386</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">tid</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span> REDO @ <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3015688</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">LSN</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/30156B8: prev <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3015650</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">xid</span></span> <span class="hljs-number"><span class="hljs-number">1003</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">len</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>: Transaction - commit: <span class="hljs-number"><span class="hljs-number">2014</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>.<span class="hljs-number"><span class="hljs-number">54153</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span> REDO @ <span class="hljs-number"><span class="hljs-number">0</span></span>/30156B8; <span class="hljs-attribute"><span class="hljs-attribute">LSN</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3015738</span></span>: prev <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3015688</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">xid</span></span> <span class="hljs-number"><span class="hljs-number">1004</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">len</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span>: Heap - hot_update: rel <span class="hljs-number"><span class="hljs-number">1663</span></span>/<span class="hljs-number"><span class="hljs-number">12318</span></span>/<span class="hljs-number"><span class="hljs-number">16386</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">tid</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">new</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre><br><br>  This is an already familiar piece with transaction number 1003, and from it we can see that yes, these are four commands for deletion and one confirmation of the transaction.  In the delete commands, we see rel - a table identifier in the format ‚Äúoid namespace / oid of the database / oid of the table‚Äù.  Corresponding numbers can be obtained by queries. <br><br>  SELECT oid, spcname FROM pg_catalog.pg_tablespace; <br>  SELECT oid, datname FROM pg_catalog.pg_database; <br>  and, suddenly, <br>  SELECT oid, relname FROM pg_catalog.pg_class; <br><br>  The second landmark is the timestamp in the transaction description.  Well, there is no need to explain anything, if we know when this crime was commited, we will find the corresponding records. <br><br>  Well, as an alternative way, you can go back to viewing records in the cracks, and navigate by scraps of text that were passed as parameters to the INSERT and UPDATE commands, if we remember the requests with which parameters were made shortly before or after the desired "erroneous" request.  In the case of UPDATE, however, you can find only those strings that were used as a new value, if the string was used to search for records, then it is not found in WAL logs. <br><br>  And finally, I can note that in the PostgreSQL 9.3 controller, the pg_xlogdump utility has appeared, which seems to be aimed at solving the problem of providing the contents of WAL logs in human-readable form.  If you are interested in some features, it makes sense to write to developers. <br><br>  It is possible that the use of this method on the archives of the working database will have some kind of pitfalls.  For example, how will UPDATE work if we ‚Äúskip‚Äù the deletion of a part of records on a database that uses frequent vacuuming?  I did not check.  But in any case, in the case it is better to have at least some hope of correcting the error than none at all. </div><p>Source: <a href="https://habr.com/ru/post/226481/">https://habr.com/ru/post/226481/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../226469/index.html">Making multiplayer games on Go and WebSocket</a></li>
<li><a href="../226471/index.html">How to reduce critical system downtime</a></li>
<li><a href="../226473/index.html">Self-Service with Cisco UCS Director: How to enable users to independently create virtual servers</a></li>
<li><a href="../226477/index.html">The price of 3D printing, and how to independently calculate the cost of 3D printing</a></li>
<li><a href="../226479/index.html">Blackphone, protected from listening to the smartphone, will go on sale in July</a></li>
<li><a href="../226483/index.html">Startup step by step: the future of online education</a></li>
<li><a href="../226487/index.html">Kdump - diagnosis and analysis of the causes of kernel failures</a></li>
<li><a href="../226491/index.html">New Horizons out of hibernation: where is the interplanetary station now?</a></li>
<li><a href="../226493/index.html">Programming for Android. 2nd ed</a></li>
<li><a href="../226495/index.html">10 main rules for killing beetles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>