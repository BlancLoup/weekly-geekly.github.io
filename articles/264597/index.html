<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Forensic VS Schroeder: Gaining Access to Deleted Files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The basis of one of the tasks of the online stage NeoQUEST-2016 was the forsensica, namely, working with the means of restoring the previous state of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Forensic VS Schroeder: Gaining Access to Deleted Files</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/files/091/2ee/3ef/0912ee3effc540bf9c1992f05ab1f062.png">  The basis of one of the tasks of the online stage NeoQUEST-2016 was the forsensica, namely, working with the means of restoring the previous state of Windows partitions.  Professionals know and often use the capabilities of this technology during pentest or investigation of information security incidents. <br><br>  Many well-known <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B5%25D0%25BD%25D0%25B5%25D0%25B2%25D0%25B0%25D1%258F_%25D0%25BA%25D0%25BE%25D0%25BF%25D0%25B8%25D1%258F">Volume Shadow Copy</a> is a volume shadow copy service that first appeared in Windows Sever 2003. It allows you to take and restore snapshots of the file system (snapshots), including the system partition.  Also, past snapshots of a partition can be mounted to a drive letter or folder, just like a regular partition.  Thus, it is possible to gain access to the previous state of the system along with <b>ALL</b> files, including the files currently removed from this section.  All these properties of Volume Shadow Copy can be used by information security experts in the following ways: <br><ol><li>  Access and copy files used by the system or user applications (application password databases, Outlook mailboxes, Thunderbird, Active Directory database). </li><li>  Access and copy deleted files (including securely wiped with a shredder). </li><li>  Hiding the executable files and modules of the malicious backdoor (a snapshot of the file system in which they are present is taken, after which they are removed from the current partition while remaining in the shadow copy). </li></ol><br>  The use of the opportunity from the second point was based on the solution of the NeoQUEST task forignics.  Read more - under the cut! <br><a name="habracut"></a><br><h4>  <b>Initial data</b> </h4><br>  In the task with the name ‚ÄúMissing file‚Äù, the participant was given a link to a torrent; when downloading, participants received 2 files ‚Äî a hard disk dump (* .vhdx file) and a RAM dump (* .dmp file).  When mounting the main file with a dump of the hard disk, the participant found a text file encrypted with the Encrypted File System (EFS).  The contents of this file just can not read!  The private keys of user certificates in Windows OS, including EFS, are protected with an account password.  That is why when it is reset, a warning appears about access to EFS files. <br><br>  Knowledge of one NTLM password hash, as well as SYSKEY, LSAKEY and NL $ KM keys to decrypt a user's private key is not enough.  Thus, having one hard disk dump is not enough.  You must also know the password of the user.  At this stage, participants may not yet know why they need it, but they can restore it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After a quick scan of the contents of the hard disk, the participants found an EFS-encrypted file, the contents of which was clearly the key. <br><br><img src="https://habrastorage.org/files/cc8/2b3/3a2/cc82b33a2925406086fa07aba32fa6bc.png"><br><br>  It was possible to read it only with the help of the certificate of the specified user, and for this you need to know his password. <br><br><h4>  <b>Password retrieval</b> </h4><br>  That is why the participants were given a dump of RAM.  It is easy to guess that the password is extracted from it using the well-known utility mimikatz.  You can do this, for example, using WinDBG and the corresponding extension mimilib.dll.  Below is the process of getting a user password in steps. <br><br><img src="https://habrastorage.org/files/16d/491/16a/16d49116ad7c4d32884b73b09c4d89e7.png"><br><br>  How to use the extension is displayed when it is loaded.  It remains only to execute the sequence of these commands.  As a result, we obtain: <br><br><img src="https://habrastorage.org/files/67b/e58/605/67be586050dd4b8ab6d7c0585193571d.png"><br><br>  After receiving the password, the easiest way to complete the task is to boot from the hard disk image in the virtual machine and log in with the corresponding user.  However, the participants are most disappointed: the EFS certificate with which the file was encrypted is deleted. <br><br>  After all the above steps, you need to restore the deleted certificate.  The dump was made in such a way that it was impossible to recover the certificate using various recovery tools for deleted files.  And here the service of shadow copies of the volume comes to the rescue. <br><br><h4>  <b>Get out of the shadows</b> </h4><br>  You can view existing shadow copies using the <a href="https://technet.microsoft.com/ru-ru/library/Cc754968(v%3DWS.10).aspx">vssadmin</a> utility, which is enabled by default on Windows 7 and higher. <br><br><img src="https://habrastorage.org/files/c27/d28/11f/c27d2811f8804833965dcd20072083be.png"><br><br>  It can be seen that each shadow copy is characterized by a unique identifier in the form of a GUID.  The shadow copies themselves are represented as objects of the ‚ÄúGeneric Volume Shadow Copy‚Äù type. <br><br><img src="https://habrastorage.org/files/5bf/60d/42b/5bf60d42b5c5413ebc3d0d6a76fdd884.png"><br><br>  You can mount it as a volume in a new drive letter or create a link as a folder.  It is also possible to access the contents of the shadow copy using the device name, which appears in the properties of the copy itself. <br><br>  Now the participants had to restore the certificate's private key values ‚Äã‚Äãfor the user's store (in this case, access to the file is open). <br><br>  This can be done by restoring the corresponding registry keys and the private key file in the% AppData% \ Microsoft \ Crypto \ RSA folder in which the user's private keys are stored.  The necessary information can be obtained from the shadow copy (by mounting it or making a link to it). <br><br>  Or you could go a simpler way - roll back the state of the partition to the shadow copy.  After that, it was enough to log in to the system and export the certificate with the private key to a file. <br><br>  In the current state of the system, it was necessary to import the certificate with the private key into the user's personal certificate store and open the file. <br><br>  You can roll back using the diskshadow tool from the Windows Sever toolkit by connecting the disk to a virtual machine with this OS, or you can use the corresponding WMI objects for the volumes and their copies.  Using diskshadow is an easier and faster way.  To roll back a partition to a snapshot, you need to request a copy ID, and then restore it. <br><br>  We get the shadow copy ID: <br><br><img src="https://habrastorage.org/files/807/fad/774/807fad774cf14803ad1cb97ecb3d7489.png"><br><br>  Restoring the shadow copy: <br><br><img src="https://habrastorage.org/files/2d0/e56/8d5/2d0e568d5ded4275942a8fb4d230e777.png"><br><br>  Boot from the resulting "past" state of the system.  Certificate present.  This can be understood by the fact that immediately there is an offer from Windows to backup the key.  Export it to a file. <br><br><img src="https://habrastorage.org/files/aca/5a2/ec3/aca5a2ec3576429da48bf71d104d9dfc.png"><br><br>  Load in the "current" state of the disk.  We import the certificate on the ‚Äúcurrent‚Äù state of the system in the user's personal certificate storage.  Now the file can be opened and read.  The contents of the file is the key to the passage of the job! <br><br><h4>  <b>Draw conclusions</b> </h4><br>  From all of the above, the following conclusions can be drawn: <br>  1. It is not necessary to save important data, which must then be deleted, on the system volume (the ‚ÄúC: \‚Äù drive).  They may be in the shadow copy, but you may not know or remember. <br>  2. If you accidentally deleted some important file from the system partition, you can try your luck and try to find it in the saved shadow copy. </div><p>Source: <a href="https://habr.com/ru/post/264597/">https://habr.com/ru/post/264597/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264587/index.html">MCMC and Bayesian statistics in BASIC</a></li>
<li><a href="../264589/index.html">Live Chat & ActionCable</a></li>
<li><a href="../264591/index.html">Analysis of large semantic cores, or "Robot Recognizer"</a></li>
<li><a href="../264593/index.html">Modding air conditioner Stulz CyberAir</a></li>
<li><a href="../264595/index.html">How to start a data center to sail</a></li>
<li><a href="../264599/index.html">Man is the main vulnerability. A little bit about social engineering at PHDays V</a></li>
<li><a href="../264601/index.html">Malefactors actively exploit new vulnerability in Windows</a></li>
<li><a href="../264603/index.html">Adobe has added new security restrictions for Flash Player.</a></li>
<li><a href="../264607/index.html">Universal JavaScript</a></li>
<li><a href="../264609/index.html">Immersion into the abyss of the Python interpreter. P1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>