<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>It is not so easy to take and write SELECT, if the vendor does not allow ... but we still write</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR: GitHub: // PastorGL / AQLSelectEx . 





 Once, not in the cold, but already winter time, and specifically a couple of months ago, for the pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>It is not so easy to take and write SELECT, if the vendor does not allow ... but we still write</h1><div class="post__text post__text-html js-mediator-article"><p>  TL; DR: <a href="https://github.com/PastorGL/AQLSelectEx">GitHub: // PastorGL / AQLSelectEx</a> . </p><br><p><img src="https://habrastorage.org/webt/lk/ke/y2/lkkey2_mk3a-rbhftk9jja_vlyw.png" alt="Aerospike AQL SELECT"></p><br><p>  Once, not in the cold, but already winter time, and specifically a couple of months ago, for the project I'm working on (something Geospatial based on Big Data), it took a quick NoSQL / Key-Value storage. </p><br><p>  We quite successfully chew terabytes of source codes with the help of Apache Spark, but the ridiculously collapsed volume (only millions of records) has to be stored somewhere.  And it is very desirable to store it in such a way that it can be associated with each result line (this is one digit) metadata (but quite a lot of them) to quickly find and give out. </p><a name="habracut"></a><br><p>  In this sense, the Hadupow stack formats are of little use, and relational databases on millions of records slow down, and the set of metadata is not so fixed as to fit well into the rigid scheme of the usual RDBMS - PostgreSQL in our case.  No, it normally supports JSON, but it still has problems with indices on millions of records.  The indices swell, the table becomes necessary to partition, and such a confusion begins with the administration that nafig-nafig. </p><br><p>  Historically, MongoDB was used as a NoSQL on the project, but Monga shows itself worse and worse (especially in terms of stability) over time, so it was gradually decommissioned.  A quick search for a more modern, faster, less buggy, and generally better alternative led to the <a href="https://www.aerospike.com/">Aerospike</a> .  Many big guys have it in favor, and I decided to check it out. </p><br><p>  Tests have shown that, indeed, the data is stored in the story straight from Sparkov's job with a whistle, and the search for many millions of entries is much faster than in Mong.  Yes, and she eats less memory.  But it turned out one "but."  Aerospay client API is purely functional, not declarative. </p><br><p>  This is not important for writing to story, because all the same, all the field types of each resulting record have to be determined locally in the job itself - and the context is not lost.  The functional style is right here, all the more so under the spark it is different to write code and it will not work.  But in the web-face, which should upload the result to the outside world, and is a regular web application in the spring, it would be much more logical to form a standard SQL SELECT from a user form, which would be full of AND and OR - <strong>predicates</strong> , - in the WHERE clause. </p><br><p>  Let me explain the difference on this synthetic example: </p><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> foo, bar, baz, qux, quux <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> namespace.set <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (baz!=<span class="hljs-string"><span class="hljs-string">'a'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (foo&gt;<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (bar&lt;=<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> foo&gt;<span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> quux <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'%force%'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> (qux <span class="hljs-keyword"><span class="hljs-keyword">WITHIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-string"><span class="hljs-string">'{\"type\": \"Polygon\", \"coordinates\": [0.0, 0.0],[1.0, 0.0],[1.0, 1.0],[0.0, 1.0],[0.0, 0.0]}'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> GEOJSON)</code> </pre> <br><p>  - this is both readable and relatively clear, which records the customer wanted to get.  If such a request is thrown into the log as it is, it can be pulled later for manual debugging.  Which is very convenient when analyzing any strange situations. </p><br><p>  And now we will look at the appeal to the predicate API in a functional style: </p><br><pre> <code class="java hljs">Statement reference = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Statement(); reference.setSetName(<span class="hljs-string"><span class="hljs-string">"set"</span></span>); reference.setNamespace(<span class="hljs-string"><span class="hljs-string">"namespace"</span></span>); reference.setBinNames(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>, <span class="hljs-string"><span class="hljs-string">"bar"</span></span>, <span class="hljs-string"><span class="hljs-string">"baz"</span></span>, <span class="hljs-string"><span class="hljs-string">"qux"</span></span>, <span class="hljs-string"><span class="hljs-string">"quux"</span></span>); reference.setFillter(Filter.stringNotEqual(<span class="hljs-string"><span class="hljs-string">"baz"</span></span>, <span class="hljs-string"><span class="hljs-string">"a"</span></span>)); reference.setPredExp(<span class="hljs-comment"><span class="hljs-comment">// 20 expressions in RPN PredExp.integerBin("foo") , PredExp.integerValue(2) , PredExp.integerGreater() , PredExp.integerBin("bar") , PredExp.integerValue(3) , PredExp.integerLessEq() , PredExp.integerBin("foo") , PredExp.integerValue(5) , PredExp.integerGreater() , PredExp.or(2) , PredExp.and(2) , PredExp.stringBin("quux") , PredExp.stringValue(".*force.*") , PredExp.stringRegex(RegexFlag.ICASE) , PredExp.and(2) , PredExp.geoJSONBin("qux") , PredExp.geoJSONValue("{\"type\": \"Polygon\", \"coordinates\": [0.0, 0.0],[1.0, 0.0],[1.0, 1.0],[0.0, 1.0],[0.0, 0.0]}") , PredExp.geoJSONWithin() , PredExp.not() , PredExp.or(2) );</span></span></code> </pre> <br><p>  Here is the wall of code, and yes even in <a href="https://ru.wikipedia.org/wiki/%25D0%259E%25D0%25B1%25D1%2580%25D0%25B0%25D1%2582%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BF%25D0%25BE%25D0%25BB%25D1%258C%25D1%2581%25D0%25BA%25D0%25B0%25D1%258F_%25D0%25B7%25D0%25B0%25D0%25BF%25D0%25B8%25D1%2581%25D1%258C">reverse Polish notation</a> .  No, I still understand that the stack machine is simple and convenient to implement from the point of view of the programmer of the engine itself, but to puzzle and write predicates in RPN from the client application ... I personally do not want to think of a vendor, I want to, as a consumer of this API It was convenient.  And it is inconvenient to write predicates even with a vendor client extension (conceptually similar to the Java Persistence Criteria API).  And there is still no readable SELECT in the query log. </p><br><p>  In general, SQL was invented in order to write criterion queries on it in a bird's language close to the natural one.  So, one wonders, what the devil? </p><br><p>  Wait, something is wrong here ... Is the screenshot on the KDPV the official documentation of the aero spike, in which the SELECT is completely described? </p><br><p>  Yes, it is described.  Here only AQL is the third-party utility written by a back left foot in dark night, and abandoned by a vendor three years ago at the time of the previous version of aero spike.  It has no relation to the client library, although it <a href="https://github.com/aerospike/aql-java">is written on a toad</a> - including. </p><br><p>  The three-year-old version did not have a predicate API, and therefore in AQL there is no support for predicates, and all that after WHERE is actually a reference to the index (secondary or primary).  Well, I mean, closer to the extension of the SQL type USE or WITH.  That is, you cannot just take the AQL source code, disassemble it for parts, and use it in your application for predicate calls. </p><br><p>  In addition, as I have already said, it was written on the dark night with the back left foot, and the <a href="">grammar</a> , which the AQL parses the query with, cannot be looked at without tears on ANTLR4.  Well, for my taste.  For some reason, I love it when the declarative definition of a grammar is not intermingled with pieces of a toad code, and very steep noodles are brewed there. </p><br><p>  Well, fortunately, I also seem to know how in ANTLR.  True, he didn‚Äôt take the sword for a long time, and the last time he wrote was a third version.  Fourth - it is much nicer, because who wants to write a manual bypass of AST, if everything is written to us, and there is a normal visitor, so let's start. </p><br><p>  As a base, take the <a href="">syntax SQLite</a> , and try to throw out all unnecessary.  We only need SELECT, and nothing more. </p><br><pre> <code class="plaintext hljs">grammar SQLite; simple_select_stmt : ( K_WITH K_RECURSIVE? common_table_expression ( ',' common_table_expression )* )? select_core ( K_ORDER K_BY ordering_term ( ',' ordering_term )* )? ( K_LIMIT expr ( ( K_OFFSET | ',' ) expr )? )? ; select_core : K_SELECT ( K_DISTINCT | K_ALL )? result_column ( ',' result_column )* ( K_FROM ( table_or_subquery ( ',' table_or_subquery )* | join_clause ) )? ( K_WHERE expr )? ( K_GROUP K_BY expr ( ',' expr )* ( K_HAVING expr )? )? | K_VALUES '(' expr ( ',' expr )* ')' ( ',' '(' expr ( ',' expr )* ')' )* ; expr : literal_value | BIND_PARAMETER | ( ( database_name '.' )? table_name '.' )? column_name | unary_operator expr | expr '||' expr | expr ( '*' | '/' | '%' ) expr | expr ( '+' | '-' ) expr | expr ( '&lt;&lt;' | '&gt;&gt;' | '&amp;' | '|' ) expr | expr ( '&lt;' | '&lt;=' | '&gt;' | '&gt;=' ) expr | expr ( '=' | '==' | '!=' | '&lt;&gt;' | K_IS | K_IS K_NOT | K_IN | K_LIKE | K_GLOB | K_MATCH | K_REGEXP ) expr | expr K_AND expr | expr K_OR expr | function_name '(' ( K_DISTINCT? expr ( ',' expr )* | '*' )? ')' | '(' expr ')' | K_CAST '(' expr K_AS type_name ')' | expr K_COLLATE collation_name | expr K_NOT? ( K_LIKE | K_GLOB | K_REGEXP | K_MATCH ) expr ( K_ESCAPE expr )? | expr ( K_ISNULL | K_NOTNULL | K_NOT K_NULL ) | expr K_IS K_NOT? expr | expr K_NOT? K_BETWEEN expr K_AND expr | expr K_NOT? K_IN ( '(' ( select_stmt | expr ( ',' expr )* )? ')' | ( database_name '.' )? table_name ) | ( ( K_NOT )? K_EXISTS )? '(' select_stmt ')' | K_CASE expr? ( K_WHEN expr K_THEN expr )+ ( K_ELSE expr )? K_END | raise_function ;</code> </pre> <br><p>  Hmm ... Taki and SELECT alone is a bit too much.  And if to get rid of the superfluous is simple enough, then there is another bad thing about the structure of the resulting workaround. </p><br><p>  The ultimate goal is to translate into a predicate API with its RPN and implied stack engine.  And here atomic expr does not contribute to such a transformation, because it implies the usual analysis from left to right.  Yes, and recursively defined. </p><br><p>  I mean, we can get our synthetic example, but it will be read exactly as written, from left to right: </p><br><pre> <code class="plaintext hljs">(foo&gt;2  (bar&lt;=3  foo&gt;5)  quux _ '%force%')  (qux _('{\"type\": \"Polygon\", \"coordinates\": [0.0, 0.0],[1.0, 0.0],[1.0, 1.0],[0.0, 1.0],[0.0, 0.0]}')</code> </pre> <br><p>  In the presence of brackets that determine the priority of parsing (which means you will need to dangle back and forth along the stack), as well as some operators behave like function calls. </p><br><p>  And we need this sequence: </p><br><pre> <code class="plaintext hljs">foo 2 &gt; bar 3 &lt;= foo 5 &gt;   quux ".*force.*" _  qux "{\"type\": \"Polygon\", \"coordinates\": [0.0, 0.0],[1.0, 0.0],[1.0, 1.0],[0.0, 1.0],[0.0, 0.0]}" _  </code> </pre> <br><p>  Brr, tin, poor brain, which is to read.  But without the brackets, there is no rollback and misunderstanding with the order of the call.  And how do we translate one into another? </p><br><p>  And here in the poor brain is chpok!  - Hello, this is a classic <a href="https://en.wikipedia.org/wiki/Shunting-yard_algorithm">Shunting Yard</a> from mnogow.  prof.  Dijkstra!  Usually, such okolobigdatovsky shamans, like me, do not need algorithms, because we simply translate prototypes already written from data of Satanists from python to toad, and then long and tediously tyunim performance of the solution obtained by purely engineering (== shamanic) methods, not scientific . </p><br><p>  But then suddenly it became necessary and knowledge of the algorithm.  Or at least the idea of ‚Äã‚Äãit.  Fortunately, not the entire university course has been forgotten over the past years, and if I remember about stack machines, I can dig up something else about the associated algorithms as well. </p><br><p>  Okay.  In the grammar, sharpened by Shunting Yard, SELECT at the top level will look like this: </p><br><pre> <code class="plaintext hljs">select_stmt : K_SELECT ( STAR | column_name ( COMMA column_name )* ) ( K_FROM from_set )? ( (K_USE | K_WITH) index_expr )? ( K_WHERE where_expr )? ; where_expr : ( atomic_expr | OPEN_PAR | CLOSE_PAR | logic_op )+ ; logic_op : K_NOT | K_AND | K_OR ; atomic_expr : column_name ( equality_op | regex_op ) STRING_LITERAL | ( column_name | meta_name ) ( equality_op | comparison_op ) NUMERIC_LITERAL | column_name map_op iter_expr | column_name list_op iter_expr | column_name geo_op cast_expr ;</code> </pre> <br><p>  I mean, the tokens corresponding to the brackets are significant, but there should not be a recursive expr.  Instead of it there will be a lot of any private anything_expr, and all are finite. </p><br><p>  In the code on the toad, which implements the visitor for this tree, things are a little more addictive - in strict accordance with the algorithm, which itself processes the hanging logic_op and balances the brackets.  I will not give an excerpt ( <a href="">look at the GC</a> yourself), but I will give the following consideration. </p><br><p>  It becomes clear why the authors of Aerospay did not bother with the support of predicates in AQL, and abandoned it three years ago.  Because it is strongly typed, and the aero spike is presented as a schema-less story.  And just like that, it is impossible to simply pick up a request from bare SQL without a predefined schema.  Oops. </p><br><p>  But we guys are hardened, and, most importantly, arrogant.  We need a scheme with field types, so there will be a scheme with field types.  Moreover, the client library already has all the necessary definitions, they just need to pick up.  Although the code for each type had to be written a lot (see the same link, from line 56). </p><br><p>  Now we are initializing ... </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> HashMap FOO_BAR_BAZ = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap() {{ put(<span class="hljs-string"><span class="hljs-string">"namespace.set0"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap() {{ put(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>, ParticleType.INTEGER); put(<span class="hljs-string"><span class="hljs-string">"bar"</span></span>, ParticleType.DOUBLE); put(<span class="hljs-string"><span class="hljs-string">"baz"</span></span>, ParticleType.STRING); put(<span class="hljs-string"><span class="hljs-string">"qux"</span></span>, ParticleType.GEOJSON); put(<span class="hljs-string"><span class="hljs-string">"quux"</span></span>, ParticleType.STRING); put(<span class="hljs-string"><span class="hljs-string">"quuux"</span></span>, ParticleType.LIST); put(<span class="hljs-string"><span class="hljs-string">"corge"</span></span>, ParticleType.MAP); put(<span class="hljs-string"><span class="hljs-string">"corge.uier"</span></span>, ParticleType.INTEGER); }}); put(<span class="hljs-string"><span class="hljs-string">"namespace.set1"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap() {{ put(<span class="hljs-string"><span class="hljs-string">"grault"</span></span>, ParticleType.INTEGER); put(<span class="hljs-string"><span class="hljs-string">"garply"</span></span>, ParticleType.STRING); }}); }}; AQLSelectEx selectEx = AQLSelectEx.forSchema(FOO_BAR_BAZ);</code> </pre> <br><p>  ... and voila, now our synthetic query is simply and clearly pulled from the aero spike: </p><br><pre> <code class="java hljs">Statement statement = selectEx.fromString(<span class="hljs-string"><span class="hljs-string">"SELECT foo,bar,baz,qux,quux FROM namespace.set WITH (baz='a') WHERE (foo&gt;2 AND (bar &lt;=3 OR foo&gt;5) AND quux LIKE '%force%') OR NOT (qux WITHIN CAST('{\"type\": \"Polygon\", \"coordinates\": [0.0, 0.0],[1.0, 0.0],[1.0, 1.0],[0.0, 1.0],[0.0, 0.0]}' AS GEOJSON)"</span></span>);</code> </pre> <br><p>  And to convert the molds from the web muzzle into the request itself, we start a ton of code written long ago in the web muzzle ... when the project finally reaches the project, otherwise the customer has postponed it to the shelf.  It's a shame, damn it, I spent almost a week of time. </p><br><p>  I hope I spent it with benefit, and the AQLSelectEx library will be needed by someone, and the approach itself will be a little closer to reality with a training tool than other articles from Habr on ANTLR. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/435902/">https://habr.com/ru/post/435902/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../435892/index.html">The digest of interesting materials for the mobile # 281 developer (January 7 - 13)</a></li>
<li><a href="../435894/index.html">Private classes. Hiding in php</a></li>
<li><a href="../435896/index.html">Using the DiagnosticSource in .NET Core: Theory</a></li>
<li><a href="../435898/index.html">What to think on the NALSD interview</a></li>
<li><a href="../435900/index.html">Encapsulate it</a></li>
<li><a href="../435904/index.html">AI translated brain activity to speech</a></li>
<li><a href="../435906/index.html">Pacemaker + DRBD (Dual primary) + ctdb cluster storage</a></li>
<li><a href="../435908/index.html">Ascetic web: prototype flea market on go and js</a></li>
<li><a href="../435910/index.html">Why did BSD lose in the battle with GNU / Linux?</a></li>
<li><a href="../435912/index.html">The main problems of the development of modern interfaces</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>