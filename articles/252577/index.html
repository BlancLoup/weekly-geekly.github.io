<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Casper - new cyber espionage malware</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In March 2014, the French edition of Le Monde published a study, according to which French intelligence agencies are suspected of developing and using...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Casper - new cyber espionage malware</h1><div class="post__text post__text-html js-mediator-article">  In March 2014, the French edition of <a href="http://www.lemonde.fr/international/article/2014/03/21/quand-les-canadiens-partent-en-chasse-de-babar_4387233_3210.html">Le Monde</a> published a study, according to which French intelligence agencies are suspected of developing and using sophisticated malware for cyber espionage.  Initially, this story was based on documents from a runaway NSA employee Edward Snowden, whom he shared with journalists from the German publication <a href="http://www.spiegel.de/media/media-35683.pdf">Der Spiegel</a> in January 2015. <br><br><img src="https://habrastorage.org/files/879/ab6/9b4/879ab69b4cec4c55882461d9bfe9b644.jpeg"><br><br>  An initial investigation of this malware was carried out by the Communications Security Establishment Canada (CSEC), in which this malware was named Babar.  After that, several malware researchers also worked on its analysis.  One of them was Marion Marschalek (Cyphort), which published two reports devoted to the analysis of this malicious program [ <a href="http://www.cyphort.com/evilbunny-malware-instrumented-lua/">1</a> ] [ <a href="http://www.cyphort.com/babar-suspected-nation-state-spyware-spotlight/">2</a> ]. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>  Another study was <a href="https://blog.gdatasoftware.com/blog/article/babar-espionage-software-finally-found-and-put-under-the-microscope.html">published by</a> one of the researchers of the anti-virus company G DATA.  In our study, we publish an analysis of another similar malware that was created by the same organization that was behind the development of Babar.  This malware is called Casper. <br><br>  Casper himself was used against the Syrian government agencies in April 2014. To install it, attackers used 0day exploits for the Adobe Flash Player software.  The exploits were posted on a website owned by the Syrian government.  Casper is a well-developed tool for conducting intelligence operations, which can go unnoticed on an infected computer for a long time.  It also contains code to counteract AV products from various vendors. <br><br>  We found two malware samples that were packaged by different packers.  The first sample is a dropper and dumps another executable file (core) to disk, which will be loaded into the system after each reboot.  The second is a DLL library that loads the core component into memory.  In this case, the core component is also a DLL file, and its name is Casper_DLL.dll. <br><br>  <b>Dropper</b> <br><br>  The dropper executable file is called ‚Äúdomcommon.exe‚Äù and its compilation date is June 18, 2010. It is likely that this compilation date in the header of the PE file is fake. <br><br>  The malicious program has a configuration file in XML format, which is decrypted by the dropper using the RC4 algorithm and a hard-wired 16-byte key.  Before decrypting it, the dropper checks the integrity of the section of memory that contains the key by calculating the checksum.  Such an operation is carried out in order to verify its integrity.  The screenshot below shows the decrypted configuration file. <br><br><img src="https://habrastorage.org/files/a76/1cf/63c/a761cf63cdee4b77bafdbca5e5d50efb.png"><br>  Fig.  Decrypted Casper dropper configuration file. <br><br>  Dropper executable code starts using the XML configuration file by analyzing the STRATEGY tag, which defines a section of the configuration file.  This tag sets the behavior mode for a malicious program, depending on which anti-virus product is installed in the system.  The list of anti-virus products launched in the system, the dropper receives using the ‚ÄúSELECT * FROM AntiVirusProduct‚Äù query using <a href="https://msdn.microsoft.com/en-us/library/aa394582%2528v%3Dvs.85%2529.aspx">WMI</a> , then the product name is extracted from the ‚ÄúdisplayName‚Äù field.  In this section of the configuration file, there may also be a list of anti-virus products, each of which is identified by an AV tag.  In this case, the malware can take a series of actions to disable this or that product. <br><br>  If there is no list of anti-virus products in the STRATEGY section, the default actions that are specified as an argument to the STRATEGY tag are applied to the anti-virus product detected in the system.  In addition, the behavior policy of malware for anti-virus products can be set in a separate configuration file called ‚Äústrategy.xml‚Äù. <br><br>  As already mentioned, the behavior of the dropper, as well as the payload, is determined by the parameters that are specified in the configuration file.  Some of the tags or sections describe how exactly the executable code of the malicious program must perform the appropriate actions and in what cases.  The table below shows examples of such parameters. <br><br><img src="https://habrastorage.org/files/2a5/80e/390/2a580e39027d41f49edfdf8032e46d68.png"><br><br>  The range of possibilities offered by the STRATEGY section shows that Casper conducted an in-depth study of the behavior of various antivirus products.  In the presented screenshot of the configuration file, you can see that the INJECTION parameter for all AV tags is set to FALSE, and for the whole section, which is set by the STRATEGY tag to TRUE.  This means that for all antivirus products encountered in the system except these four, the executable code will be introduced into their processes.  It is interesting to note that for the three antivirus products, the ESCAPE parameter is set to YES.  This means that the dropper will simply refuse to install a malicious program into the system if these anti-virus products are present there. <br><br>  According to the list of anti-virus products listed in the AV tags, we can assume that these are the products that Casper authors expect to find on infected computers.  The VERSION parameter, which may be present in the AV tag, is never used in the malicious code.  It allows malware authors to fix the versions of antivirus products they need.  We very rarely observed such an accuracy of the implementation of anti-virus bypass mechanisms by malicious code. <br><br>  In the case when the ESCAPE parameter is set to NO, i.e., the dropper can continue its work normally, it will proceed to the analysis of the next set of instructions from the configuration file. <br><br><img src="https://habrastorage.org/files/9c8/55f/00d/9c855f00de2c47bc93552c93a847b8ec.png"><br>  Fig.  Part of the dropper configuration file. <br><br>  The first such command tells the malicious code to remove other already installed Casper instances from the system.  The UNINSTALL tag is accompanied by the name parameter, which is located in the Windows registry.  Obviously, the authors wanted to disguise the autoload of the malware module by giving it the name ‚ÄúAudio Interface Device Manager‚Äù.  The mechanism for deleting an existing copy of a malicious program from the system consists of two stages.  Each stage cleans the corresponding autoload mechanism. <br><br><ul><li>  In the presence of a scheduled task (scheduled task), it is removed from the system. </li><li>  If a malware entry is present in the registry, it is deleted. </li></ul><br>  Further, the dropper installs the payload into the system (section INSTALL).  This section regulates two versions of the payload, one for 32-bit systems (x86 tag) and the other for 64-bit systems (x64 tag).  The INSTALL section will be used with one or two methods of installing the payload into the system.  In the case of Windows 7+, malware survival is ensured by the scheduled task mechanism, otherwise the well-known registry key is used. <br><br>  HKLM \ Software \ Microsoft \ Windows \ CurrentVersion \ Run <br><br>  The INSTALL tag as a parameter contains an argument that can be passed to the payload installed in the system.  The exact value of this argument is extremely important for proper operation of the payload.  The argument passed in this way is used to find the functions of dynamic libraries needed by the malicious program in memory.  In the event that this value is erroneous, the payload will not be able to properly execute its code. <br><br>  Before completing its execution, the dropper deletes itself from the system using the method specified in the AUTODEL parameter.  At this point, the payload is not yet running on the system; this will be done after the next reboot. <br><br>  <b>Payload</b> <br><br>  The execution of the Casper payload as well as its dropper is based on an XML configuration file, which is deciphered at the initial stage. <br><br><img src="https://habrastorage.org/files/876/917/6cf/8769176cf9ad47abb338a891354a332f.png"><br>  Fig.  Payload configuration file <br><br>  The configuration file starts with a timestamp that corresponds to Monday, April 7th, 2014 at 9:27:05 GMT GMT, therefore, the compile time mark of the executable file of the malicious program indicated at the beginning of our report is most likely a fake and not true. <br><br>  A PARAM tag set specifies instructions to executable payload code. <br><br><img src="https://habrastorage.org/files/a58/3ad/1e4/a583ad1e4f054269aeebbc526fa76124.png"><br><br>  The payload executable code then generates the unique identifier (ID) of the infected computer and inserts it at the end of the configuration file with the UID tag.  After this, the configuration file is encrypted using the RC4 algorithm and stored in the system registry section. <br><br>  Some features of the configuration file are not used by the executable code of the payload of those Casper files that we observed.  This applies to the parameter TIMETOLIVE, which sets the so-called.  Casper's ‚Äúlifetime‚Äù in the system, after which he will remove himself from there.  The DELAYED_START parameter specifies the waiting time that the payload code must withstand before executing its basic functions.  The payload configuration file contains the STRATEGY section similar to the one that was present in the dropper configuration file. <br><br>  <b>Interaction with the C &amp; C server</b> <br><br>  The payload can interact with its C &amp; C server.  The instructions from the server can come in XML format, as shown below. <br><br>  The SYSINFO team instructs the bot to send system information to a remote server.  Information is sent in the form of a report that contains several sections.  An example of the report is shown below in the screenshot. <br><br><img src="https://habrastorage.org/files/e33/8a8/72f/e338a872f4fb4764814047db7dc3d5fe.png"><br>  Fig.  Information about the system sent by the bot to a remote server. <br><br>  Obviously, the section names in this report do not need clarification.  The report itself is generated by the 4.4.1 bot.  The report is saved to the ‚Äúperfaudio.dat‚Äù file and then encrypted with the base64 algorithm, after which its contents are sent to a remote C &amp; C server in the body of the HTTP POST request. <br><br>  The C &amp; C server request is also provided with a cookie named PREF, to which the infected computer's UID is attached, the configuration file ID, the bot version, and the ‚ÄúR‚Äù symbol, all of which are encrypted using the base-64 algorithm.  Another character can act as a symbol - ‚ÄúG‚Äù.  Analysis of the executable file showed that the server in this case can send the image file in PNG format to the bot.  This image file has the usual PNG format, but instead of the image contains an XML configuration file.  This file will be extracted from there and the instructions from it will be executed by the bot. <br><br>  In addition to the ‚ÄúSYSINFO‚Äù command, Casper can interpret the ‚ÄúCOMMAND‚Äù tags with the following values. <br><br><ul><li>  EXEC, used to execute another program on the computer on a local path. </li><li>  SYSTEM, used to execute instructions in the Windows command line. </li></ul><br>  The malicious program can also process tags that indicate to the bot the executable file to be executed. <br><br>  The best way to establish a link between the Babar, Bunny and Casper malware is to detect unusual sections of executable code and the algorithms they use.  For comparison, you can enable another malicious program, so-called.  NBOT (aka TFC).  The presence of common links with NBOT and the malware listed above was identified by a Marion Marschalek researcher in her <a href="http://www.cyphort.com/babar-suspected-nation-state-spyware-spotlight/">report</a> on Babar.  Below is a list of such common features of these malicious programs. <br><br><ul><li>  Casper hides calls to Windows API functions using special hashes of the names of these functions.  The hash calculation algorithm is a combination of the ROL algorithm and the XOR algorithm.  At the same time, NBOT uses the same algorithm for this purpose.  Babar uses a similar approach, but the calculation algorithm is different. </li><li>  Casper receives information about running anti-virus products in the same way (WMI API) as Bunny, Babar, NBOT.  All these malicious programs calculate the SHA-256 hash from the first word in the name of the anti-virus product, although this mechanism is not used anywhere in Casper. </li><li>  Casper uses special delimiters when organizing its HTTP requests using a special format string, the values ‚Äã‚Äãfor which are generated by the well-known API function <i>GetTickCount</i> .  A similar code is also present in the NBOT samples, as shown below in the screenshots. <br><br><img src="https://habrastorage.org/files/516/191/f48/516191f4844f4444b25220e681e7a268.png"><br><img src="https://habrastorage.org/files/fcb/516/b95/fcb516b95ba342258385a42282e15089.png"><br></li><li>  Casper removes the dropper from the system by executing a Windows command that matches the following pattern. <br><br>  cmd.exe / C FOR / L %% i IN (1.1,% d) DO IF EXIST ‚Äú% hs‚Äù (DEL ‚Äú% hs‚Äù &amp; SYSTEMINFO) ELSE EXIT <br><br>  In some instances of NBOT, we may find a similar command syntax. <br><br>  cmd.exe / C FOR / L %% i IN (1.1,% d) DO IF EXIST ‚Äú% s‚Äù (DEL ‚Äú% s‚Äù &amp; PING 127.0.0.1 -n 3) ELSE EXIT </li><li> Casper sets the ID parameter to ‚Äú13001‚Äù, while Babar samples set this value to ‚Äú12075-01.‚Äù  In addition, one malware detected by CSEC in 2009 uses the same identifier and is set to ‚Äú08184‚Äù (see the 8th slide in <a href="http://www.spiegel.de/media/media-35683.pdf">the CSEC presentation</a> ). </li></ul><br><br>  It should be noted that none of these signs is sufficient to make an unambiguous conclusion; at the same time, they allow us to state with a high degree of probability that Bunny, Babar, NBOT, and Casper were developed by one group of persons or organization . <br><br>  <b>Conclusion</b> <br><br>  Our telemetry data shows that all the alleged victims of these cyber attacks were located in Syria, and besides that, they were visitors of the jpic.gov.sy website.  This site was allegedly compromised and users were redirected from it to the exploit kit page.  In fact, users could be redirected to install malware from other places as well, such as a phishing email.  However, it is precisely known that the exploits, executable files of Casper, as well as the C &amp; C component, were located on this legitimate server (jpic.gov.sy). <br><br>  It can be assumed that the mentioned website or its server was hacked in order to place malicious content there (the so-called storage area).  Such an attack model can have at least two advantages for the intruders themselves: first, placing the files on the Syrian server makes it easier to access on the territory of Syria itself, because in this country there were disconnections from the Internet, and the attackers were interested in a stable infection of users.  Secondly, such a situation may be misleading the efforts of the law enforcement agencies themselves, who are interested in finding the source of the cyber attack. <br><br>  We are sure that the same organization or hacker group is behind Bunny, Babar, and Casper.  In a detailed analysis of the Babar malware, which was published at the CSEC presentation, it was stated that this group is not new to the development of cyber espionage tools.  The use of zero-day exploits is another indicator that the authors of Casper belong to a highly professional group.  Finally, the specific thrust of the attack on Syrian citizens shows the geopolitical interest of the attackers. <br><br>  However, we did not find any evidence in the Casper files to point to authors in a particular country.  In particular, we did not find any signs of its French origin, as was found by the CSEC in the case of Babar. </div><p>Source: <a href="https://habr.com/ru/post/252577/">https://habr.com/ru/post/252577/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252567/index.html">OpenSMTPD + UW IMAP as an alternative to heavy mail systems</a></li>
<li><a href="../252569/index.html">Reverse engineering as a method of teaching electronics</a></li>
<li><a href="../252571/index.html">Machine learning - 2. Nonlinear regression and numerical optimization</a></li>
<li><a href="../252573/index.html">Conference. NEXT returns to Peter</a></li>
<li><a href="../252575/index.html">WebGL and asyncio multiplayer online shooter, part two</a></li>
<li><a href="../252581/index.html">Report from Integrated Systems Europe - what did you miss in technology if you did not get to ISE-2015</a></li>
<li><a href="../252583/index.html">$ 2,500 for a domain in the .SUCKS zone</a></li>
<li><a href="../252585/index.html">QIWI terminals. Dark side of the Moon</a></li>
<li><a href="../252587/index.html">Broadcast video with Raspberry Pi</a></li>
<li><a href="../252589/index.html">Big Data course: three months for basic knowledge, and why?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>