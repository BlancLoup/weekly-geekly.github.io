<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Taming the Plex Dust on ARM Devices</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It all started in my question in Toster. And now, for half a year I have been using the Plex media server. For those who have not heard of it, I will ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Taming the Plex Dust on ARM Devices</h1><div class="post__text post__text-html js-mediator-article"><p>  It all started in my <a href="https://toster.ru/q/270862">question</a> in Toster.  And now, for half a year I have been using the <a href="https://www.plex.tv/">Plex</a> media server.  For those who have not heard of it, I will explain: it is software that analyzes and structures your media library, and provides access to it through the web and not only, a kind of personal Netflix without registration and SMS.  I use Plex to watch movies and TV shows via a browser on a laptop or <a href="https://www.google.com/chromebook/">Chromebook</a> . </p><br><p><img src="https://habrastorage.org/files/024/051/431/0240514317ce40f38af72e73a949a692.png" alt="image"></p><br><p>  I used to have to configure NFS or Samba share, conjure with <a href="http://linux.die.net/man/8/automount">automount (8)</a> , put up with the roll-off share after suspend-resume, or just copy files over sftp / scp, but now I use <del>  Tide </del>  Plex.  Unfortunately, not everything is simple with him either. </p><a name="habracut"></a><br><p>  Cubietruck performs the role of my home server with an ARM Cortex-A7 1GHz processor and an <a href="http://www.armbian.com/cubietruck/">Armbian</a> distribution (Vanilla kernel for Docker and <a href="http://man7.org/linux/man-pages/man7/namespaces.7.html">namespaces (7)</a> support).  It is quite enough for everyday needs (backup storage, VPN server), but it is obviously not intended for more resource-intensive things. </p><br><p>  Plex is a freeware software.  It is free, but not free, which imposes certain restrictions.  For example, there are no source codes and official deb packages for any processor architecture.  Well, by itself, many paranoid moviegoers will not want to install a cat in a bag on their system. </p><br><div class="spoiler">  <b class="spoiler_title">Emby Media Server</b> <div class="spoiler_text"><p>  There is a opensource project <a href="https://emby.media/">Emby Media Server</a> , an analogue of Plex, written in Mono.  Unfortunately, he has problems with playing files in browsers.  Many of Emby video formats are fully transcoded, even if the h264 codec is originally used. </p><br><p>  Today Plex allows you to play more video formats without full conversion than Emby Media Server.  Perhaps some of you will help fix this situation.  In the meantime, you can conjure over the file <a href="">browserdeviceprofile.js</a> , which is responsible for browser profiles. </p></div></div><br><p>  We will solve the first problem with the help of officially distributed packages for NAS devices, and the second <a href="https://www.oreilly.com/ideas/five-security-concerns-when-using-docker">partially</a> with the help of Docker. </p><br><p> Let's take as a basis the package for NAS QNAP with the ARMv7-X31 + architecture (this build supports the Neon extension, which is supported by Cubietruck, you can check it with the command <code>cat /proc/cpuinfo | grep neon</code> ): </p><br><pre> <code class="hljs ruby">$ curl -s <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/plex.tv/api</span></span><span class="hljs-regexp"><span class="hljs-regexp">/downloads/</span></span><span class="hljs-number"><span class="hljs-number">1</span></span>.json <span class="hljs-params"><span class="hljs-params">| python -mjson.tool |</span></span> grep x31plus <span class="hljs-string"><span class="hljs-string">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://downloads.plex.tv/plex-media-server/1.0.3.2461-35f0caa/PlexMediaServer_1.0.3.2461-35f0caa_arm-x31plus.qpkg</span></span></code> </pre> <br><p>  The <strong>qpkg</strong> file is a symbiosis of a shell script and several archives.  We can <code>plex_media_server</code> it into the <code>plex_media_server</code> directory using the command: </p><br><pre> <code class="hljs ruby">$ mkdir plex_media_server $ wget <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/downloads.plex.tv/plex</span></span>-media-server/<span class="hljs-number"><span class="hljs-number">1.0</span></span>.<span class="hljs-number"><span class="hljs-number">3.2461</span></span>-<span class="hljs-number"><span class="hljs-number">35</span></span>f0caa/PlexMediaServer_1.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">3.2461</span></span>-<span class="hljs-number"><span class="hljs-number">35</span></span>f0caa_arm-x31plus.qpkg $ dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=PlexMediaServer_1.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">3.2461</span></span>-<span class="hljs-number"><span class="hljs-number">35</span></span>f0caa_arm-x31plus.qpkg bs=<span class="hljs-number"><span class="hljs-number">22954</span></span> skip=<span class="hljs-number"><span class="hljs-number">1</span></span> status=none <span class="hljs-params"><span class="hljs-params">| tar -xzf - -C plex_media_server</span></span></code> </pre> <br><p>  The resulting files can be placed in the Docker container, but more on that later.  Suppose we launched Plex and are going to watch a movie in the browser that is already encoded in h264 with audio AC3 5.1.  What will Plex do?  It will begin to transcode AC3 5.1 track into AAC 5.1.  And to watch the video on a laptop, we don‚Äôt need to listen to the video with six channels, and the slow processor makes itself felt with periodic pauses when watching. </p><br><p>  Fortunately, the Plex has configuration profiles that can be edited.  For example, profile for browsers <code>Resources/Profiles/Web.xml</code> . </p><br><div class="spoiler">  <b class="spoiler_title">Web.xml</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Client</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Web"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Author: Plex Inc. --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TranscodeTargets</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VideoProfile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">protocol</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hls"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">container</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mpegts"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">codec</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"h264"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">audioCodec</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"aac,mp3"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">context</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"streaming"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VideoProfile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">protocol</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dash"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">container</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mp4"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">codec</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"h264"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">audioCodec</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"aac"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">context</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"streaming"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VideoProfile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">protocol</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">container</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mkv"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">codec</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"h264"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">audioCodec</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"aac,mp3"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">context</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"streaming"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MusicProfile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">container</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mp3"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">codec</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mp3"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PhotoProfile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">container</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"jpeg"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SubtitleProfile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">container</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ass"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">codec</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ass"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">context</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"all"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TranscodeTargets</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CodecProfiles</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VideoCodec</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"*"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Limitations</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">UpperBound</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"video.bitDepth"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"8"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Limitations</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VideoCodec</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VideoAudioCodec</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"*"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Limitations</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">UpperBound</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"audio.channels"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"6"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Limitations</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VideoAudioCodec</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CodecProfiles</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Client</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><p>  In it, we see the parameter <code>&lt;UpperBound name="audio.channels" value="6" /&gt;</code> , which means that the maximum number of channels for audio should not exceed six.  And when transcoding an audio track, this means that if we convert AC3 6 channels to AAC, then the resulting AAC will also have 6 channels, i.e.  we decode 6 AC3 channels and encode them into 6 AAC channels, once again using CPU resources.  When watching a video, this causes periodic suspensions. </p><br><p>  To enable the so-called <a href="https://en.wikipedia.org/wiki/Audio_mixing_(recorded_music)">downmix</a> , you need to replace parameter 6 by 2 and get <code>&lt;UpperBound name="audio.channels" value="2" /&gt;</code> .  Then files with a six-channel audio track will be converted to stereo. </p><br><p>  For most users, this option will be acceptable.  But not for those who have files with the six-channel AAC track.  In this case, the six-channel AAC will be converted to stereo AAC.  And this is again a waste of processor resources and periodic freezes when watching a video.  I thought that conjuring with profiles might solve the problem, but unfortunately, in the current version of Plex such exceptions are not possible.  On the Plex forum for two weeks already there is a <a href="https://forums.plex.tv/discussion/225245/feature-request-add-reencoded-metadata-attribute-for-the-codecprofiles">request</a> for adding a similar option. </p><br><p>  The only option to solve this problem I saw in replacing the <code>Plex Transcoder</code> binary with a script that will generate the necessary parameters if there is an AAC track in the video file. </p><br><div class="spoiler">  <b class="spoiler_title">magic.sh</b> <div class="spoiler_text"><pre> <code class="hljs lua">#!/bin/bash # This script disables transcode <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> videos which already have aac audio magic=<span class="hljs-number"><span class="hljs-number">0</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">input</span></span>=<span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">arg</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">"$@"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ((i++)) <span class="hljs-built_in"><span class="hljs-built_in">next</span></span>=$((i+<span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">[[ "$arg" == "-i" ]]</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">input</span></span>=<span class="hljs-literal"><span class="hljs-literal">true</span></span> fi <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">[[ "$arg" =~ -codec:[0-9] &amp;&amp; "${@:$next:1}" == "aac" &amp;&amp; $magic == 0 &amp;&amp; $input == false ]]</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ((magic++)) continue fi <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">[[ "$arg" == "aac" &amp;&amp; $magic == 1 ]]</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ((magic++)) continue fi <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">[[ "$arg" == "-codec:1" &amp;&amp; $magic == 2 ]]</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ((magic++)) fi <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">[[ "$arg" == "aac" &amp;&amp; $magic == 3 ]]</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> args[$i]=<span class="hljs-string"><span class="hljs-string">"copy"</span></span> ((magic++)) continue fi <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">[[ "$arg" == "-ar:1" &amp;&amp; $magic == 4 ]]</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> args[$i]=<span class="hljs-string"><span class="hljs-string">"-copypriorss:1"</span></span> ((magic++)) continue fi <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">[[ "$arg" == "48000" &amp;&amp; $magic == 5 ]]</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> args[$i]=<span class="hljs-string"><span class="hljs-string">"0"</span></span> ((magic++)) continue fi <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">[[ "$arg" == "-channel_layout:1" &amp;&amp; $magic == 6 ]]</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ((magic++)) continue fi <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">[[ "$arg" == "stereo" &amp;&amp; $magic == 7 ]]</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ((magic++)) continue fi <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">[[ "$arg" == "-b:1" &amp;&amp; $magic == 8 ]]</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ((magic++)) continue fi <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">[[ "$arg" == "256k" &amp;&amp; $magic == 9 ]]</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ((magic++)) continue fi args[$i]=$(printf <span class="hljs-string"><span class="hljs-string">"%q"</span></span> <span class="hljs-string"><span class="hljs-string">"$arg"</span></span>) done set <span class="hljs-comment"><span class="hljs-comment">-- "${args[@]}" eval "/opt/plex/Application/Resources/Plex\ Transcoder_ $@"</span></span></code> </pre> <br><p>  github link: <a href="">https://github.com/kayrus/plex/blob/master/magic.sh</a> </p></div></div><br><p>  When testing, it turned out that this hack works well with video files from my library. </p><br><h2>  Docker </h2><br><p>  Now let's see how to wrap all this into a Docker image.  At a minimum, the following conditions must be met: </p><br><ul><li>  Access from the container is possible only to certain directories. </li><li>  Plex should not run as root, even inside a container. </li><li>  Why not use systemd to run a container with a Plex? </li></ul><br><p>  The following is an excerpt from the <code>Dockefile</code> that I use. </p><br><p>  Copy and unpack the downloaded archive (can be obtained directly via wget, but this is forbidden in the configuration I use).  I use <code>COPY</code> instead of <code>ADD</code> to avoid automatic unpacking of the archive, in this case there is no need for this.  Expression <code>|| true</code>  <code>|| true</code> allows you to ignore the gzip message about garbage after the end of the archive. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">COPY</span></span> PlexMediaServer_1<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.2461</span></span><span class="hljs-number"><span class="hljs-number">-35</span></span>f0caa_arm-x31plus.qpkg /tmp/plex_media_server.tar RUN { dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/tmp/plex_media_server.tar bs=<span class="hljs-number"><span class="hljs-number">22954</span></span> skip=<span class="hljs-number"><span class="hljs-number">1</span></span> status=<span class="hljs-keyword"><span class="hljs-keyword">none</span></span> | tar -xzf - -C /opt/plex/Application || <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } &amp;&amp; rm -f /tmp/plex_media_server.tar</code> </pre> <br><p>  Add to the container unprivileged system user <code>plex</code> . </p><br><pre> <code class="hljs swift"><span class="hljs-type"><span class="hljs-type">RUN</span></span> useradd -r -d /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/plex -s /sbin/nologin plex</code> </pre> <br><p>  Activate downmix: </p><br><pre> <code class="hljs scala"><span class="hljs-type"><span class="hljs-type">RUN</span></span> sed -i <span class="hljs-symbol"><span class="hljs-symbol">'s</span></span>/name=<span class="hljs-string"><span class="hljs-string">"audio.channels"</span></span> value=<span class="hljs-string"><span class="hljs-string">"6"</span></span>/name=<span class="hljs-string"><span class="hljs-string">"audio.channels"</span></span> value=<span class="hljs-string"><span class="hljs-string">"2"</span></span>/' /opt/plex/<span class="hljs-type"><span class="hljs-type">Application</span></span>/<span class="hljs-type"><span class="hljs-type">Resources</span></span>/<span class="hljs-type"><span class="hljs-type">Profiles</span></span>/<span class="hljs-type"><span class="hljs-type">Web</span></span>.xml</code> </pre> <br><p>  All further actions in the container will be performed by the <code>plex</code> user. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> plex</code> </pre> <br><p>  Mark the paths <code>/var/lib/plex</code> (to save the state of the media file database) and <code>/media</code> (the path for media files) as external volumes: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">VOLUME</span></span> [<span class="hljs-string"><span class="hljs-string">"/var/lib/plex"</span></span>,<span class="hljs-string"><span class="hljs-string">"/media"</span></span>]</code> </pre> <br><h3>  Container run </h3><br><p>  In the command below, we broadcast the standard port 32400 to the 80th http port, mount the path <code>/home/plex</code> to <code>/var/lib/plex</code> inside the container and <code>/home/user/media</code> to <code>/media</code> . </p><br><pre> <code class="hljs delphi">$ docker run --<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> plex --hostname plex --rm -p <span class="hljs-number"><span class="hljs-number">80</span></span>:<span class="hljs-number"><span class="hljs-number">32400</span></span> -v /home/plex:/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/plex -v /home/user/media:/media pleximage</code> </pre> <br><h3>  systemd </h3><br><p>  Unit file that I use to run the plex container. </p><br><pre> <code class="hljs mel">[Unit] Description=Plex Media Server After=docker.service Requires=docker.service [Service] Environment=MEDIA_LIB=/home/user/media Environment=CONFIG_DIR=/var/lib/plex Environment=DOCKER_IMAGE=kayrus/plex Environment=PLEX_INT_PORT=<span class="hljs-number"><span class="hljs-number">32400</span></span> Environment=PLEX_EXT_PORT=<span class="hljs-number"><span class="hljs-number">32400</span></span> # Remove old Plex <span class="hljs-keyword"><span class="hljs-keyword">container</span></span> ExecStarPre=-/usr/bin/docker rm plex ExecStart=/usr/bin/docker run --name plex --hostname plex --rm -p ${PLEX_EXT_PORT}:${PLEX_INT_PORT} -v ${CONFIG_DIR}:/var/lib/plex -v ${MEDIA_LIB}:/media ${DOCKER_IMAGE} # Fix foreign network which <span class="hljs-keyword"><span class="hljs-keyword">requires</span></span> Plex login/signup ExecStartPost=/sbin/iptables -t nat -I POSTROUTING -o docker0 -p tcp -m tcp --dport ${PLEX_INT_PORT} -j MASQUERADE ExecStopPost=-/sbin/iptables -t nat -D POSTROUTING -o docker0 -p tcp -m tcp --dport ${PLEX_INT_PORT} -j MASQUERADE ExecStop=/usr/bin/docker stop plex # Remove pidfile after stop which prevents Plex server start ExecStopPost=/bin/rm -f ${CONFIG_DIR}/Library/Application\x20Support/Plex\x20Media\x20Server/plexmediaserver.pid [Install] WantedBy=multi-user.target</code> </pre> <br><h2>  https and nginx </h2><br><p>  To access the Plex from the Internet, it is recommended to use an HTTPS connection.  If you do not want to register and pay for additional Plex features, you can configure the certificate yourself.  You can use a self-signed certificate, you can use a certificate from <a href="https://letsencrypt.org/">Let's Encrypt</a> .  But ultimately the nginx configuration file will look something like this: </p><br><div class="spoiler">  <b class="spoiler_title">nginx_plex.conf</b> <div class="spoiler_text"><pre> <code class="nginx hljs"><span class="hljs-comment"><span class="hljs-comment">#     Plex dashboard,       . map $request_method$request_uri$http_referer $do_redirect { "GET/" 1; default 0; } server { # Listen only HTTPS socket listen [::]:443; # Enter your domain here server_name plex.example.com; # Configure your SSL certificates here ssl on; include ssl.conf; ssl_trusted_certificate ssl/ca-certs.pem; ssl_certificate ssl/plex.example.com.pem; ssl_certificate_key ssl/plex.example.com-key.pem; # Protect Plex by basic auth auth_basic "denied"; auth_basic_user_file .htpasswd; # Redirect to the Plex dashboard if ($do_redirect = 1) { return 302 https://$host/web; } # Default location location / { #     Plex   proxy_set_header Authorization ""; proxy_buffering off; proxy_pass http://localhost:32400; } # Websockets location location /:/websockets/ { #     Plex   proxy_set_header Authorization ""; proxy_buffering off; proxy_pass http://localhost:32400; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection "upgrade"; } }</span></span></code> </pre> </div></div><br><p>  References: </p><br><ul><li>  A repository with information on how to run Plex in the Docker container under the ARM architecture: <a href="https://github.com/kayrus/plex">https://github.com/kayrus/plex</a> </li><li>  Repository with information on how to run the Emby Media Server in the Docker container under the ARM architecture: <a href="https://github.com/kayrus/emby">https://github.com/kayrus/emby</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/306886/">https://habr.com/ru/post/306886/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306874/index.html">Uber does not always win</a></li>
<li><a href="../306876/index.html">As I wrote game design documentation for my game.</a></li>
<li><a href="../306878/index.html">The digest of interesting events from the world of Java, and around it # 7 (07/18/2016 - 07/31/2016)</a></li>
<li><a href="../306880/index.html">Login to IT</a></li>
<li><a href="../306882/index.html">ICFPC 2016 coming soon</a></li>
<li><a href="../306888/index.html">BILLmanager has become more open</a></li>
<li><a href="../306890/index.html">Rack KVM for the budget</a></li>
<li><a href="../306892/index.html">Choosing backup equipment in a small office</a></li>
<li><a href="../306894/index.html">A small script to track prices avito from Google Spreadsheet</a></li>
<li><a href="../306896/index.html">Optical fiber in industrial communication systems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>