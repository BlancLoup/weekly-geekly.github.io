<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asterisk Manager Interface in dialplan</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Like all ASTERISKers, I have repeatedly encountered the problem that there are several trunks on the PBX that are used for outgoing communication. And...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asterisk Manager Interface in dialplan</h1><div class="post__text post__text-html js-mediator-article">  Like all ASTERISKers, I have repeatedly encountered the problem that there are several trunks on the PBX that are used for outgoing communication.  And like many, my customers also have a part of these trunks as the main ones, and the rest play the role of backup ones in case of a fall / employment / something else first. <br><br><a name="habracut"></a><br><br>  A standard mechanism for solving such a problem is the following example: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      exten =&gt; _ &lt;Che then there&gt;, 1, Dial (SIP / trunk / &lt;Che then there&gt;) <br>  exten =&gt; _ &lt;Che then there&gt;, n, GotoIf ($ ["$ {DIALSTATUS}"! = "ANSWER"]? Dial_Another_Prov: Hangup) <br>  exten =&gt; _ &lt;Che then there&gt;, n (Dial_Another_Prov), Dial (SIP / trunk2 / &lt;Che then there&gt;) <br>  exten =&gt; _ &lt;Che then there&gt;, n (hangup), Hangup () <br><br>  Well, or here's an example, which, incidentally, lies in the open spaces of the network <br><br>  [macro-safedial] <br>  exten =&gt; s, 1, Set (DIALSTART = $ {EPOCH}) <br>  exten =&gt; s, n, Dial ($ {ARG1}, $ {ARG2}, $ {ARG3}, $ {ARG4}) <br>  exten =&gt; s, n, Goto (s - $ {DIALSTATUS}, 1) <br><br>  exten =&gt; s-NOANSWER, 1, GotoIf ($ ["$ {DTIME}" = "0"]? here) <br>  exten =&gt; s-NOANSWER, n, Hangup <br>  exten =&gt; s-NOANSWER, n (here), Verbose (1, Need failover for "$ {ARG1}") <br>  exten =&gt; s-BUSY, 1, Busy <br>  exten =&gt; s-CHANUNAVAIL, 1, Verbose (1, Need failover for "$ {ARG1}") <br>  exten =&gt; s-CONGESTION, 1, Congestion <br>  exten =&gt; _s -., 1, Congestion <br>  exten =&gt; s-, 1, Congestion <br><br>  After some time, I started to turn up such decisions, based on considerations of their loudness and an increase in the number of backup channels from one of the customers, who had a question <b>to get through to the client no matter what</b> .  It is quite understandable in general: telephony should always remain telephony, and work.  That's why it is PBX - to automate work and get rid of headaches. <br><br>  In the meantime, transferring all of their wards from the usual dialplan to lua, it was decided to wake up. <br><br>  Well.  We have an excellent working tool at hand - the whole LANGUAGE of programming.  Which, like many of his brothers, can work with network interfaces.  This means that we can use this property for our own benefit.  Why not look at the state of trunks and then call available?  All you need is: <br><br>  1. Connect to AMI <br>  2. Get trunk names <br>  3. Get their statuses <br><br>  So.  First of all, we hook the socket library: <br><br><pre><code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> socket = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"socket"</span></span>)</code> </pre> <br><br>  For the analysis of trunks, I will use AMI (as everyone probably already guessed from the name).  Since AMI works on the tcp stack, I will describe it: <br><br><pre> <code class="lua hljs">tcp = socket.tcp() tcp:settimeout(<span class="hljs-number"><span class="hljs-number">100</span></span>)</code> </pre><br><br>  Further I describe a context from which trunks will be caused and I hang on it the function necessary to us.  Let's say ... <b>outgoing_calls_external_dst</b> In essence, this function is the essence of the context.  That is an analogue of the context in extensions.conf (I will not write this code. Everything is on wiki.asterisk.org) <br><br>  Here I, when receiving a call, will connect to my asterisk's AMI interface: <br><br><pre> <code class="lua hljs">tcp:connect(<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-number"><span class="hljs-number">5038</span></span>) result = tcp:receive() tcp:send(<span class="hljs-string"><span class="hljs-string">"Action: Login\r\n"</span></span>) tcp:send(<span class="hljs-string"><span class="hljs-string">"Username: pr\r\n"</span></span>) tcp:send(<span class="hljs-string"><span class="hljs-string">"Secret: 1\r\n\r\n"</span></span>) LoginIsOk = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> LoginIsOk == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> result=tcp:receive() <span class="hljs-comment"><span class="hljs-comment">--          . if string.find(result,"Authentication accepted")~=nil then LoginIsOk = 1 end if string.find(result,"Response: Error")~=nil then LoginIsOk = 2 end end</span></span></code> </pre><br><br>  Further, in general, the fun begins.  We request all peers from ASTERISK.  ‚ÄúWhy is everything?‚Äù The reader will ask.  "After all, there is <b>SIPshowregistry</b> !".  Yes.  There is.  But firstly, it will show us only trunks with registration, and secondly, if the provider has become unavailable, and the registration time has not yet expired, then information about the state of the trunk will still be invalid.  ‚ÄúBut SIPpeers will show customers too!‚Äù - and this will be a good point.  therefore, trunks need to be prepared. <br>  In sip / users / &lt;Where are you still who adds your trunks&gt; for each trunk I: <br><br>  1. Enable qualify <br>  2. Prescribed parameter description = line <br><br>  That is, in other words - all that is described as line is the trunk.  Why is it important?  because SIPpeers will give us this description for each feast.  Moreover, it will return it to you in the order in which they are written in your mysql file / table. <br><br>  Channeltype: SIP <br>  ObjectName: mysupertrunk <br>  ChanObjectType: peer <br>  Ipaddress: -none- <br>  IPport: 0 <br>  Dynamic: yes <br>  AutoForcerport: no <br>  Forcerport: yes <br>  AutoComedia: no <br>  Comedia: yes <br>  VideoSupport: no <br>  TextSupport: no <br>  ACL: no <br>  Status: UNKNOWN <br>  RealtimeDevice: no <br>  Description: line <br><br>  In general, then parsing all that is from the peers on the server, we thus perfectly separate the wheat from the chaff and put the grain in one basket called trunks: <br><br><pre> <code class="lua hljs">tcp:send(<span class="hljs-string"><span class="hljs-string">"Action: SIPpeers\r\n\r\n"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> result ~= <span class="hljs-string"><span class="hljs-string">"EventList: start"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> result = tcp:receive() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> trunks = {} i = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> result ~= <span class="hljs-string"><span class="hljs-string">"Event: PeerlistComplete"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> result = tcp:receive() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">find</span></span>(result,<span class="hljs-string"><span class="hljs-string">"ObjectName"</span></span>)~=<span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ObjectName = splitted_value(result,<span class="hljs-string"><span class="hljs-string">": "</span></span>) <span class="hljs-comment"><span class="hljs-comment">--splitted_value -   ,         end if string.find(result,"Description")~=nil then Description = splitted_value(result,": ") end if Description == "line" then trunks[i] = ObjectName i = i + 1 Description=nil --   .     . end end</span></span></code> </pre><br><br>  So now we have an array / table of all trunks on our ASTERISK. <br>  it remains only to find out which one is available and call through it.  This can be done through SIPpeerstatus: <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> key,val <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">pairs</span></span>(trunks) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> tcp:send(<span class="hljs-string"><span class="hljs-string">"Action: SIPpeerstatus\r\n"</span></span>) tcp:send(<span class="hljs-string"><span class="hljs-string">"Peer: "</span></span>..val..<span class="hljs-string"><span class="hljs-string">"\r\n\r\n"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> result~=<span class="hljs-string"><span class="hljs-string">"Event: SIPpeerstatusComplete"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> result=tcp:receive() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">find</span></span>(result,<span class="hljs-string"><span class="hljs-string">"PeerStatus:"</span></span>)~=<span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>=split(result,<span class="hljs-string"><span class="hljs-string">": "</span></span>) <span class="hljs-comment"><span class="hljs-comment">--split    ,      .       if status[2]=="Reachable" then app.Dial("SIP/"..val.."/"..extension) end end end end</span></span></code> </pre><br><br>  Well, do not forget to close the door behind him)) <br><br><pre> <code class="lua hljs">tcp:send(<span class="hljs-string"><span class="hljs-string">"Action: Logoff\r\n\r\n"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> result~=<span class="hljs-string"><span class="hljs-string">"Response: Goodbye"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> result=tcp:receive() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> tcp:<span class="hljs-built_in"><span class="hljs-built_in">close</span></span>()</code> </pre><br><br>  This is, in general, the simplest example of how AMI can be used directly in the dialplan itself.  Also, nothing prevents to recognize the employment of channels.  It will only be necessary to parse the output of the sip show inuse command.  Screws here and mysql connectors and redis, and anything, if necessary.  Without crutches. <br><br>  PS For the lazy there is a whole library ami-lua.  Only here with the documentation there ... no way. </div><p>Source: <a href="https://habr.com/ru/post/264819/">https://habr.com/ru/post/264819/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264803/index.html">Simplify the for-cycle index: range-based version</a></li>
<li><a href="../264805/index.html">Test lab v.8 - pentest laboratory, built on the basis of a real corporate network</a></li>
<li><a href="../264807/index.html">Does the amount of data on the complexity of the development. Accounting in the anthill</a></li>
<li><a href="../264811/index.html">Clustering graphs and searching for communities. Part 2: k-medoids and modifications</a></li>
<li><a href="../264815/index.html">As we raised the IT infrastructure [from the bottom]</a></li>
<li><a href="../264821/index.html">DMP Part 1. Microsegmentation of the audience using keywords</a></li>
<li><a href="../264823/index.html">We write Observer implementation over KVO on objective-c</a></li>
<li><a href="../264827/index.html">Training in the field of practical information security: "Corporate laboratories". New set</a></li>
<li><a href="../264829/index.html">Mobile printing</a></li>
<li><a href="../264839/index.html">15 Important Developer Career Tips</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>