<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Look up from the bottom or Ubuntu Server for the developer of electronics. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue to develop the theme of using a computer with a ubuntu server as a device for connecting the world of microcontrollers with the world of p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Look up from the bottom or Ubuntu Server for the developer of electronics. Part 2</h1><div class="post__text post__text-html js-mediator-article">  We continue to develop the theme of using a computer with a ubuntu server as a device for connecting the world of microcontrollers with the world of personal computers. <br><br>  <a href="https://habrahabr.ru/post/334948/">Link to part 1</a> <br><img src="https://habrastorage.org/web/5cf/0f5/20d/5cf0f520d7294c02a2565f5c90a8bdb8.jpg" alt="image"><br>  Let me remind you that the article describes the practice of using the described equipment and does not set a goal to cover all the depths and possibilities of modern equipment.  This is one of the solutions to the task. <br><a name="habracut"></a><br>  In this section, I will show you how to pass the following points: <br><br><div class="spoiler">  <b class="spoiler_title">Static IP + DHCP server</b> <div class="spoiler_text">  In the local network at the moment there are only two devices.  The server itself and the control machine.  Based on this simplicity, let's configure the Ubuntu server. <br>  <strong>Static IP</strong> <br>  <a href="http://help.ubuntu.ru/wiki/%25D0%25BD%25D0%25B0%25D1%2581%25D1%2582%25D1%2580%25D0%25BE%25D0%25B9%25D0%25BA%25D0%25B0_%25D1%2581%25D0%25B5%25D1%2582%25D0%25B8_%25D0%25B2%25D1%2580%25D1%2583%25D1%2587%25D0%25BD%25D1%2583%25D1%258E">Reference Information</a> <br>  1. To find out the logical name of the network interface: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sudo</span></span> lshw -C network</code> </pre>  and look for the line <pre> <code class="hljs pgsql"> logical <span class="hljs-type"><span class="hljs-type">name</span></span>: enp3s0</code> </pre> <br>  The option of using the ifconfig function (as an analogue of ipconfig in windows) can sometimes only give loop 127.0.0.1.  The name of the interface depends on the hardware.  On two different machines I installed ubuntu from the same flash drive and there were different names for network interfaces.  enp3s0 is a classification by bus and device number, as I understand it.  Happen still from such series eth0 and such ens35.  Do not be scared. <br><br>  2. Change network configuration file <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sudo</span></span> nano /etc/network/interfaces</code> </pre>  (nano - this little text editor) <br>  It should be like this: <br><br><pre> <code class="hljs pgsql"> # This file describes the network interfaces available <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> your <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> how <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> activate them. <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> more information, see interfaces(<span class="hljs-number"><span class="hljs-number">5</span></span>). source /etc/network/interfaces.d<span class="hljs-comment"><span class="hljs-comment">/* # The loopback network interface auto lo iface lo inet loopback # My local network. allow-hotplug enp3s0 iface enp3s0 inet static address 172.16.55.1 netmask 255.255.255.0 gateway 172.16.55.1</span></span></code> </pre><br>  Press cntrl-x - to exit the editor <br>  Press y - to save changes. <br><br>  3. Restart the network service: <br><pre> <code class="hljs pgsql">service networking <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span></code> </pre> <br><br>  <strong>DHCP server</strong> <br>  <a href="http://help.ubuntu.ru/wiki/%25D1%2580%25D1%2583%25D0%25BA%25D0%25BE%25D0%25B2%25D0%25BE%25D0%25B4%25D1%2581%25D1%2582%25D0%25B2%25D0%25BE_%25D0%25BF%25D0%25BE_ubuntu_server/%25D1%2581%25D0%25B5%25D1%2582%25D1%258C/dhcp">Reference Information</a> <br>  1. We edit files for work of the DHCP server <br><pre> <code class="hljs pgsql">sudo nano /etc/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>/isc-dhcp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span></code> </pre>  find the line <pre> <code class="hljs objectivec">INTERFACES=<span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre>  Is the interface name for the DHCP server.  In our case it should be like this: <br><br><pre> <code class="hljs objectivec">INTERFACES=<span class="hljs-string"><span class="hljs-string">"enp3s0"</span></span></code> </pre> <br>  In file <pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sudo</span></span> nano /etc/dhcp/dhcpd.conf</code> </pre>  need to add <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">subnet</span></span> <span class="hljs-number"><span class="hljs-number">172.16.55.0</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255.255.0</span></span>{ <span class="hljs-attribute"><span class="hljs-attribute">range</span></span> <span class="hljs-number"><span class="hljs-number">172.16.55.2</span></span> <span class="hljs-number"><span class="hljs-number">172.16.55.100</span></span>; }</code> </pre>  Within this subnet, the DHCP server will issue addresses in the range from 2 to 100. <br><br>  2. If you use the gethostbyname () function, then in the file <pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sudo</span></span> nano /etc/hosts</code> </pre>  should be spelled pc name and ip.  Perhaps there is a more convenient way to get your own IP, but I did not succumb to it. <br><pre> <code class="hljs css">127<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">localhost</span></span> 172<span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.55</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ubuntu</span></span></code> </pre> <br>  The file / etc / hostname stores the name of the pc (ubuntu).  You can look through <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sudo</span></span> cat /etc/hostname</code> </pre>  and a million more ways. <br><br>  3. Restart the network service: <br><pre> <code class="hljs pgsql">service networking <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span></code> </pre> <br>  <strong>Ssh access</strong> <br>  In theory, having connected a desktop computer now, we will get an IP for it and we will be able to access via SSH.  For access from Windows, I used the PuTTY utility.  In the same place, in the PuTTY program files, there is a utility for transmitting data over the network. <br>  Here is the composition of the batch file for transferring files from Ubuntu to Windows. <br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">d:</span></span>\<span class="hljs-string"><span class="hljs-string">"Program Files"</span></span>\PuTTY\pscp.exe ubuntu@172.<span class="hljs-number"><span class="hljs-number">16.55</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/home/ubuntu/tool/*</span></span> <span class="hljs-string"><span class="hljs-string">"F:/WORK/SERVER/tool/"</span></span></code> </pre> <br>  And for uploading to the server <br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">d:</span></span>\<span class="hljs-string"><span class="hljs-string">"Program Files"</span></span>\PuTTY\pscp.exe <span class="hljs-string"><span class="hljs-string">"F:/WORK/SERVER/tool/*"</span></span> ubuntu@172.<span class="hljs-number"><span class="hljs-number">16.55</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/home/ubuntu/tool/</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Put the driver from FTDI</b> <div class="spoiler_text">  FTDI drivers are shipped in a compressed form.  The package contains the drivers themselves, libraries, usage examples and the README.pdf file that was most interesting.  From the <a href="http://www.ftdichip.com/Support/Documents/ProgramGuides/AN_379%2520D3xx%2520Programmers%2520Guide.pdf">D3XX Programmers Guide</a> file <a href="http://www.ftdichip.com/Support/Documents/ProgramGuides/AN_379%2520D3xx%2520Programmers%2520Guide.pdf">it</a> is never clear how to use a driver for Linux.  I even had to write to those who support FTDI, since they are responsible in a timely and responsible manner.  It would be possible not to write if I immediately opened this archive.  But the links that they sent, examples of wiring and circuitry turned out to be useful. <br>  As shown above, using the pscp utility from the PuTTY kit, copy the driver to the server.  I had d3xx-linux-i686-0.5.0.tar.bz2.  Go to this folder on the server and do <pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">tar</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-xvf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">d3xx-linux-i686-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.tar</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.bz2</span></span></code> </pre> <br>  Further, according to the instructions FTDI execute: <br><pre> <code class="hljs pgsql">cd linux-i686 sudo rm -f /usr/lib/libftd3xx.so sudo cp -f libftd3xx.so /usr/lib sudo cp -f libftd3xx.so<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> /usr/lib sudo cp -f <span class="hljs-number"><span class="hljs-number">51</span></span>-ftd3xx.rules /etc/udev/rules.d sudo udevadm control <span class="hljs-comment"><span class="hljs-comment">--reload-rules</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Compile the program</b> <div class="spoiler_text">  I wrote the program in codeBlocks and it, with the exception of some points, including because of FTDI, is compatible with Windows.  It stopped compiling for Windows when I put the h file from the linux driver D3XX there (there were no problems with the D2XX and FT232RL chip). <br>  Now makefile.  Programmers already know why it is needed, just point out the features: <br>  STATLIB = libftd3xx.a - specify the name of the library for Linux <br>  CFLAGS = $ (DEPENDENCIES) -Wall -Wextra -std = c ++ 11 - enable c ++ 11 <br><div class="spoiler">  <b class="spoiler_title">sample makefile for one main.cpp project file</b> <div class="spoiler_text"><pre> <code class="hljs mel">CC=g++ UNAME := $(shell uname) ifeq ($(UNAME), Darwin) DEPENDENCIES := -lpthread -ldl -lobjc -framework IOKit -framework CoreFoundation <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> DEPENDENCIES := -lpthread -ldl -lrt endif CFLAGS=$(DEPENDENCIES) -Wall -Wextra -std=c++<span class="hljs-number"><span class="hljs-number">11</span></span> STATLIB=libftd3xx.a APP = prgr all: $(APP) $(APP): main.o $(CC) -o $(APP) main.o $(STATLIB) $(CFLAGS) main.o: main.cpp $(CC) -c -o main.o main.cpp $(CFLAGS) clean: rm -f *.o ; rm $(APP)</code> </pre></div></div><br>  Thus, in the project folder are the main.c files ftd3xx.h makefile libftd3xx.a and other project files.  And to compile the project, now you need to go into this folder and make <br><pre> <code class="hljs go"><span class="hljs-built_in"><span class="hljs-built_in">make</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">daemon</b> <div class="spoiler_text">  The role of daemons in Linux is similar to the role of services in Windows.  These are programs that live in the background and do all peripheral work.  It all starts with systemd - the program that starts first, has a PID = 1, respectively, and runs all other background tasks through scripts.  Having picked it up in Ubuntu, I was surprised at how much of everything inside is built on scripts.  You have already seen how static IP changes, programs are configured, by simply correcting files in a text editor. <br><br>  By completing <pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ps</span></span> -el</code> </pre>  You will see a list of running programs with their PID.  PID is a mandatory identifier of a running program, which the OS monitors for this program.  In an extreme situation, you can bang the program on this PID from the terminal - write kill and PID (it can be useful for debugging). <br><br>  So, when starting the daemon, a script is executed, which indicates when and how the program should be started, how to stop or restart it.  In order for the daemon to work normally, the program, upon launch, must save its PID to the file, the path to which is specified in the script, and switch to another stream (to the background mode). <br><br>  <a href="https://habrahabr.ru/post/129207/">The manual on the demon</a> brought me into sadness and longing.  Strongly simplifying the daemon, I turned it into a utility to run any program.  But the mandatory part has not changed.  In addition, he keeps a log to check if anything happens. <br><br><div class="spoiler">  <b class="spoiler_title">daemon code</b> <div class="spoiler_text"><pre> <code class="hljs perl">void SetPidFile(char* Filename) { FILE* f; f = fopen(Filename, <span class="hljs-string"><span class="hljs-string">"w+"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (f) { fprintf(f, <span class="hljs-string"><span class="hljs-string">"%u"</span></span>, getpid()); fclose(f); } } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> main( <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> argc, char** argv ) { char toolfile[<span class="hljs-number"><span class="hljs-number">32</span></span>]; char folder[<span class="hljs-number"><span class="hljs-number">32</span></span>]; intptr_t ret; FILE* logfile; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( argc!=<span class="hljs-number"><span class="hljs-number">3</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">printf</span></span>( <span class="hljs-string"><span class="hljs-string">"Write address of the program and name: /home/ubuntu/tool/ tool\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">1</span></span>; } pid_t pid, sid; pid = <span class="hljs-keyword"><span class="hljs-keyword">fork</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pid &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">sleep</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">1</span></span>; } //We got a good pid, Close the Parent Process <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pid &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } //Create a new Signature Id <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">our</span></span> child sid = setsid(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sid &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">1</span></span>; } //Change File Mask <span class="hljs-keyword"><span class="hljs-keyword">umask</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>Save PID memcpy( toolfile, argv[<span class="hljs-number"><span class="hljs-number">0</span></span>], strlen(argv[<span class="hljs-number"><span class="hljs-number">0</span></span>]) ); memcpy( toolfile + strlen(argv[<span class="hljs-number"><span class="hljs-number">0</span></span>]), <span class="hljs-string"><span class="hljs-string">".log"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span> ); memset( toolfile + strlen(argv[<span class="hljs-number"><span class="hljs-number">0</span></span>]) + <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">printf</span></span>( <span class="hljs-string"><span class="hljs-string">"Daemon:: log to:%s\n"</span></span>, toolfile ); logfile = fopen( toolfile, <span class="hljs-string"><span class="hljs-string">"w"</span></span> ); fprintf( logfile, <span class="hljs-string"><span class="hljs-string">"Daemon:: started with 0=%s 1=%s 2=%s\n"</span></span>, argv[<span class="hljs-number"><span class="hljs-number">0</span></span>], argv[<span class="hljs-number"><span class="hljs-number">1</span></span>], argv[<span class="hljs-number"><span class="hljs-number">2</span></span>] ); memset( toolfile, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span> ); memcpy( toolfile, argv[<span class="hljs-number"><span class="hljs-number">0</span></span>], strlen(argv[<span class="hljs-number"><span class="hljs-number">0</span></span>]) ); memcpy( toolfile + strlen(argv[<span class="hljs-number"><span class="hljs-number">0</span></span>]), <span class="hljs-string"><span class="hljs-string">".pid"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span> ); memset( toolfile + strlen(argv[<span class="hljs-number"><span class="hljs-number">0</span></span>]) + <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> ); SetPidFile( toolfile ); fprintf( logfile, <span class="hljs-string"><span class="hljs-string">"Daemon:: PID=%u saved in the %s\n"</span></span>, getpid(), toolfile ); memset( folder, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span> ); memcpy( folder, argv[<span class="hljs-number"><span class="hljs-number">1</span></span>], strlen(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]) ); fflush ( logfile ); memset( toolfile, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span> ); memcpy( toolfile, folder, strlen(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]) ); memset( toolfile + strlen(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]), <span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> ); memcpy( toolfile + strlen(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]) + <span class="hljs-number"><span class="hljs-number">1</span></span>, argv[<span class="hljs-number"><span class="hljs-number">2</span></span>], strlen(argv[<span class="hljs-number"><span class="hljs-number">2</span></span>]) ); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>Change Directory //If we cant find the directory we <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> with failure. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">chdir</span></span>(folder)) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { fprintf( logfile, <span class="hljs-string"><span class="hljs-string">"Daemon:: Program folder was not found:%s\n"</span></span>, folder ); fclose( logfile ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">1</span></span>; } //Close Standard File Descriptors <span class="hljs-keyword"><span class="hljs-keyword">close</span></span>(STDIN_FILENO); <span class="hljs-keyword"><span class="hljs-keyword">close</span></span>(STDOUT_FILENO); <span class="hljs-keyword"><span class="hljs-keyword">close</span></span>(STDERR_FILENO); fprintf( logfile, <span class="hljs-string"><span class="hljs-string">"Daemon:: Program started\n"</span></span> ); fflush ( logfile ); ret = execl( toolfile, folder, NULL ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ret==-<span class="hljs-number"><span class="hljs-number">1</span></span> ) { fprintf( logfile, <span class="hljs-string"><span class="hljs-string">"Daemon:: execl error: %s. File=%s Folder=%s\n"</span></span>, strerror(errno), toolfile, folder ); fclose( logfile ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">1</span></span>; } fprintf( logfile, <span class="hljs-string"><span class="hljs-string">"Daemon:: closed\n"</span></span> ); fclose( logfile ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre></div></div><br>  Compile the daemon. <br><br>  At this point in our working directory, say / home / ubuntu / daemon /, we have: <br><br>  daemon - daemon program <br>  prgr - program <br>  prgr.strt - a script that you need to run before starting the program (if necessary) <br>  prgr.stop - the script that you need to run to stop the program (if necessary) <br><br>  You need to allow programs to work: <br><br><pre> <code class="hljs perl">sudo <span class="hljs-keyword"><span class="hljs-keyword">chmod</span></span> <span class="hljs-number"><span class="hljs-number">755</span></span> ./tool sudo <span class="hljs-keyword"><span class="hljs-keyword">chmod</span></span> <span class="hljs-number"><span class="hljs-number">755</span></span> ./daemon</code> </pre> <br>  Now I need a script for systemd <br>  Do <pre> <code class="hljs pgsql">sudo nano /etc/systemd/<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>/mydaemon.service</code> </pre>  and write our script there. <br><br><div class="spoiler">  <b class="spoiler_title">mydaemon.service</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">[Unit] Description=my service <span class="hljs-keyword"><span class="hljs-keyword">After</span></span>=network.target <span class="hljs-keyword"><span class="hljs-keyword">After</span></span>=isc-dhcp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.service [Service] <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>=forking PIDFile=/home/ubuntu/daemon/daemon.pid ExecStartPre=/bin/sh /home/ubuntu/daemon/prgr.strt ExecStart=/home/ubuntu/daemon/daemon /home/ubuntu/daemon/prgr prgr ExecStop=/bin/sh /home/ubuntu/daemon/prgr.stop <span class="hljs-keyword"><span class="hljs-keyword">Restart</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">always</span></span> TimeoutSec=<span class="hljs-number"><span class="hljs-number">5</span></span> [Install] WantedBy=multi-<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.target</code> </pre></div></div><br>  In the script briefly: <br>  Description - a short title description. <br>  After - what is required to run <br>  Type = forking - systemd assumes that the service is started once and the process forks with the completion of the parent process. <br>  PIDFile - file with the program PID from the daemon <br>  ExecStartPre - before launching the program <br>  ExecStart - program with parameters <br>  ExecStop - how to stop <br>  WantedBy - the level at which to run <br><br>  Now you can try to run everything. <br>  We write <br><pre> <code class="hljs lua">systemctl daemon-reload systemctl <span class="hljs-built_in"><span class="hljs-built_in">status</span></span> mydaemon</code> </pre> <br>  If everything is without errors, then run: <br><pre> <code class="hljs pgsql">systemctl <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> mydaemon</code> </pre> <br>  After that, see the demon log, everything should go. <br>  For autoload to work <pre> <code class="hljs pgsql">systemctl <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> mydaemon</code> </pre> <br></div></div><br>  Friends, I look forward to your interesting comments and valuable tips.  If you lied to where you are, do not get angry, just indicate what can be done better.  I hope, there will be 3 part about a big script, automatic installation ... maybe something else. </div><p>Source: <a href="https://habr.com/ru/post/335042/">https://habr.com/ru/post/335042/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335032/index.html">3CX 15.5 SP1 Beta Release and Acquisition of Askozia</a></li>
<li><a href="../335034/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ274 (August 1 - 6, 2017)</a></li>
<li><a href="../335036/index.html">Clearing the flow of calls without magic and SMS</a></li>
<li><a href="../335038/index.html">Virtual network environment for testing network protocols. Use QEMU + YOCTO + TAP</a></li>
<li><a href="../335040/index.html">Basic Linux fortification: choosing hedgehogs and learning to dig trenches</a></li>
<li><a href="../335044/index.html">vCloud Director</a></li>
<li><a href="../335046/index.html">In the footsteps of Petya: find and exploit a software vulnerability</a></li>
<li><a href="../335048/index.html">Start learning Elixir right now! Translation of the entire series of articles is ready.</a></li>
<li><a href="../335050/index.html">Anatomy of GraphQL Queries</a></li>
<li><a href="../335052/index.html">True neural network implementation from scratch in the C # programming language</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>