<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Programming a mouse" for microcontrollers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many microcontroller platforms support tools for creating initial configuration of peripheral devices and I / O ports. Typically, this is a graphical ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Programming a mouse" for microcontrollers</h1><div class="post__text post__text-html js-mediator-article">  Many microcontroller platforms support tools for creating initial configuration of peripheral devices and I / O ports.  Typically, this is a graphical environment in which the parameters of the crystal are set and the source code can be generated - the blank of the future project. <br><br>  When using such a configurator, you significantly simplify the initial stage of programming, but do it not to the detriment of understanding the processes occurring on the chip. <br>  Below is an example of using a configurator for a C8051F930 microcontroller from Silicon Labs.  We will control the brightness of the LED with a potentiometer, writing with your hands just two lines of code.  Just for fun, of course. <br><img src="https://habrastorage.org/files/fce/e9f/350/fcee9f350c7f49bba9f6f36ab9f0201d.jpg"><br><a name="habracut"></a><br><h4>  <b>Initial data</b> </h4><br>  All Silicon Labs software development tools are available as part of the Simplicity Studio software platform.  The platform is distributed free of charge and contains IDE, documentation, a lot of examples of programs, as well as additional utilities like the <a href="http://habrahabr.ru/post/257503/">power consumption profiler</a> and the configurator.  In this example, the configurator and development environment will be used. <br>  The debugging board C8051F930-TB serves as a hardware platform, since it has a potentiometer and an LED, and the C8051F930 microcontroller has the necessary ADC and PWM blocks.  In general, a simple set of requirements is imposed on the board, which is suitable for a variety of debugging tools.  But the C8051F930-TB was on hand :) <br><br><h5>  <b>Step 1. Preparation</b> </h5><br>  Preparation is to install and run Simplicity Studio on a computer and turn on the debug board.  The board is powered from the battery or from the network and, in the absence of the built-in debugger, is connected to the computer via the DEBUGADPTR1-USB programmer. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/20f/b18/50a/20fb1850a93446758ed02d82355fa8e9.png" alt="image"><br><br>  After the correct connection, the board is detected by the medium, and all tools for 8-bit crystals become available. <br><br><img src="https://habrastorage.org/files/aca/77f/c18/aca77fc186d843a49ff80cad3ba80c20.png" alt="image"><br><br><h5>  <b>Step 2. Creating a project</b> </h5><br>  For the well-known debug board, the dialog for creating a new project appears immediately after clicking on the configurator icon.  The project creation wizard does not contain any unusual elements, only the selection of the target controller, the name and location of the project, etc. <br>  The interface of the configurator itself consists of three main parts: <br><ul><li>  Peripheral Configurator </li><li>  I / O port configurator </li><li>  Microcontroller state graph </li></ul><br><img src="https://habrastorage.org/files/e7c/21e/8ce/e7c21e8ce7ff484f9be21f04845e3955.png" alt="image"><br><br><h5>  <b>Step 3. Configuring Peripherals</b> </h5><br>  The peripheral device configurator is a list of peripheral modules and core functions available on the selected chip.  For the implemented task you will need: <br><ol><li>  Activate and adjust the ADC to process the signal from the potentiometer; </li><li>  Activate and adjust the timer to initiate conversion to the ADC with the desired frequency; </li><li>  Activate and configure the PCA unit (the so-called programmable array of meters), on which a hardware PWM generator is available on the C8051Fxxx microcontrollers. </li></ol><br>  But let's start with the inclusion of the controller clock generator.  It is enough to tick Clock Conrol - the built-in 25 MHz frequency generator with a divider by 8 suits us perfectly, therefore we leave the block settings available in the window on the right with the default settings. <br><br><img src="https://habrastorage.org/files/f88/baf/cf1/f88bafcf1d3a44d08494c5a1f5c77436.png" alt="image"><br><br>  After setting the clock, go to the timers-counters.  We will poll the ADC once in 1 ms, so we set TIMER2 to overflow with the appropriate frequency: put a tick on the TIMER2 block, specify the frequency in microseconds, set the Start in the Run Control field so that the timer starts automatically. <br><br><img src="https://habrastorage.org/files/c36/1b8/059/c361b80593b04bdf9cc8a864d7460a7c.png" alt="image"><br><br>  When TIMER2 was activated, the Timer Setup module turned on in red.  Timer Setup must be activated for timers / counters, tick. <br><br><img src="https://habrastorage.org/files/61d/c07/69f/61dc0769f4a84201965822168c41b014.png" alt="image"><br><br>  By overflowing the timer, the conversion will begin on the ADC block.  Configuring the ADC includes enabling the operation of the block, specifying the event for starting the operation, specifying the I / O line for receiving the measured signal, and selecting the 8-bit conversion mode without amplification. <br><br><img src="https://habrastorage.org/files/7dd/8f5/354/7dd8f5354be04db5a264cb68310f1062.png" alt="image"><br><br>  The reference voltage for the ADC is specified in a separate Voltage Reference block.  In the appropriate paragraph indicate the voltage of the board. <br><br><img src="https://habrastorage.org/files/424/0df/919/4240df919efd483ca158d5d8efa8af77.png" alt="image"><br><br>  So, with the correct implementation of the described settings, we get a working crystal, in which the millisecond value in the result register of the ADC is updated in accordance with the position of the potentiometer wheel.  To use this value for generating a PWM signal, it is necessary, in addition to setting the PWM block, to enable an interrupt from the ADC and set up an interrupt handler (copy the value from the result register of the ADC to the data register of the PWM block).  Using the tools of the Configurator utility, you can only configure the interrupt controller: activate the Interrupts block and the interrupt from the ADC0, enable all interrupts. <br><br><img src="https://habrastorage.org/files/6ea/6f8/04b/6ea6f804bebe4103a8d4f048413ea12d.png" alt="image"><br><br>  It remains to configure the PCA to generate a PWM signal.  Select the desired mode on Channel0 and set the automatic start (i.e. immediately after switching on or reset). <br><br><img src="https://habrastorage.org/files/ae5/df4/0bb/ae5df40bb4b743e7b7d9467bb37567e6.png" alt="image"><br><br><h5>  <b>Step 4. Configure I / O ports</b> </h5><br>  The mode of the controller is created.  Go to the next tab to configure the input / output ports - you will need to determine the input of the ADC and the PWM output in accordance with the topology of the board. <br><br>  The P0.6 line connected to the potentiometer was indicated as an input for the signal even when setting ADC0.  It is marked on the pinout of the crystal.  On the right, in the settings window of the selected ‚Äúlegs‚Äù mode of operation, two red crosses unambiguously hint that two parameters need to be corrected. <br><br><img src="https://habrastorage.org/files/790/3d6/a8c/7903d6a8c6894a97916d11e42d1012c9.png" alt="image"><br><br>  Open Drain mode is not suitable for analog input, change it to Analog I / O.  The Skip parameter refers to a CROSSBAR, a digital switch that establishes ‚Äúperipheral module -&gt; input / output ports‚Äù connections in C8051Fxxx microcontrollers.  Since the P0.6 line is the input of the microcontroller, it should not be taken into account in the CROSSBAR.  Choose Skipped. <br><br>  Go to setting the output for the PWM signal - the zero channel of the PCA block should be brought to the P1.6 line, to the yellow LED.  Such a relationship is just given through CROSSBAR.  We allow his work. <br><br><img src="https://habrastorage.org/files/eb3/c82/208/eb3c82208e304a868ebfff153782248a.png" alt="image"><br><br>  The CROSSBAR settings menu has appeared.  Put a tick on the zero PCA channel, the PWM is automatically on the P0.0 line. <br><br><img src="https://habrastorage.org/files/cad/b85/f5b/cadb85f5beff4fea98b0b0a24bf3bfe1.png" alt="image"><br><br>  PWM should be ‚Äúmoved‚Äù to P1.6, and for P1.6 you should specify the mode of Push-Pull Output instead of Open Dain. <br><br><img src="https://habrastorage.org/files/e2e/bd2/998/e2ebd2998bbd4f2f988c1cf385b5c825.png" alt="image"><br><br><h5>  <b>Step 5. Generation and addition of source code</b> </h5><br>  Generation and updating of the source code from the specified configuration occurs when the project is saved or by the command Generate Source, accessible from the menu by pressing the right mouse button.  The source code must be supplemented with an interrupt handler, and the handler template is created automatically due to the resolution of the ADC interrupt. <br><br><img src="https://habrastorage.org/files/d49/b4c/7ad/d49b4c7ad5da465789e92cccafe0dd92.png" alt="image"><br><br>  We write the very two lines of code: remove the interrupt flag at the end of the conversion, copy the contents of the ADC data register to the PWM register. <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ADC0CN_ADINT</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">PCA0CPH0</span></span> = (U8) (ADC0 &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>);</code> </pre> <br>  In addition to the peripherals and ports configurators, for 8-bit microcontrollers a tool is available for defining state graphs.  The tools that were used above describe the default mode of the controller, and in the state column it is possible to create several modes, each of which will have its own configurator of peripherals and ports.  However, in this example, the C8051F930 operates in a single mode. <br><br><h5>  <b>Step 6. Compile, run</b> </h5><br>  The project was created, remained assembly, compilation and programming of the crystal. <br>  The result of the work is on video. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://rutube.ru/play/embed/7795926&amp;xid=17259,15700002,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgOxL91eiJUqXTw9G5v9hPLjociVQ" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe><br><br>  <a href="https://www.silabs.com/Support%2520Documents/TechnicalDocs/AN794.pdf">Resource Used</a> </div><p>Source: <a href="https://habr.com/ru/post/261253/">https://habr.com/ru/post/261253/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261241/index.html">Read more about 3D navigation in nanoCAD Plus 7</a></li>
<li><a href="../261243/index.html">World OpenStack Summit and other news</a></li>
<li><a href="../261245/index.html">Lecture by Dmitry Vetrov on big data math: tensors, neural networks, Bayesian inference</a></li>
<li><a href="../261247/index.html">Anatomy of virtual telephony. Familiarity with the interface. Part 2</a></li>
<li><a href="../261249/index.html">Library patterns: Why frameworks are evil</a></li>
<li><a href="../261255/index.html">Sberbank Security Online</a></li>
<li><a href="../261257/index.html">220 Volt AC Voltage Regulator</a></li>
<li><a href="../261259/index.html">Yandex-Transfer in the terminal via Java</a></li>
<li><a href="../261263/index.html">"Pip -t" is a simple alternative to virtualenv</a></li>
<li><a href="../261265/index.html">Overview of new features in NDepend 6</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>