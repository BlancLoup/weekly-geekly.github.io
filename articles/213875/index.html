<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Organizing code in django applications or thick models is great.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From translator  As always free translation of an interesting article about a specific approach to code organization in django-applications. It will b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Organizing code in django applications or thick models is great.</h1><div class="post__text post__text-html js-mediator-article"><div class="spoiler">  <b class="spoiler_title">From translator</b> <div class="spoiler_text">  As always free translation of an interesting article about a specific approach to code organization in django-applications.  It will be useful: <br><ul><li>  Those who have not thought about such issues </li><li>  Those who already have their own views on the organization of logic, but not against the alternative options </li><li>  Those who already use the discussed approach to confirm their thoughts </li><li>  Those who no longer use the discussed approach and have arguments against </li></ul><br>  There won't be a lot of code, the article is mostly debatable.  Enzhoy) <br></div></div><br><br><img src="https://habrastorage.org/getpro/habr/post_images/fcb/f5b/d4e/fcbf5bd4e871347d3b0d77bb28a1e405.png" alt="image"><br>  <i>Thick models.</i> <br><a name="habracut"></a><br><h2>  Intro </h2><br>  Most django tutorials and examples on this framework set a bad example for beginners in terms of organizing code in their projects.  In the case of a large / long-playing application, the code structure, underlined from similar examples, can cause nontrivial problems and difficult situations in the development process.  In this article I will describe an alternative, rather rare approach to code organization, which I hope will seem interesting to you. <br><br><h2>  MVC in django = MTV + embedded C </h2><br>  Have you ever tried to explain how MTV is organized in django, say, RoR-developer?  Some might think that templates are views, and views are controllers.  Not certainly in that way.  A controller is a URL router built into django that provides request-response logic.  Views are needed to present the right data in the right templates.  Templates and views collectively constitute the ‚Äúpresentation‚Äù layer of the framework. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There are many advantages in such MTV - with its help, you can easily and quickly create typical and not only applications.  However, it remains unclear where the logic for processing and editing data should be stored, where to abstract the code in which cases.  Let's evaluate several different approaches and look at the results of their application. <br><br><h2>  Logic in views </h2><br>  Put all or most of the logic in the view.  The approach most often found in various tutorials and for beginners.  It looks something like this: <br><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accept_quote</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, quote_id, template_name=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"accept-quote.html"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> quote = Quote.objects.get(id=quote_id) form = AcceptQuoteForm() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> request.METHOD == <span class="hljs-string"><span class="hljs-string">'POST'</span></span>: form = AcceptQuoteForm(request.POST) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> form.is_valid(): quote.accepted = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> quote.commission_paid = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-comment"><span class="hljs-comment">#   provider_credit_card = CreditCard.objects.get(user=quote.provider) braintree_result = braintree.Transaction.sale({ 'customer_id': provider_credit_card.token, 'amount': quote.commission_amount, }) if braintree_result.is_success: quote.commission_paid = True transaction = Transaction(card=provider_credit_card, trans_id = result.transaction.id) transaction.save() quote.transaction = transaction elif result.transaction: #  ,      celery logger.error(result.message) else: #  ,      celery logger.error('; '.join(result.errors.deep_errors)) quote.save() return redirect('accept-quote-success-page') data = { 'quote': quote, 'form': form, } return render(request, template_name, data)</span></span></code> </pre> <br><br>  It is extremely simple, so at first glance it is attractive - all the code is in one place, there is no need to strain the brain and abstract something there.  But this is only at first glance.  Such an approach does not scale well and quickly leads to loss of readability.  I had the good fortune to contemplate ideas for half a thousand lines of code, from which even experienced developers had reduced cheekbones and cams.  Thick views lead to duplication and complication of the code, they are hard to test and debug, and as a result, it is easy to break. <br><br><h2>  Logic in Forms </h2><br>  Forms in django are object-oriented, they validate and clear data, so that they can also be considered as the location of logic. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accept_quote</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, quote_id, template_name=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"accept-quote.html"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> quote = Quote.objects.get(id=quote_id) form = AcceptQuoteForm() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> request.METHOD == <span class="hljs-string"><span class="hljs-string">'POST'</span></span>: form = AcceptQuoteForm(request.POST) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> form.is_valid(): <span class="hljs-comment"><span class="hljs-comment">#     form.accept_quote() success = form.charge_commission() return redirect('accept-quote-success-page') data = { 'quote': quote, 'form': form, } return render(request, template_name, data)</span></span></code> </pre><br><br>  Already better.  The problem is that now the form for receiving payment is also engaged in processing commissions for credit cards.  Nekomilfo.  What if we want to use this function in some other place?  We are, of course, smart and could code the necessary impurities, but again, what if we need this logic in the console, in celery, or another external application?  The decision to instantiate the form to work with the model does not look right. <br><br><h2>  Code in class-based views </h2><br>  The approach is very similar to the previous one - the same advantages, the same disadvantages.  We do not have access to logic from the console and from external applications.  Moreover, the inheritance pattern of the views in the project is complicated. <br><br><h2>  utils.py </h2><br>  Another simple and tempting approach is to abstract all side code from views and put it in the form of utility functions into a separate file.  It would seem that a quick solution to all problems (which many in the end and choose), but let's think a little. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accept_quote</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, quote_id, template_name=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"accept-quote.html"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> quote = Quote.objects.get(id=quote_id) form = AcceptQuoteForm() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> request.METHOD == <span class="hljs-string"><span class="hljs-string">'POST'</span></span>: form = AcceptQuoteForm(request.POST) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> form.is_valid(): <span class="hljs-comment"><span class="hljs-comment">#    utility- accept_quote_and_charge(quote) return redirect('accept-quote-success-page') data = { 'quote': quote, 'form': form, } return render(request, template_name, data)</span></span></code> </pre><br><br>  The first problem is that the location of such functions may not be obvious, the code relating to certain models can be spread over several packages.  The second problem is that when your project grows up and new / other people start working on it, it will be unclear what functions exist at all.  That, in turn, increases development time, annoys developers and can cause duplication of code.  Certain things can be caught on the code review, but this is a decision after the fact. <br><br><h2>  Solution: fat models and fat managers </h2><br>  Models and their managers are an ideal place to encapsulate code for processing and updating data, especially when such code is logically or functionally tied to the capabilities of the ORM.  In essence, we extend the API of the model with our own methods. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accept_quote</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, quote_id, template_name=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"accept-quote.html"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> quote = Quote.objects.get(id=quote_id) form = AcceptQuoteForm() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> request.METHOD == <span class="hljs-string"><span class="hljs-string">'POST'</span></span>: form = AcceptQuoteForm(request.POST) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> form.is_valid(): <span class="hljs-comment"><span class="hljs-comment">#      quote.accept() return redirect('accept-quote-success-page') data = { 'quote': quote, 'form': form, } return render(request, template_name, data)</span></span></code> </pre><br><br>  For my taste, this solution is the most correct.  The credit card processing code is gracefully encapsulated, the logic is in a relevant place for it, the necessary functionality is easy to find and (re) to use. <br><br><h2>  Summary: General Algorithm </h2><br>  Where to write code <s>ble @ th</s> ?  If your logic is tied to the request object, then it is probably the place in the view.  Otherwise, consider the following order of options: <br><ul><li>  Code in the model method </li><li>  Code in manager method </li><li>  Code in form method </li><li>  Code in the CBV method </li></ul><br>  If none of the options fit, it may be worthwhile to consider abstracting into a separate utility-function. <br><br><h2>  TL; DR </h2><br>  The logic in the models improves django-applications <s>not to mention your hair</s> . <br><br><h2>  Bonus </h2><br>  In the comments to the original topic slipped links to two interesting applications that are close to the topic of the article. <br><br>  <a href="https://github.com/kmmbvnr/django-fsm">github.com/kmmbvnr/django-fsm</a> - <i>state machine support for django-models</i> (from the description).  You set the FSMField field on the model and track the change of the predefined states with the help of a decorator in the spirit of the <a href="http://habrahabr.ru/users/receiver/" class="user_link">receiver</a> . <br><br>  <a href="https://github.com/adamhaney/django-ondelta">github.com/adamhaney/django-ondelta</a> is <i>an impurity for django models that allows you to process changes in the fields of a model.</i>  <i>Provides API in style of own clean _ * - methods of model</i> .  Does exactly what is stated in the description. <br><br>  In the same place, another approach was proposed - to abstract all code related to business logic into a separate module.  For example, in the prices application, select the entire code responsible for processing prices in the processing module.  Similar to the utils.py approach, it differs in that we abstract business logic, and not everything in a row. <br><br>  In my own projects, I generally use the approach of the author of the article, adhering to this logic: <br><ul><li>  Code in the model method - <i>if the code refers to a specific model instance</i> </li><li>  Code in the manager method - <i>if the code affects the entire relevant table</i> </li><li>  Code in the form method - <i>if the code validates and / or prepares data from the request</i> </li><li>  The code in the CBV method is <i>what applies to the request and the residual</i> </li><li>  In utils.py, the <i>code is not directly related to the project.</i> </li></ul><br>  Discuss? </div><p>Source: <a href="https://habr.com/ru/post/213875/">https://habr.com/ru/post/213875/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../213861/index.html">Review of the first tablet Nokia Lumia 2520</a></li>
<li><a href="../213863/index.html">C ++ 11 standard implementation implementation bugs in Visual Studio 2012 that were fixed in Visual Studio 2013</a></li>
<li><a href="../213865/index.html">The new version of the mobile application Payoneer</a></li>
<li><a href="../213867/index.html">Atlassian JIRA 6.2: Be better than yesterday</a></li>
<li><a href="../213873/index.html">What needs to be taught in the Master in Computer Science?</a></li>
<li><a href="../213881/index.html">Rocket SpaceX Falcon-9 will test folding support for a soft landing</a></li>
<li><a href="../213883/index.html">Apple massively blocks developer accounts from the Russian Federation</a></li>
<li><a href="../213885/index.html">Anonymous hosting service with i2p access</a></li>
<li><a href="../213887/index.html">Chicago police have compiled a list of 400 alleged future criminals.</a></li>
<li><a href="../213889/index.html">DARPA funds chip development to validate electronic components</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>