<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Developing a game server on Nadron</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will talk about the main points of developing a game server on the Nadron framework, about the stack of technologies I use in develo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Developing a game server on Nadron</h1><div class="post__text post__text-html js-mediator-article">  In this article I will talk about the main points of developing a game server on the <a href="https://github.com/menacher/java-game-server/tree/netty4">Nadron</a> framework, about the stack of technologies I use in development, and give an example of the structure of the project for a browser game. <br><a name="habracut"></a><br><h4>  Why exactly Nadron? </h4><br>  First of all, it implements all popular protocols for data transfer, and within a single game you can use any number of protocols, besides, you can create and add your own options.  The engine allows you to write linear code inside the game rooms and implements the basic commands.  For the client, js, as3, java or <a href="https://github.com/taluks/Nadclient-Dart">dart</a> are written ready-made libraries for working with Nadron. <br><br><h4>  What are we doing? </h4><br>  We make a blank that is suitable for implementing most of your <br>  ideas and will provide an opportunity to figure out what's what for everyone else.  In particular, ready-made authentication methods for the social network VKontakte, creating a data scheme, loading game entities, as well as a lobby, simple game rooms, etc. <br><br>  The example for this article was developed for WebSocket, but this does not really matter, since the differences for any other protocol are minimal.  But first I advise you to get acquainted with <a href="http://nerdronix.blogspot.ru/2013/06/creating-multiplayer-game-using-html-5.html">an example</a> from the author Nadron. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Configuration </h4><br>  At first about dependences.  We will need Nadron, Spring, <a href="https://flywaydb.org/">Flyway</a> and <a href="http://www.mchange.com/projects/c3p0/">c3p0</a> , for the Gradle project it will look like this: <br><br><div class="spoiler">  <b class="spoiler_title">build.gradle</b> <div class="spoiler_text"><pre><code class="hljs sql">// Apply the java plugin to add support for Java apply plugin: 'java' apply plugin: 'org.flywaydb.flyway' // In this section you <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> find the dependencies <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> your <span class="hljs-keyword"><span class="hljs-keyword">project</span></span> repositories { // <span class="hljs-keyword"><span class="hljs-keyword">Use</span></span> <span class="hljs-string"><span class="hljs-string">'jcenter'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> resolving your dependencies. // You can <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> Maven/Ivy/<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> repository here. jcenter() } buildscript { repositories { mavenCentral() } dependencies { classpath <span class="hljs-string"><span class="hljs-string">"org.flywaydb:flyway-gradle-plugin:4.0.3"</span></span> } } flyway { <span class="hljs-keyword"><span class="hljs-keyword">url</span></span> = <span class="hljs-string"><span class="hljs-string">'jdbc:postgresql://localhost:5432/game_db'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = <span class="hljs-string"><span class="hljs-string">'postgres'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> = <span class="hljs-string"><span class="hljs-string">'postgres'</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> spring_version = <span class="hljs-string"><span class="hljs-string">'5.0.1.RELEASE'</span></span> // <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> this <span class="hljs-keyword"><span class="hljs-keyword">section</span></span> you <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> the dependencies <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> your production <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> code dependencies { // The production code uses the SLF4J <span class="hljs-keyword"><span class="hljs-keyword">logging</span></span> API <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> compile <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> compile <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>: <span class="hljs-string"><span class="hljs-string">'org.slf4j'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: <span class="hljs-string"><span class="hljs-string">'slf4j-log4j12'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-string"><span class="hljs-string">'1.7.25'</span></span> compile <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>: <span class="hljs-string"><span class="hljs-string">'org.springframework'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: <span class="hljs-string"><span class="hljs-string">'spring-core'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: spring_version compile <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>: <span class="hljs-string"><span class="hljs-string">'org.springframework'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: <span class="hljs-string"><span class="hljs-string">'spring-context'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: spring_version compile <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>: <span class="hljs-string"><span class="hljs-string">'org.springframework'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: <span class="hljs-string"><span class="hljs-string">'spring-jdbc'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: spring_version compile <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>: <span class="hljs-string"><span class="hljs-string">'org.springframework'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: <span class="hljs-string"><span class="hljs-string">'spring-tx'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: spring_version compile <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>: <span class="hljs-string"><span class="hljs-string">'io.javaslang'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: <span class="hljs-string"><span class="hljs-string">'javaslang'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-string"><span class="hljs-string">'2.0.5'</span></span> compile <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>: <span class="hljs-string"><span class="hljs-string">'com.github.menacher'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: <span class="hljs-string"><span class="hljs-string">'nadron'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-string"><span class="hljs-string">'0.7'</span></span> compile <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>: <span class="hljs-string"><span class="hljs-string">'org.json'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: <span class="hljs-string"><span class="hljs-string">'json'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-string"><span class="hljs-string">'20160810'</span></span> compile <span class="hljs-string"><span class="hljs-string">'com.mchange:c3p0:0.9.5.2'</span></span> compile <span class="hljs-string"><span class="hljs-string">'org.flywaydb:flyway-core:4.0.3'</span></span> runtime(<span class="hljs-string"><span class="hljs-string">"org.postgresql:postgresql:9.4.1212"</span></span>) testCompile <span class="hljs-string"><span class="hljs-string">'junit:junit:4.12'</span></span> }</code> </pre> <br></div></div><br>  Variable parameters with application keys, connection ports and data for accessing the database will be moved to a separate configuration file. <br><br><h4>  Authentication </h4><br>  Ready solutions in Nadron are simple: by default, the username, password and code of the room to which you want to connect are transferred for user authentication.  For our example, you need to redefine the login handler, in which we will transfer the user data to the VC and add automatic detection of all players in the lobby.  We will describe the main beans on the server in the class, and those that need to be redefined will have to be entered in the xml (they are not redefined from the class): <br><br><div class="spoiler">  <b class="spoiler_title">beans.xml</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">beans</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:context</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/context"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:schemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.2.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.2.xsd"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">import</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">resource</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"classpath:/nadron/beans/server-beans.xml"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">import</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">context:annotation-config</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"webSocketLoginHandler"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.bbl.app.handlers.GameLoginHandler"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"lookupService"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"lookupService"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"idGeneratorService"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"simpleUniqueIdGenerator"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"reconnectRegistry"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"reconnectSessionRegistry"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"jackson"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"jackson"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">beans</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  Next, we create a GameLoginHandler class and inherit it from the standard WebSocketLoginHandler implementation.  The framework has the ability to map user classes to deserialize json messages.  To do this, simply send the class name from the client like this: <br><br><pre> <code class="javascript hljs">session.send(nad.CNameEvent(<span class="hljs-string"><span class="hljs-string">"com.bbl.app.events.CustomEvent"</span></span>));</code> </pre> <br>  But for authorization, this is not suitable, because  a message with the data is sent immediately after connecting to the server.  Therefore, as a message for a login, we will pass an associative array; for this, in nad-0.1.js we will replace the method of creating a login message with: <br><br><pre> <code class="javascript hljs">nad.LoginEvent = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">config</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> nad.NEvent(nad.LOG_IN, config); }</code> </pre> <br>  Where the config object appears instead of the old data array to which you can add data in the future without changing the library.  It will look like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = { <span class="hljs-attr"><span class="hljs-attr">user</span></span>:<span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-attr"><span class="hljs-attr">pass</span></span>:<span class="hljs-string"><span class="hljs-string">"pass"</span></span>, <span class="hljs-attr"><span class="hljs-attr">uid</span></span>:<span class="hljs-string"><span class="hljs-string">"1234567"</span></span>, <span class="hljs-attr"><span class="hljs-attr">key</span></span>:<span class="hljs-string"><span class="hljs-string">"1234567"</span></span>, <span class="hljs-attr"><span class="hljs-attr">picture</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">sex</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, }; <span class="hljs-comment"><span class="hljs-comment">//       nad.sessionFactory("ws://localhost:18090/nadsocket", config, loginHandler); function loginHandler(session){ session.onmessage = messageHandler; session.send(nad.CNameEvent("com.bbl.app.events.CustomEvent")); } //   function messageHandler(e){ console.log(JSON.stringify(e.source)); }</span></span></code> </pre><br>  Handler implementation on server: <br><br><div class="spoiler">  <b class="spoiler_title">GameLoginHandler.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GameLoginHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WebSocketLoginHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOG = LoggerFactory.getLogger(GameLoginHandler.class); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">channelRead0</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChannelHandlerContext ctx, TextWebSocketFrame frame)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ Channel channel = ctx.channel(); String data = frame.text(); Event event = getJackson().readValue(data, DefaultEvent.class); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> type = event.getType(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Events.LOG_IN == type) { LOG.trace(<span class="hljs-string"><span class="hljs-string">"Login attempt from {}"</span></span>, channel.remoteAddress()); <span class="hljs-meta"><span class="hljs-meta">@SuppressWarnings</span></span>(<span class="hljs-string"><span class="hljs-string">"unchecked"</span></span>) Player player = lookupPlayer((LinkedHashMap&lt;String, Object&gt;) event.getSource()); handleLogin(player, channel); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> != player) handleGameRoomJoin(player, channel, MyGame.LOBBY_NAME); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type == Events.RECONNECT) { LOG.debug(<span class="hljs-string"><span class="hljs-string">"Reconnect attempt from {}"</span></span>, channel.remoteAddress()); PlayerSession playerSession = lookupSession((String) event.getSource()); handleReconnect(playerSession, channel); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { LOG.error(<span class="hljs-string"><span class="hljs-string">"Invalid event {} sent from remote address {}. "</span></span> + <span class="hljs-string"><span class="hljs-string">"Going to close channel {}"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object[] { event.getType(), channel.remoteAddress(), channel }); closeChannelWithLoginFailure(channel); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Player </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lookupPlayer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Map&lt;String, Object&gt; source)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String user = String.valueOf(source.get(<span class="hljs-string"><span class="hljs-string">"user"</span></span>)); String vkUid = String.valueOf(source.get(<span class="hljs-string"><span class="hljs-string">"uid"</span></span>)); String vkKey = String.valueOf(source.get(<span class="hljs-string"><span class="hljs-string">"key"</span></span>)); GameCredentials credentials = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GameCredentials(user, vkUid, vkKey); credentials.setPicture(String.valueOf(source.get(<span class="hljs-string"><span class="hljs-string">"picture"</span></span>))); credentials.setSex(Integer.valueOf(String.valueOf(source.get(<span class="hljs-string"><span class="hljs-string">"sex"</span></span>)))); credentials.setHash(String.valueOf(source.get(<span class="hljs-string"><span class="hljs-string">"hash"</span></span>))); Player player = getLookupService().playerLookup(credentials); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> == player) { LOG.error(<span class="hljs-string"><span class="hljs-string">"Invalid credentials provided by user: {}"</span></span>, credentials); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> player; } }</code> </pre> <br></div></div><br>  The cradle class is inherited from library credentials with the addition of everything we need.  Then we pass it to the LookupService to authorize or register an account and return the created instance of the player‚Äôs class.  The player class (in the example it is called GamePlayer) also needs to be inherited from the standard Player.  To verify the key soc.  Networks need to have a dongle and application id; they are most conveniently written to the game class.  The MyGame class is designed to load various data from the database or files needed for the game: maps, objects, etc. <br><br><div class="spoiler">  <b class="spoiler_title">GameLookupService.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GameLookupService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleLookupService</span></span></span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MyGame myGame; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> GameDao gameDao; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LobbyRoom lobby; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> GameManager gameManager; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Player </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">playerLookup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Credentials loginDetail)</span></span></span><span class="hljs-function"> </span></span>{ Optional&lt;GamePlayer&gt; player = Optional.empty(); GameCredentials credentials = (GameCredentials) loginDetail; String authKey = myGame.getAppId() + <span class="hljs-string"><span class="hljs-string">'_'</span></span> + credentials.getVkUid() + <span class="hljs-string"><span class="hljs-string">'_'</span></span> + myGame.getAppSecret(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//   if (Objects.equals(credentials.getVkKey().toUpperCase(), MD5.encode(authKey))) { player = gameDao.fetchPlayerByVk(credentials.getVkUid(), credentials.getVkKey()); if(!player.isPresent()){ //   player = Optional.of(cratePlayer((GameCredentials) loginDetail)); gameDao.createPlayer(player.get()); } } } catch (Exception e) { e.printStackTrace(); } return player.orElse(null); } private GamePlayer cratePlayer(GameCredentials loginDetail) { GamePlayer player = new GamePlayer(); player.setVkUid(loginDetail.getVkUid()); player.setVkKey(loginDetail.getVkKey()); player.setName(loginDetail.getUsername()); player.setPicture(loginDetail.getPicture()); player.setSex(loginDetail.getSex()); player.setRef(loginDetail.getHash()); player.setMail(""); player.setCreated(LocalDateTime.now()); player.setRating(0); player.setMoney(10); player.setClanId(0L); return player; } @Override public GameRoom gameRoomLookup(Object gameContextKey) { return lobby; } }</span></span></code> </pre> <br></div></div><br>  The lobby is one of the basic mechanics that is required in most games. <br>  Here, instead of a room using the key from the gameRoomLookup method, as in the official example, we always give a copy of LobbyRoom.  Thus, all connected players will automatically fall into this room. <br><br><h4>  Work with database </h4><br>  Let's just digress and consider the option of working with a database.  The Flyway library along with its plug-in allows you to automatically execute a sequence of sql files for the database, taking into account versioning, at startup.  This is suitable to describe the database structure once and forget about it in the future.  By default, the files should be located in the src / main / resources / db / migration folder of your project, and the files themselves should start with V [n] __ name.sql.  The user table creation file will look like this: <br><br><div class="spoiler">  <b class="spoiler_title">V1__create_game_tables.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> public.players ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> bigserial <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, mail <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>, vk_uid <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>, vk_key <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>, sex <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, money <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, rating <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, clan_id <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, created <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> zone <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> players_pkey PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> ( OIDS=<span class="hljs-literal"><span class="hljs-literal">FALSE</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> EXTENSION <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> citext; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> players <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> vk_uid <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span> citext;</code> </pre> <br></div></div><br>  For everything to work quickly, you need a pool of connections for the database, - for this we have a c3p0 library with ready caching of requests.  Above in GameLookupService, the base is already used to search for player data or to create it. <br><br><h4>  Developments </h4><br>  So, we logged in and got to the room where now you need to send something to the client.  For convenience, we will define our CustomEvent event class, which will help us receive and send any commands without overlapping the framework's basic logic. <br><br><div class="spoiler">  <b class="spoiler_title">CustomEvent.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SuppressWarnings</span></span>(<span class="hljs-string"><span class="hljs-string">"serial"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomEvent</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultEvent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> EventData source; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> EventData </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> source; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(EventData source)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.source = source; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> NetworkEvent </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">networkEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GameCmd cmd, Object data)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> JSONException </span></span>{ EventData source = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EventData(); source.setCmd(cmd.getCode()); source.setData(data); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Events.networkEvent(source); } }</code> </pre> <br></div></div><br><h4>  Lobby and command handling </h4><br>  Implementing the lobby is probably not such an easy task (at least there is a <a href="https://groups.google.com/forum/">question</a> on the official forum).  In our example, the lobby is a regular room with its own state (state) and in a single copy for the game.  When entering the lobby, we send all player data.  To make it clear, I will provide the code for the entire class: <br><br><div class="spoiler">  <b class="spoiler_title">LobbyRoom.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LobbyRoom</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GameRoomSession</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOG = LoggerFactory.getLogger(LobbyRoom.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> RoomFactory roomFactory; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LobbyRoom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GameRoomSessionBuilder gameRoomSessionBuilder)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(gameRoomSessionBuilder); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.addHandler(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LobbySessionHandler(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); getStateManager().setState(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LobbyState()); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onLogin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PlayerSession playerSession)</span></span></span><span class="hljs-function"> </span></span>{ LOG.info(<span class="hljs-string"><span class="hljs-string">"sessions size: "</span></span> + getSessions().size()); playerSession.addHandler(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PlayerSessionHandler(playerSession)); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { playerSession.onEvent(CustomEvent.networkEvent(GameCmd.PLAYER_DATA, playerSession.getPlayer())); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (JSONException e) { LOG.error(e.getMessage()); e.printStackTrace(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RoomFactory </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRoomFactory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> roomFactory; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setRoomFactory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RoomFactory roomFactory)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.roomFactory = roomFactory; } }</code> </pre> <br></div></div><br>  In Nadron, there are two types of handlers: one for the player‚Äôs session, the second for processing the commands of the room itself. <br><br>  In order to process incoming commands from the client in the room, you need to send events from the player's session handler.  The new method will look like this: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDataIn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Event event)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> != event.getSource()) { event.setEventContext(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultEventContext(playerSession, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)); playerSession.getGameRoom().send(event); } }</code> </pre><br>  Thus, the events will go to the current room in which the player is located.  The onEvent method will process them, below is an example of such processing.  Note that in the absence of a command, we throw a special InvalidCommandException exception.  <a href="https://groups.google.com/forum/">All rooms will execute commands sequentially, but the best practice will be to clone objects</a> . <br><br><div class="spoiler">  <b class="spoiler_title">LobbySessionHandler.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Event event)</span></span></span><span class="hljs-function"> </span></span>{ CustomEvent customEvent = (CustomEvent) event; GameCmd cmd = GameCmd.CommandsEnum.fromInt(customEvent.getSource().getCmd()); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (cmd) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CREATE_GAME: createRoom(customEvent); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> GET_OPEN_ROOMS: broadcastRoomList(customEvent); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> JOIN_ROOM: connectToRoom(customEvent); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: LOG.error(<span class="hljs-string"><span class="hljs-string">"Received invalid command {}"</span></span>, cmd); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidCommandException(<span class="hljs-string"><span class="hljs-string">"Received invalid command"</span></span> + cmd); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InvalidCommandException e) { e.printStackTrace(); LOG.error(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, e); } }</code> </pre> <br></div></div><br><h4>  Game rooms </h4><br>  Of all the questions, one important one remained - the creation of a new room and the transfer of players into it.  The problem is that you cannot go to a room with the same protocol, otherwise the protocols overlap each other.  To correct this mistake, you need to add a check for the existence of handlers: <br><br><div class="spoiler">  <b class="spoiler_title">GameWebsocketProtocol.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GameWebsocketProtocol</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractNettyProtocol</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOG = LoggerFactory.getLogger(WebSocketProtocol.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String TEXT_WEBSOCKET_DECODER = <span class="hljs-string"><span class="hljs-string">"textWebsocketDecoder"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String TEXT_WEBSOCKET_ENCODER = <span class="hljs-string"><span class="hljs-string">"textWebsocketEncoder"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String EVENT_HANDLER = <span class="hljs-string"><span class="hljs-string">"eventHandler"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TextWebsocketDecoder textWebsocketDecoder; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TextWebsocketEncoder textWebsocketEncoder; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GameWebsocketProtocol</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(<span class="hljs-string"><span class="hljs-string">"GAME_WEB_SOCKET_PROTOCOL"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyProtocol</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PlayerSession playerSession, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> clearExistingProtocolHandlers)</span></span></span><span class="hljs-function"> </span></span>{ applyProtocol(playerSession); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (clearExistingProtocolHandlers) { ChannelPipeline pipeline = NettyUtils.getPipeLineOfConnection(playerSession); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pipeline.get(LoginProtocol.LOGIN_HANDLER_NAME) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) pipeline.remove(LoginProtocol.LOGIN_HANDLER_NAME); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pipeline.get(AbstractNettyProtocol.IDLE_STATE_CHECK_HANDLER) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) pipeline.remove(AbstractNettyProtocol.IDLE_STATE_CHECK_HANDLER); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyProtocol</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PlayerSession playerSession)</span></span></span><span class="hljs-function"> </span></span>{ LOG.trace(<span class="hljs-string"><span class="hljs-string">"Going to apply {} on session: {}"</span></span>, getProtocolName(), playerSession); ChannelPipeline pipeline = NettyUtils.getPipeLineOfConnection(playerSession); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pipeline.get(TEXT_WEBSOCKET_DECODER) == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) pipeline.addLast(TEXT_WEBSOCKET_DECODER, textWebsocketDecoder); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pipeline.get(EVENT_HANDLER) == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) pipeline.addLast(EVENT_HANDLER, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultToServerHandler(playerSession)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pipeline.get(TEXT_WEBSOCKET_ENCODER) == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) pipeline.addLast(TEXT_WEBSOCKET_ENCODER, textWebsocketEncoder); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> TextWebsocketDecoder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTextWebsocketDecoder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> textWebsocketDecoder; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setTextWebsocketDecoder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TextWebsocketDecoder textWebsocketDecoder)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.textWebsocketDecoder = textWebsocketDecoder; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> TextWebsocketEncoder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTextWebsocketEncoder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> textWebsocketEncoder; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setTextWebsocketEncoder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TextWebsocketEncoder textWebsocketEncoder)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.textWebsocketEncoder = textWebsocketEncoder; } }</code> </pre> <br></div></div><br>  The very same disconnection from the current room and connecting to another will look like this: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeRoom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PlayerSession playerSession, GameRoom room)</span></span></span><span class="hljs-function"> </span></span>{ playerSession.getGameRoom().disconnectSession(playerSession); room.connectSession(playerSession); }</code> </pre> <br>  This is all I wanted to talk about.  The full code can be found in <a href="https://github.com/taluks/nadron-game-server">github</a> . </div><p>Source: <a href="https://habr.com/ru/post/354292/">https://habr.com/ru/post/354292/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354280/index.html">Javascript es6: write less - do more</a></li>
<li><a href="../354282/index.html">Configure BGP to bypass locks, or ‚ÄúHow I stopped being afraid and fell in love with the RKN‚Äù</a></li>
<li><a href="../354284/index.html">Basics of programming on the SAS Base. Lesson 3. Reading text files</a></li>
<li><a href="../354286/index.html">ESET: Lazarus Cyber ‚Äã‚ÄãGroup Switches to Central America</a></li>
<li><a href="../354290/index.html">Summ3r 0f h4ck: Digital Security Internship 2018</a></li>
<li><a href="../354294/index.html">PYCON RUSSIA 2018 will be held July 22-23. Save the date</a></li>
<li><a href="../354296/index.html">We charge super power Appium tests on Android</a></li>
<li><a href="../354302/index.html">Veeam Backup & Replication: 10 Tips for Beginners</a></li>
<li><a href="../354304/index.html">Operation Orangeworm: hackers infect medical equipment around the world using the Kwampirs Trojan</a></li>
<li><a href="../354310/index.html">Forms on the site - a spammer reluctantly</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>