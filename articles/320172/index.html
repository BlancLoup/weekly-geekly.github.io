<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JSON API My Warehouse, self-learning</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There is such a way of self-learning - as the implementation of test tasks. Its advantage is that the volume of the task is finite, the time limits ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JSON API My Warehouse, self-learning</h1><div class="post__text post__text-html js-mediator-article">  There is such a way of self-learning - as the implementation of test tasks.  Its advantage is that the volume of the task is finite, the time limits are limited.  It does not allow you to stretch the tires to infinity or selflessly draw the twists and curls of architectural delights. <br><br>  A nice bonus of this skill training is to get acquainted with new technologies and business processes, which among other things are in demand in real-world tasks. <br><br>  This time it was necessary to make a page for the formation of the order of the buyer in the service "My warehouse".  For me, this is like a flight to the moon: in web development I‚Äôm a little less than a newbie, I know the front-end only by hearsay, and here you need to develop a whole page, oh, you Jojik! <br>  Any criticism and advice are welcome. <br><a name="habracut"></a><br>  There are a lot of curses in comments, my decision is so awful that for him they did refactoring into something decent: <br>  <a href="https://habrahabr.ru/users/michael_vostrikov/" class="user_link">michael_vostrikov</a> <br><blockquote>  From nothing to do, I did a little refactoring of this task (although there is a lot more that can be changed), not so much for you, as for those who later find this article in the search: <br>  <a href="https://github.com/michael-vostrikov/moysklad_test/commits/class">commits</a> , <a href="https://github.com/michael-vostrikov/moysklad_test/blob/0b817f5a660761f0241b711670b90a64bff9bb85/moysklad_customer_order.php">markup</a> , <a href="https://github.com/michael-vostrikov/moysklad_test/blob/2dc49649cd78a4fa785a883a191a641c7c17c525/moysklad_customer_order.php">form submission</a> . </blockquote><br><h2>  Go! </h2><br>  First of all, of course google, only the <a href="https://online.moysklad.ru/api/remap/1.1/doc/index.html">link to the documentation</a> , tutorials, examples - zero. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Still googled: ‚ÄúJSON API is available for subscribers on all rates, except Free‚Äù Wooops!  Of course, no one gave me a paid one, I didn‚Äôt buy it, but I thought that if they gave such a task, then probably on Free it is functioning there and continued to work. <br><br>  And of course, ‚Äúmoysklad-client ‚Äî npm ‚Äî a JavaScript client for comfortable work with the API of the MySklad service,‚Äù but with JS exclusively on ‚ÄúYou‚Äù, and according to the terms of the task, you need to write in PHP.  So even did not understand what can be done there on JS. <br><br><h2>  The first </h2><br>  The first thing to do is to get acquainted with the documentation.  I got acquainted. <br>  The second is to make a plan.  Made up. <br>  Plan, start. <br>  The first step is authorization. <br>  The second step is to show the Nomenclature list. <br>  The third step is to add a buyer's order. <br>  The fourth action is to add Positions to the Buyer's Order. <br>  The goal is reached, the end of the plan. <br><br><h2>  Authorization </h2><br>  I saw the code in which cUrl was used to communicate with the API.  I don‚Äôt know what cUrl is, I don‚Äôt know how to communicate with the API, but if there is code that can be copied, then its suitability is not difficult.  I copied pasted, processed with a file - it turned out. <br><br>  I will not bore you with intimate details about the friendship of a file with copy-paste, here's the working code: <br><br><pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupCurl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($apiSettings)</span></span></span><span class="hljs-function"> </span></span>{ $curl = curl_init(); curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); curl_setopt($curl, CURLOPT_RETURNTRANSFER, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); curl_setopt($curl, CURLOPT_FOLLOWLOCATION, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); $userName = $apiSettings[MOYSKLAD_USERNAME]; $userPassword = $apiSettings[MOYSKLAD_PASSWORD]; curl_setopt($curl, CURLOPT_USERPWD, <span class="hljs-string"><span class="hljs-string">"$userName:$userPassword"</span></span>); curl_setopt($curl, CURLOPT_USERAGENT, $apiSettings[MOYSKLAD_USER_AGENT]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $curl; }</code> </pre> <br>  Curl options: <br><br><ul><li>  RETURNTRANSFER - not only send a request, but also record the answer; </li><li>  USERPWD - authentication details; </li></ul><br>  The remaining options do not know why we need stupid copy-paste. <br>  It‚Äôs not a fact that authorization headers should be sent in every request, although it‚Äôs not a fact that they were not reset after the first sending ... who can tell? <br><br>  So that was the initialization of the curl object for messaging with the API server. <br><br>  Using: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">curlExec</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($curlObject)</span></span></span><span class="hljs-function"> </span></span>{ $response = curl_exec($curlObject); $curlErrorNumber = curl_errno($curlObject); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($curlErrorNumber) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(curl_error($curlObject)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $response; }</code> </pre><br>  Pure copy-paste, don't ask me why. <br><br><h2>  Show the list of Nomenclature </h2><br>  Some items were not enough, for the order of the buyer, you must specify the legal entity of the supplier and the counterparty of the buyer.  The owner of the My Warehouse account may have several legal entities, counterparties - 100500 is clearly understandable, but the specific order of the buyer is the order of a specific Counterparty to a specific Legal entity. <br><br>  Therefore, with the nomenclatures we pitch, we will deal with the parties to the "contract" - the deal. <br><br>  Legal entities <br><br><pre> <code class="php hljs">$curl = setCurl( $curl, $apiSettings[MOYSKLAD_API_URL] . $apiSettings[MOYSKLAD_GET_JURIDICAL_PERSON], $apiSettings[MOYSKLAD_GET_JURIDICAL_PERSON_METHOD]); $persons = getJuridicalPerson($curl); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setCurl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;$curlObject, $uri, $method)</span></span></span><span class="hljs-function"> </span></span>{ curl_setopt($curlObject, CURLOPT_URL, $uri); curl_setopt($curlObject, CURLOPT_HTTPGET, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> ($method) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MOYSKLAD_METHOD_GET: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MOYSKLAD_METHOD_POST: curl_setopt($curlObject, CURLOPT_POST, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MOYSKLAD_METHOD_PUT: curl_setopt($curlObject, CURLOPT_PUT, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $curlObject; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getJuridicalPerson</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($curlObject)</span></span></span><span class="hljs-function"> </span></span>{ $response = curlExec($curlObject); $data = json_decode($response, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $result = $data[<span class="hljs-string"><span class="hljs-string">'rows'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $result; }</code> </pre><br>  I apologize for the terrible names of the constants, but I‚Äôm not going to confuse with such calm, as if with nothing.  Yes, I know that case (switch) has a default branch, but it‚Äôs easier for me to embed the default value in the code and not to hope for the opposite of fate with the case. <br><br>  Each API command has its own address and its own method, setCurl - sets the address and method. <br><br>  To get the list of legal entities, we set the appropriate address and method (the address and method are set in the settings, the settings are loaded by the function method getSettings () {$ apiConfig = include ('moysklad_curl_details.php'); return $ apiConfig;}). <br><br>  After that, we use the getJuridicalPerson method to execute curl, get the response in JSON, and only take the 'rows' array from the response.  Received, saved, postponed. <br><br>  We are doing the same with Counterparties: setCurl =&gt; getCounterparty, Nomenclature using the same algorithm: setCurl =&gt; getNomenclature. <br><br>  If it was not a test for two evenings after work, but for two days of an unemployed specialist, then it would be possible to automate it, but it was a test in the style - ‚Äúif only it worked,‚Äù so I didn‚Äôt bother. <br><br>  For me, the purpose of the test was to sip and taste the JSON API, draw beauty - there was no goal. <br><br>  The data received is not a question at all, it is a stupid thing - it is not a tricky business, it was more interesting to take it to a page and then pick it up from a page, that was a problem. <br><br><h2>  Frontend </h2><br>  I do not know how correctly, I did this: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;form action="#" onsubmit="return false;" id="orderForm" &gt;&lt;p&gt;  :&lt;br /&gt;'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($persons <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $person) { $personId = $person[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;label for="'</span></span> . $personId . <span class="hljs-string"><span class="hljs-string">'"&gt;'</span></span> . $person[<span class="hljs-string"><span class="hljs-string">'name'</span></span>] . <span class="hljs-string"><span class="hljs-string">'&lt;/label&gt;&lt;input type="radio" data-organization-type="1" id="'</span></span> . $personId . <span class="hljs-string"><span class="hljs-string">'" name="organization"&gt;&lt;br /&gt;'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">' :&lt;br /&gt;'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($counterparty <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $person) { $personId = $person[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;label for="'</span></span> . $personId . <span class="hljs-string"><span class="hljs-string">'"&gt;'</span></span> . $person[<span class="hljs-string"><span class="hljs-string">'name'</span></span>] . <span class="hljs-string"><span class="hljs-string">'&lt;/label&gt;&lt;input type="radio" data-counterparty-type="1" id="'</span></span> . $personId . <span class="hljs-string"><span class="hljs-string">'" name="counterparty"&gt;&lt;br /&gt;'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">' :&lt;br /&gt;'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($nomenclature <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $position) { $positionId = $position[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;label for="'</span></span> . $positionId . <span class="hljs-string"><span class="hljs-string">'"&gt;'</span></span> . $position[<span class="hljs-string"><span class="hljs-string">'name'</span></span>] . <span class="hljs-string"><span class="hljs-string">',    =&gt; &lt;/label&gt;&lt;input type="text" id="'</span></span> . $positionId . <span class="hljs-string"><span class="hljs-string">'" data-position-type="1"&gt;&lt;br /&gt;'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">' &lt;input type="submit" name="  " onclick="sendOrder();"&gt;&lt;br /&gt;&lt;/p&gt;&lt;/form&gt;'</span></span></code> </pre><br>  General algorithm: <br><br><ol><li>  write the name of the section </li><li>  write the name of the position </li><li>  write the input tag, in the id attribute we write the identifier obtained from the API, </li><li>  we write the corresponding attribute data-organization-type / data-counterparty-type / data-position-type, because to get the attribute you need to assign a value, then assign it </li></ol><br>  (in general, of course, you can use attributes without values, but I did not figure out how). <br><br>  By clicking on the button ‚ÄúGenerate customer order‚Äù, the form is not sent - ‚Äúreturn false;‚Äù, but the function is called - ‚ÄúsendOrder ();‚Äù. <br><br><h2>  send an order </h2><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">' &lt;script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"&gt;&lt;/script&gt; &lt;script type="text/javascript"&gt; function sendOrder(){ var $text_field = $('</span></span><span class="hljs-comment"><span class="hljs-comment">#orderForm :input:text'); var position = {}; $text_field.each(function() { var this_val = $(this).val(); var may_assign = this_val&gt;0 || this_val !=""; var is_it_position = $(this).data('position-type'); if ( may_assign &amp;&amp; is_it_position &gt; 0){ position[this.id] = this_val; } }); var $radio_field = $('#orderForm :input:radio:checked'); var counterparty = {}; var organization = {}; $radio_field.each(function() { var this_val = $(this).val(); var is_it_counterparty = $(this).data('counterparty-type'); var is_it_organization = $(this).data('organization-type'); var may_assign = this_val&gt;0 || this_val !=""; if ( may_assign &amp;&amp; is_it_counterparty &gt; 0){ counterparty[this.id] = this_val; } if ( may_assign &amp;&amp; is_it_organization &gt; 0){ organization[this.id] = this_val; } });</span></span></code> </pre><br>  C JS seems to me more than transparent: <br><br><ol><li>  $ ('# orderForm: input: text');  - selected all input tags with the text type inside the tag with the orderForm identifier </li><li>  $ text_field.each - for each element we perform an anonymous function </li><li>  var this_val = $ (this) .val ();  - retained value </li><li>  var may_assign = this_val&gt; 0 ||  this_val! = "";  - calculated that the value is not empty </li><li>  var is_it_position = $ (this) .data ('position-type');  - calculated that the data-position-type attribute is set </li><li>  if (may_assign &amp;&amp; is_it_position&gt; 0) {position [this.id] = this_val;  } - if the value is not empty and this input corresponds to the position, then we add the corresponding element to the position array, the identifier as an index guarantees uniqueness. </li></ol><br>  We perform the same acrobatics with legal entities and counter agents, with the difference that for the analysis we select all inputs with the type ‚Äúradio‚Äù in the ‚Äúchecked‚Äù state: <br><br>  $ ('# orderForm: input: radio: checked'), and besides, we don‚Äôt need the value of the input element, we just need to know who (one) from the entire list was selected by our Buyer. <br><br>  Now that the data to be sent to processing is ready, you need to create a request: <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> postData = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify({<span class="hljs-attr"><span class="hljs-attr">position</span></span> : position, <span class="hljs-attr"><span class="hljs-attr">counterparty</span></span> : counterparty , <span class="hljs-attr"><span class="hljs-attr">organization</span></span> : organization}); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(postData); $.ajax({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">"moyskald_add_order.php"</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: postData, <span class="hljs-attr"><span class="hljs-attr">contentType</span></span>: <span class="hljs-string"><span class="hljs-string">"application/json; charset=utf-8"</span></span>, <span class="hljs-attr"><span class="hljs-attr">dataType</span></span>: <span class="hljs-string"><span class="hljs-string">"text"</span></span>, <span class="hljs-attr"><span class="hljs-attr">timeout</span></span>: <span class="hljs-number"><span class="hljs-number">10000</span></span>, <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ alert(<span class="hljs-string"><span class="hljs-string">"  "</span></span>); }, <span class="hljs-attr"><span class="hljs-attr">success</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">)</span></span>{alert(data);}, <span class="hljs-attr"><span class="hljs-attr">failure</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">errMsg</span></span></span><span class="hljs-function">) </span></span>{ alert(errMsg); } });</code> </pre><br>  I have nothing to add to this copy-paste, the sending method is ‚ÄúPOST‚Äù, the processing will be executed - ‚Äúmoyskald_add_order.php‚Äù, the data is sent in the format - ‚Äúapplication / json;  charset = utf-8 ", come in a format -" text ". <br><br>  The data is not needed at all, although of course it is a good tone to inform the user ‚ÄúYour order is accepted‚Äù or ‚ÄúFailed to add an order‚Äù, and ok. <br><br>  We go further, the next point of arrival - "Processing". <br><br><h2>  Treatment </h2><br>  There was a misfire with the treatment.  I am a lamer enikeyschik and for development I use XAMPP (under Win10), which I once set up and forgot.  And here something is configured there, that I get GET requests to the PHP script as a normal person, and POST requests, only through one place. <br><br>  But GET is not Camille, because GET is cached, and it‚Äôs not the fact that the server‚Äôs response will be exactly the same as last time, especially when you are developing, and the server logic changes every five minutes. <br><br>  Therefore, we had to accept the use of black magic in the form of file_get_contents ("php: // input"), because, whatever I did, but var_export ($ POST) consistently produced "array ()".  By the way, I will be grateful for a series of kicks in the right direction. <br><br>  And then everything is simple: <br><br><pre> <code class="php hljs">$data = json_decode($rawData, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $rawPosition = $data[<span class="hljs-string"><span class="hljs-string">'position'</span></span>]; $rawCounterparty = $data[<span class="hljs-string"><span class="hljs-string">'counterparty'</span></span>]; $rawOrganization = $data[<span class="hljs-string"><span class="hljs-string">'organization'</span></span>];</code> </pre><br>  Disassembled input data. <br><br>  Legal entity and contractor pulled: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FIRST_INDEX = <span class="hljs-number"><span class="hljs-number">0</span></span>; $counterpartyId = $counterpartyIdCollection[FIRST_INDEX]; $organizationId = $organizationIdCollection[FIRST_INDEX];</code> </pre><br>  Formed query fields: <br><br><pre> <code class="php hljs">$textAddCustomerOrder = <span class="hljs-string"><span class="hljs-string">' { "name": "'</span></span> . time() . <span class="hljs-string"><span class="hljs-string">'", "organization": { "meta": { "href": "https://online.moysklad.ru/api/remap/1.1/entity/organization/'</span></span> . $organizationId . <span class="hljs-string"><span class="hljs-string">'", "type": "organization", "mediaType": "application/json" } }, "agent": { "meta": { "href": "https://online.moysklad.ru/api/remap/1.1/entity/counterparty/'</span></span> . $counterpartyId . <span class="hljs-string"><span class="hljs-string">'", "type": "counterparty", "mediaType": "application/json" } } } '</span></span>; $apiSettings = getSettings(); $curl = setupCurl($apiSettings); $curl = setCurl( $curl, $apiSettings[MOYSKLAD_API_URL] . $apiSettings[MOYSKLAD_ADD_CUSTOMER_ORDER], $apiSettings[MOYSKLAD_ADD_CUSTOMER_ORDER_METHOD]); curl_setopt($curl, CURLOPT_POSTFIELDS, $textAddCustomerOrder); curl_setopt($curl, CURLOPT_HTTPHEADER, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'Content-Type: application/json'</span></span>, <span class="hljs-string"><span class="hljs-string">'Content-Length: '</span></span> . strlen($textAddCustomerOrder)) );</code> </pre><br>  Then it turned out to shuffle and fill in JSON without json_encode, stupidly paste the necessary identifier into the right places.  Be sure to do POSTFIELDS - $ textAddCustomerOrder, HTTPHEADER - 'Content-Length:'.  strlen ($ textAddCustomerOrder). <br><br>  send a request for processing to the API server: $ customerOrderId = setCustomerOrder ($ curl), in the response we take away 'id'. <br><br>  Order has been added. <br><br><h2>  Add Items to Buyer‚Äôs Order </h2><br>  With this item of the Plan, there are no problems, except the need to use json_encode to format the request text and floatval for the amount of goods in the position.  Without floatval, the API server generates a format error for the ‚Äúquantity‚Äù field (and ‚Äúreserve‚Äù, respectively). <br><br><pre> <code class="php hljs">$isPositionArray = is_array($rawPosition); $orderPositions= <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($isPositionArray) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($rawPosition <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $id =&gt; $quantity) { $positionQuantity=floatval($quantity); $orderPositions[] = [ <span class="hljs-string"><span class="hljs-string">"quantity"</span></span> =&gt;$positionQuantity, <span class="hljs-string"><span class="hljs-string">"price"</span></span>=&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"discount"</span></span>=&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"vat"</span></span>=&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"assortment"</span></span> =&gt;[ <span class="hljs-string"><span class="hljs-string">"meta"</span></span>=&gt;[ <span class="hljs-string"><span class="hljs-string">"href"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"https://online.moysklad.ru/api/remap/1.1/entity/product/$id"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"product"</span></span>, <span class="hljs-string"><span class="hljs-string">"mediaType"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"application/json"</span></span> ] ], <span class="hljs-string"><span class="hljs-string">"reserve"</span></span>=&gt;$positionQuantity, ]; } }</code> </pre><br>  Remark: foreach ($ rawPosition as $ id =&gt; $ quantity), in the keys of the array there are position identifiers, in the values ‚Äã‚Äãof the array elements - the quantity for the order. <br><br>  My feng shui requires creating each array separately and adding all the "elementary" arrays to the general heap, but ... I think it will be excessive fanaticism. <br><br>  I'm not sure that a reserve should be set up in the buyer's order, but I think this is more a business requirement than the mechanics of working with the API. <br><br>  With the price it was ridiculous, the task required to display a list of nomenclatures, for me it‚Äôs just a list of items and corresponding TTX, in which the price is not included, but if you think about it, the price is the very first TTX in such an application, but I have no price on the order form , therefore - passed. <br><br>  With the sending of the API request, now everything seems to me very clear: <br><br><pre> <code class="php hljs">$jsonResponse = <span class="hljs-string"><span class="hljs-string">'empty'</span></span>; $isContainPosition = count($orderPositions)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($isContainPosition ){ $jsonOrderPositions= json_encode($orderPositions); $curl = setupCurl($apiSettings); $curl = setCurl( $curl, $apiSettings[MOYSKLAD_API_URL] . $apiSettings[MOYSKLAD_ADD_ORDER_POSITION_PREFIX] . $customerOrderId . $apiSettings[MOYSKLAD_ADD_ORDER_POSITION_SUFFIX], $apiSettings[MOYSKLAD_ADD_ORDER_POSITION_METHOD]); curl_setopt($curl, CURLOPT_POSTFIELDS, $jsonOrderPositions); curl_setopt($curl, CURLOPT_HTTPHEADER, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'Content-Type: application/json'</span></span>, <span class="hljs-string"><span class="hljs-string">'Content-Length: '</span></span> . strlen($jsonOrderPositions)) ); $jsonResponse = setCustomerOrderPosition($curl); }</code> </pre><br>  The address command of the request is ‚Äúcalculated‚Äù in a somewhat strange way: <br><pre> <code class="php hljs">$apiSettings[MOYSKLAD_API_URL] . $apiSettings[MOYSKLAD_ADD_ORDER_POSITION_PREFIX] . $customerOrderId . $apiSettings[MOYSKLAD_ADD_ORDER_POSITION_SUFFIX]</code> </pre><br>  The documentation should be: "/ entity / customerorder / {id} / positions". <br><br>  Even a native PHP line type, take it straight and write - {id} to substitute itself, but I can‚Äôt allow a hardcode to write an API command, of course, there is no command that the command will not change at the time of writing the test, but Feng Shui requires you to put such global things into constants Amen.  Although when I look at the sources of all open source frameworks, I see that the hardcode is pretty much there, but they do it, and I do it, and I don‚Äôt. <br><br><h2>  Epilogue </h2><br>  That's all.  The API, at the Free Rate, handles requests last, so sometimes a timeout of 10 seconds is not enough.  The rest is stable.  I checked. <br>  But our goal, of course, was not the case; as a result of the assignment, we learned how to work with the JSON Web API and learned how to muddle the front-end with the output of information in the form and passing the user input for processing to the server script. <br>  Hooray :) <br><br><h2>  PostScriptum </h2><br>  Before writing the article, I went a little more closely on the topic ‚Äúphp json api my warehouse‚Äù and found a lot of implementations, but not for JSON, but for XML.  Of the dozen found, the couple looks like a real worker, but this is not relevant because the XML API is threatened to be disabled from March 31, 2017. <br><br>  Or maybe everything will be the same as with ‚ÄúJSON API is available for subscribers on all tariffs, except Free‚Äù. <br><br>  Constructive criticism and links to best practics WELCOME!  I'm not ashamed to be a collective farmer, but it would not be nice if it is better? <br><br><h3>  Links </h3><br><ol><li>  <a href="">Git</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/320172/">https://habr.com/ru/post/320172/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320158/index.html">Areas of flexibility</a></li>
<li><a href="../320160/index.html">Vulnerable Highways and Energy Infrastructure: Recent Major Failures</a></li>
<li><a href="../320164/index.html">Caution: HSTS</a></li>
<li><a href="../320166/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ246 (January 16 - 22, 2017)</a></li>
<li><a href="../320168/index.html">Depth: how to make a quality project without millions in your pocket and why you shouldn‚Äôt be afraid of ‚Äúlong-term construction projects‚Äù</a></li>
<li><a href="../320174/index.html">Local python typographer - typus Œ≤</a></li>
<li><a href="../320176/index.html">Bitcoin in a nutshell - Blockchain</a></li>
<li><a href="../320178/index.html">Bitcoin in a nutshell - Mining</a></li>
<li><a href="../320180/index.html">JDK 9 development has completed the ‚ÄúFeature Complete‚Äù phase</a></li>
<li><a href="../320184/index.html">Automatic visualization of python code using flowcharts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>