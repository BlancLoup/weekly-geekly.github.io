<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating audio plugin, part 14</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All posts series: 
 Part 1. Introduction and setup 
 Part 2. Learning Code 
 Part 3. VST and AU 
 Part 4. Digital Distortion 
 Part 5. Presets and GUI...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating audio plugin, part 14</h1><div class="post__text post__text-html js-mediator-article">  All posts series: <br>  <a href="http://habrahabr.ru/post/224911/">Part 1. Introduction and setup</a> <br>  <a href="http://habrahabr.ru/post/225019/">Part 2. Learning Code</a> <br>  <a href="http://habrahabr.ru/post/225457/">Part 3. VST and AU</a> <br>  <a href="http://habrahabr.ru/post/225751/">Part 4. Digital Distortion</a> <br>  <a href="http://habrahabr.ru/post/225755/">Part 5. Presets and GUI</a> <br>  <a href="http://habrahabr.ru/post/226439/">Part 6. Signal synthesis</a> <br>  <a href="http://habrahabr.ru/post/226573/">Part 7. Receive MIDI Messages</a> <br>  <a href="http://habrahabr.ru/post/226823/">Part 8. Virtual Keyboard</a> <br>  <a href="http://habrahabr.ru/post/227475/">Part 9. Envelopes</a> <br>  <a href="http://habrahabr.ru/post/227601/">Part 10. Refinement GUI</a> <br>  <a href="http://habrahabr.ru/post/227791/">Part 11. Filter</a> <br>  <a href="http://habrahabr.ru/post/227827/">Part 12. Low-frequency oscillator</a> <br>  <a href="http://habrahabr.ru/post/228267/">Part 13. Redesign</a> <br>  <a href="http://habrahabr.ru/post/231513/">Part 14. Polyphony 1</a> <br>  <a href="http://habrahabr.ru/post/231923/">Part 15. Polyphony 2</a> <br>  <a href="http://habrahabr.ru/post/232153/">Part 16. Antialiasing</a> <br><hr><br><br>  Let's start creating a polyphonic synthesizer from those components that we have! <br><br>  Last time we worked on the parameters and the user interface, today we will begin work on the underlying <a href="https://en.wikipedia.org/wiki/Polyphony_and_monophony_in_instruments">polyphonic</a> audio processing plug-in.  In our case, we can play up to 64 notes at the same time.  This requires a solid change in the structure of the plugin, but we can use the <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> and <code>Filter</code> classes we have already written. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this post we will write the <code>Voice</code> class, representing one sounding note.  Then we will create a <code>VoiceManager</code> class, ensuring that all notes are sounded and drowned out on time. <br>  In the next post, we will clean the code of unnecessary obsolete parts, add tone modulation and bring the interface controls into working condition.  At first glance, the work is complete.  But firstly, we already have almost all the necessary components, and secondly, at the end we will have a real-polyphonic-subtractive-pancake-synthesizer! <br><br><a name="habracut"></a><br><br><h3>  What where? </h3><br><br>  Let us think for a moment about which parts of the plug-in's architecture are global, and which parts exist separately for each individual note.  Imagine, here you are playing a few notes on the keys.  Each time you press a key, a tone appears that fades out and, perhaps, the timbre of which is changed by a filter along a certain envelope.  When you press the second key, the first one still sounds, and the second tone appears with its amplitude and filter envelopes.  The second press does not affect the first tone, it sounds and changes <i>by itself</i> .  So each voice is independent and has its own amplitude and filter envelopes. <br>  The LFO is global and unique, it just works and does not restart when you press the keys. <br>  As for the filter, it is clear that the cut-off frequency and resonance are global, because all voices look at the same cut-off and resonance knobs in the GUI.  But the cutoff frequency of the filter is modulated by the envelope, so that at each moment in time the calculated cutoff frequency for each voice is different.  Take a look at <code>Filter::cutoff</code> - <code>Filter::cutoff</code> is called in it.  So each voice needs its own filter. <br>  Can we do with two oscillators for all voices?  Each <code>Voice</code> plays its own note, i.e.  he has his own frequency, which means his own independent <code>Oscillator</code> . <br><br>  In short, the structure is as follows: <br><br><ul><li>  There is one <code>MIDIReceiver</code> and one <code>VoiceManager</code> </li><li>  <code>VoiceManager</code> has one <code>LFO</code> and many <code>Voice</code> </li><li>  <code>Voice</code> has two <code>Oscillator</code> , two envelope Generators (for amplitude and filter) and one <code>Filter</code> </li></ul><br><br><h3>  Voice class </h3><br><br>  As usual, create a new class, name it <code>Voice</code> .  And, as usual, do not forget to add it to all Xcode targets and all VS projects.  In <i>Voice.h</i> add: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Oscillator.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"EnvelopeGenerator.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Filter.h"</span></span></span></span></code> </pre><br><br>  In the class body, we start with the <code>private</code> section: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: Oscillator mOscillatorOne; Oscillator mOscillatorTwo; EnvelopeGenerator mVolumeEnvelope; EnvelopeGenerator mFilterEnvelope; Filter mFilter;</code> </pre><br><br>  Nothing new here: each voice has two oscillators, a filter and two envelopes. <br>  Each voice starts with a specific MIDI note and volume.  Add there too: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mNoteNumber; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mVelocity;</code> </pre><br><br>  Each of the following variables specifies the magnitude of the modulation parameters: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> mFilterEnvelopeAmount; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> mOscillatorMix; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> mFilterLFOAmount; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> mOscillatorOnePitchAmount; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> mOscillatorTwoPitchAmount; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> mLFOValue;</code> </pre><br><br>  All of them, except <code>mLFOValue</code> , are associated with the values ‚Äã‚Äãof the interface handles.  In fact, these values ‚Äã‚Äãare the same for all voices, but we will not make them global and throw them into the class of the plugin.  Each voice needs access to these parameters every sample, and the Voice class does not even know about the existence of a plug-in class ( <code>#include "SpaceBass.h"</code> ).  Setting up such access would be time consuming. <br>  And there is one more parameter.  Do you remember we added the <code>isMuted</code> flag to the <code>Oscillator</code> class?  Move it to <code>Voice</code> so that when the voice is silent, the values ‚Äã‚Äãof the oscillator, envelopes and filter are not calculated: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isActive;</code> </pre><br><br>  Now let <i>'s</i> add <code>public</code> <i>before</i> <code>private</code> .  Let's start with the constructor: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Voice() : mNoteNumber(<span class="hljs-number"><span class="hljs-number">-1</span></span>), mVelocity(<span class="hljs-number"><span class="hljs-number">0</span></span>), mFilterEnvelopeAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mFilterLFOAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mOscillatorOnePitchAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mOscillatorTwoPitchAmount(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), mOscillatorMix(<span class="hljs-number"><span class="hljs-number">0.5</span></span>), mLFOValue(<span class="hljs-number"><span class="hljs-number">0.0</span></span>), isActive(<span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Set myself free everytime my volume envelope has fully faded out of RELEASE stage: mVolumeEnvelope.finishedEnvelopeCycle.Connect(this, &amp;Voice::setFree); };</span></span></code> </pre><br><br>  These strings initialize variables with reasonable values.  By default, <code>Voice</code> not active.  Also, using signals and slots of the <code>EnvelopeGenerator</code> , we ‚Äúrelease‚Äù the voice as soon as the amplitude envelope exits the release stage. <br>  Add setters to <code>public</code> : <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setFilterEnvelopeAmount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> amount)</span></span></span><span class="hljs-function"> </span></span>{ mFilterEnvelopeAmount = amount; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setFilterLFOAmount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> amount)</span></span></span><span class="hljs-function"> </span></span>{ mFilterLFOAmount = amount; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setOscillatorOnePitchAmount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> amount)</span></span></span><span class="hljs-function"> </span></span>{ mOscillatorOnePitchAmount = amount; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setOscillatorTwoPitchAmount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> amount)</span></span></span><span class="hljs-function"> </span></span>{ mOscillatorTwoPitchAmount = amount; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setOscillatorMix</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> mix)</span></span></span><span class="hljs-function"> </span></span>{ mOscillatorMix = mix; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setLFOValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ mLFOValue = value; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setNoteNumber</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> noteNumber)</span></span></span><span class="hljs-function"> </span></span>{ mNoteNumber = noteNumber; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> frequency = <span class="hljs-number"><span class="hljs-number">440.0</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">pow</span></span>(<span class="hljs-number"><span class="hljs-number">2.0</span></span>, (mNoteNumber - <span class="hljs-number"><span class="hljs-number">69.0</span></span>) / <span class="hljs-number"><span class="hljs-number">12.0</span></span>); mOscillatorOne.setFrequency(frequency); mOscillatorTwo.setFrequency(frequency); }</code> </pre><br><br>  The only interesting point here is <code>setNoteNumber</code> .  It calculates the frequency for a given note using the formula we already know and passes it to both oscillators.  After it, add: <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextSample</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setFree</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre><br><br>  As <code>Oscillator::nextSample</code> gives us an <code>Oscillator</code> output, so <code>Voice::nextSample</code> gives the resulting voice value after the amplitude envelope and filter.  We write implementation in <i>Voice.cpp</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Voice::nextSample() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isActive) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> oscillatorOneOutput = mOscillatorOne.nextSample(); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> oscillatorTwoOutput = mOscillatorTwo.nextSample(); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> oscillatorSum = ((<span class="hljs-number"><span class="hljs-number">1</span></span> - mOscillatorMix) * oscillatorOneOutput) + (mOscillatorMix * oscillatorTwoOutput); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> volumeEnvelopeValue = mVolumeEnvelope.nextSample(); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> filterEnvelopeValue = mFilterEnvelope.nextSample(); mFilter.setCutoffMod(filterEnvelopeValue * mFilterEnvelopeAmount + mLFOValue * mFilterLFOAmount); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mFilter.process(oscillatorSum * volumeEnvelopeValue * mVelocity / <span class="hljs-number"><span class="hljs-number">127.0</span></span>); }</code> </pre><br><br>  The first line ensures that when the voice is inactive nothing is calculated and zero is returned.  The next three lines calculate the <code>nextSample</code> for both oscillators and mix them according to <code>mOscillatorMix</code> .  When <code>mOscillatorMix</code> is zero, only <code>oscillatorOneOutput</code> is heard.  At <code>0.5</code> both oscillators have equal amplitude. <br>  Then the next sample of both envelopes is calculated.  We apply <code>filterEnvelopeValue</code> to the filter cutoff frequency and take the LFO value into account.  The overall modulation of the slice is the sum of the filter envelope and the LFO. <br>  The modulation of the tone of both oscillators is simply the output of the LFO multiplied by the magnitude of the modulation.  We will write it in a minute. <br>  The last line is interesting.  First, the content of the brackets: take the sum of two oscillators, use the volume envelope and the note volume value.  Then we pass the result through <code>mFilter.process</code> , as a result we get a filtered output, which we return. <br><br>  The implementation of <code>setFree</code> extremely simple: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Voice::setFree() { isActive = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre><br><br>  As already mentioned, the call to this function is made whenever <code>mVolumeEnvelope</code> completely fades out. <br><br><h3>  Voicemanager </h3><br><br>  It's time to write a class to control the voices.  Create a class named <code>VoiceManager</code> .  In the header, start with these lines: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Voice.h"</span></span></span><span class="hljs-meta"> class VoiceManager { };</span></span></code> </pre><br><br>  And continue to <code>private</code> members of the class: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> NumberOfVoices = <span class="hljs-number"><span class="hljs-number">64</span></span>; Voice voices[NumberOfVoices]; Oscillator mLFO; <span class="hljs-function"><span class="hljs-function">Voice* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findFreeVoice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre><br><br>  The constant <code>NumberOfVoices</code> denotes the maximum number of simultaneously sounding voices.  The next line creates an array of votes.  This structure uses space for 64 voices, so it is better to think about the <a href="http://www.cplusplus.com/doc/tutorial/dynamic/">dynamic allocation of memory</a> .  However, the plugin class is <code>new PLUG_CLASS_NAME</code> dynamically distributed (look for " <code>new PLUG_CLASS_NAME</code> " in <i>Iplug_include_in_plug_src.h</i> ), so all the members of the plugin class are also on the <a href="http://ru.wikipedia.org/wiki/%25D0%259A%25D1%2583%25D1%2587%25D0%25B0_%2528%25D0%25BF%25D0%25B0%25D0%25BC%25D1%258F%25D1%2582%25D1%258C%2529">heap</a> . <br><br>  <code>mLFO</code> is the global LFO for the plugin.  It never restarts, it just oscillates independently.  You can bet that it should be inside the plugin class ( <code>VoiceManager</code> doesn't need to know about the LFO).  But this will add another layer of distinction between the voices of the <code>Voice</code> and the LFO, which means we will need more <a href="http://ru.wikipedia.org/wiki/Glue_code">gluing code</a> . <br>  <code>findFreeVoice</code> is a helper function to search for voices that do not currently sound.  Add its implementation to <i>VoiceManager.cpp</i> : <br><br><pre> <code class="cpp hljs">Voice* VoiceManager::findFreeVoice() { Voice* freeVoice = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; NumberOfVoices; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!voices[i].isActive) { freeVoice = &amp;(voices[i]); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> freeVoice; }</code> </pre><br><br>  She simply iterates over all voices and finds the first silent one.  We return a pointer (instead of the <code>&amp;</code> reference), because in this case, unlike the reference, you can return <code>NULL</code> .  This will mean that all voices are heard. <br><br>  Now let's add the following function headers to the <code>public</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onNoteOn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> noteNumber, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> velocity)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onNoteOff</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> noteNumber, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> velocity)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextSample</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre><br><br>  As is clear from the name, <code>onNoteOn</code> is called when a MIDI Note On message is received.  <code>onNoteOff</code> , Respectively, is called when the Note Off message.  We write the code for these functions in the .cpp class file: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> VoiceManager::onNoteOn(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> noteNumber, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> velocity) { Voice* voice = findFreeVoice(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!voice) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } voice-&gt;reset(); voice-&gt;setNoteNumber(noteNumber); voice-&gt;mVelocity = velocity; voice-&gt;isActive = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; voice-&gt;mVolumeEnvelope.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); voice-&gt;mFilterEnvelope.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }</code> </pre><br><br>  First we find the free voice with <code>findFreeVoice</code> .  If nothing is found, we return nothing.  This means that when all voices are heard, pressing another key will have no result.  The implementation of the <a href="http://electronicmusic.wikia.com/wiki/Voice_stealing">voice stealing</a> approach will be one of the topics of the next post.  If there is a free voice, we need to update it to the initial state ( <code>reset</code> , we will do it very soon).  After that we set the correct values ‚Äã‚Äãfor <code>setNoteNumber</code> and <code>mVelocity</code> .  Mark the voice as active and translate both envelopes into the attack stage. <br>  If you start the build right now, an error will pop up saying that we are trying to access <code>private</code> members of the <code>Voice</code> from outside.  In my opinion, the best solution in this situation would be to use the <a href="http://en.wikipedia.org/wiki/Friend_class">friend</a> keyword.  Add the appropriate line before <code>public</code> in <i>Voice.h</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VoiceManager</span></span></span><span class="hljs-class">;</span></span></code> </pre><br><br>  With this line, <code>Voice</code> gives <code>VoiceManager</code> access to its <code>private</code> members.  I‚Äôm not a <code>FooManager</code> this approach, but if you have the <code>Foo</code> class and the <code>FooManager</code> class, this is a good way to avoid writing many setters. <br><br>  <code>onNoteOff</code> looks like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> VoiceManager::onNoteOff(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> noteNumber, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> velocity) { <span class="hljs-comment"><span class="hljs-comment">// Find the voice(s) with the given noteNumber: for (int i = 0; i &lt; NumberOfVoices; i++) { Voice&amp; voice = voices[i]; if (voice.isActive &amp;&amp; voice.mNoteNumber == noteNumber) { voice.mVolumeEnvelope.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); voice.mFilterEnvelope.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } } }</span></span></code> </pre><br><br>  We find all voices with the number of the note released and translate their envelopes into the release stage.  Why <i>voices</i> and not voices?  Imagine that you have a very long decay stage in the amplitude envelope.  You press a key and release it, and while the tail of the note still sounds, quickly press this key again.  Naturally, you do not want to chop off the previous sounding note.  It would be very ugly.  It is necessary that the previous note be heard, and that the new one starts to sound in parallel.  So you need more than one voice per note.  If you hammer on the keys very quickly, you will need a lot of votes. <br>  So what happens if, for example, we have five active voices for Up to the third octave and we release this key?  It is called <code>onNoteOff</code> and translates the envelopes of all five voices into the release stage.  Four of them are already in this stage, so let's look at the first line of the <code>EnvelopeGenerator::enterStage</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentStage == newStage) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre><br><br>  As you can see, nothing will happen for these four notes, there will be no hiccups here. <br><br>  Let's now write the <code>nextSample</code> member <code>nextSample</code> for <code>VoiceManager</code> .  It should display the total value for all active votes: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">double</span></span> VoiceManager::nextSample() { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> output = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> lfoValue = mLFO.nextSample(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; NumberOfVoices; i++) { Voice&amp; voice = voices[i]; voice.setLFOValue(lfoValue); output += voice.nextSample(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> output; }</code> </pre><br><br>  We start with silence <code>(0.0)</code> , iterate over all votes, set the current LFO value and add the voice output to the total output.  As we remember, if a voice is inactive, its <code>Voice::nextSample</code> function will not calculate anything and will end immediately. <br><br><h3>  Reusable components </h3><br><br>  Until now, we created <code>Oscillator</code> and <code>Filter</code> objects and used them throughout the plug-in's work.  But VoiceManager re-uses free voices, so you have to figure out how to fully transfer the voice to the initial state.  Let's start by adding a function to the <code>public</code> <code>Voice</code> header: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre><br><br>  The body of the function is written in .cpp: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Voice::reset() { mNoteNumber = <span class="hljs-number"><span class="hljs-number">-1</span></span>; mVelocity = <span class="hljs-number"><span class="hljs-number">0</span></span>; mOscillatorOne.reset(); mOscillatorTwo.reset(); mVolumeEnvelope.reset(); mFilterEnvelope.reset(); mFilter.reset(); }</code> </pre><br><br>  As you can see, <code>mNoteNumber</code> and <code>mVelocity</code> are dropped <code>mVelocity</code> , then oscillators, envelopes and a filter are dropped.  Let's write it! <br><br>  In the <code>public</code> section of <i>Oscillator.h,</i> add: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ mPhase = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> </pre><br><br>  This allows you to start the waveform first every time the voice starts to sound. <br><br>  At the same time, while we are there, remove the <code>isMuted</code> flag from the <code>private</code> section.  Remember to remove it also from the constructor initialization list and remove the <code>setMuted</code> member <code>setMuted</code> .  We now monitor the state of activity at the <code>Voice</code> level, so the oscillator is no longer necessary.  Remove this line from the <code>Oscillator::nextSample</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// remove this line: if(isMuted) return value;</span></span></code> </pre><br><br>  The <code>reset</code> function in the <code>EnvelopeGenerator</code> slightly longer.  In the <code>public</code> section of the <code>EnvelopeGenerator</code> write the following: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ currentStage = ENVELOPE_STAGE_OFF; currentLevel = minimumLevel; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; currentSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; nextStageSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br><br>  Here you just need to reset more values, everything is linear.  It remains to add a <code>reset</code> for the <code>Filter</code> class (also in <code>public</code> ): <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ buf0 = buf1 = buf2 = buf3 = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; }</code> </pre><br><br>  As you probably remember, these buffers contain the previous output samples of the filter.  When we reuse the voice, these buffers must be empty. <br><br>  To sum up: every time <code>VoiceManager</code> uses <code>Voice</code> , it calls the <code>reset</code> function to reset the voice to its initial state.  This function, in turn, resets voice oscillators, its envelope generators and filter. <br><br><h3>  static or non static? </h3><br><br>  The member variables for all votes are the same: <br><br><ul><li>  <code>Oscillator</code> : <code>mOscillatorMode</code> </li><li>  <code>Filter</code> : <code>cutoff</code> , <code>resonance</code> , <code>mode</code> </li><li>  <code>EnvelopeGenerator</code> : <code>stageValue</code> </li></ul><br><br>  At first I thought that such redundancy is evil, and all these things should be static members.  Let's imagine that <code>mOscillatorMode</code> is static.  Then the LFO would have the same waveform as the other oscillators, and we do not want this.  Further, if the <code>EnvelopeGenerator</code> envelope generator <code>stageValue</code> values ‚Äã‚Äãwere static, the amplitude and filter envelopes would be the same. <br><br>  This could be remedied by inheritance: by creating the <code>VolumeEnvelope</code> and <code>FilterEnvelope</code> classes that would inherit from the <code>EnvelopeGenerator</code> class.  The <code>stageValue</code> parameter could be static and <code>VolumeEnvelope</code> and <code>FilterEnvelope</code> could change it.  This would clearly separate the envelopes and all voices might have access to static members.  But in this case we are not talking about large amounts of memory.  All that has to do with the structure that we have created is to synchronize these variables between the amplitude envelopes and the filters of all voices. <br><br>  However, one thing can be static: <code>sampleRate</code> .  It makes no sense for the synthesizer components to work at different sampling rates.  Let's fix this in <i>Oscillator.h</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> mSampleRate;</code> </pre><br><br>  So, we should not initialize this variable through the initialization list.  Remove <code>mSampleRate(44100.0)</code> .  In <i>Oscillator.cpp,</i> after <code>#include</code> add: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Oscillator::mSampleRate = <span class="hljs-number"><span class="hljs-number">44100.0</span></span>;</code> </pre><br><br>  The sampling frequency is now static and all oscillators use one of its value. <br>  Let's do the same for the <code>EnvelopeGenerator</code> .  Make <code>sampleRate</code> static, remove the constructor from the initialization list and add it to <i>EnvelopeGenerator.cpp</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">double</span></span> EnvelopeGenerator::sampleRate = <span class="hljs-number"><span class="hljs-number">44100.0</span></span>;</code> </pre><br><br>  In <i>EnvelopeGenerator.h,</i> make the static setter: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setSampleRate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newSampleRate)</span></span></span></span>;</code> </pre><br><br>  We have added a lot of new!  Next time we will clean the excess and bring the GUI into working condition. <br><br>  The code can be downloaded <a href="">from here</a> . <br>  <a href="http://martin-finke.de/blog/articles/audio-plugins-016-polyphony/">Original post</a> . </div><p>Source: <a href="https://habr.com/ru/post/231513/">https://habr.com/ru/post/231513/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../231497/index.html">OpenVZ + venet + vlan / addresses from different networks</a></li>
<li><a href="../231499/index.html">How to make a phone holder with your own hands</a></li>
<li><a href="../231503/index.html">A delivery drone that flies like a plane and sits like a helicopter</a></li>
<li><a href="../231505/index.html">Unboxing NetApp FAS8040</a></li>
<li><a href="../231511/index.html">What languages ‚Äã‚Äãshould I translate my product into?</a></li>
<li><a href="../231519/index.html">How to respond to freelancing projects</a></li>
<li><a href="../231521/index.html">The Head of the Ministry of Communications and Mass Media proposed Apple and SAP to disclose their source codes to Russian specialists.</a></li>
<li><a href="../231523/index.html">Binding session to server in nginx. Nginx-sticky-module</a></li>
<li><a href="../231525/index.html">We write on Kotlin for Android</a></li>
<li><a href="../231527/index.html">SERP Yandex and Google: Analyzing competitors, researching industries - advodka.com</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>