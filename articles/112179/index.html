<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The subtleties when working with Sanitize in conjunction with save</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, dear% username%. I would like to tell you about one interesting feature of working with the Sanitization class. This class is part of the co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The subtleties when working with Sanitize in conjunction with save</h1><div class="post__text post__text-html js-mediator-article">  Good day, dear% username%.  I would like to tell you about one interesting feature of working with the Sanitization class.  This class is part of the core of the great CakePHP framework and is designed to ‚Äúclean‚Äù incoming data.  For example, it can be, it is necessary to use it to ‚Äúclear‚Äù the data transmitted by the user before saving to the database.  Official documentation and usage examples are here <a href="http://book.cakephp.org/view/1183/Data-Sanitization">book.cakephp.org/view/1183/Data-Sanitization</a> .  I strongly recommend that every developer using CakePHP become familiar with this class. <a name="habracut"></a><br>  But Sanitize has one feature that is not documented and it took a lot of time for the author to ascertain.  I would like to tell you more about it.  Although if you sit down and think hard, then this is not a feature or a snag, you just need to be careful and everything turns out to be understandable, simple and obvious.  Sanitize has 4 static methods: <br><ul><li>  Sanitize :: paranoid - removes "extra" characters from the string </li><li>  Sanitize :: html - cuts html </li><li>  Sanitize :: escape - escapes a string before adding to the database </li><li>  Sanitize :: clean - ‚Äúcleans‚Äù the transferred array. </li></ul><br>  In this case, we are most interested in the clean method.  Sanitize :: clean (mixed $ data, mixed $ options) takes two parameters $ data - an array and a set of options for cleaning (or, if necessary, filtering rules) <br><ul><li>  odd_spaces </li><li>  encode </li><li>  dollar </li><li>  carriage </li><li>  unicode </li><li>  escape </li><li>  backslash </li></ul><br>  Each of these rules is applied recursively to each element of $ data.  Consider this with a live example: <br>  we have a comment table (id, first_name, last_name, email, comment) <br>  Comment model <br>  Comments controller with add and view methods <br>  Let's start with the controller function to add a comment <br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     $_POST if (isset($this-&gt;data['Comment']) and !empty($this-&gt;data['Comment']) ) { App::import('Sanitize'); // ""   $this-&gt;data = Sanitize::clean($this-&gt;data); $this-&gt;Comment-&gt;set($this-&gt;data); //     if ($this-&gt;Comment-&gt;validates()) { //    if($this-&gt;Comment-&gt;save()){ $this-&gt;redirect('/comments/'); } } } }</span></span></code> </pre> <br>  like nothing out of the ordinary and incomprehensible. <pre> <code class="php hljs">Sanitize::clean(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data)</code> </pre>  as we see, we used all the filters available with this method. <br>  What will add the first comment <br><img src="https://habrastorage.org/storage/ac31c652/c6ced1a3/08d3c792/adcc8d32.png" alt="add comment"><br>  look what happened <br><img src="https://habrastorage.org/storage/8a661666/3ffcb057/05429158/d8be3fed.png" alt="view comment"><br>  so stop stop stop, where did the second slash in the last_name field come from?  Maybe this is a display error? <br>  Let's see how the data in the database. <br><img src="https://habrastorage.org/storage/85e520d5/af99d8a9/766c66eb/0ae053a8.png" alt="in db"><br>  So quotes were coded, this is understandable.  But where does this second slash come from in the last_nme field ??  You and I,%% username, know perfectly well that when escaping, the screen slashes are added to the line (sorry for tautology), but they are present in the line only until they hit the base.  In other words, the escape characters never enter the base.  But what happened in this case?  Let's figure it out!  To do this, remove the add redirect method on the defaul action (comment out the line $ this-&gt; redirect ('/ comments /');), enter the same data and see what happens.  We look at the add request: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`comments`</span></span> (<span class="hljs-string"><span class="hljs-string">`first_name`</span></span>, <span class="hljs-string"><span class="hljs-string">`last_name`</span></span>, <span class="hljs-string"><span class="hljs-string">`email`</span></span>, <span class="hljs-string"><span class="hljs-string">`comment`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'Lorem '</span></span> ipsum <span class="hljs-string"><span class="hljs-string">"', 'Aliquam\\\\ut/metus', 'consectetur@amet.sit', 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus posuere, lectus vel mollis laoreet, mauris est vehicula tortor, non tincidunt purus turpis id ligula. Ut gravida scelerisque nisi in auctor. Sed fringilla eleifend massa in mattis. Suspendisse potenti.')</span></span></code> </pre> <br>  As we remember Sanitize clears the data before saving to the database.  So part of the characters was escaped.  Escaping slashes are not recorded in the database, this is understandable.  In our case, we have 4 characters "\" two of them hit the base, the rest were shielding.  It is assumed that the line was escaped twice.  In fact, the way it is.  If you delve into the source code of the save method (and if you just think well), then we may find that Model-&gt; save () also escapes the string before saving.  Thus, if you use save + Sanitize in a bundle, disable the escape option in our case. <pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data = Sanitize::clean(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data,<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'escape'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>));</code> </pre>  But if you use the Model-&gt; query () methods for writing data and the Sanitize escape option must be enabled. <br>  Thanks to everyone who read to this place.  I don‚Äôt know, but I myself think that this is an article from the section ‚ÄúOh, hi guys, I discovered America yesterday‚Äù.  So let it be so, but I still think that this is a subtlety about which a novice (poorly reading documentation) can seriously stumble.  With great attention I will listen to any comments and suggestions. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/112179/">https://habr.com/ru/post/112179/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../112172/index.html">GNOME 3 website launched</a></li>
<li><a href="../112173/index.html">Forced change of passwords on the site, or care about my security. Or free-lance.ru broke?</a></li>
<li><a href="../112176/index.html">Different levels of languages</a></li>
<li><a href="../112177/index.html">How does Megaphone relate to the complaints of its subscribers on SMS scam and a divorce for money</a></li>
<li><a href="../112178/index.html">The State of Wikipedia</a></li>
<li><a href="../11218/index.html">Safari 3.0.2 Update</a></li>
<li><a href="../112180/index.html">Infographics: The Rise And Fall Of Yahoo</a></li>
<li><a href="../112181/index.html">Amazon is coming: Amazon Elastic Beanstalk</a></li>
<li><a href="../112182/index.html">HTML - New HTML5</a></li>
<li><a href="../112184/index.html">Fairware</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>