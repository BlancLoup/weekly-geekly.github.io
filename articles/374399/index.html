<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Smart home control system on the knee: Tarantool</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Internet of Things breaks into our lives. Somewhere completely unnoticeable, somewhere stuffing existing orders with the grace of a locomotive. Mo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Smart home control system on the knee: Tarantool</h1><div class="post__text post__text-html js-mediator-article">  The Internet of Things breaks into our lives.  Somewhere completely unnoticeable, somewhere stuffing existing orders with the grace of a locomotive.  More and more devices are connecting to the network, and more and more there are different applications, web-panels, control systems that are tied to a specific manufacturer, or, even worse, to a specific device. <br><br>  But what should those who do not want to put up with such a state, and want <s>one ring</s> one interface to rule by all?  Of course, write it yourself! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/242/dad/639/242dad6391dbb3340d65dcdd72e21a51.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I will show how using Tarantool to quickly make even non-visualization, but a complete control system, with a database, control buttons and graphs.  With its help, it is possible to control the devices of a smart home, collect and display data from sensors. <br><br>  What is Tarantool?  This is a bunch of "application server - database."  You can use it as a database with stored procedures, or you can as an application server with a built-in database.  All internal logic, whether user-defined or stored, is written in Lua.  Thanks to the use of LuaJIT, and not the usual interpreter, it is not much slower than the native code in speed. <br><br>  Another important factor is Tarantool is a noSQL database.  This means that instead of traditional queries like ‚ÄúSELECT ... WHERE‚Äù, you manage data directly: write a procedure that iterates through all the data (or part of it) and gives you it.  In version 2.x, SQL query support was added, but they are not a panacea - for high performance, it is often important to understand exactly how a particular query is executed, and not to give it to the developers. <br><br>  In the article, I will show an example of use when all the application logic is written inside Tarantool, including communication with external APIs, data processing and output. <br><br>  Go! <br><a name="habracut"></a><br><h2>  Introduction </h2>  We define the system requirements.  This should be a service that implements the user interface for some smart home device.  In the web interface, there should be buttons that send commands to the device, and visualization of data from this device.  A little blurry, but enough to start. <br><br>  Disclaimer 1: <br>  My understanding of web development at the time of the beginning of this article was frozen somewhere in 2010 (or even earlier), so take the frontend code as an example of ‚Äúhow not to do‚Äù. <br><br>  Disclaimer 2: <br>  Let's immediately agree that the hypothetical device of the smart home is available through MQTT.  This is a fairly universal and common protocol, so that they do not accuse me of artificiality of the example.  The implementation of other protocols, though simple, is clearly beyond the scope of the article in which I want to show an example of working with Tarantool, and not the process of writing a driver for some Chinese light bulb. <br><br><h3>  What is MQTT? </h3>  MQTT, as Google tells us, is a network protocol used mainly for <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B5%25D0%25B6%25D0%25BC%25D0%25B0%25D1%2588%25D0%25B8%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25B2%25D0%25B7%25D0%25B0%25D0%25B8%25D0%25BC%25D0%25BE%25D0%25B4%25D0%25B5%25D0%25B9%25D1%2581%25D1%2582%25D0%25B2%25D0%25B8%25D0%25B5">M2M interaction</a> . <br><br>  The protocol works according to the publisher-subscriber model: this means that someone (for example, a device) can publish messages, and you, if you subscribe to an address (in MQTT this is called a topic, for example, <b>"/ data / voltage / "</b> ), you will receive these messages. <br><br>  Client-server protocol - it should always have a server, without which two clients cannot exchange data.  This is done in order to maximally facilitate the client part and the protocol.  Clients simply send messages ‚ÄúI want to subscribe‚Äù, ‚ÄúI want to unsubscribe‚Äù, ‚ÄúI want to publish‚Äù, and the server is engaged in routing between them. <br><br><div class="spoiler">  <b class="spoiler_title">A little bit more</b> <div class="spoiler_text">  You can subscribe not only to a specific topic, but also using wildcards in the address.  So, subscribing to " <b>/ data / +</b> " will allow you to receive messages from any topics of the form " <b>/ data / whatever /</b> ", for example, " <b>/ data / temperature /</b> " and " <b>/ data / stat</b> ", and subscribing to " <b>/ data / #</b> "- from the topics of the form" <b>/ data / whatever / whatever / whatever / ...</b> ", i.e.  not only from " <b>/ data / temperature /</b> and" <b>/ data / stat</b> ", but also from" <b>/ data / stat / today</b> "and" <b>/ data / stat / today / user / ivan</b> ". <br><br>  The names of topics are not standardized, so the way you shove your data on them is your business.  Statistics for the user for the current day can be either in " <b>/ stat / today / user / ivan</b> " or in " <b>/ user / ivan / stat / today</b> " or in " <b>/ today / ivan / stat</b> ".  In the first case, you can subscribe to all statistics notifications (" <b>/ stat / #</b> "), and in the second, all notifications from an individual user (" <b>/ user / ivan / #</b> ").  However, in the second case, you can also subscribe to statistics for the current day for all users (" <b>/ user / + / stat / today</b> "). <br><br>  The protocol has QOS, which determines how much effort the sender must make to deliver the message to the recipient.  When QOS 0 does not attach them at all (sends a message and forgets), with QOS 1, it waits for at least one confirmation (but sometimes the recipient may receive several duplicate messages, take this into account when commands are always changing the current state), while QOS 2 only one confirmation (more than one message will not come). <br><br>  Another message can be marked with the flag ¬´Retain¬ª.  In this case, the server will remember the last message value in this topic, and will send it to all reconnected clients. <br><br>  This is convenient if the client needs to know about the current state, such as light, but he just connected, and can not know what happened an hour ago.  And if you mark messages about changes in light with this flag, the server will store the latest changes and send them immediately when new clients are connected. <br></div></div><br><h2>  Step one: form with buttons </h2>  So, our minimum functionality is the ability to send some command to a hypothetical device.  Although why a hypothetical?  Let's take the <a href="https://wirenboard.com/ru/catalog/kontrollery/">Wiren Board</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/229/0c6/e4b/2290c6e4b63a24bd4edfb4ec631ea863.jpg"><br><br>  We will manage at least a squeaker on it.  To enable it, we need to connect via MQTT to WirenBoard and send "1" to the topic " <b>/ devices / buzzer / controls / enabled / on</b> ".  To disable - you must send the same "0". <br><br>  Install the http-server package, create a new file, give it rights to execute and say that it should be executed in the Tarantool interpreter, and not just in Lua: <br><br><pre><code class="lua hljs">tarantoolctl rocks install http echo <span class="hljs-string"><span class="hljs-string">'#!/usr/bin/env tarantool'</span></span> &gt; iot_scada.lua chmod +x iot_scada.lua</code> </pre> <br>  Now you can open the file in your favorite editor, and literally through a few lines of code we will have a small but very proud HTTP server: <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-built_in"><span class="hljs-built_in">config</span></span> = {} <span class="hljs-built_in"><span class="hljs-built_in">config</span></span>.HTTP_PORT = <span class="hljs-number"><span class="hljs-number">8080</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">http_server_root_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(req)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req:render{ json = { server_status = <span class="hljs-string"><span class="hljs-string">"ok"</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> http_server = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http.server'</span></span>).new(<span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">config</span></span>.HTTP_PORT, {charset = <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}) http_server:route({ <span class="hljs-built_in"><span class="hljs-built_in">path</span></span> = <span class="hljs-string"><span class="hljs-string">'/'</span></span> }, http_server_root_handler) http_server:start()</code> </pre> <br>  Now, having started our service ( <b>./iot_scada.lua</b> ), we can open the <a href="http://localhost/">localhost</a> : 8080 / page in the browser and see there something like <br><br><pre> <code class="lua hljs">{<span class="hljs-string"><span class="hljs-string">"server_status"</span></span>:<span class="hljs-string"><span class="hljs-string">"ok"</span></span>}</code> </pre> <br>  This means that our server is working and is able to communicate with the outside world.  Yes, so far exclusively in JSON format, but it is easy to fix.  In order not to bother with the interface, we take for this purpose <a href="http://getbootstrap.com/">Twitter Bootstrap</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/110/f9a/be5/110f9abe5d29e4ae71c5d58405c3fc2b.png"><br><br>  Next to our script, create public folders and templates.  The first one will contain static content, and the second is intended for HTML templates (they do not belong to static, because Tarantool can execute lua-scripts in these templates). <br><br>  In the public folder, we put all sorts of bootstrap.min.css, bootstrap.min.js, jquery-slim.min.js, and so on (I found these files in the archive with Bootstrap, you can find it in the same place or <a href="https://github.com/vvzvlad/tarantool-iotscada-mailru-gt/tree/a2f55792019145ca2355012a65167ca7eae3154d/public">here</a> ), and in the templates we'll throw The file <b>dashboard.html</b> is an example of a page from the same standard delivery.  We'll talk about him a little later. <br><br>  Now, change our service a bit: <br><br><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--...-- local function http_server_action_handler(req) -- endpoint-a /action return req:render{ json = { mqtt_result = true } } -- JSON end local function http_server_root_handler(req) -- endpoint-a / return req:redirect_to('/dashboard') --  /dashboard end --...-- http_server:route({ path = '/action' }, http_server_action_handler) http_server:route({ path = '/' }, http_server_root_handler) http_server:route({ path = '/dashboard', file = 'dashboard.html' }) --...--</span></span></code> </pre> <br>  What did we do here?  First, they described two more endpoints - "/ action", which will be used for API requests, and "/ dashboard", which will give the contents of the dashboard.html file.  We installed and described the functions that will be called when the browser requests these addresses: when you request "/", the <b>http_server_root_handler</b> function will be called, which redirects the browser to the / dashboard address, and when the / action request is, the <b>http_server_action_handler</b> function will generate JSON from the Lua object and will give it to the client. <br><br>  Now, as promised, let's do the dashboard.html file.  I will not give it all, you can look <a href="https://github.com/vvzvlad/tarantool-iotscada-mailru-gt/blob/a2f55792019145ca2355012a65167ca7eae3154d/templates/dashboard.html">here</a> , it is almost a copy of the example from Bootstrap.  I will show only the functional parts: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"row input-group"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"col-md-3 mb-1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action-button</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"on"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-success mqtt-buttons"</span></span></span><span class="hljs-tag">&gt;</span></span>On buzzer<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action-button</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"off"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-success mqtt-buttons"</span></span></span><span class="hljs-tag">&gt;</span></span>Off buzzer<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Here we describe two buttons, "On buzzer" and "Off buzzer".  Add to them the attribute " <b>action-button</b> ", which describes the function of the button, and the class " <b>mqtt-buttons</b> ", which we will catch in JS.  And here it is, by the way (yes, right in the body of the page, do not do that, so be it). <br><br><pre> <code class="javascript hljs"> &lt;script&gt; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> button_xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> last_button_object; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mqtt_result</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (button_xhr.readyState == <span class="hljs-number"><span class="hljs-number">4</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (button_xhr.status == <span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> json_data = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(button_xhr.responseText); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(json_data, button_xhr.responseText) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (json_data.mqtt_result == <span class="hljs-literal"><span class="hljs-literal">true</span></span>) last_button_object.removeClass(<span class="hljs-string"><span class="hljs-string">"btn-warning"</span></span>).removeClass(<span class="hljs-string"><span class="hljs-string">"btn-danger"</span></span>).addClass(<span class="hljs-string"><span class="hljs-string">"btn-success"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> last_button_object.removeClass(<span class="hljs-string"><span class="hljs-string">"btn-warning"</span></span>).removeClass(<span class="hljs-string"><span class="hljs-string">"btn-success"</span></span>).addClass(<span class="hljs-string"><span class="hljs-string">"btn-danger"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { last_button_object.removeClass(<span class="hljs-string"><span class="hljs-string">"btn-warning"</span></span>).removeClass(<span class="hljs-string"><span class="hljs-string">"btn-success"</span></span>).addClass(<span class="hljs-string"><span class="hljs-string">"btn-danger"</span></span>); } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_to_mqtt</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ button_xhr.open(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-string"><span class="hljs-string">'action?type=mqtt_send&amp;action='</span></span> + $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).attr(<span class="hljs-string"><span class="hljs-string">'action-button'</span></span>), <span class="hljs-literal"><span class="hljs-literal">true</span></span>); button_xhr.send() last_button_object = $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).removeClass(<span class="hljs-string"><span class="hljs-string">"btn-success"</span></span>).removeClass(<span class="hljs-string"><span class="hljs-string">"btn-danger"</span></span>).addClass(<span class="hljs-string"><span class="hljs-string">"btn-warning"</span></span>); } $(<span class="hljs-string"><span class="hljs-string">'.mqtt-buttons'</span></span>).on(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, send_to_mqtt); button_xhr.onreadystatechange = mqtt_result &lt;<span class="hljs-regexp"><span class="hljs-regexp">/script&gt;</span></span></code> </pre> <br>  Easier to read from the bottom up.  We set the function <b>send_to_mqtt</b> as a handler for all buttons with the class mqtt-buttons ( <b>$ ('. Mqtt-buttons'). On ('click', send_to_mqtt);</b> ).  In this function, we make a POST request of the form <b>/ action? Type = mqtt_send &amp; action = on</b> , with the last value obtained from the action-button attribute of the pressed button.  Well, let's paint the button yellow ( <b>.addClass (‚Äúbtn-warning‚Äù)</b> ), showing that the request went to the server. <br><br>  The request is asynchronous, so we install and process the data that the server will return to us in response to the request ( <b>button_xhr.onreadystatechange = mqtt_result</b> ).  In the handler, we check whether the response came, whether it came with code 200, and whether it is valid JSON data with the parameter <b>mqtt_result = true</b> .  If he is like that, then we paint the button back to green, and if not, then to red ( <b>.addClass (‚Äúbtn-danger‚Äù)</b> ): ‚Äúchef, everything is lost‚Äù. <br><br>  Now, if you start the service and open <a href="http://localhost/">localhost</a> : 8080 / in the browser, we will see the following page: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f84/512/139/f84512139e133f028492c8736c424d62.png"><br><br>  When you click on the buttons it seems that their color does not change, but this is only because the request comes and goes too quickly.  If you stop the service running in the console, then pressing the button will repaint it red: there is no one to answer. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/110/4d1/c44/1104d1c449bdb7253ec45a246e85ff84.png"><br><br>  Buttons work, but do nothing: there is no logic on the server side.  Let's add it. <br><br>  First you need to install the mqtt library.  By default, there is no tarantula in its delivery, so you need to install: <b>sudo tarantoolctl rocks install mqtt</b> .  Run this command in the folder containing <b>iot_scada.lua</b> , since the library will be installed locally in the .rocks folder. <br><br>  Now you can write code: <br><br><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--...-- local mqtt = require 'mqtt' config.MQTT_WIRENBOARD_HOST = "192.168.1.59" config.MQTT_WIRENBOARD_PORT = 1883 config.MQTT_WIRENBOARD_ID = "tarantool_iot_scada" --...-- mqtt.wb = mqtt.new(config.MQTT_WIRENBOARD_ID, true) local mqtt_ok, mqtt_err = mqtt.wb:connect({host=config.MQTT_WIRENBOARD_HOST,port=config.MQTT_WIRENBOARD_PORT,keepalive=60,log_mask=mqtt.LOG_ALL}) if (mqtt_ok ~= true) then print ("Error mqtt: "..(mqtt_err or "No error")) os.exit() end --...--</span></span></code> </pre> <br>  We connect the library, determine the server‚Äôs address and port, as well as the client‚Äôs name (usually, authorization is still required, but it is turned off by default on WB. You can read about how to use authorization and other library functions on its <a href="https://github.com/tarantool/mqtt">page</a> ). <br><br>  After connecting the library, create a new mqtt object and connect to the server.  Now we can use " <b>mqtt.wb: publish</b> " to send MQTT messages to different topics. <br><br>  Let's <b>do the http_server_action_handler</b> function.  She must, firstly, obtain information about what kind of request she sent to the button on the page, and secondly, execute it.  With the first, everything is very simple.  This construction will pull out the <b>type</b> and <b>action</b> arguments from the address: <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> type_param, action_param = req:param(<span class="hljs-string"><span class="hljs-string">"type"</span></span>), req:param(<span class="hljs-string"><span class="hljs-string">"action"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type_param ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> action_param ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-comment"><span class="hljs-comment">--body-- end</span></span></code> </pre> <br>  The <b>type</b> argument will be equal to ‚Äúmqtt_send‚Äù, and the <b>action</b> can be ‚Äúon‚Äù or ‚Äúoff‚Äù.  At the first value, we need to send to the MQTT topic "1", and at the second - "2".  We implement: <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">http_server_action_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(req)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> type_param, action_param = req:param(<span class="hljs-string"><span class="hljs-string">"type"</span></span>), req:param(<span class="hljs-string"><span class="hljs-string">"action"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type_param ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> action_param ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type_param == <span class="hljs-string"><span class="hljs-string">"mqtt_send"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> command = <span class="hljs-string"><span class="hljs-string">"0"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (action_param == <span class="hljs-string"><span class="hljs-string">"on"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> command = <span class="hljs-string"><span class="hljs-string">"1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> (action_param == <span class="hljs-string"><span class="hljs-string">"off"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> command = <span class="hljs-string"><span class="hljs-string">"0"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> result = mqtt.wb:publish(<span class="hljs-string"><span class="hljs-string">"/devices/buzzer/controls/enabled/on"</span></span>, command, mqtt.QOS_1, mqtt.NON_RETAIN) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req:render{ json = { mqtt_result = result } } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  Notice the result variable ‚Äî the <b>mqtt.wb: publish</b> function returns the request status (true or false), which is then packaged in JSON and sent to the browser. <br><br>  Now the buttons are not only pressed, but also work.  See for yourself: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/nwXwg8bVsws" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  All code related to this step can be found <a href="https://github.com/vvzvlad/tarantool-iotscada-mailru-gt/tree/a2f55792019145ca2355012a65167ca7eae3154d">here</a> .  Or get yourself on the disk with this command: <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/vvzvlad/tarantool-iotscada-mailru-gt.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> tarantool-iotscada-mailru<span class="hljs-_"><span class="hljs-_">-gt</span></span> git checkout a2f55792019145ca2355012a65167ca7eae3154d</code> </pre> <br><h2>  Step one and a half: playing the imperial march <br></h2>  Let's add the third button, or what?  If we have a speaker, let him play the imperial march! <br><br>  What is great, on the page we need to add only the button itself, defining some other action-button attribute to it: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action-button</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sw"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-success mqtt-buttons"</span></span></span><span class="hljs-tag">&gt;</span></span>Play Imperial march<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  All the magic will occur in the file with the code.  Add a new parameter handler: <br><br><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--...-- local function play_star_wars() end --...-- elseif (action_param == "sw") then play_star_wars() --...--</span></span></code> </pre> <br>  Now, we need to think about how we will play the melody.  In an article on Wikipedia about the imperial march there were good timings for the melody, but now they were cut out from there.  I had to find others in the format frequency / time: <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> imperial_march = {{<span class="hljs-number"><span class="hljs-number">392</span></span>, <span class="hljs-number"><span class="hljs-number">350</span></span>}, {<span class="hljs-number"><span class="hljs-number">392</span></span>, <span class="hljs-number"><span class="hljs-number">350</span></span>}, {<span class="hljs-number"><span class="hljs-number">392</span></span>, <span class="hljs-number"><span class="hljs-number">350</span></span>}, {<span class="hljs-number"><span class="hljs-number">311</span></span>, <span class="hljs-number"><span class="hljs-number">250</span></span>}, {<span class="hljs-number"><span class="hljs-number">466</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>}, {<span class="hljs-number"><span class="hljs-number">392</span></span>, <span class="hljs-number"><span class="hljs-number">350</span></span>}, {<span class="hljs-number"><span class="hljs-number">311</span></span>, <span class="hljs-number"><span class="hljs-number">250</span></span>}, {<span class="hljs-number"><span class="hljs-number">466</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>}, {<span class="hljs-number"><span class="hljs-number">392</span></span>, <span class="hljs-number"><span class="hljs-number">700</span></span>}, {<span class="hljs-number"><span class="hljs-number">392</span></span>, <span class="hljs-number"><span class="hljs-number">350</span></span>}, {<span class="hljs-number"><span class="hljs-number">392</span></span>, <span class="hljs-number"><span class="hljs-number">350</span></span>}, {<span class="hljs-number"><span class="hljs-number">392</span></span>, <span class="hljs-number"><span class="hljs-number">350</span></span>}, {<span class="hljs-number"><span class="hljs-number">311</span></span>, <span class="hljs-number"><span class="hljs-number">250</span></span>}, {<span class="hljs-number"><span class="hljs-number">466</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>}, {<span class="hljs-number"><span class="hljs-number">392</span></span>, <span class="hljs-number"><span class="hljs-number">350</span></span>}, {<span class="hljs-number"><span class="hljs-number">311</span></span>, <span class="hljs-number"><span class="hljs-number">250</span></span>}, {<span class="hljs-number"><span class="hljs-number">466</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>}, {<span class="hljs-number"><span class="hljs-number">392</span></span>, <span class="hljs-number"><span class="hljs-number">700</span></span>}, {<span class="hljs-number"><span class="hljs-number">784</span></span>, <span class="hljs-number"><span class="hljs-number">350</span></span>}, {<span class="hljs-number"><span class="hljs-number">392</span></span>, <span class="hljs-number"><span class="hljs-number">250</span></span>}, {<span class="hljs-number"><span class="hljs-number">392</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>}, {<span class="hljs-number"><span class="hljs-number">784</span></span>, <span class="hljs-number"><span class="hljs-number">350</span></span>}, {<span class="hljs-number"><span class="hljs-number">739</span></span>, <span class="hljs-number"><span class="hljs-number">250</span></span>}, {<span class="hljs-number"><span class="hljs-number">698</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>}, {<span class="hljs-number"><span class="hljs-number">659</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>}, {<span class="hljs-number"><span class="hljs-number">622</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>}, {<span class="hljs-number"><span class="hljs-number">659</span></span>, <span class="hljs-number"><span class="hljs-number">450</span></span>}, {<span class="hljs-number"><span class="hljs-number">415</span></span>, <span class="hljs-number"><span class="hljs-number">150</span></span>}, {<span class="hljs-number"><span class="hljs-number">554</span></span>, <span class="hljs-number"><span class="hljs-number">350</span></span>}, {<span class="hljs-number"><span class="hljs-number">523</span></span>, <span class="hljs-number"><span class="hljs-number">250</span></span>}, {<span class="hljs-number"><span class="hljs-number">493</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>}, {<span class="hljs-number"><span class="hljs-number">466</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>}, {<span class="hljs-number"><span class="hljs-number">440</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>}, {<span class="hljs-number"><span class="hljs-number">466</span></span>, <span class="hljs-number"><span class="hljs-number">450</span></span>}, {<span class="hljs-number"><span class="hljs-number">311</span></span>, <span class="hljs-number"><span class="hljs-number">150</span></span>}, {<span class="hljs-number"><span class="hljs-number">369</span></span>, <span class="hljs-number"><span class="hljs-number">350</span></span>}, {<span class="hljs-number"><span class="hljs-number">311</span></span>, <span class="hljs-number"><span class="hljs-number">250</span></span>}, {<span class="hljs-number"><span class="hljs-number">466</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>}, {<span class="hljs-number"><span class="hljs-number">392</span></span>, <span class="hljs-number"><span class="hljs-number">750</span></span>}}</code> </pre> <br>  True, over time there is something not quite right, and there is no pause length, but what can we do.  On WirenBoard, you can change the frequency of the speaker by sending the value of the new frequency in Hertz to the topic " <b>/ devices / buzzer / controls / frequency / on</b> ", but you cannot set the duration of the sound.  So, we will count the duration on the application side. <br><br>  Since we are designing the ‚Äúright‚Äù service, then despite any actions, the responsiveness of the service should not deteriorate: we will have to make it asynchronous and multi-threaded. <br><br>  For this we use fibers (fibers) - this is the implementation of separate streams for Tarantool.  Documentation can be found <a href="https://tarantool.io/en/doc/1.9/reference/reference_lua/fiber.html">here</a> .  In the simplest version, launching another stream within your program requires only a few lines: <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> fiber = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> <span class="hljs-string"><span class="hljs-string">'fiber'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fiber_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"fiber ok"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> fiber.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(fiber_func)</code> </pre> <br>  First we connect the library, then we define the function that will be launched in a separate thread, and then we create a new fiber, passing it the name of the function.  There is also monitoring of running processes, synchronization tools and messages between running threads, but we will not dive into it yet.  We use only the delay function, which is called <b>fiber.sleep</b> .  By the way, Faybers are cooperative multitasking, so the call to fiber.sleep is not just waiting, but giving control to the task manager so that other processes can work, for example, writing to the database.  It should be remembered that in heavy cycles it is sometimes necessary to transfer control to other flows so that they do not stop for long. <br><br>  Everything else is simple: we need to bypass the array in a loop, getting the frequency and duration of each element, adjusting the frequency through the MQTT, and then starting the delays for the note and pause, and also turning on / off the sound. <br><br><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--...-- for i = 1, #imperial_march do local freq = imperial_march[i][1] local delay = imperial_march[i][2] mqtt.wb:publish("/devices/buzzer/controls/frequency/on", freq, mqtt.QOS_0, mqtt.NON_RETAIN) mqtt.wb:publish("/devices/buzzer/controls/enabled/on", 1, mqtt.QOS_0, mqtt.NON_RETAIN) fiber.sleep(delay/1000*2) mqtt.wb:publish("/devices/buzzer/controls/enabled/on", 0, mqtt.QOS_0, mqtt.NON_RETAIN) fiber.sleep(delay/1000/3) end --...--</span></span></code> </pre> <br>  View the full code <a href="">here</a> , or in <a href="https://github.com/vvzvlad/tarantool-iotscada-mailru-gt/commit/10364cea7f3e1490ac3eb916b4f4b4c095bec705">diff-form</a> . <br><br>  Hurray, it works! <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/JakZwKTxFKw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  The clarity of the melody floats a little because of unpredictable network delays, but the melody is quite clear and recognizable.  Colleagues rejoice (in fact, no, for the tenth time they were zadolbalo). <br><br>  As usual, the code relating to this step can be found <a href="https://github.com/vvzvlad/tarantool-iotscada-mailru-gt/tree/10364cea7f3e1490ac3eb916b4f4b4c095bec705">here</a> .  Or get yourself on the disk with such a command (it is assumed that you have already cloned the repository, and you are inside its directory): <br><br><pre> <code class="plaintext hljs">git checkout 10364cea7f3e1490ac3eb916b4f4b4c095bec705</code> </pre><br><h2>  Step Three: Temperature on the webpage </h2>  And now let's do something more close to reality.  The imperial march sounds funny, but it has very little to do with the Internet of things.  Take, for example, two temperature sensors and connect them: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a33/1a1/1d9/a331a11d9729e10e0981783ce5495382.jpg"><br><br>  As the <a href="https://contactless.ru/wiki/index.php/1-Wire">documentation</a> promises, we will not need to do anything else, the data from the sensors will appear in the MQTT themselves. <br><br>  The minimum task in this step is to make on the page a real-time updated display of information from the sensors.  There are several of them, and the composition may change, so we will not hardcore the serial numbers of the sensors, and automate all actions, including determining and displaying information from new sensors.  Let's start with the server. <br><br><h3>  Backend <br></h3>  The first thing we need to do is create a function that should be called when the MQTT message is received with temperature, then tell the library that we should call it, and subscribe to the message topic.  The documentation states that the topic looks like this: " <b>/ devices / wb-w1 / controls / 28-43276f64</b> ".  28-43276f64 - this is the serial number of the sensor.  So, a subscription to the data from all possible sensors will look like this: " <b>/ devices / wb-w1 / controls / +</b> ". <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> sensor_values = {} <span class="hljs-comment"><span class="hljs-comment">--...-- local function mqtt_callback(message_id, topic, payload, gos, retain) local topic_pattern = "/devices/wb%-w1/controls/(%S+)" local _, _, sensor_address = string.find(topic, topic_pattern) if (sensor_address ~= nil) then sensor_values[sensor_address] = tonumber(payload) end end --...-- mqtt.wb:on_message(mqtt_callback) mqtt.wb:subscribe('/devices/wb-w1/controls/+', 0)</span></span></code> </pre> <br>  Now we will understand in more detail what we do in the callback function.  To find the serial number in the address bar, we use the so-called <a href="https://www.lua.org/pil/20.2.html">patterns</a> (regular expressions for Lua-shnogo spill).  The function <b>string.find</b> accepts a string and a pattern in which the brackets indicate what should be captured from this string.  In this case, ‚Äú <b>% S +</b> ‚Äù means ‚Äú1 or more characters that are not spaces‚Äù - so the function will capture everything after ‚Äú..controls /‚Äù before the first space encountered.  And since we do not have spaces in the sensor number, and the subscription address allows messages only from " <b>/ devices / wb-w1 / controls / sensor address</b> ", but not from " <b>/ devices / wb-w1 / controls / sensor address / something else</b> ", then in the variable <b>sensor_address</b> we will always have the address (serial number) of the sensor. <br><br>  Please note that the strings <b>'/ devices / wb-w1 / controls / +'</b> and <b>"/ devices / wb% -w1 / controls / (% S +)"</b> are similar, but different: the first line is wildcard mqtt- a subscription, and the second is a string argument for the Lua-shny function <b>string.find</b> , which uses a subset of regular expressions in the Lua format (there, for example, "-" must be escaped, so it is written as "wb% -w1") <br><br>  In the next lines we create and fill in the <b>sensor_values</b> table, in which we will have records corresponding to the sensors: the key will be the serial number, and the value will be the temperature from the sensor. <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> sensor_values = {} <span class="hljs-comment"><span class="hljs-comment">--...-- sensor_values[sensor_address] = tonumber(payload)</span></span></code> </pre> <br>  The table will contain the last temperature value received and stored only in memory.  In fact, you should not do this, global tables accessible to all are evil.  If the application were slightly larger than the demo, it would be worth creating two functions: a getter and a setter, the first of which would produce a table, and the second would preserve.  In addition to the obvious advantages, such as validation of stored data and data output in different formats, it would be much easier to track who changes the data and when than with a table that is available to everyone in a row. <br><br>  The next thing we have to do is somehow give this table to the frontend.  Therefore, we write this function: first, it will turn the key-value label into an array, which will be easier to display on the page, and secondly, it will be packed in JSON and given to the one who asks: <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">http_server_data_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(req)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> type_param = req:param(<span class="hljs-string"><span class="hljs-string">"type"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type_param ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type_param == <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor_values ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> temperature_data_object, i = {}, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> key, value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">pairs</span></span>(sensor_values) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> i = i + <span class="hljs-number"><span class="hljs-number">1</span></span> temperature_data_object[i] = {} temperature_data_object[i].sensor = key temperature_data_object[i].temperature = value <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req:render{ json = { temperature_data_object } } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req:render{ json = { none_data = <span class="hljs-string"><span class="hljs-string">"true"</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  Of course, you can immediately form the correct table in the mqtt-callback, but choosing where to convert depends on what happens more often - saving or issuing: saving to the table by key is much faster than going through the table looking for the right sensor name for each value.  Thus, if we show the values, on average, every minute, and they are saved every second, then it is more advantageous to save by key, and then format it on request.  If, on the contrary, for example, we have a dozen customers who look at the table, and the temperature is updated infrequently, then it is better to keep the finished table. <br><br>  But again, this all matters only if these operations begin to occupy at least some tangible share of resources. <br><br>  Finally, we install this function as an endpoint-a / data <code>http_server:route({ path = '/data' }, http_server_data_handler)</code> : <code>http_server:route({ path = '/data' }, http_server_data_handler)</code> . <br><br>  Checking: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/10c/341/2a3/10c3412a3d4ee2e313ccc4d0cbee0f6e.png"><br><br>  Works! <br><br><h3>  Frontend </h3>  Now you need to draw a sign.  Create a preset: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>Sensors:<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"table-responsive"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"table table-striped table-sm"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"table_values_temp"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  And we write two functions that will turn the JS object into a table: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_row_table</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">table_name, type, table_data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> table_current_row; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type == <span class="hljs-string"><span class="hljs-string">"head"</span></span>) table_current_row = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(table_name).createTHead().insertRow(<span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(table_name).tBodies.length == <span class="hljs-number"><span class="hljs-number">0</span></span>) table_current_row = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(table_name).createTBody().insertRow(<span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> table_current_row = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(table_name).tBodies[<span class="hljs-number"><span class="hljs-number">0</span></span>].insertRow(<span class="hljs-number"><span class="hljs-number">-1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; table_data.length; j++) table_current_row.insertCell(<span class="hljs-number"><span class="hljs-number">-1</span></span>).innerHTML = table_data[j]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clear_table</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">table_name</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(table_name).innerHTML = <span class="hljs-string"><span class="hljs-string">""</span></span>; }</code> </pre> <br>  Now it remains only to start updating this label in a loop: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr_tmr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update_table_callback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xhr_tmr.readyState == <span class="hljs-number"><span class="hljs-number">4</span></span> &amp;&amp; xhr_tmr.status == <span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> json_data = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(xhr_tmr.responseText); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (json_data.none_data != <span class="hljs-string"><span class="hljs-string">"true"</span></span>) { clear_table(<span class="hljs-string"><span class="hljs-string">"table_values_temp"</span></span>) add_row_table(<span class="hljs-string"><span class="hljs-string">"table_values_temp"</span></span>, <span class="hljs-string"><span class="hljs-string">"head"</span></span>, [<span class="hljs-string"><span class="hljs-string">"Sensor serial"</span></span>, <span class="hljs-string"><span class="hljs-string">"Temperature"</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> index = <span class="hljs-number"><span class="hljs-number">0</span></span>; index &lt; json_data[<span class="hljs-number"><span class="hljs-number">0</span></span>].length; index++) { add_row_table(<span class="hljs-string"><span class="hljs-string">"table_values_temp"</span></span>, <span class="hljs-string"><span class="hljs-string">"body"</span></span>, [json_data[<span class="hljs-number"><span class="hljs-number">0</span></span>][index].sensor, json_data[<span class="hljs-number"><span class="hljs-number">0</span></span>][index].temperature]) } } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timer_update_field</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ xhr_tmr.onreadystatechange = update_table_callback xhr_tmr.open(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-string"><span class="hljs-string">'data?type=temperature'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xhr_tmr.send() } setInterval(timer_update_field, <span class="hljs-number"><span class="hljs-number">1000</span></span>);</code> </pre> <br>  As you can see, the table is deleted and re-created each time, which could have a bad effect on the execution speed if the label did not consist of two values.  The correct approach is to take a framework that can use reactivity and virtual dom, but this is clearly beyond the scope of this article. <br><br>  Well, what did we do? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bbf/efc/342/bbfefc34277fc9d091ffcf2d9a2c8fcc.png"><br><br>  The code related to this step can be viewed <a href="https://github.com/vvzvlad/tarantool-iotscada-mailru-gt/tree/e387430efed44598efe827016f903cc3c17634a8">here</a> , or by making <b>git checkout e387430efed44598efe827016f903cc3c17634a8</b> .  Or <a href="https://github.com/vvzvlad/tarantool-iotscada-mailru-gt/commit/e387430efed44598efe827016f903cc3c17634a8">DIFF-</a> view. <br><br><h2>  Step Four: Database Temperature </h2>  And now let's do the same, but with the database!  In the end, Tarantool - a database or not?  :) <br><br>  Changes, in fact, will be quite a bit.  First, we initialize the database engine and create a space (this is an analogue of a table in some SQL): <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">database_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> box.cfg { log_level = <span class="hljs-number"><span class="hljs-number">4</span></span> } box.schema.user.grant(<span class="hljs-string"><span class="hljs-string">'guest'</span></span>, <span class="hljs-string"><span class="hljs-string">'read,write,execute'</span></span>, <span class="hljs-string"><span class="hljs-string">'universe'</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, {if_not_exists = <span class="hljs-literal"><span class="hljs-literal">true</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-built_in"><span class="hljs-built_in">format</span></span> = { {name=<span class="hljs-string"><span class="hljs-string">'serial'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">'string'</span></span>}, <span class="hljs-comment"><span class="hljs-comment">--1 {name='timestamp', type='number'}, --2 {name='value', type='number'}, --3 } storage = box.schema.space.create('storage', {if_not_exists = true, format = format}) storage:create_index('serial', {parts = {'serial'}, if_not_exists = true}) end</span></span></code> </pre> <br>  Now let's take a closer look at the challenges: we are beginning to dive into the very essence of Tarantool - in working with the database. <br><br>  <a href="https://tarantool.io/en/doc/1.9/book/box/box_cfg/">box.cfg ()</a> is initialization.  We pass the logging level parameter to it, indicating which logs of what importance we want to see, and which one is not.  But in general, she has many <a href="https://tarantool.io/en/doc/1.9/reference/configuration/">parameters</a> . <br><br>  You may notice that the function call <b>box.cfg is</b> kind of strange: instead of round braces it is curly.  This is because in Lua, when passing a function, one argument of the bracket can be omitted.  And since {} is a table, one argument is passed to the table.  Simply put, <b>box.cfg ({log_level = 4})</b> is the same as <b>box.cfg {log_level = 4}</b> . <br><br>  <a href="https://tarantool.io/en/doc/1.9/book/box/box_schema/"><b>With the box.schema.user.grant</b></a> function <a href="https://tarantool.io/en/doc/1.9/book/box/box_schema/"><b>,</b></a> we give the guest user without a password ( <b>nil</b> ) rights to read, write and execute ( <b>read, write, execute</b> ) in the entire space of the current Tarantool ( <b>universe</b> ) instance.  The last argument ( <b>if_not_exists = true</b> ) allows the system to do nothing if the user already has these rights (more precisely, only allows them to give rights if the user does not have them). <br><br>  Now we need to create some kind of storage.  This is the function <a href="https://tarantool.io/en/doc/1.9/book/box/box_schema/"><b>box.schema.space.create</b></a> .  We transfer to it the name of the repository, the <b>if_not_exists</b> instruction already known to us and the format - in fact, the names of the fields and the types of data stored in them, which are defined by a couple of lines above.  This piece is optional, you can not transfer the format and still work with the database, just access to the fields will not be by name, but by numbers (but you can add new fields in the process). <br><br>  This function returns the created storage object.      :      : <b>box.space.space_name</b> ( <b>box.space.storage</b>   ,     ).  <b>storage:create_index</b>  <b>box.space.storage:create_index</b> . <br><br>  ,  , ,  ,  .    <a href="https://tarantool.io/en/doc/1.9/book/box/box_space/"><b>create_index</b></a>   ,        ,  ‚Äî  (  ),    . ,      serial, ,        " <b>serial</b> " (     ,    ,    1). <br><br>      ,    ‚Äî   Tarantool    . <br><br>  ,    ,       .      : <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save_value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(serial, value)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> timestamp = <span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>() value = <span class="hljs-built_in"><span class="hljs-built_in">tonumber</span></span>(value) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> serial ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> storage:upsert({serial, timestamp, value}, {{<span class="hljs-string"><span class="hljs-string">"="</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, timestamp} , {<span class="hljs-string"><span class="hljs-string">"="</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, value}}) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>     ‚Äî <b>storage:upsert({serial, timestamp, value}, {{"=", 2, timestamp}, {"=", 3, value}})</b> . <br><br> <a href="https://tarantool.io/en/doc/1.9/book/box/box_space/"><b>Upsert</b></a> ‚Äî   <b>update</b>  <b>insert</b> :      ,  <b>insert</b> ,    ‚Äî  <b>update</b> .    ,         <b>insert</b> ( : <b>serial</b> , <b>timestamp</b> , <b>value</b> ),   ‚Äî    <b>update</b> . <br><br>  : <b>serial</b> , <b>timestamp</b>  <b>value</b>    ,     .    ,    .     :   ,     <b>serial</b> ,   ‚Äî <b>timestamp</b> ,    <b>value</b> .           <b>format</b> (. ). <br><br>    :       (   ,        ),    ,        . <br><br>  " <b>{"=", 2, timestamp}</b> " ,         ,     =).      <a href="https://tarantool.io/en/doc/1.9/book/box/box_space/"></a> . ,       ,  XOR/AND,   . <br><br>   ‚Äî    ,      (mqtt      ,      value   <b>number</b> ,       ),      . <br><br>   ,      : <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_values</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> temperature_data_object, i = {}, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, tuple <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> storage:<span class="hljs-built_in"><span class="hljs-built_in">pairs</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> i = i + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> absolute_time_text = <span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>(<span class="hljs-string"><span class="hljs-string">"%Y-%m-%d, %H:%M:%S"</span></span>, tuple[<span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> relative_time_text = (<span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>() - tuple[<span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>])..<span class="hljs-string"><span class="hljs-string">"s ago"</span></span> temperature_data_object[i] = {} temperature_data_object[i].sensor = tuple[<span class="hljs-string"><span class="hljs-string">"serial"</span></span>] temperature_data_object[i].temperature = tuple[<span class="hljs-string"><span class="hljs-string">"value"</span></span>] temperature_data_object[i].update_time_epoch = tuple[<span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>] temperature_data_object[i].update_time_text = absolute_time_text..<span class="hljs-string"><span class="hljs-string">" ("</span></span>..relative_time_text..<span class="hljs-string"><span class="hljs-string">")"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> temperature_data_object <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>     <a href="https://habr.com/company/mailru/blog/374399/"></a> .      <a href="https://www.lua.org/pil/7.3.html">  <b>pairs()</b>     for</a> ,      . <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-built_in"><span class="hljs-built_in">table</span></span> = {<span class="hljs-string"><span class="hljs-string">"test_1"</span></span>,<span class="hljs-string"><span class="hljs-string">"test_2"</span></span>,<span class="hljs-string"><span class="hljs-string">"test_3"</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> key, value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">pairs</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(value) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>      <b>table</b> ,     <b>print()</b> ,        .  Those.    : <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-built_in"><span class="hljs-built_in">table</span></span> = {<span class="hljs-string"><span class="hljs-string">"test_1"</span></span>,<span class="hljs-string"><span class="hljs-string">"test_2"</span></span>,<span class="hljs-string"><span class="hljs-string">"test_3"</span></span>} <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>]) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>]) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>])</code> </pre> <br>    <b>key</b> ,      .      ,       : 1,2,3. <br><br>    Tarantool      <a href="https://tarantool.io/en/doc/1.9/book/box/box_space/"><b>pairs</b></a> (),      : <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, tuple <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> box.space.storage:<span class="hljs-built_in"><span class="hljs-built_in">pairs</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment">-- for body end</span></span></code> </pre> <br>          (),     ()    .  ,  ,    ,          <b>tuple[1]</b> ,   format,    : <b>tuple[¬´name¬ª]</b> .  ,     ( <b>tuple[¬´serial¬ª]</b> ),   ( <b>tuple[¬´value¬ª]</b> )       ( <b>tuple[¬´timestamp¬ª]</b> ). <br><br>   ‚Äî         (   (. key ),     ,         ). <br><br>   .   . <br><br><h3>  </h3>  -    :    .      ,       . : <br><br><pre> <code class="lua hljs">add_row_table(<span class="hljs-string"><span class="hljs-string">"table_values_temp"</span></span>, <span class="hljs-string"><span class="hljs-string">"head"</span></span>, [<span class="hljs-string"><span class="hljs-string">"Sensor serial"</span></span>, <span class="hljs-string"><span class="hljs-string">"Temperature"</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (let index = <span class="hljs-number"><span class="hljs-number">0</span></span>; index &lt; json_data[<span class="hljs-number"><span class="hljs-number">0</span></span>].length; index++) { add_row_table(<span class="hljs-string"><span class="hljs-string">"table_values_temp"</span></span>, <span class="hljs-string"><span class="hljs-string">"body"</span></span>, [json_data[<span class="hljs-number"><span class="hljs-number">0</span></span>][index].sensor, json_data[<span class="hljs-number"><span class="hljs-number">0</span></span>][index].temperature) }</code> </pre> <br>  It became: <br><br><pre> <code class="lua hljs">add_row_table(<span class="hljs-string"><span class="hljs-string">"table_values_temp"</span></span>, <span class="hljs-string"><span class="hljs-string">"head"</span></span>, [<span class="hljs-string"><span class="hljs-string">"Sensor serial"</span></span>, <span class="hljs-string"><span class="hljs-string">"Temperature"</span></span>, <span class="hljs-string"><span class="hljs-string">"Update time"</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (let index = <span class="hljs-number"><span class="hljs-number">0</span></span>; index &lt; json_data[<span class="hljs-number"><span class="hljs-number">0</span></span>].length; index++) { add_row_table(<span class="hljs-string"><span class="hljs-string">"table_values_temp"</span></span>, <span class="hljs-string"><span class="hljs-string">"body"</span></span>, [json_data[<span class="hljs-number"><span class="hljs-number">0</span></span>][index].sensor, json_data[<span class="hljs-number"><span class="hljs-number">0</span></span>][index].temperature, json_data[<span class="hljs-number"><span class="hljs-number">0</span></span>][index].update_time_text]) }</code> </pre> <br>    . <br><br>      : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9eb/fb8/bb5/9ebfb8bb500fb31b140d9a424cfbc503.gif"><br><br> ! <br><br> ,    ,   <a href="https://github.com/vvzvlad/tarantool-iotscada-mailru-gt/tree/bf26c3aea21e68cd184594beec2e34f3413c2776"></a> ,   <b>git checkout bf26c3aea21e68cd184594beec2e34f3413c2776</b> .  <a href="https://github.com/vvzvlad/tarantool-iotscada-mailru-gt/commit/bf26c3aea21e68cd184594beec2e34f3413c2776">DIFF</a> -. <br><br><h2>  :     </h2>       ,     . ,     . <br><br>      . : <br><br><pre> <code class="lua hljs">storage:create_index(<span class="hljs-string"><span class="hljs-string">'serial'</span></span>, {parts = {<span class="hljs-string"><span class="hljs-string">'serial'</span></span>}, if_not_exists = <span class="hljs-literal"><span class="hljs-literal">true</span></span>})</code> </pre> <br>  It became: <br><br><pre> <code class="lua hljs">storage:create_index(<span class="hljs-string"><span class="hljs-string">'timestamp'</span></span>, {parts = {<span class="hljs-string"><span class="hljs-string">'timestamp'</span></span>}, if_not_exists = <span class="hljs-literal"><span class="hljs-literal">true</span></span>}) storage:create_index(<span class="hljs-string"><span class="hljs-string">'serial'</span></span>, {parts = {<span class="hljs-string"><span class="hljs-string">'serial'</span></span>}, unique = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, if_not_exists = <span class="hljs-literal"><span class="hljs-literal">true</span></span>})</code> </pre> <br>    ?      ,     ‚Äî    .     ,         ,   ‚Äî       .                  ,          . <br><br> ,    ,            .   . ,        ,      . <br><br>      <a href="http://conf.tarantool.io/">T++ Conference</a> . <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gen_id</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> new_id = <span class="hljs-built_in"><span class="hljs-built_in">clock</span></span>.realtime()*<span class="hljs-number"><span class="hljs-number">10000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> storage.index.timestamp:get(new_id) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> new_id = new_id + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new_id <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save_value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(serial, value)</span></span></span></span> value = <span class="hljs-built_in"><span class="hljs-built_in">tonumber</span></span>(value) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> serial ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> storage:<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>({serial, gen_id(), value}) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  insert  upsert:     ,   ,  ,           ,   . <br><br>  ,           ,   ,       ,     ‚Äî    . <br><br>      clock,       <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> <span class="hljs-string"><span class="hljs-string">'clock'</span></span></code> </pre> <br>  <b>get_values</b>  : <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_values_for_table</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(serial)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> temperature_data_object, i = {}, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, tuple <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> storage.index.serial:<span class="hljs-built_in"><span class="hljs-built_in">pairs</span></span>(serial) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> i = i + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> time_in_sec = <span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(tuple[<span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>]/<span class="hljs-number"><span class="hljs-number">10000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> absolute_time_text = <span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>(<span class="hljs-string"><span class="hljs-string">"%Y-%m-%d, %H:%M:%S"</span></span>, time_in_sec) temperature_data_object[i] = {} temperature_data_object[i].serial = tuple[<span class="hljs-string"><span class="hljs-string">"serial"</span></span>] temperature_data_object[i].temperature = tuple[<span class="hljs-string"><span class="hljs-string">"value"</span></span>] temperature_data_object[i].time_epoch = tuple[<span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>] temperature_data_object[i].time_text = absolute_time_text <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> temperature_data_object <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>          <b>storage:pairs()</b> ,    ,   ,   : <br><br><pre> <code class="lua hljs">storage.index.serial:<span class="hljs-built_in"><span class="hljs-built_in">pairs</span></span>(serial)</code> </pre> <br>     :    (pairs)    storage,      serial  ,     serial.      ,       . <br><br>       ,       , ,   ,    ,        ,   . <br><br>     :     ,     : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/152/e99/7ec/152e997ecaccd40c2d4f3976239353b8.png"><br><br> ,     .       :        . <br><br><pre> <code class="javascript hljs">&lt;script type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> src=<span class="hljs-string"><span class="hljs-string">"https://www.gstatic.com/charts/loader.js"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;script type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; google.charts.load(<span class="hljs-string"><span class="hljs-string">'current'</span></span>, { <span class="hljs-string"><span class="hljs-string">'packages'</span></span>: [<span class="hljs-string"><span class="hljs-string">'corechart'</span></span>] }); google.charts.setOnLoadCallback(timer_update_graph); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update_graph_callback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> data_b = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(xhr_graph.responseText); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = google.visualization.arrayToDataTable(data_b[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> options = { <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">'Temperatype'</span></span>, <span class="hljs-attr"><span class="hljs-attr">hAxis</span></span>: { <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">'Time'</span></span>, <span class="hljs-attr"><span class="hljs-attr">titleTextStyle</span></span>: { <span class="hljs-attr"><span class="hljs-attr">color</span></span>: <span class="hljs-string"><span class="hljs-string">'#333'</span></span> } }, }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> chart = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> google.visualization.AreaChart(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'chart_div'</span></span>)); chart.draw(data, options); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr_graph = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timer_update_graph</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ xhr_graph.onreadystatechange = update_graph_callback xhr_graph.open(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-string"><span class="hljs-string">'data?data=graph&amp;serial=28-000008e538e6'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xhr_graph.send() setTimeout(timer_update_graph, <span class="hljs-number"><span class="hljs-number">3000</span></span>); } &lt;<span class="hljs-regexp"><span class="hljs-regexp">/script&gt; &lt;div id="chart_div" style="width: 100%; height: 300px;"&gt;&lt;/</span></span>div&gt;</code> </pre> <br> ,  ,    :  JSON c   ,    ,   ,     ,   .    ,           3 . <br><br>  , ,     ,        -,   ,       : <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_values_for_graph</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(serial)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> temperature_data_object, i = {}, <span class="hljs-number"><span class="hljs-number">1</span></span> temperature_data_object[<span class="hljs-number"><span class="hljs-number">1</span></span>] = {<span class="hljs-string"><span class="hljs-string">"Time"</span></span>, <span class="hljs-string"><span class="hljs-string">"Value"</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, tuple <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> storage.index.serial:<span class="hljs-built_in"><span class="hljs-built_in">pairs</span></span>(serial) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> i = i + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> time_in_sec = <span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(tuple[<span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>]/<span class="hljs-number"><span class="hljs-number">10000</span></span>) temperature_data_object[i] = {<span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>(<span class="hljs-string"><span class="hljs-string">"%H:%M"</span></span>, time_in_sec), tuple[<span class="hljs-string"><span class="hljs-string">"value"</span></span>]} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> temperature_data_object <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>     HTTP,        ,      ‚Äî     : <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">http_server_data_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(req)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> params = req:param() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (params[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] == <span class="hljs-string"><span class="hljs-string">"table"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> values = get_values_for_table(params[<span class="hljs-string"><span class="hljs-string">"serial"</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req:render{ json = { values } } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> (params[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] == <span class="hljs-string"><span class="hljs-string">"graph"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> values = get_values_for_graph(params[<span class="hljs-string"><span class="hljs-string">"serial"</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req:render{ json = { values } } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>   : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/242/dad/639/242dad6391dbb3340d65dcdd72e21a51.png"><br><br>  ,       . <br><br> ,    ,   <a href="https://github.com/vvzvlad/tarantool-iotscada-mailru-gt/tree/10ed490333bead9e8aeaa851dc52070050aac68c"></a> ,   <b>git checkout 10ed490333bead9e8aeaa851dc52070050aac68c</b> .  <a href="https://github.com/vvzvlad/tarantool-iotscada-mailru-gt/commit/10ed490333bead9e8aeaa851dc52070050aac68c">DIFF</a> -. <br><br><h2>  Conclusion </h2> ,       ,      Tarantool,     // . ,     ,    .  ,   ,     .  ,       TSDB,   - ‚Äî    Vue. <br><br>        ,        Tarantool     ,   . ,    . <br><br> Tarantool ‚Äî ,    ,   ,  ,  . </div><p>Source: <a href="https://habr.com/ru/post/374399/">https://habr.com/ru/post/374399/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../374389/index.html">Possible future of optical media: 10 TB, 600 years, one disc</a></li>
<li><a href="../374391/index.html">Events in cities on Cosmonautics Day-2018</a></li>
<li><a href="../374393/index.html">Except Lego. What to collect with the child at your leisure: a selection of designers up to 1000 rubles</a></li>
<li><a href="../374395/index.html">How to connect the MD910 matrix printer from the cash register Minik</a></li>
<li><a href="../374397/index.html">This imperfect reality requires correction: a selection of AR-programs</a></li>
<li><a href="../374401/index.html">The story "Ambush"</a></li>
<li><a href="../374403/index.html">What does the Earth look like from space?</a></li>
<li><a href="../374405/index.html">Use Onion Omega2 to create devices with Linux and Wi-Fi</a></li>
<li><a href="../374407/index.html">How to send a letter to the ISS by April 12</a></li>
<li><a href="../374409/index.html">Red Hogwarts. Series 3. Major</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>