<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Java String Internal Representation Changes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 This is my first translation of the article. I decided to dedicate it to Java, oddly enough. This article describes the changes to the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Java String Internal Representation Changes</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  This is my first translation of the article.  I decided to dedicate it to Java, oddly enough.  This article describes the changes to the string data type that occurred in Java. <br><br>  <i>IMPORTANT: In Java 7 update 17, as before, nothing has changed regarding the article.</i> <br><br><h5>  Splitting char [] character array </h5><br>  In the present implementation of the String class, there are 4 instance fields: the char [] value character array contains the string characters, int offset is the index of the first character used in the value array, int count is the number of characters used, and int hash is the cached value of the calculated hash code for this string .  As you can see, in most cases the string will have the values ‚Äã‚Äãoffset = 0 and count = value.length.  The only exception to this rule is possibly when a string is created by calling the viaString.substring method or by any method that uses this method (for example, split). <br><a name="habracut"></a><br>  String.substring creates a string that separates the internal char [] character array with the original string, which allows you to: <br><ol><li>  Save memory using it together; </li><li>  Make the time to make the String.substring method constant (O (1)). </li></ol><br>  At the same time, with such an implementation a memory leak is possible: if you extract a small substring from a large string and you no longer need a large string, you will still have a link to a large array of characters of the original string.  The only way to avoid this is to call the constructor new String (String), which will force you to create a copy of the character array, that is, detach your small string from the large ‚Äúparent‚Äù. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In Java 1.7.0_06, the offset and count fields have been removed from the String class.  This means that we can no longer share an array of characters.  Now we can forget about the memory leaks described above and never use the new String (String) constructor again.  As a drawback, you should always remember that the String.substring method now has linear complexity, unlike the constant that was before. <br><br><h5>  Changes in hashing logic </h5><br>  Another change introduced in the String class in the same update: a new hashing algorithm.  Oracle says the new algorithm gives better distribution of hash codes, which should improve the performance of some hashing-based collections: HashMap, Hashtable, HashSet, LinkedHashSet, WeakHashMap, and ConcurentHashMap.  Unlike the changes described at the beginning of the article, these changes are experimental and are turned off by default. <br><br>  As you probably noticed, these changes are true only for the case when the keys of the collections are strings.  If you want to enable these changes, you must set the value of the jdk.map.althashing.threshold system property to a non-negative value (by default, it is -1).  This value is the threshold of the collection size, after which the new hashing algorithm will be used.  Small correction: the hashing algorithm will be changed only when there is a shortage of memory.  If the collection was redistributed with size = 160 and jdk.map.althashing.threshold = 200, then the hash method will be changed only when the collection size grows to 320. <br><br>  The String class now has a hash32 () method, the result of which is cached in the int field hash32.  The result of the hash32 () method for the same lines may be different for different JVM launches (in fact, it will be almost always different, because it uses System.currentTimeMillis () and two System.nanoTime calls for initial initialization).  As a result, the iteration on the same collection may be different for different program launches.  In fact, I was a little surprised by this method.  Why do we need it if the real implementation of the hashCode method works well enough?  I decided to check how many collisions will be obtained using the hash32 () method.  The String.hash32 () method is not public, but I looked at the implementation of the HashMap class to determine how it calls it.  Answer: sun.misc.Hashing.stringHash32 (String).  On a test containing one million strings, the method yielded 304 collisions, compared to more than one collision using the String.hashCode method.  I think we should wait for further improvements. <br><br><h5>  New hashing logic can seriously affect multi-threaded code </h5><br>  Oracle made a mistake when implementing hashing in the following classes: HashMap, Hashtable, HashSet, LinkedHashSet, WeakHashMap.  Only ConcurentHashMap does not contain this error.  The problem is that all non-parallel classes now have a field: <br><br><pre><code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** *            . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">transient</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> hashSeed = sun.misc.Hashing.randomHashSeed(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);</code> </pre> <br>  This means that each time the above collections are created, the sun.misc.Hashing.randomHashSeed method will be called.  In turn, the randomHashSeed method calls the java.util.Random.nextInt method.  As you know, the Random class is not very friendly with multithreading: it contains the private final AtomicLong seed field.  Atomics work well with average load, but bad with a large load. <br><br>  As a result, many high-load web applications processing HTTP / JSON / XML can be affected by this error, because almost all known parsers (analyzers) use at least one of the affected classes.  All these parsers can create nested map collections, which will increase the number of created map collections per second. <br><br><h5>  How to solve this problem? </h5><br>  1. ConcurrentHashMap path: call the randomHashSeed method only when the jdk.map.althashing.threshold system property is defined.  However, this is only available for kernel JDK developers. <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** *            . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">transient</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> hashSeed = randomHashSeed(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">randomHashSeed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConcurrentHashMap instance)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sun.misc.VM.isBooted() &amp;&amp; Holder.ALTERNATIVE_HASHING) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sun.misc.Hashing.randomHashSeed(instance); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br>  2. Hacker path: change class sun.misc.Hashing.  It is not recommended.  If you do decide to do this, you can do this: the java.util.Random class is not final.  You can extend it and override its nextInt method by returning, for example, a constant value.  Then you need to change the sun.misc.Hashing.Holder.SEED_MAKER field by setting it to your class inherited from Random.  Do not worry that this field is private, static and final - a reflection will help you. <br><br><h5>  Summary </h5><br><ul><li>  Starting with Java 1.7.0_06, the String.substring method always creates a new array of char [] characters for each string it creates.  This means that now this method has linear complexity in comparison with the constant one as in previous versions.  As a result of this change, the string takes 4 bytes less than before, and memory leaks caused by the String.substring method are guaranteed to be eliminated. </li><li>  Starting from the same update, the second method for hashing, called hash32, appeared in the String class.  This method is not public and can be accessed without reflection only through a call to the sun.misc.Hashing.stringHash32 (String) method.  This method is used in JDK 7 hashing-based collections if their size exceeds the value of the jdk.map.althashing.threshold system property.  This is an experimental method, and I do not recommend using it in your code. </li><li>  Starting with Java 1.7.0_06, all standard non-threaded collections have an undesirable side effect caused by the new hashing algorithm.  This error manifests itself only in multi-threaded applications that create multiple map collections per second. </li></ul><br><h5>  Push </h5><br>  The fact that strings in Java separated an array of characters indicates that they were persistent.  As is well known, persistent structures are structures that retain all their previous versions when they change.  This was done explicitly, as an optimization to reduce the amount of memory used + to make the substring method run time constant.  However, the benefits of this optimization are not so great, which is why this idea was abandoned in version 7 of Java. <br><br>  In .NET, the strings were initially not persistent.  Here is a <a href="http://blogs.msdn.com/b/ruericlippert/archive/2011/08/08/strings-immutability-and-persistence.aspx">link</a> to an interesting article by Eric Lippert in which he explained in detail why this is so. <br><br>  Thanks for reading. <br>  I hope the article was helpful. </div><p>Source: <a href="https://habr.com/ru/post/178409/">https://habr.com/ru/post/178409/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../178393/index.html">Implementing API Call Interception</a></li>
<li><a href="../178401/index.html">Processing and classification of requests. Part Three: Correcting Typos</a></li>
<li><a href="../178403/index.html">Add Web API for a C ++ program using the POCO library</a></li>
<li><a href="../178405/index.html">Correctly free up resources in java</a></li>
<li><a href="../178407/index.html">Automate Web Application Testing</a></li>
<li><a href="../178415/index.html">The company AMLogic is preparing to release a new single-chip platform - AML8726-M8</a></li>
<li><a href="../178417/index.html">How do startups get into accelerator</a></li>
<li><a href="../178423/index.html">"Terminating" sms-spam</a></li>
<li><a href="../178425/index.html">How we made a smart office lighting system: compare two floors</a></li>
<li><a href="../178427/index.html">uptodate.js is a library for auto updating time elements</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>