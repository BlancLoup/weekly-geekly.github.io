<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reliable localStorage for bookmarklets</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Unlike extensions, bookmarklets are good in simplicity and cross-browser compatibility. Of course, they are limited to the context of the window (page...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reliable localStorage for bookmarklets</h1><div class="post__text post__text-html js-mediator-article"> Unlike extensions, <a href="https://en.wikipedia.org/wiki/Bookmarklet">bookmarklets</a> are good in simplicity and cross-browser compatibility.  Of course, they are limited to the context of the window (page content), but often this is enough.  And with the advent of the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Storage"><code>localStorage</code></a> mechanism, they had an easy way to save and request data on the client side. <br><a name="habracut"></a><br>  For example, I use such a simple bookmarklet to keep intermediate ‚Äúbookmarks‚Äù for places in long articles that cannot be read in one sitting. <br><br><pre> <code class="javascript hljs">javascript:(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">d, scrT</span></span></span><span class="hljs-function">)</span></span>{ scrT = d.documentElement.scrollTop || d.body.scrollTop; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (scrT) { localStorage[<span class="hljs-string"><span class="hljs-string">'bmk_'</span></span> + d.location.href] = scrT; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { scrollTo(<span class="hljs-number"><span class="hljs-number">0</span></span>, localStorage[<span class="hljs-string"><span class="hljs-string">'bmk_'</span></span> + d.location.href] || <span class="hljs-number"><span class="hljs-number">0</span></span>); } })(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>)</code> </pre><br>  The same bookmarklet works at the same time to save the reading place and to go to it.  If the page is just loaded or is in the initial scrolling state (for example, the <code>Home</code> key was pressed), the bookmarklet assumes that we need to go to the previously saved place, tries to extract it from <code>localStorage</code> and scroll to the page.  If the page is already scrolled, the bookmarklet retains the current scrolling state. <br><br>  If the size and resolution of the monitor, the size of the browser window and the size of its main part (minus the sidebar and toolbars) do not change, the page scale and main structure do not change - the program works like a clock.  That is, in most cases, its simplicity can be relied upon. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      However, sites treat their <code>localStorage</code> .  Some do not use it at all.  Some use actively, but only change or delete keys that they themselves create (for example, Twitter).  But there are absolute monarchs: let's say, Facebook periodically completely clears its <code>localStorage</code> , most likely <code>localStorage.clear()</code> method.  Of course, there is nothing to reproach the latter type of sites - they are sovereign owners in this area and do not have to reckon with the fact that someone else may want to take advantage of their property. <br><br>  How to protect yourself in such cases?  Of course, you can go to <a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API"><code>IndexedDB</code></a> (if the site doesn‚Äôt clear it again) or write an extension (Google Chrome allocates its <code>localStorage</code> to extensions, Firefox doesn‚Äôt allow it, but provides its own way of storing data in the general settings database) simple cases to use such complex tools is not very handy. <br><br>  Unfortunately, it will not be possible to use <code>localStorage</code> belonging to internal frames of the page, if such are found: this will not allow us to make the <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy">principle of the same source</a> . <br><br>  However, there is a way out - clumsy at first glance, but in practice it is quite simple and convenient, if you adjust everything once and stock up on templates for all occasions. <br><br>  The <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window.postMessage"><code>Window.postMessage</code></a> technology will help us.  We just need to create a tiny web page, like this: <br><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!doctype html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UTF-8"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="javascript"><span class="hljs-function"><span class="hljs-title">processMessage</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">event</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">if</span></span></span><span class="javascript"> (event.data.action == </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'get'</span></span></span><span class="javascript">) { event.source.postMessage(localStorage[event.data.key], event.origin); } </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">else</span></span></span><span class="javascript"> { localStorage[event.data.key] = event.data.value; } } </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.addEventListener(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'message'</span></span></span><span class="javascript">, processMessage, </span><span class="hljs-literal"><span class="javascript"><span class="hljs-literal">false</span></span></span><span class="javascript">); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Then put it on any hosting that supports the <code>http:</code> and <code>https:</code> protocols ‚Äî for example, on <a href="https://help.github.com/categories/github-pages-basics/">GitHub Pages</a> , which are accessible to all registered users.  After that, we can embed this page as an internal frame into any document, establish communication with it from the main document window, in the context of which the bookmarklet works, and use it as a proxy server between the bookmarklet and <code>localStorage</code> this very page, that is, almost like a small server Database. <br><br>  Unfortunately, it‚Äôs impossible to embed a local page for these needs due to security restrictions, but loading such a small page happens completely unnoticed, even if it is not cached. <br><br>  It remains to remake our bookmarklet for a new method.  The size, of course, will grow from nine lines to almost forty (with readable formatting), but still the code will remain fairly simple.  Working with a bookmarklet for the user will not change at all. <br><br><pre> <code class="javascript hljs">javascript:(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">d, mySt, scrT</span></span></span><span class="hljs-function">)</span></span>{ scrT = d.documentElement.scrollTop || d.body.scrollTop; mySt.origin = d.location.protocol + <span class="hljs-string"><span class="hljs-string">'//user.github.io'</span></span>; mySt.URL = mySt.origin + <span class="hljs-string"><span class="hljs-string">'/storage/storage.html'</span></span>; mySt.iframe = d.querySelector(<span class="hljs-string"><span class="hljs-string">'iframe#myStorageIframe'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mySt.iframe) { mySt.iframe.contentWindow.postMessage( scrT ? {<span class="hljs-string"><span class="hljs-string">'action'</span></span>: <span class="hljs-string"><span class="hljs-string">'set'</span></span>, <span class="hljs-string"><span class="hljs-string">'key'</span></span>: <span class="hljs-string"><span class="hljs-string">'bmk_'</span></span> + d.location.href, <span class="hljs-string"><span class="hljs-string">'value'</span></span>: scrT} : {<span class="hljs-string"><span class="hljs-string">'action'</span></span>: <span class="hljs-string"><span class="hljs-string">'get'</span></span>, <span class="hljs-string"><span class="hljs-string">'key'</span></span>: <span class="hljs-string"><span class="hljs-string">'bmk_'</span></span> + d.location.href}, mySt.origin ); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event.origin == mySt.origin) { scrollTo(<span class="hljs-number"><span class="hljs-number">0</span></span>, event.data || <span class="hljs-number"><span class="hljs-number">0</span></span>); } } addEventListener(<span class="hljs-string"><span class="hljs-string">'message'</span></span>, processMessage, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); mySt.iframe = d.body.appendChild(d.createElement(<span class="hljs-string"><span class="hljs-string">'iframe'</span></span>)); mySt.iframe.style.display = <span class="hljs-string"><span class="hljs-string">'none'</span></span>; mySt.iframe.id = <span class="hljs-string"><span class="hljs-string">'myStorageIframe'</span></span>; mySt.iframe.src = mySt.URL; mySt.iframe.addEventListener(<span class="hljs-string"><span class="hljs-string">'load'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ mySt.iframe.contentWindow.postMessage( scrT ? {<span class="hljs-string"><span class="hljs-string">'action'</span></span>: <span class="hljs-string"><span class="hljs-string">'set'</span></span>, <span class="hljs-string"><span class="hljs-string">'key'</span></span>: <span class="hljs-string"><span class="hljs-string">'bmk_'</span></span> + d.location.href, <span class="hljs-string"><span class="hljs-string">'value'</span></span>: scrT} : {<span class="hljs-string"><span class="hljs-string">'action'</span></span>: <span class="hljs-string"><span class="hljs-string">'get'</span></span>, <span class="hljs-string"><span class="hljs-string">'key'</span></span>: <span class="hljs-string"><span class="hljs-string">'bmk_'</span></span> + d.location.href}, mySt.origin ); }); } })(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>, {})</code> </pre><br>  The main principle remains the same: the bookmarklet analyzes the scrolling state, retrieves the bookmark in its initial position and goes over it, saves the state in the intermediate scrolling position. <br><br>  The changes are as follows. <br><br>  First, the bookmarklet creates a <code>mySt</code> (myStorage) service object with three properties: <code>origin</code> - to provide the interface with the necessary information about the source of the addressee, <code>URL</code> (based on the previous property) - to set the full address for the frame, and <code>iframe</code> - to reference the frame itself.  Since the pages with the <code>https:</code> protocol do not allow to embed a page with the usual protocol, at the first stage we determine the current protocol and, depending on it, create the <code>origin</code> and <code>URL</code> properties (in the example, an invalid conditional URL is given, the ‚Äúuser‚Äù will need to be replaced by real username if the page will be posted on this site). <br><br>  Then the bookmarklet checks whether our mediation page is already built in (if we have read this article for some time and have saved bookmarks before, without closing the window, just in case or temporarily leaving, it is quite possible that the frame is already embedded and need to repeat the insert).  If the page is embedded, we immediately proceed to the communication: either we send the key and the value to save, or we request the value of the previously saved key.  Since the communication is asynchronous, we have nothing more to do - even if we requested a value, the response will be picked up by the handler that we hung up earlier when we embedded the frame (see further about it). <br><br>  If there is no frame, then we take the following steps. <br><br>  1. For the future, we hang up on the main document the processor of the answers of our future intermediary window. <br>  2. We build the window itself and hide it so as not to interfere. <br>  3. We hang a one-time download handler on the intermediary window to start communication when our proxy is ready.  In this handler, we will perform the same actions as in the previously described case, when a ready mediation page is detected. <br><br>  The code does not in any way claim to the standards, library universality and purity, I'm not a professional programmer.  So any corrections and warnings will be greatly appreciated. <br><br>  In the meantime, the work of the bookmarklet has been successfully tested on the latest versions of Firefox (Nightly), Google Chrome (Canary), Internet Explorer (11). </div><p>Source: <a href="https://habr.com/ru/post/249949/">https://habr.com/ru/post/249949/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249929/index.html">Random maze on js in you know how many lines</a></li>
<li><a href="../249931/index.html">EMC VMAX 3: Enterprise Data Management Platform</a></li>
<li><a href="../249933/index.html">Automating Storage Infrastructure with ViPR Controller: IT as a Service in Action</a></li>
<li><a href="../249939/index.html">A little more reverse engineering of UEFI PEI modules on another useful example</a></li>
<li><a href="../249945/index.html">Automate backup tasks with vCenter Orchestrator via Veeam Restful API</a></li>
<li><a href="../249951/index.html">TheRole 3. Authorization for Ruby on Rails</a></li>
<li><a href="../249953/index.html">Freeloot: is freelance free?</a></li>
<li><a href="../249955/index.html">Survey online courses in mathematics</a></li>
<li><a href="../249957/index.html">HTTP / 2 (h2-14, spdy4) in Google Chrome 40</a></li>
<li><a href="../249959/index.html">Snapshot Hunter Snapshot Detector - Veeam Backup & Replication v8 integrated functionality</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>