<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to recognize a text with a photo: new possibilities of the Vision framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Now the Vision framework is able to recognize the text for real, and not as before. We look forward to when we can apply it in Dodo IS. In the meantim...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to recognize a text with a photo: new possibilities of the Vision framework</h1><div class="post__text post__text-html js-mediator-article">  Now the Vision framework is able to recognize the text for real, and not as before.  We look forward to when we can apply it in Dodo IS.  In the meantime, translation of an article on the recognition of cards from the Magic The Gathering board game and the retrieval of textual information from them. <br><br><img src="https://habrastorage.org/webt/2l/xs/d5/2lxsd5kor2fezmc7qsrvgnzf7tm.png"><br><a name="habracut"></a><br><br>  For the first time, the Vision framework was introduced to the general public at WWDC in 2017, along with iOS 11. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Vision was created to help developers classify and identify objects, horizontal planes, barcodes, facial expressions, and text. <br><br>  However, there was a problem with text recognition: Vision could find a place where the text is located, but actual text recognition did not occur.  Of course, it was nice to see the bounding box around the individual text fragments, but then they had to be pulled out and recognized independently. <br><br>  This problem was solved in the Vision update, which was included in iOS 13. Now the Vision framework provides true text recognition. <br><br>  To test this, I created a very simple application that can recognize the card from the Magic The Gathering board game and extract text information from it: <br><br><ul><li>  card name; </li><li>  release code; </li><li>  collection number (it‚Äôs an index). </li></ul><br>  Here is an example of a map and selected text that I would like to receive. <br><br><img src="https://habrastorage.org/webt/yt/je/_1/ytje_1zq4exjtvj_srlty1e7wb0.png"><br><br>  Looking at the card you might think: "This text is rather small, plus there is a lot of other text on the card that can interfere."  But for Vision this is not a problem. <br><br>  First we need to create a <code>VNRecognizeTextRequest</code> .  In essence, this is a description of what we hope to recognize, plus setting up a recognition language and level of accuracy: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> request = <span class="hljs-type"><span class="hljs-type">VNRecognizeTextRequest</span></span>(completionHandler: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.handleDetectedText) request.recognitionLevel = .accurate request.recognitionLanguages = [<span class="hljs-string"><span class="hljs-string">"en_GB"</span></span>]</code> </pre> <br>  The completion block has the form <code>handleDetectedText(request: VNRequest?, error: Error?)</code> .  We pass it to the <code>VNRecognizeTextRequest</code> constructor and then set the remaining properties. <br><br>  There are two levels of recognition accuracy: <code>.fast</code> and <code>.accurate</code> .  Since our card has a rather small text at the bottom, I chose a higher accuracy.  The fast version is more likely to be better for large amounts of text. <br><br>  I have limited recognition to British English, since all my cards are on it. You can specify several languages, but you need to understand that scanning and recognition can take a little longer for each additional language. <br>  There are two more properties worth mentioning: <br><br><ul><li>  <code>customWords</code> : you can add an array of strings to be used over the built-in lexicon.  This is useful if there are any unusual words in your text.  I did not apply an option for this project.  But if I made a commercial recognition app for Magic The Gathering cards, I would add some of the most complex cards (for example, <a href="https://scryfall.com/card/war/50/fblthp-the-lost">Fblthp, the Lost</a> ) to avoid problems. </li><li>  <code>minimumTextHeight</code> : this is the float value.  It indicates the size relative to the height of the image at which the text should no longer be recognized.  If I created this scanner to just get the name of the card, it would be useful to remove all other text that is not needed.  But I need the smallest pieces of text, so for now I have ignored this property.  Obviously, when ignoring small texts, the recognition rate will be higher. </li></ul><br>  Now that we have our request, we need to pass it along with the image to the request handler: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> requests = [textDetectionRequest] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> imageRequestHandler = <span class="hljs-type"><span class="hljs-type">VNImageRequestHandler</span></span>(cgImage: cgImage, orientation: .<span class="hljs-keyword"><span class="hljs-keyword">right</span></span>, options: [:]) <span class="hljs-type"><span class="hljs-type">DispatchQueue</span></span>.global(qos: .userInitiated).async { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> imageRequestHandler.perform(requests) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> error { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Error: \(error)"</span></span>) } }</code> </pre> <br>  I use the image directly from the camera, converting it from a <code>UIImage</code> to a <code>CGImage</code> .  This is used in the <code>VNImageRequestHandler</code> along with the orientation flag to help the processor understand which text it should recognize. <br><br>  As part of this demo, I use the phone only in portrait orientation.  So naturally, I add the <code>.right</code> orientation.  So, the layouts! <br><br>  It turns out that the orientation of the camera on your device is completely separated from the rotation of the device and is always considered to be on the left (as was the default in 2009, you need to keep your phone in landscape orientation to take photos).  Of course, times have changed, and we mostly take photos and videos in portrait orientation format, but the camera is still aligned to the left. <br><br>  As soon as our handler is configured, we move to the stream with the priority <code>.userInitiated</code> and try to execute our queries.  You may notice that this is an array of queries.  This happens because you can try to pull out several pieces of data in one pass (that is, identify faces and text from the same image).  If there are no errors, the callback created using our query will be called after the text is found: <br><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleDetectedText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: VNRequest?, error: Error?)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> error = error { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"ERROR: \(error)"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> results = request?.results, results.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"No text found"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> result <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> results { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> observation = result <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>? <span class="hljs-type"><span class="hljs-type">VNRecognizedTextObservation</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> text <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> observation.topCandidates(<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(text.string) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(text.confidence) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(observation.boundingBox) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>) } } } }</code> </pre> <br>  Our handler returns our query, which now has a results property.  Each result is a <code>VNRecognizedTextObservation</code> , which for us has several options for the result (hereinafter - candidates). <br><br>  You can get up to 10 candidates for each unit of recognized text, and they are sorted in descending order of confidence.  This can be useful if you have certain terminology that the parser does not correctly recognize on the first attempt.  But determines correctly later, even if he is less confident in the correctness of the result. <br><br>  In this example, we need only the first result, so we go through the cycle of <code>observation.topCandidates(1)</code> and extract both text and confidence.  While the candidate himself has different text and confidence, the <code>.boundingBox</code> remains the same.  <code>.boundingBox</code> uses a normalized coordinate system with the origin in the lower left corner, so if it is to be used later in UIKit, for your own convenience it should be converted. <br><br>  This is almost all you need.  If I run a <a href="">photo of the card</a> through this, I will get the following result in less than 0.5 seconds on the iPhone XS Max: <br><br><pre> <code class="markdown hljs">Carnage Tyrant 1.0 (0.2654155572255453, 0.6955686092376709, 0.18710780143737793, 0.019915008544921786) Creature 1.0 (0.26317582130432127, 0.423814058303833, 0.09479101498921716, 0.013565015792846635) Dinosaur 1.0 (0.3883238156636556, 0.42648010253906254, 0.10021591186523438, 0.014479541778564364) Carnage Tyrant can't be countered. 1.0 (0.26538230578104655, 0.3742666244506836, 0.4300231456756592, 0.024643898010253906) Trample, hexproof 0.5 (0.2610074838002523, 0.34864263534545903, 0.23053167661031088, 0.022259855270385653) Sun Empire commanders are well versed 1.0 (0.2619712670644124, 0.31746063232421873, 0.45549616813659666, 0.022649812698364302) in advanced martial strategy. Still, the 1.0 (0.2623249689737956, 0.29798884391784664, 0.4314465204874674, 0.021180248260498136) correct maneuver is usually to deploy the 1.0 (0.2620727062225342, 0.2772137641906738, 0.4592740217844645, 0.02083740234375009) giant, implacable death lizard. 1.0 (0.2610833962758382, 0.252408218383789, 0.3502468903859457, 0.023736238479614258) 7/6 0.5 (0.6693102518717448, 0.23347826004028316, 0.04697717030843107, 0.018937730789184593) 179/279 M 1.0 (0.24829587936401368, 0.21893787384033203, 0.08339192072550453, 0.011646795272827193) XLN: EN N YEONG-HAO HAN 0.5 (0.246867307027181, 0.20903720855712893, 0.19095951716105145, 0.012227916717529319) TN &amp; 0 2017 Wizards of the Coast 1.0 (0.5428387324015299, 0.21133480072021482, 0.19361832936604817, 0.011657810211181618)</code> </pre> <br><blockquote>  This is incredible!  Each piece of text was recognized, placed in its own bounding box and returned as a result with a trust rating of 1.0. </blockquote><br>  Even a very small copyright is basically correct.  All this was done on the image of 3024x4032, weighing 3.1 MB.  The process would be even faster if I first reduced the image.  It is also worth noting that this process is much faster on new bionic A12 chips that have a special neural engine. <br><br>  When the text is recognized, the last thing to do is to pull the information I need.  I will not put all the code here, but the key logic is to go over each <code>.boundingBox</code> determine a location so that I can select the text in the lower left corner and in the upper left corner, ignoring anything further to the right. <br><blockquote>  The end result was an application scanning the card and returning the result to me in less than one second. </blockquote><br>  PS In fact, I need only a release code and a collection number (also known as an index).  Then they can be used in the Scryfall service API to obtain all possible information about this map, including the rules of the game and the cost. <br><br><img src="https://habrastorage.org/webt/om/gp/hr/omgphr0qi2qla1vyp_0cyqdsdfs.png"><br><br>  A sample application is available on <a href="https://github.com/bendodson/MTG-VNRecognizeTextRequest">GitHub</a> . </div><p>Source: <a href="https://habr.com/ru/post/459668/">https://habr.com/ru/post/459668/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459650/index.html">How not to lose money in a black box: billing testing methods</a></li>
<li><a href="../459652/index.html">Automated regression testing approach</a></li>
<li><a href="../459656/index.html">OData service without writing code</a></li>
<li><a href="../45966/index.html">MySQL file storage and distribution</a></li>
<li><a href="../459662/index.html">PVS-Studio wanted, but could not find bugs in robots.txt</a></li>
<li><a href="../45967/index.html">Problem when using OutputCache in CustomControl</a></li>
<li><a href="../459670/index.html">GOTO Amsterdam</a></li>
<li><a href="../459672/index.html">Python underline</a></li>
<li><a href="../459674/index.html">Epic Intelligence Intelligence Saga</a></li>
<li><a href="../45968/index.html">widget do it yourself</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>