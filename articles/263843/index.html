<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Acceleration of image processing in Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The central processors and graphics cores of modern Android devices are capable of much. For example, their computing power can be directed to image p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Acceleration of image processing in Android</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/company/intel/blog/263843/"><img src="https://habrastorage.org/getpro/habr/post_images/036/999/742/036999742f81132d6dd77132016b4907.jpg" alt="image" align="left"></a>  The central processors and graphics cores of modern Android devices are capable of much.  For example, their computing power can be directed to image processing. <br><br>  In order to do this, you should pay attention to the technology OpenCL and RenderScript. <br><br>  This material describes an example of an Android application, which shows high-performance image processing techniques using the programming languages <a href="https://www.khronos.org/opencl/">OpenCL</a> and <a href="http://developer.android.com/guide/topics/renderscript/compute.html">RenderScript</a> .  These technologies are designed with a view to the possibility of graphics hardware designed for parallel data processing (shader units).  They allow you to speed up work with significant amounts of data and solving problems involving a large number of command repetitions.  Although, to speed up graphics processing in Android applications, you can use other technologies, this material discusses examples of building the application infrastructure and the implementation of graphical algorithms on OpenCL and RenderScript.  It also covers the wrapper class for the OpenCL API, which allows you to simplify the creation and execution of applications that work with graphics and use OpenCL.  Using source code of this class in your projects does not require licensing. <br><a name="habracut"></a><br>  In preparing this material, it was assumed that his readers are familiar with the technologies OpenCL and RenderScript, and are proficient in programming techniques for the Android platform.  Therefore, we will focus on consideration of mechanisms for accelerating processing or programmatically creating images. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In order to see the examples in the case, you need an Android device that is configured so that it can execute the OpenCL code.  Below we will talk about how to organize a working environment for OpenCL development using Intel INDE and Android Studio. <br><br>  Please note that the purpose of this article is to show the features of the OpenCL and RenderScript code, we are not talking about other technologies here.  In addition, a material is planned on analyzing the performance of applications using OpenCL and RenderScript code, which is executed on video chips (GPU). <br><br><h2>  <font color="#0071c5">1.1 Application Interface</font> </h2><br>  On the screen of the application in question, there are three switches with which you can choose between imaging subsystems using RenderScript, OpenCL or Android machine code.  The menu allows you to switch between the execution of OpenCL code on a CPU (central processing unit) or on a GPU (graphic core).  In addition, you can select a graphic effect from the menu.  Target device selection is available only for OpenCL code.  The Intel x86 platform supports running OpenCL on both the CPU and the GPU. <br><br>  Below you can see the main screen of the application, which displays the effect of plasma, which is generated by means of OpenCL. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/54d/6d1/c83/54d6d1c830e5fa7112c0478eb5657299.png"><br>  <i><font color="#999999">The main program window, the choice of the target device for the execution of OpenCL-code</font></i> <br><br>  Performance indicators are displayed in the upper right corner of the window.  They are displayed for all three methods of working with graphics supported by the program. <br><br>  Performance indicators include the number of frames per second (FPS), the frame rendering time (frame render) and the time it takes to calculate the effect (effect compute elapsed time). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/22c/901/fa9/22c901fa955f13806effe6f2d6a46716.png"><br>  <i><font color="#999999">Performance indicators</font></i> <br><br>  Please note that this is just one example of performance.  Indicators depend on the device on which the code is run. <br><br><h2>  <font color="#0071c5">1.2.</font>  <font color="#0071c5">APIs and SDKs used</font> </h2><br>  In addition to the ADT (Android Development Tool, Android development tools that include the Android SDK), the sample development used the RenderScript SDK and the Intel OpenCL SDK designed to work in the Android environment. <br><br>  Intel OpenCL SDK is based on the OpenCL specification and adheres to its provisions.  This specification is an open, free-to-use cross-platform development standard.  Details are on the <a href="https://www.khronos.org/opencl/">Khronos</a> website. <br><br>  RenderScript appeared in ADT 2.2.  (API Level 8).  It is a platform for performing high-performance computing in the Android environment.  RenderScript is mainly designed to perform tasks that allow parallel execution of calculations, however, it can also be used to benefit from calculations that are performed sequentially.  <a href="http://developer.android.com/guide/topics/renderscript/compute.html">Here</a> you can find out more about RenderScript. <br><br>  The latest version of ADT, available from Google‚Äôs open repository, includes packages that need to be imported in order to use RenderScript, JNI (Java Native Interface, Machine Code Java Interface) and a set of runtime APIs. <br><br>  You can find more information about developing using RenderScript <a href="http://developer.android.com/guide/topics/renderscript/reference.html">here</a> , OpenCL materials - <a href="https://software.intel.com/en-us/intel-opencl">here</a> . <br><br><h2>  <font color="#0071c5">1.3 Application Support Infrastructure Code</font> </h2><br>  The infrastructure of the considered application consists of the main Activity and auxiliary functions.  Here we look at these functions and the code used to configure the user interface, select a graphical effect, and for OpenCL, select the computing device that should be used. <br><br>  Here are two main auxiliary functions. <br><br>  The first, <i>backgroundThread ()</i> , starts a separate thread of execution, from which a function is periodically called that performs a step-by-step application of the graphic effect.  This function is taken from the application, which is discussed in the <a href="https://software.intel.com/en-us/articles/renderscript-basic-sample-for-android-os">Getting Started with RenderScript</a> , details about this example can be found <a href="https://software.intel.com/sites/default/files/managed/36/bc/AndroidBasicRenderScript_0.pdf">here</a> . <br><br>  The second function, <i>processStep ()</i> , is called from <i>backgroundThread ().</i>  She <i>,</i> in turn, calls the commands for image processing.  The function relies on the state of the switches to determine which algorithm implementation to use.  In the <i>processStep ()</i> function, depending on the state of the settings, methods are invoked for image processing using OpenCL, RenderScript or plain machine code written in C / C ++.  Since this code is executed in a background thread, the user interface is not blocked, so you can switch between implementations of graphical algorithms at any time.  When the user selects an effect, the application immediately switches to it. <br><br><pre><code class="hljs haskell">//  processStep()    () . private void processStep() { try { switch (this.<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">.getCheckedRadioButtonId()) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type_renderN</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">oclFlag</span></span></span><span class="hljs-class"> = 0; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenCL</span></span></span><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stepRenderNative</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">break</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type_renderOCL</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">oclFlag</span></span></span><span class="hljs-class"> = 1; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenCL</span></span></span><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stepRenderOpenCL</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">break</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type_renderRS</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">oclFlag</span></span></span><span class="hljs-class"> = 0; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpenCL</span></span></span><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stepRenderScript</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">break</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class">; } } catch (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RuntimeException</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ex</span></span></span><span class="hljs-class">) { //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wtf</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Android</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Image</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Processing</span></span></span><span class="hljs-class">", "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">render</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">failed</span></span></span><span class="hljs-class">", </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ex</span></span></span><span class="hljs-class">); } }</span></span></code> </pre> <br><h2>  <font color="#0071c5">1.4 Definition of functions implemented in native code in Java</font> </h2><br>  The application in <i>question</i> implements the <i>NativeLib</i> class, which defines the functions used to invoke machine-level commands using JNI that implement graphic effects.  The appendix shows three effects: the plasma effect (plasma), toning the image in sepia (sepia) and bleaching (monochrome).  Accordingly, the class defines the <i>renderPlasma (...)</i> , <i>renderSepia (...)</i> and <i>renderMonoChrome (...) functions</i> .  These Java functions play the role of JNI entry points, by means of which either the functionality implemented in the machine code or the OpenCL version of the graphical algorithms is called. <br><br>  The corresponding JNI function, when running a selected graphic effect, either executes code written in C / C ++, or sets up and executes a program on OpenCL.  The described class uses the <i>android.graphics.Bitmap</i> and <i>android.content.res.AssetManager</i> packages.  <i>Bitmap</i> objects <i>are</i> used to send graphic data to the processing subsystem and to get results.  An application uses an object of the <i>AssetManager</i> class to access OpenCL files (sepia.cl, for example).  These files describe OpenCL kernels (kernels), which are functions that implement graphical algorithms. <br><br>  Below is the code for the <i>NativeLib</i> class.  It can be easily expanded to add additional graphical effects, as indicated by the comment // TODO. <br><br><pre> <code class="hljs pgsql">package com.example.imageprocessingoffload; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.res.AssetManager; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.graphics.Bitmap; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> NativeLib { //   libimageeffects.so <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static native <span class="hljs-type"><span class="hljs-type">void</span></span> renderPlasma(Bitmap bitmapIn, <span class="hljs-type"><span class="hljs-type">int</span></span> renderocl, long time_ms, String eName, <span class="hljs-type"><span class="hljs-type">int</span></span> devtype, AssetManager mgr); <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static native <span class="hljs-type"><span class="hljs-type">void</span></span> renderMonoChrome(Bitmap bitmapIn, Bitmap bitmapOut, <span class="hljs-type"><span class="hljs-type">int</span></span> renderocl, long time_ms, String eName, <span class="hljs-type"><span class="hljs-type">int</span></span> simXtouch, <span class="hljs-type"><span class="hljs-type">int</span></span> simYtouch, <span class="hljs-type"><span class="hljs-type">int</span></span> radHi, <span class="hljs-type"><span class="hljs-type">int</span></span> radLo, <span class="hljs-type"><span class="hljs-type">int</span></span> devtype, AssetManager mgr); <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static native <span class="hljs-type"><span class="hljs-type">void</span></span> renderSepia(Bitmap bitmapIn, Bitmap bitmapOut, <span class="hljs-type"><span class="hljs-type">int</span></span> renderocl, long time_ms, String eName, <span class="hljs-type"><span class="hljs-type">int</span></span> simXtouch, <span class="hljs-type"><span class="hljs-type">int</span></span> simYtouch, <span class="hljs-type"><span class="hljs-type">int</span></span> radHi, <span class="hljs-type"><span class="hljs-type">int</span></span> radLo, <span class="hljs-type"><span class="hljs-type">int</span></span> devtype, AssetManager mgr); //TODO <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static native &lt;<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>&gt; render&lt;Effectname&gt;(‚Ä¶); //  static { <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.loadLibrary("imageeffectsoffloading"); } }</code> </pre> <br>  Notice that the Android objects <i>AssetManager</i> and <i>BitMap</i> are passed to the machine code as input and output parameters.  The <i>AssetManager</i> object <i>is</i> used by machine code to access CL files that describe OpenCL kernels.  The <i>BitMap</i> object contains pixel data that is processed in native code.  The same data type is used to return the processing result. <br><br>  The <i>deviceType</i> user interface <i>parameter</i> is used to specify the target device on which the OpenCL code will be executed - CPU or GPU.  To achieve this flexibility, the Android OS must be properly configured.  Modern Intel Atom and Intel Core processors can execute OpenCL instructions both independently and using graphics chips embedded in the system. <br><br>  The <i>eName</i> parameter specifies which OpenCL kernel to compile and run.  In the application, each graphic effect has its own JNI function; as a result, the transfer of the kernel name may seem unnecessary.  However, in one CL-file (the same applies to the JNI-function) you can encode several similar graphical algorithms.  In this situation, the <i>eName</i> parameter could be used to indicate which particular CL program (or kernel) needs to be compiled and loaded. <br><br>  The <i>renderocl</i> parameter plays the role of a flag indicating whether to execute OpenCL code or machine code written in C / C ++.  Its value is interpreted as true if the user has activated the OpenCL switch, otherwise the flag remains unchecked. <br><br>  The <i>time_ms</i> parameter <i>is</i> used to transmit the timestamp (in milliseconds), which is used to calculate performance metrics.  The effect of plasma, moreover, is guided by this value in the step-by-step calculation of the image. <br><br>  Other arguments reflect the features of the implementation of graphic effects, in particular, the radial expansion of the treated area.  For example, the parameters <i>simXtouch</i> , <i>simYTouch</i> , <i>radLo</i> and <i>radHi</i> , together with the width and height values, are used in the effects of tinting an image into sepia and bleaching.  With their use, calculation and display of how image processing begins at a certain point, after which the area expands radially until it fills the entire image. <br><br><h2>  <font color="#0071c5">1.5 Definitions and resources needed to run machine code (C or OpenCL)</font> </h2><br>  Here we look at the definitions of machine JNI functions that implement the effects shown in the example.  As already mentioned, each effect corresponds to one function.  This is done in order not to complicate the narration and more clearly distinguish the functional elements used in accelerating image processing using OpenCL. <br><br>  There are links to code written in C, fragments of this code are included here.  This is done in terms of comparing the performance of the technologies under consideration in future versions of the example. <br><br>  One JNI function corresponds to a single Java machine function.  Therefore, it is very important that the JNI functions are correctly declared and defined.  The <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">Java SDK</a> has a <a href="http://docs.oracle.com/javase/7/docs/technotes/tools/windows/javah.html">javah</a> tool that helps generate correct and accurate declarations of JNI functions.  This tool is recommended to use in order not to fall into difficult situations when the code is compiled correctly, but gives runtime errors. <br><br>  The following shows the JNI functions corresponding to the lower level functions for accelerated image processing.  Function signatures are generated using the javah tool. <br><br><pre> <code class="hljs pgsql">//    JNI-,     //      #ifndef _Included_com_example_imageprocessingoffload_NativeLib #define _Included_com_example_imageprocessingoffload_NativeLib #ifdef __cplusplus extern "C" { #endif <span class="hljs-comment"><span class="hljs-comment">/* * Class: com_example_imageprocessingoffload_NativeLib * Method: renderPlasma * Signature: (Landroid/graphics/Bitmap;IJLjava/lang/String;)Ljava/lang/String; */</span></span> JNIEXPORT <span class="hljs-type"><span class="hljs-type">void</span></span> JNICALL Java_com_example_imageprocessingoffload_NativeLib_renderPlasma (JNIEnv *, jclass, jobject, jint, jlong, jstring, jint, jobject); <span class="hljs-comment"><span class="hljs-comment">/* * Class: com_example_imageprocessingoffload_NativeLib * Method: renderMonoChrome * Signature: (Landroid/graphics/Bitmap;Landroid/graphics/Bitmap;IJLjava/lang/String;)Ljava/lang/String; */</span></span> JNIEXPORT <span class="hljs-type"><span class="hljs-type">void</span></span> JNICALL Java_com_example_imageprocessingoffload_NativeLib_renderMonoChrome (JNIEnv *, jclass, jobject, jobject, jint, jlong, jstring, jint, jint, jint, jint, jint, jobject); <span class="hljs-comment"><span class="hljs-comment">/* * Class: com_example_imageprocessingoffload_NativeLib * Method: renderSepia * Signature: (Landroid/graphics/Bitmap;Landroid/graphics/Bitmap;IJLjava/lang/String;)Ljava/lang/String; */</span></span> JNIEXPORT <span class="hljs-type"><span class="hljs-type">void</span></span> JNICALL Java_com_example_imageprocessingoffload_NativeLib_renderSepia (JNIEnv *, jclass, jobject, jobject, jint, jlong, jstring, jint, jint, jint, jint, jint, jobject); } #endif</code> </pre><br>  The <i>javah</i> tool can generate the correct JNI function signatures.  However, the class or classes that define Java machine functions should already be compiled in the Android project.  If you need to generate a header file, you can use the javah command like this: <br><br>  <i>{javahLocation} -o {outputFile} -classpath {classpath} {importName}</i> <br><br>  In our example, the function signatures were created with the following command: <br><br>  <i>javah -o junk.h -classpath bin \ classes com.example.imageprocessingoffloading.NativeLib</i> <br><br>  The signatures of the JNI functions from the <i>junk.h</i> file <i>were</i> then added to the <i>imageeffects.cpp</i> file, which implements the preparation and launch of OpenCL or C code.  Next, we allocate the resources needed when running OpenCL or machine code for plasma effects, bleaching, toning in sepia. <br><br><h2>  <font color="#0071c5">1.5.1 Plasma effect</font> </h2><br>  The <i>Java_com_example_imageprocessingoffload_NativeLib_renderPlasma (...)</i> function is the entry point for the execution of OpenCL or machine code that implement the plasma effect.  The functions <i>startPlasmaOpenCL (...)</i> , <i>runPlasmaOpenCL (...)</i> , and <i>runPlasmaNative (...)</i> are external to the code from the <i>imagee imageeffects.cpp</i> file, they are declared in a separate <i>plasmaEffect.cpp</i> file.  The source code of <i>plasmaEffect.cpp</i> can be found <a href="">here</a> . <br><br>  The <i>renderPlasma (...)</i> function, which is the entry point, uses an OpenCL wrapper to query Android for OpenCL support.  It calls the wrapper class function <i>:: initOpenCL (...)</i> to initialize the OpenCL environment.  As a device type, when creating an OpenCL context, it is passed to a CPU or GPU.  The Android resource manager uses the <i>ceName</i> parameter to identify, load, and compile a CL file with the required kernel. <br><br>  If you succeed in successfully setting up the OpenCL environment, the next step for the <i>renderPlasma (...)</i> function is to call the <i>startPlasmaOpenCL ()</i> function, which allocates OpenCL resources and starts the execution of the kernel that implements the plasma effect.  Note that <i>gOCL</i> is a global variable that holds an instance of the wrapper class of OpenCL.  This variable is visible to all JNI functions that are entry points.  Thanks to this approach, the OpenCL environment can be initialized when accessing any of the supported graphic effects. <br><br>  When demonstrating the plasma effect, no ready-made images are used.  Everything that is displayed on the screen is generated programmatically.  The <i>bitmapIn</i> parameter is a <i>BitMap</i> object that stores graphic data generated during the operation of the algorithm.  The <i>pixels</i> parameter passed to the <i>startPlasma (...)</i> function is mapped onto a raster texture and is used by machine code or OpenCL core code to read and write pixel data that is displayed on the screen.  Once again, we note that the <i>assetManager</i> object <i>is</i> used to access the CL file that contains the OpenCL core that implements the plasma effect. <br><br><pre> <code class="hljs pgsql">JNIEXPORT <span class="hljs-type"><span class="hljs-type">void</span></span> Java_com_example_imageprocessingoffload_NativeLib_renderPlasma(JNIEnv * env, jclass, jobject bitmapIn, jint renderocl, jlong time_ms, jstring ename, jint devtype, jobject assetManager) { ‚Ä¶ //     //    BitMapIn    ‚Äúpixels‚Äù,   OpenCL-     . ret = AndroidBitmap_lockPixels(env, bitmapIn, &amp;pixels); ‚Ä¶ //     <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> OCL <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> initialized AAssetManager *amgr = AAssetManager_fromJava(env, assetManager); gOCL.initOpenCL(clDeviceType, ceName, amgr); startPlasmaOpenCL((cl_ushort *) pixels, infoIn.height, infoIn.width, (<span class="hljs-type"><span class="hljs-type">float</span></span>) time_ms, ceName, cpinit); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> runPlasmaOpenCL(infoIn.width, infoIn.height, (<span class="hljs-type"><span class="hljs-type">float</span></span>) time_ms, (cl_ushort *) pixels); ‚Ä¶ //     }</code> </pre> <br>  The external <i>startPlasmaOpenCL (...)</i> function creates and fills <i>Palette</i> and <i>Angles</i> buffers, which contain the data necessary to create a plasma effect.  To run the OpenCL kernel responsible for this effect, the function relies on the OpenCL command queue, context, and kernel, which are defined as data members in a wrapper class. <br><br>  The <i>runPlasmaOpenCL (...)</i> function continuously calls the OpenCL core, which generates a plasma image.  A separate function is used once, when the OpenCL kernel is launched, subsequent kernel calls need only a new timestamp value in the input data.  Due to the fact that for subsequent calls to the kernel you need to pass only an argument in the form of a timestamp, there is a need for an additional function. <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startPlasmaOpenCL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cl_ushort* pixels, cl_int height, cl_int width, cl_float ts, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* eName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> inittbl</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runPlasmaOpenCL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> width, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> height, cl_float ts, cl_ushort *pixels</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runPlasmaNative</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> AndroidBitmapInfo* info, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* pixels, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> t, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> inittbl </span></span></span><span class="hljs-function">)</span></span>;</code> </pre> <br>  The <i>runPlasmaNative (...)</i> function contains the implementation of the plasma effect creation algorithm on C. The <i>inittbl</i> argument <i>is</i> used as a logical one, its value indicates whether the <i>Palette</i> and <i>Angles</i> data sets are needed for the algorithm to work.  OpenCL kernel code implementing the plasma effect can be found in the <i>plasmaEffect.cpp</i> file. <br><br><pre> <code class="hljs go">#define FBITS <span class="hljs-number"><span class="hljs-number">16</span></span> #define FONE (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; FBITS) #define FFRAC(x) ((x) &amp; ((<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; FBITS)<span class="hljs-number"><span class="hljs-number">-1</span></span>)) #define FIXED_FROM_FLOAT(x) ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)((x)*FONE)) <span class="hljs-comment"><span class="hljs-comment">/*  ,     */</span></span> #define PBITS <span class="hljs-number"><span class="hljs-number">8</span></span> #define ABITS <span class="hljs-number"><span class="hljs-number">9</span></span> #define PSIZE (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; PBITS) #define ANGLE_2PI (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; ABITS) #define ANGLE_MSK (ANGLE_2PI - <span class="hljs-number"><span class="hljs-number">1</span></span>) #define YT1_INCR FIXED_FROM_FLOAT(<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">100.0f</span></span>) #define YT2_INCR FIXED_FROM_FLOAT(<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">163.0f</span></span>) #define XT1_INCR FIXED_FROM_FLOAT(<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">173.0f</span></span>) #define XT2_INCR FIXED_FROM_FLOAT(<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">242.0f</span></span>) #define ANGLE_FROM_FIXED(x) ((x) &gt;&gt; (FBITS - ABITS)) &amp; ANGLE_MSK ushort pfrom_fixed(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x, __global ushort *palette) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) x = -x; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x &gt;= FONE) x = FONE<span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idx = FFRAC(x) &gt;&gt; (FBITS - PBITS); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> palette[idx &amp; (PSIZE<span class="hljs-number"><span class="hljs-number">-1</span></span>)]; } __kernel void plasma(__global ushort *pixels, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> height, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> width, float t, __global ushort *palette, __global <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *angleLut) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> yt1 = FIXED_FROM_FLOAT(t/<span class="hljs-number"><span class="hljs-number">1230.0f</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> yt2 = yt1; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xt10 = FIXED_FROM_FLOAT(t/<span class="hljs-number"><span class="hljs-number">3000.0f</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xt20 = xt10; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = get_global_id(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y = get_global_id(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> tid = x+y*width; yt1 += y*YT1_INCR; yt2 += y*YT2_INCR; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> base = angleLut[ANGLE_FROM_FIXED(yt1)] + angleLut[ANGLE_FROM_FIXED(yt2)]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xt1 = xt10; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xt2 = xt20; xt1 += x*XT1_INCR; xt2 += x*XT2_INCR; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ii = base + angleLut[ANGLE_FROM_FIXED(xt1)] + angleLut[ANGLE_FROM_FIXED(xt2)]; pixels[tid] = pfrom_fixed(ii/<span class="hljs-number"><span class="hljs-number">4</span></span>, palette); }</code> </pre> <br><h2>  <font color="#0071c5">1.5.2 Image discoloration</font> </h2><br>  The <i>Java_com_example_imageprocessingoffload_NativeLib_renderMonochrome (...)</i> function is the entry point for calling image discoloration functions implemented in native code or OpenCL tools.  The functions <i>executeMonochromeOpenCL (...)</i> and <i>executeMonochromeNative (...)</i> are external to the code from <i>imageeffects.cpp</i> , they are declared in a separate file.  As in the case of the plasma effect, the function that plays the role of an entry point uses an OpenCL wrapper to perform requests for OpenCL support to the Android device management subsystem.  It also calls the function <i>:: initOpenCL (...)</i> , which initializes the OpenCL environment. <br><br>  The following pair of lines of code shows that the <i>executeMonochromeOpenCL (...)</i> and <i>executeMonochromeNative (...)</i> functions are declared with the <i>extern</i> keyword.  This makes them visible to the NDK compiler.  This is necessary because these functions are declared in a separate file. <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">executeMonochromeOpenCL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cl_uchar4 *srcImage, cl_uchar4 *dstImage, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> radiHi, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> radiLo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> xt, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> yt, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nWidth, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nHeight</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">executeMonochromeNative</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cl_uchar4 *srcImage, cl_uchar4 *dstImage, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> radiHi, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> radiLo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> xt, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> yt, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nWidth, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nHeight</span></span></span><span class="hljs-function">)</span></span>;</code> </pre> <br>  Unlike the plasma effect, input and output images are used here.  Both <i>bitmapIn</i> and <i>bitmapOut</i> are bitmaps in the ARGB_888 format.  Both of them are mapped onto <i>cl</i> -buffers of <i>cl_uchar4</i> type <i>vectors</i> .  Notice that the <i>typesIn</i> and <i>PixOut</i> types are <i>cast</i> <i>here</i> , this is necessary so that OpenCL can map BitMap objects to the <i>cl_uchar4</i> vector <i>buffers</i> . <br><br><pre> <code class="hljs pgsql">JNIEXPORT <span class="hljs-type"><span class="hljs-type">void</span></span> JNICALL Java_com_example_imageprocessingoffload_NativeLib_renderMonochrome(JNIEnv * env, jclass obj, jobject bitmapIn, jobject bitmapOut, jint renderocl, jlong time_ms, jstring ename, jint xto, jint yto, jint radHi, jint radLo, jint devtype, jobject assetManager) { ‚Ä¶ //     //    BitMapIn    ‚ÄúpixelsIn‚Äù,   OpenCL-     . ret = AndroidBitmap_lockPixels(env, bitmapIn, &amp;pixelsIn); //    BitMapOut    ‚ÄúpixelsOut‚Äù,   OpenCL-      ret = AndroidBitmap_lockPixels(env, bitmapOut, &amp;pixelsOut); ‚Ä¶ //     <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> OpenCL <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> OCL <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> initialized AAssetManager *amgr = AAssetManager_fromJava(env, assetManager); gOCL.initOpenCL(clDeviceType, ceName, amgr); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> executeMonochromeOpenCL((cl_uchar4*) pixelsIn,(cl_uchar4*) pixelsOut, radiHi, radiLo, xt, yt, infoIn.width, infoIn.height); //  , ,  OCL  <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> executeMonochromeNative((cl_uchar4*) pixelsIn,(cl_uchar4*) pixelsOut, radiHi, radiLo, xt, yt, infoIn.width, infoIn.height); //   OpenCL ‚Ä¶ //     }</code> </pre> <br>  When the <i>executeMonochromeOpenCL (...)</i> function is <i>called</i> , <i>pixelsIn</i> and <i>pixelsOut are</i> converted to the <i>cl_uchar4</i> type of buffers and transmitted.  This function uses the OpenCL API to create buffers and other resources needed for operation.  It sets the kernel arguments and enqueues the commands necessary for the execution of the OpenCL kernel.  The input image buffer is formed as a read-only buffer (read_only); it is accessed using the <i>pixelsIn</i> pointer.  Kernel code uses this pointer to get the image input pixel data.  This data, in turn, is processed by the kernel, the input image is discolored.  The output buffer is a buffer that is intended for both reading and writing (read_write), it stores the results of image processing, <i>pixelsOut</i> points to <i>it</i> .  For more information about OpenCL, see the <a href="https://software.intel.com/en-us/iocl_opg">Intel Programming and Optimization Guide</a> . <br><br>  In the function <i>executeMonochromeNative (...), the</i> image discoloration algorithm is implemented in C. It is a very simple algorithm that uses nested loops ‚Äî an external (y) and internal (x), in which pixel data is processed, and the result is stored in the <i>dstImage</i> variable <i>pointed</i> to by <i>pixoOut</i> .  The variable <i>srcImage</i> , which is indicated by <i>pixelsIn</i> , is used to obtain the input pixel data in the formula of the algorithm, where the color image is converted to monochrome. <br><br>  Here is the OpenCL kernel code that implements the bleaching effect: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">constant</span></span> uchar4 cWhite = {<span class="hljs-number"><span class="hljs-number">1.0</span></span>f, <span class="hljs-number"><span class="hljs-number">1.0</span></span>f, <span class="hljs-number"><span class="hljs-number">1.0</span></span>f, <span class="hljs-number"><span class="hljs-number">1.0</span></span>f}; <span class="hljs-keyword"><span class="hljs-keyword">constant</span></span> float3 channelWeights = {<span class="hljs-number"><span class="hljs-number">0.299</span></span>f, <span class="hljs-number"><span class="hljs-number">0.587</span></span>f, <span class="hljs-number"><span class="hljs-number">0.114</span></span>f}; <span class="hljs-keyword"><span class="hljs-keyword">constant</span></span> <span class="hljs-type"><span class="hljs-type">float</span></span> saturationValue = <span class="hljs-number"><span class="hljs-number">0.0</span></span>f; __kernel <span class="hljs-type"><span class="hljs-type">void</span></span> mono (__global uchar4 *<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>, __global uchar4 *<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>, <span class="hljs-type"><span class="hljs-type">int4</span></span> intArgs, <span class="hljs-type"><span class="hljs-type">int</span></span> width) { <span class="hljs-type"><span class="hljs-type">int</span></span> x = get_global_id(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-type"><span class="hljs-type">int</span></span> y = get_global_id(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-type"><span class="hljs-type">int</span></span> xToApply = intArgs.x; <span class="hljs-type"><span class="hljs-type">int</span></span> yToApply = intArgs.y; <span class="hljs-type"><span class="hljs-type">int</span></span> radiusHi = intArgs.z; <span class="hljs-type"><span class="hljs-type">int</span></span> radiusLo = intArgs.w; <span class="hljs-type"><span class="hljs-type">int</span></span> tid = x + y * width; uchar4 c4 = <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>[tid]; <span class="hljs-type"><span class="hljs-type">float4</span></span> f4 = convert_float4 (c4); <span class="hljs-type"><span class="hljs-type">int</span></span> xRel = x - xToApply; <span class="hljs-type"><span class="hljs-type">int</span></span> yRel = y - yToApply; <span class="hljs-type"><span class="hljs-type">int</span></span> polar = xRel*xRel + yRel*yRel; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (polar &gt; radiusHi || polar &lt; radiusLo) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (polar &lt; radiusLo) { <span class="hljs-type"><span class="hljs-type">float4</span></span> outPixel = dot (f4.xyz, channelWeights); outPixel = mix ( outPixel, f4, saturationValue); outPixel.w = f4.w; <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>[tid] = convert_uchar4_sat_rte (outPixel); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>[tid] = convert_uchar4_sat_rte (f4); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>[tid] = convert_uchar4_sat_rte (cWhite); } }</code> </pre> <br><h2>  <font color="#0071c5">1.5.3 Toning in sepia</font> </h2><br>  The code for toning the image in sepia is very similar to the implementation of the bleaching algorithm.  The main difference is how the pixel color information is processed.  Other formulas and constants are used here.  Below is the declaration of functions for calling algorithm implementations implemented by means of OpenCL and on C. As you can see, functions, with the exception of names, look the same as functions for calling implementations of the bleaching algorithm. <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">executeSepiaOpenCL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cl_uchar4 *srcImage, cl_uchar4 *dstImage, it </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> radiHi, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> radiLo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> xt, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> yt, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nWidth, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nHeight</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">executeSepiaNative</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cl_uchar4 *srcImage, cl_uchar4 *dstImage, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> radiHi, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> radiLo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> xt, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> yt, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nWidth, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nHeight</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">JNIEXPORT jstring JNICALL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_com_example_imageprocessingoffload_NativeLib_renderSepia</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">JNIEnv * env, jclass obj, jobject bitmapIn, jobject bitmapOut, jint renderocl, jlong time_ms, jstring ename, jint xto, jint yto, jint radHi, jint radLo, jint devtype, jobject assetManager</span></span></span><span class="hljs-function">)</span></span> { ‚Ä¶ }</code> </pre> <br>  The code in <i>Java_com_example_imageprocessingoffload_NativeLib_renderSepia (...) is</i> also very similar to the one we saw for the bleaching algorithm, so it is not shown here. <br><br>  When the <i>executeSepiaOpenCL (...)</i> function is <i>called</i> , it converts the values ‚Äã‚Äãpassed to it to the desired type and passes <i>pixelsIn</i> and <i>pixelsOut</i> in the format of <i>cl_uchar4</i> buffers.  It uses the OpenCL API to create buffers and other necessary resources.  It also sets the arguments for the OpenCL core, enqueues the commands for execution.  The input image buffer is formed as a read-only buffer (read_only); it is accessed using the <i>pixelsIn</i> pointer.  Kernel code uses a pointer to get image pixel data.  These data, in turn, are processed by the core, the input image is stained in sepia.  The output buffer is a buffer that is intended for both reading and writing (read_write), it stores the results of image processing, <i>pixelsOut</i> points to <i>it</i> . <br><br>  In the function <i>executeSepiaNative (...)</i> is the implementation of the algorithm of rendering to sepia in C. This is a simple algorithm consisting of a pair of nested loops ‚Äî external (y) and internal (x).  In the loop, the data is processed, the results are stored in the <i>dstImage</i> variable <i>pointed</i> to by <i>pixelsOut</i> .  The <i>srcImage</i> variable <i>pointed</i> to by <i>pixelsIn</i> is used to obtain the input pixel data in the formula of the algorithm, where the color image is colored in sepia. <br><br>  Below is the OpenCL kernel code for rendering an image in sepia. <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">constant</span></span> uchar4 cWhite = {<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">constant</span></span> float3 sepiaRed = {<span class="hljs-number"><span class="hljs-number">0.393</span></span>f, <span class="hljs-number"><span class="hljs-number">0.769</span></span>f, <span class="hljs-number"><span class="hljs-number">0.189</span></span>f}; <span class="hljs-keyword"><span class="hljs-keyword">constant</span></span> float3 sepiaGreen = {<span class="hljs-number"><span class="hljs-number">0.349</span></span>f, <span class="hljs-number"><span class="hljs-number">0.686</span></span>f, <span class="hljs-number"><span class="hljs-number">0.168</span></span>f}; <span class="hljs-keyword"><span class="hljs-keyword">constant</span></span> float3 sepiaBlue = {<span class="hljs-number"><span class="hljs-number">0.272</span></span>f, <span class="hljs-number"><span class="hljs-number">0.534</span></span>f, <span class="hljs-number"><span class="hljs-number">0.131</span></span>f}; __kernel <span class="hljs-type"><span class="hljs-type">void</span></span> sepia(__global uchar4 *<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>, __global uchar4 *<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>, <span class="hljs-type"><span class="hljs-type">int4</span></span> intArgs, <span class="hljs-type"><span class="hljs-type">int2</span></span> wh) { <span class="hljs-type"><span class="hljs-type">int</span></span> x = get_global_id(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-type"><span class="hljs-type">int</span></span> y = get_global_id(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-type"><span class="hljs-type">int</span></span> width = wh.x; <span class="hljs-type"><span class="hljs-type">int</span></span> height = wh.y; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(width &lt;= x || height &lt;= y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-type"><span class="hljs-type">int</span></span> xTouchApply = intArgs.x; <span class="hljs-type"><span class="hljs-type">int</span></span> yTouchApply = intArgs.y; <span class="hljs-type"><span class="hljs-type">int</span></span> radiusHi = intArgs.z; <span class="hljs-type"><span class="hljs-type">int</span></span> radiusLo = intArgs.w; <span class="hljs-type"><span class="hljs-type">int</span></span> tid = x + y * width; uchar4 c4 = <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>[tid]; <span class="hljs-type"><span class="hljs-type">float4</span></span> f4 = convert_float4(c4); <span class="hljs-type"><span class="hljs-type">int</span></span> xRel = x - xTouchApply; <span class="hljs-type"><span class="hljs-type">int</span></span> yRel = y - yTouchApply; <span class="hljs-type"><span class="hljs-type">int</span></span> polar = xRel*xRel + yRel*yRel; uchar4 pixOut; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(polar &gt; radiusHi || polar &lt; radiusLo) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(polar &lt; radiusLo) { <span class="hljs-type"><span class="hljs-type">float4</span></span> outPixel; <span class="hljs-type"><span class="hljs-type">float</span></span> tmpR = dot(f4.xyz, sepiaRed); <span class="hljs-type"><span class="hljs-type">float</span></span> tmpG = dot(f4.xyz, sepiaGreen); <span class="hljs-type"><span class="hljs-type">float</span></span> tmpB = dot(f4.xyz, sepiaBlue); outPixel = (<span class="hljs-type"><span class="hljs-type">float4</span></span>)(tmpR, tmpG, tmpB, f4.w); pixOut = convert_uchar4_sat_rte(outPixel); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { pixOut= c4; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { pixOut = cWhite; } <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>[tid] = pixOut; }</code> </pre> <br><h2> <font color="#0071c5">1.6    ,   RenderScript</font> </h2><br>    ,   RenderScript-  ?  ,   ‚Äì     ,    ,  ,      . Android-        ,    . <br><br>   <i>MainActivity.java</i>       . <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-type"><span class="hljs-type">RenderScript</span></span> rsContext;</code> </pre> <br>  <i>rsContext</i>   RenderScript,     RS-.      RenderScript. <a href="http://developer.android.com/guide/topics/renderscript/compute.html"></a>       RenderScript. <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-type"><span class="hljs-type">ScriptC_plasma</span></span> plasmaScript; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-type"><span class="hljs-type">ScriptC_mono</span></span> monoScript; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-type"><span class="hljs-type">ScriptC_sepia</span></span> sepiaScript;</code> </pre> <br>  <i>plasmaScript</i> , <i>monoScript</i> ,  <i>sepiaScript</i> ‚Äì   -,     RS-. Eclipse IDE  Android Studio    Java-   rs-.  ,    <i>plasma.rs</i>   <i>ScriptC_plasma</i> ,   <i>mono.rs</i> ‚Äì  <i>ScriptC_mono</i> .  <i>sepia.rs</i>     <i>ScriptC_sepia</i> .  RenderScript-  ,      <i>gen</i> . ,    <i>sepia.rs</i>     <i>ScriptC_sepia.java</i> .        Java-,  rs-   ,    RenderScript-,   .  - -    MainActivity.java. <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-type"><span class="hljs-type">Allocation</span></span> allocationIn; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-type"><span class="hljs-type">Allocation</span></span> allocationOut; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-type"><span class="hljs-type">Allocation</span></span> allocationPalette; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-type"><span class="hljs-type">Allocation</span></span> allocationAngles;</code> </pre> <br>   <i>Allocation</i>       RenderScript-. , <i>allocationIn</i>  <i>allocationOut</i>       .     ,    <i>allocationIn</i> ,   <i>allocationOut</i> ,    RS-  ,  ,  . <br><br>   RenderScript-,     ,    Activity    .  ,      ,   <i>allocationPalette</i>  <i>allocationAngle</i> . <br><br> ,    RS-,        RS-.      <i>initRS(‚Ä¶)</i> . <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initRS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ‚Ä¶ };</code> </pre> <br>     RenderScript,    <i>create</i>  <i>RenderScript</i> .    ,     RenderScript,       .  RenderScript     RS-.   ,     RenderScript     <i>MainActivity</i>  .     <i>RenderScript.create(‚Ä¶)</i>  ¬´ <i>this</i> ¬ª. <br><br><pre> <code class="hljs kotlin">rsContext = RenderScript.create(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);</code> </pre> <br>  ,   RS-,     RenderScript-,       .  ,  ,     <i>initRS()</i> ,      RenderScript-    ,   . <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (effectName.<span class="hljs-keyword"><span class="hljs-keyword">equals</span></span>(<span class="hljs-string"><span class="hljs-string">"plasma"</span></span>)) { plasmaScript = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ScriptC_plasma(rsContext); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (effectName.<span class="hljs-keyword"><span class="hljs-keyword">equals</span></span>(<span class="hljs-string"><span class="hljs-string">"mono"</span></span>)) { monoScript = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ScriptC_mono(rsContext); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (effectName.<span class="hljs-keyword"><span class="hljs-keyword">equals</span></span>(<span class="hljs-string"><span class="hljs-string">"sepia"</span></span>)) { sepiaScript = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ScriptC_sepia(rsContext); } <span class="hljs-comment"><span class="hljs-comment">//        </span></span></code> </pre> <br>  <i>stepRenderScript(‚Ä¶)</i>   ,     RenderScript-  .   RenderScript-        RS-.      <i>stepRenderScript(‚Ä¶)</i> ,          . <br><br><pre> <code class="hljs pgsql">private <span class="hljs-type"><span class="hljs-type">void</span></span> stepRenderScript(‚Ä¶) { ‚Ä¶ //     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(effectName.equals("plasma")) { plasmaScript.bind_gPalette(allocationPalette); plasmaScript.bind_gAngles(allocationAngles); plasmaScript.set_gx(inX - stepCount); plasmaScript.set_gy(inY - stepCount); plasmaScript.set_ts(<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.currentTimeMillis() - mStartTime); plasmaScript.set_gScript(plasmaScript); plasmaScript.invoke_filter(plasmaScript, allocationIn, allocationOut); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(effectName.equals("mono")) { //      ,        <span class="hljs-type"><span class="hljs-type">int</span></span> radius = (stepApply == <span class="hljs-number"><span class="hljs-number">-1</span></span> ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>*(stepCount - stepApply)); <span class="hljs-type"><span class="hljs-type">int</span></span> radiusHi = (radius + <span class="hljs-number"><span class="hljs-number">2</span></span>)*(radius + <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-type"><span class="hljs-type">int</span></span> radiusLo = (radius - <span class="hljs-number"><span class="hljs-number">2</span></span>)*(radius - <span class="hljs-number"><span class="hljs-number">2</span></span>); //   . monoScript.set_radiusHi(radiusHi); monoScript.set_radiusLo(radiusLo); monoScript.set_xInput(xToApply); monoScript.set_yInput(yToApply); //  . monoScript.forEach_root(allocationIn, allocationOut); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(stepCount &gt; FX_COUNT) { stepCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; stepApply = <span class="hljs-number"><span class="hljs-number">-1</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(effectName.equals("sepia")) { ‚Ä¶ // ,      } ‚Ä¶ //     };</code> </pre><br>  RenderScript-,    ,    <i>gPalette</i> , <i>gAngles</i> , <i>gx</i> , <i>gy</i>  <i>gScript</i> .  RS  ,      .      <i>plasma.rs</i> .   ,   <i>rs_allocation</i> ,    <i>bind_&lt;var&gt;</i> .     ,   <i>bind_&lt;gvars&gt;</i>     ,   <i>allocationPalette</i>  <i>allocationAngles</i>  RenderScript-.   , ,  <i>gx</i> , <i>gy</i> , <i>ts</i>  <i>gScript,</i>    <i>set_&lt;var&gt;</i> ,         .  ,   ,     RenderScript-  ,  x, y   ,    .  <i>invoke_filter(‚Ä¶)</i>      RenderScript.   , ,  <i>filter()</i> ,  ,   ,            RenderScript. <br><br>     ,  <i>radius</i>     <i>radiusHi</i>  <i>radiusLo</i> .  ,   <i>xInput</i>  <i>yInput</i> ,               .    ,     ,  ,    , <i>forEach_root()</i>  .  <i>forEach_root(‚Ä¶)</i> ‚Äì,   ,   RenderScript.    ,  <i>radiusHi</i> , <i>radiusLo</i> , <i>xInput</i>  <i>yInput</i>       .   <i>set_&lt;var&gt;</i>       . <br><br>       RenderScript  ,      . <br><br>   RenderScript    : <br><br><pre> <code class="hljs django"><span class="xml"><span class="xml">#pragma version(1) #pragma rs java_package_name(com.example.imageprocessingoffload) rs_allocation *gPalette; rs_allocation *gAngles; rs_script gScript; float ts; int gx; int gy; static int32_t intFromFloat(float xfl) { return (int32_t)((xfl)*(1 </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">16</span></span></span></span><span class="xml"><span class="hljs-tag">)); } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">const</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">float</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">YT1_INCR</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(1/100.0f);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">const</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">float</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">YT2_INCR</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(1/163.0f);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">const</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">float</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">XT1_INCR</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(1/173.0f);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">const</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">float</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">XT2_INCR</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(1/242.0f);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">static</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">uint16_t</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pfrom_fixed</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int32_t</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dx</span></span></span></span><span class="xml"><span class="hljs-tag">) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">short</span></span></span></span><span class="xml"><span class="hljs-tag"> *</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">palette</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">short</span></span></span></span><span class="xml"><span class="hljs-tag"> *)</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">gPalette</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">uint16_t</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ret</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dx</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dx</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">-dx;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dx</span></span></span></span><span class="xml"><span class="hljs-tag"> &gt;</span></span></span><span class="xml">= (1 </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">16</span></span></span></span><span class="xml"><span class="hljs-tag">)) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dx</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(1</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">16</span></span></span></span><span class="xml"><span class="hljs-tag">)</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-1</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">idx</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">((dx</span></span></span></span><span class="xml"><span class="hljs-tag"> &amp; ((</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">16</span></span></span></span><span class="xml"><span class="hljs-tag">)</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-1</span></span></span></span><span class="xml"><span class="hljs-tag">)) &gt;</span></span></span><span class="xml">&gt; 8); ret = palette[idx &amp; ((1</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">8</span></span></span></span><span class="xml"><span class="hljs-tag">)</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-1</span></span></span></span><span class="xml"><span class="hljs-tag">)]; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">return</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ret</span></span></span></span><span class="xml"><span class="hljs-tag">; } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">uint16_t</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">__attribute__</span></span></span></span><span class="xml"><span class="hljs-tag">((</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">kernel</span></span></span></span><span class="xml"><span class="hljs-tag">)) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">root</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">uint16_t</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">in</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">uint32_t</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">x</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">uint32_t</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">y</span></span></span></span><span class="xml"><span class="hljs-tag">) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag"> *</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">angles</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag"> *)</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">gAngles</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">uint32_t</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">out</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">in;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">yt1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">intFromFloat(ts/1230.0f);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">yt2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">yt1;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xt10</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">intFromFloat(ts/3000.0f);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xt20</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">xt10;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">y1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">y*intFromFloat(YT1_INCR);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">y2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">y*intFromFloat(YT2_INCR);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">yt1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">yt1</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">y1</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">yt2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">yt2</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">y2</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(yt1</span></span></span></span><span class="xml"><span class="hljs-tag"> &gt;</span></span></span><span class="xml">&gt; 7) &amp; ((1</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">9</span></span></span></span><span class="xml"><span class="hljs-tag">)</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(yt2</span></span></span></span><span class="xml"><span class="hljs-tag"> &gt;</span></span></span><span class="xml">&gt; 7) &amp; ((1</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">9</span></span></span></span><span class="xml"><span class="hljs-tag">)</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">base</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">angles[a1]</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">angles</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a2</span></span></span></span><span class="xml"><span class="hljs-tag">]; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xt1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">xt10;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xt2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">xt20;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xt1</span></span></span></span><span class="xml"><span class="hljs-tag"> += </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">x*intFromFloat(XT1_INCR);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xt2</span></span></span></span><span class="xml"><span class="hljs-tag"> += </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">x*intFromFloat(XT2_INCR);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(xt1</span></span></span></span><span class="xml"><span class="hljs-tag"> &gt;</span></span></span><span class="xml">&gt; (16-9)) &amp; ((1</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">9</span></span></span></span><span class="xml"><span class="hljs-tag">)</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(xt2</span></span></span></span><span class="xml"><span class="hljs-tag"> &gt;</span></span></span><span class="xml">&gt; (16-9)) &amp; ((1</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">9</span></span></span></span><span class="xml"><span class="hljs-tag">)</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ii</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">base</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">angles</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a1</span></span></span></span><span class="xml"><span class="hljs-tag">] + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">angles</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a2</span></span></span></span><span class="xml"><span class="hljs-tag">]; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">out</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">pfrom_fixed(ii/4);</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">return</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">out</span></span></span></span><span class="xml"><span class="hljs-tag">; } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">filter</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rs_script</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">gScript</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rs_allocation</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">alloc_in</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rs_allocation</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">alloc_out</span></span></span></span><span class="xml"><span class="hljs-tag">) { //</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rsDebug</span></span></span></span><span class="xml"><span class="hljs-tag">("</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Inputs</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">TS</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">X</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Y:</span></span></span></span><span class="xml"><span class="hljs-tag">", </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ts</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">gx</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">gy</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rsForEach</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">gScript</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">alloc_in</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">alloc_out</span></span></span></span><span class="xml"><span class="hljs-tag">); }</span></span></span></span></code> </pre> <br>   RenderScript   : <br><br><pre> <code class="hljs go">#pragma version(<span class="hljs-number"><span class="hljs-number">1</span></span>) #pragma rs java_package_name(com.example.imageprocessingoffload) <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> radiusHi; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> radiusLo; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xToApply; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> yToApply; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> float4 gWhite = {<span class="hljs-number"><span class="hljs-number">1.f</span></span>, <span class="hljs-number"><span class="hljs-number">1.f</span></span>, <span class="hljs-number"><span class="hljs-number">1.f</span></span>, <span class="hljs-number"><span class="hljs-number">1.f</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> float3 channelWeights = {<span class="hljs-number"><span class="hljs-number">0.299f</span></span>, <span class="hljs-number"><span class="hljs-number">0.587f</span></span>, <span class="hljs-number"><span class="hljs-number">0.114f</span></span>}; float saturationValue = <span class="hljs-number"><span class="hljs-number">0.0f</span></span>; uchar4 __attribute__((kernel)) root(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> uchar4 in, uint32_t x, uint32_t y) { float4 f4 = rsUnpackColor8888(in); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xRel = x - xToApply; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> yRel = y - yToApply; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> polar = xRel*xRel + yRel*yRel; uchar4 out; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(polar &gt; radiusHi || polar &lt; radiusLo) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(polar &lt; radiusLo) { float3 outPixel = dot(f4.rgb, channelWeights); outPixel = mix( outPixel, f4.rgb, saturationValue); out = rsPackColorTo8888(outPixel); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { out = rsPackColorTo8888(f4); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { out = rsPackColorTo8888(gWhite); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> out; }</code> </pre> <br>  RenderScript-      . <br><br><pre> <code class="hljs go">#pragma version(<span class="hljs-number"><span class="hljs-number">1</span></span>) #pragma rs java_package_name(com.example.imageprocessingoffload) #pragma rs_fp_relaxed <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> radiusHi; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> radiusLo; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xTouchApply; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> yTouchApply; rs_script gScript; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> float4 gWhite = {<span class="hljs-number"><span class="hljs-number">1.f</span></span>, <span class="hljs-number"><span class="hljs-number">1.f</span></span>, <span class="hljs-number"><span class="hljs-number">1.f</span></span>, <span class="hljs-number"><span class="hljs-number">1.f</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> static float3 sepiaRed = {<span class="hljs-number"><span class="hljs-number">0.393f</span></span>, <span class="hljs-number"><span class="hljs-number">0.769f</span></span>, <span class="hljs-number"><span class="hljs-number">0.189f</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> static float3 sepiaGreen = {<span class="hljs-number"><span class="hljs-number">0.349f</span></span>, <span class="hljs-number"><span class="hljs-number">0.686</span></span>, <span class="hljs-number"><span class="hljs-number">0.168f</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> static float3 sepiaBlue = {<span class="hljs-number"><span class="hljs-number">0.272f</span></span>, <span class="hljs-number"><span class="hljs-number">0.534f</span></span>, <span class="hljs-number"><span class="hljs-number">0.131f</span></span>}; uchar4 __attribute__((kernel)) sepia(uchar4 in, uint32_t x, uint32_t y) { uchar4 result; float4 f4 = rsUnpackColor8888(in); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xRel = x - xTouchApply; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> yRel = y - yTouchApply; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> polar = xRel*xRel + yRel*yRel; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(polar &gt; radiusHi || polar &lt; radiusLo) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(polar &lt; radiusLo) { float3 out; float tmpR = dot(f4.rgb, sepiaRed); float tmpG = dot(f4.rgb, sepiaGreen); float tmpB = dot(f4.rgb, sepiaBlue); out.r = tmpR; out.g = tmpG; out.b = tmpB; result = rsPackColorTo8888(out); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { result = rsPackColorTo8888(f4); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { result = rsPackColorTo8888(gWhite); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><h2> <font color="#0071c5">1.7     </font> </h2><br>        OpenCL,          . <br><br>        <a href="https://software.intel.com/en-us/intel-inde">Intel INDE</a> .       IDE,     .     ‚Äì Android Studio.    ,  , -, IDE,    (   ‚Äì Android SDK  NDK,  ), - ‚Äì  OpenCL-       OpenCL-.    Android-,   .  ,        Root-. <br><br>   ,    ,    <a href="https://software.intel.com/en-us/android/articles/opencl-basic-sample-for-android-os">   OpenCL   Android</a> .       Eclipse IDE,   ,        Android Studio. <br><br>    Android Studio     .   ,      Android Studio,   <a href="http://rghost.ru/7xmSSVQxR"></a> .       ,     ,       Android SDK, NDK   ,    Intel    OpenCL. <br><br>  ,   Android.mk       ,    OpenCL-.       : <br><br><pre> <code class="hljs tex">INTELOCLSDKROOT="C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Intel</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">INDE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">code</span></span></span></span>_builder_5.1.0.25"</code> </pre> <br>   local.properties      Android SDK  NDK. <br><br><pre> <code class="hljs tex">sdk.dir=C<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">:</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>Intel<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>INDE<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>IDEintegration<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>android-sdk-windows ndk.dir=C<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">:</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>Intel<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>INDE<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>IDEintegration<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>android-ndk-r10d</code> </pre> <br>        Android-.     Intel Nexus 7 x86.      Android Virtual Device Manager. <br><br>  ,   ,     ,      OpenCL.   ,    Run  Android Studio      .   ,     Serial Number.      <i>emulator-5554</i> . <br>     Windows    : <br><br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Intel</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">INDE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">code</span></span></span></span>_builder_5.1.0.25<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android</span></span></span></span>-preinstall&gt;opencl_android_install ‚Äìd emulator-5554</code> </pre> <br>     OpenCL-  ,     .  ,      ,       Android Studio ,  ,    OK.  . <br><br><img src="https://lh4.googleusercontent.com/ajfiFpzFHmwy59FzcKh9UPh7reJfYhGOidjcM_N0VXFbym_utl8KdBegnC2NUY9q1DPh_QjUj68wlXsYjYGwM1eLCfBp6eOn6vNtA4QNjQhU-HF_Yeh4nSW6nDeNGaMHtUTmXNs"><br> <i><font color="#999999"> OpenCL-   </font></i> <br><br>    ,   OpenCL-   . <br>   ,         OpenCL,    RenderScript-.   Android Studio Eclipse-  <a href="https://software.intel.com/en-us/articles/renderscript-basic-sample-for-android-os">    RenderScript  Android</a> .   ,    ,    RenderScript.       . <br><br> <a href="https://software.intel.com/en-us/intel-opencl"></a>      OpenCL-.           OpenCL    <a href="https://software.intel.com/en-us/node/539390"></a> . <br><br><h2> <font color="#0071c5">2. - OpenCL</font> </h2><br> -   OpenCL API     OpenCL-.  ,   -  API,       OpenCL.             .          .      <a href=""></a> . <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> openclWrapper { private: cl_device_id* mDeviceIds; //   OpenCL- (CPU, GPU,   ) cl_kernel mKernel; //   cl_command_queue mCmdQue; //    CL- cl_context mContext; //  OpenCL cl_program mProgram; //  OpenCL- <span class="hljs-built_in"><span class="hljs-built_in">public</span></span>: openclWrapper() { mDeviceIds = <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; mKernel = <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; mCmdQue = <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; mContext = <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; mProgram = <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; }; ~openclWrapper() { }; cl_context getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mContext; }; cl_kernel getKernel() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mKernel; }; cl_command_queue getCmdQue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mCmdQue; }; <span class="hljs-type"><span class="hljs-type">int</span></span> createContext(cl_device_type deviceType); <span class="hljs-type"><span class="hljs-type">bool</span></span> LoadInlineSource(<span class="hljs-type"><span class="hljs-type">char</span></span>* &amp;sourceCode, const <span class="hljs-type"><span class="hljs-type">char</span></span>* eName); <span class="hljs-type"><span class="hljs-type">bool</span></span> LoadFileSource(<span class="hljs-type"><span class="hljs-type">char</span></span>* &amp;sourceCode, const <span class="hljs-type"><span class="hljs-type">char</span></span>* eName, AAssetManager *mgr); <span class="hljs-type"><span class="hljs-type">int</span></span> buildProgram(const <span class="hljs-type"><span class="hljs-type">char</span></span>* eName, AAssetManager *mgr); <span class="hljs-type"><span class="hljs-type">int</span></span> createCmdQueue(); <span class="hljs-type"><span class="hljs-type">int</span></span> createKernel(const <span class="hljs-type"><span class="hljs-type">char</span></span> *kname); //   <span class="hljs-type"><span class="hljs-type">int</span></span> initOpenCL(cl_device_type clDeviceType, const <span class="hljs-type"><span class="hljs-type">char</span></span>* eName, AAssetManager *mgr=<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>); };</code> </pre> <br>  <i>::createContext(cl device)</i>   . ,    (CPU  GPU), ,     OpenCL      .  ,     OpenCL.       OpenCL. ,   ,  SUCCESS     ( <i>mContext</i> ).   ,      ,      OpenCL,   FAIL. <br><br>  <i>::createCmdQue()</i>   ,   OpenCL-.      <i>mContext</i>    .      SUCCESS      ( <i>mCmdQue</i> ).   ,         ,    <i>createContext(‚Ä¶)</i> ,  FAIL. <br><br>  <i>::buildProgram(effectName, AssetManager)</i> .       ( <i>effectName</i> )      Android JNI.          OpenCL-,      . -           (inline) OpenCL-.             NULL  .      ,         <i>effectName</i> ,    ,       .      ,    OpenCL-,     ,      .             ,   ,  ‚Äì    OpenCL-.         ,   OpenCL-  ,  ‚Äì ,   API        OpenCL-  . <br><br><ul><li>  <i>buildProgram(‚Ä¶)</i>   OpenCL API <i>clCreateProgramWithSource(‚Ä¶)</i>      .  API       ,   OpenCL-   .       .  OpenCL         .    , <i>clCreateProgramWithSource(‚Ä¶)</i>   . <br><br></li><li>  <i>clBuildProgram(‚Ä¶)</i>   ,   <i>clCreateProgramWithSource(‚Ä¶)</i>   <i>clCreateProgramWithBinary(‚Ä¶)</i> .     ,       ,      OpenCL-.     -   ,   <i>clGetProgramBuildInfo(‚Ä¶)</i>      .        -. <br></li></ul><br>  <i>::createKernel(‚Ä¶)</i>          .        SUCCESS.      <i>mKernel</i> ,       ,     ,    . <br><br>  <i>::getContext()</i> , <i>::getCmdQue()</i>  <i>::getKernel()</i> , ,  ,    .    JNI     ,    OpenCL-. <br><br><h2>  <font color="#0071c5">Results</font> </h2><br>       OpenCL-,         Android-. OpenCL   RenderScript.     ,       ,     .    OpenCL    ,         ,          ,    . ,          . </div><p>Source: <a href="https://habr.com/ru/post/263843/">https://habr.com/ru/post/263843/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263833/index.html">CHECK CONSTRAINT in MS SQL - Rakes we walked through</a></li>
<li><a href="../263835/index.html">Viewing statistics on the number of errors in a project, or ‚ÄúWow, graphics have appeared in PVS-Studio!‚Äù</a></li>
<li><a href="../263837/index.html">Corporate Cisco Jabber: Version 11 is very pleased</a></li>
<li><a href="../263839/index.html">Bartle's Psychotypes and Audience Balancing</a></li>
<li><a href="../263841/index.html">Google Chrome for Windows switched to using the AppContainer sandbox</a></li>
<li><a href="../263845/index.html">Hacker projects on Kickstarter</a></li>
<li><a href="../263849/index.html">Sphinx distribute. Accelerate the search</a></li>
<li><a href="../263853/index.html">Magic of tensor algebra: Part 15 - Motion of a non-free solid</a></li>
<li><a href="../263855/index.html">Operation Potao: Malware Analysis for cyber espionage, part 1</a></li>
<li><a href="../263859/index.html">Automating the ip-network using the tools at hand (Python)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>