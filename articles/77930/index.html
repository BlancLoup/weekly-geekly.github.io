<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I connected to QIWI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Why did I need it? 
 The project strongly demanded the connection of convenient payment systems. Yes, there is webmoney, but not at all. Yes, there ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I connected to QIWI</h1><div class="post__text post__text-html js-mediator-article"><h4>  Why did I need it? </h4><br>  The project strongly demanded the connection of convenient payment systems.  Yes, there is webmoney, but not at all.  Yes, there are moneybookers for cards, but the bureaucratic process is too long. <br><br>  It was decided to accept payments through QIWI, firstly because their machines are almost everywhere, and secondly (shhh, great secret!) They are preparing to launch a direct payment system from the account of the cellular operator, without any stupid SMS and ninety percent commissions. <br><br>  Well, since manually requesting registries from the payment system and entering data into the accounting department and the website yesterday, a fully automatic connection option using the SOAP protocol was chosen. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  No sooner said than done! </h4><br>  For the site was taken quite ordinary VDS, which is assembled as an ordinary server set - nginx in front, Apache behind. <br><br>  I already had a basis in the form of some kind of CMS, including in it the module of users' personal accounts with plug-ins of payment systems was implemented. <br><br>  The easiest way to work with SOAP is to take the nuSOAP class from google code ( <a href="http://code.google.com/p/nusoap-for-php5/">http://code.google.com/p/nusoap-for-php5/</a> ). <br><br>  Then we need to do two things: <br><ol><li>  Sending payment attempt information to QIWI server </li><li>  Reception from QIWI to our server package with information about changing the status of the payment. </li></ol><br>  Documentation, it‚Äôs a pity that it‚Äôs not very detailed, is here: <a href="https://ishop.qiwi.ru/docs/OnlineStores_Protocols_SOAP.pdf">https://ishop.qiwi.ru/docs/OnlineStores_Protocols_SOAP.pdf</a> <br><a name="habracut"></a><br>  I give my code, which everyone can take as a basis <br><br> <code>$client = new nusoap_client("https://mobw.ru/services/ishop", false); //       QIWI <br> $error = $client-&gt;getError(); <br> if ( !empty($error) ) { <br> TPAccount::cancelTransaction($transaction); //              <br> echo -1; <br> exit(); <br> } <br> $client-&gt;useHTTPPersistentConnection(); <br> <br> //      : <br> //  ID   QIWI <br> //   <br> //   <br> //     <br> // ,           <br> //      <br> //        <br> //           <br> // 0 ‚Äì     QIWI, 1 ‚Äì   <br> $params = array( <br> 'login' =&gt; $payment-&gt;getVar('id'), <br> 'password' =&gt; $payment-&gt;getVar('password'), <br> 'user' =&gt; $phone, <br> 'amount' =&gt; $transaction['amount'], <br> 'comment' =&gt; '    ', <br> 'txn' =&gt; $transaction['id'], <br> 'lifetime' =&gt; date("dmY H:i:s", strtotime("+2 weeks")), <br> 'alarm' =&gt; 1, <br> 'create' =&gt; 1 <br> ); <br> //  : <br> $result = $client-&gt;call('createBill', $params, "http://server.ishop.mw.ru/"); <br> if ($client-&gt;fault) { <br> TPAccount::cancelTransaction($transaction); <br> echo -1; <br> exit(); <br> } else { <br> $err = $client-&gt;getError(); <br> if ($err) { <br> TPAccount::cancelTransaction($transaction); <br> echo -1; <br> exit(); <br> } else { <br> echo $result; <br> exit(); <br> } <br> } <br></code> <br><br>  My script is called via AJAX, and, as can be seen from the code, it returns the exit code: -1 is an error, any other value is the response of the QIWI server. <br><br>  The code for receiving information on status changes from the payment system is a little more complicated (I quote immediately in final form): <br><br> <code>$server = new nusoap_server; <br> $server-&gt;register('updateBill'); <br> $server-&gt;service($HTTP_RAW_POST_DATA); <br> <br> function updateBill($login, $password, $txn, $status) { <br> <br> //    qiwiPayment <br> $paymentclass = "qiwi" . "Payment"; <br> $payment = new $paymentclass; <br> <br> //    <br> if ( $login != $payment-&gt;getVar('id') ) <br> return 150; <br> <br> if ( !empty($password) &amp;&amp; $password != md5($payment-&gt;getVar('password')) ) <br> return 150; <br> <br> //      <br> $transaction = TPTransactions::getTransactionByID(intval($txn)); <br> <br> if ( empty($transaction) ) <br> return 300; <br> <br> switch ( intval($status) ) { <br> <br> case 50: <br> // Bill created <br> return 0; <br> break; <br> <br> case 60: <br> //    ‚Äì   <br> TPAccount::proceedTransaction($transaction); <br> return 0; <br> break; <br> <br> default: <br> // - ,   ,    <br> TPAccount::cancelTransaction($transaction); <br> return 0; <br> break; <br> <br> } <br> <br> return 300; <br> <br> }</code> <br> <br><h4>  Surprise first.  nuSOAP. </h4><br>  It seems that the code was written, verified on a local server, it's time to introduce my PHP to noble JAVA from the QIWI side. <br><br>  The first surprise occurs instantly - at the first attempt to create a test payment, nuSOAP puzzles with the message ‚ÄúResponse not of type text / xml‚Äù.  Yes, the creators of nuSOAP did not expect that one Russian payment system would decide that SOAP is ‚Äúapplication / soap + xml‚Äù.  We will correct them - it is rather simple to find and comment out the corresponding checks inside the nuSOAP code. <br><br>  And here is a triumph - a test payment was created, it can be seen in QIWI, it is time to accept the answer about successful payment from it. <br><br>  I go to the machine ... <br><br><h4>  Nginx configuration  Error 411. </h4><br>  However, I am in for an unpleasant surprise.  When I try to check the web service of the store, my server unexpectedly responds with error 411 - Length required. <br><br>  The QIWI support response clarified everything: <br>  <i>"Hello.</i>  <i>Our service sends chunked requests without specifying content-length.</i>  <i>I think your web server should have settings to handle such requests. ‚Äù</i> <br><br>  For me, it remained forever a mystery that prevents QIWI from specifying Content-length, but now much has become understood.  nginx does not accept chuncked requests, immediately responding to them with an error ... <br><br>  Go to the server and work! <br><br>  Download the module NginxHttpChunkinModule, put it, unpacking, for example in / root / chunkin.  You can get it here: <a href="http://wiki.nginx.org/NginxHttpChunkinModule">http://wiki.nginx.org/NginxHttpChunkinModule</a> , there are also installation instructions <br><br>  There is nothing difficult in installation, I will show on the example of FreeBSD and nginx 0.7.64 <br><br> <code>#cd /usr/ports/www/nginx <br> # cd ./work/nginx-0.7.64 <br> # ./configure --add-module=/root/chunkin <br> # cd ../../ <br> #make rmconfig &amp;&amp; make config &amp;&amp; make deinstall &amp;&amp; make install</code> <br> <br>  Then we put in the nginx config (usually this /usr/local/etc/nginx/nginx.conf) in the http parameter section <br><br> <code>chunkin on;</code> <br> <br>  and restart nginx <br><br><h4>  Another surprise - Error 501 </h4><br>  And what do you think?  Did it work?  Of course not. <br><br>  The next scourge was the error 501 Method Not Implemented.  Its cause was managed to be localized fairly quickly by looking at the server logs.  Despite the fact that I registered the address of my web service /account/result/qiwi.html in the QIWI interface, the QIWI client stubbornly fought through a closed door - it tried to make a request for the nonexistent address / account / result / qiwi / <br><br>  What caused this behavior - it was not possible to find out, but one rule of mod_rewrite saved the situation.  The request began to come to the address I needed.  And then QIWI support quickly solved this problem on its side. <br><br><h4>  The last and most terrible surprise </h4><br>  Well, now that everything seems to be ready, QIWI has prepared me another surprise.  When I tried to test the web service of the store from the QIWI interface, I invariably received the message ‚ÄúAn error occurred during the request: error in msg parsing: xml was empty, did not parse!‚Äù <br><br>  In fact, this is a good sign - it means that nuSOAP works, and even gives the correct SOI response to a request from the QIWI point of view.  But he doesn‚Äôt see any data from QIWI ... <br><br>  Debugging showed that the $ _POST array is empty, no data comes from QIWI. <br><br>  Here I fell into a complete stupor.  There is no obvious reason for this behavior, but it still exists! <br>  Building nginx with the --with-debug parameter, a two-day analysis of the logs, consulting nginx experts (many thanks to comrade MiksIr) showed a rather unattractive picture.  Nginx with the installed chunkin module really honestly collected chuncked data into a single unit and prepared for further transfer to Apache a request with the correctly specified Content-length header.  However, instead of completely removing the Transfer-encoding header from the original request: it chuncked (the chunkin module) just cut off its value, leaving ‚ÄúTransfer-encoding:‚Äù like this.  Apache at such a disgrace quite logical cursing. <br><br>  To say that the problem was quickly - I can not.  However, she did decide.  So: <br><br>  Go to the sources of the module NginxHttpChunkinModule, file ngx_http_chunckin_filter_module.c and comment on the following lines: <br><br> <code>r-&gt;headers_in.transfer_encoding-&gt;value.len = 0; <br> r-&gt;headers_in.transfer_encoding-&gt;value.data = (u_char*) ""; <br> ngx_http_chunkin_clear_transfer_encoding(r);</code> <br> <br>  There was no time to understand the code deeply, so it can be considered a rude but effective hack. <br>  Rebuild nginx again, and - voila! <br><br><h4>  The surprise is quite the last </h4><br>  I create a transaction, I see its number.  I‚Äôm going to QIWI‚Äôs personal account and trying to manually set the status to ‚ÄúPaid‚Äù.  The QIWI test script faithfully shows me 0 (zero), but nothing happens ... <br>  I will not bore readers with the description of the process of finding this glitch.  Let me just say that the test script always returns zero, regardless of the response from your server, this is ‚Äúa <i>feature of the system</i> (c) QIWI support‚Äù, but to take into account the fact that the client part of a payment system written in Java is considered to be a duty to transfer Hash your password in uppercase - must be. <br><br><h4>  Total. </h4><br>  Everything works, the site has been launched, an invaluable experience has been gained, which, in turn, I am ready to share with pleasure with habrauser (by the <i>way, meet ‚Äî this is my first post on Habr√©!</i> ) And habrachchiteli. <br><br>  Thanks in advance, I hope that my article will help someone save at least a few minutes of precious time! <br><br>  PS The link to the project could give - yes I am afraid of habraeffekt.  Maybe later, in the appropriate blog, when I am sure that the server will withstand ... <br><br>  <b>UPD.</b>  <b>Transferred to the blog "Payment Systems"</b> </div><p>Source: <a href="https://habr.com/ru/post/77930/">https://habr.com/ru/post/77930/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../77913/index.html">Demo version of –°erebro</a></li>
<li><a href="../77918/index.html">Your consumers are responsible: community marketing</a></li>
<li><a href="../77921/index.html">GlassFish v3 released</a></li>
<li><a href="../77925/index.html">Iferta online shopping mall opened in Runet</a></li>
<li><a href="../77926/index.html">Sale from Google: traditional advertising. Price: Free</a></li>
<li><a href="../77932/index.html">Height 100% or full height</a></li>
<li><a href="../77934/index.html">Opinion of Eric Schmidt (CEO of Google) about the secret of personal life</a></li>
<li><a href="../77935/index.html">Keyboard Kinesis Advantage Pro</a></li>
<li><a href="../77936/index.html">New Google Chrome ad</a></li>
<li><a href="../77937/index.html">Advanced Whois</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>