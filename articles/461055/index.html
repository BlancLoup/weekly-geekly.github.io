<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rekko Challenge 2019: how it was</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, a contest of recommendation systems from the Okko online cinema - Rekko Challenge 2019 was held on the Boosters platform. For me it w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rekko Challenge 2019: how it was</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/hb/u7/gu/hbu7guq0ic25zumfxsf5bbipkcq.png"><br><br>  Not so long ago, a contest of recommendation systems from the Okko online cinema - <a href="https://habr.com/ru/company/okko/blog/439180/">Rekko Challenge 2019</a> was held on the <a href="http://boosters.pro/">Boosters</a> platform.  For me it was the first experience of participating in a competition with a leaderboard (previously I tried strength only in a hackathon).  The task is interesting and familiar to me from practice, there is a prize pool, which means it made sense to participate.  As a result, I took 14th place, for which the organizers issued a commemorative T-shirt.  Nicely.  Thank. <br><br>  In this article, I will briefly immerse you in the task, talk about the hypotheses put forward by me, as well as how to drag the competition in recommendation systems and get into the top 15 without stacking experience, which will be especially useful for those who are just going to participate in contests. <br><a name="habracut"></a><br><h3>  Recommender Systems </h3><br>  The main goal of recommender systems is to give the user what he <s>wants to</s> buy (unfortunately, such a hypertrophied view is imposed on us by commercial application). <br>  There are different statements of tasks (ranking, search for similar ones, prediction of a specific element), and, accordingly, ways to solve them.  Well, we all love the variability in choice, which is provided by a set of several potential solutions to each problem.  Various approaches are well described in the article <a href="https://habr.com/ru/company/lanit/blog/420499/">Anatomy of Recommender Systems</a> .  Of course, no one canceled the <a href="http://www.no-free-lunch.org/">NFL theorem</a> , which means that in the competitive problem we can try different algorithms. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Formulation of the problem </h3><br>  Read more about the task and the data in the <a href="https://habr.com/ru/company/okko/blog/439180/">article by the</a> organizers.  TL; DR here I will describe the necessary minimum for understanding the context. <br><br>  The dataset contains just over ten thousand films with anonymized attributes.  The following options are available as user-item interaction matrices: <br><br><ul><li>  transactions - contains facts of users buying content / renting / viewing by subscription; </li><li>  ratings - ratings of films by users; </li><li>  bookmarks - the event of adding a movie to bookmarks. </li></ul><br>  All information is taken over a certain period of time, which is presented in arbitrary units that are linked to real. <br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>t</mi><mi>s</mi><mo>=</mo><mi>f</mi><mo stretchy=&quot;false&quot;>(</mo><mi>t</mi><msub><mi>s</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>r</mi><mi>e</mi><mi>a</mi><mi>l</mi></mrow></msub><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="13.146ex" height="2.66ex" viewBox="0 -832 5660.2 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-74" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-73" x="361" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMAIN-3D" x="1108" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-66" x="2165" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMAIN-28" x="2715" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-74" x="3105" y="0"></use><g transform="translate(3466,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-73" x="0" y="0"></use><g transform="translate(469,-150)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-72" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-65" x="451" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-61" x="918" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-6C" x="1447" y="0"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMAIN-29" x="5270" y="0"></use></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>t</mi><mi>s</mi><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mi>t</mi><msub><mi>s</mi><mrow class="MJX-TeXAtom-ORD"><mi>r</mi><mi>e</mi><mi>a</mi><mi>l</mi></mrow></msub><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> ts = f (ts_ {real}) </script></p><br>  Content had the following set of attributes: <br><br><img src="https://habrastorage.org/webt/14/hj/uu/14hjuuoannzvkwpal7n7xwqyvyk.png"><br><br>  You can read about them in detail in the article by the organizers, but I want to immediately pay attention to what caught my eye: the ‚Äúattributes‚Äù parameter.  It contained a bag of categorical attributes with a cardinality of ~ 36 thousand.  There were an average of 15 values ‚Äã‚Äãper film.  At first glance, these values ‚Äã‚Äãare encrypted just the most basic attributes that describe the content: actors, directors, country, subscriptions or collections to which the film belongs. <br><br>  It is necessary to predict 20 films that test users will watch in the next two months.  Test users are 50 thousand of all 500 thousand users.  On the leaderboard they are divided in half: 25 thousand each in public / private. <br><br><h3>  Metrics </h3><br>  The organizers chose Mean Normalize Average Precision on 20 elements (MNAP @ 20) as a metric.  The main difference from the usual MAP is that for users who have not watched 20 films in the test period, rationing does not take place on k, but on the actual value of the films watched. <br><br><img src="https://habrastorage.org/webt/tk/xt/fn/tkxtfnagqxtookssvkg8rjiicqg.png"><br><br>  Read more and see Cython code <a href="https://habr.com/ru/company/okko/blog/439180/">here.</a> <br><br><h3>  Validation </h3><br>  Getting to the solution of the problem.  First of all, it was necessary to decide what was validated.  Since we need to predict movies in the future, we can‚Äôt do a simple breakdown by users.  Due to the fact that time was anonymized, I had to at least decipher it at first.  To do this, I took several users, made a schedule for transactions and revealed a certain seasonality.  It was assumed that it is daily, and knowing the time difference between the days, we can calculate for what period the data were uploaded.  It turned out that these were transactions for 6 months.  This was later confirmed in the telegram channel where the contest was discussed. <br><br><img src="https://habrastorage.org/webt/ba/3_/67/ba3_67yp9-znxb9b_uoeummo6li.png"><br><br>  The chart above shows the hourly frequency of transactions using one-month-long data as an example.  Three prominent peaks each week are similar to Friday, Saturday, and Sunday evenings. <br><br>  Consequently, we have six months of viewing, and films must be predicted for the next two.  We will use the last third of the training sample time as a validation dataset. <br><br><img src="https://habrastorage.org/webt/mu/uy/cm/muuycmuqlah95etk4kqmdrbpygo.jpeg"><br><br>  The next few submissions showed that the split was selected successfully and the local validation speed correlated excellently with the leaderboard. <br><br><h3>  Attempt to deanonymize data </h3><br>  To begin with, I decided to try to deanonymize all the films so that: <br><br><ul><li>  generate a bunch of signs from the meta-information of the content.  At least, the following people come to mind: genres, cast, entry into subscriptions, text description, etc .; </li><li>  throw in the furnace of interactions from the side to reduce the sparseness of the matrix.  Yes, the competition rules did not prohibit the use of external data.  Of course, there was no hope of a match with open datasets, but nobody canceled the parsing of Russian portals. </li></ul><br>  It seems to be a logical motivation, which, according to my expectations, was to become a killer-featured solution. <br><br>  First of all, I decided to parse the Okko website and pull out all the movies along with their properties (rating, duration, age restrictions and others).  Well, how to parse - everything turned out to be quite simple, in this case, you could use the API: <br><br><img src="https://habrastorage.org/webt/c6/i8/8s/c6i88s9db6wj9nl7aqvysuappt8.png"><br><br>  By going to the catalog and choosing a specific genre or subscription, you just had to go into any of the elements.  In response to the request above, the entire array of films in the genre / subscription with all the attributes falls out.  Very comfortably :) <br><br><div class="spoiler">  <b class="spoiler_title">So the attributes of one element in the structure looked</b> <div class="spoiler_text"><pre><code class="json hljs"><span class="hljs-string"><span class="hljs-string">"element"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"c2f98ef4-2eb5-4bfd-b765-b96589d4c470"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"SERIAL"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"originalName"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"covers"</span></span>: {...}, <span class="hljs-attr"><span class="hljs-attr">"basicCovers"</span></span>: {...}, <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"      ,    ..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"worldReleaseDate"</span></span>: <span class="hljs-number"><span class="hljs-number">1558731600000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ageAccessType"</span></span>: <span class="hljs-string"><span class="hljs-string">"16"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ageAccessDescription"</span></span>: <span class="hljs-string"><span class="hljs-string">"16+    16 "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"duration"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"trailers"</span></span>: {...}, <span class="hljs-attr"><span class="hljs-attr">"kinopoiskRating"</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-attr"><span class="hljs-attr">"okkoRating"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"imdbRating"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"alias"</span></span>: <span class="hljs-string"><span class="hljs-string">"staraja-gvardija"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"has3d"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hasHd"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hasFullHd"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hasUltraHd"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hasDolby"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hasSound51"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hasMultiAudio"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hasSubtitles"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"inSubscription"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"inNovelty"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"earlyWindow"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"releaseType"</span></span>: <span class="hljs-string"><span class="hljs-string">"RELEASE"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"playbackStartDate"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"playbackTimeMark"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"products"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"items"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"PURCHASE"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"consumptionMode"</span></span>: <span class="hljs-string"><span class="hljs-string">"SUBSCRIPTION"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fromConsumptionMode"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"qualities"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"Q_FULL_HD"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"fromQuality"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"price"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"currencyCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"RUB"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"priceCategory"</span></span>: <span class="hljs-string"><span class="hljs-string">"679"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"startDate"</span></span>: <span class="hljs-number"><span class="hljs-number">1554670800000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"endDate"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"subscription"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"element"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"bc682dc6-c0f7-498e-9064-7d6cafd8ca66"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"SUBSCRIPTION"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"alias"</span></span>: <span class="hljs-string"><span class="hljs-string">"119228"</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"offer"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"originalPrice"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> }, ... ], <span class="hljs-attr"><span class="hljs-attr">"emptyReason"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"licenses"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"assets"</span></span>: {...}, <span class="hljs-attr"><span class="hljs-attr">"genres"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"items"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"element"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"Detective"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"GENRE"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"alias"</span></span>: <span class="hljs-string"><span class="hljs-string">"Detective"</span></span> } }, ... ], <span class="hljs-attr"><span class="hljs-attr">"totalSize"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"countries"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"items"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"element"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"3b9706f4-a681-47fb-918e-182ea9dfef0b"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"COUNTRY"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"alias"</span></span>: <span class="hljs-string"><span class="hljs-string">"russia"</span></span> } } ], <span class="hljs-attr"><span class="hljs-attr">"totalSize"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"subscriptions"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"items"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"element"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"bc682dc6-c0f7-498e-9064-7d6cafd8ca66"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"SUBSCRIPTION"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"   "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"alias"</span></span>: <span class="hljs-string"><span class="hljs-string">"119228"</span></span> } }, ... ], <span class="hljs-attr"><span class="hljs-attr">"totalSize"</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"promoText"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"innerColor"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"updateRateDescription"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"contentCountDescription"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"copyright"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"subscriptionStartDate"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"subscriptionEndDate"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"subscriptionActivateDate"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"stickerText"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fullSeasonPriceText"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"purchaseDate"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"expireDate"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lastWatchedChildId"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bookmarkDate"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"userRating"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"consumeDate"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lastStartingDate"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"watchDate"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"startingDate"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"earlyWatchDate"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> }</code> </pre> <br></div></div><br>  It remains to go through all genres, parse JSON, and then allow duplicates, since one movie can belong to several genres / subscriptions. <br><br>  Yes, here I was lucky and I saved a lot of time.  If this is not your case, and you need to parse html content, then there are articles on the hub that can help with this, for example, <a href="https://habr.com/ru/post/280238/">here</a> . <br><br>  ‚ÄúThe thing is the hat,‚Äù I thought, ‚Äúwe can only hold it back.‚Äù  ‚ÄúThe point is the hat,‚Äù I realized the next day: the data were not absolutely matched.  About it below. <br><br>  Firstly, the size of the catalog was significantly different: in the dataset - 10,200, collected from the site - 8870. This follows from the historicity of the dataset: it was downloaded only what is on the site now, and the competition data for 2018.  Some of the films have become unavailable.  Oops <br><br>  Secondly, of the potential attributes for the match, there was persistent intuition only about the following: <br><br>  <i>feature5</i> - age limit.  It was easy enough to understand.  The cardinality of the attribute is 5 unique float values ‚Äã‚Äãand ‚Äú-1‚Äù.  Among the collected data, the ‚ÄúageAccessType‚Äù attribute was found with just cardinality 5. The mapping looked as follows: <br><br><pre> <code class="python hljs">catalogue.age_rating = catalogue.age_rating.map({<span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0.4496666915</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">0.5927161087</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">0.6547073468</span></span>: <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">0.6804096966000001</span></span>: <span class="hljs-number"><span class="hljs-number">18</span></span>})</code> </pre><br>  <i>feature2</i> - converted movie rating from movie search.  Initially, at the EDA stage, the idea that we are dealing with a rating was submitted by the correlation of the parameter with the total number of views.  Subsequently, the belief that this rating was from a movie search confirmed the presence of the ‚ÄúkinopoiskRating‚Äù parameter in the site data. <br><br>  One step closer to the match!  Now it remains to find a way to reverse the conversion for the <i>feature2</i> parameter presented in an anonymous form. <br><br>  Here's what the distribution of values ‚Äã‚Äãlooks like in <i>feature2</i> : <br><br><img src="https://habrastorage.org/webt/pq/pl/_d/pqpl_d1lpm0xed8limzxedbevfa.png"><br><br>  And so the distribution of <i>kinopoiskRating</i> parameter values: <br><br><img src="https://habrastorage.org/webt/wn/6a/np/wn6anpuxtav5ghzgq4tdme0lji8.png"><br><br>  When I showed these images to my colleague Sasha, he immediately saw that this was a degree of three.  Three mathematicians are not held in high esteem, but the number Pi is very even.  As a result, it turned out like this: <br><br><img src="https://habrastorage.org/webt/tw/tt/4u/twtt4uravymgxe1lhxj2d9ydqly.png"><br><br>  It seems to be all, but not quite.  We see identical distributions, but the nominal values ‚Äã‚Äãand quantity still do not converge.  If we knew a certain number of comparison examples, we would only have to approximate the linear function to find the factor.  But we did not have them. <br><br>  To approximate, by the way, is not the most suitable word.  We need a solution with an error almost equal to zero.  Accuracy in the collected data is 2 characters after the separator.  If you consider that there are a lot of films with a rating of 6.xx and there are films with the same rating, then you should fight for precision here. <br><br>  What else can you try?  You can rely on the minimum and maximum values ‚Äã‚Äãand use MinMaxScaler, but the unreliability of this method immediately raises doubts.  Let me remind you that the number of films did not initially coincide, and our dataset is historical, and the current state on the site.  Those.  there are no guarantees that the films with the minimum and maximum ratings in both groups are identical (it turned out that they had a different age limit, and the duration did not converge from the word ‚Äúcompletely‚Äù), as well as there is no understanding of how often OKKO updates in API daily changing movie search rating. <br><br>  So it became clear that I needed more attribute candidates for matching. <br><br>  <b>What else is interesting?</b> <br><br>  <i>feature1</i> - some kind of date.  In theory, for dates, the organizers promised the preservation of separation of states, which implied a linear function.  In general, the transformation should have been identical to the <i>ts</i> attribute for the interaction matrices.  If you look at the distribution of films by <i>feature_1</i> ... <br><br><img src="https://habrastorage.org/webt/q2/94/dn/q294dngcpjgbfdgxcpwsrsv-1lu.png"><br><br>  ... then the film‚Äôs release date hypothesis is immediately swept away.  Intuition suggests that the number of films produced by the industry should increase over time.  This is confirmed below. <br><br>  There are 14 attributes in the data that we received from the site.  In fact, unfortunately, the values ‚Äã‚Äãwere contained only for the following: <br><br><img src="https://habrastorage.org/webt/wg/bw/64/wgbw64outbnbatpbee2vt5ge8y0.png"><br><br><img src="https://habrastorage.org/webt/5t/ba/pw/5tbapwosxnjwma2wxnznoj3ntfm.png"><br><br><img src="https://habrastorage.org/webt/rj/l8/jb/rjl8jbpximeqbwahvzmrdbummm4.png"><br><br>  None of the examples above are similar to <i>feature_1</i> .  Well, there were no more ideas for comparison, and it seems that all the fuss with this task was in vain.  Of course, I heard about contests, where the guys marked up the data manually, but not when it comes to hundreds and thousands of copies. <br><br><h3>  Decision </h3><br>  <b>1. Simple models</b> <br><br>  Realizing that not everything is so simple, I began to humbly work with what is.  For starters, I wanted to start with a simple one.  I tried several solutions often used in the industry, namely: <a href="https://en.wikipedia.org/wiki/Collaborative_filtering">collaborative filtering</a> (in our case, item-based) and <a href="https://en.wikipedia.org/wiki/Matrix_factorization_(recommender_systems)">factorization of matrices</a> . <br><br>  The community makes extensive use of a couple of python libraries suitable for these tasks: <a href="https://github.com/benfred/implicit">implicit</a> and <a href="https://github.com/lyst/lightfm">LightFM</a> .  The first one is capable of factoring based on ALS, as well as Nearest Neighbor Collaborative Filtering with several options for preprocessing the item-item matrix.  The second has two distinctive factors: <br><br><ul><li>  Factorization is based on SGD, which makes it possible to use sampling-based loss functions, including <a href="https://lyst.github.io/lightfm/docs/examples/warp_loss.html">WARP</a> . </li><li>  It uses a hybrid approach, combining information about user attributes and items in the model in such a way that the latent vector of the user is the sum of the latent vectors of its attributes.  And similarly for items.  This approach becomes extremely convenient when there is a cold start problem for the user / item. </li></ul><br>  We didn‚Äôt have any user attributes (apart from the ability to display them based on interaction with movies), so I used only the attributes of items. <br><br>  In total, 6 settings went to enumerate the parameters.  A combination of three matrices was used as the interaction matrix, where the ratings were converted to binary.  Comparative results with the best hyperparameters for each setting in the table below. <br><div class="scrollable-table"><table><tbody><tr><td>  <b>Model</b> </td><td>  <b>Test MNAP @ 20</b> </td></tr><tr><td>  Implicit ALS </td><td>  0.02646 </td></tr><tr><td>  Implicit Cosine kNN CF </td><td>  <b>0.03170</b> </td></tr><tr><td>  Implicit TFIDF kNN CF </td><td>  0.03113 </td></tr><tr><td>  LightFM (without item features), BPR loss </td><td>  0.02567 </td></tr><tr><td>  LightFM (without item features), WARP loss </td><td>  0.02632 </td></tr><tr><td>  LightFM with item features, WARP loss </td><td>  0.02635 </td></tr></tbody></table></div><br>  As you can see, classical collaborative filtering has proven to be much better than other models.  Not perfect, but much is not required of the base line.  Submit with this configuration gave 0.03048 on the public leaderboard.  I don‚Äôt remember the position at that time, but at the time of the closing of the competition, this submission would definitely have hit the top 80 and provided a bronze medal. <br><br>  <b>2. Hello Boosting</b> <br><br>  What could be better than one model?  Correct: several models. <br><br>  Therefore, the next option was ensemble or, in the context of recommendations, a ranking model of the second level.  As an approach, I took <a href="https://habr.com/ru/company/avito/blog/439206/">this</a> article from the guys from Avito.  It seems to be cooking strictly according to the recipe, periodically stirring and seasoning with the attributes of films.  The only deviation was the number of candidates: I took the top 200 from LightFM, because  with 500,000 users, more simply did not fit into memory. <br><br>  As a result, the speed obtained by me on validation was worse than on one model. <br><br>  After several days of experimentation, the realization came that nothing was working and nothing would work on its own.  Or I don‚Äôt know how to cook it (spoiler: the correct second answer).  What am I doing wrong?  Two reasons came to mind: <br><br><ul><li>  On the one hand, taking the top 200 from the first-level model is sensible from the point of view of generating ‚Äúhard negative‚Äù samples, i.e.  those films that are also relevant to the user, but not watched by him.  On the other hand, some of these films can be watched in the test period, and we present these examples as negative.  Next, I decided to reduce the risks of this fact, rechecking the hypothesis with the following experiment: I took all the positive examples + random for the training sample.  The speed on the test sample did not improve.  Here it is necessary to clarify that in the sampling on the test there were also top predictions from the first level model, because on the leaderboard no one will tell me all the positive examples. </li><li>  Of the 10,200 films available in the catalog, only 8,296 films made any interactions.  Nearly 2,000 films were deprived of user attention, partly because they were not available for purchase / rental / as part of a subscription.  The guys in the chat asked if inaccessible films could become available in the test period.  The answer was yes.  It is definitely impossible to throw them out.  Thus, I assumed that almost 2,000 more films will be available in the next 2 months.  Otherwise, why throw them into the dataset? </li></ul><br>  <b>3. Neurons</b> <br><br>  From the previous paragraph the question was asked: how can we work with films for which there are no interactions at all?  Yes, we recall item features in LightFM, but as we remember, they did not enter.  What else?  Neurons! <br><br>  The open source arsenal has a couple of quite popular high-level libraries for working with recommender systems: <a href="https://maciejkula.github.io/spotlight/index.html">Spotlight</a> by Maciej Kula (author of LightFM) and <a href="https://github.com/jfkirk/tensorrec">TensorRec</a> .  The first under the hood PyTorch, the second - Tensorflow. <br><br>  Spotlight can perform factorization on implicit / explicit datasets with neurons and model sequences.  At the same time, in the factorization ‚Äúout of the box‚Äù there is no way to add user / item features, so drop it. <br><br>  TensorRec, by contrast, only knows how to factorize and is an interesting framework: <br><br><ul><li>  representation graph - a way of converting (it can be set different for user / item) input data into embedding, based on which calculations in the prediction graph will take place.  The selection consists of layers with different activation options.  It is also possible to use an abstract class and stick a custom transformation, consisting of a sequence of keras layers. </li><li>  prediction graph allows you to select the operation at the end: your favorite dot product, euclidean and cosine distance. </li><li>  loss - there is also plenty to choose from.  I was pleased with the implementation of WMRB (essentially the same WARP, only knows how to learn batch and distributed) </li></ul><br>  Most importantly, TensorRec is able to work with contextual features, and indeed the author admits that he was originally inspired by the idea of ‚Äã‚ÄãLightFM.  Well, let's see.  We take interactions (only transactions) and item features. <br><br>  We send to search of various configurations and wait.  Compared to LightFM, training and validation takes a long time. <br><br>  In addition, there were a couple of inconveniences that had to be encountered: <br><br><ol><li>  From changing the verbose flag, the <i>fit</i> method has not changed anything and no callbacks have been provided for you.  I had to write a function that internally did the training of one era using the <i>fit_partial</i> method, and then ran the validation for train and test (in both cases, samples were used to speed up the process). </li><li>  In general, the author of the framework is very well done and uses tf.SparseTensor everywhere.  However, it is worthwhile to understand that as prediction, including for validation, you get the result in dense vector form with the length n_items for each user.  Two tips follow from this: make a cycle for generating predictions with batches (the library method does not have such a parameter) with top-k filtering and prepare the strips with RAM. </li></ol><br>  Ultimately, on the best configuration option, I managed to squeeze 0.02869 on my test sample.  There was something similar to LB. <br><br>  Well, what did I hope for?  What adding nonlinearity to item features will give a twofold increase in the metric?  It is naive. <br><br>  <b>4. Beck that task</b> <br><br>  So wait a moment.  It seems that I again ran into juggling neurons.  What hypothesis did I want to test when I got down to this?  The hypothesis was as follows: ‚ÄúIn the next 2 months of the delayed selection on the leaderboard there will be almost 2,000 new films.  Some of them will take on a heavy share of views. ‚Äù <br><br>  So you can check it in 2 steps: <br><br><ol><li>  It would be nice to see how many movies we added in the honestly split by us test period regarding train.  If we take only the views, then the ‚Äúnew‚Äù films are only 240 (!).  The hypothesis immediately shook.  It seems that the purchase of new content cannot differ by such a number from period to period. </li><li>  We finish.  We have the opportunity to train the model to use only the presentation based on item features (in LightFM, for example, this is done by default, if we did not pre-populate the attribute matrix with the identity matrix).  Further, for infreness, we can submit to this model only (!) Our inaccessible and never seen films.  From these results, we submit and get 0.0000136. </li></ol><br>  Bingo!  This means that you can stop squeezing semantics out of movie attributes.  By the way, later, at DataFest, guys from OKKO said that most of the inaccessible content was just some old movies. <br><br>  You need to try something new, and new - well-forgotten old.  In our case, not completely forgotten, but what happened a couple of days ago.  Collaborative filtering? <br><br>  <b>5. Tune the base line</b> <br><br>  How can I help the CF baseline? <br><br>  <b>Idea number 1</b> <br><br>  On the Internet, I found a presentation about using the likelihood ratio test to filter out minor films. <br><br>  Below I will leave my python code to calculate the LLR score, which I had to write on my knee to test this idea. <br><br><div class="spoiler">  <b class="spoiler_title">LLR calculation</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> scipy.sparse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> csr_matrix <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tqdm <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tqdm <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LLR</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, interaction_matrix, interaction_matrix_2=None)</span></span></span><span class="hljs-function">:</span></span> interactions, lack_of_interactions = self.make_two_tables(interaction_matrix) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> interaction_matrix_2 <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: interactions_2, lack_of_interactions_2 = self.make_two_tables(interaction_matrix_2) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: interactions_2, lack_of_interactions_2 = interactions, lack_of_interactions self.num_items = interaction_matrix.shape[<span class="hljs-number"><span class="hljs-number">1</span></span>] self.llr_matrix = np.zeros((self.num_items, self.num_items)) <span class="hljs-comment"><span class="hljs-comment"># k11 - item-item co-occurrence self.k_11 = np.dot(interactions, interactions_2.T) # k12 - how many times row elements was bought without column elements self.k_12 = np.dot(interactions, lack_of_interactions_2.T) # k21 - how many times column elements was bought without row elements self.k_21 = np.dot(lack_of_interactions, interactions_2.T) # k22 - how many times elements was not bought together self.k_22 = np.dot(lack_of_interactions, lack_of_interactions_2.T) def make_two_tables(self, interaction_matrix): interactions = interaction_matrix if type(interactions) == csr_matrix: interactions = interactions.todense() interactions = np.array(interactions.astype(bool).T) lack_of_interactions = ~interactions interactions = np.array(interactions, dtype=np.float32) lack_of_interactions = np.array(lack_of_interactions, dtype=np.float32) return interactions, lack_of_interactions def entropy(self, k): N = np.sum(k) return np.nansum((k / N + (k == 0)) * np.log(k / N)) def get_LLR(self, item_1, item_2): k = np.array([[self.k_11[item_1, item_2], self.k_12[item_1, item_2]], [self.k_21[item_1, item_2], self.k_22[item_1, item_2]]]) LLR = 2 * np.sum(k) * (self.entropy(k) - self.entropy(np.sum(k, axis=0)) - self.entropy(np.sum(k, axis=1))) return LLR def compute_llr_matrix(self): for item_1 in range(self.num_items): for item_2 in range(item_1, self.num_items): self.llr_matrix[item_1, item_2] = self.get_LLR(item_1, item_2) if item_1 != item_2: self.llr_matrix[item_2, item_1] = self.llr_matrix[item_1, item_2] def get_top_n(self, n=100, mask=False): filtered_matrix = self.llr_matrix.copy() for i in tqdm(range(filtered_matrix.shape[0])): ind = np.argpartition(filtered_matrix[i], -n)[-n:] filtered_matrix[i][[x for x in range(filtered_matrix.shape[0]) if x not in ind]] = 0 if mask: return filtered_matrix != 0 else: return filtered_matrix</span></span></code> </pre><br></div></div><br>  As a result, the resulting matrix can be used as a mask to leave only the most significant interactions, and here there are two options: use threshold or leave top-k elements with the highest value.  In the same way, the combination of several influences on a purchase in one speed is used to rank items, in other words, the test shows how important it is, for example, adding to favorites regarding possible conversion to a purchase.  It looks promising, but the use showed that filtering using the LLR score gives a very miniature increase, and combining several speeds only worsens the result.  Apparently, the method is not for this data.  Of the pluses, I can only note that, while figuring out how to implement this idea, I had to delve into the implicit under the hood. <br><br>  An example of applying this custom logic to implicit will be left under the cat. <br><br><div class="spoiler">  <b class="spoiler_title">Modification of the matrix in implicit</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   LLR scores.     n_items * n_items. llr = LLR(train_csr, train_csr) llr.compute_llr_matrix() #     id, ,      llr_based_mask = llr.get_top_n(n=500, mask=True) #     ,  - CosineRecommender. model = CosineRecommender(K=10200) model.fit(train_csr.T) # model.similarity -   co-occurrence (  Cosine - ).        . masked_matrix = np.array(model.similarity.todense()) * llr_based_mask #  fit()  scorer     model.similarity. #     . model.scorer = NearestNeighboursScorer(csr_matrix(masked_matrix)) #      :   recommend   . test_predict = {} for id_ in tqdm(np.unique(test_csr.nonzero()[0])): test_predict[id_] = model.recommend(id_, train_csr, filter_already_liked_items=True, N=20) #   tuples (item_id, score),   id  . test_predict_ids = {k: [x[0] for x in v] for k, v in test_predict.items()} #       / ,     ,   Cython.</span></span></code> </pre> <br></div></div><br>  <b>Idea number 2</b> <br><br>  Another idea came up that could improve predictions on simple collaborative filtering.  The industry often uses some kind of damping function for old estimates, but we have a not so simple case.  Probably, you need to somehow take into account 2 possible cases: <br><br><ol><li>  Users who watch the service are mostly new </li><li>  ‚ÄúExaminers.‚Äù  That is, those who came relatively recently and can watch previously popular films. </li></ol><br>  Thus, it is possible to divide the collaborative component into two different groups automatically.  To do this, I invented a function that instead of implicit values ‚Äã‚Äãset to ‚Äú1‚Äù or ‚Äú0‚Äù at the intersection of the user and the film, a value showing how important this film is in the user's viewing history. <br><br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>c</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo stretchy=&quot;false&quot;>(</mo><mi>m</mi><mi>o</mi><mi>v</mi><mi>i</mi><mi>e</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#x3B1;</mo></mrow><mo>&amp;#x2217;</mo><mi>S</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo>+</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#x3B2;</mo></mrow><mo>&amp;#x2217;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#x394;</mo></mrow><mi>W</mi><mi>a</mi><mi>t</mi><mi>c</mi><mi>h</mi><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="57.886ex" height="2.66ex" viewBox="0 -832 24922.9 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-63" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-6F" x="433" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-6E" x="919" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-66" x="1519" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-69" x="2070" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-64" x="2415" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-65" x="2939" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-6E" x="3405" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-63" x="4006" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-65" x="4439" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMAIN-28" x="4906" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-6D" x="5295" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-6F" x="6174" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-76" x="6659" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-69" x="7145" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-65" x="7490" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMAIN-29" x="7957" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMAIN-3D" x="8624" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-3B1" x="9680" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMAIN-2217" x="10543" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-53" x="11266" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-74" x="11911" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-61" x="12273" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-72" x="12802" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-74" x="13254" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-54" x="13615" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-69" x="14320" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-6D" x="14665" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-65" x="15544" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMAIN-2B" x="16232" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-3B2" x="17233" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMAIN-2217" x="18022" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMAIN-394" x="18744" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-57" x="19578" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-61" x="20626" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-74" x="21156" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-63" x="21517" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-68" x="21951" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-54" x="22527" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-69" x="23232" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-6D" x="23577" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/surfstudio/blog/461055/&amp;xid=17259,15700023,15700186,15700190,15700256,15700259,15700262,15700265&amp;usg=ALkJrhj21wAgv6c0yZFbM9S2U-VmONz-HQ#MJMATHI-65" x="24456" y="0"></use></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>c</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo stretchy="false">(</mo><mi>m</mi><mi>o</mi><mi>v</mi><mi>i</mi><mi>e</mi><mo stretchy="false">)</mo><mo>=</mo><mrow class="MJX-TeXAtom-ORD"><mo>Œ±</mo></mrow><mo>‚àó</mo><mi>S</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo>+</mo><mrow class="MJX-TeXAtom-ORD"><mo>Œ≤</mo></mrow><mo>‚àó</mo><mrow class="MJX-TeXAtom-ORD"><mo>Œî</mo></mrow><mi>W</mi><mi>a</mi><mi>t</mi><mi>c</mi><mi>h</mi><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-2"> confidence (movie) = Œ± * StartTime + Œ≤ * ŒîWatchTime </script></p><br>  where <i>StartTime</i> is the release date of the movie, and <i>ŒîWatchTime</i> is the difference between the release date and the date the user watched, and <i>Œ±</i> and <i>Œ≤</i> are hyperparameters. <br><br>  Here, the first term is responsible for increasing the speed of films that have recently been released, and the second is for taking into account users' addiction to old films.  If a movie was released long ago, and the user immediately bought it, then today, this fact should not be taken into account much.  If this is some kind of novelty, then we should recommend it to a larger number of users who also watch new items.  If the movie is quite ancient, and the user watched it only now, then this can be also important for those like him. <br><br>  There is a trifle left - to sort out the coefficients <i>Œ±</i> and <i>Œ≤</i> .  Leave for the night, and the job is done.  There were no assumptions about the range at all, so it was initially large, and below are the results of a local optimum search. <br><br><img src="https://habrastorage.org/webt/ej/iy/qk/ejiyqkpfmhz43nlifcd3o_zv40o.png"><br><br>  Using this idea, a simple model on a single matrix gave a speed of 0.03627 on local validation and 0.03685 on public LB, which immediately looks like a good boost compared to previous results.  At that time, it brought me approximately to the top 20. <br><br>  <b>Idea number 3</b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The final idea was that old films that the user had watched for a long time, can be ignored at all. </font><font style="vertical-align: inherit;">This CF screening method is often called pruning. </font><font style="vertical-align: inherit;">Let‚Äôs go through several values ‚Äã‚Äãand test the hypothesis: </font></font><br><br><img src="https://habrastorage.org/webt/pk/xd/uk/pkxduk8vw3eyyojevyibbesixbi.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It turns out that for users with a long history it makes sense to leave only the last 25 interactions. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In total, by working with the data, we achieved a speed of 0.040312 on the local test sample, and the submission with these parameters gave the result in 0.03870 and 0.03990 on the public / private parts, respectively, and provided me with 14th place and a T-shirt.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Acknowledged segments </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Running projects in jupyter notebook is a thankless job. </font><font style="vertical-align: inherit;">You are constantly lost in your code, which is scattered across several notebooks. </font><font style="vertical-align: inherit;">And tracking results only in output cells is completely dangerous in terms of reproducibility. </font><font style="vertical-align: inherit;">Therefore, datasaentists cope as much as they can. </font><font style="vertical-align: inherit;">My colleagues and I made our </font></font><a href="https://drivendata.github.io/cookiecutter-data-science/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cookiecutter-data-science</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> framework </font><font style="vertical-align: inherit;">- Ocean. </font><font style="vertical-align: inherit;">This is a tool for creating structure and project management. </font><font style="vertical-align: inherit;">You can read about its advantages in our </font></font><a href="https://habr.com/ru/company/surfstudio/blog/459340/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Largely due to the good approach to separation of experiments, I did not lose my mind and did not get confused when testing hypotheses.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The secret to success (not mine) </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As it became known immediately after the private part of the leaderboard was opened, almost all the guys with top solutions used simple models on the first level and boosting with additional features on the second. As I understood later, my first puncture in this experiment was primarily the method of sampling when training the second-level model. I tried this: </font></font><br><br><img src="https://habrastorage.org/webt/vq/c1/ds/vqc1dsjoq63esgrlttp3v9-ky2g.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Realizing that this was nonsense, I started looking for quite sophisticated methods, like this one: </font></font><br><br><img src="https://habrastorage.org/webt/p3/im/w3/p3imw3yj1ip5bvqorv_uexldawu.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, I found the right way on the slide from the presentation of Evgeny Smirnov, who took 2nd place. It was a split by users in the test part of the first level model. It seems trivial, but this idea did not come to me.</font></font><br><br><img src="https://habrastorage.org/webt/i9/rs/gw/i9rsgwcjimnuhjbgqcpmlyaj2rk.jpeg"><br><br><h3>  Conclusion </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contests are contests. </font><font style="vertical-align: inherit;">Heavy models really give more accuracy, especially if you can cook them. </font><font style="vertical-align: inherit;">Will this experience come in handy? </font><font style="vertical-align: inherit;">Instead of an answer, I‚Äôll say that after the end of the competition, the organizers threw off a spoiler - a feature importance graph from the product model, according to which it is obvious that they use the same ‚Äúsuccessful‚Äù approach in production. </font><font style="vertical-align: inherit;">It turns out that they are also flowing in the prod. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It turns out that for me the experience of participation was really useful professionally. </font><font style="vertical-align: inherit;">Thanks for reading the article; </font><font style="vertical-align: inherit;">Questions, suggestions, comments are welcome.</font></font></div><p>Source: <a href="https://habr.com/ru/post/461055/">https://habr.com/ru/post/461055/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461043/index.html">Conflict management in a team - balancing act or a vital necessity?</a></li>
<li><a href="../461045/index.html">Extracts from Rosreestr through FSIS USRN and python. Part 1 - Sample</a></li>
<li><a href="../461047/index.html">To write or not to write. Letters to authorities during events</a></li>
<li><a href="../461049/index.html">ONYX BOOX Faust - He who seeks is not forced to wander</a></li>
<li><a href="../461053/index.html">We connect online maps to the navigator on the smartphone. Part 2 - vector cards</a></li>
<li><a href="../461057/index.html">Telegram channels about game development</a></li>
<li><a href="../461059/index.html">Writing an Android App for Movie Fans - Part 1 (Prototyping)</a></li>
<li><a href="../46106/index.html">3G communicator in our opinion</a></li>
<li><a href="../461061/index.html">Magnesium alloys, twin boundaries and segregation</a></li>
<li><a href="../461063/index.html">Interaction of R with databases on the example of Microsoft SQL Server and other DBMS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>