<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Stateful backups in Kubernetes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So, as everyone knows, most recently, DevOpsConfRussia2018 took place on October 1-2 October in Moscow in Infospace . For those who do not vkurse, Dev...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Stateful backups in Kubernetes</h1><div class="post__text post__text-html js-mediator-article"><p>  So, as everyone knows, most recently, <b>DevOpsConfRussia2018</b> took place <b>on</b> October 1-2 October in Moscow in <b>Infospace</b> .  For those who do not vkurse, <b>DevOpsConf</b> - a professional conference on the integration of development processes, testing and operation. </p><br><p>  Our company also took part in this conference.  We were its partners, representing the company at our stand, and also conducted a small meeting.  By the way, this was our first participation in this kind of activity.  The first conference, the first mitap, the first experience. </p><br><p>  What are we talking about?  Mitap was on ‚ÄúBackups in Kubernetes‚Äù. </p><br><p>  Most likely, having heard this name, many will say: ‚ÄúWhy backup in Kubernetes?  He doesn't need to be backed up, he's Stateless. ‚Äù </p><br><p><img src="https://habrastorage.org/webt/t7/qd/uy/t7qduyxlblaljfdfs_tduggq0w8.png"></p><a name="habracut"></a><br><h3>  Introduction ... </h3><br><p>  Let's start with a little background.  Why did it become necessary to highlight this topic and why it is needed. </p><br><p>  In 2016, we became acquainted with such technology as Kubernetes and began to actively apply it to our projects.  Of course, these are mainly microservice architecture projects, and this in turn entails the use of a large number of various software. </p><br><p>  With the very first project, where we used Kubernetes, we had a question about how to back up stateful services located there, which sometimes for one reason or another get into k8s. </p><br><p>  We began to study and search for existing practices to solve this problem.  Communicate with our colleagues and comrades: "And how is this process carried out and built from them?" </p><br><p>  After talking, we realized that for everyone this happens by different methods, means and with a large number of crutches.  At the same time, we did not follow any single approach even <u>within the framework of one project</u> . </p><br><p>  Why is this so important?  Since our company serves projects built on the basis of k8s, we just needed to develop a structured methodology for solving this problem. </p><br><p>  Imagine you are working with one specific project in Kubera.  It contains some stateful services and you need to back up their data.  In principle, you can do with a couple of crutches and forget about it.  But what if you already have two projects on k8s?  And the second project uses completely different services in its work.  And if there are already five projects?  Ten?  Or more than twenty? </p><br><p>  Of course, putting crutches on is difficult and inconvenient.  We need some kind of unified approach that could be used when working with many projects in Cuba and at the same time so that the team of engineers can easily and literally in a matter of minutes make the necessary changes to the work of the backups of these projects. </p><br><p>  Within the framework of this article, we will tell you exactly what tool and practice we use to solve this problem within our company. </p><br><h3>  What are we doing this for? </h3><br><h6>  Nxs-backup what is it? </h6><br><p>  For backups, we use our own open source tool - nxs-backup.  We will not go into the details of what he can.  More information about him can be found at the following <a href="https://habr.com/company/nixys/blog/424717/">link</a> . </p><br><p>  We now turn to the actual implementation of backups in k8s.  How and what exactly we did. </p><br><h3>  What is backup? </h3><br><p>  Let's look at an example of the backup of our own Redmine.  In it, we will back up the MySQL database and user project files. </p><br><h3>  How do we do it? </h3><br><h6>  1 CronJob == 1 Service </h6><br><p>  On normal servers and clusters on hardware, almost all backup tools are mainly run through normal cron.  In k8s, we use CronJob for this purpose, that is, we create 1 CronJob for 1 service, which we will back up.  All these CronJobs are located in the same namespace as the service itself. </p><br><p>  Let's start with the MySQL database.  In order to backup MySQL, we need 4 elements, as well as almost any other service: </p><br><ul><li>  ConfigMap (nxs-backup.conf) </li><li>  ConfigMap (mysql.conf for nxs-backup) </li><li>  Secret (access to the service is stored here, in this case MySQL).  Usually, this element is already defined for the operation of the service and it can be reused. </li><li>  CronJob (for each service its own) </li></ul><br><p>  Let's go in order. </p><br><h6>  nxs-backup.conf </h6><br><pre><code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>-conf <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: nxs-backup.conf: |- <span class="hljs-keyword"><span class="hljs-keyword">main</span></span>: server_name: Nixys k8s cluster admin_mail: admins@nixys.ru client_mail: - <span class="hljs-string"><span class="hljs-string">''</span></span> mail_from: <span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>@nixys.ru level_message: <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> block_io_read: <span class="hljs-string"><span class="hljs-string">''</span></span> block_io_write: <span class="hljs-string"><span class="hljs-string">''</span></span> blkio_weight: <span class="hljs-string"><span class="hljs-string">''</span></span> general_path_to_all_tmp_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span> cpu_shares: <span class="hljs-string"><span class="hljs-string">''</span></span> log_file: /dev/stdout jobs: !<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> [conf.d<span class="hljs-comment"><span class="hljs-comment">/*.conf]</span></span></code> </pre> <br><p>  Here we set the basic parameters transmitted to our tool, which are necessary for its operation.  This is the name of the server, e-mail for notifications, restriction on resource consumption and other parameters. </p><br><p>  Configurations can be set in j2 format, which allows the use of environment variables. </p><br><h6>  mysql.conf </h6><br><pre> <code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: mysql-conf data: service.conf.j2: |- - job: mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: {{ db_host }} db_port: {{ db_port }} socket: <span class="hljs-string"><span class="hljs-string">''</span></span> db_user: {{ db_user }} db_password: {{ db_password }} target: - redmine_db gzip: yes is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">'--opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> <br><p>  This file describes the backup logic for the corresponding service, in our case it is MySQL. </p><br><p>  Here you can specify: </p><br><ul><li>  What is the name of Job (field: job) </li><li>  Job'a type (field: type) </li><li>  The temporary directory needed to collect backups (field: tmp_dir) </li><li>  MySQL connection parameters (field: connect) </li><li>  Database that will be backed up (field: target) </li><li>  The need to stop the Slave before collecting (field: is_slave) </li><li>  Additional keys for mysqldump (field: extra_keys) </li><li>  Storage storage, i.e. in which storage we will store a copy (field: storage) </li><li>  The directory where we will store our copies (field: backup_dir) </li><li>  Storage scheme (field: store) </li></ul><br><p>  In our example, the storage type is set to local, that is, we collect and store backup copies locally in a certain directory of the pod being launched. </p><br><p>  Right by analogy with this configuration file, you can set the same configuration files for Redis, PostgreSQL or any other necessary service, if our tool supports it.  The fact that it supports can be found on the link given earlier. </p><br><h6>  Secret mysql </h6><br><pre> <code class="hljs lua">apiVersion: v1 kind: Secret metadata: name: app-<span class="hljs-built_in"><span class="hljs-built_in">config</span></span> data: db_name: <span class="hljs-string"><span class="hljs-string">""</span></span> db_host: <span class="hljs-string"><span class="hljs-string">""</span></span> db_user: <span class="hljs-string"><span class="hljs-string">""</span></span> db_password: <span class="hljs-string"><span class="hljs-string">""</span></span> secret_token: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_address: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_domain: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_ssl: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_enable_starttls_auto: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_port: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_auth_type: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_login: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_password: <span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre> <br><p>  In secret, we keep access to connect to MySQL itself and the mail server.  They can be stored or in a separate secret, or use the existing, of course, if it is.  There is nothing interesting.  Our secret also keeps the secret_token necessary for our Redmine to work. </p><br><h6>  MySQL CronJob </h6><br><pre> <code class="hljs pgsql">apiVersion: batch/v1beta1 kind: CronJob metadata: <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql spec: schedule: "00 00 * * *" jobTemplate: spec: <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>: - nxs-node5 containers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-backup image: nixyslab/nxs-backup:latest env: - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_HOST valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: db_host - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_PORT <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'3306'</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_USER valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: db_user - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_PASSWORD valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: db_password - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_ADDR valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_address - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_PORT valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_port - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_USE_TLS <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'YES'</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_USER valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_login - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_PASS valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_password - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_FROM_LINE_OVERRIDE <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'NO'</span></span> volumeMounts: - <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-conf mountPath: /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/nxs-backup/service.conf.j2 subPath: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf mountPath: /etc/nxs-backup/nxs-backup.conf subPath: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir mountPath: /var/nxs-backup imagePullPolicy: <span class="hljs-keyword"><span class="hljs-keyword">Always</span></span> volumes: - <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-conf items: - key: service.conf.j2 <span class="hljs-type"><span class="hljs-type">path</span></span>: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf items: - key: nxs-backup.conf <span class="hljs-type"><span class="hljs-type">path</span></span>: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir hostPath: <span class="hljs-type"><span class="hljs-type">path</span></span>: /var/backups/k8s <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Directory restartPolicy: OnFailure</code> </pre> <br><p>  Perhaps this is the most interesting element.  Firstly, in order to create the correct CronJob, it is necessary to determine where the collected backups will be stored. </p><br><p>  We have dedicated server for this with the necessary amount of resources.  In the example, a separate cluster node, nxs-node5, is reserved for collecting backups.  Restriction of CronJob launch on the nodes we need is set by the nodeAffinity directive. </p><br><p>  When CronJob is launched, the corresponding directory is connected to it via the hostPath from the host system, which is just used for storing backup copies. </p><br><p>  Next, ConfigMapes that contain the configuration for nxs-backup are connected to a specific CronJob, namely, the files nxs-backup.conf and mysql.conf, which we just talked about above. </p><br><p>  Then, all the necessary environment variables are set, which are defined directly in the manifest or are pulled from the Secret. </p><br><p>  So, the variables are transferred to the container and through docker-entrypoint.sh are substituted in ConfigMaps in the right places to the right values.  For MySQL, this is db_host, db_user, db_password.  In this case, the port is transmitted simply as a value in the CronJob manifest, since it does not carry any valuable information. </p><br><p>  Well, with MySQL everything seems to be clear.  And now let's see what is needed for backup of the Redmine application files. </p><br><h6>  desc_files.conf </h6><br><pre> <code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: desc-files-conf data: service.conf.j2: |- - job: desc-files type: desc_files tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/files/<span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>/dump_tmp sources: - target: - /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/files gzip: yes storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/files/<span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> <br><p>  This is a configuration file that describes the backup logic for files.  Here, too, there is nothing unusual, all the same parameters are set as those of MySQL, with the exception of the data for authorization, because they simply do not exist.  Although they can be, if the protocols for data transfer will be involved: ssh, ftp, webdav, s3 and others.  We will consider this option a little later. </p><br><h6>  CronJob desc_files </h6><br><pre> <code class="hljs pgsql">apiVersion: batch/v1beta1 kind: CronJob metadata: <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files spec: schedule: "00 00 * * *" jobTemplate: spec: <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>: - nxs-node5 containers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-backup image: nixyslab/nxs-backup:latest env: - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_ADDR valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_address - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_PORT valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_port - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_USE_TLS <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'YES'</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_USER valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_login - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_PASS valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_password - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_FROM_LINE_OVERRIDE <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'NO'</span></span> volumeMounts: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-conf mountPath: /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/nxs-backup/service.conf.j2 subPath: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf mountPath: /etc/nxs-backup/nxs-backup.conf subPath: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: target-dir mountPath: /var/www/files - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir mountPath: /var/nxs-backup imagePullPolicy: <span class="hljs-keyword"><span class="hljs-keyword">Always</span></span> volumes: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-conf items: - key: service.conf.j2 <span class="hljs-type"><span class="hljs-type">path</span></span>: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf items: - key: nxs-backup.conf <span class="hljs-type"><span class="hljs-type">path</span></span>: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir hostPath: <span class="hljs-type"><span class="hljs-type">path</span></span>: /var/backups/k8s <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Directory - <span class="hljs-type"><span class="hljs-type">name</span></span>: target-dir persistentVolumeClaim: claimName: redmine-app-files restartPolicy: OnFailure</code> </pre> <br><p>  Also nothing new regarding MySQL.  But here one additional PV (target-dir) is mounted, just which we will back up - / var / www / files.  Otherwise, we still store copies locally on the node we need, which CronJob is assigned to. </p><br><h6>  Total </h6><br><p>  For each service we want to back up, we create a separate CronJob with all the necessary companion elements: ConfigMaps and Secrets.  By analogy with the considered examples, we can back up any similar service in the cluster. </p><br><p>  I think, on the basis of these two examples, everybody got some idea how exactly we back up Stateful services in Cuba.  I think it makes no sense to analyze in detail the same examples for other services, because basically they are all similar to each other and have minor differences. </p><br><p>  Actually, this is what we wanted to achieve, namely, some kind of <u>unified approach</u> in building the backup process.  And so that this approach could be applied to a large number of different projects based on k8s. </p><br><h3>  Where is it stored? </h3><br><p>  In all the examples discussed above, we store copies in the local directory of the node on which the container is running.  But no one bothers to connect Persistent Volume as a working external storage and collect copies there.  Or you can only synchronize them to a remote repository using the desired protocol, without saving locally.  That is a lot of variations.  First compile locally, then synchronize.  Or collect and store only in a remote repository, etc.  The configuration is quite flexible. </p><br><h6>  mysql.conf + s3 </h6><br><p>  Below is an example of the MySQL backup configuration file, where copies are stored locally on the node where CronJob is running, and also synchronized to s3. </p><br><pre> <code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: mysql-conf data: service.conf.j2: |- - job: mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: {{ db_host }} db_port: {{ db_port }} socket: <span class="hljs-string"><span class="hljs-string">''</span></span> db_user: {{ db_user }} db_password: {{ db_password }} target: - redmine_db gzip: yes is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">' --opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: s3 <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump bucket_name: {{ bucket_name }} access_key_id: {{ access_key_id }} secret_access_key: {{ secret_access_key }} s3fs_opts: {{ s3fs_opts }} <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> weeks: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> <br><p>  Ie, if it is not enough to store copies locally, you can synchronize them to any remote storage using the appropriate protocol.  Storage number can be any. </p><br><p>  But in this case, you still need to make some additional changes, namely: </p><br><ul><li>  Connect the appropriate ConfigMap with the content required for authorization with AWS S3, in j2 format </li><li>  Create an appropriate Secret to store access authorization </li><li>  Set the desired environment variables taken from Secret above </li><li>  Adjust docker-entrypoint.sh to replace corresponding variables in ConfigMap </li><li>  Rebuild Docker image by adding utilities for working with AWS S3 </li></ul><br><p>  So far this process is far from perfect, but we are working on it.  Therefore, in the near future, we will add to nxs-backup the ability to define parameters in the configuration file using environment variables, which will greatly simplify the work with the entrypoint file and minimize the time costs of adding support for backup of new services. </p><br><h3>  Conclusion </h3><br><p>  On this, probably, everything. </p><br><p>  Using the approach that has just been discussed, first of all, it allows you to structure and back up the Stateful project services to k8s in a structured and pattern-based manner.  That is, this is a ready-made solution, and most importantly a practice that can be applied in your projects, without wasting time and energy on finding and refining existing open source solutions. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/426543/">https://habr.com/ru/post/426543/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../426527/index.html">Good outstuff, bad outstuff</a></li>
<li><a href="../426531/index.html">Dell G3 15 (3579): gaming laptop for a minimal budget</a></li>
<li><a href="../426533/index.html">Noise Security Bit episode 0x21 (Fiction and reality: backdoors in hardware and firmware)</a></li>
<li><a href="../426537/index.html">The book "App from scratch"</a></li>
<li><a href="../426541/index.html">Paul Allen, co-founder of Microsoft, passed away at the age of 65</a></li>
<li><a href="../426545/index.html">Joker 2018 Bonuses: Free Live Webcast, Bags, Party, and Desktops</a></li>
<li><a href="../426547/index.html">As the creator of Android is trying to release the first "anti-smartphone"</a></li>
<li><a href="../426549/index.html">New type of software for product managers</a></li>
<li><a href="../426551/index.html">Trekz Air - how bone conduction headphones actually sound</a></li>
<li><a href="../426553/index.html">Banner advertising in iOS application</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>