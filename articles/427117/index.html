<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asterisk conference rooms</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 Good day. 

 I was inspired by two things to write this article: a small number or the lack of modern working examples on Asterisk "chips",...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asterisk conference rooms</h1><div class="post__text post__text-html js-mediator-article"><h3>  Foreword </h3><br>  Good day. <br><br>  I was inspired by two things to write this article: a small number or the lack of modern working examples on Asterisk "chips", as well as the reluctance of experts to share these same "chips" with the rest.  This is me now about the RU-community.  Any "grandfathers" on the forums would rather shower you with mud and send you to read books a decade ago, than give you a little bit of useful information.  The themes of the forums created in 2005-2010 are very outdated and sometimes something has already been cut out of the current version of the asterisk, and something needs to be redone very much to make it work. <br><a name="habracut"></a><br>  So here. <br>  As a result of the refusal of CUCM in favor of Asterisk, the management was tasked with keeping the most popular services among users in the most original state in order not to disturb people.  One of these was the creation of conferences.  By that time, I was already familiar with Asterisk, but not so deeply, so it took me about a week and a half to sort through all sorts of conference options, and another task pushed me to the final decision. <br><br>  The problem is that, from a solution that is similar to a solution, there is <a href="https://www.voip-info.org/asterisk-n-way-call-howto">an article</a> with an outdated meetme, as well as some kind of <a href="https://voxlink.ru/kb/asterisk-configuration/call_Asterisk_ConfBridge/">monster</a> , which I never managed to get to work with.  I suggest something not so cumbersome. <br><cut></cut><br><h3>  Pulp </h3><br>  Describe what confbridge is, what sections in a particular config are responsible for, and what kind of option it is, I will not, this information is available and relevant.  Now about the decision as a whole. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Task: to make it so that a conference can be created during a conversation, and then invite more subscribers there.  The main problem is that the channelredirect function does not work as I would like.  That is, if you execute it from the dialplan during a call, then one of the channels will fly away to the right place, and the second one will collapse, and climbing around the entire dialplan for 2k lines and setting the g option on the Dials was lazy.  And I don‚Äôt understand at all why in most manuals everyone is trying to solve the task only through dialplan, ignoring the possibility of the asterisk to work with external scripts and ami. <br><cut></cut><br>  So.  Asterisk 14.4.0 <br><br>  Conference script for 2 options (with comments): <br><br><div class="spoiler">  <b class="spoiler_title">conference.php</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//    $host = "192.168.1.1"; $port = "5038"; $timeout = "10"; $user = "conference"; $pass = "1111"; // ,    1   2  $kusok = $argv[1]; //       if ($kusok == 1){ //  $channel = $argv[2]; $bridgepeer = $argv[3]; $confnum = $argv[4]; print_r($bridgepeer); print_r($confnum); // $sconn = fsockopen ($host, $port, $timeout) or die ("Connection to $host:$port failed!"); fputs ($sconn, "Action: Login\r\n"); fputs ($sconn, "Username: $user\r\n"); fputs ($sconn, "Secret: $pass\r\n\r\n"); //   fputs ($sconn, "Action: Setvar\r\n"); fputs ($sconn, "Channel: $channel\r\n"); fputs ($sconn, "Variable: CONFNUM\r\n"); fputs ($sconn, "Value: $confnum\r\n\r\n"); fputs ($sconn, "Action: Setvar\r\n"); fputs ($sconn, "Channel: $bridgepeer\r\n"); fputs ($sconn, "Variable: CONFNUM\r\n"); fputs ($sconn, "Value: $confnum\r\n\r\n"); // fputs ($sconn, "Action: Redirect\r\n"); fputs ($sconn, "Channel: $bridgepeer\r\n"); fputs ($sconn, "ExtraChannel: $channel\r\n"); fputs ($sconn, "Context: service_code-ael\r\n"); fputs ($sconn, "Exten: conference\r\n"); fputs ($sconn, "Priority: 1\r\n\r\n"); fputs($sconn, "Action: Logoff\r\n\r\n"); sleep(2); fclose ($sconn); } //     if ($kusok == 2) { //  $confnum = $argv[2]; $inviten = $argv[3]; $sconn = fsockopen ($host, $port, $errno, $errstr, $timeout) or die ("Connection to $host:$port failed!"); // fputs ($sconn, "Action: Login\r\n"); fputs ($sconn, "Username: $user\r\n"); fputs ($sconn, "Secret: $pass\r\n\r\n"); //     fputs ($sconn, "Action: Originate\r\n"); fputs ($sconn, "Channel: Local/".$inviten."@out-ael\r\n"); fputs ($sconn, "Context: service_code-ael\r\n"); fputs ($sconn, "Exten: conference\r\n"); fputs ($sconn, "Priority: 1\r\n"); fputs ($sconn, "Variable: CONFNUM=".$confnum."\r\n\r\n"); fputs($sconn, "Action: Logoff\r\n\r\n"); sleep(2); fclose ($sconn); } }</span></span></code> </pre> <br></div></div><br>  Programming gurus can fix the code by making candy out of it, I wrote as best I could. <br>  Next, we start using this script directly in Asterisk itself. <br><br>  In order to create a conference, I chose the combination * 1.  Briefly and does not intersect with the main numbering. <br><br>  Add a script call to features.conf with passing the required variables to it <br><br><pre> <code class="hljs ruby">[applicationmap] conference =&gt; *<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>,System(<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/php /home</span></span><span class="hljs-regexp"><span class="hljs-regexp">/script/conference</span></span>.php <span class="hljs-number"><span class="hljs-number">1</span></span> ${CHANNEL} ${BRIDGEPEER} ${CALLERID(num)})</code> </pre><br>  Then, to make it work, we create a variable in the [globals] section of the dialplan and add our feature <br><br><pre> <code class="hljs">DYNAMIC_FEATURES=conference</code> </pre> <br>  To add new participants to the already created conference, you will need to register the code in confbridge.conf <br><br><pre> <code class="hljs haskell">[default_menu] <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> = menu *1=dialplan_exec(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service_code</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ael</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">conference_add</span></span></span><span class="hljs-class">,1)</span></span></code> </pre><br>  And now the most delicious, extensions.ael: <br><br>  To create a conference (here the php script addresses both conversational channels): <br><br><pre> <code class="hljs perl"> <span class="hljs-string"><span class="hljs-string">conference =&gt;</span></span> { ConfBridge(${CONFNUM},,,default_menu); }</code> </pre><br>  To add a new user (here addresses dialplan_exec): <br><br><pre> <code class="hljs ruby">conference_add =&gt; { Read(INVITEN,dial,<span class="hljs-number"><span class="hljs-number">11</span></span>,i); System(<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/php /home</span></span><span class="hljs-regexp"><span class="hljs-regexp">/script/conference</span></span>.php <span class="hljs-number"><span class="hljs-number">2</span></span> ${CALLERID(num)} ${INVITEN}); }</code> </pre><br>  Everything.  No kilotons of code in the dialplan.  Everything is capacious.  * 1 in the conversation and you're in the box, once again * 1 beep and dialing someone to add. <br><br><h3>  Galls </h3><br>  Driven by the wishes of users, I began to develop this feature. <br><br>  The next was the ability to create conferences from scratch (not from a conversation), as well as to enter already created conferences by their number, and not wait for an inviting call. <br><br>  Add to dialplan: <br><br><pre> <code class="hljs ruby"><span class="hljs-number"><span class="hljs-number">_</span></span>*<span class="hljs-number"><span class="hljs-number">1</span></span>XXXX =&gt; { NoOp(${CONFCHAN}); Set(__CONFNUM=${<span class="hljs-symbol"><span class="hljs-symbol">EXTEN:</span></span><span class="hljs-number"><span class="hljs-number">2</span></span>}); System(<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/php /home</span></span><span class="hljs-regexp"><span class="hljs-regexp">/script/conference</span></span>.php <span class="hljs-number"><span class="hljs-number">3</span></span> ${CONFCHAN} ${CONFNUM} ); }</code> </pre><br>  Add to script: <br><br><div class="spoiler">  <b class="spoiler_title">conference.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//     if ($kusok == 3){ //  $channel = $argv[2]; $confnum = $argv[3]; // $sconn = fsockopen ($host, $port, $timeout) or die ("Connection to $host:$port failed!"); fputs ($sconn, "Action: Login\r\n"); fputs ($sconn, "Username: $user\r\n"); fputs ($sconn, "Secret: $pass\r\n\r\n"); //   fputs ($sconn, "Action: Setvar\r\n"); fputs ($sconn, "Channel: $channel\r\n"); fputs ($sconn, "Variable: CONFNUM\r\n"); fputs ($sconn, "Value: $confnum\r\n\r\n"); // fputs ($sconn, "Action: Redirect\r\n"); fputs ($sconn, "Channel: $channel\r\n"); fputs ($sconn, "Context: service_code-ael\r\n"); fputs ($sconn, "Exten: conference\r\n"); fputs ($sconn, "Priority: 1\r\n\r\n"); fputs($sconn, "Action: Logoff\r\n\r\n"); sleep(2); fclose ($sconn);</span></span></code> </pre> <br></div></div><br>  I also had to modify the _ * X line. <br><br><pre> <code class="hljs perl"> <span class="hljs-number"><span class="hljs-number">_</span></span>*X. =&gt; { set(__CONFCHAN=${CHANNEL}); Dial(Local/${EXTEN}@service_code-ael);</code> </pre><br>  Now to enter the conference or create it from scratch, simply make a call to * 1 and a number, for example * 15234. <br><br>  The final mutation of this service is the so-called ‚Äúgroup conference‚Äù.  This is when big bosses are too lazy to add everything manually, but I want to press one button and everything in the collection.  For this, I decided to make separate service codes (* XXX) in order for people not to be confused too.  For our organization, it is unlikely that over1000 conference groups will be required in the next 100 years, so the numbering reserve should be enough.  At home, you can add another prefix as well as allocate another numbering capacity. <br><br>  Dialplan: <br><br><pre> <code class="hljs ruby"> <span class="hljs-number"><span class="hljs-number">_</span></span>*XXX=&gt; { Set(CONFNUM=${CALLERID(num)}); System(<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/php /home</span></span><span class="hljs-regexp"><span class="hljs-regexp">/script/groups</span></span>.php ${<span class="hljs-symbol"><span class="hljs-symbol">EXTEN:</span></span><span class="hljs-number"><span class="hljs-number">1</span></span>} ${CONFNUM}); ConfBridge(${CONFNUM},,,default_menu); }</code> </pre><br>  The squeak of the collection of participants <br><br><div class="spoiler">  <b class="spoiler_title">groups.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//  function call ($group, $confnum) { $many = count($group); //       for ($i=0; $many&gt;$i; $i++) { //    $num = trim(array_shift($group[$i])); // system("asterisk -rx \"channel originate Local/$num@out-ael application ConfBridge $confnum\""); } } //    function conf_group ($groupid) { //   $opt = array( PDO::ATTR_ERRMODE =&gt; PDO::ERRMODE_EXCEPTION, PDO::ATTR_DEFAULT_FETCH_MODE =&gt; PDO::FETCH_ASSOC ); $pdo = new PDO("odbc:mssql_asterisk, "asterisk, "121212", $opt); //   $sql = "SELECT extension FROM [asterisk].[dbo].[conf_groups] where groupid = $groupid"; $select = $pdo-&gt;query($sql); $result = $select-&gt;fetchAll(); // $pdo = NULL; return $result; } //  ,    $groupid = $argv[1]; //   $confnum = $argv[2]; //   $group=conf_group($groupid); // call($group, $confnum); }</span></span></code> </pre><br></div></div><br>  All groups are stored in a database according to the structure ‚ÄúGroups, Number, Name, Description‚Äù.  If a new group appears, then simply add it to the database. <br><br>  Now, to collect, for example, all the directors for a meeting, the general just needs to dial * 100.  And as a rule, big bosses have big phones.  Therefore, the bindim * 100 on any speeddial key, we sign as a ‚Äúdirector‚Äù and the user does not bother at all what to type.  Button pressed - the meeting gathered. <br><br>  <b>Now anticipating your questions:</b> <br><br>  Why scripts and ami?  Because I didn‚Äôt manage to make a sane redirect of both channels using the dialplan tools without losing them on the way.  In ami, in the redirect function, you can attach an additional channel + set a variable to it (for example, a conference number, so that it can also add someone to it). <br><br>  Also, you may have noticed that I rendered features in a separate context service_code-ael.  This is convenient when all sorts of features you have more than a couple of pieces.  I decided to do them through *, therefore in any context I just write _ * X.  and address in this context.  Perhaps someone will find a more elegant solution, but I haven‚Äôt found it in a few months.  And this functionality came to users like. <br><br>  Why ael, but not conf?  Well, because it is more structured and easier to read. <br>  and clearer.  One gotoif function is worth something.  To lua, I have not yet matured. <br><br>  Why in the example of a massive collection originate made through bash, and not through AMI?  The problem is that performing a bunch of originate in a row through ami, the system waits until the previous one is completed to give the next one.  And if no one picks up the phone, and there 20 seconds no_ans and such 5 pieces?  It will be possible to wait until the evening of the gathering. <br><br>  Well, perhaps that's all.  I hope this article will help the same seekers as I was when it all needed to be done quickly, comfortably for users, and most importantly, in the future it was convenient to maintain this system myself, so to speak, with the future. </div><p>Source: <a href="https://habr.com/ru/post/427117/">https://habr.com/ru/post/427117/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../427105/index.html">Learn to learn: continuing education is the key to competitiveness in the digital economy</a></li>
<li><a href="../427107/index.html">Parsim X12 "on the knee"</a></li>
<li><a href="../427109/index.html">Space Piracy - Deceitful Delta-V and Hydrogen Stealth Steamboats - Part 1</a></li>
<li><a href="../427111/index.html">Transformation of development and delivery processes for legacy applications</a></li>
<li><a href="../427113/index.html">Programmable valve arrays: how will they help 5G networks</a></li>
<li><a href="../427123/index.html">Turing game</a></li>
<li><a href="../427129/index.html">Threat Intelligence - a modern approach to ensuring information security</a></li>
<li><a href="../427131/index.html">Acquaintance with ‚ÄúAudiomania‚Äù: 15 thematic materials about production, design, offices and business</a></li>
<li><a href="../427133/index.html">Assortment is a classic optimization problem.</a></li>
<li><a href="../427135/index.html">The implementation of cutscenes and sequences of actions in games</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>