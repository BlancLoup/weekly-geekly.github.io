<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Working with ESP8266: Writing firmware to control the system nooLite</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In previous articles, we looked at working with SoC Espressif ESP8266 on the example of working with basic AT firmware, building a compiler and writin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Working with ESP8266: Writing firmware to control the system nooLite</h1><div class="post__text post__text-html js-mediator-article">  In <a href="http://geektimes.ru/post/241054/">previous</a> <a href="http://geektimes.ru/post/241842/">articles,</a> we looked at working with SoC Espressif ESP8266 on the example of working with basic AT firmware, building a compiler and writing your own firmware with the implementation of a TCP server (client).  In this article, we will look at an example of writing firmware for working with the <a href="http://www.noo.com.by/modul_mt1132.html">nooLite MT1132</a> transmitter module and try to control the lighting in a real apartment.  Anyone who cares, I ask under habrakat. <br><a name="habracut"></a><br><br>  To write the firmware, we will use Eclipse Luna and my <a href="http://programs74.ru/get.php%3Ffile%3DEspressifESP8266DevKit">Unofficial Development Kit for Espressif ESP8266</a> (it is worth noting that I recently updated it, now Python is not required for its work, libhal.a has been updated, and many examples have been added: 1wire_ds18b20, dht22, blinky, blinky2, i2c_24xx16, i2c_htu21d, etc.), I told about it <a href="http://geektimes.ru/post/241842/">in the last article</a> . <br><br>  For work we need the following materials and devices: <br>  1. Board ESP-01 with chip ESP8266. <br>  2. Module MT1132, you can buy in <a href="http://thinking-home.ru/product/48.aspx">this online store</a> or <a href="http://intelmart.ru/index.php%3FcPath%3D44">this</a> . <br>  3. <a href="http://esp8266.ru/download/esp8266-doc/ESP8266_Specifications_v4.1.pdf">Specification for ESP8266 chip</a> . <br>  4. <a href="http://esp8266.ru/download/esp8266-doc/ESP8266_IoT_SDK_Programming%2520Guide_v0.9.1.pdf">Description of the ESP8266 SDK</a> . <br>  5. <a href="http://www.noo.com.by/assets/files/PDF/MT1132.pdf">Manual for the module nooLite MT1132</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The nooLite developers described in detail the MT1132 module in the documentation, and also gave <a href="http://www.noo.com.by/assets/files/software/MT1132_demo.txt">an example of the scratch for the module to work with the Arduino</a> , so there were no difficulties with connecting the module to the ESP-01 board. <br><br><div class="spoiler">  <b class="spoiler_title">The final wiring diagram:</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/fc6/5bc/f02/fc65bcf0290e412bbef397993f0413fb.png"></div></div><br>  In the firmware we implement 2 modes of operation ESP-01: <br>  1. Configuration mode.  In this mode, it will be possible to set the parameters for connecting ESP-01 to our AP via the Web interface, and set a unique ID for our card.  The ID will only be used to identify the board, if we have several of them on the network. <br>  2. Main mode.  Through the Web interface in this mode, it will be possible to bind-untie the MT1132 module from the power blocks, turn the nooLite power blocks on and off. <br><br>  A brief algorithm for the firmware is: <br>  1. After powering on, we read wi-fi settings and configuration from memory, if there are no settings or wi-fi in STA mode, then we transfer wi-fi to STA-AP mode, give the AP the name NOOLITE_% MACADDRESS%, password% MACADDRESS%, start the web server in configuration mode. <br>  2. Using a simple Web interface, we set the connection parameters to the AP, the ESP-01 board will connect to this AP in the main mode.  Set the board ID.  Save the settings in flash.  Restart board to main mode. <br>  3. In the main mode, a simple Web-server is started, through which you can bind-untie the module MT1132 from the power blocks, turn on / off the power blocks of nooLite. <br>  4. We connect a regular button to GPIO0, the button closure to earth brings the ESP-01 back to the configuration mode. <br>  5. To GPIO16 (in fact, the Chinese have deceived and this is not the GPIO output, but the RESET output) we connect a conventional button, closing the button to the ground produces a hardware reset of the board. <br><br>  Now let's start writing the code (I‚Äôll say right away that the implementation of the web server was borrowed from the <a href="https://github.com/elektronika-ba/ctrl-esp8266-test">elektronika-ba</a> project): <br>  The firmware consists of 6 main files: <br>  driver \ uart.c - UART driver, it modified the uart0_rx_intr_handler procedure for receiving and parsing a response from MT1132; <br>  user \ user_main.c - the main file, but not the main one; <br>  user \ flash_param.c - work with flash-memory; <br>  user \ noolite_platform.c - the main functions, all the logic of switching between different modes; <br>  user \ noolite_config_server.c - configuration web-server; <br>  user \ noolite_control_server.c - main mode web server, sending MT1132 commands; <br><br>  Let's sort each file in order, under the spooler there will be a lot of code with comments: <br><br><div class="spoiler">  <b class="spoiler_title">User_main.c file</b> <div class="spoiler_text"><pre><code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"ets_sys.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"osapi.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"noolite_platform.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"driver/uart.h"</span></span> extern int ets_uart_printf(const char *fmt, ...); void user_init(void) { //  <span class="hljs-type"><span class="hljs-type">UART</span></span>   <span class="hljs-number"><span class="hljs-number">9600</span></span>, ..  <span class="hljs-type"><span class="hljs-type">MT1132</span></span>      uart_init(<span class="hljs-type"><span class="hljs-type">BIT_RATE_9600</span></span>, <span class="hljs-type"><span class="hljs-type">BIT_RATE_9600</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">NOOLITE_LOGGING</span></span> ets_uart_printf(<span class="hljs-comment"><span class="hljs-comment">"nooLite platform starting...\r\n"</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> //      noolite_platform.c noolite_platform_init(); <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">NOOLITE_LOGGING</span></span> ets_uart_printf(<span class="hljs-comment"><span class="hljs-comment">"nooLite platform started!\r\n"</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">File noolite_platform.c</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"ets_sys.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"osapi.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"user_interface.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"mem.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"espconn.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"os_type.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"driver/uart.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"gpio.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"flash_param.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"noolite_platform.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"noolite_config_server.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"noolite_control_server.h"</span></span> //     wi-fi   <span class="hljs-type"><span class="hljs-type">AP</span></span> os_timer_t <span class="hljs-type"><span class="hljs-type">WiFiLinker</span></span>; //      os_timer_t <span class="hljs-type"><span class="hljs-type">DebounceTimer</span></span>; static tConnState connState = <span class="hljs-type"><span class="hljs-type">WIFI_CONNECTING</span></span>; uint16_t wifiErrorConnect = <span class="hljs-number"><span class="hljs-number">0</span></span>; uint16_t controlServerStatus = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-type"><span class="hljs-type">LOCAL</span></span> void input_intr_handler(void *arg); void <span class="hljs-type"><span class="hljs-type">ICACHE_FLASH_ATTR</span></span> debounce_timer_cb(void *arg); //    wi-fi   <span class="hljs-type"><span class="hljs-type">AP</span></span> static void <span class="hljs-type"><span class="hljs-type">ICACHE_FLASH_ATTR</span></span> noolite_platform_check_ip(void *arg) { //   .   ip struct ip_info ipconfig; // .   os_timer_disarm(&amp;<span class="hljs-type"><span class="hljs-type">WiFiLinker</span></span>); //   <span class="hljs-type"><span class="hljs-type">IP</span></span> wifi_get_ip_info(<span class="hljs-type"><span class="hljs-type">STATION_IF</span></span>, &amp;ipconfig); //     <span class="hljs-type"><span class="hljs-type">AP</span></span>   <span class="hljs-type"><span class="hljs-type">IP</span></span>  //   ,   web-    if (wifi_station_get_connect_status() == <span class="hljs-type"><span class="hljs-type">STATION_GOT_IP</span></span> &amp;&amp; ipconfig.ip.addr != <span class="hljs-number"><span class="hljs-number">0</span></span>) { connState = <span class="hljs-type"><span class="hljs-type">WIFI_CONNECTED</span></span>; <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">NOOLITE_LOGGING</span></span> char temp[<span class="hljs-number"><span class="hljs-number">80</span></span>]; ets_uart_printf(<span class="hljs-comment"><span class="hljs-comment">"WiFi connected\r\n"</span></span>); os_sprintf(temp, <span class="hljs-comment"><span class="hljs-comment">"Client IP address: "</span></span> <span class="hljs-type"><span class="hljs-type">IPSTR</span></span> <span class="hljs-comment"><span class="hljs-comment">"\r\n"</span></span>, <span class="hljs-type"><span class="hljs-type">IP2STR</span></span>(&amp;ipconfig.ip)); ets_uart_printf(temp); os_sprintf(temp, <span class="hljs-comment"><span class="hljs-comment">"Client IP netmask: "</span></span> <span class="hljs-type"><span class="hljs-type">IPSTR</span></span> <span class="hljs-comment"><span class="hljs-comment">"\r\n"</span></span>, <span class="hljs-type"><span class="hljs-type">IP2STR</span></span>(&amp;ipconfig.netmask)); ets_uart_printf(temp); os_sprintf(temp, <span class="hljs-comment"><span class="hljs-comment">"Client IP gateway: "</span></span> <span class="hljs-type"><span class="hljs-type">IPSTR</span></span> <span class="hljs-comment"><span class="hljs-comment">"\r\n"</span></span>, <span class="hljs-type"><span class="hljs-type">IP2STR</span></span>(&amp;ipconfig.gw)); ets_uart_printf(temp); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> wifiErrorConnect = <span class="hljs-number"><span class="hljs-number">0</span></span>; if(controlServerStatus == <span class="hljs-number"><span class="hljs-number">0</span></span>) { controlServerStatus++; <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">NOOLITE_LOGGING</span></span> ets_uart_printf(<span class="hljs-comment"><span class="hljs-comment">"Init noolite control server...\r\n"</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> //  web-    noolite_control_server_init(); } //     wi-fi ,     //os_timer_setfn(&amp;<span class="hljs-type"><span class="hljs-type">WiFiLinker</span></span>, (os_timer_func_t *)noolite_platform_check_ip, <span class="hljs-type"><span class="hljs-type">NULL</span></span>); //os_timer_arm(&amp;<span class="hljs-type"><span class="hljs-type">WiFiLinker</span></span>, <span class="hljs-number"><span class="hljs-number">10000</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } else { // <span class="hljs-type"><span class="hljs-type">Wi</span></span>-<span class="hljs-type"><span class="hljs-type">Fi</span></span>   ,  ,      <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span> . if(wifi_station_get_connect_status() == <span class="hljs-type"><span class="hljs-type">STATION_WRONG_PASSWORD</span></span>) { connState = <span class="hljs-type"><span class="hljs-type">WIFI_CONNECTING_ERROR</span></span>; <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">PLATFORM_DEBUG</span></span> ets_uart_printf(<span class="hljs-comment"><span class="hljs-comment">"WiFi connecting error, wrong password\r\n"</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> wifiErrorConnect++; os_timer_setfn(&amp;<span class="hljs-type"><span class="hljs-type">WiFiLinker</span></span>, (os_timer_func_t *)noolite_platform_check_ip, <span class="hljs-type"><span class="hljs-type">NULL</span></span>); os_timer_arm(&amp;<span class="hljs-type"><span class="hljs-type">WiFiLinker</span></span>, <span class="hljs-number"><span class="hljs-number">1500</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } // <span class="hljs-type"><span class="hljs-type">Wi</span></span>-<span class="hljs-type"><span class="hljs-type">Fi</span></span>   ,   <span class="hljs-type"><span class="hljs-type">AP</span></span>,      <span class="hljs-number"><span class="hljs-number">1</span></span> . else if(wifi_station_get_connect_status() == <span class="hljs-type"><span class="hljs-type">STATION_NO_AP_FOUND</span></span>) { connState = <span class="hljs-type"><span class="hljs-type">WIFI_CONNECTING_ERROR</span></span>; <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">PLATFORM_DEBUG</span></span> ets_uart_printf(<span class="hljs-comment"><span class="hljs-comment">"WiFi connecting error, ap not found\r\n"</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> wifiErrorConnect++; os_timer_setfn(&amp;<span class="hljs-type"><span class="hljs-type">WiFiLinker</span></span>, (os_timer_func_t *)noolite_platform_check_ip, <span class="hljs-type"><span class="hljs-type">NULL</span></span>); os_timer_arm(&amp;<span class="hljs-type"><span class="hljs-type">WiFiLinker</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } // <span class="hljs-type"><span class="hljs-type">Wi</span></span>-<span class="hljs-type"><span class="hljs-type">Fi</span></span>   , ,      <span class="hljs-number"><span class="hljs-number">1</span></span> . else if(wifi_station_get_connect_status() == <span class="hljs-type"><span class="hljs-type">STATION_CONNECT_FAIL</span></span>) { connState = <span class="hljs-type"><span class="hljs-type">WIFI_CONNECTING_ERROR</span></span>; <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">PLATFORM_DEBUG</span></span> ets_uart_printf(<span class="hljs-comment"><span class="hljs-comment">"WiFi connecting fail\r\n"</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> wifiErrorConnect++; os_timer_setfn(&amp;<span class="hljs-type"><span class="hljs-type">WiFiLinker</span></span>, (os_timer_func_t *)noolite_platform_check_ip, <span class="hljs-type"><span class="hljs-type">NULL</span></span>); os_timer_arm(&amp;<span class="hljs-type"><span class="hljs-type">WiFiLinker</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } //  <span class="hljs-type"><span class="hljs-type">Wi</span></span>-<span class="hljs-type"><span class="hljs-type">Fi</span></span> , ... else { os_timer_setfn(&amp;<span class="hljs-type"><span class="hljs-type">WiFiLinker</span></span>, (os_timer_func_t *)noolite_platform_check_ip, <span class="hljs-type"><span class="hljs-type">NULL</span></span>); os_timer_arm(&amp;<span class="hljs-type"><span class="hljs-type">WiFiLinker</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); connState = <span class="hljs-type"><span class="hljs-type">WIFI_CONNECTING</span></span>; wifiErrorConnect++; <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">PLATFORM_DEBUG</span></span> ets_uart_printf(<span class="hljs-comment"><span class="hljs-comment">"WiFi connecting...\r\n"</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> } controlServerStatus = <span class="hljs-number"><span class="hljs-number">0</span></span>; } } //    ,    <span class="hljs-type"><span class="hljs-type">ESP</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span>   <span class="hljs-type"><span class="hljs-type">STATIONAP</span></span>    static void <span class="hljs-type"><span class="hljs-type">ICACHE_FLASH_ATTR</span></span> noolite_platform_enter_configuration_mode(void) { wipe_flash_param(<span class="hljs-type"><span class="hljs-type">ESP_PARAM_SAVE_1</span></span>); wifi_set_opmode(<span class="hljs-type"><span class="hljs-type">STATIONAP_MODE</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">NOOLITE_LOGGING</span></span> ets_uart_printf(<span class="hljs-comment"><span class="hljs-comment">"Restarting in STATIONAP mode...\r\n"</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> system_restart(); } //   <span class="hljs-type"><span class="hljs-type">CONFMODE</span></span> (<span class="hljs-type"><span class="hljs-type">GPIO0</span></span>) void <span class="hljs-type"><span class="hljs-type">BtnInit</span></span>() { // . <span class="hljs-type"><span class="hljs-type">GPIO</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>  - <span class="hljs-type"><span class="hljs-type">PIN_FUNC_SELECT</span></span>(<span class="hljs-type"><span class="hljs-type">PERIPHS_IO_MUX_MTDI_U</span></span>, <span class="hljs-type"><span class="hljs-type">FUNC_GPIO0</span></span>); // . .  <span class="hljs-type"><span class="hljs-type">PIN_PULLUP_EN</span></span>(<span class="hljs-type"><span class="hljs-type">PERIPHS_IO_MUX_MTDI_U</span></span>); // . . <span class="hljs-type"><span class="hljs-type">ETS_GPIO_INTR_DISABLE</span></span>(); // .  .  <span class="hljs-type"><span class="hljs-type">ETS_GPIO_INTR_ATTACH</span></span>(input_intr_handler, <span class="hljs-type"><span class="hljs-type">NULL</span></span>); <span class="hljs-type"><span class="hljs-type">GPIO_DIS_OUTPUT</span></span>(<span class="hljs-type"><span class="hljs-type">BTN_CONFIG_GPIO</span></span>); //   <span class="hljs-type"><span class="hljs-type">GPIO_REG_WRITE</span></span>(<span class="hljs-type"><span class="hljs-type">GPIO_STATUS_W1TC_ADDRESS</span></span>, <span class="hljs-type"><span class="hljs-type">BIT</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)); // . gpio_pin_intr_state_set(<span class="hljs-type"><span class="hljs-type">GPIO_ID_PIN</span></span>(<span class="hljs-type"><span class="hljs-type">BTN_CONFIG_GPIO</span></span>), <span class="hljs-type"><span class="hljs-type">GPIO_PIN_INTR_NEGEDGE</span></span>); // .. <span class="hljs-type"><span class="hljs-type">ETS_GPIO_INTR_ENABLE</span></span>(); //  os_timer_disarm(&amp;<span class="hljs-type"><span class="hljs-type">DebounceTimer</span></span>); os_timer_setfn(&amp;<span class="hljs-type"><span class="hljs-type">DebounceTimer</span></span>, &amp;debounce_timer_cb, <span class="hljs-number"><span class="hljs-number">0</span></span>); } //  .  <span class="hljs-type"><span class="hljs-type">LOCAL</span></span> void input_intr_handler(void *arg) { //  <span class="hljs-type"><span class="hljs-type">GPIO</span></span> uint32 gpio_status = <span class="hljs-type"><span class="hljs-type">GPIO_REG_READ</span></span>(<span class="hljs-type"><span class="hljs-type">GPIO_STATUS_ADDRESS</span></span>); //  <span class="hljs-type"><span class="hljs-type">GPIO_REG_WRITE</span></span>(<span class="hljs-type"><span class="hljs-type">GPIO_STATUS_W1TC_ADDRESS</span></span>, gpio_status); // . <span class="hljs-type"><span class="hljs-type">ETS_GPIO_INTR_DISABLE</span></span>(); gpio_pin_intr_state_set(<span class="hljs-type"><span class="hljs-type">GPIO_ID_PIN</span></span>(<span class="hljs-type"><span class="hljs-type">BTN_CONFIG_GPIO</span></span>), <span class="hljs-type"><span class="hljs-type">GPIO_PIN_INTR_DISABLE</span></span>); // . <span class="hljs-type"><span class="hljs-type">ETS_GPIO_INTR_ENABLE</span></span>(); //   os_timer_arm(&amp;<span class="hljs-type"><span class="hljs-type">DebounceTimer</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-type"><span class="hljs-type">FALSE</span></span>); } //      <span class="hljs-type"><span class="hljs-type">CONFMODE</span></span> void <span class="hljs-type"><span class="hljs-type">ICACHE_FLASH_ATTR</span></span> debounce_timer_cb(void *arg) { <span class="hljs-type"><span class="hljs-type">ETS_GPIO_INTR_DISABLE</span></span>(); gpio_pin_intr_state_set(<span class="hljs-type"><span class="hljs-type">GPIO_ID_PIN</span></span>(<span class="hljs-type"><span class="hljs-type">BTN_CONFIG_GPIO</span></span>), <span class="hljs-type"><span class="hljs-type">GPIO_PIN_INTR_NEGEDGE</span></span>); <span class="hljs-type"><span class="hljs-type">ETS_GPIO_INTR_ENABLE</span></span>(); <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">NOOLITE_LOGGING</span></span> ets_uart_printf(<span class="hljs-comment"><span class="hljs-comment">"Button CONFMODE pressed, wiping configuration and restart in configuration mode...\r\n"</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> noolite_platform_enter_configuration_mode(); } //  void <span class="hljs-type"><span class="hljs-type">ICACHE_FLASH_ATTR</span></span> noolite_platform_init(void) { //    ,       <span class="hljs-number"><span class="hljs-number">4</span></span> tSetup nooLiteSetup; //    flash load_flash_param(<span class="hljs-type"><span class="hljs-type">ESP_PARAM_SAVE_1</span></span>, (uint32 *)&amp;nooLiteSetup, sizeof(tSetup)); //   <span class="hljs-type"><span class="hljs-type">CONFMODE</span></span> <span class="hljs-type"><span class="hljs-type">BtnInit</span></span>(); //   flash          <span class="hljs-type"><span class="hljs-type">STA</span></span>,   web-  if(nooLiteSetup.<span class="hljs-type"><span class="hljs-type">SetupOk</span></span> != <span class="hljs-type"><span class="hljs-type">SETUP_OK_KEY</span></span> || wifi_get_opmode() != <span class="hljs-type"><span class="hljs-type">STATION_MODE</span></span>) { //   wipe_flash_param(<span class="hljs-type"><span class="hljs-type">ESP_PARAM_SAVE_1</span></span>); //      <span class="hljs-type"><span class="hljs-type">STA</span></span>-<span class="hljs-type"><span class="hljs-type">AP</span></span>,  .   if(wifi_get_opmode() != <span class="hljs-type"><span class="hljs-type">STATIONAP_MODE</span></span>) { wifi_set_opmode(<span class="hljs-type"><span class="hljs-type">STATIONAP_MODE</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">NOOLITE_LOGGING</span></span> ets_uart_printf(<span class="hljs-comment"><span class="hljs-comment">"Restarting in STATIONAP mode...\r\n"</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> system_restart(); } char macaddr[<span class="hljs-number"><span class="hljs-number">6</span></span>]; //  <span class="hljs-type"><span class="hljs-type">MAC</span></span>   <span class="hljs-type"><span class="hljs-type">AP</span></span> wifi_get_macaddr(<span class="hljs-type"><span class="hljs-type">SOFTAP_IF</span></span>, macaddr); //   <span class="hljs-type"><span class="hljs-type">AP</span></span>   <span class="hljs-type"><span class="hljs-type">IP</span></span> struct ip_info ipinfo; <span class="hljs-type"><span class="hljs-type">IP4_ADDR</span></span>(&amp;ipinfo.ip, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-type"><span class="hljs-type">IP4_ADDR</span></span>(&amp;ipinfo.gw, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-type"><span class="hljs-type">IP4_ADDR</span></span>(&amp;ipinfo.netmask, <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); wifi_set_ip_info(<span class="hljs-type"><span class="hljs-type">SOFTAP_IF</span></span>, &amp;ipinfo); //   <span class="hljs-type"><span class="hljs-type">AP</span></span>  struct softap_config apConfig; os_memset(apConfig.ssid, <span class="hljs-number"><span class="hljs-number">0</span></span>, sizeof(apConfig.ssid)); os_sprintf(apConfig.ssid, <span class="hljs-comment"><span class="hljs-comment">"NOOLITE_%02x%02x%02x%02x%02x%02x"</span></span>, <span class="hljs-type"><span class="hljs-type">MAC2STR</span></span>(macaddr)); os_memset(apConfig.password, <span class="hljs-number"><span class="hljs-number">0</span></span>, sizeof(apConfig.password)); os_sprintf(apConfig.password, <span class="hljs-comment"><span class="hljs-comment">"%02x%02x%02x%02x%02x%02x"</span></span>, <span class="hljs-type"><span class="hljs-type">MAC2STR</span></span>(macaddr)); apConfig.authmode = <span class="hljs-type"><span class="hljs-type">AUTH_WPA_WPA2_PSK</span></span>; apConfig.channel = <span class="hljs-number"><span class="hljs-number">7</span></span>; apConfig.max_connection = <span class="hljs-number"><span class="hljs-number">255</span></span>; apConfig.ssid_hidden = <span class="hljs-number"><span class="hljs-number">0</span></span>; wifi_softap_set_config(&amp;apConfig); //  ,    , .noolite_platform.h <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">NOOLITE_LOGGING</span></span> char temp[<span class="hljs-number"><span class="hljs-number">80</span></span>]; os_sprintf(temp, <span class="hljs-comment"><span class="hljs-comment">"OPMODE: %u\r\n"</span></span>, wifi_get_opmode()); ets_uart_printf(temp); os_sprintf(temp, <span class="hljs-comment"><span class="hljs-comment">"SSID: %s\r\n"</span></span>, apConfig.ssid); ets_uart_printf(temp); os_sprintf(temp, <span class="hljs-comment"><span class="hljs-comment">"PASSWORD: %s\r\n"</span></span>, apConfig.password); ets_uart_printf(temp); os_sprintf(temp, <span class="hljs-comment"><span class="hljs-comment">"CHANNEL: %u\r\n"</span></span>, apConfig.channel); ets_uart_printf(temp); os_sprintf(temp, <span class="hljs-comment"><span class="hljs-comment">"CONFIGURATION WEB SERVER IP: "</span></span> <span class="hljs-type"><span class="hljs-type">IPSTR</span></span> <span class="hljs-comment"><span class="hljs-comment">"\r\n"</span></span>, <span class="hljs-type"><span class="hljs-type">IP2STR</span></span>(&amp;ipinfo.ip)); ets_uart_printf(temp); ets_uart_printf(<span class="hljs-comment"><span class="hljs-comment">"Starting nooLite configuration web server...\r\n"</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> //    noolite_config_server_init(); } else //     { <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">NOOLITE_LOGGING</span></span> ets_uart_printf(<span class="hljs-comment"><span class="hljs-comment">"Starting in normal mode...\r\n"</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> //     <span class="hljs-type"><span class="hljs-type">STA</span></span> if(wifi_get_opmode() != <span class="hljs-type"><span class="hljs-type">STATION_MODE</span></span>) { <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">NOOLITE_LOGGING</span></span> ets_uart_printf(<span class="hljs-comment"><span class="hljs-comment">"Restarting in STATION mode...\r\n"</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> wifi_set_opmode(<span class="hljs-type"><span class="hljs-type">STATION_MODE</span></span>); system_restart(); } //  .    <span class="hljs-type"><span class="hljs-type">STA</span></span>,     <span class="hljs-type"><span class="hljs-type">MAC</span></span>  <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">NOOLITE_LOGGING</span></span> char temp[<span class="hljs-number"><span class="hljs-number">80</span></span>]; uint8 bssid[<span class="hljs-number"><span class="hljs-number">6</span></span>]; struct station_config stationConf; wifi_station_get_config(&amp;stationConf); os_sprintf(temp, <span class="hljs-comment"><span class="hljs-comment">"OPMODE: %u\r\n"</span></span>, wifi_get_opmode()); ets_uart_printf(temp); os_sprintf(temp, <span class="hljs-comment"><span class="hljs-comment">"AP SSID: %s\r\n"</span></span>, stationConf.ssid); ets_uart_printf(temp); os_sprintf(temp, <span class="hljs-comment"><span class="hljs-comment">"AP PASSWORD: %s\r\n"</span></span>, stationConf.password); ets_uart_printf(temp); wifi_get_macaddr(<span class="hljs-type"><span class="hljs-type">STATION_IF</span></span>, bssid); os_sprintf(temp, <span class="hljs-comment"><span class="hljs-comment">"STA MACADDR: "</span></span> <span class="hljs-type"><span class="hljs-type">MACSTR</span></span> <span class="hljs-comment"><span class="hljs-comment">"\r\n"</span></span>, <span class="hljs-type"><span class="hljs-type">MAC2STR</span></span>(bssid)); ets_uart_printf(temp); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">NOOLITE_LOGGING</span></span> ets_uart_printf(<span class="hljs-comment"><span class="hljs-comment">"System initialization done!\r\n"</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> //     wi-fi   <span class="hljs-type"><span class="hljs-type">AP</span></span> os_timer_disarm(&amp;<span class="hljs-type"><span class="hljs-type">WiFiLinker</span></span>); os_timer_setfn(&amp;<span class="hljs-type"><span class="hljs-type">WiFiLinker</span></span>, (os_timer_func_t *)noolite_platform_check_ip, <span class="hljs-type"><span class="hljs-type">NULL</span></span>); os_timer_arm(&amp;<span class="hljs-type"><span class="hljs-type">WiFiLinker</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } }</code> </pre></div></div><br>  I see no point in describing the noolite_config_server.c file, it is launching a web server in configuration mode, by the principle of operation it is similar to the work in normal mode, which we will consider below. <br>  The implementation of the web server is very simple and does not pretend to be flexible and functional, and moreover, implementing the web server on ESP8266 is not entirely correct, the more correct approach is to organize a TCP client on the ESP8266 that will keep the connection to the management server, and the management server already has to organize a full-fledged interaction interface (RESTfull or JSON) with the external environment; under the external environment, I mean the Web interface, various mobile and stationary clients (Windows, Android, iOS, etc.) <br><br>  The appearance of the web-interface pages turned out this, the interface is very simple: <br><br><div class="spoiler">  <b class="spoiler_title">Configuration Mode, Main Page</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/45a/dda/251/45adda251eb44b0994b638728f64aa96.png"></div></div><br>  When you click on Return to normal mode, the board returns to normal mode. <br><br><div class="spoiler">  <b class="spoiler_title">Configuration Mode, WiFi Connection Setup Page</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/8a5/667/3eb/8a56673eb6b74cecb30c741d60f333e4.png"></div></div><br><div class="spoiler">  <b class="spoiler_title">Configuration mode, deviveID setup page</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/8f7/6ec/f1e/8f76ecf1eb2d484297add5d076611db0.png"></div></div><br><div class="spoiler">  <b class="spoiler_title">Main mode, main page</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/806/99d/367/80699d367a264d5bbf71ab57f5d3ded9.png"></div></div><br>  The deviceID page is used to get our device number for some auxiliary tasks; it simply gives out a number without any design. <br><br><div class="spoiler">  <b class="spoiler_title">Main mode, deviceID page</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/f7c/7af/606/f7c7af6061254ec5886328be963dc91e.png"></div></div><br><div class="spoiler">  <b class="spoiler_title">Main Mode, Power Block Binding Page</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/0a2/c1c/281/0a2c1c281eee46bcb4df4680841d8900.png"></div></div><br><div class="spoiler">  <b class="spoiler_title">Main mode, power unit control page</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/2c2/be1/e1e/2c2be1e1e3034fae875dcd197a4fe183.png"></div></div><br>  Implementing all this in code: <br><br><div class="spoiler">  <b class="spoiler_title">File noolite_control_server.c</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#include "ets_sys.h" #include "osapi.h" #include "user_interface.h" #include "mem.h" #include "espconn.h" #include "driver/uart.h" #include "noolite_control_server.h" #include "flash_param.h" #include "noolite_platform.h" static struct espconn esp_conn; static esp_tcp esptcp; static unsigned char killConn; // http  404 static const char *http404Header = "HTTP/1.0 404 Not Found\r\nServer: nooLite-Control-Server\r\nContent-Type: text/plain\r\n\r\nNot Found (or method not implemented).\r\n"; // http  200 static const char *http200Header = "HTTP/1.0 200 OK\r\nServer: nooLite-Control-Server/0.1\r\nContent-Type: text/html\r\n"; // html ,   static const char *pageStart = "&lt;html&gt;&lt;head&gt;&lt;title&gt;nooLite Control Panel&lt;/title&gt;&lt;style&gt;body{font-family: Arial}&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;form method=\"get\" action=\"/\"&gt;&lt;input type=\"hidden\" name=\"set\" value=\"1\"&gt;\r\n"; // html ,   static const char *pageEnd = "&lt;/form&gt;&lt;hr&gt;(c) 2014 by &lt;a href=\"mailto:sleuthhound@gmail.com\" target=\"_blank\"&gt;Mikhail Grigorev&lt;/a&gt;, &lt;a href=\"http://programs74.ru\" target=\"_blank\"&gt;programs74.ru&lt;/a&gt;\r\n&lt;/body&gt;&lt;/html&gt;\r\n"; //  html  static const char *pageIndex = "&lt;h2&gt;Welcome to nooLite Control Panel&lt;/h2&gt;nooLite Control deviceID: {deviceid}&lt;ul&gt;&lt;li&gt;&lt;a href=\"?page=devid\"&gt;Get deviceID&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=\"?page=bind\"&gt;nooLite bind-unbind channel&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=\"?page=control\"&gt;nooLite control&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;\r\n"; // html       static const char *pageSetBindChannel = "&lt;h2&gt;&lt;a href=\"/\"&gt;Home&lt;/a&gt; / nooLite bind-unbind channel&lt;/h2&gt;&lt;input type=\"hidden\" name=\"page\" value=\"bind\"&gt;&lt;table border=\"0\"&gt;&lt;tr&gt;&lt;td&gt;&lt;b&gt;Channel #:&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;input type=\"text\" name=\"channel\" value=\"{channel}\" size=\"5\"&gt; 0 .. 32&lt;/td&gt;&lt;/tr&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;b&gt;Status:&lt;/b&gt;&lt;/td&gt;&lt;td&gt;{status}&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;input type=\"submit\" name = \"action\" value=\"Bind\"&gt;&lt;input type=\"submit\" name = \"action\" value=\"Unbind\"&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\r\n"; // html     static const char *pageSetNooliteControl = "&lt;h2&gt;&lt;a href=\"/\"&gt;Home&lt;/a&gt; / nooLite control&lt;/h2&gt;&lt;input type=\"hidden\" name=\"page\" value=\"control\"&gt;&lt;table border=\"0\"&gt;&lt;tr&gt;&lt;td&gt;&lt;b&gt;Channel #:&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;input type=\"text\" name=\"channel\" value=\"{channel}\" size=\"5\"&gt; 0 .. 32&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;b&gt;Status:&lt;/b&gt;&lt;/td&gt;&lt;td&gt;{status}&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;input type=\"submit\" name = \"action\" value=\"On\"&gt;&lt;input type=\"submit\" name = \"action\" value=\"Off\"&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\r\n"; static const char *pageCommandSent = "&lt;br&gt;&lt;b style=\"color: green\"&gt;Command sent!&lt;/b&gt;\r\n"; // html  ID ,     static const char *pageDevID = "{deviceid}"; int recvOK = 0; static void recvTask(os_event_t *events); //     UART  nooLite MT1132 //       http://www.noo.com.by/assets/files/PDF/MT1132.pdf static int ICACHE_FLASH_ATTR noolite_sendCommand(unsigned char channel, unsigned char command, unsigned char data, unsigned char format) { unsigned char buf[12]; unsigned int i; int checkSum = 0; recvOK = 0; os_memset(buf, 0, 12); buf[0] = 85; buf[1] = 80; buf[2] = command; buf[3] = format; buf[5] = channel; buf[6] = data; for(i = 0;i&lt;10;i++){ checkSum+= buf[i]; } buf[10] = lowByte(checkSum); buf[11] = 170; uart0_tx_buffer(&amp;buf, 12); sleepms(300); return recvOK; } #ifdef NOOLITE_LOGGING static void ICACHE_FLASH_ATTR noolite_control_server_recon(void *arg, sint8 err) { ets_uart_printf("noolite_control_server_recon\r\n"); } #endif #ifdef NOOLITE_LOGGING static void ICACHE_FLASH_ATTR noolite_control_server_discon(void *arg) { ets_uart_printf("noolite_control_server_discon\r\n"); } #endif //   static void ICACHE_FLASH_ATTR noolite_control_server_recv(void *arg, char *data, unsigned short len) { struct espconn *ptrespconn = (struct espconn *)arg; //   GET  if(os_strncmp(data, "GET ", 4) == 0) { char page[16]; os_memset(page, 0, sizeof(page)); //  GET     page noolite_control_server_get_key_val("page", sizeof(page), data, page); //  page=devid,     device id if(os_strncmp(page, "devid", 5) == 0 &amp;&amp; strlen(page) == 5) { noolite_control_server_deviceid_page(ptrespconn, page, data); } else { //    noolite_control_server_process_page(ptrespconn, page, data); } return; } else //     ,   http404Header { espconn_sent(ptrespconn, (uint8 *)http404Header, os_strlen(http404Header)); killConn = 1; return; } } //     device id static void ICACHE_FLASH_ATTR noolite_control_server_deviceid_page(struct espconn *ptrespconn, char *page, char *request) { //    flash tSetup nooliteSetup; load_flash_param(ESP_PARAM_SAVE_1, (uint32 *)&amp;nooliteSetup, sizeof(tSetup)); //  pageDevID     {},          char *stream = (char *)pageDevID; char templateKey[16]; os_memset(templateKey, 0, sizeof(templateKey)); unsigned char templateKeyIdx; while(*stream) { if(*stream == '{') { templateKeyIdx = 0; stream++; while(*stream != '}') { templateKey[templateKeyIdx++] = *stream; stream++; } //   {deviceid}   device id     if(os_strncmp(templateKey, "deviceid", 6) == 0) { char deviceid[3]; char i; for(i=0; i&lt;16; i++) { os_sprintf(deviceid, "%02x", nooliteSetup.deviceId[i]); espconn_sent(ptrespconn, (uint8 *)deviceid, os_strlen(deviceid)); } } } else { espconn_sent(ptrespconn, (uint8 *)stream, 1); } stream++; } killConn = 1; } //     static void ICACHE_FLASH_ATTR noolite_control_server_process_page(struct espconn *ptrespconn, char *page, char *request) { //  http200Header espconn_sent(ptrespconn, (uint8 *)http200Header, os_strlen(http200Header)); espconn_sent(ptrespconn, (uint8 *)"\r\n", 2); //  pageStart espconn_sent(ptrespconn, (uint8 *)pageStart, os_strlen(pageStart)); //   char set[2] = {'0', '\0'}; noolite_control_server_get_key_val("set", sizeof(set), request, set); char channel_num[2] = "0"; char status[32] = "[status]"; char action[10] = "unbind"; os_memset(channel_num, 0, sizeof(channel_num)); os_memset(status, 0, sizeof(status)); os_memset(action, 0, sizeof(action)); //   pageSetBindChannel if(os_strncmp(page, "bind", 4) == 0 &amp;&amp; strlen(page) == 4) { //    set     pageSetBindChannel //   1,  ,            ,      if(set[0] == '1') { //   ,     (  ) noolite_control_server_get_key_val("channel", sizeof(channel_num), request, channel_num); noolite_control_server_get_key_val("action", sizeof(action), request, action); //    MT1132 // noolite_sendCommand(channel, command, data, format) // channel = 0 .. 32 // command = 15 - bind // command = 9 - unbind // command = 2 - on // command = 0 - off //      ,  MT1132    OK  UART //         uart.c,        (.    system_os_task),   uart.c   0 //   ,   0  32 if(atoi(channel_num) &gt;= 0 &amp;&amp; atoi(channel_num) &lt;= 32) { //  if(os_strncmp(action, "Bind", 4) == 0 &amp;&amp; strlen(action) == 4) { if(noolite_sendCommand(atoi(channel_num), 15, 0, 0)) { os_sprintf(status, "Bind OK"); } else { os_sprintf(status, "Bind ERR"); } //  } else if(os_strncmp(action, "Unbind", 6) == 0 &amp;&amp; strlen(action) == 6) { if(noolite_sendCommand(atoi(channel_num), 9, 0, 0)) { os_sprintf(status, "Unbind OK"); } else { os_sprintf(status, "Unbind ERR"); } } else { os_sprintf(status, "Err"); } } else { os_sprintf(status, "Err"); } } //     char *stream = (char *)pageSetBindChannel; char templateKey[16]; os_memset(templateKey, 0, sizeof(templateKey)); unsigned char templateKeyIdx; while(*stream) { if(*stream == '{') { templateKeyIdx = 0; stream++; while(*stream != '}') { templateKey[templateKeyIdx++] = *stream; stream++; } //    {}    if(os_strncmp(templateKey, "channel", 7) == 0) { if(strlen(channel_num) == 0) os_sprintf(channel_num, "0"); espconn_sent(ptrespconn, (uint8 *)channel_num, os_strlen(channel_num)); } else if(os_strncmp(templateKey, "status", 6) == 0) { if(strlen(status) == 0) { os_sprintf(status, "[status]"); } espconn_sent(ptrespconn, (uint8 *)status, os_strlen(status)); } } else { espconn_sent(ptrespconn, (uint8 *)stream, 1); } stream++; } //  pageCommandSent if(set[0] == '1') { espconn_sent(ptrespconn, (uint8 *)pageCommandSent, os_strlen(pageCommandSent)); } } //   pageSetNooliteControl,      else if(os_strncmp(page, "control", 7) == 0 &amp;&amp; strlen(page) == 7) { if(set[0] == '1') { noolite_control_server_get_key_val("channel", sizeof(channel_num), request, channel_num); noolite_control_server_get_key_val("action", sizeof(action), request, action); // noolite_sendCommand(channel, command, data, format) // channel = 0 .. 32 // command = 15 - bind // command = 9 - unbind // command = 2 - on // command = 0 - off if(atoi(channel_num) &gt;= 0 &amp;&amp; atoi(channel_num) &lt;= 32) { if(os_strncmp(action, "On", 2) == 0 &amp;&amp; strlen(action) == 2) { if(noolite_sendCommand(atoi(channel_num), 2, 0, 0)) { os_sprintf(status, "On"); } else { os_sprintf(status, "On ERR"); } } else if(os_strncmp(action, "Off", 3) == 0 &amp;&amp; strlen(action) == 3) { if (noolite_sendCommand(atoi(channel_num), 0, 0, 0)) { os_sprintf(status, "Off"); } else { os_sprintf(status, "Off ERR"); } } else { os_sprintf(status, "Err"); } } else { os_sprintf(status, "Err"); } } char *stream = (char *)pageSetNooliteControl; char templateKey[16]; os_memset(templateKey, 0, sizeof(templateKey)); unsigned char templateKeyIdx; while(*stream) { if(*stream == '{') { templateKeyIdx = 0; stream++; while(*stream != '}') { templateKey[templateKeyIdx++] = *stream; stream++; } // send the replacing value now if(os_strncmp(templateKey, "channel", 7) == 0) { if(strlen(channel_num) == 0 ) os_sprintf(channel_num, "0"); espconn_sent(ptrespconn, (uint8 *)channel_num, os_strlen(channel_num)); } else if(os_strncmp(templateKey, "status", 6) == 0) { if(strlen(status) == 0) { os_sprintf(status, "[status]"); } espconn_sent(ptrespconn, (uint8 *)status, os_strlen(status)); } } else { espconn_sent(ptrespconn, (uint8 *)stream, 1); } stream++; } if(set[0] == '1') { espconn_sent(ptrespconn, (uint8 *)pageCommandSent, os_strlen(pageCommandSent)); } } else //    pageIndex  device id { tSetup nooliteSetup; load_flash_param(ESP_PARAM_SAVE_1, (uint32 *)&amp;nooliteSetup, sizeof(tSetup)); char *stream = (char *)pageIndex; char templateKey[16]; os_memset(templateKey, 0, sizeof(templateKey)); unsigned char templateKeyIdx; while(*stream) { if(*stream == '{') { templateKeyIdx = 0; stream++; while(*stream != '}') { templateKey[templateKeyIdx++] = *stream; stream++; } //  {deviceid} if(os_strncmp(templateKey, "deviceid", 6) == 0) { char deviceid[3]; char i; for(i=0; i&lt;16; i++) { os_sprintf(deviceid, "%02x", nooliteSetup.deviceId[i]); espconn_sent(ptrespconn, (uint8 *)deviceid, os_strlen(deviceid)); } } } else { espconn_sent(ptrespconn, (uint8 *)stream, 1); } stream++; } } //  pageEnd espconn_sent(ptrespconn, (uint8 *)pageEnd, os_strlen(pageEnd)); killConn = 1; } //         key=value static unsigned char ICACHE_FLASH_ATTR noolite_control_server_get_key_val(char *key, unsigned char maxlen, char *str, char *retval) { unsigned char found = 0; char *keyptr = key; char prev_char = '\0'; *retval = '\0'; while( *str &amp;&amp; *str!='\r' &amp;&amp; *str!='\n' &amp;&amp; !found ) { if(*str == *keyptr) { if(keyptr == key &amp;&amp; !( prev_char == '?' || prev_char == '&amp;' ) ) { str++; continue; } keyptr++; if (*keyptr == '\0') { str++; keyptr = key; if (*str == '=') { found = 1; } } } else { keyptr = key; } prev_char = *str; str++; } if(found == 1) { found = 0; while( *str &amp;&amp; *str!='\r' &amp;&amp; *str!='\n' &amp;&amp; *str!=' ' &amp;&amp; *str!='&amp;' &amp;&amp; maxlen&gt;0 ) { *retval = *str; maxlen--; str++; retval++; found++; } *retval = '\0'; } return found; } // callback ,     static void ICACHE_FLASH_ATTR noolite_control_server_sent(void *arg) { struct espconn *pesp_conn = (struct espconn *)arg; if (pesp_conn == NULL) { return; } if(killConn) { espconn_disconnect(pesp_conn); } } // callback ,     static void ICACHE_FLASH_ATTR noolite_control_server_connect(void *arg) { struct espconn *pesp_conn = (struct espconn *)arg; #ifdef NOOLITE_LOGGING ets_uart_printf("noolite_control_server_connect\r\n"); #endif //   callback  espconn_regist_recvcb(pesp_conn, noolite_control_server_recv); espconn_regist_sentcb(pesp_conn, noolite_control_server_sent); #ifdef NOOLITE_LOGGING espconn_regist_reconcb(pesp_conn, noolite_control_server_recon); espconn_regist_disconcb(pesp_conn, noolite_control_server_discon); #endif } //    we- void ICACHE_FLASH_ATTR noolite_control_server_init() { #ifdef NOOLITE_LOGGING ets_uart_printf("noolite_control_server_init()\r\n"); #endif esptcp.local_port = 80; esp_conn.type = ESPCONN_TCP; esp_conn.state = ESPCONN_NONE; esp_conn.proto.tcp = &amp;esptcp; //  callback  espconn_regist_connectcb(&amp;esp_conn, noolite_control_server_connect); espconn_accept(&amp;esp_conn); //         UART //  uart.c            MT1132 (. uart0_rx_intr_handler) //   OK,    0    system_os_post(recvTaskPrio, 0, atHead); os_event_t *recvTaskQueue = (os_event_t *)os_malloc(sizeof(os_event_t) * recvTaskQueueLen); system_os_task(recvTask, recvTaskPrio, recvTaskQueue, recvTaskQueueLen); } //    static void ICACHE_FLASH_ATTR recvTask(os_event_t *events) { switch (events-&gt;sig) { case 0: //    0,        recvOK = 1 #ifdef NOOLITE_LOGGING ets_uart_printf("nooLite MT1132 sent OK\r\n"); #endif recvOK = 1; break; default: break; } }</span></span></code> </pre> </div></div><br>  And finally a small video demonstrating how the board works: <br><div class="spoiler">  <b class="spoiler_title">Demonstration of the Espressif ESP8266 and the module nooLite MT1132</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/V7yl6m_5PH8%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjCGs0iJ30EOkRFj7eEFZSFdpiwpQ" frameborder="0" allowfullscreen=""></iframe></div></div><br>  In general, we once again see that the capabilities of the board on the ESP8266 chip are quite large. <br><br>  In conclusion, I would like to thank the company <a href="http://www.noo.com.by/">Notekhnika</a> , as well as the administration of the site <a href="http://thinking-home.ru/">Thinking-Home.RU</a> for providing nooLite equipment for testing. <br><br>  <a href="https://github.com/CHERTS/esp8266-noolite/tree/master">Project repository on Github</a> <br><br>  PS If someone has any wishes regarding the next article about ESP8266, then I am ready to listen to them.  You can write about working with different sensors: DS18B20, DHT22, SHT21, BMP180, IR receiver / transmitter, external memory ms, for example Microchip 24xx16 series, etc. </div><p>Source: <a href="https://habr.com/ru/post/364113/">https://habr.com/ru/post/364113/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../364099/index.html">There is less freedom on the Internet</a></li>
<li><a href="../364101/index.html">Rovio's profit declined by half, 110 employees will be laid off</a></li>
<li><a href="../364103/index.html">Ultimate Ears launched a line of Hi-End headphones printed on a 3D printer</a></li>
<li><a href="../364105/index.html">Idea for smartphone</a></li>
<li><a href="../364107/index.html">Curiosity discovered traces of lakes on Mars</a></li>
<li><a href="../364115/index.html">Gaming laptop? Buy two separate computers are cheaper</a></li>
<li><a href="../364117/index.html">Android Studio 1.0: Google's first stable IDE</a></li>
<li><a href="../364119/index.html">What happened in the world of finance in a week # 2</a></li>
<li><a href="../364123/index.html">The Riddle of the Dunes on Titan</a></li>
<li><a href="../364125/index.html">Wearable electronics: how to design your own hands</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>