<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>TensorFlow.js and clmtrackr.js: tracking the direction of the user's gaze in the browser</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The author of the article, the translation of which we publish, offers to talk about solving tasks from the field of computer vision solely by means o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>TensorFlow.js and clmtrackr.js: tracking the direction of the user's gaze in the browser</h1><div class="post__text post__text-html js-mediator-article">  The author of the article, the translation of which we publish, offers to talk about solving tasks from the field of computer vision solely by means of a web browser.  Solving this problem is not so difficult thanks to the <a href="https://js.tensorflow.org/">TensorFlow</a> JavaScript library.  Instead of training your own model and offering it to users as part of the finished product, we will give them the opportunity to independently collect data and train the model directly in the browser, on their own computer.  With this approach, server data processing is completely unnecessary. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1n/6k/57/1n6k57nn-wdkux5hhohvjnyadve.jpeg"></div><br>  You can try what this material is about to create <a href="https://cpury.github.io/lookie-lookie/">here</a> .  For this you need a modern browser, a webcam and a mouse.  <a href="https://github.com/cpury/lookie-lookie">Here is the</a> source code of the project.  It is not designed to work on mobile devices, the author of the material said that he did not have time for the appropriate improvements.  In addition, he notes that the task considered here will become more complicated if you have to process the video stream from a moving camera. <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Idea</font> </h2><br>  Let's use machine learning technologies to find out exactly where the user is looking when looking at a web page.  Do this by watching his eyes with a webcam. <br><br>  In the browser it is very easy to access the webcam.  If we assume that the entire image from the camera will be used as input for the neural network, then we can say that it is too large for this purpose.  The system will have to do a great job only to determine the place on the image where the eyes are.  Such an approach can show itself well if we are talking about a model that the developer teaches independently and deploys on the server, but if we are talking about learning and using the model in the browser, this is too much. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In order to facilitate the task of the network, we can provide it with only a part of the image - the one that contains the user's eyes and a small area around them.  This area, which is a rectangle surrounding the eyes, can be identified using a third-party library.  Therefore, the first part of our work looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pg/fc/fp/pgfcfppfo3_6wddvm58zikfoqlw.png"></div><br>  <i><font color="#999999">Webcam input, face recognition, eye detection, cropped image</font></i> <br><br>  I used the library called <a href="https://github.com/auduno/clmtrackr">clmtrackr</a> to detect faces in the image.  It is not perfect, but is small in size, good performance, and, in general, adequately copes with its task. <br><br>  If as an input for a simple convolutional neural network, a small but cleverly chosen image is used, the network can learn without any problems.  This is what this process looks like: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yh/k_/th/yhk_thr05faoc09immbn8fz1vou.png"></div><br>  <i><font color="#999999">The input image, the model is a convolutional neural network, the coordinates, the position predicted by the network on the page where the user is looking.</font></i> <br><br>  Here will be described a fully working minimal implementation of the idea discussed in this section.  A project whose code is in <a href="https://github.com/cpury/lookie-lookie">this</a> repository has many additional features. <br><br><h2>  <font color="#3AC1EF">Training</font> </h2><br>  To get started, <code>clmtrackr.js</code> from the corresponding <a href="">repository</a> .  We'll start the work with an empty HTML file in which jQuery, TensorFlow.js, clmtrackr.js and <code>main.js</code> file are <code>main.js</code> with our code, which we will work on a little later: <br><br><pre> <code class="hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!doctype html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://code.jquery.com/jquery-3.3.1.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.12.0"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"clmtrackr.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"main.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">Getting video stream from a webcam</font> </h2><br>  In order to activate the webcam and display the video stream on the page, we will need to obtain the user's permission.  Here I do not provide code that solves the problem of compatibility of the project with different browsers.  We will proceed from the assumption that our users work on the Internet using the latest version of Google Chrome. <br><br>  Add the following code to the HTML file.  It must be located within the <code>&lt;body&gt;</code> , but above the <code>&lt;script&gt;</code> tags: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">video</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"webcam"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"400"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"300"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">autoplay</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">video</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Now let's work on the <code>main.js</code> file: <br><br><pre> <code class="hljs javascript">$(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>).ready(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> video = $(<span class="hljs-string"><span class="hljs-string">'#webcam'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onStreaming</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stream</span></span></span><span class="hljs-function">) </span></span>{   video.srcObject = stream; } navigator.mediaDevices.getUserMedia({ <span class="hljs-attr"><span class="hljs-attr">video</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }).then(onStreaming); });</code> </pre> <br>  Try this code for yourself.  When you open the page, the browser must request permission, and then a picture from the webcam will appear on the screen. <br><br>  Later we will extend the <code>onStreaming()</code> function code. <br><br><h2>  <font color="#3AC1EF">Face search</font> </h2><br>  Now let's use the clmtrackr.js library to search for faces on the video.  To begin, initialize the face tracking system by adding the following code after <code>const video = ...</code> : <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ctrack = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> clm.tracker(); ctrack.init();</code> </pre> <br>  Now, in the <code>onStreaming()</code> function, we connect the face search system by adding the following command: <br><br><pre> <code class="hljs pgsql">ctrack.<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>(video);</code> </pre> <br>  That's all we need.  Now the system will be able to recognize a face in a video stream. <br><br>  Do not believe?  Let us, in order for you to be convinced of this, draw a ‚Äúmask‚Äù around the face. <br>  In order to do this, we need to display the image on top of the element responsible for displaying the video.  You can draw something on HTML pages using the <code>&lt;canvas&gt;</code> .  Therefore, we will create such an element, putting it on the element that displays the video.  This will help us with the following code, which must be added to the HTML file under the <code>&lt;video&gt;</code> element already existing there: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"overlay"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"400"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"300"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css">   </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#webcam</span></span></span><span class="css">, </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#overlay</span></span></span><span class="css"> {       </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">position</span></span></span><span class="css">: absolute;       </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">top</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">;       </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">left</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">;   } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  If you want, you can move the inline style to a separate CSS file. <br><br>  Here we added a <code>&lt;canvas&gt;</code> element to the page of the same size as the <code>&lt;video&gt;</code> element.  The fact that the elements will be located in the same position is provided by the styles used here. <br><br>  Now, every time the browser displays the next frame of the video, we are going to draw something on the <code>&lt;canvas&gt;</code> .  The execution of any code during the output of each frame is performed using the <code>requestAnimationLoop()</code> mechanism.  Before we put anything into the <code>&lt;canvas&gt;</code> , we need to remove from it what was on it before, clearing it.  We can then suggest that <code>clmtrackr</code> perform graphics output directly on the <code>&lt;canvas&gt;</code> . <br><br>  Here is the code that implements what we just talked about.  You need to add it below the <code>ctrack.init()</code> command: <br><br><pre> <code class="hljs matlab">const overlay = $(<span class="hljs-string"><span class="hljs-string">'#overlay'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]; const overlayCC = overlay.getContext(<span class="hljs-string"><span class="hljs-string">'2d'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackingLoop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { // ,     , //     -   . </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestAnimationFrame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(trackingLoop)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">let</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">currentPosition</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ctrack</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCurrentPosition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">overlayCC</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clearRect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(0, 0, 400, 300)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(currentPosition)</span></span></span><span class="hljs-function"> {   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ctrack</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">draw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(overlay)</span></span></span><span class="hljs-function">; } }</span></span></code> </pre> <br>  Now we call the <code>trackingLoop()</code> function in the <code>onStreaming()</code> function immediately after <code>ctrack.start()</code> .  This function will plan its own restart itself in each frame. <br><br>  Refresh the page and look at the webcam.  You should see a green ‚Äúmask‚Äù around the face in the video window.  Sometimes in order for the system to correctly recognize the face, you need to move your head slightly in the frame. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/394/ab1/98a/394ab198a25c82f7a6c03eefdbe7c73c.png"></div><br>  <i><font color="#999999">Face recognition results</font></i> <br><br><h2>  <font color="#3AC1EF">Identify the area of ‚Äã‚Äãthe image containing the eyes</font> </h2><br>  Now we need to find the rectangular area of ‚Äã‚Äãthe image in which the eyes are located, and place it on a separate <code>&lt;canvas&gt;</code> . <br><br>  Fortunately, cmltracker gives us not only information about the location of the face, but also 70 control points.  If you look at the <a href="https://www.auduno.com/clmtrackr/docs/reference.html">documentation</a> for cmltracker, you can choose exactly the control points that we need. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6e7/334/c6f/6e7334c6fa51c5c55ebd66b45d0d8dd8.png"></div><br>  <i><font color="#999999">Control points</font></i> <br><br>  Let us decide that the eyes are a rectangular part of the image, the borders of which touch the points 23, 28, 24 and 26, extended by 5 pixels in each direction.  This rectangle should include everything that is important to us, unless the user tilts his head too much. <br><br>  Now, before we can take advantage of this image fragment, we need another <code>&lt;canvas&gt;</code> for its output.  Its size will be 50x25 pixels.  A rectangle with eyes will be inscribed in this element.  Small deformations of the image are not a problem. <br><br>  Add this code to the HTML file, which describes the <code>&lt;canvas&gt;</code> , into which that part of the image that has eyes: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"eyes"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"50"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"25"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css">   </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#eyes</span></span></span><span class="css"> {       </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">position</span></span></span><span class="css">: absolute;       </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">top</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">;       </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">right</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">;   } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  The following function will return the <code>x</code> and <code>y</code> coordinates, as well as the width and height of the rectangle surrounding the eye.  She, as input, takes an array of <code>positions</code> , obtained from clmtrackr.  Note that each coordinate obtained from clmtrackr has components <code>x</code> and <code>y</code> .  This function should be added to <code>main.js</code> : <br><br><pre> <code class="hljs markdown">function getEyesRectangle(positions) { const minX = positions[<span class="hljs-string"><span class="hljs-string">23</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">0</span></span>] - 5; const maxX = positions[<span class="hljs-string"><span class="hljs-string">28</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">0</span></span>] + 5; const minY = positions[<span class="hljs-string"><span class="hljs-string">24</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">1</span></span>] - 5; const maxY = positions[<span class="hljs-string"><span class="hljs-string">26</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">1</span></span>] + 5; const width = maxX - minX; const height = maxY - minY; return [minX, minY, width, height]; }</code> </pre> <br>  Now, in each frame, we are going to extract a rectangle with eyes from the video stream, circle it with a red line on the <code>&lt;canvas&gt;</code> element that is superimposed on the <code>&lt;video&gt;</code> element, and then copy it into a new <code>&lt;canvas&gt;</code> .  Please note that in order to correctly identify the area we need, we will calculate the <code>resizeFactorX</code> and <code>resizeFactorY</code> . <br><br>  Replace the following code with an <code>if</code> block in the <code>trackingLoop()</code> function: <br><br><pre> <code class="hljs ruby"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentPosition) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  ,     /<span class="hljs-regexp"><span class="hljs-regexp">/   &lt;canvas&gt;,    &lt;video&gt; ctrack.draw(overlay); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  ,  ,    /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   const eyesRect = getEyesRectangle(currentPosition); overlayCC.strokeStyle = 'red'; overlayCC.strokeRect(eyesRect[0], eyesRect[1], eyesRect[2], eyesRect[3]); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      , /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/        /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      const resizeFactorX = video.videoWidth /</span></span> video.width; const resizeFactorY = video.videoHeight / video.height; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>          /<span class="hljs-regexp"><span class="hljs-regexp">/    &lt;canvas&gt; const eyesCanvas = $('#eyes')[0]; const eyesCC = eyesCanvas.getContext('2d'); eyesCC.drawImage(   video,   eyesRect[0] * resizeFactorX, eyesRect[1] * resizeFactorY,   eyesRect[2] * resizeFactorX, eyesRect[3] * resizeFactorY,   0, 0, eyesCanvas.width, eyesCanvas.height ); }</span></span></code> </pre> <br>  Reloading the page now, you should see the red rectangle around the eyes, and what contains this rectangle - in the corresponding <code>&lt;canvas&gt;</code> .  If your eyes are bigger than mine, experiment with the <code>getEyeRectangle</code> function. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6c8/29e/5a3/6c829e5a354575ed9c269bebf20c5a5a.png"></div><br>  <i><font color="#999999">A &lt;canvas&gt; element that displays a rectangle containing an image of the user's eyes.</font></i> <br><br><h2>  <font color="#3AC1EF">Data collection</font> </h2><br>  There are many ways to collect data.  I decided to use the information that can be obtained from the mouse and keyboard.  In our project, data collection looks like this. <br><br>  The user moves the cursor around the page and watches him with his eyes, pressing the <code></code> on the keyboard each time the program has to write another sample.  With this approach, it is easy to quickly collect a large set of data for learning the model. <br><br><h3>  <font color="#3AC1EF">‚ñçTracking mouse movements</font> </h3><br>  In order to find out exactly where the mouse pointer is located on the web page, we need the event handler <code>document.onmousemove</code> .  Our function, in addition, normalizes the coordinates so that they fit into the range [-1, 1]: <br><br><pre> <code class="hljs pgsql">//   : const mouse = { x: <span class="hljs-number"><span class="hljs-number">0</span></span>, y: <span class="hljs-number"><span class="hljs-number">0</span></span>, handleMouseMove: <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(event) {   //      ,    [<span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>]   mouse.x = (event.clientX / $(<span class="hljs-keyword"><span class="hljs-keyword">window</span></span>).width()) * <span class="hljs-number"><span class="hljs-number">2</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>;   mouse.y = (event.clientY / $(<span class="hljs-keyword"><span class="hljs-keyword">window</span></span>).height()) * <span class="hljs-number"><span class="hljs-number">2</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>; }, } document.onmousemove = mouse.handleMouseMove;</code> </pre> <br><h3>  <font color="#3AC1EF">‚ñç Image Capture</font> </h3><br>  To capture an image displayed by the <code>&lt;canvas&gt;</code> and save it as a tensor, TensorFlow.js offers an auxiliary function <code>tf.fromPixels()</code> .  Use it to save and then normalize the image from the <code>&lt;canvas&gt;</code> , which displays a rectangle containing the user's eyes: <br><br><pre> <code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getImage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { //       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tf.tidy(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {   const image = tf.fromPixels($(<span class="hljs-string"><span class="hljs-string">'#eyes'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]);   //  &lt;i&gt;&lt;font color=<span class="hljs-string"><span class="hljs-string">"#999999"</span></span>&gt;&lt;/font&gt;&lt;/i&gt;:   const batchedImage = image.expandDims(<span class="hljs-number"><span class="hljs-number">0</span></span>);   //    :   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> batchedImage.toFloat().div(tf.scalar(<span class="hljs-number"><span class="hljs-number">127</span></span>)).<span class="hljs-built_in"><span class="hljs-built_in">sub</span></span>(tf.scalar(<span class="hljs-number"><span class="hljs-number">1</span></span>)); }); }</code> </pre> <br>  Note that the <code>tf.tidy()</code> function is used to restore order after the completion of work. <br><br>  We could just save all the samples in one large training set, but in machine learning it is important to check the quality of the training model.  That is why we need to save some samples in a separate control sample.  After that, we can check the model's behavior on new data for it and find out if excessive model learning has occurred.  For this purpose, 20% of the total number of samples are included in the control sample. <br><br>  Here is the code that is used for data collection and sampling: <br><br><pre> <code class="hljs pgsql">const dataset = { train: {   n: <span class="hljs-number"><span class="hljs-number">0</span></span>,   x: <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>,   y: <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, }, val: {   n: <span class="hljs-number"><span class="hljs-number">0</span></span>,   x: <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>,   y: <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, }, } <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> captureExample() { //            tf.tidy(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span>() {   const image = getImage();   const mousePos = tf.tensor1d([mouse.x, mouse.y]).expandDims(<span class="hljs-number"><span class="hljs-number">0</span></span>);   // ,    (  )     const subset = dataset[Math.random() &gt; <span class="hljs-number"><span class="hljs-number">0.2</span></span> ? <span class="hljs-string"><span class="hljs-string">'train'</span></span> : <span class="hljs-string"><span class="hljs-string">'val'</span></span>];   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (subset.x == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {     //        subset.x = tf.keep(image);     subset.y = tf.keep(mousePos);   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {     //          const oldX = subset.x;     const oldY = subset.y;     subset.x = tf.keep(oldX.concat(image, <span class="hljs-number"><span class="hljs-number">0</span></span>));     subset.y = tf.keep(oldY.concat(mousePos, <span class="hljs-number"><span class="hljs-number">0</span></span>));   }   //     subset.n += <span class="hljs-number"><span class="hljs-number">1</span></span>; }); }</code> </pre> <br>  And finally, we need to bind this function to the <code></code> key: <br><br><pre> <code class="hljs matlab">$(<span class="hljs-string"><span class="hljs-string">'body'</span></span>).keyup(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span><span class="hljs-function"> { //         </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event.keyCode == 32)</span></span></span><span class="hljs-function"> {   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">captureExample</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">event</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">preventDefault</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">false</span></span></span><span class="hljs-function">; } });</span></span></code> </pre> <br>  Now each time the <code></code> pressed, the image of the eyes and the coordinates of the mouse pointer are added to one of the data sets. <br><br><h2>  <font color="#3AC1EF">Model training</font> </h2><br>  Create a simple convolutional neural network.  TensorFlow.js provides an API for this purpose, reminiscent of Keras.  The network must have a <code>conv2d</code> layer, a <code>maxPooling2d</code> layer, and, finally, a <code>dense</code> layer with two output values ‚Äã‚Äã(they represent screen coordinates).  Along the way, I added to the network, as a regularizer, a <code>dropout</code> layer, and a <code>flatten</code> layer in order to convert two-dimensional data into one-dimensional.  Network training is performed using the Adam optimizer. <br><br>  Please note that I stopped at the network settings used here after experimenting on my MacBook Air.  You may well choose your own configuration of the model. <br><br>  Here is the model code: <br><br><pre> <code class="hljs pgsql">let currentModel; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> createModel() { const model = tf.sequential(); model.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(tf.layers.conv2d({   kernelSize: <span class="hljs-number"><span class="hljs-number">5</span></span>,   filters: <span class="hljs-number"><span class="hljs-number">20</span></span>,   strides: <span class="hljs-number"><span class="hljs-number">1</span></span>,   activation: <span class="hljs-string"><span class="hljs-string">'relu'</span></span>,   inputShape: [$(<span class="hljs-string"><span class="hljs-string">'#eyes'</span></span>).height(), $(<span class="hljs-string"><span class="hljs-string">'#eyes'</span></span>).width(), <span class="hljs-number"><span class="hljs-number">3</span></span>], })); model.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(tf.layers.maxPooling2d({   poolSize: [<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>],   strides: [<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>], })); model.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(tf.layers.flatten()); model.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(tf.layers.dropout(<span class="hljs-number"><span class="hljs-number">0.2</span></span>)); //    x  y model.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(tf.layers.dense({   units: <span class="hljs-number"><span class="hljs-number">2</span></span>,   activation: <span class="hljs-string"><span class="hljs-string">'tanh'</span></span>, })); //   Adam     <span class="hljs-number"><span class="hljs-number">0.0005</span></span>     MSE model.compile({   optimizer: tf.train.adam(<span class="hljs-number"><span class="hljs-number">0.0005</span></span>),   loss: <span class="hljs-string"><span class="hljs-string">'meanSquaredError'</span></span>, }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> model; }</code> </pre> <br>  Before we start learning about the network, we set a fixed number of epochs and a variable packet size (since we may be working with very small data sets). <br><br><pre> <code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fitModel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> batchSize = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(dataset.train.n * <span class="hljs-number"><span class="hljs-number">0.1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (batchSize &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) {   batchSize = <span class="hljs-number"><span class="hljs-number">4</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (batchSize &gt; <span class="hljs-number"><span class="hljs-number">64</span></span>) {   batchSize = <span class="hljs-number"><span class="hljs-number">64</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentModel == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) {   currentModel = createModel(); } currentModel.fit(dataset.train.x, dataset.train.y, {   <span class="hljs-attr"><span class="hljs-attr">batchSize</span></span>: batchSize,   <span class="hljs-attr"><span class="hljs-attr">epochs</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>,   <span class="hljs-attr"><span class="hljs-attr">shuffle</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>,   <span class="hljs-attr"><span class="hljs-attr">validationData</span></span>: [dataset.val.x, dataset.val.y], }); }</code> </pre> <br>  Now add a button to the page to start learning.  This code goes to the HTML file: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"train"</span></span></span><span class="hljs-tag">&gt;</span></span>Train!<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css">   </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#train</span></span></span><span class="css"> {       </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">position</span></span></span><span class="css">: absolute;       </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">top</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">50%</span></span></span><span class="css">;       </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">left</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">50%</span></span></span><span class="css">;       </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">transform</span></span></span><span class="css">: </span><span class="hljs-built_in"><span class="css"><span class="hljs-built_in">translate</span></span></span><span class="css">(-50%, -50%);       </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">font-size</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">24pt</span></span></span><span class="css">;   } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  This code must be added to the JS file: <br><br><pre> <code class="hljs matlab">$(<span class="hljs-string"><span class="hljs-string">'#train'</span></span>).click(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fitModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; });</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">Where is the user looking?</font> </h2><br>  Now that we can collect data and prepare a model, we can begin to predict the place on the page where the user is looking.  Indicate this place with the help of a green circle that moves around the screen. <br><br>  First, add a circle to the page: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"target"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css">   </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#target</span></span></span><span class="css"> {       </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">background-color</span></span></span><span class="css">: lightgreen;       </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">position</span></span></span><span class="css">: absolute;       </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">border-radius</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">50%</span></span></span><span class="css">;       </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">height</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">40px</span></span></span><span class="css">;       </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">width</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">40px</span></span></span><span class="css">;       </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">transition</span></span></span><span class="css">: all </span><span class="hljs-number"><span class="css"><span class="hljs-number">0.1s</span></span></span><span class="css"> ease;       </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">box-shadow</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">20px</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">10px</span></span></span><span class="css"> white;       </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">border</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">4px</span></span></span><span class="css"> solid </span><span class="hljs-built_in"><span class="css"><span class="hljs-built_in">rgba</span></span></span><span class="css">(0,0,0,0.5);   } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  In order to move it around the page, we periodically transfer the current image of the eyes of the neural network and ask it where the user is looking.  The model responds with two coordinates along which the circle should be moved: <br><br><pre> <code class="hljs matlab"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">moveTarget</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(currentModel == null)</span></span></span><span class="hljs-function"> {   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function">; } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tf</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tidy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(function()</span></span></span><span class="hljs-function"> {   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">const</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">image</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getImage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">const</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prediction</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">currentModel</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">predict</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(image)</span></span></span><span class="hljs-function">;   //          </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">const</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">targetWidth</span></span></span><span class="hljs-function"> = $</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('#target')</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">outerWidth</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">const</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">targetHeight</span></span></span><span class="hljs-function"> = $</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('#target')</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">outerHeight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">const</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(prediction.get(0, 0)</span></span></span><span class="hljs-function"> + 1) / 2 * </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($(window)</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">width</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> - </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">targetWidth</span></span></span><span class="hljs-function">);   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">const</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">y</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(prediction.get(0, 1)</span></span></span><span class="hljs-function"> + 1) / 2 * </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($(window)</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">height</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> - </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">targetHeight</span></span></span><span class="hljs-function">);   //     :   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">const</span></span></span><span class="hljs-function"> $</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">target</span></span></span><span class="hljs-function"> = $</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('#target')</span></span></span><span class="hljs-function">;   $</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">target</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">css</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('left', x + 'px')</span></span></span><span class="hljs-function">;   $</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">target</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">css</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('top', y + 'px')</span></span></span><span class="hljs-function">; }); } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setInterval</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(moveTarget, 100)</span></span></span><span class="hljs-function">;</span></span></code> </pre> <br>  I set the interval to 100 milliseconds.  If your computer is not as powerful as mine, you may decide to increase it. <br><br><h2>  <font color="#3AC1EF">Results</font> </h2><br>  Now we have everything that is needed to implement the idea set out at the very beginning of this material.  Try what we did.  Move the mouse cursor, watching him with your eyes, and press the Spacebar.  Then click the start training button. <br><br>  Collect more data, press the button again.  After a while, the green circle will start moving around the screen following your gaze.  At first, it will not be particularly good to get to the place where you are looking, but, starting with about 50 samples collected, after several stages of training, and if you are lucky, it will quite accurately move to the point on the page you are looking at .  The full code of the example analyzed in this material can be found <a href="https://github.com/cpury/lookie-lookie/tree/master/blogcode">here</a> . <br><br>  Although what we have done already looks very interesting, there are still many improvements to be made.  What if the user moves his head or changes position in front of the camera?  Our project would not be hindered by the possibilities regarding the selection of the size, position and angle of a rectangle bounding the image area where the eyes are located.  In fact, quite a lot of additional features are implemented in the <a href="https://cpury.github.io/lookie-lookie/">full version of</a> the example discussed here.  Here are some of them: <br><br><ul><li>  The options for setting the rectangle that bounds the eyes described above. </li><li>  Convert image to grayscale. </li><li>  Using <a href="https://eng.uber.com/coordconv/">CoordConv</a> . </li><li>  Heat map to check where the model performed well and where it did not. </li><li>  Ability to save and load datasets. </li><li>  Ability to save and load models. </li><li>  Saving weights, showed after training the minimum loss when checking. </li><li>  Improved user interface with a brief instruction on how to work with the system. </li></ul><br>  <b>Dear readers!</b>  Do you use TensorFlow? <br><br> <a href="https://ruvds.com/ru-rub/"><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div><p>Source: <a href="https://habr.com/ru/post/426055/">https://habr.com/ru/post/426055/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../426041/index.html">Symbolic solution of linear differential equations and systems by the Laplace transform method using SymPy</a></li>
<li><a href="../426045/index.html">Special exceptions in .NET and how to prepare them</a></li>
<li><a href="../426047/index.html">10 great books for beginners in English</a></li>
<li><a href="../426051/index.html">Improving software debugging skills - some tips</a></li>
<li><a href="../426053/index.html">Caching event handlers and improving the performance of React applications</a></li>
<li><a href="../426059/index.html">Tutu PHP Meetup # 2: Video Speeches</a></li>
<li><a href="../426061/index.html">Microsoft joins the Open Invention Network and "distributes" licenses for 60,000 of its patents.</a></li>
<li><a href="../426063/index.html">HPE MSA Entry Level Innovation Arrays: A More Available Flash Array And Rich Decision Integration</a></li>
<li><a href="../426065/index.html">Smart TV, which itself determines the most interesting channel, or an unusual solution to sudoku for video content</a></li>
<li><a href="../426067/index.html">Moving like two fires? Once again about the relocation of staff</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>