<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>USB support in KolibriOS: what's inside? Part 5: logic level</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Device connection processing, started at the host controller support level , has stopped, preparing the zero device endpoint for operation. The channe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>USB support in KolibriOS: what's inside? Part 5: logic level</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/882/61a/ae8/88261aae82f0dfcb06d32f7bfd94c4c6.png" align="left">  Device connection processing, started at <a href="http://habrahabr.ru/company/kolibrios/blog/183284/">the host controller support level</a> , has stopped, preparing the zero device endpoint for operation.  <a href="http://habrahabr.ru/company/kolibrios/blog/186276/">The channel support level has</a> provided methods for working with channels.  It‚Äôs time to use them to continue the device initialization: the <code>usb_new_device</code> function from <a href="http://websvn.kolibrios.org/filedetails.php%3Frepname%3DKolibri%2BOS%26path%3D%252Fkernel%252Ftrunk%252Fbus%252Fusb%252Fprotocol.inc">bus / usb / protocol.inc</a> is <code>usb_new_device</code> . <br><br>  Now the device can do little: it has not yet received an address on the bus, it has not yet been configured, it can use only 100 mA of bus power.  In general, all that a device can do is to tell about itself in response to relevant questions.  The story about the device itself is organized in the form of <i>descriptors</i> .  A <code>GET_DESCRIPTOR</code> issue is the <code>GET_DESCRIPTOR</code> command sent to the null endpoint;  the command must specify the <i>type of descriptor</i> , the sequence <i>number of the</i> descriptor among all with this type, the length of the data to be transmitted.  Each command to the control endpoint takes 8 bytes and may or may not have additional data; in some commands some fields are not used.  The command structure by byte and the fields used are described in Chapter 9 of the USB specification, here I will only describe the input and output data for the commands. <br><br>  The logic device level has two tasks: first, configure the device;  secondly, ask him, download the appropriate driver ‚Äî or even drivers ‚Äî and inform the driver about the new device. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h3>  The first steps </h3><br>  <code>usb_new_device</code> starts by creating a channel to the zero end point of the device.  The host controllers support code before calling <code>usb_new_device</code> filled in the structure describing the device, all that remains is to specify the endpoint parameters: the number ‚Äî zero ‚Äî and the maximum packet size.  The maximum packet size for a control endpoint can vary from 8 to 64 bytes and is recorded among the first 8 bytes of the device descriptor.  However, to read the descriptor, you need an already open channel.  Fortunately, you can get out of the dependency cycle: the maximum packet size is needed only to break one transfer into transactions;  it is guaranteed that the maximum packet size for the control endpoint is at least 8 bytes;  if during the initial stages of the configuration only data of length 8 bytes or less is transmitted, then the exact value of the maximum packet size is unimportant.  Therefore, as the maximum value of the packet, you can set any number, not less than 8 bytes. <br><br>  However, there is one problem: the EHCI emulation in VirtualBox is not entirely correct and requires 64 bytes to work with HighSpeed ‚Äã‚Äãdevices.  Since there are no other requirements, the channel to the zero endpoint begins to exist with a maximum packet size of 64 bytes. <br><br>  Until the device receives an address on the bus, it responds to the zero address and prevents the reset of subsequent devices ‚Äî if another device is reset, both devices will respond to packets with a zero address, which will lead to confusion on the bus.  Therefore, the first thing that <code>usb_new_device</code> does after opening a channel is to select the first unallocated address and send the <code>SET_ADDRESS</code> command.  At the entrance of the command <code>SET_ADDRESS</code> - address, there is no output. <br><br>  After completing the <code>SET_ADDRESS</code> command, the <code>usb_set_address_callback</code> procedure receives <code>usb_set_address_callback</code> .  If the device did not respond to the command or responded with an error, then the only option is to disconnect the device from the bus at the hub level.  If the command is successful, <code>usb_set_address_callback</code> informs the support level of the host controllers that the address has changed;  for the reasons I mentioned in <a href="http://habrahabr.ru/company/kolibrios/blog/183284/">one of the previous articles in the series</a> , the change may take some time.  In both cases, the zero address on the bus ceases to be occupied, so you can begin to reset subsequent devices, if any;  the call to <code>usb_test_pending_port</code> is responsible for this. <br><br>  When the host controller confirms the address change in the structure describing the device, the support code calls <code>usb_after_set_address</code> .  Now the representations of the host controller and the device about the address on the bus are reconfigured, you can continue the configuration.  The next command <code>usb_after_set_address</code> sends the question <code>GET_DESCRIPTOR</code> , requesting the first 8 bytes of the device descriptor ‚Äî descriptor type 1, descriptor number 0. The last of these 8 bytes sets the maximum packet size for the zero end point ‚Äî the last thing that was missing for full communication.  The <code>usb_get_descr8_callback</code> response <code>usb_get_descr8_callback</code> pulls out the maximum packet size, reports it to the host controller, and waits for confirmation.  After confirmation, call <code>usb_after_set_endpoint_size</code> , where the <code>GET_DESCRIPTOR</code> question for the device descriptor is repeated, now requesting data completely. <br><br><h3>  Device handle </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/77f/d4f/ddb/77fd4fddb4d82a58bd44505b186469a5.png"></div><br>  The figure shows the hexadecimal dumps of the descriptors of two different devices: on the top ‚Äî the virtual hub of RMH, on the bottom ‚Äî of a mouse.  The device handle consists of the following data in <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D1%2580%25D1%258F%25D0%25B4%25D0%25BE%25D0%25BA_%25D0%25B1%25D0%25B0%25D0%25B9%25D1%2582%25D0%25BE%25D0%25B2">little-endian</a> : <ul><li>  the first byte of any descriptor is its size, the second is its type, the device descriptor is of type 1; </li><li>  USB specification version, with which the device is compatible, in <a href="http://ru.wikipedia.org/wiki/BCD"><abbr title="Binary-Coded Decimal">BCD</abbr></a> , <code>110h</code> - version 1.1, <code>200h</code> - version 2.0; </li><li>  <a href="http://www.usb.org/developers/defined_class">class, subclass and protocol of the</a> device as a whole;  often there are zeros, then the data is set at the level of individual interfaces - it will be further about them; </li><li>  maximum packet size for the zero end point; </li><li>  Vendor ID and Product ID of the device - the USB Implementers Forum association allocates to each USB device manufacturer a double-byte Vendor ID, sometimes even not one, the manufacturer assigns each product a separate double-byte Product ID;  for example, Vendor ID <code>8087h</code> assigned to Intel; </li><li>  the device version is an arbitrary number that the manufacturer recorded here: </li><li>  three pointers to lines, each of which may be missing.  The first two are the texts for the user, the manufacturer and product description lines respectively, the last is the serial number.  The lines themselves are stored in separate type 3 descriptors; </li><li>  number of configurations. </li></ul>  Configurations are mutually exclusive modes of operation of the device, between which there is nothing in common.  In theory, a USB device can have several different configurations, between which the software should choose.  The USB specification, as a somewhat contrived example, leads a modem that can provide either one channel at 128 Kbps or two independent channels at 64 Kbps each.  In practice, the vast majority of devices have exactly one configuration and use other methods for selecting the operating mode.  However, this one configuration still needs to be explicitly turned on; before that, the device will remain non-functional and able only to give descriptors. <br><br>  KolibriOS always selects the first device configuration.  The <code>usb_get_descr_callback</code> function, called after reading the device descriptor, sends the <code>GET_DESCRIPTOR</code> command for the first configuration descriptor ‚Äî type 2, number 0. <br><br>  Together with the configuration descriptor, the device returns many other descriptors that specify the configuration details.  The total amount of data associated with the configuration descriptor is not known in advance, but is contained in the configuration descriptor itself.  Therefore, the request proceeds in two stages - at the first stage, the <code>usb_get_descr_callback</code> function requests 8 bytes, at the second stage, the <code>usb_know_length_callback</code> function pulls the total size from the read bytes and requests it already. <br><br><h3>  Configuration descriptor </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/48c/596/9a7/48c5969a7af056aad131b688d325093a.png"></div><br>  One of the simplest configurations is the virtual hub of RMH, it is shown in the figure.  Together with the configuration descriptor, the device returns descriptors of all <i>interfaces of</i> this configuration, for each interface descriptors of all its endpoints.  Associated data includes other types of descriptors ‚Äî for example, HID devices like mice and keyboards return a HID descriptor between an interface descriptor and an endpoint descriptor;  parsing them is a matter of driver. <br><br>  The configuration descriptor consists of the following data: <ul><li>  size and type, like all descriptors;  configuration descriptor is type 2; </li><li>  the total size of all associated data, in the example with RMH it is 9 + 9 + 7 = 19h; </li><li>  number of interfaces; </li><li>  the byte parameter of the <code>SET_CONFIGURATION</code> command corresponding to the described configuration; </li><li>  the index of the configuration description string for the user, usually absent - set as 0; </li><li>  the attribute byte is the high bit and the low 5 bits are reserved, the 5th bit means wake-up support from the sleepy state in response to some external action, the 6th bit means that the device has its own USB-powered power source; </li><li>  The maximum bus power used in this configuration, 1 unit = 2 mA, a value of 50 corresponds to 100 mA. </li></ul><br>  Interface Descriptor: <ul><li>  size and type, like all descriptors;  configuration descriptor is type 4; </li><li>  interface number and interface mode identifier.  For some devices, one interface can operate in several modes.  Example - webcams: depending on the resolution of the image and the codec, the speed of data flow can vary significantly, different modes reserve different bandwidths of the end point transmitting data.  In such cases, there are several descriptors for the same interface, in which the number field is the same, but mode identifiers differ.  By default, after selecting the configuration, the interfaces operate in zero mode, the driver can send the <code>SET_INTERFACE</code> command to switch the mode of one interface; </li><li>  the number of end points; </li><li>  class, subclass, and interface protocol.  Classes, except <code>0FFh</code> , are defined by the USB Implementers Forum association, their descriptions are collected <a href="http://www.usb.org/developers/defined_class">on this page</a> .  For example, hubs are class 9.  Class <code>0FFh</code> used for devices not falling into any other class; </li><li>  The interface description string for the user, usually absent - specified as 0. </li></ul><br>  The endpoint descriptor specifies the parameters needed to open the channel: <ul><li>  size and type, like all descriptors;  the endpoint descriptor is type 5; </li><li>  direction - high bit - and number - 4 low bits - end point;  for example, <code>81h</code> means point number 1, transmitting data from the device to the host; </li><li>  Endpoint type: 0 = control, 1 = isochronous, 2 = data sets, 3 = interrupts;  for isochronous points, specifying parameters are packed in the same byte; </li><li>  11 bits of the maximum packet size for this end point plus 2 more bits for HighSpeed ‚Äã‚Äãpoints, specifying the maximum number of transactions per microframe; </li><li>  Desired polling interval for isochronous and interrupt type points.  For LowSpeed ‚Äã‚Äã/ FullSpeed-type interruption points, the interval is specified in milliseconds, for HighSpeed-type interruption points, the interval is 2 <sup>value-1</sup> microframes.  In the RMH example, 2 11/8 milliseconds = 0.256 seconds is obtained.  For isochronous points, the interval is 2 <sup>value-1</sup> in units of measurement that correspond to speed: milliseconds for FullSpeed, microframes for HighSpeed. </li></ul><br><br>  The <code>usb_set_config_callback</code> function, after receiving the complete data associated with the configuration descriptor, <code>SET_CONFIGURATION</code> command with a parameter taken from the descriptor;  no output from this command.  After successful completion of the command, the device becomes fully functional.  The last function of the logic unit level, <code>usb_got_config_callback</code> , parses the resulting configuration data: makes sure that the device does not try to cheat by replacing the total data size between the <code>GET_DESCRIPTOR</code> commands;  passes through the list of descriptors, ignoring everything except interface descriptors;  for zero-mode descriptors, determines the driver by device class, loads the driver and calls its <code>AddDevice</code> function, passing a pointer to the configuration data and a pointer to the desired interface descriptor inside them.  For further work with the device meets the loaded driver.  I will talk about existing KolibriOS drivers in subsequent articles. <br><br><h3>  All articles of the series </h3><br>  <a href="http://habrahabr.ru/company/kolibrios/blog/181586/">Part 1: general scheme</a> <br>  <a href="http://habrahabr.ru/company/kolibrios/blog/183184/">Part 2: Basics of working with host controllers</a> <br>  <a href="http://habrahabr.ru/company/kolibrios/blog/183284/">Part 3: Host Controller Support Code</a> <br>  <a href="http://habrahabr.ru/company/kolibrios/blog/186276/">Part 4: Channel Support Level</a> <br>  Part 5: logic level <br>  <a href="http://habrahabr.ru/company/kolibrios/blog/203918/">Part 6: hub driver</a> </div><p>Source: <a href="https://habr.com/ru/post/200172/">https://habr.com/ru/post/200172/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../200160/index.html">Startup AddVenture is a meeting place for startups and investors from all over Europe and the USA.</a></li>
<li><a href="../200162/index.html">How is the exchange trading in Russia</a></li>
<li><a href="../200164/index.html">Apache JMeter logging in Oracle database in on-line mode</a></li>
<li><a href="../200166/index.html">Metric # 27 - A podcast about technologies, products, and services from the IT world</a></li>
<li><a href="../200168/index.html">Working with SQL Server in Hybrid Cloud Scripts</a></li>
<li><a href="../200180/index.html">FSB does not classify Google Glass as special tools.</a></li>
<li><a href="../200190/index.html">How I filled up an interview on Twitter</a></li>
<li><a href="../200192/index.html">Development of client-server infrastructure in javascript (part 1 - client)</a></li>
<li><a href="../200194/index.html">Work with the mdadm utility. Change array type, chunk size, extension</a></li>
<li><a href="../200196/index.html">IPTV on Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>