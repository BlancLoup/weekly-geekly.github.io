<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rake using common .dll</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago I came across an interesting non-standard problem that made me think about two hours. It has mixed several factors, such as some curva...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rake using common .dll</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago I came across an interesting non-standard problem that made me think about two hours.  It has mixed several factors, such as some curvature of the product architecture, insufficient logging and features of other software already installed.  At once I will make a reservation that by and large the view of the problem and the solution will be from the philistine bell tower (in programming I shave a little more than nothing), but in this case it was this fresh look that was key in the final decision. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5d0/472/4b9/5d04724b9a94ec23bf4f72bccadcd10f.png"><br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Actually the problem: </h4><br><br>  After installing <a href="http://www.acronis.com/enterprise/products/vmprotect/">Acronis vmProtect</a> Windows Agent (upgrade from version 8 to version 9), an agent for backing up virtual machines running VMware ESX / ESXi, the main Acronis vmProtect Managed Machine Service ( <i>vmms.exe</i> ) service refused to start.  After starting the service spontaneously terminated within a few seconds: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4d2/6d6/143/4d26d6143341082183f9ee1b6748942c.png"><br><br><h4>  Our dances with and without tambourines: </h4><br><br>  To begin with, we tried the standard dances with tambourines ala ‚Äúreinstall under another user, reboot, etc.‚Äù, as obviously the problem did not reproduce in our QA department and accordingly the conclusion was that something was wrong with a particular installation of the user .  As you can guess, these dances did not lead to anything and the service still stubbornly refused to start normally.  The following lines were found in our service logs: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f49/55d/646/f4955d6467f75599e9d6ea598c9d4337.png"><br><br>  We knew that the <i>MigrationManager</i> component was being loaded inside the main library <i>VELightBundle.dll</i> and the fact that the service had successfully started earlier was known, and the problem arose only after upgrading from version 8 to version 9.  The first assumption was made that <i>VELightBundle.dll was</i> incorrectly updated and the old one remained.  Let me clarify that by this time the investigation of the problem was already taking place on the user's side through TeamViewer, so it was quite funny for him to watch our attempts.  All this time there was a lively discussion on Skype between me and the developer (the sky began to look like a sieve): <br><br>  [10/31/2013 12:17:35] Developer: Listen on his machine, the dll part was created on 20.08 and on 28.10. <br>  [10/31/2013 12:17:46 PM] Developer: I understand he didn‚Äôt have an update. <br>  [10/31/2013 12:18:53 PM] Developer: For example, DiskBundle on the 20th, and velight 28 <br>  [10/31/2013 12:27:21] Developer: strange <br>  [10/31/2013 12:27:49 PM] Developer: it's just that the file is not from 9k <br>  [10/31/2013 12:28:13] Chineek: from 8 chtoli <br>  [10/31/2013 12:28:39] Chineek: if I were you, I would have just planted all the RIGHT ones for myself) well, either aninstall, install <br>  [10/31/2013 12:28:48] Chineek: Aninstall - remove all that is extra in the long run - install <br><br>  Unfortunately, even the use of the standard method ‚Äúin any incomprehensible situation if something does not work, delete and install as it should work‚Äù in this case did not help and had to use ‚Äúheavy artillery‚Äù in the person of one of my favorite utilities <a href="http://technet.microsoft.com/ru-ru/sysinternals/bb896645.aspx">Process Monitor</a> .  The log was filmed from the moment of the start of the Acronis vmProtect Managed Machine Service until the moment of its spontaneous stop.  The log was set to filter the process vmms.exe and viewed messages about trying to download <i>VELightBundle.dll</i> .  I will not describe how long it took to search for these particular lines (I was helped by removing the similar log from the system where the service started correctly and comparing it with the problem log regarding the boot process of <i>VELightBundle.dll</i> ), but this is what <i>happened</i> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b1e/e34/208/b1ee34208dad2d9cd598824d9854eee9.png"><br><br><h4>  Decision </h4><br><br>  As you can see, during the download process, <i>VELightBundle.dll</i> tried to load the shared 3rd-party library <i>libxml2.dll</i> (we use it to generate certain xml reports starting from version 9), but instead of the correct path <i>C: \ Program Files (x86) \ Common Files \ Acronis \ vmProtect \ Common \</i> , it began to load from <i>C: \ Program Files (x86) \ ATI Stream \ bin \ x86_64 \</i> , because  was present in both places (each had its own unique version of this library): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/db3/4d7/714/db34d77146fed517932d5b570af59e21.png"><br><br>  From the Process Monitor log you can see that the first place where libxml2.dll is searched for is the product installation folder, therefore, by simply copying libxml2.dll from <i>C: \ Program Files (x86) \ Common Files \ Acronis \ vmProtect \ Common \</i> to <i>C: \ Program Files (x86) \ Acronis \ vmProtect \ Windows Agent \</i> initial problem was solved and the service started correctly.  Hooray! <br><br><h4>  How did this happen? </h4><br><br>  What have we missed?  Where did <i>C: \ Program Files (x86) \ ATI Stream \ bin \ x86_64 \</i> come from? <br><br>  The answer to the second question is fairly obvious: loading the .dll goes by traversing the paths from the% path% variable if it is not found in the same folder where the original process was started.  As you can see in the following screenshot, <i>C: \ Program Files (x86) \ ATI Stream \ bin \ x86_64 \</i> is indeed listed and therefore was selected to search and download <i>libxml2.dll</i> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4b5/acb/3df/4b5acb3dfba7bbc8d64fa42c6b0ad3c4.png"><br><br>  <b>An important explanation:</b> I took screenshots after I reproduced the problem locally on my machine.  While reproducing and writing this article, I downloaded <i>libxml2.dll</i> from the first available link and copied it to the first path mentioned in% path%, which was <i>C: \ Program Files (x86) \ ATI Stream \ bin \ x86_64 \</i> .  In the case of a real user, <i>libxml2.dll</i> was in the installation folder of the <a href="http://www.norman.com/home_and_small_office/products/norman_antivirus">Norman</a> antivirus, which, as it turned out, also registers itself in% path%. <br><br>  Having continued to get to the bottom of the developers, I confirmed for myself the following thing: <br><br>  All third-party (3rd-party) .dll files are added to <i>C: \ Program Files (x86) \ Common Files \ Acronis \ vmProtect \ Common \</i> folder, which, however, is not written into the% path% variable.  The .dll data is jerked from our own libraries, but in an indirect way, that is, only if they are not found anywhere in the standard paths <i>C: \ Windows \</i> , <i>C: \ Windows \ Syswow64 \</i> (system32) or% path%.  In other words, there is a bug / <s>dirty</s> hack in the logic of loading third-party libraries. <br><br>  Once again, Process Monitor <s>saved the world</s> helped solve a nonstandard problem, while finding a reason by remote debugging via VPN would take much longer. <br><br>  I hope that this experience will prevent developers from writing buggy code, and technical support will provide another means to investigate problems with the launch of services.  Agree, it is pleasant to receive similar confessions from developers: <br><br>  [10/31/2013 2:56:21 PM] Developer: Thank you.  I myself would have come to this for a long time. <br><br>  PS I will quote our developers (I hope for other developers this phrase will make sense, and not a set of characters for me :)): ‚ÄúWell, what can I add.  The fact is that we have a hook on delayload, which this kind of problem is designed to solve.  Now does not solve. " </div><p>Source: <a href="https://habr.com/ru/post/205476/">https://habr.com/ru/post/205476/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../205460/index.html">Setting up an Internet gateway for a small office CentOS, Iptables, NAT, Squid Transparent, Sarg</a></li>
<li><a href="../205462/index.html">Reading Mettler Toledo PS60 Scale Data</a></li>
<li><a href="../205464/index.html">Working with Group Policy Preferences: Interacting with Local Accounts</a></li>
<li><a href="../205466/index.html">Development of Windows 8.1 applications on XAML / –° #. Part 3. Toolbars</a></li>
<li><a href="../205472/index.html">turbofilm.tv blocked</a></li>
<li><a href="../205478/index.html">Virtual Trading: the first step in the stock market</a></li>
<li><a href="../205480/index.html">ADI method for direct observation of exoplanets - how it works</a></li>
<li><a href="../205482/index.html">C ++ Type Classes</a></li>
<li><a href="../205484/index.html">Hood timer</a></li>
<li><a href="../205486/index.html">Intel 8051. 30 years in devices, devices and soft toys</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>