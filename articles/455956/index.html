<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Chromium is not only a browser, but also a good framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most people are used to the fact that Chromium is both the browser and the foundation for other browsers. Until recently, I also thought so, but, stud...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Chromium is not only a browser, but also a good framework</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/ue/ye/xv/ueyexvk-uewnyghxhvtud7vugrq.jpeg"><br><br>  Most people are used to the fact that Chromium is both the browser and the foundation for other browsers.  Until recently, I also thought so, but, studying this topic for a couple of months, I began to discover another wonderful world.  Chromium is a huge ecosystem that has everything: a dependency system, a cross-platform build system, and components for almost all occasions.  So why not try creating your applications using all this power? <br><br>  Under the cut a little guide how to start doing it. <br><a name="habracut"></a><br><h2>  Environment preparation </h2><br>  In the article I will use Ubuntu 18.04, the procedure for other operating systems can be found in the documentation: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  <a href="">Linux</a> <br></li><li>  <a href="">Windows</a> <br></li><li>  <a href="">Mac</a> <br></li></ul><br>  Git and Python are required for the next steps.  If they are not installed, they must be installed using the command: <br><br><pre><code class="bash hljs">sudo apt install git python</code> </pre> <br><h3>  Install depot_tools </h3><br>  <code>depot_tools</code> is a toolkit for Chromium development.  To install it you need to run: <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://chromium.googlesource.com/chromium/tools/depot_tools.git</code> </pre> <br>  And add the path to the PATH environment variable: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PATH=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PATH</span></span></span><span class="hljs-string">:/path/to/depot_tools"</span></span></code> </pre> <br>  Important: if <code>depot_tools</code> were downloaded to the home folder, then do not use <code>~</code> in the <code>PATH</code> variable, otherwise problems may occur.  You must use the <code>$HOME</code> variable: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PATH=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PATH</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${HOME}</span></span></span><span class="hljs-string">/depot_tools"</span></span></code> </pre> <br><h3>  Getting the code </h3><br>  First you need to create a folder for sources.  For example, in the home directory (you need about 30 GB of free space): <br><br><pre> <code class="bash hljs">mkdir ~/chromium &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/chromium</code> </pre> <br>  After that, you can download the sources using the <code>fetch</code> utility from <code>depot_tools</code> : <br><br><pre> <code class="bash hljs">fetch --nohooks --no-history chromium</code> </pre> <br>  Now you can go to drink tea / coffee, as the procedure is not fast.  History is not needed for experiments, so the <code>--no-history</code> flag is used.  With the story will be even longer. <br><br><h3>  Installing dependencies </h3><br>  All sources are in the <code>src</code> folder, go to it: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> src</code> </pre> <br>  Now you need to put all the dependencies using the script: <br><br><pre> <code class="bash hljs">./build/install-build-deps.sh</code> </pre> <br>  And run the hooks: <br><br><pre> <code class="bash hljs">gclient runhooks</code> </pre> <br>  This completes the preparation of the environment. <br><br><h2>  Assembly system </h2><br>  <a href="https://ninja-build.org/">Ninja is</a> used as the main build system of Chromium, and <a href="">GN</a> is used to generate <code>.ninja</code> files. <br><br>  To understand how to use these tools, I suggest creating a test utility example.  To do this, you need to create a subfolder <code>example</code> in the <code>src</code> folder: <br><br><pre> <code class="bash hljs">mkdir example</code> </pre> <br>  Then in the <code>src/example</code> folder you need to create a <code>BUILD.gn</code> file that contains: <br><br><pre> <code class="cpp hljs">executable(<span class="hljs-string"><span class="hljs-string">"example"</span></span>) { sources = [ <span class="hljs-string"><span class="hljs-string">"example.cc"</span></span>, ] }</code> </pre> <br>  <code>BUILD.gn</code> consists of a target (an executable <code>example</code> file) and a list of files that are needed to build a target. <br><br>  The next step is to create the file itself <code>example.cc</code> .  To begin with, I propose to make the classic application ‚ÄúHello world‚Äù: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; int main(int argc, char **argv) { std::cout &lt;&lt; "Hello world" &lt;&lt; std::endl; return 0; }</span></span></span></span></code> </pre> <br>  Source code can be found on <a href="https://github.com/sergei-svistunov/chromium-as-framework-article/tree/example-1">github</a> . <br><br>  In order for GN to find out about a new project, you need to add the line <code>"//example"</code> in the <code>deps</code> section in the <code>BUILD.gn</code> file that is located in <code>src</code> : <br><br><pre> <code class="cpp hljs">... group(<span class="hljs-string"><span class="hljs-string">"gn_all"</span></span>) { testonly = <span class="hljs-literal"><span class="hljs-literal">true</span></span> deps = [ <span class="hljs-string"><span class="hljs-string">":gn_visibility"</span></span>, <span class="hljs-string"><span class="hljs-string">"//base:base_perftests"</span></span>, <span class="hljs-string"><span class="hljs-string">"//base:base_unittests"</span></span>, <span class="hljs-string"><span class="hljs-string">"//base/util:base_util_unittests"</span></span>, <span class="hljs-string"><span class="hljs-string">"//chrome/installer"</span></span>, <span class="hljs-string"><span class="hljs-string">"//chrome/updater"</span></span>, <span class="hljs-string"><span class="hljs-string">"//net:net_unittests"</span></span>, <span class="hljs-string"><span class="hljs-string">"//services:services_unittests"</span></span>, <span class="hljs-string"><span class="hljs-string">"//services/service_manager/public/cpp"</span></span>, <span class="hljs-string"><span class="hljs-string">"//skia:skia_unittests"</span></span>, <span class="hljs-string"><span class="hljs-string">"//sql:sql_unittests"</span></span>, <span class="hljs-string"><span class="hljs-string">"//third_party/flatbuffers:flatbuffers_unittests"</span></span>, <span class="hljs-string"><span class="hljs-string">"//tools/binary_size:binary_size_trybot_py"</span></span>, <span class="hljs-string"><span class="hljs-string">"//tools/ipc_fuzzer:ipc_fuzzer_all"</span></span>, <span class="hljs-string"><span class="hljs-string">"//tools/metrics:metrics_metadata"</span></span>, <span class="hljs-string"><span class="hljs-string">"//ui/base:ui_base_unittests"</span></span>, <span class="hljs-string"><span class="hljs-string">"//ui/gfx:gfx_unittests"</span></span>, <span class="hljs-string"><span class="hljs-string">"//url:url_unittests"</span></span>, # ‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì <span class="hljs-string"><span class="hljs-string">"//example"</span></span>, ] ...</code> </pre> <br>  Now you need to go back to the <code>src</code> folder and generate the project using the command: <br><br><pre> <code class="bash hljs">gn gen out/Default</code> </pre> <br>  GN also allows you to prepare a project for one of the supported IDEs: <br><br><ul><li>  eclipse <br></li><li>  vs <br></li><li>  vs2013 <br></li><li>  vs2015 <br></li><li>  vs2017 <br></li><li>  vs2019 <br></li><li>  xcode <br></li><li>  qtcreator <br></li><li>  json <br></li></ul><br>  More information can be obtained using the command: <br><br><pre> <code class="bash hljs">gn <span class="hljs-built_in"><span class="hljs-built_in">help</span></span> gen</code> </pre> <br>  For example, to work with the <code>example</code> project in <a href="https://www.qt.io/download">QtCreator,</a> you need to run the command: <br><br><pre> <code class="bash hljs">gn gen --ide=qtcreator --root-target=example out/Default</code> </pre> <br>  After that, you can open the project in QtCreator: <br><br><pre> <code class="bash hljs">qtcreator out/Default/qtcreator_project/all.creator</code> </pre> <br>  The final step is building the project with Ninja: <br><br><pre> <code class="bash hljs">autoninja -C out/Default example</code> </pre> <br>  At this brief introduction to the assembly system can be completed. <br><br>  The application can be launched using the command: <br><br><pre> <code class="bash hljs">./out/Default/example</code> </pre> <br>  And see Hello world.  In fact, you can write a separate article about the build system in Chromium.  Perhaps not one. <br><br><h2>  Work with the command line </h2><br>  As the first example of using the Chromium codebase as a framework, I suggest playing with the command line. <br><br>  Task: <i>display all the arguments passed to the application in the style of Chromium.</i> <br>  To work with the command line, you need to include a header file in example.cc: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#include "base/command_line.h"</span></span></code> </pre> <br>  And also it is necessary not to forget to add dependence on the project <code>base</code> in <code>BUILD.gn</code> .  <code>BUILD.gn</code> should look like this: <br><br><pre> <code class="cpp hljs">executable(<span class="hljs-string"><span class="hljs-string">"example"</span></span>) { sources = [ <span class="hljs-string"><span class="hljs-string">"example.cc"</span></span>, ] deps = [ <span class="hljs-string"><span class="hljs-string">"//base"</span></span>, ] }</code> </pre> <br>  Now everything you need will be connected to <code>example</code> . <br><br>  To work with the command line, Chromium provides a <code>base::CommandLine</code> .  To get a link to it, you must use the static <code>base::CommandLine::ForCurrentProcess</code> , but first you need to initialize it using the <code>base::CommandLine::Init</code> method: <br><br><pre> <code class="cpp hljs">base::CommandLine::Init(argc, argv); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> *cmd_line = base::CommandLine::ForCurrentProcess();</code> </pre> <br>  All arguments passed to the application on the command line and starting with a character <code>-</code> returned as <code>base::SwitchMap</code> (essentially, <code>map&lt;string, string&gt;</code> ) using the <code>GetSwitches</code> method.  All other arguments are returned in the form of <code>base::StringVector</code> (in fact, <code>vectr&lt;strig&gt;</code> ).  This knowledge is enough to implement the code for the task: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> &amp;sw : cmd_line-&gt;GetSwitches()) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Switch "</span></span> &lt;&lt; sw.first &lt;&lt; <span class="hljs-string"><span class="hljs-string">": "</span></span> &lt;&lt; sw.second &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> &amp;arg: cmd_line-&gt;GetArgs()) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Arg "</span></span> &lt;&lt; arg &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; }</code> </pre> <br>  The full version can be found on <a href="https://github.com/sergei-svistunov/chromium-as-framework-article/tree/example-2">github</a> . <br><br>  To build and run the application you need to run: <br><br><pre> <code class="bash hljs">autoninja -C out/Default example ./out/Default/example arg1 --sw1=val1 --sw2 arg2</code> </pre> <br>  The screen will display: <br><br><pre> <code class="bash hljs">Switch sw1: val1 Switch sw2: Arg arg1 Arg arg2</code> </pre> <br><h2>  Work with the network </h2><br>  As a second and last example for today, I suggest working with the network part of Chromium. <br><br>  Task: <i>display the contents of the URL passed as an argument</i> . <br><br><h3>  Chromium network subsystem </h3><br>  The network subsystem is quite large and complex.  The entry point for requests to HTTP, HTTPS, FTP, and other data resources is <code>URLRequest</code> , which already determines which client to use.  A simplified diagram looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7d6/b9f/e45/7d6b9fe45ac8c5a47d51e4522735e5eb.png"><br><br>  <i>The full version can be found in the <a href="">documentation</a> .</i> <br><br>  To create a <code>URLRequest</code> you must use a <code>URLRequestContext</code> .  Creating a context is a rather complicated operation, so it is recommended to use <code>URLRequestContextBuilder</code> .  It initializes all necessary variables with default values, but, if you wish, you can change them for your own, for example: <br><br><pre> <code class="cpp hljs">net::URLRequestContextBuilder context_builder; context_builder.DisableHttpCache(); context_builder.SetSpdyAndQuicEnabled(<span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-comment"><span class="hljs-comment">/* http2 */</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-comment"><span class="hljs-comment">/* quic */</span></span>); context_builder.SetCookieStore(<span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>);</code> </pre> <br><h3>  Multithreading </h3><br>  The network stack of Chromium is designed to work in a multi-threaded environment, so you can not skip this topic.  The basic objects for working with multithreading in Chromium are: <br><br><ul><li>  Task is a task to perform, in Chromium it is a function of type <code>base::Callback</code> , which can be created using <code>base::Bind</code> . <br></li><li>  Task queue - the queue of tasks to perform. <br></li><li>  Physical thread - cross-platform wrapper over an operating system thread ( <code>pthread</code> on POSIX or <code>CreateThread()</code> on Windows).  Implemented in the <code>base::PlatformThread</code> class, do not use directly. <br></li><li>  base :: Thread is a real thread that infinitely processes messages from a dedicated task queue;  it is not recommended to create them directly. <br></li><li>  Thread pool - a pool of threads with a common task queue.  Implemented in <code>base::ThreadPool</code> class.  As a rule, create one copy.  Tasks are sent to it using functions from <code>base/task/post_task.h</code> . <br></li><li>  Sequence or Virtual thread is a virtual thread that uses real threads and can switch between them. <br></li><li>  Task runner is an interface for setting tasks, implemented in the <code>base::TaskRunner</code> . <br></li><li>  Sequenced task runner - an interface for setting tasks that ensures that tasks will be executed in the same order in which they came.  Implemented in the <code>base::SequencedTaskRunner</code> class. <br></li><li>  The single-thread task runner is similar to the previous one, but it guarantees that all tasks will be executed in one OS thread.  Implemented in class <code>base::SingleThreadTaskRunner</code> . <br></li></ul><br><h3>  Implementation </h3><br>  Some Chromium components require <code>base::AtExitManager</code> - this is the class that allows you to register the operations that must be performed when the application terminates.  Using it is very simple; you need to create an object on the stack: <br><br><pre> <code class="cpp hljs">base::AtExitManager exit_manager;</code> </pre> <br>  When <code>exit_manager</code> goes out of scope, all registered callbacks will be executed. <br><br>  Now you need to take care of the presence of all the necessary components of multithreading for the network subsystem.  To do this, you need to create a <code>Thread pool</code> , <code>Message loop</code> with the <code>TYPE_IO</code> type for processing network messages, and the <code>Run loop</code> is the main program loop: <br><br><pre> <code class="cpp hljs">base::ThreadPool::CreateAndStartWithDefaultParams(<span class="hljs-string"><span class="hljs-string">"downloader"</span></span>); base::<span class="hljs-function"><span class="hljs-function">MessageLoop </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">msg_loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(base::MessageLoop::TYPE_IO)</span></span></span></span>; base::RunLoop run_loop;</code> </pre> <br>  Next you need to use <code>Context builder</code> to create a <code>Context</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> ctx = net::URLRequestContextBuilder().Build();</code> </pre> <br>  To send a request, you must use the <code>CreateRequest</code> method of the <code>ctx</code> object to create a <code>URLRequest</code> object.  The following parameters are passed as parameters: <br><br><ul><li>  URL, string with type gurl; <br></li><li>  a priority; <br></li><li>  The delegate that handles events. <br></li></ul><br>  A delegate is a class that implements the <code>net::URLRequest::Delegate</code> interface.  For this task, it might look like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyDelegate</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> net::URLRequest::Delegate { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">explicit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyDelegate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(base::Closure quit_closure)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">quit_closure_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::move(quit_closure))</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buf_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(base::MakeRefCounted&lt;net::IOBuffer&gt;(BUF_SZ))</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnReceivedRedirect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(net::URLRequest *request, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> net::RedirectInfo &amp;redirect_info, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *defer_redirect)</span></span></span><span class="hljs-function"> override </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cerr</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"redirect to "</span></span> &lt;&lt; redirect_info.new_url &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnAuthRequired</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(net::URLRequest* request, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> net::AuthChallengeInfo&amp; auth_info)</span></span></span><span class="hljs-function"> override </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cerr</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"auth req"</span></span> &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnCertificateRequested</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(net::URLRequest *request, net::SSLCertRequestInfo *cert_request_info)</span></span></span><span class="hljs-function"> override </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cerr</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"cert req"</span></span> &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnSSLCertificateError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(net::URLRequest* request, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> net_error, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> net::SSLInfo&amp; ssl_info, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fatal)</span></span></span><span class="hljs-function"> override </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cerr</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"cert err"</span></span> &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnResponseStarted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(net::URLRequest *request, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> net_error)</span></span></span><span class="hljs-function"> override </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cerr</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"resp started"</span></span> &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> n = request-&gt;Read(buf_.get(), BUF_SZ); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cerr</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"resp read "</span></span> &lt;&lt; n &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n == net::ERR_IO_PENDING) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { OnReadCompleted(request, n); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>(buf_-&gt;data(), n) &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnReadCompleted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(net::URLRequest *request, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bytes_read)</span></span></span><span class="hljs-function"> override </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cerr</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"completed"</span></span> &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; quit_closure_.Run(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: base::Closure quit_closure_; scoped_refptr&lt;net::IOBuffer&gt; buf_; };</code> </pre> <br>  All the main logic is in the <code>OnResponseStarted</code> event <code>OnResponseStarted</code> : the contents of the response are read until an error occurs or there is nothing to read.  Since after reading the response, you need to terminate the application, the delegate must have access to the function that will interrupt the main <code>Run loop</code> , in this case, callback of type <code>base::Closure</code> . <br><br>  Now everything is ready to send the request: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">MyDelegate </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delegate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(run_loop.QuitClosure())</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> req = ctx-&gt;CreateRequest(GURL(args[<span class="hljs-number"><span class="hljs-number">0</span></span>]), net::RequestPriority::DEFAULT_PRIORITY, &amp;delegate); req-&gt;Start();</code> </pre> <br>  For the request to start processing, you need to run the <code>Run loop</code> : <br><br><pre> <code class="cpp hljs">run_loop.Run();</code> </pre> <br>  The full version can be found on <a href="https://github.com/sergei-svistunov/chromium-as-framework-article/tree/example-3">github</a> . <br><br>  To build and run the application you need to run: <br><br><pre> <code class="bash hljs">autoninja -C out/Default example out/Default/example <span class="hljs-string"><span class="hljs-string">"https://example.com/"</span></span></code> </pre> <br><h2>  The final </h2><br>  In fact, in Chromium you can find a lot of useful cubes and bricks from which you can build applications.  It is constantly evolving, which, on the one hand, is a plus, and on the other hand, regular API changes do not allow to relax.  For example, in the latest release, <code>base::TaskScheduler</code> turned into <code>base::ThreadPool</code> , thankfully, without changing the API. <br><br>  PS We are looking for a leading C ++ programmer in our team!  If you feel strong, our wishes are described here: <a href="https://team.mail.ru/vacancy/4641/">team.mail.ru/vacancy/4641/</a> .  There is also a button "Respond". </div><p>Source: <a href="https://habr.com/ru/post/455956/">https://habr.com/ru/post/455956/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../455948/index.html">RAMBleed: remove the RSA-key in 34 hours</a></li>
<li><a href="../45595/index.html">Airplane effect</a></li>
<li><a href="../455950/index.html">The rarest and most expensive programming languages. Part II</a></li>
<li><a href="../455952/index.html">Roslyn Code Generation</a></li>
<li><a href="../455954/index.html">The use and protection of legacy in the modern world</a></li>
<li><a href="../455960/index.html">Why developers leave: 8 reasons</a></li>
<li><a href="../455962/index.html">Data Science and Tropics Conference</a></li>
<li><a href="../455968/index.html">I make a big half-bed on solar panels for 250,000 rubles (1 part)</a></li>
<li><a href="../45597/index.html">The beginning of sales of WiMAX modems in Moscow</a></li>
<li><a href="../455970/index.html">Everything you wanted to know about SwiftUI, but were afraid to ask</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>