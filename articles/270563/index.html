<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a VPN tunnel between two apartments based on routers with dd-wrt</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Background: 
 Actually, the task is to unite house 1 and house 2. In service, we have the following schemes: 

 House 1: -internet prov. Beeline l2tp;...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a VPN tunnel between two apartments based on routers with dd-wrt</h1><div class="post__text post__text-html js-mediator-article"><h4>  Background: </h4><br>  Actually, the task is to unite house 1 and house 2. In service, we have the following schemes: <br><br>  House 1: <i>-internet prov.</i>  <i>Beeline l2tp;</i>  <i>psTV (196.168.2.13);</i>  <i>dir615C2 (ext: 192.168.2.1, ext: 95.24.xh (will be a VPN client))</i> <br><br>  House 2: <i>-internet prov.</i>  <i>Interzet with white ip;</i>  <i>PS4 (192.168.1.13);</i>  <i>dir6154 (ext st.IP: 188..., vnt: 192.168.1.1 (there will be a VPN server)</i> <br><a name="habracut"></a><br>  Dd-wrt firmware was installed on both routers.  The installation procedure is not complicated, there is a lot of information on this topic on the Internet. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The goal is that the dir615c2 equipment (hereinafter referred to as ‚ÄúB‚Äù) is available on the dir615E4 local network (hereafter referred to as ‚ÄúA‚Äù) and back. <br><br><h4>  Preparation, problems, solution: </h4><br>  After installing dd-wrt and setting up an internet connection, it was noticed on the router And the lack of ping between clients connected via lan (there is no such problem with wifi).  This problem is solved in two ways: <br><br>  1. Installing the <i>dd-wrt</i> firmware <i>from 04-18-2014-r23919</i> <br><br>  2. Entering the ‚ÄúAdministrator - Commands‚Äù tab and executing the command: <br><br><pre><code class="hljs sql">swconfig dev eth0 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> enable_vlan <span class="hljs-number"><span class="hljs-number">1</span></span> swconfig dev eth0 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">apply</span></span></code> </pre> <br>  Inspired by the settings, I felt the desire to make automatic switching off and on WIFI, whether for the purpose of experiment, or to reduce the number of radiating devices in the apartment.  For this, several solutions were found: <br><br>  1. Using <i>ifup, ifdown,</i> and <i>cron</i> commands.  For this, in the ‚ÄúAdministrator‚Äù tab in the Cron item we write: <br><br><pre> <code class="hljs markdown">0 7 <span class="hljs-bullet"><span class="hljs-bullet">* *</span></span> <span class="hljs-bullet"><span class="hljs-bullet">* root /sbin/ifconfig ath0 up 0 0 *</span></span> <span class="hljs-bullet"><span class="hljs-bullet">* *</span></span> root /sbin/ifconfig ath0 down</code> </pre><br>  This will enable on.  at 7:00 am and off  00:00 night.  But I, like many, she did not work. <br><br>  2. This method consists in using the WPS / Reboot button on the router body.  For this, in the Services menu in the <i>SES / AOSS / EZ-SETUP / WPS Button</i> item follows on.  <i>Turning off radio.</i>  But every time to press the button is not very interesting. <br><br>  3. Using the WIFI scheduling command: <br><br><pre> <code class="hljs pgsql">nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> radio0_timer_enable=<span class="hljs-number"><span class="hljs-number">1</span></span> nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> radio0_on_time=<span class="hljs-number"><span class="hljs-number">000000011111111111111111</span></span> nvram <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span></code> </pre><br>  Where 0 is off, 1 is on, in my example it is on.  at 7:00 and off  at 01:00. <br><br>  Now you can proceed to configure the VPN.  The PPTP server is raised to ‚ÄúA‚Äù, and the client is raised to ‚ÄúB‚Äù.  Make sure the VPN is working on the tab ‚ÄúStatus - lan‚Äù.  At the bottom indicates that the client "B" is connected to the server "A". <br><br>  <i>(Server and client settings were carried out in the Web interface)</i> <br><br><img src="https://habrastorage.org/files/461/716/4a5/4617164a510e41c9a8d4dfef6ee45187.jpg"><br><br>  On the server, setting the name and password should be put * through a space. <br><br><img src="https://habrastorage.org/files/9ee/b1e/d96/9eeb1ed96fd14079ba19dbc9b8ba1d5a.jpg"><br><br>  If you, like me, have a router based on the <i>Atheros AR7240</i> , then perhaps the VPN client will remain with its local IP when connected (without taking ip from the server range).  In this case, you need to add <i>noipdefault</i> in the field of encryption mpppe.  Also, it will not be superfluous to add <i>--nobuffer</i> in the <i>SP</i> box of the pptp server separated by a space for off.  buffering. <br><br>  Now that we have a VPN tunnel, we need to register a route to the next network. <br><br>  "A" has a network of 192.168.1.0/24 and ip as a VPN server 172.16.1.1 <br>  "B" has a network of 192.168.2.0/24 and ip as a VPN client 172.16.1.51 <br><br>  For access from "A" to "B" you need to set: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-net</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">netmask</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">gw</span></span> 172<span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span></code> </pre><br>  To access from "B" in "A" you need to specify: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-net</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">netmask</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">gw</span></span> 172<span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.51</span></span></code> </pre><br>  Since when reconnecting the client to the VPN server, the route will be reset and it will have to be re-set, it was decided to write a Shell script.  He would periodically check for the presence of a route and in the case of his absence he checked the raising of the tunnel, and if there was one, he would set the route. <br><br>  It looks like this for the server: <br><br><pre> <code class="hljs pgsql">#!/bin/sh <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> PPTP=`ip ro | awk <span class="hljs-string"><span class="hljs-string">'/192.168.2.0/ {print $1}'</span></span>`; test "$PPTP" = "192.168.2.0/24" <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; #      ip ro    <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> PPTPup=`ip ro | awk <span class="hljs-string"><span class="hljs-string">'/172.16.1.51/ {print $1}'</span></span>`; test "$PPTPup" != "" <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> -net <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> gw <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; #      ip ro "VPN"           fi fi <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>;</code> </pre><br>  For the client, we change 192.168.2.0 to 192.168.1.0, 172.16.1.51 to 172.16.1.1, 172.16.1.1 to 172.16.1.51. <br><br>  Now we need to make this script work at a given interval.  It is possible to do this in the ‚ÄúAdministrator‚Äù tab in the Cron paragraph, we write: <br><br><pre> <code class="hljs markdown"><span class="hljs-emphasis"><span class="hljs-emphasis">*/3 *</span></span> <span class="hljs-bullet"><span class="hljs-bullet">* *</span></span> * root /tmp/custom.sh</code> </pre><br>  This will give us the launch of the script every 3 minutes, every hour and every day.  This completes the VPN tunnel setup. </div><p>Source: <a href="https://habr.com/ru/post/270563/">https://habr.com/ru/post/270563/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../270549/index.html">How we moved the disk space of hundreds of bank branches to a single storage system in Moscow without losing LAN speeds in the field</a></li>
<li><a href="../270551/index.html">Use VTune Amplifier 2016 to analyze the HelloOpenCL application for GPU</a></li>
<li><a href="../270555/index.html">Veeam Cloud Connect in Microsoft Azure</a></li>
<li><a href="../270557/index.html">What is useful you can extract from the report on the clouds in Russia</a></li>
<li><a href="../270559/index.html">The book "Learning C + + through game programming"</a></li>
<li><a href="../270565/index.html">ABBYY helps startups</a></li>
<li><a href="../270571/index.html">LinOTP + RADIUS. Authentication with one-time passwords</a></li>
<li><a href="../270573/index.html">How to find the longest continuous series of events using SQL</a></li>
<li><a href="../270577/index.html">Database generalization level</a></li>
<li><a href="../270579/index.html">Speeding up work with Emmet, or my first step to open source</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>