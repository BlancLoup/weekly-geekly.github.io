<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We generate a beautiful Google spreadsheet from our program (using the Google Sheets API v4)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Formulation of the problem 
 Suppose we need to create a table like this in the Python language program: 

  

 Features of this table: 



- set the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We generate a beautiful Google spreadsheet from our program (using the Google Sheets API v4)</h1><div class="post__text post__text-html js-mediator-article"><h2>  Formulation of the problem </h2><br>  Suppose we need to create <a href="https://docs.google.com/spreadsheets/d/1kygOW5wSSVqwf26M-OCT72i0FX0olZAz4duT2i6psp4/edit%3Fusp%3Dsharing">a table like this</a> in the Python language program: <br><br> <a href="https://habrahabr.ru/post/305378/"><img src="https://habrastorage.org/files/5c8/3b1/1f8/5c83b11f836a4dac84a584158a40a6c1.png" alt="image"></a> <br><br>  Features of this table: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  set the width of the columns; </li><li>  the top cell is the union <b>A1: E1</b> ; </li><li>  Some of the cells have been configured: display format, font size, boldness, text alignment and background color; </li><li>  the values ‚Äã‚Äãin the last column are calculated by the formula (for example, in <b>E4</b> it is written <b>= D4-C4</b> ); </li><li>  draw border under cells <b>A3: E3</b> ; </li><li>  Pikachu is present (but it will remain as homework for enthusiasts). </li></ul><br>  Interesting?  Then welcome under cat. <br><a name="habracut"></a><br><h2>  Decision </h2><br>  Immediately sweep out inappropriate libraries.  For example, <a href="https://github.com/burnash/gspread">gspread</a> .  This is a wrapper over <a href="https://developers.google.com/google-apps/spreadsheets/">Google Sheets API <b>v3</b></a> , in which <b>there are no</b> methods for customizing the table layout.  Even the width of the column can not be set. <br><br>  We will use <a href="https://developers.google.com/sheets/">Google Sheets API <b>v4</b></a> . <br><br><h3>  <font color="#ff6000">Step 1. Create a service account</font> </h3><br><ol><li>  Enter the <a href="https://console.developers.google.com/project">Google Developers Console</a> and create a new project (or use some of those that already exist). </li><li>  Enable the Drive API and Sheets API for this project. </li><li>  Create credentials and save private key: <br><br><img src="https://habrastorage.org/files/ad7/59a/1b3/ad759a1b37a340b1aff711873b3aab2c.png"></li></ol><br><br><h3>  <font color="#ff6000">Step 2. Install the necessary libraries</font> </h3><br>  Namely, <b>google-api-python-client</b> .  <a href="https://developers.google.com/api-client-library/python/start/installation">You</a> can <a href="https://developers.google.com/api-client-library/python/start/installation">install</a> using <b>pip</b> , for example: <br><br><pre><code class="bash hljs">pip install --upgrade google-api-python-client</code> </pre> <br>  This library will attract the necessary dependencies (such as <b>oauth2client</b> and others). <br><br><h3>  <font color="#ff6000">Step 3. Encode</font> </h3><br><h4>  <font color="#006000">3.1.</font>  <font color="#006000">Service object</font> </h4><br>  Import the necessary: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> httplib2 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> apiclient.discovery <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> oauth2client.service_account <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ServiceAccountCredentials</code> </pre><br>  Create a service object to work with Google-tables: <br><br><pre> <code class="python hljs">CREDENTIALS_FILE = <span class="hljs-string"><span class="hljs-string">'test-proj-for-habr-article-1ab131d98a6b.json'</span></span> <span class="hljs-comment"><span class="hljs-comment">#      credentials = ServiceAccountCredentials.from_json_keyfile_name(CREDENTIALS_FILE, ['https://www.googleapis.com/auth/spreadsheets', 'https://www.googleapis.com/auth/drive']) httpAuth = credentials.authorize(httplib2.Http()) service = apiclient.discovery.build('sheets', 'v4', http = httpAuth)</span></span></code> </pre><br><h4>  <font color="#006000">3.2.</font>  <font color="#006000">Terms and id'shniki</font> </h4><br>  Now for a moment we stop and discuss the terminology. <br><br><ul><li>  <b>spreadsheet</b> is a google document with spreadsheets.  Below I will call the <b>document</b> (or the English name). <br><br>  It has a <code><b><font color="#0000FF">spreadsheetId</font></b></code> form <code>1kygOW5wSSVqwf26M-OCT72i0FX0olZAz4duT2i6psp4</code> . </li><li>  <b>sheet</b> is a <b>sheet</b> inside a <b>spreadsheet</b> .  In other words, a tab with one of the tables (there may be several inside one document). <br><br>  <b>Sheet</b> has <code><b><font color="#0000FF">sheetId</font></b></code> being a number.  The first sheet that was created in the document is id.  There is always at least one sheet in the document (you cannot delete it).  All sheets have different id and different names. <br><br><div class="spoiler">  <b class="spoiler_title">History of worksheet</b> <div class="spoiler_text">  In the old API, a worksheet is called a <b>worksheet</b> .  It has a <code><b><font color="#0000FF">worksheetId</font></b></code> (or <code><b><font color="#0000FF">wid</font></b></code> ) that looks like <code>oowy6v0</code> .  To convert to a number you need a <a href="http://stackoverflow.com/a/26885636/1565832">special perversion</a> : <br><pre> <code class="python hljs">wid2sheetId = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> wid: int(wid[<span class="hljs-number"><span class="hljs-number">1</span></span>:] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(wid) &gt; <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> wid, <span class="hljs-number"><span class="hljs-number">36</span></span>) ^ (<span class="hljs-number"><span class="hljs-number">474</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(wid) &gt; <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">31578</span></span>)</code> </pre></div></div></li></ul><br>  Link to a specific sheet is formed as follows: <br> <code>https://docs.google.com/spreadsheets/d/ <b><font color="#0000FF">spreadsheetId</font></b> /edit#gid= <b><font color="#0000FF">sheetId</font></b></code> <br>  If you discard <code>#gid= <b><font color="#0000FF">sheetId</font></b></code> , then the link opens the first sheet in the document. <br><br><h4>  <font color="#006000">3.3.</font>  <font color="#006000">New spreadsheet</font> </h4><br>  Let's go back to the code.  The <code>service</code> object we created gives us <a href="https://developers.google.com/sheets/reference/rest/">only 9 functions</a> .  One of them is called <a href="https://developers.google.com/sheets/reference/rest/v4/spreadsheets/create"><b>spreadsheets.create</b></a> , it creates a new <b>spreadsheet</b> .  As an argument, pass a <a href="https://developers.google.com/sheets/reference/rest/v4/spreadsheets">Spreadsheet</a> object.  It is not required to fill in all of its fields, most have default values. <br><br><pre> <code class="python hljs">spreadsheet = service.spreadsheets().create(body = { <span class="hljs-string"><span class="hljs-string">'properties'</span></span>: {<span class="hljs-string"><span class="hljs-string">'title'</span></span>: <span class="hljs-string"><span class="hljs-string">'   '</span></span>, <span class="hljs-string"><span class="hljs-string">'locale'</span></span>: <span class="hljs-string"><span class="hljs-string">'ru_RU'</span></span>}, <span class="hljs-string"><span class="hljs-string">'sheets'</span></span>: [{<span class="hljs-string"><span class="hljs-string">'properties'</span></span>: {<span class="hljs-string"><span class="hljs-string">'sheetType'</span></span>: <span class="hljs-string"><span class="hljs-string">'GRID'</span></span>, <span class="hljs-string"><span class="hljs-string">'sheetId'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'title'</span></span>: <span class="hljs-string"><span class="hljs-string">'   '</span></span>, <span class="hljs-string"><span class="hljs-string">'gridProperties'</span></span>: {<span class="hljs-string"><span class="hljs-string">'rowCount'</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">'columnCount'</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>}}}] }).execute()</code> </pre><br>  In response, we receive again the <a href="https://developers.google.com/sheets/reference/rest/v4/spreadsheets">Spreadsheet</a> object, only the filled parameters are greater: <br><br><div class="spoiler">  <b class="spoiler_title">Watch answer</b> <div class="spoiler_text"><pre> <code class="python hljs">{<span class="hljs-string"><span class="hljs-string">'properties'</span></span>: {<span class="hljs-string"><span class="hljs-string">'autoRecalc'</span></span>: <span class="hljs-string"><span class="hljs-string">'ON_CHANGE'</span></span>, <span class="hljs-string"><span class="hljs-string">'defaultFormat'</span></span>: {<span class="hljs-string"><span class="hljs-string">'backgroundColor'</span></span>: {<span class="hljs-string"><span class="hljs-string">'blue'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'green'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'red'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}, <span class="hljs-string"><span class="hljs-string">'padding'</span></span>: {<span class="hljs-string"><span class="hljs-string">'bottom'</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'left'</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">'right'</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">'top'</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>}, <span class="hljs-string"><span class="hljs-string">'textFormat'</span></span>: {<span class="hljs-string"><span class="hljs-string">'bold'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, <span class="hljs-string"><span class="hljs-string">'fontFamily'</span></span>: <span class="hljs-string"><span class="hljs-string">'arial,sans,sans-serif'</span></span>, <span class="hljs-string"><span class="hljs-string">'fontSize'</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">'foregroundColor'</span></span>: {}, <span class="hljs-string"><span class="hljs-string">'italic'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, <span class="hljs-string"><span class="hljs-string">'strikethrough'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, <span class="hljs-string"><span class="hljs-string">'underline'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>}, <span class="hljs-string"><span class="hljs-string">'verticalAlignment'</span></span>: <span class="hljs-string"><span class="hljs-string">'BOTTOM'</span></span>, <span class="hljs-string"><span class="hljs-string">'wrapStrategy'</span></span>: <span class="hljs-string"><span class="hljs-string">'OVERFLOW_CELL'</span></span>}, <span class="hljs-string"><span class="hljs-string">'locale'</span></span>: <span class="hljs-string"><span class="hljs-string">'ru_RU'</span></span>, <span class="hljs-string"><span class="hljs-string">'timeZone'</span></span>: <span class="hljs-string"><span class="hljs-string">'Etc/GMT'</span></span>, <span class="hljs-string"><span class="hljs-string">'title'</span></span>: <span class="hljs-string"><span class="hljs-string">'   '</span></span>}, <span class="hljs-string"><span class="hljs-string">'sheets'</span></span>: [{<span class="hljs-string"><span class="hljs-string">'properties'</span></span>: {<span class="hljs-string"><span class="hljs-string">'gridProperties'</span></span>: {<span class="hljs-string"><span class="hljs-string">'columnCount'</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">'rowCount'</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span>}, <span class="hljs-string"><span class="hljs-string">'index'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'sheetId'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'sheetType'</span></span>: <span class="hljs-string"><span class="hljs-string">'GRID'</span></span>, <span class="hljs-string"><span class="hljs-string">'title'</span></span>: <span class="hljs-string"><span class="hljs-string">'   '</span></span>}}], <span class="hljs-string"><span class="hljs-string">'spreadsheetId'</span></span>: <span class="hljs-string"><span class="hljs-string">'1Sfl7EQ0Yuyo65INidt4LCrHMzFI9wrmc96qHq6EEqHM'</span></span>}</code> </pre></div></div><br>  It was possible to specify many of them in the request, but the default parameters suit us for solving the current problem. <br>  The <code>locale</code> parameter was set to <code>ru_RU</code> not by chance, but more on that later. <br><br>  The response contains <code>spreadsheetId</code> .  Hooray!  We go to look at the <a href="https://docs.google.com/spreadsheets/d/1Sfl7EQ0Yuyo65INidt4LCrHMzFI9wrmc96qHq6EEqHM/edit">created document</a> with our eyes ... and break off, because we do not have access to it.  Even reading.  Just like the usual hand-freshly created Google-table user. <br>  And who has access?  At the service account. <br><br><div class="spoiler">  <b class="spoiler_title">Click on the button "Request permission for access"?</b> <div class="spoiler_text">  Do not spam yourself.  Clicking this button will send a letter to an e-mail like <i>account@test-proj-for-habr-article.iam.gserviceaccount.com</i> .  It will not be possible to deliver this letter (because the domain does not exist), and you will receive a message about the unsuccessful delivery of the letter.  The content of the letter also does not help, because the link for issuing access can only work if you are logged in under the owner‚Äôs account, that is, under the service account. <br></div></div><br>  What to do?  The answer is obvious: give access to the document using the API too. <br><br><div class="spoiler">  <b class="spoiler_title">Well, or another option</b> <div class="spoiler_text">  You can create a document manually on your Google disk and give access to the service account (that is, manually issue permissions to that e-mail like <i>account@test-proj-for-habr-article.iam.gserviceaccount.com</i> ).  Then work with this document through the API. <br><br>  This option did not suit me, because I needed to teach the program to create many different documents. <br></div></div><br><h4>  <font color="#006000">3.4.</font>  <font color="#006000">Access to a new document</font> </h4><br>  Our <code>service</code> object has no method for setting up access to the document.  It is simply not in the Google Sheets API.  But <a href="https://developers.google.com/drive/v3/web/manage-sharing">he is</a> in <a href="https://developers.google.com/drive/v3/web/about-sdk">Google <b>Drive</b> API v3</a> .  We write the code. <br><br><pre> <code class="python hljs">driveService = apiclient.discovery.build(<span class="hljs-string"><span class="hljs-string">'drive'</span></span>, <span class="hljs-string"><span class="hljs-string">'v3'</span></span>, http = httpAuth) shareRes = driveService.permissions().create( fileId = spreadsheet[<span class="hljs-string"><span class="hljs-string">'spreadsheetId'</span></span>], body = {<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'anyone'</span></span>, <span class="hljs-string"><span class="hljs-string">'role'</span></span>: <span class="hljs-string"><span class="hljs-string">'reader'</span></span>}, <span class="hljs-comment"><span class="hljs-comment">#      fields = 'id' ).execute()</span></span></code> </pre><br>  This code gives everyone access to reading <a href="https://docs.google.com/spreadsheets/d/1cZydEMbMomTfmPFj6IX_5F0ayiKD8H4DKS3lQt0wChc/edit">on the link</a> .  Suppose we wish instead to give edit access to <i>user@example.com</i> .  For this instead <br><br><pre> <code class="python hljs">{<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'anyone'</span></span>, <span class="hljs-string"><span class="hljs-string">'role'</span></span>: <span class="hljs-string"><span class="hljs-string">'reader'</span></span>}</code> </pre> <br>  write <br><br><pre> <code class="python hljs">{<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'user'</span></span>, <span class="hljs-string"><span class="hljs-string">'role'</span></span>: <span class="hljs-string"><span class="hljs-string">'writer'</span></span>, <span class="hljs-string"><span class="hljs-string">'emailAddress'</span></span>: <span class="hljs-string"><span class="hljs-string">'user@example.com'</span></span>}</code> </pre> <br><h4>  <font color="#006000">3.5.</font>  <font color="#006000">Some more theory</font> </h4><br>  We begin the design of the table by setting the width of the columns.  Oh, and where is the function?  Everything is not so transparent and a bit more clever than just any <code>setColumnWidth</code> . <br><br>  There is a function <a href="https://developers.google.com/sheets/reference/rest/v4/spreadsheets/batchUpdate"><b>spreadsheets.batchUpdate</b></a> .  She immediately applies a wad of changes to the document.  Or rather, she first checks the entire bundle for correctness.  If everything is OK, then it atomically applies everything and returns the corresponding stack of results.  The list of changes that can be applied by this function <a href="https://developers.google.com/sheets/reference/rest/v4/spreadsheets/request">is here</a> . <br><br><h4>  <font color="#006000">3.6.</font>  <font color="#006000">Column width</font> </h4><br>  To set the width of the columns you need to do <a href="https://developers.google.com/sheets/reference/rest/v4/spreadsheets/request">UpdateDimensionPropertiesRequest</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read code</b> <div class="spoiler_text"><pre> <code class="python hljs">results = service.spreadsheets().batchUpdate(spreadsheetId = spreadsheet[<span class="hljs-string"><span class="hljs-string">'spreadsheetId'</span></span>], body = { <span class="hljs-string"><span class="hljs-string">"requests"</span></span>: [ <span class="hljs-comment"><span class="hljs-comment">#    A: 317  { "updateDimensionProperties": { "range": { "sheetId": 0, "dimension": "COLUMNS", # COLUMNS -    "startIndex": 0, #     "endIndex": 1 # startIndex  , endIndex -  , # ..        [0,1), ..    A }, "properties": { "pixelSize": 317 #    }, "fields": "pixelSize" #    pixelSize       } }, #    B: 200  { "updateDimensionProperties": { "range": { "sheetId": 0, "dimension": "COLUMNS", "startIndex": 1, "endIndex": 2 }, "properties": { "pixelSize": 200 }, "fields": "pixelSize" } }, #    C  D: 165  { "updateDimensionProperties": { "range": { "sheetId": 0, "dimension": "COLUMNS", "startIndex": 2, "endIndex": 4 }, "properties": { "pixelSize": 165 }, "fields": "pixelSize" } }, #    E: 100  { "updateDimensionProperties": { "range": { "sheetId": 0, "dimension": "COLUMNS", "startIndex": 4, "endIndex": 5 }, "properties": { "pixelSize": 100 }, "fields": "pixelSize" } } ] }).execute()</span></span></code> </pre></div></div><br>  It turned out very cumbersome and a lot of copy-paste.  At this stage, I decided to write a small wrapper class over the Sheets API, which will give me the necessary methods in a convenient form. <br><br><h4>  <font color="#006000">3.7.</font>  <font color="#006000">Wrapper class logic</font> </h4><br>  Let the wrapper class (let's call it <b>Spreadsheet</b> ) store the <b>requests</b> list and, in its <b>runPrepared</b> method <b>,</b> pass it to the <b>spreadsheets.batchUpdate</b> function and then clear it.  The items in this list will be added by the methods of the <b>prepare_</b> type of the <b>corresponding Request</b> . <br><br>  Now the code for setting the width of the columns looks like this: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># ss -    Spreadsheet ss.prepare_setColumnWidth(0, 317) ss.prepare_setColumnWidth(1, 200) ss.prepare_setColumnsWidth(2, 3, 165) ss.prepare_setColumnWidth(4, 100) ss.runPrepared()</span></span></code> </pre><br>  And here is the code for the <b>prepare_setColumnWidth</b> and <b>prepare_setColumnsWidth methods</b> : <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Spreadsheet</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... def prepare_setDimensionPixelSize(self, dimension, startIndex, endIndex, pixelSize): self.requests.append({"updateDimensionProperties": { "range": {"sheetId": self.sheetId, "dimension": dimension, "startIndex": startIndex, "endIndex": endIndex}, "properties": {"pixelSize": pixelSize}, "fields": "pixelSize"}}) def prepare_setColumnsWidth(self, startCol, endCol, width): self.prepare_setDimensionPixelSize("COLUMNS", startCol, endCol + 1, width) def prepare_setColumnWidth(self, col, width): self.prepare_setColumnsWidth(col, col, width)</span></span></code> </pre> <br>  I will give the code of the <b>runPrepared</b> method a little further, because it will be replenished with something else. <br><br><h4>  <font color="#006000">3.8.</font>  <font color="#006000">Filling cells with data</font> </h4><br>  To fill the cells with information in Google Sheets API v4, the function <a href="https://developers.google.com/sheets/reference/rest/v4/spreadsheets.values/batchUpdate"><b>spreadsheets.values.batchUpdate is</b></a> provided, which works on the same principle as <b>spreadsheets.batchUpdate</b> .  It takes a list of rectangles and values ‚Äã‚Äãto write to each of them.  In addition, it accepts the <a href="https://developers.google.com/sheets/reference/rest/v4/ValueInputOption">ValueInputOption</a> parameter: <br><br><ul><li>  if <code>USER_ENTERED</code> , then the data is interpreted as being entered by the user; </li><li>  if <code>RAW</code> , they are not interpreted in any way and are stored in their raw form. </li></ul><br>  We need the first option, because it is required that the table recognize dates and formulas. <br><br>  This is how you can fill in data with a pair of rectangles on a sheet <b>without</b> using our wrapper class: <br><br><pre> <code class="python hljs">results = service.spreadsheets().values().batchUpdate(spreadsheetId = spreadsheet[<span class="hljs-string"><span class="hljs-string">'spreadsheetId'</span></span>], body = { <span class="hljs-string"><span class="hljs-string">"valueInputOption"</span></span>: <span class="hljs-string"><span class="hljs-string">"USER_ENTERED"</span></span>, <span class="hljs-string"><span class="hljs-string">"data"</span></span>: [ {<span class="hljs-string"><span class="hljs-string">"range"</span></span>: <span class="hljs-string"><span class="hljs-string">"   !B2:C3"</span></span>, <span class="hljs-string"><span class="hljs-string">"majorDimension"</span></span>: <span class="hljs-string"><span class="hljs-string">"ROWS"</span></span>, <span class="hljs-comment"><span class="hljs-comment">#   ,   (..     values -  ) "values": [["This is B2", "This is C2"], ["This is B3", "This is C3"]]}, {"range": "   !D5:E6", "majorDimension": "COLUMNS", #   ,   (..     values -  ) "values": [["This is D5", "This is D6"], ["This is E5", "=5+5"]]} ] }).execute()</span></span></code> </pre><br>  We will <a href="https://docs.google.com/spreadsheets/d/1PPVP_0HIH9sljQjD86pKJaYaPFmMJgONLpUc9Djhoqg/edit">receive such a document</a> . <br><br>  Now we will make our wrapper class provide convenient methods to achieve the same result. <br>  Let the <b>spreadsheets.values.batchUpdate</b> function be called in the <b>runPrepared</b> method, and the <b>prepare_setValues</b> method add a rectangle and data to the <b>valueRanges</b> list, which when called <b>runPrepared</b> will be passed to <b>spreadsheets.values.batchUpdate</b> . <br><br>  The code for the <b>prepare_setValues</b> and <b>runPrepared methods are</b> : <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Spreadsheet</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... def prepare_setValues(self, cellsRange, values, majorDimension = "ROWS"): self.valueRanges.append({"range": self.sheetTitle + "!" + cellsRange, "majorDimension": majorDimension, "values": values}) # spreadsheets.batchUpdate and spreadsheets.values.batchUpdate def runPrepared(self, valueInputOption = "USER_ENTERED"): upd1Res = {'replies': []} upd2Res = {'responses': []} try: if len(self.requests) &gt; 0: upd1Res = self.service.spreadsheets().batchUpdate(spreadsheetId = self.spreadsheetId, body = {"requests": self.requests}).execute() if len(self.valueRanges) &gt; 0: upd2Res = self.service.spreadsheets().values().batchUpdate(spreadsheetId = self.spreadsheetId, body = {"valueInputOption": valueInputOption, "data": self.valueRanges}).execute() finally: self.requests = [] self.valueRanges = [] return (upd1Res['replies'], upd2Res['responses'])</span></span></code> </pre><br>  Fill in the data with the same pair of rectangles as in the example above, but already using our wrapper class: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># ss -    Spreadsheet ss.prepare_setValues("B2:C3", [["This is B2", "This is C2"], ["This is B3", "This is C3"]]) ss.prepare_setValues("D5:E6", [["This is D5", "This is D6"], ["This is E5", "=5+5"]], "COLUMNS") ss.runPrepared()</span></span></code> </pre><br><h4>  <font color="#006000">3.9.</font>  <font color="#006000">Combining cells, setting boldness, display format, background color and other things</font> </h4><br>  Who can not wait, you can immediately <a href="https://github.com/Tsar/Spreadsheet/blob/master/Spreadsheet.py">read the full code of the class <b>Spreadsheet</b></a> and <a href="https://github.com/Tsar/Spreadsheet/blob/master/Spreadsheet.py">an example of its use</a> , which is a solution to the problem posed at the beginning of the article. <br><br>  For a more patient reader: <br><br><ul><li>  <a href="https://developers.google.com/sheets/reference/rest/v4/spreadsheets/request">MergeCellsRequest</a> - merge cells. <br><br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   A1:E1 {'mergeCells': {'range': {'sheetId': 0, 'startRowIndex': 0, 'endRowIndex': 1, 'startColumnIndex': 0, 'endColumnIndex': 5}, 'mergeType': 'MERGE_ALL'}} #       Spreadsheet ss.prepare_mergeCells('A1:E1')</span></span></code> </pre></div></div></li><li>  <a href="https://developers.google.com/sheets/reference/rest/v4/spreadsheets/request">RepeatCellRequest</a> ‚Äî apply the same changes to all cells in the specified range. <br><br><div class="spoiler">  <b class="spoiler_title">Examples</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#        A3:E3 {'repeatCell': {'range': {'sheetId': 0, 'startRowIndex': 2, 'endRowIndex': 3, 'startColumnIndex': 0, 'endColumnIndex': 5}, 'cell': {'userEnteredFormat': {'horizontalAlignment': 'CENTER', 'textFormat': {'bold': True}}}, 'fields': 'userEnteredFormat'}} #       #   ¬´¬ª   E4:E8 {'repeatCell': {'range': {'sheetId': 0, 'startRowIndex': 3, 'endRowIndex': 8, 'startColumnIndex': 4, 'endColumnIndex': 5}, 'cell': {'userEnteredFormat': {'numberFormat': {'pattern': '[h]:mm:ss', 'type': 'TIME'}}}, 'fields': 'userEnteredFormat.numberFormat'}} #       #       Spreadsheet ss.prepare_setCellsFormat('A3:E3', {'horizontalAlignment': 'CENTER', 'textFormat': {'bold': True}}) ss.prepare_setCellsFormat('E4:E8', {'numberFormat': {'pattern': '[h]:mm:ss', 'type': 'TIME'}}, fields = 'userEnteredFormat.numberFormat')</span></span></code> </pre></div></div></li><li>  <a href="https://developers.google.com/sheets/reference/rest/v4/spreadsheets/request">UpdateCellsRequest</a> - apply the changes specified for each cell in the specified range. <br><br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#      : B4 - , C4 - , B5 - , C5 -  {'updateCells': {'range': {'sheetId': 0, 'startRowIndex': 3, 'endRowIndex': 5, 'startColumnIndex': 1, 'endColumnIndex': 3}, 'rows': [{'values': [{'userEnteredFormat': {'backgroundColor': {'red': 1, 'green': 0, 'blue': 0}}}, {'userEnteredFormat': {'backgroundColor': {'red': 0, 'green': 1, 'blue': 0}}}]}, {'values': [{'userEnteredFormat': {'backgroundColor': {'red': 0, 'green': 0, 'blue': 1}}}, {'userEnteredFormat': {'backgroundColor': {'red': 1, 'green': 1, 'blue': 0}}}]}], 'fields': 'userEnteredFormat'}} #       Spreadsheet ss.prepare_setCellsFormats('B4:C5', [[{'backgroundColor': {'red': 1, 'green': 0, 'blue': 0}}, {'backgroundColor': {'red': 0, 'green': 1, 'blue': 0}}], [{'backgroundColor': {'red': 0, 'green': 0, 'blue': 1}}, {'backgroundColor': {'red': 1, 'green': 1, 'blue': 0}}]])</span></span></code> </pre></div></div></li><li>  <a href="https://developers.google.com/sheets/reference/rest/v4/spreadsheets/request">UpdateBordersRequest</a> - set the cell boundary. <br><br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#     1  A3:E3 {'updateBorders': {'range': {'sheetId': 0, 'startRowIndex': 2, 'endRowIndex': 3, 'startColumnIndex': 0, 'endColumnIndex': 5}, 'bottom': {'style': 'SOLID', 'width': 1, 'color': {'red': 0, 'green': 0, 'blue': 0, 'alpha': 1}}}}</span></span></code> </pre></div></div></li></ul><br><h3>  <font color="#ff6000">Some subtleties</font> </h3><br>  <b>Q1:</b> Why is it that when creating the document (in 3.3) the <code>locale</code> parameter was set to <code>ru_RU</code> ? <br>  <b>A1:</b> The fact is that in this case, a string that looks like <code>2 <u></u> 2016 17:57:52</code> will be recognized by the table as a date and time.  Accordingly, such cells can be used in a formula to calculate the duration (as the difference of two dates, for example). <br><br>  <b>Q2:</b> From where it is received that the format "duration" is <code>{'numberFormat': {'pattern': '[h]:mm:ss', 'type': 'TIME'}}</code> ? <br><br><img src="https://habrastorage.org/files/808/68e/447/80868e447dec4b75991f323d254f58ed.png"><br><br>  <b>A2:</b> You can get to the bottom of this by studying the documentation.  But I just manually set the specific duration display format for a specific cell, and then I got the document with the program using the <a href="https://developers.google.com/sheets/reference/rest/v4/spreadsheets/get"><b>spreadsheets.get</b></a> function, setting the <code>includeGridData</code> parameter to <code>True</code> , and looked at the value of the <code>numberFormat</code> parameter in that cell. <br><br>  <b>Q3:</b> In the queries sent to the <b>spreadsheets.batchUpdate</b> function, the <code>range</code> parameter has the format <a href="https://developers.google.com/sheets/reference/rest/v4/spreadsheets">GridRange</a> : <br><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">'sheetId'</span></span>: , <span class="hljs-string"><span class="hljs-string">'startRowIndex'</span></span>: , <span class="hljs-string"><span class="hljs-string">'endRowIndex'</span></span>: , <span class="hljs-string"><span class="hljs-string">'startColumnIndex'</span></span>: , <span class="hljs-string"><span class="hljs-string">'endColumnIndex'</span></span>:  }</code> </pre><br>  And in the data rectangles for the <b>spreadsheets.values.batchUpdate</b> function, the <code>range</code> parameter is a string, of the type <code>_!A5:E7</code> ( <a href="https://developers.google.com/sheets/guides/concepts">A1 notation</a> ).  Strange. <br>  <b>A3:</b> Yes.  Perhaps in the comments on the article, someone will explain why. <br>  In the wrapper class, I made the <a href="https://github.com/Tsar/Spreadsheet/blob/master/Spreadsheet.py">toGridRange</a> method for convenience. <br><br>  <b>Q4:</b> Pikachu, who in the <a href="https://docs.google.com/spreadsheets/d/1kygOW5wSSVqwf26M-OCT72i0FX0olZAz4duT2i6psp4/edit%3Fusp%3Dsharing">table at the beginning of the article</a> , is planted there programmatically? <br>  <b>A4:</b> No, Pikachu I placed in the table manually.  I'm not sure that Google Sheets API v4 allows you to do this programmatically, but I didn‚Äôt find the necessary function right away. <br><br>  <b>Q5:</b> Are there any restrictions on using Google Sheets API v4? <br>  <b>A5:</b> Yes, they are called quotas.  You can <a href="https://console.developers.google.com/iam-admin/quotas">follow</a> them <a href="https://console.developers.google.com/iam-admin/quotas">in the Google Developers Console</a> .  You can also send a request to increase the quota, if it is not enough. <br><img src="https://habrastorage.org/files/c7b/9a1/0bf/c7b9a10bf43744f5bd9a52b8043e05f2.png"><br><br><h2>  Conclusion </h2><br>  If you‚Äôve read this far, you‚Äôve probably learned how to programmatically create a spreadsheet, and now you‚Äôll be eager to use Google spreadsheets in all your projects :) <br><br>  Let me reiterate the most important links: <br><ul><li>  <a href="https://developers.google.com/sheets/">Google Sheets API v4</a> </li><li>  <a href="https://console.developers.google.com/">Google Developers Console</a> </li><li>  <a href="https://github.com/Tsar/Spreadsheet/blob/master/Spreadsheet.py">Spreadsheet wrapper class and examples of its use</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/305378/">https://habr.com/ru/post/305378/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../305366/index.html">Amazing story document.write</a></li>
<li><a href="../305368/index.html">QNX 2 per virtual machine</a></li>
<li><a href="../305372/index.html">Ubuntu Unity desktop shell launched in Windows 10 environment</a></li>
<li><a href="../305374/index.html">UX design in the mobile application: a request to evaluate the application</a></li>
<li><a href="../305376/index.html">The digest of fresh materials from the world of the frontend for the last week No. 219 (July 4 - 10, 2016)</a></li>
<li><a href="../305380/index.html">MongoDB Replica Set and OpLog on the same server</a></li>
<li><a href="../305382/index.html">Bitrix - UrlRewrite (feat. Juggernaut)</a></li>
<li><a href="../305384/index.html">Announcement of the public beta version of NGINX Amplify</a></li>
<li><a href="../305386/index.html">Azure-IaaS-Digest number 8 (June-July)</a></li>
<li><a href="../305388/index.html">Gateway Virtualization with Hyper-v</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>