<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tidying up POSTs in ASP.NET MVC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The topic describes one of the professional techniques of developing ASP.NET MVC applications, which can significantly reduce the number of duplicate ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tidying up POSTs in ASP.NET MVC</h1><div class="post__text post__text-html js-mediator-article">  The topic describes one of the professional techniques of developing <a href="http://www.asp.net/mvc">ASP.NET MVC</a> applications, which can significantly reduce the number of duplicate code in POST action handlers for forms.  In spite of the fact that I found out about it at the time of the first edition of <a href="http://www.manning.com/palermo/">ASP.NET MVC In Action</a> and the first <a href="http://www.mvcconf.com/">mvcConf</a> , the presentation style of <a href="http://twitter.com/">Jimmy Bogard</a> seemed to me very simple and I decided to publish a free translation for those who do not use this approach in practice. . <br><br><a name="habracut"></a><br>  Many people ask why <a href="http://automapper.codeplex.com/">AutoMapper has</a> so few built-in capabilities for reverse mapping ( <a href="http://ru.wikipedia.org/wiki/DTO">DTO</a> s -&gt; persistent object models).  The fact is that the existing capabilities severely limit the domain models, forcing them to be anemic, so we just found another way to deal with the complexity in our POST requests. <br><br>  Look at the medium / large ASP.NET MVC site, at the complexity or size, and you will notice that there are some patterns in the implementation.  You will see a big difference between what your GET and POST actions look like.  This is expected because  GETs are requests (Queries), and POSTs are commands (Commands) (if you implemented them correctly, then that's it).  You will not necessarily see a 1: 1 ratio for form tags and POST actions, since  The form can also be used to send requests (for example, a search form). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For GET action, in my opinion, the problem has already been solved.  GET actions create a ViewModel and send it to the view and use any number of optimizations / abstractions (AutoMapper, model binding, projections on conventions, etc.). <br><br>  POSTs are a completely different beast.  The vectors of difficulty in changing information and the receipt / validation of commands are completely orthogonal to GETs, which causes us to throw away all our previous decisions.  Usually we see something like this: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">[HttpPost] <br> <font color="#0000ff">public</font> ActionResult Edit(ConferenceEditModel form) <br> { <br> <font color="#0000ff">if</font> (!ModelState.IsValid) <br> { <br> <font color="#0000ff">return</font> View(form); <br> } <br> <br> <font color="#0000ff">var</font> conf = _repository.GetById(form.Id); <br> <br> conf.ChangeName(form.Name); <br> <br> <font color="#0000ff">foreach</font> ( <font color="#0000ff">var</font> attendeeEditModel <font color="#0000ff">in</font> form.Attendees) <br> { <br> <font color="#0000ff">var</font> attendee = conf.GetAttendee(attendeeEditModel.Id); <br> <br> attendee.ChangeName(attendeeEditModel.FirstName, attendeeEditModel.LastName); <br> attendee.Email = attendeeEditModel.Email; <br> } <br> <br> <font color="#0000ff">return</font> <font color="#0000ff">this</font> .RedirectToAction(c =&gt; c.Index( <font color="#0000ff">null</font> ), <font color="#A31515">"Default"</font> ); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  What we see again and again and again is a pattern similar to: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">[HttpPost] <br> <font color="#0000ff">public</font> ActionResult Edit( <font color="red">SomeEditModel</font> form) <br> { <br> <font color="#0000ff">if</font> ( <font color="red">IsNotValid</font> ) <br> { <br> <font color="#0000ff">return</font> <font color="red">ShowAView</font> (form); <br> } <br> <br> <font color="red">DoActualWork</font> (); <br> <br> <font color="#0000ff">return</font> <font color="red">RedirectToSuccessPage</font> (); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Where everything that is marked in red changes from POST action to POST action. <br><br>  So why should we worry about these actions?  Why not form a common way of doing what we see here?  Here are a few reasons we encountered: <br><ul><li>  POST actions require dependencies other than GETs, and the dichotomy between these types leads to controller swelling (controllers); </li><li>  The desire to make changes / improvements for ALL POST actions is centralized, as an example, adding logging, validation, authorization, event notifications, etc; </li><li>  The problems are thoroughly mixed.  PERFORMANCE of work is mixed with MANAGEMENT in how this work should be done.  Sometimes it's terrible. </li></ul><br>  As a workaround, we used a combination of techniques: <br><ul><li>  Own result of action (action result) for management of the general flow of execution; </li><li>  Separation of ‚Äújob performance‚Äù and the overall flow of execution. </li></ul><br>  We do not always want to create these abstractions, but this can be useful for managing the complexity of POSTs.  First, let's create the result of the action. <br><br><h4>  Determining the overall flow of execution </h4><br>  Before going too far along the path of creating an action result, let's look at the general pattern above.  Some things need to be defined in the controller action, but others may be random.  For example, the ‚ÄúDoActualWork‚Äù block can be defined based on the form received.  We will never have 2 different ways to handle the action of a form, so let's define an interface to handle this form: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">interface</font> IFormHandler&lt;T&gt; <br> { <br> <font color="#0000ff">void</font> Handle(T form); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Everything is quite simple, a class that represents " <a href="http://msdn.microsoft.com/ru-ru/library/018hxwa8.aspx">Action (T)</a> " or the implementation of the pattern Command.  In fact, if you are familiar with messages, it looks just like a message handler.  A form is a message and the handler knows what to do with such a message. <br><br>  The abstraction above represents what we need to do for the ‚ÄúDoActualWork‚Äù block, and the rest can be dragged into the overall result of the action: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> FormActionResult&lt;T&gt; : ActionResult <br> { <br> <font color="#0000ff">public</font> ViewResult Failure { <font color="#0000ff">get</font> ; <font color="#0000ff">private</font> <font color="#0000ff">set</font> ; } <br> <font color="#0000ff">public</font> ActionResult Success { <font color="#0000ff">get</font> ; <font color="#0000ff">private</font> <font color="#0000ff">set</font> ; } <br> <font color="#0000ff">public</font> T Form { <font color="#0000ff">get</font> ; <font color="#0000ff">private</font> <font color="#0000ff">set</font> ; } <br> <br> <font color="#0000ff">public</font> FormActionResult(T form, ActionResult success, ViewResult failure) <br> { <br> Form = form; <br> Success = success; <br> Failure = failure; <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#0000ff">void</font> ExecuteResult(ControllerContext context) <br> { <br> <font color="#0000ff">if</font> (!context.Controller.ViewData.ModelState.IsValid) <br> { <br> Failure.ExecuteResult(context); <br> <br> <font color="#0000ff">return</font> ; <br> } <br> <br> <font color="#0000ff">var</font> handler = ObjectFactory.GetInstance&lt;IFormHandler&lt;T&gt;&gt;(); <br> <br> handler.Handle(Form); <br> <br> Success.ExecuteResult(context); <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  We reviewed the main execution pipeline (execution pipeline), and found pieces that vary.  It is noteworthy that this is an <a href="http://msdn.microsoft.com/ru-ru/library/system.web.mvc.actionresult.aspx">ActionResult</a> to execute in case of a successful outcome, and an ActionResult is in case of an unsuccessful outcome.  The specific form handler to execute is already determined based on the type of form, so we use any popular <a href="http://ru.wikipedia.org/wiki/%25D0%259E%25D0%25B1%25D1%2580%25D0%25B0%25D1%2589%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25BA%25D0%25BE%25D0%25BD%25D1%2582%25D1%2580%25D0%25BE%25D0%25BB%25D1%258F">IoC</a> container to find a specific form handler to execute ( <a href="http://structuremap.net/structuremap/">StructureMap</a> in my case).  Say StructureMap to find implementations of IFormHandler based on implementations is just one line of code: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">Scan(scanner =&gt; <br> { <br> scanner.TheCallingAssembly(); <br> scanner.ConnectImplementationsToTypesClosing( <font color="#0000ff">typeof</font> (IFormHandler&lt;&gt;)); <br> }); <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Now drag the ‚ÄúDoActualWork‚Äù block into the class that deals only with form processing, and not with tracking UI traffic: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> ConferenceEditModelFormHandler <br> : IFormHandler&lt;ConferenceEditModel&gt; <br> { <br> <font color="#0000ff">private</font> <font color="#0000ff">readonly</font> IConferenceRepository _repository; <br> <br> <font color="#0000ff">public</font> ConferenceEditModelFormHandler( <br> IConferenceRepository repository) <br> { <br> _repository = repository; <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> Handle(ConferenceEditModel form) <br> { <br> Conference conf = _repository.GetById(form.Id); <br> <br> conf.ChangeName(form.Name); <br> <br> <font color="#0000ff">foreach</font> ( <font color="#0000ff">var</font> attendeeEditModel <font color="#0000ff">in</font> GetAttendeeForms(form)) <br> { <br> Attendee attendee = conf.GetAttendee(attendeeEditModel.Id); <br> <br> attendee.ChangeName(attendeeEditModel.FirstName, <br> attendeeEditModel.LastName); <br> attendee.Email = attendeeEditModel.Email; <br> } <br> } <br> <br> <font color="#0000ff">private</font> ConferenceEditModel.AttendeeEditModel[] GetAttendeeForms(ConferenceEditModel form) <br> { <br> <font color="#0000ff">return</font> form.Attendees ?? <br> <font color="#0000ff">new</font> ConferenceEditModel.AttendeeEditModel[0]; <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Now this class is designed only for successful form processing.  Namely, returning to my domain object and changing it accordingly.  Because  I have a behavioral model of the domain, you will not see the possibility of "reverse mapping".  This is intentional. <br><br>  What is really interesting is how we isolated all these problems and that they are no longer dependent on a particular ASP.NET result of the action.  At the moment, we have effectively separated the problems of doing work from direct work. <br><br><h4>  With reference to our controller </h4><br>  Now that we have developed our result of the action, the last problem remains - applying this result of the action to our controller action.  Like most people, we often insert a layer in the class hierarchy of controllers to be able to apply helper methods in all of our controllers.  In this class, we will add a helper method for constructing our custom action result: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> DefaultController : Controller <br> { <br> <font color="#0000ff">protected</font> FormActionResult&lt;TForm&gt; Form&lt;TForm&gt;( <br> TForm form, <br> ActionResult success) <br> { <br> <font color="#0000ff">var</font> failure = View(form); <br> <br> <font color="#0000ff">return</font> <font color="#0000ff">new</font> FormActionResult&lt;TForm&gt;(form, success, failure); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  It simply wraps some default paths that we often define.  For example, a processing error almost always shows the view from which we just came.  Finally, we can change our original POST controller action: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> ConferenceController : DefaultController <br> { <br> [HttpPost] <br> <font color="#0000ff">public</font> ActionResult Edit(ConferenceEditModel form) <br> { <br> <font color="#0000ff">var</font> successResult = <br> <font color="#0000ff">this</font> .RedirectToAction(c =&gt; c.Index( <font color="#0000ff">null</font> ), <font color="#A31515">"Default"</font> ); <br> <br> <font color="#0000ff">return</font> Form(form, successResult); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  We have reduced the action of the controller so that it is really a description of what we do, and how we do it, we moved to the level below.  This is a classic example of applying OO <a href="http://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25BC%25D0%25BF%25D0%25BE%25D0%25B7%25D0%25B8%25D1%2586%25D0%25B8%25D1%258F_(%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)">composition</a> in practice, we have combined various ways of performing POST forms into the result of an action and implemented a form handler.  In fact, we didn‚Äôt reduce the code that we are forced to write, it just moved, and it became a little easier for us to talk. <br><br>  Another interesting side effect is that we are now creating modular / integration tests for the form handler, but not for the controller action.  And what is there to check it?  We have no incentive to write a test, because  there is too little logic. <br><br>  Observing the use of large-scale patterns, it is important to investigate first the aggregation of routes (routes).  This allows us to be a little more flexible in folding the pieces together than in the case of inherited routes. <br><br>  Although this is a somewhat complicated example, in the next article we will look at how more complex POST actions can look when our validation goes beyond simple elements and our POST handlers become even more difficult. </div><p>Source: <a href="https://habr.com/ru/post/123113/">https://habr.com/ru/post/123113/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../123107/index.html">Marketing is like seasoning. The basics</a></li>
<li><a href="../123108/index.html">On the Sony Ericsson phones the opportunity to make video calls via Skype</a></li>
<li><a href="../123109/index.html">Freedom is slavery</a></li>
<li><a href="../123111/index.html">The instruction crib for beginners</a></li>
<li><a href="../123112/index.html">The film will be able to make any LCD-screen suitable for three-dimensional image.</a></li>
<li><a href="../123114/index.html">How to encrypt your files and improve security Dropbox</a></li>
<li><a href="../123116/index.html">How to effectively use the search string in Evernote</a></li>
<li><a href="../123117/index.html">AWS cancels incoming traffic charges</a></li>
<li><a href="../123120/index.html">Operative all standards</a></li>
<li><a href="../123121/index.html">Facebook users are still putting their friends at risk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>