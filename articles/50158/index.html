<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Parser math expressions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Thank you all! The article gained the necessary number of advantages and the author joins us! Here it is: elw00d 
 I present to the attention of fello...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Parser math expressions</h1><div class="post__text post__text-html js-mediator-article">  <b>Thank you all!</b>  <b>The article gained the necessary number of advantages and the author joins us!</b>  <b>Here it is: <a href="https://habrahabr.ru/users/elw00d/" class="user_link">elw00d</a></b> <br>  I present to the attention of fellow donetchikov a library of my own writing, with the help of which one can easily handle simple mathematical functions, translating them from the string form of infix notation into a processed representation composed in postfix notation, and back.  What can it be needed for? <br><br>  For example, you can write an application that accepts user input as a string, analyzes syntax correctness, calculates its value at specified points, optimizes the entered expression, minimizing the number of operations required for the calculation, and can produce the result as a string that represents the correct string representation of the optimized function.  As specific applications, various specialized calculators (including those built like programmable ones), applications used to build graphs or other reports that require defining initial functions, or as an original tool for building anti-spam / automatic registrations can be mentioned. <br><a name="habracut"></a><br>  It all started with the fact that I saw an application written by some superprogrammer for laboratory work on numerical optimization methods.  The input of the original function in it was organized in the following original way: the user (== student) entered the function, and the program generated the source code and started the next-line Delphi compiler to get the DLL.  Then the DLL that appeared appeared in the program and the graph was built according to the function.  Laughing a little at the developer‚Äôs resourcefulness, I thought, how could it be possible to organize similar functionality without using such a thick ‚Äúplug-in‚Äù as the Delphi compiler?  As a result, I got an idea to write my own parser for such tasks.  That's what came out of this idea. <br><br>  At the moment, the following functionality has been implemented and tested: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      1. Analysis of lines of expressions composed of standard mathematical operators +, -, /, *, functions <br>  sin, cos, brackets.  It supports variables with any names that are acceptable for the syntax <br>  analyzer (consist of letters and numbers, must begin with a letter). <br><br>  An example of such an expression is the string <br>  ‚Äú <b>-4 + 5.5 * sin (1/3) * (2 + 5)</b> ‚Äù. <br><br>  To calculate this expression, you need to write code: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//      </font> PreparedExpression preparedExpression = ToolsHelper.Parser.Parse( <font color="#A31515">"-4+5.5*sin(1/3)*(2+5)"</font> ); CompiledExpression compiledExpression = ToolsHelper.Compiler.Compile(preparedExpression); <font color="#008000">//   ,      </font> <font color="#008000">//     ,      </font> <font color="#2B91AF">List</font> &lt;VariableValue&gt; variables = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt;VariableValue&gt;(); <font color="#008000">//    </font> <font color="#0000ff">double</font> res = ToolsHelper.Calculator.Calculate(compiledExpression, variables);</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <ol><li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> //       PreparedExpression preparedExpression = ToolsHelper.Parser.Parse( <font color="#A31515">"-4+5.5*sin(1/3)*(2+5)"</font> ); CompiledExpression compiledExpression = ToolsHelper.Compiler.Compile(preparedExpression); <font color="#008000">//   ,      </font> <font color="#008000">//     ,      </font> <font color="#2B91AF">List</font> &lt;VariableValue&gt; variables = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt;VariableValue&gt;(); <font color="#008000">//    </font> <font color="#0000ff">double</font> res = ToolsHelper.Calculator.Calculate(compiledExpression, variables); <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#008000">//      </font> PreparedExpression preparedExpression = ToolsHelper.Parser.Parse( <font color="#A31515">"-4+5.5*sin(1/3)*(2+5)"</font> ); CompiledExpression compiledExpression = ToolsHelper.Compiler.Compile(preparedExpression); <font color="#008000">//   ,      </font> <font color="#008000">//     ,      </font> <font color="#2B91AF">List</font> &lt;VariableValue&gt; variables = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt;VariableValue&gt;(); <font color="#008000">//    </font> <font color="#0000ff">double</font> res = ToolsHelper.Calculator.Calculate(compiledExpression, variables); <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#008000">//      </font> PreparedExpression preparedExpression = ToolsHelper.Parser.Parse( <font color="#A31515">"-4+5.5*sin(1/3)*(2+5)"</font> ); CompiledExpression compiledExpression = ToolsHelper.Compiler.Compile(preparedExpression); <font color="#008000">//   ,      </font> <font color="#008000">//     ,      </font> <font color="#2B91AF">List</font> &lt;VariableValue&gt; variables = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt;VariableValue&gt;(); <font color="#008000">//    </font> <font color="#0000ff">double</font> res = ToolsHelper.Calculator.Calculate(compiledExpression, variables); <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#008000">//      </font> PreparedExpression preparedExpression = ToolsHelper.Parser.Parse( <font color="#A31515">"-4+5.5*sin(1/3)*(2+5)"</font> ); CompiledExpression compiledExpression = ToolsHelper.Compiler.Compile(preparedExpression); //   ,       <font color="#008000">//     ,      </font> <font color="#2B91AF">List</font> &lt;VariableValue&gt; variables = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt;VariableValue&gt;(); <font color="#008000">//    </font> <font color="#0000ff">double</font> res = ToolsHelper.Calculator.Calculate(compiledExpression, variables); <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#008000">//      </font> PreparedExpression preparedExpression = ToolsHelper.Parser.Parse( <font color="#A31515">"-4+5.5*sin(1/3)*(2+5)"</font> ); CompiledExpression compiledExpression = ToolsHelper.Compiler.Compile(preparedExpression); <font color="#008000">//   ,      </font> //     ,       <font color="#2B91AF">List</font> &lt;VariableValue&gt; variables = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt;VariableValue&gt;(); <font color="#008000">//    </font> <font color="#0000ff">double</font> res = ToolsHelper.Calculator.Calculate(compiledExpression, variables); <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#008000">//      </font> PreparedExpression preparedExpression = ToolsHelper.Parser.Parse( <font color="#A31515">"-4+5.5*sin(1/3)*(2+5)"</font> ); CompiledExpression compiledExpression = ToolsHelper.Compiler.Compile(preparedExpression); <font color="#008000">//   ,      </font> <font color="#008000">//     ,      </font> <font color="#2B91AF">List</font> &lt;VariableValue&gt; variables = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt;VariableValue&gt;(); <font color="#008000">//    </font> <font color="#0000ff">double</font> res = ToolsHelper.Calculator.Calculate(compiledExpression, variables); <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#008000">//      </font> PreparedExpression preparedExpression = ToolsHelper.Parser.Parse( <font color="#A31515">"-4+5.5*sin(1/3)*(2+5)"</font> ); CompiledExpression compiledExpression = ToolsHelper.Compiler.Compile(preparedExpression); <font color="#008000">//   ,      </font> <font color="#008000">//     ,      </font> <font color="#2B91AF">List</font> &lt;VariableValue&gt; variables = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt;VariableValue&gt;(); //     <font color="#0000ff">double</font> res = ToolsHelper.Calculator.Calculate(compiledExpression, variables); <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#008000">//      </font> PreparedExpression preparedExpression = ToolsHelper.Parser.Parse( <font color="#A31515">"-4+5.5*sin(1/3)*(2+5)"</font> ); CompiledExpression compiledExpression = ToolsHelper.Compiler.Compile(preparedExpression); <font color="#008000">//   ,      </font> <font color="#008000">//     ,      </font> <font color="#2B91AF">List</font> &lt;VariableValue&gt; variables = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt;VariableValue&gt;(); <font color="#008000">//    </font> <font color="#0000ff">double</font> res = ToolsHelper.Calculator.Calculate(compiledExpression, variables); <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> </ol> <code><font color="gray"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//      </font> PreparedExpression preparedExpression = ToolsHelper.Parser.Parse( <font color="#A31515">"-4+5.5*sin(1/3)*(2+5)"</font> ); CompiledExpression compiledExpression = ToolsHelper.Compiler.Compile(preparedExpression); <font color="#008000">//   ,      </font> <font color="#008000">//     ,      </font> <font color="#2B91AF">List</font> &lt;VariableValue&gt; variables = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt;VariableValue&gt;(); <font color="#008000">//    </font> <font color="#0000ff">double</font> res = ToolsHelper.Calculator.Calculate(compiledExpression, variables);</font> * This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  2. The ability to quickly add the necessary functions and operators by simply configuring the xml-config library.  Functions with multiple arguments are supported, for example, you can define your own signature of the myfunc function, which takes 2 parameters.  In the expression, it can be called like this: ‚Äúmyfunc (12, x)‚Äù.  Here x is a variable, its value must be transferred to the calculator during the calculation. <br><br>  Operators with more than two operands are also supported (as an example, the library has already defined the ternary operator?: Which gives the value of the second or third operand, depending on the sign of the first operand. <br><br>  All operations (operators and functions) are characterized by a signature (a symbolic representation by which occurrences in the source string are searched for), priority, the number of operands, and a calculator class that will be used to calculate this operation.  The class calculator implements the interface <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">public</font> <font color="#0000ff">interface</font> IOperationCalculator { </li><li>  <font color="#008000">/// &lt;summary&gt;</font> </li><li>  <font color="#008000">/// Returns a result of operation called.</font> </li><li>  <font color="#008000">/// &lt;/ summary&gt;</font> </li><li>  <font color="#0000ff">double</font> Calculate ( <font color="#0000ff">params</font> <font color="#0000ff">double</font> [] parameters); </li><li>  } </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  Thus, in order to add a new operator or function, you need to define a class-calculator for this function and add an entry to Operations.xml of the form <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">&lt;</font> <font color="#800000">operation</font> <font color="#ff0000">name</font> <font color="#0000ff">= "sinus"</font> <font color="#ff0000">operands</font> <font color="#0000ff">= "1"</font> <font color="#ff0000">kind</font> <font color="#0000ff">= "function"</font> <font color="#0000ff">&gt;</font> </li><li>  <font color="#0000ff">&lt;</font> <font color="#800000">signatures</font> <font color="#0000ff">&gt;</font> </li><li>  <font color="#0000ff">&lt;</font> <font color="#800000">signature</font> <font color="#ff0000">number</font> <font color="#0000ff">= "1"</font> <font color="#ff0000">value</font> <font color="#0000ff">= "sin"</font> <font color="#0000ff">/&gt;</font> </li><li>  <font color="#0000ff">&lt;/</font> <font color="#800000">signatures</font> <font color="#0000ff">&gt;</font> </li><li>  <font color="#0000ff">&lt;</font> <font color="#800000">calculator</font> <font color="#ff0000">type</font> <font color="#0000ff">= "ELW.Library.Math.Calculators.Standard.CalculatorSinus, ELW.Library.Math"</font> <font color="#0000ff">/&gt;</font> </li><li>  <font color="#0000ff">&lt;/</font> <font color="#800000">operation</font> <font color="#0000ff">&gt;</font> </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br><br>  During initialization, the library will load the types necessary for processing the added function and match this operation with an instance of the selected calculator class.  During the calculation, the corresponding Calculate () function with the passed parameters will be called. <br><br>  3. The ability to optimize the compiled expression by predicting constants.  For example, the expression (3 + 5) / x can be reduced to the form 8 / x.  The resulting expression can be used in calculations instead of the original one, and even output to the user as a slightly simplified version of its function.  The optimization algorithm can be improved by adding new features (if someone, of course, lights up with such an idea). <br><br>  4. Ability to control the intermediate stages of the transformation of expressions.  From string to a sequence of signatures and operands, then to the reverse Polish record from operands and operations, and vice versa.  In general, possible transitions are reflected in the following diagram: <br><img src="https://habrastorage.org/getpro/habr/post_images/3ca/709/a36/3ca709a36cdddaa66b3f3f7172ac34b6.jpg" alt="image"><br>  String and Double are primitive types, expression processing begins with them, and usually ends with them. <br>  Prepared Expression - consists of a set of elements, each of which is either a constant, or a variable name, or a separator, such as a bracket or comma, or a string signature of the operation.  For example, the expression (a + b) / 3 will be a set of '(', ‚Äúa‚Äù, ‚Äú+‚Äù, ‚Äúb‚Äù, ')', ‚Äú/‚Äù, 3. The number 3 is no longer in string form and Double. <br><br>  Compiled Expression is a set of operands and operations on them in postfix notation, that is, exactly what the calculator feeds on.  It is an array of operands (either a constant or a variable name) and operations (either an operator or a function).  Calculator, receiving this expression as an input, works with it according to a simple algorithm, by turns extracting operands and information about operations and performing sequential calculations in the operand stack. <br><br>  5. It is assembled both under the .NET Framework 3.5 and under .NET 2.0.  Attached are nant scripts to automate <br>  builds can be used with Visual Studio. <br><br>  Screenshot of the library example: <br><img src="https://habrastorage.org/getpro/habr/post_images/2d3/985/71e/2d398571ef1a4c6f0ee0bcb40e1f21e3.jpg" alt="image"><br>  Epilogue. <br><br>  So far, the possibilities are not too great, however, they are sufficient to play around with the invention of their own operators, with changing the priority of operator calculations, or for the primitive optimization of mathematical expressions. <br><br>  <a href="">Download library sources + test application</a> <br><br>  Things to think about: <br><br>  <a href="http://ru.wikipedia.org/wiki/%25D0%259E%25D0%25B1%25D1%2580%25D0%25B0%25D1%2582%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BF%25D0%25BE%25D0%25BB%25D1%258C%25D1%2581%25D0%25BA%25D0%25B0%25D1%258F_%25D0%25B7%25D0%25B0%25D0%25BF%25D0%25B8%25D1%2581%25D1%258C">ru.wikipedia.org/wiki/Reverse_pole_record</a> <br>  <a href="http://msdn.microsoft.com/ru-ru/library/ms139741.aspx">msdn.microsoft.com/en-ru/library/ms139741.aspx</a> </div><p>Source: <a href="https://habr.com/ru/post/50158/">https://habr.com/ru/post/50158/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../50151/index.html">Let's beat Ruby together! Drop eleventh</a></li>
<li><a href="../50152/index.html">Script for recursive directory comparison</a></li>
<li><a href="../50153/index.html">Legend of the Black Point</a></li>
<li><a href="../50155/index.html">Increasing the speed of SQL queries</a></li>
<li><a href="../50157/index.html">rails scaffold news - how?</a></li>
<li><a href="../50160/index.html">Enable font smoothing in wine</a></li>
<li><a href="../50162/index.html">Does Google Translate Translate Microsoft?</a></li>
<li><a href="../50165/index.html">The fall of the channel between Moscow and St. Petersburg</a></li>
<li><a href="../50168/index.html">Broken windows</a></li>
<li><a href="../50169/index.html">2. Metaprogramming patterns - 22yu. Reuse in small - bang!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>