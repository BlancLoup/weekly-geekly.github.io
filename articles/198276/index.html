<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Zabbix: Backing up a small base</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Omit a long introduction on the need to back up data. We all know what backups need to do. Those who actively use Zabbix, also think about the possibi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Zabbix: Backing up a small base</h1><div class="post__text post__text-html js-mediator-article">  Omit a long introduction on the need to back up data.  We all know what backups need to do.  Those who actively use Zabbix, also think about the possibility of restoring the database if it is damaged or transferred to a new server, etc.  It is clear that replication is the best option for this, but not every organization can afford it.  I will show how the problem of Zabbix backup is solved here.  If anyone is interested, I ask under the cat. <br><a name="habracut"></a><br>  <i>Warning: I do not consider the diagram below as ideal, so the article was not written as a sample, but with the aim of obtaining constructive criticism and useful tips for improvement.</i> <br><br>  When I faced the need to back up the Zabbix database, I did not go far and decided to use a proven tool: <b>mysqldump</b> .  It has proven itself well when used with databases of other web services, such as redmine, glpi, drupal and others, but in the case of Zabbix it turned out to be completely unsuitable.  Backups were made, no errors occurred, but one day it was a black day when backup was required to be restored.  It took about two days to unload a relatively small database from a dump.  Considering that the database at that time was, it can be said, in its infancy, the downtime would increase significantly in the future.  It was absolutely unacceptable.  It was then that my eyes fell on <b>Percona XtraBackup</b> . <br><br>  <a href="http://www.percona.com/software/percona-xtrabackup">Percona Xtrabackup</a> is an open source software product that allows you to make backup copies of MySQL databases without blocking.  Open Query, mozilla.org and Facebook use this program, which allows to conclude that this is not a raw red-eyed product.  I note that in my case, Percona could not be used in conjunction with a zabbix server due to the poor performance of the disk subsystem.  Sometimes there were errors related to the fact that Percona did not have time to read the data that Zabbix was actively recording.  It was decided to stop the zabbix server at the time of the backup.  Today it takes about 6 minutes a day.  Considering that all particularly critical triggers are tied to SNMP traps, which, after running the zabbix-server, will still not be left unrecorded, for me this time is quite acceptable.  Perhaps, in your case, you will not have to stop the Zabbix daemon, and there will be no idle time at all. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Then I thought what should be the perfect backup for me.  And I realized that the best backup is the one you don‚Äôt worry about, but you know that it is executed.  I managed to achieve this result: I do not care about backups.  I do not go to the server every morning, fingers crossed, and do not check the log, file size and remaining space on the partition.  But I know that backups are being made, because I receive all the necessary information by e-mail.  This is helped by a fairly simple script that I want to bring to the public.  Perhaps there are some problems with him that I do not suspect? <br><br>  In Zabbix, we set up email notifications.  To do this, use <b>ssmtp</b> .  There are enough instructions on the Internet, besides, the topic is considered to be quite different, so I will not dwell on this.  In addition to Percona and ssmtp, nothing specific is used: tar, gzip, sed and find is in every distribution.  For reliability, backup files are duplicated to a remote server via NFS. <br><br>  The system on which <i>it is</i> used: <br><img src="https://habrastorage.org/storage3/b6d/1b6/3c9/b6d1b63c9d123742edef556a3b46ec8b.png"><br><br><div class="spoiler">  <b class="spoiler_title">Actually script</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash DAY=`date +%Y%m%d` LOGFILE=/var/log/zabbix_backup.log # E-mail,     EMAIL=admin@host.com #   logfile  mailfile:             logrotate MAILFILE=/tmp/mailfile.tmp #    BK_GLOBAL=/home/zabbix/backups #     BK_DIR=$BK_GLOBAL/Zabbix_$DAY # # set_date        set_date () { DT=`date "+%y%m%d %H:%M:%S"` } # mkdir $BK_DIR set_date echo -e "$DT     ZABBIX" &gt; $MAILFILE service zabbix-server stop 2&gt;&gt;$MAILFILE innobackupex --user=root --password=qwerty --no-timestamp $BK_DIR/xtra 2&gt;&amp;1 | tee /var/log/innobackupex.log | egrep "ERROR|innobackupex: completed OK" &gt;&gt;$MAILFILE innobackupex --apply-log --use-memory=1000M $BK_DIR/xtra 2&gt;&amp;1 | tee /var/log/innobackupex.log | egrep "ERROR|innobackupex: completed OK" &gt;&gt;$MAILFILE #  Percona Xtrabackup   :    .    ,   tee  egrep. service zabbix-server start 2&gt;&gt;$MAILFILE set_date echo -e "$DT     " &gt;&gt; $MAILFILE set_date echo -e "$DT  " &gt;&gt; $MAILFILE cd $BK_DIR tar -cf $BK_DIR/zabbix_db_$DAY.tar ./xtra 2&gt;&gt;$MAILFILE rm -rf $BK_DIR/xtra cd /usr/share tar -cf $BK_DIR/zabbix_files_$DAY.tar ./zabbix 2&gt;&gt;$MAILFILE cd /etc tar -cf $BK_DIR/zabbix_etc_$DAY.tar ./zabbix 2&gt;&gt;$MAILFILE cd / gzip $BK_DIR/zabbix_db_$DAY.tar 2&gt;&gt;$MAILFILE gzip $BK_DIR/zabbix_files_$DAY.tar 2&gt;&gt;$MAILFILE gzip $BK_DIR/zabbix_etc_$DAY.tar 2&gt;&gt;$MAILFILE set_date echo -e "$DT  " &gt;&gt; $MAILFILE rm -f zabbix_db_$DAY.tar rm -f zabbix_files_$DAY.tar rm -f zabbix_etc_$DAY.tar set_date echo -e "$DT  NFS-" &gt;&gt; $MAILFILE mount 192.168.1.30:/home/backups /mnt/nfs 2&gt;&gt;$MAILFILE set_date echo -e "$DT     " &gt;&gt; $MAILFILE mkdir /mnt/nfs/Zabbix_$DAY cp $BK_DIR/zabbix_db_$DAY.tar.gz /mnt/nfs/Zabbix_$DAY 2&gt;&gt;$MAILFILE cp $BK_DIR/zabbix_files_$DAY.tar.gz /mnt/nfs/Zabbix_$DAY 2&gt;&gt;$MAILFILE cp $BK_DIR/zabbix_etc_$DAY.tar.gz /mnt/nfs/Zabbix_$DAY 2&gt;&gt;$MAILFILE set_date echo -e "$DT     " &gt;&gt; $MAILFILE echo -e "$DT   " &gt;&gt; $MAILFILE find $BK_GLOBAL/* -type f -ctime +30 -exec rm -rf {} \; 2&gt;&gt;$MAILFILE find /mnt/nfs/* -type f -ctime +30 -exec rm -rf {} \; 2&gt;&gt;$MAILFILE find $BK_GLOBAL/* -type d -name "*" -empty -delete 2&gt;&gt;$MAILFILE find /mnt/nfs/* -type d -name "*" -empty -delete 2&gt;&gt;$MAILFILE set_date echo -e "$DT   " &gt;&gt; $MAILFILE echo -e "$DT  NFS-\n" &gt;&gt; $MAILFILE umount /mnt/nfs 2&gt;&gt;$MAILFILE cat $MAILFILE &gt;&gt; $LOGFILE sed -i -e "1 s/^/Subject: Zabbix backup log $DAY\n\n/;" $MAILFILE 2&gt;&gt;$LOGFILE sed -i -e "1 s/^/From: zabbixsender@host.com\n/;" $MAILFILE 2&gt;&gt;$LOGFILE sed -i -e "1 s/^/To: $EMAIL\n/;" $MAILFILE 2&gt;&gt;$LOGFILE echo -e "\n  $BK_DIR:\n" &gt;&gt; $MAILFILE ls -lh $BK_DIR &gt;&gt; $MAILFILE echo -e "\n  :\n" &gt;&gt; $MAILFILE df -h &gt;&gt; $MAILFILE cat $MAILFILE | mail -t 2&gt;&gt;$LOGFILE</span></span></code> </pre> <br></div></div><br>  Files from the / etc / zabbix and / usr / share / zabbix directories are copied to save settings and additional scripts used in Zabbix. <br><div class="spoiler">  <b class="spoiler_title">The text of the letter sent by the script</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage3/753/bba/c74/753bbac742027f1822eec2e0d3fedc9f.png"><br></div></div><br>  To restore the database from the copy, it is enough to stop mysqld, replace the directory with the one extracted from the archive and restart the MySQL daemon.  Count yourself how much time it will take for you, but I think a lot less than two days. <br>  All working backups and stable operation of all systems. </div><p>Source: <a href="https://habr.com/ru/post/198276/">https://habr.com/ru/post/198276/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../198266/index.html">Algorithm for finding paths in the maze</a></li>
<li><a href="../198268/index.html">Algorithm for learning a multilayer neural network using the back propagation error (Backpropagation)</a></li>
<li><a href="../198270/index.html">Qt Meta System over Network. Part 1 - Properties</a></li>
<li><a href="../198272/index.html">Chelyabinsk meteorite: systematized photo and video materials</a></li>
<li><a href="../198274/index.html">Metaobject Protocol for Basic Perl 5</a></li>
<li><a href="../198280/index.html">Babel and handlebars, it's time to make friends</a></li>
<li><a href="../198284/index.html">How to cheat Robokassu</a></li>
<li><a href="../198286/index.html">Part 1. Detailed instructions for creating your CocoaPod</a></li>
<li><a href="../198288/index.html">Elon Musk will make a transformed submarine from "James Bond" a real vehicle-transformer</a></li>
<li><a href="../198290/index.html">Predictive interfaces</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>