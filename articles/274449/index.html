<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Own search by hand rutracker.org - implementation on Yii2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Inspired by this publication. 

 Here is a description of how to implement a search by rutracker.org distribution on your own hosting / localhost. 


...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Own search by hand rutracker.org - implementation on Yii2</h1><div class="post__text post__text-html js-mediator-article">  Inspired by <a href="http://habrahabr.ru/post/273777/">this</a> publication. <br><br>  Here is a description of how to implement a search by rutracker.org distribution on your own hosting / localhost. <br><br><img src="https://habrastorage.org/files/8df/7e4/710/8df7e4710359499cac026ed67b642972.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Preliminary agreement:</b> <br><ul><li>  All operations are performed in a unix-like environment.  The nuances for windows are unfortunately unknown to me; </li><li>  you are supposed to have basic knowledge of Unix shell, Yii2, git </li><li>  I personally see quite a few scenarios for using this (local search by hand) solution; </li><li>  The implementation on the yii2 advanced template in this case is redundant, but I'm used to it; </li><li>  I see spinx for the first time in my life, so there may be oddities in the config file; </li><li>  in some places the decisions are quite controversial (I will be grateful for the ‚Äúhow-to‚Äù tips). </li></ul><br><br><a name="habracut"></a><br>  After reading the previous topic on this topic, I was, frankly, slightly disappointed with the implementation offered by the author.  Actually, that's why I did everything myself. <br><br>  The whole project is on <a href="https://github.com/andrew72ru/rutracker-yii2">github</a> , the whole code can be viewed there, I will only give excerpts here, for understanding the point. <br><br>  The project implemented automatic import of csv-files from <a href="http://rutracker.org/forum/viewtopic.php%3Ft%3D4824458">this</a> distribution (started from the console), and a search by name / category / subcategory of distribution. <br><br>  <b>Details</b> <br><br>  If you want to use the whole project as it is, here is a brief instruction: <br><br><ol><li>  clone repository (git clone <a href="">github.com/andrew72ru/rutracker-yii2.git</a> ) </li><li>  go to the project folder, install the components (composer install) </li><li>  initialize the environment (./init) </li><li>  create a database, configure access to it in common / config / main-local.php </li><li>  start the migration (./yii migrate) </li><li>  configure your web server to access the project (root directory is frontend / web) </li><li>  download <a href="http://rutracker.org/forum/viewtopic.php%3Ft%3D4824458">distribution</a> </li><li>  create a frontend / runtime / csv directory </li><li>  Put the latest distribution files in this directory.  The entire distribution is divided into folders, they are named dates, I took the folder with the last date </li><li>  run in the console ./yii import / import </li></ol><br><br>  On my server, the import lasted about six hours - there are more than one and a half million entries in the distribution table, do not be surprised. <br><br><div class="spoiler">  <b class="spoiler_title">DB schema</b> <div class="spoiler_text">  Table for categories: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`categories`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`category_name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_unicode_ci <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`file_name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_unicode_ci <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">37</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8 <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span>=utf8_unicode_ci;</code> </pre> <br><br>  Subcategories table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`subcategory`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`forum_name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_unicode_ci <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">1239</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8 <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span>=utf8_unicode_ci;</code> </pre><br><br>  Distribution table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`torrents`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`forum_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`forum_name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_unicode_ci <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`topic_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`hash`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_unicode_ci <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`topic_name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_unicode_ci, <span class="hljs-string"><span class="hljs-string">`size`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`datetime`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`category_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`forum_name_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`topic_id`</span></span> (<span class="hljs-string"><span class="hljs-string">`topic_id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`hash`</span></span> (<span class="hljs-string"><span class="hljs-string">`hash`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`category_torrent_fk`</span></span> (<span class="hljs-string"><span class="hljs-string">`category_id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`torrent_subcat_id`</span></span> (<span class="hljs-string"><span class="hljs-string">`forum_name_id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">`category_torrent_fk`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`category_id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> <span class="hljs-string"><span class="hljs-string">`categories`</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">`torrent_subcat_id`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`forum_name_id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> <span class="hljs-string"><span class="hljs-string">`subcategory`</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">1635590</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8 <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span>=utf8_unicode_ci;</code> </pre><br><br>  The table with distributions is somewhat redundant (the forum_name column is no longer needed, implemented as a link), but I did not delete it, so that you can refer directly to it and not use the JOIN. <br></div></div><br><br>  <b>Models</b> <br><br>  Models are used generated through gii with almost no changes.  I don‚Äôt think it‚Äôs worth giving them all here (see github), except for the one used to search through Sphinx. <br><br><div class="spoiler">  <b class="spoiler_title">TorrentSearch.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">common</span></span>\<span class="hljs-title"><span class="hljs-title">models</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Yii</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">helpers</span></span>\<span class="hljs-title"><span class="hljs-title">ArrayHelper</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">sphinx</span></span>\<span class="hljs-title"><span class="hljs-title">ActiveDataProvider</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   use yii\sphinx\ActiveRecord; //   yii2-sphinx /** * This is the model class for index "torrentz". * * @property integer $id * @property string $size * @property string $datetime * @property integer $id_attr * @property integer $size_attr * @property integer $datetime_attr * @property string $topic_name * @property string $topic_id * @property integer $topic_id_attr * @property integer $category_attr * @property string $category_id * @property string $name_attr * @property integer $forum_name_id_attr */ class TorrentSearch extends ActiveRecord { /** * @inheritdoc */ public static function indexName() { return '{{%torrentz}}'; } /** * @inheritdoc */ public function rules() { return [ [['id'], 'required'], [['id'], 'unique'], [['id'], 'integer'], [['id_attr'], 'integer'], [['topic_name', 'topic_id', 'category_id'], 'string'], [['name_attr'], 'string'], [['id', 'size_attr', 'datetime_attr', 'id_attr', 'topic_id_attr', 'category_attr', 'forum_name_id_attr'], 'integer'], [['size', 'datetime', 'topic_name', 'name_attr'], 'string'] ]; } /** * @inheritdoc */ public function attributeLabels() { return [ 'id_attr' =&gt; Yii::t('app', 'ID'), 'name_attr' =&gt; Yii::t('app', 'Topic Name'), 'id' =&gt; Yii::t('app', 'ID'), 'size' =&gt; Yii::t('app', 'Size'), 'datetime' =&gt; Yii::t('app', 'Datetime'), 'topic_name' =&gt; Yii::t('app', 'Topic Name'), 'size_attr' =&gt; Yii::t('app', 'Size'), 'datetime_attr' =&gt; Yii::t('app', 'Torrent Registered Date'), 'category_attr' =&gt; Yii::t('app', 'Category Name'), 'forum_name_id_attr' =&gt; Yii::t('app', 'Forum Name'), ]; } /** *    * * @param $params * @return ActiveDataProvider */ public function search($params) { $query = self::find(); $dataProvider = new ActiveDataProvider([ 'query' =&gt; $query, ]); $this-&gt;load($params); $query-&gt;match($this-&gt;name_attr); $query-&gt;filterWhere(['category_attr' =&gt; $this-&gt;category_attr]); $query-&gt;andFilterWhere(['forum_name_id_attr' =&gt; $this-&gt;forum_name_id_attr]); $dataProvider-&gt;sort = [ 'defaultOrder' =&gt; ['category_attr' =&gt; SORT_ASC, 'datetime_attr' =&gt; SORT_DESC], ]; return $dataProvider; } /** *    (forum_name)    * * @param null|integer $id * @return array */ public static function subsForCat($id = null) { $query = Subcategory::find(); if ($id != null &amp;&amp; ($cat = Categories::findOne($id)) !== null) { $subcatsArr = array_keys(self::find() -&gt;where(['category_attr' =&gt; $id]) -&gt;groupBy('forum_name_id_attr') -&gt;indexBy('forum_name_id_attr') -&gt;limit(10000) -&gt;asArray() -&gt;all()); $query-&gt;andWhere(['id' =&gt; $subcatsArr]); } return ArrayHelper::map($query-&gt;asArray()-&gt;all(), 'id', 'forum_name'); } /** *     ,    * * @param null|integer $id * @return array */ public static function catForSubs($id = null) { $query = Categories::find(); if($id != null &amp;&amp; ($subCat = Subcategory::findOne($id)) !== null) { /** @var TorrentSearch $category */ $category = self::find()-&gt;where(['forum_name_id_attr' =&gt; $id])-&gt;one(); $query-&gt;andWhere(['id' =&gt; $category-&gt;category_attr]); } return ArrayHelper::map($query-&gt;asArray()-&gt;all(), 'id', 'category_name'); } }</span></span></code> </pre><br></div></div><br><br>  <b>Import</b> <br><br>  The main idea is that we first import categories (the category_info.csv file), then distributions (category _ *. Csv files), in the course of importing distributions we take subcategories from them and write them into a separate model. <br><br><div class="spoiler">  <b class="spoiler_title">Import controller</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">console</span></span>\<span class="hljs-title"><span class="hljs-title">controllers</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">common</span></span>\<span class="hljs-title"><span class="hljs-title">models</span></span>\<span class="hljs-title"><span class="hljs-title">Categories</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">common</span></span>\<span class="hljs-title"><span class="hljs-title">models</span></span>\<span class="hljs-title"><span class="hljs-title">Subcategory</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">common</span></span>\<span class="hljs-title"><span class="hljs-title">models</span></span>\<span class="hljs-title"><span class="hljs-title">Torrents</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Yii</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">console</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">helpers</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">helpers</span></span>\<span class="hljs-title"><span class="hljs-title">VarDumper</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *      csv- * * Class ImportController * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@package</span></span></span><span class="hljs-comment"> console\controllers */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImportController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $color = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *  * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> int */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionIndex</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;stdout(<span class="hljs-string"><span class="hljs-string">"Default: import/import [file_path]. \nDefault file path is frontend/runtime/csv\n\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Controller::EXIT_CODE_NORMAL; } <span class="hljs-comment"><span class="hljs-comment">/** *    * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $path * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> int */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionImport</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($path = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'frontend/runtime/csv'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ $fullPath = Yii::getAlias(<span class="hljs-string"><span class="hljs-string">'@'</span></span> . $path); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!is_dir($fullPath)) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;stderr(<span class="hljs-string"><span class="hljs-string">"Path '{$fullPath}' not found\n"</span></span>, Console::FG_RED); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Controller::EXIT_CODE_ERROR; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(is_file($fullPath . DIRECTORY_SEPARATOR . <span class="hljs-string"><span class="hljs-string">'category_info.csv'</span></span>)) $categories = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;importCategories($fullPath); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;stderr(<span class="hljs-string"><span class="hljs-string">"File 'category_info.csv' not found\n"</span></span>, Console::FG_RED); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Controller::EXIT_CODE_ERROR; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($categories === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;stderr(<span class="hljs-string"><span class="hljs-string">"Categories is NOT imported"</span></span>, Console::FG_RED); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Controller::EXIT_CODE_ERROR; } <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> Categories $cat */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($categories <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $cat) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!is_file($fullPath . DIRECTORY_SEPARATOR . $cat-&gt;file_name)) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;importTorrents($cat, $path); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Controller::EXIT_CODE_NORMAL; } <span class="hljs-comment"><span class="hljs-comment">/** *   * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> \common\models\Categories $cat * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $path */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">importTorrents</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Categories $cat, $path)</span></span></span><span class="hljs-function"> </span></span>{ $filePath = Yii::getAlias(<span class="hljs-string"><span class="hljs-string">'@'</span></span> . $path . DIRECTORY_SEPARATOR . $cat-&gt;file_name); $row = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($handle = fopen($filePath, <span class="hljs-string"><span class="hljs-string">"r"</span></span>)) !== <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (($data = fgetcsv($handle, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">";"</span></span>)) !== <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) { $row++; $model = Torrents::findOne([<span class="hljs-string"><span class="hljs-string">'forum_id'</span></span> =&gt; $data[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-string"><span class="hljs-string">'topic_id'</span></span> =&gt; $data[<span class="hljs-number"><span class="hljs-number">2</span></span>]]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($model !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Subcategory $subcat = $this-&gt;importSubcategory($data[1]); if(!($subcat instanceof Subcategory)) { $this-&gt;stderr("Error! Unable to import subcategory!"); $this-&gt;stdout("\n"); continue; } $this-&gt;stdout("Row {$row} of category \"{$cat-&gt;category_name}\" "); $this-&gt;stdout("and subcategory \"{$subcat-&gt;forum_name}\": \n"); if($model === null) { if(isset($data[4])) $data[4] = str_replace('\\', '/', $data[4]); //   ,   ,       //          , //    ,    if(!isset($data[0]) || !isset($data[1]) || !isset($data[2]) || !isset($data[3]) || !isset($data[4]) || !isset($data[5]) || !isset($data[6])) { $this-&gt;stderr("Error! Undefined Field!\n", Console::FG_RED); \yii\helpers\VarDumper::dump($data); $this-&gt;stdout("\n"); continue; } $model = new Torrents([ 'forum_id' =&gt; $data[0], 'forum_name' =&gt; $data[1], 'topic_id' =&gt; $data[2], 'hash' =&gt; $data[3], 'topic_name' =&gt; $data[4], 'size' =&gt; $data[5], 'datetime' =&gt; strtotime($data[6]), 'category_id' =&gt; $cat-&gt;id, ]); } $model-&gt;forum_name_id = $subcat-&gt;id; if($model-&gt;save()) { $this-&gt;stdout("Torrent \t"); $this-&gt;stdout($model-&gt;topic_name, Console::FG_YELLOW); $this-&gt;stdout(" added\n"); } $this-&gt;stdout("\n"); } } } /** *   (forum_name) * * @param string $subcat_name * @return bool|Subcategory */ private function importSubcategory($subcat_name) { $model = Subcategory::findOne(['forum_name' =&gt; $subcat_name]); if($model === null) $model = new Subcategory(['forum_name' =&gt; $subcat_name]); if($model-&gt;save()) return $model; else { VarDumper::dump($model-&gt;errors); } return false; } /** *   * * @param $path * @return array|\yii\db\ActiveRecord[] */ private function importCategories($path) { $file = $path . DIRECTORY_SEPARATOR . 'category_info.csv'; $row = 1; if (($handle = fopen($file, "r")) !== FALSE) { while (($data = fgetcsv($handle, 0, ";")) !== FALSE) { $row++; $this-&gt;stdout("Row " . $row . ":\n"); $model = Categories::findOne($data[0]); if($model === null) { $model = new Categories([ 'id' =&gt; $data[0], 'category_name' =&gt; $data[1], 'file_name' =&gt; $data[2] ]); } if($model-&gt;save()) $this-&gt;stdout("Category {$model-&gt;id} with name '{$model-&gt;category_name}' imported\n"); $this-&gt;stdout("\n"); } } else return false; return Categories::find()-&gt;all(); } }</span></span></code> </pre><br></div></div><br><br>  Import is better to run in screen, so that you can close the console.  You can, of course, redirect the output to a file and read later, at your leisure. <br><br>  <b>Sphinx</b> <br><br>  For debian - apt-get install sphinxsearch <br>  I have installed Sphinx version 2.2.9 <br><br><div class="spoiler">  <b class="spoiler_title">/etc/sphinxsearch/sphinx.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">source</span></span> torrentz { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> = mysql sql_host = localhost sql_user = webmaster <span class="hljs-comment"><span class="hljs-comment">#   MySQL sql_pass = webmaster #   MySQL sql_db = rutracker #      sql_port = 3306 sql_query_pre = SET NAMES utf8 sql_query_pre = SET CHARACTER SET utf8 sql_query = SELECT id, id AS id_attr, \ size, size AS size_attr, \ datetime, datetime as datetime_attr, \ topic_name, topic_name AS name_attr, \ topic_id, topic_id AS topic_id_attr, \ category_id, category_id AS category_attr, \ forum_name_id, forum_name_id AS forum_name_id_attr \ FROM torrents sql_attr_string = name_attr sql_attr_uint = id_attr sql_attr_uint = size_attr sql_attr_uint = datetime_attr sql_attr_uint = topic_id_attr sql_attr_uint = category_attr sql_attr_uint = forum_name_id_attr } index torrentz { source = torrentz path = /var/lib/sphinxsearch/data/ docinfo = extern morphology = stem_enru min_word_len = 2 charset_table = 0..9, A..Z-&gt;a..z, _, a..z, U+410..U+42C-&gt;U+430..U+44C, U+42E..U+42F-&gt;U+44E..U+44F, U+430..U+44C, U+44E..U+44F, U+0401-&gt;U+0435, U+0451-&gt;U+0435, U+042D-&gt;U+0435, U+044D-&gt;U+0435 min_infix_len = 2 } indexer { mem_limit = 512M } searchd { listen = 0.0.0.0:9306:mysql41 log = /var/log/sphinxsearch/searchd.log query_log = /var/log/sphinxsearch/query.log read_timeout = 5 max_children = 30 pid_file = /var/run/sphinxsearch/searchd.pid }</span></span></code> </pre><br></div></div><br><br>  Indexing is started by the command <br><br><pre> <code class="bash hljs">indexer --config /etc/sphinxsearch/sphinx.conf --all <span class="hljs-comment"><span class="hljs-comment">#   </span></span></code> </pre><br><pre> <code class="bash hljs">indexer --config /etc/sphinxsearch/sphinx.conf --rotate --all <span class="hljs-comment"><span class="hljs-comment">#    </span></span></code> </pre><br><br>  That's all. <br>  In the web interface, the standard Yii2 GridView, search through standard filters. <br><br>  <b>What would be worth completing</b> <br><br>  You can develop it endlessly, if you want.  First of all, you can make a selective import of categories / subcategories, a more correct dependent list of categories / subcategories in GridView, API for remote queries and then in general everything that comes to mind. <br><br>  Maybe I'll do it at my leisure. <br><br>  PS I welcome comments and additions on the code, but please do not bother to write ‚Äúphp sucks, write on ... &lt;insert any other language&gt;‚Äù - we have already discussed all this for a long time. <br>  Also, comments / additions on sphinx config are welcome, and I want to remind once again - I saw it for the first time in my life and used it only because the author of the original topic wrote about it.  Well, for the experiment, of course, but what about :) </div><p>Source: <a href="https://habr.com/ru/post/274449/">https://habr.com/ru/post/274449/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274437/index.html">Comparison of the transition process of Angular2 applications to version beta.0 in Dart and TypeScript languages</a></li>
<li><a href="../274439/index.html">Php Inspections (EA Extended): choose a strategy for 2016</a></li>
<li><a href="../274443/index.html">Microsoft will notify users of state-sponsored cyber attacks</a></li>
<li><a href="../274445/index.html">Kill switch for OpenVPN based on iptables</a></li>
<li><a href="../274447/index.html">Emsisoft Specialists Discovered Javascript Extortionist</a></li>
<li><a href="../274451/index.html">Expansion of sections without data loss</a></li>
<li><a href="../274453/index.html">Black Hat USA 2015: the full story of the hacking of the very Jeep</a></li>
<li><a href="../274455/index.html">Creating a function on Rust that accepts a String or & str</a></li>
<li><a href="../274457/index.html">Defending Revel from CSRF attacks</a></li>
<li><a href="../274461/index.html">The tale of the compressor, which can be called, but I do not remember how</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>