<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>State Machines and Web Application Development</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The year 2018 has arrived, many wonderful ways to create applications have been found, but countless armies of front-end developers are still fighting...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>State Machines and Web Application Development</h1><div class="post__text post__text-html js-mediator-article">  The year 2018 has arrived, many wonderful ways to create applications have been found, but countless armies of front-end developers are still fighting for the simplicity and flexibility of web projects.  Month after month they spend trying to achieve the cherished goal: to find a software architecture that is free from errors and helps them to do their work quickly and efficiently.  I am one of these developers.  I managed to find something interesting that could give us a chance to win. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/393/be6/c7b/393be6c7b3068eb73a7d530c248c7db9.png"></div><br>  Tools like <a href="https://facebook.github.io/react/">React</a> and <a href="http://redux.js.org/">Redux</a> allowed web development to take a big step in the right direction.  However, they alone are not enough to create large-scale applications.  It seems that the situation in the development of client parts of web applications can significantly improve the use of state machines.  About them, and will be discussed in this material.  By the way, you may have already built several such machines, but for the time being you don‚Äôt know about it. <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Familiarity with state machines</font> </h2><br>  The state machine is a mathematical model of computation.  This is an abstract concept, according to which a machine can have different states, but, at some point in time, it can only be in one of them.  I guess the most famous state <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B0%25D1%2588%25D0%25B8%25D0%25BD%25D0%25B0_%25D0%25A2%25D1%258C%25D1%258E%25D1%2580%25D0%25B8%25D0%25BD%25D0%25B3%25D0%25B0">machine is the Turing machine</a> .  This is a machine with an unlimited number of states, which means that it can have an infinite number of states.  The Turing machine does not very well meet the needs of modern interface design, since in most cases we have a finite number of states.  That is why we are better suited to machines with a limited number of states, or, as they are often called, finite automata.  This is the <a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D0%25B2%25D1%2582%25D0%25BE%25D0%25BC%25D0%25B0%25D1%2582_%25D0%259C%25D0%25B8%25D0%25BB%25D0%25B8">Mile</a> <a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D0%25B2%25D1%2582%25D0%25BE%25D0%25BC%25D0%25B0%25D1%2582_%25D0%259C%25D1%2583%25D1%2580%25D0%25B0">machine gun</a> and the <a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D0%25B2%25D1%2582%25D0%25BE%25D0%25BC%25D0%25B0%25D1%2582_%25D0%259C%25D1%2583%25D1%2580%25D0%25B0">Moore machine gun</a> . <br><br>  The difference between the two is that Moore‚Äôs automaton changes its state based only on its previous state.  However, we have a lot of external factors, such as user actions and processes occurring in the network, which means that Moore's machine gun will not suit us.  What we are looking for is very similar to the Mile machine gun.  This state machine has an initial state, after which it transitions to new states based on the input data and its current state. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      One of the easiest ways to illustrate how a state machine works is to consider it through an analogy with a turnstile.  It has a limited set of states: it can be either closed or open.  Our turnstile is blocking the entrance to a certain area.  Let him have a drum with three bars and a mechanism for receiving money.  You can pass through the closed turnstile by dropping a coin into the coin acceptor, which puts the device in the open state, and pushing the bar in order to pass through the turnstile.  After having passed through the turnstile, it closes again.  Here is a simple diagram that shows us these states, as well as possible input signals and state transitions. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/393/be6/c7b/393be6c7b3068eb73a7d530c248c7db9.png"></div><br>  The initial state of the turnstile is ‚Äúclosed‚Äù (locked).  No matter how many times we push his bar, he will remain closed.  However, if we drop a coin into it, the turnstile will go to the ‚Äúopen‚Äù state (un-locked).  At this point, another coin will not change anything, since the turnstile will still be in the open state.  On the other hand, now the push of the turnstile bar makes sense, and we can go through it.  This action, in addition, will bring our state machine to its initial state "closed". <br><br>  If you need to implement a single function that controls the turnstile, we probably should stop at two arguments: this is the current state and the action.  If you are using Redux, you may be familiar with this.  This is similar to the well-known functions of <a href="http://redux.js.org/docs/basics/Reducers.html">reducers</a> , where we get the current state, and, based on the payload of the action, decide what the next state will be.  A reduer is a transition in the context of a state machine.  In fact, any application that has a state that we can somehow change can be called a state machine.  The point is simply that all this, again and again, is implemented manually. <br><br><h2>  <font color="#3AC1EF">What are the strengths of state machines?</font> </h2><br>  At work, we use Redux and it suits us perfectly.  However, I began to notice some things that I did not like.  Just because I don‚Äôt like something, doesn‚Äôt mean that it doesn‚Äôt work.  The point is more that all this adds complexity to the project and forces me to write more code.  Once I started a third-party project, where I had room for experimentation, and I decided to rethink our approaches to development on React and Redux.  I started taking notes on what was bothering me, and realized that the abstraction of the state machine would most likely solve some of these problems.  Let's get down to business and see how to implement the state machine in JavaScript. <br><br>  We will solve a simple problem.  We need to get data from the server API and show it to the user.  The very first step is to understand how, when thinking about a task, to think in terms of states, not transitions.  Before we get to the state machine, I want to talk about how, at a high level, what we want to create looks like: <br><br><ul><li> The <code> </code> button is displayed on the page. <br></li><li>  The user clicks this button. <br></li><li>  The system makes a request to the server. <br></li><li>  The data is loaded and parsed. <br></li><li>  Data is displayed on the page. <br></li><li>  If an error occurs, a corresponding message is displayed and the <code> </code> button appears on the page again, which allows the user to start the process of receiving data from the server again. <br></li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4f2/f5b/35d/4f2f5b35d2c9df879d1d998009fc2636.png"></div><br>  Now, analyzing the problem, we think linearly, and, strictly speaking, we are trying to cover all possible paths to the final result.  One step leads to another, the next leads to another, and so on.  In code, this can be expressed as branch operators.  Let's conduct a mental experiment with a program that is built on the basis of user and system actions. <br><br>  How about a situation in which a user clicks a button twice?  What happens if a user clicks a button while we wait for a response from the server?  How will the system behave if the request is successful, but the data is damaged? <br>  To handle such situations, we will probably need various flags that signal what is happening.  The presence of flags means an increase in the number of <code>if</code> , and, in more complex applications, an increase in the number of conflicts. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ea/4d6/430/8ea4d64309cf234370cc370b8735d0df.png"></div><br>  This is due to the fact that we think transitions.  We focus on how exactly the changes occur in the program, and on the order in which they occur.  If, instead, focus on the various states of the application, everything will be much simpler.  How many states do we have?  What is their input?  We use the same example: <br><br><ul><li>  <code>idle</code> state (idle).  In this state, we display the <code> </code> button and wait for user actions.  Here are the possible actions: <br></li><li>  <code>fetching</code> state (data retrieval).  The request has been sent to the server and we are awaiting its completion.  Here are the possible actions: <br></li><li>  The <code>error</code> state.  We display an error message and show the <code> </code> button.  This state takes one action: <br></li></ul><br>  Here we described roughly the same process, but now using the states and input data. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c0e/63e/31c/c0e63e31cb60acfda8b2cb6b0341e4e1.png"></div><br>  This simplified the logic and made it more predictable.  In addition, it solved some of the problems mentioned above.  Please note that when the machine is in <code>fetching</code> state, we do not accept the events associated with clicking the button.  Therefore, even if the user clicks a button, nothing will happen, as the machine is not configured to respond to this action when it is in the <code>fetching</code> state.  This approach allows you to automatically eliminate unexpected branching logic code. <br><br>  This means that we will have to cover less code when testing.  In addition, some types of testing, such as integration testing, can be automated.  Think about the fact that with such an approach we would have a really clear understanding of what our application does, and we could create a script that traverses the predefined states and transitions and generates assertions.  These statements can prove that we have reached each of the possible states or implemented a specific sequence of transitions. <br><br>  In fact, it is easier to write out all possible states than to write out all possible transitions, since we know which states we need or which states we have.  By the way, in most cases, states would describe the logic of the functioning of our application.  But if we talk about transitions, their meaning is very often unknown at the beginning of work.  Errors in the programs are the results of the fact that actions are performed when the application is in a state that is not designed for these actions.  In addition, even if the application is in the appropriate state, the action can be performed at the wrong time.  Similar actions lead our application to a state about which we do not know, and this puts the program out of action or leads to the fact that it behaves incorrectly.  Of course, we do not need it.  State machines are good defenses against such problems.  They protect us from reaching unknown states, as we set boundaries for what and when it can happen, without explicitly indicating how it can happen.  The concept of a state machine fits perfectly with a unidirectional data stream.  Together they reduce the complexity of the code and give clear answers to questions about how the system got into one or another state. <br><br><h2>  <font color="#3AC1EF">Creating a state machine using JavaScript</font> </h2><br>  Stop talking - it's time to program.  We will use the same example.  Based on the above list, let's start with the following code: <br><br><pre> <code class="hljs actionscript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> machine = { <span class="hljs-string"><span class="hljs-string">'idle'</span></span>: {   click: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... } }, <span class="hljs-string"><span class="hljs-string">'fetching'</span></span>: {   success: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... },   failure: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... } }, <span class="hljs-string"><span class="hljs-string">'error'</span></span>: {   <span class="hljs-string"><span class="hljs-string">'retry'</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... } } }</code> </pre> <br>  States are represented by objects, possible input signals of states are by methods of objects.  However, the initial state is not here.  Modify the above code, bringing it to the following form: <br><br><pre> <code class="hljs actionscript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> machine = { state: <span class="hljs-string"><span class="hljs-string">'idle'</span></span>, transitions: {   <span class="hljs-string"><span class="hljs-string">'idle'</span></span>: {     click: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... }   },   <span class="hljs-string"><span class="hljs-string">'fetching'</span></span>: {     success: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... },     failure: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... }   },   <span class="hljs-string"><span class="hljs-string">'error'</span></span>: {     <span class="hljs-string"><span class="hljs-string">'retry'</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... }   } } }</code> </pre> <br>  After we have identified all the states that have meaning, we are ready to send them input signals and change the state of the system.  We will do this using the following two auxiliary methods: <br><br><pre> <code class="hljs markdown">const machine = { dispatch(actionName, ...payload) {   const actions = this.transitions[<span class="hljs-string"><span class="hljs-string">this.state</span></span>];   const action = this.transitions[<span class="hljs-string"><span class="hljs-string">this.state</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">actionName</span></span>];   if (action) {     action.apply(machine, ...payload);   } }, changeStateTo(newState) {   this.state = newState; }, ... }</code> </pre> <br>  The <code>dispatch</code> function checks whether there is an action with the specified name among the transitions of the current state.  If so, she triggers this action, passing it the data passed to her when she calls.  In addition, the <code>action</code> handler is called with the <code>machine</code> as the context, so we can dispatch another action with <code>this.dispatch(&lt;action&gt;)</code> or change the state with <code>this.changeStateTo(&lt;new state&gt;)</code> . <br><br>  Following the user's path from our example, the first action we need to dispatch is <code>click</code> .  Here is the handler for this action: <br><br><pre> <code class="hljs kotlin">transitions: { <span class="hljs-string"><span class="hljs-string">'idle'</span></span>: {   click: function () {     <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.changeStateTo(<span class="hljs-string"><span class="hljs-string">'fetching'</span></span>);     service.getData().then(       <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> =&gt; {         <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {           <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dispatch(<span class="hljs-string"><span class="hljs-string">'success'</span></span>, JSON.parse(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>));         } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error) {           <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dispatch(<span class="hljs-string"><span class="hljs-string">'failure'</span></span>, error)         }       },       error =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dispatch(<span class="hljs-string"><span class="hljs-string">'failure'</span></span>, error)     );   } }, ... } machine.dispatch(<span class="hljs-string"><span class="hljs-string">'click'</span></span>);</code> </pre> <br>  First, we change the state of the machine to <code>fetching</code> .  Then run the request to the server.  Suppose we have a service with a <code>getData</code> method that returns a promise.  After this promise is resolved and the data is successfully parsed, we dispatch the <code>succes</code> event, otherwise the <code>failure</code> . <br><br>  As long as everything goes as it should.  Next, we need to implement the <code>success</code> and <code>failure</code> actions and describe the <code>fetching</code> status input: <br><br><pre> <code class="hljs lua">transitions: { <span class="hljs-string"><span class="hljs-string">'idle'</span></span>: { ... }, <span class="hljs-string"><span class="hljs-string">'fetching'</span></span>: {   success: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data)</span></span></span></span> {     //       this.changeStateTo(<span class="hljs-string"><span class="hljs-string">'idle'</span></span>);   },   failure: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> {     this.changeStateTo(<span class="hljs-string"><span class="hljs-string">'error'</span></span>);   } }, ... }</code> </pre> <br>  Notice how we saved ourselves the need to think about the previous process.  We do not care about user clicks on a button, or what happens with an HTTP request.  We know that the application is in <code>fetching</code> state, and we expect only these two actions to appear.  This is a bit like creating new application mechanisms that work in isolation. <br><br>  The last thing we have to figure out is the <code>error</code> state.  It will be very good if we create a code here to implement a retry, as a result, the application can recover from the occurrence of the error. <br><br><pre> <code class="hljs actionscript">transitions: { <span class="hljs-string"><span class="hljs-string">'error'</span></span>: {   retry: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{     <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.changeStateTo(<span class="hljs-string"><span class="hljs-string">'idle'</span></span>);     <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dispatch(<span class="hljs-string"><span class="hljs-string">'click'</span></span>);   } } }</code> </pre> <br>  Here you have to copy the code that is already written in the <code>click</code> handler.  In order to avoid this, we either need to declare the handler as a function accessible to both actions, or first go to the <code>idle</code> state and then dispatch the <code>click</code> action independently. <br><br>  A full example of a running state machine can be found in <a href="https://codepen.io/krasimir/pen/boGvKj%3Feditors%3D0010">my CodePen</a> project. <br><br><h2>  <font color="#3AC1EF">State Machine Management with Library</font> </h2><br>  The state machine template works regardless of whether we use React, Vue, or Angular.  As we saw in the previous section, you can implement the state machine on pure JS without much difficulty.  However, if you entrust this to a specialized library, this can add more flexibility to the project.  Among the examples of good libraries for implementing state machines are <a href="http://machina-js.org/">Machina.js</a> and <a href="https://github.com/davidkpiano/xstate">XState</a> .  In this article, however, we will talk about <a href="https://github.com/krasimir/stent">Stent</a> - my Redux-like library, which implements the concept of finite automata. <br><br>  Stent is the implementation of the state machine container.  This library follows some ideas from the Redux and Redux-Saga projects, but gives, in my opinion, easier-to-use and less constrained capabilities.  It is developed using an <a href="http://krasimirtsonev.com/blog/article/readme-driven-development">approach</a> based on the fact that they first write the documentation for the project, and then the code.  Following this approach, I spent weeks only on designing API.  Since I wrote the library myself, I had a chance to correct the problems I encountered using the Redux and Flux architectures. <br><br><h2>  <font color="#3AC1EF">Creating state machines in Stent</font> </h2><br>  In most cases, the application performs many functions.  As a result, we cannot do just one car.  Therefore, Stent allows you to create as many machines as you need: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Machine } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'stent'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> machineA = Machine.create(<span class="hljs-string"><span class="hljs-string">'A'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">state</span></span>: ..., <span class="hljs-attr"><span class="hljs-attr">transitions</span></span>: ... }); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> machineB = Machine.create(<span class="hljs-string"><span class="hljs-string">'B'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">state</span></span>: ..., <span class="hljs-attr"><span class="hljs-attr">transitions</span></span>: ... });</code> </pre> <br>  Later we can access these machines using the <code>Machine.get</code> method: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> machineA = Machine.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">'A'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> machineB = Machine.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">'B'</span></span>);</code> </pre> <br><h2>  <font color="#3AC1EF">Connecting machines to rendering logic</font> </h2><br>  In my case, rendering is done using React tools, but we can use any other library.  It all comes down to calling a callback in which we initiate rendering.  One of the first features of the library I created was the <code>connect</code> function: <br><br><pre> <code class="hljs coffeescript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { connect } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'stent/lib/helpers'</span></span>; Machine.create(<span class="hljs-string"><span class="hljs-string">'MachineA'</span></span>, ...); Machine.create(<span class="hljs-string"><span class="hljs-string">'MachineB'</span></span>, ...); connect() .with(<span class="hljs-string"><span class="hljs-string">'MachineA'</span></span>, <span class="hljs-string"><span class="hljs-string">'MachineB'</span></span>) .map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MachineA, MachineB)</span></span></span><span class="hljs-function"> =&gt;</span></span> {   ...      });</code> </pre> <br>  We inform the system about which machines we want to work with, indicating their names.  The callback that we pass to the <code>map</code> method is immediately called, this is done once.  After that, it is called every time the state of one of the machines changes.  This is where we call the render function.  In this place we have direct access to the connected machines, so we can get the current state of the machines and their methods.  In the library, in addition, there is a method <code>mapOnce</code> , used to work with callbacks that need to be called only once, and <code>mapSilent</code> , in order to skip this initial one-time execution of a callback. <br><br>  For convenience, auxiliary functions are exported based on integration with React.  This is very similar to the Redux <a href="">connect (mapStateToProps)</a> construction. <br><br><pre> <code class="hljs scala"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-type"><span class="hljs-type">React</span></span> from <span class="hljs-symbol"><span class="hljs-symbol">'reac</span></span>t'; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { connect } from <span class="hljs-symbol"><span class="hljs-symbol">'stent</span></span>/lib/react'; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TodoList</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">React</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{ render() {   const { isIdle, todos } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props;   ... } } <span class="hljs-comment"><span class="hljs-comment">// MachineA  MachineB -  ,  //    Machine.create export default connect(TodoList) .with('MachineA', 'MachineB') .map((MachineA, MachineB) =&gt; {   isIdle: MachineA.isIdle,   todos: MachineB.state.todos });</span></span></code> </pre> <br>  Stent executes a callback and expects to receive an object.  Namely, the object that was sent as <code>props</code> the React component. <br><br><h2>  <font color="#3AC1EF">What is the state in the context of Stent?</font> </h2><br>  Until now, states have been simple strings.  Unfortunately, in the real world one has to store in a state something more than the usual line.  That is why the Stent state is an object within which there are properties.  The only reserved property is <code>name</code> .  All the rest is application specific data.  For example: <br><br><pre> <code class="hljs css">{ <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: <span class="hljs-string"><span class="hljs-string">'idle'</span></span> } { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: <span class="hljs-string"><span class="hljs-string">'fetching'</span></span>, todos: [] } { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: <span class="hljs-string"><span class="hljs-string">'forward'</span></span>, speed: <span class="hljs-number"><span class="hljs-number">120</span></span>, gear: <span class="hljs-number"><span class="hljs-number">4</span></span> }</code> </pre> <br>  My experience with Stent shows that if the state object becomes too large, then we may need another state machine that could handle these additional properties.  Identifying the various states takes some time, but I believe that this is a big step forward in writing applications that are easier to manage.  It is something like an attempt to plan ahead for the behavior of the system and prepare the space for future actions. <br><br><h2>  <font color="#3AC1EF">Work with state machine</font> </h2><br>  Practically the same as in the example given at the beginning of the material, we, when working with Stent, need to specify the possible (final) states of the machine and describe the possible input signals: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Machine } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'stent'</span></span>; const machine = Machine.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(<span class="hljs-string"><span class="hljs-string">'sprinter'</span></span>, { state: { <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'idle'</span></span> }, //   transitions: {   <span class="hljs-string"><span class="hljs-string">'idle'</span></span>: {     <span class="hljs-string"><span class="hljs-string">'run please'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () {       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'running'</span></span> };     }   },   <span class="hljs-string"><span class="hljs-string">'running'</span></span>: {     <span class="hljs-string"><span class="hljs-string">'stop now'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> () {       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'idle'</span></span> };     }   } } });</code> </pre> <br>    , <code>idle</code> ,    <code>run</code> .  ,      <code>running</code> ,    <code>stop</code> ,       <code>idle</code> . <br><br> , ,    <code>dispatch</code>  <code>changeStateTo</code>  ,  . Stent    ,     ,  ,      .  ,    <code>transitions</code> , Stent  : <br><br><ul><li>     ,      . ,   <code>idle</code>     <code>isIdle()</code> ,    <code>running</code> ‚Äî    <code>isRunning()</code> . <br></li><li>     : <code>runPlease()</code>  <code>stopNow()</code> . <br></li></ul><br>        : <br><br><pre> <code class="hljs ruby">machine.isIdle(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   machine.isRunning(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   machine.runPlease(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   machine.stopNow(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  </code> </pre> <br>        <code>connect</code> ,      .         ,     . -     ,  <code>connect</code> ,       .      . <br><br><h2> <font color="#3AC1EF">    </font> </h2><br> ,      ‚Äî  .  ‚Äî ,       ,             .   ,     ,    Redux ‚Äî     <a href="http://redux.js.org/docs/basics/Reducers.html">-</a> .  ,   Stent ‚Äî    .      ,   ,       .      ( <code>undefined</code> ),     . <br><br><pre> <code class="hljs actionscript">transitions: { <span class="hljs-string"><span class="hljs-string">'fetching'</span></span>: {   <span class="hljs-string"><span class="hljs-string">'success'</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(state, payload)</span></span></span><span class="hljs-function"> </span></span>{     <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> todos = [ ...state.todos, payload ];     <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { name: <span class="hljs-string"><span class="hljs-string">'idle'</span></span>, todos };   } } }</code> </pre> <br> ,       .           <code>fetching</code> .      ,   <code>success</code> : <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">machine</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.success</span></span>({ <span class="hljs-attribute"><span class="hljs-attribute">label</span></span>: <span class="hljs-string"><span class="hljs-string">'...'</span></span> });</code> </pre> <br>      <code>idle</code>        <code>todos</code> .    ,    .      ‚Äî     ,    . <br><br><pre> <code class="hljs cs">transitions: { <span class="hljs-string"><span class="hljs-string">'idle'</span></span>: {   <span class="hljs-string"><span class="hljs-string">'run'</span></span>: <span class="hljs-string"><span class="hljs-string">'running'</span></span> } }</code> </pre> <br>      <code>{ name: 'idle' }</code>   <code>{ name: 'running' }</code>    <code>run()</code> .   ,      ,        . ,       -,        .       : <br><br><pre> <code class="hljs pgsql">transitions: { <span class="hljs-string"><span class="hljs-string">'editing'</span></span>: {   <span class="hljs-string"><span class="hljs-string">'delete all todos'</span></span>: { <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'idle'</span></span>, todos: [] } } }</code> </pre> <br>       <code>editing</code>  <code>idle</code>    <code>deleteAllTodos</code> . <br><br>    -,      ‚Äî  -.       <a href="https://redux-saga.js.org/">Redux-Saga</a> ,   : <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { call } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'stent/lib/helpers'</span></span>; Machine.create(<span class="hljs-string"><span class="hljs-string">'app'</span></span>, { <span class="hljs-string"><span class="hljs-string">'idle'</span></span>: {   <span class="hljs-string"><span class="hljs-string">'fetch data'</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> * (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state, payload</span></span></span><span class="hljs-function">) </span></span>{     <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'fetching'</span></span> }     <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {       <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> data = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> call(requestToBackend, <span class="hljs-string"><span class="hljs-string">'/api/todos/'</span></span>, <span class="hljs-string"><span class="hljs-string">'POST'</span></span>);       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'idle'</span></span>, data };     } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error) {       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'error'</span></span>, error };     }   } } });</code> </pre> <br>        ,       . ,   JavaScript ‚Äî   .       ,        . <br><br><h2> <font color="#3AC1EF">  </font> </h2><br>      <a href="https://redux-saga.js.org/">Redux-Saga</a> ,  ,         .      ‚Äî     <a href="https://addyosmani.com/resources/essentialjsdesignpatterns/book/">command</a> ().       ,          . <br><br>   ‚Äî     ,   ,     ,    .       <a href="http://formidable.com/blog/category/redux-saga/"> </a>  ,    .         Stent.    ,    ,   ,       .    ,    . <br><br>        : <br><br><ul><li>   ( )    . <br></li><li>   <code>call</code> (   ,   ,     -).   , ,  ,  : ¬´  ,     , .      ‚Äî   ¬ª. <br></li><li>   <code>wait</code> (  ,   ).             . <br></li></ul><br>  ,     : <br><br><pre> <code class="hljs lua">const fireHTTPRequest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new Promise((resolve, reject) =&gt; {   // ... }); } ... transitions: { <span class="hljs-string"><span class="hljs-string">'idle'</span></span>: {   <span class="hljs-string"><span class="hljs-string">'fetch data'</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> * </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {     <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span> <span class="hljs-string"><span class="hljs-string">'fetching'</span></span>; //    { name: <span class="hljs-string"><span class="hljs-string">'fetching'</span></span> }     <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span> { name: <span class="hljs-string"><span class="hljs-string">'fetching'</span></span> }; //   ,        //       //  getTheData  checkForErrors     const [ data, isError ] = <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span> wait(<span class="hljs-string"><span class="hljs-string">'get the data'</span></span>, <span class="hljs-string"><span class="hljs-string">'check for errors'</span></span>);     //   ,     //  fireHTTPRequest     const result = <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span> call(fireHTTPRequest, <span class="hljs-string"><span class="hljs-string">'/api/data/users'</span></span>);     <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { name: <span class="hljs-string"><span class="hljs-string">'finish'</span></span>, users: result };   } } }</code> </pre> <br>     , ,   ,    .   ,  Stent             . <br><br><h2> <font color="#3AC1EF"> Redux      Stent</font> </h2><br><h3> <font color="#3AC1EF">‚ñç     </font> </h3><br>  Redux (  Flux)   ,    .    ,  ,        .       ,           .  ,      ,        ,          . <br><br>  Stent   .     : <br><br><pre> <code class="hljs actionscript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> machine = Machine.create(<span class="hljs-string"><span class="hljs-string">'todo-app'</span></span>, { state: { name: <span class="hljs-string"><span class="hljs-string">'idle'</span></span>, todos: [] }, transitions: {   <span class="hljs-string"><span class="hljs-string">'idle'</span></span>: {     <span class="hljs-string"><span class="hljs-string">'add todo'</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(state, todo)</span></span></span><span class="hljs-function"> </span></span>{       ...     }   } } }); machine.addTodo({ title: <span class="hljs-string"><span class="hljs-string">'Fix that bug'</span></span> });</code> </pre> <br>     <code>machine.addTodo</code> ,    .      ,    :  ,     .    React         <code>addToDo</code> .        ,   .                 .    . <br><br><h3> <font color="#3AC1EF">‚ñç   </font> </h3><br>  , Redux        .      Redux,   ,         .  ,     ,   ,         ?   ‚Äî       Redux? , , ,  -   .      ,     ,     . ,   -   ,    . <br><br>     ,          ?        ? <br><br>      Redux,      ,          .           ,     .   Stent     ,       ,      .  For example: <br><br><pre> <code class="hljs ruby">const machine = Machine.create(<span class="hljs-string"><span class="hljs-string">'app'</span></span>, { <span class="hljs-symbol"><span class="hljs-symbol">state:</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">name:</span></span> <span class="hljs-string"><span class="hljs-string">'idle'</span></span> }, <span class="hljs-symbol"><span class="hljs-symbol">transitions:</span></span> {   <span class="hljs-string"><span class="hljs-string">'idle'</span></span>: {     <span class="hljs-string"><span class="hljs-string">'run'</span></span>: <span class="hljs-string"><span class="hljs-string">'running'</span></span>,     <span class="hljs-string"><span class="hljs-string">'jump'</span></span>: <span class="hljs-string"><span class="hljs-string">'jumping'</span></span>   },   <span class="hljs-string"><span class="hljs-string">'running'</span></span>: {     <span class="hljs-string"><span class="hljs-string">'stop'</span></span>: <span class="hljs-string"><span class="hljs-string">'idle'</span></span>   } } }); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   machine.run(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     , <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>       /<span class="hljs-regexp"><span class="hljs-regexp">/ running       stop. machine.jump();</span></span></code> </pre> <br>  ,                     . <br><br><h2> <font color="#3AC1EF">    </font> </h2><br> Redux,   Flux,      .  ,   Redux-,  ,   ,   ,       .      ,   ,   ,   ,     ,   .         ,     ,   ,        . <br><br><h2>  <font color="#3AC1EF">Results</font> </h2><br>     ,  ‚Äî    ,     .      ,     ,   ,  .              . ,   ,         ,    ‚Äî    .  ,    ‚Äî     .  ‚Äî ,      ‚Äî  .        -     ,      . <br><br>  <b>Dear readers!</b>          ? <br><br> <a href="https://ruvds.com/ru-rub/"><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div><p>Source: <a href="https://habr.com/ru/post/346908/">https://habr.com/ru/post/346908/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346898/index.html">School of speakers: analysis of the speech of Evgeny Rossinsky, ivi</a></li>
<li><a href="../346900/index.html">Expressive Kotlin. Extensions</a></li>
<li><a href="../346902/index.html">Safety of football stadiums: some implicit features</a></li>
<li><a href="../346904/index.html">Agile communication in distributed teams that do not intersect at work time</a></li>
<li><a href="../346906/index.html">How to recover a stolen domain through WIPO arbitration. Step-by-step instruction</a></li>
<li><a href="../346910/index.html">A selection of free computer forensic tools (forsensics)</a></li>
<li><a href="../346914/index.html">Advantages and fatal flaws in php typing</a></li>
<li><a href="../346918/index.html">OAuth authentication in the Flask application</a></li>
<li><a href="../346920/index.html">Ten startups from 1298: the story of the first global IKEA Bootcamp</a></li>
<li><a href="../346922/index.html">Interview with Oren Kaniel (CEO Appsflyer) about the mobile ecosystem, investments in technology and corporate culture</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>