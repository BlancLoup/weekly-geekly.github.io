<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Named tuples from selections</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In Django, to speed up queries that return a large amount of data, there are methods QuerySet values() and values_list() . The first instead of models...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Named tuples from selections</h1><div class="post__text post__text-html js-mediator-article"> In Django, to speed up queries that return a large amount of data, there are methods <code>QuerySet</code> <code>values()</code> and <code>values_list()</code> .  The first instead of models returns dictionaries, the second tuples.  Working with those and with others is not as convenient as with instances of models, they say, pay the guys for speed convenience.  But I don‚Äôt want to, and thanks to the nominal tuples from the standard <code>collections</code> module, I won‚Äôt. <br><a name="habracut"></a><br>  For those who have not encountered, and for those who have not yet convinced, I will give a piece of code illustrating the current state of affairs: <br><blockquote> <code>qs <font color="#666666">=</font> Item <font color="#666666">.</font> objects <font color="#666666">.</font> filter( <font color="#666666">...</font> ) <br> <font color="#008000"><strong>for</strong></font> item <font color="#AA22FF"><strong>in</strong></font> qs: <br> <font color="#008000"><strong>print</strong></font> item <font color="#666666">.</font> title, item <font color="#666666">.</font> amount <br> total <font color="#666666">+=</font> item <font color="#666666">.</font> amount <font color="#666666">*</font> item <font color="#666666">.</font> price <br> <br> <font color="#408080"><em>#  </em></font> <br> qs <font color="#666666">=</font> Item <font color="#666666">.</font> objects <font color="#666666">.</font> filter( <font color="#666666">...</font> ) <font color="#666666">.</font> values( <font color="#BA2121">'title'</font> , <font color="#BA2121">'amount'</font> , <font color="#BA2121">'price'</font> ) <br> <font color="#008000"><strong>for</strong></font> item <font color="#AA22FF"><strong>in</strong></font> qs: <br> <font color="#008000"><strong>print</strong></font> item[ <font color="#BA2121">'title'</font> ], item[ <font color="#BA2121">'amount'</font> ] <br> total <font color="#666666">+=</font> item[ <font color="#BA2121">'amount'</font> ] <font color="#666666">*</font> item[ <font color="#BA2121">'price'</font> ] <br> <br> <font color="#408080"><em>#  </em></font> <br> qs <font color="#666666">=</font> Item <font color="#666666">.</font> objects <font color="#666666">.</font> filter( <font color="#666666">...</font> ) <font color="#666666">.</font> values_list( <font color="#BA2121">'title'</font> , <font color="#BA2121">'amount'</font> , <font color="#BA2121">'price'</font> ) <br> <font color="#008000"><strong>for</strong></font> item <font color="#AA22FF"><strong>in</strong></font> qs: <br> <font color="#008000"><strong>print</strong></font> item[ <font color="#666666">0</font> ], item[ <font color="#666666">1</font> ] <br> total <font color="#666666">+=</font> item[ <font color="#666666">1</font> ] <font color="#666666">*</font> item[ <font color="#666666">2</font> ] <br></code> </blockquote><br>  Versions with dictionaries and tuples are not as pretty as with models, but they work faster and require less memory.  Named tuples allow to access their fields by attribute, i.e.  with them, our code will hardly differ from the code for models.  Hence the accompanying bonus - in many cases we will be able to switch from models to tuples and back without changing the code, and where you have to change it, the changes will be minimal.  In addition, tuples store field names in the class, rather than each object as dictionaries, so they take up less memory, which is nice in itself and will be even more important if you think of adding the results of queries to the cache. <br><br><h4>  What are named tuples? </h4><br>  Named tuples appeared in Python 2.6 and are tuples in which access to elements is possible by specified attributes.  A small piece of code for the demonstration: <br><blockquote> <code><font color="#000080"><strong>&gt;&gt;&gt;</strong></font> <font color="#008000"><strong>from</strong></font> <font color="#0000FF"><strong>collections</strong></font> <font color="#008000"><strong>import</strong></font> namedtuple <br> <font color="#000080"><strong>&gt;&gt;&gt;</strong></font> Point <font color="#666666">=</font> namedtuple( <font color="#BA2121">'Point'</font> , <font color="#BA2121">'x y'</font> <font color="#666666">.</font> split()) <br> <font color="#000080"><strong>&gt;&gt;&gt;</strong></font> p <font color="#666666">=</font> Point(x <font color="#666666">=11</font> , y <font color="#666666">=22</font> ) <font color="#408080"><em>#    </em></font> <br> <font color="#000080"><strong>&gt;&gt;&gt;</strong></font> p2 <font color="#666666">=</font> Point( <font color="#666666">11</font> , <font color="#666666">22</font> ) <font color="#408080"><em># ...   </em></font> <br> <font color="#000080"><strong>&gt;&gt;&gt;</strong></font> p1 <font color="#666666">==</font> p2 <br> <font color="#808080">True <br></font> <font color="#000080"><strong>&gt;&gt;&gt;</strong></font> p[ <font color="#666666">0</font> ] <font color="#666666">+</font> p[ <font color="#666666">1</font> ] <font color="#408080"><em># </em></font> <br> <font color="#808080">33 <br></font> <font color="#000080"><strong>&gt;&gt;&gt;</strong></font> x, y <font color="#666666">=</font> p <font color="#408080"><em># ...      </em></font> <br> <font color="#000080"><strong>&gt;&gt;&gt;</strong></font> x, y <br> <font color="#808080">(11, 22) <br></font> <font color="#000080"><strong>&gt;&gt;&gt;</strong></font> p <font color="#666666">.</font> x <font color="#666666">+</font> p <font color="#666666">.</font> y <font color="#408080"><em>#     </em></font> <br> <font color="#808080">33 <br></font> <font color="#000080"><strong>&gt;&gt;&gt;</strong></font> Point <font color="#666666">.</font> _make([ <font color="#666666">11</font> , <font color="#666666">22</font> ]) <font color="#408080"><em>#    </em></font> <br> <font color="#808080">Point(x=11, y=22)</font> <br></code> </blockquote><br><h4>  NamedTuplesQuerySet </h4><br>  It remains to create a descendant of <code>QuerySet</code> , which will produce named tuples.  Due to the fact that all the query logic with marked fields is implemented in <code>ValuesQuerySet</code> (returned from <code>QuerySet.values()</code> ), we just need to process the result before issuing: <br><blockquote> <code><font color="#008000"><strong>from</strong></font> <font color="#0000FF"><strong>itertools</strong></font> <font color="#008000"><strong>import</strong></font> imap <br> <font color="#008000"><strong>from</strong></font> <font color="#0000FF"><strong>collections</strong></font> <font color="#008000"><strong>import</strong></font> namedtuple <br> <br> <font color="#008000"><strong>from</strong></font> <font color="#0000FF"><strong>django.db.models.query</strong></font> <font color="#008000"><strong>import</strong></font> ValuesQuerySet <br> <br> <font color="#008000"><strong>class</strong></font> <font color="#0000FF"><strong>NamedTuplesQuerySet</strong></font> (ValuesQuerySet): <br> <font color="#008000"><strong>def</strong></font> <font color="#0000FF">iterator</font> ( <font color="#008000">self</font> ): <br> <font color="#408080"><em>#    </em></font> <br> extra_names <font color="#666666">=</font> <font color="#008000">self</font> <font color="#666666">.</font> query <font color="#666666">.</font> extra_select <font color="#666666">.</font> keys() <br> field_names <font color="#666666">=</font> <font color="#008000">self</font> <font color="#666666">.</font> field_names <br> aggregate_names <font color="#666666">=</font> <font color="#008000">self</font> <font color="#666666">.</font> query <font color="#666666">.</font> aggregate_select <font color="#666666">.</font> keys() <br> names <font color="#666666">=</font> extra_names <font color="#666666">+</font> field_names <font color="#666666">+</font> aggregate_names <br> <br> <font color="#408080"><em>#   </em></font> <br> tuple_cls <font color="#666666">=</font> namedtuple( <font color="#BA2121">'</font> <font color="#BB6688"><strong>%s</strong></font> <font color="#BA2121">Tuple'</font> <font color="#666666">%</font> <font color="#008000">self</font> <font color="#666666">.</font> model <font color="#666666">.</font> __name__, names) <br> <br> results_iter <font color="#666666">=</font> <font color="#008000">self</font> <font color="#666666">.</font> query <font color="#666666">.</font> get_compiler( <font color="#008000">self</font> <font color="#666666">.</font> db) <font color="#666666">.</font> results_iter() <br> <font color="#408080"><em>#       </em></font> <br> <font color="#008000"><strong>return</strong></font> imap(tuple_cls <font color="#666666">.</font> _make, results_iter) <br></code> </blockquote><br>  And, for ease of use, we assign the method to the <code>QuerySet</code> : <br><blockquote> <code><font color="#008000"><strong>from</strong></font> <font color="#0000FF"><strong>django.db.models.query</strong></font> <font color="#008000"><strong>import</strong></font> QuerySet <br> <br> <font color="#008000"><strong>def</strong></font> <font color="#0000FF">namedtuples</font> ( <font color="#008000">self</font> , <font color="#666666">*</font> fields): <br> <font color="#008000"><strong>return</strong></font> <font color="#008000">self</font> <font color="#666666">.</font> _clone(klass <font color="#666666">=</font> NamedTuplesQuerySet, setup <font color="#666666">=</font> <font color="#008000">True</font> , _fields <font color="#666666">=</font> fields) <br> QuerySet <font color="#666666">.</font> namedtuples <font color="#666666">=</font> namedtuples <br></code> </blockquote><br>  After that, the code given in the beginning of the article for models, dictionaries and tuples can be written as: <br><blockquote> <code>qs <font color="#666666">=</font> Item <font color="#666666">.</font> objects <font color="#666666">.</font> filter( <font color="#666666">...</font> ) <font color="#666666">.</font> namedtuples( <font color="#BA2121">'title'</font> , <font color="#BA2121">'amount'</font> , <font color="#BA2121">'price'</font> ) <br> <font color="#008000"><strong>for</strong></font> item <font color="#AA22FF"><strong>in</strong></font> qs: <br> <font color="#008000"><strong>print</strong></font> item <font color="#666666">.</font> title, item <font color="#666666">.</font> amount <br> total <font color="#666666">+=</font> item <font color="#666666">.</font> amount <font color="#666666">*</font> item <font color="#666666">.</font> price <br></code> </blockquote><br>  It's funny that the resulting class performs the functions of both the existing <code>values()</code> and <code>values_list()</code> accelerators.  And it does it either better, or almost also and thus generates a more beautiful code.  Maybe someday it will lead to their replacement. <br><br>  <b>PS</b> Class code with the patch can be pulled from here <a href="https://gist.github.com/876324">gist.github.com/876324</a> <br>  <b>PPS</b> The order of the fields in the tuple may not correspond to the order of the arguments <code>nametuples()</code> , scored on this for speed.  Implementing the reordering of fields, if anyone needs it, can be taken from <code>ValuesListQuerySet.iterator()</code> . </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/115797/">https://habr.com/ru/post/115797/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../115791/index.html">Particle System for PHP in 3D</a></li>
<li><a href="../115792/index.html">Another Hollywood movie being filmed for the Internet</a></li>
<li><a href="../115793/index.html">This Is Russia</a></li>
<li><a href="../115794/index.html">Little under-game under-development story</a></li>
<li><a href="../115796/index.html">ICANN approves .xxx zone</a></li>
<li><a href="../115798/index.html">Constructor Theme for Wordpress</a></li>
<li><a href="../115799/index.html">Giants of the past: Catalyst 5000 (Project Synergy)</a></li>
<li><a href="../115801/index.html">How to come up with a domain name for the site - a creative approach</a></li>
<li><a href="../115804/index.html">New York Times newspaper website will be paid</a></li>
<li><a href="../115805/index.html">Projection mouse evoMouse</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>