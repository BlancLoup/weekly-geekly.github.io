<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I left elma</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Three years ago, in order to automate the management of organizational and administrative documentation, the elma system was acquired. But after a yea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I left elma</h1><div class="post__text post__text-html js-mediator-article">  Three years ago, in order to automate the management of organizational and administrative documentation, the elma system was acquired.  But after a year of operation, it became clear that it would have to be abandoned. <br><img src="https://habrastorage.org/files/4bb/b17/be0/4bbb17be07ca430b9ba2946ef57baab8.png"><br>  The story of how I went from elma to easla.com. <br><a name="habracut"></a><br>  Before purchasing <a href="http://www.elma-bpm.ru/">elma</a> , a thorough analysis of the system on the adequacy of the tasks was carried out.  I liked the following in the system: <br><ul><li>  Modern web interface </li><li>  Ability to customize business processes using flowcharts </li><li>  The ability to write code in C #. </li></ul><br>  It is a pity that I could not see the pitfalls immediately.  I will not go into much detail, but about three months after the start of operation, problems of a different plan appeared.  First of all, I was certainly worried about technical problems, for example: <br><ul><li>  It is extremely difficult to name the files of an object programmatically (remember, technical support offered to write more than a hundred lines of code in different events for this), although two months later the developers fixed this problem. </li><li>  Problems creating processes with branches.  An incoming letter review process was created, which was branched out according to the number of responsible executives.  There was practically no code in the process.  However, phantom tasks appeared regularly - I called them so.  5 tasks were assigned, but it turns out 10. It was not possible to solve the problem with the help of technical support and I had to write ‚Äúcrutches‚Äù that destroyed phantoms programmatically.  But still, in unpredictable situations, they manifested themselves. </li><li>  Development of new processes was possible only on a separate, test server, for which regularly had to ask for a license, because  It is not included in the delivery.  The finished process had to be manually transferred from the test server to the battle one.  At the same time, the combat server had to be restarted.  During working hours this is impossible, which led to the regular transfer of working time at night. </li><li>  Each update brought its own corrections and its own bugs.  Once, an update brought a bug that was fixed 2-3 updates back.  And sometimes the mistakes were funny - children.  For example, two updates in a row could not expand the main menu to the full height of the browser. </li></ul><br>  There were other problems.  But that, technical problems which end users do not concern. <br>  However, users also regularly complained about inconveniences, for example: <br><ul><li>  The search for objects is carried out only on a separate page, which seems to be logical, and even search criteria can be entered very complex, but for the end user this functionality was inconvenient.  All have long been accustomed to looking for conveniently indicating the criteria in the header of the table, and switching to a separate page and multi-entry criteria caused dissatisfaction and rejection. </li><li>  Elma, working in a local network, began to amaze with her thoughtfulness.  We studied the system from the inside.  It turned out that for each object the system creates a separate table and a handful of adjacent tables for storing data, i.e.  braking should not be.  However, when the number of entries for each object exceeded five thousand, the brakes became noticeable on an intuitive level.  List of pages opened a few seconds. </li></ul><br>  After a year of operation <a href="http://www.elma-bpm.ru/">elma,</a> it became clear that the system will lead the organization to a standstill.  We will not be able to implement other processes on it without degrading performance.  And there is no guarantee that, having implemented the processes, they will work stably, taking into account constantly ‚Äúgetting out bugs‚Äù.  All the advantages of the system have disappeared. <br><br><h4>  Search </h4><br>  A search was made for the system instead of <a href="http://www.elma-bpm.ru/">elma</a> .  One of the search criteria was its free or low cost, because  the management of the organization did not want to spend money on the purchase of a new system, and I, as the head of the IT department, who made the decision to purchase <a href="http://www.elma-bpm.ru/">elma</a> at one time and justifying its acquisition was once again ashamed to ask for the same money.  Also, in the list of criteria were: <br><ul><li>  User-friendly web interface </li><li>  Development and change of processes in real time </li><li>  File storage flexibility </li><li>  The ability to import data from elma to the new system. </li></ul><br>  Just <a href="http://easla.com/">easla.com</a> approached all items. <br><br><h4>  Development </h4><br>  After registering in the system began to develop relevant business processes.  Moreover, the attributes of objects had to be implemented so that they could receive imported data from <a href="http://www.elma-bpm.ru/">elma</a> . <br>  It took four processes: <br><ul><li>  Customers </li><li>  Treaties </li><li>  Correspondence </li><li>  Tasks. </li></ul><br>  The process " <a href="https://easla.com/ru/process/infoAlone/process_id/117">Customers</a> " can hardly be called a process.  Objects do not even have statuses.  In fact, it is a catalog of contractors and related contacts.  But the contractor differs from all other objects in the number of attributes.  It allows you to store not only the name, but also the legal and postal addresses, as well as bank details.  Only 40 attributes!  A contact is an individual who is an employee of the counterparty. <br>  The ‚ÄúContracts‚Äù process at that time was also a simple catalog of contracts.  He was needed solely for the classification of letters. <br>  The process of " <a href="https://easla.com/ru/process/infoAlone/process_id/159">correspondence</a> " - a very important process for the organization.  He manages the official <a href="https://habrahabr.ru/company/easla/blog/281839/">incoming</a> and <a href="https://habrahabr.ru/company/easla/blog/281999/">outgoing</a> correspondence, which affects the adoption of technical decisions and participates in resolving conflict situations in court.  Incoming letters may cause damage due to late consideration or response.  Outgoing letters can bring <u>six- and sometimes seven-digit profit</u> when they are sent in a timely manner.  Important differences of the Outgoing Document object are: <br><ul><li>  The way of storing the file of the letter </li><li>  The method of storage of the attached documents </li><li>  The possibility of developing a letter online </li><li>  Ability to send a letter in one of a dozen ways. </li></ul><br>  The process of " <a href="https://easla.com/ru/process/infoAlone/process_id/28">Tasks</a> " is important in the same way as "Correspondence", because  is its logical continuation.  With the help of tasks, the execution of orders for each <a href="https://habrahabr.ru/company/easla/blog/281839/">incoming</a> or <a href="https://habrahabr.ru/company/easla/blog/281999/">outgoing</a> document is monitored.  In addition, in each task, the registration of labor costs in minutes and a bundle with the incoming and outgoing letter is carried out. <br>  The development of processes finished in a month and the question of the actual data import arose.  But before - export from <a href="http://www.elma-bpm.ru/">elma</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Export Import </h4><br>  Import to <a href="http://easla.com/">easla.com</a> has some features to keep in mind: <br><ul><li>  The first line of the data file may contain attribute designations. </li><li>  You can only import 1000 records at a time. </li><li>  Multiple values ‚Äã‚Äãfor one attribute must be separated by the symbol "|" </li><li>  Imported files must have different names. </li></ul><br>  I did not find any regular means of uploading data from <a href="http://www.elma-bpm.ru/">elma</a> , so I had to go into the database.  In the base of <a href="http://www.elma-bpm.ru/">elma there is a</a> sea ‚Äã‚Äãof ‚Äã‚Äãdifferent tables, the necessary tables were found intuitively.  Still, programmers think the same way. <br>  Began to export with simple objects.  First counterparties.  I wrote this SQL query: <br><div class="spoiler">  <b class="spoiler_title">ELMA_export_contragents.sql</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> [ELMA].[dbo].[Contractor].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_name] ,[LF].[LongName] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_opf] ,[ELMA].[dbo].[ContractorType].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_type] ,[Site] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_url] ,[crm_management_contragent_email] = <span class="hljs-keyword"><span class="hljs-keyword">STUFF</span></span>(( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'|'</span></span> + [ELMA].[dbo].[Email].[EmailString] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [ELMA].[dbo].[Contractor_Email] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[Email] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [ELMA].[dbo].[Email].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[Contractor_Email].[Email] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [ELMA].[dbo].[Contractor_Email].[Contractor] = [ELMA].[dbo].[Contractor].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">XML</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PATH</span></span>(<span class="hljs-string"><span class="hljs-string">''</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span>).value(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'VARCHAR(MAX)'</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) ,[Fax] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_fax] ,[crm_management_contragent_phone] = <span class="hljs-keyword"><span class="hljs-keyword">STUFF</span></span>(( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'|'</span></span> + [ELMA].[dbo].[Phone].[PhoneString] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [ELMA].[dbo].[Contractor_Phone] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[Phone] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [ELMA].[dbo].[Phone].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[Contractor_Phone].[Phone] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [ELMA].[dbo].[Contractor_Phone].[Contractor] = [ELMA].[dbo].[Contractor].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">XML</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PATH</span></span>(<span class="hljs-string"><span class="hljs-string">''</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span>).value(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'VARCHAR(MAX)'</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) ,[LAC].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_legal_country] ,[LA].[Region] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_legal_region] ,[LA].[District] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_legal_district] ,[LA].[City] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_legal_city] ,[LA].[Locality] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_legal_locality] ,[LA].[Street] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_legal_street] ,[LA].[Building] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_legal_house] ,[LA].[Stroenie] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_legal_building] ,[LA].[Korpus] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_legal_corp] ,[LA].[Appartment] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_legal_apartment] ,[LA].[Zip] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_legal_postcode] ,[PAC].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_post_country] ,[PA].[Region] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_post_region] ,[PA].[District] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_post_district] ,[PA].[City] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_post_city] ,[PA].[Locality] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_post_locality] ,[PA].[Street] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_post_street] ,[PA].[Building] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_post_house] ,[PA].[Stroenie] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_post_building] ,[PA].[Korpus] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_post_corp] ,[PA].[Appartment] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_post_apartment] ,[PA].[Zip] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_post_postcode] ,[INN] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_inn] ,[ELMA].[dbo].[ContractorLegal].[KPP] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_kpp] ,[ELMA].[dbo].[ContractorLegal].[OGRN] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_ogrn] ,[ELMA].[dbo].[ContractorLegal].[BIK] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_bik] ,[ELMA].[dbo].[ContractorLegal].[BANK] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_bank] ,[ELMA].[dbo].[ContractorLegal].[KS] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_ks] ,[ELMA].[dbo].[ContractorLegal].[RS] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contragent_rs] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [ELMA].[dbo].[Contractor] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[ContractorType] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [ELMA].[dbo].[ContractorType].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[Contractor].[<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[ContractorLegal] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [ELMA].[dbo].[ContractorLegal].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[Contractor].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[Address] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [LA] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [LA].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[Contractor].[LegalAddress] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[Country] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [LAC] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [LAC].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [LA].[Country] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[Address] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [PA] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PA].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[Contractor].[PostalAddress] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[Country] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [PAC] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PAC].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [PA].[Country] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[LegalForm] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [LF] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [LF].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[ContractorLegal].[LegalForm] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [ELMA].[dbo].[Contractor].[IsDeleted] = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> [ELMA].[dbo].[Contractor].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> [ELMA].[dbo].[Contractor].[<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">500</span></span></code> </pre> <br></div></div><br>  Multiple values ‚Äã‚Äãfor one attribute are combined into one using STUFF (...).  The result of the query is saved in csv format with a separator ";".  The first line in the file added attribute notation in <a href="http://easla.com/">easla.com</a> .  Uploaded file in the section "Import Objects".  Then he specified the encoding of the file and the user on whose behalf to perform the import.  Launched import.  The import procedure is not very fast, it can take about one second to create each object.  The number of imported records was about 500. It looked like this: <br><img src="https://habrastorage.org/files/52c/8ee/eec/52c8eeeec9a6487092b1e2acc3eba713.gif"><br>  Now contacts.  I wrote this SQL query: <br><div class="spoiler">  <b class="spoiler_title">ELMA_export_contacts.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Surname] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contact_lastname] ,[Firstname] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contact_firstname] ,[Middlename] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contact_middlename] ,[ELMA].[dbo].[Contractor].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contact_contragent] ,[Department] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [cnt_management_contact_department] ,[<span class="hljs-keyword"><span class="hljs-keyword">Position</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [cnt_management_contact_position] ,[crm_management_contact_email] = <span class="hljs-keyword"><span class="hljs-keyword">STUFF</span></span>(( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'|'</span></span> + [ELMA].[dbo].[Email].[EmailString] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [ELMA].[dbo].[Contact_Email] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[Email] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [ELMA].[dbo].[Email].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[Contact_Email].[Email] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [ELMA].[dbo].[Contact_Email].[Contact] = [ELMA].[dbo].[Contact].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">XML</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PATH</span></span>(<span class="hljs-string"><span class="hljs-string">''</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span>).value(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'VARCHAR(MAX)'</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) ,[crm_management_contact_phone] = <span class="hljs-keyword"><span class="hljs-keyword">STUFF</span></span>(( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'|'</span></span> + [ELMA].[dbo].[Phone].[PhoneString] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [ELMA].[dbo].[Contact_Phone] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[Phone] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [ELMA].[dbo].[Phone].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[Contact_Phone].[Phone] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [ELMA].[dbo].[Contact_Phone].[Contact] = [ELMA].[dbo].[Contact].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">XML</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PATH</span></span>(<span class="hljs-string"><span class="hljs-string">''</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span>).value(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'VARCHAR(MAX)'</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Year</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, [Birthday],<span class="hljs-number"><span class="hljs-number">104</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contact_birthday] ,[RAC].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contact_country] ,[RA].[Region] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contact_region] ,[RA].[District] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contact_district] ,[RA].[City] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contact_city] ,[RA].[Locality] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contact_locality] ,[RA].[Street] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contact_street] ,[RA].[Building] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contact_house] ,[RA].[Stroenie] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contact_building] ,[RA].[Korpus] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contact_corp] ,[RA].[Appartment] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contact_apartment] ,[RA].[Zip] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crm_management_contact_postcode] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [ELMA].[dbo].[Contact] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[Contractor] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [ELMA].[dbo].[Contractor].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[Contact].[Contractor] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[Address] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [RA] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [RA].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[Contact].[RegistrationAddress] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[Country] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [RAC] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [RAC].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [RA].[Country] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [ELMA].[dbo].[Contact].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">1919</span></span></code> </pre><br></div></div><br>  All actions are similar to the previous import.  The peculiarity of importing contacts after counterparties was that the contact possesses the attribute "Counterparty", which refers to the counterparty.  Therefore, contractors were imported first, followed by contacts.  When importing contacts in the "Counterparty" field, <a href="http://easla.com/">easla.com</a> <u>found and substituted links to counterparties</u> !  The number of records imported was approximately 1,800. <br>  After importing counterparties and contacts, a structured database was obtained in which all contacts belong to certain counterparties.  It took about 2 hours to import the data.  And half the time spent on developing SQL queries.  As a result, I got two ready and interrelated tables. <br>  Counterparty Registry: <br><img src="https://habrastorage.org/files/7e0/c32/f02/7e0c32f02f1c47dbbaa1f2f9bba0f3d8.png"><br>  Contact register: <br><img src="https://habrastorage.org/files/65e/029/164/65e029164888434193e563c9cea89edc.png"><br>  Next in line was the import of contracts.  Unloaded them using this SQL query: <br><div class="spoiler">  <b class="spoiler_title">ELMA_export_contracts.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [RegYear] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [agr_management_contract_year] ,[RegNum] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [agr_management_contract_num] ,[RegAppendixFront] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [agr_management_contract_appendix_front] ,[RegAppendixBack] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [agr_management_contract_appendix_back] ,[RegCode] ,[ELMA].[dbo].[Contractor].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [agr_management_contract_contragent] ,<span class="hljs-string"><span class="hljs-string">'"'</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span>([Title],<span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),<span class="hljs-string"><span class="hljs-string">''</span></span>),<span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>(<span class="hljs-number"><span class="hljs-number">13</span></span>),<span class="hljs-string"><span class="hljs-string">''</span></span>),<span class="hljs-string"><span class="hljs-string">';'</span></span>,<span class="hljs-string"><span class="hljs-string">','</span></span>)+<span class="hljs-string"><span class="hljs-string">'"'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [agr_management_contract_title] ,<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, [RegDate],<span class="hljs-number"><span class="hljs-number">104</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [agr_management_contract_reg_date] ,<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, [SignDate],<span class="hljs-number"><span class="hljs-number">104</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [agr_management_contract_sign_date] ,[PM1].[EMail] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [agr_management_contract_project_manager] ,[PM2].[EMail] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [agr_management_contract_project_manager_helper] ,agr_management_contract_fields = <span class="hljs-keyword"><span class="hljs-keyword">STUFF</span></span>(( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'|'</span></span> + [F1].[Title] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [ELMA].[dbo].[Project_Fields] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Field</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [F1] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [F1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[Project_Fields].[<span class="hljs-keyword"><span class="hljs-keyword">Field</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [ELMA].[dbo].[Project_Fields].[<span class="hljs-keyword"><span class="hljs-keyword">Parent</span></span>] = [ELMA].[dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Project</span></span>].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">XML</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PATH</span></span>(<span class="hljs-string"><span class="hljs-string">''</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span>).value(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'VARCHAR(MAX)'</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [ELMA].[dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Project</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[Contractor] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [ELMA].[dbo].[Contractor].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Project</span></span>].[Contragent] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [PM1] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PM1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Project</span></span>].[ProjectManager] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [PM2] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PM2].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Project</span></span>].[ProjectManagerHelper]</code> </pre><br></div></div><br>  All actions are also similar to previous imports.  And just like with contacts, all contracts having the attribute "Counterparty" during the import contacted the corresponding counterparties.  The number of records imported was a little over 200. <br><img src="https://habrastorage.org/files/24c/dcb/ed4/24cdcbed40c64361a0d90bdd512a0abf.png"><br>  Now, when all contractors, contacts and contracts referred to by incoming and outgoing documents were in <a href="http://easla.com/">easla.com</a> , it was possible to proceed with the import of correspondence. <br>  The number of <a href="https://habrahabr.ru/company/easla/blog/281839/">incoming</a> and <a href="https://habrahabr.ru/company/easla/blog/281999/">outgoing</a> letters was large - approximately 5400 and 5300, respectively. <br>  It is interesting that incoming and outgoing letters refer to each other, i.e.  Outgoing can be sent in response to incoming and information about this is stored in the corresponding attribute of the outgoing document.  The incoming document can be received in response to the outgoing document and information about it is stored in the corresponding attribute of the incoming document.  Thus, when importing one of the object types, <u>it is impossible to</u> ensure the formation of all links.  The first imported documents were imported, but before that, the type of the attribute that stores the link to the outgoing document was changed from ‚ÄúObject‚Äù to ‚ÄúString‚Äù.  This made it possible to save in the attribute a description of the outgoing document that is not yet in the database and use it later, after importing outgoing documents.  Ultimately, this is a SQL query for uploading incoming documents: <br><div class="spoiler">  <b class="spoiler_title">ELMA_export_incomings.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> [DocMethod] <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'. '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crs_management_incoming_method] ,[ELMA].[dbo].[Contractor].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crs_management_incoming_contragent] ,[ELMA].[dbo].[Contact].[Surname] + <span class="hljs-string"><span class="hljs-string">' '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">SUBSTRING</span></span>([ELMA].[dbo].[Contact].[Firstname],<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) + <span class="hljs-string"><span class="hljs-string">'.'</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">SUBSTRING</span></span>([ELMA].[dbo].[Contact].[Middlename],<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) + <span class="hljs-string"><span class="hljs-string">'.'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crs_management_incoming_contact] ,[crs_management_incoming_performers] = <span class="hljs-keyword"><span class="hljs-keyword">STUFF</span></span>(( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'|'</span></span> + [C1].[Surname] + <span class="hljs-string"><span class="hljs-string">' '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">SUBSTRING</span></span>([C1].[Firstname],<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) + <span class="hljs-string"><span class="hljs-string">'.'</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">SUBSTRING</span></span>([C1].[Middlename],<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) + <span class="hljs-string"><span class="hljs-string">'.'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [ELMA].[dbo].[IncomingDoc_Performers] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[Contact] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [C1] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [C1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[IncomingDoc_Performers].[Performer] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [ELMA].[dbo].[IncomingDoc_Performers].[<span class="hljs-keyword"><span class="hljs-keyword">Parent</span></span>] = [ELMA].[dbo].[IncomingDoc].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">XML</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PATH</span></span>(<span class="hljs-string"><span class="hljs-string">''</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span>).value(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'VARCHAR(MAX)'</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, [ELMA].[dbo].[IncomingDoc].[ContragentDate], <span class="hljs-number"><span class="hljs-number">104</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crs_management_incoming_contragent_date] ,[ELMA].[dbo].[IncomingDoc].[ContragentRegNum] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crs_management_incoming_contragent_regnum] ,<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>,[ELMA].[dbo].[IncomingDoc].[ReceiveDate],<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crs_management_incoming_receive_date] ,[ELMA].[dbo].[IncomingDoc].[ReceiveOriginalDate] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crs_management_incoming_receive_original_date] ,[ReceiveOriginalDateFlag] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crs_management_incoming_receive_original_flag] ,[ELMA].[dbo].[IncomingDoc].[ReceiveRegNum] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crs_management_incoming_receive_regnum] ,<span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span>([ELMA].[dbo].[IncomingDoc].[Subj],<span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>(<span class="hljs-number"><span class="hljs-number">13</span></span>),<span class="hljs-string"><span class="hljs-string">''</span></span>),<span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crs_management_incoming_subj] ,<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> [ELMA].[dbo].[IncomingDoc].[DocType] <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'   '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'   '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">99</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crs_management_incoming_content] ,[U1].[UserName]+<span class="hljs-string"><span class="hljs-string">'@sngp.ru'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crs_management_incoming_to] ,[U2].[UserName]+<span class="hljs-string"><span class="hljs-string">'@sngp.ru'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crs_management_incoming_forwardto] ,[ELMA].[dbo].[OutgoingDoc].[RegNum] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crs_management_incoming_outgoing] ,[ELMA].[dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Project</span></span>].[RegCode] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crs_management_incoming_contract] ,[crs_management_incoming_attachments] = <span class="hljs-keyword"><span class="hljs-keyword">STUFF</span></span>(( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'|'</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>([F0].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>]) + <span class="hljs-string"><span class="hljs-string">' '</span></span> + [F0].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>]),<span class="hljs-string"><span class="hljs-string">'¬´'</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>),<span class="hljs-string"><span class="hljs-string">'¬ª'</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>),<span class="hljs-string"><span class="hljs-string">'‚Äì'</span></span>,<span class="hljs-string"><span class="hljs-string">'-'</span></span>),<span class="hljs-string"><span class="hljs-string">'.zip.zip'</span></span>,<span class="hljs-string"><span class="hljs-string">'.zip'</span></span>),<span class="hljs-string"><span class="hljs-string">'.docx'</span></span>,<span class="hljs-string"><span class="hljs-string">'.docx'</span></span>),<span class="hljs-string"><span class="hljs-string">' '</span></span>,<span class="hljs-string"><span class="hljs-string">' '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [ELMA].[dbo].[IncomingDoc_DocAttachments] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[FS_FILES] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [F0] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [F0].[Uid] = [ELMA].[dbo].[IncomingDoc_DocAttachments].[DocAttachment] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [ELMA].[dbo].[IncomingDoc_DocAttachments].[<span class="hljs-keyword"><span class="hljs-keyword">Parent</span></span>] = [ELMA].[dbo].[IncomingDoc].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">XML</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PATH</span></span>(<span class="hljs-string"><span class="hljs-string">''</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span>).value(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'VARCHAR(MAX)'</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">LTRIM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">STR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>([F1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>],[F2].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>]))) + <span class="hljs-keyword"><span class="hljs-keyword">REVERSE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUBSTRING</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">REVERSE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>([F1].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>],[F2].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>])), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CHARINDEX</span></span>(<span class="hljs-string"><span class="hljs-string">'.'</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">REVERSE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>([F1].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>],[F2].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>]))) + <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [crs_management_incoming_document] ,[S].[<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">status</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [ELMA].[dbo].[IncomingDoc] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[Contractor] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [ELMA].[dbo].[Contractor].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[IncomingDoc].[Contragent] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[Contact] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [ELMA].[dbo].[Contact].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[IncomingDoc].[Contact] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [U1] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [U1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[IncomingDoc].[<span class="hljs-keyword"><span class="hljs-keyword">To</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [U2] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [U2].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[IncomingDoc].[ForwardTo] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Project</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [ELMA].[dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Project</span></span>].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[IncomingDoc].[<span class="hljs-keyword"><span class="hljs-keyword">Project</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[OutgoingDoc] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [ELMA].[dbo].[OutgoingDoc].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[IncomingDoc].[OutgoingDoc] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[DocumentVersion] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [DV1] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [DV1].[DocumentId] = [ELMA].[dbo].[IncomingDoc].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> [DV1].[<span class="hljs-keyword"><span class="hljs-keyword">Status</span></span>] = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ISNUMERIC([DV1].[<span class="hljs-keyword"><span class="hljs-keyword">File</span></span>]) = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[DocumentVersion] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [DV2] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [DV2].[DocumentId] = [ELMA].[dbo].[IncomingDoc].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> [DV2].[<span class="hljs-keyword"><span class="hljs-keyword">Status</span></span>] = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ISNUMERIC([DV1].[<span class="hljs-keyword"><span class="hljs-keyword">File</span></span>]) = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[FS_FILES] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [F1] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [F1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [DV1].[<span class="hljs-keyword"><span class="hljs-keyword">File</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[FS_FILES] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [F2] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [F2].[Uid] = [DV2].[<span class="hljs-keyword"><span class="hljs-keyword">File</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Document</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [ELMA].[dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Document</span></span>].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[IncomingDoc].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [ELMA].[dbo].[LifeCycleStatus] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [S] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [S].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [ELMA].[dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Document</span></span>].[<span class="hljs-keyword"><span class="hljs-keyword">Status</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-comment"><span class="hljs-comment">--[ELMA].[dbo].[IncomingDoc].[Subj] NOT LIKE '%' AND [ELMA].[dbo].[IncomingDoc].[Subj] NOT LIKE 'test%' [ELMA].[dbo].[IncomingDoc].[Id] &gt; 12193 ORDER BY [ELMA].[dbo].[IncomingDoc].[ReceiveDate]</span></span></code> </pre><br></div></div><br>  By the way, the situation was complicated by the fact that along with the data it was necessary to upload and import all files. <br>  It was completely unexpected that the <a href="http://www.elma-bpm.ru/">elma</a> developers at some point changed the way they stored files, so I had to create two different requests and merge them together to upload files.  There was a problem with the first unloading attempt.  The names of some files were repeated and overwritten each other.  I had to change the name of the final file in the request, adding id to it.  In addition, in fact, the file and its name needed to be transferred to <a href="http://easla.com/">easla.com</a> and additional data stored with the file.  They also had to be entered in the file name.  Thus, the final file name was formed by the principle: id data filename.ext.  Since <a href="http://www.elma-bpm.ru/">elma</a> stores files in a separate directory, the result of the query was planned to be converted into a bat file to upload files to the right place.  Ultimately, to upload the files of incoming documents, the following query appeared: <br><div class="spoiler">  <b class="spoiler_title">ELMA_export_incoming_files.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'copy "\\ssv11\c$\ELMA3-Standart.cfg\UserConfig\Files\' + [FNAME] + '</span></span><span class="hljs-string"><span class="hljs-string">" "</span></span>c:\temp\elma\incoming\<span class="hljs-string"><span class="hljs-string">' + REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(ISNULL([ENDNAME],[FNAME]),'</span></span>¬´<span class="hljs-string"><span class="hljs-string">',''),'</span></span>¬ª<span class="hljs-string"><span class="hljs-string">',''),'</span></span>‚Äì<span class="hljs-string"><span class="hljs-string">','</span></span>-<span class="hljs-string"><span class="hljs-string">'),'</span></span>.zip.zip<span class="hljs-string"><span class="hljs-string">','</span></span>.zip<span class="hljs-string"><span class="hljs-string">'),'</span></span>.docx<span class="hljs-string"><span class="hljs-string">','</span></span>.docx<span class="hljs-string"><span class="hljs-string">'),'</span></span> <span class="hljs-string"><span class="hljs-string">','</span></span> <span class="hljs-string"><span class="hljs-string">') + '</span></span><span class="hljs-string"><span class="hljs-string">"' FROM ( SELECT [ELMA].[dbo].[IncomingDoc].[Id] AS [Id], [ELMA].[dbo].[IncomingDoc].[Subj] AS [Subj], [ELMA].[dbo].[IncomingDoc].[ReceiveDate] AS [RD], LTRIM(STR([F0].[Id])) + REVERSE(SUBSTRING(REVERSE([F0].[Name]), 0, CHARINDEX('.',REVERSE([F0].[Name])) + 1)) AS [FNAME], LTRIM(STR([F0].[Id]) + ' ' + [Name]) AS [ENDNAME] FROM [ELMA].[dbo].[IncomingDoc] LEFT JOIN [ELMA].[dbo].[IncomingDoc_DocAttachments] ON [ELMA].[dbo].[IncomingDoc_DocAttachments].[Parent] = [ELMA].[dbo].[IncomingDoc].[Id] LEFT OUTER JOIN [ELMA].[dbo].[FS_FILES] AS [F0] ON [F0].[Uid] = [ELMA].[dbo].[IncomingDoc_DocAttachments].[DocAttachment] UNION SELECT [ELMA].[dbo].[IncomingDoc].[Id] AS [Id], [ELMA].[dbo].[IncomingDoc].[Subj] AS [Subj], [ELMA].[dbo].[IncomingDoc].[ReceiveDate] AS [RD], LTRIM(STR(ISNULL([F1].[Id],[F2].[Id]))) + REVERSE(SUBSTRING(REVERSE(ISNULL([F1].[Name],[F2].[Name])), 0, CHARINDEX('.',REVERSE(ISNULL([F1].[Name],[F2].[Name]))) + 1)) AS [FNAME], NULL AS [ENDNAME] FROM [ELMA].[dbo].[IncomingDoc] LEFT JOIN [ELMA].[dbo].[DocumentVersion] AS [DV1] ON [DV1].[DocumentId] = [ELMA].[dbo].[IncomingDoc].[Id] AND [DV1].[Status] = 2 AND ISNUMERIC([DV1].[File]) = 1 LEFT JOIN [ELMA].[dbo].[DocumentVersion] AS [DV2] ON [DV2].[DocumentId] = [ELMA].[dbo].[IncomingDoc].[Id] AND [DV2].[Status] = 2 AND ISNUMERIC([DV1].[File]) = 0 LEFT JOIN [ELMA].[dbo].[FS_FILES] AS [F1] ON [F1].[Id] = [DV1].[File] LEFT JOIN [ELMA].[dbo].[FS_FILES] AS [F2] ON [F2].[Uid] = [DV2].[File] ) AS [F] WHERE [FNAME] IS NOT NULL ORDER BY [RD]</span></span></code> </pre><br></div></div><br>  Loaded csv file, downloaded all incoming files.  The procedure was long, because  The total file size was several gigabytes.  It's good that importing data by 1000 records, since  no lining has not done.  Be sure to pop up in every thousand of 10-15 errors.  It was possible to identify errors before the import procedure, using a preview.  Very comfortably.  In general, every thousand required advance preparation. <br>  In the same way imported all outgoing documents. <br>  After that, in the objects was written the procedure for converting file names.  She deleted the id, and data, transferred to the revdata file in <a href="http://easla.com/">easla.com</a> .  Thus, the application files received the original names filename.ext. <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateAttachmentsFileName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $files = cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_incoming_attachments'</span></span>)-&gt;availableFiles(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($files <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $f) { $parts = explode(<span class="hljs-string"><span class="hljs-string">' '</span></span>, $f-&gt;nowname, <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($parts) == <span class="hljs-number"><span class="hljs-number">2</span></span>) { $f-&gt;nowname = $parts[<span class="hljs-number"><span class="hljs-number">1</span></span>]; $f-&gt;save(); } } }</code> </pre><br>  A procedure was written especially for incoming letters, which replaced descriptions of references to outgoing documents with their identifiers. <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateOutgoing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_incoming_outgoing'</span></span>)-&gt;value)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; $outgoing_doc = selectAll( <span class="hljs-string"><span class="hljs-string">'crs_management'</span></span>, <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_regnum'</span></span>=&gt;cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_incoming_outgoing'</span></span>)-&gt;value) ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($outgoing_doc)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_incoming_outgoing'</span></span>)-&gt;value = $outgoing_doc[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]; }</code> </pre><br><br>  Checking the work of these procedures launched a batch update of objects.  Slowly but surely <a href="http://easla.com/">easla.com</a> updated all the objects!  After that, changed the attribute type referencing the outgoing document in the incoming document from ‚ÄúString‚Äù to ‚ÄúObject‚Äù so that the object identifiers become objects. <br>  Thus, <a href="http://easla.com/">easla.com</a> renamed files and organized <u>cross-references</u> between incoming and outgoing documents! <br>  In general, the export and import procedure took about 3 working days.  Download files on <a href="http://easla.com/">easla.com</a> carried out in the evenings, when the Internet channel was free.  Importing data by 1000 was also convenient because old letters could be imported immediately, without worrying about data integrity.  And just before the ‚Äúcombat‚Äù launch I downloaded and imported the remnants - the last couple of hundred letters. <br>  Migration was carried out at the end of 2014, and launched into operation all the described business processes on January 12, 2015. <br>  More than a year has passed.  The total amount of letters exceeded 20 thousand.  The number of tasks exceeded 10 thousand.  Here is the latest data from the main menu: <br><img src="https://habrastorage.org/files/a91/7f7/3f2/a917f73f29284e338ed75c4ace5137be.png"><br><br><h4>  Results </h4><br>  I can say with confidence that a year ago I did everything right.  Here are the main benefits: <br><ul><li>  The time for registering letters has been reduced to seconds or minutes. </li><li>  The time for sending an outgoing letter has been reduced from 30-40 minutes to seconds </li><li>  Now you can place outgoing email files on the <a href="http://easla.com/">easla.com</a> file sharing <a href="http://easla.com/">service.</a> </li><li>  Developing a letter has become easier, because  Now the file in docx format is stored in the <a href="http://easla.com/">easla.com</a> object, and not anywhere in the user </li><li>  Communication tasks and letters allows you to generate and upload complex reports that bring the organization a profit </li><li>  The contract management process was developed, if earlier it was a simple catalog, now it is a real process with statuses, execution control, signing of acts and receipt of funds. </li></ul><br>  At the moment, other processes have also been developed: management of tasks, coordination, subcontract agreements.  All that was previously feared to do at <a href="http://www.elma-bpm.ru/">elma</a> is now done at <a href="http://easla.com/">easla.com</a> ! <br><br>  PS Please do not regard the article as <a href="http://www.elma-bpm.ru/">elma</a> anti-advertising.  The system did not suit us, but it may well suit others, if they are not ‚Äúsqueezing the juice out of it,‚Äù as we are. </div><p>Source: <a href="https://habr.com/ru/post/282662/">https://habr.com/ru/post/282662/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282652/index.html">Lazy threads: optional parallelism</a></li>
<li><a href="../282654/index.html">Record of the webinar "How easy it is to protect the company from encrypters and hidden threats"</a></li>
<li><a href="../282656/index.html">Piter Py # 3 - Personal Impressions</a></li>
<li><a href="../282658/index.html">Mobile application against fraudsters and paperwork in auto insurance</a></li>
<li><a href="../282660/index.html">Another Reflection Library and ORM for C ++</a></li>
<li><a href="../282664/index.html">Installing Joomla 3.5 on Freebsd 10.3</a></li>
<li><a href="../282670/index.html">The digest of interesting materials from the world of MODX # 2</a></li>
<li><a href="../282672/index.html">The benefits of inspections</a></li>
<li><a href="../282674/index.html">How does it feel to be a developer when you're forty</a></li>
<li><a href="../282676/index.html">Inheriting tables in Postgresql with Ruby on Rails</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>