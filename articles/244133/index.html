<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Redirect users by rules to Squid</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At work, I encountered such a problem: there are a dozen proxy servers (squid) in different countries and not one dozen users. Each of them decides th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Redirect users by rules to Squid</h1><div class="post__text post__text-html js-mediator-article">  At work, I encountered such a problem: there are a dozen proxy servers (squid) in different countries and not one dozen users.  Each of them decides through which server to work - there is a chrome extension in which they can make a choice. <br><br>  But all the servers are at different distances from the user and the user from Russia, using a server in Canada, is faced with good brakes.  On the other hand, all the servers in the data centers are connected to highways and there is much less delay between them. <br><br>  It was decided to send each user to the server nearest to him, and from there to the selected one. <br><a name="habracut"></a><br><h4>  Proxy proxy </h4><br>  The first point is to configure the proxy to work with each other.  The easiest way was to specify: <br><pre><code class="bash hljs">acl localnet srcdomain  .com</code> </pre> <br>  But it turned out that not everyone allows the inverse transformation to the domain specified by you.  I had to register all ip servers: <br><pre> <code class="bash hljs">acl localnet srcdomain IP a 1 acl localnet srcdomain IP a 2 acl localnet srcdomain IP a 3</code> </pre><br>  If someone prompts another solution, I will be happy to correct.  While the servers do not change often and in case of changes, they are quickly corrected using puppet. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Redirect Management </h4><br>  The next step is to configure acl for server redirection: <br><pre> <code class="bash hljs">cache_peer { 1} parent 3128 3130 name=peer1 cache_peer { 2} parent 3128 3130 name=peer2 cache_peer { 3} parent 3128 3130 name=peer3 cache_peer_access peer1 allow user1 cache_peer_access peer2 allow user2 cache_peer_access peer3 allow user3</code> </pre><br>  At the same time, user1, user2 and user3 are acl users. <br><br><h4>  Authorization </h4><br>  The company has already configured a radius server for these cases.  In centos 5, I went through configuration via pam, since I didn‚Äôt collect squid itself, but then I had to go the way of self-assembly (ssl was not included in the standard one) and I used the key - enable-basic-auth-helpers = squid_radius_auth.  Also, for those who don‚Äôt want to bother with pam, I would recommend a separate library: <br><br><pre> <code class="bash hljs">wget http://www.squid-cache.org/contrib/squid_radius_auth/squid_radius_auth-1.10.tar.gz tar xvzf squid_radius_auth-1.10.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> squid_radius_auth-1.10 cp Makefile.default Makefile make make install</code> </pre><br>  In any installation option, the squid configuration does not change, only the path to the file in the first line: <br><pre> <code class="bash hljs">auth_param basic program /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/squid/libexec/basic_radius_auth -f /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/squid/etc/radius_config auth_param basic children 5 auth_param basic realm { } //      auth_param basic credentialsttl 2 hours auth_param basic casesensitive off acl radius proxy_auth REQUIRED</code> </pre><br>  Sample radius_config file: <br><pre> <code class="bash hljs">server { radius } password {     radius}</code> </pre><br><br><h4>  Each server of its user </h4><br>  The rules were pretty simple.  First, we specify which user will be controlled by which rule: <br><pre> <code class="bash hljs">acl user1 proxy_auth <span class="hljs-string"><span class="hljs-string">"/usr/local/squid/userlist/user1"</span></span> no_cache acl user2 proxy_auth <span class="hljs-string"><span class="hljs-string">"/usr/local/squid/userlist/user2"</span></span> no_cache acl user3 proxy_auth <span class="hljs-string"><span class="hljs-string">"/usr/local/squid/userlist/user3"</span></span> no_cache</code> </pre><br>  And, of course, we allow them to use a proxy: <br><pre> <code class="bash hljs">http_access allow localnet //  proxy-proxy http_access allow radius //  ,     -   http_access allow user1 http_access allow user2 http_access allow user3 http_access deny all //    </code> </pre><br>  That's all.  When a user selects a server, a separate program removes the user from the files in the userlist and adds it to the selected one.  But that's another story. <br><br><h4>  Sources </h4><br>  The basic information was taken from wiki squid, but there are not enough examples: <br><ul><li>  The main site is <a href="http://wiki.squid-cache.org/">wiki.squid-cache.org</a> .  Without translation into Russian.  I do not indicate individual pages, as I used them a lot. </li><li>  Configuring Radius <a href="http://safesrv.net/setup-squid-and-freeradius-on-centos-5/">Setup Squid and FreeRADIUS on CentOS 5 and CentOS 6</a> </li><li>  This is Acl Reference - <a href="http://rus-linux.net/MyLDP/FAQ/SQUID-FAQ/FAQ-10.html">ACL elements</a> <br></li><br>  The article does not describe the entire service, but only the squid configuration.  But not written refers only to the dynamics, and all of them can have their own.  I noted only the right moments.  Do not try to customize everything using copy-paste - missing lines that have nothing to do with the topic of the article. </ul></div><p>Source: <a href="https://habr.com/ru/post/244133/">https://habr.com/ru/post/244133/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../244119/index.html">eBay API: Step Two</a></li>
<li><a href="../244121/index.html">How-to: How the hosting provider infrastructure is built</a></li>
<li><a href="../244127/index.html">14 effective tips for content marketing for small businesses (part 2)</a></li>
<li><a href="../244129/index.html">Search for a site for hackathon. HackDay Experience</a></li>
<li><a href="../244131/index.html">How to easily and simply teach your Asterisk to call through the desired operator</a></li>
<li><a href="../244135/index.html">Climate Control at Arduino</a></li>
<li><a href="../244137/index.html">New optimizations for x86 in the expected GCC 5.0</a></li>
<li><a href="../244139/index.html">Keyboard Octodon: Throwing and Metamorphosis</a></li>
<li><a href="../244141/index.html">Media Player for Translators - feci quod potui</a></li>
<li><a href="../244143/index.html">Bypassing the protection of the iOS client Dropbox</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>