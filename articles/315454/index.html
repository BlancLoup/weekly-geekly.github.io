<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating and testing a firewall in Linux, Part 1.3. Writing char device. Adding a virtual file system ...</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Content of the first part: 

 1.1 - Creating a virtual lab (so that we have where to work, I'll show you how to create a virtual network on your compu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating and testing a firewall in Linux, Part 1.3. Writing char device. Adding a virtual file system ...</h1><div class="post__text post__text-html js-mediator-article">  <b>Content of the first part:</b> <br><br>  <a href="https://habrahabr.ru/post/315340/"><b>1.1</b> - Creating a virtual lab (so that we have where to work, I'll show you how to create a virtual network on your computer. The network will consist of 3 Linux ubuntu machines).</a> <br>  <a href="https://habrahabr.ru/post/315350/"><b>1.2</b> - Writing a simple module in Linux.</a>  <a href="https://habrahabr.ru/post/315350/">Introducing Netfilter and intercepting traffic with it.</a>  <a href="https://habrahabr.ru/post/315350/">We combine everything together, we test.</a> <br>  <b><b>1.3</b> - Writing a simple char device.</b>  <b>Adding a virtual file system - sysfs.</b>  <b>Writing user interface.</b>  <b>We combine everything together, we test.</b> <br><br>  <b>The content of the second part:</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">  <a href="https://habrahabr.ru/post/316086/"><b>2.1</b> - Introduction to the second part.</a>  <a href="https://habrahabr.ru/post/316086/">We look at the network and protocols.</a>  <a href="https://habrahabr.ru/post/316086/">Wireshark.</a> <br>  <a href="https://habrahabr.ru/post/316756/"><b>2.2</b> - Firewall Tables.</a>  <a href="https://habrahabr.ru/post/316756/">Transport Layer.</a>  <a href="https://habrahabr.ru/post/316756/">TCP structures, UDP.</a>  <a href="https://habrahabr.ru/post/316756/">Extend the firewall.</a> <br>  <b>2.3</b> - Expanding functionality.  We process the data in user space.  libnetfilter_queue. <br>  <b>2.4</b> - (* Optionally) We study the real Buffer Overflow attack and prevent it with the help of our Firewall. <br></div></div><a name="habracut"></a><br>  <b>Part 1.3</b> <br><br>  In the previous parts, we have prepared a module (kernel space), which can already do a minimal job - give some packages pass, and some do not.  Now it was not bad to add the ability to receive data and control the operation of the module from the usual program (user space).  For example, enable Firewall, turn off and get job statistics.  There are several ways to do this.  We will go in the classic way. <br><br><h3>  Introduction to Character device.  Theory </h3><br>  I advise to read the <a href="https://en.wikipedia.org/wiki/Device_file">English version of the Wikipedia article</a> , as more accurate and voluminous on this topic than the Russian.  It will be enough for us to understand that different hardware devices (hardware) work and interact with the operating system at a very low level and of course all this happens in the kernel space.  Linux / Unix systems, created mechanisms, one of which is a <i>character device</i> , in order to simplify interaction with these devices.  When creating a <i>character device</i> , we ‚Äúask‚Äù the OS for the necessary resources and can present the device as a file in a special directory (as is known in linux, everything is represented as files and read / write operations into it).  When reading from this file, we can receive data from the device (for example, packets that came to the network card), and when writing to this file, we can send data to the device (for example, send a document to the printer for printing).  In our case, the device is not physically present, but we will use these files to interact with our program. <br><br><h3>  Introduction to Character device.  Practice </h3><br>  It is very simple to create and register such a driver; just call the function. <br> <code>fw_major = register_chrdev(0, DEVICE_NAME, &amp;fops);</code>  .  After this function, you can go to / dev / manually add a device and start working with it.  The <i>fops</i> structure defines the functions that will be called on various events with the driver, for example, reading or writing.  The function returns a <i>major number</i> - a unique identification number. <br><br>  In this case, I chose only two events, but the links that I give below, or by reading the kernel source itself, you can find a complete list (quite large). <br><br>  Below, I determined that when reading from our device, we get the number of all captured packets, and when writing, we reset them: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ssize_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fw_device_read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct file* filp, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __user *buffer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">loff_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* offset)</span></span></span><span class="hljs-function"> </span></span>{ printk(<span class="hljs-string"><span class="hljs-string">"Reading from device, return total number of messages\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buffer, <span class="hljs-string"><span class="hljs-string">"%u"</span></span>, accepted_num + dropped_num); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ssize_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fw_device_write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct file *fp, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buff, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">loff_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ppos)</span></span></span><span class="hljs-function"> </span></span>{ printk(<span class="hljs-string"><span class="hljs-string">"Writing to device, clear number of messages\n"</span></span>); accepted_num = dropped_num = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_operations</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fops</span></span></span><span class="hljs-class"> = {</span></span> .read = fw_device_read, .write = fw_device_write };</code> </pre><br>  In order not to add a device manually each time, you can make its registration automatic: <br><br><pre> <code class="cpp hljs">fw_class = class_create(THIS_MODULE, DEVICE_NAME); fw_device = device_create(fw_class, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, MKDEV(fw_major, <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, DEVICE_FW);</code> </pre><br>  A small check: <br><br><img src="https://habrastorage.org/files/1f2/ee7/49f/1f2ee749f6ff46c1a6214092bc54c2b1.png"><br><br>  You can already see the device in / dev, and after registering the class, it also appears in / sys / class <br><br>  Below is a full listing, note the use of goto.  Usually (= always), we do not use goto in programming, because it spoils the comprehension, content, readability of the code and most likely speaks of problems in the design of the program ( <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BF%25D0%25B0%25D0%25B3%25D0%25B5%25D1%2582%25D1%2582%25D0%25B8-%25D0%25BA%25D0%25BE%25D0%25B4">spaghetti code</a> ).  But this case is one of the few where goto is very relevant. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fw_major; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fw_device</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ssize_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fw_device_read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct file* filp, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __user *buffer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">loff_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* offset)</span></span></span><span class="hljs-function"> </span></span>{ printk(<span class="hljs-string"><span class="hljs-string">"Reading from device, return total number of messages\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buffer, <span class="hljs-string"><span class="hljs-string">"%u"</span></span>, accepted_num + dropped_num); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ssize_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fw_device_write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct file *fp, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buff, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">loff_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ppos)</span></span></span><span class="hljs-function"> </span></span>{ printk(<span class="hljs-string"><span class="hljs-string">"Writing to device, clear number of messages\n"</span></span>); accepted_num = dropped_num = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_operations</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fops</span></span></span><span class="hljs-class"> = {</span></span> .read = fw_device_read, .write = fw_device_write }; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">init </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fw_module_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> retval = <span class="hljs-number"><span class="hljs-number">0</span></span>; printk(<span class="hljs-string"><span class="hljs-string">"Starting FW module loading\n"</span></span>); ‚Ä¶ accepted_num = <span class="hljs-number"><span class="hljs-number">0</span></span>; dropped_num = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// device functions fw_major = register_chrdev(0, DEVICE_NAME, &amp;fops); if (fw_major &lt; 0) { printk("failed to register device: error %d\n", fw_major); goto failed_chrdevreg; } fw_class = class_create(THIS_MODULE, DEVICE_NAME); if (fw_class == NULL) { printk("failed to register device class '%s'\n", DEVICE_NAME); goto failed_classreg; } fw_device = device_create(fw_class, NULL, MKDEV(fw_major, 0), NULL, DEVICE_FW); if (fw_device == NULL) { printk("failed to create device '%s_%s'\n", DEVICE_NAME, DEVICE_FW); goto failed_devreg; } // netfilter functions ‚Ä¶ return 0; failed_devreg: class_destroy(fw_class); // unregister the device class failed_classreg: unregister_chrdev(fw_major , DEVICE_NAME); // remove the device class failed_classreg: failed_chrdevreg: // unregister the major number failed_chrdevreg: return -1; }</span></span></code> </pre> <br><h3>  User interface </h3><br>  Now we will write a simple program that will read and write to the created device to test the work: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// test.c #include &lt;stdio.h&gt; #include &lt;string.h&gt; #include &lt;fcntl.h&gt; int reset() { char path[] = "/dev/device_fw"; int fd = open(path, O_WRONLY); if (fd&lt;0) { printf("Device access error, fd = %d\n", fd); return fd; } char msg = '1'; write(fd, &amp;msg, sizeof(msg)); close(fd); return 0; } int all_msg() { char msg[1] = {0}; int fd = open("/dev/device_fw", O_RDONLY); if (fd&lt;0) { printf("Device access error, fd = %d\n", fd); return fd; } if(read(fd, &amp;msg, 1)&gt;0){ printf("Accepted packets number: %s\n", msg); } else { printf("Nothing to read\n"); } close(fd); return 0; } int main(int argc, char* argv[]) { if(argc &lt;= 1 || argc &gt; 3) { printf("Wrong number arguments. Number of arguments is %d\n", argc); return -1; } if(strcmp(argv[1], "reset")==0){ reset(); } else if(strcmp(argv[1], "all_msg")==0){ all_msg(); } else { printf("Wrong argument %s\n", argv[1]); } return 0; }</span></span></code> </pre><br>  And check the work: <br><br><img src="https://habrastorage.org/files/678/390/713/67839071328d458dac6a40c3ff1b8f76.png"><br><br>  As you can see above, we first loaded our module.  Then they compiled a program to read / write to the device.  The first time we <i>ran sudo ./test all_msg</i> , we read from the device and got the number 0. After that, we sent a 4 ping request to one of the network devices.  Again, we read, received 16 packets (why not 8m?;).  We executed <i>sudo ./test reset</i> , which addressed the device to the recording, which in turn <i>reset</i> everything. <br><br>  So it looks from the point of view of the driver: <br><br><img src="https://habrastorage.org/files/bdc/f6e/228/bdcf6e2285284eba9fff164e4e953dfc.png"><br><br>  Before we continue, I strongly advise (but not necessarily) to read <a href="http://derekmolloy.ie/writing-a-linux-kernel-module-part-2-a-character-device/">here</a> for deepening.  And also <a href="http://pete.akeo.ie/2011/08/writing-linux-device-driver-for-kernels.html">here</a> .  Below there is a link to a good free book. <br><br><h3>  Introduction to sysfs.  Theory </h3><br>  We could continue the driver-user communication through reading / writing to <i>/ dev / fw_device</i> , but this is not recommended if you need to send / receive a lot of information (unlike the bytes in our example), and this method is also considered obsolete.  And although there are no large volumes in this article, I will show how to use sysfs, for communication <i>kernel &lt;-&gt; user</i> . <br><br>  <i><b>sysfs</b></i> is a virtual file system in the Linux operating system.  Exports Linux kernel information about devices and drivers present on the system into user space.  First appeared in the kernel version 2.6.  The need to create was caused by the outdated system of the kernel with devices. ( <a href="https://ru.wikipedia.org/wiki/Sysfs">Https://ru.wikipedia.org/wiki/Sysfs</a> ) <br><br>  That is, thanks to sysfs, we can create entire structures with a hierarchy of files that will be displayed in <i>/ sys / class / fw</i> and use them for reading or writing.  For example, we will create two files: <br><br>  <i>/ sys / class / fw / acceptedMessages</i> - reading from which will return the number of received packets <br>  <i>/ sys / class / fw / dropedMessages</i> - reading from which will return the number of prohibited packets <br><br>  This is done very simply.  Please note that after calling above: <br><br><pre> <code class="cpp hljs">fw_class = class_create(THIS_MODULE, DEVICE_NAME);</code> </pre> <br>  We have already registered the class and have already seen it in / sys / class.  It remains to add two files and define their functions.  Register files: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">init </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fw_module_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ ‚Ä¶ fw_device = device_create(fw_class, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, MKDEV(fw_major, <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, DEVICE_FW); ‚Ä¶ retval = device_create_file(fw_device, &amp;dev_attr_acceptedMessages); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (retval &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { printk(<span class="hljs-string"><span class="hljs-string">"failed to create acceptedMessages /sys endpoint - continuing without\n"</span></span>); } retval = device_create_file(fw_device, &amp;dev_attr_droppedMessages); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (retval &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { printk(<span class="hljs-string"><span class="hljs-string">"failed to create droppedMessages /sys endpoint - continuing without\n"</span></span>); } ‚Ä¶ }</code> </pre><br>  At the beginning of the module, add the DEVICE_ATTR macros that define read or write, as well as the functions that will be called.  Since we don‚Äôt need to process the record, the last field is NULL. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DEVICE_ATTR</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(acceptedMessages, S_IWOTH | S_IROTH, sys_read_accepted_msg, </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">NULL</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DEVICE_ATTR</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(droppedMessages, S_IWOTH | S_IROTH, sys_read_dropped_msg, </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">NULL</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>;</code> </pre><br>  And the functions themselves: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ssize_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sys_read_accepted_msg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct device *dev, struct device_attribute *attr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buffer)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buffer, <span class="hljs-string"><span class="hljs-string">"%u"</span></span>, accepted_num); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ssize_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sys_read_dropped_msg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct device *dev, struct device_attribute *attr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buffer)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buffer, <span class="hljs-string"><span class="hljs-string">"%u"</span></span>, dropped_num); }</code> </pre> <br>  Accessing them through our user interface is exactly the same as with / dev /.  For example: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dropped_num</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> msg[<span class="hljs-number"><span class="hljs-number">255</span></span>] = {<span class="hljs-number"><span class="hljs-number">0</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fd = open(<span class="hljs-string"><span class="hljs-string">"/sys/class/fw/device_fw/droppedMessages"</span></span>, O_RDONLY); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fd&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"Device access error, fd = %d\n"</span></span>, fd); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fd; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(read(fd, &amp;msg, <span class="hljs-number"><span class="hljs-number">255</span></span>)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>){ <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"Accepted packets number: %s\n"</span></span>, msg); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"Nothing to read\n"</span></span>); } close(fd); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br>  Now is the time to put everything together, compile and thoroughly check. <br>  <i>Sysfs:</i> <br><br><img src="https://habrastorage.org/files/92a/84e/afe/92a84eafe7144012bad4ba9bfe0ae24d.png"><br><br>  <b>Accepted packets:</b> do ping <br><br><img src="https://habrastorage.org/files/2a0/2c5/69f/2a02c569f0be4a4cadd2750e550a0106.png"><br><br>  And in parallel we read <br><br><img src="https://habrastorage.org/files/c64/130/938/c6413093829e4776ad8a10ebe7c69cc6.png"><br><br>  Check for <b>dropped packets</b> : <br>  Trying to ping from <i>host2</i> to <i>host1</i> <br><br><img src="https://habrastorage.org/files/41a/7cb/90d/41a7cb90d4a6469b9482e865d7938f93.png"><br><br>  In parallel, we look at the "logs" <br><br><img src="https://habrastorage.org/files/90b/257/5e5/90b2575e58e44f76b80303dbbeea3eaa.png"><br><br>  By the way, note that here, the counter is constantly increasing by one (and not by two, as before), because <i>host1</i> does not receive requests from <i>host2</i> and accordingly does not respond.  And for the interest of <i>dmesg</i> : <br><br><img src="https://habrastorage.org/files/f4f/d4d/8c0/f4fd4d8c054d457fb4a72c2c38b81727.png"><br><br><img src="https://habrastorage.org/files/13f/2b6/ca9/13f2b6ca965640eebf5dc72c7002a23e.png"><br><br>  Lastly, I will upload fw and check that the network works without it without restrictions: <br><br><img src="https://habrastorage.org/files/9ea/61f/787/9ea61f7874054ff1988325064fe6bd01.png"><br><br><img src="https://habrastorage.org/files/44c/f53/5bf/44cf535bfa6045c481285db3cd118c22.png"><br><br>  We see that without our module, ping passes without problems. <br><br><h3>  Conclusion </h3><br>  In the first part, we first created a virtual network to work with three computers.  Then we looked at writing a simple module that netfilter used to intercept traffic.  And at the end, we added a char device and sysfs, to present the functions of the module in the file system to the average user through reading / writing to files.  At the end we wrote a program for the user to control our device. <br><br>  I would be very happy with any constructive comments.  In the next part, we will significantly expand the functionality of this module, make it more similar to a simple firewall, and also see how it can protect the network from various types of attacks. <br><br>  <b>Links</b> <br><br>  <a href="https://lwn.net/Kernel/LDD3/">Linux Device Drivers, Third Edition</a> <br>  ¬ª <a href="http://derekmolloy.ie/writing-a-linux-kernel-module-part-2-a-character-device/">Http://derekmolloy.ie/writing-a-linux-kernel-module-part-2-a-character-device/</a> <br>  ¬ª <a href="http://pete.akeo.ie/2011/08/writing-linux-device-driver-for-kernels.html">Http://pete.akeo.ie/2011/08/writing-linux-device-driver-for-kernels.html</a> <br>  ¬ª <a href="https://ru.wikipedia.org/wiki/Sysfs">Https://ru.wikipedia.org/wiki/Sysfs</a> <br>  ¬ª <a href="https://en.wikipedia.org/wiki/Device_file">Https://en.wikipedia.org/wiki/Device_file#Character_devices</a> <br>  ¬ª <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BF%25D0%25B0%25D0%25B3%25D0%25B5%25D1%2582%25D1%2582%25D0%25B8-%25D0%25BA%25D0%25BE%25D0%25B4">Spaghetti code</a> </div><p>Source: <a href="https://habr.com/ru/post/315454/">https://habr.com/ru/post/315454/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315442/index.html">Visual Regular Expression Generator</a></li>
<li><a href="../315444/index.html">Visual Studio for Mac and other Connect conference news; // 2016</a></li>
<li><a href="../315448/index.html">GitLab 8.13 release</a></li>
<li><a href="../315450/index.html">The reason for the misunderstanding between us and the misuse of technology. Based on the article "Five Worlds" (software)</a></li>
<li><a href="../315452/index.html">Microsoft has received the status of a platinum member of the Linux Foundation.</a></li>
<li><a href="../315458/index.html">Black Friday - how to avoid falling services?</a></li>
<li><a href="../315460/index.html">Efficient power consumption in Hyper-V infrastructures</a></li>
<li><a href="../315462/index.html">Human factor</a></li>
<li><a href="../315468/index.html">Stripe Service Discovery</a></li>
<li><a href="../315470/index.html">History of programming languages: from BASIC to Visual Basic</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>