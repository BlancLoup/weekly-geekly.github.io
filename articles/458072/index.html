<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PVS-Studio goes to the clouds - launch analysis on Travis CI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the moment, cloud CI-systems are a very demanded service. In this article we will describe how, using existing tools available in PVS-Studio, you c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PVS-Studio goes to the clouds - launch analysis on Travis CI</h1><div class="post__text post__text-html js-mediator-article">  At the moment, cloud CI-systems are a very demanded service.  In this article we will describe how, using existing tools available in PVS-Studio, you can integrate source code analysis with the cloud-based CI platform, using the example of the Travis CI service. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ee1/252/191/ee125219104f0ff7d27f8c9dfc2db8bf.png" alt="Picture 1"></div><br><a name="habracut"></a><br>  Why do we consider third-party clouds and do not make our own?  There are a number of reasons, and the main one is that the SaaS organization is a rather expensive and complicated procedure.  In fact, directly integrating the analysis of PVS-Studio with a third-party cloud platform (be it open platforms like CircleCI, Travis CI, GitLab, or some specialized enterprise solution used only in one particular company) is a rather simple and trivial task.  That is, we can say that <i>PVS-Studio is already available ‚Äúin the clouds‚Äù</i> .  Quite another matter in the organization and provision of infrastructure for such work 24/7.  This is a completely different task, and PVS-Studio has not yet planned to provide its own cloud platform directly for launching analysis on it. <br><br><h2>  Information about the software used </h2><br>  <a href="https://travis-ci.org/">Travis CI</a> is a service for building and testing software that uses GitHub as storage.  Travis CI does not require changing the program code to use the service, all settings occur in the <i>.travis.yml</i> file located in the repository root. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We will take <a href="https://linuxcontainers.org/">LXC</a> (Linux Containers) as a test project for testing with PVS-Studio.  It is an operating system-level virtualization system for running multiple instances of the Linux operating system on a single host. <br><br>  The project is small, but more than enough for demonstration.  The output of the cloc command: <br><div class="scrollable-table"><table><tbody><tr><td>  Language <br></td><td>  files <br></td><td>  blank <br></td><td>  comment <br></td><td>  code <br></td></tr><tr><td>  C <br></td><td>  124 <br></td><td>  11937 <br></td><td>  6758 <br></td><td>  50836 <br></td></tr><tr><td>  C / C ++ Header <br></td><td>  65 <br></td><td>  1117 <br></td><td>  3676 <br></td><td>  3774 <br></td></tr></tbody></table></div>  <b>Note:</b> The LXC developers are already using Travis CI, so we will take their configuration file as a base and edit it for our purposes. <br><br><h2>  Customization </h2><br>  To get started with Travis CI <a href="https://travis-ci.com/">, click on the link</a> and authenticate using a GitHub account. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1ba/8fc/c5a/1ba8fcc5a0caf41da255093cf4feaa8e.png" alt="Picture 17"></div><br>  In the opened window you need to authorize Travis CI. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2d7/aec/13d/2d7aec13dec45022c952ff0498a6acae.png" alt="Picture 16"></div><br>  After authorization is redirected to the welcome page ‚ÄúFirst time here?  Lets get you started! ‚Äù <b>,</b> Which briefly describes what you need to do next to get started: <br><br><ul><li>  activate repositories; </li><li>  add the .travis.yml file to the repository; </li><li>  run the first build. </li></ul><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/29c/17f/c83/29c17fc830db9fad9d6d9dcb7fa047d7.png" alt="Picture 18"></div><br>  Begin to perform these items. <br><br>  To add our repository to Travis CI, go to the profile settings <a href="https://travis-ci.com/account/repositories">by the link</a> and click the ‚ÄúActivate‚Äù button. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ab8/1f7/75e/ab81f775edc51c92b3238bf30b40527d.png" alt="Picture 19"></div><br>  After clicking, a window will open with a selection of repositories to which the Travis CI application will be granted access. <br>  <b>Note:</b> to provide access to the repository, the account must have administrative rights to it. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1e8/4fe/351/1e84fe351a57fcff37b5b70ec77e9cc5.png" alt="Picture 38"></div><br>  Select the desired repository, confirm the selection with the ‚ÄúApprove &amp; Install‚Äù button, and redirect us back to the profile settings page. <br><br>  We will immediately create the variables that we will use to create the analyzer license file and send its reports.  To do this, go to the settings page - the ‚ÄúSettings‚Äù button to the right of the desired repository. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d35/f44/907/d35f449074bd079c1b35140dd8336173.png" alt="Picture 39"></div><br>  The settings window will open. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cfe/c5f/1a8/cfec5f1a8ea19bf2c6e9e63c7af4c68c.png" alt="Picture 41"></div><br>  A brief description of the settings: <br><br><ul><li>  The ‚ÄúGeneral‚Äù section - setting up the task autorun trigger; </li><li>  Section "Auto Cancelation" - allows you to customize the assembly; </li><li>  The ‚ÄúEnvironment Variables‚Äù section allows you to define environment variables containing both public and confidential information, such as credentials, ssh-keys; </li><li>  ‚ÄúCron Jobs‚Äù section - setting up the task launch schedule. </li></ul><br>  In the ‚ÄúEnvironment Variables‚Äù section, we will create the <i>PVS_USERNAME</i> and <i>PVS_KEY variables</i> , containing, respectively, the user name and the license key for the static analyzer.  If you do not have a permanent license of PVS-Studio, then you can <a href="https://www.viva64.com/ru/pvs-studio-download/">request a trial license</a> . <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8aa/731/483/8aa731483fc391273980c7de338f83be.png" alt="Picture 5"></div><br>  Here we will create the variables <i>MAIL_USER</i> and <i>MAIL_PASSWORD</i> containing the username and password from the mailbox, which we will use to send reports. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/37d/a42/9b4/37da429b49812239ab900e3b6fe5a90d.png" alt="Picture 4"></div><br>  When you run the task, Travis CI takes the instructions from the .travis.yml file in the root of the repository. <br><br>  Using Travis CI, we can run static analysis directly in the virtual machine, or use a pre-configured container for this.  The results of these approaches do not differ from each other, but using a pre-configured container can be useful, for example, if we already have a container with some specific environment in which a software product is assembled and tested, and there is no desire to restore this environment in Travis CI . <br><br>  Create a configuration for running the analyzer in a virtual machine. <br><br>  For assembly and testing, we will use a virtual machine based on Ubuntu Trusty, its description can be viewed <a href="https://docs.travis-ci.com/user/reference/trusty/">at the link</a> . <br><br>  First of all, we indicate that the project is written in C and list the compilers that we will use to build: <br><br><pre><code class="cpp hljs">language: c compiler: - gcc - clang</code> </pre> <br>  <b>Note</b> : when specifying more than one compiler, tasks will be run in parallel for each of them.  Read more <a href="https://docs.travis-ci.com/user/build-matrix/">in the documentation</a> . <br><br>  Before we start building, we need to add the analyzer repository, install dependencies and additional packages: <br><br><pre> <code class="cpp hljs">before_install: - sudo add-apt-repository ppa:ubuntu-lxc/daily -y - wget -q -O - https:<span class="hljs-comment"><span class="hljs-comment">//files.viva64.com/etc/pubkey.txt | sudo apt-key add - - sudo wget -O /etc/apt/sources.list.d/viva64.list https://files.viva64.com/etc/viva64.list - sudo apt-get update -qq - sudo apt-get install -qq coccinelle parallel libapparmor-dev libcap-dev libseccomp-dev python3-dev python3-setuptools docbook2x libgnutls-dev libselinux1-dev linux-libc-dev pvs-studio libio-socket-ssl-perl libnet-ssleay-perl sendemail ca-certificates</span></span></code> </pre> <br>  Before building the project, you need to prepare the environment: <br><br><pre> <code class="cpp hljs">script: - ./coccinelle/run-coccinelle.sh -i - git diff --<span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>-code - <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> CFLAGS=<span class="hljs-string"><span class="hljs-string">"-Wall -Werror"</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> LDFLAGS=<span class="hljs-string"><span class="hljs-string">"-pthread -lpthread"</span></span> - ./autogen.sh - rm -Rf build - mkdir build - cd build - ../configure --enable-tests --with-distro=unknown</code> </pre> <br>  Next we need to create a file with the license and run the analysis of the project. <br><br>  The first command is to create a file with a license for the analyzer.  The data for the <i>$ PVS_USERNAME</i> and <i>$ PVS_KEY variables</i> are taken from the project settings. <br><br><pre> <code class="cpp hljs">- pvs-studio-analyzer credentials $PVS_USERNAME $PVS_KEY -o PVS-Studio.lic</code> </pre> <br>  The next command runs the project build trace: <br><br><pre> <code class="cpp hljs">- pvs-studio-analyzer trace -- make -j4</code> </pre> <br>  After we start static analysis. <br>  <b>Note:</b> when using a trial license, you need to specify the <i>--disableLicenseExpirationCheck</i> parameter. <br><br><pre> <code class="cpp hljs"> - pvs-studio-analyzer analyze -j2 -l PVS-Studio.lic -o PVS-Studio-${CC}.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> ‚Äì-disableLicenseExpirationCheck</code> </pre> <br>  With the last command, the file with the results of the analyzer is converted into an html report. <br><br><pre> <code class="cpp hljs">- plog-converter -t html PVS-Studio-${CC}.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> -o PVS-Studio-${CC}.html</code> </pre> <br>  Since TravisCI does not allow changing the format of email notifications, we will use the sendemail package to send reports in the last step: <br><br><pre> <code class="cpp hljs">- sendemail -t mail@domain.com -u <span class="hljs-string"><span class="hljs-string">"PVS-Studio $CC report, commit:$TRAVIS_COMMIT"</span></span> -m <span class="hljs-string"><span class="hljs-string">"PVS-Studio $CC report, commit:$TRAVIS_COMMIT"</span></span> -s smtp.gmail.com:<span class="hljs-number"><span class="hljs-number">587</span></span> -xu $MAIL_USER -xp $MAIL_PASSWORD -o tls=yes -f $MAIL_USER -a PVS-Studio-${CC}.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> PVS-Studio-${CC}.html</code> </pre> <br>  The full text of the configuration file for running the analyzer in a virtual machine: <br><br><pre> <code class="cpp hljs">language: c compiler: - gcc - clang before_install: - sudo add-apt-repository ppa:ubuntu-lxc/daily -y - wget -q -O - https:<span class="hljs-comment"><span class="hljs-comment">//files.viva64.com/etc/pubkey.txt | sudo apt-key add - - sudo wget -O /etc/apt/sources.list.d/viva64.list https://files.viva64.com/etc/viva64.list - sudo apt-get update -qq - sudo apt-get install -qq coccinelle parallel libapparmor-dev libcap-dev libseccomp-dev python3-dev python3-setuptools docbook2x libgnutls-dev libselinux1-dev linux-libc-dev pvs-studio libio-socket-ssl-perl libnet-ssleay-perl sendemail ca-certificates script: - ./coccinelle/run-coccinelle.sh -i - git diff --exit-code - export CFLAGS="-Wall -Werror" - export LDFLAGS="-pthread -lpthread" - ./autogen.sh - rm -Rf build - mkdir build - cd build - ../configure --enable-tests --with-distro=unknown - pvs-studio-analyzer credentials $PVS_USERNAME $PVS_KEY -o PVS-Studio.lic - pvs-studio-analyzer trace -- make -j4 - pvs-studio-analyzer analyze -j2 -l PVS-Studio.lic -o PVS-Studio-${CC}.log --disableLicenseExpirationCheck - plog-converter -t html PVS-Studio-${CC}.log -o PVS-Studio-${CC}.html - sendemail -t mail@domain.com -u "PVS-Studio $CC report, commit:$TRAVIS_COMMIT" -m "PVS-Studio $CC report, commit:$TRAVIS_COMMIT" -s smtp.gmail.com:587 -xu $MAIL_USER -xp $MAIL_PASSWORD -o tls=yes -f $MAIL_USER -a PVS-Studio-${CC}.log PVS-Studio-${CC}.html</span></span></code> </pre> <br>  To run a static analyzer in a container, first create it using the following Dockerfile: <br><br><pre> <code class="cpp hljs">FROM docker.io/ubuntu:trusty ENV CFLAGS=<span class="hljs-string"><span class="hljs-string">"-Wall -Werror"</span></span> ENV LDFLAGS=<span class="hljs-string"><span class="hljs-string">"-pthread -lpthread"</span></span> RUN apt-get update &amp;&amp; apt-get install -y software-properties-common wget \ &amp;&amp; wget -q -O - https:<span class="hljs-comment"><span class="hljs-comment">//files.viva64.com/etc/pubkey.txt | sudo apt-key add - \ &amp;&amp; wget -O /etc/apt/sources.list.d/viva64.list https://files.viva64.com/etc/viva64.list \ &amp;&amp; apt-get update \ &amp;&amp; apt-get install -yqq coccinelle parallel libapparmor-dev libcap-dev libseccomp-dev python3-dev python3-setuptools docbook2x libgnutls-dev libselinux1-dev linux-libc-dev pvs-studio git libtool autotools-dev automake pkg-config clang make libio-socket-ssl-perl libnet-ssleay-perl sendemail ca-certificates \ &amp;&amp; rm -rf /var/lib/apt/lists/*</span></span></code> </pre> <br>  In this case, the configuration file may look like this: <br><br><pre> <code class="cpp hljs">before_install: - docker pull docker.io/oandreev/lxc env: - CC=gcc - CC=clang script: - docker run --rm --cap-add SYS_PTRACE -v $(pwd):/pvs -w /pvs docker.io/oandreev/lxc /bin/bash -c <span class="hljs-string"><span class="hljs-string">" ./coccinelle/run-coccinelle.sh -i &amp;&amp; git diff --exit-code &amp;&amp; ./autogen.sh &amp;&amp; mkdir build &amp;&amp; cd build &amp;&amp; ../configure CC=$CC &amp;&amp; pvs-studio-analyzer credentials $PVS_USERNAME $PVS_KEY -o PVS-Studio.lic &amp;&amp; pvs-studio-analyzer trace -- make -j4 &amp;&amp; pvs-studio-analyzer analyze -j2 -l PVS-Studio.lic -o PVS-Studio-$CC.log --disableLicenseExpirationCheck &amp;&amp; plog-converter -t html -o PVS-Studio-$CC.html PVS-Studio-$CC.log &amp;&amp; sendemail -t mail@domain.com -u 'PVS-Studio $CC report, commit:$TRAVIS_COMMIT' -m 'PVS-Studio $CC report, commit:$TRAVIS_COMMIT' -s smtp.gmail.com:587 -xu $MAIL_USER -xp $MAIL_PASSWORD -o tls=yes -f $MAIL_USER -a PVS-Studio-${CC}.log PVS-Studio-${CC}.html"</span></span></code> </pre> <br>  As you can see, in this case we are not doing anything inside the virtual machine, and absolutely all actions for building and testing a project occur inside the container. <br><br>  <b>Note</b> : when starting the container, it is necessary to specify the <i>--cap-add SYS_PTRACE parameter</i> or <i>--security-opt seccomp: unconfined</i> , since the ptrace system call is used to compile the trace. <br><br>  We load the configuration file into the repository root and see that Travis CI received a notification about the presence of changes in the project and automatically started the build. <br><br>  Detailed information on the assembly and verification by the analyzer can be seen in the console. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/00a/846/95d/00a84695de9e00013c89760219f5292e.png" alt="Picture 2"></div><br>  After the end of the tests, we will receive 2 letters to the post office: one with the results of the static analysis for building the project using gcc, and the second, respectively, with clang. <br><br><h2>  Briefly about the test results </h2><br>  In general, the project is quite clean, the analyzer issued only 24 critical and 46 average warnings.  To demonstrate the work, consider a couple of interesting notifications: <br><br><h3>  Excess Conditions in if </h3><br>  <a href="https://www.viva64.com/ru/w/v590/">V590</a> Consider inspecting the 'ret! = (- 1) &amp;&amp; ret == 1' expression.  The expression is misprint.  attach.c 107 <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> EOF -1 static struct lxc_proc_context_info *lxc_proc_get_context_info(pid_t pid) { .... while (getline(&amp;</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta">, &amp;line_bufsz, proc_file) != -1) { ret = sscanf(</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CapBnd: %llx"</span></span></span><span class="hljs-meta">, &amp;info-&gt;capability_mask); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (ret != EOF &amp;&amp; ret == 1) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// &lt;= { found = true; break; } } .... }</span></span></span></span></code> </pre> <br>  If <i>ret == 1</i> , then it is definitely not equal to -1 (EOF).  Excess check, you can remove <i>ret! = EOF</i> . <br><br>  Two more such warnings were issued: <br><br><ul><li>  V590 Consider inspecting the 'ret! = (- 1) &amp;&amp; ret == 1' expression.  The expression is misprint.  attach.c 579 </li><li>  V590 Consider inspecting the 'ret! = (- 1) &amp;&amp; ret == 1' expression.  The expression is misprint.  attach.c 583 </li></ul><br><h3>  Loss of high bits </h3><br>  <a href="https://www.viva64.com/ru/w/v784/">V784</a> The size of the bit mask is less than the size of the first operand.  This will cause the loss of higher bits.  conf.c 1879 <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mount_opt</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *name; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> clear; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> flag; }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_mntopt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *opt, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *flags, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mount_opt</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mo</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">/* If opt is found in mount_opt, set or clear flags. * Otherwise append it to data. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (mo = &amp;mount_opt[<span class="hljs-number"><span class="hljs-number">0</span></span>]; mo-&gt;name != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; mo++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(opt, mo-&gt;name, <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(mo-&gt;name)) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mo-&gt;clear) { *flags &amp;= ~mo-&gt;flag; <span class="hljs-comment"><span class="hljs-comment">// &lt;= } else { *flags |= mo-&gt;flag; } return; } } .... }</span></span></code> </pre> <br>  Under Linux, <i>long</i> is a 64-bit integer variable, <i>mo-&gt; flag</i> is a 32-bit integer variable.  Using <i>mo-&gt; flag</i> as a bitmask will result in a loss of 32 high-order bits.  Implicit bit-mask conversion to a 64-bit integer variable after bitwise inversion is performed.  The upper bits of this mask will be zero. <br><br>  Let us demonstrate by example: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> y; .... x &amp;= ~y;</code> </pre> <br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1a3/59f/a71/1a359fa7163d8a99c8632ffc17cf7eb0.png" alt="Picture 3"></div><br><br>  The correct code is: <br><br><pre> <code class="cpp hljs">*flags &amp;= ~(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)(mo-&gt;flag);</code> </pre> <br>  The analyzer issued another similar warning: <br><br><ul><li>  V784 The size of the bit mask is less than the size of the first operand.  This will cause the loss of higher bits.  conf.c 1933 </li></ul><br><h3>  Suspicious cycle </h3><br>  <a href="https://www.viva64.com/ru/w/v612/">V612</a> An unconditional 'return' within a loop.  conf.c 3477 <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> lxc_list_for_each(__iterator, __list) \ for (__iterator = (__list)-&gt;next; __iterator != __list; \ __iterator = __iterator-&gt;next) static bool verify_start_hooks(struct lxc_conf *conf) { char path[PATH_MAX]; struct lxc_list *it; lxc_list_for_each (it, &amp;conf-&gt;hooks[LXCHOOK_START]) { int ret; char *hookname = it-&gt;elem; ret = snprintf(path, PATH_MAX, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%s%s"</span></span></span><span class="hljs-meta">, conf-&gt;rootfs.path ? conf-&gt;rootfs.mount : </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">, hookname); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (ret </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; 0 || ret &gt;= PATH_MAX) return false; ret = access(path, X_OK); if (ret &lt; 0) { SYSERROR("Start hook \"%s\" not found in container", hookname); return false; } return true; // &lt;= } return true; }</span></span></span></span></code> </pre> <br>  Launch the loop and interrupt it at the first iteration.  Perhaps it was conceived, but then the cycle can be omitted. <br><br><h3>  Array bounds </h3><br>  <a href="https://www.viva64.com/ru/w/v557/">V557</a> Array underrun is possible.  The value of 'bytes - 1' index could reach -1.  network.c 2570 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lxc_create_network_unpriv_exec</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *lxcpath, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *lxcname, struct lxc_netdev *netdev, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> hooks_version)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bytes; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buffer[PATH_MAX] = {<span class="hljs-number"><span class="hljs-number">0</span></span>}; .... bytes = lxc_read_nointr(pipefd[<span class="hljs-number"><span class="hljs-number">0</span></span>], &amp;buffer, PATH_MAX); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bytes &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { SYSERROR(<span class="hljs-string"><span class="hljs-string">"Failed to read from pipe file descriptor"</span></span>); close(pipefd[<span class="hljs-number"><span class="hljs-number">0</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { buffer[bytes - <span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; } .... }</code> </pre> <br>  From pipe'a read bytes to the buffer.  In case of an error, the <i>lxc_read_nointr</i> function will return a negative value.  If everything went well, then the last element is the zero-terminal.  However, if 0 bytes are read, the buffer will overflow, leading to undefined behavior. <br><br>  The analyzer issued another similar warning: <br><br><ul><li>  V557 Array underrun is possible.  The value of 'bytes - 1' index could reach -1.  network.c 2725 </li></ul><br><h3>  Buffer overflow </h3><br>  <a href="https://www.viva64.com/ru/w/v576/">V576</a> Incorrect format.  Consider checking the sscanf function.  It is dangerous to use string specifier without width specification.  Buffer overflow is possible.  lxc_unshare.c 205 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lookup_user</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *oparg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *uid)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> name[PATH_MAX]; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">sscanf</span></span>(oparg, <span class="hljs-string"><span class="hljs-string">"%u"</span></span>, uid) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* not a uid -- perhaps a username */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">sscanf</span></span>(oparg, <span class="hljs-string"><span class="hljs-string">"%s"</span></span>, name) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">// &lt;= { free(buf); return false; } .... } .... }</span></span></code> </pre> <br>  Using <i>sscanf</i> in this case can be dangerous, because if the length of the <i>oparq</i> buffer is greater than the length of the <i>name</i> buffer, it will <i>overflow</i> when the <i>name</i> buffer is formed. <br><br><h2>  Conclusion </h2><br>  As we have seen, setting up a static code analyzer check of our project in the cloud is a fairly simple task.  To do this, you just need to add one file to the repository and spend the minimum time setting up the CI system.  As a result, we will get a tool that allows you to identify problem code at the writing stage, and does not allow errors to get into the next stages of testing, where fixing them will take more time and resources. <br><br>  Of course, the use of PVS-Studio in conjunction with cloud platforms is not limited to Travis CI only.  By analogy with the method described in the article, with minimal differences, the analysis of PVS-Studio can be integrated with other popular cloud CI solutions, such as CircleCI, GitLab, etc. <br><br><h2>  useful links </h2><br><ul><li>  Additional information about launching PVS-Studio on Linux and MacOS can be found <a href="https://www.viva64.com/ru/m/0036/">here</a> . </li><li>  You can read about the creation, configuration and use of containers with the installed PVS-Studio static analyzer <a href="https://www.viva64.com/ru/m/0047/">here</a> . </li><li>  <a href="https://docs.travis-ci.com/">TravisCI documentation</a> . </li></ul><br><p> <a href="https://habr.com/en/company/pvs-studio/blog/458064/"><img src="https://habrastorage.org/getpro/habr/post_images/898/3b6/5a7/8983b65a74adb29a2113eba12fbec3f1.png" align="left"></a> </p><br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Oleg Andreev.  <a href="https://habr.com/en/company/pvs-studio/blog/458064/">PVS-Studio in the Clouds -Running the Analysis on Travis CI</a> </div><p>Source: <a href="https://habr.com/ru/post/458072/">https://habr.com/ru/post/458072/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../458048/index.html">Delegation as a tool manager</a></li>
<li><a href="../458050/index.html">How did the Mobius 2019 Piter (and a little about the next Mobius)</a></li>
<li><a href="../458052/index.html">AMA with Habr v.10. Last * issue</a></li>
<li><a href="../458062/index.html">UserGate Platform Overview</a></li>
<li><a href="../458070/index.html">PVS-Studio for Visual Studio</a></li>
<li><a href="../458074/index.html">Go language: development, ORM choice</a></li>
<li><a href="../458080/index.html">July 25, Moscow - QIWI iOS Meetup</a></li>
<li><a href="../458084/index.html">50 selected materials about the earnings of musicians, sound in games and movies, unusual instruments and well forgotten old ones</a></li>
<li><a href="../458088/index.html">Best Linux Distributions for Older Computers</a></li>
<li><a href="../45809/index.html">USB to VirtualBox</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>