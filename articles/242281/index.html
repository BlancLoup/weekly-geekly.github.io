<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Change ConcurrentDictionary during iteration</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently decided to deal with the internal device of thread-safe collections, the publication on Habr√© was chosen as the starting point in the study o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Change ConcurrentDictionary during iteration</h1><div class="post__text post__text-html js-mediator-article">  Recently decided to deal with the internal device of thread-safe collections, the <a href="http://habrahabr.ru/post/198104/">publication</a> on Habr√© was chosen as the starting point in the study of the ConcurrentDictionary device.  The principle of its work is described simply and clearly, for which a special thank you to the author. <br><br>  It seemed to me that one moment in the publication was not fully covered and I decided to fill this gap. <br><a name="habracut"></a><br>  Thread-safe collections are designed for use in a multi-threaded environment and should be able to change at any time.  Accordingly, they can be changed even at the time of their search.  From here I had a question, if during the iteration the collection is changed, will the iterator see these changes? <br><br>  Refer to the article above: <br><blockquote>  GetEnumerator - can return old values ‚Äã‚Äãin case changes were made by another thread after calling the method and how the iterator passed this element. </blockquote><br>  Well, it is quite logical that changes to the elements that the iterator has already passed will not be taken into account when searching the collection.  And what will happen if you change the element to which the iterator has not ‚Äúreached‚Äù yet or if you insert a new element into the collection? <br>  Referring to MSDN (the Russian translation of this note is not very well done, so I will also insert a note in the original language): <br><blockquote>  The enumerator returned from the dictionary is safe to use simultaneously with reading from the dictionary and writing to it, however, it does not represent a snapshot of the dictionary.  Content accessible through an enumerator may contain changes made to the dictionary after calling GetEnumerator. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It doesn‚Äôt represent a moment-in-time snapshot of the dictionary.  This is an enumerator. </blockquote><br>  I, as a person with technical education, are confused by the wording ‚Äúmay contain‚Äù.  Those.  may contain, and may not contain?  Let's check: <br><br><pre><code class="hljs cs">ConcurrentDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; dictionary = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); dictionary.TryAdd(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"item0"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> element <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dictionary) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tmp = x++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!dictionary.TryAdd(tmp, <span class="hljs-string"><span class="hljs-string">"item"</span></span> + tmp.ToString())) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"   "</span></span>); } Console.WriteLine(element); }</code> </pre> <br>  What will be displayed in the console?  Will one element or program go into an infinite loop?  Neither one nor the other.  The following will be displayed: <br><br>  [0, item0] <br>  [1, item1] <br>  [2, item2] <br>  [3, item3] <br>  [4, item4] <br>  [5, item5] <br>  [6, item6] <br>  [7, item7] <br>  [8, item8] <br>  [9, item9] <br>  [10, item10] <br>  [11, item11] <br>  [12, item12] <br>  [13, item13] <br>  [14, item14] <br>  [15, item15] <br>  [16, item16] <br><br>  There were no exceptions, respectively, the 18th element was successfully inserted into the collection, but the iterator did not see it, why? <br><br>  Let's take a look at the <a href="http://referencesource.microsoft.com/">sources of</a> this collection, namely the implementation of the GetEnumerator method: <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IEnumerator&lt;KeyValuePair&lt;TKey, TValue&gt;&gt; GetEnumerator() { Node[] buckets = m_tables.m_buckets; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; buckets.Length; i++) { // The <span class="hljs-keyword"><span class="hljs-keyword">Volatile</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Read</span></span> ensures that the <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the fields <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-string"><span class="hljs-string">'current'</span></span> doesn<span class="hljs-string"><span class="hljs-string">'t move before the load from buckets[i]. Node current = Volatile.Read&lt;Node&gt;(ref buckets[i]); while (current != null) { yield return new KeyValuePair&lt;TKey, TValue&gt;(current.m_key, current.m_value); current = current.m_next; } } }</span></span></code> </pre> <br>  The m_tables field is marked with the volatile keyword, so a change in the Node [] m_buckets array it contains is visible to all threads.  Each element of this array represents the first element in a single-linked list and contains a link to the next element in the list.  Further, it is easy to guess that as long as adding / changing elements leads to a change in the simply linked lists themselves, the iterator "sees" these changes, but the changes in the array itself are not visible to the iterator. <br><br>  The m_buckets array is changed in two cases.  The first is to increase the size when inserting elements, the second is to call the Clear () method (resets the size of the array to its default value). <br>  <b>Update:</b> <br>  In order to answer the question when the size of the m_buckets array increases, I will make a small remark about the internal structure of ConcurrentDictionary. <br>  To provide locks for the operations Add / Modify / Remove an item from the collection, there is an array object [] m_locks, its default size is 4 * number of processors (with each increase of m_tables.m_buckets, the size of the array with objects for locks is doubled). <br>  There is also an int m_budget field that defines the maximum number of elements per lock.  It is calculated as follows: m_buckets.Length / m_locks.Length. <br>  The number of items for each lock is contained in the int [] m_countPerLock field, which is incremented when a new item is added to the linked list, and decremented when the item is removed from the list. <br>  Now back to the m_buckets array expansion condition.  <b>It increases after the condition tables.m_countPerLock [lockNo]&gt; m_budget, i.e.</b>  <b>when the number of elements per lock exceeds the maximum allowed number.</b>  It should be noted that this check occurs at the end of the element's insert method, and the size of the internal m_buckets collection will be changed after the current item has been inserted into it. <br>  In my example: I have 4 processors, respectively, the size of the array is m_locks = 16, and m_budget = 31/16 = 1. As soon as we insert the 17th element, now there are 2 elements for one lock and the collection expands. <br>  <b>/ Update</b> <br>  The Update and Remove operations do not change the size of the array and, accordingly, these changes will <b>always</b> be visible to the iterator (of course, if we are talking about changing the element to which the iterator has not ‚Äúreached‚Äù yet). <br><br><h5>  Conclusion </h5><br>  In spite of the fact that we now know when changes made during collection iteration are visible, and when not, you should not take this knowledge into account when programming with ConcurrentDictionary.  It is best to adhere to the rule described on MSDN that the changes made may or may not be visible. </div><p>Source: <a href="https://habr.com/ru/post/242281/">https://habr.com/ru/post/242281/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../242271/index.html">RemoteIE Announcement: We are testing the latest version of Internet Explorer on Windows, Mac OS X, iOS and Android</a></li>
<li><a href="../242273/index.html">Welcome to Moscow Django Meetup and Moscow.pm November 6</a></li>
<li><a href="../242275/index.html">GUI for xdebug trace files</a></li>
<li><a href="../242277/index.html">"Mouse Programming" in Xcode 6 for Swift</a></li>
<li><a href="../242279/index.html">Why the buffer should grow exponentially</a></li>
<li><a href="../242283/index.html">How I encrypt files in the cloud</a></li>
<li><a href="../242285/index.html">Quotient filter</a></li>
<li><a href="../242287/index.html">Why only hard and hardcore</a></li>
<li><a href="../242289/index.html">The Queen of the click: the story of the most outstanding keyboard in history</a></li>
<li><a href="../242293/index.html">Three things forgotten by beginner conversion optimizers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>