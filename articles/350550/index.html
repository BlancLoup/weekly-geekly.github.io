<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Straight DNS: doing the right thing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We present to your attention a very emotional story by Lev Nikolayev ( @maniaque ) about how to configure the DNS, and especially how not to do it. Ri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Straight DNS: doing the right thing</h1><div class="post__text post__text-html js-mediator-article">  We present to your attention a very emotional story by Lev Nikolayev ( <a href="https://habrahabr.ru/users/maniaque/">@maniaque</a> ) about how to configure the DNS, and especially how not to do it.  Right after each point, you can mentally add: ‚ÄúPlease do not do this!‚Äù In his report, Lev says so. <br><br>  The article will consist of three parts: <br><br>  <strong>1. <a href="https://habr.com/ru/company/oleg-bunin/blog/350550/">How to make a resolver (unbound, bind)</a></strong> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A resolver is the thing that you write in the settings of your operating system so that you can turn human-readable addresses like ya.ru into an incomprehensible 87.250.250.242. <br><br>  <strong>2. <a href="https://habr.com/ru/company/oleg-bunin/blog/350550/">How to keep zones (PowerDNS)</a></strong> <br><br>  If you have already grown to this, we will tell you how to keep the zone yourself, how to do it well and fault tolerantly, and how to do it if you have several hundred domains. <br><br>  <strong>3. <a href="https://habr.com/ru/company/oleg-bunin/blog/350550/">How to shake up, but not to mix (PowerDNS + unbound)</a></strong> <br><br><img src="https://habrastorage.org/webt/qh/vc/4_/qhvc4_4ap-vpg4ymcszpgyfvh5e.jpeg"><br><a name="habracut"></a><br>  <strong><em>About the speaker:</em></strong> Three years ago, Lev Nikolaev came to the Maxnet company, in which the DNS was developing just not quite right.  There was bind and text files with zones;  my hands itched to clean up the mess.  The article is based on a report on <a href="http://rootconf.ru/">Root Conf</a> 2017, during which Leo shares his assortment of rakes with the community. <br><a name="bind"></a><br><h2>  Making a resolver </h2><br>  The resolver is needed by those <strong>organizations</strong> that either have no provider resolver, or which it is already beginning to interfere with (so many requests pour in from you that the resolver does not have time to respond or limits you).  From the <strong>data center</strong> or <strong>provider,</strong> in principle, waiting for the presence of its productive resolver. <br><br>  An interesting question for reflection is why, in the standard package of almost any operating system, there is no resolver that can independently perform DNS requests from root servers.  It is completely incomprehensible why my car should always go to someone and ask him to complete a DNS query.  Strangely enough, colleagues from FreeBSD replied that they had something there, that they had unbound out of the box, but the rest of the operating systems did not. <br><br><h2>  Selection of software for resolver </h2><br>  By and large, there are only 2 options: <br><br><ol><li>  You can use <strong>bind</strong> ; </li><li>  You can use <strong>unbound</strong> . </li></ol><br>  In fact, this is almost all that you can really use for serious sales and heavy loads.  I deliberately do not call other options, because not all servers meet the requirements.  If you make a resolver, then automatically assume that you will have a large load, otherwise you would not do it. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/DIHx4qOi5Uc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Regarding the resolver, I'm not trying to persuade you to choose any particular software, because today the <strong>resolver is first of all some realizable features</strong> , and not a specific software.  You can use bind or unbound, or anything else, if it responds to the things I‚Äôll tell you about. <br><br><h2>  Hello ubuntuvodam! </h2><br>  If you like Ubuntu, as we do, and use it in production, you will have to do a little banging.  As you know, unbound should start with the system.  At 16.04, we switched to systemd, but naturally, the unit was forgotten to write.  And when the generator tries to generate it automatically from the SysV script, it turns out a complete disgrace.  Do not try to roll it out in production - I did it and left 30,000 subscribers without DNS for half an hour.  Fortunately, it was at night. <br><br>  Write a unit!  Or <strong>take it from me</strong> , at the end will be the address of the repository.  This applies only to those with Ubuntu, but, for example, something close in Debian should be. <br><br><h2>  What should be in resolver? </h2><br>  5 things to do in your resolver. <br><br>  <strong>1. No forwards to Yandex or Google</strong> <br><br>  This is pretty obvious, so please stop doing that.  Redirecting requests to Google is bad for two reasons.  First, sooner or later you will be limited in terms of the number of requests, which they warn about in advance.  But the most annoying is that <strong>connectivity is not ideal</strong> . <br><br>  Sometimes it happens that even the coveted 4 eights are not available, respectively, you will also have problems.  Absolutely the same applies to Yandex. <br><br>  No, this is not a Google or Yandex problem, their inaccessibility is usually due to the fact that you (or your uplink) dropped the channel to them. <br><br>  <strong>2. SO_REUSEPORT</strong> <br><br>  This option really <strong>speeds up life</strong> , but requires that you have at least a kernel version 3.9.  If among you there are lovers of kernels 2.6.  (my grandmother of RedHat), bury him, please.  The SO_REUSEPORT option allows several processes to bind one port at the same time (they must have the same UID so that the port does not ‚Äúhijack‚Äù), but its pleasures in the other - the load is distributed to these flows <strong>evenly</strong> .  For DNS, this is perfect, and you‚Äôll actually see a performance boost just by going to the modern core. <br><br>  SO_REUSEPORT is both in bind and unbound.  In bind, it is included out of the box, in unbound it must be separately included, because unbound tries to be as compatible as possible, sometimes at the expense of performance. <br><br>  <strong>3. Prefetch</strong> <br><br>  This is a strange option.  It really helps in the sense that it does not respect TTL a little.  When we go to a reputable server and ask him for some kind of record, she has a TTL - this is the time during which you can not go to it for an update.  Unbound and bind follow the updated contents of this record before the TTL really expired. <br><br>  But there are two features.  You will get <strong>a</strong> 10 percent <strong>increase in outgoing traffic</strong> . Although in general, resolvers in general can hardly generate much traffic at all, so this is unlikely to worry you.  The second point - <strong>with short TTL</strong> (for example, per minute) with Prefetch, <strong>no particular benefit</strong> will come out, but since for a ru-segment a short TTL is still fantastic, in principle, it can work perfectly. <br><br>  <strong>4. Expired</strong> <br><br>  I did not find this option in bind, but it is in unbound and allows you to return an expired entry with zero TTL, and in the background it tries to get fresh from reputable servers.  This <strong>helps</strong> well <strong>from major crashes</strong> , for example, users might not even notice the recent fall of Dyn, if this option were massively enabled.  But not everyone knows her, not everyone loves and does not include everything. <br><br>  <strong>5. DNSSEC</strong> <br><br>  DNSSEC is in 2 different guises - simple and complex: <br><br><ul><li>  Simple when you just validate a record if DNSSEC is enabled for the domain. </li><li>  Difficult when you yourself for your domain make a DNSSEC signature, etc. </li></ul><br>  In a simple version, it works automatically.  Simply, if there is DNSSEC, it is necessary to check it, and in case of violations, do not give the result of the query.  This is important today, because TTL records tend to 0, i.e. there is a certain probability of an attempt to poison the DNS cache. <br><br>  As you understand, if we poison the resolver's cache, all its <strong>clients will get a poisoned record</strong> , and many interesting things can be done.  Therefore, please always check DNSSEC if it is in a domain, there is nothing complicated about it and it is done automatically and well. <br><br>  Foreign domains have acquired DNSSEC already well, although the percentage there is also small.  At the same time, many providers in principle do not check DNSSEC, for example, Rostelecom. <br><br>  For a year and a half of this validation, I expected everything from one of our large companies to do with DNSSE, thus breaking our technical support for the British flag, but so far all single hits were on foreign sites with little traffic - everything is fine. <br><br><h2>  Little nothings of life </h2><br>  <strong>1. Stop responding to ANY</strong> <br><br>  If you are doing a resolver, stop responding to ANY requests because this is a kind of request that is not really standardized and is used by 99% of all wonderful viruses. <br><br>  In order not to go down to the software level, you can use iptables, which works fairly quickly: if it sees that the request is ANY, it simply drops it. <br><br> <code>iptables -A INPUT -p udp --dport 53 -m string --hex-string "|0000ff0001|" --algo bm -j DROP <br></code> <br>  <strong>2. Rate-limit</strong> <br><br>  Use the limit on the number of requests per second, if you are not closed from the outside.  For a variety of reasons, my resolver had to be opened to the whole world, so practically the first thing I did was limit the number of requests per second from outside.  If you cannot close your resolver for clients outside, then at least limit them.  Set a limit to taste, for example, I have 70 requests per second. <br><br> <code>[ -j ACCEPT   ,     ] <br> iptables -A INPUT -p udp --dport 53 -m state --state NEW -m recent ‚Ä¶ <br> --set --name DNSQF --rsource <br> --update --seconds 1 --hitcount 70 --name DNSQF --rsource -j DROP <br></code> <br>  <strong>3. For unbound well interface-automatic: yes</strong> <br><br>  The third is a nice little thing.  Usually, not one resolver is made on the network, and sometimes you want to failover between them, but, naturally, not with the help of the resolver itself.  It is necessary to failover to do the routing methods and unbound has a great interface-automatic option: yes.  She says: "If the request came to me in principle, I do not care who it was intended for, I will answer it."  With this option it is very convenient, if necessary, to wrap traffic of a neighboring resolver to unbound. <br><br><h2>  What to monitor? </h2><br>  This is a typical picture with the sale.  We see here that the <strong>number of requests has</strong> reached 300,000 requests, and this is not per minute and not per second, my statistics are taken every 5 minutes, that is, in fact, trifle. <br><br><img src="https://habrastorage.org/webt/7d/f5/nc/7df5ncmv0m-ll-lo7emr5sy8upe.png"><br><br>  Thus, it is absolutely necessary to monitor the number of requests, <strong>since if you cannot measure them, you cannot control them</strong> .  Still need to monitor the <strong>types of requests</strong> .  In the example below you can clearly see: the turquoise stripe is PTR-requests, and you need to understand why there are so many of them and where they come from. <br><br>  Most often, their cause is crookedly configured software, or some router thinks that it needs to urgently make a PTR request for a couple of thousand times. <br><br><img src="https://habrastorage.org/webt/wc/ia/u1/wciau1pylahlyhy0ggtmhf6-wsm.png"><br><br>  This is done quite simply - by cron, you pull unbound statistics, and then from there (we are in Zabbix user-parameter), take what you need. <br><br><img src="https://habrastorage.org/webt/ed/mg/5j/edmg5jrkv_fd4okxsxrpzohonxc.png"><br><br>  <strong>Types of answers</strong> also need to be monitored.  In the picture above, a typical example of DNS Water Torture, that is, a botnet inside your network, asks for non-existent subdomains of the attacked domain.  As a result, he receives the answer Nodata (red color), in the example it reached 25,000 such requests at the peak. <br><br>  The goal is to: hesitate to death the name-server of the attacked domain, so that it is tired to respond and to legitimate requests.  And as soon as you begin to monitor the types of responses, you <strong>begin to see how botnets are active within your network</strong> . <br><br>  Pay attention, and the number of legitimate requests bounces just as well when a red bar appears, that is, here the botnets increase the number of requests 2 times. <br><br>  Another problem is what to do with it later, but this is not today's topic. <br><br><h3>  Your best friend is dnstop </h3><br>  This is a very convenient command to understand who is requesting what, if an attack happened and something went wrong.  Usually, it is run without parameters, but this is wrong. <br><br> <code>dnstop &lt;&gt; -i &lt; ip&gt; <br>    ,    2 <br></code> <br>  I specifically write that we need to <strong>specify our IP address</strong> in order not to take into account in the statistics requests of the resolver itself, which will be many.  Further, in combination, these are magic buttons <strong>with</strong> means to give details on IP addresses, <strong>2</strong> - details up to the 2nd level of domains. <br><br>  So you can easily see who and where goes, and what the attack is now. <br><br><img src="https://habrastorage.org/webt/4y/h6/5n/4yh65ndrva_aq90rcfwuqkvpmy0.png"><br><br><h2>  Rake (sharing my own) </h2><br>  A lot of them.  As soon as you raise the resolver, you will encounter crooked tuned routers or software.  You can get tons of PTR requests.  This happens quite often, and you will see it, be able to correct, understand and make your network better.  A separate moment - this is the perfect <strong>Chinese DVRs</strong> .  For them, I have a special love, like many, probably. <br><br>  The main problem in your network is that your <strong>users do not care a lot about your problems</strong> .  That is, the fact that the user receives parasitic traffic from the DNS Water Torture worries him a little while World of Tanks are working. <br><br>  Now they were talking about the simplest thing - about the resolver, now let's complicate the task. <br><a name="powerdns"></a><br><h2>  Keep the zone </h2><br>  So, we have grown to the fact that we have domains, we want to keep them, to be an authoritative server for them, to give answers. <br><br>  As a rule, they keep zones or organizations with special ambitions: ‚ÄúWe are cool!  We are better able to keep the zones than any Dyn! ‚Äù, Either to the data centers or providers, from which this is again expected by default. <br><br><h2>  No need to combine </h2><br>  The first task is not to combine.  Please do not do this ever!  Although we will find an exception to this rule.  <strong>Combining a resolver and a reputable server on one machine is bad</strong> .  What is the problem, I think you understand.  If the client ‚Äústeals‚Äù the domain from you (i.e., changed the ns server from the registrar) or the domain is rotten (that is, its paid period has expired), you won‚Äôt find out about it at all.  Because you can not make changes locally. <br><br>  We had clients who so believed that if the site opens from within our network, then they don‚Äôt need to renew the domain either.  They have our Internet at home and our Internet at work - everywhere it opens, everything is fine. <br><br><h2>  Choosing software </h2><br>  The main point: do not think that you are choosing software here.  This is a key mistake in the minds of many.  DNS is a database, do not push it into a text file.  Very, very bad, if you use Ansible or chef to generate a text file, which you then insert into bind.  But I know - you do it, and then you tell that it does not work well. <br><br>  So the answer is: <strong>PowerDNS</strong> <br><br>  You know that bind has a patch to work with MySQL, right?  Have you tried it?  Many still do not know about PowerDNS.  Most of them firmly believe that this patch can be somehow used on older versions, but it will work terribly in terms of performance, because this is just a set of crutches. <br><br><h2>  Hello again to ubuntuvodam </h2><br>  If you are using Ubuntu, the alpha version of PowerDNS 4.x is in the standard 16.04 repositories.  I don't know who to say thanks for that.  It really works, but with problems.  Already a year, as I opened to version 4.x issue # 3824.  I ask the developers of PowerDNS: <br><br><blockquote>  - Guys, and nothing, that I restart MySQL, but you have PowerDNS does not pick it up? <br>  - Wow cool! <br></blockquote><br>  Remember this bug, they have already closed 3 times and opened 3 times in the 4th branch.  Therefore - there is the 3rd stable, it does not have these problems, but on Debian / Ubuntu you will need to install it from the deb-file.  And today, in March 2018, it is already unsafe.  Therefore, the only way out is to switch to ppa from the developers for your version of Ubuntu. <br><br><h2>  Thoughtful architecture </h2><br>  This is where the difficult part of the article begins - let's think about architecture.  As soon as we come to PowerDNS, since this is a database, we want a convenient editor on the web.  And there are no editors, except PowerAdmin.  This is a PHP web application, and it‚Äôs immediately clear that the one who will deploy it along with the DNS server needs to be cut off - you cannot put it on the same machine.  As a result, the problem arises: <br><br><ul><li>  There is a database. </li><li>  There is a server that goes to this database to get answers. </li><li>  There are several of these servers. </li><li>  It is necessary to <strong>synchronize everything.</strong> </li></ul><br>  Naturally, first of all, the zone transfer mechanism * XFR comes to mind, i.e. IXFR or AXFR is not important.  But if you leave this mechanism to transfer zones, you are banned.  You will continue to make master / slave - and you will not get away from these concepts. <br><br>  Next, we have several DNS servers and we need to deliver a database to them.  It turns out that there is a machine with PowerAdmin, with the current database, and somehow you need to roll out this database for a bunch of other machines. <br><br><blockquote>  - Let's take, for example, MySQL replication.  They say it works cool! <br>  ‚ÄúShe won't help you either.‚Äù  Replication is not the best friend here. <br></blockquote><br>  Therefore, the scheme looks like this. <br><br><img src="https://habrastorage.org/webt/c1/9j/fd/c19jfd0uv2127ygjl45neojihva.png"><br><br>  You have a server with PowerAdmin and MySQL.  From the DNS server, you go there and do mysqldump with the skip-extended-insert option (we'll talk about it soon) and get the SQL file. <br><br>  You will say: ‚ÄúEka nevidal!  What have we never done? ‚Äù <br><br>  And then the interesting begins.  Naturally, you can not, taking the dump in the database for example 700 domains, load it into the same database.  Therefore, it must be loaded into the next, and then make RENAME TABLE.  You ask - why?  It is <strong>100% atomic</strong> .  RENAME TABLE is an awesome thing that, like renaming a file in Linux, is <strong>either working or not, it does not have an intermediate state</strong> .  It is very convenient and convenient than a transaction, because it is much faster.  After you have successfully downloaded this dump, you put the same file in git.  Since there is a skip-extended-insert option, the file is <strong>git-friendly</strong> , that is, it has one line for each insert, and you get a sane diff. <br><br>  The main thing here is this: I want to be able to see the diff from the results of ‚Äúrolling‚Äù the base. <br><br><h2>  What we get </h2><br><ul><li>  These are very simple operations: 225 lines in PHP in the name of good. </li><li>  Every DNS server does this every 2 minutes.  The clock is synchronized, so you can have any number of servers - they will get the same database. </li><li>  The skip-extended-insert option allows you to do not one big monstrous INSERT, but many small ones. </li></ul><br>  Despite this, it works very quickly and the whole process of sucking a new dump on 700 domains takes just 15 seconds.  Yes, time does not grow in proportion.  That is, if tomorrow you have 1400 domains, it will take 18 seconds, okay. <br><br>  And <strong>forget</strong> about the concept of <strong>master / slave</strong> , in this context it is unimportant. <br><br><h2>  Houston, we have a problem </h2><br>  Everything would be great and wonderful, but we have one problem.  This cool approach works only if we are for the domain in which we do it, both master and slave.  If this is not the case, difficulties begin, which we will now overcome. <br><br>  <strong>Let's redefine the master / slave role</strong> again.  The master sends notifications as soon as the zone has changed, the slave receives these notifications and does something, while both of them respond to requests. <br><br><h2>  There are 2 option <strike>chairs</strike> : </h2><br><ol><li>  The client wants us to keep <strong>a slave</strong> .  That is, the client will keep the master somewhere, and we have to take the data from him.  This is just a difficult option that will require gestures. </li><li>  The client wants us to keep <strong>the master</strong> , and he will be a slave, that is, he will take a copy from us.  This is a simple option, we simply allow the transfer of the zone to the client. </li></ol><br><blockquote>  <strong>Exit</strong> - assign one of the servers (you can 2 - a separate conversation) responsible for receiving * XFR.  This cannot be done by the server with PowerAdmin, since there is no DNS server and there is no one to accept it. </blockquote><br>  The scheme looks like this: <br><br><ul><li>  One of our servers receives * XFR. </li><li>  Makes changes to its base. </li><li>  Rolls in these changes to the server, where there is PowerAdmin. </li></ul><br><img src="https://habrastorage.org/webt/l4/yu/xd/l4yuxdizvjzgxelknfswao2nv7y.png"><br><br>  We can have 2 roles: just a DNS server that is synchronized, or maybe a DNS server with the role of a slave, which accepts * XFR, writes itself to the database, and returns the changes to PowerAdmin, executing another script. <br><br>  I repeat that this scheme is quite simple, it works very well for quite a long time and allows you to completely abandon the concepts of master and slave in general, in principle.  We slave in those cases where we need them to be, and nothing more. <br><br><h2>  What to monitor? </h2><br>  Power DNS is still a separate mechanism that needs to be monitored.  Below are pictures from Zabbix.  We remove <strong>Latency, i.e., how long the response took</strong> in microseconds, and bursts are clearly visible if the machine was busy or the database was inhibited. <br><br><img src="https://habrastorage.org/webt/vo/ro/ye/voroyenxqtjq21a0izujqduzsqo.png"><br><br>  <strong>The protocol</strong> on which the request came also needs to be monitored.  There is not always legitimate TCP, it should also be carefully monitored.  At the same time, you can understand how popular IPv6 is, here it‚Äôs 10% of requests. <br><br><img src="https://habrastorage.org/webt/wk/nd/yr/wkndyrsoolbw1ucmnjjgj6ux9mg.png"><br><br>  <strong>Types of requests</strong> also need to be removed, then you will understand what is happening and see, for example, that requests of the AAAA type, that is, addresses in IPv6 in our situation are almost equal to requests for IPv4. <br><br><img src="https://habrastorage.org/webt/xg/re/cn/xgrecnhokipthuip5qvbfo1gkow.png"><br><br>  Be sure to monitor the sending of <strong>SERVFAIL and broken packages</strong> , and it is convenient to do this on one chart.  If these two numbers match, sleep well.  Do not match - you will see. <br><br><img src="https://habrastorage.org/webt/i5/l9/ua/i5l9uazasmxjgidgvvsvrz3xdxe.png"><br><a name="unbound"></a><br><h2>  Shake but do not mix </h2><br>  Alas, sometimes you have to use a bunch of <strong>PowerDNS + unbound.</strong>  For example, you have a local domain with a cunning structure, which is inconvenient to configure in unbound.  By the way, this is how one of the site blocking mechanisms in Russia works.  The resolver of your provider can return a stub for a ‚Äúbad‚Äù domain, for a good one a normal entry.  In a corporate environment, this is used, for example, to block social networks or protect against viruses. <br><br><h2>  Architecture </h2><br>  The architecture here is painfully simple - it's just a mixture of 2 components that we just talked about.  That is, PowerDNS looks into the light, accepts the request, looks into the database, to the config-file of which there is an option to send the request further to this server (standing on the same unbound machine) if something is not in the database itself.  The only feature is that, within the framework of monitoring, we set up a template Zabbix 2 times for this machine and 2 times more pictures. <br><br><h3>  Contacts </h3><br>  "Repository code - <a href="https://github.com/maniaque/rootconf2017">https://github.com/maniaque/rootconf2017</a> <br>  ¬ªMail - <a href="">nikolaev@kasatkina.org</a> <br>  ¬ªTelegram - <a href="https://t.me/maniaque_ru">@maniaque_ru</a> <br><br><div class="spoiler">  <b class="spoiler_title">Answers and questions</b> <div class="spoiler_text">  <strong>- I would like to hear your advice on how to filter requests of certain types to the server.</strong>  <strong>For example, I want to completely cut off all requests for IPv4 so that they do not reach the server at all.</strong> <br><br>  - These options are in PowerDNS, and unbound.  There is also an option using IPtables, you can use hex match to pull out a piece, watch what requests are there and just drop them completely.  Another option.  There are various DNS proxies, and even the authors of PowerDNS also release their resolver, which supports Lua scripts.  You can slip your script there, which will do any custom magic.  There are various means for this.  It all depends on what your task is. <br><br>  <strong>- Tell me, have you implemented the blocking of banned sites on your network using DNS?</strong>  <strong>Is there approximate statistics?</strong> <br><br>  I will say this, and her too.  How many are blocked?  It is clear that blocking via DNS is from housewives.  It is clear that no one bothers the subscriber to take and drive in the DNS of Google.  Honestly, we do not look at her, but in principle, something falls there. <br><br>  <strong>- And according to the auditors' reports are there any changes after the introduction of the DNS block?</strong> <br><br>  Yes.  For an auditor, this is a great way.  Keep this in mind. <br><br>  <strong>- Do you give IP addresses to your customers who use your DNS?</strong>  <strong>You ensure the availability of these addresses, and how?</strong> <br><br>  Let's briefly tell you how it works.  You remember that we enter 2 addresses there.  You know how funny failover works there.  See, Windows and Linux behave differently.  When the first one is unavailable, Windows switches to the second one and once every 15 minutes tries to still try the first one and, if possible, switches to it.  Linux does not. <br><br>  First, what should be understood?  What failover means by the operating system is not uniform and bad.  Accordingly, your task is to ensure that both IPs that you give up as resolvers are always lit and working.  Since we do this with the help of routing, each of our servers has additional IP addresses to the interface that contain the addresses of its friends.  We have them used 3 and yet enough. <br><br>  Using routing, we send traffic there.  Since we use the ‚Äúanswer on all interfaces‚Äù option in unbound, it responds perfectly, and no additional manipulations are needed. <br><br>  <strong>- You had a sign on transferring MySQL dump from servers to each other.</strong>  <strong>You said that you did not have master / slave and master / master.</strong>  <strong>That is, roughly speaking, do you always change the zone on one of the servers and transfer it to another and the split-brain cannot work in this case?</strong> <br><br>  No, split-brain is possible.  In general, each server runs every 2 minutes makes dump and throws it to him.  But if he did not succeed, then we see a la split-brain, he has an old version of the database. <br><br>  But here the following helps us.  If he could not do this, most likely he has no connectedness.  If there is no connectedness, it means that clients will not get to it either, and the problem will not arise.  As soon as he gets connected, he will very quickly get a new copy. <br><br>  <strong>- No, split-brain in the sense that you changed the record on one of the servers, but not on the other.</strong> <br><br>  Look, on the DNS servers themselves, nothing changes.  Changes in one place where PowerAdmin, and from there rolls out on all the others.  Accordingly, this can not be that we have forgotten to change the base somewhere else.  We did just that to never happen. <br><br>  This was one of our problems when bind with text files.  It was cool to change the zone in one place, then forget to change the serial, but it did not flow to the second with XFR.  It was our pain, which we also eliminated. <br><br>  <strong>- And then there is some statistics on when to stop using XFR ...</strong> <br><br>  XFR is a mechanism that was coined under conditions of poor connectivity.  Relatively speaking, XFR, especially incremental XFR, is designed to save bandwidth.  But in modern realities, the DNS server band is 5 Mb / s, it no longer eats.  Therefore, in my opinion, now XFR is a so-so mechanism.  Therefore, I would, in principle, not recommend looking in his direction.  The guys from Power DNS in the documentation and write that if you can somehow replicate the backend without XFR and other things, do it.  In our case, it turned out great. <br><br>  <strong>- When you told about the situation of setting up an authoritative server, you said that you supposed to forget about Master / slave replication, and we give the same configuration to everything on one server.</strong>  <strong>In this situation, in the SOA record we have some kind of ns server.</strong>  <strong>And how many ns records?</strong>  <strong>That is, if there is no such thing, because there are different DNS checkers for services, whether it is configured correctly or not, it will swear like: ‚ÄúYou have 1 ns server, this is very bad!‚Äù, Etc.</strong>  <strong>Or we will make one ns record by several IP's?</strong> <br><br>  Multiple entries, to be correct.   ,       ,     ns  ,  ‚Äî ,  , , . Ns     ‚Äî .          . <br><br> <strong>‚Äî       PowerDNS   .  4-   PDNSutil edit.     ,      .  save ‚Äî    .</strong> <br><br> <strong>   issue ‚Äî       PowerDNS ‚Äî        .       DNS dist  recursor.    ,  .    , ,     .</strong> <br><br>  3-  . 4-    ,    16.4   .     ¬´,  !¬ª <br><br> <strong>‚Äî .       DNSSEC   ,   !</strong> <br><br>  Thank. <br><br> <strong>‚Äî  ,    ,    .     ,       DNS ‚Äî     ?</strong> <br><br>  DNS  ,         .        Top Level Domain,   TTL ‚Äî   .       ‚Äî    ,     . <br><br> <strong>‚Äî    ,     ns  .ru       ?</strong> <br><br>  Of course.  TTL  ,     .      ‚Äî   .    .    ,        - DNS .      .         . ,      :  , .       . <br><br>      ‚Äî     ,  ¬´   ‚Äî   !¬ª  ,      .   ,        .   ,        .    . <br><br> <strong>‚Äî  Ubuntu, , dnsmasq   .</strong> <br><br> ,   , . dnsmasq  .      .     FreeBSD,   unbound,   local-   .    FreeBSD ‚Äî   . </div></div><br><blockquote>  , ,  ‚Äî   <strong>RootConf</strong>   <a href="http://ritfest.ru/">++</a>   <a href="http://speakers.ritfest.ru/"></a>  <strong>9 </strong> . ,            ,     -. </blockquote></div><p>Source: <a href="https://habr.com/ru/post/350550/">https://habr.com/ru/post/350550/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350538/index.html">Introduction to Gjallarhorn.Bindable.WPF (F #) on the example of the test</a></li>
<li><a href="../350540/index.html">Detective story about RMCP + and OpenSSL, or how Wireshark helped defeat an incorrect argument in OpenIPMI</a></li>
<li><a href="../350542/index.html">Prospects for the development of the video surveillance industry: the capabilities of modern video analytics systems</a></li>
<li><a href="../350544/index.html">Learned helplessness in software development</a></li>
<li><a href="../350546/index.html">FastTrack Training. "Network Basics". "Products in the field of wireless local networks." Eddie Martin December 2012</a></li>
<li><a href="../350552/index.html">Who is the product manager on the project and can it come from the lead developer?</a></li>
<li><a href="../350554/index.html">Lightning network in depth, part 1: payment channels</a></li>
<li><a href="../350556/index.html">How to convince others to respond to letters and become a universal email machine</a></li>
<li><a href="../350558/index.html">Why we put content first</a></li>
<li><a href="../350560/index.html">Asynchronous (self-timed) circuits. Calculation of logical functions directly on the event graph. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>