<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>N5 parallel notes - continue to get acquainted with the designs of OpenMP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I bring to your attention another note on acquaintance with the technology of parallel programming OpenMP . Consider the directives: atomic, reduction...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>N5 parallel notes - continue to get acquainted with the designs of OpenMP</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/313/d92/363/313d9236363444561a81fc44a625579b.png" alt="image"><br>  I bring to your attention another note on acquaintance with the technology of parallel programming <a href="http://software.intel.com/ru-ru/articles/About-OpenMP/">OpenMP</a> .  Consider the directives: atomic, reduction. <br><br><a name="habracut"></a><br><br><h5>  Atomic directive </h5><br>  Consider the code that summarizes the elements of the array: <br><pre>  intptr_t A [1000], sum = 0;
 for (intptr_t i = 0; i &lt;1000; i ++)
   A [i] = i;
 for (intptr_t i = 0; i &lt;1000; i ++)
   sum + = A [i];
 printf ("Sum =% Ii \ n", sum); </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The result of this code is: <br><br><pre>  Sum = 499500
 Press any key to continue.  .  . </pre><br><br>  Let's try to parallelize this code using the directives "omp" and "parallel": <br><br><pre>  #pragma omp parallel for
 for (intptr_t i = 0; i &lt;1000; i ++)
   sum + = A [i]; </pre><br><br>  Unfortunately, such parallelization is incorrect, as in the process of work a <a href="http://www.viva64.com/terminology/Race_condition_rus.html">race condition</a> will arise.  Multiple <a href="http://www.viva64.com/terminology/Thread_Parallel_thread_rus.html">threads</a> will attempt to simultaneously access the sum variable for reading and writing.  The sequence of requests may be as follows: <br><pre> The value of the variable sum = 500;
 The value of i in the first thread = 1;
 The value of i in the second stream = 501;

 Stream 1: processor register = sum
 Stream 2: processor register = sum
 Stream 1: processor register + = i
 Stream 2: processor register + = i
 Stream 2: sum = processor register
 Stream 1: sum = processor register

 The variable value sum = 501, not 1002.
</pre><br><br>  The incorrectness of parallelization can also be seen in practice by running the demo code.  In particular, I received: <br><br><pre>  Sum = 486904
 Press any key to continue.  .  . </pre><br><br>  Critical sections can be used to prevent common variable updating errors.  However, if the variable ‚Äúsum‚Äù is common, and the operator has the form sum = sum + expr, then the more convenient means is the ‚Äúatomic‚Äù directive.  The ‚Äúatomic‚Äù directive works faster than critical sections, since some atomic operations can be directly replaced by processor commands. <br><br>  This directive refers to the assignment operator immediately following it, ensuring correct operation with the common variable on its left-hand side.  At the time the statement is executed, access to this variable is blocked for all threads currently running, except for the thread performing the operation. <br><br>  The atomic directive applies only to operations of the following type: <br><ul><li>  X BINOP = EXPR </li><li>  X ++ </li><li>  ++ X </li><li>  X‚àí‚àí </li><li>  ‚àí‚àíX </li></ul><br>  Here X is a scalar variable, EXPR is an expression with scalar types, in which the variable x is not present, BINOP is not an overloaded operator +, *, -, /, &amp;, ^, |, &lt;&lt;, &gt;&gt;.  In all other cases, the atomic directive cannot be used. <br><br>  The revised code looks like this: <br><br><pre>  #pragma omp parallel for
 for (intptr_t i = 0; i &lt;1000; i ++)
 {
   #pragma omp atomic
   sum + = A [i];
 } </pre><br><br>  This solution gives the correct result, but is extremely inefficient.  The speed of the above code will be lower than the speed of the sequential version.  During the operation of the algorithm, locks will constantly arise, as a result of which almost all the work of the cores will be reduced to waiting.  The atomic directive is used in this example only to demonstrate how it works.  In practice, the use of this directive is rational with a relatively rare reference to common variables.  Example: <br><br><pre>  unsigned count = 0;
 #pragma omp parallel for
 for (intptr_t i = 0; i &lt;N; i ++)
 {
   // Slow function
   if (SlowFunction ())
   {
     #pragma omp atomic
     count ++;
   }
 } </pre><br><br>  It should be remembered that in the expression to which the ‚Äúatomic‚Äù directive is applied, only work with the variable in the left part of the assignment operator is atomic, and the calculations in the right part need not be atomic.  Consider this with an example where the atomic directive does not affect the call of the functions used in the expression: <br><br><pre>  class Example
 {
 public:
   unsigned m_value;
   Example (): m_value (0) {}
   unsigned getValue ()
   {
     return ++ m_value;
   }
   unsigned GetSum ()
   {
     unsigned sum = 0;
     #pragma omp parallel for
     for (ptrdiff_t i = 0; i &lt;100; i ++)
     {
       #pragma omp atomic
       sum + = GetValue ();
     }
     return sum;
   }
 }; </pre><br><br>  This example contains a race condition error, and the value returned to it may vary from run to run.  In the code, the increase in the variable ‚Äúsum‚Äù is protected using the ‚Äúatomic‚Äù directive.  But the ‚Äúatomic‚Äù directive does not affect the call to the GetValue () function.  Calls occur in parallel threads, which leads to errors when executing the "++ m_value" operation inside the GetValue function. <br><br><h5>  Reduction directive </h5><br>  It is logical to ask the question, but how quickly sum up the elements of an array?  The ‚Äúreduction‚Äù directive will help. <br><br>  Directive format: reduction (operator: list) <br><br>  The possible operators are "+", "*", "-", "&amp;", "|", "^", "&amp;&amp;", "||". <br><br>  List - lists common variable names.  Variables must have a scalar type (for example, float, int or long, but not std :: vector, int [], etc.). <br><br>  Principle of operation: <br><ol><li>  Local copies are created for each variable in each stream. </li><li>  Local copies are initialized according to the type of statement.  For additive operations - 0 or its analogues, for multiplicative operations - 1 or its analogues.  See also table N1. </li><li>  The local operator is executed on local copies of variables after all the operators in the parallel domain are executed.  The order of the statements is not defined. </li></ol><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3c2/709/a84/3c2709a840be202943c44144ddc5fc55.png" alt="reduction"></div><br>  Table N1 - reduction operators <br><br>  Now using ‚Äúreduction‚Äù, the effectively working code will look like: <br><br><pre>  #pragma omp parallel for reduction (+: sum)
 for (intptr_t i = 0; i &lt;1000; i ++)
   sum + = A [i]; </pre><br><br>  In the next issue of "Parallel Notes" we will continue ... </div><p>Source: <a href="https://habr.com/ru/post/88574/">https://habr.com/ru/post/88574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../88563/index.html">A file from the Internet in a few seconds? This is real!</a></li>
<li><a href="../88564/index.html">Java EE 6. JPA 2.0 Review, Part 1: Introduction</a></li>
<li><a href="../88566/index.html">Disruption of integument</a></li>
<li><a href="../88569/index.html">IT Songs</a></li>
<li><a href="../88573/index.html">Very correct needle</a></li>
<li><a href="../88576/index.html">Mentioner. The results of the first month of work</a></li>
<li><a href="../88577/index.html">Not a Habrom uniform, or notes</a></li>
<li><a href="../88579/index.html">Windows Live Wave 4 beta leaked to the Internet</a></li>
<li><a href="../88581/index.html">Python, Perl, PHP, Ruby, .NET, Flex, Silverlight - at DEVCONF 2010 May 17 in Moscow (Hello World!)</a></li>
<li><a href="../88583/index.html">Monitoring the temperature in the server drains using SCOM 2007 and Sensatronics Em1, suitable for configuring any devices working on SNMP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>