<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Personal vDisk in Citrix XenDesktop: what is the advantage and how it works</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article was delayed for two years, because it was two years ago that I became acquainted with VDI based on Citrix XenDesktop and the Personal vDi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Personal vDisk in Citrix XenDesktop: what is the advantage and how it works</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/a05/68c/969/a0568c9694af4939aea8fe50decb47e7.jpg" alt="image"></div><br>  This article was delayed for two years, because it was two years ago that I became acquainted with VDI based on Citrix XenDesktop and the <b>Personal vDisk</b> (PvD) feature that was a bit discouraging.  At that time, I was responsible for the <a href="https://habrahabr.ru/post/243413/">VDI</a> infrastructure <a href="https://habrahabr.ru/post/243413/">managed by the Fujitsu PanoLogic product</a> .  Full clones were used, and it was a pain.  Just imagine installing updates on 1000+ virtual machines located on a non-flash array. <br><br>  We were looking at VMware View (now Horizon) with its Linked Clones, but we were very embarrassed by the fact that the update of the base image (Gold Image) brings all the desktops based on it to almost a virgin appearance, depriving the user of lovingly installed applications.  Developers would definitely not be happy, and the rest are accustomed to good. <br><br>  And when we were allowed to play around with Citrix XenDesktop, then another 7.0 or 7.1, I was delighted.  Because when using PvD, all changes made inside the virtual machine were saved even after updating the master image.  And by ‚Äúall‚Äù I mean not only profile settings or documents on the desktop (this is achieved in VMware), but also installed and even remote (!) Applications.  When I shared the results with VMware colleagues from another organization, they said that this was impossible, because it was not explicable. <br><a name="habracut"></a><br>  In practice, of course, miracles rarely occur, and there is an explanation for what is happening. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Both manufacturers of VDI solutions approach differential disk infrastructure implementation in their own way.  With VMware, it looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/472/43e/45b/47243e45bf2e4f57b4d36c09ce2d000d.jpg" alt="image"></div><br>  For obvious reasons, nothing can be written on <b>Replica</b> , the whole record goes to <b>Delta</b> . <br><br>  <b>Internal</b> stores computer identification information (such as an AD password). <br><br>  <b>Persistent Disk</b> can be created for data that must always be stored.  Here you can transfer the profile, Redirected Folders and Home Directory. <br><br>  <b>Disposable Disk</b> , on the contrary, is reset after each reboot.  Here you can transfer data that you do not need to store at all (pagefile, temp) in order to reduce the size of Delta and the load on it. <br><br>  And this is what the XenDesktop picture looks like when using MCS (it is closer to the VMware used than PVS) <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d8e/20c/002/d8e20c00260b45efb69a26793cdc7af2.jpg"></div><br>  <b>Difference</b> - to redirect the record. <br>  <b>Identity</b> - to store the identity of the computer. <br>  <b>PvD</b> - Personal vDisk for storing permanent data.  It looks similar to the VMware Persistent disk.  In the system, it is visible as a P: disk (by default) and if you access it, you will see user data (profile). <br><br>  However, as I already wrote, when using PvD, the virtual machine "remembers" not only user settings and data, but also installed and even remote applications.  Even after updating the master image.  Conducted the following experiments. <br><br><h4>  Software installation </h4><br>  1. Created a master image with Windows 7 (VD-template). <br>  2. Created a virtual desktop based on it (VD01). <br>  3. In the virtual desktop installed 7zip (in C: \ Program Files). <br>  4. Updated the master image (installed Adobe Reader in it) and applied it to the pool. <br>  5. Logged in to VD01.  7zip in place.  And Adobe Reader too. <br>  6. Created a new desktop based on the same master image (VD02).  Adobe Reader is present.  7zip is not. <br><br><h4>  Software removal </h4><br>  1. Logged in to VD01.  Removed Adobe Reader. <br>  2. Updated the master image (installed several Windows updates in the VD-template) and applied it to the pool. <br>  3. Logged in to VD01.  7zip in place, Adobe Reader removed.  Updates are present. <br>  4. In VD02, Adobe Reader is in place.  Updates are present.  7zip is not. <br>  5. Created a new desktop VD03.  The same picture as in VD02. <br><br>  Damn amazing!  It remains to understand how he does it.  Well, I will not beat around the bush and whip up intrigue. <br><br>  Technically, PvD is two disks in one.  The first is what we see in the form of a P drive: inside a virtual desktop.  Profile data is redirected to it, and there is nothing unusual here.  The second is the virtual vhd-disk UserData.vhd, which lies on the first one.  It is also mounted in the system, although it is not visible in the explorer.  And the record is redirected to it at the object (not block) level. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/0a2/f2a/07c/0a2f2a07c1994d1784569fa80a0fe341.png"></div><br>  When first used on PvD, information about objects is copied from the main image, which is located here: C: \ CitrixPvD \ Settings \ Inventory.  Further in Inventory the data about the changes made by the user and links to them are recorded. <br><br>  After updating the master image, before turning it off and removing the snapshot for use in the pool, you need to update the Inventory on it.  If you forget, the system will remind you when you try to turn it off. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d23/d1e/2ac/d23d1e2ac5cf44f1bf0e7a7ebd51c817.jpg"></div><br>  After the distribution of the new master image, virtual desktops re-read the Inventory of the new image when they first start and compare it with the PvD entries.  In the course of this process, it is determined what is new and what should be redirected. <br><br>  This procedure leads to the fact that the first user login to the system after updating the master image can take a long time (10-15 minutes, depending on the number of changes made).  At first, without knowing the details of the operation of this mechanism, I spoiled several desktops, impatiently rebooting them at this moment.  Well, that in a test environment. <br><br>  At the same time, if it turns out that objects previously installed by the user and stored in PvD appeared in the master image, they will be cleaned out of PvD in order to save space, and the links to them will be replaced with those that lead to the main image.  In other words, if I would install 7zip in the master image in the examples above, VD01 would remove it from PvD and start using the one that is common to all.  Subject to the coincidence of versions. <br><br>  I have not tested different versions of scenarios with version conflicts. <br><br><h3>  Some PvD details and limitations. </h3><br><ul><li>  All hypervisors supported by XenDesktop are supported ‚Äî Hyper-V, VMware ESXi, and of course Xen. </li><li>  Only client-side guest operating systems are supported (Windows 7-10). </li><li>  No administrator rights are required to work in the guest OS (although the user will not be able to customize a little without local administrator rights). </li><li>  Cannot be used for software isolation.  For example, it will not work with PvD to launch two different versions of MS Office or Internet Explorer.  To solve this problem, you need to use other technologies.  But if someone needs to use Office 2003 <b><i>instead of the one</i></b> installed in the main image of 2013, then it‚Äôs quite an option. </li><li>  Not compatible with applications using 0-level and network stack drivers (miniports / protocol drivers).  They should be put in the main image. </li><li>  OS updates should also not be installed on PvD to avoid conflicts. </li><li>  With guest OS antivirus, in principle, is compatible, but there may be nuances.  And problems. </li><li>  You should not backup / restore from inside the OS, since the backup agent cannot determine which part of the data belongs to the main image and which part to the PvD.  When recovering, all data will be recorded in PvD, simply because the entire record is redirected there.  Backup and recovery should be done at the hypervisor level and from his side. </li></ul><br><h3>  Management and settings (quite a bit, did not have much practice) </h3><br>  The minimum size of PvD is 3 GB.  The maximum is limited by what the storage system supports. <br><br>  By default, profile data (drive P :) and OS data (UserData.vhd) distribute space utilization on a 50/50 basis.  You can change this ratio by changing the following registry key: <br><blockquote>  HKEY_LOCAL_MACHINE \ Software \ Citrix \ personal vDisk \ Config <br>  Value: PercentOfPvDForApps </blockquote><br>  By default, 50 is set. If corrected to 80, 80% of the space will be reserved for applications, and 20% for profile data. <br><br>  You can generally prevent profile redirection on PvD (for example, if you are using Roaming Profiles): <br><blockquote>  "HKLM \ Software \ Citrix \ personal vDisk \ Configuration" <br>  Value: "EnableUserProfileRedirection" <br>  0: Profile is not directed to the PvD <br>  1: Profile is redirected to the PvD </blockquote><br>  PvD can be reset to its original state either from the Desktop Director, or from the desktop itself using the command: <br><br><pre><code class="dos hljs"><span class="hljs-function"><span class="hljs-function">C:\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Program</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Files</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">citrix</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">personal</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vdisk</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bin</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ctxpvd</span></span></span><span class="hljs-function"> ‚Äì</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reset</span></span></span></span></code> </pre> <br>  (in command line from administrator) <br><br>  Reset does not affect the user profile.  In fact, just UserData.vhd is replaced by the original empty template, taken from here: C: \ ProgramData \ Citrix \ personal vDisk. <br><br>  Finally, a small abstract conclusion.  The error " <i>Failed to load reg hive [\ Device \ IvmVhdDisk00000001 \ CitrixPvD \ Settings \ <b>RingCube</b> .dat].</i> " Suggests that the PvD solution is based on the development of RingCube's <a href="https://en.wikipedia.org/wiki/RingCube_vDesk">vDesk</a> , which was <a href="https://www.crunchbase.com/organization/ringcube-technologies">purchased by</a> Citrix in 2011 for $ 46.67 million. <br><br>  And as a final summary, I note that the decision is, of course, very interesting and makes the life of a VDI administrator much more convenient.  Although it can hardly be considered a panacea - although the support of ‚Äúalmost all standard software‚Äù is claimed, various scenarios need to be checked and possible version conflicts or problems with individual software cannot be ruled out.  And what in our [IT] world can be considered a panacea? <br><br>  As I said, the article was two years late - by the time I found information about the mechanisms of PvD work, I changed jobs and lost the ability to write articles in general, due to the extremely high workload.  During this time, new technologies for connecting custom applications to VDI have appeared - VMware has <a href="https://www.unidesk.com/solutions/citrix-xenapp">applied</a> App Volumes, Citrix has launched <a href="https://www.unidesk.com/solutions/citrix-xenapp">Unidesk</a> ... But these are slightly different stories. <br>  Now I have changed jobs again, moved away from virtualization, but I was tormented by the feeling of an unfinished business ... <br><br>  Thanks for attention!  Even though I closed my own gestalt with this article, I hope that someone else will be useful, or at least interesting. </div><p>Source: <a href="https://habr.com/ru/post/326608/">https://habr.com/ru/post/326608/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326592/index.html">Fat programs - speed factors</a></li>
<li><a href="../326594/index.html">Bash scripts, part 4: input and output</a></li>
<li><a href="../326596/index.html">Exoskeleton do it yourself</a></li>
<li><a href="../326600/index.html">Hello, who is calling or determining the number in Asterisk</a></li>
<li><a href="../326602/index.html">Terrible import kraken - how to use ES6-modules and not go crazy</a></li>
<li><a href="../326610/index.html">Functional components</a></li>
<li><a href="../326612/index.html">The digest of interesting materials for the mobile developer # 199 (April 10-16)</a></li>
<li><a href="../326614/index.html">Simple JDBC Beginner Example</a></li>
<li><a href="../326616/index.html">Fast loading data from files in R</a></li>
<li><a href="../326618/index.html">K-Meleon 76 Pro - a new Russian browser assembly for oldfags and true connoisseurs.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>