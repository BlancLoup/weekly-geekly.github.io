<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Isomorphic JavaScript Applications with Catberry.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="UPD: 
 Time passed ... The framework has evolved and a lot of things from this article are already out of date. 
 But no matter what, fresh material c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Isomorphic JavaScript Applications with Catberry.js</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/635/80d/1f3/63580d1f3304402da4836ce103b81251.png"><br><br>  <b>UPD:</b> <br>  Time passed ... The framework has evolved and a lot of things from this article are already out of date. <br>  But no matter what, fresh material can be found here <a href="http://bit.ly/what-isojs-why-catberry">on these slides</a> , and there is still a <a href="https://youtu.be/tVjf2s_n4_g">video</a> for them. <br><br>  Catberry.js is a framework for developing isomorphic JavaScript applications on node.js using modular architecture and fast rendering mechanisms.  This framework allows you to write an application module once and use it both on the server for rendering pages for search robots, and in the browser for a single-page application, requesting only data for templates. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For the first time I personally saw the term ‚Äúisomorphic applications‚Äù <a href="http://nerds.airbnb.com/isomorphic-javascript-future-web-apps/">on the Airbnb company's blog</a> ; you can <a href="http://habrahabr.ru/post/203444/">read the</a> translation of this article <a href="http://habrahabr.ru/post/203444/">in Habr√©</a> , although this term began to sound a bit earlier, for example, in the <a href="http://blog.nodejitsu.com/scaling-isomorphic-javascript-code/">nodejitsu blog</a> .  Therefore, it is a little difficult to say who invented this, but the fact is that nowadays there is a whole class of web applications that are commonly called isomorphic.  On Habr√©, this term was mainly mentioned in the articles about frameworks from <a href="http://habrahabr.ru/company/swarm/blog/238785/">gritzko</a> and <a href="http://habrahabr.ru/post/206526/">zag2art</a> . <br><br><h4>  What is isomorphic applications? </h4><br>  Seeing this strange name, many developers get scared and try to avoid becoming acquainted with it.  And it‚Äôs in vain, I think, that exactly isomorphic applications are the future (and, maybe, even now) of web applications. <br><br>  No matter how scary it sounds, in fact, everything is quite simple - these are applications that can reuse the server code in the browser and behave in the same way both on the server and in the browser.  In other words, you write once the code of your application and get a server back-end, which renders pages for search robots and responsive one-page application in the browser.  It, in turn, may not load the HTML byte from the server anymore, but only request data for rendering in the browser.  Almost a dream, is not it? <br><br>  The emergence of a class of isomorphic applications is based on the desires of developers, for example: <br><ul><li>  have a modern one-page application that works without reloading the page; </li><li>  do not sacrifice SEO, so that for search robots it would be a regular website that is loaded from the server; </li><li>  do not repeat the page rendering logic twice for the server and the browser; one code must be used for this; </li><li>  in the case of JavaScript applications, this should be a common language environment for the developer ‚Äî no need to spend time on context switches; </li><li>  HTML rendering on the server should occur only at the first load, and then the browser is engaged in rendering, thus we will unload the server; </li><li>  All this should be easy for the developer. </li></ul><br>  Personally, I want all this as much as I do web development, and, obviously, I'm not the only one, as there are already many frameworks for developing isomorphic applications in the world of rainbow, unicorns and isomorphism: <br><ul><li>  <a href="https://github.com/rendrjs/rendr">Rendr</a> (Airbnb); </li><li>  <a href="http://krakenjs.com/">Kraken</a> (PayPal); </li><li>  <a href="https://github.com/yahoo/mojito">Mojito</a> (Yahoo); </li><li>  <a href="https://www.meteor.com/">Meteor</a> ; </li><li>  <a href="http://derbyjs.com/">Derby</a> ; </li><li>  probably another couple dozens of lesser-known solutions. </li></ul><br>  There is also an approach like <a href="http://mean.io/">MEAN</a> (MongoDB + Express + Angular + node.js), which makes Angular applications isomorphic. <br><br><h4>  Why not just take one of them? </h4><br>  When I wanted to start a new web project, I began to study all the existing solutions at that time and saw a number of shortcomings: <br><ul><li>  Some solutions used front-end frameworks for rendering on back-end.  This meant virtualization and building DOM directly on the server, and then rendering it in HTML.  This approach seemed extremely inefficient both in memory and in complexity, which would definitely lead to poor performance.  For example, Rendr uses Backbone, Mojito - YUI, MEAN - Angular. </li><li>  Another disadvantage is dependence on a specific database.  I have nothing against MongoDB and even used it myself several times, but sometimes we need reliability and transactionality, and sometimes the lack of a scheme and speed.  I believe that the developer should not be limited in the choice.  We are talking about Rendr, Meteor, Derby, which are tightly attached to MongoDB, and Derby still requires Redis. </li><li>  Real-time data binding is, of course, a very useful feature for applications such as <a href="http://ru.wikipedia.org/wiki/SCADA">SCADA</a> (APCS) or applications for collaboration on anything.  However, if you need to implement a regular website, as developers do on RoR or a PHP framework, these are unnecessary difficulties. </li></ul><br>  I want to be able to develop isomorphic and simple sites so that they work quickly and simply.  And since my search ended in failure, I realized that it is possible to develop a framework that fills this niche, at least for me. <br><br><h4>  atberry.js </h4><br>  This framework is called Catberry.js, and now it is already in version 3.0.  Not that it is old, but <a href="http://semver.org/">Semantic Versioning 2.0.0 is</a> used for versioning, and the framework has undergone changes a couple of times without backward compatibility.  Catberry is a fairly lightweight framework with its own ideology that says ‚ÄúStorage and data processing should not be part of the Catberry application, it should be done by a separate RESTful service‚Äù. <br><br>  Familiarity with the framework should start with the approach of SMP (Service-Module-Placeholder), which replaces the usual MVC (Model-View-Controller), but I promise it will look familiar.  Again, it‚Äôs worth mentioning that I‚Äôm not against MVC, it‚Äôs very good, but for a certain class of applications where real-time data updating is needed.  The MVC that is used now in the development of web applications is often not what was originally thought of as MVC, but as some kind of interpretation.  So I decided to call my interpretation differently, so as not to confuse my colleagues. <br><br><h4>  Service-Module-Placeholder </h4><br>  As the name implies, the application is built on three components. <br><br><h5>  Service </h5><br>  Service is an external component that is a RESTful service to which our Catberry application constantly refers.  This service can be implemented on absolutely any platform: Erlang, Go, PHP, .NET, whatever.  You are limited to HTTP 1.1 protocol only. <br><br><h5>  Module </h5><br>  A module in the concept of a Catberry application is a logic set that prepares data for a template engine and handles user events.  In other words, if you need to render part of the page, Catberry finds the module responsible for this part of the page and asks him to prepare the data context for the template, taking into account the current state of the entire application (for example, the parameters in the current URL). <br><br><h5>  Placeholder </h5><br>  At first glance, you can say that this is just a template.  In fact, it may have HTML elements that refer to other placeholders, and such links may appear dynamically during rendering, and this will insert another placeholder inside the current one.  For example, the contents of the element placeholder ‚Äúpaw‚Äù of the module ‚Äúcat‚Äù.  Why id is used, you ask?  And in order that placeholders can be very quickly found in the DOM, when rendering works in the browser.  It really saves time. <br><br><h5>  Placeholder to Module </h5><br>  As mentioned, the placeholder is associated with the module, or rather, the module owns a certain set of placeholders, and no one else can belong to these placeholders.  Hence the question may arise: ‚ÄúBut how can you split the application into placeholders and modules?‚Äù.  There are two fairly simple rules: <br><ol><li>  If a section of a web page can be displayed in one request to a RESTful service, then most likely it is a placeholder. </li><li>  If several placeholders depend on the same parameters in the URL and if you change these parameters you need to update them at the same time, then these placeholders should be grouped into one module. </li></ol><br><h5>  Differences from MVC </h5><br>  Probably, one of the readers will surely think: ‚ÄúWhat is the difference from MVC?‚Äù.  If you try, you can say that Service == Model, Controller == Module and View = Placeholder.  But this is exactly what I said earlier, the term MVC in our time is very distorted, and when people interpret it in their own way, they call it MVC.  I found it necessary to specify a different name, because: <br><ul><li>  Service is not part of the application, it is an external application with which the Module communicates via HTTP requests; this cannot be called a Model; </li><li>  as a result, we do not have data storage and processing in a Catberry application, which means there is no Model at all; </li><li>  According to the classic <a href="https://ru.wikipedia.org/wiki/Model-View-Controller">description of MVC</a> with an active model, it should inform all interested View about its changes, as it is done, for example, in Meteor.  There is nothing like that in Catberry. </li><li>  there is also a MVC with a passive model, but in this case, the Controller should track the model changes and update the View, nothing like that in the Catberry either; </li><li>  instead, updates come only from the user‚Äôs actions when he changes the URL or submits the form data.  Of course, no one bothers you to additionally update Placeholder by calling an update request in the Module code, for example, by events or using long-polling.  But the content of the placeholder will depend on the state of the application described in the URL.  This is the meaning of the approach - the ability on the server and in the browser at the URL to fully restore the state of the application in order to render identical pages. </li></ul><br><h4>  How it works </h4><br>  The Catberry application works exactly as I previously described isomorphic applications: <br><ul><li>  First, the user makes a request to the server by URL; </li><li>  server renders the page at the specified URL; </li><li>  the browser version of the application is loaded into the browser along with the page; </li><li>  and then everything works without reloading the page as a one-page application. </li></ul><br>  For a better understanding of the picture <br><div style="text-align:center;"><img src="https://habrastorage.org/files/4e5/461/269/4e54612690364c8cb2acb1545313b70a.png"></div><br><h4>  Stream server rendering </h4><br>  As can be understood from the description and schema, when rendering takes place on the server, to draw each placeholder, you usually need to make a request for a RESTful service.  This may take considerable time for the user.  So that the user does not look at a blank page with a spinning loader while we make requests for all placeholders, a streaming-based rendering engine has been developed.  Its task is to deliver the page to the browser as soon as it is ready.  In other words, as soon as the request to the service to render the page title is completed, the user will immediately see this title in his browser, without waiting for the entire page to be ready. <br><br>  I myself do not like very much when when I open the page for a few seconds I see a white screen and I don‚Äôt even know if my request reached the back-end, or I‚Äôll see ‚Äú504 Gateway Timeout‚Äù now.  Usually I close such sites in 3-4 seconds of a white screen. <br><br>  With streaming rendering, I immediately see the response and the fact that the site works for me, tries and puffs, collecting data for rendering.  Another nice thing is that streaming does not buffer the data in a large amount, which will save the memory of our server with the application.  Well, the most pleasant moment is that the browser, having received the HEAD element that comes from the server almost immediately, starts parsing JavaScript and CSS, and also loads all the resources specified in the page, all this will work in parallel, as in the diagram below. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c88/a50/46f/c88a5046f51347c8869d1a56325e595a.png"></div><br><br><h4>  Parallel browser rendering </h4><br>  Streaming rendering is, of course, good, but only when we are limited to the sequential loading of a page along a stream of a TCP connection.  When we already have a finished page in the browser, and the user clicks on the link, we need to rebuild part of the page for the new state of the application, here we are not limited by anything.  We can execute queries to the RESTful service in parallel, and by the results immediately update the placeholders.  And if inside there are references to others, then again in parallel to request data for them.  This results in an incredibly fast rendering of placeholders in the browser.  In addition, if one of the requests receives a response for a very long time, it will not affect the rendering of the remaining placeholders. <br><br><h4>  Tools for isomorphism </h4><br>  When we develop a web application, we often need to take advantage of actions that depend on the implementation in a particular environment, that is, they work differently in the browser and on the server.  For this, Catberry has isomorphic implementations of such actions.  Outwardly, they work identically, have the same software interface, but internally they are implemented using the tools of the current environment.  Here is a list of such implementations: <br><ul><li>  getting Location; </li><li>  getting Referrer; </li><li>  getting User Agent; </li><li>  cleaning URL fragment (hash); </li><li>  getting or setting cookies; </li><li>  Redirect; </li><li>  HTTP / HTTPS requests; </li><li>  data cache used for the last rendering of each placeholder. </li></ul><br>  It is this API that makes the application isomorphic on Catberry.js. <br><br><h4>  How does the application on the Catberry </h4><br><h5>  Service Locator and DI </h5><br>  The framework architecture is based on the implementation of the patterns <a href="http://en.wikipedia.org/wiki/Service_locator_pattern">Service Locator</a> and <a href="http://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a> . <br><br>  For example, <br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cat = catberry.create(config); <span class="hljs-comment"><span class="hljs-comment">//    cat.locator.register('uhr', UHR); //      cat.locator.registerInstance('uhr', new UHR()); //    cat.locator.resolve('uhr'); //   cat.locator.resolveAll('uhr'); //       cat.locator.resolveInstance(SomeConstructorDependsOnUHR); //      //   : function ModuleConstructor ($uhr, someConfigSection) { //    $uhr //     someConfigSection }</span></span></code> </pre> <br>  Such dependency implementations do not break when minified, as it is done by the framework itself using <a href="https://github.com/mishoo/UglifyJS2">UglifyJS2</a> . <br><br><h5>  How the module is arranged </h5><br>  Each module is a directory with an index.js file that the module constructor must export (the module is a constructor with a declared prototype).  The module can also have a placeholders directory in which the module placeholders templates are located. <br><br><h5>  Methods </h5><br>  Each module can implement three groups of methods: render, handle, and submit.  The naming convention is used here - if your placeholder is called some-awesome-placeholder, then you must implement the renderSomeAwesomePlaceholder method if you want to prepare data for it.  You can and do not implement, nothing will break from this, and the template will be rendered with an empty context, which is also quite acceptable.  This convention applies to the handle / submit methods that process events from the page. <br><br>  An example of the implementation of all three methods: <br><pre> <code class="javascript hljs">ModuleConstructor.prototype.renderSome = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   return {some: data}; //  Promise }; ModuleConstructor.prototype.handleSome = function (event) { // -   // event.args // event.element // event.isEnding // event.isHashChanging //   Promise }; ModuleConstructor.prototype.submitSome = function (event) { //    // event.values // event.element };</span></span></code> </pre><br>  Sometimes it is necessary to bind to DOM elements after the placeholder is rendered, for this are provided after methods, for example, for the renderSome method above: <br><pre> <code class="javascript hljs">ModuleConstructor.prototype.afterRenderSome = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dataContext</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//        };</span></span></code> </pre><br>  You can add such methods also for the handle and submit methods. <br>  An example of the implementation of the module can be found on <a href="">Github</a> . <br><br><h5>  Promises </h5><br>  As mentioned in the examples, everywhere where asynchronous calls are used, <a href="https://www.promisejs.org/">Promises</a> are used in Catberry (there was a great <a href="http://habrahabr.ru/post/242767/">article</a> recently).  And if they <a href="http://caniuse.com/">already exist in the browser</a> , the native implementation will be used, otherwise <a href="https://github.com/then/promise">the polyfill library</a> from one of the authors of the specification will be used.  Type Promise, while available globally, you do not need to connect anything, as if you are working with native promises. <br><br><h4>  Where used </h4><br>  Now based on the framework, the <a href="http://konfettin.ru/">Confettin</a> project site has already been launched, where you can experience the performance and responsiveness of the Catberry-based application.  In addition, the next version of <a href="http://flamp.ru/">Flamp</a> is being developed with might and main, which will see the light in the foreseeable future.  What I personally look forward to. <br><br><h4>  Where to begin </h4><br>  If this rather brief description of the framework interests you, then you can start with these two lines in the terminal: <br><pre> <code class="bash hljs">npm -g install catberry-cli catberry init example</code> </pre><br>  This way you will get the code of the working example that works with the GitHub API and instructions on how to run it.  This example shows typical implementations of things that often have to be done in a web application.  The same <a href="https://github.com/catberry/catberry-cli">CLI-utility</a> can do much more interesting.  For example, create a new project or add a module to the project. <br><br>  If you do not want to install anything on your computer or there is no such possibility, there is the same finished project on <a href="http://runnable.com/U_RHWYh4VjkgAeCl/example-catberry-js-application-that-works-with-github-api">Runnable</a> , but there you can exceed the limit of requests to the GitHub API. <br><br>  Detailed documentation and examples can be <a href="http://catberry.org/">found on the official website</a> . <br>  And, of course, the <a href="https://github.com/catberry/catberry">repository page</a> on GitHub and Twitter account <a href="https://twitter.com/catberryjs">catberryjs</a> , in which there is always the latest news about the framework. </div><p>Source: <a href="https://habr.com/ru/post/242909/">https://habr.com/ru/post/242909/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../242897/index.html">Elastics: a simple ElasticSearch client for Ruby with everything you need</a></li>
<li><a href="../242901/index.html">The introduction of the software product. Features of the business consultant. Part II</a></li>
<li><a href="../242903/index.html">WinJS + universal applications. Learning ListView</a></li>
<li><a href="../242905/index.html">How to install PostgreSQL 9.4 on Raspberry Pi, Radxa or other similar microcomputers running Lubuntu</a></li>
<li><a href="../242907/index.html">"IT" Vitebsk</a></li>
<li><a href="../242911/index.html">We turn html into native components</a></li>
<li><a href="../242915/index.html">About symfony 3.0</a></li>
<li><a href="../242917/index.html">Myself SelfHost server</a></li>
<li><a href="../242919/index.html">How we backed up the client's IT infrastructure in Donetsk</a></li>
<li><a href="../242925/index.html">Course pixel art 4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>