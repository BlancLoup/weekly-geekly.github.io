<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Setting up a Source Source Server for Linux, Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This guide will describe the installation and configuration of simultaneous operation of several dedicated Steam game servers for Linux using the exam...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Setting up a Source Source Server for Linux, Part 1</h1><div class="post__text post__text-html js-mediator-article"><p>  This guide will describe the installation and configuration of simultaneous operation of several dedicated Steam game servers for Linux using the example of Team Fortress 2. </p><br><ul><li>  Introduction </li><li>  Installing Steam Client and Team Fortress 2 Server </li><li>  Basic server setup <br><ul><li>  Theory </li><li>  Practice </li><li>  Network settings </li><li>  Server startup scripts </li></ul></li><li>  Server update <br><ul><li>  Automatic </li><li>  Periodic update </li><li>  Verification only <a name="habracut"></a></li></ul></li></ul><br><h1 id="vvedenie">  Introduction </h1><br><p>  We will need: </p><br><ul><li>  server with a processor, disk and memory, able to pull all the game servers </li><li>  normal channel to the Internet.  Do not dialup.  Not ADSL. </li><li>  installed web server, in our case - nginx </li><li>  installed sql-server, in our case - mysql (mariadb) </li><li>  ability to run tasks on a schedule (cron) </li><li>  php with modules </li><li>  root access in individual configuration steps </li><li>  enough disk space for: <br><ul><li>  game server - over six gigabytes </li><li>  logs (and there will be many and different) </li><li>  records (replay) </li><li>  sql databases </li><li>  custom maps, sounds, models and so on. </li></ul></li></ul><br><p>  All of the following is described in relation to a separate server, physical or virtual, with installed and configured Linux, console access.  In all examples, the server has an ip address of 192.0.2.0, our client computer has 198.51.100.0 </p><br><p>  The game server does not need root privileges to start and work, so we will install and run everything from under the unprivileged game user.  Log in as root and add the user: </p><br><pre><code class="dos hljs"># useradd --user-group --create-home --comment "Source dedicated server" game</code> </pre> <br><p>  Since we will run a number of scripts on a schedule, we‚Äôll check if the game user can create his crontab file: </p><br><pre> <code class="dos hljs"> # su - game $ crontab -e</code> </pre> <br><p>  If the editor window has opened, well, maybe.  If something like this is displayed on the screen: </p><br><pre> <code class="hljs cs"> <span class="hljs-function"><span class="hljs-function">cannot </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chdir</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">/</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">var</span></span></span></span><span class="hljs-function"><span class="hljs-params">/spool/cron</span></span></span><span class="hljs-function">), bailing </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">out</span></span></span><span class="hljs-function">. /</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">var</span></span></span><span class="hljs-function">/spool/cron: Permission denied</span></span></code> </pre> <br><p>  it cannot.  Then, depending on the cron program used and its settings, we allow the user (after leaving the game back to root) to create his crontab file. </p><br><p>  So, the user is created, authorization is configured.  Close the root session, continue to work as a game. </p><br><h1 id="ustanovka-klienta-steam-i-servera-team-fortress-2">  Installing Steam Client and Team Fortress 2 Server </h1><br><p>  Our goal of installing and configuring the simultaneous operation of multiple game servers can be achieved in different ways.  In the simplest case - creating separate instances of servers, each in its own directory.  This, at the cost of inefficient use of disk space (if the file system or data storage does not use deduplication) and the increased consumption of traffic to download the same updates, makes it possible to independently configure, update and manage servers, although using all the same ip address for all game servers different ports.  Another way is to use a single directory for the game, but with individual settings of the game servers.  This way we go. </p><br><p>  If we have a 64-bit distribution of Linux, then you need to install additional compatibility libraries (as root).  What exactly - is googled for the phrase <a href="https://www.google.com/%3Fq%3Dsteamcmd%2Bx64">steamcmd x64 YOUR_DISTRIBUT</a> .  For Ubuntu 13.10 x64, for example, <code>apt-get install lib32gcc1</code> , for ArchLinux - <code>pacman -S lib32-gcc-libs</code> (with the multilib repository enabled in /etc/pacman.conf), for CentOS - <code>yum install glibc.i686 libstdc++.i686</code> and etc. </p><br><p>  If they are not installed, an error of the form will be generated: </p><br><pre> <code class="hljs pgsql"> ./steamcmd.sh: <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">29</span></span>: /home/game/Steam/linux32/steamcmd: <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> such file <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> directory</code> </pre> <br><p>  or </p><br><pre> <code class="hljs pgsql"> ./steamcmd.sh: /home/game/Steam/linux32/steamcmd: /lib/ld-linux.so<span class="hljs-number"><span class="hljs-number">.2</span></span>: bad ELF interpreter: <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> such file <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> directory</code> </pre> <br><p>  We will install the Steam client in the directory of the same name in the user's home directory game, and the game itself in the tf2 directory.  It is assumed that in / etc / fstab the partition with / home is mounted without noexec and there is enough free space. </p><br><p>  Create directories for our servers and go to the first one: </p><br><pre> <code class="bash hljs"> $ mkdir ~/Steam $ mkdir ~/tf2 $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/Steam</code> </pre> <br><p>  Download the <a href="https://developer.valvesoftware.com/wiki/SteamCMD">console client Steam</a> , unpack the archive. </p><br><pre> <code class="bash hljs"> $ wget http://media.steampowered.com/client/steamcmd_linux.tar.gz $ tar -xvzf steamcmd_linux.tar.gz</code> </pre> <br><p>  For greater clarity, we divide the next launch of steamcmd.sh into two.  First, run the self-update procedure: </p><br><pre> <code class="bash hljs"> $ ./steamcmd.sh +quit</code> </pre> <br><p>  Steam client needs to be updated.  In case of any problems, read the logs in ~ / Steam / logs. </p><br><p>  Now install a dedicated game server: </p><br><pre> <code class="bash hljs"> $ ./steamcmd.sh +login anonymous +force_install_dir ~/tf2/ +app_update 232250 validate +quit</code> </pre> <br><p>  The number "232250" in the command line parameters is appid, the application identifier, in our case Team Fortress 2 dedicated server.  More commands are described in the section "Update servers". </p><br><p>  If everything is ok, then the download will start spontaneously: </p><br><pre> <code class="hljs perl"> Redirecting stderr to <span class="hljs-string"><span class="hljs-string">'/home/game/Steam/logs/stderr.txt'</span></span> ... Connecting anonymously to Steam Public...Logged in OK Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> license info...OK Update <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> (<span class="hljs-number"><span class="hljs-number">0x3</span></span>) reconfiguring, progress: <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span> / <span class="hljs-number"><span class="hljs-number">0</span></span>) Update <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> (<span class="hljs-number"><span class="hljs-number">0x11</span></span>) preallocating, progress: <span class="hljs-number"><span class="hljs-number">8.28</span></span> (<span class="hljs-number"><span class="hljs-number">561715882</span></span> / <span class="hljs-number"><span class="hljs-number">6785978023</span></span>) Update <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> (<span class="hljs-number"><span class="hljs-number">0x61</span></span>) downloading, progress: <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">20</span></span> (<span class="hljs-number"><span class="hljs-number">13671159</span></span> / <span class="hljs-number"><span class="hljs-number">6785978023</span></span>) Update <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> (<span class="hljs-number"><span class="hljs-number">0x61</span></span>) downloading, progress: <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">70</span></span> (<span class="hljs-number"><span class="hljs-number">47497460</span></span> / <span class="hljs-number"><span class="hljs-number">6785978023</span></span>) ... Update <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> (<span class="hljs-number"><span class="hljs-number">0x61</span></span>) downloading, progress: <span class="hljs-number"><span class="hljs-number">99.96</span></span> (<span class="hljs-number"><span class="hljs-number">6783415033</span></span> / <span class="hljs-number"><span class="hljs-number">6785978023</span></span>) Update <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> (<span class="hljs-number"><span class="hljs-number">0x81</span></span>) committing, progress: <span class="hljs-number"><span class="hljs-number">7.66</span></span> (<span class="hljs-number"><span class="hljs-number">519615292</span></span> / <span class="hljs-number"><span class="hljs-number">6785978023</span></span>) Success! App <span class="hljs-string"><span class="hljs-string">'232250'</span></span> fully installed.</code> </pre> <br><p>  A few minutes, and we have to download six and a half gigabytes for Team Fortress 2 (as of October 2016). </p><br><p>  Go to the folder ~ / tf2 and try to start the game manually, let's see how it is. </p><br><pre> <code class="bash hljs"> $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/tf2 $ ./srcds_run -game tf +map cp_cloak</code> </pre> <br><p>  On the console should appear something like: </p><br><pre> <code class="hljs sql"> Auto detecting CPU Using default binary: ./srcds_linux Server will auto-restart if there is a crash. WARNING: Failed to <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span> libtinfo.so<span class="hljs-number"><span class="hljs-number">.5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> libncurses.so<span class="hljs-number"><span class="hljs-number">.5</span></span>. Please <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> (lib32tinfo5 / ncurses-libs.i686 / equivalent) <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> readline. <span class="hljs-keyword"><span class="hljs-keyword">Using</span></span> Breakpad minidump system. <span class="hljs-keyword"><span class="hljs-keyword">Version</span></span>: <span class="hljs-number"><span class="hljs-number">3475087</span></span> AppID: <span class="hljs-number"><span class="hljs-number">232250</span></span> Setting breakpad minidump AppID = <span class="hljs-number"><span class="hljs-number">232250</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Using</span></span> breakpad crash <span class="hljs-keyword"><span class="hljs-keyword">handler</span></span> Loaded <span class="hljs-number"><span class="hljs-number">7510</span></span> VPK <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> hashes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> /home/game/tf2/tf/tf2_textures.vpk <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pure <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> operation. ... Network: IP <span class="hljs-number"><span class="hljs-number">192.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">mode</span></span> MP, dedicated Yes, ports <span class="hljs-number"><span class="hljs-number">27015</span></span> SV / <span class="hljs-number"><span class="hljs-number">27005</span></span> CL Initializing Steam libraries <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> secure Internet <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">Connection</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Steam servers successful. <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> IP <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">192.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>. Assigned anonymous gameserver Steam <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> [A:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1724597452</span></span>:<span class="hljs-number"><span class="hljs-number">5521</span></span>]. VAC secure <span class="hljs-keyword"><span class="hljs-keyword">mode</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> activated. Received <span class="hljs-number"><span class="hljs-number">3825164</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> DBDD1115 direct <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> queued.</code> </pre> <br><p>  You can respect the request by installing the ncurses-libs.i686 library.  And the rest is all good.  Make sure that in lines 13 (Network: ...) and 17 (Public IP ...) the server chose the correct IP. </p><br><p>  We don‚Äôt pay attention to errors about "/home/game/.steam/sdk32/steamclient.so: cannot be shared"; this is normal.  However, you can fix it: </p><br><pre> <code class="bash hljs"> $ mkdir -p ~/.steam/sdk32 $ ln -s ~/Steam/linux32/steamclient.so ~/.steam/sdk32</code> </pre> <br><p>  We launch on our computer Team Fortress 2, call the console ( <code>~</code> ), then <code>connect 192.0.2.0:27015</code> (Either immediately steam: //connect/192.0.2.0: 27015 - you can then create a shortcut on the desktop).  We start to connect to the game server, and on the server console at this time a line of the form was displayed </p><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Client</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">Ich</span></span>" <span class="hljs-selector-tag"><span class="hljs-selector-tag">connected</span></span> (198<span class="hljs-selector-class"><span class="hljs-selector-class">.51</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:42380).</span></span></code> </pre> <br><p>  If the connection failed, then we check that the server is listening on the correct interface.  If there is a firewall, we check if the necessary ports are open according to <a href="https://support.steampowered.com/kb_article.php%3Fref%3D8571-GLVN-8711">the Valve manual</a> .  In the case of more complex network configurations (server for NAT, etc.) refer to the relevant manuals. </p><br><p>  We stop the game server with the <code>quit</code> command, typing it into its console, return to the command line and start the configuration. </p><br><h1 id="bazovaya-nastroyka-serverov">  Basic server setup </h1><br><h2 id="teoriya">  Theory </h2><br><p>  Historically, over the years of development, various possibilities have emerged for configuring the server. </p><br><p>  By default, the server uses several basic configuration files that it searches for in ~ / tf2 / tf / cfg /: autoexec.cfg - runs once at server start, server.cfg - when starting any card, &lt;card_name&gt; .cfg - when starting the corresponding cards. </p><br><p>  Also, when you start the server, you can specify the <code>+servercfgfile my.cfg</code> parameter in its command line - the server will no longer use server.cfg but my.cfg, and several parameters like <code>+exec file1.cfg +exec file2.cfg +exec file3.cfg</code> - these files will be executed once at server start, immediately after autoexec.cfg. </p><br><p>  In addition, even before checking the main directory, the server searches for ~ / tf2 / tf / custom files with the extension .vpk and directory structures of the form my_dir / cfg /, my_dir / maps /, my_dir / materials / and the like and files found there uses instead of the standard ones of the same name. </p><br><p>  But that's not all.  In Team Fortress 2 update dated <a href="http://wiki.teamfortress.com/wiki/May_14,_2013_Patch">May 14, 2013,</a> a new command line parameter <code>-insert_search_path</code> .  It serves to add a custom directory structure (similar to custom /), but with the ability to specify an absolute path, that is, not necessarily inside the server directory ~ / tf2 / tf /.  Previously, it had to be clever, but now it is enough to specify -insert_search_path / var / dir1 in the srcds_run command line and this directory will be used as a search path (/ var / dir1 / maps, / var / dir1 / cfg,) before custom / and to the main directory with configuration files ~ / tf2 / tf / cfg /.  In -insert_search_path, you can specify multiple directories separated by commas.  And the directories will be processed in the order in which they are listed, unlike the directory structure in custom /, where they are processed alphabetically. </p><br><p>  That is, if we have several server.cfg files in different directories: </p><br><pre> <code class="hljs ruby"> ~<span class="hljs-regexp"><span class="hljs-regexp">/tf2/tf</span></span><span class="hljs-regexp"><span class="hljs-regexp">/cfg/server</span></span>.cfg ~<span class="hljs-regexp"><span class="hljs-regexp">/tf2/tf</span></span><span class="hljs-regexp"><span class="hljs-regexp">/custom/my</span></span>_files/cfg/server.cfg ~<span class="hljs-regexp"><span class="hljs-regexp">/tf2/tf</span></span><span class="hljs-regexp"><span class="hljs-regexp">/custom/another</span></span><span class="hljs-regexp"><span class="hljs-regexp">/cfg/server</span></span>.cfg /var/dir1/cfg/server.cfg</code> </pre> <br><p>  and in the command line of the server, we also specify <code>-insert_search_path /var/dir1</code> , then when the server is started and when <code>exec server.cfg</code> commands are executed in the console and scripts, this file will first be searched in / var / dir1 / cfg, then in custom / another / cfg /, further in custom / my_files / cfg / (directories in custom / are sorted alphabetically) and finally in the main cfg /.  This applies not only to server.cfg, but also to motd.txt, maps, etc. For more information about search paths, you can read (and pick up the settings) in ~ / tf2 / tf / gameinfo.txt - there are also ways to configure paths from the system language, not covered here and a lot of interesting things. </p><br><p>  It is very simple to look at the sequence of search paths search - just enter the <code>path</code> command in the console of a running server: </p><br><pre> <code class="hljs 1c"> path --------------- Paths: <span class="hljs-string"><span class="hljs-string">"maps/cp_cloak.bsp"</span></span> <span class="hljs-string"><span class="hljs-string">"GAME"</span></span> (map) <span class="hljs-string"><span class="hljs-string">"/home/game/tf2/bin/"</span></span> <span class="hljs-string"><span class="hljs-string">"EXECUTABLE_PATH"</span></span> <span class="hljs-string"><span class="hljs-string">"/home/game/tf2/"</span></span> <span class="hljs-string"><span class="hljs-string">"BASE_PATH"</span></span> <span class="hljs-string"><span class="hljs-string">"/var/dir1/"</span></span> <span class="hljs-string"><span class="hljs-string">"GAME"</span></span> <span class="hljs-string"><span class="hljs-string">"/var/dir1/"</span></span> <span class="hljs-string"><span class="hljs-string">"MOD"</span></span> <span class="hljs-string"><span class="hljs-string">"/home/game/tf2/tf/custom/another/"</span></span> <span class="hljs-string"><span class="hljs-string">"GAME"</span></span> <span class="hljs-string"><span class="hljs-string">"/home/game/tf2/tf/custom/another/"</span></span> <span class="hljs-string"><span class="hljs-string">"MOD"</span></span> <span class="hljs-string"><span class="hljs-string">"/home/game/tf2/tf/custom/my_files/"</span></span> <span class="hljs-string"><span class="hljs-string">"GAME"</span></span> <span class="hljs-string"><span class="hljs-string">"/home/game/tf2/tf/custom/my_files/"</span></span> <span class="hljs-string"><span class="hljs-string">"MOD"</span></span>   , <span class="hljs-keyword"><span class="hljs-keyword"></span></span>, <span class="hljs-keyword"><span class="hljs-keyword"></span></span></code> </pre> <br><p>  Also, do not forget about the configuration files of the form &lt;card name&gt; .cfg.  In addition, there is replay.cfg, sourcemod.cfg, mmm ... yes, thousands of them! </p><br><p>  Such a zoo allows for setting up individual configurations for servers to shoot themselves in a variety of ways.  And since srcds is a young, dynamically developing server, it can deliver quite a lot of fun hours in search of an answer to the question "Why did the players suddenly stop downloading user cards. Even through slow download, not to mention fast ... Everything was fine for two years ... " </p><br><p>  Of the total wealth of choices we have proposed, we will focus on specifying the configuration files in + exec and + servercfgfile in the launch parameters. </p><br><p>  It should be noted that any complete files installed during installation in ~ / tf2 can be changed during the next server update, including files in ~ / tf2 / tf / cfg.  Therefore, we will not directly use the available configuration files, but will begin to create our own, even if based on them. </p><br><p>  That is, instead of using an existing, complete file with a list of maps for rotation, for example, <code>+mapcyclefile mapcycle_quickplay_cp.txt</code> , even if it currently suits us completely, we will copy it into our mapcycle.txt and connect it. </p><br><blockquote>  The complete files that we modified or deleted (not only configurations, but any) can be returned to its original state by running the game server update with the "validate" parameter - <code>steamcmd.sh +login anonymous +force_install_dir ~/tf2/ +app_update 232250 validate +quit</code> .  Then, even if there is no new update for us as such, the checksums of all the complete files will be checked, and, if there is a mismatch, the modified files will be downloaded again. </blockquote><br><h2 id="praktika">  Practice </h2><br><p>  In our example, we will configure two game servers: </p><br><ul><li>  the first is public, with official maps, without modifications. </li><li>  the second is private, with user cards, bots, game-changing modifications.  But with the included Valve Anti-Cheat, of course. </li></ul><br><p>  Create a directory for storing files with server settings.  At the same time make a directory for logs.  At the moment we already have the logs of the Steam client, so immediately make a link there: </p><br><pre> <code class="bash hljs"> $ mkdir ~/cfg $ mkdir ~/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> $ ln -s ~/Steam/logs ~/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/steam</code> </pre> <br><p>  If possible, we will create all configuration files in ~ / cfg and symbolic links in the corresponding directories of the server.  This placement will significantly simplify the backup and restore process of the server, and reduce mixing settings of different servers, although this can not be completely avoided. </p><br><p>  Settings can be grouped into three categories: </p><br><ol><li>  Parameters that must be specified only on the server launch command line.  Example - maxplayers and sv_pure with a value of two </li><li>  Parameters that must be specified before loading the maps - either in autoexec.cfg, or in the + exec file.cfg connected on the command line.  Example - mapcyclefile, motdfile, tv_enable, and a lot of them </li><li>  All others that can be specified in server.cfg and other files. </li></ol><br><p>  But in the command line of the server, you can‚Äôt specify a lot, either due to restrictions on maximum length or for security reasons - if there are no properly tightened nuts, other users on your Linux server with shell access can see each other‚Äôs processes and command lines - <code>cat /proc/&lt;id&gt;/cmdline</code> with such delicate parameters as rcon_password, tf_server <em>identity</em> &lt;...&gt;, sv_setsteamaccount, sv_password and so on. </p><br><p>  Thus, we will first use only five files for our settings - the general settings for both servers in the autoexec.cfg file, the individual settings of the first server are autoexec1.cfg and server1.cfg, the second one is autoexec2.cfg and server2.cfg.  The expediency of dividing individual settings into two files is dictated by the above dividing the parameters into three categories, and the need to use files (such as server.cfg) that are performed each time the map is changed - to restore the settings changed in the individual map settings files, or manually in the console , either by cron, or in any other way.  After all, files like autoexec.cfg are executed only at the start of the game server. </p><br><blockquote>  Not to mention three very useful commands.  The first is <code>echo "- ,    "</code> . <code>echo "- ,    "</code>  When used at the beginning of each configuration file, it allows you to visually see the sequence of execution of various files, in the case of analysis of non-obvious server behavior.  The second one is <code>differences</code> , when entered into the server console, it shows all variables whose values ‚Äã‚Äãare different from the default values.  Facilitates the search for an answer to the question "Why is everything wrong? It seems everything is as always ...".  The third - <code>exec &lt;config&gt;</code> - allows you to call some configuration files from others.  With thoughtful configuration, and in combination with the ability to replace files by cron and together with the ability to run them from scripts (using tmux send-keys - an example in the update.sh script in the section "Updating servers") allows you to turn a game server into a living organism that lives own life. </blockquote><p>  The detailed configuration of the internal configuration of the game server will not be described here - each has its own, let us dwell only on the moments associated with the simultaneous operation of two servers. </p><br><p>  If you already have ready configuration files for a single server, then you can start with them, and if not (well, that's not enough - our first game server), then you can google <a href="https://www.google.com/%3Fq%3D%25D0%25BD%25D0%25B0%25D1%2581%25D1%2582%25D1%2580%25D0%25BE%25D0%25B9%25D0%25BA%25D0%25B0%2Bserver.cfg%2B%25D0%25B4%25D0%25BB%25D1%258F%2Btf2">the server.cfg setting for tf2</a> .  The only thing I can advise is not to look for someone‚Äôs clever configuration file a decade ago, which lists all possible, including already obsolete parameters, the vast majority with default values ‚Äã‚Äãand descriptions taken from the cvarlist, and look for actual and Most documented descriptions, although it may be difficult, yes. </p><br><p>  In general, it is better to start without a ready server.cfg at all - the game server will start fine without it, we have already seen this, but when you want to change something - the number and duration of the rounds, auto-balancing of teams, etc., then you will already recognize write down the parameters that control this. </p><br><p>  If you still want to know the "all-all-all" server-side public commands and variables, then in the console of the running server just enter: </p><br><pre> <code class="hljs delphi"> cvarlist log allcvars.txt <span class="hljs-keyword"><span class="hljs-keyword">cvar</span></span> list -------------- _resetgamestats : cmd : : Erases current game stats <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> writes <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> a blank stats <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> _restart : cmd : : Shutdown <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> restart the engine. ... -------------- <span class="hljs-number"><span class="hljs-number">1908</span></span> total convars/concommands</code> </pre> <br><p>  and in the file ~ / tf2 / tf / allcvars.txt all console variables will be listed, often with brief descriptions.  You can only output commands with a specific prefix, for example, <code>cvarlist tf_</code> , <code>cvarlist sv_</code> .  You can search by the substring - <code>find log</code> .  In this case, the search is performed both by name and by description. </p><br><p>  So, we create our configuration files. </p><br><blockquote>  It should be borne in mind that many teams depend on each other, and in some cases their sequence is important.  So, for example, if you first enable logging to a file (log on), and then start pointing to which directory (sv_logsdir) and under what name (sv_logfilename_format) - the results will not meet expectations. </blockquote><p>  In the file ~ / cfg / autoexec.cfg - it is executed first, we prescribe settings common to both servers: </p><br><div class="spoiler">  <b class="spoiler_title">autoexec.cfg</b> <div class="spoiler_text"><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/     echo "*** ~/cfg</span></span><span class="hljs-regexp"><span class="hljs-regexp">/autoexec.cfg (global)" /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    ,     exec banned_user.cfg exec banned_ip.cfg writeid writeip /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ,    /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ -1 - , 0 -  , 1 -  , 2 -  , 3 - , /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 4 - , 5 - , 6 -  , 7 -  sv_region 3 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/        (1), /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/        (0) sv_log_onefile 0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      sv_logbans 1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     ,   ,   UDP. /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      sv_logfile 1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     sv_logecho 0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    (log on)      /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   -     (sv_logsdir)</span></span></code> </pre> </div></div><br><blockquote>  Log management commands are discussed in more detail in the "Logs" section. </blockquote><p>  Create (for now) empty banned_user.cfg and banned_ip.cfg files </p><br><pre> <code class="bash hljs"> $ touch ~/cfg/banned_user.cfg ~/cfg/banned_ip.cfg</code> </pre> <br><p>  In the file ~ / cfg / autoexec1.cfg we set the settings for the first server: </p><br><div class="spoiler">  <b class="spoiler_title">autoexec1.cfg</b> <div class="spoiler_text"><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/     echo "*** ~/cfg</span></span><span class="hljs-regexp"><span class="hljs-regexp">/autoexec1.cfg" /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  ,          hostname Public Server No 1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    . /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/        rcon_password rconPasswordServer1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  .       /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     .    map cp_granary /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ sv_allow_point_servercommand /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   message of the day motdfile motd1.html motdfile_text motd1.txt /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/       mapcyclefile mapcycle1.txt /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      sv_logsdir /home</span></span><span class="hljs-regexp"><span class="hljs-regexp">/game/log</span></span><span class="hljs-regexp"><span class="hljs-regexp">/server1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    log on</span></span></code> </pre> </div></div><br><p>  About the motd and mapcyclefile files will be mentioned below.  A directory for logs will be created by the server itself. </p><br><p>  And on the second server we install the cp_orange_x3 map, not included in the standard delivery of Team Fortress 2. The easiest way to install custom maps is to put the file with the map in ~ / tf2 / tf / maps, or in a directory in one of the search paths.  But there is another way to connect third-party cards.  If such a map is presented in <a href="https://steamcommunity.com/app/440/workshop/">Steam Workshop</a> , then we can refer to it as to "workshop /", or "workshop / &lt;map name&gt; .ugc" both in the map command and in the mapcycle file.  Then when you start the game, our server downloads it from the Valve servers, and when you connect a player, his computer will download the card from there.  Each time you change the card, it will be checked for updates.  When using non-standard maps only from Steam Workshop, the inclusion of Fast Download becomes unnecessary.  But the reverse side of the coin - there is also a dependence on the Workshop servers. <br></p><p>  So, open the Steam Workshop browser using the link above, in the search bar, enter "cp_orange_x3", in the search results go to the map page - <a href="https://steamcommunity.com/sharedfiles/filedetails/%3Fid%3D454299390">https://steamcommunity.com/sharedfiles/filedetails/?id=454299390</a> .  From this url we take the numeric id and write it in our autoexec2.cfg in the format "workshop / 454299390" or "workshop / cp_orange_x3.ugc454299390".  The second option is clearer. </p><br><p>  In the file ~ / cfg / autoexec2.cfg we set the settings for the second server: </p><br><div class="spoiler">  <b class="spoiler_title">autoexec2.cfg</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">echo "*** ~/cfg/autoexec2.cfg" hostname Private <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> rcon_password rconPasswordServer2 //map workshop/<span class="hljs-number"><span class="hljs-number">454299390</span></span> map workshop/cp_orange_x3.ugc454299390 sv_allow_point_servercommand <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> motdfile "motd2.txt" mapcyclefile "mapcycle2.txt" sv_logsdir /home/game/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/server2 <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span></code> </pre> </div></div><br><p>  Another little moment.  For each map, you can create a file-satellite &lt;map name&gt; .cfg - for commands executed by the server when this map is started, immediately after server.cfg is executed.  For standard maps, the file should be in ~ / tf2 / tf / cfg.     Steam Workshop,       "&lt; &gt;.ugc.cfg"      ~/tf2/tf/cfg/workshop.       ,   ,            Steam Workshop.    cp_orange_x3,   id 454299390,          ~/tf2/tf/cfg/workshop/cp_orange_x3.ugc454299390.cfg <br></p><p>      <a href="https://developer.valvesoftware.com/wiki/Point_servercommand"> </a>        sv_allow_point_servercommand,     "official" ‚Äî Allowed for valve maps only.            "always"  autoexec2.cfg </p><br><blockquote>     -   Steam Workshop,         <code>tf_workshop_map_sync &lt;id &gt;</code> .       ‚Äî        <code>changelevel wohrkshop/&lt;id&gt;</code>       .        <code>tf_workshop_map_status</code> ,     ~/tf2/steamapps/workshop{1,2}/appworkshop_440.acf. </blockquote><p>   ~/cfg/server1.cfg     ,       : </p><br><div class="spoiler"> <b class="spoiler_title">server1.cfg</b> <div class="spoiler_text"><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/     echo "*** ~/cfg</span></span><span class="hljs-regexp"><span class="hljs-regexp">/server1.cfg" /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ***       /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   ,        UDP    HLstatsX /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/        /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    127.0.0.1 (!) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  "log on"  -   (    autoexec1.cfg) logaddress_delall logaddress_add 192.0.2.0:27500 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      (1 - , 0 - ) sv_cheats 0</span></span></code> </pre> </div></div><br><p>    -          HLstatsX (      ‚Äî      ,     )  <code>logaddress_delall</code>  &lt; &gt;.cfg,     - ,    logaddress_add  server1.cfg       .   logaddress_delall  logaddress_add    "logaddress_add: 192.0.2.0:27500 is already in the list" </p><br><p>      ,         sv_cheats  "0" ‚Äî  ,   -  (  , )     "1". </p><br><p>   ~/cfg/server2.cfg      : </p><br><div class="spoiler"> <b class="spoiler_title">server2.cfg</b> <div class="spoiler_text"><pre> <code class="hljs erlang-repl">echo <span class="hljs-string"><span class="hljs-string">"*** ~/cfg/server2.cfg"</span></span> //   -      <span class="hljs-number"><span class="hljs-number">27500</span></span>,   - <span class="hljs-number"><span class="hljs-number">27501</span></span> !!! logaddress_delall logaddress_add <span class="hljs-number"><span class="hljs-number">192.0</span></span>.<span class="hljs-number"><span class="hljs-number">2.0</span></span>:<span class="hljs-number"><span class="hljs-number">27501</span></span> sv_cheats <span class="hljs-number"><span class="hljs-number">0</span></span> tf_bot_quota <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> </div></div><br><p>        .   ,         Control Point,       mapcycle_quickplay_cp.txt,     . </p><br><pre> <code class="bash hljs"> $ cp ~/tf2/tf/cfg/mapcycle_quickplay_cp.txt ~/cfg/mapcycle1.txt $ dos2unix ~/cfg/mapcycle1.txt $ chmod 664 ~/cfg/mapcycle1.txt</code> </pre> <br><p>  ,  ~/cfg/mapcycle1.txt         : </p><br><div class="spoiler"> <b class="spoiler_title">mapcycle1.txt</b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">cp_5gorge</span></span> cp_badlands cp_coldfront cp_fastlane cp_freight_final1 cp_granary cp_well cp_yukon_final cp_foundry cp_gullywash_final1 cp_process_final cp_standin_final cp_snakewater_final1 cp_powerhouse cp_vanguard cp_sunshine cp_metalworks</code> </pre> </div></div><br><p>       ~/cfg/mapcycle2.txt  .  cp_orange_x3     ,    autoexec2.cfg ‚Äî "workshop/454299390",  "workshop/cp_orange_x3.ugc454299390": </p><br><div class="spoiler"> <b class="spoiler_title">mapcycle2.txt</b> <div class="spoiler_text"><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/  cp_orange_x3  https:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/steamcommunity.com/sharedfiles</span></span><span class="hljs-regexp"><span class="hljs-regexp">/filedetails/</span></span>?id=<span class="hljs-number"><span class="hljs-number">454299390</span></span> workshop/cp_orange_x3.ugc45429939<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> </div></div><br><p>       .    ,   html ,    url.       - 1-2 . </p><br><p>     ~/cfg/motd1.html   : </p><br><div class="spoiler"> <b class="spoiler_title">motd1.html</b> <div class="spoiler_text"><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Message of the day<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Welcome to our server!<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><p>    ~/cfg/motd1.txt  ,     html motd (cl_disablehtmlmotd 1): </p><br><div class="spoiler"> <b class="spoiler_title">motd1.txt</b> <div class="spoiler_text"><pre> <code class="hljs kotlin">Welcome! Have <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> and be safe</span></span></code> </pre> </div></div><br><p>     ~/cfg/motd2.txt   url,       motd  : </p><br><div class="spoiler"> <b class="spoiler_title">motd2.txt</b> <div class="spoiler_text"><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">//m.forum.example.org/news.html</span></span></code> </pre> </div></div><br><p>   url    motdfile.    motdfile_text, url     . </p><br><p>         MOTD ‚Äî <a href="http://steamcommunity.com/sharedfiles/filedetails/%3Fid%3D143877817">from Jimo</a> ,   <a href="http://www.specialattack.net/content/how-create-tf2-chalkboard-style-motd-html"> </a> . </p><br><p> ,       ,       cfg  : </p><br><pre> <code class="bash hljs"> $ ln -s -v ~/cfg/* ~/tf2/tf/cfg/</code> </pre> <br><h3 id="setevye-nastroyki">   </h3><br><p>      (      ),       <code>netstat -lpn | grep srcds</code> ,   : </p><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">tcp</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">192.0.2.0:27015</span></span> <span class="hljs-number"><span class="hljs-number">0.0.0.0</span></span>:* LISTEN <span class="hljs-number"><span class="hljs-number">3456</span></span>/./srcds_linux udp <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">192.0.2.0:27005</span></span> <span class="hljs-number"><span class="hljs-number">0.0.0.0</span></span>:* <span class="hljs-number"><span class="hljs-number">3456</span></span>/./srcds_linux udp <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">192.0.2.0:27015</span></span> <span class="hljs-number"><span class="hljs-number">0.0.0.0</span></span>:* <span class="hljs-number"><span class="hljs-number">3456</span></span>/./srcds_linux udp <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">192.0.2.0:27020</span></span> <span class="hljs-number"><span class="hljs-number">0.0.0.0</span></span>:* <span class="hljs-number"><span class="hljs-number">3456</span></span>/./srcds_linux udp <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">192.0.2.0:26901</span></span> <span class="hljs-number"><span class="hljs-number">0.0.0.0</span></span>:* <span class="hljs-number"><span class="hljs-number">3456</span></span>/./srcds_linux</code> </pre> <br><p>      .        srcds: </p><br><p> <code>UDP/27005</code> <br> <code>+clientport</code> ‚Äî Game client port </p><br><p> <code>UDP/27015</code> <br> <code>-port</code> ‚Äî The port the server advertises to clients </p><br><p> <code>TCP/27015</code> <br>    , RCON,    <code>-port</code> ,    TCP.             ssh (  ‚Äî   ),      TCP ( UDP!)  ,      .   ,     .        . </p><br><p> <code>UDP/27020</code> <br> <code>-tv_port</code> ‚Äî SourceTV port (    "SourceTV") </p><br><p> <code>UDP/26901</code> <br> <code>-steamport</code> ‚Äî Steam/VAC connection port </p><br><p>  ,      ,   ,        "-port 27015 -steamport 26900 +clientport 27005 +tv_port 27020".  26900 ‚Äî   ,         . </p><br><p>       .    ,           ,    (27015 -&gt; 27017 -&gt; 27019   ).       .    . </p><br><p>        "-port 27016 -steamport 26901 +clientport 27006 +tv_port 27021". </p><br><p> ,     ,    ,   .    ,       ,       : </p><br><pre> <code class="hljs vhdl"> <span class="hljs-literal"><span class="hljs-literal">WARNING</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Port</span></span> <span class="hljs-number"><span class="hljs-number">27015</span></span> was unavailable - bound <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">port</span></span> <span class="hljs-number"><span class="hljs-number">27016</span></span> instead <span class="hljs-literal"><span class="hljs-literal">WARNING</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Port</span></span> <span class="hljs-number"><span class="hljs-number">27005</span></span> was unavailable - bound <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">port</span></span> <span class="hljs-number"><span class="hljs-number">27006</span></span> instead <span class="hljs-literal"><span class="hljs-literal">WARNING</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Port</span></span> <span class="hljs-number"><span class="hljs-number">27020</span></span> was unavailable - bound <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">port</span></span> <span class="hljs-number"><span class="hljs-number">27021</span></span> instead Network: IP <span class="hljs-number"><span class="hljs-number">192.0</span></span>.<span class="hljs-number"><span class="hljs-number">2.0</span></span>, mode MP, dedicated Yes, ports <span class="hljs-number"><span class="hljs-number">27016</span></span> SV / <span class="hljs-number"><span class="hljs-number">27006</span></span> CL</code> </pre> <br><p>      .            ,      <code>-strictportbind</code> (  ). </p><br><p> ,       ,  "-port 50000 +clientport 50001 +tv_port 50002 -steamport 50003",        ISteamApps/GetServersAtAddress           .        . </p><br><h3 id="skripty-zapuska-servera">    </h3><br><p>          -: </p><br><ol><li>    Steam ‚Äî ~/Steam/steamcmd.sh,    linux32/steamcmd.            ; </li><li>  ,    ‚Äî ~/tf2/srcds_run,      srcds_linux,    . </li></ol><br><p>    ,    / ,      ‚Äî ~/start1.sh  ~/start2.sh.       .   , ~/start1.sh: </p><br><div class="spoiler"> <b class="spoiler_title">start1.sh</b> <div class="spoiler_text"><pre> <code class="hljs tex">#!/bin/sh # #   . #     ,    srcds_run GAMEFOLDER=/home/game/tf2 CMDLINE="-port 27015 -steamport 26900 +clientport 27005 +tv_port 27020 -strictportbind <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>+sv_pure 2 -game tf +maxplayers 24 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>-pidfile <span class="hljs-formula"><span class="hljs-formula">${GAMEFOLDER}/tf/srcds1.pid </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-ugcpath $</span></span>{GAMEFOLDER}/steamapps/workshop1 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>+exec autoexec1.cfg +servercfgfile server1.cfg" #    <span class="hljs-formula"><span class="hljs-formula">${GAMEFOLDER}/srcds_run $</span></span>{CMDLINE}</code> </pre> </div></div><br><p>    (  "-")    (  "+"): </p><br><p> <code>-port</code> <br>   .    ‚Äî 27015.    ,   ,        </p><br><p> <code>-steamport</code> <br>   VAC (Valve Anti-Cheat).       .    26900,    26901 </p><br><p> <code>+clientport</code> <br>     </p><br><p> <code>+tv_port</code> <br>   SourceTV.     ,    +tv_port   -nohltv </p><br><p> <code>-strictportbind</code> <br>    ,        ,      "ERROR: Port 27015 was unavailable ‚Äî quitting due to "-strictportbind" command-line flag!".       . </p><br><p> <code>-ip</code> <br> ip ,    .   - ,  0.0.0.0 ‚Äî  .    ,         ,   ip </p><br><p> <code>-game</code> <br>  .   ‚Äî "tf" ‚Äî Team Fortress 2. </p><br><p> <code>+maxplayers</code> <br>      .       .    ‚Äî 24,     32.  Mann vs. Machine   32 </p><br><p> <code>-pidfile</code> <br>     PID . </p><br><p> <code>-ugcpath</code> <br>      Steam Workshop.   ‚Äî ~/tf2/steamapps/workshop.        ,   ~/tf2/tf.   <a href="http://store.steampowered.com/news/18032/">, </a>   workshop           ,      . </p><br><p> <code>+sv_pure</code> <br>    ‚Äî    ,             ( ,   ,     ).      -1, 0, 1, 2.    sv_pure  0  ,      ,             ( ,  ), , ,    .     pure_server_full.txt, pure_server_minimal.txt  pure_server_whitelist_example.txt  ~/tf2/tf/cfg/.     ‚Äî <code>sv_pure 2</code> ,       srcds_run,       ,        .vpk . </p><br><p> <code>+exec</code> <br>  ,         autoexec.cfg.    . </p><br><p> <code>+servercfgfile</code> <br>  ,     server.cfg ‚Äî    ,       </p><br><p> <code>+map</code> <br>   ( ).    ,       autoexec.cfg ( server.cfg !).     ,     .         .     ,      autoexec.cfg </p><br><p>        <a href="https://developer.valvesoftware.com/wiki/Command_Line_Options">Valve Developer Community wiki</a> </p><br><p>    ~/start2.sh,  CMDLINE (        ), . </p><br><div class="spoiler"> <b class="spoiler_title">start2.sh</b> <div class="spoiler_text"><pre> <code class="hljs tex">#!/bin/sh #   . GAMEFOLDER=/home/game/tf2 CMDLINE="-port 27016 -steamport 26901 +clientport 27006 +tv_port 27021 -strictportbind <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>+sv_pure 2 -game tf +maxplayers 24 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>-pidfile <span class="hljs-formula"><span class="hljs-formula">${GAMEFOLDER}/tf/srcds2.pid </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-ugcpath $</span></span>{GAMEFOLDER}/steamapps/workshop2 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>+exec autoexec2.cfg +servercfgfile server2.cfg" #    <span class="hljs-formula"><span class="hljs-formula">${GAMEFOLDER}/srcds_run $</span></span>{CMDLINE}</code> </pre> </div></div><br><p>    </p><br><pre> <code class="bash hljs"> $ chmod u+x ~/start{1,2}.sh</code> </pre> <br><p>     (-  game,  root !),   -.      : </p><br><pre> <code class="hljs delphi"> ... *** ~/cfg/autoexec.cfg (global) Writing cfg/banned_user.cfg. Writing cfg/banned_ip.cfg. -------------------------------------------------------- sv_pure <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>. -------------------------------------------------------- maxplayers <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> *** ~/cfg/autoexec1.cfg Server logging enabled. Server logging data <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> /home/game/log/server1/L1007000.log ... Executing dedicated server config <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> server1.cfg Using map cycle <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-string"><span class="hljs-string">'cfg/mapcycle1.txt'</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> motd from <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-string"><span class="hljs-string">'cfg/motd1.html'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> motd_text from <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-string"><span class="hljs-string">'cfg/motd1.txt'</span></span> Connection <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> game coordinator established. tf_server_identity_account_id <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> logging into registered account *** ~/cfg/server1.cfg logaddress_delall: no addresses <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the list logaddress_add: <span class="hljs-number"><span class="hljs-number">192.0</span></span>.<span class="hljs-number"><span class="hljs-number">2.0</span></span>:<span class="hljs-number"><span class="hljs-number">27500</span></span> <span class="hljs-string"><span class="hljs-string">'cp_granary.cfg'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> present; <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> executing. Connection <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Steam servers successful. ...</code> </pre> <br><p> , ,    .      .     ,      L1007000.log,       l1007000.log.       ‚Äî   Linux  ! ,   ‚Äî  .      .    ‚Äî  . </p><br><p>     , ,       . </p><br><pre> <code class="hljs vhdl"> ... *** ~/cfg/autoexec2.cfg ... [TF Workshop] Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> steam connection [TF Workshop] Preparing <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> ID <span class="hljs-number"><span class="hljs-number">454299390</span></span> [TF Workshop] <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> ID <span class="hljs-number"><span class="hljs-number">454299390</span></span> isn<span class="hljs-symbol"><span class="hljs-symbol">'t</span></span> tracked, adding ... [TF Workshop] <span class="hljs-keyword"><span class="hljs-keyword">New</span></span> version available <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>, download queued [ workshop/cp_orange_x3.ugc454299390 ] ... [TF Workshop] Installed subscribed <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> [ workshop/cp_orange_x3.ugc454299390 ] [TF Workshop] Successfully prepared client <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> from workshop [ workshop/cp_orange_x3.ugc454299390 ] ... <span class="hljs-symbol"><span class="hljs-symbol">'workshop</span></span>/cp_orange_x3.ugc454299390.cfg' <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> present; <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> executing. ...</code> </pre> <br><p> , .      Steam Workshop   ~/tf2/steamapps/workshop2,       ~/tf2/steamapps/workshop2/content/440/454299390/cp_orange_x3.bsp.   , "[ workshop/cp_orange_x3.ugc454299390 ]" ‚Äî     ,   .   ,    autoexec2.cfg </p><br><p>      Team Fortress 2, "Find a game" ‚Äî "Community servers" ‚Äî "" ‚Äî "" ‚Äî  ip   "192.0.2.0" ‚Äî "    " ‚Äî    .  :-).    . </p><br><p>  ,        - Valve    Web API,       ip   <a href="http://api.steampowered.com/ISteamApps/GetServersAtAddress/v0001%3Faddr%3D192.0.2.0">http://api.steampowered.com/ISteamApps/GetServersAtAddress/v0001?addr=192.0.2.0</a> ‚Äî      source    ,   Team Fortress 2 </p><br><p>   (quit,  Ctrl+C),  . </p><br><blockquote>   ,   srcds_run,    ,      <code>quit</code> ,          "Sat Jun 18 10:28:33 VOST 2016: Server restart in 10 seconds",    Ctrl+C.      ,     ‚Äî      8 .   -  . </blockquote><br><h1 id="obnovlenie-serverov">   </h1><br><p>        , ,    ,     ,         . </p><br><p>    Valve     ,    ,         : </p><br><p><img src="https://habrastorage.org/files/ef3/22d/0ac/ef322d0acca14f339a7740b741d46ca0.png" alt=",     ,     "></p><br><p>      ‚Äî          ,   ‚Äî  ()      .        ‚Äî      Valve     <a href="https://list.valvesoftware.com/cgi-bin/mailman/listinfo/hlds_linux">https://list.valvesoftware.com/cgi-bin/mailman/listinfo/hlds_linux</a> .   ,  "Optional TF2 update released" ‚Äî     .   "Mandatory Team Fortress 2 update released" ‚Äî   . .   ,   ,         ‚Äî    hlds_linux. </p><br><p>      . </p><br><h2 id="avtomaticheskoe">  Automatic </h2><br><p>              ‚Äî       : </p><br><div class="spoiler"> <b class="spoiler_title">start1.sh</b> <div class="spoiler_text"><pre> <code class="hljs objectivec"><span class="hljs-built_in"><span class="hljs-built_in">CMDLINE</span></span>=<span class="hljs-string"><span class="hljs-string">"... -autoupdate -steam_dir /home/game/Steam -steamcmd_script /home/game/cfg/tf2_update \ ...</span></span></code> </pre> </div></div><br><p> <code>-autoupdate</code> <br>     .      </p><br><p> <code>-steam_dir</code> <br>       steam.sh  steamcmd.sh </p><br><p> <code>-steamcmd_script</code> <br>   ,   "-steam_dir",       </p><br><blockquote>   ,      ()     <code>./srcds_run +runscript ~/cfg/tf2_update</code> </blockquote><p>   ~/cfg   tf2_update ‚Äî        .      ,          . </p><br><div class="spoiler"> <b class="spoiler_title">tf2_update</b> <div class="spoiler_text"><pre> <code class="hljs mel">@ShutdownOnFailedCommand <span class="hljs-number"><span class="hljs-number">0</span></span> @NoPromptForPassword <span class="hljs-number"><span class="hljs-number">1</span></span> login anonymous force_install_dir /home/game/tf2/ app_update <span class="hljs-number"><span class="hljs-number">232250</span></span> <span class="hljs-keyword"><span class="hljs-keyword">quit</span></span></code> </pre> </div></div><br><p>   : </p><br><p> <code>@ShutdownOnFailedCommand</code> <br>  Valve      "0"     . </p><br><p> <code>@NoPromptForPassword</code> <br>  ,   "1",    Steam    ,       login.         ,     . </p><br><p> <code>login &lt;username&gt; [&lt;password&gt;] [&lt;Steam guard ode&gt;]</code> <br>    Steam.       ,       "ERROR! Failed to request AppInfo update, not online or not logged in to Steam."     "anonymous" ‚Äî    .     ,         ,          .            <a href="https://developer.valvesoftware.com/wiki/Dedicated_Servers_List">Dedicated Servers List</a> .   ,       ,      steam guard,    ,     set_steam_guard_code. </p><br><p> <code>set_steam_guard_code &lt;ode&gt;</code> <br>   steam guard.     . </p><br><p> <code>force_install_dir</code> <br>       ./SteamApps/common/&lt; &gt;.      ,       .      app_update. </p><br><p> <code>app_update &lt;appid&gt; [-validate] [-language &lt;lang&gt;] [-beta &lt;betaname&gt;] [-betapassword &lt;pwd&gt;]</code> <br>   (  ),     .   appid.    validate ‚Äî         ,  ,      .  ,    <a href="https://support.steampowered.com/kb_article.php%3Fp_faqid%3D282%26l%3Drussian">"  ..."</a>   Steam,   ,     . ,    ,     ,    ,        . </p><br><p> <code>app_set_config &lt;appid&gt; &lt;key&gt; &lt;value&gt;</code> <br>     . </p><br><p>       Steam     ,  steamcmd.sh  .   <code>help</code> , <code>find &lt;&gt;</code> . </p><br><p>          - Steam    ,         . </p><br><p>   : </p><br><pre> <code class="hljs pgsql"> ^CMasterRequestRestart Your <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> will be restarted <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> map change. Your <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> will be restarted <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> map change. Your <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> needs <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> be restarted <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> receive the latest <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>. Your <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> needs <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> be restarted <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> receive the latest <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>.</code> </pre> <br><p>   : </p><br><pre> <code class="hljs pgsql"> L <span class="hljs-number"><span class="hljs-number">07</span></span>/<span class="hljs-number"><span class="hljs-number">08</span></span>/<span class="hljs-number"><span class="hljs-number">2016</span></span> - <span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>: Your <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> will be restarted <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> map change. L <span class="hljs-number"><span class="hljs-number">07</span></span>/<span class="hljs-number"><span class="hljs-number">08</span></span>/<span class="hljs-number"><span class="hljs-number">2016</span></span> - <span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>: Your <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> needs <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> be restarted <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> receive the latest <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>.</code> </pre> <br><p>        ,    ~/cfg/tf2_update , ,  .              . </p><br><p><img src="https://habrastorage.org/files/d1d/b32/a93/d1db32a93faa499d9cbfb95c307c8235.png" alt="  "></p><br><p> , ,    . </p><br><p>         .   ,          ,      .           ,    ( mp_maxrounds,   = 0),  (mp_winlimit = 0),  (mp_fraglimit = 0),  (mp_timelimit = 0),   ,      ,  , .                ,      - ,         . </p><br><p>      . </p><br><h2 id="periodicheskoe-obnovlenie">   </h2><br><p>       ‚Äî   cron  steamcmd.sh     (, "-"),          . </p><br><p> ,   <code>~/Steam/steamcmd.sh +runscript ~/cfg/tf2_update</code>     , steamcmd.sh   : </p><br><pre> <code class="hljs delphi"> ... Connecting anonymously <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Steam <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span>...Logged <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> OK Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> license info...OK Success! App <span class="hljs-string"><span class="hljs-string">'232250'</span></span> already up <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> date.</code> </pre> <br><p>   ,        : </p><br><pre> <code class="hljs sql"> ... <span class="hljs-keyword"><span class="hljs-keyword">Update</span></span> state (<span class="hljs-number"><span class="hljs-number">0x61</span></span>) downloading, progress: <span class="hljs-number"><span class="hljs-number">99.63</span></span> (<span class="hljs-number"><span class="hljs-number">3616706682</span></span> / <span class="hljs-number"><span class="hljs-number">3630011517</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Update</span></span> state (<span class="hljs-number"><span class="hljs-number">0x81</span></span>) committing, progress: <span class="hljs-number"><span class="hljs-number">100.00</span></span> (<span class="hljs-number"><span class="hljs-number">606937472</span></span> / <span class="hljs-number"><span class="hljs-number">606937472</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Success</span></span>! App <span class="hljs-string"><span class="hljs-string">'232250'</span></span> fully installed.</code> </pre> <br><p>   "fully installed"   . .   ~/update.sh: </p><br><div class="spoiler"> <b class="spoiler_title">update.sh</b> <div class="spoiler_text"><pre> <code class="hljs mel">#!/bin/sh ~/Steam/steamcmd.sh +login anonymous +force_install_dir /home/game/tf2/ +app_update <span class="hljs-number"><span class="hljs-number">232250</span></span> +<span class="hljs-keyword"><span class="hljs-keyword">quit</span></span> &gt; ~/steamcmd.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> grep --quiet <span class="hljs-string"><span class="hljs-string">"fully installed"</span></span> ~/steamcmd.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>; then # kill <span class="hljs-string"><span class="hljs-string">`cat /home/game/tf2/tf/srcds1.pid`</span></span> # ~/start1.sh &amp; # kill <span class="hljs-string"><span class="hljs-string">`cat /home/game/tf2/tf/srcds2.pid`</span></span> # ~/start2.sh &amp; fi rm -f ~/steamcmd.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span></code> </pre> </div></div><br><p> ,    ,       steamcmd.sh ‚Äî "+login anonymous +force_install_dir ~/tf2/ +app_update 232250 +quit",        tf2_update ‚Äî "+runscript ~/cfg/tf2_update" </p><br><p>    ,        .        ,    "  ",   tmux      sudo,       ,     .      : </p><br><div class="spoiler"> <b class="spoiler_title">update.sh (v2)</b> <div class="spoiler_text"><pre> <code class="hljs vbscript">#!/bin/sh ~/Steam/steamcmd.sh +login anonymous +force_install_dir /home/game/tf2/ +app_update <span class="hljs-number"><span class="hljs-number">232250</span></span> +quit &gt; ~/steamcmd.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> grep --quiet <span class="hljs-string"><span class="hljs-string">"fully installed"</span></span> ~/steamcmd.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> echo <span class="hljs-string"><span class="hljs-string">"Update installed"</span></span> tmux -L socket1 send-keys <span class="hljs-string"><span class="hljs-string">"say New update installed. Server will be restarted in 10 seconds. Please join us after a minute"</span></span> Enter tmux -L socket2 send-keys <span class="hljs-string"><span class="hljs-string">"say New update installed. Server will be restarted in 10 seconds. Please join us after a minute"</span></span> Enter sleep <span class="hljs-number"><span class="hljs-number">10</span></span>s sudo /usr/bin/systemctl reload srcds1.service sudo /usr/bin/systemctl reload srcds2.service <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> echo <span class="hljs-string"><span class="hljs-string">"Update not found"</span></span> fi rm -f ~/steamcmd.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span></code> </pre> </div></div><br><p>  "say",    SourceMod   <a href="https://forums.alliedmods.net/showthread.php%3Ft%3D56764"> </a> . </p><br><p>       crontab ,      : </p><br><pre> <code class="hljs smalltalk"> <span class="hljs-string"><span class="hljs-string">$ </span></span>chmod <span class="hljs-number"><span class="hljs-number">744</span></span> ~/update.sh <span class="hljs-string"><span class="hljs-string">$ </span></span>crontab -e</code> </pre> <br><p>    : </p><br><div class="spoiler"> <b class="spoiler_title">crontab</b> <div class="spoiler_text"><pre> <code class="hljs markdown"><span class="hljs-emphasis"><span class="hljs-emphasis">*/30 *</span></span> <span class="hljs-bullet"><span class="hljs-bullet">* *</span></span> * ~/update.sh</code> </pre> </div></div><br><p>    cron  ,   game    "" </p><br><h2 id="tolko-proverka">   </h2><br><p>         ,     . </p><br><p>  Valve  <a href="https://developer.valvesoftware.com/wiki/Steam_Web_API">Steam Web API</a> .         ISteamApps/UpToDateCheck, ,    Team Fortress 2 ‚Äî <a href="http://api.steampowered.com/ISteamApps/UpToDateCheck/v1%3Fappid%3D440%26version%3D3528598">http://api.steampowered.com/ISteamApps/UpToDateCheck/v1?appid=440&amp;version=3528598</a> ,    version    (  - ).    appid = 232250 (, ,       ),   "Couldn't get app info for the app specified.".  Alas. </p><br><p> ,  ,    Team Fortress 2 dedicated server    ‚Äî <a href="https://api.steampowered.com/IGCVersion_440/GetServerVersion/v1%3Fformat%3Djson">https://api.steampowered.com/IGCVersion_440/GetServerVersion/v1?format=json</a> .    - : </p><br><pre> <code class="hljs json"> { <span class="hljs-attr"><span class="hljs-attr">"result"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"success"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deploy_version"</span></span>: <span class="hljs-number"><span class="hljs-number">3531256</span></span>, <span class="hljs-attr"><span class="hljs-attr">"active_version"</span></span>: <span class="hljs-number"><span class="hljs-number">3531256</span></span>, <span class="hljs-attr"><span class="hljs-attr">"min_allowed_version"</span></span>: <span class="hljs-number"><span class="hljs-number">3528598</span></span> } }</code> </pre> <br><p>         ‚Äî json, xml, vdf.  ‚Äî <a href="https://developer.valvesoftware.com/wiki/KeyValues">Valve Data Format</a> ,   Valve,    json     .     ‚Äî items_game.txt,  ,  .acf, .vdf   . </p><br><p> ,  deploy_version  active_version  Valve   ,     ,          . ,    ,       api. </p><br><p>         <code>version</code>   ,    ~/tf2/tf/steam.inf </p><br><p>  ,  ,        Web API,     ,           .  - : </p><br><div class="spoiler"> <b class="spoiler_title">update.sh (v3)</b> <div class="spoiler_text"><pre> <code class="hljs kotlin">#!/bin/sh wget -q --no-check-certificate <span class="hljs-string"><span class="hljs-string">"https://api.steampowered.com/IGCVersion_440/GetServerVersion/v1?format=json"</span></span> -O=~/GameVersion.json VERSION_DEPLOYED=`grep deploy_version ~/GameVersion.json | sed -s <span class="hljs-string"><span class="hljs-string">'s/[^[:digit:]]//g'</span></span>` VERSION_INSTALLED=`grep ServerVersion ~/tf2/tf/steam.inf | sed -s <span class="hljs-string"><span class="hljs-string">'s/[^[:digit:]]//g'</span></span>` <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [[ $VERSION_DEPLOYED -gt $VERSION_INSTALLED ]]; then echo <span class="hljs-string"><span class="hljs-string">"New update is ready, </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$VERSION_DEPLOYED</span></span></span><span class="hljs-string"> vs </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$VERSION_INSTALLED</span></span></span><span class="hljs-string">"</span></span> # -  fi</code> </pre> </div></div><br><p> ,    crontab. </p><br><p>  ,         .  ,      Steam Web API,        ~/tf2/steamapps/appmanifest_232250.acf,  "buildid".     ‚Äî <code>steamcmd.sh +login anonymous +app_info_update 1 +app_info_print 232250 +quit</code> ,      "buildid"   depots -&gt; branches -&gt; public ( app_info_print ,    ,    app_info_update 1.    rm -f ~/Steam/appcache/appinfo.vdf).          grep, cut, tr   ,        ,         json (    sed + tr)     . </p><br><blockquote>         "  ". </blockquote><br><ul><li> <a href="https://habrahabr.ru/post/312928/"> 2</a> ‚Äî  (Replay), SourceTV, Fast Download,  </li><li> <a href="https://habrahabr.ru/post/312934/"> 3</a> ‚Äî  MetaMod  SourceMod,  , ,  Steam  <del>  Quickplay </del></li><li> <a href="https://habrahabr.ru/post/312936/"> 4</a> ‚Äî   HLstatsX </li></ul><p></p><p></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/312922/">https://habr.com/ru/post/312922/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../312908/index.html">UX-mitap October 26 in St. Petersburg: work on design sprints, LeanUX, usability research</a></li>
<li><a href="../312912/index.html">Frequent errors when creating game animations</a></li>
<li><a href="../312916/index.html">Sergey Baryshnikov, BigPicture: ‚ÄúTo this led me a complete lack of money‚Äù</a></li>
<li><a href="../312918/index.html">Information security in the field of telecom on the example of Megafon</a></li>
<li><a href="../312920/index.html">Entertaining task "Unlucky ticket"</a></li>
<li><a href="../312924/index.html">On the specifics of the renewal of domain names in international zones</a></li>
<li><a href="../312926/index.html">Launch i2pd in the Docker container on CentOS 7</a></li>
<li><a href="../312928/index.html">Setting up a dedicated Source server for Linux, part 2</a></li>
<li><a href="../312930/index.html">What is new in licensing Windows Server 2016 and how can you avoid unnecessary expenses?</a></li>
<li><a href="../312932/index.html">Algorithm of reading books on programming</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>