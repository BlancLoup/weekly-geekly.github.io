<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHP class for convenient and safe work with MySQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After writing an article about protection against injections, I took up writing a class that implements the ideas contained in it. 
 Or rather, since ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHP class for convenient and safe work with MySQL</h1><div class="post__text post__text-html js-mediator-article">  After writing an <a href="http://habrahabr.ru/post/148701/">article about protection against injections,</a> I took up writing a class that implements the ideas contained in it. <br>  Or rather, since the key functionality was already used in the framework of the working framework, I started to allocate it into an independent class.  Taking this opportunity, I want to thank the members of PHPClub for their help in correcting a few critical errors and helpful comments.  Below I will try to describe the main features, but first a small <div class="spoiler">  <b class="spoiler_title">disclaimer</b> <div class="spoiler_text">  There are several ways to work with SQL - you can use Query Builder, you can use ORM, you can work with pure SQL.  I chose the latter option, because it is closer to me.  I do not think the first two are bad.  Just for me personally, it has always been closely within their framework.  But I am by no means arguing that my version is better.  This is just another option.  Which can be used, including, when writing ORM.  In any case, I believe that having a safe way to work with pure SQL cannot do any harm.  But at the same time, perhaps, it will help the last remaining adherents of using mysql_ * in the application code to finally abandon this vicious practice. </div></div><br>  In a nutshell, a class is built around a set of helper functions that allow you to perform most database operations on a single line, while providing (unlike standard APIs) <b>complete</b> protection against SQL injections, implemented using an extended set of placeholders that protect any data types which may fall request. <br>  The class is based on three basic principles: <br><ol><li>  100% protection against SQL injection </li><li>  At the same time, the protection is very easy to use, making the code shorter, not longer </li><li>  Universality, portability and ease of development </li></ol><br>  I will dwell a little more on each of the points. <br><a name="habracut"></a><br><h4>  Security </h4><br>  provided by the very two rules that I formulated in the article: <br><ol><li>  <b>Any</b> - without exception!  - dynamic elements are included in the request <b>only</b> through placeholders. </li><li>  All that fails to substitute through placeholders is first driven through the white list. </li></ol><br>  Unfortunately, standard libraries do not provide complete protection against injections, protecting only the strings and numbers using the prepared statements. <br>  Therefore, in order to make the protection complete, we had to abandon the obviously limited concept of prepared statements in favor of a broader concept - placeholders.  And the placeholders are typed (this thing is known to all of us by the printf () family of functions:% d is the placeholder, which tells the parser how to handle the substituted value, in this case, as an integer).  Innovation was so successful that at once solved many problems and greatly simplified the code.  I will write more about typed placeholders below. <br>  Support for filtering by whitelists is provided by two functions, which are somewhat far-fetched, but nevertheless necessary. <br><br><h4>  Convenience and brevity of the application code </h4><br>  Here, I was also greatly helped by typed placeholders, which made it possible to make function calls one-line, passing immediately both the request and the data for it.  Plus a set of helpers resembling those in PEAR :: DB functions that immediately return a result of the desired type.  All helpers are organized according to the same scheme: one mandatory parameter is passed to the function - a request with placeholders, and as many optional parameters, the number and order of which must match the number and order of location of the placeholders in the request.  The functions of the Ind family use another mandatory parameter ‚Äî the name of the field by which the returned array is indexed. <br>  Based on my experience, I came to the following set of returned values ‚Äã‚Äã(and, as a result, helpers): <br><ul><li>  query () - returns mysqli resource.  Can be used traditionally, with fetch (), etc. </li><li>  getOne () - returns a scalar, the first element of the first line of the result. </li><li>  getRow () - one-dimensional array, first row of result </li><li>  getCol () - one-dimensional array of scalars - table column </li><li>  getAll () is a two-dimensional array indexed by numbers in order </li><li>  getInd () is a two-dimensional array indexed by the values ‚Äã‚Äãof the field specified by the first parameter </li><li>  getIndCol () is an array of scalars, indexed by the field from the first parameter.  Indispensable for compiling dictionaries of the form key =&gt; value </li></ul><br>  As a result, most of the calls to the database are reduced to one or two line structures (instead of 5-10 with the traditional approach): <br><pre><code class="php hljs">$data = $db-&gt;getAll(<span class="hljs-string"><span class="hljs-string">"SELECT * FROM ?n WHERE mod=?s LIMIT ?i"</span></span>,$table,$mod,$limit);</code> </pre> <br>  In this code there are only necessary and significant elements, but there is nothing superfluous and repetitive.  All the offal is neatly tucked inside the class: the getAll () helper allows you to immediately get the desired result without writing cycles in the application code, and typed placeholders allow you to <b>safely</b> add <b>any</b> type of dynamic elements to the query without setting the bindings (bind_param) manually.  Extra <abbr title="Don't Repeat Yourself">DRY</abbr> code!  In cases of use of placeholders? A and? U, the difference in the amount of code becomes even greater: <br><pre> <code class="php hljs">$data = $db-&gt;getAll(<span class="hljs-string"><span class="hljs-string">"SELECT * FROM table WHERE category IN (?a)"</span></span>,$ids);</code> </pre><br><h4>  Universality and ease of learning </h4><br>  stand on three pillars: <br><ol><li>  <b>A very</b> small API - half a dozen placeholders and as many helpers. </li><li>  We are working with good old SQL, which does not need to be re-learned. </li><li>  At first glance, an inconspicuous, but incredibly useful function parse (), which was originally intended only for debugging, but eventually grew to a key element in the preparation of complex queries. </li></ol><br>  As a result, all complex queries are collected in the old-fashioned way - for example, in a cycle - but at the same time, while observing all safety rules! <br>  I will give a small example (more complicated examples can be found in the documentation at the link below the article): <br>  It is quite often the case when we need to add a condition to the query if there is a variable <br><br><pre> <code class="php hljs">$sqlpart = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($var)) { $sqlpart = $db-&gt;parse(<span class="hljs-string"><span class="hljs-string">" AND field = ?s"</span></span>, $var); } $data = $db-&gt;getAll(<span class="hljs-string"><span class="hljs-string">"SELECT * FROM table WHERE a=?i ?p"</span></span>, $id, $sqlpart);</code> </pre><br>  Here it is important to note a few points. <br>  First, since we are not bound by the native API, no one forbids us to parse not the entire request, but only a part of it.  This turns out to be super-convenient for requests that are assembled according to some logic: we only parse part of the request, and then it is inserted into the main request through a special ‚Äúidle‚Äù placeholder to avoid re-parsing (and follow the rule ‚Äúany elements are substituted only placeholder ‚Äù). <br>  But unfortunately, this is the weak point of the whole class.  Unlike all other placeholders (which, even when used incorrectly, never lead to an injection), incorrect use of the placeholder? P can lead to it. <br>  However, protection from a fool would greatly complicate the class, but it still would not protect against stupid variable insertion into the query string.  So I decided to leave it as it is.  But if you know a way to solve this problem without too much over-engineering, I would be grateful for the ideas. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Nevertheless, in the end we got a powerful and easy query generator, which more than justifies this small drawback. <br>  Powerful because we are not limited to the syntax of the four-builder, "SQL written in PHP" - we write pure SQL. <br>  Easy because the entire query design API consists of half a dozen placeholders and the parse () function <br>  Here is my favorite example - pasting using Mysql functions <br><pre> <code class="php hljs">$data = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'field'</span></span>=&gt;$value,<span class="hljs-string"><span class="hljs-string">'field2'</span></span>=&gt;$value); $sql = <span class="hljs-string"><span class="hljs-string">"INSERT INTO table SET ts=unix_timestamp(), ip=inet_aton(?s),?u"</span></span>; $db-&gt;query($sql, $ip, $data);</code> </pre><br>  On the one hand, we keep the SQL syntax, on the other - we make it safe, and on the third, we reduce the amount of code. <br><br><h4>  Learn more about typed placeholders </h4><br>  First, answer the question, why placeholders in general? <br>  This, in general, is already a common place, but, nevertheless, I repeat - <b>any dynamic data should get into the query only through placeholders</b> for the following reasons: <br><ul><li>  the most important thing is security.  By adding a variable cherz placeholder, we can be sure that it will be correctly formatted. </li><li>  formatting locality.  This is no less important point.  First, the data is formatted just before it hits the query, and does not affect the original variable, which can then be used elsewhere.  Secondly, the data is formatted exactly where it is needed, and not before the script starts working, as with magic quotes, and not in ten possible places of code by several developers, each of whom can rely on the other. </li></ul><br>  Developing this concept further, we come to the idea that paceholders must be <b>typed</b> .  But why? <br>  Here I would like to briefly stop and trace the history of the development of programmer thought in the field of protection from injections. <br>  At first there was chaos - no protection at all, we shove everything as it is. <br>  Then it became not much better, with the paradigm of ‚Äúsearching for everything that came into the script from the user‚Äù and culminating in the form of magic quotes. <br>  Then the best minds came to the conclusion that it is correct to speak not about screening, but about formatting.  Since the formatting is not always reduced to one iskapeyngu.  This is how the quote () method appeared in PDO, which did complete line formatting - not only escaped special characters in it, but also enclosed it in quotes without relying on the programmer.  As a result, even if the programmer used this function out of place (for example, for a number), the injection still did not pass (and in the case of bare escaping via mysql_real_escape_string, it easily passes if we put the number in the request without enclosing it in quotes ).  Being used to format the identifier, this function led to an error at the development stage, which prompted the author of the code that he was a little wrong. <br>  Unfortunately, the PDO authors stopped at this point, since the idea that the query only needs to be formatted is still firmly seated in the heads of the developers.  But in fact, in the query there are much more elements of various types.  <b>And everyone needs their own type of formatting!</b>  That is, the only quote () method doesn‚Äôt suit us - you need a lot of different quotes.  And not as an exception, ‚Äúhere you are quoteName ()‚Äù, but as one of the main concepts: each type has its own format.  Well, since there are a lot of formatting types, the type must be specified somehow.  And a typed placeholder is best suited for this. <br><br>  In addition, a typed placeholder is VERY convenient! <br>  First, because it becomes unnecessary a special operator to bind a value to a placeholder (but it is still possible to specify the type of the transmitted value!) <br>  Secondly, since we invented a typed placeholder - we can stick a huge amount of these placeholders to solve a variety of routine tasks of composing SQL queries. <br>  First of all, we will make a placeholder for identifiers - we desperately lack it in real life, and not in the imagination of the standard API, by the authors.  As soon as the developer is faced with the need to dynamically add the name of the field to the request, everyone starts to pervert in their own way, who is in the forest, who is on firewood.  Here, everything is unified with the rest of the query elements, and adding an identifier becomes as simple as adding a string.  But at the same time, the identifier is not formatted as a string, but in accordance with its own rules - is enclosed in reverse quotes, and inside these quotes are escaped by doubling. <br>  Further more.  The next headache of any developer who has ever tried to use standard prepared statements in real life is the IN () operator.  Voila, we have a placeholder and for this operation!  Array substitution becomes no more difficult than any other elements, plus it is <i>unified</i> with them - no separate functions, only the letter in the placeholder changes. <br>  In the same way we do the placeholder for SET.  I won‚Äôt hold back and demonstrate how simple the code becomes for such a confused query as INSERT ... ON DUPLICATE: <br><pre> <code class="php hljs">$data = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'offers_in'</span></span> =&gt; $in, <span class="hljs-string"><span class="hljs-string">'offers_out'</span></span> =&gt; $out); $sql = <span class="hljs-string"><span class="hljs-string">"INSERT INTO stats SET pid=?i,dt=CURDATE(),?u ON DUPLICATE KEY UPDATE ?u"</span></span>; $db-&gt;query($sql,$pid,$data,$data);</code> </pre><br>  Currently, the class supports 6 types of placeholders <br><ul><li>  ? s ("string") - strings (as well as DATE, FLOAT and DECIMAL). </li><li>  ? i ("integer") - integers. </li><li>  ? n ("name") - the names of fields and tables </li><li>  ? p ("parsed") - to insert parts of the request already processed </li><li>  ? a ("array") - a set of values ‚Äã‚Äãfor IN (a string of the form 'a', 'b', 'c') </li><li>  ? u ("update") - a set of values ‚Äã‚Äãfor SET (a string of the form `field` = 'value',` field` = 'value') </li></ul><br>  That is quite enough for my tasks, but this set can always be expanded with any other placeholder, for example, for fractional numbers.  I don‚Äôt see any point in making a separate placeholder for NULL - you can always enter it directly into the query. <br>  I decided not to do automatic translation of PHP-NULL to SQL-YUSKY NULL.  Perhaps this will complicate the code a little (in those rare cases when it is needed), but it will reduce its ambiguity. <br><br>  By the way, as many may have noticed, this class is in many ways reminiscent of Dmitry Koterov‚Äôs DbSimple library.  But I have fundamental differences with some of the ideas embedded in it. <br>  Firstly, I am against any magic, when the same function can return a different result depending on the type of data transferred.  This, perhaps, slightly simplifies writing, but at the same time makes it extremely monotonous to maintain and debug the code.  Therefore, in my class, all magic is minimized, and all operations and data types are always written explicitly. <br>  Secondly, in DbSimple, a little, in my opinion, overcomplicated syntax.  On the one hand, braces are a great idea.  On the other hand, why bother if we have all the power of PHP at our disposal?  Therefore, I decided to go the other way and Westo ‚Äúinternal‚Äù - obviously limited - logic introduced the ‚Äúexternal‚Äù, limited only by the PHP syntax.  The main thing is that any dynamic elements get into the request only through placeholders, and the rest depends only on the developer's imagination (and the function parse ()). <br><br>  Class code is available on Github, <a href="https://github.com/colshrapnel/safemysql/blob/master/safemysql.class.php">github.com/colshrapnel/safemysql/blob/master/safemysql.class.php</a> <br>  Cheat sheet with the main commands and examples: <a href="http://phpfaq.ru/misc/safemysql_cheatsheet_ru.pdf">phpfaq.ru/misc/safemysql_cheatsheet_ru.pdf</a> <br>  A good idea of ‚Äã‚Äãthe possibilities can be found on the sample documentation page (unfortunately, not yet finished), <a href="http://phpfaq.ru/safemysql">phpfaq.ru/safemysql</a> <br>  There are also answers to frequently asked questions, such as ‚Äúwhy don't you use your native prepared statements?‚Äù And so forth. <br>  Nevertheless, I will be glad to answer any questions in the comments, as well as improve on your comments both the class itself and this article. </div><p>Source: <a href="https://habr.com/ru/post/165069/">https://habr.com/ru/post/165069/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../165057/index.html">NVIDIA introduced its own gaming console SHIELD</a></li>
<li><a href="../165059/index.html">We collect, parsim and give logs using Logstash</a></li>
<li><a href="../165061/index.html">What can be difficult in calculating the hypotenuse?</a></li>
<li><a href="../165063/index.html">A PC created with Valve will be shown this week.</a></li>
<li><a href="../165067/index.html">Prediction of information epidemics by analyzing the social graph</a></li>
<li><a href="../165071/index.html">We write the application for Android on Ruby (Ruboto)</a></li>
<li><a href="../165073/index.html">Writing an extension for google chrome</a></li>
<li><a href="../165077/index.html">Android Conquering fragmentation</a></li>
<li><a href="../165085/index.html">JS module for Java developers</a></li>
<li><a href="../165087/index.html">The simplest image clustering by the k-means method (k-means)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>