<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Audio and video in the Tox messenger</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="While some people are thinking about regulating instant messengers, other people are developing distributed instant messengers. In a previous publicat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Audio and video in the Tox messenger</h1><div class="post__text post__text-html js-mediator-article">  While some people are thinking about regulating instant messengers, other people are developing distributed instant messengers.  In a <a href="https://habrahabr.ru/post/264179/">previous publication</a> , the use of the Tox messenger kernel API was considered using the example of creating a simple echo-bot.  The development of Tox does not stand still, and on November 3rd, the Tox core was <a href="https://blog.tox.chat/2015/11/new-tox-av-api/">enriched with a</a> new audio and video call subsystem - <b>ToxAV</b> , which I would like to talk about in this publication. <br><br><img src="https://habrastorage.org/files/7bb/28c/d78/7bb28cd781a34835ac3156c432bc4527.png" alt="image"><br><br><a name="habracut"></a><br><h1>  Introduction </h1><br>  ToxAV is based on <a href="https://ru.wikipedia.org/wiki/Opus_(%25D0%25BA%25D0%25BE%25D0%25B4%25D0%25B5%25D0%25BA)">Opus</a> codecs for audio and <a href="https://ru.wikipedia.org/wiki/VP8">VP8</a> for video and their implementations in the <a href="http://opus-codec.org/downloads/">libopus</a> and <a href="http://www.webmproject.org/code/releases/">libvpx libraries,</a> respectively. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As an input and output format for audio, the ToxAV API uses PCM format with 16-bit samples, 1 or 2 channel support, and 8, 12, 16, 24, and 48KHz sampling rates.  The duration of one data frame should be 2.5, 5, 10, 20, 40 or 60 ms (requirement of the opus codec). <br><br>  As an input and output format for video, the ToxAV API uses frames in YUV420 format (aka IYUV and I420), which can be relatively easily <a href="https://ru.wikipedia.org/wiki/YUV">converted</a> into the more familiar RGB color space. <br><br>  ToxAV does not provide any methods for capturing data from audio and video devices or their playback - all this is left to the discretion of the application developer.  For example, the <a href="https://github.com/GrayHatter/uTox">¬µTox</a> client uses <a href="https://www.openal.org/">OpenAL</a> for working with audio and <a href="http://www.linuxtv.org/">v4l</a> (video4Linux) for working with video devices.  The <a href="https://github.com/tux3/qTox">qTox</a> client uses <a href="https://www.ffmpeg.org/">FFmpeg</a> to work with video.  In python (which will be discussed indirectly below) we can use <a href="http://people.csail.mit.edu/hubert/pyaudio/">PyAudio</a> for audio and <a href="http://opencv.org/">OpenCV</a> for video. <br><br>  The general cycle of working with ToxAV can be presented sequentially in the form: <br><br><ol><li>  Initialization of the ToxCore core (described in detail in a <a href="http://habrahabr.ru/post/264179/">previous publication</a> ). </li><li>  Initializing the ToxAV subsystem ( <b>toxav_new</b> ). </li><li>  Setting callback functions for event handling ( <b>toxav_callback_ *</b> ) - event handlers are called from the main loop (4) and usually contain the main logic of the application. </li><li>  The main work cycle ( <b>toxav_iterate</b> ) and event handling. </li><li>  Pause for a time of <b>toxav_iteration_interval</b> and return to the previous step. </li></ol><br>  Since  The main way to get knowledge of how Tox API works is to read the source code (written in C), to simplify the following, I will use the python wrapper ( <a href="https://github.com/abbat/pytoxcore">pytoxcore on github</a> ).  For those who do not wish to engage in self-build library from source, there are also links to ready-made binary packages for common distributions. <br><br>  When using python wrappers, you can get library help in the following way: <br><br><pre><code class="python hljs">$ python &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pytoxcore <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ToxAV &gt;&gt;&gt; help(ToxAV) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ToxAV</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class"> | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ToxAV</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> ... | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">toxav_answer</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(...)</span></span></span><span class="hljs-class"> | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">toxav_answer</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(friend_number, audio_bit_rate, video_bit_rate)</span></span></span><span class="hljs-class"> | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Accept</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">an</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">incoming</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class">. | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">If</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">answering</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fails</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">any</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">reason</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">will</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">still</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pending</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">and</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">it</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">possible</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">try</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">and</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">answer</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">it</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">later</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Audio</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">and</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">video</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">receiving</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">are</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">both</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">enabled</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">by</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">. | | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">toxav_audio_receive_frame_cb</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(...)</span></span></span><span class="hljs-class"> | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">toxav_audio_receive_frame_cb</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(friend_number, pcm, sample_count, channels, sampling_rate)</span></span></span><span class="hljs-class"> | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">triggered</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">when</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">audio</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">received</span></span></span><span class="hljs-class">. ...</span></span></code> </pre> <br>  Below we will focus on each step of working with the API in a little more detail. <br><br><h1>  ToxAV Initialization </h1><br>  To initialize the ToxAV subsystem, an instance of the previously initialized <b>ToxCore kernel is</b> used as a parameter to the <b>toxav_new</b> call.  Only one ToxAV instance can be created for a single ToxCore instance.  In the python wrapper, the toxav_new call is hidden inside the constructor and initialization looks like: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pytoxcore <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ToxCore, ToxAV <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoBot</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ToxCore)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoAVBot</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ToxAV)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, core)</span></span></span><span class="hljs-function">:</span></span> super(EchoAVBot, self).__init__(core) ... bot = EchoBot(options) botav = EchoAVBot(bot)</code> </pre><br>  To destroy a ToxAV instance, use the <b>toxav_kill</b> call or destroy the class instance in the python wrapper, where the toxav_kill call is hidden in the destructor. <br><br><h1>  Setting callback functions </h1><br>  In the python wrapper, the connection to the supported callback functions is performed automatically.  The handlers themselves can be methods of a <b>ToxAV</b> successor and have the <b>* _cb</b> suffix.  In all handlers, one of the parameters is <b>friend_number</b> - an integer friend identifier from similar ToxCore methods. <br><br>  <b>toxav_call_cb (friend_number, audio_enabled, video_enabled)</b> - incoming call.  As arguments, additional flags of audio and video support are transmitted from the contact side.  In the future, contact with disabled audio or video streams can turn them on, which will trigger a call status change event.  The call can be accepted by calling <b>toxav_answer</b> , or rejected by calling <b>toxav_call_control</b> . <br><br>  <b>toxav_call_state_cb (friend_number, state)</b> - change the state of the call.  The argument is the state, which is the bit mask of the constants: <br><br><ul><li>  <b>TOXAV_FRIEND_CALL_STATE_ERROR</b> - timeout for transferring data to a contact.  This state is the last state for the call (at this point the call is completed) and cannot be combined with other states. </li><li>  <b>TOXAV_FRIEND_CALL_STATE_FINISHED</b> - normal call termination.  This state is the last state for the call (at this point the call is completed) and cannot be combined with other states. </li><li>  <b>TOXAV_FRIEND_CALL_STATE_SENDING_A</b> - the contact has started the audio stream. </li><li>  <b>TOXAV_FRIEND_CALL_STATE_SENDING_V</b> - the contact has started the transmission of the video stream. </li><li>  <b>TOXAV_FRIEND_CALL_STATE_ACCEPTING_A</b> - the contact has started receiving an audio stream. </li><li>  <b>TOXAV_FRIEND_CALL_STATE_ACCEPTING_V</b> - the contact has started receiving a video stream </li></ul><br>  <b>toxav_bit_rate_status_cb (friend_number, audio_bit_rate, video_bit_rate)</b> is a network overload event when the kernel does not have time to send data with the required bitrate.  As parameters, the kernel offers new bit rates for audio and video stream.  At first, the kernel tries to reduce the bitrate of the video stream as occupying the main band and only after turning off the video stream, an attempt is made to decrease the bitrate for audio.  The application can ignore these recommendations or use the <b>toxav_bit_rate_set (friend_number, audio_bit_rate, video_bit_rate) call</b> to set new bitrate values.  Bitrates are specified in Kb / s (kilobits per second), a value of 0 indicates that the corresponding data stream is disconnected, a value of -1 leaves the previous bitrate unchanged. <br><br>  For the opus audio codec, the minimum bitrate is 6, and the values ‚Äã‚Äãabove 16-32 to my ear are no longer distinguishable for sound from a webcam. <br><br>  For the V8 video codec, I could not find the recommended bandwidth values ‚Äã‚Äãdepending on the frame size and FPS.  In general, the following basic bitrates are <a href="http://www.ezs3.com/public/What_bitrate_should_I_use_when_encoding_my_video_How_do_I_optimize_my_video_for_the_web.cfm">recommended</a> for different video resolutions: <br><table><tbody><tr><th>  frame size, px </th><th>  bitrate, Kb / s </th></tr><tr><td>  320x240 </td><td>  400 </td></tr><tr><td>  480x270 </td><td>  700 </td></tr><tr><td>  1024x576 </td><td>  1500 </td></tr><tr><td>  1280x720 </td><td>  2500 </td></tr><tr><td>  1920x1080 </td><td>  4,000 </td></tr></tbody></table><br>  <b>toxav_audio_receive_frame_cb (friend_number, pcm, sample_count, channels, sampling_rate)</b> - receiving a frame of audio data.  The parameters are the data buffer, the number of samples, the number of channels and the sampling frequency (Hz).  For stereo sound, 16-bit samples go in series for the left and right channels.  The buffer size in bytes is defined as <b>sample_count * channels * 2 byte</b> , and the buffer duration in milliseconds as <b>sampling_rate / sample_count</b> . <br><br>  Since PCM is a conventional <a href="https://ru.wikipedia.org/wiki/%25D0%2598%25D0%25BC%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D1%2581%25D0%25BD%25D0%25BE-%25D0%25BA%25D0%25BE%25D0%25B4%25D0%25BE%25D0%25B2%25D0%25B0%25D1%258F_%25D0%25BC%25D0%25BE%25D0%25B4%25D1%2583%25D0%25BB%25D1%258F%25D1%2586%25D0%25B8%25D1%258F">pulse code modulation</a> format, the buffer data can be transmitted with little or no conversion to any DAC or saved to the WAV file by adding the appropriate <a href="http://audiocoding.ru/article/2008/05/22/wav-file-structure.html">header</a> with the format description, but you should be prepared that during the conversation any parameters of the audio stream can be changed by the caller. <br><br>  <b>toxav_video_receive_frame_cb (friend_number, width, height, y, u, v, ystride, ustride, vstride)</b> - receiving a frame of video data in YUV420 format.  This is the original callback from ToxAV.  An example of implementing the conversion from YUV420 to BGR can be found, for example, in the source code ¬µTox ( <a href="">yuv420tobgr</a> ). <br><br>  <b>toxav_video_receive_frame_cb (friend_number, width, height, rgb) ‚ÄîReceiving</b> a frame in RGB or BGR format is an additional python wrapper callback that is not present in ToxAV.  This option is used to speed up the necessary conversions within the library instead of converting them to pyhon (in fact, yuv420tobgr from the ¬µTox code is used).  The RGB or BGR format is specified by calling <b>toxav_video_frame_format_set</b> with the parameter: <br><br><ul><li>  <b>TOXAV_VIDEO_FRAME_FORMAT_BGR</b> - BGR format (used in OpenCV). </li><li>  <b>TOXAV_VIDEO_FRAME_FORMAT_RGB</b> - RGB format. </li><li>  <b>TOXAV_VIDEO_FRAME_FORMAT_YUV420</b> is the original <b>ToxAV</b> callback with the YUV420 format. </li></ul><br>  Hereinafter, RGB / BGR means a 24-bit format without an alpha channel, where each of the components of red, green, and blue is allocated 8 bits each.  Sometimes this format is referred to as RGB24 / BGR24 depending on the order of the color components of red and blue. <br><br>  As with the audio stream, the format of the video stream can be changed at any time by the caller (for example, the frame size will change). <br><br><h1>  Event handling </h1><br>  To handle ToxAV events, a periodic <b>toxav_iterate</b> method call is <b>used</b> (similar to a kernel method <b>tox_iterate call</b> ) with a recommended interval between calls equal to the value <b>returned by a toxav_iteration_interval</b> call (by analogy with a <b>tox_iteration_interval call</b> ). <br><br>  Duty cycle for ToxAV is recommended to serve in a separate thread, because  in the absence of audio / video calls, the value <b>toxav_iteration_interval</b> will be 200 ms and the stream will sleep most of the time: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> threading <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoAVBot</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ToxAV)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, core)</span></span></span><span class="hljs-function">:</span></span> ... self.running = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.iterate_thread = threading.Thread(target = self.iterate_cb) self.iterate_thread.start() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iterate_cb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> self.running: self.toxav_iterate() interval = self.toxav_iteration_interval() time.sleep(float(interval) / <span class="hljs-number"><span class="hljs-number">1000.0</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.running = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> self.iterate_thread.join() self.toxav_kill();</code> </pre><br>  Since we have a GIL (Global Interpreter Lock) for python, we should not worry about the need for synchronization between threads, but in other languages ‚Äã‚Äãthere can be "unexpected" surprises when tox <b>av</b> _ * cb events can be triggered from a thread that serves tox_iterate thread serving tox <b>av</b> _iterate.  Such an event, for example, is the <b>toxav_call_state_cb</b> call <b>termination event</b> - use the appropriate synchronization primitives taking into account the possibility of a deadlock inside the Tox kernel. <br><br><h1>  Call management </h1><br>  To create an outgoing call, the <b>toxav_call</b> method <b>(friend_number, audio_bit_rate, video_bit_rate) is used</b> , where the contact ID from the contact list and outgoing audio and video bitrate (Kb / s) are specified as arguments.  Bitrate value 0 blocks sending the corresponding stream, which can be enabled later by calling <b>toxav_bit_rate_set</b> . <br><br>  ToxAV does not have the usual control of making a call to us - an unanswered outgoing call will last until the call is canceled by any internal timeout of the application itself (the application "hangs up"), or the contact does not go offline (the network is broken) and the <b>toxav_call_state_cb</b> event with the parameter <b>TOXAV_FRIEND_CALL_STATE_FINISHED</b> ).  By default, receiving audio and video data from a contact is allowed and can be changed by calling <b>toxav_call_control</b> . <br><br>  An incoming call is determined by the <b>toxav_call_cb</b> event, after which the call can be either completely ignored or processed by answering the call or changing its state through <b>toxav_call_control</b> . <br><br>  To answer the call, the <b>toxav_answer</b> call <b>(friend_number, audio_bit_rate, video_bit_rate) is used</b> , where the contact ID from the contact list making the incoming call and outgoing audio and video bitrate (Kb / s) are specified as arguments.  Bitrate value 0 blocks sending the corresponding stream, which can be enabled later by calling <b>toxav_bit_rate_set</b> . <br><br>  To control the state of a call, the <b>toxav_call_control (friend_number, control)</b> call is used, where the following constants can be used as a control parameter: <br><br><ul><li>  <b>TOXAV_CALL_CONTROL_RESUME</b> - the resumption of a call that was previously paused cannot be used until the call is answered. </li><li>  <b>TOXAV_CALL_CONTROL_PAUSE</b> ‚Äî setting a call to pause (hold, hold) cannot be used until the call is answered. </li><li>  <b>TOXAV_CALL_CONTROL_CANCEL</b> - drop an incoming call or end an active call. </li><li>  <b>TOXAV_CALL_CONTROL_MUTE_AUDIO</b> ‚Äî Sends a request to the respondent to stop transmitting audio data (the respondent may ignore this request). </li><li>  <b>TOXAV_CALL_CONTROL_UNMUTE_AUDIO</b> is a request <b>sent to the</b> respondent to resume the transfer of audio data. </li><li>  <b>TOXAV_CALL_CONTROL_HIDE_VIDEO</b> ‚Äî Sends a request to the respondent to stop transmitting video data (the respondent can ignore this request). </li><li>  <b>TOXAV_CALL_CONTROL_SHOW_VIDEO</b> - a request to the respondent to resume the transfer of video data. </li></ul><br><h1>  Transmission of audio and video streams </h1><br>  The audio stream is transmitted by calling <b>toxav_audio_send_frame (friend_number, pcm, sample_count, channels, sampling_rate)</b> , where the contact ID from the contact list, the PCM data buffer, the number of samples, the number of channels and the sampling frequency are specified as arguments.  By analogy with <b>toxav_audio_receive_frame_cb</b> for stereo stream, 16-bit samples for the left and right channels should go one after the other. <br><br>  It should be recalled that the maximum number of channels is 2 (stereo), the sampling rate can be 8, 12, 16, 24 and 48 KHz and, due to the features of the opus codec, the number of samples must correspond to a frame length of 2.5, 5, 10, 20, 40 or 60 ms. <br><br>  To transfer a video stream frame, the <b>toxav_video_send_frame</b> call is <b>used</b> , which in the python wrapper is renamed <b>toxav_video_send_yuv420_frame (friend_number, width, height, y, u, v)</b> , where the arguments are the contact identifier from the contact list, the frame width and height in pixels, buffers Y (brightness) and color difference UV. <br><br>  An example of the implementation of the conversion from BGR to YUV420 can be found, for example, in the source code ¬µTox ( <a href="">bgrtoyuv420</a> ).  For convenience, the python wrapper implements the <b>toxav_video_send_bgr_frame (friend_number, width, height, bgr)</b> and <b>toxav_video_send_rgb_frame (friend_number, width, height, rgb)</b> methods, which perform these transformations themselves (bgrtoyuv420 is used from the code in the text of the tegavtext). <br><br><h1>  Examples </h1><br>  Python is a fairly convenient language for prototyping and learning how to work.  To demonstrate the above, I wrote several <a href="https://github.com/abbat/pytoxcore/tree/master/examples">examples</a> : <br><br>  <a href="https://github.com/abbat/pytoxcore/blob/master/examples/echobot.py">echobot.py</a> is a plain text echo-bot that responds with text sent to it.  Additionally demonstrates the management of contacts, status, avatars, files.  It is the base for the implementation of other examples. <br><br>  <a href="https://github.com/abbat/pytoxcore/blob/master/examples/echoavbot.py">echoavbot.py</a> - audio and video echo-bot that sends back audio and video streams sent to the caller.  It may be convenient to study the influence of the network on the quality of data transmission, the arising delays, testing of own equipment. <br><br>  <a href="https://github.com/abbat/pytoxcore/blob/master/examples/avbot.py">avbot.py</a> - bot to simulate the respondent, transmits audio and video data from their own devices.  It may be convenient to monitor pets during their absence :) <br><br><h1>  Conclusion </h1><br>  The Tox project is alive and well developed.  <a href="http://habrahabr.ru/post/264383/">The rupture of relations with the Tox Foundation</a> did not slow down the development of the project and it seemed he gave a second wind - PR began to be taken, tickets were figured out, a new website was being actively filled and work was being done on the documentation.  I hope in a short time the <a href="">branch of working with group chats</a> will be infused into the kernel and the kernel will take on a complete pre-release look. <br><br><h1>  Links </h1><br><ul><li>  <a href="https://tox.chat/">tox.chat</a> is the official site of the Tox project. </li><li>  Kernel <a href="https://github.com/irungentoo/toxcore">toxcore</a> project <a href="https://github.com/irungentoo/toxcore">on github</a> . </li><li>  The <a href="https://github.com/abbat/pytoxcore">pytoxcore</a> python wrapper <a href="https://github.com/abbat/pytoxcore">project on github</a> . </li><li>  A project to build binary versions of clients and <a href="">tox.pkg</a> libraries <a href="">on github,</a> including oldstable distributions like Debian Wheezy, Ubuntu Precise and CentOS 6, on which the ‚Äúofficial‚Äù client builds may not run. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/272999/">https://habr.com/ru/post/272999/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272983/index.html">Writing code for Node.js in the state machine style</a></li>
<li><a href="../272987/index.html">Conflict-Free Replication: CRDT in Theory and Practice</a></li>
<li><a href="../272989/index.html">Screenshot game - the hard way</a></li>
<li><a href="../272993/index.html">Simple Blender. Part 4</a></li>
<li><a href="../272995/index.html">You can not use tools</a></li>
<li><a href="../273001/index.html">Black PR Telegram. Who to believe?</a></li>
<li><a href="../273003/index.html">Games that teach programming</a></li>
<li><a href="../273007/index.html">The digest of interesting materials for the mobile # 133 developer (December 7-13)</a></li>
<li><a href="../273009/index.html">Deploy Drupal 8 with Otto</a></li>
<li><a href="../273011/index.html">MongoDB certification</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>