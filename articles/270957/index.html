<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Telegram Bots: Experience, Revelations, Design Tips</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Let's get down to business right away. The content of the article: 


- What we started writing bots in Telegram. First experience. 
- Create a bot-br...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Telegram Bots: Experience, Revelations, Design Tips</h1><div class="post__text post__text-html js-mediator-article">  Let's get down to business right away.  The content of the article: <br><ul><li>  What we started writing bots in Telegram.  First experience. </li><li>  Create a bot-brother nodejs library for quickly writing bots. </li><li>  Parse the code of freshly written bot DeloreanBot </li><li>  Human recommendations for creating a popular bot </li><li>  Philosophical reasoning about the monetization of bots </li></ul><br><img src="https://habrastorage.org/files/0fe/b1d/f4e/0feb1df4e4634c6b946c1d1a06dd8bbf.jpg"><br>  Go. <br><a name="habracut"></a><br><h4>  What we started to do bots.  Matchmaker, Weatherman, Zodiac. </h4><br>  <i>Attention!</i>  <i>The next paragraph may contain spoilers.</i>  <i>Be careful.</i> <br><br>  All three bots turned out to be suitable and hang out now in the storebot.me top.  Weatherman has consistently held in first place for several months. <br><br>  Now a brief history of creation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Developers do not feed bread - let me just nakodit some cool goofy garbage.  Therefore, it was incredibly difficult for us to ignore the news about the launch of bots in Telegram. <br>  First of all, it was necessary to come up with an idea for the first bot.  Research started with Internet pillars - porn and cats. <br>  It turned out that in Arab countries porn sites are blocked, and porn in the telegraph is available.  This fact multiplied the attractiveness of pornbots for developers to infinity and the niche quickly filled. <br>  And Serezha‚Äôs seals (Serezha is a developer in general, I‚Äôm writing current articles) are allergic. <br><br>  Somewhere at the junction of porn and cats there was an idea to make a dating bot.  Without thinking twice, we created Matchmaker_bot, an analogue of Tinder in Telegram (telegram.me/matchmaker_bot). <br>  The idea of ‚Äã‚Äãa bot is simple and therefore beautiful - you upload a photo and then watch other people's photos.  If you like a certain user, and you like him, the bot will allow you to exchange contacts and you can <s>live happily and happily until death do you</s> chat in the telegraph. <br><br>  I can not share.  At the first launch of the bot in the code was a bug that counted dislike for like.  Because of this bug, I said a good ten brutal Iranians, who immediately joyfully began to chat with me. <br>  Every time when I saw a notice in a telegram that a photo had come to me, I closed my eyes and ran to Seryozha to remove the photo ‚Äî everything was waiting for obscenities.  But polite Iranians have never sent anything indecent - only pictures with flowers and cats.  Such are the romantic comrades. <br><br>  For the first two days of life, the bot gathered 800 unique users, received 200 people daily audience and still the audience is growing. <br>  At the time of this writing, we have 900 unique visitors per day. <br><br>  We are not SEO website optimization specialists and, to be honest, we don‚Äôt imagine how to make a website that would attract a similar audience in two days without any special efforts. <br><br>  Therefore, the result inspired us and Serezha quickly decided to make a couple more bots.  Thus, Weatherman and Zodiac saw the light - bots that know how to give a weather forecast or horoscope, as well as send you daily forecasts for today or tomorrow at the time you specified (telegram.me/weatherman_bot and telegram.me/zodiac_bot). <br><br>  Serezha got confused and made localization for bots in 5 languages, and for the weather bot he already took a paid weather API. <br>  Multilingual, forecast accuracy and intuitive interface have suddenly made the weather bot very popular. <br>  Now he is in the top of storebot.me, occasionally getting into the place of the coolest bot in Telegram, has more than 2000 user ratings, an average rating of 5 stars.  Reviews are full of love and adoration. <br><img src="https://habrastorage.org/files/1bd/3ef/982/1bd3ef982c3b4c25963754cca3407e6a.png"><br><br><h4>  Creating bot-brother nodejs for quick bot development </h4><br>  The first bot was written haphazardly, on bare enthusiasm.  But the real developer understands - if you have to do about the same product many times, he starts to smack the framework.  We did not find ready-made libraries or frameworks, so Seryozha wrote his lib. <br><br>  Telegram Bot API allows using http-requests to receive or send text commands for dialogue with the user. <br>  You can add special markup and variables to queries, for example, to show the user a simple keyboard. <br><img src="https://habrastorage.org/files/f19/d12/27a/f19d1227a88445a58329ceda641f5137.png"><br><br>  In fact, the developer thinks in terms of several more complex abstractions. <br><br><h6>  1. You divide text messages from the user into two types - entering a command and responding to a bot request. </h6><br>  For example, there is a dialogue: <br>  User: Bot, show me the weather forecast! <br>  Bot: Ok, for which city? <br>  User: Irkutsk <br>  Bot: It's cold in Irkutsk ... <br><br>  The first phrase of the dialogue is the initialization of the dialogue by the user, input of the command.  And the third phrase is already the answer to the specific question of the bot. <br><br><h6>  2. All work with the bot is walking on some finite state machine. </h6><br>  Here you want to have the means for conveniently moving between states (commands), to be able to make child and parent states, to return to a new state, etc.  etc.  Simply put - I want to have a convenient tool for routing between teams. <br><br><h6>  3. You want to have a tool for convenient work with different languages. </h6><br>  I would like to have separate logic, separate configs for different languages.  Ideally, language configs should be simple so that localization files can be outsourced for translation. <br><br><h6>  4. You want to organize sessions. </h6><br>  That is, to have some set of data that is tied to a unique bot user. <br><br><h6>  5. I want to break the processing of the team into several stages - middlewares. </h6><br>  Everyone loves the principles of express.js :) <br><br>  All these ideas were embodied in the <a href="https://github.com/SerjoPepper/bot-brother">bot-brother</a> library.  We have tried to write detailed documentation for it, which can be found in the repository. <br><br><h4>  Boat per day.  Using bot-brother on the example of a bot for notifications DeloreanBot. </h4><br>  If someone wants to skip the lyrics, you can touch the <a href="http://telegram.me/delorean_bot">working bot</a> in Telegram, and its <a href="https://github.com/SerjoPepper/bot-brother">sources</a> look at the githaba. <br><br>  For the rest, we describe the features of the implementation. <br>  The functionality of the manufactured bot - the user enters into the bot reminders and time, the bot sends a notification at the right time. <br>  For example, the user writes "Walk with the dog in an hour", the bot sends a reminder in an hour.  (Let us immediately agree that we do not pretend to the originality of the idea).  We make bot in Russian and English. <br><br>  Writing such a bot completely and debugging and localizing the interface to English takes us one day. <br><br>  We need: <br><ul><li>  Be able to work out user commands; </li><li>  Organize localization; </li><li>  To be able to conveniently determine the user's time zone; </li><li>  Store user data; </li><li>  Be able to track the time when you need to send a message; </li><li>  Be able to parse phrases containing the date and time. </li></ul><br><h6>  1. Processing user commands </h6><br>  This is basically the basic bot-brother functionality.  It makes no sense to duplicate the library documentation here.  I will give a small piece of code for a common understanding.  Registering a team and responding to its response usually looks like this: <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   settings_locale bot.command('settings_locale') .invoke(function (ctx) { //      ‚Äì     return ctx.sendMessage(' '); }) .answer(function (ctx) { //      . ctx.session.locale = ctx.answer; ctx.setLocale(ctx.answer); return ctx.sendMessage('answer.success').then(function () { //    ,     . return ctx.goBack(); }); }) //      ,      . .keyboard([[ {'': 'ru'}, {'English': 'en'}, ], //   ¬´¬ª  . [{'': function (ctx) { ctx.goBack(); }] ]);</span></span></code> </pre> <br><br><h6>  2. Organization of localization </h6><br>  If we ask a person to specify the interface language, it would be nice to show him texts in the correct language when working with a bot. <br><br>  All phrases will be stored as ‚Äúkey-localized value‚Äù in yaml-files.  This format is useful if you want to transfer files for editing to third-party translators.  An example of a file with an English translation can be found <a href="">here</a> . <br><br>  With the code we turn these files into json of the required format and transfer it to the bot. <br><br>  The code for turning yaml-files into json is of no scientific interest, but if that is <a href="">there</a> . <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//      var bot = bb({ key: config.bot.key, redis: config.redis }) //       . .texts(texts.ru, {locale: 'ru'}) .texts(texts.en, {locale: 'en'}) .texts(texts.default);</span></span></code> </pre><br><br>  After that, instead of text phrases, we will indicate the corresponding localization keys in the code. <br><br>  All pieces of code with text message output will change slightly. <br>  This code snippet <br><pre> <code class="javascript hljs">.invoke(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ctx</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      ‚Äì     return ctx.sendMessage(' '); })</span></span></code> </pre><br>  transformed into <br><pre> <code class="javascript hljs">.invoke(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ctx</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      ‚Äì     return ctx.sendMessage('settings.locale'); })</span></span></code> </pre><br><br><h6>  3. Determining the user's time zone. </h6><br>  If you come up and ask an ordinary citizen to name your time zone, he may not understand you.  But almost all human individuals are more or less sure of the name of the city in which they are located.  We take advantage of this fact. <br><br>  To determine the time zone, thus, you need to either directly request the user's location, or ask the user to type in the name of their city.  Practice shows that this approach is good and does not scare anyone. <br><br>  The name of the city is translated coordinates using <a href="https://tech.yandex.ru/maps/geocoder/">Yandex http-geocoder</a> (note, you need to get the key). <br><br>  The coordinates feed <a href="">timezoner</a> , which will return us to the user's time zone. <br><br>  There are nuances - both services have restrictions on the number of requests per day.  Therefore: <br>  a) we cache requests to the geocoder for identical cities; <br>  b) when a person enters the exact location, we still run it through the geocoder, we get the city of the user and we work further with the coordinates of the city center - this way for all users from Moscow you can make one request in timezoner. <br><br>  The code of the module for determining the time zone, see <a href="">here</a> . <br><br><h6>  4. User data storage </h6><br>  Previously, we noted that bot-brother can store data associated with a specific user for a long time.  This functionality is implemented through Redis. <br><br>  In more complex bots in Redis, we store only a small amount of user session data, and the bulk still have to be placed in a full-fledged database (for example, in MongoDB). <br><br>  But for this bot decided to do only Redis. <br>  Reading user data from the repository occurs before processing the next command, and writing back to the repository after the processing cycle of the next command. <br><br><h6>  5. Tracking the time at which you want to send a notification. </h6><br>  Our other bots need to send messages to users at certain times of the day.  To do this, the server runs a process that checks the time, checks the records in the database and sends alerts regularly. <br><br>  But for this bot there was a more cool solution.  In Redis, you can add keys with a given lifetime.  When the key goes out, Redis sends us the corresponding event.  That's all. <br>  As soon as we need to add a notification, we write down the key with the desired lifetime in Redis, and then we just listen to events and send notifications to users via them. <br>  <a href="">Code</a> <br><br><h6>  6. Search for a time or date in a phrase </h6><br>  There is a wonderful library <a href="https://www.npmjs.com/package/chrono-node">chrono-node</a> , which can look for time in English phrases. <br>  By analogy we add the code for the Russian language. <br><br>  We now more or less represent: <br><ul><li>  How to create a bot; </li><li>  How localization is set; </li><li>  How commands and their handlers are registered; </li><li>  How keyboards with answer choices are declared; </li><li>  How to organize the storage of user data; </li><li>  How to organize the definition of the user's time zone; </li><li>  How to isolate the date and time from the text. </li></ul><br>  Then it remains just to accurately program all the necessary commands for the bot and debug.  We watch the full version in the same <a href="">repository</a> . <br><br><h5>  2 days.  The flight is predictable. </h5><br>  We posted DeLorean on the storebot two days ago.  Statistics: <br><ul><li>  38 ratings, average rating 4 stars; </li><li>  Top three in Best New Bots, hit themed mailing storebot; </li><li>  1500 unique users. </li></ul><br><h4>  Human recommendations for creating a popular bot </h4><br>  Above, we have shamelessly boasted that our bots have climbed to the top of the bots rating and have been sitting there for a long time. <br><img src="https://habrastorage.org/files/3ed/a63/8b7/3eda638b707845d1a28f567227748837.png"><br>  Why is it important to have a high place in the ranking? <br><ul><li>  The higher the bot, the greater the loyalty that someone accidentally stumbles upon it. </li><li>  If the bot rises to the top, it can get on the storebot mailing lists (Best New Bots, Top Chart Bots).  Mailings accordingly will attract you a decent amount of new users. </li></ul><br>  Of course, telegrams never publish magical algorithms, which are used to calculate the rating of bots.  However, we have a hypothesis on this subject, which seems rather plausible. <br><br>  So, your bot's rating is most dependent on recent storebot ratings.  If your bot has recently been given a lot of positive ratings (5 stars), then it will most likely crawl up in the ratings. <br>  The number of uniqueness in the bot and the intensity of its use do not seem to affect the position in the ranking.  Otherwise, we cannot explain in any way how our Zodiac_bot manages to overtake in the ratings, for example, the super popular Yandex Yandex.Kartinok: / <br><br>  Based on this thought, we conclude that the only way to promote a bot in the store is not to upset the bot's target audience and make users as happy as possible. <br><br>  Now bots are a young and strange niche.  The key feature of the overwhelming majority of bots is an incomprehensible interface. <br>  The author of the article has formed a subjective feeling that bots are written by developers for developers.  And for some reason, few people write bots for people. <br>  If you make a bot for developers, then you can hardly raise it high in the ranking.  Just because non-programmers will be confused in the interface and give low marks.  Your cap. <br><br>  In this regard, a few obvious recommendations on how to make a convenient bot for non-programmer users. <br><br><h6>  Keyboards instead of commands </h6><br>  Yes, I know that teams are very cool.  Commands in the console, commands in the messenger - is this not happiness? <br>  But, surprisingly, most of the world's population does not like to drive a team. <br>  Hence, recommendation No. 1: so that absolutely any user does not fall into a stupor when working with your bot (even your grandmother), always, at almost any stage of working with the bot, show the user a keyboard with possible options for action.  Leave the teams for the geeks, let them rejoice. <br><br><h6>  Do not ask people difficult things </h6><br>  I have already revealed this idea in principle in the section on determining the time zone.  The less a user needs to think and click when working with your bot, the more chances that he will not fall off. <br><br><h6>  Feel free to use emoji </h6><br>  The feature of bots is a small amount of expressive means for creating attractive interfaces.  Therefore, if we have the ability to make a button with an icon and text, it should be used. <br>  I admit that many do not like the distortion of literary writing with vulgar pictures, but emoji really do make the text interface more friendly.  An excellent illustration is the weather forecast. <br><img src="https://habrastorage.org/files/d9f/a5e/c62/d9fa5ec62c3546d9a1f02b232baab8a6.png"><br><br><h6>  Love negative reviews </h6><br>  Many negative reviews - not the worst situation for the product.  The most terrible reaction - no one uses and writes nothing.  Here it is really not clear what to do. <br>  And when you have negative reviews, you can: <br>  a) finish bot <br>  b) fix bugs (if it's bug reports) <br>  c) write to the author of a negative assessment and talk about the bot <br><br>  We actively practice all three approaches.  Serezha wrote many times to users who left some incomprehensible low-rated feedback, together they found a bug, repaired, and almost always the user returned to rate the bot more (which, as we know, contributes to its distribution). <br><br>  Lyrical digression - the most funny reviews are left by the users of the dating bot. <br><img src="https://habrastorage.org/files/c38/d44/bd6/c38d44bd6ed34663bf8b50dfd5b323b0.png"><br>  But Mehregan is right, but what about the soul? .. <br><br><h4>  Philosophical reasoning about the monetization of bots </h4><br>  Theoretically, we understand that if we have an audience of 2,000 people a day, at least something can be earned from it.  But almost do not understand how. <br>  Now our headache is the growing needs of the weather bot.  His audience is growing, requests for weather api are growing, and our costs of maintaining it, too.  When growth stops - it is not clear. <br><br>  We came up with three theoretical approaches to monetize a bot: <br><ol><li>  Make a button for donations.  Plus approach - unobtrusive.  Cons - most likely the income will be close to zero. </li><li>  Paid subscription.  We give to use the bot for free, for example, a month, then we ask to buy the key to the bot for the dollar.  Pros - just do not leave a minus.  Minus - we can lose all users. </li><li>  Advertising in the bot.  Pros - the chances of earning it seems there.  Cons - we can spoil the karma. </li></ol><br>  We are trying to develop approach number three, which is about advertising.  Seryozha wrote a platform for advertising in adbot.io bots.  You can <a href="https://adbot.io/">read the</a> dock and see the platform on the platform's website - <a href="https://adbot.io/">adbot.io</a> .  It is completely new, as long as it contains only our bots and there are no advertisers at all.  This is all a pure experiment for the time being, so we invite all those who are not indifferent to participate.  We really want to find an arbitrazhnik who agrees to place advertisements in our bots (at first you can even be free), just to see if an advertising exchange is viable for bots. <br><br>  If at least one of these approaches allows making bots profitable (or at least not unprofitable), then apparently the niche is not hopeless.  And if it does not, apparently the botiki will die as a beautiful concept. </div><p>Source: <a href="https://habr.com/ru/post/270957/">https://habr.com/ru/post/270957/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../270939/index.html">Little OS from scratch in C ++ and assembler</a></li>
<li><a href="../270943/index.html">Concurrent programming in Java8. Creating multi-threaded programs using the Fork / Join Framework</a></li>
<li><a href="../270949/index.html">Factorization of numbers (option 2)</a></li>
<li><a href="../270951/index.html">Underground carders market. Translation of the book "KingPIN". Chapter 17. Pizza and Plastic</a></li>
<li><a href="../270955/index.html">What's New in Veeam Backup & Replication 9.0: New Products of the Veeam Explorers Line to Recover Application Objects</a></li>
<li><a href="../270961/index.html">Financial Transmission Ways # 4: ASTS Bridge Protocol</a></li>
<li><a href="../270965/index.html">Those village from zero to one. Now and with reviews of companies</a></li>
<li><a href="../270967/index.html">NUnit 3.0 released</a></li>
<li><a href="../270969/index.html">Restoring access rights for Mac OS X - EL Capitan</a></li>
<li><a href="../270971/index.html">Travel startups. How programmers on a trillionth market are lured: kofounders, vacancies, hackathons</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>