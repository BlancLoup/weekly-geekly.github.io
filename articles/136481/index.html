<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple monitoring of SQL Server activity. Who is active?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What am I talking about? 
 Any database administrator probably had to deal with the fact that everything works slowly, or does not work at all. The fi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple monitoring of SQL Server activity. Who is active?</h1><div class="post__text post__text-html js-mediator-article"><h4>  What am I talking about? </h4><br>  Any database administrator probably had to deal with the fact that everything works slowly, or does not work at all.  The first thing you need to do is figure out what is going on in SQL Server at the moment.  It seemed that there would be so many useful pieces in the administrator‚Äôs arsenal: a guided Activity Monitor, a bunch of Dynamic Management Views (dmv), sp_who and sp_who2 stored procedures, inherited from the days of SQL Server 7 and SQL Server 2000. <br>  But let's see ... <br><a name="habracut"></a><br><h4>  Monitoring tools </h4><br><h5>  Activity Monitor </h5><br>  It would seem that a great thing, is engaged in just what you need - monitors the activity.  I run a heavy accounting report and watch what the Activity Monitor will show me. <br>  The screenshots monitor activity from SQL Server 2005: <br><img src="https://habrastorage.org/getpro/habr/post_images/32a/39f/555/32a39f555b9aca79f852bd3af8083d98.png" alt="image"><br>  and from SQL Server Denali (2012) CTP 3. <br><img src="https://habrastorage.org/getpro/habr/post_images/88e/c14/bb9/88ec14bb94095628d698a1dd9d5bb370.png" alt="image"><br>  M-yes.  And if a dozen people run such reports?  But this is not a rarity ... It will be rather inconvenient to deal with it, although, of course, progress is obvious.  In the Denali Activity Monitor it shows a lot more useful information (for example, on which particular resource is waiting), plus, we can, for example, run the profiler directly from the monitor for the necessary session and track it already in the profiler, but, damn it, it additionally loads and already loaded server.  In addition, the problem with the brakes is already there, and those requests that at the time of launching the profiler have already started to be executed, we will not see. <br>  And I want to see exactly this - who and what is performing right now. <br><br><h5>  sp_who and sp_who2 </h5><br>  In the screenshot, the result of executing sp_who (above) and sp_who2 (below), executed while building the same unfortunate report: <br><img src="https://habrastorage.org/getpro/habr/post_images/f4f/43b/1e1/f4f43b1e1e06ed27ba8541b0962cd098.png" alt="image"><br>  Yeah.  Very informative.  Looking at sp_who we can see only that something is being executed.  Of course it is executed - we are looking at it, and we see that some SELECT is executed.  Or some SELECT'ov.  Great. <br>  sp_who2 shows already more information.  Now we can see how much processor time was spent by the session (and probably add up the total time, probably) the number of i / o operations, the name of the database in which all this is done and who blocked this session (if it is locked). <br>  Activity Monitor, as we see, gives more information. <br><br><h5>  DMV </h5><br>  Beginning with SQL Server 2005, we received a new opportunity to obtain information about the state of the server - <a href="http://msdn.microsoft.com/ru-ru/library/ms188754(v%3Dsql.90).aspx">Dynamic Management Views</a> .  MSDN says this: ‚ÄúDynamic administrative views and functions return server state data that can be used to monitor the health of a server instance, diagnose problems, and tune performance.‚Äù <br>  Indeed, in 2005, SQL Server had a set of views related to the execution of queries at the moment (however, there are also views to view the ‚Äúhistory‚Äù): <a href="http://msdn.microsoft.com/ru-ru/library/ms188068(v%3Dsql.90).aspx">here they are</a> .  And their number, from version to version continues to increase! <br>  Surely, mastable administrators have a lot of scripts at their disposal to get information about the current state of the server, but what to do if there is no experience with DMV yet, and there are already problems? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  sp_WhoIsActive </h4><br>  <a href="http://sqlblog.com/blogs/adam_machanic/default.aspx">Adam Machanic</a> (SQL Server MVP and MCITP) has developed and is constantly refining the stored procedure sp_WhoIsActive, which relies on these very DMVs and is pretty darn easy to use.  Download the latest version of sp_WhoIsActive <a href="http://sqlblog.com/files/folders/35240/download.aspx">here</a> .  Adam himself has a series of articles devoted to sp_WhoIsActive, consisting of as many as 30 (thirty!) Pieces, you can read it <a href="http://sqlblog.com/blogs/adam_machanic/archive/tags/activity%2Bmonitoring/default.aspx%3Fp%3D2">here</a> , and I will try to interest you in reading this material :). <br>  So, we will assume that you downloaded and launched this script on one of the test servers (on any version from 2005 to Denali).  Adam advises to store it in the master system database so that it can be called in the context of any database, but this is not necessary, just when calling it in the context of another database, you have to write the name completely - BD.schema.sp_whoIsActive. <br>  So, let's try.  In the screenshot, the result of its execution at the time of building the same report: <br><img src="https://habrastorage.org/getpro/habr/post_images/949/03a/e22/94903ae22c80aeb51bdcf713e5c91d39.png" alt="image"><br>  The result of the exec sp_whoIsActive query is, alas, not in one screen, so here‚Äôs a text description of the output of the stored procedure called without parameters. <br><ul><li>  [dd hh: mm: ss.mss] - shows the execution time for the active query, the sleep time for the sleeping session; </li><li>  [session_id] - actually, spid; </li><li>  [sql_text] - shows the text of the query being executed now, or the text of the last executed query, if the session is sleeping; </li><li>  [login_name] - well, you understand; </li><li>  [wait_info] is a very interesting column.  It is output in the format (Ax: Bms / Cms / Dms) E.  A is the number of outstanding tasks on E. B / C / D is the wait time in milliseconds.  If there is only one session waiting for a resource to be released (as in the screenshot), its wait time will be shown, if 2 sessions are their wait times in B / C format.  If they expect 3 or more - we will see the minimum, average and maximum waiting time on this resource in the format B / C / D; </li><li>  [CPU] - for an active request - the total CPU time spent by this request, for a sleeping session - the total CPU time for the ‚Äúentire life‚Äù of this session; </li><li>  [tempdb_allocations] - for an active query - this is the number of write operations to TempDB during the query execution time;  for a sleeping session - the total number of records in TempDB for the entire lifetime of the session; </li><li>  [tempdb_current] - for active request - the number of pages in TempDB allocated for this request;  for a sleeping session - the total number of pages in TempDB allocated for the entire lifetime of the session; </li><li>  [blocking_session_id] - if we are suddenly blocked by someone, it will show the spid (session_id) of who we are blocked by; </li><li>  [reads] - for an active request - the number of logical reads performed when this request is executed;  for a sleeping session - the number of read pages for the entire life of this session; </li><li>  [writes] - all the same, but about the record; </li><li>  [physical_reads] - for an active request ‚Äî the number of physical reads executed during the execution of this request;  for a sleeping session - traditionally, the total number of physical readings for the entire life of the session; </li><li>  [used_memory] - for active request ‚Äî the number of eight-kilobyte pages used in the execution of this request;  for a sleeping session - how many total memory pages were allocated to her for all her life time; </li><li>  [status] - session status - executed, asleep, etc .; </li><li>  [open_tran_count] - shows the number of transactions opened by this session; </li><li>  [percent_complete] - indicates, if there is such an opportunity, the process of performing the operation (for example, BACKUP, RESTORE) <b>will never show how many percent the SELECT is performed</b> . </li></ul><br>  The remaining columns in the <b>standard</b> sp_WhoIsActive <b>output</b> are of little interest, and I will not describe them - I think their purpose is clear to everyone (host_name, database_name, program_name, start_time, login_time, request_id, collection_time). <br><br><h4>  And what?  It's all? </h4><br>  No, that's not all.  I will also talk about with what (the most interesting and useful, from my point of view) parameters you can call sp_WhoIsActive and what will come of it. <br><ul><li> <code>@help</code> is a terribly useful option.  When <code>sp_whoIsActive @help = 1</code> called, we get information about ALL parameters and output columns on the screen.  So if something remains unclear, you can always see the "help" </li><li>  <code>@filter_type</code> and <code>@filter</code> - allow you to filter the result of execution.  <code>@filter_type</code> can be 'session', 'program', 'database', 'login' and 'host'.  In the <a href="https://habrahabr.ru/users/filter/" class="user_link">filter</a> parameter, we specify which object of the selected type interests us.  For example, we want to see all the sessions running in the master database, for this we call <code><code>exec sp_whoIsActive @filter_type</code> = 'database', <a href="https://habrahabr.ru/users/filter/" class="user_link">filter</a> = 'master'</code> .  In the <a href="https://habrahabr.ru/users/filter/" class="user_link">filter</a> parameter it is allowed to use "%" </li><li>  <code>@not_filter_type</code> and <code>@not_filter</code> - allow us to filter "vice versa".  Ie, for example, we want to see everything except those sessions that have 'master' in the ‚Äúdatabase‚Äù field, for this we execute <code>exec sp_WhoIsActive @not_filter_type = 'database', @not_filter = 'master'</code> .  Well, or, we want to see what all users do except the sa user ... There can be many uses.  The @not_filter parameter allows the use of "%"; </li><li>  <code>@show_system_spids = 1</code> - show information about system sessions; </li><li>  <code>@get_full_inner_text = 1</code> - in the sql_text field there will be not just the text of the current request (state) in the package (batch), but the text of the whole batch; </li><li>  <code>@get_plans</code> - add a column with query plans to the output; </li><li>  <code>@get_transaction_info = 1</code> - will add to the output the number and volume of entries in the transaction logs, as well as the start time of the last transaction; </li><li>  <code>@get_locks = 1</code> - adds to the output information about all locks imposed during the execution of the query; </li><li>  <code>@find_block_leaders = 1</code> - <code>@find_block_leaders = 1</code> chain of locks and shows the total number of sessions waiting for the current session to be unlocked; </li><li>  <code>@output_column_list = '[dd%][session_id][sql_text][sql_command][login_name][wait_info][tasks][tran_log%][cpu%][temp%][block%][reads%][writes%][context%][physical%][query_plan][locks][%]'</code> - what if you don‚Äôt want to see information about tempDB in the sp_whoIsActive output?  With this parameter you can control what it displays; </li><li>  <code>@destination_table = 'table_name'</code> - will try to insert the result of the execution to write to the table, but will not check whether this table exists and whether there is enough rights to insert into it. </li></ul><br><br><h4>  Now everything </h4><br>  As a result, we have another extremely convenient and flexible tool for tracking current activity on SQL Server.  For its normal operation, the permission of VIEW SERVER STATE and the rights to access dmv are sufficient. <br>  It is also worth adding, in the case when the server can only be connected via <a href="http://msdn.microsoft.com/en-us/library/ms178068.aspx">Dedicated Admin Connection</a> , the <code>sp_whoIsActive</code> call goes off with a bang, while the Activity Monitor, alas, cannot be started. </div><p>Source: <a href="https://habr.com/ru/post/136481/">https://habr.com/ru/post/136481/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136472/index.html">Be a voice, not an echo</a></li>
<li><a href="../136475/index.html">CSS 3D effects</a></li>
<li><a href="../136477/index.html">Codeception - testing in a new way</a></li>
<li><a href="../136479/index.html">Google Cache Browser - view cache without torment</a></li>
<li><a href="../136480/index.html">As you stumble with "dead souls" registered but not using the site</a></li>
<li><a href="../136482/index.html">Implementation of ECM-solutions: what to talk with the client, part 2</a></li>
<li><a href="../136483/index.html">Face recognition by the human brain: 19 facts that computer vision researchers should be aware of</a></li>
<li><a href="../136484/index.html">Workreactor: Freelance vs Business</a></li>
<li><a href="../136491/index.html">Google+ user activity visualization</a></li>
<li><a href="../136492/index.html">Search on a site is not only search on a site</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>