<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Oil tube</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The ruble is falling, oil is getting cheaper. It has already become a habit to look in and admire graphs on Yandex: RUR / USD and USD / BAR . Naturall...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Oil tube</h1><div class="post__text post__text-html js-mediator-article">  The ruble is falling, oil is getting cheaper.  It has already become a habit to look in and admire graphs on Yandex: <a href="http://news.yandex.ru/quotes/1.html">RUR / USD</a> and <a href="http://news.yandex.ru/quotes/1006.html">USD / BAR</a> .  Naturally, at some point it became interesting in what proportion it happens - what is getting cheaper faster?  Simple multiplication, and voila - the cost of BAR / RUB.  In general, it turns out that it seems like a barrel in rubles is in place. <br><br>  And then, of course, I wanted to see long-term statistics.  Yandex explicitly on api does not provide this data, but it gives simple xml to its graphs.  Therefore - Sinatra, Bootstrap, Chart.js and Heroku. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/b5c/3b0/83a/b5c3b083a5db318b1e6cca6cb6079b05.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The most significant - fluctuations of about 3,600 rubles for the last insane 3 months.  Sharp surges - the lag of the ruble exchange rate from changes in the cost of oil. <a name="habracut"></a>  Just here frolics speculators) <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/05b/601/305/05b601305d85a757f79778c28073ca8c.png" alt="image"><br>  At a larger interval it can be seen that the current price of oil in rubles has been kept since 2011. <br><br>  It is also interesting that during the crisis of 2008 the ruble was not so rigidly tied to the cost of oil, as it is now.  On the other hand, the principle was the same - the oil price changes first, and then, with a delay, the ruble is catching up. <br><br>  Such is the simple analyst. <br><br>  The application itself: <a href="http://rubbar.herokuapp.com/">http://rubbar.herokuapp.com/</a> . <br><br>  <b>PS</b> So, congratulations, comrades, this button accordion is relevant today as never before: <br><img src="https://habrastorage.org/files/a90/e99/932/a90e99932b334ab7a3ca5c5b7102a54e.png"><br>  I just catch myself recounting how many barrels of oil I left in the supermarket, and presenting coins with cans and bills in one, half and a quarter of a barrel - since we are so attached to them. <br><br>  <b>UPD:</b> <br><br><div class="spoiler">  <b class="spoiler_title">A little bit about how the application was written and how it works inside.</b> <div class="spoiler_text">  Everything is quite simple, but since there is interest, I supplement the article. <br><br>  At first it was necessary to catch how data comes from Yandex.  It turned out two XML-ki: <a href="">graph_1.xml</a> and <a href="">graph_1006.xml</a> .  This is all the data that will be used. <br><br>  Since I myself am engaged in development on Ruby, I took the lightweight framework <a href="http://www.sinatrarb.com/">Sinatra</a> as a basis, connected the <a href="http://slim-lang.com/">Slim</a> templating system for a single view.  Two actions - one renders a template (tied to the site root), and the second <a href="">returns json with the data for the chart</a> .  To generate json, I took the <a href="https://github.com/ohler55/oj">oj</a> gem, and for parsing xml, I took <a href="https://github.com/ohler55/ox">ox</a> . <br><br>  The original data, of course, turned out to be different time stamps (the ruble / dollar and dollar / barrel rates are not updated synchronously), so the nearest update of the ruble exchange rate to the barrel update in question is taken. <br><br>  It turned out that the json-ki request takes a noticeable amount of time - primarily due to two requests to Yandex.  Therefore, the result wanted to cache.  Moreover, the data from Yandex will be updated twice a day.  Having studied the possibilities of Heroku on a free account, I was delighted with a bunch of cloud options Redis and Memcache from 5 to 25 MB, which is much more than the required amount.  But it turned out that they are provided only after entering data on a credit card, which is somewhat alarming - there is a suspicion that the money will be written off if you exceed the free volume.  And I wanted to pour in - and not think.  Therefore, a class has been filed, with the proud name <a href="">StupidCache</a> .  The point is that the application on Sinatra is resident in memory, and therefore the static class attributes are stored between requests.  All controller code turned out like this: <br><br><pre><code class="ruby hljs">get <span class="hljs-string"><span class="hljs-string">'/chart/rub_bar.json'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> result_json = StupidCache.fetch <span class="hljs-symbol"><span class="hljs-symbol">:rub_bar</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment">#     ,     Oj.dump ChartModel.get_rub_bar, mode: :compat end content_type 'application/json' result_json end</span></span></code> </pre> <br><br>  At first there were thoughts to request data for certain time intervals, but considering the size of the resulting json &lt;100KB, I decided that you can always give everything entirely - besides, you can change ranges without reloading the page. <br><br>  Left the interface itself.  For the assembly, I took <a href="http://bower.io/">bower</a> , pulled out bootstrap, jquery, <a href="http://fontawesome.io/">fontawesome</a> and <a href="http://www.chartjs.org/">chartjs</a> (then switched, though jquery and fontawesome to CDN, and fontawesome itself was useful only for the github icon in the basement). <br><br>  Special magic had to deal only with chartjs.  Chartjs is quite handy: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = { <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: labels, <span class="hljs-comment"><span class="hljs-comment">//,  ajax datasets: [ { /*       */ data: values //,  ajax } ] }; var ctx = $("#oil_chart").get(0).getContext("2d"); // #oil_chart -   canvas new Chart(ctx).Line(data, { /*     */ });</span></span></code> </pre><br><br>  What is in the application is almost a configuration out of the box, except for one trouble: if you run the above code again (and this is necessary to switch between periods), then the graphs overlap each other.  The problem was successfully crutched with this line before redrawing: <br><br><pre> <code class="javascript hljs">$(<span class="hljs-string"><span class="hljs-string">"#oil_chart"</span></span>).replaceWith(<span class="hljs-string"><span class="hljs-string">'&lt;canvas id="oil_chart" height="400"&gt;&lt;/canvas&gt;'</span></span>);</code> </pre><br><br>  Another trifle: the data for the month fits well on the screen, i.e.  30 points.  A few thousand people slow down and look bad.  Therefore, we skip the counts so that the points are from 30 to 59: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> skip = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(values_all.length/<span class="hljs-number"><span class="hljs-number">30</span></span>); skip = skip &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> ? <span class="hljs-number"><span class="hljs-number">1</span></span> : skip; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> values = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; values_all.length; i = i + skip) { values.push(values_all[i]); }</code> </pre><br><br>  And the last - on Heroku, about which there is a decent amount of articles on Habr√©. <br><br>  For production, it is better to get rid of the standard WEBrick and use the smart multi-threaded Puma.  Although Heroku and recommends Unicorn, but on a free account, so even with requests for third-party services Puma should feel much more comfortable.  To do this, simply add the gem 'puma' to the gemfile.  A Procfile has been added for the order, although without it Heroku runs everything. <br><br>  For the deployment itself, we register the account, set up their console utility, log in through it, commit the project to git, git push heroku. <br><br>  A curtain. <br><br>  <a href="https://github.com/urvalla/rub-bar">GitHab Code</a> <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/364365/">https://habr.com/ru/post/364365/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../364353/index.html">Repost content from your blog to other sites: to be or not to be?</a></li>
<li><a href="../364355/index.html">Margaret Hamilton, Lead Software Engineer, Apollo Project</a></li>
<li><a href="../364357/index.html">New Year's space gifts</a></li>
<li><a href="../364359/index.html">Curiosity Mars Rover Report: Conquering Sharpe Mountain</a></li>
<li><a href="../364361/index.html">Facebook algorithms will be able to recognize "drunken" photos.</a></li>
<li><a href="../364367/index.html">"Internet plants" for farming in the city</a></li>
<li><a href="../364369/index.html">Roscosmos plans to build a lunar base, to establish industry and mining</a></li>
<li><a href="../364371/index.html">The Orion spacecraft uses a 12-year-old processor.</a></li>
<li><a href="../364373/index.html">Strati: electric car that can be printed per day</a></li>
<li><a href="../364377/index.html">Samsung and Apple again raise prices in Russia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>