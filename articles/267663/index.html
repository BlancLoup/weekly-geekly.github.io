<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Static analysis of Mozilla Thunderbird code using PVS-Studio</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I want to talk about the verification of the Mozilla Thunderbird project with the PVS-Studio static analyzer. Using Thunderbird, I som...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Static analysis of Mozilla Thunderbird code using PVS-Studio</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/ada/8cf/335/ada8cf33568d4f92939f4b3afe0905bc.png" align="left">  In this article I want to talk about the verification of the Mozilla Thunderbird project with the PVS-Studio static analyzer.  Using Thunderbird, I sometimes encountered hangs and strange behavior of the program.  Perhaps we can find at least some of the reasons for this in the source code.  I invite you to see what mistakes can hide in such a popular project. <br><a name="habracut"></a><br><h2>  Email client Mozilla Thunderbird </h2><br>  Mozilla Thunderbird is a free, cross-platform freeware program for working with e-mail and newsgroups developed by the Mozilla Foundation.  The main advantages of using Thunderbird are the simplicity and flexibility of the program.  The user can customize the interface by changing, adding or removing buttons.  In addition to this, the installation of extensions and new themes is supported.  The program can use digital signatures, message encryption and certificate verification. <br><br><h2>  About the PVS-Studio analyzer </h2><br>  PVS-Studio is a static code analyzer for C and C ++ programs.  PVS-Studio is provided as a plug-in to the Visual Studio development system, but can also be used via the Standalone utility.  This utility has a monitoring function that tracks the compiler calls and transfers the necessary files to the analyzer.  Thus, PVS-Studio does not depend on the project build system. <br><br>  The tool is easy to use, so instead of many words, it is better to <a href="http://www.viva64.com/ru/pvs-studio-download/">download</a> and try the demo version on your own code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Build and validate Thunderbird </h2><br>  Mozilla has its own build system.  Instructions describing the basic steps for building a project can be found <a href="https://developer.mozilla.org/en-US/docs/Simple_Thunderbird_build">here</a> .  The assembly itself is made as convenient as possible for the user.  Mozilla provides a binary installer of all utilities needed for installation under windows, for example, 7zip, msys, mercurial, etc. <br><br>  The test was carried out using the compiler's call monitoring system mentioned above, which is provided by the Standalone utility included in the PVS-Studio package. <br><br><h2>  Analyzer Warnings </h2><br>  Thunderbird is a large project and uses many third-party libraries.  Most of the warnings fell on their code.  For the article, I tried to weed out these warnings and leave only those that were issued to the source code of the mail program. <br><br>  In addition, to describe the bugs in the projects of Mozilla there is a page with a description of <a href="https://bugzilla.mozilla.org/describekeywords.cgi">keywords</a> .  Among them you can find such as coverity, klocwork, valgrind and clang-anazyler.  It appears that these code analysis tools are already used in Mozilla.  So it will be interesting to look at what these analyzers did not notice. <br><br><h3>  Suspicious conditions </h3><br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0090/">warning</a> : <a href="http://www.viva64.com/ru/d/0090/">V501</a> <i>There are identical sub-expressions "aStatus == NS_ERROR_OFFLINE"</i>  <i>operator.</i>  <i>nsdocshell.cpp 7606</i> <br><pre><code class="cpp hljs">nsresult nsDocShell::EndPageLoad(nsresult aStatus, ....) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(....) { .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aStatus == NS_ERROR_NET_TIMEOUT || .... aStatus == NS_ERROR_OFFLINE || aStatus == NS_ERROR_MALWARE_URI || aStatus == NS_ERROR_PHISHING_URI || aStatus == NS_ERROR_UNWANTED_URI || aStatus == NS_ERROR_UNSAFE_CONTENT_TYPE || aStatus == NS_ERROR_REMOTE_XUL || aStatus == NS_ERROR_OFFLINE || ....) }</code> </pre> <br>  This code contains an extra check of "NS_ERROR_OFFLINE".  The list of values ‚Äã‚Äãfor which you need to check the variable aStatus is large, so you can easily make mistakes and randomly duplicate the check.  The second option may be that the programmer, after copying, inserted the same line in order not to rewrite the same part, and forgot to change the name of the constant ‚ÄúNS_ERROR_OFFLINE‚Äù.  In this case, the code lacks one necessary check. <br><br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0194/">warning</a> : <a href="http://www.viva64.com/ru/d/0194/">V590</a> <i>Consider inspecting the 'type! = (1) &amp;&amp; type == (2)' expression.</i>  <i>The expression is misprint.</i>  <i>nswindowsregkey.cpp 313</i> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> REG_SZ ( 1 ) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> REG_EXPAND_SZ ( 2 ) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> REG_MULTI_SZ ( 7 ) NS_IMETHODIMP nsWindowsRegKey::ReadStringValue(const nsAString&amp; aName, nsAString&amp; aResult) { .... </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (type != REG_SZ &amp;&amp; type == REG_EXPAND_SZ &amp;&amp; type == REG_MULTI_SZ) { return NS_ERROR_FAILURE; } .... }</span></span></code> </pre> <br>  The condition ‚Äútype == REG_EXPAND_SZ &amp;&amp; type == REG_MULTI_SZ‚Äù is always false, since one variable cannot have two values ‚Äã‚Äãat the same time.  As a result, the function will never return the error status NS_ERROR_FAILURE. <br><br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0233/">warning</a> : <a href="http://www.viva64.com/ru/d/0233/">V616</a> <i>The 'eBorderStyle_none' is in the bitwise operation.</i>  <i>nswindow.cpp 2318</i> <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> nsBorderStyle { eBorderStyle_none = <span class="hljs-number"><span class="hljs-number">0</span></span>, .... } NS_IMETHODIMP nsWindow::SetNonClientMargins(....) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!mIsTopWidgetWindow || mBorderStyle &amp; eBorderStyle_none) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NS_ERROR_INVALID_ARG; .... }</code> </pre> <br>  When checking the condition, a constant is used with a value of 0, which participates in the bitwise AND operation with a variable.  The result of the operation, of course, will also be zero.  Thus, the condition does not depend on the ‚ÄúmBorderStyle‚Äù variable. <br><br>  A similar warning: <br><br><ul><li>  V616 <i>The 'nsIDocShell :: BUSY_FLAGS_NONE' is used in the bitwise operation.</i>  <i>presentationcallbacks.cpp 105</i> </li></ul><br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0265/">warning</a> : <a href="http://www.viva64.com/ru/d/0265/">V646</a> <i>Consider inspecting the application's logic.</i>  <i>It's possible that 'else' keyword is missing.</i>  <i>nsnativethemewin.cpp 924</i> : <br><br><pre> <code class="cpp hljs">nsresult nsNativeThemeWin::GetThemePartAndState(nsIFrame* aFrame, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> aWidgetType, <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span>&amp; aPart, <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span>&amp; aState) { .... { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!aFrame) { aState = TS_NORMAL; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GetCheckedOrSelected(aFrame, !isCheckbox)) { inputState = CHECKED; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isCheckbox &amp;&amp; GetIndeterminate(aFrame)) { inputState = INDETERMINATE; } .... } .... }</code> </pre> <br>  It is possible that before the last ‚Äúif‚Äù the word else is omitted.  The code for the current view implies that both if conditions can be met, and then the value of ‚ÄúCHECKED‚Äù in the variable ‚ÄúinputState‚Äù will be changed to ‚ÄúINDETERMINATE‚Äù.  If either one condition or another were satisfied in this code, it would be more logical to use an if - else, as in the external structure. <br><br>  Another similar design is located here: <ul><li>  V646 <i>Consider inspecting the application's logic.</i>  <i>It's possible that 'else' keyword is missing.</i>  <i>debugger.cpp 4794</i> </li></ul><br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0354/">warning</a> : <a href="http://www.viva64.com/ru/d/0354/">V713</a> <i>The pointer mHTMLEditor was used for the same logical expression.</i>  <i>nshtmleditrules.cpp 6593</i> : <br><br><pre> <code class="cpp hljs">nsHTMLEditor* mHTMLEditor; nsresult nsHTMLEditRules::SplitParagraph(...) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mHTMLEditor-&gt;IsTextNode(child) || !mHTMLEditor || mHTMLEditor-&gt;IsContainer(child)) .... }</code> </pre> <br>  The SplitParagraph function in its check contains an erroneous order of arguments.  If the mHTMLEditor pointer is zero in this code, then it will be de-referenced before detecting this, which will lead to undefined behavior.  To fix the code, you need to swap "! MHTMLEditor" and "mHTMLEditor-&gt; IsTextNode (child)". <br><br>  Two similar errors are located here: <br><br><ul><li>  V713 <i>The mHTMLEditor was used in the same logical expression.</i>  <i>nshtmleditrules.cpp 7392</i> </li><li>  V713 <i>The mHTMLEditor was used in the same logical expression.</i>  <i>nshtmleditrules.cpp 7413</i> </li></ul><br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0111/">warning</a> : <a href="http://www.viva64.com/ru/d/0111/">V522</a> <i>Dereferencing of the null pointer 'aStyleValues' might take place.</i>  <i>sdnaccessible.cpp 252</i> : <br><br><pre> <code class="cpp hljs">STDMETHODIMP sdnAccessible::get_computedStyle( BSTR __RPC_FAR* aStyleProperties, BSTR __RPC_FAR* aStyleValues, <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> __RPC_FAR* aNumStyleProperties) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!aStyleProperties || aStyleValues || !aNumStyleProperties) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> E_INVALIDARG; .... aStyleValues[realIndex] = ::SysAllocString(value.get()); .... }</code> </pre> <br>  As they say, mind you prankster. <br><br><img src="https://habrastorage.org/files/606/eb4/7e1/606eb47e11e4450f8380cecfc5c81e05.png"><br><br>  The analyzer detected null pointer dereferencing.  When checking the programmer forgot to put "!"  before "aStyleValues".  Further code gets control only when this pointer is equal to zero, and leads to its dereference. <br><br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0137/">warning</a> : <a href="http://www.viva64.com/ru/d/0137/">V547</a> <i>Expression is always false.</i>  <i>Probably the '||'</i>  <i>operator should be used here.</i>  <i>nsmsgdbview.cpp 3014</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NS_NO_VTABLE</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nsMsgViewCommandType</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> { .... junk = <span class="hljs-number"><span class="hljs-number">27</span></span>, unjunk = <span class="hljs-number"><span class="hljs-number">28</span></span>, .... }; }; nsresult nsMsgDBView:: ApplyCommandToIndices(nsMsgViewCommandTypeValue command, ....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((command == nsMsgViewCommandType::junk) &amp;&amp; (command == nsMsgViewCommandType::unjunk)) .... }</code> </pre> <br>  The code corresponding to the if block will never be executed, since the command variable cannot have two values ‚Äã‚Äãat the same time.  It seems more logical to use the operator "OR" - "||". <br><br><h3>  Pointer issues </h3><br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0181/">warning</a> : <a href="http://www.viva64.com/ru/d/0181/">V579</a> <i>.</i>  <i>It is possibly a mistake.</i>  <i>Inspect the second argument.</i>  <i>nsdisplaylist.h 929</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnimatedGeometryRootLookup</span></span></span><span class="hljs-class"> {</span></span> .... <span class="hljs-function"><span class="hljs-function">PLDHashNumber </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Hash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mozilla::HashBytes(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); } .... }</code> </pre> <br>  The analyzer found it suspicious that a pointer is passed to the HashBytes function as the first argument, and a pointer size as the second.  If you search the source files for the function name, you can find the following comment in the hashfunctions.h file: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* Utilities for hashing. */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* * This file exports functions for hashing data down * to a 32-bit value, including: .... * - HashBytes Hash a byte array of known length. .... */</span></span></code> </pre> <br>  The comment suggests that the second argument should be the size of the object located at the pointer.  Most likely the correct code should look like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mozilla::HashBytes(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>));</code> </pre><br>  Let's move on to the next warning. <br><br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0226/">warning</a> : <a href="http://www.viva64.com/ru/d/0226/">V611</a>  <i>Consider inspecting operation logics behind the 'instanceData' variable.</i>  <i>nptest.cpp 971</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">NPError </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NPP_New</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... InstanceData* instanceData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InstanceData; .... <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(instanceData); .... }</code> </pre> <br>  The error lies in the fact that the memory is allocated using the operator "new", and is released using the "free".  The ‚Äúfree‚Äù function does not call the destructor of the object located on this pointer.  This means that if the object contained more pointers with allocated memory, it will not be freed and a leak will occur. <br><br>  And in general, this can not be done.  Such code leads to undefined program behavior. <br><br>  PVS-Studio Warning: <a href="http://www.viva64.com/ru/d/0230/">V614</a> <i>Potentially uninitialized pointer 'hOldFont' used.</i>  <i>progressui_win.cpp 168</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitDialog</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... HFONT hInfoFont, hOldFont; hInfoFont = (HFONT)SendMessage(hWndInfo, WM_GETFONT, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hInfoFont) hOldFont = (HFONT)SelectObject(hDCInfo, hInfoFont); .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hOldFont) SelectObject(hDCInfo, hOldFont); .... }</code> </pre> <br>  If the ‚ÄúSendMessage‚Äù function returns zero, the result of the next check will be false, which means the hOldFont variable will not be initialized.  The variable will have a random value that may not be zero.  If it is not 0, then this random value will be passed to the SelectObject function. <br><br>  Another similar situation may arise here: <br><br><ul><li>  V614 <i>Potentially uninitialized pointer 'queryD3DKMTStatistics' used.</i>  <i>gfxwindowsplatform.cpp 206</i> </li></ul><br><h3>  Copy-paste errors </h3><br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0106/">warning</a> : <a href="http://www.viva64.com/ru/d/0106/">V517</a> <i>The use of if (A) {...} else if (A) {...} 'pattern was detected.</i>  <i>There is a possibility of logical error presence.</i>  <i>Check lines: 1060, 1062. nsstylestruct.cpp 1060</i> : <br><br><pre> <code class="cpp hljs">nsStyleClipPath::nsStyleClipPath(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> nsStyleClipPath&amp; aSource) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aSource.mType == NS_STYLE_CLIP_PATH_URL) { SetURL(aSource.mURL); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aSource.mType == NS_STYLE_CLIP_PATH_SHAPE) { SetBasicShape(aSource.mBasicShape, aSource.mSizingBox); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aSource.mType == NS_STYLE_CLIP_PATH_SHAPE) { SetSizingBox(aSource.mSizingBox); } }</code> </pre> <br>  The ‚Äúif - else if‚Äù block contains a duplicate equality test, called by the copy-paste method.  This means that the last part of the code corresponding to the second check on ‚ÄúNS_STYLE_CLIP_PATH_SHAPE‚Äù will never be executed. <br><br><img src="https://habrastorage.org/files/d16/0fc/b2a/d160fcb2aaaf4af89eb83ef8a88895a4.png"><br><br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0112/">warning</a> : <a href="http://www.viva64.com/ru/d/0112/">V523</a> <i>The 'then' statement is equivalent to the 'else' statement.</i> <i><br></i>  <i>mozspelli18nmanager.cpp 34</i> : <br><br><pre> <code class="cpp hljs">NS_IMETHODIMP mozSpellI18NManager::GetUtil(mozISpellI18NUtil **_retval, ....) { .... nsAutoString lang; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(lang.EqualsLiteral(<span class="hljs-string"><span class="hljs-string">"en"</span></span>)) { *_retval = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> mozEnglishWordUtils; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { *_retval = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> mozEnglishWordUtils; } NS_IF_ADDREF(*_retval); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NS_OK; }</code> </pre> <br>  The analyzer paid attention to the fact that the same actions correspond to the if and else blocks.  This may be an error when copying, a superfluous condition or simply unfinished code.  Anyway, in this form, the condition does not make sense. <br><br>  Some more similar errors: <br><br><ul><li>  V523 <i>The 'then' statement is equivalent to the 'else' statement.</i>  <i>jemalloc.c 6504</i> </li><li>  V523 <i>The 'then' statement is equivalent to the 'else' statement.</i>  <i>nsnativethemewin.cpp 1007</i> </li><li>  V523 <i>The 'then' statement is equivalent to the 'else' statement.</i>  <i>msgmapihook.cpp 677</i> </li></ul><br><h3>  Indefinite behavior </h3><br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0205/">warning</a> : <a href="http://www.viva64.com/ru/d/0205/">V595</a> <i>The 'aParent' pointer was used before it was verified against nullptr.</i>  <i>Check lines: 511, 518. nsgenericdomdatanode.cpp 511</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NS_ADDREF(_ptr) \ (_ptr)-&gt;AddRef() nsresult nsGenericDOMDataNode::BindToTree(nsIContent* aParent, ....) { .... ShadowRoot* parentContainingShadow = aParent-&gt;GetContainingShadow(); .... </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (aParent) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!GetParent()) { NS_ADDREF(aParent); } mParent = aParent; } .... }</span></span></code> </pre> <br>  Checking the ‚ÄúaParent‚Äù pointer indicates that it may be null.  This means that the first time it is dereferenced, which occurs before the inspection, we risk getting undefined behavior. <br><br>  The V595 warning is one of the most common among checked projects, and Thunderbird is no exception.  In total, the analyzer issued <a href="http://www.viva64.com/external-pictures/txt/Thunderbird_V595.txt">95 warnings</a> related directly to the Thunderbird code. <br><br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0225/">warning</a> : <a href="http://www.viva64.com/ru/d/0225/">V610</a> <i>Undefined behavior.</i>  <i>Check the shift operator '&lt;&lt;'.</i>  <i>The left operand '~ 0L' is negative.</i>  <i>nsprotocolproxyservice.cpp 336</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">proxy_MaskIPv6Addr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PRIPv6Addr &amp;addr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> mask_len)</span></span></span><span class="hljs-function"> </span></span>{ .... addr.pr_s6_addr32[<span class="hljs-number"><span class="hljs-number">3</span></span>] = PR_htonl( PR_ntohl(addr.pr_s6_addr32[<span class="hljs-number"><span class="hljs-number">3</span></span>]) &amp; (~<span class="hljs-number"><span class="hljs-number">0L</span></span> &lt;&lt; (<span class="hljs-number"><span class="hljs-number">128</span></span> - mask_len))); .... }</code> </pre> <br>  When one of the left-shift parameters is a negative number, the behavior is undefined.  Here is what is said about this in the standard: <br><br>  <i>The shift operators &lt;&lt; and &gt;&gt; group left-to-right.</i>  <i>shift-expression &lt;&lt; additive-expression, shift-expression &gt;&gt; additive-expression.</i> <br><br>  <i>This is an integral part of this article.</i>  <i>1. The promoted left operand.</i>  <i>If you are the right operand.</i>  <i>2. ... If you want to use it, it‚Äôs possible to make it easier to use it.</i>  <i>Otherwise, if E1 is a signed type and non-negative value, and E1 * 2 ^ E2 is representable, then that is the resulting value;</i>  <i>otherwise, <b>the behavior is undefined</b> .</i>  <i>...</i> <br><br>  3 more cases of indefinite behavior: <br><br><ul><li>  V610 <i>Undefined behavior.</i>  <i>Check the shift operator '&lt;&lt;'.</i>  <i>The left operand '~ 0L' is negative.</i>  <i>nsprotocolproxyservice.cpp 341</i> </li><li>  V610 <i>Undefined behavior.</i>  <i>Check the shift operator '&lt;&lt;'.</i>  <i>The left operand '~ 0L' is negative.</i>  <i>nsprotocolproxyservice.cpp 347</i> </li><li>  V610 <i>Undefined behavior.</i>  <i>Check the shift operator '&lt;&lt;'.</i>  <i>The left operand '~ 0L' is negative.</i>  <i>nsprotocolproxyservice.cpp 354</i> </li></ul><br><h3>  Warnings with features </h3><br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0208/">warning</a> : <a href="http://www.viva64.com/ru/d/0208/">V597</a> <i>The compiler could delete the memset function call, which is used to flush the ctx object.</i>  <i>The RtlSecureZeroMemory () function should be used to erase the private data.</i>  <i>gmploader.cpp 166</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> GMPLoaderImpl::Load(....) { SHA256Context ctx; .... <span class="hljs-comment"><span class="hljs-comment">// Overwrite all data involved in calculation as it could //potentially identify the user, so there's no chance a GMP //can read it and use it for identity tracking. memset(&amp;ctx, 0, sizeof(ctx)); .... }</span></span></code> </pre> <br>  Here the analyzer noticed that the call to the 'memset' function can be deleted.  Since the variable 'ctx' is not used further, the compiler has every right to remove the ‚Äúmemset‚Äù call when optimizing.  In Windows, you can use the RtlSecureZeroMemory feature. <br><br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0119/">warning</a> : <a href="http://www.viva64.com/ru/d/0119/">V530</a> <i>The return value of the 'getenv' is required to be utilized.</i> <i><br></i>  <i>nswindowswmain.cpp 134</i> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wmain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, WCHAR **argv)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-comment"><span class="hljs-comment">// Force creation of the multibyte _environ variable. getenv("PATH"); int result = main(argc, argvConverted, _environ); .... }</span></span></code> </pre> <br>  Here we are dealing with a call to the function ‚Äúgetenv‚Äù, the result of which is not used and is not even written to a variable.  Here‚Äôs how this feature is described on cplusplus.com. <br><br>  <i>This is where the environment variable is defined.</i>  <i>The function returns a null pointer.</i> <br><br>  <s>Using "getenv" in this form is meaningless and only confusing when reading the code.</s> <br><br>  <b>UPD</b> : <a href="http://habrahabr.ru/company/pvs-studio/blog/267663/">habrahabr.ru/company/pvs-studio/blog/267663/#comment_8589575</a> <br><br><h3>  Other warnings </h3><br><img src="https://habrastorage.org/files/b78/dfd/3d5/b78dfd3d53504c7ca5b0233a6bb521b0.png"><br><br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0224/">warning</a> : <a href="http://www.viva64.com/ru/d/0224/">V609</a> <i>Divide by zero.</i>  <i>Denominator range [0..8].</i>  <i>ionbuilder.cpp 10922</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> size_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UnboxedTypeSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JSValueType type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (type) { .... <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } } MInstruction*IonBuilder::loadUnboxedProperty(<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset, JSValueType unboxedType, ....) { <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> index = offset / UnboxedTypeSize(unboxedType); .... }</code> </pre> <br>  Since the ‚ÄúUnboxedTypeSize‚Äù function can return zero, potentially we are dealing with division by zero.  If a new type is transferred to the ‚ÄúUnboxedTypeSize‚Äù function, it will return the default zero value, which will lead to an exception.  Better to be safe and add a check before dividing. <br><br>  Another potential division by zero: <br><br><ul><li>  V609 <i>Divide by zero.</i>  <i>Denominator range [0..8].</i>  <i>ionbuilder.cpp 11844</i> </li></ul><br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0238/">warning</a> : <a href="http://www.viva64.com/ru/d/0238/">V621</a> <i>Consider inspecting the 'for' operator.</i>  <i>It is possible that you will not be executed at all.</i>  <i>nsmsgdbfolder.cpp 4501</i> : <br><br><pre> <code class="cpp hljs">NS_IMETHODIMP nsMsgDBFolder::GetDisplayRecipients(<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> *displayRecipients) { .... <span class="hljs-comment"><span class="hljs-comment">// There's one FCC folder for sent mail, and one for sent news nsIMsgFolder *fccFolders[2]; int numFccFolders = 0; for (int i = 0; i &lt; numFccFolders; i++) { .... } .... }</span></span></code> </pre> <br>  The analyzer found a suspicious place in which the loop does not go through a single iteration.  The reason for this is the variable "numFccFolders", the value of which is zero.  Perhaps this assignment is done for some purpose, but it is also possible that this is a typo.  The comment and pointer declaration above suggest that the variable should be 2. <br><br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0312/">warning</a> : <a href="http://www.viva64.com/ru/d/0312/">V678</a> <i>An object is used as an argument to its own method.</i>  <i>Consider checking this function.</i>  <i>nsgenerichtmlelement.h 411</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nsGenericHTMLElement</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> nsGenericHTMLElementBase, <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> nsIDOMHTMLElement { .... <span class="hljs-function"><span class="hljs-function">NS_IMETHOD </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetItemId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(nsAString&amp; aId)</span></span></span><span class="hljs-function"> final override </span></span>{ nsString id; GetItemId(id); aId.Assign(aId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NS_OK; } .... }</code> </pre> <br>  In itself, using the "aId" object as an argument in its own method is not an error.  But this code is suspicious because the function uses a variable with a similar name ‚Äúid‚Äù.  This suggests that there is a typo and the argument of the function "aId.Assign" should be the variable "id". <br><br>  PVS-Studio <a href="http://www.viva64.com/ru/d/0300/">warning</a> : <a href="http://www.viva64.com/ru/d/0300/">V670</a> <i>The uninitialized class member 'mWorkerConnection' is used to initialize the 'mWorkerStatements' member.</i>  <i>Remember that members are initialized in the order of declarations inside a class.</i>  <i>domstoragedbthread.cpp 50</i> <br><br><pre> <code class="cpp hljs">DOMStorageDBThread::DOMStorageDBThread() : mWorkerStatements(mWorkerConnection) , .... {} <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DOMStorageDBThread</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DOMStorageDBBridge { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: .... StatementCache mWorkerStatements; <span class="hljs-comment"><span class="hljs-comment">//&lt;=line 304 .... nsCOMPtr&lt;mozIStorageConnection&gt; mWorkerConnection; //&lt;=line 309 .... }</span></span></code> </pre> <br>  When using the initialization list, one thing should be remembered: the variables are initialized in the order in which they are declared in the class, and the order in the initialization list does not matter.  In this code, the "mWorkerStatements" variable is initialized by the "mWorkerConnection" object of another class.  But at the time of initialization, a constructor was not yet called for this object, since it was declared later in the class than the variable ‚ÄúmWorkerStatements‚Äù.  To fix this, it is enough to swap the declaration of these two objects in the class. <br><br>  In this class there is another similar bug: <br><br><ul><li>  V670 <i>The uninitialized class member 'mReaderConnection' is used to initialize the 'mReaderStatements' member.</i>  <i>Remember that members are initialized in the order of declarations inside a class.</i>  <i>domstoragedbthread.cpp 51</i> </li></ul><br><h2>  Conclusion </h2><br>  Summing up, I would like to note that PVS-Studio found many suspicious places in the Mozilla Thunderbird project.  Most of them belong to third-party libraries.  Nevertheless, in the Thunderbird found some interesting errors. <br><br>  To write a big project without errors is beyond the power of even the most experienced and attentive programmers.  For such purposes, there are static code analyzers.  Using them will help you save time searching for old mistakes and prevent new ones.  I suggest trying PVS-Studio on your project: <a href="http://www.viva64.com/ru/pvs-studio-download/">http://www.viva64.com/ru/pvs-studio-download/</a> . <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0347/"><img src="https://habrastorage.org/files/9dd/4ba/bc6/9dd4babc6fba4e8184afa3a8c5148288.png"></a> </div><br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Igor Shtukarev.  <a href="http://www.viva64.com/en/b/0347/">Static Analysis of Mozilla Thunderbird's Code by PVS-Studio</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/267663/">https://habr.com/ru/post/267663/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../267645/index.html">Another built-in spyware application detected on Lenovo computers</a></li>
<li><a href="../267647/index.html">FirebirdSQL is used by 11 companies from the TOP-500 list of Russia</a></li>
<li><a href="../267651/index.html">Hungarian algorithm in the task of tracking a multitude of moving objects</a></li>
<li><a href="../267655/index.html">We write the driver of the user environment for uinput on Raspberry Pi</a></li>
<li><a href="../267661/index.html">Create a REST service on Rust. Part 2: we read INI; multirust</a></li>
<li><a href="../267665/index.html">Switch company builds the largest data center in the world</a></li>
<li><a href="../267669/index.html">Shortcuts for web panels and an improved list of entered addresses in Vivaldi 1.0.283.8</a></li>
<li><a href="../267671/index.html">Software development: stages and principles</a></li>
<li><a href="../267673/index.html">How to evaluate the quality of the product</a></li>
<li><a href="../267675/index.html">Software support</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>