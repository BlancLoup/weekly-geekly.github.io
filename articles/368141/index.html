<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Efficient interoperability between native Arduino and Linux processes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Using Arduino sketches for working with Intel Galileo and Intel Edison boards, you may encounter a situation where you need to add additional function...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Efficient interoperability between native Arduino and Linux processes</h1><div class="post__text post__text-html js-mediator-article">  Using Arduino sketches for working with Intel Galileo and Intel Edison boards, you may encounter a situation where you need to add additional functionality by using the Yocto kit to develop embedded systems based on Linux OS.  And here we have to solve the problem, which we have already mentioned in the title of our post: how to establish effective ‚Äúcommunication‚Äù between these two worlds. <br><br> <a href="http://geektimes.ru/company/intel/blog/261350/"><img src="https://habrastorage.org/files/6ba/d90/0af/6bad900af68c4625916dd15f77db3be8.jpg"></a> <br><a name="habracut"></a><br>  Let's define some criteria that we need to take into account: <br><br><h2>  <font color="#0071c5">Criteria</font> </h2><br>  1. No disk sharing (SD card, eMMC) to reduce disk wear and increase performance. <br>  2. Communication is caused solely by any events (in particular, we do not need to periodically check the status, but we want to receive notification of a particular event, otherwise - not to activate the data exchange). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  <font color="#0071c5">Interprocess Communication (IPC) on Linux</font> </h2><br>  A program created in the Arduino environment (sketch) and run on Intel Galileo or Intel Edison is a Linux process running in parallel with other similar processes.  Since we are dealing with a full-fledged Linux system running on these boards, it is also possible to use standard means for interprocess communication (IPC) between Arduino processes and native processes.  For Linux, there are various IPC methods.  One of them is the ‚Äúmapped IPC‚Äù.  In essence, this means that IPC processes share the same memory area.  In turn, this means that any modifications made by one process that uses a specific area of ‚Äã‚Äãmemory immediately become visible to all other processes.  This behavior satisfies our first criterion: during data transfer, we work with the latter exclusively in memory, they are not written to disk. <br><br><h2>  <font color="#0071c5">Mutexes and condition variables</font> </h2><br>  The use of shared memory immediately raises a couple of questions, such as: <br><br>  <b>1.</b> How to make sure that in a shared data at any particular time only one process is performed (synchronization)? <br><br>  <b>2.</b> How to instantly notify another process (or processes) of data changes (notification)? <br><br>  Below we consider these two questions in turn.  We will make it possible to use "mutexes" and "condition variables" that are included in the POSIX thread library (Pthreads) available for the Linux system. <br><br><h2>  <font color="#0071c5">Sync - Mutex</font> </h2><br>  Mutual exclusion, or mutex (mutex) - is a standard principle that is implemented, perhaps, in any modern multitasking OS.  In this post, we will not describe all the principles and details, but only share specific information regarding the mutexes from the POSIX (Pthreads) thread set.  For more information, refer to paper editions (for example, Tanenbaum, Woodhull: Operating Systems 3rd ed. Pearson 2006) or use Internet search. <br><br>  As the name of the library suggests, the Pthreads suite is mainly intended for streaming programming.  At the same time, it also offers powerful tools applicable to process management.  Moreover, the Arduino IDE development environment for Intel Galileo and Intel Edison boards supports the Pthreads library (i.e., links to this library) out of the box, thus offering easy-to-implement integration.  Therefore, using Pthreads for our purposes looks like a logical decision. <br><br>  As a rule, a mutex ensures that only one thread receives access to a certain critical section of code.  Since we are dealing with processes here, let's use mutexes so that only one process can access the pthread_mutex_lock request in the code.  All other processes will be put into sleep mode by the OS itself - just until the mutex receives the pthread_mutex_unlock command, after which the OS will wake up all other processes, requesting pthread_mutex_lock. <br><br>  Pseudocode: <br><br><pre><code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">pthread_mutex_lock</span></span>(&amp;mutex); // read / write shared memory <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> here pthread_mutex_unlock(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mutex</span></span></span><span class="hljs-class">);</span></span></code> </pre> <br>  This must be done in the same way, both for blocking the record and blocking access to reading.  Otherwise, in the process of reading can be accessed to partially updated data.  In the next section, we will talk about the principles of operation of the Pthreads elements, which allow you to receive a notification in case of data changes. <br><br><h2>  <font color="#0071c5">Notification - Conditional Variable</font> </h2><br>  Similar to the principle that when a process tries to access a locked mutex, the Pthreads library also includes condition variables.  A condition variable allows the thread or (in our case) process to request permission to sleep until it is awakened.  This is implemented through the pthread_cond_wait function. <br><br>  The mutex and condition variable in combination give the following pseudocode: <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">pthread_mutex_lock</span></span>(&amp;mutex); pthread_cond_wait(&amp;cond_variable, &amp;mutex); // read shared memory <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> here pthread_mutex_unlock(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mutex</span></span></span><span class="hljs-class">);</span></span></code> </pre> <br>  Another process needs to unlock the mutex and send a change signal by calling pthread_cond_signal.  This will wake the process from sleep mode. <br><br>  More information can be found in specialized publications or on the relevant online resources.  The following section presents an example code implementation. <br><br><h2>  <font color="#0071c5">Implementation</font> </h2><br>  Some explanations: <br><br><ul><li>  For both the mutex and the condition variable, we need to explicitly set the attributes in order to allow interprocess use. <br><br></li><li>  We chose to use IPC shared memory through memory-mapped files, since the Arduino IDE does not support all the libraries needed to implement direct IPC memory allocation.  Placing a file to exchange data in a file system mapped to main memory essentially provides identical functionality.  The Yocto Linux platform, which comes bundled with the Intel Edison board, as well as the Yocto image for the SD card, includes a temporary / tmp folder mounted in the tmpfs storage that resides in memory.  That is, we can use any file in this folder.  We have chosen the file / tmp / arduino, it is intended exclusively for use in the IPC. <br><br></li><li>  We assume that it is the Arduino process that will start the mutex and the condition variable, since this is the process that is executed during system loading. <br><br></li><li>  In our example, the situation is shown when the Arduino process expects data from the native Linux process and runs on the basis of the received data.  For all other options, the code should be changed accordingly. <br><br></li><li>  In order to show the principle of operation, we put two boolean (logical) in the memory- <em>mapped</em> structure <em>mmapData</em> , which defines the on and off indicators (built-in and external on IO 8): <br><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">bool</span></span> led8_on; // led <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> IO8 <span class="hljs-type"><span class="hljs-type">bool</span></span> led13_on; // built-<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> led</code> </pre> <br>  Obviously, you can put any data here.  The two other variables in the <em>mmapData</em> structure are a mutex and a condition variable. </li></ul><br><h2>  <font color="#0071c5">Note:</font> </h2><br>  Sample code below is supplied under the MIT License.  Below you will find three files: <br><br><ul><li>  <b>mmap.ino</b> : a sketch to launch in the Arduino IDE development environment <br></li><li>  <b>mmap.cpp</b> : a native process responsible for sending data <br></li><li>  <b>mmap.h</b> : header file - file for use in the Arduino IDE, as well as in Linux <br></li></ul><br>  That is, on the Arduino side, you should have a folder that contains the mmap.ino and mmap.h files in the Arduino sketches directory.  In Linux, you should use the folder containing the files mmap.cpp and mmap.r. <br><br>  To run the sketch, open the mmap program in the Arduino IDE development environment and load it into the appropriate board (Intel Galileo Gen 1, Intel Galileo Gen 2 or Intel Edison).  The <a href="https://software.intel.com/iot">Intel IoT</a> Developer Package comes with a cross-compiler.  In addition, the Yocto platform, which comes bundled with Intel Edison, as well as the Yocto image for an SD card, or the Intel Galileo board, comes with a pre-installed C ++ compiler.  To run the pre-installed compiler, you need to run: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">g</span></span>++ <span class="hljs-selector-tag"><span class="hljs-selector-tag">mmap</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cpp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-lpthread</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-o</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mmap</span></span></code> </pre> <br>  The folder should be placed files mmap.cpp and mmap.h.  This will generate a binary file that can be run as follows: <br><br><pre> <code class="hljs">./mmap {0,1}{0,1}</code> </pre> <br>  ... where "{0,1}" appears for 0 or 1. For example, the expression "./mmap 00" turns off both indicators, while the command ./mmap 00 will turn them on.  Some additional information is output to the serial monitor (Ctrl + Shift + M). <br><br><h2>  <font color="#0071c5">mmap.ino</font> </h2><br><pre> <code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">/* * Author: Matthias Hahn &lt;matthias.hahn@intel.com&gt; * Copyright (C) 2014 Intel Corporation * This file is part of mmap IPC sample provided under the MIT license * * Permission is hereby granted, free of charge, to any person obtaining a copy * of this software and associated documentation files (the "Software"), to deal * in the Software without restriction, including without limitation the rights * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell * copies of the Software, and to permit persons to whom the Software is * furnished to do so, subject to the following conditions: * The above copyright notice and this permission notice shall be included in * all copies or substantial portions of the Software. * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN * THE SOFTWARE. */</span></span> #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "mmap.h" <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> namespace std; <span class="hljs-comment"><span class="hljs-comment">/* assume /tmp mounted on /tmpfs -&gt; all operation in memory */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* we can use just any file in tmpfs. assert(file size not modified &amp;&amp; file permissions left readable) */</span></span> struct mmapData* p_mmapData; // here our mmapped data will be accessed <span class="hljs-type"><span class="hljs-type">int</span></span> led8 = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-type"><span class="hljs-type">int</span></span> led13 = <span class="hljs-number"><span class="hljs-number">13</span></span>; <span class="hljs-type"><span class="hljs-type">void</span></span> exitError(const <span class="hljs-type"><span class="hljs-type">char</span></span>* errMsg) { <span class="hljs-comment"><span class="hljs-comment">/* print to the serial Arduino is attached to, ie /dev/ttyGS0 */</span></span> string s_cmd("echo 'error: "); s_cmd = s_cmd + errMsg + " - exiting' &gt; /dev/ttyGS0"; <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>(s_cmd.c_str()); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(EXIT_FAILURE); } <span class="hljs-type"><span class="hljs-type">void</span></span> setup() { <span class="hljs-type"><span class="hljs-type">int</span></span> fd_mmapFile; // file descriptor <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> memory mapped file <span class="hljs-comment"><span class="hljs-comment">/* open file and mmap mmapData*/</span></span> fd_mmapFile = <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(mmapFilePath, O_CREAT | O_RDWR, S_IRUSR | S_IWUSR); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fd_mmapFile == <span class="hljs-number"><span class="hljs-number">-1</span></span>) exitError("couldn't open mmap file"); <span class="hljs-comment"><span class="hljs-comment">/* make the file the right size - exit if this fails*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ftruncate(fd_mmapFile, sizeof(struct mmapData)) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) exitError("couldn' modify mmap file"); <span class="hljs-comment"><span class="hljs-comment">/* memory map the file to the data */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* assert(filesize not modified during execution) */</span></span> p_mmapData = static_cast&lt;struct mmapData*&gt;(mmap(<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, sizeof(struct mmapData), PROT_READ | PROT_WRITE, MAP_SHARED, fd_mmapFile, <span class="hljs-number"><span class="hljs-number">0</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p_mmapData == MAP_FAILED) exitError("couldn't mmap"); <span class="hljs-comment"><span class="hljs-comment">/* initialize mutex */</span></span> pthread_mutexattr_t mutexattr; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pthread_mutexattr_init(&amp;mutexattr) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) exitError("pthread_mutexattr_init"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pthread_mutexattr_setrobust(&amp;mutexattr, PTHREAD_MUTEX_ROBUST) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) exitError("pthread_mutexattr_setrobust"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pthread_mutexattr_setpshared(&amp;mutexattr, PTHREAD_PROCESS_SHARED) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) exitError("pthread_mutexattr_setpshared"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pthread_mutex_init(&amp;(p_mmapData-&gt;mutex), &amp;mutexattr) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) exitError("pthread_mutex_init"); <span class="hljs-comment"><span class="hljs-comment">/* initialize condition variable */</span></span> pthread_condattr_t condattr; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pthread_condattr_init(&amp;condattr) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) exitError("pthread_condattr_init"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pthread_condattr_setpshared(&amp;condattr, PTHREAD_PROCESS_SHARED) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) exitError("pthread_condattr_setpshared"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pthread_cond_init(&amp;(p_mmapData-&gt;cond), &amp;condattr) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) exitError("pthread_mutex_init"); <span class="hljs-comment"><span class="hljs-comment">/* for this test we just use 2 LEDs */</span></span> pinMode(led8, OUTPUT); pinMode(led13, OUTPUT); } <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>() { <span class="hljs-comment"><span class="hljs-comment">/* block until we are signalled from native code */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pthread_mutex_lock(&amp;(p_mmapData-&gt;mutex)) != <span class="hljs-number"><span class="hljs-number">0</span></span>) exitError("pthread_mutex_lock"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pthread_cond_wait(&amp;(p_mmapData-&gt;cond), &amp;(p_mmapData-&gt;mutex)) != <span class="hljs-number"><span class="hljs-number">0</span></span>) exitError("pthread_cond_wait"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p_mmapData-&gt;led8_on) { <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>("echo 8:1 &gt; /dev/ttyGS0"); digitalWrite(led8, HIGH); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>("echo 8:0 &gt; /dev/ttyGS0"); digitalWrite(led8, LOW); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p_mmapData-&gt;led13_on) { <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>("echo 13:1 &gt; /dev/ttyGS0"); digitalWrite(led13, HIGH); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>("echo 13:0 &gt; /dev/ttyGS0"); digitalWrite(led13, LOW); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pthread_mutex_unlock(&amp;(p_mmapData-&gt;mutex)) != <span class="hljs-number"><span class="hljs-number">0</span></span>) exitError("pthread_mutex_unlock"); }</code> </pre> <br><br><h2>  <font color="#0071c5">mmap.cpp</font> </h2><br><pre> <code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">/* * Author: Matthias Hahn &lt;matthias.hahn@intel.com&gt; * Copyright (C) 2014 Intel Corporation * This file is part of mmap IPC sample provided under the MIT license * * Permission is hereby granted, free of charge, to any person obtaining a copy * of this software and associated documentation files (the "Software"), to deal * in the Software without restriction, including without limitation the rights * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell * copies of the Software, and to permit persons to whom the Software is * furnished to do so, subject to the following conditions: * The above copyright notice and this permission notice shall be included in * all copies or substantial portions of the Software. * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN * THE SOFTWARE. */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* mmap.cpp Linux native program communicating via memory mapped data with Arduino sketch. Compilation: g++ mmap.cpp -lpthread -o mmap Run: ./mmap &lt;LED8&gt;&lt;LED13&gt; (eg ./mmap 01 -&gt; LED 8 off, LED 13 on) For "random" blink you may run following commands in the command line: while [ 1 ]; do ./mmap $(($RANDOM % 2))$(($RANDOM % 2)); done */</span></span> #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "mmap.h" <span class="hljs-type"><span class="hljs-type">void</span></span> exitError(const <span class="hljs-type"><span class="hljs-type">char</span></span>* errMsg) { perror(errMsg); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(EXIT_FAILURE); } <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> namespace std; <span class="hljs-comment"><span class="hljs-comment">/** * @brief: for this example uses a binary string "&lt;led8&gt;&lt;led13&gt;"; eg "11": both leds on * if no arg equals "00" * For "random" blink you may run following commands in the command line: * while [ 1 ]; do ./mmap $(($RANDOM % 2))$(($RANDOM % 2)); done */</span></span> <span class="hljs-type"><span class="hljs-type">int</span></span> main(<span class="hljs-type"><span class="hljs-type">int</span></span> argc, <span class="hljs-type"><span class="hljs-type">char</span></span>** argv) { struct mmapData* p_mmapData; // here our mmapped data will be accessed <span class="hljs-type"><span class="hljs-type">int</span></span> fd_mmapFile; // file descriptor <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> memory mapped file <span class="hljs-comment"><span class="hljs-comment">/* Create shared memory object and set its size */</span></span> fd_mmapFile = <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(mmapFilePath, O_CREAT | O_RDWR, S_IRUSR | S_IWUSR); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fd_mmapFile == <span class="hljs-number"><span class="hljs-number">-1</span></span>) exitError("fd error; check errno for details"); <span class="hljs-comment"><span class="hljs-comment">/* Map shared memory object read-writable */</span></span> p_mmapData = static_cast&lt;struct mmapData*&gt;(mmap(<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, sizeof(struct mmapData), PROT_READ | PROT_WRITE, MAP_SHARED, fd_mmapFile, <span class="hljs-number"><span class="hljs-number">0</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p_mmapData == MAP_FAILED) exitError("mmap error"); <span class="hljs-comment"><span class="hljs-comment">/* the Arduino sketch might still be reading - by locking this program will be blocked until the mutex is unlocked from the reading sketch * in order to prevent race conditions */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pthread_mutex_lock(&amp;(p_mmapData-&gt;mutex)) != <span class="hljs-number"><span class="hljs-number">0</span></span>) exitError("pthread_mutex_lock"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (argc == <span class="hljs-number"><span class="hljs-number">1</span></span>) { cout &lt;&lt; "8:0" &lt;&lt; endl; cout &lt;&lt; "13:0" &lt;&lt; endl; p_mmapData-&gt;led8_on = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; p_mmapData-&gt;led13_on = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (argc &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { // <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(correct string given) <span class="hljs-type"><span class="hljs-type">int</span></span> binNr = atol(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (binNr &gt;= <span class="hljs-number"><span class="hljs-number">10</span></span>) { cout &lt;&lt; "8:1" &lt;&lt; endl; p_mmapData-&gt;led8_on = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { cout &lt;&lt; "8:0" &lt;&lt; endl; p_mmapData-&gt;led8_on = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } binNr %= <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (binNr == <span class="hljs-number"><span class="hljs-number">1</span></span>) { cout &lt;&lt; "13:1" &lt;&lt; endl; p_mmapData-&gt;led13_on = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { cout &lt;&lt; "13:0" &lt;&lt; endl; p_mmapData-&gt;led13_on = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } // signal <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> waiting thread <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pthread_mutex_unlock(&amp;(p_mmapData-&gt;mutex)) != <span class="hljs-number"><span class="hljs-number">0</span></span>) exitError("pthread_mutex_unlock"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pthread_cond_signal(&amp;(p_mmapData-&gt;cond)) != <span class="hljs-number"><span class="hljs-number">0</span></span>) exitError("pthread_cond_signal"); }</code> </pre> <br><br><h2>  <font color="#0071c5">mmap.h</font> </h2><br><pre> <code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">/* * Author: Matthias Hahn &lt;matthias.hahn@intel.com&gt; * Copyright (C) 2014 Intel Corporation * This file is part of mmap IPC sample provided under the MIT license * * Permission is hereby granted, free of charge, to any person obtaining a copy * of this software and associated documentation files (the "Software"), to deal * in the Software without restriction, including without limitation the rights * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell * copies of the Software, and to permit persons to whom the Software is * furnished to do so, subject to the following conditions: * The above copyright notice and this permission notice shall be included in * all copies or substantial portions of the Software. * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN * THE SOFTWARE. */</span></span> #ifndef MMAP_HPP #define MMAP_HPP #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> &lt;fcntl.h&gt; #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> &lt;unistd.h&gt; #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> &lt;sys/mman.h&gt; #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> &lt;iostream&gt; #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> &lt;string.h&gt; #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> &lt;stdlib.h&gt; #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> &lt;cstdio&gt; #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> &lt;pthread.h&gt; <span class="hljs-comment"><span class="hljs-comment">/* assert(/tmp mounted to tmpfs, ie resides in RAM) */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* just use any file in /tmp */</span></span> static const <span class="hljs-type"><span class="hljs-type">char</span></span>* mmapFilePath = "/tmp/arduino"; struct mmapData { <span class="hljs-type"><span class="hljs-type">bool</span></span> led8_on; // led <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> IO8 <span class="hljs-type"><span class="hljs-type">bool</span></span> led13_on; // built-<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> led pthread_mutex_t mutex; pthread_cond_t cond; }; #endif</code> </pre> <br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/368141/">https://habr.com/ru/post/368141/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../368131/index.html">"We sit well" or a fairy tale that needs to be told not only to children</a></li>
<li><a href="../368133/index.html">Smarthalo - a system that will turn the life of a cyclist into a paradise</a></li>
<li><a href="../368135/index.html">Apple lured away another Tesla engineer</a></li>
<li><a href="../368137/index.html">Lantern "Magic Lamp"</a></li>
<li><a href="../368139/index.html">RZD has released a new mobile application for buying tickets - now without commission</a></li>
<li><a href="../368145/index.html">Russia and the United States are jointly creating a new type of fusion reactor</a></li>
<li><a href="../368147/index.html">An overview of current bb-mobile tablets in 2016: ‚Äútablets‚Äù for every taste with 8 cores, Android, Windows and LTE</a></li>
<li><a href="../368151/index.html">Perfect gadget backpack for father family</a></li>
<li><a href="../368153/index.html">Slack presents a new call feature</a></li>
<li><a href="../368155/index.html">Canadian schoolboy created a service that allows investors to track the statistics of IT startups</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>