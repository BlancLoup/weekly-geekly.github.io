<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Connecting a character LCD to the board from WD MyBook Live on AppliedMicro APM82181</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! The purpose of this work was to expand the capabilities of the available card from NAS Western Digital MyBook Live. 

 Appearance: 

 Accord...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Connecting a character LCD to the board from WD MyBook Live on AppliedMicro APM82181</h1><div class="post__text post__text-html js-mediator-article">  Good day!  The purpose of this work was to expand the capabilities of the available card from NAS Western Digital MyBook Live. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Appearance:</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/d7a/872/093/d7a872093d464bbfa66e088fb13edb25.jpg" alt="image"><br></div></div><br>  According to its characteristics, this board is not very bad: <br><br><blockquote>  Processor: APM82181 <br>  Frequency: 800 MHz <br>  Platform: PowerPC 44x <br>  RAM: 256 MB <br>  ROM: 512 kV <br></blockquote>  From the interfaces in the presence of SATA, a network of 100 Mbps, serial port (UART, not soldered), a place for debugging connector JTAG.  There was a label with the number 4061-705086-003 REV on the board.  Ah.  On the other side, the number 4060-705086 is etched. <br><br>  The content of the article: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      1. Connecting the console <br>  2. Boot without disk <br>  3. Compile in LEDE <br>  4. Port management (via LuCI and console) <br>  5. Connection to the I2C bus <br>  6. Connecting the PCF8574 port extender <br><br>  The rest is in the next part ... <br><br>  Additions and comments are welcome.  Go! <br><br><h4>  1. Connecting the console </h4><br>  To work with the board, a local console connection is required (although most of the post-boot operations can also be performed via SSH).  This is done simply, there is enough information on the Internet, for example, here is the <a href="http://mybookworld.wikidot.com/wd-mybook-live-uart">WD MyBook Live UART Port</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Wiring contacts:</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/01d/2c3/8fb/01d2c38fbd2f4ccf8684b403c334f816.jpg" alt="image"><br></div></div><br>  Connection is made to the RS232 port of the computer through an RS232-UART adapter, since  On the board, logic levels are within 3.3V.  The default speed is 115200 baud. <br><br><div class="spoiler">  <b class="spoiler_title">After connecting and powering up the console, you can see messages from the u-boot bootloader:</b> <div class="spoiler_text"><pre><code class="bash hljs">U-Boot 2009.08-svn65645 (Oct 08 2012 - 14:36:50), Build: 0.2.5 CPU: AMCC PowerPC UNKNOWN (PVR=12c41c83) at 800 MHz (PLB=200, OPB=100, EBC=100 MHz) Bootstrap Option E - Boot ROM Location NOR/SRAM (8 bits) 32 kB I-Cache 32 kB D-Cache Board: Apollo-3G - APM82181 Board, 2*SATA, 1*USB I2C: ready DRAM: Auto calibration 256 MB FLASH: 512 kB DTT: 1 FAILED INIT Net: PHY EC1 Register: 0x2c8c ppc_4xx_eth0 Type run flash_nfs to mount root filesystem over NFS Hit any key to stop autoboot: 0</code> </pre> <br></div></div><br>  The message ‚ÄúApollo-3G - APM82181 Board, 2 * SATA, 1 * USB‚Äù is slightly incorrect, since there is no USB, and SATA is only one.  This seems to be due to the fact that the loader is common for MyBook Live and the DUO model with two disks. <br><br>  If you do not press anything in the console, it will attempt to boot from the hard disk.  In our case, it is not there, so by pressing any button the download is stopped. <br><br><h4>  2. Boot without disk </h4><br>  In the u-boot bootloader there are many possibilities for working with equipment. <br><br><div class="spoiler">  <b class="spoiler_title">For example, you can see all the colors of the three-color LED.</b> <div class="spoiler_text">  Turning off the LED (in the loader is lit in blue): <br><pre> <code class="bash hljs">ledtestoff</code> </pre> <br>  Test the three colors of the LED alternately: <br><pre> <code class="bash hljs">ledtest</code> </pre> <br></div></div><br>  The list of commands can be seen by typing help.  Learn more about the bootloader <a href="http://www.denx.de/wiki/U-Boot">here</a> .  When loading the console, you can see that u-boot offers the option of mounting the nfs file system "Type run flash_nfs to mount root filesystem over NFS".  In this case, we will use another option - loading the RAM image from the TFTP server. <br><br>  A server, for example TFTPD32 ( <a href="http://tftpd32.jounin.net/">Official site</a> ), is raised on the computer, then we set up the board.  We set the local IP address and the TFTP server address (of your computer).  They must be from the same subnet: <br><br><pre> <code class="bash hljs">setenv ipaddr <span class="hljs-string"><span class="hljs-string">'192.168.1.1'</span></span> setenv serverip <span class="hljs-string"><span class="hljs-string">'192.168.1.10'</span></span></code> </pre> <br>  View the file names that will be requested from the TFTP server: <br><br><pre> <code class="bash hljs">=&gt; printenv fdt_file bootfile fdt_file=apollo3g.dtb bootfile=uImage</code> </pre> <br>  Note that the fdt_file variable contains the name of the device tree file, and the bootfile contains the name of the RAM disk image file with the operating system. <br><br>  Names can be changed to more convenient ones like addresses with the setenv command.  After setting, it is desirable to save the new values ‚Äã‚Äãof the variables in the ROM: <br><br><pre> <code class="bash hljs">=&gt; saveenv Saving Environment to Flash... Un-Protected 1 sectors Un-Protected 1 sectors Erasing Flash... . <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> Erased 1 sectors Writing to Flash... <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> Protected 1 sectors Protected 1 sectors</code> </pre> <br>  Thus, after a reboot or power failure, the settings will be saved.  After that, we place two necessary files (if you don‚Äôt have them, then create them in the next section) on the TFTP server and type the command run net_nfs. <br><br><div class="spoiler">  <b class="spoiler_title">=&gt; run net_nfs</b> <div class="spoiler_text"><pre> <code class="bash hljs">Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> PHY auto negotiation to complete.. <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> ENET Speed is 100 Mbps - FULL duplex connection (EMAC0) Using ppc_4xx_eth0 device TFTP from server 192.168.1.10; our IP address is 192.168.1.1 Filename <span class="hljs-string"><span class="hljs-string">'uImage'</span></span>. Load address: 0x1000000 Loading: <span class="hljs-comment"><span class="hljs-comment">################################################################# ################################################################# ################################################################# ################################################################# ################################################################# ################################################################# ################################################################# # done Bytes transferred = 6680079 (65ee0f hex) Using ppc_4xx_eth0 device TFTP from server 192.168.1.10; our IP address is 192.168.1.1 Filename 'apollo3g.dtb'. Load address: 0x1800000 Loading: ## done Bytes transferred = 16384 (4000 hex) ## Booting kernel from Legacy Image at 01000000 ... Image Name: POWERPC LEDE Linux-4.4.21 Image Type: PowerPC Linux Kernel Image (gzip compressed) Data Size: 6680015 Bytes = 6.4 MB Load Address: 00000000 Entry Point: 00000000 Verifying Checksum ... OK ## Flattened Device Tree blob at 01800000 Booting using the fdt blob at 0x1800000 Uncompressing Kernel Image ... OK Loading Device Tree to 00ff9000, end 00ffffff ... OK</span></span></code> </pre> <br></div></div><br>  As you can see, two files are loaded as a result.  They are placed in the specified places of RAM, the kernel is unpacked and loaded.  As a result, we have a working system, in this case LEDE: <br><br><pre> <code class="bash hljs">root@lede: uname -a Linux lede 4.4.21 <span class="hljs-comment"><span class="hljs-comment">#0 Fri Nov 18 03:27:44 UTC 2016 ppc GNU/Linux</span></span></code> </pre> <br><h4>  3. Compile in LEDE </h4><br>  We will use <a href="https://www.lede-project.org/">LEDE</a> as the source of the operating system for our board.  This is a fork of OpenWRT and it supports the MyBook Live board.  Download here: <a href="https://github.com/chunkeey/apm82181-lede">apm82181-lede</a> .  We download packages as written in the instructions: <br><br><pre> <code class="bash hljs">./scripts/feeds update -a ./scripts/feeds install -a</code> </pre> <br>  Run the configurator: <br><br><pre> <code class="bash hljs">make menuconfig</code> </pre> <br>  We select ‚ÄúAppliedMicro APM821xx‚Äù as the system (‚ÄúTarget System‚Äù), ‚ÄúDevices which boot from SATA (NAS)‚Äù as the subsystem (‚ÄúSubtarget‚Äù), ‚ÄúWestern Digital My Book Live‚Äù .  The final image (‚ÄúTarget Images‚Äù) must necessarily be marked ramdisk. <br><br>  Packages choose at their discretion.  If you save the settings in the configurator and exit it, you can start the compilation with the make command. <br><br>  After the process is completed, if it has passed without errors, the necessary files can be picked up and put on the TFTP server: <br><br><ul><li>  bin / targets / apm821xx / sata / lede-apm821xx-sata-MyBookLiveSingle-initramfs-kernel.bin file is renamed to uImage </li><li>  file build_dir / target-powerpc_464fp_musl-1.1.15 / linux-apm821xx_sata / tmp / lede-apm821xx-sata-MyBookLiveSingle-initramfs-kernel.bin.dtb is renamed to apollo3g.dtb </li></ul><br>  So we went through the boot-up process. <br><br><h4>  4. Port management (via LuCI and console) </h4><br>  I did not manage to find the scheme of this board on the Internet and in general the scheme of any device based on the APM82181 processor.  Therefore, we will perform partial reverse engineering (reverse engineering), that is, guess about the connections on the board and check it.  The developers of LEDE apparently partially did this, because the connected ports can be seen in the device tree or view information from the kernel: <br><br><div class="spoiler">  <b class="spoiler_title">I / O ports</b> <div class="spoiler_text"><pre> <code class="bash hljs">root@lede: cat /sys/kernel/debug/gpio GPIOs 496-503, platform/4e0100000.gpio1, 4e0100000.gpio1: gpio-498 ( |Reset button ) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hi GPIOs 504-511, platform/4e0000000.gpio0, 4e0000000.gpio0: gpio-504 ( |<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> EMAC PHY ) out hi gpio-505 ( |Enable Reset Button,) out lo gpio-506 ( |Power USB Core ) out hi gpio-507 ( |Power Drive Port 1 ) out hi gpio-508 ( |? ) out lo gpio-509 ( |? ) out hi gpio-510 ( |? ) out lo gpio-511 ( |Power Drive Port 0 ) out hi</code> </pre> <br></div></div><br>  As you can see, one port is used to enter the button, the rest to the output for control.  It is clear that editing the device tree file (the file with the .dts extension) can free any function in the operating system from the functions, but this may affect the functionality of the board's functional blocks.  Is that except the LED.  Ports connected to this indicator can be used for their own purposes.  Ports marked with a question mark, just connected to it.  And LED control is available, for example, from the console. <br><br>  By default, after the LEDE is loaded, the LED is green.  This is how you can turn it off: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 0 &gt; /sys/class/leds/mbl\:green\:power/brightness</code> </pre> <br>  And turn blue: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 1 &gt; /sys/class/leds/mbl\:blue\:power/brightness</code> </pre> <br>  If LEDE was built with a LuCI web shell, then the LEDs can be controlled from the browser. <br><br><div class="spoiler">  <b class="spoiler_title">Go to the IP address of the network card</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/e03/a1b/2a8/e03a1b2a82494942821bea8829fff011.jpg" alt="image"><br></div></div><br>  In the System menu, go to the LED Configuration, and configure which events each specific LED color is triggered.  For example, this is how a green LED will flash on incoming and outgoing network packets: <br><br><div class="spoiler">  <b class="spoiler_title">Network activity</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/91d/698/0a3/91d6980a3b154aecab29370c2cb2b35d.jpg" alt="image"><br></div></div><br>  It is clear that if you use the LED ports for your needs, then the service that controls the LED (/etc/init.d/led) will not be needed and the driver too.  And management can be made from a script like this: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 1 &gt; /sys/class/gpio/gpio508/value</code> </pre> <br><h4>  5. Connection to the I2C bus </h4><br>  So, it is possible to use at least three ports.  I would certainly like to have more resources.  You can put a port expander on these ports, connect it to the I2C software port.  Then you can dial a virtually unlimited number of ports, but with low speed. <br><br>  There was a number of empty seats on the board, there was a desire to check if something was diluted, which might be useful to us. <br><br>  For example, near the processor, there is a footprint marked U12 for a chip with 8 legs: <br><br><div class="spoiler">  <b class="spoiler_title">Soldered plume</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/c75/2b0/0ba/c752b00bab244eba83de3b423dac0b7e.jpg" alt="image"><br></div></div><br>  Making sure that on all contacts no more than 3.3V, a digital analyzer was connected. <br>  During the OS boot no signals were detected.  Then a description of the I2C bus was added to the device tree, since it was originally missing: <br><br><pre> <code class="hljs objectivec">IIC0: i2c@ef600700 { compatible = <span class="hljs-string"><span class="hljs-string">"ibm,iic"</span></span>; reg = &lt;<span class="hljs-number"><span class="hljs-number">0xef600700</span></span> <span class="hljs-number"><span class="hljs-number">0x00000014</span></span>&gt;; interrupt-parent = &lt;&amp;<span class="hljs-built_in"><span class="hljs-built_in">UIC0</span></span>&gt;; interrupts = &lt;<span class="hljs-number"><span class="hljs-number">0x2</span></span> <span class="hljs-number"><span class="hljs-number">0x4</span></span>&gt;; fast-mode; <span class="hljs-meta"><span class="hljs-meta">#address-cells = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;1&gt;</span></span></span><span class="hljs-meta">; #size-cells = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;0&gt;</span></span></span><span class="hljs-meta">; };</span></span></code> </pre><br>  It is clear that in the LEDE configuration it is also necessary to enable support for I2C in the core (kmod-i2c-core). <br><br>  After compiling, updating the file on the TFTP server and rebooting, the device / dev / i2c-0 appeared. <br><br><pre> <code class="bash hljs">root@lede: dmesg | grep i2c [ 4.816060] i2c /dev entries driver [ 4.819878] ibm-iic 4ef600700.i2c: using standard (100 kHz) mode</code> </pre><br>  Sending characters with the echo command: <br><br><pre> <code class="bash hljs">root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 11 &gt; /dev/i2c-0 ash: write error: Remote I/O error</code> </pre><br><div class="spoiler">  <b class="spoiler_title">A signal was detected by a digital analyzer:</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/1bd/27a/ab3/1bd27aab3d804970b39a3f8fd1a7ea88.png" alt="image"><br></div></div><br>  Thus, the hardware I2C bus was detected, which greatly expanded the I / O capabilities of this board. <br><br>  Judging by the location of the signals on the U12 (5 - GND, 7 - SDA, 8 - SCL), it is possible assumed ADM1032ARMZ - temperature sensor. <br><br><h4>  6. Connecting the PCF8574 port extender </h4><br>  It's time to connect something to the I2C bus.  In stocks there was a liquid-crystal indicator of 216 familiarity, each 8x5 pixels.  Made in China based on HD44780 clone controller and PCF8574 port extender. <br><br><div class="spoiler">  <b class="spoiler_title">LCD HD44780 16x2 I2C</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/c02/c54/679/c02c546795334f05ad485a0126ecf27e.jpg" alt="image"></div></div><br>  According to the description, it allows power and signal levels of both 5 and 3.3V, but the test revealed a very low image contrast with 3.3V power.  Since the power supply of 5V would also lead to signal levels from 0 to 5 V, and the board is rated at 3.3, we had to make a primitive signal level converter.  The I2C bus is bidirectional, a confirmation signal must come from the device, so at least there should be a bi-directional converter on the SDA lines.  Very good options for schemes are described here: <a href="http://we.easyelectronics.ru/Shematech/soglasovanie-logicheskih-urovney-5v-i-33v-ustroystv.html">Coordination of logical levels of 5V and 3.3V devices</a> .  In our case was used <br><br><div class="spoiler">  <b class="spoiler_title">insulated gate field effect transistor</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/e4b/f62/c81/e4bf62c81ed14460b613178584528558.jpg" alt="image"><br></div></div><br>  True transistor is different, selected from similar - BSS123. <br><br><div class="spoiler">  <b class="spoiler_title">Assembled on breadboard:</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/b11/341/a79/b11341a7951f46dc98f9bf3cf24dcac3.jpg" alt="image"></div></div><br>  Thus, the LCD indicator is powered by 5V (taken on the board from the SATA power connector), the power converter comes to both power supplies - 3.3 and 5V. <br><br>  Now add a port extender to LEDE.  We enable kernel support (Kernel modules - Other modules - kmod-gpio-pcf857x ... PCX857x, PCA967x and MAX732X I2C GPIO expanders), recompile, upload to the server, reboot. <br><br>  We are looking for a driver: <br><br><pre> <code class="bash hljs">root@lede: lsmod |grep pcf gpio_pcf857x 6128 0</code> </pre><br>  We connect (0x27 - the address of our expander on the I2C bus): <br><br><pre> <code class="bash hljs">root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> pcf8574 0x27 &gt; /sys/bus/i2c/devices/i2c-0/new_device [ 218.957888] pcf857x 0-0027: probed [ 218.961321] i2c i2c-0: new_device: Instantiated device pcf8574 at 0x27</code> </pre><br>  Check the appearance of ports: <br><br><pre> <code class="bash hljs">root@lede: ls -l /sys/class/gpio/ --w------- 1 root root 4096 Jan 1 1970 <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> lrwxrwxrwx 1 root root 0 Nov 25 04:04 gpiochip488 -&gt; ../../devices/platform/plb/plb:opb/4ef600700.i2c/i2c-0/0-0027/gpio/gpiochip488 lrwxrwxrwx 1 root root 0 Jan 1 1970 gpiochip496 -&gt; ../../devices_platform/plb/plb:opb/4e0100000.gpio1/gpio/gpiochip496 lrwxrwxrwx 1 root root 0 Jan 1 1970 gpiochip504 -&gt; ../../devices/platform/plb/plb:opb/4e0000000.gpio0/gpio/gpiochip504 --w------- 1 root root 4096 Jan 1 1970 unexport</code> </pre> <br>  As you can see, a gpiochip488 port group appeared on the I2C bus with the address 0x27.  Now you can add ports that will also be represented by the system, as well as those located on the processor, despite the fact that they work through the port expander: <br><br><pre> <code class="bash hljs">root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 488 &gt; /sys/class/gpio/<span class="hljs-built_in"><span class="hljs-built_in">export</span></span> root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 489 &gt; /sys/class/gpio/<span class="hljs-built_in"><span class="hljs-built_in">export</span></span> root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 490 &gt; /sys/class/gpio/<span class="hljs-built_in"><span class="hljs-built_in">export</span></span> root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 491 &gt; /sys/class/gpio/<span class="hljs-built_in"><span class="hljs-built_in">export</span></span></code> </pre> <br>  ... and so on until 495, since we have an 8-port expander available.  Check their availability: <br><br><pre> <code class="bash hljs">root@lede: ls -l /sys/class/gpio/gpio??? lrwxrwxrwx 1 root root 0 Nov 25 04:17 /sys/class/gpio/gpio488 -&gt; ../../devices/platform/plb/plb:opb/4ef600700.i2c/i2c-0/0-0027/gpio/gpio488 lrwxrwxrwx 1 root root 0 Nov 25 04:17 /sys/class/gpio/gpio489 -&gt; ../../devices/platform/plb/plb:opb/4ef600700.i2c/i2c-0/0-0027/gpio/gpio489 lrwxrwxrwx 1 root root 0 Nov 25 04:17 /sys/class/gpio/gpio490 -&gt; ../../devices/platform/plb/plb:opb/4ef600700.i2c/i2c-0/0-0027/gpio/gpio490 lrwxrwxrwx 1 root root 0 Nov 25 04:17 /sys/class/gpio/gpio491 -&gt; ../../devices/platform/plb/plb:opb/4ef600700.i2c/i2c-0/0-0027/gpio/gpio491</code> </pre><br>  Let's set the direction of work for the conclusion: <br><br><pre> <code class="bash hljs">root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> out &gt; /sys/class/gpio/gpio488/direction root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> out &gt; /sys/class/gpio/gpio489/direction root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> out &gt; /sys/class/gpio/gpio490/direction root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> out &gt; /sys/class/gpio/gpio491/direction</code> </pre><br>  If you need to enter, you must give the command "in".  Well, check how the output works, for example, by measuring the output state with a tester or a digital analyzer.  In the case of the HD447880 connected to the LCD expander, you can use the fact that the third bit of the expander controls the backlight of the indicator: <br><br><pre> <code class="bash hljs">root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 1 &gt; /sys/class/gpio/gpio491/value root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 0 &gt; /sys/class/gpio/gpio491/value</code> </pre><br>  The first command turns on the backlight, the second one turns it off.  In order for devices to be added during the boot process, you can include them in the device tree: <br><br><pre> <code class="hljs objectivec"> IIC0: i2c@ef600700 { compatible = <span class="hljs-string"><span class="hljs-string">"ibm,iic"</span></span>; reg = &lt;<span class="hljs-number"><span class="hljs-number">0xef600700</span></span> <span class="hljs-number"><span class="hljs-number">0x00000014</span></span>&gt;; interrupt-parent = &lt;&amp;<span class="hljs-built_in"><span class="hljs-built_in">UIC0</span></span>&gt;; interrupts = &lt;<span class="hljs-number"><span class="hljs-number">0x2</span></span> <span class="hljs-number"><span class="hljs-number">0x4</span></span>&gt;; fast-mode; <span class="hljs-meta"><span class="hljs-meta">#address-cells = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;1&gt;</span></span></span><span class="hljs-meta">; #size-cells = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;0&gt;</span></span></span><span class="hljs-meta">; /* Boot ROM is at 0x52-0x53, do not touch */ /* Unknown chip at 0x6e, not sure what it is */ i2cled: led@27{ #gpio-cells = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;2&gt;</span></span></span><span class="hljs-meta">; compatible = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"nxp,pcf8574"</span></span></span><span class="hljs-meta">; reg = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;0x27&gt;</span></span></span><span class="hljs-meta">; gpio-controller; }; };</span></span></code> </pre><br>  The lines after the i2cled tag replace the echo pcf8574 0x27&gt; / sys / bus / i2c / devices / i2c-0 / new_device command. <br><br>  So, the ability to transparently use I / O ports connected via an extender to the I2C bus has appeared and is being implemented in practice. <br><br>  For the first part, probably enough.  In the second part, unless of course there is an obvious antagonism in the comments, we will get to using the indicator to display the state of the system: <br><br><img src="https://habrastorage.org/files/19c/2ff/ab7/19c2ffab79384ca78c01d9a7e9ed9dde.gif" alt="image"><br><br>  For this, the HD44780 driver was used and improved.  The LCD4Linux package was connected, in which a new display driver was also written, which controls the display of the commands of the VT100 terminal, because the existing drivers did not fit. </div><p>Source: <a href="https://habr.com/ru/post/315912/">https://habr.com/ru/post/315912/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315902/index.html">New season webinars Hewlett Packard Enterprise</a></li>
<li><a href="../315904/index.html">Meeting lovers of big data and art</a></li>
<li><a href="../315906/index.html">SPDK: Acceleration with NVMe Disks</a></li>
<li><a href="../315908/index.html">When is it harmful to test your components?</a></li>
<li><a href="../315910/index.html">Asterisk statistics interface. New version, new functionality</a></li>
<li><a href="../315914/index.html">Using Intel technology to transfer network traffic from a physical adapter to a virtual one</a></li>
<li><a href="../315916/index.html">You, Inc. How to develop personal and professional skills, sell them and stand out from the crowd</a></li>
<li><a href="../315918/index.html">How an entrepreneur destroyed a mediocre business to create a great company</a></li>
<li><a href="../315924/index.html">Biological background of the degradation of companies</a></li>
<li><a href="../315926/index.html">Fedora 25. New Hope: Wayland, Storaged, Raspberry Pi Support ...</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>