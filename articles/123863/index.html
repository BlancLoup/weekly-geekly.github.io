<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sharepoint 2010 / customization of search alerts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to talk about my own successful experience in customizing search alerts in Sharepoint 2010 using IAlertNotifyHandler. 

 At first, the task see...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sharepoint 2010 / customization of search alerts</h1><div class="post__text post__text-html js-mediator-article">  I want to talk about my own successful experience in customizing search alerts in Sharepoint 2010 using IAlertNotifyHandler. <br><br>  At first, the task seemed trivial.  It seems like everything is simple.  The MSDN documentation has an article describing the process itself, there are examples on other resources.  But, as it turned out, customization of all types of alerts, <strong>except search engines</strong> , is described everywhere.  Since I haven‚Äôt found a solution in the whole Internet, I‚Äôm presenting my own (maybe not the most optimal, but working). <br><a name="habracut"></a><br><h4>  Condition </h4><br>  There is a SQL database, which Sharepoint search is implemented using Business Connectivity Services (BCS) and Enterprise Search.  The output of search results to a Sharepoint user is customized using the appropriate XSLT transforms.  Thus, when searching, the user gets the result approximately in this form (the base is working - hereinafter the names and all that are crossed out). <br><br><img src="http://my.jetscreenshot.com/7261/m_20110707-3c6f-117kb.jpg" width="640" height="347">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      By means of Sharepoint, users can assign alerts for each search query that are triggered when changes are made to the database.  When triggered, the user receives an email of the following form. <br><br><img src="http://my.jetscreenshot.com/7261/m_20110707-9gzu-108kb.jpg" width="640" height="369"><br><br>  That is, the standard alert does not take into account the XSLT transformations and gives the user unreadable information.  Therefore, the problem arises to convert the text of the email into a readable one, preferably the same as in the search. <br><br><h4>  Standard alert customization solution </h4><br><br>  First, I briefly describe the standard solution, <strong>which is not suitable for search alerts</strong> , but parts of which (paragraphs 2, 5-11) will be needed later to launch my version. <br><br>  1. Create a dll AlertHandler with class Class1 that implements the IAlertNotifyHandler interface, in the OnNotification method of which we can receive the current alert text and modify it accordingly. <br><br>  2. Put dll in GAC <br><br>  3. Make a copy of the alertTemplates.xml file which is located: C: \ Program Files \ Common Files \ Microsoft Shared \ Web Server Extensions \ 14 \ TEMPLATE \ XML.  In this case, always modify the copy of the file and not the original (this is important so that you can later return to the standard handler and not nakosyachit). <br><br>  4. Name the new file (copy alertTemplates.xml) of CustomAlertTemplates and save it.  Modify the file as follows.  Find the properties block and add the following lines to this block: <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">NotificationHandlerAssembly</font> <font color="#0000ff">&gt;</font> AlertHandler, Version=1.0.0.0, Culture=neutral, PublicKeyToken=d59ecf2a3bd66904 <font color="#0000ff">&lt;/</font> <font color="#800000">NotificationHandlerAssembly</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">NotificationHandlerClassName</font> <font color="#0000ff">&gt;</font> AlertHandler.Class1 <font color="#0000ff">&lt;/</font> <font color="#800000">NotificationHandlerClassName</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">NotificationHandlerProperties</font> <font color="#0000ff">&gt;&lt;/</font> <font color="#800000">NotificationHandlerProperties</font> <font color="#0000ff">&gt;</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Now the whole block will look like this: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">Properties</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">ImmediateNotificationExcludedFields</font> <font color="#0000ff">&gt;</font> ID;Author;Editor;Modified_x0020_By;Created_x0020_By;_UIVersionString;ContentType;TaskGroup;IsCurrent;Attachments;NumComments; <font color="#0000ff">&lt;/</font> <font color="#800000">ImmediateNotificationExcludedFields</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">DigestNotificationExcludedFields</font> <font color="#0000ff">&gt;</font> ID;Author;Editor;Modified_x0020_By;Created_x0020_By;_UIVersionString;ContentType;TaskGroup;IsCurrent;Attachments;NumComments; <font color="#0000ff">&lt;/</font> <font color="#800000">DigestNotificationExcludedFields</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">NotificationHandlerAssembly</font> <font color="#0000ff">&gt;</font> AlertHandler, Version=1.0.0.0, Culture=neutral, PublicKeyToken=d59ecf2a3bd66904 <font color="#0000ff">&lt;/</font> <font color="#800000">NotificationHandlerAssembly</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">NotificationHandlerClassName</font> <font color="#0000ff">&gt;</font> AlertHandler.Class1 <font color="#0000ff">&lt;/</font> <font color="#800000">NotificationHandlerClassName</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">NotificationHandlerProperties</font> <font color="#0000ff">&gt;&lt;/</font> <font color="#800000">NotificationHandlerProperties</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">Properties</font> <font color="#0000ff">&gt;</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Note: PublicKeyToken can be viewed in the dll properties by finding it in C: \ windows \ assembly. <br><br>  5. Run the command from C: \ Program Files \ Common Files \ Microsoft Shared \ web server extensions \ 14 \ BIN: stsadm -o updatealerttemplates -filename "C: \ Program Files \ Common Files \ Microsoft Shared \ Web Server Extensions \ 14 \ TEMPLATE \ XML \ customalerttemplates.xml ¬ª-url 6. Run the command: stsadm -o setproperty -pn job-immediate-alerts -pv" every 1 minutes "this is needed only for testing.  Return back after testing. <br><br>  7. Make sure that SharePoint is configured to send outgoing emails. <br><br>  8. Make sure that the alert is enabled for example a document library if you are testing on a document library. <br><br>  9. Run the command: iisreset <br><br>  10. Run the command: services.msc <br><br>  11. Restart Windows SharePoint Services Timer. <br><br><h4>  Standard solution problem </h4><br><br>  Everything is great, everything works, but not for the case of search alerts.  For search alerts in the OnNotification method (SPAlertHandlerParams ahp), the values ‚Äã‚Äãof the ahp.eventData and ahp.body fields do not come in, which are actually needed for customization. <br><br>  In response to my questions on the <a href="http://social.technet.microsoft.com/">social.technet.microsoft.com</a> forums <a href="http://social.technet.microsoft.com/">,</a> I received the following information. <br><br>  First, you can customize the SharePoint alert using IAlertNotifyHandler as the following: <br>  <a href="http://blogs.msdn.com/b/sharepointdeveloperdocs/archive/2007/12/14/how-to-customizing-alert-emails-using-ialertnotificationhandler.aspx">blogs.msdn.com/b/sharepointdeveloperdocs/archive/2007/12/14/how-to-customizing-alert-emails-using-ialertnotificationhandler.aspx</a> <br>  Second, there is no search alert. <br>  All the Alert template: <a href="http://msdn.microsoft.com/en-us/library/bb802738.aspx">msdn.microsoft.com/en-us/library/bb802738.aspx</a> <br><br>  That is, it turns out that there is no solution?! .. But since I was not used to giving up without a fight, I continued to collect information from the Internet bit by bit.  And that's what came of it. <br><br><h4>  My version </h4><br><br>  1. Reading the forums showed that to process search alerts, first of all, you need to add a new type of AlertTemplate - ‚ÄúOSS.Search‚Äù.  Add to the CustomAlertTemplates file. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">AlertTemplate</font> <font color="#ff0000">Type</font> <font color="#0000ff">="Custom"</font> <font color="#ff0000">Name</font> <font color="#0000ff">="OSS.Search"</font> <font color="#ff0000">AlwaysNotify</font> <font color="#0000ff">="True"</font> <font color="#ff0000">DefaultTitle</font> <font color="#0000ff">="Search"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">EventTypes</font> <font color="#ff0000">IsVisible</font> <font color="#0000ff">="True"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">EventType</font> <font color="#ff0000">Mask</font> <font color="#0000ff">="0x1"</font> <font color="#ff0000">Selected</font> <font color="#0000ff">="true"</font> <font color="#0000ff">&gt;</font> $Resources:Microsoft.Office.Server.Search,SearchResults_ATEventDiscovered; <font color="#0000ff">&lt;/</font> <font color="#800000">EventType</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">EventType</font> <font color="#ff0000">Mask</font> <font color="#0000ff">="0x2"</font> <font color="#0000ff">&gt;</font> $Resources:Microsoft.Office.Server.Search,SearchResults_ATEventModified; <font color="#0000ff">&lt;/</font> <font color="#800000">EventType</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">EventType</font> <font color="#ff0000">Mask</font> <font color="#0000ff">="0x3"</font> <font color="#0000ff">&gt;</font> $Resources:Microsoft.Office.Server.Search,SearchResults_ATEventAll; <font color="#0000ff">&lt;/</font> <font color="#800000">EventType</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">EventTypes</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Frequency</font> <font color="#ff0000">IsVisible</font> <font color="#0000ff">="true"</font> <font color="#ff0000">ShowImmediate</font> <font color="#0000ff">="false"</font> <font color="#ff0000">ShowDaily</font> <font color="#0000ff">="true"</font> <font color="#ff0000">ShowWeekly</font> <font color="#0000ff">="true"</font> <font color="#ff0000">ShowTime</font> <font color="#0000ff">="false"</font> <font color="#ff0000">DefaultFrequency</font> <font color="#0000ff">="Daily"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Filters</font> <font color="#ff0000">IsVisible</font> <font color="#0000ff">="false"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Properties</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">NotificationHandlerAssembly</font> <font color="#0000ff">&gt;</font> mySearchAlert, Version=1.0.0.0, Culture=neutral, PublicKeyToken=aa1e89f3cc0ef56b <font color="#0000ff">&lt;/</font> <font color="#800000">NotificationHandlerAssembly</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">NotificationHandlerClassName</font> <font color="#0000ff">&gt;</font> mySearchAlert.MySearchAlertHandler <font color="#0000ff">&lt;/</font> <font color="#800000">NotificationHandlerClassName</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">NotificationHandlerProperties</font> <font color="#0000ff">&gt;&lt;/</font> <font color="#800000">NotificationHandlerProperties</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">UpdateHandlerAssembly</font> <font color="#0000ff">&gt;</font> mySearchAlert, Version=1.0.0.0, Culture=neutral, PublicKeyToken=aa1e89f3cc0ef56b <font color="#0000ff">&lt;/</font> <font color="#800000">UpdateHandlerAssembly</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">UpdateHandlerClassName</font> <font color="#0000ff">&gt;</font> mySearchAlert.MySearchUpdateAlertHandler <font color="#0000ff">&lt;/</font> <font color="#800000">UpdateHandlerClassName</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">UpdateHandlerProperties</font> <font color="#0000ff">&gt;&lt;/</font> <font color="#800000">UpdateHandlerProperties</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">Properties</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">AlertTemplate</font> <font color="#0000ff">&gt;</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  It is important to note that in order to return back to the standard handler, the previously saved standard file is no longer enough, so we copy the standard alertTemplates.xml into a file, for example, into alertTemplates_forRestore.xml and add the following section <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">AlertTemplate</font> <font color="#ff0000">Type</font> <font color="#0000ff">="Custom"</font> <font color="#ff0000">Name</font> <font color="#0000ff">="OSS.Search"</font> <font color="#ff0000">AlwaysNotify</font> <font color="#0000ff">="True"</font> <font color="#ff0000">DefaultTitle</font> <font color="#0000ff">="Search"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">EventTypes</font> <font color="#ff0000">IsVisible</font> <font color="#0000ff">="True"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">EventType</font> <font color="#ff0000">Mask</font> <font color="#0000ff">="0x1"</font> <font color="#ff0000">Selected</font> <font color="#0000ff">="true"</font> <font color="#0000ff">&gt;</font> $Resources:Microsoft.Office.Server.Search,SearchResults_ATEventDiscovered; <font color="#0000ff">&lt;/</font> <font color="#800000">EventType</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">EventType</font> <font color="#ff0000">Mask</font> <font color="#0000ff">="0x2"</font> <font color="#0000ff">&gt;</font> $Resources:Microsoft.Office.Server.Search,SearchResults_ATEventModified; <font color="#0000ff">&lt;/</font> <font color="#800000">EventType</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">EventType</font> <font color="#ff0000">Mask</font> <font color="#0000ff">="0x3"</font> <font color="#0000ff">&gt;</font> $Resources:Microsoft.Office.Server.Search,SearchResults_ATEventAll; <font color="#0000ff">&lt;/</font> <font color="#800000">EventType</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">EventTypes</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Frequency</font> <font color="#ff0000">IsVisible</font> <font color="#0000ff">="true"</font> <font color="#ff0000">ShowImmediate</font> <font color="#0000ff">="false"</font> <font color="#ff0000">ShowDaily</font> <font color="#0000ff">="true"</font> <font color="#ff0000">ShowWeekly</font> <font color="#0000ff">="true"</font> <font color="#ff0000">ShowTime</font> <font color="#0000ff">="false"</font> <font color="#ff0000">DefaultFrequency</font> <font color="#0000ff">="Daily"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Filters</font> <font color="#ff0000">IsVisible</font> <font color="#0000ff">="false"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Properties</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">NotificationHandlerAssembly</font> <font color="#0000ff">&gt;</font> Microsoft.Office.Server.Search, Version=14.0.0.0, Culture=neutral, PublicKeyToken=71e9bce111e9429c <font color="#0000ff">&lt;/</font> <font color="#800000">NotificationHandlerAssembly</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">NotificationHandlerClassName</font> <font color="#0000ff">&gt;</font> Microsoft.Office.Server.Search.Query.SearchAlertHandler <font color="#0000ff">&lt;/</font> <font color="#800000">NotificationHandlerClassName</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">NotificationHandlerProperties</font> <font color="#0000ff">&gt;&lt;/</font> <font color="#800000">NotificationHandlerProperties</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">UpdateHandlerAssembly</font> <font color="#0000ff">&gt;</font> Microsoft.Office.Server.Search, Version=14.0.0.0, Culture=neutral, PublicKeyToken=71e9bce111e9429c <font color="#0000ff">&lt;/</font> <font color="#800000">UpdateHandlerAssembly</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">UpdateHandlerClassName</font> <font color="#0000ff">&gt;</font> Microsoft.Office.Server.Search.Query.SearchAlertHandler <font color="#0000ff">&lt;/</font> <font color="#800000">UpdateHandlerClassName</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">UpdateHandlerProperties</font> <font color="#0000ff">&gt;&lt;/</font> <font color="#800000">UpdateHandlerProperties</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">Properties</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">AlertTemplate</font> <font color="#0000ff">&gt;</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Carefully store the alertTemplates_forRestore.xml file - rollback to the standard handler is impossible without it. <br><br>  2. Having poked my head, I thought that, once using a standard solution, some part of the information still comes to us, then we can start from it.  And I can find not the most elegant, but working solution. <br><ul><li>  Using the information about the alert that is being processed, I create a programmatically new temporary search alert SearchAlert alert2 = new SearchAlert (s1, q1); </li><li>  I create a search query to the Sharepoint server using the search string of the processed alert - Search.Query.Query query = alert2.CreateSearchQuery <br>  using Reflection, I set the internal property AlertInfo of our query query, setting LastUpdateTime to the value we need (to get only the changed records since the last alert triggering) and get the result of the query </li><li>  I get additional information from the SQL database using FullTextSqlQuery </li><li>  delete alert2 created by me </li><li>  I generate my HTML body letter text based on the SQL database fields and Saherepoint 2010 fields received in the query. </li></ul><br><br>  I will not fully include all the code (it is long) - only highlights. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> MySearchAlertHandler : IAlertNotifyHandler <br> <font color="#008000">//  </font> <br> <font color="#0000ff">public</font> <font color="#0000ff">bool</font> OnNotification(SPAlertHandlerParams alertHandler) <br> { <br> ... <br> <font color="#0000ff">return</font> CustomAlertNotification(alertHandler); <br> ... <br> } <br> <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">bool</font> CustomAlertNotification(SPAlertHandlerParams alertHandlerParams) <br> { <br> <font color="#0000ff">string</font> myBody = <font color="#A31515">""</font> ; <br> SPSite site = <font color="#0000ff">null</font> ; <br> <font color="#0000ff">int</font> searchAlertNotificationQuota = 200; <br> <font color="#2B91AF">TimeSpan</font> span; <br> SPAlert a = alertHandlerParams.a; <br> <br> <br> site = <font color="#0000ff">new</font> SPSite(alertHandlerParams.siteUrl+ alertHandlerParams.webUrl;); <br> <br> <br> <font color="#008000">// alertTime  span   </font> <br> <br> <font color="#2B91AF">DateTime</font> alertTime = a.AlertTime; <br> <font color="#0000ff">if</font> (a.AlertFrequency == SPAlertFrequency.Weekly) <br> { <br> span = <font color="#2B91AF">TimeSpan</font> .FromDays(7.0); <br> } <br> <font color="#0000ff">else</font> <br> { <br> span = <font color="#2B91AF">TimeSpan</font> .FromDays(1.0); <br> } <br> <br> <font color="#0000ff">if</font> ((alertTime + span) &lt;= <font color="#2B91AF">DateTime</font> .Now) <br> { <br> <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; <br> } <br> <br> <font color="#0000ff">using</font> (SPWeb web = site.OpenWeb()) <br> { <br> <br> <br> <font color="#008000">//     (      )    queryText</font> <br> <br> <font color="#0000ff">string</font> queryText = Utils.GetValueFromXML(a.Properties[ <font color="#A31515">"p_query"</font> ], <font color="#A31515">"QueryText"</font> ); <br> <br> SPSite s1 = <font color="#0000ff">new</font> SPSite (alertHandlerParams.siteUrl+alertHandlerParams.webUrl ); <br> Query q1 = <font color="#0000ff">new</font> KeywordQuery(s1); <br> q1.QueryText = queryText; <br> <br> <font color="#008000">//     alert2,      </font> <br> <br> SearchAlert alert2 = <font color="#0000ff">new</font> SearchAlert(s1,q1); <br> alert2.ChangeType = AlertChangeType.DiscoveredOrModified; <br> alert2.InnerAlert.AlertFrequency = alertHandlerParams.a.AlertFrequency ; <br> alert2.InnerAlert.Title = <font color="#A31515">"Temp#1"</font> ; <br> alert2.InnerAlert.EventType = alertHandlerParams.a.EventType; <br> alert2.InnerAlert.User = s1.OpenWeb().CurrentUser ; <br> alert2.InnerAlert.AlertType = alertHandlerParams.a.AlertType; <br> alert2.Update(); <br> <br> <br> <font color="#008000">//    query     alert2  queryText</font> <br> <br> <font color="#0000ff">using</font> (Microsoft.Office.Server.Search.Query.Query query = alert2.CreateSearchQuery ()) <br> { <br> ResultTableCollection tables; <br> <br> query.QueryText =  queryText; <br> query.RowLimit = searchAlertNotificationQuota; <br> query.TrimDuplicates = <font color="#0000ff">false</font> ; <br> <br> <font color="#008000">//     ,        ,        ,      .</font> <br>  ,   Reflection  <font color="#0000ff">internal</font>  AlertInfo   query,  LastUpdateTime     <br> <br> AlertInfo ai = <font color="#0000ff">new</font> AlertInfo(); <br> ai.ChangeType = alert2.ChangeType; <br> ai.LastUpdateTime = alertTime - span; <br> <br> Type t1 = query.GetType(); <br> <font color="#0000ff">if</font> (t1.GetProperty( <font color="#A31515">"AlertInfo"</font> , System.Reflection.BindingFlags.Public | System.Reflection.BindingFlags.NonPublic | <br> System.Reflection.BindingFlags.Instance) == <font color="#0000ff">null</font> ) <br> <font color="#0000ff">throw</font> <font color="#0000ff">new</font> ArgumentOutOfRangeException( <font color="#A31515">"propName"</font> , <font color="#0000ff">string</font> .Format( <font color="#A31515">"Property {0} was not found in Type {1}"</font> , <br> <font color="#A31515">"AlertInfo"</font> , query.GetType().FullName)); <br> t1.InvokeMember( <font color="#A31515">"AlertInfo"</font> , System.Reflection.BindingFlags.Public | System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.SetProperty | <br> System.Reflection.BindingFlags.Instance, <font color="#0000ff">null</font> , query, <font color="#0000ff">new</font> <font color="#0000ff">object</font> [] { ai }); <br> <br> <br> <font color="#008000">//   query</font> <br> <br> ResultTable result = <font color="#0000ff">null</font> ; <br> <font color="#0000ff">try</font> <br> { <br> tables = query.Execute(); <br> } <br> <font color="#0000ff">catch</font> <br> { <br> alert2.Delete(); <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> } <br> <br> result = tables[ResultType.RelevantResults]; <br> <br> <font color="#008000">//  result -      alert2 -     </font> <br> <br> <br> alert2.Delete(); <br> <br> <font color="#008000">//    DataTable       .      - WorkId, Rank, Title, Author, Size, Path, Description, Write, SiteName, CollapsingStatus, HitHighlightedSummary, HitHighlightedProperties, ContentClass, IsDocument, PictureThumbnailURL</font> <br> <br> <font color="#008000">//  DiscoveredTime       </font> <br> <br> System.Data.DataTable myTable = <font color="#0000ff">new</font> System.Data.DataTable(); <br> myTable.Load(result2, System.Data.LoadOption.OverwriteChanges); <br> <br> <font color="#0000ff">foreach</font> (System.Data.DataRow myrow <font color="#0000ff">in</font> myTable.Rows) <br> { <br> <font color="#0000ff">if</font> ( <font color="#2B91AF">Convert</font> .ToDateTime(myrow[ <font color="#A31515">"DiscoveredTime"</font> ]) &gt; alertTime - span) <br> { <br> <font color="#008000">//   </font> <br> } <br> <font color="#0000ff">else</font> <br> { <br> <font color="#008000">//   </font> <br> } <br> } <br> <br> <font color="#008000">//   ,          SQL,  FullTextSqlQuery   </font> <br> <br> FullTextSqlQuery fts = <font color="#0000ff">new</font> FullTextSqlQuery(site2); <br> fts.QueryText = <font color="#A31515">"SELECT WorkId, Rank, Title, Author, Size, Path, Description, Write, SiteName, CollapsingStatus, HitHighlightedSummary, HitHighlightedProperties, ContentClass, IsDocument, PictureThumbnailURL, PopularSocialTags, PictureWidth, PictureHeight, DatePictureTaken, ServerRedirectedURL, ErgebnisKenntnis, LetzterKontakt, Kandidatenmail FROM SCOPE() WHERE Path='"</font> + myrow[ <font color="#A31515">"Path"</font> ].ToString() + <font color="#A31515">"'"</font> ; <br> fts.ResultTypes = ResultType.RelevantResults; <br> fts.RowLimit = 300; <br> ResultTableCollection rtc = fts.Execute();</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Where ErgebnisKenntnis, LetzterKontakt, Kandidatenmail are the SQL database fields (for example purposes only).  To be able to search by them, it is important that these fields be registered in the Metadata property of the Sharepoint 2010 server. <br><br>  Now we can form the HTML body of the myBody letter using any fields of the SQL database, Sharepoint and at the end do not forget to send it to the user. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">SPUtility.SendEmail(web, <font color="#0000ff">false</font> , <font color="#0000ff">false</font> , <font color="#0000ff">string</font> .Format( <font color="#A31515">"{0}"</font> , alertHandlerParams.headers[ <font color="#A31515">"To"</font> ]), <br> <font color="#0000ff">string</font> .Format( <font color="#A31515">"{0}"</font> , alertHandlerParams.headers[ <font color="#A31515">"Subject"</font> ]), myBody);</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Now, after performing points 2, 5-11 of the standard solution, users will receive search alerts, for example, in this form. <br><br><img src="http://my.jetscreenshot.com/7261/m_20110707-ppu3-91kb.jpg" width="640" height="257"><br><br>  Everything, the problem is solved.  I did not find any other ways on the Internet, so I will be glad if my decision will help someone. </div><p>Source: <a href="https://habr.com/ru/post/123863/">https://habr.com/ru/post/123863/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../123854/index.html">Cut the Rope - first place in the Android Market. How much is earned?</a></li>
<li><a href="../123856/index.html">Statistics on user profiles VKontakte</a></li>
<li><a href="../123857/index.html">Japanese use industrial iRobot to collect radioactive dust from Fukushima</a></li>
<li><a href="../123859/index.html">Making online payments simple and convenient. A1Pay system redesign</a></li>
<li><a href="../123860/index.html">Elephants love mangoes, part 2/2: backstage look at Evernote for Windows Phone 7</a></li>
<li><a href="../123864/index.html">Google is preparing a business version of Google+</a></li>
<li><a href="../123865/index.html">Digest Wanted.VC # 5</a></li>
<li><a href="../123866/index.html">My experience of withdrawing money from a blocked PayPal account</a></li>
<li><a href="../123868/index.html">The long-awaited Ciklum .NET Subbotnik - in Dnepropetrovsk</a></li>
<li><a href="../123870/index.html">Programming in nanoCAD: how to register your team in the nanoCAD environment?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>