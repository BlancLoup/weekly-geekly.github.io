<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write a simple player for Windows Phone</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article demonstrates how to write the simplest music player under Windows Phone. 

 Key features: the player works with a playlist, you can contr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write a simple player for Windows Phone</h1><div class="post__text post__text-html js-mediator-article">  This article demonstrates how to write the simplest music player under Windows Phone. <br><br>  Key features: the player works with a playlist, you can control the music (switch melodies), the player can play in the background. <br><br>  The author was primarily guided by an <a href="http://msdn.microsoft.com/en-us/library/hh202978(v%3Dvs.92).aspx">article</a> in which some elementary, but not always obvious, aspects of player writing were not covered.  They are dismantled in this article. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Creating a project </h2><br><img src="https://habrastorage.org/storage2/aac/812/410/aac8124104458fa9610b173b1e9d073e.png"><br><br>  We take as a basis the usual <b>Silverlight for Windows Phone</b> solution, let's call it <b>SimplePlayer</b> . <br><br><img src="https://habrastorage.org/storage2/0e4/d73/052/0e4d730527ecca1ddc98720f220dec90.png"><br><br>  To the existing solution we will add another project of the <b>Windows Phone Audio Playback Agent type</b> , let's call it <b>AudioPlaybackAgent</b> . <br><br><img src="https://habrastorage.org/storage2/066/82b/c8e/06682bc8e2b62eb3e8a0d38216d72094.png"><br><br>  In the project <b>SimplePlayer</b> add a link to the <b>AudioPlaybackAgent</b> . <br><img src="https://habrastorage.org/storage2/4f9/792/1ca/4f97921ca5b13ecf749819349331ee36.png"><br><br>  <b>SimplePlayer</b> is the main project, it contains and maintains the graphical interface and is launched first, and <b>AudioPlaybackAgent</b> is a shell over the internal Windows Phone player that runs from the main project when a track is requested to play. <br>  The communication between the two projects, during the execution of the application, is quite limited and imposes some restrictions, we will consider how to overcome them. <br><br><h2>  Interface design </h2><br>  We will deal with the design: it is quite simple and immediately makes it clear what functionality the application should have. <br>  To do this, open <b>MainPage.xaml</b> , which contains the markup interface. <br>  1. It is necessary to replace the <b>StackPanel</b> named <b>TitlePanel</b> with this code: <br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TitlePanel"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Row</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Margin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"12,17,0,28"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextBlock</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ApplicationTitle"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"SIMPLE PLAYER"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{StaticResource PhoneTextNormalStyle}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextBlock</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PageTitle"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"playlist"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Margin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"9,-7,0,0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{StaticResource PhoneTextTitle1Style}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  2. It is necessary to replace the <b>Grid</b> named <b>ContentPanel</b> with the code: <br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ContentPanel"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Row</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Margin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"12,0,12,0"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Orientation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Vertical"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ListBox</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PlayListBox"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">SelectionChanged</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PlayListBox_SelectionChanged"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Orientation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Horizontal"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PrevButton"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"prev"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"140"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"140"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PrevButton_Click"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PlayButton"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"play"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"140"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"140"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PlayButton_Click"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"NextButton"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"next"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"140"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"140"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"NextButton_Click"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  After that, the interface in the designer will look like this: <br><img src="https://habrastorage.org/storage2/c2a/5c0/071/c2a5c00717fa354259743e8aedafbd4a.png"><br><br>  With this we are done with the design. <br><br><h2>  Playlist </h2><br>  It's time to talk about how we will store the playlist with tracks and where we will take these tracks. <br><br>  Add some <b>mp3</b> or <b>wma</b> tracks to the <b>SipmlePlayer</b> project.  (In this example: 1.mp3, 2.mp3, 3.mp3) <br><br><img src="https://habrastorage.org/storage2/77b/4b5/4fd/77b4b54fdec9f5276f0f9316e5e17aa4.png"><br><br>  Now open the <b>MainPage.xaml.cs</b> file, which presents the code that serves our interface.  Add a field to the <b>MainPage</b> class: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; playlist;</code> </pre><br>  The same field should be added to the <b>AudioPlaybackAgent</b> project in the <b>AudioPlayer</b> class. <br><br>  In this field we will store our list of files, in favor of simplicity we immediately refuse to store and display the name of the tracks, artists and albums. <br><br>  We will not store the playlist statically in the code, but in the XML file that will be deserialized in the playlist field.  Add an xml file to the main project, let's name it <b>playlist.xml</b> .  Content will be: <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ArrayOfString</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsd</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span>1.mp3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span>2.mp3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span>3.mp3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ArrayOfString</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  For another list of files you just need to add, change, delete tags. <br><br><img src="https://habrastorage.org/storage2/48f/12c/1dd/48f12c1dd371d47d0f60e8ce167f6df0.png"><br><br>  Attention: Do not forget to set the <b>Build Action</b> in the <b>Content</b> and <b>Copy to Output Directory</b> files to <b>Copy always</b> in all music and playlist files. <br><br>  It's time to make <b>playlist.xml</b> available for both projects.  To do this, copy it to <b>IsolatedStorage</b> , which both projects have access to.  The repository, at the moment, is the only way to communicate information to the background agent in addition to events and the current track. <br><br>  The function of saving the file from the project to the repository: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CopyToIsolatedStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fullFilePath, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> storeFileName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (IsolatedStorageFile storage = IsolatedStorageFile.GetUserStoreForApplication()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!storage.FileExists(storeFileName)) { StreamResourceInfo resource = Application.GetResourceStream(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(fullFilePath, UriKind.Relative)); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (IsolatedStorageFileStream file = storage.CreateFile(storeFileName)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> chunkSize = <span class="hljs-number"><span class="hljs-number">4096</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[chunkSize]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> byteCount; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((byteCount = resource.Stream.Read(bytes, <span class="hljs-number"><span class="hljs-number">0</span></span>, chunkSize)) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { file.Write(bytes, <span class="hljs-number"><span class="hljs-number">0</span></span>, byteCount); } } } } }</code> </pre><br>  It needs to be added to the <b>MainPage</b> class, it does not make sense to look at it in detail in this article.  Then we call it from the constructor: <br><pre> <code class="cs hljs">CopyToIsolatedStorage(<span class="hljs-string"><span class="hljs-string">"playlist.xml"</span></span>, <span class="hljs-string"><span class="hljs-string">"playlist.xml"</span></span>);</code> </pre><br>  And now we will deserialize it and for this we will write a function, which also needs to be called in the constructor immediately after the previous one. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadPlaylist</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (IsolatedStorageFile myIsolatedStorage = IsolatedStorageFile.GetUserStoreForApplication()) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (IsolatedStorageFileStream stream = myIsolatedStorage.OpenFile(<span class="hljs-string"><span class="hljs-string">"playlist.xml"</span></span>, FileMode.Open)) { XmlSerializer serializer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XmlSerializer(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;)); playlist = (List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;)serializer.Deserialize(stream); } } }</code> </pre><br>  The same function should be copied into the <b>AudioPlaybackAgent</b> project and add its call in the constructor of the <b>AudioPlayer</b> class. <br><img src="https://habrastorage.org/storage2/e27/c37/9f2/e27c379f23aa78029f084336016117d7.png"><br><br>  <b>Attention:</b> For this function, you must add a link to <b>System.Xml.Serialization</b> . <br><br>  We will now take care of loading music files by writing a function to be called in the constructor <b>MainPage</b> class immediately after <b>LoadPlaylist ()</b> . <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadMusicFiles</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filepath <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> playlist) { CopyToIsolatedStorage(filepath, filepath); } }</code> </pre><br>  <b>Warning:</b> This method is not optimal and critical delays the loading of the application, I advise you to resort to <b>BackgroundWorker</b> for real applications. <br><br>  So that our playlist is displayed and the user can work with it, in the <b>MainPage</b> class in the constructor, after calling <b>InitializeComponent (),</b> we add the line: <br><pre> <code class="cs hljs">PlayListBox.ItemsSource = playlist;</code> </pre> <br><br><h2>  Event handlers </h2><br>  When we edited the XAML code, we declared event handlers, but did not describe them.  Consider the code: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PlayListBox_SelectionChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, SelectionChangedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> filepath = (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)e.AddedItems[<span class="hljs-number"><span class="hljs-number">0</span></span>]; BackgroundAudioPlayer.Instance.Track = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AudioTrack(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(filepath,UriKind.Relative),<span class="hljs-literal"><span class="hljs-literal">null</span></span>,<span class="hljs-literal"><span class="hljs-literal">null</span></span>,<span class="hljs-literal"><span class="hljs-literal">null</span></span>,<span class="hljs-literal"><span class="hljs-literal">null</span></span>); BackgroundAudioPlayer.Instance.Play(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PrevButton_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoutedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { BackgroundAudioPlayer.Instance.SkipPrevious(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PlayButton_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoutedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (BackgroundAudioPlayer.Instance.PlayerState == PlayState.Playing) BackgroundAudioPlayer.Instance.Pause(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> BackgroundAudioPlayer.Instance.Play(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NextButton_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoutedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { BackgroundAudioPlayer.Instance.SkipNext(); }</code> </pre><br>  The question may arise, what is the <b>BackgroundAudioPlayer</b> ? <br><br>  This, in fact, is the only direct connection with the background agent. <br>  In these handlers, we set the behavior of our agent, but we can also receive events from it (for example, stop the track, start playing, etc.), for this <b>we</b> add a method to the <b>MainPage</b> class: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Instance_PlayStateChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (BackgroundAudioPlayer.Instance.PlayerState) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PlayState.Playing: PlayButton.Content = <span class="hljs-string"><span class="hljs-string">"pause"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  ,    PlayListBox.SelectedItem = BackgroundAudioPlayer.Instance.Track.Source.OriginalString; break; case PlayState.Paused: case PlayState.Stopped: PlayButton.Content = "play"; break; } }</span></span></code> </pre><br><br>  And in the constructor of the <b>MainPage</b> class, <b>we</b> associate it with our agent with the string: <br><pre> <code class="cs hljs">BackgroundAudioPlayer.Instance.PlayStateChanged += Instance_PlayStateChanged;</code> </pre> <br>  It is worth noting that the <b>BackgroundAudioPlayer.Instance.PlayerState</b> field contains the current background agent state, i.e.  music plays, paused, over, and so on.  There is also the <b>BackgroundAudioPlayer.Instance.Position</b> field, which reflects the current place to play in the file, which can also be useful, we omit this feature. <br><br>  At this stage, our project is almost finished, but switching tracks does not work, and there is no transition to the next track if the current one has finished playing. <br><br>  In the <b>AuidioPlayer</b> class, you can see two interesting functions <b>OnPlayStateChanged</b> and <b>OnUserAction</b> .  The first is responsible for handling changes in the state of the agent, in the second - for processing the impact of the main project.  In both methods, stub methods are invoked, which serve up the next and previous track. <br><br>  We realize: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> AudioTrack </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNextTrack</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> next = (playlist.IndexOf(BackgroundAudioPlayer.Instance.Track.Source.OriginalString) + <span class="hljs-number"><span class="hljs-number">1</span></span>) % (playlist.Count); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AudioTrack(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(playlist[next], UriKind.Relative), <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); ; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> AudioTrack </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPreviousTrack</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> prev = (playlist.IndexOf(BackgroundAudioPlayer.Instance.Track.Source.OriginalString) <span class="hljs-number"><span class="hljs-number">-1</span></span> + playlist.Count) % (playlist.Count); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AudioTrack(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(playlist[prev], UriKind.Relative), <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); ; }</code> </pre><br>  For reasons unknown to the author, the template developers decided that at the end of the track ( <b>PlayState.TrackEnded</b> ), the previous track will be played next, to solve this misunderstanding, you need to replace <b>player.Track = GetPreviousTrack ()</b> in the <b>OnPlayStateChanged</b> handler <b>;</b>  on <b>player.Track = GetNextTrack ();</b>  . <br><br>  If the user has not selected a track, and he presses one of the buttons (play / next / prev), then the current track is also not selected in the <b>AuidioPlayer</b> class, and therefore critical exceptions may occur. <br>  At the first user event, we define the current track as the first one, if it is not already selected, adding the first line to the <b>OnUserAction</b> method: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (player.Track == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) player.Track = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AudioTrack(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(playlist[<span class="hljs-number"><span class="hljs-number">0</span></span>], UriKind.Relative), <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>);</code> </pre><br><br>  Now our application has all the declared basic functionality that is required for each player. <br><br><h2>  Conclusion </h2><br>  Implementing a player is a fairly typical task, and I hope that the article made it clear how to make a simple player. <br><br>  <b>Source code:</b> <a href="http://slylamb.codeplex.com/releases/view/83385">download</a> / <a href="http://slylamb.codeplex.com/SourceControl/changeset/view/12319">view</a> <br>  <b>Sample article based application:</b> <a href="http://www.windowsphone.com/ru-RU/apps/4303a6ff-5f46-410d-99c8-43ef300763eb">New Year's Music</a> </div><p>Source: <a href="https://habr.com/ru/post/139113/">https://habr.com/ru/post/139113/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139108/index.html">Three projects created in 2 days</a></li>
<li><a href="../139109/index.html">Google wanted to issue its currency</a></li>
<li><a href="../139110/index.html">Comparison of characteristics of micromechanical gyros</a></li>
<li><a href="../139111/index.html">3D stylus using echolocation</a></li>
<li><a href="../139112/index.html">Android x86 on Asus Eee PC 900</a></li>
<li><a href="../139115/index.html">The microphp manifesto</a></li>
<li><a href="../139116/index.html">Windows 8 Consumer Preview available for download</a></li>
<li><a href="../139117/index.html">The idea of ‚Äã‚Äãa Linux distribution with full (almost) support for Windows applications</a></li>
<li><a href="../139118/index.html">How to protect yourself when buying expensive goods on Ebay</a></li>
<li><a href="../139129/index.html">Introduction to the theory of interacting sequential processes (CSP), part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>