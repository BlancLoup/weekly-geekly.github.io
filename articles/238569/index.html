<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to solve user problems not in a day, but in minutes: we speed up the search in logs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We in Mail.Ru Mail are constantly faced with the need to work with the history of users. Given that the monthly audience of the project is more than 4...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to solve user problems not in a day, but in minutes: we speed up the search in logs</h1><div class="post__text post__text-html js-mediator-article">  We in Mail.Ru Mail are constantly faced with the need to work with the history of users.  Given that the monthly audience of the project is more than 40 million people, the history of all their actions is in the order of petabyte data.  The need to search for logs arises hundreds of times a day, and on average it took several hours to obtain the necessary information.  In this case, according to our assumptions, the extraction of information from the logs could be accelerated to a few seconds. <br><br>  To evaluate the feasibility of developing a system for optimizing the search by logs, we used this <a href="http://xkcd.com/1205/">table with XKCD</a> : <br><br> <a href="http://habrahabr.ru/company/mailru/blog/238569/"><img src="https://habrastorage.org/files/cd5/8f4/69d/cd58f469df5c4c4388fec5effff2a965.png"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      (not really, but we still like it). <br><br>  So, we seriously took up the optimization.  The result of our work was the development of a system, thanks to which we can raise the history of actions by about 100,000 (one hundred thousand, this is not a typo) times faster.  We have developed a big-data service that allows you to store petabytes of information in a structured way: we have a log of some events for each key.  The storage is designed so that it can work on the cheapest SATA disks, and on large multi-disk storages with a minimum of processor time, while it is completely fault-tolerant - if suddenly a machine fails, it doesn‚Äôt matter affects.  If the system runs out of space, it simply adds a server or several: the system automatically sees them and starts recording data.  Reading data occurs almost instantly. <br><a name="habracut"></a><br><h1>  What's the catch? </h1><img src="https://habrastorage.org/files/067/d2d/acf/067d2dacf81e45e7a18f2e690c569e15.png"><br><br>  Why do you need it?  Suppose the user is not working.  To reproduce the error, we need to know the whole background: where the person went, what buttons and links clicked.  Also, logs are necessary for decision-making in cases such as hacking a user account, when it is important to separate the actions of the user and the attacker. <br><br>  Accordingly, the speed of the response of the technical support service is ‚Äútied‚Äù to the speed of the search by logs. <br><br>  During a working day, a large system can accumulate several terabytes of logs, especially considering that our company has a lot of ‚Äúcompound‚Äù services.  Suppose the user went to the mail, the mail turned to the database, the database to the storage system, she also wrote logs ... To understand what the user was doing, all this data needs to be collected into a heap.  To do this, use the good old grep command, from which the word "grepat".  To solve the problem of a single user, we for example, terabyte.  This process can take several hours.  We attended to this problem and began to think how to process this data much faster. <br><br>  The problem is that there are no complete separate systems for storing and processing logs corresponding to our tasks.  For example, Hadoop (like any other implementation of MapReduce) can parallel logs in parallel and bring together the results.  But, since in the Mail and Mail.Ru Cloud the volume of logs that need to be stored is estimated to be petabyte, even parallel processing of such a volume will require a lot of time.  In addition, for a day, it is necessary to go through several terabytes, and for a week, this volume can increase to ten terabytes.  Plus, if you need to bail out for a large number of different logs, then to solve just one problem you might need a few dozen terabytes of logs. <br><br>  Hard disks can write information linearly at a speed of about 100 Mbps.  However, quick writing implies unstructured, non-optimal placement of information.  And for quick reading of files it is necessary that they be structured in a certain way.  We needed to provide high speed of both processes.  The logs constantly preserve a large amount of information, while we need to quickly collect statistics on a specific user in order to promptly solve his problems, providing high-quality technical support. <br><br>  It would be possible to follow the simplest path by organizing the storage of logs in a database.  But this is a very, very expensive solution, since it requires the use of SSD disks, sharding the database, creating replicas.  We wanted to find a solution that would allow us to work with the most cheap storage on slow disks of huge volume. <br><br>  Taking into account all these factors, it was decided to write a system from scratch, which allows speeding up the process of fastening.  By the way, as far as we know, it has no analogues not only in Russia, but also in the world. <br><br><h1>  How did we do it? </h1><img src="https://habrastorage.org/files/de2/6a9/ac7/de26a9ac74e54def8f5e75070eefa015.png"><br><br>  The system we have created for this is as follows.  From the programmer‚Äôs point of view, it performs essentially two operations: creating a record for a specific user (ID and time) and getting the entire history for a specific user. <br><br>  The recording is carried out in our database Tarantool.  In it all information is always stored in one file, and reading is carried out from memory.  Base shardirovana on several instances.  The logs themselves are stored on multidisk servers.  Since Tarantool stores everything both in memory and on disk, it is clear that this cannot continue indefinitely.  Therefore, a process is periodically launched that groups data from Tarantool by users and writes them into files on servers, and in the database puts a link to this data. <br><br>  Thus, Tarantool stores only a recent history by users (accordingly, it can be quickly retrieved).  And the ‚Äúold‚Äù data is stored on disks in one large file, well structured and suitable for quick reading.  Thanks to this, the entire history of any user can be obtained in a matter of seconds.  For comparison: prior to this, weekly period for one user took about three days. <br><br>  Each disk contains several files in which all information on different users is recorded in a row.  So that Tarantool does not overflow, the following is done: a process that consistently reads all these files, takes the information about the user from the file, adds to it what is in Tarantool, and writes it all back to the end of the file.  This whole system is also shardirovanny and replicated, that is, there can be as many servers as possible, because every time we rewrite the user's history, we always write it down to two disks, which are chosen arbitrarily.  After successful pair recording, the link is saved in Tarantool.  Thus, if even one of the servers falls, the information does not disappear.  When a new server is added, it is registered in the system configuration, after which new data is automatically saved to it. <br><br>  Now this system is used in Mail and Cloud Mail.Ru.  In the near future, we plan to implement it in Mail.Ru for Business, and then gradually on other projects. <br><br><h1>  How it works? </h1>  We search the logs in two types of cases.  First, to solve technical problems.  For example, a user complains that something is not working for him, and we need to quickly see the whole history of his actions: what he did, where he went, and so on.  Secondly, if we have a suspicion that a box has been hacked.  As I said above, in this case, the story is needed in order to divide the user's actions into his own and those committed by the attacker. <br><br>  I will give a few examples of how effective the system we have created. <br><br>  Quite a frequent case: the user complains about the loss of letters from the mailbox.  We pick up the story and see when and from which programs he deleted them.  Suppose we see that the letters were deleted from such an IP address via POP3, from which we conclude that the user connected the POP3 client and selected the option ‚ÄúDownload all letters and delete them from the server‚Äù - that is, in fact letters were deleted by the user, and not "disappeared."  Thanks to our systematized system of log storage, we can establish this fact and demonstrate it to the user in a matter of seconds.  Saving time admins and support - a giant. <br><br>  Another example: we receive a complaint from a user who cannot open the letter.  Having raised all the logs for this user, we can literally within a few seconds see when and which server calls were made, by what user agents, what was happening on the client side.  Thanks to this, we can more easily and, most importantly, establish more quickly what the problem is. <br><br>  Another case - the user complains that he can not enter the mailbox.  We begin to look for the cause - it turns out that the account was automatically blocked for spamming.  Here you need to figure out who exactly is spam - the user himself or someone else on his behalf, and for this you will have to analyze the entire history of using the box for a long period (perhaps a week, a month or even more).  Having glanced in history, we see that, starting from a certain date, they came into his box from a suspicious (ie, ‚Äúnon-native‚Äù for the user) region.  Obviously, he was just hacked.  Moreover, the data collection and analysis took not a day, but several seconds: the technical support employee simply pressed a button and received exhaustive information.  The user changed the password from the mailbox and got access to it again. <br><br>  In short, our system saves us a lot of time every day, while allowing us to reduce the response time to the user - in my opinion, this is win.  We will tell about other ways of its application in the following posts. </div><p>Source: <a href="https://habr.com/ru/post/238569/">https://habr.com/ru/post/238569/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../238557/index.html">Personal devices when working with corporate data: BYOD or bring your own device</a></li>
<li><a href="../238559/index.html">Geektimes - new TM project?</a></li>
<li><a href="../238561/index.html">The next Moscow CocoaHeads will be held on October 3</a></li>
<li><a href="../238565/index.html">We are being watched or clickjacking for business</a></li>
<li><a href="../238567/index.html">Java ME: Midlet Structure</a></li>
<li><a href="../238571/index.html">QJack thermometer helps turn temperature measurement into a game</a></li>
<li><a href="../238573/index.html">Sony: we will teach you to look at the world with alien eyes</a></li>
<li><a href="../238575/index.html">FTN-based messenger</a></li>
<li><a href="../238577/index.html">Facebook opened the veil to its technology</a></li>
<li><a href="../238581/index.html">The structure of the code in Unity3d - personal opinion and a couple of tricks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>