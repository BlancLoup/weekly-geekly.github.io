<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The system of timely replenishment of the mobile account</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think many people had the idea to automate one or another sequence of actions in order to do something really important and ambitious, for example, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The system of timely replenishment of the mobile account</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/14269446/7636d8e8/381963a0/2681bd4b.jpg"><br>  I think many people had the idea to automate one or another sequence of actions in order to do something really important and ambitious, for example, to go to the shower or eat.  This story is about the implementation of one such idea. <br><a name="habracut"></a><br><a name="p00"></a><h4>  CONTENT </h4><br>  <a href="https://habr.com/ru/post/131962/">SYMBOLS AND ABBREVIATIONS</a> <br>  <a href="https://habr.com/ru/post/131962/">INTRODUCTION</a> <br>  1. <a href="https://habr.com/ru/post/131962/">DESCRIPTION OF SERVICES AND SYSTEMS</a> <br>  2. <a href="https://habr.com/ru/post/131962/">PROJECT TASK</a> <br>  3. <a href="https://habr.com/ru/post/131962/">DESCRIPTION OF THE PROJECT</a> <br>  3.1.  <a href="https://habr.com/ru/post/131962/">Funds for receiving personal account status</a> <br>  3.2.  <a href="https://habr.com/ru/post/131962/">Means for working with poison</a> <br>  3.3.  <a href="https://habr.com/ru/post/131962/">Twitter Tools</a> <br>  4. <a href="https://habr.com/ru/post/131962/">WORK AND LOGIC</a> <br>  <a href="https://habr.com/ru/post/131962/">CONCLUSION</a> <br>  <a href="https://habr.com/ru/post/131962/">LIST OF USED SOURCES</a> <br><br><a name="p02"></a><h4>  SYMBOLS AND ABBREVIATIONS </h4><br>  LISA - subscriber‚Äôs personal Internet service; <br>  POISON - Yandex.Money; <br>  Drink poison - to receive money on Yandex-wallet; <br>  DB - database. <br><br><a name="p03"></a><h4>  INTRODUCTION </h4><br>  Like many people, every now and then comes the thought that there are many things in our life that are overly complex and confusing, they require simplification.  About this thought came to me when, once again, I received a text from my mobile operator that the balance was approaching zero and, once again, I went to the POISON, went through authorization, clicked to repeat the payment, confirmed, indicated payment password, wait for the execution, out of the poison.  Somehow a lot of action, do not you think?  It seemed to me that way, and indeed, this is a very tedious process, I need to find a simpler way that would suit me. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I would like to note that the process took me so much that I am not sure now - did I save time on all this or was it easier to leave everything as it is?  However, I am such a person, I take a great interest in all sorts of interesting activities quickly, so the implementation process itself brought more pleasure than the final result. <br><br><a name="p1"></a><h4>  1. DESCRIPTION OF SERVICES AND SYSTEMS </h4><br>  <b>LISA</b> is a service that allows subscribers of Motive Company to manage the current state of their personal account and use services via the Internet. <br><br>  <b>POISON</b> - electronic payment system.  Many stores and companies implement support for the Poison, which makes it easy and simple to pay for goods and services.  ‚ÄúMotive‚Äù is just one of those companies where the possibility of recharge is realized through nuclear weapons. <br><br>  <b>Twitter</b> is a system that allows users to send short text notes (up to 140 characters) using a web interface, SMS, instant messaging tools, or third-party client programs.  A distinctive feature of Twitter is the public availability of posting, which makes it related to blogs. <br><br><a name="p2"></a>  <a href="https://habr.com/ru/post/131962/">Back to content ‚Üí</a> <br><br><h4>  2. PROJECT TASK </h4><br>  The implementation of the mobile phone balance replenishment system from the Poison Wallet is the main task of the project, the balance replenishment should occur without any predetermined frequency.  Mobile account should be replenished only when necessary. <br><br>  The system should include: <br><ol><li>  Funds for receiving personal account status; </li><li>  Means for working with nuclear weapons; </li><li>  Tools for working with Twitter. </li></ol><br><a name="p3"></a>  <a href="https://habr.com/ru/post/131962/">Back to content ‚Üí</a> <br><br><h4>  3. DESCRIPTION OF THE PROJECT </h4><br>  The project is located on the Masterhost site, hosting is received free of charge, as part of the student support program.  It was necessary to contact technical support to turn on curl and obtain information about the scheduler, since this service was not provided on windows tariffs.  It was proposed to add an entry to the crontab on a unix server, to which I agreed.  I gave a link to the script and indicated a frequency of 10 minutes, after which I was warned that if the script would create a greater load, it would have to be disabled. <br><br><a name="p31"></a>  <a href="https://habr.com/ru/post/131962/">Back to content ‚Üí</a> <br><br><h5>  3.1.  Funds for receiving personal account status </h5><br>  In the first version, the state of the mobile account had to be received directly through the FOX site, which took quite a long time and did not always give a result, sometimes the duration of the operation reached 10 seconds, which was simply unacceptable. <br><img src="https://habrastorage.org/storage1/2d17c2b4/b0460c5c/b2b0de38/60f69bda.jpg"><br>  Figure 3.1 - LISA website. <br><br>  After a long and merciless communication with the technical support of the Motiv Company, I learned that in the near future the Balance Gadget will be introduced, which is intended to display the current balance of the personal account.  In addition, I received information that the service is not planned to have any external interface, which, by the way, I was no longer needed, I was sure that I could get all the information from the gadget. <br><img src="https://habrastorage.org/storage1/e0390db3/bed52734/c9df9c56/d1a62974.jpg"><br>  Figure 3.2 - Information about the "Balance Gadget" and the button for its formation. <br><br>  Previously, I did not have to work with gadgets for Windows 7 or Vista, after installing / reinstalling the operating system, I immediately disconnected the whole thing, because I didn‚Äôt see this as necessary, and on my home computer I‚Äôve got the old Windows XP. <br><img src="https://habrastorage.org/storage1/028634c9/3d572195/2339b6b6/c5b6d03a.jpg"><br>  Figure 3.3 - The internal structure of the "Balance Gadget". <br><br>  In the directory ‚Äúmotiv_balance.gadget \ js‚Äù there are files: <br><ul><li>  balance.js - the main logic of the gadget; </li><li>  jquery.js is a common javascript library; </li><li>  settings.js - the implementation of the functions of reading and saving gadget settings. </li></ul>  I set about studying the balance.js file and immediately came across the desired getInfo () function, in which the request is being generated and sent: <br><pre><code class="javascript hljs">_req = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActiveXObject(<span class="hljs-string"><span class="hljs-string">"Microsoft.XMLHTTP"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*don't change this sequence! it invokes non-ordering requests: xz why*/</span></span> _req.open(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre>  a response is expected, then it is passed to the showResponse () function, which is responsible for processing and displaying the result. <br><br>  As you have already noticed, accessing the operator‚Äôs site is nothing more than a regular GET request, which consists of several parameters: <br><ul><li>  uid - unique identifier associated with the subscriber number; </li><li>  b - type of data request.  It can take two values: ‚Äúa‚Äù - a simplified report (only the state of the personal account) or ‚Äúb‚Äù - extended (the state of the personal account + balances on subscriptions / service packages, for example, the number of purchased SMS or MMS).  Not sure if all this works, this value, in a mystical way, depends on System.Gadget.docked; </li><li>  a is a random number. </li></ul>  Here's what it looks like: <br><pre> <code class="javascript hljs"> b = System.Gadget.docked ? <span class="hljs-string"><span class="hljs-string">'a'</span></span> : <span class="hljs-string"><span class="hljs-string">'b'</span></span>; a = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.round(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * <span class="hljs-number"><span class="hljs-number">10000</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*it should be global: no ideas why*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = <span class="hljs-string"><span class="hljs-string">"https://gadget.motivtelecom.ru/?uid=UID&amp;b="</span></span>+b+<span class="hljs-string"><span class="hljs-string">"&amp;a="</span></span> + a;</code> </pre>  In response, we receive either information about the current state of the account, for example: <br><pre>  3 = RUB: 80p.45k. </pre>  where 3 is the version number of the gadget, at the time of writing the article (var VERSION = 3;), or an error message <s>with a detailed description</s> : <br><pre>  3 = ERR </pre><br>  Armed with this knowledge, I wrote the simplest function that cURL sends the request. <pre> <code class="php hljs"> $req_lisa = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( CURLOPT_HEADER =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, CURLOPT_CONNECTTIMEOUT =&gt; <span class="hljs-number"><span class="hljs-number">10</span></span>, CURLOPT_TIMEOUT =&gt; <span class="hljs-number"><span class="hljs-number">10</span></span>, CURLOPT_SSL_VERIFYPEER =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, CURLOPT_SSL_VERIFYHOST =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, CURLOPT_RETURNTRANSFER =&gt; <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, CURLOPT_URL =&gt; LISA_URL ); $ci = curl_init(); curl_setopt_array ($ci, $req_lisa); $result_lisa = curl_exec($ci);</code> </pre>  The time required to execute a query and process the result was reduced from 10 seconds to 0.26 seconds. <br><br><a name="p32"></a>  <a href="https://habr.com/ru/post/131962/">Back to content ‚Üí</a> <br><br><h5>  3.2.  Means for working with nuclear weapons </h5><br>  To work with poison you need: <ol><li>  Examine the documentation; </li><li>  Register the application (get client_id); </li><li>  Get a temporary token (less than 1 minute); </li><li>  Get an authorization token (for a period of 1 year). </li></ol><img src="https://habrastorage.org/storage1/705500e4/91c76bc6/ac429148/775477e2.jpg"><br>  Figure 3.4 - Information about the registered application. <br><br>  The received authorization token is limited to 1 store (Company ‚ÄúMotive‚Äù) and the limit ‚Äú1 thousand rubles per week‚Äù with the ability to view information about the current account: <br><pre> <code class="html hljs xml">scope=payment.to-pattern("1122").limit(7,1000) account-info</code> </pre>  Now we have methods at our disposal: <ul><li>  account-info - information about the status of the account, I have not used this method; </li><li>  request-payment - payment request; </li><li>  process-payment - payment confirmation; </li></ul>  To make a payment, we create a payment template: <br>  pattern_id = 1122 &amp; PROPERTY1 = 908 &amp; PROPERTY2 = 9089XXX &amp; sum =% s <br>  and send a request-payment request for nuclear weapons, if everything is correct, then we get a json-string with the status value ‚Äúsuccess‚Äù and the desired request_id, everything else for us, other than ‚Äúsuccess‚Äù, is equivalent to failure and may depend on various factors such such as: technical problems on the side of Yandex, technical problems on the side of the store, or something else. <br>  If everything is in order, then we are sending a process-payment request containing the request_id, thereby confirming the payment: <br><pre> <code class="php hljs">$yad = json_decode($result, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( $yad[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] == <span class="hljs-string"><span class="hljs-string">'success'</span></span> ) { $pay_fields = sprintf($process_fields, $yad[<span class="hljs-string"><span class="hljs-string">'request_id'</span></span>]); curl_setopt($ci, CURLOPT_URL, YM_PROC_URL); curl_setopt($ci, CURLOPT_POSTFIELDS, $pay_fields); $result_pay = curl_exec($ci); curl_close($ci); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> json_decode($result_pay, <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre>  In case of successful or unsuccessful payment, we also get a json string with the status parameter.  If the status parameter has the ‚Äúsuccess‚Äù value, the payment number and the account status information are returned. <br><br><a name="p33"></a>  <a href="https://habr.com/ru/post/131962/">Back to content ‚Üí</a> <br><br><h5>  3.3.  Twitter Tools </h5><br>  A ready library was chosen for work, all that was needed was to register your application on the website for developers and get all the necessary parameters for work: <ul><li>  Consumer key </li><li>  Consumer secret </li><li>  Access token </li><li>  Access token secret </li></ul><img src="https://habrastorage.org/storage1/294017ad/35c498da/5e1b40c0/b210fc34.jpg"><br>  It seemed to me that it would be very sad and not cool if the same tweets were posted on Twitter, so I sketched a set of phrases that my bot application now operates on: <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRandomTwit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $music_bands = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> ( <span class="hljs-string"><span class="hljs-string">'Queen'</span></span>, <span class="hljs-string"><span class="hljs-string">'Coldplay'</span></span>, <span class="hljs-string"><span class="hljs-string">'Muse'</span></span>, <span class="hljs-string"><span class="hljs-string">'Justice'</span></span>, <span class="hljs-string"><span class="hljs-string">'Duft Punk'</span></span>, <span class="hljs-string"><span class="hljs-string">'Radiohead'</span></span>, <span class="hljs-string"><span class="hljs-string">'Adele'</span></span>, <span class="hljs-string"><span class="hljs-string">'Beatles'</span></span>, <span class="hljs-string"><span class="hljs-string">'Red Hot Chili Peppers'</span></span>, <span class="hljs-string"><span class="hljs-string">'Foo Fighters'</span></span>, <span class="hljs-string"><span class="hljs-string">'Killers'</span></span>, <span class="hljs-string"><span class="hljs-string">'Gorillaz'</span></span> ); $rand_music_band = $music_bands[rand(<span class="hljs-number"><span class="hljs-number">0</span></span>, sizeof($music_bands)<span class="hljs-number"><span class="hljs-number">-1</span></span>)]; $twi_mask = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> ( <span class="hljs-string"><span class="hljs-string">'  ,  ,  %1$s #motiv #motivtelecom #wtf'</span></span>, <span class="hljs-string"><span class="hljs-string">'   : %1$s #motiv'</span></span>, <span class="hljs-string"><span class="hljs-string">' ,   %1$s #motiv'</span></span>, <span class="hljs-string"><span class="hljs-string">'%1$s    #motiv'</span></span>, <span class="hljs-string"><span class="hljs-string">'#motiv   !    %1$s'</span></span>, <span class="hljs-string"><span class="hljs-string">'  .,   %3$s. : %1$s #motivtelecom'</span></span>, <span class="hljs-string"><span class="hljs-string">'%1$s   ,  ? #motiv'</span></span>, <span class="hljs-string"><span class="hljs-string">' - ,   %1$s #motiv'</span></span>, <span class="hljs-string"><span class="hljs-string">'  '</span></span>.$rand_music_band.<span class="hljs-string"><span class="hljs-string">'  ...     %1$s #motiv'</span></span>, <span class="hljs-string"><span class="hljs-string">'!     %1$s #motiv #motivtelecom #whyyyyyy'</span></span>, <span class="hljs-string"><span class="hljs-string">', #motiv    , ,     ;)  %2$s .'</span></span>, <span class="hljs-string"><span class="hljs-string">' ,  ,    !  ,   %1$s'</span></span>, <span class="hljs-string"><span class="hljs-string">'     ,  ,     %1$s #motivtelecom'</span></span>, <span class="hljs-string"><span class="hljs-string">'YU SO GREEDY? %2$s rub #motiv #motivtelecom'</span></span>, <span class="hljs-string"><span class="hljs-string">'#motiv    !  %1$s #motivtelecom #yusogreedy'</span></span>, <span class="hljs-string"><span class="hljs-string">'  ,      ,       !  %2$s .'</span></span>, <span class="hljs-string"><span class="hljs-string">'   GPRS- : %3$s.   : %1$s #motiv'</span></span>, <span class="hljs-string"><span class="hljs-string">',      :( %2$s . #motiv #motivtelecom'</span></span>, <span class="hljs-string"><span class="hljs-string">' -,   '</span></span>.$rand_music_band.<span class="hljs-string"><span class="hljs-string">',    %2$s . #motiv #'</span></span>.str_replace(<span class="hljs-string"><span class="hljs-string">' '</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>, strtolower($rand_music_band)), <span class="hljs-string"><span class="hljs-string">'      ..    ! :(    %2$s .'</span></span>, <span class="hljs-string"><span class="hljs-string">'#motiv     '</span></span>.$rand_music_band.<span class="hljs-string"><span class="hljs-string">'  ? , %2$s   .'</span></span>, <span class="hljs-string"><span class="hljs-string">'  !   %1$s #motivtelecom'</span></span>, <span class="hljs-string"><span class="hljs-string">',   ,   - - %)    %1$s #motiv'</span></span>, <span class="hljs-string"><span class="hljs-string">'   ,   ,   %3$s :)   %2$s .'</span></span>, <span class="hljs-string"><span class="hljs-string">'  ,     ? , ,    %2$s . #motiv'</span></span>, <span class="hljs-string"><span class="hljs-string">' -  ,       . #motiv'</span></span>, <span class="hljs-string"><span class="hljs-string">'BREAKING NEWS! Balance: %2$s rub.'</span></span>, <span class="hljs-string"><span class="hljs-string">'    ,    ! ,    %2$s .'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ($twi_mask[rand(<span class="hljs-number"><span class="hljs-number">0</span></span>, sizeof($twi_mask)<span class="hljs-number"><span class="hljs-number">-1</span></span>)]); }</code> </pre>  The library is extremely simple: <br><pre> <code class="php hljs">$twitter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Twitter(TWT_CON_KEY, TWT_CON_SEC, TWT_ACC_TOK, TWT_ACC_TOK_SEC); $twitter-&gt;send(sprintf(GetRandomTwit(), GetSumWithPost($current_bal_value), $current_bal_value, YM_WALLET));</code> </pre> <br><a name="p4"></a>  <a href="https://habr.com/ru/post/131962/">Back to content ‚Üí</a> <br><br><h4>  4. WORK AND LOGIC </h4><br>  The main idea of ‚Äã‚Äãthe application is to make the payment timely, I do not need the balance to be replenished every day with 50 or 100 rubles, because I can simply not use the phone on that day and it could be implemented at the POISON.  It was up to the logic of the work, because all the components already exist and work. <br><br>  Lowering the extra checks, it all comes down to a clear view: <br>  1. I check the current balance in order to know when to top up, you should always be aware of how much money is in the account now; <br>  2. I determine the difference between the reference value of the balance (100 rubles) and the current one; <br>  2.1.  The difference is greater than the specified value (20 rubles): <br>  2.1.1.  make payment; <br>  2.1.2.  I am writing a new value in the database; <br>  2.1.3.  writing on twitter. <br>  2.2.  The difference is less than the specified value (20 rubles): <br>  2.2.1.  I compare the current value with the last recorded in the database, if the difference is positive, then the balance has increased: <br>  2.2.1.1.  I am writing a new value in the database; <br>  2.2.1.2.  I am writing to Twitter that someone from outside has filled up the balance. <br>  2.2.2.  I compare the current value with the last recorded in the database, if the difference is negative and less than the specified value (-5 rubles): <br>  2.2.2.1.  I am writing a new value in the database; <br>  2.2.2.2.  I am writing to Twitter that the balance has changed. <br><br>  There are some reservations that had to be considered: <br>  - Motive does not accept payments of less than 10 rubles - this means that the difference between the current account balance and the reference setpoint must be at least 10 rubles in order to replenish; <br>  - the sum of 20 rubles is taken in order not to tweet about the replenishment of the account; <br>  - the difference of 5 rubles, which was mentioned above, was taken for a reason, there was no limitation before, and the application reported, via Twitter, every 10 minutes that the balance changed by 7 kopecks, or even less - it made me put a certain limiter, at first it was equal to 1 ruble, but even this was not enough, now the limiter is equal to 5 rubles and nothing bothers me anymore; <br>  - if the difference between the current value and the reference leaves more than 100 rubles, then we begin to suspect something is wrong and replenish the balance in parts, first 100 rubles, then the remaining money, on the same principle. <pre> <code class="php hljs">$pay_bot = (floor(BAL_LEVEL-$current_bal_value)&gt;BAL_PAY_LEVEL_MAX)?BAL_PAY_LEVEL_MAX:(floor(BAL_LEVEL-$current_bal_value));</code> </pre>  There will be enough time to answer the questions: ‚ÄúWhere did the money go?  Why such a big minus?  Who is to blame? ‚Äù, Drink a cup of tea and, finally, turn off the bot. <br><br><pre> <code class="php hljs"> $pay_bot = (floor(BAL_LEVEL-$current_bal_value)&gt;BAL_PAY_LEVEL_MAX)?BAL_PAY_LEVEL_MAX:(floor(BAL_LEVEL-$current_bal_value)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( $pay_bot &gt;= BAL_PAY_LEVEL ) { $pay_bot += BAL_UP_SUM; $ym_pay_state = YandexMoneyPay($pay_bot); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( $ym_pay_state[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] == YM_PAY_STAT ) { $twitter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Twitter(TWT_CON_KEY, TWT_CON_SEC, TWT_ACC_TOK, TWT_ACC_TOK_SEC); $twitter-&gt;send(sprintf($plus_pay, GetSumWithPost($pay_bot), GetSumWithPost($current_bal_value+$pay_bot), GetSumWithPost($ym_pay_state[<span class="hljs-string"><span class="hljs-string">'balance'</span></span>]))); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $pay_user = floor($current_bal_value - $last_bal_value); $bal_diff = $last_bal_value - $current_bal_value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( $pay_user &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> $bal_diff &gt;= BAL_CHANGE_LEVEL ) { $twitter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Twitter(TWT_CON_KEY, TWT_CON_SEC, TWT_ACC_TOK, TWT_ACC_TOK_SEC); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( $pay_user &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ) $twitter-&gt;send(sprintf($user_pay, GetSumWithPost($pay_user), GetSumWithPost($current_bal_value))); <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> ( $bal_diff &gt;= BAL_CHANGE_LEVEL ) $twitter-&gt;send(sprintf(GetRandomTwit(), GetSumWithPost($current_bal_value), $current_bal_value, YM_WALLET)); } }</code> </pre>  I note that the value of BAL_UP_SUM increases any payment.  Now the value of BAL_UP_SUM is 1, you see that the above all calculations are applied with rounding down, to go beyond 99 rubles with kopecks, you should add 1 ruble.  Also, this value can be increased in order for the application not to bother its constant writing to Twitter. <br><br><a name="p04"></a>  <a href="https://habr.com/ru/post/131962/">Back to content ‚Üí</a> <br><br><h4>  CONCLUSION </h4><br>  At the time of writing, I ran into some questions that I could not find the answer to. <br>  For a long time I could not understand why I could not make a transfer to a mobile account through nuclear weapons, although in the response to the request-payment-request the value ‚Äúsuccess‚Äù comes.  It turned out that the example given in the documentation: <br>  pattern_id = 2904 &amp; phone-prefix = 921 &amp; phone-number = 9538 &amp; sum = 300.00 <br>  with the content of the phone-prefix and phone-number fields, it is not necessary for each store, at Motiv these parameters are named PROPERTY1 and PROPERTY2, for MTS or Megaphone these fields may also have other names.  Fields for Motive were suggested to me by the moderators of the API Club of the Poison, which is strange.  Once I know the values ‚Äã‚Äãof these fields in the poison, why is it simple, during the payment, they cannot be reassigned from their parameter names to the parameters of the store? <br><br>  And one more question, it is directly related to the first.  When I sent a request with incorrect field names to me, for some reason, the value ‚Äúsuccess‚Äù came in, also the request_id parameter came, for which you need to confirm the payment.  Such payments, of course, did not go through, but why did I receive success in status?  The developer‚Äôs manual clearly states that ‚Äúsuccess‚Äù is a successful implementation. <br><br>  I would be glad if someone answers these questions. <br><br>  I would like to thank: <ul><li>  Motive employee - Marina Neumann; </li><li>  Moderators of the Yandex.Money API club - Line and hh; </li><li>  Employees of the company Masterkhost. </li></ul>  The result of the work: <a href="http://twitter.com/001011010">http://twitter.com/001011010</a> <br><br><a name="p05"></a>  <a href="https://habr.com/ru/post/131962/">Back to content ‚Üí</a> <br><br><h4>  LIST OF USED SOURCES </h4><br>  1. Yandex.Money API.  Developer's Guide // materials site <a href="http://api.yandex.ru/money/doc/dg/">api.yandex.ru/money/doc/dg/</a> . <br>  2. Club for developers using the Yandex.Money API // materials on the site <a href="http://clubs.ya.ru/moneyapi/">clubs.ya.ru/moneyapi/</a> . <br>  3. Twitter.  Site for developers // materials of the site <a href="https://dev.twitter.com/">dev.twitter.com</a> . <br>  4. FOX.  Gadget balance // materials site <a href="http://lisa.motivtelecom.ru/">lisa.motivtelecom.ru</a> . <br>  5. Materials site <a href="http://ru.wikipedia.org/">en.wikipedia.org</a> . </div><p>Source: <a href="https://habr.com/ru/post/131962/">https://habr.com/ru/post/131962/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../131954/index.html">Meeting users Sphinx search '11</a></li>
<li><a href="../131955/index.html">Groupon went IPO and raised over $ 700 million</a></li>
<li><a href="../131956/index.html">Streetter</a></li>
<li><a href="../131957/index.html">The new SiRFstarV chip for navigation inside buildings and with a cloud platform</a></li>
<li><a href="../131961/index.html">Do you trust sms-informing?</a></li>
<li><a href="../131964/index.html">Privat24. Change of payment confirmation method</a></li>
<li><a href="../131965/index.html">Acer C20 Pocket Projector Review</a></li>
<li><a href="../131966/index.html">Python + Selenium = not just tests</a></li>
<li><a href="../131968/index.html">Why is it worth using RVM instead of rbenv + ruby-build</a></li>
<li><a href="../131969/index.html">Dell Vostro 3750 Matte Dream</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>