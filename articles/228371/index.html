<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Link Doctrine Entity and Doctrine Document on the form in the Sonata Admin Bundle</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the process of developing an online store, the task was to implement the address book for an authorized user. So that the user himself is stored in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Link Doctrine Entity and Doctrine Document on the form in the Sonata Admin Bundle</h1><div class="post__text post__text-html js-mediator-article">  In the process of developing an online store, the task was to implement the address book for an authorized user.  So that the user himself is stored in the mysql database, and the addresses associated with it are stored in mongoDB.  This task deserves special attention in terms of managing users and their address books from the admin area, based on SonataAdminBundle. <br><br><h4>  Initial data: </h4><br>  There is a doctrine entity User and a doctrine document Address.  One-to-many relationship must be established between them.  All this should be controlled from the add user form in the Sonata-based admin panel.  Since a user can have many addresses, a form of adding addresses with buttons ‚Äúadd‚Äù, ‚Äúdelete‚Äù and inline editing the fields of related addresses should be implemented on the add user form.  This is what we will do next. <br><br><h4>  What we need: </h4><br><h5>  1) Install @Gedmo \ References doctrine-extension </h5><br>  This is necessary so that we can get a collection of related addresses for a given user from Mongo, and vice versa - an associated user to each address from mysql. <br><a name="habracut"></a><br>  We write in composer.json: <br> <code>"gedmo/doctrine-extensions": "dev-master"</code> <br> <br>  update dependencies. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      All doctrine-extensions will be installed, but we need only one - specifically References, intended for the connection between entities and documents. <br>  Read more about it here: <a href="">github.com/Atlantic18/DoctrineExtensions/blob/master/doc/references.md</a> <br><br>  Now we need to register in the config.yml 2 services that process both sides of the links. <br>  You can put these configs into a separate file, say, in doctrine_extensions.yml and then connect it to config.yml, if you use some other doctrine extensions. <br><br><pre> <code class="php hljs">services: gedmo.listener.reference: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Gedmo</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">References</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReferencesListener</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tags</span></span></span><span class="hljs-class">: - </span></span>{ name: doctrine_mongodb.odm.event_subscriber } calls: - [ setAnnotationReader, [ <span class="hljs-string"><span class="hljs-string">"@annotation_reader"</span></span> ] ] - [ registerManager, [ <span class="hljs-string"><span class="hljs-string">'entity'</span></span>, <span class="hljs-string"><span class="hljs-string">"@doctrine.orm.default_entity_manager"</span></span> ] ] utils.listener.reference: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Utils</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReferenceBundle</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Listener</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReferencesListener</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">arguments</span></span></span><span class="hljs-class">: ["@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service_container</span></span></span><span class="hljs-class">"] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tags</span></span></span><span class="hljs-class">: - </span></span>{ name: doctrine.event_subscriber, connection: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> }</code> </pre><br><br>  The first service configures the vendor listener.  ManyToOne side works with him.  (getUser () method in the Address document).  And for the oneToMany side, we need a second service with a custom listener. <br><br>  Below is the Utils \ ReferenceBundle \ Listener \ ReferencesListener class, which should be put into the bundle where your global helpers and utilities are located. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Utils</span></span>\<span class="hljs-title"><span class="hljs-title">ReferenceBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Listener</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>\<span class="hljs-title"><span class="hljs-title">ContainerInterface</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Class ReferencesListener * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@package</span></span></span><span class="hljs-comment"> Utils\ReferenceBundle\Listener */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReferencesListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Gedmo</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">References</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReferencesListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> \Symfony\Component\DependencyInjection\ContainerInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $container; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> array */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $managers = [ <span class="hljs-string"><span class="hljs-string">'document'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'doctrine.odm.mongodb.document_manager'</span></span>, <span class="hljs-string"><span class="hljs-string">'entity'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'doctrine.orm.default_entity_manager'</span></span> ]; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ContainerInterface $container * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> array $managers */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContainerInterface $container, array $managers = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;container = $container; <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::__construct($managers); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $type * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> object */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;container-&gt;get(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;managers[$type]); } }</code> </pre><br><br>  <b>Note:</b> there is a convenient bundle that does the work for you on prescribing services for the extension users of doctrines - this one: Stof \ DoctrineExtensionsBundle ( <a href="https://github.com/stof/StofDoctrineExtensionsBundle">github.com/stof/StofDoctrineExtensionsBundle</a> ), but there is no implementation for References Extras, so you have to write yourself and I don't use it here. <br><br>  Now you need to write the appropriate annotations for the fields of your entity and document.  In this case, it is necessary to provide a field in mongo with user_id for the foreign key, since this field in mongo will not be created by itself. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/*Entity\User:*/</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> ArrayCollection * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Gedmo</span></span></span><span class="hljs-comment">\ReferenceMany(type="document", class="\Application\Sonata\UserBundle\Document\Address", mappedBy="user") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $addresses;</code> </pre><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/*Document\Address:*/</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Gedmo</span></span></span><span class="hljs-comment">\ReferenceOne(type="entity", class="\Application\Sonata\UserBundle\Entity\User", inversedBy="addresses", identifier="user_id", mappedBy="user_id") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $user; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> int $user_id */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $user_id;</code> </pre><br>  Setters \ Getters for these classes, I still do not cite, they will be discussed further.  I have types of fields in yaml configs, and I haven‚Äôt figured out how to register gedmo references in the ground.  I would be grateful if you indicate this in the comments. <br><br>  After the above settings, everything should work for you almost as if the usual one-to-many connection between two entities or documents is in front of you, except that such code <b>will not work</b> : <br><pre> <code class="php hljs">$user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(); $address = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Address(); $address-&gt;setAddress(¬´aaa¬ª); $address-&gt;setUser($user); $user-&gt;getAddresses()-&gt;add($address); $em-&gt;persist($user); $em-&gt;flush();</code> </pre><br><br>  Instead, you need to clearly perzistit each address doctrin document manager.  I have not solved this problem yet. <br><br><h5>  2. We proceed to the rendering of the form for adding users with a collection of addresses attached to it. </h5><br><br>  Inside your useradmin class: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configureFormFields</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FormMapper $formMapper)</span></span></span><span class="hljs-function"> </span></span>{ $formMapper -&gt;with(<span class="hljs-string"><span class="hljs-string">'General'</span></span>) <span class="hljs-comment"><span class="hljs-comment">// ‚Ä¶  -&gt;add('addresses', 'collection', array('type' =&gt; new AddressType(), 'allow_add' =&gt; true, 'by_reference' =&gt; false, 'allow_delete' =&gt; true)) -&gt;end(); }</span></span></code> </pre><br><br>  Please note that here we use the usual symphony collection (more about it: <a href="http://symfony.com/doc/current/cookbook/form/form_collections.html">symfony.com/doc/current/cookbook/form/form_collections.html</a> ) instead of sonata_type_collection, which could not be attached to the Mongo at all. <br><br>  To use the collection type, a form object is required - AddressType in our case.  Let's make a form.  The usual symphony form. <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddressType</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractType</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> FormBuilderInterface $builder * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> array $options */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildForm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FormBuilderInterface $builder, array $options)</span></span></span><span class="hljs-function"> </span></span>{ $builder -&gt;add(<span class="hljs-string"><span class="hljs-string">'firstname'</span></span>) -&gt;add(<span class="hljs-string"><span class="hljs-string">'lastname'</span></span>) -&gt;add(<span class="hljs-string"><span class="hljs-string">'address'</span></span>) ; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> OptionsResolverInterface $resolver */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setDefaultOptions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OptionsResolverInterface $resolver)</span></span></span><span class="hljs-function"> </span></span>{ $resolver-&gt;setDefaults(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'data_class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Application\Sonata\UserBundle\Document\Address'</span></span> )); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'application_sonata_userbundle_address'</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   .... */</span></span></code> </pre><br><br>  Be sure to set the default data_class setting with the full name of the Address class with all the namespaces. <br><br>  As a result, the following element should appear on your form for adding / editing users in the sonata: (assuming that you already have a pair of addresses attached to the current user) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/595/3a9/9cc/5953a99ccf861f619b98b588cee19b21.png" alt="image"><br><br>  Button ‚Äú+‚Äù - add address block, ‚Äú-‚Äù - respectively, remove the block from the form. <br><br><h5>  3. We process the form. </h5><br><br>  Now we should deal with the entity setters, which we submit, so that adding / deleting elements from the address collection, depending on what comes out of the form, works correctly. <br>  Please note that when rendering a collection of addresses, the by_reference = false parameter must be specified, since it determines whether the setAddresses () setter is called or whether adding / deleting records will be done somewhere inside using strings of the type getAddress () -&gt; add (), getAddress () -&gt; remove ().  We do not need this, we need the setter to be called and we can override its behavior. <br><br>  Here is the setter itself: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setAddresses</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($addresses)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addresses <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $orig_address) { <span class="hljs-comment"><span class="hljs-comment">//     -    ‚Äî    if (false === $addresses-&gt;contains($orig_address)) { //     $this-&gt;addresses-&gt;removeElement($orig_address); } } //   ,    ,      . foreach($addresses as $passed_address) { if(!$this-&gt;addresses-&gt;contains($passed_address)) { $passed_address-&gt;setUser($this); $this-&gt;addresses-&gt;add($passed_address); } } }</span></span></code> </pre><br><br>  There should be another addAddress method to add one address to an existing collection with reference to the current user: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addAddress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($addresses)</span></span></span><span class="hljs-function"> </span></span>{ $addresses-&gt;setUser(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addresses[] = $addresses; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; }</code> </pre><br><br>  Now, if you enable debug mode, you will see that everything is fine inside the addresses collection, but addresses are not written to Mongo anyway.  This is because of the above-described bug with the fact that it does not pergist in the Mongo collection.  To write addresses to Mongo manually, and also to remove from there those addresses that are not needed, we will bind to the postUpdate () event of our UserAdmin class: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($user)</span></span></span><span class="hljs-function"> </span></span>{ $dm = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;container-&gt;get(<span class="hljs-string"><span class="hljs-string">"doctrine_mongodb"</span></span>)-&gt;getManager(); $dbAddresses = $dm-&gt;getRepository(<span class="hljs-string"><span class="hljs-string">'Application\Sonata\UserBundle\Document\Address'</span></span>)-&gt;findBy(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'user_id'</span></span>=&gt;$user-&gt;getId())); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($dbAddresses <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $dbAddress) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!$user-&gt;getAddresses()-&gt;contains($dbAddress)) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $dbAddress-&gt;getFirstName(); $dm-&gt;remove($dbAddress); } } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($user-&gt;getAddresses() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $address) { $address-&gt;setUser($user); $dm-&gt;persist($address); } $dm-&gt;flush(); }</code> </pre><br><br>  The last problem remains - in the context of the UserAdmin class there is nowhere to get the documentManager for doctrine_mongodb.  This is solved by injecting the service container into the UserAdmin class by calling the container setter from the Sonatov service during initialization. <br><br>  In the config of your Admin class services: <br><br><pre> <code class="php hljs">sonata.user.admin.user: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">: %</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sonata</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">admin</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">% </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tags</span></span></span><span class="hljs-class">: - </span></span>{ name: sonata.admin, manager_type: orm, group: %sonata.user.admin.groupname%, label: users, label_catalogue: SonataUserBundle, label_translator_strategy: sonata.admin.label.strategy.underscore } arguments: - ~ - %sonata.user.admin.user.entity% - %sonata.user.admin.user.controller% calls: - [ setUserManager, [@fos_user.user_manager]] - [ setTranslationDomain, [%sonata.user.admin.user.translation_domain%]] - [ setContainer, [@service_container]]&lt;/code&gt;    &lt;code&gt;- [ setContainer, [@service_container]]</code> </pre><br><br>  Then, inside the class admin, declare a new container field and make a setter for it, which will be called by the service during class initialization. <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> \Symfony\Component\DependencyInjection\ContainerInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $container; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setContainer</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\Symfony\Component\DependencyInjection\ContainerInterface $container)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;container = $container; }</code> </pre><br><br>  This seems to be all.  Addresses must be added, edited and deleted as if they were two ordinary entities in mysql or two regular documents in Mongo. </div><p>Source: <a href="https://habr.com/ru/post/228371/">https://habr.com/ru/post/228371/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../228361/index.html">404 post</a></li>
<li><a href="../228363/index.html">My favorite feature of generators</a></li>
<li><a href="../228365/index.html">Android Studio for NDK for Windows</a></li>
<li><a href="../228367/index.html">Tic-tac-toe: compiler against man - extreme metaprogramming</a></li>
<li><a href="../228369/index.html">Simulation of the world and dynamic systems</a></li>
<li><a href="../228373/index.html">The eight queen problem on Oracle SQL (another solution)</a></li>
<li><a href="../228375/index.html">Effective or effective? Master class on creating a site design</a></li>
<li><a href="../228377/index.html">Feature # 3 - Podcast on entrepreneurs and current trends in the IT ecosystem</a></li>
<li><a href="../228379/index.html">The practice of programming games in python: life</a></li>
<li><a href="../228383/index.html">Serious design of a serious store. Part 3. Card product and not only</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>