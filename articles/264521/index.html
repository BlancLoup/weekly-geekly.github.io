<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Treacherous router or why ports need to open</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article is a little story about how the desire to simplify the application for the end user, came out very time-consuming process. 

 Speech about...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Treacherous router or why ports need to open</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/a91/0e9/98a/a910e998aa8e4bd48190d1461d9b8280.jpg" height="240" width="300" align="left"><br>  The article is a little story about how the desire to simplify the application for the end user, came out very time-consuming process. <br><br>  Speech about the "automatic" port forwarding through <a href="https://ru.wikipedia.org/wiki/UPnP">UPnP</a> technology, without using the "standard" library <strong>NATUPnPLib</strong> . <br><br>  About that, by virtue of what such a difficult way was chosen and why it is still not an easy one - read below. <br><a name="habracut"></a><br><h3>  Prologue </h3><br>  While working on my project (game project), I clearly realized that sooner or later I would have to come to the server and the link to this question.  It is worth noting that he was in the plans.  But I remembered my experience with a dedicated server, for the same minecraft, I was ready for a certain ‚Äúpain‚Äù, especially if I tried to promote my product to the masses. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Briefly about the dedicated server Minecraft'a</b> <div class="spoiler_text">  Many people who tried to start their dedicated server had one common problem, having a router, they could connect to themselves, but any person from outside did not.  It is clear that such issues were solved by forwarding the port in the settings of the router, but as practice has shown (as well as a bunch of videos on YouTube), it was difficult for people. <br></div></div><br>  From all these things, the underlying requirements for my server came out. <br><ol><li>  The user must do a minimum of movements to start the server and start the game. </li><li>  The solution should work out of the box on any machine under Windows (support for Unix systems is not yet in the plans). </li></ol><br>  In essence, this meant the following goals: <br><ol><li>  Port forwarding should occur without human intervention. </li><li>  The solution will be written in C # in two x64 and x32 architectures (priority on x64, due to the fact that it will probably require ‚Äúa lot‚Äù of memory). </li></ol><br><h3>  Illusion of solution </h3><br>  Having decided on the language, the first thing I did was go to Google to find out if there are already ready-made solutions.  And indeed, a ‚Äúsolution‚Äù was immediately found, it was proposed to use the NATUPnPLib library, and immediately an example of its use: <br><pre><code class="hljs pgsql">NATUPNPLib.UPnPNATClass upnpnat = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> NATUPNPLib.UPnPNATClass(); NATUPNPLib.IStaticPortMappingCollection mappings = upnpnat.StaticPortMappingCollection; //  mappings.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-number"><span class="hljs-number">12345</span></span>, "UDP", <span class="hljs-number"><span class="hljs-number">12345</span></span>, "localIp", <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, "Some name"); //  mappings.Remove(<span class="hljs-number"><span class="hljs-number">12345</span></span>, "UDP");</code> </pre> <br>  Having rejoiced to this, I hurried to test the received "little animal".  In the end, on one machine I managed to get the desired result.  However, when I was completely rejoiced, I decided to ‚Äútest a bit‚Äù (in general, as practice shows, this is a useful action), and I ran the compiled code on the next machine (in one local computer, with one router ‚Äúat the head‚Äù) and then the first disappointment. <br><br>  Alas, upnpnat.StaticPortMappingCollection - returned null, whatever I did.  At the same time, a ‚Äúreport‚Äù came from another person, whom I also asked to test, his answer was just as sad, this library was not allowed for him at all (probably it was not registered in the system, for some reason or forbidden, or as, but the point is that she did not pick up). <br><br>  ‚ÄúLack of results, also results‚Äù - as one cunning wisdom says.  The sad result, gave me an understanding that if I leave this library, the end user will have similar errors, which means I will have to prepare to accept the flow of "good".  What I, for some reason did not want. <br><br><h3>  Finding the way </h3><br>  In the frustrated feelings went google replacement NATUPnPLib.  But as it turned out, almost all ready-made solutions were essentially wrappers over this library.  For the sake of experiment, they were tried, but since it is based on NATUPnPLib, everything ended as before. <br><br>  This greatly grieved.  However, looking at such products as uTorrent, for example, and seeing that it is successfully forwarding the port, I decided to take the tricky <s>scientific</s> path.  The idea is simple as a cat.  I know that a certain command or part is transmitted from the machine to the router, which should somehow say what the router has to do.  It remained the case for small, ‚Äúface‚Äù this team or a set of teams. <br><br>  The first link in Google to the request for a network sniffer was Wireshark.  Then he started to google, that he knows how this <a href="http://habrahabr.ru/company/pentestit/blog/204274/">article</a> <a href="http://habrahabr.ru/users/sinist3r/" class="user_link">came</a> across from comrade <a href="http://habrahabr.ru/users/sinist3r/" class="user_link">sinist3r</a> for which he thanks a lot.  The article describes to a sufficient degree how and what to do, therefore I will not dwell on this in detail. <br><br><h3>  Network traffic analysis </h3><br>  Having started Wireshark and having made port forwarding with NATUPnPLib library (from that machine on which everything worked), we receive something like this: <br><div class="spoiler">  <b class="spoiler_title">Overall result</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/e6b/d8c/454/e6bd8c454da14dcc8814889cbe025bca.png"><br></div></div><br>  So, what we have: <br><ul><li>  A bunch of network information </li><li>  We know the ip address of the machine from which we send </li><li>  We know the ip address of other machines </li></ul><br>  We will configure the filter so that there is only a request from the machine with which we carry out the test (column Source ip 150th), and also that there were no other machines in the destination column (ip 200). <br><br>  We look at the resulting list and see some interesting thing, namely, the <b>multicast group</b> and the <b>SSDP</b> protocol, and the following message is sent to it: <br><div class="spoiler">  <b class="spoiler_title">Multicast group</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/952/26d/7db/95226d7db8484d9a9c20b26a4c801159.png"><br></div></div><br>  This is already interesting.  We go to Google and see what kind of a multicast group it is, and ... a <i>dramatic pause ... with the</i> first request we kill two small fluffy and eared creatures, Google gives this <a href="https://ru.wikipedia.org/wiki/Simple_Service_Discovery_Protocol">link</a> . <br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  Why I decided that the address for which the request is being sent is multicast, I remind you that addresses starting with 224.0.0.0 and ending with 239.255.255.255 are class D, which was reserved for multicast groups.  More details can be found <a href="https://en.wikipedia.org/wiki/Classful_network">here</a> . <br></div></div><br>  I joyfully rub my paws, like a fly, from a literally small Wikipedia article, I find out that the UDP protocol is being used, a detection message is sent, which was shown in the screenshot above.  And everything says that I am on the right path. <br><br><h3>  From theory to practice </h3><br>  Having a request at hand, the protocol for which we are addressing and the address, I decided to try to make a small console program to test, how it will, and whether it will work at all. <br><br>  So, such a request should be sent to a multicast group, on port 1900. The router, having heard the request, will respond, the <u>machine with which the request came</u> , with a certain answer. <br><blockquote>  M-SEARCH * HTTP / 1.1 \ r \ n <br>  HOST: 239.255.255.250: 1900 \ r \ n <br>  MAN: \ "ssdp: discover \" \ r \ n <br>  ST: upnp: rootdevice \ r \ n <br>  MX: 3 \ r \ n \ r \ n </blockquote><br>  You can find out more about what is <a href="http://developer.lgappstv.com/TV_HELP/index.jsp%3Ftopic%3D%252Flge.tvsdk.references.book%252Fhtml%252FUDAP%252FUDAP%252FM%2BSEARCH%2BRequest.htm">here</a> . <br><br>  We write about this code: <br><div class="spoiler">  <b class="spoiler_title">Sample code</b> <div class="spoiler_text"><pre> <code class="hljs haskell"><span class="hljs-type"><span class="hljs-type">IPEndPoint</span></span> <span class="hljs-type"><span class="hljs-type">MulticastEndPoint</span></span> = new <span class="hljs-type"><span class="hljs-type">IPEndPoint</span></span>(<span class="hljs-type"><span class="hljs-type">IPAddress</span></span>.<span class="hljs-type"><span class="hljs-type">Parse</span></span>(<span class="hljs-string"><span class="hljs-string">"239.255.255.250"</span></span>), <span class="hljs-number"><span class="hljs-number">1900</span></span>);//     <span class="hljs-number"><span class="hljs-number">1900</span></span> <span class="hljs-type"><span class="hljs-type">IPEndPoint</span></span> <span class="hljs-type"><span class="hljs-type">LocalEndPoint</span></span> = new <span class="hljs-type"><span class="hljs-type">IPEndPoint</span></span>(<span class="hljs-type"><span class="hljs-type">GetLocalAdress</span></span>(), <span class="hljs-number"><span class="hljs-number">0</span></span>);//      <span class="hljs-type"><span class="hljs-type">IP</span></span>-a     //      ,       <span class="hljs-type"><span class="hljs-type">Socket</span></span> socket = new <span class="hljs-type"><span class="hljs-type">Socket</span></span>(<span class="hljs-type"><span class="hljs-type">AddressFamily</span></span>.<span class="hljs-type"><span class="hljs-type">InterNetwork</span></span>, <span class="hljs-type"><span class="hljs-type">SocketType</span></span>.<span class="hljs-type"><span class="hljs-type">Dgram</span></span>, <span class="hljs-type"><span class="hljs-type">ProtocolType</span></span>.<span class="hljs-type"><span class="hljs-type">Udp</span></span>); //    socket.<span class="hljs-type"><span class="hljs-type">SetSocketOption</span></span>(<span class="hljs-type"><span class="hljs-type">SocketOptionLevel</span></span>.<span class="hljs-type"><span class="hljs-type">Socket</span></span>, <span class="hljs-type"><span class="hljs-type">SocketOptionName</span></span>.<span class="hljs-type"><span class="hljs-type">ReuseAddress</span></span>, true); socket.<span class="hljs-type"><span class="hljs-type">Bind</span></span>(<span class="hljs-type"><span class="hljs-type">LocalEndPoint</span></span>);//        socket.<span class="hljs-type"><span class="hljs-type">SetSocketOption</span></span>(<span class="hljs-type"><span class="hljs-type">SocketOptionLevel</span></span>.<span class="hljs-type"><span class="hljs-type">IP</span></span>, <span class="hljs-type"><span class="hljs-type">SocketOptionName</span></span>.<span class="hljs-type"><span class="hljs-type">AddMembership</span></span>, new <span class="hljs-type"><span class="hljs-type">MulticastOption</span></span>(<span class="hljs-type"><span class="hljs-type">MulticastEndPoint</span></span>.<span class="hljs-type"><span class="hljs-type">Address</span></span>, <span class="hljs-type"><span class="hljs-type">IPAddress</span></span>.<span class="hljs-type"><span class="hljs-type">Any</span></span>)); socket.<span class="hljs-type"><span class="hljs-type">SetSocketOption</span></span>(<span class="hljs-type"><span class="hljs-type">SocketOptionLevel</span></span>.<span class="hljs-type"><span class="hljs-type">IP</span></span>, <span class="hljs-type"><span class="hljs-type">SocketOptionName</span></span>.<span class="hljs-type"><span class="hljs-type">MulticastTimeToLive</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); socket.<span class="hljs-type"><span class="hljs-type">SetSocketOption</span></span>(<span class="hljs-type"><span class="hljs-type">SocketOptionLevel</span></span>.<span class="hljs-type"><span class="hljs-type">IP</span></span>, <span class="hljs-type"><span class="hljs-type">SocketOptionName</span></span>.<span class="hljs-type"><span class="hljs-type">MulticastLoopback</span></span>, true); string searchString = <span class="hljs-string"><span class="hljs-string">"M-SEARCH * HTTP/1.1\r\nHOST:239.255.255.250:1900\r\nMAN:\"ssdp:discover\"\r\nST:upnp:rootdevice\r\nMX:3\r\n\r\n"</span></span>; byte[] <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Encoding</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UTF8</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetBytes</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">searchString</span></span></span><span class="hljs-class">); socket.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SendTo</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SocketFlags</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">None</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MulticastEndPoint</span></span></span><span class="hljs-class">); socket.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SendTo</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SocketFlags</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">None</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MulticastEndPoint</span></span></span><span class="hljs-class">); socket.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SendTo</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SocketFlags</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">None</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MulticastEndPoint</span></span></span><span class="hljs-class">); //     ,     ! byte[] </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReceiveBuffer</span></span></span><span class="hljs-class"> = new byte[64000]; int </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReceivedBytes</span></span></span><span class="hljs-class"> = 0; int repeatCount = 10; while (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repeatCount</span></span></span><span class="hljs-class">&gt;0) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">socket</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Available</span></span></span><span class="hljs-class"> &gt; 0) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReceivedBytes</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">socket</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Receive</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReceiveBuffer</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SocketFlags</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">None</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReceivedBytes</span></span></span><span class="hljs-class"> &gt; 0) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Console</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WriteLine</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Encoding</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UTF8</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetString</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReceiveBuffer</span></span></span><span class="hljs-class">, 0, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReceivedBytes</span></span></span><span class="hljs-class">)); } } else { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repeatCount</span></span></span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">--; Thread.Sleep(100);//  ,   ,      ,     } } socket.Close();</span></span></span></span></code> </pre><br></div></div><br>  Here's what happens in the end <br><div class="spoiler">  <b class="spoiler_title">Query result</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/366/b69/38c/366b6938cec2468cafeb3e37249af1a6.png"><br></div></div><br>  We are interested in the underlined line, it is for her in the future and will be communicating with the router.  (How did I understand this? In the same Wireshark, I pointed out the source of the ip-machine from which the request was sent, and as the destination, an ip-router, and saw a bunch of http requests) <br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  First of all, I would like to draw your attention to the fact that the message is carried out three times, due to the fact that on some machines (I have one of the three), the first packet is ‚Äúlost‚Äù and in fact is not sent at all (when observed in Wireshark ' e there is not even a hint that the packet is sent).  Read about such things on the Internet, but okromya solutions "go to TCP" or "make several requests" did not find. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  Why use this design: <br><pre> <code class="hljs lisp">IPEndPoint LocalEndPoint = new IPEndPoint(<span class="hljs-name"><span class="hljs-name">GetLocalAdress</span></span>(), <span class="hljs-number"><span class="hljs-number">0</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>  Not IPAddress.Any, as a result of this <a href="http://stackoverflow.com/a/22822291">answer</a> <br></div></div><br>  Now not much about the function GetLocalAdress.  Usually, it is suggested to use such or similar code. <br><pre> <code class="hljs javascript">Dns.GetHostEntry(Dns.GetHostName()).AddressList.FirstOrDefault(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ip</span></span></span><span class="hljs-function"> =&gt;</span></span> ip.AddressFamily == AddressFamily.InterNetwork);</code> </pre> <br>  However, if you have VirtualBox on your machine or, say, Tunngle, or something like that, which puts your adapter, then in this case, the above code will return the address of that adapter itself.  That ‚Äúit is not good‚Äù, and therefore it is necessary either to try to cut off the ‚Äúleft‚Äù addresses by names, or as I suggest: <br><div class="spoiler">  <b class="spoiler_title">Code example</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">private static IPAddress GetLocalAdress() { NetworkInterface[] networkInterfaces = NetworkInterface.GetAllNetworkInterfaces(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (NetworkInterface network <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> networkInterfaces) { IPInterfaceProperties properties = network.GetIPProperties(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (properties.GatewayAddresses.Count == <span class="hljs-number"><span class="hljs-number">0</span></span>)//      <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (IPAddressInformation address <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> properties.UnicastAddresses) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (address.Address.AddressFamily != AddressFamily.InterNetwork) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IPAddress.IsLoopback(address.Address)) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> address.Address; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>(IPAddress); }</code> </pre><br></div></div><br><h3>  The end is near </h3><br>  So, almost everything we have.  You can go to the final stage, namely, to try in practice to forward the port and close it. <br><br>  I‚Äôll omit moments like I‚Äôm at Wireshark, I‚Äôve watched which commands go and where, I wrote in sufficient detail earlier, the further search is quite simple, considering that all communication with the router is already going through HTTP. <br><br>  Having received at the previous stage, the path to request information about the router, let's do it.  Immediately make a reservation when HTTP requests, <b>be sure</b> to specify UserAgent = "Microsoft-Windows / 6.1 UpnP / 1.0";  (naturally given the real version of Windows). <br><br>  In my case, the GET request must be sent to this address: <pre>  http://192.168.0.1:46382/rootDesc.xml </pre><br><br>  In the received, huge answer, (yes, here in this huge sheet of text), we are interested in the controlURL tag, in which the serviceType is equal to the urn: schemas-upnp-org: service: WANIPConnection: 1. <br><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text"><blockquote>  WANPPPConnection (ADSL modems) and WANIPConnection (IP routers) </blockquote><br>  Read more, you can read <a href="http://www.upnp-hacks.org/igd.html">here</a> , including the commands to add or remove ports <br></div></div><br>  In my case, the value "/ ctl / IPConn" is received.  We add it to the address of the router, as a result we get this: <br><pre>  http://192.168.0.1:46382/ctl/IPConn </pre><br><br>  Now we will collect the request body, it should contain: <br><ul><li>  NewRemoteHost // leave empty </li><li>  NewExternalPort // external port </li><li>  NewProtocol // protocol (TCP / UDP) </li><li>  NewInternalPort // internal port </li><li>  NewInternalClient // ip "on which" we open </li><li>  NewEnabled // on or off </li><li>  NewPortMappingDescription // description </li><li>  NewLeaseDuration // lifespan, 0 - forever </li></ul><br>  Having collected, I received such a body (Formatted to improve reading): <br><div class="spoiler">  <b class="spoiler_title">Request body</b> <div class="spoiler_text"><pre> &lt;? xml version = \ "1.0 \"?&gt;
 &lt;SOAP-ENV: Envelope xmlns: SOAP-ENV = \ "http: //schemas.xmlsoap.org/soap/envelope/ \" SOAP-ENV: encodingStyle = \ "http://schemas.xmlsoap.org/soap/ encoding / \ "&gt;
	 &lt;SOAP-ENV: Body&gt; &lt;m: AddPortMapping xmlns: m = \ "urn: schemas-upnp-org: service: WANIPConnection: 1 \"&gt;
		 &lt;NewRemoteHost xmlns: dt = \ "urn: schemas-microsoft-com: datatypes \" dt: dt = \ "string \"&gt; &lt;/ NewRemoteHost&gt;
		 &lt;NewExternalPort xmlns: dt = \ "urn: schemas-microsoft-com: datatypes \" dt: dt = \ "ui2 \"&gt; 25565 &lt;/ NewExternalPort&gt;
		 &lt;NewProtocol xmlns: dt = \ "urn: schemas-microsoft-com: datatypes \" dt: dt = \ "string \"&gt; TCP &lt;/ NewProtocol&gt;
		 &lt;NewInternalPort xmlns: dt = \ "urn: schemas-microsoft-com: datatypes \" dt: dt = \ "ui2 \"&gt; 25565 &lt;/ NewInternalPort&gt;
		 &lt;NewInternalClient xmlns: dt = \ "urn: schemas-microsoft-com: datatypes \" dt: dt = \ "string \"&gt; 192.168.0.150 &lt;/ NewInternalClient&gt;
		 &lt;NewEnabled xmlns: dt = \ "urn: schemas-microsoft-com: datatypes \" dt: dt = \ "boolean \"&gt; 1 &lt;/ NewEnabled&gt;
		 &lt;NewPortMappingDescription xmlns: dt = \ "urn: schemas-microsoft-com: datatypes \" dt: dt = \ "string \"&gt; Test your port &lt;/ NewPortMappingDescription&gt;
		 &lt;NewLeaseDuration xmlns: dt = \ "urn: schemas-microsoft-com: datatypes \" dt: dt = \ "ui4 \"&gt; 0 &lt;/ NewLeaseDuration&gt;
	 &lt;/ m: AddPortMapping&gt;
 &lt;/ SOAP-ENV: Body&gt; &lt;/ SOAP-ENV: Envelope&gt;
</pre><br></div></div><br>  After completing the query, and if everything is correctly stated, we will get a similar result. <br><div class="spoiler">  <b class="spoiler_title">Result</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/96f/3b3/860/96f3b386071547908ff5e434b2e0d20e.png"><br><br></div></div><br>  Similarly, it is easier to remove the port, there are only two important parameters - the protocol and the port, I stress, the external port. <br><br><h3>  Conclusion </h3><br>  In this way, the simple desire to make the user ‚Äúsimpler‚Äù resulted in a whole epic and article.  I hope the article will help someone to avoid the certain difficulties that I encountered. <br><br>  Thank you all, who read, if there are any additions, write, supplement the article. </div><p>Source: <a href="https://habr.com/ru/post/264521/">https://habr.com/ru/post/264521/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264511/index.html">Optimize the Android game mTricks Looting Crown for the Intel Atom platform</a></li>
<li><a href="../264513/index.html">Writing a program to steal data from a USB-drive in Windows</a></li>
<li><a href="../264515/index.html">Updating Linux on a device based on the Altera SoC FPGA chip and gaining access to shared Windows server resources</a></li>
<li><a href="../264517/index.html">The notorious programmer: life hacking firsthand</a></li>
<li><a href="../264519/index.html">Tutorial: Interactive SVG Cartogram Component for InstantCMS 2</a></li>
<li><a href="../264523/index.html">How Easter eggs in email helped the company draw attention to its conference</a></li>
<li><a href="../264525/index.html">Free IBM Bluemix Developer Resources</a></li>
<li><a href="../264527/index.html">EXTREME'AL LACP</a></li>
<li><a href="../264531/index.html">ASR and TTS technologies for an application programmer: theoretical minimum</a></li>
<li><a href="../264535/index.html">Android Devs Meetup 2: videos and presentations from the last meeting</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>