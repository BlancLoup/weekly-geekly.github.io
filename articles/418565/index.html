<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>On the way to 100% of code coverage by tests in Go using the example of sql-dumper</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this post I will talk about how I wrote the console program in the Go language for uploading data from the database to files, trying to cover all c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>On the way to 100% of code coverage by tests in Go using the example of sql-dumper</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/getpro/habr/post_images/cc4/3fe/2c1/cc43fe2c1f16d831ccbf66843bded446.png" alt="image"></p><br><p>  In this post I will talk about how I wrote the console program in the Go language for uploading data from the database to files, trying to cover all code with 100% tests.  I'll start with a description of why I needed this program.  I will continue the description of the first difficulties, some of which are caused by the peculiarities of the Go language.  Then I‚Äôll mention the build on Travis CI a bit, and then I‚Äôll tell you how I wrote the tests, trying to cover the code 100%.  I will touch upon the testing of work with the database and file system.  And in conclusion, I‚Äôll tell you what the desire to cover the code with tests as much as possible and what this indicator shows.  I will accompany the material with references both to the documentation and to the examples of commits from my project. </p><a name="habracut"></a><br><h1 id="naznachenie-programmy">  Purpose of the program </h1><br><p>  The program should be launched from the command line with a list of tables and some of their columns, a range of data on the first specified column, listing the connections of the selected tables to each other, with the ability to specify a file with database connection settings.  The result of the work should be a file that describes the requests to create the specified tables with the specified columns and the insert expressions of the selected data.  It was assumed that the use of such a program would simplify the scenario of extracting a portion of data from a large database and deploying this portion locally.  In addition, these sql files of unloading were supposed to be processed by another program, which replaces part of the data according to a specific pattern. </p><br><p>  The same result can be achieved using any of the popular clients to the database and a sufficiently large amount of manual work.  The application had to simplify this process and automate as much as possible. </p><br><p>  This program should have been developed by my interns for the purpose of training and subsequent use in their further education.  But the situation was such that they abandoned this idea.  But I decided to try to write such a program in my spare time in order to practice my development in the Go language. </p><br><p>  The solution is incomplete, has several limitations, which are described in the README.  In any case, this is not a combat project. </p><br><p>  <a href="https://github.com/rnixik/sql-dumper">Examples of use and source code</a> . </p><br><h1 id="pervye-trudnosti">  First difficulties </h1><br><p> The list of tables and their columns is passed to the program by an argument in the form of a string, that is, it is unknown in advance.  Most of the examples on working with the database on Go implied that the database structure is known in advance, we simply create a <code>struct</code> indicating the types of each column.  But in this case it will not work. </p><br><p>  The solution for this was the use of the <code>MapScan</code> method from <code>github.com/jmoiron/sqlx</code> , which created a slice of interfaces in a size equal to the number of sample columns.  The next question was how to get a real data type from these interfaces.  The solution is a <a href="https://tour.golang.org/methods/16">switch-case by type</a> .  Such a solution does not look very beautiful, because you will need to bring all types to a string: whole - as is, strings - to escape and wrap in quotes, but to describe all types that can come from the database.  I did not find a more elegant way to solve this issue. </p><br><p>  With types, another feature of the Go language was manifested - a variable of the string type cannot take the value <code>nil</code> , but both an empty string and <code>NULL</code> can come from the database.  To solve this problem in the <code>database/sql</code> package there is a <a href="https://golang.org/pkg/database/sql/">solution</a> - to use special <code>strut</code> that store the value and the sign, <code>NULL</code> or not. </p><br><h1 id="sborka-i-vychislenie-procenta-pokrytiya-koda-testami">  Build and calculate the percentage of code coverage tests </h1><br><p>  I use Travis CI for the build, Coveralls for getting the percentage of code coverage of the tests.  The <code>.travis.yml</code> file for assembly is quite simple: </p><br><pre> <code class="hljs go">language: <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">go</span></span>: - <span class="hljs-number"><span class="hljs-number">1.9</span></span> script: - <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> get -t -v ./... - <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> get golang.org/x/tools/cmd/cover - <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> get github.com/mattn/goveralls - <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> test -v -covermode=count -coverprofile=coverage.out ./... - $HOME/gopath/bin/goveralls -coverprofile=coverage.out -service=travis-ci -repotoken $COVERALLS_TOKEN</code> </pre> <br><p>  In the Travis CI settings, you only need to specify the environment variable <code>COVERALLS_TOKEN</code> , the value of which you need to take on the <a href="https://coveralls.io/">site</a> . </p><br><p>  Coveralls allows you to conveniently find out what percentage of the entire project, each file, highlight a line of source code, which turned out to be an uncovered test.  For example, in the <a href="https://coveralls.io/builds/17987192/source%3Ffilename%3Drequest.go">first build</a> it is clear that I did not write tests for some cases of errors when parsing a user request. </p><br><p>  Covering code with tests for 100% means that tests are written that, among other things, execute code for each branch in <code>if</code> .  This is the most voluminous work when writing tests, and, in general, when developing an application. </p><br><p>  It is possible to calculate the coverage by tests locally, for example, the same <code>go test -v -covermode=count -coverprofile=coverage.out ./...</code> , but it is also more solid to do this in CI, you can place a plate on Github. </p><br><p>  If we are talking about dies, then I find a dashboard from <a href="https://goreportcard.com/">https://goreportcard.com</a> useful, which analyzes the following indicators: </p><br><ul><li>  gofmt - code formatting, including <a href="https://github.com/rnixik/sql-dumper/commit/d25ce5018ee888d66acc479a3e550e8d05470269">simplified constructions</a> </li><li>  go_vet - checks for suspicious constructions </li><li>  gocyclo - shows problems in cyclomatic complexity </li><li>  golint - for me this is a check for all the necessary comments </li><li>  license - the project must have a license </li><li>  ineffassign - checks for inefficient assignments </li><li>  misspell - checks for typos </li></ul><br><h1 id="trudnosti-pokrytiya-koda-testami-na-100">  Difficulties of covering the code with tests for 100% </h1><br><p>  If parsing a small custom query into parts basically works with converting strings to some structures from strings and is fairly easily covered with tests, then for testing code that works with a database, the solution is not so obvious. </p><br><p>  As an option, connect to a real database server, prefill data in each test, perform selections, clear.  But this is a difficult decision, far from unit-testing and imposes its requirements on the environment, including the CI-server. </p><br><p>  Another option could be to use the database in memory, for example, sqlite ( <code>sqlx.Open("sqlite3", ":memory:")</code> ), but this implies that the code should be tied as little as possible to the database engine, and this greatly complicates the project , but for the integration test is quite good. </p><br><p>  For unit testing, use mock for the database.  I found <a href="https://github.com/DATA-DOG/go-sqlmock">this one</a> .  Using this package, you can test the behavior both in the case of a normal result and in the event of errors by specifying which query should return the error. </p><br><p>  Writing tests showed that the function that connects to the real database needs to be moved to main.go, so it can be redefined in tests for the one that will return the mock instance. </p><br><p>  In addition to working with the database, you need to separate work with the file system.  This will allow replacing the recording of real files with writing into memory for convenience of testing and will reduce the coupling.  This is how the <code>FileWriter</code> interface appeared, and with it the interface of the file returned by it.  To test scripts for errors, auxiliary implementations of these interfaces were created and placed in the <code>filewriter_test.go</code> file, so they do not fall into the general build, but can be used in tests. </p><br><p>  After a while I had a question, how to cover with tests <code>main()</code> .  At that time I had enough code there.  As shown by the search results, so <a href="https://stackoverflow.com/a/31352478">do not go</a> in <a href="https://stackoverflow.com/a/31352478">Go</a> .  Instead, all the code that can be removed from <code>main()</code> needs to be rendered.  In my code, I left only the analysis of options and arguments of the command line ( <code>flag</code> package), connection to the database, instantiation of the object that will be responsible for writing files, and calling the method that will do the rest of the work.  But these lines do not allow to get exactly 100% coverage. </p><br><p>  In Go testing there is such a thing as " <a href="https://golang.org/pkg/testing/">Example Functions</a> ".  These are test functions that compare the output with what is described in the commentary inside such a function.  Examples of such tests can be found in the <a href="https://golang.org/src/sort/">go package source code</a> .  If such files do not contain tests and benchmarks, then they are named with the prefix <code>example_</code> and end in <code>_test.go</code> .  The name of each such test function must begin with <code>Example</code> .  At this point I wrote a test for an object that writes sql to a file, replacing the actual record in the file with a mox, from which you can get the content and output it.  This conclusion is compared with the standard.  Convenient, you do not need to write a comparison with your hands, and it‚Äôs convenient to write a few lines in the comments.  But when it came to the test for an object that writes data to a csv file, difficulties arose.  According to <a href="https://tools.ietf.org/html/rfc4180">RFC4180, the</a> lines in CSV should be separated by CRLF, and <code>go fmt</code> replaces all lines with LF, which leads to the fact that the standard from the comment does not coincide with the actual output due to different line separators.  I had to write an ordinary test for this object, while also renaming the file, removing <code>example_</code> from it. </p><br><p>  The question remains, if the file, for example, <code>query.go</code> tested according to Example and according to normal tests, should there be two files, <code>example_query_test.go</code> and <code>query_test.go</code> ?  Here, for example, there is only one <code>example_test.go</code> .  Use the search for "go test example" something else fun. </p><br><p>  I learned to write tests in Go according to the guides Google provides for "go writing tests".  Most of those I came across ( <a href="https://www.golang-book.com/books/intro/12">1</a> , <a href="https://blog.alexellis.io/golang-writing-unit-tests/">2</a> , <a href="https://medium.com/%40matryer/5-simple-tips-and-tricks-for-writing-unit-tests-in-golang-619653f90742">3</a> , <a href="">4</a> ) suggest comparing the result obtained with the expected construction of the form </p><br><pre> <code class="hljs vbscript"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v != <span class="hljs-number"><span class="hljs-number">1.5</span></span> { t.<span class="hljs-keyword"><span class="hljs-keyword">Error</span></span>(<span class="hljs-string"><span class="hljs-string">"Expected 1.5, got "</span></span>, v) }</code> </pre> <br><p>  But when it comes to type comparison, a familiar construct is evolutionarily reborn into a jumble of using the "reflect" or type text dissertation.  Or another example when you need to check that slice or map has the necessary value.  The code becomes cumbersome.  I just want to write my <a href="">auxiliary functions</a> for the test.  Although a good solution here is to use the library for testing.  I found <a href="https://github.com/stretchr/testify">https://github.com/stretchr/testify</a> .  It allows you to make <a href="">comparisons in one line</a> .  This solution reduces the amount of code and simplifies reading and support of tests. </p><br><h1 id="droblenie-koda-i-testirovanie">  Code shredding and testing </h1><br><p>  Writing a test for a high-level function that works with several objects allows one time to significantly raise the code coverage value with tests, because during this test many lines of code of individual objects are performed.  If you set yourself a goal of only 100% coverage, then the motivation to write unit tests for small system components is lost, because it does not affect the code coverage value. </p><br><p>  In addition, if the test function does not check the result, then this will also not affect the value of code coverage.  You can get a high value of coverage, but it does not detect serious errors in the application. </p><br><p>  On the other hand, if you have a <a href="">code with many branches</a> , after which a volume function is called, then it will be difficult to cover it with tests.  And here you have an incentive to improve this code, for example, <a href="">to take</a> all the branches into a separate function and write a <a href="">separate test</a> for it.  This will positively affect the readability of the code. </p><br><p>  If the code has a strong coupling, then most likely you will not be able to write a test to it, which means you will have to make changes to it, which will positively affect the quality of the code. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  Prior to this project, I did not have to set a goal for myself in 100% code coverage of tests.  I could get a workable application in 10 hours of development, but it took me 20 to 30 hours to reach 95% coverage.  Using a small example, I got an idea of ‚Äã‚Äãhow the value of code coverage affects its quality, how much effort goes to support it. </p><br><p>  My conclusion is that if you see someone with a die with a high code coverage value, then it says almost nothing about how well this application has been tested.  You still need to watch the tests themselves.  But if you yourself headed for an honest 100%, then this will help you to write an application with better quality. </p><br><p>  You can read more about this in the following materials and comments to them: </p><br><ul><li>  <a href="https://labs.ig.com/code-coverage-100-percent-tragedy">The tragedy of 100% code coverage</a> , it's on <a href="https://habr.com/company/everydaytools/blog/328406/">Habr√©</a> </li><li>  <a href="https://jeroenmols.com/blog/2017/11/28/coveragproblem/">How can you have a 100% coverage, but do not check anything</a> </li></ul><br><div class="spoiler">  <b class="spoiler_title">Spoiler</b> <div class="spoiler_text"><p>  The word "coating" is used about 20 times.  Sorry. </p></div></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/418565/">https://habr.com/ru/post/418565/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../418553/index.html">Kotlin + React vs Javasript + React</a></li>
<li><a href="../418557/index.html">Calculation of wave processes in the hydraulic line by the method of characteristics</a></li>
<li><a href="../418559/index.html">NL2API: Creating Natural Language Interfaces for the Web API</a></li>
<li><a href="../418561/index.html">State machines in the service of MVP. Yandex lecture</a></li>
<li><a href="../418563/index.html">The digest of interesting materials for the mobile developer # 263 (July 23 - July 29)</a></li>
<li><a href="../418567/index.html">Dell will cease to be a private company and for the first time in 5 years will place shares on the exchange.</a></li>
<li><a href="../418569/index.html">New satellites - new bugs: The GOES-17 satellite's infrared sensor does not cool well</a></li>
<li><a href="../418573/index.html">Wateri: Transferring readings of water to the phone via Wi-Fi (4 years from batteries)</a></li>
<li><a href="../418575/index.html">"Do not take off": 6 unusual audio gadgets</a></li>
<li><a href="../418577/index.html">Manage your bookmarks with tags - to the delight of yourself and colleagues</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>