<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We generate a table of contents for the text</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! In this publication I want to tell and tell you how to generate a table of contents for PHP. Why hub "Laravel"? This solution resulted in a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We generate a table of contents for the text</h1><div class="post__text post__text-html js-mediator-article">  Good day!  In this publication I want to tell and tell you how to generate a table of contents for PHP.  Why hub "Laravel"?  This solution resulted in a package that can be simply connected via composer. <br><br><img src="https://habrastorage.org/files/d68/f9d/670/d68f9d6708ed44c9a43e98f086572d39.png"><br><a name="habracut"></a><br>  <s>I am a code reader!</s>  If you need a code, it's <a href="https://github.com/lutdev/table-contents/blob/master/src/Lutskevich/TOC/TableContents.php">here</a> .  The final decision resulted in a package for Laravel. <br><br>  <s>We are sitting with the boys, the code ...</s> While working on an interesting project, the customer receives the task ‚ÄúGuys, it‚Äôs necessary for a certain type of articles to generate a table of contents on the fly‚Äù.  This task came to me last year.  How, how to implement it was incomprehensible and unknown.  One famous search engine didn‚Äôt give out any results that would suit me.  It was necessary to come up with the decision himself.  And one famous portal with ready-made solutions did not help me either. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <s>I sat down, banged a couple of liters of dark ... I got together</s> with the idea that yes how to do and began to code.  At first everything seemed simple: there are headings of different levels in the text (h1-h6 tags), and we need to build a table of contents on them.  Well, I think, now I will parse the text on the template and the whole thing into an array.  While working, the muse visited me and the dialogue began: <br>  - coder, and what will you do if the headers are not in a strict order? <br>  - what?  like this? <br>  - Imagine, going h1, then in the text h2, h3, again h2, h1, h2, h3, h4.  This is a strict order, because  lower-level headings follow the parent strictly.  And now imagine that after h2, it is not h3 that goes in the text, but h4 or h6!  And after h6 h4 and so on, like an equalizer. <br>  Here I was covered with cold sweat.  ‚ÄúWell,‚Äù I think, ‚Äúthis cannot be.‚Äù  I decided to check with the customer and yes!  Is it possible!.. <br><br>  <s>I gave a shit to gov ...</s> Having drunk a cup of tea, having made up my mind, I decided that I could not get rid of the array, because  I need to know when the parent to open and close.  But the array is either there, or it is not there, and it‚Äôs impossible to determine exactly where I need to save the next title.  Since  All these things happen on the API, on the SPA, respectively, each header level should be at a distance from the left edge.  In addition, it is necessary to keep the title itself and a link to it.  The link is formed from the title itself and must be an anchor in order to click and get into the necessary part of the text. <br><br>  <s>Not hard, but interesting ...</s> That's exactly what I thought to myself, and I also thought that I can open and close the parent and child elements myself, collecting data in JSON. <br><br>  The first line of code is: <br><br><pre><code class="php hljs">$description = preg_replace(<span class="hljs-string"><span class="hljs-string">"/&lt;(p|[hH](10|[1-9]))&gt;(&lt;[hH](10|[1-9]).*?&gt;(.*?)&lt;\/[hH](10|[1-9])&gt;)&lt;\/(p|[hH](10|[1-9]))&gt;/"</span></span>, <span class="hljs-string"><span class="hljs-string">"$3"</span></span>, $description);</code> </pre> <br>  She did not immediately take the lead, but appeared after the requirement was added that it should be possible to insert the headers h7-h10, which were not in the wysiwyg editor.  For this, we created our own magic, as a result of which we received a situation when the title tag could be framed with a paragraph.  This is the line that removes this very paragraph (p tag). <br><br>  Next we collect into the array all the headers that are in the text in the array $ items <br><br><pre> <code class="php hljs">preg_match_all(<span class="hljs-string"><span class="hljs-string">"/&lt;[hH](10|[1-9]).*?&gt;(.*?)&lt;\/[hH](10|[1-9])&gt;/"</span></span>, $description, $items);</code> </pre> <br><br>  And then the carousel begins.  First I need to open all my table of contents: <br><br><pre> <code class="php hljs">$menu = <span class="hljs-string"><span class="hljs-string">"{"</span></span>;</code> </pre><br>  Then, a large cycle is launched on the headings, into which we will dive: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; count($items[<span class="hljs-number"><span class="hljs-number">0</span></span>]); $i++) {...}</code> </pre><br>  First of all, you need to get the title text, clearing it from tags and other peels.  The <i>replaceH1Symbols</i> function <i>replaces</i> some html entities with special characters (for example, &lt;turns into ‚Äú).  The <i>stripTags</i> property stores such a regular <br><br><pre> <code class="php hljs">/&lt;\/?[^&gt;]+&gt;|\&amp;[az]+;|\<span class="hljs-string"><span class="hljs-string">'|"/</span></span></code> </pre> <br><pre> <code class="php hljs">$name = preg_replace(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;stripTags, <span class="hljs-string"><span class="hljs-string">""</span></span>, trim(html_entity_decode(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;replaceH1Symbols($items[<span class="hljs-number"><span class="hljs-number">2</span></span>][$i]), ENT_QUOTES)));</code> </pre><br>  After the name is received, we will create a link for it: <br><br><pre> <code class="php hljs">$link = preg_replace(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;symbols, <span class="hljs-string"><span class="hljs-string">""</span></span>, strtolower($name)); $link = preg_replace(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;spaces, <span class="hljs-string"><span class="hljs-string">"-"</span></span>, $link);</code> </pre><br>  where the <i>symbols</i> property contains all the vzabinka symbols (quotes, brackets, apostrophes, punctuation marks, etc.), and in <i>spaces</i> everything looks like a space, because it should not be in the link. <br><br>  So, there is a link.  Next you need to check whether there is such a link already in the text.  After all, the text may contain the same headings.  If there is such a link and perhaps it is not one, then our new link should be assigned its serial number <br><br><pre> <code class="php hljs">$repeatCount = count(array_keys($usedItem, $name)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($repeatCount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { $link .= <span class="hljs-string"><span class="hljs-string">"-"</span></span> . ($repeatCount + <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre><br>  <s>Kill me!</s>  We begin to form our table of contents.  First, check whether we have a cycle or not. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($i == <span class="hljs-number"><span class="hljs-number">0</span></span>) { $menu .= <span class="hljs-string"><span class="hljs-string">'"'</span></span> . $i . <span class="hljs-string"><span class="hljs-string">'": {'</span></span>; $menu .= <span class="hljs-string"><span class="hljs-string">'"title": "'</span></span> . $name . <span class="hljs-string"><span class="hljs-string">'",'</span></span>; $menu .= <span class="hljs-string"><span class="hljs-string">'"link": "'</span></span> . $link . <span class="hljs-string"><span class="hljs-string">'"'</span></span>; }</code> </pre><br>  If the beginning, then everything is fine, and if not?  We check for whether the level of the current header is greater than the previous one (for example, the previous h2, and the current h4).  Perhaps this wording is not entirely correct, but I write more \ less, starting from the number near h. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> ($i != <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; $items[<span class="hljs-number"><span class="hljs-number">1</span></span>][$i] &gt; $items[<span class="hljs-number"><span class="hljs-number">1</span></span>][$i - <span class="hljs-number"><span class="hljs-number">1</span></span>]) {</code> </pre><br>  If so, we need to calculate the difference between these headers. <br><br><pre> <code class="php hljs">$quantity = $items[<span class="hljs-number"><span class="hljs-number">1</span></span>][$i] - $items[<span class="hljs-number"><span class="hljs-number">1</span></span>][$i - <span class="hljs-number"><span class="hljs-number">1</span></span>];</code> </pre><br>  and open a child submenu <br><br><pre> <code class="php hljs">$menu .= <span class="hljs-string"><span class="hljs-string">', "subItems": {'</span></span>;</code> </pre><br>  Then we write down what level our previous heading is, because  if its order is less (2 &lt;4), then it is the parent of our current title. <br><br><pre> <code class="php hljs">array_push($parentItem, (int)$items[<span class="hljs-number"><span class="hljs-number">1</span></span>][$i - <span class="hljs-number"><span class="hljs-number">1</span></span>]);</code> </pre><br>  And write the total number of internal elements: <br><br><pre> <code class="php hljs">$subItemsCount += $quantity;</code> </pre><br>  Then we start the nesting cycle of these very internal elements, which are not. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($j = <span class="hljs-number"><span class="hljs-number">1</span></span>; $j &lt;= $quantity - <span class="hljs-number"><span class="hljs-number">1</span></span>; $j++) { $menu .= <span class="hljs-string"><span class="hljs-string">"\""</span></span> . $j . <span class="hljs-string"><span class="hljs-string">"\":{"</span></span>; $menu .= <span class="hljs-string"><span class="hljs-string">'"subItems": {'</span></span>; array_push($parentItem, $items[<span class="hljs-number"><span class="hljs-number">1</span></span>][$i - <span class="hljs-number"><span class="hljs-number">1</span></span>] + $j); }</code> </pre><br>  And after that, finally insert our title <br><br><pre> <code class="php hljs"> $menu .= <span class="hljs-string"><span class="hljs-string">'"'</span></span> . $i . <span class="hljs-string"><span class="hljs-string">'": {'</span></span>; $menu .= <span class="hljs-string"><span class="hljs-string">'"title": "'</span></span> . $name . <span class="hljs-string"><span class="hljs-string">'",'</span></span>; $menu .= <span class="hljs-string"><span class="hljs-string">'"link": "'</span></span> . $link . <span class="hljs-string"><span class="hljs-string">'"'</span></span>; }</code> </pre><br>  <s>How would I get it?</s>  Then we consider the situation on the contrary, when the current title is less than the previous one.  For example, h2 comes after h4. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> ($i != <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; $items[<span class="hljs-number"><span class="hljs-number">1</span></span>][$i] &lt; $items[<span class="hljs-number"><span class="hljs-number">1</span></span>][$i - <span class="hljs-number"><span class="hljs-number">1</span></span>]) {</code> </pre><br>  Then we calculate the difference between the headers and, if there is a <i>subItemsCount,</i> we need to close all the internal elements that were opened earlier.  You ask why I multiply by 2?  Believe, just believe.  This is a magic that previously had an explanation, but now it is covered with myths about the pairing of opening / closing curly braces. <br><br><pre> <code class="php hljs">$quantity = $items[<span class="hljs-number"><span class="hljs-number">1</span></span>][$i - <span class="hljs-number"><span class="hljs-number">1</span></span>] - $items[<span class="hljs-number"><span class="hljs-number">1</span></span>][$i]; $menu .= <span class="hljs-string"><span class="hljs-string">"}"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($subItemsCount) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($j = <span class="hljs-number"><span class="hljs-number">1</span></span>; $j &lt;= $quantity * <span class="hljs-number"><span class="hljs-number">2</span></span>; $j++) { $menu .= <span class="hljs-string"><span class="hljs-string">"}"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($j % <span class="hljs-number"><span class="hljs-number">2</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>) { $subItemsCount--; array_pop($parentItem); } } }</code> </pre><br>  And paste our current header <br><br><pre> <code class="php hljs"> $menu .= <span class="hljs-string"><span class="hljs-string">', "'</span></span> . $i . <span class="hljs-string"><span class="hljs-string">'": {'</span></span>; $menu .= <span class="hljs-string"><span class="hljs-string">'"title": "'</span></span> . $name . <span class="hljs-string"><span class="hljs-string">'",'</span></span>; $menu .= <span class="hljs-string"><span class="hljs-string">'"link": "'</span></span> . $link . <span class="hljs-string"><span class="hljs-string">'"'</span></span>; }</code> </pre><br>  <s>Hey man, are you a drug addict?</s>  The last check is whether the level of the current header is equal to the previous one.  For example, there was h2 and again h2.  It's simple: close the previous item and insert the current one. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $menu .= <span class="hljs-string"><span class="hljs-string">'}, "'</span></span> . $i . <span class="hljs-string"><span class="hljs-string">'": {'</span></span>; $menu .= <span class="hljs-string"><span class="hljs-string">'"title": "'</span></span> . $name . <span class="hljs-string"><span class="hljs-string">'",'</span></span>; $menu .= <span class="hljs-string"><span class="hljs-string">'"link": "'</span></span> . $link . <span class="hljs-string"><span class="hljs-string">'"'</span></span>; }</code> </pre><br>  <s>To promise is not to marry ... He</s> deceived, not the last.  Last check on whether the current header is the last or not.  After all, if so, we need to close all levels open to it. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!array_key_exists($i + <span class="hljs-number"><span class="hljs-number">1</span></span>, $items[<span class="hljs-number"><span class="hljs-number">1</span></span>])) { $a = $items[<span class="hljs-number"><span class="hljs-number">1</span></span>][$i]; $lastParent = array_shift($parentItem); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($lastParent &amp;&amp; $lastParent &lt; $a) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($q = <span class="hljs-number"><span class="hljs-number">0</span></span>; $q &lt;= ($a - $lastParent) * <span class="hljs-number"><span class="hljs-number">2</span></span>; $q++) { $menu .= <span class="hljs-string"><span class="hljs-string">"}"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $menu .= <span class="hljs-string"><span class="hljs-string">"}"</span></span>; } }</code> </pre><br>  And do not forget to put the name in the array of used names: <br><br><pre> <code class="php hljs">$usedItem[] = $name;</code> </pre><br>  <s>That's the end of the fairy tale. It</s> remains only to close our table of contents outside the cycle. <br><br><pre> <code class="php hljs">$menu .= <span class="hljs-string"><span class="hljs-string">"}"</span></span>;</code> </pre><br>  Everything.  Table of contents is ready to use.  It remains only to put anchors in the text on the headers themselves. <br><br>  <s>Shta</s>  This JSON at the exit of the API is decoded and the SPA receives the object. <br><br>  <s>I read, I do well?</s>  Thank you for your attention and I hope that the publication will be useful.  Any advice, criticism accept 24 \ 7.  Good luck to all coding and not only! </div><p>Source: <a href="https://habr.com/ru/post/325224/">https://habr.com/ru/post/325224/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325210/index.html">Mobile platform. ReactNative Hybrid Application Architecture</a></li>
<li><a href="../325216/index.html">Probability of data loss in large clusters</a></li>
<li><a href="../325218/index.html">"Introduction to Elixir" - the first book on the Elixir in Russian</a></li>
<li><a href="../325220/index.html">Making your first game on the Phaser. Part 2 - Loading Resources</a></li>
<li><a href="../325222/index.html">Go digest Events, articles, interesting projects from the world of Go [March 15 - 30, 2017]</a></li>
<li><a href="../325226/index.html">How hackers attack corporate WiFi: parsing attacks</a></li>
<li><a href="../325230/index.html">OpenSSL, ssl_ciphers and nginx: we pump 100%</a></li>
<li><a href="../325232/index.html">Zen social programming</a></li>
<li><a href="../325234/index.html">Poll. What php-framework do you use?</a></li>
<li><a href="../325236/index.html">FPGA image rotation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>