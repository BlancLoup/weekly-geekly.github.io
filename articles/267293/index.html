<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mikrotik RouterOS + PHP script on the site. Empowerment</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the time of ROS 5.x, there was a need to raise a tunnel to a router with a white dynamic address. In ROS 5, we did not specify the name, but the IP...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mikrotik RouterOS + PHP script on the site. Empowerment</h1><div class="post__text post__text-html js-mediator-article">  At the time of ROS 5.x, there was a need to raise a tunnel to a router with a white dynamic address.  In ROS 5, we did not specify the name, but the IP address.  Option 2: DDNS service, the implementation of which we will consider briefly and the second about which the story will be. <br><a name="habracut"></a><br>  There was an idea to make a center where routers would report their addresses, and read the addresses of others.  It was decided to go through the least resistance - the site on PHP. <br><br>  At the moment, implemented a couple of simple things. <br><br><h4>  Announcement of your address </h4><br>  Implemented through a request to the script with an indication of its (router) name and password: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">:local</span></span> number <span class="hljs-string"><span class="hljs-string">"ROUTER_NUMBER"</span></span>; <span class="hljs-symbol"><span class="hljs-symbol">:local</span></span> pass <span class="hljs-string"><span class="hljs-string">"PASSWORD"</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">/tool fetch url="http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/whoami.ho.ua/adr</span></span>.php\<span class="hljs-string"><span class="hljs-string">?i</span></span>=$number&amp;p=$pass<span class="hljs-string"><span class="hljs-string">" mode=http</span></span></code> </pre> <br>  The name and password are needed so that no one could disguise itself as you and did not initiate the connection of your router to your router or could not consider the address of your router.  Using the fetch utility, we open the necessary script on the server and pass the name and password through GET.  The script through $ _SERVER ['REMOTE_ADDR'] gets the external address of the router and writes it to the database. <br><br><h4>  Reading another's address </h4><br>  Again, we call the web script through the same utility: <br><br><pre> <code class="hljs pgsql">:<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> number "ROUTER_NUMBER"; :<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> pass "PASSWORD"; /tool <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span> url="http://whoami.ho.ua/getadr.php\?i=$number&amp;p=$pass" mode=http dst-<span class="hljs-type"><span class="hljs-type">path</span></span>="adr.txt" :<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> routeradr [/file <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> adr.txt contents]</code> </pre><br>  dst-path = "adr.txt" - we indicate that the received data is saved to a file.  On the webpage itself, we have a purely text with the address of the requested router: <br><br>  $ query = "SELECT address FROM table_routers WHERE ((id = '$ _ GET [i]') AND (password = '$ _ GET [p]'))"; <br>  $ adr = mysql_query ($ query) or die (mysql_error ()); <br>  $ router = mysql_fetch_assoc ($ adr); <br>  echo $ router [address]; <br><br>  : global routeradr [/ file get adr.txt contents] - set the value of the file contents to a global variable.  Then this variable can be applied according to need and desire. <br><br><h4>  Reading the script from the database </h4><br><pre> <code class="hljs pgsql">:<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> number "ROUTER_NUMBER"; :<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> pass "PASSWORD"; /tool <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span> url="http://whoami.ho.ua/getscript.php\?i=$number&amp;p=$pass" mode=http dst-<span class="hljs-type"><span class="hljs-type">path</span></span>="script.rsc" <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> file-<span class="hljs-type"><span class="hljs-type">name</span></span>=script.rsc /file remove script.rsc</code> </pre><br><br>  Everything is the same as in the previous script, but we import the file into the router config, and then delete this file. <br><br>  What is it for?  For example, you inadvertently cut off access to the router in the firewall.  Then you can add on the site a script for this router with which you specify the corrected firewall rules.  The router following the schedule connects to the site, where PHP looks to see if there are any unsent scripts for this router in the database: <br><br><pre> <code class="php hljs">SELECT id FROM table_routers WHERE ((id=<span class="hljs-string"><span class="hljs-string">'$_GET[i]'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (password=<span class="hljs-string"><span class="hljs-string">'$_GET[p]'</span></span>)) $adr=mysql_query($query) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">die</span></span> (mysql_error()); $router=mysql_fetch_assoc($adr); $query=<span class="hljs-string"><span class="hljs-string">"SELECT script, id FROM table_scripts WHERE ((router='$router[id]') AND (executed='N')) ORDER BY id ASC LIMIT 1"</span></span>;</code> </pre><br>  First, we check if the password and the router number are set correctly (so that no one else can read your script, maybe you change the passwords in the config file), and then we look at which script is in the queue not transferred to this router. <br><br>  This method does not solve the problems that have arisen; it helps to prevent them.  That is, you must first ‚Äúlay straws‚Äù and score in the scheduler every X minutes / hours the router checks for new scripts for it. <br><br>  This method is also good when the router has a gray ip address, and access to it must be obtained from outside.  We are scoring the script of raising the VPN-tunnel to our white ipishka and after a specified time we have access to the device even for 10 NATIs. <br><br>  Here is such a short story.  I will once remarks and ideas what else can be screwed to such a service.  There are still small statistics in the plans - so that the router would merge a couple of its parameters into the database, for example, temperature, processor load and others. <br><br>  As a bonus, a piece of ready-made scripts, which I wrote about at the beginning, get ip from the host name and add it to the IPsec policy. <br><br>  Plus, it works in conjunction with Mikrotik + soapboxes that support ddns and ipsec (Dlink 804 for example).  The script that gets the IP address from the remote peer name and inserts it into the necessary policy: <br><br><pre> <code class="php hljs">:local nname RHost1; :log info <span class="hljs-string"><span class="hljs-string">"start $nname"</span></span>; :local newip [:resolve <span class="hljs-string"><span class="hljs-string">"rmotehost1.zapto.org"</span></span>]; :local curip [/ip ipsec policy get [/ip ipsec policy find comment=$nname] sa-dst-address]; :log info <span class="hljs-string"><span class="hljs-string">"newip = $newip"</span></span>; :log info <span class="hljs-string"><span class="hljs-string">"currentip = $curip"</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($newip != $curip) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :log info <span class="hljs-string"><span class="hljs-string">"ip $nname is $curip not $newip"</span></span>; /ip ipsec policy set [/ip ipsec policy find comment=$nname] sa-dst-address=$newip; :log info <span class="hljs-string"><span class="hljs-string">"end $nname"</span></span>; }</code> </pre><br>  And the script that substitutes on the remote side the current ip in the ipsec policy: <br><br><pre> <code class="php hljs">:<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> lastip :local wanip :local wanif <span class="hljs-string"><span class="hljs-string">"pppoe-out1"</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([ :typeof $lastip ] = nil ) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> lastip <span class="hljs-string"><span class="hljs-string">"0"</span></span> } :local wanip [ /ip address get [/ip address find <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class">=$</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wanif</span></span></span><span class="hljs-class"> ] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">address</span></span></span><span class="hljs-class"> ] :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> ([ :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">typeof</span></span></span><span class="hljs-class"> $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wanip</span></span></span><span class="hljs-class"> ] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class"> ) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class">=</span></span>{ :log info (<span class="hljs-string"><span class="hljs-string">"WANIP: no ip address on $wanif ."</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>= { :<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i from=( [:len $wanip] - <span class="hljs-number"><span class="hljs-number">1</span></span>) to=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [:pick $wanip $i] = <span class="hljs-string"><span class="hljs-string">"/"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :set wanip [:pick $wanip <span class="hljs-number"><span class="hljs-number">0</span></span> $i]; :log info (<span class="hljs-string"><span class="hljs-string">"wan ip now is $wanip"</span></span>) } } :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($wanip != $lastip) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :log info (<span class="hljs-string"><span class="hljs-string">"Renew ipsec Policy: $wanif -&gt; $wanip"</span></span>) <span class="hljs-comment"><span class="hljs-comment">#   ipsec /ip ipsec policy set 0 sa-src-address=$wanip :global lastip $wanip } }</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/267293/">https://habr.com/ru/post/267293/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../267279/index.html">The digest of interesting materials from the world of web development and IT for the last week No. 177 (September 14 - 20, 2015)</a></li>
<li><a href="../267281/index.html">PHP Digest number 70 - interesting news, materials and tools (September 6 - 20, 2015)</a></li>
<li><a href="../267283/index.html">We count working days from Moment.js</a></li>
<li><a href="../267289/index.html">Overview of opportunities for working with Microsoft for startups</a></li>
<li><a href="../267291/index.html">Router reservation using VRRP protocol</a></li>
<li><a href="../267295/index.html">RC5 encryption algorithm and its implementation in python</a></li>
<li><a href="../267297/index.html">Free Firebird large database seminar</a></li>
<li><a href="../267301/index.html">Automate Java EE Testing Web Services with SoapUI and Arquillian</a></li>
<li><a href="../267305/index.html">Modifiers private and private [this] in Scala</a></li>
<li><a href="../267307/index.html">Backups of Hyper-V virtual machines and regular computers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>