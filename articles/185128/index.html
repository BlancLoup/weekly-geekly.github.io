<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rake 1: Rise of the lonely phoenixes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I wanted to write an article about the theoretical shortcomings of the Singleton pattern, but a brief search showed that there was enough material on ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rake 1: Rise of the lonely phoenixes</h1><div class="post__text post__text-html js-mediator-article">  I wanted to write an article about the theoretical shortcomings of the Singleton pattern, but a brief search showed that there was enough material on this topic.  But it seems to me that there are not enough real examples of architectural problems with loners.  I will try to fill this gap with the help of this post.  At the end, conclusions from their own mistakes will be given, which so far make it possible to avoid repeating problems. <br><a name="habracut"></a><br><h6>  Rake </h6><br>  So, for the beginning of the actual rake.  In the inherited project, single classes were actively used.  There were more than ten of them.  Dynamic creation of instances was used during the first access, i.e.  the getInstance method had the following form <br><br><pre><code class="cpp hljs">Singleton* Singleton::getInstance() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sInstance == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { sInstance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Singleton; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sInstance; }</code> </pre> <br>  And then began the hunt for memory leaks.  The destruction of singles was not provided, because the profiler gave a lot of false "leaks", among which it was almost impossible to find a real problem.  Yes, and did not want to look.  Therefore, it was decided to write the destroyInstance method, which would allow to destroy instances of singles classes upon request. <br><br>  The situation was greatly simplified by the fact that the implementation of Singleton-logic was rendered into a separate template class - there was no need for a global rework.  It was enough to add a deleting method and its call for each single ... And it was here that the theory worked.  Basically two of its points <br><ol><li>  Dependencies on the classes of singles are not obvious from the interfaces of the classes and modules. </li><li>  The singleton class has no explicit owner.  That's why he is a loner.  From that and suffers. </li></ol><br>  Having called all destroyInstance, I opened the profiler in anticipation of the hunt for real leaks and ... all plunged into the same sea of ‚Äã‚Äãfalse positives!  Most of the singles lived in their own pleasure and further, despite the destruction experienced.  The first thing, as always, was the compiler.  And, as always, the real problem was in its own hands. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Everything is properly destroyed.  But uncontrollable dependencies existed between singles.  Often, the other was used in the destructor of one.  And since getInstance not only returned an existing instance of the class, but also created new ones if necessary, mass uncontrolled uprisings from the ashes began to occur.  Immediately I remembered the book Alexandrescu [1].  Only, unlike me, he was engaged in necromancy (in section 6.6, which is almost symbolic) intentionally. <br><br>  The situation needed to be corrected.  The first thought is to expose a flag when destroying an instance that prevents the object from being re-created.  But this led to the need for a large-scale modification of the already tangled code that was written with the expectation that getInstance always returns the correct pointer.  As a result, realizing that there was no easy solution, I almost completely eradicated the loners (leaving one), which I still only enjoy. <br><br><h6>  findings </h6><br>  The problems associated with managing the lifetime of singleton classes are often raised and discussed.  It seems to me that the root of the problem is in misunderstanding the essence of this pattern.  <b>The singleton should be alone</b> .  And that is all.  Yes, as a result, more careful design is required, identifying dependencies between entities.  But it's worth it.  Because in the end it turns out a single point of management of the application, the interfaces and logic are clarified. <br><br>  Of course, there are certainly applications where this approach is unacceptable.  But these are exceptions, and they should be treated as exceptions.  If the application is one, then the class completely independent in terms of its creation and destruction should be one. <br><br>  For example, the classic example of a keyboard, display and log [1].  The owner of these classes can be made a global Application.  The name is beaten, but here are its pluses <br><ul><li>  <b>Certainty</b>  After calling Application :: free, you can not be afraid of zombie phoenixes - everything will be destroyed exactly in the order in which the developer intended.  The log is deleted with the last simple call to the delete mLog operator after deleting all other objects. </li><li>  <b>Simplicity and portability</b> .  It does not require the use (and even knowledge) of the subtleties of language.  The architecture freely adapts to the main object-oriented languages.  In addition, simple solutions are much less prone to errors and have lower requirements for staff skills.  In other words, they are cheaper and better than complex ones [3] </li><li>  <b>Testability</b>  Using tricks like <b>atexit</b> [1,2] for planning the destruction of single classes makes it impossible to reset the global state of an application without completing its work.  As a result, for example, to perform two independent tests, you will have to restart the program each time. </li></ul><br><br>  The only problem is the uncontrolled creation / copying of these classes.  So, theoretically, the programmer may not find that the keyboard control object needs to be obtained from the Application, and create its own instance.  This development can be easily stopped by declaring all unwanted designers closed.  This will make impossible the "manual" creation.  For the owner class to still instantiate a keyboard object, it‚Äôs enough to declare it a friend. <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Keyboard</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: Keyboard(); <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class">;</span></span> };</code> </pre><br>  Such implementation will play an important informational role.  Even without any documentation, simply by examining the interface of the Keyboard class, the developer will be able to understand that you need to contact Application for instances. <br><br>  A single class can almost always be replaced by a better solution.  At least, in my case over the past year, every attempt to make another singleton with more detailed analysis invariably turned out to be a manifestation of laziness and unwillingness to once again think about the planned architecture. <br><br>  [1] Alexandrescu A. Modern C ++ Design: Generalized Programming and Applied Design Patterns. <br>  [2] <a href="http://www.cplusplus.com/reference/cstdlib/atexit/">atexit</a> <br>  [3] <a href="http://ru.wikipedia.org/wiki/KISS_(%25D0%25BF%25D1%2580%25D0%25B8%25D0%25BD%25D1%2586%25D0%25B8%25D0%25BF)">KISS</a> </div><p>Source: <a href="https://habr.com/ru/post/185128/">https://habr.com/ru/post/185128/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../185108/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ63 (June 24 - 29, 2013)</a></li>
<li><a href="../185110/index.html">simpleTooltip: HTML filled with CSS and flavored jQuery</a></li>
<li><a href="../185114/index.html">Meet - RosFin Monitoring</a></li>
<li><a href="../185116/index.html">DNA origami: how to make interesting pieces of nanometer-sized DNA</a></li>
<li><a href="../185124/index.html">mySQLgame</a></li>
<li><a href="../185130/index.html">Football on the plus, part 2: practical</a></li>
<li><a href="../185134/index.html">The digest of news from the world of mobile development for the last week ‚Ññ18 (June 24 - 30, 2013)</a></li>
<li><a href="../185138/index.html">Wi-Fi seamless roaming</a></li>
<li><a href="../185140/index.html">Building a Qt 5.1 Android application on a Mac seriously?</a></li>
<li><a href="../185142/index.html">The digest of interesting news and materials from the world of PHP over the past two weeks, number 20 (06/18/2013 - 06/30/2013)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>