<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>[Translation] Handling errors and transactions in SQL Server. Part 1. Error handling - quick start</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! I present to you the translation of the article ‚ÄúError and Transaction Handling in SQL Server. Part One - Jumpstart Error Handling " by Erla...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>[Translation] Handling errors and transactions in SQL Server. Part 1. Error handling - quick start</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  I present to you the translation of the article <a href="http://www.sommarskog.se/error_handling/Part1.html">‚ÄúError and Transaction Handling in SQL Server.</a>  <a href="http://www.sommarskog.se/error_handling/Part1.html">Part One - Jumpstart Error Handling "</a> by Erland Sommarskog. <br><br><h2>  1. Introduction </h2><br>  This article is the first in a series of three articles on error and transaction handling in SQL Server.  Its goal is to give you a quick start to the error handling thread by setting a basic example that fits most of your code.  This part is written for an inexperienced reader, and for this reason I deliberately keep silent about many details.  At the moment, the task is to tell <i>how,</i> without emphasis on <i>why</i> .  If you take my words on faith, you can read only this part and put the other two aside for further steps in your career. <br><br>  On the other hand, if you question my recommendations, you definitely need to read the other two parts, where I dive into the details much more deeply, exploring the very tangled world of error and transaction processing in SQL Server.  <a href="http://www.sommarskog.se/error_handling/Part2.html">The second</a> and <a href="http://www.sommarskog.se/error_handling/Part3.html">third</a> parts, as well as the three applications, are intended for readers with deeper experience.  The first article is short, the second and third are much longer. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      All articles describe error and transaction handling in SQL Server for version 2005 and later. <br><a name="habracut"></a><br><h3>  1.1 Why do you need error handling? </h3><br>  Why do we handle errors in our code?  There are many reasons for this.  For example, on the forms in the application, we check the data entered and inform users about errors made during the input.  User errors are <i>foreseeable</i> errors.  But we also need to handle <i>unexpected</i> errors.  That is, errors may occur due to the fact that we have missed something when writing code.  A simple approach is to interrupt the execution or at least return to the stage in which we have complete control over what is happening.  It will not be enough just to emphasize that it is completely impermissible to ignore unforeseen errors.  This is a flaw that can cause disastrous consequences: for example, cause the application to provide incorrect information to the user or, even worse, store incorrect data in the database.  It is also important to report the occurrence of an error so that the user does not think that the operation was successful, while your code actually did not perform anything. <br><br>  We often want changes in the database to be <a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D1%2582%25D0%25BE%25D0%25BC%25D0%25B0%25D1%2580%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BE%25D0%25BF%25D0%25B5%25D1%2580%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">atomic</a> .  For example, the task of transferring money from one account to another.  To this end, we need to change two entries in the CashHoldings table and add two entries to the Transactions table.  It is absolutely unacceptable that errors or failure led to the fact that the money will be transferred to the beneficiary‚Äôs account, and it will not be debited from the sender‚Äôs account.  For this reason, error handling also applies to transaction processing.  In the example above, we need to wrap the operation in BEGIN TRANSACTION and COMMIT TRANSACTION, but not only this: in case of an error, we have to make sure that the transaction has been rolled back. <br><br><h2>  2. Basic commands </h2><br>  We will begin with an overview of the most important commands that are required for error handling.  In the second part, I will describe all the commands related to error handling and transactions. <br><br><h3>  2.1 TRY-CATCH </h3><br>  The main error handling mechanism is the TRY-CATCH construct, very much like similar constructions in other languages.  The structure is as follows: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY &lt; &gt; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH &lt; &gt; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH</code> </pre> <br>  If any error appears in <code>&lt; &gt;</code> , the execution will be transferred to the CATCH block, and the error handling code will be executed. <br><br>  As a rule, in CATCH any open transaction is rolled back and re-cause an error.  Thus, the calling client program understands that something went wrong.  Recalling the error will be discussed later in this article. <br><br>  Here is a very quick example: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @x <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @x = <span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> PRINT <span class="hljs-string"><span class="hljs-string">'Not reached'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH PRINT <span class="hljs-string"><span class="hljs-string">'This is the error: '</span></span> + error_message() <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH</code> </pre> <br>  Result of performance: <code>This is the error: Divide by zero error encountered.</code> <br><br>  We will return to the error_message () function later.  It should be noted that the use of PRINT in the CATCH handler is provided only as part of experiments and should not be done in the real application code. <br><br>  If <code>&lt; &gt;</code> calls a stored procedure or triggers triggers, then any error that occurs in them will pass the execution to the CATCH block.  More specifically, when an error occurs, SQL Server spins the stack until it finds a CATCH handler.  And if there is no such handler, SQL Server sends the error message directly to the client. <br><br>  There is one very important limitation in the TRY-CATCH construct that needs to be known: it does not catch compilation errors that occur in the same scope.  Consider an example: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> inner_sp <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY PRINT <span class="hljs-string"><span class="hljs-string">'This prints'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> NoSuchTable PRINT <span class="hljs-string"><span class="hljs-string">'This does not print'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH PRINT <span class="hljs-string"><span class="hljs-string">'And nor does this print'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> EXEC inner_sp</code> </pre> <br>  Output: <br><br><pre> <code class="hljs delphi">This prints Msg <span class="hljs-number"><span class="hljs-number">208</span></span>, Level <span class="hljs-number"><span class="hljs-number">16</span></span>, State <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">Procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inner_sp</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Line</span></span></span><span class="hljs-function"> 4 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Invalid</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span><span class="hljs-function"> '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NoSuchTable</span></span></span><span class="hljs-function">'</span></span></code> </pre> <br>  As you can see, the TRY block is present, but when an error occurs, execution is not transferred to the CATCH block, as expected.  This applies to all compilation errors, such as column skipping, invalid aliases, and the like that occur during execution.  (Compilation errors may occur in SQL Server at runtime due to deferred name resolution ‚Äî a feature that allows SQL Server to create a procedure that refers to non-existent tables.) <br><br>  These errors are not completely elusive;  you cannot catch them in the area in which they arise, but you can catch them in the outer area.  Add this code to the previous example: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> outer_sp <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY EXEC inner_sp <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH PRINT <span class="hljs-string"><span class="hljs-string">'The error message is: '</span></span> + error_message() <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> EXEC outer_sp</code> </pre> <br>  Now we get this output: <br><br><pre> <code class="hljs delphi">This prints The error <span class="hljs-keyword"><span class="hljs-keyword">message</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span>: Invalid <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-string"><span class="hljs-string">'NoSuchTable'</span></span>.</code> </pre> <br>  This time the error was intercepted because the external CATCH handler worked. <br><br><h3>  2.2 SET XACT_ABORT ON </h3><br>  You should always add this expression to the beginning of your stored procedures: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> XACT_ABORT, NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span></code> </pre> <br>  It activates two session parameters that are turned off by default for compatibility with previous versions, but experience proves that the best approach is to have these parameters always on.  The default behavior of SQL Server in the situation when TRY-CATCH is not used is that some errors interrupt execution and roll back any open transactions, while with other errors the execution of subsequent instructions continues.  When you turn on XACT_ABORT ON, almost all errors begin to cause the same effect: any open transaction is rolled back, and the execution of the code is interrupted.  There are a few exceptions, among which the most noticeable expression is RAISERROR. <br><br>  The XACT_ABORT parameter is required for more reliable error handling and transaction processing.  In particular, with the default settings, there are several situations where execution can be interrupted without any rollback of the transaction, even if you have a TRY-CATCH.  We saw this example in the previous section, where we found out that TRY-CATCH does not intercept compilation errors that occurred in the same area.  An open transaction that was not rolled back due to an error can cause serious problems if the application continues to work without completing the transaction or rolling back. <br><br>  For reliable error handling in SQL Server, you need both TRY-CATCH and SET XACT_ABORT ON.  Among them, the instruction SET XACT_ABORT ON is the most important.  If it is not worth relying on it for code on an industrial environment, it is quite suitable for quick and simple solutions. <br><br>  The NOCOUNT parameter has nothing to do with error handling, but including it in the code is a good practice.  NOCOUNT suppresses messages of the form (1 row (s) affected), which you can see in the Message panel in SQL Server Management Studio.  While these messages can be useful when working with SSMS, they can negatively affect application performance as they increase network traffic.  The message about the number of rows can also lead to an error in poorly written client applications, which may think that this is the data that the query returned. <br><br>  Above, I used a syntax that is a bit unusual.  Most people would write two separate expressions: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> XACT_ABORT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span></code> </pre> <br>  There is no difference between them.  I prefer the version with SET and the comma, since  This reduces the noise level in the code.  Since these expressions should appear in all your stored procedures, they should take up as little space as possible. <br><br><h2>  3. Basic Error Handling Example </h2><br>  After we looked at TRY-CATCH and SET XACT_ABORT ON, let's connect them together in an example that we can use in all of our stored procedures.  First, I will show an example in which an error is generated in a simple form, and in the next section I will look at solutions better. <br><br>  For example, I will use this simple table. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> sometable(a <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, b <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> pk_sometable PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(a, b))</code> </pre> <br>  Here is a stored procedure that demonstrates how you should work with errors and transactions. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> insert_data @a <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, @b <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> XACT_ABORT, NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> sometable(a, b) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (@a, @b) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> sometable(a, b) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (@b, @a) <span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @@trancount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @msg <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">2048</span></span>) = error_message() RAISERROR (@msg, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-number"><span class="hljs-number">55555</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH</code> </pre> <br>  The first line in the procedure includes XACT_ABORT and NOCOUNT in one expression, as I showed above.  This line is the only one before BEGIN TRY.  Everything else in the procedure should be placed after BEGIN TRY: declaration of variables, creation of temporary tables, table variables, everything.  Even if you have other SET-commands in the procedure (although the reasons for this are rare), they should go after BEGIN TRY. <br><br>  The reason I prefer to specify SET XACT_ABORT and NOCOUNT before BEGIN TRY is that I see it as one line of noise: it should always be there, but I don‚Äôt want it to interfere with the look.  Of course, this is a matter of taste, and if you prefer to put SET-commands after BEGIN TRY, do not worry.  The important thing is that you should not put anything else in front of BEGIN TRY. <br><br>  The part between BEGIN TRY and END TRY is the main component of the procedure.  Since I wanted to use a user-defined transaction, I introduced a rather contrived business rule, which says that if you insert a pair, then the reverse pair must also be inserted.  The two INSERT statements are inside BEGIN and COMMIT TRANSACTION.  In many cases, you will have many lines of code between BEGIN TRY and BEGIN TRANSACTION.  Sometimes you will also have code between COMMIT TRANSACTION and END TRY, although this is usually just a final SELECT that returns data or assigns values ‚Äã‚Äãto output parameters.  If your procedure does not perform any changes or has only one INSERT / UPDATE / DELETE / MERGE statement, then usually you don‚Äôt need to explicitly specify the transaction at all. <br><br>  While the TRY block will look different from procedure to procedure, the CATCH block should be more or less the result of copying and pasting.  So you do something short and simple and then use it everywhere, without really thinking.  The CATCH handler above performs three actions: <br><br><ol><li>  Rolls back any open transactions. </li><li>  Repeats an error. </li><li>  Ensures that the value returned by the procedure is non-zero. </li></ol><br>  These three actions should always be there.  We can argue that the string <br><br><pre> <code class="sql hljs">IF @@trancount &gt; 0 <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span></code> </pre> <br>  not needed if there is no explicit transaction in the procedure, but this is absolutely wrong.  Perhaps you are calling a stored procedure that opens a transaction, but which cannot roll it back due to TRY-CATCH restrictions.  Perhaps you or someone else will add an explicit transaction after two years.  Do you remember then that you need to add a line with a rollback?  Do not count on it.  I also hear readers who object that if the person calling the procedure has opened a transaction, we should not roll it back ... No, we should, and if you want to know why, you need to read the second and third parts.  Rolling back a transaction in the CATCH handler is a categorical imperative that has no exceptions. <br><br>  The error re-generation code includes the following line: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @msg <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">2048</span></span>) = error_message()</code> </pre> <br>  The built-in error_message () function returns the text of the error that occurred.  The next line reruns the error using the RAISERROR expression.  This is not the easiest way to call an error, but it works.  We will look at other ways in the next chapter. <br><br>  <b>Note</b> : The syntax for assigning the initial value of a variable in DECLARE was implemented in SQL Server 2008. If you have SQL Server 2005, you need to break the string into DECLARE and a SELECT statement. <br><br>  The final expression RETURN is insurance.  RAISERROR never aborts its execution, so the execution of the next expression will continue.  While all procedures use TRY-CATCH, and also all client code handles exceptions, there is no cause for concern.  But your procedure can be called from old code written before SQL Server 2005 and before the TRY-CATCH implementation.  In those days, the best we could do was look at the returned values.  What you return with RETURN does not really matter if it is not a null value (zero usually indicates a successful completion). <br><br>  The last expression in the procedure is END CATCH.  You should never put any code after END CATCH.  Someone reading the procedure may not see this piece of code. <br><br>  After reading the theory, let's try a test example: <br><br><pre> <code class="sql hljs">EXEC insert_data 9, NULL</code> </pre> <br>  Result of performance: <br><br><pre> <code class="hljs pgsql">Msg <span class="hljs-number"><span class="hljs-number">50000</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>, State <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Procedure</span></span> insert_data, <span class="hljs-type"><span class="hljs-type">Line</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> Cannot <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> <span class="hljs-string"><span class="hljs-string">'b'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">'tempdb.dbo.sometable'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> does <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> allow nulls. <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> fails.</code> </pre> <br>  Let's add an external procedure to see what happens when the error is recalled: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> outer_sp @a <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, @b <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> XACT_ABORT, NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY EXEC insert_data @a, @b <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @@trancount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @msg <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">2048</span></span>) = error_message() RAISERROR (@msg, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-number"><span class="hljs-number">55555</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> EXEC outer_sp <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span></code> </pre> <br>  Result of work: <br><br><pre> <code class="hljs pgsql">Msg <span class="hljs-number"><span class="hljs-number">50000</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>, State <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Procedure</span></span> outer_sp, <span class="hljs-type"><span class="hljs-type">Line</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> Violation <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> <span class="hljs-string"><span class="hljs-string">'pk_sometable'</span></span>. Cannot <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> duplicate key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-string"><span class="hljs-string">'dbo.sometable'</span></span>. The duplicate key <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> (<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>).</code> </pre> <br>  We received a correct error message, but if you look at the headers of this message and take a closer look at the previous one, you may notice a problem: <br><br><pre> <code class="hljs delphi">Msg <span class="hljs-number"><span class="hljs-number">50000</span></span>, Level <span class="hljs-number"><span class="hljs-number">16</span></span>, State <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">Procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insert_data</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Line</span></span></span><span class="hljs-function"> 12 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Msg</span></span></span><span class="hljs-function"> 50000, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Level</span></span></span><span class="hljs-function"> 16, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">State</span></span></span><span class="hljs-function"> 1, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">outer_sp</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Line</span></span></span><span class="hljs-function"> 9</span></span></code> </pre> <br>  The error message displays the location of the final RAISERROR expression.  In the first case, only the line number is incorrect.  In the second case, the procedure name is also incorrect.  For simple procedures, such as our test case, this is not a big problem.  But if you have several levels of nested complex procedures, the presence of an error message with no indication of the place of its origin will make the search and elimination of the error a much more complicated matter.  For this reason, it is desirable to generate an error so that you can determine if an erroneous piece of code is found quickly, and this is what we will look at in the next chapter. <br><br><h2>  4. Three ways to generate errors </h2><br><h3>  4.1 Using error_handler_sp </h3><br>  We looked at the error_message () function, which returns the text of the error message.  The error message consists of several components, and there is a function error_xxx () for each of them.  We can use them to re-generate a complete message that contains the original information, albeit in a different format.  If you do this in every CATCH handler, this will be a big disadvantage - duplication of code.  You do not need to be in the CATCH block to call error_message () and other similar functions, and they will return the same information if they are called from a stored procedure that the CATCH block performs. <br><br>  Let me introduce error_handler_sp: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> error_handler_sp <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @errmsg <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">2048</span></span>), @severity tinyint, @state tinyint, @errno <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, @proc sysname, @lineno <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @errmsg = error_message(), @severity = error_severity(), @state = error_state(), @errno = error_number(), @proc = error_procedure(), @lineno = error_line() <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @errmsg <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'***%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @errmsg = <span class="hljs-string"><span class="hljs-string">'*** '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">quotename</span></span>(@proc), <span class="hljs-string"><span class="hljs-string">'&lt;dynamic SQL&gt;'</span></span>) + <span class="hljs-string"><span class="hljs-string">', Line '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">ltrim</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">str</span></span>(@lineno)) + <span class="hljs-string"><span class="hljs-string">'. Errno '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">ltrim</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">str</span></span>(@errno)) + <span class="hljs-string"><span class="hljs-string">': '</span></span> + @errmsg <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> RAISERROR(<span class="hljs-string"><span class="hljs-string">'%s'</span></span>, @severity, @state, @errmsg)</code> </pre> <br>  The first of what error_handler_sp does is that it saves the value of all error_xxx () functions into local variables.  I will return to the IF statement in a second.  Instead, let's look at the SELECT statement inside the IF: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @errmsg = <span class="hljs-string"><span class="hljs-string">'*** '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">quotename</span></span>(@proc), <span class="hljs-string"><span class="hljs-string">'&lt;dynamic SQL&gt;'</span></span>) + <span class="hljs-string"><span class="hljs-string">', Line '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">ltrim</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">str</span></span>(@lineno)) + <span class="hljs-string"><span class="hljs-string">'. Errno '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">ltrim</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">str</span></span>(@errno)) + <span class="hljs-string"><span class="hljs-string">': '</span></span> + @errmsg</code> </pre> <br>  The purpose of this SELECT is to format the error message that is sent to RAISERROR.  It includes all the information from the original error message, which we cannot insert directly into RAISERROR.  We need to handle the name of the procedure, which may be NULL for errors in regular scripts or in dynamic SQL.  Therefore, the COALESCE function is used.  (If you do not understand the form of the expression RAISERROR, I tell about it in more detail in the second part.) <br><br>  The formatted error message starts with three asterisks.  This achieves two goals: 1) We can immediately see that this message is called from the CATCH handler.  2) This makes it possible for error_handler_sp to filter errors that have already been generated one or more times, using the NOT LIKE '***%' condition in order to avoid changing the message a second time. <br><br>  Here is what the CATCH handler should look like when you use error_handler_sp: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @@trancount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> EXEC error_handler_sp <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-number"><span class="hljs-number">55555</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH</code> </pre> <br>  Let's try some test scripts. <br><br><pre> <code class="sql hljs">EXEC insert_data 8, NULL EXEC outer_sp 8, 8</code> </pre> <br>  Result of performance: <br><br><pre> <code class="hljs delphi">Msg <span class="hljs-number"><span class="hljs-number">50000</span></span>, Level <span class="hljs-number"><span class="hljs-number">16</span></span>, State <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">Procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error_handler_sp</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Line</span></span></span><span class="hljs-function"> 20 *** [</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insert_data</span></span></span><span class="hljs-function">], </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Line</span></span></span><span class="hljs-function"> 5. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Errno</span></span></span><span class="hljs-function"> 515:</span></span> Cannot insert the value NULL into column <span class="hljs-string"><span class="hljs-string">'b'</span></span>, table <span class="hljs-string"><span class="hljs-string">'tempdb.dbo.sometable'</span></span>; column does <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> allow nulls. INSERT fails. Msg <span class="hljs-number"><span class="hljs-number">50000</span></span>, Level <span class="hljs-number"><span class="hljs-number">14</span></span>, State <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">Procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error_handler_sp</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Line</span></span></span><span class="hljs-function"> 20 *** [</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insert_data</span></span></span><span class="hljs-function">], </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Line</span></span></span><span class="hljs-function"> 6. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Errno</span></span></span><span class="hljs-function"> 2627:</span></span> Violation <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> PRIMARY KEY constraint <span class="hljs-string"><span class="hljs-string">'pk_sometable'</span></span>. Cannot insert duplicate key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-string"><span class="hljs-string">'dbo.sometable'</span></span>. The duplicate key value <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> (<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>).</code> </pre> <br>  The message headers indicate that the error occurred in the error_handler_sp procedure, but the text of the error messages gives us the real location of the error ‚Äî both the name of the procedure and the line number. <br><br>  I will show two more methods for calling errors.  However, error_handler_sp is my main recommendation for readers who read this part.  This is a simple option that works on all versions of SQL Server since 2005. There is only one drawback: in some cases, SQL Server generates two error messages, but the error_xxx () functions return only one of them, and therefore one of the messages is lost.  This can be inconvenient when dealing with administrative commands like BACKUP \ RESTORE, but the problem rarely occurs in code that is purely for applications. <br><br><h3>  4.2.  Usage; THROW </h3><br>  In SQL Server 2012, Microsoft introduced the expression; THROW for easier error handling.  Unfortunately, Microsoft made a serious mistake when designing this team and created a dangerous trap. <br><br>  With the expression; THROW you do not need any stored procedures.  Your CATCH handler becomes as simple as this: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @@trancount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> ;THROW RETURN 55555 <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH</code> </pre> <br>  The advantage of THROW is that the error message is generated exactly the same as the original message.  If there were initially two error messages, both messages are reproduced, which makes this expression even more attractive.  As with all other error messages, errors generated by THROW can be intercepted by an external CATCH handler and replayed.  If there is no CATCH handler, execution is interrupted, therefore the RETURN statement is not needed in this case.  (I still recommend leaving it, in case you change your attitude towards; THROW later). <br><br>  If you have SQL Server 2012 or later, change the definition of insert_data and outer_sp and try running the tests again.  The result this time will be: <br><br><pre> <code class="hljs pgsql">Msg <span class="hljs-number"><span class="hljs-number">515</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>, State <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Procedure</span></span> insert_data, <span class="hljs-type"><span class="hljs-type">Line</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> Cannot <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> <span class="hljs-string"><span class="hljs-string">'b'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">'tempdb.dbo.sometable'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> does <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> allow nulls. <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> fails. Msg <span class="hljs-number"><span class="hljs-number">2627</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>, State <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Procedure</span></span> insert_data, <span class="hljs-type"><span class="hljs-type">Line</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> Violation <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> <span class="hljs-string"><span class="hljs-string">'pk_sometable'</span></span>. Cannot <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> duplicate key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-string"><span class="hljs-string">'dbo.sometable'</span></span>. The duplicate key <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> (<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>).</code> </pre> <br>  The procedure name and line number are correct and there is no other procedure name that can confuse us.  Also saved the original error numbers. <br><br>  At this point, you can tell yourself: did Microsoft really call the team; THROW?  Isn't it just THROW?  In fact, if you look in Books Online, there will not be a semicolon.  But the semicolon should be.  Officially, they separate the previous expression, but this is optional, and not everyone uses a semicolon in T-SQL expressions.  More importantly, if you miss the semicolon before THROW, there will be no syntax error.  But this will affect the behavior when the expression is executed, and this behavior will be incomprehensible to the uninitiated.  If there is an active transaction, you will receive an error message that will be completely different from the original one.  And even worse, in the absence of an active transaction, the error will be silently output without processing.  Such a thing as the omission of a semicolon should not have such absurd consequences.  To reduce the risk of such behavior, always think of a team as; THROW (with a semicolon). <br><br>  There is no denying that; THROW has its advantages, but the semicolon is not the only trap of this command.  If you want to use it, I encourage you to read at least the second part of this series, where I reveal more details about the team; THROW.  Up to this point, use error_handler_sp. <br><br><h3>  4.3.  Using SqlEventLog </h3><br>  The third way to handle errors is to use SqlEventLog, which I describe in great detail in the third part.  Here I will only make a short review. <br><br>  SqlEventLog provides a slog.catchhandler_sp stored procedure that works just like error_handler_sp: it uses the error_xxx () functions to collect information and displays an error message, storing all the information about it.  In addition to this, it logs the error to the splog.sqleventlog table.  Depending on the type of application that you have, this table can be a very valuable object. <br><br>  To use SqlEventLog, your CATCH handler must be: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @@trancount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> EXEC slog.catchhandler_sp @@procid <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-number"><span class="hljs-number">55555</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH</code> </pre> <br>  @@ procid returns the object ID of the current stored procedure.  ,  SqlEventLog      .     ,       catchhandler_sp: <br><br><pre> <code class="hljs pgsql">Msg <span class="hljs-number"><span class="hljs-number">50000</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>, State <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Procedure</span></span> catchhandler_sp, <span class="hljs-type"><span class="hljs-type">Line</span></span> <span class="hljs-number"><span class="hljs-number">125</span></span> {<span class="hljs-number"><span class="hljs-number">515</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">Procedure</span></span> insert_data, <span class="hljs-type"><span class="hljs-type">Line</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> Cannot <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> <span class="hljs-string"><span class="hljs-string">'b'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">'tempdb.dbo.sometable'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> does <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> allow nulls. <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> fails. Msg <span class="hljs-number"><span class="hljs-number">50000</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>, State <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Procedure</span></span> catchhandler_sp, <span class="hljs-type"><span class="hljs-type">Line</span></span> <span class="hljs-number"><span class="hljs-number">125</span></span> {<span class="hljs-number"><span class="hljs-number">2627</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">Procedure</span></span> insert_data, <span class="hljs-type"><span class="hljs-type">Line</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> Violation <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> <span class="hljs-string"><span class="hljs-string">'pk_sometable'</span></span>. Cannot <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> duplicate key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-string"><span class="hljs-string">'dbo.sometable'</span></span>. The duplicate key <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> (<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>).</code> </pre> <br>   ,       ,    error_handler_sp,     .   ,      slog.sqleventlog: <br><table><tbody><tr><td> logid </td><td> logdate </td><td> errno </td><td> severity </td><td> logproc </td><td> linenum </td><td> msgtext </td></tr><tr><td>  one </td><td> 2015-01-25 22:40:24.393 </td><td>  515 </td><td>  sixteen </td><td> insert_data </td><td>  five </td><td> Cannot insert ... </td></tr><tr><td>  2 </td><td> 2015-01-25 22:40:24.395 </td><td>  2627 </td><td>  14 </td><td> insert_data </td><td>  6 </td><td> Violation of ... </td></tr></tbody></table><br>     SqlEventLog,     sqleventlog.zip.       ,   SqlEventLog. <br><br><h2> 5.   </h2><br>            .   ,      90-95%  .   ,     : <br><br><ol><li>   ,          ,    ,     . </li><li>      ,    TRY-CATCH,  RAISERROR    . </li><li>     Linked Server  ,               . </li><li>     INSERT-EXEC,    ,   ROLLBACK TRANSACTION     . </li><li>   ,    error_handler_sp  SqlEventLog,    ,  SQL Server      .   ;THROW   . </li></ol><br>            . <br><br>    ,        . <br><br><h3>  </h3><br>           ,     ,     :      RETURN (  RETURN     ). <br><br>    ,     ,   ,       ,     BEGIN TRANSACTION. <br>      ,  ,     ,         .  :     ,     .     ,       ,    .             . <br><br><h3>   </h3><br>         ,      .      ,     -    .     ,    . <br><br>        :   ,  SQL Server,         : <br><br><pre> <code class="sql hljs">IF @@trancount &gt; 0 <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span></code> </pre> <br>       Timeout expired (     SQL Server,   API). <br><br><h2> 6.    </h2><br>       .        ,     .     ,     ,            SQL Server  -. <br><br> ‚Ä¶           : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> XACT_ABORT, NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span></code> </pre> <br></div><p>Source: <a href="https://habr.com/ru/post/358936/">https://habr.com/ru/post/358936/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358926/index.html">Defect management style</a></li>
<li><a href="../358928/index.html">Choosing a location for the server and software, testing market inefficiencies: how to actually create trading robots</a></li>
<li><a href="../358930/index.html">The most difficult program</a></li>
<li><a href="../358932/index.html">Out of IPv4 - the RIPE recorder gave the last block</a></li>
<li><a href="../358934/index.html">The patented dream of programmers 80-90</a></li>
<li><a href="../358938/index.html">40 stupid CRM questions</a></li>
<li><a href="../358940/index.html">Switzerland Travel Guide</a></li>
<li><a href="../358942/index.html">Apollo graphql client - development of isomorphic (universal) applications on react.js</a></li>
<li><a href="../358944/index.html">How to speed up mobile search in half. Yandex lecture</a></li>
<li><a href="../358946/index.html">Introduction to competitive networks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>