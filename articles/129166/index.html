<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We draw water on Direct3D. Part 1. Graphics pipeline architecture and API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, divided into several parts, I will explain in general terms the architecture of modern versions of Direct3D (10-11), and also show ho...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We draw water on Direct3D. Part 1. Graphics pipeline architecture and API</h1><div class="post__text post__text-html js-mediator-article">  In this article, divided into several parts, I will explain in general terms the architecture of modern versions of Direct3D (10-11), and also show how using this API to draw just such a scene of a coral reef, the main advantage of which is simple to implement, but beautiful and relatively convincing looking water: <br><img src="https://habrastorage.org/getpro/habr/post_images/399/fa1/1b8/399fa11b8f514403ab6f5344d54defea.png" alt="image"><br><br><a name="habracut"></a><br>  You should start by describing the Direct3D architecture. <br><br>  API Direct3D is a direct reflection of the architecture of modern video cards, and encapsulates the following graphic pipeline: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/comment_images/705/087/618/7050876188b7159d6cbdc5fff1a64a0d.jpg" alt="image"><br><br>  In the figure, the fully programmable stages of the conveyor are indicated by rounded rectangles, and the configurable are ordinary. <br><br>  Now I will explain each of the stages separately. <br><br>  <b>Input Assembler (IA for short)</b> - retrieves data about vertices from buffers located in system memory and collects from them primitives that are used by subsequent stages of the pipeline.  Also, IA attaches to the vertices some metadata generated by the D3D runtime, such as the vertex number. <br><br>  <b>Vertex Shader (Vertex Shader, VS)</b> is a mandatory, and fully programmable stage of the pipeline.  As you can easily guess, it runs for each vertex (English <i>vertex</i> ), and receives input data from the Input Assembler.  It is used for various transformations of vertices, for transformation of their coordinates from one coordinate system to another, for generating normals, texture coordinates, lighting calculations and another.  The data from the vertex shader come either directly to the rasterizer, or to the Stream Output (if this stage of the pipeline is set, but the geometric shader is not), or to the geometric shader, or to the surface shader. <br><br>  <b>Hull Shader (surface shader, HS), Domain Shader (domain shader, DS) and Tesselator (tesselator)</b> are the stages added to Shader Model 5.0 (and D3D11, respectively) and used during the tessellation process (splitting primitives into smaller ones for enhance image detail).  These pipeline stages are optional, and since they are not used in my scene, I will not dwell on them in detail.  Those interested can read about them, for example, on <a href="http://msdn.microsoft.com/en-us/library/ff476340(v%3DVS.85).aspx">MSDN</a> . <br><br>  <b>Geometry Shader (geometric shader, GS)</b> - handles primitives (points, lines or triangles) collected from vertices processed by previous stages of the pipeline.  Geometric shaders can generate new primitives on the fly (that is, their exhaust does not have to be 1-to-1, as in the case of, for example, vertex shaders).  They are used to generate shadow geometry (shadow volume), sprites (particle systems, etc.), reflections (for example, one-pass drawing in a cube map) and the like.  Although it can be used for tessellation, it is not recommended.  The data from the geometry shader is fed either to the Stream Output or to the rasterizer. <br><br>  <b>Stream Output (SO)</b> - an optional stage of the pipeline, used to unload the vertices processed by the pipeline back to the system memory (so that the exhaust SO can be read by the CPU or used by the pipeline the next time it is started).  Data is received either from a geometric shader, or, in the case of its absence, from a vertex or domain. <br><br>  <b>Rasterizer (rasterizer, RS)</b> is the ‚Äúheart‚Äù of the graphics pipeline.  The purpose of this stage, as the name implies, is rasterization of primitives, that is, their splitting into pixels (although the name ‚Äúpixel‚Äù is not entirely correct - a pixel usually means what is directly in the framebuffer, that is, what is displayed on the screen , so it would be more correct to "fragments").  The rasterizer will receive the vector information about the vertices from the previous stages of the pipeline, and convert it into raster, cutting off primitives outside the scope, interpolating the values ‚Äã‚Äãassociated with the vertices (such as texture coordinates) and projecting their positions on the two-dimensional viewing area (Eng. <i>viewport</i> ).  Data from the rasterizer goes to the pixel shader, if it is installed. <br><br>  <b>Pixel Shader (pixel shader, PS)</b> - works with image fragments obtained from the rasterizer.  Used to implement a huge variety of graphic effects, and the output, in the Output Merger stage, gives the color of the fragment, and, optionally, the depth value (the value used to determine which fragments lie closer to the camera). <br><br>  <b>Output Merger (OM)</b> - the last stage of the graphics pipeline.  For each fragment received from the pixel shader, it performs a depth test and a stencil test, determining whether the fragment should get into the framebuffer and mixes colors, if included. <br><br>  Now about the API itself. <br><br>  The Direct3D API is based on the lightweight COM ( <a href="http://en.wikipedia.org/wiki/Component_Object_Model">Microsoft Component Object Model</a> ).  Lightweight so that from the "full-fledged" COM there remains only the concept of interfaces. <br><br>  For those who are unfamiliar with the concept of a COM interface, a small lyrical digression. <br><br>  The concept of a COM interface is close in its essence to the concept of interfaces from .NET (because .NET is, in fact, a development of COM).  At its core, this is an abstract class that has only methods, and which is associated with some 16-byte identifier ( <a href="http://en.wikipedia.org/wiki/GUID">GUID</a> ).  Physically, an interface is a collection of functions, that is, a pointer to an array with pointers to functions (with a C-compatible ABI, and usually with a stdcall call convention), whose first argument is a pointer to the interface itself.  Behind each interface is some object that implements it, and each object can implement several different types of interfaces.  Microsoft postulates that the only way to communicate with an object that implements an interface is through a pointer to this interface, namely, by calling its methods. <br><br>  Interfaces can be inherited from each other, and most COM interfaces, including Direct3D, are inherited from a special interface ‚Äî <i>IUnknown</i> , which implements controlling the lifetime of an object that implements the interface through reference counting and allows you to receive pointers to interfaces of various types from the object by their GUID. <br><br>  I must say that although the program for this article is written in C ++, but since COM interfaces have C-compatible ABI, you can work with them from any language that is able to work with native code, directly or through <a href="http://en.wikipedia.org/wiki/Foreign_function_interface">FFI</a> .  In the case of MSVC ++ and .NET, this is particularly convenient, since MS seamlessly integrated COM into C ++ and .NET object systems, respectively. <br><br>  Interfaces Direct3D 10 and 11 can be divided into several types: <br><br>  <b>DXGI Interfaces</b>  DXGI is a low-level API on which all new components of the Windows graphics subsystem are based.  In the case of D3D, we are especially interested in the <i>IDXGISwapChain</i> interface - it encapsulates a chain of buffers into which the graphics pipeline draws, and is responsible for linking them to a specific winapi window (HWND).  Although it is not necessary to use this interface (even for drawing ‚Äúto the window‚Äù - we can draw into texture and then transfer it to HDC in GDI), it is often used, as it is very convenient. <br><br>  <b>Interfaces of the virtual adapter.</b>  Used to create various resources, to configure the graphics pipeline and to start it.  In D3D10, one interface was responsible for all this, <i>ID3D10Device</i> (or <i>ID3D10Device1</i> , for D3D10.1. In general, in the naming of D3D and DXGI interfaces - the prefix ‚ÄúI‚Äù in the name means that the type is an interface type, a prefix like ‚ÄúDXGI‚Äù or ‚Äú D3D11 "means a specific API, and the suffix, if there is one, means the minor version of the API), in D3D11 it was divided into two - <i>ID3D11Device</i> (resource creation), and <i>ID3D11DeviceContext</i> (the remaining two tasks). <br>  Objects that implement these interfaces also implement some DXGI interfaces ‚Äî for example, we can query the <i>IDXGIDevice</i> interface from <i>ID3D11Device</i> (by calling the <i>QueryInterface</i> method (which is included in <i>IUnknown</i> , and <i>ID3D11Device is</i> inherited from <i>IUnknown</i> ) from the first) <br><br>  Here we should mention that using the newest API, we absolutely do not have to require the hardware on which our program will work to fully comply with this API.  In D3D10.1, Microsoft introduced the concept of ‚Äúfeature level‚Äù, which allows programs using new API versions to run even on D3D9 hardware (if they do not require features from the API, of a certain feature level that are not included, of course).  In the case of my scene, I will use D3D11, but I will create a virtual adapter with the D3D_FEATURE_LEVEL_10_0 flag, and use the 4th model shaders respectively. <br><br>  <b>Auxiliary interfaces.</b>  Such as <i>ID3D11Debug</i> , <i>ID3D11InfoQueue</i> , <i>ID3D11Counter</i> or <i>ID3D11ShaderReflection</i> - used to get additional information about the status of the pipeline, about shaders, to measure performance and other. <br><br>  <b>Resource Interfaces</b>  In D3D, a resource is some kind of texture (for example, <i>ID3D11Texture2D</i> is a two-dimensional texture), or just a buffer (containing, for example, vertex data).  Resource objects also implement various DXGI interfaces, such as <i>IDXGIResource</i> , and this is the key to interoperability between different graphics subsystems (such as Direct2D, GDI) and different versions of the same subsystem (D3D9, 10 and 11) in new versions of Windows. <br><br>  <b>Interfaces of representation (English <i>view</i> ).</b>  Each resource we can use for several different purposes, and perhaps even at the same time.  In new versions of D3D, we do not supply textures and buffers interfaces directly to the pipeline (except for vertex buffers, indexes, and constants), instead we create an object that implements one of the presentation interfaces and deliver it to the pipeline. <br>  In D3D11, the following types of view interfaces are present: <br><ul><li>  <b>ID3D11RenderTargetView</b> - rendering target view (render target).  As the name implies (in general, I must say, the type names in D3D and DXGI are very speaking, albeit long), to the resource associated with this representation, the graphics pipeline draws </li><li>  <b>ID3D11ShaderResourceView</b> - a view for the resources used by shaders (an example is the texture from which the pixel shader selects a texel to form a fragment color). </li><li> <b>ID3D11DepthStencilView</b> is a view for resources used as a depth buffer and stencil. </li><li>  <b>ID3D11UnorderedAccessView</b> - a view for the resources used by compute shaders (Compute Shader, CS - since they practically do not belong to the rendering process, I will not describe them). </li></ul><br>  <b>Shader Interfaces</b>  For example, <i>ID3D11VertexShader</i> .  Encapsulate the shader code for a specific programmable stage of the graphics pipeline, and are used to set up the shader for this stage. <br><br>  <b>Interfaces of a state (English <i>state</i> ).</b>  Used to configure various non-programmable pipeline stages.  Examples are <i>ID3D11RasterizerState</i> (configures the rasterizer), <i>ID3D11InputLayout</i> (stores information about the vertices supplied from the vertex buffers in the Input Assembler), <i>ID3D11BlendState</i> (configures the color mixing process in Output Merger). <br><br>  Actually, the program that paints the scene mentioned at the very beginning will be described in the following parts of the article, namely, in the second part I will describe in detail the process of creating and initializing the virtual adapter and the resources needed to render the scene, and the third part will be devoted to the shaders used in the program . <br><br>  The full code is available on github, at the following link: <a href="https://github.com/Lovesan/Reef">github.com/Lovesan/Reef</a> <br><br></div><p>Source: <a href="https://habr.com/ru/post/129166/">https://habr.com/ru/post/129166/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../129159/index.html">Microsoft is going to patent a modular smartphone</a></li>
<li><a href="../129160/index.html">On-line broadcast of Fadi Bishar‚Äôs lecture</a></li>
<li><a href="../129162/index.html">Predicting revolutions by analyzing open sources</a></li>
<li><a href="../129163/index.html">Short cut for the smartest: Glavstart now invests weekly</a></li>
<li><a href="../129165/index.html">Why in some people‚Äôs hands phones don't work</a></li>
<li><a href="../129169/index.html">The secret of the golden billion</a></li>
<li><a href="../129170/index.html">Farminers: in the morning you present a startup, in the evening you get 150,000 dollars of investment!</a></li>
<li><a href="../129172/index.html">Crossbeam and XOS, what is it and how to cook them correctly</a></li>
<li><a href="../129173/index.html">We are taking away other cookies from mail.ru</a></li>
<li><a href="../129174/index.html">RedDwarf - server platform for developing online games in Java</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>