<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write game logic in C #. Part 2/2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is a continuation of the previous article . Step by step, we are creating an engine on which the game logic of our economic strategy will work. I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write game logic in C #. Part 2/2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/681/92c/36d/68192c36d912459bac96e1cb223b3c98.jpg" align="left">  This is a continuation of the <a href="https://habrahabr.ru/post/322258/">previous article</a> .  Step by step, we are creating an engine on which the game logic of our economic strategy will work.  If you see this for the first time, I strongly recommend starting with <b><a href="https://habrahabr.ru/post/322258/">Part 1</a></b> , as this is a dependent continuation and requires its context. <br><br>  As before - at the bottom of the article you can find the full code for the GitHab and a link to free download. <br><br><hr><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Work plan </h3><br>  1. <s>Set up projects</s> <br>  2. <s>Create a core (basic facilities)</s> <br>  3. <s>Add and test the first commands - build the structure and module</s> <br>  4. <s>We take out the settings of buildings and modules in a separate file.</s> <br>  5. <s>Add the flow of time</s> <br>  6. Add Constructible, buildings are now under construction for some time. <br>  7. Add resources, for the construction of the necessary resources <br>  8. Add a production cycle - the module consumes and issues resources. <br><br><h2>  Adding Constructible </h2><br>  Let's tie something to the flow of time now.  Let the buildings and modules are not built immediately, but several moves (depending on the configuration).  To begin with, we will add the ConstructionTime item to all settings.  If ConstructionTime is zero, the structure cannot be built. <br><br><blockquote><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">BuildingConfig</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... public int ConstructionTime; }</span></span></code> </pre> <pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ModuleConfig</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... public int ConstructionTime; }</span></span></code> </pre></blockquote><br>  Do not forget to add the settings to the factory: <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Factory</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... Type = BuildingType.PowerPlant, ConstructionTime = 8, // ... Type = BuildingType.Smeltery, ConstructionTime = 10, // ... Type = BuildingType.Roboport, ConstructionTime = 12, // ... Type = ModuleType.Generator, ConstructionTime = 5 // ... Type = ModuleType.Furnace, ConstructionTime = 6 // ... Type = ModuleType.Digger, ConstructionTime = 7 // ... Type = ModuleType.Miner, ConstructionTime = 8 // ... }</span></span></code> </pre></blockquote><br>  Now create a class Progression, which we will implement any progressions that flow in time, for example, construction. <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Progression</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Time; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Progress { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsFake { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Time == <span class="hljs-number"><span class="hljs-number">0</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsReady { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsFake || Progress &gt;= Time; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsRunning { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !IsReady &amp;&amp; Progress &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Progression</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> time</span></span></span><span class="hljs-function">)</span></span> { Time = time; Progress = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddProgress</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!IsReady) Progress++; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Complete</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!IsReady) Progress = Time; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Reset</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Progress = <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre></blockquote><br>  Now we add the possibility of construction in our rooms and modules. <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Building</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... public readonly Progression Constructible; // ... public Building (BuildingConfig config) { // ... Constructible = new Progression(config.ConstructionTime); }</span></span></code> </pre><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Module</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... public readonly Progression Constructible; public Module (ModuleConfig config) { // ... Constructible = new Progression(config.ConstructionTime); }</span></span></code> </pre></blockquote><br>  And we prohibit the construction of modules in a room not yet built: <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ModuleConstruct</span></span> : <span class="hljs-title"><span class="hljs-title">Command</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... protected override bool Run () { // ... if (!Building.Constructible.IsReady) { return false; }</span></span></code> </pre></blockquote><br>  Of course, tests fell after that, so we will add CorrectConstruction, IncorrectConstruction, CantConstructInWrongBuilding and ModulesLimits to tests after successfully completing the BuildingConstruct command, calling the Complete method (yes, we created it for this purpose) <br><br><pre> <code class="cs hljs">room.Building.Constructible.Complete()</code> </pre><br>  And to test the inability to build in an unfinished room we will write a separate test: <br><br><blockquote><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CantConstructInUncompleteBuilding</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> core = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GameLogic.Core(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> room = core.Ship.GetRoom(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BuildingConstruct( room, core.Factory.ProduceBuilding(BuildingType.PowerPlant) ) .Execute(core); Assert.IsFalse( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModuleConstruct( room.Building, core.Factory.ProduceModule(ModuleType.Generator), <span class="hljs-number"><span class="hljs-number">2</span></span> ) .Execute(core) .IsValid ); }</code> </pre></blockquote><br>  But now let's make the room build not only by the wave of the hand of the gods of the world of our game, but simply with time.  To do this, create a special command and call it every turn: <br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NextTurn</span></span> : <span class="hljs-title"><span class="hljs-title">Command</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConstructionProgress().Execute(Core); <span class="hljs-comment"><span class="hljs-comment">// .. } }</span></span></code> </pre><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ConstructionProgress</span></span> : <span class="hljs-title"><span class="hljs-title">Command</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> room <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Core.Ship.Rooms) { BuildingProgress(room.Building); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuildingProgress</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Building building</span></span></span><span class="hljs-function">)</span></span> { building.Constructible.AddProgress(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> module <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> building.Modules) { module.Constructible.AddProgress(); } } }</code> </pre></blockquote><br>  And immediately we will cover the tests that show that the code works great: <br><blockquote><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Constructible</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> smelteryTime = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> furnaceTime = <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> core = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GameLogic.Core(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> room = core.Ship.GetRoom(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Smeltery new BuildingConstruct( room, core.Factory.ProduceBuilding(BuildingType.Smeltery) ) .Execute(core); Assert.IsFalse( room.Building.Constructible.IsReady ); new NextTurnCount(smelteryTime - 1).Execute(core); Assert.IsFalse(room.Building.Constructible.IsReady); new NextTurn().Execute(core); Assert.IsTrue(room.Building.Constructible.IsReady); // Furnace new ModuleConstruct( room.Building, core.Factory.ProduceModule(ModuleType.Furnace), 2 ).Execute(core); var module = room.Building.GetModule(2); Assert.IsFalse( module.Constructible.IsReady ); new NextTurnCount(furnaceTime - 1).Execute(core); Assert.IsFalse(module.Constructible.IsReady); new NextTurn().Execute(core); Assert.IsTrue(module.Constructible.IsReady); }</span></span></code> </pre></blockquote><br><img src="https://habrastorage.org/files/9ac/a63/b96/9aca63b96450455abe5d493a3c1ac5c9.png"><br><br><h2>  Add resources </h2><br>  In order to create something you first need to destroy something and collect scrap metal.  Let's sell resources so that the player has to pay for his buildings.  There will be three resources - Energy, Ore and Metal. <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ResourceType { Energy, Ore, Metal }</code> </pre> </blockquote><br>  We will also create a bank where the player will store and where to take resources from. <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Bank</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Dictionary&lt;ResourceType, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; resources = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;ResourceType, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ResourceType type</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resources.ContainsKey(type) ? resources[type] : <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Change</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ResourceType type, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> current = Get(type); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (current + <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"Not enought "</span></span> + type + <span class="hljs-string"><span class="hljs-string">" in bank"</span></span>); } resources[type] = current + <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } }</code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Core</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... public readonly Bank Bank = new Bank(); }</span></span></code> </pre> </blockquote><br>  Now we add the price of production to the settings of the modules and buildings: <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">BuildingConfig</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... public Dictionary&lt;ResourceType, int&gt; ConstructionCost; }</span></span></code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ModuleConfig</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... public Dictionary&lt;ResourceType, int&gt; ConstructionCost; }</span></span></code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Factory</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... Type = BuildingType.PowerPlant, ConstructionCost = new Dictionary&lt;ResourceType, int&gt;() {{ ResourceType.Metal, 20 }}, // ... Type = BuildingType.Smeltery, ConstructionCost = new Dictionary&lt;ResourceType, int&gt;() {{ ResourceType.Metal, 20 }}, // ... Type = BuildingType.Roboport, ConstructionCost = new Dictionary&lt;ResourceType, int&gt;() {{ ResourceType.Metal, 20 }}, // ... // ... Type = ModuleType.Generator, ConstructionCost = new Dictionary&lt;ResourceType, int&gt;() {{ ResourceType.Metal, 10 }}, // ... Type = ModuleType.Furnace, ConstructionCost = new Dictionary&lt;ResourceType, int&gt;() {{ ResourceType.Metal, 10 }}, // ... Type = ModuleType.Digger, ConstructionCost = new Dictionary&lt;ResourceType, int&gt;() {{ ResourceType.Metal, 10 }}, // ... Type = ModuleType.Miner, ConstructionCost = new Dictionary&lt;ResourceType, int&gt;() {{ ResourceType.Metal, 40 }}, // ... }</span></span></code> </pre> </blockquote><br>  Now we will add a team that allows you to pay resources and immediately try it in (in tests): <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Pay</span></span> : <span class="hljs-title"><span class="hljs-title">Command</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Dictionary&lt;ResourceType, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; Cost; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pay</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Dictionary&lt;ResourceType, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; cost</span></span></span><span class="hljs-function">)</span></span> { Cost = cost; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//        -       if (Cost.Any(item =&gt; Core.Bank.Get(item.Key) &lt; item.Value)) { return false; } //    -    foreach (var item in Cost) { Core.Bank.Change(item.Key, -item.Value); } return true; } }</span></span></code> </pre><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestClass</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Player</span></span> { [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Payment</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> core = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Core(); core.Bank.Change(ResourceType.Metal, <span class="hljs-number"><span class="hljs-number">100</span></span>); core.Bank.Change(ResourceType.Ore, <span class="hljs-number"><span class="hljs-number">150</span></span>); Assert.IsFalse( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pay(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;ResourceType, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;{ { ResourceType.Metal, <span class="hljs-number"><span class="hljs-number">100</span></span> }, { ResourceType.Ore, <span class="hljs-number"><span class="hljs-number">2000</span></span> } }) .Execute(core) .IsValid ); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">100</span></span>, core.Bank.Get(ResourceType.Metal)); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">150</span></span>, core.Bank.Get(ResourceType.Ore)); Assert.IsTrue( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pay(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;ResourceType, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;{ { ResourceType.Metal, <span class="hljs-number"><span class="hljs-number">100</span></span> }, { ResourceType.Ore, <span class="hljs-number"><span class="hljs-number">30</span></span> } }) .Execute(core) .IsValid ); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, core.Bank.Get(ResourceType.Metal)); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">120</span></span>, core.Bank.Get(ResourceType.Ore)); } }</code> </pre> </blockquote><br>  Payment works correctly and start paying for buildings and modules is quite simple - we will add a call to the Pay command as the last validation (it should be the last if we don‚Äôt want another check to prevent the construction from being made after payment): <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">BuildingConstruct</span></span> : <span class="hljs-title"><span class="hljs-title">Command</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... protected override bool Run () { // ... if (!new Pay(Building.Config.ConstructionCost).Execute(Core).IsValid) { return false; } Room.Building = Building; return true; } }</span></span></code> </pre><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ModuleConstruct</span></span> : <span class="hljs-title"><span class="hljs-title">Command</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... protected override bool Run () { // ... if (!new Pay(Module.Config.ConstructionCost).Execute(Core).IsValid) { return false; } Building.SetModule(Position, module); return true; } }</span></span></code> </pre> </blockquote><br>  Fortunately, the tests fell off again (fortunately, because it means that they do their job well). <br><br>  In the old tests we will add resources to the player and write a new test, which in the future will check that suddenly there was no opportunity to build a structure for free.  Add to all broken tests closer to the beginning: <br><br><pre> <code class="cs hljs">core.Bank.Change(ResourceType.Metal, <span class="hljs-number"><span class="hljs-number">1000</span></span>);</code> </pre> <br>  And we write a test for the construction with a shortage of resources: <br><blockquote><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CantBuiltCostly</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> core = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GameLogic.Core(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> room = core.Ship.GetRoom(<span class="hljs-number"><span class="hljs-number">0</span></span>); core.Bank.Change(ResourceType.Metal, <span class="hljs-number"><span class="hljs-number">3</span></span>); Assert.IsFalse( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BuildingConstruct( room, core.Factory.ProduceBuilding(BuildingType.Smeltery) ) .Execute(core) .IsValid ); }</code> </pre></blockquote><br><img src="https://habrastorage.org/files/5fa/847/93f/5fa84793f1f74becb7f1c4296c081533.png"><br><br><h2>  Add production cycle </h2><br>  Of course, it is pleasant to take resources, but it is much more pleasant to give.  Let's set the ability to run production chains.  Each module will be able to eat a certain amount of raw materials and then produce the finished material.  Start again with the configuration: <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ModuleConfig</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... public int CycleTime; //       public Dictionary&lt;ResourceType, int&gt; CycleInput; //   public Dictionary&lt;ResourceType, int&gt; CycleOutput; //     }</span></span></code> </pre><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Module</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... public readonly Progression Cycle; public Module (ModuleConfig config) { // ... Cycle = new Progression(config.CycleTime); } }</span></span></code> </pre><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Factory</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... { ModuleType.Generator, new ModuleConfig() { // ... CycleTime = 12, CycleInput = null, //    ,   CycleOutput = new Dictionary&lt;ResourceType, int&gt;() { { ResourceType.Energy, 10 } }, }}, { ModuleType.Furnace , new ModuleConfig() { // ... CycleTime = 16, CycleInput = new Dictionary&lt;ResourceType, int&gt;() { { ResourceType.Energy, 6 }, { ResourceType.Ore, 4 }, }, CycleOutput = new Dictionary&lt;ResourceType, int&gt;() { { ResourceType.Metal, 5 } } }}, { ModuleType.Digger , new ModuleConfig() { // ... CycleTime = 18, CycleInput = new Dictionary&lt;ResourceType, int&gt;() { { ResourceType.Energy, 2 } }, CycleOutput = new Dictionary&lt;ResourceType, int&gt;() { { ResourceType.Ore, 7 } } }}, { ModuleType.Miner , new ModuleConfig() { // ... CycleTime = 32, CycleInput = new Dictionary&lt;ResourceType, int&gt;() { { ResourceType.Energy, 8 } }, CycleOutput = new Dictionary&lt;ResourceType, int&gt;() { { ResourceType.Ore, 40 } } }}</span></span></code> </pre></blockquote><br>  Now add to each move the progress of production: <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NextTurn</span></span> : <span class="hljs-title"><span class="hljs-title">Command</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CycleProgress().Execute(Core); <span class="hljs-comment"><span class="hljs-comment">//    ,      // ... } }</span></span></code> </pre><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CycleProgress</span></span> : <span class="hljs-title"><span class="hljs-title">Command</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> room <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Core.Ship.Rooms) { BuildingProgress(room.Building); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuildingProgress</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Building building</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!building.Constructible.IsReady) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> module <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> building.Modules) { ModuleProgress(module); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ModuleProgress</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Module module</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!module.Constructible.IsReady || module.Cycle.IsFake) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//        (  ) //        ( ) if (module.Cycle.IsRunning || TryStartCycle(module)) { AddStep(module); } } private void AddStep (Module module) { module.Cycle.AddProgress(); //       ... if (module.Cycle.IsReady) { // ...     CycleOutput(module); // ...   ,       module.Cycle.Reset(); } } private bool TryStartCycle (Module module) { if (module.Config.CycleInput == null) { return true; } //       -   return new Pay(module.Config.CycleInput).Execute(Core).IsValid; } private void CycleOutput (Module module) { foreach (var item in module.Config.CycleOutput) { //    ,     Core.Bank.Change(item.Key, item.Value); } } }</span></span></code> </pre></blockquote><br>  The class turned out to be large, but we can always refactor if the complexity is too high.  Now we write the test.  It will be quite long, and check the correctness of production, and non-launch in case of shortage of resources.  I also created separate settings for the module and the structure specifically for the test (all of a sudden the DG will change them and my tests will drop).  Ideally, all the tests could be changed to special test settings: <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Cycle</span></span> { [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckCycle</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> buildingConfig = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BuildingConfig() { Type = BuildingType.Smeltery, ModulesLimit = <span class="hljs-number"><span class="hljs-number">1</span></span>, AvailableModules = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> [] { ModuleType.Furnace } }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> moduleConfig = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModuleConfig() { Type = ModuleType.Furnace, ConstructionTime = <span class="hljs-number"><span class="hljs-number">2</span></span>, ConstructionCost = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;ResourceType, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;() { { ResourceType.Metal, <span class="hljs-number"><span class="hljs-number">10</span></span> } }, CycleTime = <span class="hljs-number"><span class="hljs-number">4</span></span>, CycleInput = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;ResourceType, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;() { { ResourceType.Ore, <span class="hljs-number"><span class="hljs-number">10</span></span> }, { ResourceType.Energy, <span class="hljs-number"><span class="hljs-number">5</span></span> } }, CycleOutput = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;ResourceType, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;() { { ResourceType.Metal, <span class="hljs-number"><span class="hljs-number">1</span></span> } } }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> core = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Core(); core.Bank.Change(ResourceType.Metal, <span class="hljs-number"><span class="hljs-number">10</span></span>); core.Bank.Change(ResourceType.Ore, <span class="hljs-number"><span class="hljs-number">80</span></span>); core.Bank.Change(ResourceType.Energy, <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> building = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Building(buildingConfig); core.Ship.GetRoom(<span class="hljs-number"><span class="hljs-number">0</span></span>).Building = building; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> module = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Module(moduleConfig); Assert.IsTrue( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModuleConstruct(building, module, <span class="hljs-number"><span class="hljs-number">0</span></span>) .Execute(core) .IsValid ); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NextTurn().Execute(core); Assert.IsFalse(module.Cycle.IsRunning); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NextTurn().Execute(core); Assert.IsTrue(module.Constructible.IsReady); Assert.IsFalse(module.Cycle.IsRunning); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NextTurn().Execute(core); Assert.IsTrue(module.Cycle.IsRunning); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">1</span></span>, module.Cycle.Progress); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">70</span></span>, core.Bank.Get(ResourceType.Ore)); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">5</span></span>, core.Bank.Get(ResourceType.Energy)); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, core.Bank.Get(ResourceType.Metal)); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NextTurnCount(<span class="hljs-number"><span class="hljs-number">3</span></span>).Execute(core); Assert.IsFalse(module.Cycle.IsRunning); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">70</span></span>, core.Bank.Get(ResourceType.Ore)); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">5</span></span>, core.Bank.Get(ResourceType.Energy)); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">1</span></span>, core.Bank.Get(ResourceType.Metal)); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NextTurn().Execute(core); Assert.IsTrue(module.Cycle.IsRunning); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">60</span></span>, core.Bank.Get(ResourceType.Ore)); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, core.Bank.Get(ResourceType.Energy)); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">1</span></span>, core.Bank.Get(ResourceType.Metal)); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NextTurnCount(<span class="hljs-number"><span class="hljs-number">3</span></span>).Execute(core); Assert.IsFalse(module.Cycle.IsRunning); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">2</span></span>, core.Bank.Get(ResourceType.Metal)); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NextTurn().Execute(core); <span class="hljs-comment"><span class="hljs-comment">// Cant launch because of Energy leak Assert.IsFalse(module.Cycle.IsRunning); Assert.AreEqual(60, core.Bank.Get(ResourceType.Ore)); Assert.AreEqual(0, core.Bank.Get(ResourceType.Energy)); } }</span></span></code> </pre></blockquote><br><img src="https://habrastorage.org/files/c07/184/3a0/c071843a00c04b3bb2ea15d5648b4475.png"><br><br><h2>  the end </h2><br>  So, the tests started correctly and we were able to make the minimum version of our product.  The Factory class has turned out to be bloated, but if you make the settings in JSON, then it will be quite nothing.  Using Json.NET we need to write something like this: <br><br><div class="spoiler">  <b class="spoiler_title">JSON Settings</b> <div class="spoiler_text"><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> files = Directory.GetFiles(path + <span class="hljs-string"><span class="hljs-string">"/Items/Modules"</span></span>, <span class="hljs-string"><span class="hljs-string">"*.json"</span></span>, SearchOption.AllDirectories); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> modules = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;ModuleConfig&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> file <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> modules) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> content = File.ReadAllText(file); modules.Add( JsonConvert.DeserializeObject&lt;ModuleConfig&gt;(content) ); }</code> </pre><br><br><pre> <code class="hljs objectivec">{ <span class="hljs-string"><span class="hljs-string">"Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"Generator"</span></span>, <span class="hljs-string"><span class="hljs-string">"ConstructionTime"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"ConstructionCost"</span></span>: { <span class="hljs-string"><span class="hljs-string">"Metal"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> }, <span class="hljs-string"><span class="hljs-string">"CycleTime"</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-string"><span class="hljs-string">"CycleInput"</span></span>: { <span class="hljs-string"><span class="hljs-string">"Energy"</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-string"><span class="hljs-string">"Ore"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, }, <span class="hljs-string"><span class="hljs-string">"CycleOutput"</span></span>: { <span class="hljs-string"><span class="hljs-string">"Energy"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> } }</code> </pre></blockquote><br></div></div><br>  For those who just love the code - there is a <a href="https://github.com/theshock/GameLogicArticle">separate repository on GitHub.</a> <br><br>  In addition, if you are interested in questions on the development of SpaceLab - ask, I will answer them in the comments or in a separate article <br><br>  Download for Windows, Linux, Mac for free and without SMS, as well as you can support us on <a href="http://steamcommunity.com/sharedfiles/filedetails/%3Fid%3D868755125">the SpaceLab page at GreenLight</a> </div><p>Source: <a href="https://habr.com/ru/post/322268/">https://habr.com/ru/post/322268/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../322254/index.html">Examples of how partners lose money when collaborating with CPA networks</a></li>
<li><a href="../322256/index.html">Why Kotlin sucks</a></li>
<li><a href="../322258/index.html">We write game logic in C #. Part 1/2</a></li>
<li><a href="../322262/index.html">Mustached shooter of twenty-three polygons</a></li>
<li><a href="../322266/index.html">Tarantool: load testing</a></li>
<li><a href="../322270/index.html">In defense, Zuckerberg takes Evan Spiegel "by the throat"</a></li>
<li><a href="../322272/index.html">How to wind 40k views on Habrahabr. Bug or feature?</a></li>
<li><a href="../322274/index.html">Business rule repositories and corresponding code blocks that are embedded in production</a></li>
<li><a href="../322276/index.html">Myths about the CAP theorem</a></li>
<li><a href="../322278/index.html">Web interface for your Asterisk. Statistics for call-centers, sales departments, listening to calls and much more</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>