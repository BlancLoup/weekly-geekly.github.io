<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Contributing to PostgreSQL: examples of real patches, part 1 of N</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Earlier in the article Becoming a Contributor in PostgreSQL, the PostgreSQL development process and the tools used were discussed in detail, some idea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Contributing to PostgreSQL: examples of real patches, part 1 of N</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/c0a/2b3/b47/c0a2b3b47dbe4bce8a31b7aa10980f6e.png"><br><br>  Earlier in the article <a href="https://habrahabr.ru/company/postgrespro/blog/308442/">Becoming a Contributor in PostgreSQL, the PostgreSQL</a> development process and the tools used were discussed in detail, some ideas for the first patch were proposed, and it was told where and how these patches should be sent.  Reference was also made to additional sources of information regarding the internal structure of the RDBMS. <br><br>  Now we look at examples of real patches taken in PostgreSQL lately.  Some of these patches were written directly by me, and I actively participated in the development of others as a reviewer.  These are relatively small patches.  At the time of this writing, I have been developing PostgreSQL for less than a year, and I have not been involved in developing a database before (exactly like developing in C for money).  Therefore, there is reason to believe that these patches will be of interest to beginners who want to start participating in the development of open source projects, and not necessarily PostgreSQL.  In order not to write longridov, the article is divided into parts. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Interested please follow under cat. <a name="habracut"></a><br><br><h3>  1. Delete duplicate code in ReorderBufferCleanupTXN () </h3><br>  I like to go through the PostgreSQL code from time to time with <a href="https://eax.me/c-static-analysis/">different static analyzers</a> , especially the Clang Static Analyzer.  Often these analyzers swear at some dubious nonsense, but in the midst of this nonsense you can sometimes find really very suspicious pieces of code.  One of these pieces looked like this: <br><br><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/* delete from list of known subxacts */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (txn-&gt;is_known_as_subxact) { <span class="hljs-comment"><span class="hljs-comment">/* NB: nsubxacts count of parent will be too high now */</span></span> dlist_delete(&amp;txn-&gt;node); } <span class="hljs-comment"><span class="hljs-comment">/* delete from LSN ordered list of toplevel TXNs */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dlist_delete(&amp;txn-&gt;node); }</code> </pre> <br>  Agree, it is rather strange to do the same in the if and else blocks.  After a short discussion of this problem in the mailing list and just one patch rewrite, the code turned into: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Remove TXN from its containing list. * * Note: if txn-&gt;is_known_as_subxact, we are deleting the TXN from its * parent's list of known subxacts; this leaves the parent's nsubxacts * count too high, but we don't care. Otherwise, we are deleting the TXN * from the LSN-ordered list of toplevel TXNs. */</span></span> dlist_delete(&amp;txn-&gt;node);</code> </pre><br>  Discussion: <a href="https://www.postgresql.org/message-id/flat/20160404190345.54d84ee8%40fujitsu">20160404190345.54d84ee8@fujitsu</a> <br>  Commit: <a href="https://git.postgresql.org/gitweb/%3Fp%3Dpostgresql.git%3Ba%3Dcommitdiff%3Bh%3Db6182081be4a795d70b966be2542ad32d1ffbc20%3Bhp%3Dc7f68bea22bf680a4eab4b8b1592b3c90bc634ac">b6182081be4a795d70b966be2542ad32d1ffbc20</a> <br><br><h3>  2. Fix double variable initialization </h3><br>  Honestly, I don‚Äôt remember whether this problem was found by the eyes or by a static analyzer.  In several places, code in the style was found: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *qual_value; ParseState *qual_pstate = make_parsestate(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* parsestate is built just to build the range table */</span></span> qual_pstate = make_parsestate(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>);</code> </pre><br>  As you can see, the variable is initialized twice, only in vain warming the processor.  The patch was accepted instantly without any questions. <br><br>  Discussion: <a href="https://www.postgresql.org/message-id/flat/20160316112019.64057481%2540fujitsu">20160316112019.64057481@fujitsu</a> <br>  Commit: <a href="https://git.postgresql.org/gitweb/%3Fp%3Dpostgresql.git%3Ba%3Dcommitdiff%3Bh%3Dbd0ab28912d7502b237b8aeb95d052abe4ff6bc6%3Bhp%3Dc27033ff7c17b5100d02c454a0eebb95ec7b91cc">bd0ab28912d7502b237b8aeb95d052abe4ff6bc6</a> <br><br><h3>  3. Correction of typos in the comments </h3><br>  In any large enough project there is a fair amount of typos.  Finding them is easy by turning on spell checking in your IDE or text editor.  I personally <a href="https://eax.me/vim-commands/">write code in Vim</a> .  To check the spelling in ~ / .vimrc, I have the lines: <br><br><pre> <code class="hljs bash"><span class="hljs-built_in"><span class="hljs-built_in">command</span></span>! SpellOn :<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> spell spelllang=en_us,ru_ru <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>! SpellOff :<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> nospell</code> </pre><br>  If anyone is interested, then the full version of my ~ / .vimrc, exactly like all the other configuration files, is <a href="https://github.com/afiskon/freebsd-on-desktop-v2/tree/master/home/eax">available here</a> . <br><br>  Often, typos appear because the committers rewrite them a little, very little, before accepting patches.  The result is a completely new code that no one has read before.  You can send several patches every week just by carefully reading out new commits and finding typos in them! <br><br>  Discussion: <i>(something can not be found)</i> <br>  Commit: <a href="https://git.postgresql.org/gitweb/%3Fp%3Dpostgresql.git%3Ba%3Dcommitdiff%3Bh%3D2d8a1e22b109680204cb015a30e5a733a233ed64%3Bhp%3Daa698d753566f68bdd54881d30b1a515b0327b0e">2d8a1e22b109680204cb015a30e5a733a233ed64</a> <br><br><h3>  4. Correction of two identical comments </h3><br>  In addition to typos in the comments, there are other types of errors.  For example, as a result of the <a href="https://git.postgresql.org/gitweb/%3Fp%3Dpostgresql.git%26a%3Dcommitdiff%26h%3Db6fb6471f6afaf649e52f38269fd8c5c60647669">b6fb6471 commit</a> , this piece of code was added: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/*----------- * pgstat_progress_update_param() - * * Update index'th member in st_progress_param[] of own backend entry. *----------- */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pgstat_progress_update_param</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index, int64 val)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> PgBackendStatus *beentry = MyBEEntry; Assert(index &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; index &lt; PGSTAT_NUM_PROGRESS_PARAM); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!beentry || !pgstat_track_activities) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; pgstat_increment_changecount_before(beentry); beentry-&gt;st_progress_param[index] = val; pgstat_increment_changecount_after(beentry); } <span class="hljs-comment"><span class="hljs-comment">/*----------- * pgstat_progress_end_command() - * * Update index'th member in st_progress_param[] of own backend entry. *----------- */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pgstat_progress_end_command</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{</code> </pre><br>  It can be noted that two different procedures have a completely identical description, which is clearly some kind of a jamb. <br><br>  Discussion: <a href="https://www.postgresql.org/message-id/flat/20160310120506.5007ea28%2540fujitsu">20160310120506.5007ea28@fujitsu</a> <br>  Commit: <a href="https://git.postgresql.org/gitweb/%3Fp%3Dpostgresql.git%3Ba%3Dcommitdiff%3Bh%3D090b287fc59e7a44da8c3e0823eecdc8ea4522f2%3Bhp%3Dcc402116ca156babcd3ef941317f462a96277e3a">090b287fc59e7a44da8c3e0823eecdc8ea4522f2</a> <br><br><h3>  5. Vorning when compiling on FreeBSD </h3><br>  Most PostgreSQL developers are running MacOS and Linux.  Therefore, it is useful to try to build a project on an exotic type of Microsoft Windows :) or FreeBSD.  Using this technique, for example, I managed to find out that PostgreSQL on FreeBSD is going with the following warning signals: <br><br><pre> <code class="hljs pgsql">pg_locale.c:<span class="hljs-number"><span class="hljs-number">1290</span></span>:<span class="hljs-number"><span class="hljs-number">12</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">warning</span></span>: implicit declaration <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-string"><span class="hljs-string">'wcstombs_l'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> invalid <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> C99 [-Wimplicit-<span class="hljs-keyword"><span class="hljs-keyword">function</span></span>-declaration] result = wcstombs_l(<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>, tolen, locale); pg_locale.c:<span class="hljs-number"><span class="hljs-number">1365</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">warning</span></span>: implicit declaration <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-string"><span class="hljs-string">'mbstowcs_l'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> invalid <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> C99 [-Wimplicit-<span class="hljs-keyword"><span class="hljs-keyword">function</span></span>-declaration] result = mbstowcs_l(<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>, str, tolen, locale); <span class="hljs-number"><span class="hljs-number">2</span></span> warnings <span class="hljs-keyword"><span class="hljs-keyword">generated</span></span>.</code> </pre> <br>  It was not too difficult to fix this problem, although it required you to <a href="https://eax.me/autotools/">tinker with Autotools</a> , which, in my experience, is usually not a very pleasant experience. <br><br>  Discussion: <a href="https://www.postgresql.org/message-id/flat/20160310163632.53d8e2cc%2540fujitsu">20160310163632.53d8e2cc@fujitsu</a> <br>  Commit: <a href="https://git.postgresql.org/gitweb/%3Fp%3Dpostgresql.git%3Ba%3Dcommitdiff%3Bh%3D0e9b89986b7ced6daffdf14638a25a35c45423ff%3Bhp%3D101fd9349eddb7e9ed84a239145d5230a9bc7336">0e9b89986b7ced6daffdf14638a25a35c45423ff</a> <br><br><h3>  To be continued... </h3><br>  As you see, in order to start contributing to PostgreSQL, you do not need a deep knowledge of relational database devices or ten years of C programming experience. By and large, anyone can become a contributor, in theory, even if they cannot program at all.  In this part, the most trivial patches were considered.  Next time we will look at patches more interestingly, solving the problem of lock contention, reducing the complexity of the algorithm from O (N) to O (1), implementing the bypass of binary trees, repairing resource leaks, and not only. <br><br>  As always, I will be glad to any of your comments and questions! <br><br>  Continued: <a href="https://habrahabr.ru/company/postgrespro/blog/310372/">Examples of real patches in PostgreSQL: part 2 of N</a> </div><p>Source: <a href="https://habr.com/ru/post/309488/">https://habr.com/ru/post/309488/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309476/index.html">Trends DDOS attacks 2015-2016</a></li>
<li><a href="../309478/index.html">Tips and tricks for working with Unity3D</a></li>
<li><a href="../309480/index.html">ExcelArt - isometry "for free". Draw a pseudo-volume phone without 3D and Photoshop</a></li>
<li><a href="../309484/index.html">OpenBSD Songs</a></li>
<li><a href="../309486/index.html">Optimizing multicast traffic on a local network using IGMP snooping</a></li>
<li><a href="../309490/index.html">PostgreSQL integration with MS SQL Server</a></li>
<li><a href="../309492/index.html">How to make a web-studio effective and start earning? 15 steps from WebCanape</a></li>
<li><a href="../309496/index.html">ASP.NET MVC + VM: splitting complex views into simple ones using view models using the example of an event calendar</a></li>
<li><a href="../309500/index.html">We invite developers to Droidcon Moscow 2016</a></li>
<li><a href="../309502/index.html">Spherical testing in vacuum: How to eat, how it should be, how it will be</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>