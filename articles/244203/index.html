<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Construction of parallel curves in web mapping applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the course of working on a web map within the project, the task of displaying metro lines on a map arose. It would seem that in this difficult? In ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Construction of parallel curves in web mapping applications</h1><div class="post__text post__text-html js-mediator-article">  In the course of working on a web map within the project, the task of displaying metro lines on a map arose.  It would seem that in this difficult?  In fact - nothing, as long as you do not need to visualize the various routes, physically passing through one place.  We encountered such a situation while trying to display the Amsterdam metro lines. <br><br><img src="https://habrastorage.org/files/044/ff8/5d7/044ff85d733048ae92f406b038f9dd2c.png"><br><a name="habracut"></a><br>  The first thought that comes to mind is simply to duplicate those segments along which several routes pass, slightly shifting them relative to each other, changing the geographical coordinates.  However, as a result of such an action, we get lines that merge with each other on small scales, and on large ones, on the contrary, fly apart in different directions, that is, looking at a similar map, it is impossible to understand that these routes physically pass in one place. <br><br>  A more correct way is that the shift of lines relative to each other should be specified in pixels, taking into account the thickness of the lines.  An approximate procedure should be as follows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  When changing the scale level, we determine the pixel coordinates of the base segment; </li><li>  We calculate the increment of the next segment in pixels: if you want the second line to be displayed close to the first without gaps, then the offset should be equal to the line thickness (we assume that all segments have the same width); </li><li>  Calculate the coordinates of the new segment, taking into account the increment; </li><li>  Draw the resulting segment on the map. </li></ol><br>  If more than 2 routes go through the same place, then it makes sense to use negative increments along with positive ones to evenly position the segments in both directions relative to the real route. <br><br>  The calculation of the coordinates of a segment that is shifted relative to the baseline by a certain distance is essentially the task of finding a <a href="https://en.wikipedia.org/wiki/Parallel_curve">parallel curve</a> . <br><br>  Since the Leaflet cartographic library is used in the web map of the Metro for All project, it was decided to try to find some plug-in to build parallel curves.  And such a plugin was found - <a href="https://github.com/bbecquet/Leaflet.PolylineOffset">Leaflet.PolylineOffset</a> , <a href="http://bbecquet.github.io/Leaflet.PolylineOffset/examples/example_bus.html">an example</a> . <br><br>  On a test dataset, everything looks pretty good.  However, when trying to draw real data (metro lines), a number of unacceptable artifacts appeared (line overshoots, disappearing lines at certain scale levels), and therefore an attempt was made to search for an alternative way to find parallel curves. <br><br>  It is worth noting that during the writing of this article, the commit <a href="https://github.com/bbecquet/Leaflet.PolylineOffset/commit/e2166fa"># e2166fa</a> was added to the <a href="https://github.com/bbecquet/Leaflet.PolylineOffset/commit/e2166fa">Leaflet.PolylineOffset code</a> , eliminating most of the above artifacts.  However, <a href="https://github.com/bbecquet/Leaflet.PolylineOffset/issues/1">problems</a> with the display of segments on a small scale remained. <br><br><img src="https://habrastorage.org/files/a48/13f/5d8/a4813f5d88ea487095134f0bd27d39aa.png"><br>  <i>Artifacts when using the Leaflet.PolylineOffset plugin</i> <br><br>  If you look at the code Leaflet.PolylineOffset, it becomes clear that this is a lightweight plugin that implements including all the mathematics for calculating parallel curves.  However, finding parallel curves is not at all a trivial task; moreover, there is no such function even in the <a href="http://tsusiatsoftware.net/jts/main.html">JTS Topology Suite</a> .  This is what one of the main developers of JTS Topology Suite, <a href="http://lin-ear-th-inking.blogspot.ru/2010/11/single-sided-buffers-in-jts.html%3FshowComment%3D1290195359882">Martin Davis,</a> says about this: <br><br><blockquote>  In fact, it was a tricky to implement goal.  I'm still thinking about doing offset lines, though. </blockquote><br><br>  Therefore, there is every reason not to trust the algorithm that is used in Leaflet.PolylineOffset. <br><br>  <b>For your information</b> : the implementation of the function for finding parallel curves is available in the <a href="http://trac.osgeo.org/geos/">GEOS</a> library, <a href="">code</a> . <br><br>  One of the most well-known and functional libraries in JavaScript, designed to perform all sorts of spatial operations on objects in a two-dimensional space - <a href="https://github.com/bjornharrtell/jsts">JSTS Topology Suite</a> .  This is the JavaScript port of the JTS Topology Suite library mentioned above.  However, as already noted, the JTS Topology Suite does not have a function for constructing parallel curves; therefore, it is not found in the JSTS Topology Suite.  One could, of course, understand the algorithm implemented in GEOS and transfer it to JavaScript using the appropriate functions of the JSTS Topology Suite, but we will consider another option that is not so precise, but as practice has shown, it is quite enough to solve a specific problem: visualize various routes that physically pass through the same place, without tangible artifacts.  Not the fact that the algorithm described below will be acceptable to work with another data set, but all the same - there will be at least some starting point. <br><br>  In JSTS Topology Suite there is the possibility of building a one-way buffer (in one direction or another, depending on the sign).  An example of building a one-way buffer (blue line - the outer ring of the constructed polygon, green - the original line): <br><br><img src="https://habrastorage.org/files/0d1/97e/454/0d197e4543484d81819a0810793d0560.png"><br>  <i>Unilateral buffer</i> <br><br>  Also in the JSTS Topology Suite there is the possibility of constructing a ‚Äúraw‚Äù parallel curve (allowing self-intersection).  An example of constructing such a curve (the black line is the ‚Äúraw‚Äù curve, the red dots are its nodes): <br><br><img src="https://habrastorage.org/files/f54/ab5/cb2/f54ab5cb21f84a1e96bd64c6e40aacee.png"><br>  <i>"Raw" parallel curve</i> <br><br>  The final parallel curve (blue) will be recruited from the nodes of the "raw" curve relating to the outer ring of the one-way buffer: <br><br><img src="https://habrastorage.org/files/c9b/67e/5fe/c9b67e5fec2c47adbaf1c8447235aa3a.png"><br>  <i>Total parallel curve</i> <br><br>  The code of the resulting function to calculate a parallel curve: <br><br><pre><code class="javascript hljs">offsetPoints: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pts, offset</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> offsetPolyline, ls = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> jsts.geom.LineString(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pointsToJSTSCoordinates(pts)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (offset != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Parameters which describe how a buffer should be constructed var bufferParameters = new jsts.operation.buffer.BufferParameters(); // Sets whether the computed buffer should be single-sided bufferParameters.setSingleSided(true); var precisionModel = new jsts.geom.PrecisionModel(); var offsetCurveBuilder = new jsts.operation.buffer.OffsetCurveBuilder(precisionModel, bufferParameters); var offsetCurve = offsetCurveBuilder.getOffsetCurve(ls.points, offset); var offsetBuffer = jsts.operation.buffer.BufferOp.bufferOp2(ls, offset, bufferParameters); var offsetPointsList = []; for (var i=0, l=offsetCurve.length; i&lt;l; i++) { var offsetCurveNode = new jsts.geom.Point(offsetCurve[i]); if (offsetBuffer.touches(offsetCurveNode)) { var offsetPoint = offsetCurve[i]; if (!(isNaN(offsetPoint.x) || isNaN(offsetPoint.y))) { offsetPointsList.push(offsetPoint); } } } offsetPolyline = offsetPointsList; } else { offsetPolyline = ls.points; } return this.JSTSCoordinatesToPoints(offsetPolyline); }</span></span></code> </pre> <br><br>  The code of the entire module of the module can be taken on <a href="https://github.com/drnextgis/Leaflet.PolylineOffset">github</a> .  To clone it yourself, run the command: <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> --recursive git@github.com:drnextgis/Leaflet.PolylineOffset.git</code> </pre><br><br>  There are also examples of use. <br><br>  As a result, we obtained a result that also contains small artifacts at a certain scale level, but not in the same amount as Leaflet.PolylineOffset.  No departures and disappearances of the lines are observed. <br><br><img src="//habrastorage.org/files/4ef/2be/cb9/4ef2becb9bf64de39fca420a65d75caf.png"><br>  <i>Result</i> </div><p>Source: <a href="https://habr.com/ru/post/244203/">https://habr.com/ru/post/244203/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../244177/index.html">Responsive images in practice (Part 2)</a></li>
<li><a href="../244179/index.html">Beta new 2GIS for your computer</a></li>
<li><a href="../244191/index.html">Adobe fixed critical flash player vulnerability</a></li>
<li><a href="../244193/index.html">How to find love or adventure with crate.io and kibana</a></li>
<li><a href="../244195/index.html">14 effective tips for content marketing for small businesses (part 1)</a></li>
<li><a href="../244207/index.html">Fixed table style or Fixed Table Layouts</a></li>
<li><a href="../244209/index.html">Creating an AngularJS application using Firebase</a></li>
<li><a href="../244211/index.html">Wicket + lambda: a type-safe and concise implementation of IModel</a></li>
<li><a href="../244213/index.html">VoCore firmware update: UART</a></li>
<li><a href="../244215/index.html">How support for message formatting makes the messenger better</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>