<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Custom Action in WiX</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Custom Actions is one of the most important elements in WiX , allowing you to perform any actions in the process of installing or removing a program t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Custom Action in WiX</h1><div class="post__text post__text-html js-mediator-article">  <b>Custom Actions is</b> one of the most important elements in <b>WiX</b> , allowing you to perform any actions in the process of installing or removing a program that expands the capabilities of WiX.  With the help of Custom Action, we can connect to our installer VBScript, JScript, Dll library, executable module and perform any actions in the process of the installer. <br><br>  Consider an example - during the installation of the program we need to specify the path to the file on the local computer, let's say the license file. <br><a name="habracut"></a><br>  To begin with, we will create a project, add a window with a choice of the license file (so that the article is not filled with unnecessary code, I will only give you important code fragments in my opinion. You can download and view the sources of the project at the end of the article). <br><br>  I created a project, excluded unnecessary windows from the installation process, added a new window in which the file was selected.  As a result, the installer will contain the following windows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>1. Greetings</b> <br><br>  <b>2. Select license file</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/ca8/ef6/aa3/ca8ef6aa3094dddcbb8bc6c4928b63c2.gif"><br><br>  <b>3. Starting installation</b> <br><br>  <b>4. End of installation</b> <br><br>  The project includes the following files: <br><ul><li>  <b>Product.wxs</b> product description </li><li>  <b>Features.wxs</b> installation options </li><li>  <b>Files.wxs</b> installable files </li><li>  <b>Variables.wxi</b> variables </li><li>  <b>AddRemove.wxi</b> parameters affecting the product display in the <i>Add / Remove Programs</i> panel </li><li>  <b>WixUI_License.wxs</b> window with selection of license file </li><li>  <b>WixUI_Wizard.wxs</b> description of installation wizard steps </li></ul><br>  Let's add the <i>Custom Action</i> to our project, for this we will add the <b>CustomAction.wxs</b> file to the project <b>.</b> <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;?</font> <font color="#800000">xml</font> <font color="#ff0000">version</font> <font color="#0000ff">="1.0"</font> <font color="#ff0000">encoding</font> <font color="#0000ff">="UTF-8"</font> ? <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Wix</font> <font color="#ff0000">xmlns</font> <font color="#0000ff">="http://schemas.microsoft.com/wix/2006/wi"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Fragment</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Binary</font> <font color="#ff0000">Id</font> <font color="#0000ff">="BinBrowseForFile"</font> <br> <font color="#ff0000">SourceFile</font> <font color="#0000ff">="BrowseForFile.vbs"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">CustomAction</font> <font color="#ff0000">Id</font> <font color="#0000ff">='BrowseForFile'</font> <br> <font color="#ff0000">BinaryKey</font> <font color="#0000ff">="BinBrowseForFile"</font> <br> <font color="#ff0000">VBScriptCall</font> <font color="#0000ff">="CallTheAction"</font> <br> <font color="#ff0000">Return</font> <font color="#0000ff">="check"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">Fragment</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">Wix</font> <font color="#0000ff">&gt;</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  With the help of the <i>Binary</i> element, we can add files to our project that will not be installed on the target computer, but will participate in the process of the installer.  The <i>SourceFile</i> parameter specifies the path to the file, in this case, <i>BrowseForFile.vbs</i> . <br><br>  The <i>CustomAction</i> element describes some action performed by a script, a dynamic library, which we can perform during the installation / uninstall process.  Consider its parameters: <br><br>  <b>BinaryKey</b> is a reference to the <i>Binary</i> element. <br>  <b>VBScriptCall</b> sets the name of the VBScript function to call. <br>  <b>Return</b> in this case, <i>check</i> , indicates that the script will be called synchronously, and the returned value will be checked for success.  The <i>check</i> value is the default value. <br><br>  Other possible values ‚Äã‚Äãfor <i>Return</i> : <br>  <b>asyncNoWait</b> is an asynchronous call, the installer will not wait until the end of execution, which may occur even after the installer has completed.  It can be useful when we want to run our program after the installation process is complete. <br>  <b>asyncWait</b> is an asynchronous call, but, unlike the previous one, the installer will wait for completion. <br>  <b>Ignore</b> is the same as <i>check</i> , but without checking the result. <br><br>  The <i>CustomAction</i> element has a lot of other parameters, which list does not make sense here, a full description of the <i>CustomAction</i> element.  You can find it <a href="http://wix.sourceforge.net/manual-wix2/wix_xsd_customaction.htm">here</a> . <br><br>  Understood, go to the contents of the file <b>BrowseForFile.vbs</b> <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">Function</font> CallTheAction <br> <font color="#0000ff">Set</font> objDialog = CreateObject( <font color="#A31515">"UserAccounts.CommonDialog"</font> ) <br> objDialog.Filter = <font color="#A31515">" |*.txt| |*.*"</font> <br> objDialog.FilterIndex = 1 <br> objDialog.InitialDir = <font color="#A31515">"C:\"</font> <br> <br> <font color="#0000ff">Dim</font> intResult : intResult = objDialog.ShowOpen <br> <br> <font color="#0000ff">If</font> intResult = 0 <font color="#0000ff">Then</font> <br> CallTheAction = msiDoActionStatusUserExit <br> <font color="#0000ff">Exit</font> <font color="#0000ff">Function</font> <br> <font color="#0000ff">End</font> <font color="#0000ff">If</font> <br> <br> Session. <font color="#0000ff">Property</font> ( <font color="#A31515">"LICENSE_FILE_PATH"</font> ) = objDialog.FileName <br> CallTheAction = msiDoActionStatusSuccess <br> <font color="#0000ff">End</font> Function</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  This script displays a file selection dialog and returns the result.  If the user specifies a file and clicks the <i>Open</i> button, the script will return the path to the file by setting the value of the <i>LICENSE_FILE_PATH</i> variable defined in the <b>Product.wxs</b> file <br><br><blockquote> <code><font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">Property</font> <font color="#ff0000">Id</font> <font color="#0000ff">="LICENSE_FILE_PATH"</font> <font color="#0000ff">&gt;</font> C:\ <font color="#0000ff">&lt;/</font> <font color="#800000">Property</font> <font color="#0000ff">&gt;</font></font></code> </blockquote> <br>  For the <i>CustomAction</i> call, we will have the <i>Browse</i> button, defined in the <b>WixUI_License.wxs</b> file <b>.</b> <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">Control</font> <font color="#ff0000">Id</font> <font color="#0000ff">="ButtonBrowse"</font> <br> <font color="#ff0000">Type</font> <font color="#0000ff">="PushButton"</font> <br> ... <br> <font color="#ff0000">Text</font> <font color="#0000ff">=""</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Publish</font> <font color="#ff0000">Event</font> <font color="#0000ff">="DoAction"</font> <font color="#ff0000">Value</font> <font color="#0000ff">="BrowseForFile"</font> <font color="#ff0000">Order</font> <font color="#0000ff">="1"</font> <font color="#0000ff">&gt;</font> 1 <font color="#0000ff">&lt;/</font> <font color="#800000">Publish</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">Control</font> <font color="#0000ff">&gt;</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  The <i>Publish</i> element, in this case, is responsible for the reaction for pressing the button.  The value of the <i>Event</i> (DoAction) parameter indicates the need to call <i>CustomAction</i> with the identifier specified in the <i>Value</i> parameter (BrowseForFile). <br><br>  Now we need to output the value of the <i>LICENSE_FILE_PATH</i> variable that stores the path to our file.  The display will deal with the text field: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">Control</font> <font color="#ff0000">Id</font> <font color="#0000ff">="TextLicensePath"</font> <br> <font color="#ff0000">Type</font> <font color="#0000ff">="Edit"</font> <br> ... <br> <font color="#ff0000">Property</font> <font color="#0000ff">="LICENSE_FILE_PATH"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">Control</font> <font color="#0000ff">&gt;</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  If we now assemble and run the installer, then after clicking the <i>Browse</i> button and selecting a file, we will see that our text field is not updated. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/17f/60c/79b/17f60c79bb5480bc49d4901a57732467.gif"><br><br>  In order to understand the cause of the problem, click the <i>Back</i> button, then <i>Next</i> , the field has been updated.  Again, select the file and ‚Äúcover‚Äù our window with another window, then return it.  The field has been updated again.  Yeah, so we did everything right, and the problem is that the UI does not update the field contents when the <i>Property</i> changes.  What to do? <br><br>  One option is to create a duplicate <b>LicenseDlg</b> window and switch between these windows when you click the <i>Browse</i> button.  The implementation is simple.  Create a copy of the file <b>WixUI_License.wxs</b> , call it, for example, <b>WixUI_License2.wxs</b> .  Rename the <b>LicenseDlg</b> dialog to <b>LicenseDlg2</b> .  In the script wizard add: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">Publish</font> <font color="#ff0000">Dialog</font> <font color="#0000ff">="LicenseDlg2"</font> <font color="#ff0000">Control</font> <font color="#0000ff">="Back"</font> <font color="#ff0000">Event</font> <font color="#0000ff">="NewDialog"</font> <font color="#ff0000">Value</font> <font color="#0000ff">="WelcomeDlg"</font> <font color="#0000ff">&gt;</font> 1 <font color="#0000ff">&lt;/</font> <font color="#800000">Publish</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Publish</font> <font color="#ff0000">Dialog</font> <font color="#0000ff">="LicenseDlg2"</font> <font color="#ff0000">Control</font> <font color="#0000ff">="Next"</font> <font color="#ff0000">Event</font> <font color="#0000ff">="NewDialog"</font> <font color="#ff0000">Value</font> <font color="#0000ff">="VerifyReadyDlg"</font> <font color="#0000ff">&gt;</font> 1 <font color="#0000ff">&lt;/</font> <font color="#800000">Publish</font> <font color="#0000ff">&gt;</font> <br> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Publish</font> <font color="#ff0000">Dialog</font> <font color="#0000ff">="LicenseDlg"</font> <font color="#ff0000">Control</font> <font color="#0000ff">="ButtonBrowse"</font> <font color="#ff0000">Event</font> <font color="#0000ff">="NewDialog"</font> <font color="#ff0000">Value</font> <font color="#0000ff">="LicenseDlg2"</font> <font color="#0000ff">&gt;</font> 1 <font color="#0000ff">&lt;/</font> <font color="#800000">Publish</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Publish</font> <font color="#ff0000">Dialog</font> <font color="#0000ff">="LicenseDlg2"</font> <font color="#ff0000">Control</font> <font color="#0000ff">="ButtonBrowse"</font> <font color="#ff0000">Event</font> <font color="#0000ff">="NewDialog"</font> <font color="#ff0000">Value</font> <font color="#0000ff">="LicenseDlg"</font> <font color="#0000ff">&gt;</font> 1 <font color="#0000ff">&lt;/</font> <font color="#800000">Publish</font> <font color="#0000ff">&gt;</font> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  The first two lines duplicate the behavior of the dialog <b>LicenseDlg</b> , the second are responsible for the transitions between duplicate windows. <br><br>  We start, check, work.  But I absolutely do not like this method.  Duplicate code, and the need to delete, copy, rename the dialogue every time you make changes to its structure. <br><br>  Now, if it were possible to somehow ‚Äútie‚Äù C ++ here, I would instantly figure out how to update the window ... But you can.  As it was already written at the beginning of the article, we can use Dll libraries as sources for <i>CustomAction</i> .  I will say more, a ready-made library with source codes, for our task, is available on the site <a href="http://www.installsite.org/pages/en/msi/ca.htm">www.installsite.org</a> . <br><br>  If you look at the sources of this library, we see that the <b>BrowseForFile</b> function takes the initial value of the file path from the <b>PATHTOFILE</b> property, displays the file selection dialog and, if successful, saves the received path value to the <b>PATHTOFILE</b> .  Then it finds the window that needs to be updated, by the name of the <i>Default</i> window <i>- the InstallShield Wizard</i> , finds in it an element with the name of the class <i>RichEdit20W</i> and sets it with the text equal to the selected path to the file. <br><br>  You can take this library, correct the search window, filter in the file selection dialog and connect to your project.  And you can, based on this code, write your own, more universal library.  In my opinion, the library should be able to accept as an input parameter a filter for the file selection dialog and correctly find the installer window. <br><br>  Let's create a library for our project.  To do this, add a new project to the project ( <i>File - Add - New Project</i> ).  Project Type <i>Win32 Project</i> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e51/2e8/06d/e512e806ddc38ddc7d143fa03ea66812.gif"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c93/8c4/4a0/c938c44a0fae87c041ca2ecb53cd95a6.gif"><br><br>  We connect to the project library <b>Msi.lib</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0ca/59b/3e6/0ca59b3e682b37aadc5f48da3017ea13.gif"><br><br>  Next, we will create a file with a description of the exported functions, we will immediately agree that ours will be called <b>BrowseForFile</b> <br><br><blockquote> <code><font color="black">LIBRARY <font color="#A31515">"BrowseForFile"</font> <br> EXPORTS <br> BrowseForFile <br></font></code> </blockquote>  There is a second, simpler way to create a Custom Action in C ++. To do this, select the new project in the window for selecting a new project. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d09/e99/5e3/d09e995e33bc8a0bfbd0f1e51855c2d8.gif"><br><br>  But for the first time it is better to create everything with your hands in order to understand how it works, and only then you can trust the creation to the master. <br><br>  Create a <b>BrowseForFile</b> function <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">UINT __stdcall BrowseForFile(MSIHANDLE hInstall) <br> { <br> <font color="#0000ff">long</font> lErrMsg = 0; <br> <br> TCHAR szOriginalPath[MAX_PATH] = {0}; <br> TCHAR szDialogFilter[MAX_PATH] = {0}; <br> TCHAR szIndex[8] = {0}; <br> <br> DWORD cchValue; <br> <br> <font color="#008000">//   BFF_PATH_TO_FILE</font> <br> cchValue = _countof(szOriginalPath); <br> MsiGetProperty(hInstall, TEXT( <font color="#A31515">"BFF_PATH_TO_FILE"</font> ), szOriginalPath, &amp;cchValue); <br> <br> <font color="#008000">//   BFF_FILE_DIALOG_FILTER</font> <br> cchValue = _countof(szDialogFilter); <br> MsiGetProperty(hInstall, TEXT( <font color="#A31515">"BFF_FILE_DIALOG_FILTER"</font> ), szDialogFilter, &amp;cchValue); <br> <br> size_t nFilterLength = wcslen(szDialogFilter); <br> <br> <font color="#0000ff">for</font> (size_t i = 0; i &lt; nFilterLength; ++i) <br> { <br> <font color="#0000ff">if</font> (szDialogFilter[i] == <font color="#A31515">'|'</font> ) <br> { <br> szDialogFilter[i] = <font color="#A31515">'\0'</font> ; <br> } <br> } <br> <br> OPENFILENAME ofn = {0}; <br> <br> <font color="#008000">//   OPENFILENAME.</font> <br> ofn.lStructSize = <font color="#0000ff">sizeof</font> (ofn); <br> ofn.hwndOwner = GetForegroundWindow(); <br> ofn.lpstrFile = szOriginalPath; <br> ofn.nMaxFile = _countof(szOriginalPath); <br> ofn.lpstrFilter = szDialogFilter; <br> ofn.nFilterIndex = 0; <br> ofn.lpstrFileTitle = NULL; <br> ofn.nMaxFileTitle = 0; <br> ofn.lpstrInitialDir = NULL; <br> <br> <font color="#0000ff">if</font> (GetOpenFileName(&amp;ofn)) <br> { <br> <font color="#008000">//   .</font> <br> MsiSetProperty(hInstall, TEXT( <font color="#A31515">"BFF_PATH_TO_FILE"</font> ), szOriginalPath); <br> } <br> <br> <font color="#0000ff">return</font> ERROR_SUCCESS; <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  At this stage, our library can do everything the same as the script did.  Add the ability to update the field.  In the example, the search was performed by the name of the window, in my opinion this is not correct.  From a project to a project, the name of the window may change, I would like to find a universal way.  Having set myself such a task, I decided to check, the first thing that came to mind - and what class do installer windows have?  Looking at the installer window information using the <b>Spy ++</b> utility (included in Visual Studio), I found that the window has the class <b>MsiDialogCloseClass</b> .  Here on it will rely.  Add the code: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//        .</font> <br> BOOL CALLBACK EnumChildProc(HWND hWnd, LPARAM lParam) <br> { <br> TCHAR szBuffer[100] = {0}; <br> <br> GetClassName(hWnd, (LPTSTR)&amp;szBuffer, _countof(szBuffer)); <br> <br> <font color="#0000ff">if</font> (_wcsicmp(szBuffer, (_T( <font color="#A31515">"RichEdit20W"</font> ))) == 0) <br> { <br> <font color="#008000">//         .</font> <br> *(HWND*)lParam = hWnd; <br> <br> <font color="#0000ff">return</font> FALSE; <br> } <br> <br> <font color="#0000ff">return</font> TRUE; <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  And in the <b>BrowseForFile</b> function, inside the condition: <br><br><blockquote> <code><font color="black"><font color="#0000ff">if</font> (GetOpenFileName(&amp;ofn))</font> <br></code> </blockquote><br>  add: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//   .</font> <br> HWND hInstallerWnd = FindWindow(_T( <font color="#A31515">"MsiDialogCloseClass"</font> ), NULL); <br> <br> <font color="#0000ff">if</font> (hInstallerWnd != NULL) <br> { <br> HWND hWndChild = NULL; <br> <br> EnumChildWindows(hInstallerWnd, EnumChildProc, (LPARAM)&amp;hWndChild); <br> <br> <font color="#0000ff">if</font> (hWndChild != NULL) <br> { <br> SendMessage(hWndChild, WM_SETTEXT, 0, (LPARAM)szOriginalPath); <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Everything is ready to use our library in the installation package.  In the file <b>Product.wxs, we will</b> declare two new properties. <br><blockquote> <code><font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">Property</font> <font color="#ff0000">Id</font> <font color="#0000ff">="BFF_PATH_TO_FILE"</font> <font color="#0000ff">&gt;&lt;/</font> <font color="#800000">Property</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Property</font> <font color="#ff0000">Id</font> <font color="#0000ff">="BFF_FILE_DIALOG_FILTER"</font> <font color="#0000ff">&gt;</font>   (*.*)|*.*|  (*.txt)|*.txt|| <font color="#0000ff">&lt;/</font> <font color="#800000">Property</font> <font color="#0000ff">&gt;</font> <br></font></code> </blockquote><br>  Through the <i>BFF_PATH_TO_FILE</i> property <i>,</i> our Dll library will ‚Äúcommunicate‚Äù with the installer. <br>  The <i>BFF_FILE_DIALOG_FILTER</i> property contains a filter for the file selection dialog. <br><br>  Let's change the description of <i>CustomAction</i> to: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">Binary</font> <font color="#ff0000">Id</font> <font color="#0000ff">="BinBrowseForFile"</font> <font color="#ff0000">SourceFile</font> <font color="#0000ff">="..\Debug\BrowseForFile.DLL"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">CustomAction</font> <font color="#ff0000">Id</font> <font color="#0000ff">="BrowseForFile"</font> <br> <font color="#ff0000">BinaryKey</font> <font color="#0000ff">="BinBrowseForFile"</font> <br> <font color="#ff0000">DllEntry</font> <font color="#0000ff">="BrowseForFile"</font> <br> <font color="#ff0000">Return</font> <font color="#0000ff">="check"</font> <font color="#0000ff">/&gt;</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  And we will add a new <i>CustomAction</i> , which will assign the <i>LICENSE_FILE_PATH</i> property we need to the value received as a result of the Dll call ( <i>BFF_PATH_TO_FILE</i> ) <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">CustomAction</font> <font color="#ff0000">Id</font> <font color="#0000ff">='AssignPathToProperty'</font> <br> <font color="#ff0000">Property</font> <font color="#0000ff">='LICENSE_FILE_PATH'</font> <br> <font color="#ff0000">Value</font> <font color="#0000ff">='[BFF_PATH_TO_FILE]'</font> <font color="#0000ff">/&gt;</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  The last thing left to do is change the code responsible for pressing the button, we will add to it a call to the new <i>CustomAction</i> <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">Control</font> <font color="#ff0000">Id</font> <font color="#0000ff">="ButtonBrowse"</font> <br> ... <br> <font color="#ff0000">Text</font> <font color="#0000ff">=""</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Publish</font> <font color="#ff0000">Event</font> <font color="#0000ff">="DoAction"</font> <font color="#ff0000">Value</font> <font color="#0000ff">="BrowseForFile"</font> <font color="#ff0000">Order</font> <font color="#0000ff">="1"</font> <font color="#0000ff">&gt;</font> 1 <font color="#0000ff">&lt;/</font> <font color="#800000">Publish</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Publish</font> <font color="#ff0000">Event</font> <font color="#0000ff">="DoAction"</font> <font color="#ff0000">Value</font> <font color="#0000ff">="AssignPathToProperty"</font> <font color="#ff0000">Order</font> <font color="#0000ff">="2"</font> <font color="#0000ff">&gt;</font> 1 <font color="#0000ff">&lt;/</font> <font color="#800000">Publish</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">Control</font> <font color="#0000ff">&gt;</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Done, you can collect and check. <br><br>  <b>Custom Action</b> can be called not only in response to any action from the user, but also automatically, in the process of the installer.  Let's look at a simple example in which we will need to create the <b>Config</b> folder in the program folder during the installation process, and delete this folder during the uninstall process (there is another way to do the same using the child <i>Directory</i> section. In this case, this method was chosen for the sake of ). <br><br>  Start by creating a folder during the installation process.  Create a new <b>CustomAction</b> : <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">CustomAction</font> <font color="#ff0000">Id</font> <font color="#0000ff">="CreateConfigFolder"</font> <font color="#ff0000">Script</font> <font color="#0000ff">="vbscript"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;!</font> [CDATA[ <br> On Error Resume Next <br> Set objFso = CreateObject("Scripting.FileSystemObject") <br> strFolderPath = Session.Property("INSTALLLOCATION") &amp; "\Config" <br> objFso.CreateFolder(strFolderPath) <br> ]] <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">CustomAction</font> <font color="#0000ff">&gt;</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  As you can see from the example, the script code can be written directly into the body of the CustomAction element, while there is no need to create the Binary element and refer to it. <br><br>  To delete a folder during the removal process: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">CustomAction</font> <font color="#ff0000">Id</font> <font color="#0000ff">="RemoveConfigFolder"</font> <font color="#ff0000">Script</font> <font color="#0000ff">="vbscript"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;!</font> [CDATA[ <br> On Error Resume Next <br> Set objFso = CreateObject("Scripting.FileSystemObject") <br> strFolderPath = Session.Property("INSTALLLOCATION") &amp; "\Config" <br> objFso.DeleteFolder(strFolderPath) <br> ]] <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">CustomAction</font> <font color="#0000ff">&gt;</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Actions are added, now someone has to call them and run.  Add the <b>following</b> code to the <b>Product.wxs</b> file: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">InstallExecuteSequence</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Custom</font> <font color="#ff0000">Action</font> <font color="#0000ff">="CreateConfigFolder"</font> <font color="#ff0000">After</font> <font color="#0000ff">="InstallFinalize"</font> <font color="#0000ff">&gt;</font> Not Installed <font color="#0000ff">&lt;/</font> <font color="#800000">Custom</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Custom</font> <font color="#ff0000">Action</font> <font color="#0000ff">="RemoveConfigFolder"</font> <font color="#ff0000">Before</font> <font color="#0000ff">="RemoveFiles"</font> <font color="#0000ff">&gt;</font> Installed <font color="#0000ff">&lt;/</font> <font color="#800000">Custom</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">InstallExecuteSequence</font> <font color="#0000ff">&gt;</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  The <i>InstallExecuteSequence</i> section allows <i>you</i> to place within yourself other partitions, which you can specify when they will be used.  In our example, the folder will be created after the <i>InstallFinalize</i> stage is <i>completed</i> (installation is completed), and the deletion is <i>done</i> before the <i>RemoveFiles</i> stage (file deletion). <br><br>  Notice that the <i>Custom</i> sections contain some text inside.  These are logical conditions that determine whether an action will be performed or not.  <b>Installed</b> is a sign that the product is already installed.  Those.  <i>CreateConfigFolder</i> will work if the product is not yet installed.  <i>RemoveConfigFolder</i> if the product is installed, i.e.  in the process of removing the program. <br><br>  That's all, I hope it was not too boring.  If you have questions, feel free to ask. <br><br>  <a href="">Project sources</a> <br>  <a href="">Binary Dll-ki with brief instructions for use</a> <br><br>  Links to previous articles: <a href="http://habrahabr.ru/blogs/development/68616/">Part 1 (getting started)</a> , <a href="http://habrahabr.ru/blogs/development/69129/">Part 2 (project organization)</a> , <a href="http://habrahabr.ru/blogs/development/70616/">Part 3 (custom windows)</a> </div><p>Source: <a href="https://habr.com/ru/post/71917/">https://habr.com/ru/post/71917/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../71906/index.html">Get the SPListItem from the SPList. Very fast and very slow</a></li>
<li><a href="../71907/index.html">Power supply repair for iBook G4 (Photo report)</a></li>
<li><a href="../71908/index.html">Neoware CA2</a></li>
<li><a href="../71909/index.html">True value of things</a></li>
<li><a href="../71912/index.html">It b ... charging!</a></li>
<li><a href="../71921/index.html">Program from SysInternals turns your PC into a virtual machine</a></li>
<li><a href="../71923/index.html">iPhone OS 3.1.2</a></li>
<li><a href="../71927/index.html">Async hearts</a></li>
<li><a href="../71928/index.html">Secretarial content management</a></li>
<li><a href="../71930/index.html">Captcha? Do not!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>