<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Zabbix + Cisco ISR: we monitor the loading of VPN tunnels via SNMP + Perl script + LLD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Task: There is a Cisco router with a bunch of configured site-to-site IPsec-VPN tunnels. You need to configure the monitoring of loading of tunnels in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Zabbix + Cisco ISR: we monitor the loading of VPN tunnels via SNMP + Perl script + LLD</h1><div class="post__text post__text-html js-mediator-article">  Task: There is a Cisco router with a bunch of configured site-to-site IPsec-VPN tunnels.  You need to configure the monitoring of loading of tunnels in Zabbix 2.0.x <br>  It is assumed that SNMP on Ziska and Zabbix is ‚Äã‚Äãalready configured. <br><br>  The main problem is that we need to monitor the SNMP OIDs with traffic counts are dynamically generated.  Moreover, the lists of these numbers are also formed dynamically. <br><a name="habracut"></a><br>  This is due to the fact that the tunnel building algorithm itself is rather complicated.  First, an ISAKMP service tunnel is formed, then a basic IPSEC tunnel for data.  You can read more about this here: <a href="http://linkmeup.ru/blog/50.html">linkmeup.ru/blog/50.html</a> (by the way, an excellent training cycle of articles by this author on the basics of configuring Cisco equipment was already on Habr√©). <br><br>  The specific algorithm for extracting the cherished traffic samples is so muddy that it seems impossible to implement it using the purely built-in Zabbix tools.  Why, even the artistic transfer did not work for me.  Let me describe from the forum <a href="http://www.networking-forum.com/viewtopic.php%3Ft%3D21010">www.networking-forum.com</a> : <br><blockquote>  these OIDs are used solely over the phase 1 tunnel.  In the case of the tunnels, you must get the index 1 ID using the endpoint address from the SNMPv2-SMI :: enterprises.9.9.171.1.2.3.1.7, then you will get the index 2 s) from SNMPv2-SMI :: enterprises.9.9.171.1.3.2.1.2, then you can use SNMPv2SMI :: enterprises.9.9.171.1.3.2.1.26 and SNMPv2-SMI :: enterprises.9.9.171.1.3.2.1.39 with the phase 2 index ID appended for the actual phase 2 traffic. <br></blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Inquisitive can pull the right OIDs handles to personally see the scale of the disaster:</b> <div class="spoiler_text"><pre><code class="bash hljs">zabbix-host:~ <span class="hljs-comment"><span class="hljs-comment"># snmpwalk -v2c -c &lt;community&gt; &lt;IP- &gt; SNMPv2-SMI::enterprises.9.9.171.1.2.3.1.7 SNMPv2-SMI::enterprises.9.9.171.1.2.3.1.7.479 = STRING: "091.092.093.094" SNMPv2-SMI::enterprises.9.9.171.1.2.3.1.7.483 = STRING: "012.013.014.015" SNMPv2-SMI::enterprises.9.9.171.1.2.3.1.7.499 = STRING: "162.163.164.165" SNMPv2-SMI::enterprises.9.9.171.1.2.3.1.7.505 = STRING: "217.218.219.220"</span></span></code> </pre> <br><br><pre> <code class="bash hljs">zabbix-host:~ <span class="hljs-comment"><span class="hljs-comment"># snmpwalk -v2c -c &lt;community&gt; &lt;IP- &gt; SNMPv2-SMI::enterprises.9.9.171.1.3.2.1.2: SNMPv2-SMI::enterprises.9.9.171.1.3.2.1.2.8830 = INTEGER: 462 SNMPv2-SMI::enterprises.9.9.171.1.3.2.1.2.8831 = INTEGER: 462 SNMPv2-SMI::enterprises.9.9.171.1.3.2.1.2.8832 = INTEGER: 462 SNMPv2-SMI::enterprises.9.9.171.1.3.2.1.2.8833 = INTEGER: 462 SNMPv2-SMI::enterprises.9.9.171.1.3.2.1.2.8834 = INTEGER: 499 SNMPv2-SMI::enterprises.9.9.171.1.3.2.1.2.8835 = INTEGER: 499 SNMPv2-SMI::enterprises.9.9.171.1.3.2.1.2.8836 = INTEGER: 499 SNMPv2-SMI::enterprises.9.9.171.1.3.2.1.2.8837 = INTEGER: 499 SNMPv2-SMI::enterprises.9.9.171.1.3.2.1.2.8838 = INTEGER: 499 SNMPv2-SMI::enterprises.9.9.171.1.3.2.1.2.8839 = INTEGER: 499 SNMPv2-SMI::enterprises.9.9.171.1.3.2.1.2.8840 = INTEGER: 499 SNMPv2-SMI::enterprises.9.9.171.1.3.2.1.2.8841 = INTEGER: 499 SNMPv2-SMI::enterprises.9.9.171.1.3.2.1.2.8842 = INTEGER: 499</span></span></code> </pre><br></div></div><br><br>  Fortunately, good people from the Cacti forum <a href="http://forums.cacti.net/about27211.html">wrote a</a> pearl-barley script that does all the dirty work by itself. <br><br>  Download the script and drop it into the ExternalScripts folder (/ usr / local / share / zabbix / externalscripts by default). <br><br><div class="spoiler">  <b class="spoiler_title">Let's play with this script manually:</b> <div class="spoiler_text"><pre> <code class="bash hljs">zabbix-host:/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/share/zabbix/externalscripts <span class="hljs-comment"><span class="hljs-comment"># perl query_asa_lan2lan.pl &lt;community&gt; &lt;IP- &gt; ASA get RX &lt;IP- - remote endpoint&gt; 70546023</span></span></code> </pre><br>  Works! <br></div></div><br><br>  Since there are many tunnels and sometimes they change, we apply LLD (low-level detection rules) in Zabbix so that all the tunnels themselves are detected and registered in our system. <br>  We make a new pattern, and in it - the detection rule and prototypes of data elements for incoming and outgoing traffic: <br><img src="https://habrastorage.org/getpro/habr/post_images/85d/8d6/6f7/85d8d66f7812ac939be7b2ea729c486b.png" alt="image"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/118/2bb/cb6/1182bbcb6ebfb6bb5cc0d50363e098c5.png" alt="image"><br>  <b>Full</b> key: <b>query_asa_lan2lan.pl ["{$ SNMP_COMMUNITY}", "{HOST.IP}", "ASA", "get", "RX", "{#SNMPVALUE}"]</b> <br>  Link in the description of OID: <a href="http://tools.cisco.com/Support/SNMP/do/BrowseOID.do%3Flocal%3Den%26translate%3DTranslate%26objectInput%3D1.3.6.1.4.1.9.9.171.1.2.3.1.35">tools.cisco.com/Support/SNMP/do/BrowseOID.do?local=en&amp;translate=Translate&amp;objectInput=1.3.6.1.4.1.9.9.171.1.2.3.1.35#oidContent</a> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b27/c1c/6ce/b27c1c6ce3cc61b6cc733c8ac993e8f4.png" alt="image"><br>  <b>Full</b> key: <b>query_asa_lan2lan.pl ["{$ SNMP_COMMUNITY}", "{HOST.IP}", "ASA", "get", "TX", "{#SNMPVALUE}"]</b> <br>  Link in the description of OID: <a href="http://tools.cisco.com/Support/SNMP/do/BrowseOID.do%3Flocal%3Den%26translate%3DTranslate%26objectInput%3D1.3.6.1.4.1.9.9.171.1.2.3.1.35">tools.cisco.com/Support/SNMP/do/BrowseOID.do?local=en&amp;translate=Translate&amp;objectInput=1.3.6.1.4.1.9.9.171.1.2.3.1.35#oidContent</a> <br><br>  We apply the template to the necessary hosts, waiting for auto-detection and contemplate our tunnels. <br><br>  It remains to make graphics for the tunnels.  Unfortunately, LLD does not allow you to automatically make consolidated graphs from several data prototypes, you have to add the detected data elements manually: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/832/da0/309/832da0309754a123c3d0a28445317c8b.png" alt="image"><br><br>  Hooray!  You can boast of live pictures of the boss. </div><p>Source: <a href="https://habr.com/ru/post/195622/">https://habr.com/ru/post/195622/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../195612/index.html">Sending faxes from the User Panel to FreePBX</a></li>
<li><a href="../195614/index.html">Exploring and Configuring CentOS 6.4 for a Server</a></li>
<li><a href="../195616/index.html">Color in the interface</a></li>
<li><a href="../195618/index.html">Analog Meggy JR RGB do it yourself</a></li>
<li><a href="../195620/index.html">Rare language - coding without IDE, but with convenience</a></li>
<li><a href="../195624/index.html">Generating large amounts of useful data</a></li>
<li><a href="../195628/index.html">Run LendWings. Part 2. Russian lands</a></li>
<li><a href="../195632/index.html">WebCrypt - online encryption service</a></li>
<li><a href="../195636/index.html">Angular.js vs Meteor.js vs Derby.js</a></li>
<li><a href="../195642/index.html">The influence of cats on the development of technology</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>