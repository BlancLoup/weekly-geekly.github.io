<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>LINSTOR repository and its integration with OpenNebula</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, the guys from LINBIT presented their new SDS solution - Linstor. This is a completely free storage based on proven technologies: DRBD...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>LINSTOR repository and its integration with OpenNebula</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/e-/3z/h-/e-3zh-bbwjnljyazm68edln7muw.png"></p><br><p>  Not so long ago, the guys from LINBIT presented their new SDS solution - Linstor.  This is a completely free storage based on proven technologies: DRBD, LVM, ZFS.  Linstor combines simplicity and well-developed architecture, which allows to achieve stability and quite impressive results. </p><br><p>  Today I would like to tell you a little more about it and show how easy it can be integrated with OpenNebula using linstor_un - a new driver that I developed specifically for this purpose. </p><br><p>  Linstor in combination with OpenNebula allows you to build a fast and reliable cloud that can be deployed without problems on its own infrastructure. </p><a name="habracut"></a><br><h2 id="arhitektura-linstor">  Architecture linstor </h2><br><p>  Linstor is neither a file system nor block storage by itself, Linstor is an orchestrator that provides an abstraction layer that allows you to automate the creation of volumes in LVM or ZFS and replicate them using DRBD9. </p><br><h5 id="lomaem-stereotipy">  We break stereotypes </h5><br><p>  But wait, DRBD?  ‚ÄúWhy automate it and how can it work at all?‚Äù </p><br><p>  Recall the past, when DRBD8 was popular.  Its standard use implied the creation of one large block device and cutting it into many small pieces, using the same LVM.  A kind of mdadm RAID-1 but with network replication. </p><br><p>  This approach is not without drawbacks, and therefore, with the advent of DRBD9, the principles of building storage have changed, now a separate DRBD device is created for each virtual machine. </p><br><p>  The approach with independent block devices allows better utilization of space in the cluster, as well as adds a number of additional features.  For example, for each such device, you can determine the number of replicas, their location and individual settings.  They are easy to create / delete, make snapshots, resize, enable encryption and much more.  It is worth noting that DRBD9 also supports a quorum that avoids split-brain situations. </p><br><h5 id="resursy-i-bekendy">  Resources and Backends </h5><br><p>  Creating a new block device, Linstor places the necessary number of replicas on different nodes in the cluster.  Each such replica will be called a DRBD resource. </p><br><p>  Resources are of two types: </p><br><ul><li>  <strong>Data resource</strong> - represent a DRBD device located on a node in the LVM or ZFS pool. <br>  At the moment there is support for several backends and their number is constantly growing.  There is support for LVM, ThinLVM and ZFS.  The last two allow you to create and use snapshots. </li><li>  <strong>Diskless resource</strong> - is a DRBD device located on a node without a backend, but allowing to treat it as a regular block device, all read / write operations will be redirected to data resources.  The closest analogue to diskless resources is the iSCSI LUN. </li></ul><br><p>  Each DRBD resource can have up to 8 replicas, and only one of them can be active by default - <strong>Primary</strong> , all others will be <strong>Secondary</strong> and their use will be impossible as long as there is at least one Primary, that is, they will simply replicate data between yourself </p><br><p>  By mounting a DRBD device into the system, it automatically becomes <strong>Primary</strong> , thus even a Diskless resource, in the terminology of DRBD, can be Primary. </p><br><h5 id="tak-zachem-nuzhen-linstor">  So why do you need Linstor? </h5><br><p>  Trusting all resource-intensive tasks to the core, Linstor is essentially a regular Java application that allows you to easily automate the creation of DRBD resources. <br>  At the same time, each resource created by it will be an independent DRBD cluster, which operates independently, regardless of the state of the control-plane and other DRBD resources. </p><br><p>  <strong>Linstor consists of only two components:</strong> </p><br><ul><li>  <strong>Linstor-controller</strong> - The main controller that provides an API for creating and managing resources.  He also communicates with the satellites, checking the free space on them, and sends tasks to create and delete new resources.  Runs in a single instance and uses a database that can be either internal (H2) or external (PostgreSQL, MySQL, MariaDB) </li><li>  <strong>Linstor-satellite</strong> - Installs on all storage nodes and provides the controller with information about free space, as well as performs the tasks received from the controller to create and delete new volumes and DRBD devices on top of them. </li></ul><br><p>  <strong>Linstor operates on the following key concepts:</strong> </p><br><ul><li>  <strong>Node</strong> is the physical server on which DRBD resources will be created and used. </li><li>  <strong>Storage Pool</strong> - LVM or ZFS pool created on the node in which DRBD resources will be located.  A diskless pool is also possible - this is a pool in which only diskless resources will be located. </li><li>  <strong>Resource Definition</strong> - The definition of a resource, in fact, is a prototype that describes a name and all its properties. </li><li>  <strong>Volume Definition</strong> - The definition of a volume.  Each resource can consist of several volumes, each volume must have a size. </li><li>  <strong>Resource</strong> - The created instance of the block device, each resource must be placed on a specific node and in some kind of storage pool. </li></ul><br><h2 id="ustanovka-linstor">  Install linstor </h2><br><p>  As a system, I recommend using Ubuntu, because  there is a <a href="https://launchpad.net/~linbit/%2Barchive/ubuntu/linbit-drbd9-stack">ready PPA</a> for it: </p><br><pre><code class="bash hljs">add-apt-repository ppa:linbit/linbit-drbd9-stack apt-get update</code> </pre> <br><p>  Or Debian, where Linstor can be installed from the official repository for Proxmox: </p><br><pre> <code class="bash hljs">wget -O- https://packages.linbit.com/package-signing-pubkey.asc | apt-key add - PVERS=5 &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb http://packages.linbit.com/proxmox/ proxmox-</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PVERS</span></span></span><span class="hljs-string"> drbd-9.0"</span></span> &gt; \ /etc/apt/sources.list.d/linbit.list apt-get update</code> </pre> <br><h5 id="controller">  Controller </h5><br><p>  Everything is simple here: </p><br><pre> <code class="bash hljs">apt-get install linstor-controller linstor-client systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> linstor-controller systemctl start linstor-controller</code> </pre> <br><h5 id="storage-nody">  Storage nodes </h5><br><p>  Currently, the Linux kernel comes with an in-tree kernel module <strong>DRBD8</strong> , unfortunately it does not suit us and we need to install <strong>DRBD9</strong> : </p><br><pre> <code class="bash hljs">apt-get install drbd-dkms</code> </pre> <br><p>  As practice shows, most of the difficulties arise precisely with the fact that the DRBD8 module is loaded into the system, and not DRBD9.  Luckily, this is easily verified by running: </p><br><pre> <code class="bash hljs">modprobe drbd cat /proc/drbd</code> </pre> <br><p>  If you see <strong>version: 9</strong> , it means everything is ok, if <strong>version: 8</strong> , then something went wrong and you need to take additional steps to find out the reasons. </p><br><p>  Now install <strong>linstor-satellite</strong> and <strong>drbd-utils</strong> : </p><br><pre> <code class="bash hljs">apt-get install linstor-satellite drbd-utils systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> linstor-satellite systemctl start linstor-satellite</code> </pre> <br><h2 id="sozdanie-klastera">  Cluster creation </h2><br><p>  <strong>Storage pools and nodes</strong> </p><br><p>  As a backend, we take <strong>ThinLVM</strong> , because  It is the easiest and supports snapshots. <br>  Install <strong>lvm2</strong> , if you haven‚Äôt already done so and let's create a ThinLVM pool on all of our storage nodes: </p><br><pre> <code class="bash hljs">sudo vgcreate drbdpool /dev/sdb sudo lvcreate -L 800G -T drbdpool/thinpool</code> </pre> <br><p>  All further actions can be performed directly on the controller: </p><br><p>  Add our nodes: </p><br><pre> <code class="bash hljs">linstor node create node1 127.0.0.11 linstor node create node2 127.0.0.12 linstor node create node3 127.0.0.13</code> </pre> <br><p>  Create storage pools: </p><br><pre> <code class="bash hljs">linstor storage-pool create lvmthin node1 data drbdpool/thinpool linstor storage-pool create lvmthin node2 data drbdpool/thinpool linstor storage-pool create lvmthin node3 data drbdpool/thinpool</code> </pre> <br><p>  Now check the created pools: </p><br><pre> <code class="bash hljs">linstor storage-pool list</code> </pre> <br><p>  If everything is done correctly, then we should see something like: </p><br><pre>  + ------------------------------------------------- -------------------------------------------------- ---- +
 |  StoragePool |  Node |  Driver |  PoolName |  FreeCapacity |  TotalCapacity |  SupportsSnapshots |
 | ------------------------------------------------- -------------------------------------------------- ---- |
 |  data |  node1 |  LVM_THIN |  drbdpool / thinpool |  64 GiB |  64 GiB |  true |
 |  data |  node2 |  LVM_THIN |  drbdpool / thinpool |  64 GiB |  64 GiB |  true |
 |  data |  node3 |  LVM_THIN |  drbdpool / thinpool |  64 GiB |  64 GiB |  true |
 + ------------------------------------------------- -------------------------------------------------- ---- + </pre><br><p>  <strong>DRBD resources</strong> </p><br><p>  Now let's try creating our new DRBD resource: </p><br><pre> <code class="bash hljs">linstor resource-definition create myres linstor volume-definition create myres 1G linstor resource create myres --auto-place 2</code> </pre> <br><p>  Check the created resources: </p><br><pre> <code class="bash hljs">linstor resource list</code> </pre> <br><pre>  + ------------------------------------------------- -------------------------------------------------- --- +
 |  Node |  Resource |  StoragePool |  VolumeNr |  MinorNr |  DeviceName |  Allocated |  InUse |  State |
 | ------------------------------------------------- -------------------------------------------------- --- |
 |  node1 |  myres |  data |  0 |  1084 |  / dev / drbd1084 |  52 KiB |  Unused |  UpToDate |
 |  node2 |  myres |  data |  0 |  1084 |  / dev / drbd1084 |  52 KiB |  Unused |  UpToDate |
 + ------------------------------------------------- -------------------------------------------------- --- + </pre><br><p>  Fine!  - we see that the resource was created on the first two nodes, we can also try to create a diskless resource on the third: </p><br><pre> <code class="bash hljs">linstor resource create --diskless node3 myres</code> </pre> <br><p>  On the nodes, you will always find this device as <code>/dev/drbd1084</code> or <code>/dev/drbd/by-res/myres/0</code> </p><br><p>  This is how Linstor works, you can get more information from the <a href="https://docs.linbit.com/docs/users-guide-9.0/">official documentation</a> . </p><br><p>  Now I will talk about how to integrate it with OpenNebula </p><br><h2 id="nastroyka-opennebula">  Configuring OpenNebula </h2><br><p>  I will not go deep into the process of setting up OpenNebula, because  All steps are described in detail in the <a href="https://docs.opennebula.org/stable/deployment/opennebula_installation/index.html">official documentation</a> , to which I recommend you to refer, I will tell only about the integration of OpenNebula with Linstor. </p><br><h5 id="linstor_un">  linstor_un </h5><br><p>  To solve this problem, I wrote my own driver - <a href="https://github.com/OpenNebula/addon-linstor_un">linstor_un</a> , at the moment it is available as a plugin and must be installed separately. </p><br><p>  The entire installation is done on the frontend OpenNebula nodes, and does not require additional actions on the compute nodes. </p><br><p>  First we need to make sure that we have <strong>jq</strong> and <strong>linstor-client</strong> : </p><br><pre> <code class="plaintext hljs">apt-get install jq linstor-client</code> </pre> <br><p>  The <code>linstor node list</code> command should list the nodes.  All OpenNebula compute nodes must be added to the Linstor cluster. </p><br><p>  Download and install the plugin: </p><br><pre> <code class="bash hljs">curl -L https://github.com/OpenNebula/addon-linstor_un/archive/master.tar.gz | tar -xzvf - -C /tmp mv /tmp/addon-linstor_un-master/vmm/kvm/* /var/lib/one/remotes/vmm/kvm/ mkdir -p /var/lib/one/remotes/etc/datastore/linstor_un mv /tmp/addon-linstor_un-master/datastore/linstor_un/linstor_un.conf /var/lib/one/remotes/etc/datastore/linstor_un/linstor_un.conf mv /tmp/addon-linstor_un-master/datastore/linstor_un /var/lib/one/remotes/datastore/linstor_un mv /tmp/addon-linstor_un-master/tm/linstor_un /var/lib/one/remotes/tm/linstor_un rm -rf /tmp/addon-linstor_un-master</code> </pre> <br><p>  Now we need to add it to the OpenNebula config, for this we perform the simple steps described <strong><a href="https://github.com/OpenNebula/addon-linstor_un">here</a></strong> . </p><br><p>  Then restart OpenNebula: </p><br><pre> <code class="bash hljs">systemctl restart opennebula</code> </pre> <br><p>  And add our datastores, system: </p><br><pre> <code class="bash hljs">cat &gt; system-ds.conf &lt;&lt;EOT NAME=<span class="hljs-string"><span class="hljs-string">"linstor-system"</span></span> TYPE=<span class="hljs-string"><span class="hljs-string">"SYSTEM_DS"</span></span> STORAGE_POOL=<span class="hljs-string"><span class="hljs-string">"data"</span></span> AUTO_PLACE=<span class="hljs-string"><span class="hljs-string">"2"</span></span> CLONE_MODE=<span class="hljs-string"><span class="hljs-string">"snapshot"</span></span> CHECKPOINT_AUTO_PLACE=<span class="hljs-string"><span class="hljs-string">"1"</span></span> BRIDGE_LIST=<span class="hljs-string"><span class="hljs-string">"node1 node2 node3"</span></span> TM_MAD=<span class="hljs-string"><span class="hljs-string">"linstor_un"</span></span> EOT onedatastore create system-ds.conf</code> </pre> <br><p>  And the image repository: </p><br><pre> <code class="bash hljs">cat &gt; images-ds.conf &lt;&lt;EOT NAME=<span class="hljs-string"><span class="hljs-string">"linstor-images"</span></span> TYPE=<span class="hljs-string"><span class="hljs-string">"IMAGE_DS"</span></span> STORAGE_POOL=<span class="hljs-string"><span class="hljs-string">"data"</span></span> AUTO_PLACE=<span class="hljs-string"><span class="hljs-string">"2"</span></span> BRIDGE_LIST=<span class="hljs-string"><span class="hljs-string">"node1 node2 node3"</span></span> DISK_TYPE=<span class="hljs-string"><span class="hljs-string">"BLOCK"</span></span> DS_MAD=<span class="hljs-string"><span class="hljs-string">"linstor_un"</span></span> TM_MAD=<span class="hljs-string"><span class="hljs-string">"linstor_un"</span></span> EOT onedatastore create images-ds.conf</code> </pre> <br><ul><li>  The <code>AUTO_PLACE</code> parameter displays the number of data points that will be created for each new image in OpenNebula. </li><li>  The <code>CLONE_MODE</code> parameter specifies exactly how the images will be cloned when creating new virtual machines, <code>snapshot</code> will create a snapshot of the image and deploy a virtual machine from snapshot, <code>copy</code> will make a full copy of the image for each virtual machine. </li><li>  In <code>BRIDGE_LIST</code> it is recommended to specify all nodes that will be used to perform image cloning operations. </li></ul><br><p>  A complete list of supported parameters is provided in the project's <a href="https://github.com/OpenNebula/addon-linstor_un">README</a> . </p><br><p>  This completes the configuration, now you can download any appliance from the official <a href="https://marketplace.opennebula.systems/appliance">OpenNebula Marketplace</a> and create virtual machines from it. </p><br><p>  <a href="https://github.com/OpenNebula/addon-linstor_un">Link to the project</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/451186/">https://habr.com/ru/post/451186/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../451166/index.html">What will the new storages for AI and MO systems offer?</a></li>
<li><a href="../451170/index.html">Jeff Bezos announced plans to conquer the moon</a></li>
<li><a href="../451174/index.html">Adaptation programs for the ZX Spectrum to TR-DOS with modern tools. Part 1</a></li>
<li><a href="../451176/index.html">News from the world of OpenStreetMap ‚Ññ458 (04/23/2019-29.04.2019)</a></li>
<li><a href="../451178/index.html">Accident when testing the Crew Dragon parachute landing system</a></li>
<li><a href="../451196/index.html">Separation of customer profiles and freelancer</a></li>
<li><a href="../4512/index.html">Google is interested in weddings</a></li>
<li><a href="../451204/index.html">Free text editors for collaboration</a></li>
<li><a href="../451206/index.html">What is happening with RDF repositories?</a></li>
<li><a href="../451208/index.html">"Topological" sorting graph with cycles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>