<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Testing Ethereum smart contracts on the example of DAO</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When creating smart contracts on the Ethereum platform, the developer lays down certain work logic, defining how methods should change the state of th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Testing Ethereum smart contracts on the example of DAO</h1><div class="post__text post__text-html js-mediator-article">  When creating smart contracts on the Ethereum platform, the developer lays down certain work logic, defining how methods should change the state of the contract, what events should be emitted, when and to whom the transfer of funds should be effected and when to throw an exception.  Smart contract debugging tools are not yet well developed, so tests often become a necessary development tool, because  to run contracts after each change can be quite a long procedure.  Also, in case of detection of errors, it is already impossible to change the code of a contract deployed in the network, you can only destroy the contract and create a new one, so testing should be carried out in as much detail as possible, especially the methods associated with payments.  The article will show some testing techniques that developers encounter when creating and debugging smart contracts for <a href="http://solidity.readthedocs.io/en/develop/solidity-in-depth.html">Solidity</a> . <a name="habracut"></a><br><br><h2>  Decentralized Autonomous Organization (DAO) </h2><br>  In the summer of 2016, the story with THE DAO, from which the attacker <a href="http://hackingdistributed.com/2016/06/18/analysis-of-the-dao-exploit/">took a lot of money</a> , made a noise.  DAO is a smart contract that positions itself as an organization, all processes of which are described by code that operates in the blockchain environment, while not being a legal entity and are managed collectively by all its investors.  Back in March, the DAO developers <a href="https://blog.slock.it/how-does-one-test-a-dao-58edb53e8885">emphasized the importance of testing</a> and even covered their smart contract with <a href="https://github.com/slockit/DAO/tree/master/tests">tests</a> using their own framework in a mixture of Python and Javascript, but unfortunately the tests did not close the vulnerability that was used later. <br><br>  <a href="https://github.com/slockit/DAO/tree/master">The DAO</a> smart contract code is too big for an example, so let's take the smart contract of <a href="">Congress</a> , which implements the principles of DAO, which is given in the article <a href="https://www.ethereum.org/">http://ethereum.org</a> <a href="https://www.ethereum.org/dao">on the blockchain</a> article.  In the future, it is assumed familiarity with the <a href="https://medium.com/%40ConsenSys/a-101-noob-intro-to-programming-smart-contracts-on-ethereum-695d15c1dab4">basic principles of the development of smart contracts</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  How does smart contract testing occur? </h2><br>  The general principle is similar to testing any other code - a set of reference method calls is created in a predefined environment, for the results of which statements are written.  For testing, it is convenient to use the practices of BDD - Behavior Driven Development, which, along with tests, allow you to create documentation and examples of use. <br><br><h2>  Testing Tools </h2><br>  Currently, a number of Ethereum smart contract frameworks and libraries have been developed: <br><br><h3>  Truffle </h3><br>  <a href="https://github.com/ConsenSys/truffle">Truffle</a> v.2 tests are developed in JavaScript, using the Mocha framework and the Chai library.  In version 3, the ability <a href="http://truffleframework.com/docs/getting_started/solidity-tests">to write tests for Solidity was</a> added. <br><br><h3>  DApple </h3><br>  In <a href="https://github.com/nexusdev/dapple">DApple,</a> tests are implemented on Solidity, using methods of specially developed basic smart contracts. <br><br><h3>  Embarkjs </h3><br>  In <a href="https://github.com/iurimatias/embark-framework">EmbarkJS</a> approach is similar to Truffle, tests are written in Javascript, Mocha framework is used. <br><br>  Development of tests for Solidity is quite limited by the capabilities of this language, so we will use Javascript, all the examples will be using the Cruffle Framework.  You can also use the <a href="https://github.com/trufflesuite">Truffle Framework</a> components, such as <a href="https://github.com/trufflesuite/truffle-contract">truffle-contract</a> or <a href="https://github.com/trufflesuite/truffle-artifactor">truffle-artifactor</a> , to create your custom solutions for interacting with smart contracts. <br><br><h3>  Test client </h3><br>  Taking into account the fact that the blockchain systems, in particular Ethereum, do not work very quickly, the ‚Äútest‚Äù blockchain clients are used for testing, for example, <a href="https://github.com/ethereumjs/testrpc">TestRPC</a> , which almost completely emulates Ethereum clients <a href="https://github.com/ethereumjs/testrpc">JSON RPC API</a> .  In addition to standard methods, TestRPC also implements a number of additional methods that are convenient to use when testing, such as <i>evm_increaseTime</i> , <i>evm_mine</i> , etc. <br><br>  Alternatively, you can use one of the standard clients, for example Parity, which works in <a href="https://github.com/ethcore/parity/wiki/Private-development-chain">dev mode</a> , in which transactions are confirmed instantly.  In the following examples, TestRPC will be used. <br><br><h2>  Setting up the environment </h2><br><h3>  Test client </h3><br>  Installation via npm: <br><br><pre><code class="bash hljs">npm install -g ethereumjs-testrpc</code> </pre> <br>  TestRPC should be run in a separate terminal.  Each time the test client starts, it generates 10 new accounts, on each of which funds are already placed. <br><br><h3>  Framework truffle </h3><br>  Installation via npm: <br><br><pre> <code class="bash hljs">npm install -g truffle</code> </pre> <br>  To create a project structure you need to run the command truffle init <br><br><pre> <code class="bash hljs">$ mkdir solidity-test-example $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> solidity-test-example/ $ truffle init</code> </pre> <br>  Contracts must be located in the <i>contracts /</i> directory, when compiling contracts the Truffle Framework expects each contract to be placed in a separate file, the name of the contract is equal to the file name.  Tests are located in the <i>test /</i> directory.  When you execute the <i>truffle init</i> command, test contracts are also created by Metacoin, etc. <br><br>  In further examples, the project <a href="https://github.com/vitiko/solidity-test-example">https://github.com/vitiko/solidity-test-example</a> will be used, which contains the smart code for the contract <i>Congress</i> and tests for it.  Tests are performed in the Truffle v.2 environment, in the v.3 version that was recently released, there are some minor differences in terms of the connection between the generated Truffle code and the format of the transaction data that is returned after calling the state-changing methods. <br><br><h2>  Development of tests based on the Truffle framework </h2><br><h3>  Test organization </h3><br>  The tests use JavaScript objects, which are abstractions for working with contracts, producing mapping between operations on objects and calls to JSON RPC client methods Ethereum.  These objects are created automatically when compiling the source code of * .sol files.  Calls of all methods are asynchronous and return Promise, it allows not to worry about tracking the confirmation of transactions, everything is implemented under the hood Truffle components. <br><br>  <a href="http://truffleframework.com/docs/getting_started/javascript-tests">The examples</a> on the Truffle Framework site use the style of writing with .then () chains.  If you describe a large script, the test code is quite voluminous.  Much more concise and readable is the test code using async / await, then this style of writing tests will be used.  Also, in the examples on the developer's website, instances of smart contracts are used, the deployment of which is prescribed in <a href="http://truffleframework.com/docs/getting_started/migrations">migrations</a> .  In order not to mix migrations and creating test instances, it is more convenient to create them explicitly in a test, for this you can use the code that creates a new instance of the contract before calling each test function.  The example below shows the <i>beforeEach</i> function in which an instance of the <i>Congress</i> object is created. <br><br><div class="spoiler">  <b class="spoiler_title">Designer Smart Contract Contract</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* First time setup */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Congress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> uint minimumQuorumForProposals, uint minutesForDebate, int marginOfVotesForMajority, address congressLeader </span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">payable</span></span></span><span class="hljs-function"> </span></span>{ changeVotingRules(minimumQuorumForProposals, minutesForDebate, marginOfVotesForMajority); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (congressLeader != <span class="hljs-number"><span class="hljs-number">0</span></span>) owner = congressLeader; <span class="hljs-comment"><span class="hljs-comment">// It's necessary to add an empty first member addMember(0, ''); // and let's add the founder, to save a step later addMember(owner, 'founder'); }</span></span></code> </pre> </div></div><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> congressInitialParams = { <span class="hljs-attr"><span class="hljs-attr">minimumQuorumForProposals</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">minutesForDebate</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-attr"><span class="hljs-attr">marginOfVotesForMajority</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">congressLeader</span></span>: accounts[<span class="hljs-number"><span class="hljs-number">0</span></span>] }; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> congress; beforeEach(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ congress = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Congress.new(...Object.values(congressInitialParams)); });</code> </pre> <br><h3>  Testing a smart contract state change </h3><br>  To begin with, let's try to test the <a href=""><i>addMember</i></a> method changing the state of a smart contract - the method should write information about the DAO member into an array of member structures. <br><br><div class="spoiler">  <b class="spoiler_title">Function code of addMember smart contract</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*make member*/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addMember</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">address targetMember, string memberName</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onlyOwner</span></span></span><span class="hljs-function"> </span></span>{ uint id; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (memberId[targetMember] == <span class="hljs-number"><span class="hljs-number">0</span></span>) { memberId[targetMember] = members.length; id = members.length++; members[id] = Member({<span class="hljs-attr"><span class="hljs-attr">member</span></span>: targetMember, <span class="hljs-attr"><span class="hljs-attr">memberSince</span></span>: now, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: memberName}); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { id = memberId[targetMember]; Member m = members[id]; } MembershipChanged(targetMember, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre> </div></div><br>  In the test, using the array with test accounts, we add participants to the contract.  Then we check that the members function (getter for an array of <i>member</i> structures) returns the entered data.  It should be noted that each time the <i>addMember</i> method is <i>called</i> , a transaction is created and the state of the blockchain changes;  information is recorded in a distributed registry. <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should allow owner to add members"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  3  for (let i = 1; i &lt;= 3; i++) { let addResult = await congress.addMember(accounts[i], 'Name for account ' + i); //    members      2. // .. members[0] - empty, members[1] - ,   (. ) let memberInfoFromContract = await congress.members(i + 1); //  members(pos)       Member //  [0] -   , [1] -    assert.equal(memberInfoFromContract[0], accounts[i]); assert.equal(memberInfoFromContract[1], 'Name for account ' + i); } });</span></span></code> </pre> <br><h3>  Event Testing </h3><br>  <a href="https://media.consensys.net/technical-introduction-to-events-and-logs-in-ethereum-a074d65dd61e">Events</a> in Ethereum have a fairly universal application, they can be used: <br><br><ul><li>  To return values ‚Äã‚Äãfrom methods that change the state of the contract, incl.  in user interface </li><li>  To create a status history of smart contracts </li><li>  As a cheap storage of information (the cost of placing data in the event log is much cheaper than in the state of the contract) </li></ul><br>  In the following example, we will check that when calling the <a href=""><i>newProposal</i></a> method, which adds proposals to the <i>Congress</i> contract, a record of the event <i>Proposal Added is created.</i> <br><br><div class="spoiler">  <b class="spoiler_title">Function code of the newProposal smart contract</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* Function to create a new proposal */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newProposal</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> address beneficiary, uint etherAmount, string JobDescription, bytes transactionBytecode </span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onlyMembers</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">uint proposalID</span></span></span><span class="hljs-function">) </span></span>{ proposalID = proposals.length++; Proposal p = proposals[proposalID]; p.recipient = beneficiary; p.amount = etherAmount; p.description = JobDescription; p.proposalHash = sha3(beneficiary, etherAmount, transactionBytecode); p.votingDeadline = now + debatingPeriodInMinutes * <span class="hljs-number"><span class="hljs-number">1</span></span> minutes; p.executed = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; p.proposalPassed = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; p.numberOfVotes = <span class="hljs-number"><span class="hljs-number">0</span></span>; ProposalAdded(proposalID, beneficiary, etherAmount, JobDescription); numProposals = proposalID+<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> proposalID; }</code> </pre> </div></div><br>  To do this, we first create a DAO participant in the test and create a proposal on its behalf.  Then we create a subscriber for the <i>ProposalAdded</i> event and check that after calling the <i>newProposal</i> method <i>, the</i> event has occurred and its attributes correspond to the data passed. <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should fire event 'ProposalAdded' when member add proposal"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> proposedAddedEventListener = congress.ProposalAdded(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> proposalParams = { <span class="hljs-attr"><span class="hljs-attr">beneficiary</span></span> : accounts[<span class="hljs-number"><span class="hljs-number">9</span></span>], <span class="hljs-attr"><span class="hljs-attr">etherAmount</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-attr"><span class="hljs-attr">JobDescription</span></span> : <span class="hljs-string"><span class="hljs-string">'Some job description'</span></span>, <span class="hljs-attr"><span class="hljs-attr">transactionBytecode</span></span> : web3.sha3(<span class="hljs-string"><span class="hljs-string">'some content'</span></span>) }; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> congress.addMember(accounts[<span class="hljs-number"><span class="hljs-number">5</span></span>], <span class="hljs-string"><span class="hljs-string">'Name for account 5'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> congress.newProposal(...Object.values (proposalParams), { <span class="hljs-attr"><span class="hljs-attr">from</span></span>: accounts[<span class="hljs-number"><span class="hljs-number">5</span></span>] }); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> proposalAddedLog = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) =&gt;</span></span> proposedAddedEventListener.get( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error, log</span></span></span><span class="hljs-function">) =&gt;</span></span> error ? reject(error) : resolve(log) )); assert.equal(proposalAddedLog.length, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'should be 1 event'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> eventArgs = proposalAddedLog[<span class="hljs-number"><span class="hljs-number">0</span></span>].args; assert.equal(eventArgs.proposalID , <span class="hljs-number"><span class="hljs-number">0</span></span>); assert.equal(eventArgs.recipient , proposalParams.beneficiary); assert.equal(eventArgs.amount , proposalParams.etherAmount); assert.equal(eventArgs.description , proposalParams.JobDescription); }); });</code> </pre> <br><h3>  Error Testing and Message Sender Verification </h3><br>  The standard method for terminating the contract method is <a href="http://solidity.readthedocs.io/en/develop/control-structures.html">exceptions</a> , which can be created using the <i>throw</i> statement.  An exception may be needed, for example, if you need to restrict access to the method.  For this, a <a href="http://solidity.readthedocs.io/en/develop/contracts.html">modifier</a> is implemented that checks the address of the account that called the method, and if an exception is not met, an exception is created.  For example, let's create a test that checks that if the <a href=""><i>addMember</i></a> method is not the contract owner, an exception is created.  In the code below, the Contract contract <i>is</i> created on behalf of accounts [0], then the <i>addMember</i> method is <i>called</i> on behalf of another account. <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should disallow no owner to add members"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> addError; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  ,  accounts[0] != accounts[9] await congress.addMember(accounts[1], 'Name for account 1', { from: accounts[9] }); } catch (error) { addError = error; } assert.notEqual(addError, undefined, 'Error must be thrown'); //      ,       //  "invalid JUMP" assert.isAbove(addError.message.search('invalid JUMP'), -1, 'invalid JUMP error must be returned'); });</span></span></code> </pre> <br><h3>  Testing the change in the balance of a smart contract, using the current time in a smart contract </h3><br>  Perhaps the most important function of the smart contract to <i>Congress</i> , which implements the principles of DAO, is the <i>executeProposal</i> function, which starts checking that the proposal received the required number of votes and the discussion of the proposal lasted no less than the minimum required time specified when creating the smart contract, and then transfers the funds to the beneficiary discussed proposal. <br><br><div class="spoiler">  <b class="spoiler_title">Function code executeProposal smart contract</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">executeProposal</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">uint proposalNumber, bytes transactionBytecode</span></span></span><span class="hljs-function">) </span></span>{ Proposal p = proposals[proposalNumber]; <span class="hljs-comment"><span class="hljs-comment">/* Check if the proposal can be executed: - Has the voting deadline arrived? - Has it been already executed or is it being executed? - Does the transaction code match the proposal? - Has a minimum quorum? */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (now &lt; p.votingDeadline || p.executed || p.proposalHash != sha3(p.recipient, p.amount, transactionBytecode) || p.numberOfVotes &lt; minimumQuorum) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* execute result */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* If difference between support and opposition is larger than margin */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p.currentResult &gt; majorityMargin) { <span class="hljs-comment"><span class="hljs-comment">// Avoid recursive calling p.executed = true; if (!p.recipient.call.value(p.amount * 1 ether)(transactionBytecode)) { throw; } p.proposalPassed = true; } else { p.proposalPassed = false; } // Fire Events ProposalTallied(proposalNumber, p.currentResult, p.numberOfVotes, p.proposalPassed); }</span></span></code> </pre> </div></div><br>  To simulate the elapsed time, we use the <i>evm_increaseTime</i> method, which is <a href="https://github.com/ethereumjs/testrpc">implemented in testrpc</a> - with its help, you can change the internal blockchain time of the client. <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should pay for executed proposal"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> proposalParams = { <span class="hljs-attr"><span class="hljs-attr">beneficiary</span></span>: accounts[<span class="hljs-number"><span class="hljs-number">9</span></span>], <span class="hljs-attr"><span class="hljs-attr">etherAmount</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">JobDescription</span></span>: <span class="hljs-string"><span class="hljs-string">'Some job description'</span></span>, <span class="hljs-attr"><span class="hljs-attr">transactionBytecode</span></span>: web3.sha3(<span class="hljs-string"><span class="hljs-string">'some content'</span></span>) }; <span class="hljs-comment"><span class="hljs-comment">//    accounts[9]   executeProposal let curAccount9Balance = web3.eth.getBalance(accounts[9]).toNumber(); //  ,         //     accounts[9] await congress.newProposal(...Object.values(proposalParams), { from: accounts[0] //accounts[0]  , ..      }); //  DAO,      //     3    //   3  DAO     0    for (let i of[3, 4, 5]) { await congress.addMember(accounts[i], 'Name for account ' + i); await congress.vote(0, true, 'Some justification text from account ' + i, { from: accounts[i] }); } //    let curProposalState = await congress.proposals(0); //   ,       //  .  //... //    testrpc  10 ,    //       minutesForDebate (5) await new Promise((resolve, reject) =&gt; web3.currentProvider.sendAsync({ jsonrpc: "2.0", method: "evm_increaseTime", params: [10 * 600], id: new Date().getTime() }, (error, result) =&gt; error ? reject(error) : resolve(result.result)) ); //    -  3  ‚Äú‚Äù, //      await congress.executeProposal(0, proposalParams.transactionBytecode); // ,     accounts[9] //   ,     let newAccount9Balance = web3.eth.getBalance(accounts[9]).toNumber(); assert.equal(web3.fromWei(newAccount9Balance - curAccount9Balance, 'ether'), proposalParams.etherAmount, 'balance of acccounts[9] must increase to proposalParams.etherAmount'); let newProposalState = await congress.proposals(0); assert.isOk(newProposalState[PROPOSAL_PASSED_FIELD]); });</span></span></code> </pre> <br><h3>  Secondary functions </h3><br>  In the process of writing tests useful functions that are conveniently used for frequently used operations when testing, such as checking for an exception, receiving the event log, changing the time of the test client.  The functions are placed in the form of a package <a href="https://www.npmjs.com/package/solidity-test-util">https://www.npmjs.com/package/solidity-test-util</a> , the code is placed on <a href="https://github.com/vitiko/solidity-test-util">github</a> .  The following is an example of using the <i>testUtil.assertThrow</i> function to check for an exception: <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should disallow no owner to add members"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> testUtil.assertThrow(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> congress.addMember(accounts[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">'Name for account 1'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">from</span></span>: accounts[<span class="hljs-number"><span class="hljs-number">9</span></span>] })); });</code> </pre> <br>  Other examples using <i>solidity-test-util</i> functions can be seen <a href="">here</a> . <br><br><h2>  Conclusion </h2><br>  As a result of the development of tests, we get both automated verification of the correctness of smart contracts, as well as the specification and examples of use, in general, everything that can be said about testing any other software code. </div><p>Source: <a href="https://habr.com/ru/post/321362/">https://habr.com/ru/post/321362/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321352/index.html">Search for large documents in ElasticSearch</a></li>
<li><a href="../321354/index.html">How-to: tools for competitive analysis of software products</a></li>
<li><a href="../321356/index.html">One-day conference on the gaming industry at VSBI February 11</a></li>
<li><a href="../321358/index.html">A / B tests are not needed *</a></li>
<li><a href="../321360/index.html">Technosphere Mail.Ru - three years</a></li>
<li><a href="../321364/index.html">Lightshot client for Ubuntu Linux (and not only)</a></li>
<li><a href="../321366/index.html">NetApp ONTAP & VMware vVOL</a></li>
<li><a href="../321368/index.html">Andrew Un's draft of The Thirst for Machine Learning, Chapters 1-7</a></li>
<li><a href="../321370/index.html">Why VIPER is a bad choice for your next application.</a></li>
<li><a href="../321372/index.html">Why Zuckerberg chasing a ghost</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>