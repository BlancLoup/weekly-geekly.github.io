<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>mod_performance 0.4 help monitoring Apache 2.x</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="mod_performance - 0.4 
 The final series of articles on the apache module is mod_performance. 

 History tour 
 This is the usual Apache 2.x module fo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>mod_performance 0.4 help monitoring Apache 2.x</h1><div class="post__text post__text-html js-mediator-article"><h1>  mod_performance - 0.4 </h1><br>  The final series of articles on the apache module is mod_performance. <br><br><h2>  History tour </h2><br>  This is the usual Apache 2.x module for Linux: <br><ol><li>  the module is designed to collect and accumulate statistics on the use of resources (CPU and memory, script execution time) by the Apache 2.4 / 2.2 / 2.0 web server; </li><li>  The module allows to analyze the collected data. </li></ol><br><a name="habracut"></a><br>  It allows you to keep track of how many resources consumed the request received by the web server.  Each time saving the following information: <br><ol><li>  virtual host that received the request; </li><li>  the file that is requested; </li><li>  Request URI; </li><li>  CPU load in%; </li><li>  memory usage in%; </li><li>  request processing time. </li></ol><br><br>  And the accumulated statistics allows you to analyze.  SQLite (MySQL, PostgreSQL, error_log) is used as a database for saving and analysis. <br>  The module allows you to track absolutely all requests, as well as specific ones, filtered by the rule using regular expressions.  More precisely, it will be said that the module ALWAYS processes only those requests that match the filter containing the regular expression. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      An earlier description of the module can be read on the links: <br><ol><li>  0.2-0.3 version - <a href="http://habrahabr.ru/post/120660/">http://habrahabr.ru/post/120660/</a> </li><li>  0.1 and earlier - <a href="http://habrahabr.ru/post/119011/">http://habrahabr.ru/post/119011/</a> </li></ol><br>  The functionality of the module during its existence has been expanded, new features have been added, and the mechanism of saving in the database has been optimized. <br>  I decided to put together all the innovations and talk about them. <br><br><h2>  A small digression ... </h2><br>  There are many alternative methods of collecting various statistics, there are wonderful modules mod_status, mod_log_config, which can also perform similar (and not so) with the described module actions.  The article only tells about another tool that can be useful for monitoring and debugging issues on the server. <br><br><h2>  What is the difference between module version 0.4 and 0.3? </h2><br><h3>  First difference </h3><br>  I think a very important difference.  Previously, for each request, the module ran two threads that monitored the request; they ended with a stream, writing data on the stream to the database (log).  There was a limit on the number of threads monitored and the stack size for the thread being created ‚Äî PerformanceMaxThreads and PerformanceStackSize.  These parameters are no longer used by the module.  Also removed from it is a pool of threads that monitored memory allocated to threads. <br>  Now all requests are monitored by three threads.  I will not specifically describe what they do, but there are only three of them.  This means that there is no limit on the number of requests that will be monitored. <br><br><h3>  Second difference </h3><br>  The data in the database (log) is written by one stream, and not many as previously.  Thus, the number of locks to the database decreases - this is especially true for SQLite.  Buffering of data recording in the database.  Ie now the data in the log does not fall instantly, but when there is an opportunity and time to write it there. <br><br><h3>  Third difference </h3><br>  It is no secret that the statistics on the process is taken by the module through procfs.  Previously, data was taken only by Process ID, now it is possible to read data and by Thread ID - the so-called TID.  This should be relevant for apache worker (event). <br><br><h3>  Fourth difference </h3><br>  Added the ability to create your own reports (a report is a method for analyzing data collected by a module).  The module still carries a certain set of reports, the so-called ‚Äúout of box‚Äù.  But in the source code of the module there is a file custom.tpl, which expands the number of available reports of the module.  And also allows you to create your own database queries and display the results.  How to do this, I will describe below. <br><br><h3>  Fifth difference </h3><br>  A number of bugs fixed that caused apache server restarts (hopefully, no new bugs were added).  Added display of which method GET, POST, etc.  The script was called. <br><br><h3>  Sixth difference </h3><br>  Now you can write data to a centralized remote database (for MySQL, PostgreSQL mode).  Those.  Now data from different machines can be accumulated on the same server. <br><br><h2>  More details </h2><br><h3>  A little bit about the interface </h3><br>  Since version 0.3, the interface has been redesigned for analyzing the collected data.  I'll tell you a little about its features (Figure 1). <br>  Figure 1. <br><br><img src="https://habrastorage.org/files/1e5/610/58c/1e561058c5e4483ab910697b8696958e.png" alt="mod_performance 0.4"><br><br>  1. Hide / Show - the button "Hide / Show filter" - designed to minimize and maximize the filter window. <br>  2. Report - drop-down list of available reports (reports of analysis of accumulated data) <br>  3. Sort Field - the number of the displayed field, which will be sorted (does not affect custom reports) <br>  4. Sort Type - sorting type of the selected field - in ascending or descending order (does not affect custom reports) <br>  5. Period (days) - the interval in days from the current day for which the data will be analyzed <br>  6. Period begin (Period End) - the exact date and time of the beginning and end of the analyzed period (if these values ‚Äã‚Äãare specified, then the Period (days) field is ignored) <br>  7-8-9.  - Additional filter parameters of the analyzed data.  Perhaps as a strict match, and not strict - for example, the value ending in test -% test. <br>  10. Link to download the latest version <br>  11. Reference to module documentation <br>  12. Icon for sorting data on the page (v - descending, ^ - ascending) <br>  13. Column Header Row <br>  14. Fixed row column numbers.  Does not move even when scrolling the page. <br><br>  The module interface uses javascript. <br><br><h3>  Custom reports </h3><br>  An example of setting up custom reports (for CentOS / Redhat / Fedora) supplied with the module source code: <br><pre><code class="bash hljs">mkdir ~/tmp <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/tmp wget http://www.lexvit.dn.ua/modperf/getlast -O mod_performance.tar.gz tar -xvf mod_performance.tar.gz ‚Äìstrip 1 mkdir -p /opt/performance/ chown apache:apache /opt/performance/ chmod 755 /opt/performance/ cp ~/tmp/custom.tpl /opt/performance/   mod_performance.conf  PerformanceCustomReports /opt/performance/custom.tpl service httpd restart</code> </pre> <br><br>  Report example: <br>  Figure 2. <br><br><img src="https://habrastorage.org/files/b06/b80/094/b06b800940934dd383ddfc378970677b.png" alt="mod_performance 0.4 report"><br><br>  List of custom reports: <br><ol><li>  Show the average load generated by the site in different time periods </li><li>  Show most popular script by site - show the most frequently called script for each site. </li><li>  Show CPU load range by site - show CPU load distribution for each site </li><li>  Show Memory Usage range by site - show the memory allocation for each site </li><li>  Show Max CPU load in different time periods by site - show the maximum CPU load in different time periods for each site </li><li>  Show Max Memory Usage - show the maximum memory usage in different time periods for each site. </li><li>  Show Max IO Usage - show the maximum IO load in different time periods for each site </li></ol><br><br>  To create a custom report, use the following syntax in the custom.tpl file: <br><br><pre> <code class="bash hljs">[ ] header=Fld 1|Fld 2|Fld 3; ssql=   SQLite; msql=   MySQL; psql=   PostgerSQL; sort=1,2;</code> </pre><br><br>  The name of the report is written in square brackets; it will be displayed in field 2 of fig.1. <br>  Header - the name and list of displayed fields in order in select separated by the ‚Äú|‚Äù sign.  In the example, the first picked up field from select will be displayed in column Fld 1, the second in column Fld 2, and so on.  List of fields number 13 in Figure 1. <br>  Ssql, msql, psql - database queries.  I recommend not using the direct names of the table fields, but their pseudonyms.  The report is displayed if there is a query for the current database configuration (SSQL, MSQL, PSQL) <br>  Match table field and alias: <br>  id: ITEMNUMBER: - record identifier <br>  dateadd: DATEADD: - the date the record was added <br>  host: FORHOST: - the host to which the request was made <br>  uri: REQUESTURI: - Request URI <br>  script: CALLEDSCRIPT: - called script <br>  cpu: CPUUSAGE: - CPU in% <br>  memory: MEMUSAGEINPRCT: - memory in% <br>  exc_time: EXECUTIONTIME: - request execution time <br>  cpu_sec: CPUUSAGEINSEC: <br>  memory_mb: MEMUSAGEINMB: - memory in Mb <br>  bytes_read: BYTESREAD: - byte read <br>  bytes_write: BYTESWRITE: -, fqn pfgbcfyj <br>  hostnm: HOSTNAME: - the request was made on the server ... <br>  Filter fields: <br>  : FILTER: - consider filter fields <br>  : PERIOD: - take into account the entered period <br>  performance -: TBL: - table alias <br><br>  Example: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> t1, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(:CPUUSAGE:)/<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> t2, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(:MEMUSAGEINPRC T:)/<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> t3, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(:BYTESREAD:+:BYTESWRITE:)/<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> t4, :CALLEDSCRIPT:, :FORHOST: <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> :TBL: <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> :FILTER: <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">PERIOD</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> :CALLEDSCRIPT:,: FORHOST:</code> </pre><br><br><h3>  Saving data in one centralized repository </h3><br>  Configuring the module for working with centralized storage: <br>  1) in a centralized repository (MySQL, PostgreSQL), you must create a user, database and table. <br>  <i>MySQL: CREATE TABLE IF NOT EXISTS performance (id INT NOT NULL AUTO_INCREMENT, dateadd DATETIME, host VARCHAR (255), uri VARCHAR (512), script VARCHAR (512), cpu FLOAT (15.5), memory FLOAT (15.5 ), exc_time FLOAT (15.5), cpu_sec FLOAT (15.5), memory_mb FLOAT (15.5), bytes_read FLOAT (15.5), bytes_write FLOAT (15.5), hostnm CHAR (32), PRIMARY KEY (id))</i> <i><br></i>  <i>PostgreSQL: create table performance (id SERIAL, dateadd timestamp, host varchar (255), uri varchar (512), script varchar (512), cpu float (4), memory float (4), exc_time float (4), cpu_sec float (4), memory_mb float (4), bytes_read float (4), bytes_write float (4), hostnm char (32), PRIMARY KEY (id))</i> <br>  2) on servers from which data will be collected to register in mod_performance.conf <br>  <i>PerformanceLogType MySQL or Postgres</i> <i><br></i>  <i>PerformanceHostId HostName (enter a unique name for each host, for example its IP or other)</i> <i><br></i>  <i>PerformanceDbUserName username</i> <i><br></i>  <i>PerformanceDBPassword userpassword</i> <i><br></i>  <i>PerformanceDBName dbname</i> <i><br></i>  <i>PerformanceDBHost hostname - IP address or server name with centralized data storage</i> <br><br><h2>  For those who have installed the module version 0.3 </h2><br>  In version 0.4, the data table format was changed.  For the 0.4 version to work correctly, the old table needs to be modified: <br>  <b>SQLITE: ALTER TABLE performance ADD hostnm CHAR (32)</b> <b><br></b>  <b>MySQL: ALTER TABLE performance ADD hostnm CHAR (32)</b> <b><br></b>  <b>PostreSQL: ALTER TABLE performance ADD hostnm CHAR (32)</b> <br><br><h2>  Links and documentation </h2><br>  <b>Documentation section mod_performance 0.4:</b> <br>  <a href="http://wiki.bayrepo.net/ru/docs">http://wiki.bayrepo.net/ru/docs</a> <br>  <a href="http://wiki.bayrepo.net/en/docs">http://wiki.bayrepo.net/en/docs</a> <br><br>  <b>Download module:</b> <br><pre> <code class="bash hljs">wget http://git.bayrepo.net/modperformance/snapshot/modperformance-master.tar.gz</code> </pre></div><p>Source: <a href="https://habr.com/ru/post/240735/">https://habr.com/ru/post/240735/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../240721/index.html">Another critical vulnerability in Drupal 7</a></li>
<li><a href="../240725/index.html">Configuring a dedicated server for the site running HostCMS</a></li>
<li><a href="../240727/index.html">Zyxel Keenetic + DAS CFI = Budget NAS?</a></li>
<li><a href="../240731/index.html">Travel notes introduction engineer: Spanish passion at the box office</a></li>
<li><a href="../240733/index.html">How to create a blog on github.io using CMS Ghost</a></li>
<li><a href="../240737/index.html">How Odesk Freelancers Merge</a></li>
<li><a href="../240741/index.html">Tab List and Print View in Opera Developer 26</a></li>
<li><a href="../240743/index.html">PayPal has limited the amount of anonymous payments in Russia</a></li>
<li><a href="../240745/index.html">Cloud-IX from TelecityGroup - it's easier to connect to the "cloud"</a></li>
<li><a href="../240747/index.html">VexorCI - a fresh look at continuous integration</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>