<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reverse Engineering Visual Stories</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to admit: I adore visual novels. Who does not know - these are either interactive books, or games ‚Äî in which ‚Äî it is necessary ‚Äî mostly ‚Äî read-...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reverse Engineering Visual Stories</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/77c/2b0/ac6/77c2b0ac67b742569ae0c7f0aad791c6.png" align="right">  I want to admit: I adore visual novels.  Who does not know - these are either interactive books, or games ‚Äî in which ‚Äî it is necessary ‚Äî mostly ‚Äî read-text, or radio plays-with-pictures, predominantly Japanese.  For the last 5 years, I probably don‚Äôt accept any fiction in another format: visual novels have much more immersive experience than visual books, audio books and even TV series. </p><a name="habracut"></a><br><p>  And since my childhood I love to understand how things are arranged and what is inside them.  He started from the first broken toys, grew to reverse engineering and virus analyst in one not the smallest company.  And it occurred to me - why not try to combine these things?  See what the visual stories are inside and figure out what this or that engine is based on? </p><br><p>  And then just recently released <a href="http://kaitai.io/">Kaitai Struct</a> release - this is such a new framework for reverse engineering of binary data structures (although the authors are actively unlocked, saying that they are all just for peaceful purposes).  The idea there is trivial, but it is captivating: declaratively describing a data structure in a certain markup language - and then you get a ready-made class library for parsing in any supported programming language.  Included are a visualizer (to make it easier to check) and, in fact, a compiler.  Well, let's try, what is it good for? </p><br><p>  As a warm-up, and at the same time, in order to show the typical actions that you will encounter in reverse engineering, I suggest starting with something not very trivial, namely, the wonderful visual novel <a href="https://vndb.org/v13353">Koisuru Shimai no Rokujuso</a> (in the original - ÊÅã „Åô „Çã ÂßâÂ¶πÂÖ≠ ÈáçÂ•è) authorship is widely known in narrow circles of PeasSoft.  This is a fun, non-addictive romantic comedy, with traditionally beautiful visuals for PeasSoft.  From the point of view of reversing, she hooked me up with the fact that she uses her own engine, which is not widely used and seems to have not been studied by anyone yet.  And this is at least more interesting than picking on <a href="http://kikyou.info/tvp/">KiriKiri</a> or <a href="https://www.renpy.org/">Ren'Py,</a> already completely tortured and <a href="http://kikyou.info/tvp/">driven apart</a> . </p><br><p>  First of all, here is a list of the tools we need: </p><br><ul><li>  <a href="http://kaitai.io/">Kaitai Struct</a> - compiler and visualizer to it </li><li>  <a href="https://java.com/download">Java JRE</a> - unfortunately, Kaitai Struct is written <strike>in Java</strike> on Scala and requires either JRE or node.js, but I have not tried with node.js </li><li>  Any programming language supported by KS (currently Java, JavaScript, Ruby, Python) - I will use <a href="https://www.ruby-lang.org/">Ruby</a> , but this is not so important, we will write a lister and an extractor at the very end </li><li>  some kind of hex editor - by and large, no matter what, they are all imperfect;  in principle, the hex editor is inside the KS visualizer, but it is also not the most convenient;  I personally use <a href="https://utils.kde.org/projects/okteta/">okteta</a> (simply because there is a humanly convenient copy-paste) - but almost anything will go - there would be an opportunity to watch the dump, go to the specified address and quickly copy the selected piece to a separate file </li></ul><br><p>  Next you need the product of the study itself - the distribution of the visual novel.  Here, too, was lucky: PeasSoft on its website puts out trial versions for completely legal free download, which are enough for us to become familiar with the formats.  On the site you need to find such a page: </p><br><p><img src="https://habrastorage.org/files/403/580/6f9/4035806f9fda447b9fe7b06b9c8380c6.png" alt="image"></p><br><p>  Circled in blue - in fact, links to myrrh (all the same), where they give download trial. </p><br><p>  After downloading and unpacking the distribution, we start by collecting information.  Let's think about what we already know about our exhibit.  First, the platform.  At least the version that is distributed on the site works under Windows on Intel processors (in general, there is another version under Android, but in practice it is sold only in application markets of Japanese cellular operators, plus it is nontrivially pulled from the phone).  From the fact that this is Windows / Intel, several very likely things follow: </p><br><ul><li>  integers in binary formats will be encoded in little-endian </li><li>  Windows programmers in Japan are still <strike>living in the Stone Age</strike> using Shift-JIS encoding </li><li>  the ends of the lines, if we meet them once in an explicit form, will be denoted by "\ r \ n", and not just "\ n" </li></ul><br><p>  A quick inspection of the unpacked and installed shows that the mining consists of: </p><br><ul><li>  data01.ykc - 8393294 </li><li>  data02.ykc - 560418878 </li><li>  data03.ykc - 219792804 </li><li>  sextet.exe - 978944 </li><li>  AVI / op.mpg - 122152964 </li></ul><br><p>  Those.  there is one small exe-schnick (obviously, with the engine), several giant .ykc files (probably, archives with content) and op.mpg - a video file with a splash screen (which you can verify immediately by opening it with any player). </p><br><p>  It is useful to quickly visually inspect the exe-file in the hex editor: modern developers are even quite adequate and often use ready-made libraries for working with images, sounds and music.  And such libraries, as a rule, leave some signatures visible with the naked eye when compiled.  What to look for: </p><br><ul><li>  "libpng version 1.0.8 - July 24, 2000" - libpng is used, it means the pictures will be in png format </li><li>  "zlib version error", "Unknown zlib error" - means that zlib compression will be used;  may in fact be a false trace, since  zlib compression is used when encoding png;  until we make far-reaching conclusions </li><li>  "Xiph.Org libVorbis I 20020717" - libvorbis, which means that music, speech and sounds will most likely be in ogg / vorbis </li><li>  "Corrupt JPEG data", "Premature end of JPEG file" - lines from libjpeg;  if there is - it means that the engine is most likely able to also pictures in jpg format </li><li>  "D3DX8 Shader Assembler Version 0.91" - somewhere inside something uses the shaders D3DX8 </li><li> scattering of messages like "Microsoft Visual C ++ Runtime Library", " <code>local vftable'", "</code> eh vector constructor iterator'", etc.  tells us that this has been linked with the Microsoft C ++ library, and, most likely, written in C ++;  if you want, you can rummage and find out even a specific version, but now we don‚Äôt need it especially - we are not going to disassemble it or something, we have an absolutely honest clean room </li></ul><br><p>  You can also search for lines like "version", "copyright", "compiler", "engine", "script" - moreover, since  This is a Windows file, do not forget to do it also in double-byte encodings like UTF16-LE - sometimes there is something else interesting.  We have, for example, "Yuka Compiler Error", "YukaWindowClass", "YukaApplicationWindowClass", "YukaSystemRunning", as well as references to "start.yks", "system.ykg".  From all this, it is logical to assume that the programmers themselves called their engine something like "Yuka", and all the types of files used by them all start with yk - ykc, yks, ykg.  There is also "CDPlayMode" and "CDPlayTime" - from which we can assume that the engine can play music from Audio CD tracks, and also "MIDIStop" and "MIDIPlay" - from which we can assume support for MIDI music. </p><br><p><img src="https://habrastorage.org/files/eb2/ffc/19c/eb2ffc19c28740578764c169fd9c1575.png" alt="image"></p><br><p>  According to our novel in the dry residue, a rather optimistic picture is obtained: </p><br><ul><li>  pictures in png and jpg formats, which immediately simplifies the task by an order of magnitude - most likely you will not need to dig into custom image compression formats </li><li>  music, speech and sounds - most likely in ogg (but maybe MIDI and CDDA - although not likely, because there is no physical carrier) </li></ul><br><p>  Initial information is collected - now you can roll up your sleeves and dive into the files.  In fact, there are several files - and this is also good.  In general, reverse engineering is often very important to become a purely statistical question, when a studied object can be obtained more than one in different variations and see how they differ.  It is much more difficult to guess what the next 7F 02 00 00 means when you have it exactly one. </p><br><p>  Check if the files have the same format.  Judging by the fact that all of them - data * .ykc - one.  We look inside the beginning of the file: everything starts with "YKC001 \ 0 \ 0" - very good, it seems that these are really archives of the same format. </p><br><p>  Quickly empirically check if some kind of compression is used.  We take any archiver, try to compress the file and see how much it was before and how much it became after.  I stupidly used zip: </p><br><ul><li>  to - 8393294 </li><li>  after - 6758313 </li></ul><br><p>  It is compressed, but not much.  Most likely the same or no compression, or it is not for all files.  On the other hand, if some png or ogg are in the archive ‚Äî they are already compressed, they will not be compressed with zip. </p><br><p>  For general reasons, almost any archive has some kind of header, as a rule, there is a directory of archive contents (relatively small), and 99% of the archive file is occupied, the actual content is attached files or data blocks.  The title, by the way, does not necessarily start right from the beginning of the file ‚Äî perhaps with some stepping back from the end of the file or some (usually a little) from the beginning.  It is extremely rare to find a file starting from the very beginning of a career to read from the middle. </p><br><p>  We look at the beginning of the files.  We see approximately the following picture: </p><br><p><img src="https://habrastorage.org/files/d02/006/389/d020063892b74ce68b211b3d3e1bbcad.png" alt="image"></p><br><ul><li>  <code>59 4B 43 30 ‚îÇ 30 31 00 00</code> - this is obviously just the signature of the file, in ASCII this is "YKC001", most likely it means something like "Yuka Container", version 001 </li><li>  <code>18 00 00 00 ‚îÇ 00 00 00 00 ‚îÇ 1A 00 80 00 ‚îÇ 34 12 00 00</code> - apparently, this is the title </li><li>  then the body of some file inside the archive clearly begins;  This is especially well seen in data02.ykc - there are lines of some kind of either a config, or a scripting language: "WindowSize = 1280, 800", "TransitionWaitType = 2", etc .;  those.  look no further </li></ul><br><p>  We look at how the header looks in all three files we have: </p><br><ul><li>  data01.ykc: <code>18 00 00 00 ‚îÇ 00 00 00 00 ‚îÇ 1A 00 80 00 ‚îÇ 34 12 00 00</code> </li><li>  data02.ykc: <code>18 00 00 00 ‚îÇ 00 00 00 00 ‚îÇ 4E E1 66 21 ‚îÇ F0 6E 00 00</code> </li><li>  data03.ykc: <code>18 00 00 00 ‚îÇ 00 00 00 00 ‚îÇ 5C E1 18 0D ‚îÇ 48 E4 00 00</code> </li></ul><br><p>  What is "18 00 00 00 ‚îÇ 00 00 00 00" is still not clear, but it is the same everywhere.  The other 2 fields are much more interesting - these are obviously two 4-byte integers.  It seems, it is time to get Kaitai Struct and begin to describe the received guesses in the form of a ksy format: </p><br><pre> <code class="hljs objectivec">meta: <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: ykc application: Yuka Engine endian: le seq: - <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: magic contents: [<span class="hljs-string"><span class="hljs-string">"YKC001"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>] - <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: magic2 contents: [<span class="hljs-number"><span class="hljs-number">0x18</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>] - <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: unknown1 type: u4 - <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: unknown2 type: u4</code> </pre> <br><p>  It seems to be nothing complicated.  ksy are actually ordinary YAML files.  The "meta" section describes what we are actually working on and what we have gathered following the results of our preliminary investigation - i.e.  that we parse the "ykc" files, presumably processes their application called "Yuka Engine" (the "application" field doesn‚Äôt seem to affect anything, this is a comment), and by default the integers will be in little endian format (endian: le ). </p><br><p>  Next comes a description of how to parse the file and what data structures we found in it - this is specified by an array of fields in the "seq" section.  Each field must have an id (and this is logical, for the sake of it we work to understand what lies where) and a description of the content.  Here we used two constructions: </p><br><ul><li>  The <code>contents: [0x18, 0, 0, 0, 0, 0, 0, 0]</code> type construct <code>contents: [0x18, 0, 0, 0, 0, 0, 0, 0]</code> specifies a field with fixed content.  It works like this: the content automatically follows its length, plus KS will automatically make a check and throw an exception if the content does not match the expected when reading such a field </li><li>  Type construction <code>type: u4</code> specifies the type field "unsigned integer (_u_nsigned) number, length 4 bytes".  Endianness is the same as we specified in meta. </li></ul><br><p>  Now we load our new format into the visualizer: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ksv</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">data01</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ykc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ykc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ksy</span></span></code> </pre> <br><p>  and see for data01.ykc: </p><br><p><img src="https://habrastorage.org/files/08a/e82/830/08ae828304f54b54ac3ab2bb5dd33db9.png" alt="image"></p><br><p>  Yes, the visualizer works in the console, you can start to feel like a hacker.  But now we are interested in the structure tree: </p><br><pre> <code class="hljs scala">[-] [root] [.] <span class="hljs-meta"><span class="hljs-meta">@magic</span></span> = <span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>b <span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@magic</span></span>2 = <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>1 = <span class="hljs-number"><span class="hljs-number">8388634</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>2 = <span class="hljs-number"><span class="hljs-number">4660</span></span></code> </pre> <br><p>  In the visualizer, you can use the arrows to walk through the fields, you can switch to the hex viewer and back by pressing Tab, and by pressing Enter you can fall into the contents of the fields, open instances (you will see about them below) and view hex dumps in full screen.  To save space and time, I‚Äôll not show any more screenshots of the visualizer, I‚Äôll only show the part with the text tree. </p><br><p>  We look for data02.ykc: </p><br><pre> <code class="hljs scala">[-] [root] [.] <span class="hljs-meta"><span class="hljs-meta">@magic</span></span> = <span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>b <span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@magic</span></span>2 = <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>1 = <span class="hljs-number"><span class="hljs-number">560390478</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>2 = <span class="hljs-number"><span class="hljs-number">28400</span></span></code> </pre> <br><p>  for data03.ykc: </p><br><pre> <code class="hljs scala">[-] [root] [.] <span class="hljs-meta"><span class="hljs-meta">@magic</span></span> = <span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>b <span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@magic</span></span>2 = <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>1 = <span class="hljs-number"><span class="hljs-number">219734364</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>2 = <span class="hljs-number"><span class="hljs-number">58440</span></span></code> </pre> <br><p>  Sparsely, in general.  There is no file directory, where to look for the ends, at first glance, is not clear.  Now is the time to recall once again how much these files occupy and estimate whether one of these two can be a link somewhere else: </p><br><ul><li>  data01.ykc - 8393294 @ unknown1 = 8388634 </li><li>  data02.ykc - 560418878 @ unknown1 = 560390478 </li><li>  data03.ykc - 219792804 @ unknown1 = 219734364 </li></ul><br><p>  What a striking resemblance.  Let's check what lies there by this offset: </p><br><pre> <code class="hljs objectivec">meta: <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: ykc application: Yuka Engine endian: le seq: - <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: magic contents: [<span class="hljs-string"><span class="hljs-string">"YKC001"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>] - <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: magic2 contents: [<span class="hljs-number"><span class="hljs-number">0x18</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>] - <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: unknown_ofs type: u4 - <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: unknown2 type: u4 instances: unknown3: pos: unknown_ofs size-eos: <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br><p>  We have added the description of this field "unknown3".  This time it went not to the "seq" section, but to the "instances" section.  In fact, these are approximately the same fields that can be described in "seq", but they do not go in order, but have an explicit indication of where to read them (at what offset, from which stream, etc.).  We have indicated that we want to have a field called "unknown3" (we do not yet know what is there), starting from the offset unknown_ofs ( <code>pos: unknown_ofs</code> ) and continuing to the end of the file ( <code>size-eos: true</code> ).  As you do not know, what is there - just a stream of bytes will be read to us.  Yes, while it is not enough, but with this you can already try to live.  We try: </p><br><p>  Immediately pay attention to the fact that the length of what we read was strikingly similar to the contents of the unknown2 field.  Those.  it seems that at the beginning of the YKC file there is simply an indication of the offset and what size of the actual file header.  Correct our format file to reflect this guess: </p><br><pre> <code class="hljs objectivec">meta: <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: ykc application: Yuka Engine endian: le seq: - <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: magic contents: [<span class="hljs-string"><span class="hljs-string">"YKC001"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>] - <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: magic2 contents: [<span class="hljs-number"><span class="hljs-number">0x18</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>] - <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: header_ofs type: u4 - <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: header_len type: u4 instances: header: pos: header_ofs size: header_len</code> </pre> <br><p>  The changes are minor: we renamed all unknown-fields to reflect their meaning, and "size-eos: true" (read all of them to the end of the file) changed to "size: header_len".  Most likely this closely matches the plan of the person who invented this format.  Load again and now we are concentrating on the data block that we called the "header".  Here is what its beginning for data01.ykc looks like: </p><br><pre> <code class="hljs go"><span class="hljs-number"><span class="hljs-number">000000</span></span>: <span class="hljs-number"><span class="hljs-number">57</span></span> e7 <span class="hljs-number"><span class="hljs-number">7f</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>a <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> | W............... <span class="hljs-number"><span class="hljs-number">000010</span></span>: <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> e7 <span class="hljs-number"><span class="hljs-number">7f</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>b <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>b <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> | ....a.......+... <span class="hljs-number"><span class="hljs-number">000020</span></span>: db <span class="hljs-number"><span class="hljs-number">2</span></span>a <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c e7 <span class="hljs-number"><span class="hljs-number">7f</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> | .*......l....... <span class="hljs-number"><span class="hljs-number">000030</span></span>: <span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">2d</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">92</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">7d</span></span> e7 <span class="hljs-number"><span class="hljs-number">7f</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> | .-..........}...</code> </pre> <br><p>  for data02.ykc: </p><br><pre> <code class="hljs erlang-repl"><span class="hljs-number"><span class="hljs-number">000000</span></span>: d1 <span class="hljs-number"><span class="hljs-number">2</span></span>b <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>c <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>a <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> | .+f!........Z... <span class="hljs-number"><span class="hljs-number">000010</span></span>: <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> dd <span class="hljs-number"><span class="hljs-number">2</span></span>b <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> | .....+f!....r... <span class="hljs-number"><span class="hljs-number">000020</span></span>: <span class="hljs-number"><span class="hljs-number">26</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>a <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> f1 <span class="hljs-number"><span class="hljs-number">2</span></span>b <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> | &amp;........+f!.... <span class="hljs-number"><span class="hljs-number">000030</span></span>: <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>e <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> a8 <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>c <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> | .....<span class="hljs-number"><span class="hljs-number">2</span></span>.......,f!</code> </pre> <br><p>  for data03.ykc: </p><br><pre> <code class="hljs go"><span class="hljs-number"><span class="hljs-number">000000</span></span>: ec <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">0d</span></span> <span class="hljs-number"><span class="hljs-number">26</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">48</span></span> fd <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> | <span class="hljs-number"><span class="hljs-number">.0</span></span>..&amp;.......H... <span class="hljs-number"><span class="hljs-number">000010</span></span>: <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">0d</span></span> <span class="hljs-number"><span class="hljs-number">26</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">60</span></span> fd <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> | ....<span class="hljs-number"><span class="hljs-number">.1</span></span>..&amp;...<span class="hljs-string"><span class="hljs-string">`... 000020: 0d 82 03 00 00 00 00 00 38 31 17 0d 26 00 00 00 | ........81..&amp;... 000030: 6d 7f 04 00 d0 85 01 00 00 00 00 00 5e 31 17 0d | m...........^1..</span></span></code> </pre> <br><p>  At first glance, nothing is clear and there is nothing in common.  At second glance, in fact, the eye clings to a sequence of repeating bytes.  In the first file this is <code>e7 7f</code> , in the second - <code>2b 66</code> , in the third - <code>30 17</code> and <code>31 17</code> .  It is very likely that we are dealing with repeated records of fixed length and this length is 0x14 (i.e., 20) bytes.  By the way, this agrees well with the lengths of the header in all three files: both 4660 and 28400 and 58440 are divided by 20. Let's test this hypothesis: </p><br><pre> <code class="hljs pgsql">meta: id: ykc application: Yuka Engine endian: le seq: - id: magic contents: ["YKC001", <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>] - id: magic2 contents: [<span class="hljs-number"><span class="hljs-number">0x18</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>] - id: header_ofs <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: u4 - id: header_len <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: u4 instances: <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>: pos: header_ofs size: header_len <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">header</span></span> <span class="hljs-keyword"><span class="hljs-keyword">types</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>: seq: - id: entries size: <span class="hljs-number"><span class="hljs-number">0x14</span></span> repeat: eos</code> </pre> <br><p>  Notice what happened with the instance "header".  It still starts with header_ofs and has a length of header_len, but also added a <code>type: header</code> indication.  Unlike "u4" (integer), we will now declare and use a custom type, and the entire block "header" will be parsed by this type.  Below is a description of the type "header" - see "types: header:".  As you can guess from the appearance and the word "seq" - then follows exactly the same syntax as at the top level of the file.  Those.  inside our new type of header, you can also specify fields that will be read from the very beginning of the block sequentially (in "seq"), fields on certain offsets (in "instances"), their subtypes (in "types"), etc. . </p><br><p>  So, we set the type "header", consisting so far from one field of entries, having a size of 0x14 bytes, but repeated as many times as possible until the end of the stream ( <code>repeat: eos</code> ).  By the way, the stream in this case is already considered the header block, which we explicitly declared as a block in header_len bytes, starting with header_ofs.  Those.  if there was something else behind it - it would not be read, everything is in order. </p><br><p>  Look what happened: </p><br><pre> <code class="hljs ruby"> [-] header [-] @entries (<span class="hljs-number"><span class="hljs-number">233</span></span> = <span class="hljs-number"><span class="hljs-number">0xe9</span></span> entries) [.] <span class="hljs-number"><span class="hljs-number">0</span></span> = <span class="hljs-number"><span class="hljs-number">57</span></span> e7 <span class="hljs-number"><span class="hljs-number">7</span></span>f <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-params"><span class="hljs-params">|0a 00 00 00|</span></span><span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-params"><span class="hljs-params">|13 02 00 00|</span></span><span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [.] <span class="hljs-number"><span class="hljs-number">1</span></span> = <span class="hljs-number"><span class="hljs-number">61</span></span> e7 <span class="hljs-number"><span class="hljs-number">7</span></span>f <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-params"><span class="hljs-params">|0b 00 00 00|</span></span><span class="hljs-number"><span class="hljs-number">2</span></span>b <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-params"><span class="hljs-params">|db 2a 00 00|</span></span><span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [.] <span class="hljs-number"><span class="hljs-number">2</span></span> = <span class="hljs-number"><span class="hljs-number">6</span></span>c e7 <span class="hljs-number"><span class="hljs-number">7</span></span>f <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-params"><span class="hljs-params">|11 00 00 00|</span></span><span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>d <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-params"><span class="hljs-params">|92 16 00 00|</span></span><span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [.] <span class="hljs-number"><span class="hljs-number">3</span></span> = <span class="hljs-number"><span class="hljs-number">7</span></span>d e7 <span class="hljs-number"><span class="hljs-number">7</span></span>f <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-params"><span class="hljs-params">|14 00 00 00|</span></span><span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-params"><span class="hljs-params">|69 25 00 00|</span></span><span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [.] <span class="hljs-number"><span class="hljs-number">4</span></span> = <span class="hljs-number"><span class="hljs-number">91</span></span> e7 <span class="hljs-number"><span class="hljs-number">7</span></span>f <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-params"><span class="hljs-params">|15 00 00 00|</span></span><span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-params"><span class="hljs-params">|d7 12 00 00|</span></span><span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [.] <span class="hljs-number"><span class="hljs-number">5</span></span> = a6 e7 <span class="hljs-number"><span class="hljs-number">7</span></span>f <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-params"><span class="hljs-params">|12 00 00 00|</span></span>d8 <span class="hljs-number"><span class="hljs-number">7</span></span>b <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-params"><span class="hljs-params">|27 3f 07 00|</span></span><span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span></code> </pre> <br><p>  Well, not bad.  Some kind of common record is clearly visible.  From sports interest we will look at the second file: </p><br><pre> <code class="hljs ruby"> [-] header [-] @entries (<span class="hljs-number"><span class="hljs-number">1420</span></span> = <span class="hljs-number"><span class="hljs-number">0x58c</span></span> entries) [.] <span class="hljs-number"><span class="hljs-number">0</span></span> = d1 <span class="hljs-number"><span class="hljs-number">2</span></span>b <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span><span class="hljs-params"><span class="hljs-params">|0c 00 00 00|</span></span><span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-params"><span class="hljs-params">|5a 04 00 00|</span></span><span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [.] <span class="hljs-number"><span class="hljs-number">1</span></span> = dd <span class="hljs-number"><span class="hljs-number">2</span></span>b <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span><span class="hljs-params"><span class="hljs-params">|14 00 00 00|</span></span><span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-params"><span class="hljs-params">|26 1a 00 00|</span></span><span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [.] <span class="hljs-number"><span class="hljs-number">2</span></span> = f1 <span class="hljs-number"><span class="hljs-number">2</span></span>b <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span><span class="hljs-params"><span class="hljs-params">|16 00 00 00|</span></span><span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>e <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-params"><span class="hljs-params">|a8 32 00 00|</span></span><span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [.] <span class="hljs-number"><span class="hljs-number">3</span></span> = <span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>c <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span><span class="hljs-params"><span class="hljs-params">|16 00 00 00|</span></span><span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">51</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-params"><span class="hljs-params">|a2 16 00 00|</span></span><span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [.] <span class="hljs-number"><span class="hljs-number">4</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>d <span class="hljs-number"><span class="hljs-number">2</span></span>c <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span><span class="hljs-params"><span class="hljs-params">|16 00 00 00|</span></span>e2 <span class="hljs-number"><span class="hljs-number">67</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-params"><span class="hljs-params">|89 c4 00 00|</span></span><span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [.] <span class="hljs-number"><span class="hljs-number">5</span></span> = <span class="hljs-number"><span class="hljs-number">33</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>c <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span><span class="hljs-params"><span class="hljs-params">|16 00 00 00|</span></span><span class="hljs-number"><span class="hljs-number">6</span></span>b <span class="hljs-number"><span class="hljs-number">2</span></span>c <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-params"><span class="hljs-params">|fa f5 00 00|</span></span><span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span></code> </pre> <br><p>  By the way, "233" and "1420" records is quite similar to the number of files in the archive.  The first archive we have is small (8 megabytes), for 233 files - we get an average of 36022 bytes per file.  It is quite similar to some scripts, configs, script files, etc.  The second archive is the largest (560 megabytes), with 1420 files - 394661 bytes per file, quite similar to some pictures or files with voice recordings. </p><br><p>  <code>57 e7 7f 00</code> , <code>61 e7 7f 00</code> , <code>6c e7 7f 00</code> , etc.  - this is clearly a sequence of increasing numbers, what could it mean?  In the second file, these are, respectively, <code>d1 2b 66 21</code> , <code>dd 2b 66 21</code> , <code>f1 2b 66 21</code> .  Stop, somewhere I have already seen these numbers.  We look at the very beginning of our research - for sure.  This is close to the length of the entire archive file.  So this is again pointers to something inside the file.  Actually, let's describe the structure of these 20-byte records.  It seems to be clear from the appearance that it is trite 5 integers.  We describe another type of "file_entry".  In your silent permission, I will not list the entire ksy file as a whole, but I will give only the changed types section: </p><br><pre> <code class="hljs scala">types: header: seq: - id: entries repeat: eos <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: file_entry file_entry: seq: - id: unknown_ofs <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: unknown2 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: unknown3 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: unknown4 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: unknown5 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4</code> </pre> <br><p>  There are no new designs here.  Added "type" to the entries field and described this very type as 5 consecutive integers (of type u4).  Look what happened: </p><br><pre> <code class="hljs scala"> [-] header [-] <span class="hljs-meta"><span class="hljs-meta">@entries</span></span> (<span class="hljs-number"><span class="hljs-number">233</span></span> = <span class="hljs-number"><span class="hljs-number">0xe9</span></span> entries) [-] <span class="hljs-number"><span class="hljs-number">0</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>_ofs = <span class="hljs-number"><span class="hljs-number">8382295</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>2 = <span class="hljs-number"><span class="hljs-number">10</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>3 = <span class="hljs-number"><span class="hljs-number">24</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>4 = <span class="hljs-number"><span class="hljs-number">531</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>5 = <span class="hljs-number"><span class="hljs-number">0</span></span> [-] <span class="hljs-number"><span class="hljs-number">1</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>_ofs = <span class="hljs-number"><span class="hljs-number">8382305</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>2 = <span class="hljs-number"><span class="hljs-number">11</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>3 = <span class="hljs-number"><span class="hljs-number">555</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>4 = <span class="hljs-number"><span class="hljs-number">10971</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>5 = <span class="hljs-number"><span class="hljs-number">0</span></span> [-] <span class="hljs-number"><span class="hljs-number">2</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>_ofs = <span class="hljs-number"><span class="hljs-number">8382316</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>2 = <span class="hljs-number"><span class="hljs-number">17</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>3 = <span class="hljs-number"><span class="hljs-number">11526</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>4 = <span class="hljs-number"><span class="hljs-number">5778</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>5 = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Another hypothesis emerges: unknown3 is a pointer to the beginning of the file body in the archive, and unknown4 is its length.  After all, 24 + 531 = 555, and 555 + 10971 = 11526. Ie  These are files inside the archive, which stupidly go sequentially.  A similar observation can be made for unknown_ofs and unknown2: 8382295 + 10 = 8382305, 8382305 + 11 = 8382316. That is, unknown2 is the length of some records starting with unknown_ofs.  unknown5, it seems, is always 0. Forward, we add two more fields inside each file_entry: read, content (unknown_ofs; unknown2) and the body of the file to (unknown3; unknown4).  I give only the description of file_entry: </p><br><pre> <code class="hljs scala"> file_entry: seq: - id: unknown_ofs <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: unknown_len <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: body_ofs <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: body_len <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: unknown5 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 instances: unknown: pos: unknown_ofs size: unknown_len io: _root._io body: pos: body_ofs size: body_len io: _root._io</code> </pre> <br><p>  From the new and nontrivial here there is only one construction: <code>io: _root._io</code> .  Without it, the <code>pos: body_ofs</code> , say, will count the body_ofs offset in the current thread, i.e.  in a stream consisting of 20 bytes file_entry.  Of course, an attempt to read the 8-millionth byte of 20 will lead to an error.  Therefore, we need this very special magic, which says that we will not read out from the current stream, but from the stream that corresponds to the file as a whole - <code>_root._io</code> . </p><br><p>  What happened: </p><br><pre> <code class="hljs scala"> [-] <span class="hljs-meta"><span class="hljs-meta">@entries</span></span> (<span class="hljs-number"><span class="hljs-number">233</span></span> = <span class="hljs-number"><span class="hljs-number">0xe9</span></span> entries) [-] <span class="hljs-number"><span class="hljs-number">0</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>_ofs = <span class="hljs-number"><span class="hljs-number">8382295</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>_len = <span class="hljs-number"><span class="hljs-number">10</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@body</span></span>_ofs = <span class="hljs-number"><span class="hljs-number">24</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@body</span></span>_len = <span class="hljs-number"><span class="hljs-number">531</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>5 = <span class="hljs-number"><span class="hljs-number">0</span></span> [-] unknown = <span class="hljs-number"><span class="hljs-number">73</span></span> <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>e <span class="hljs-number"><span class="hljs-number">79</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>b <span class="hljs-number"><span class="hljs-number">73</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [-] body = <span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>b <span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>‚Ä¶ [-] <span class="hljs-number"><span class="hljs-number">1</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>_ofs = <span class="hljs-number"><span class="hljs-number">8382305</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>_len = <span class="hljs-number"><span class="hljs-number">11</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@body</span></span>_ofs = <span class="hljs-number"><span class="hljs-number">555</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@body</span></span>_len = <span class="hljs-number"><span class="hljs-number">10971</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>5 = <span class="hljs-number"><span class="hljs-number">0</span></span> [-] unknown = <span class="hljs-number"><span class="hljs-number">73</span></span> <span class="hljs-number"><span class="hljs-number">79</span></span> <span class="hljs-number"><span class="hljs-number">73</span></span> <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">65</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>d <span class="hljs-number"><span class="hljs-number">2</span></span>e <span class="hljs-number"><span class="hljs-number">79</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>b <span class="hljs-number"><span class="hljs-number">67</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> [-] body = <span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>b <span class="hljs-number"><span class="hljs-number">47</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>‚Ä¶</code> </pre> <br><p>  Even with the naked eye you can see that <code>73 74 61 72 74 2e 79 6b 73 00</code> is an ASCII string, and by looking at the char representation, you can verify that it is ‚Äústart.yks‚Äù with the terminating 0 byte, and <code>73 79 73 74 65 6d 2e 79 6b 67 00</code> is "system.ykg".  Hooray, it looks like file names.  And about them we know for sure that they are strings.  Let's reflect this fact: </p><br><pre> <code class="hljs scala"> file_entry: seq: - id: filename_ofs <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: filename_len <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: body_ofs <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: body_len <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 - id: unknown5 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: u4 instances: filename: pos: filename_ofs size: filename_len <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: str encoding: <span class="hljs-type"><span class="hljs-type">ASCII</span></span> io: _root._io body: pos: body_ofs size: body_len io: _root._io</code> </pre> <br><p>  From innovations - <code>type: str</code> (means that the captured bytes must be interpreted as a string) and <code>encoding: ASCII</code> (we still do not exactly know what the encoding is, so let's take the path of least resistance).  We look in the visualizer: </p><br><pre> <code class="hljs scala"> [-] header [-] <span class="hljs-meta"><span class="hljs-meta">@entries</span></span> (<span class="hljs-number"><span class="hljs-number">233</span></span> = <span class="hljs-number"><span class="hljs-number">0xe9</span></span> entries) [-] <span class="hljs-number"><span class="hljs-number">0</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@filename</span></span>_ofs = <span class="hljs-number"><span class="hljs-number">8382295</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@filename</span></span>_len = <span class="hljs-number"><span class="hljs-number">10</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@body</span></span>_ofs = <span class="hljs-number"><span class="hljs-number">24</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@body</span></span>_len = <span class="hljs-number"><span class="hljs-number">531</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>5 = <span class="hljs-number"><span class="hljs-number">0</span></span> [-] filename = <span class="hljs-string"><span class="hljs-string">"start.yks\x00"</span></span> [-] body = <span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>b <span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>‚Ä¶ [-] <span class="hljs-number"><span class="hljs-number">1</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@filename</span></span>_ofs = <span class="hljs-number"><span class="hljs-number">8382305</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@filename</span></span>_len = <span class="hljs-number"><span class="hljs-number">11</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@body</span></span>_ofs = <span class="hljs-number"><span class="hljs-number">555</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@body</span></span>_len = <span class="hljs-number"><span class="hljs-number">10971</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>5 = <span class="hljs-number"><span class="hljs-number">0</span></span> [-] filename = <span class="hljs-string"><span class="hljs-string">"system.ykg\x00"</span></span> [-] body = <span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>b <span class="hljs-number"><span class="hljs-number">47</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>‚Ä¶ [-] <span class="hljs-number"><span class="hljs-number">2</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@filename</span></span>_ofs = <span class="hljs-number"><span class="hljs-number">8382316</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@filename</span></span>_len = <span class="hljs-number"><span class="hljs-number">17</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@body</span></span>_ofs = <span class="hljs-number"><span class="hljs-number">11526</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@body</span></span>_len = <span class="hljs-number"><span class="hljs-number">5778</span></span> [.] <span class="hljs-meta"><span class="hljs-meta">@unknown</span></span>5 = <span class="hljs-number"><span class="hljs-number">0</span></span> [-] filename = <span class="hljs-string"><span class="hljs-string">"SYSTEM\\black.PNG\x00"</span></span> [-] body = <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>e <span class="hljs-number"><span class="hljs-number">47</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>d <span class="hljs-number"><span class="hljs-number">0</span></span>a <span class="hljs-number"><span class="hljs-number">1</span></span>a <span class="hljs-number"><span class="hljs-number">0</span></span>a <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>d‚Ä¶</code> </pre> <br><p>  Beauty.  In fact, everything, we have already completed the task, this is enough to extract the files.  And now - the magic for which everything was started.  Let's write a script that will upload us all the files from one archive.  And for this we do not have to write a parsing of all these fields again.  We just take the ksc compiler and do: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ksc</span></span> -t ruby ykc.ksy</code> </pre> <br><p>  and we get in the current folder an excellent file ykc.rb, which you can immediately connect as a library and use.  How?  Let us show you how to warm up the listing of all archive files: </p><br><pre> <code class="ruby hljs">require_relative <span class="hljs-string"><span class="hljs-string">'ykc'</span></span> Ykc.from_file(<span class="hljs-string"><span class="hljs-string">'data01.ykc'</span></span>).header.entries.each { <span class="hljs-params"><span class="hljs-params">|f|</span></span> puts f.filename }</code> </pre> <br><p>  Inspires?  Just one line (not counting the library connection) - and that's it.  We start and see a healthy listing: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">start</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yks</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">system</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ykg</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SYSTEM</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">black</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.PNG</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SYSTEM</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">bt_click</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ogg</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SYSTEM</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">bt_select</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ogg</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SYSTEM</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yks</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SYSTEM</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Confirmation</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yks</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SYSTEM</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">confirmation_load</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.png</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SYSTEM</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">confirmation_no</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ykg</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SYSTEM</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">confirmation_no_load</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ykg</span></span> ...</code> </pre> <br><p>  Let's see what is happening here: </p><br><ul><li>  <code>Ykc.from_file(...)</code> - spawns an object of class Ykc from the specified file on disk;  In the fields of the object, what is described in the format is automatically parsed. </li><li>  <code>.header</code> - selects the "header" field of the class Ykc, thereby returning an instance of the class Ykc :: Header </li><li>  <code>.entries</code> - selects the "entries" field in the header, returns an array of elements of the class Ykc :: FileEntry </li><li> <code>.each { |f| ... }</code>  <code>.each { |f| ... }</code> - does something with each element of the array </li><li>  <code>puts f.filename</code> - displays the "filename" field of the f object (which is of class Ykc :: FileEntry) </li></ul><br><p>  Before you write the code that will extract all files from the archive, let's pay attention to a couple of facts: </p><br><ul><li>  First, there are folders in the paths, and since  This archive was made on a Windows system, and a backslash ("\") is used as a separator character for the path elements.  I don‚Äôt know how where, but at least in Ruby this results in the creation of a folder with backslashes in it.  To work correctly, everyone there mkdir_p will need to change the "\" to "/". </li><li>  Secondly, there is a terminating 0 in the file names at the end, apparently, we have a heavy legacy C. When printing, it is not visible, but for good it would also be worth removing. </li><li>  Third, in fact, an autopsy showed that there are files in data02.ykc that look something like this: </li></ul><br><pre> <code class="hljs tex">"SE<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>00050_<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>93d<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>98b<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>82P.ogg<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>00" "SE<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>00080_<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>83J<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>81[<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>83e<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>83<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>93.ogg<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>00" "SE<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>00090_<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>83`<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>83<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>83<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>83C<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>83<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>80.ogg<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>00" "SE<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>00130_<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>83h<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>83<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>93<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>83K<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>83`<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>83<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>83<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>82Q.ogg<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>00" "SE<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>00160_<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>91<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>96<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>82<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xE</span></span></span></span>8<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>8B<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>8E<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>82<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xE</span></span></span></span>9<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>82Q.ogg<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">x</span></span></span></span>00"</code> </pre> <br><p>  Remembering the hypothesis from the very beginning of the article that programmers were clearly Japanese and it could be ShiftJIS, we change the encoding of the filename to "SJIS", actively consoling ourselves with the idea that for those who use non-ASCII characters in file names prepared special circle in hell.  Do not forget to recompile ksy =&gt; rb, check, now everything is in order: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">SE</span></span>\00050_ÈõªË©±Ôºë<span class="hljs-selector-class"><span class="hljs-selector-class">.ogg</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SE</span></span>\00080_„Ç´„Éº„ÉÜ„É≥<span class="hljs-selector-class"><span class="hljs-selector-class">.ogg</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SE</span></span>\00090_„ÉÅ„É£„Ç§„É†<span class="hljs-selector-class"><span class="hljs-selector-class">.ogg</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SE</span></span>\00130_„Éâ„É≥„Ç¨„ÉÅ„É£Ôºí<span class="hljs-selector-class"><span class="hljs-selector-class">.ogg</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SE</span></span>\00160_Ëµ∞„ÇäÂéª„ÇãÔºí<span class="hljs-selector-class"><span class="hljs-selector-class">.ogg</span></span></code> </pre> <br><p>  Well, it‚Äôs not quite alright, but it‚Äôs quite similar to Japanese.  Using at least a google translate, you can check that "ÈõªË©±" is a "phone", and "SE \ 00050" is probably the sound effect of a phone ringing. </p><br><p>  The final upload script just looks like this: </p><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'fileutils'</span></span> require_relative <span class="hljs-string"><span class="hljs-string">'ykc'</span></span> EXTRACT_PATH = <span class="hljs-string"><span class="hljs-string">'extracted'</span></span> ARGV.each { <span class="hljs-params"><span class="hljs-params">|ykc_fn|</span></span> Ykc.from_file(ykc_fn).header.entries.each { <span class="hljs-params"><span class="hljs-params">|f|</span></span> filename = f.filename.strip.encode(<span class="hljs-string"><span class="hljs-string">'UTF-8'</span></span>).gsub(<span class="hljs-string"><span class="hljs-string">"\\"</span></span>, <span class="hljs-string"><span class="hljs-string">'/'</span></span>) dirname = File.dirname(filename) FileUtils::mkdir_p(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{EXTRACT_PATH}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{dirname}</span></span></span><span class="hljs-string">"</span></span>) File.write(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{EXTRACT_PATH}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{filename}</span></span></span><span class="hljs-string">"</span></span>, f.body) } }</code> </pre> <br><p>  Not a single line, of course, but, on the other hand, there is nothing to comment on here either.  From the command line arguments we get the names of files with archives (it is quite possible to run something like ./extract-ykc * .ykc - it works), we cast the necessary file name from f.filename, create, if necessary, folders in the path,      f.body        . </p><br><p>    ‚Äî  ,     ,   .    ,     png (     ),    ‚Äî  ogg (     ). , ,    BG    : </p><br><p><img src="https://habrastorage.org/files/5d5/b91/2c5/5d5b912c598045e9ae6be17e672100ae.png" alt="image"></p><br><p>    TA/   ,    . , ,  : </p><br><p><img src="https://habrastorage.org/files/209/a80/f3b/209a80f3b363488cbb02b23fd05adc1a.png" alt="image"></p><br><p>       .  ,   ‚Äî    yks  ykg ‚Äî ,        .    ‚Äî      . ,      :) </p><br><p>         KS: </p><br><ul><li> Kaitai Struct    ,     ,         .     ‚Äî ,  ,        - Ruby  Python:  ,     ,  ‚Äî    .      - ""   101  Hexinator ‚Äî     (    ‚Äî   ). </li><li>  Kaitai Struct ‚Äî  ,     , ,  ,  ,      .    -    okteta. </li><li> -, ,    ,     .         ,    .           +  exe-. </li><li>   ksy   (    ,        ‚Äî , ,  ,      ,        ),   ,  ,   .   ‚Äî    , ,    KS.      <code>io: _root._io</code> ‚Äî   ,    . ,   1.0      . </li></ul><br><p> <strong>UPDATE</strong> :          . ,     ‚Äî       .   , ,    . <br> <strong>UPDATE 2</strong> :  <a href="https://habrahabr.ru/post/281595/"></a> ,     ,   KS ‚Äî <a href="https://habrahabr.ru/users/greycat/" class="user_link">GreyCat</a> ‚Äî   .       . <br> <strong>UPDATE 3</strong> :  <a href="https://github.com/kaitai-io/kaitai_struct_visualizer/"></a> .   <code>gem install kaitai-struct-visualizer</code> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/281595/">https://habr.com/ru/post/281595/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../281581/index.html">Infographics: fraud in RuNet</a></li>
<li><a href="../281583/index.html">SparrowHub - repository of ready-made utilities for system administration</a></li>
<li><a href="../281589/index.html">A piece of space in a 3D case</a></li>
<li><a href="../281591/index.html">Development for copters</a></li>
<li><a href="../281593/index.html">v3.14.1592-beta2: everything you wanted to know about semantic versioning</a></li>
<li><a href="../281597/index.html">We write the Slack bot to get comments from VK in Python</a></li>
<li><a href="../281599/index.html">An introduction to shader programming: part 2</a></li>
<li><a href="../281601/index.html">bash + logger application warrants</a></li>
<li><a href="../281603/index.html">Machine learning: what you need to know about creating strategies for trading on the exchange. Part IV</a></li>
<li><a href="../281605/index.html">RESTful Visual Editor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>