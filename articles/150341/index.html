<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Windows Azure Virtual Machines - a review of new functionality</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear colleagues. 
 In the near future, we will consider another aspect of the new Windows Azure functionality - virtual machines. Virt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Windows Azure Virtual Machines - a review of new functionality</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, dear colleagues. <br>  In the near future, we will consider another aspect of the new Windows Azure functionality - virtual machines.  Virtual machines are a new service provided by the Windows Azure platform, and they make it much easier and more flexible to transfer local infrastructures to the cloud or create new software solutions that are critical to persistent storage (not cleaned up after every reboot of the run instance) <br><br>  What will you see in this article? <br>  1. Differences of the new service from the VM role <br>  2, Virtual Machine Architecture <br>  3. Virtual networks <br>  4. Virtual Machine Availability and Warranties <br>  Practice - creating a web server farm in Windows Azure <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Windows Azure Virtual Machines</b> <br><br>  Virtual machines are a new service provided by the Windows Azure platform, and they make it much easier and more flexible to transfer local infrastructures to the cloud or create new software solutions that are critical to persistent storage (not cleaned up after each reboot of the run instance).  In fact, after June 7, 2012, Windows Azure can hardly be called SaaS, PaaS, or any platform, now it is rather an umbrella term that combines many abbreviations. <br><br>  Practically all types of applications that can be used in the local infrastructure can be attributed to the use cases of virtual machines in Windows Azure: business applications, CRM, Active Directory, own applications, as well as allowing to combine local and cloud infrastructure, creating a hybrid solution. <br><br>  <b>Differences of a new service from a VM role</b> <br><br> <a href=""><img title="clip_image002" src="http://hpcru.files.wordpress.com/2012/08/clip_image002_thumb1.jpg" alt="clip_image002" width="538" height="295"></a> <br><br>  Fig.  1. Differences VM from VM roles <br><br>  After the announcement of the new service, the question arose - how does it differ from what we saw before, namely the VM role in the Cloud Services role model (then Hosted Services).  Let's first see what a VM role is. <br><br>  The VM role was introduced into the platform for use in cases where the capabilities of the Web / Worker roles were not sufficient to implement certain solutions, such as, for example, transfer of complex applications to the cloud (Sharepoint, ...).  At the same time, no SLA was provided for the operating system in the virtual machine, since the user loaded his own VHD disk.  However, the SLA on the virtual machines themselves was preserved - it was possible to load two virtual machines and get 99.95% SLA for the accessibility of the role. <br><br>  However, suppose if you loaded several virtual machines and something was happening with one of the virtual machines (for example, hardware failure), everything that was on this machine disappeared - all the unique data that was saved to disk and in memory, and other  This was due to the fact that in response to an error, Windows Azure deployed a new virtual machine, before doing this, sysprep on the image downloaded by the user. <br><br>  This is all seemingly normal for a simple application, but it turned into a big problem ‚Äî given the inconstant storage, you had to redesign your application in this way to take this feature into account. <br><br>  So, the differences include: <br><ul><li>  <strong>Type of storage</strong> .  Since the VM role, in essence, was some kind of service with a virtual machine, it did not have permanent storage ‚Äî with a hardware one, for example, an error, you lost all data from this machine.  With virtual machines, it is a little different - now you can add permanent storage in the form of a data disk, in addition, the disk of your virtual machine is constantly replicated in three replicas. </li><li>  <strong>Types of deployment</strong> .  You had to create your VHD locally and upload it to the cloud, after which you could use it.  With the new service, you can create and upload VHDs as well as use them as well as any other available in the image gallery. </li><li>  <strong>Network configuration</strong>  The settings for the VM role needed to be made in the service model, while the new virtual machine service can be configured on the Windows Azure management portal and even automated with Powershell or scripts. </li></ul><br> <a href=""><img title="clip_image003" src="http://hpcru.files.wordpress.com/2012/08/clip_image003_thumb.png" alt="clip_image003" width="473" height="268"></a> <br><br>  Fig.2.  The life cycle of a virtual machine in the cloud <br><br>  <b>Virtual Machine Architecture</b> <br><br>  In general, Windows Azure virtual machines are based on the service model used by Web / Worker roles for a long time, with major modifications such as persistent storage and one instance = one role. <br><br>  When creating a virtual machine, the Cloud Service is automatically created, which acts as a container for this virtual machine.  At the same time, if there are two deployment cells (Staging / Production) in the Cloud Service, in the case of a virtual machine it is deployed only in Production (which means that the VIP swap is unavailable) (Fig. 3). <br><br> <a href=""><img title="clip_image004" src="http://hpcru.files.wordpress.com/2012/08/clip_image004_thumb.png" alt="clip_image004" width="476" height="271"></a> <br><br>  Fig.  3. Cloud Service as a container for virtual machines <br><br> <a href=""><img title="clip_image006" src="https://habrastorage.org/getpro/habr/post_images/b52/e63/fa4/b52e63fa48c95bb651350345fadbe1aa.jpg" alt="clip_image006" width="480" height="278"></a> <br><br>  Fig.  four. <br><br>  As for where the virtual machines are stored, these are page blobs in the Windows Azure storage.  When creating a virtual machine, VHD is placed in a page blob with the possibility of further recording.  There are several disks available: <br><ul><li>  C: - operating system; </li><li>  D: - physical data on the storage, which is <strong>not reserved</strong> and used only for temporary storage; </li><li>  E: - user data; </li><li>  F: - logs. </li></ul><br>  The maximum size of the operating system can be up to 127 gigabytes, but a certain amount (depending on the size of the virtual machine) of additional data disks (Fig. 8) can be attached to the virtual machine, including during the execution of the virtual machine. <br><br> <a href=""><img title="clip_image007" src="http://hpcru.files.wordpress.com/2012/08/clip_image007_thumb.png" alt="clip_image007" width="486" height="283"></a> <br><br>  Fig.  5. Sizes of the virtual machine <br><br>  Virtual machines located within the same Cloud Service have a direct communication channel with each other - there is no need to configure something separately, as is the case with separate virtual machines, when in order to provide a connection, it is necessary to open ports in the service model.  Of course, we must not forget about firewalls on operating systems.  With this, everything is clear - you need to think only about firewalls and to fine-tune them (since the forums occasionally had questions about why the traffic did not ‚Äúgo‚Äù).  So what if you need to set up so-called endpoints?  Here, too, everything is simple.  Each endpoint is associated with a virtual machine and indicates whether to allow traffic. <br><br>  The properties of the final entry point include: <br><br>  <strong>Name</strong> - a logical name in the system. <br><br>  <strong>Protocol</strong> - tcp / udp <br><br>  <strong>Local port</strong> <br><br>  <strong>Public port</strong> <br><br>  Configure the same load balancing port (Fig. 9), i.e.  the one that the user will come to and then later go to one of the virtual machines in the set, you can use the definition of one entry point on all the necessary virtual machines and the special property LoadBalancedEndpointSetName. <br><br> <a href=""><img title="clip_image009" src="http://hpcru.files.wordpress.com/2012/08/clip_image009_thumb1.png" alt="clip_image009" width="495" height="266"></a> <br><br>  Fig.  6. Load Balancing and Virtual Machine Endpoint <br><br>  As you have probably already seen, there is room for setting up port forwarding.  Since each Cloud Service has one public IP address, but many virtual machines are inside, port forwarding is exactly what is needed in order to gain access to a specific machine from the outside (Figure 7). <br><br> <a href=""><img title="clip_image011" src="http://hpcru.files.wordpress.com/2012/08/clip_image011_thumb1.png" alt="clip_image011" width="499" height="274"></a> <br><br>  Fig.  7. Port Forwarding in Windows Azure Virtual Machines <br><br>  For example, as in the image numbered 5, the port forwarding is configured for the system ‚Äî an external client, initiating a request for 5586, goes to the RDP port (for example) to virtual machine No. 1, initiating the same request to 5587, goes to virtual machine No. 2, and etc. <br><br>  <b>Virtual networks</b> <br><br>  The most important function was the emergence of virtual networks.  Virtual Networks is a functionality that allows both connecting your local infrastructure with a cloud network and setting up a network within a deployed service.  If the first scenario is more or less clear (you need a VPN that supports Site-To-Site VPN), then what are the benefits of using virtual networks inside a deployed service?  First, this is a permanent IP scenario (not static, but permanent).  When you need to transfer Active Directory to Windows Azure, do not use the same standard mode when the IP will change?  Here you can use VNET, with which you can determine the general IP addressing scheme for your cloud network.  In this case, you will determine the address space, subnets and ownership of virtual machines.  Thus, each deployed virtual machine belonging to a particular VNET will have the same IP address regardless of its state (reboot, other actions leading to a change of IP).  This IP is non-static because it is not prescribed by statics (an indisputable fact), but is issued as if by DHCP with an infinite leasing time.  In this case, of course, there may be a question about the resolution of names.  By default, there is no name resolution when a virtual machine is placed in a virtual network - it is considered that you will take care of this yourself.  There are three options for resolving the problem: manually configure DNS on the network adapter for each machine (the main drawback, of course, in the phrase ‚Äúconfigure for each‚Äù), define the DNS server in the network configuration (which is also inconvenient, since it is not possible to override DNS) -servers without the need to redeploy the added virtual machines to the virtual network) and specify the DNS during the initial deployment of the virtual machine (for example, using Powershell, which is quite convenient). <br><br> <a href=""><img title="clip_image013" src="http://hpcru.files.wordpress.com/2012/08/clip_image013_thumb1.png" alt="clip_image013" width="506" height="245"></a> <br><br>  Fig.  8. Hybrid Solution Using Virtual Networks <br><br>  To deploy a virtual machine to a virtual network, you need to remember a few simple rules: <br><br>  1) You can not transfer an already deployed virtual machine, you need to deploy it directly into a virtual network. <br><br>  2) DNS settings - if you do not plan everything in advance, you can come to the conclusion that for an already deployed virtual machine it will be impossible to change these settings without redeploying. <br><br>  3) Each virtual network needs an affine group.  In addition, the storage account must be located in the same region as the affine group, or in this affine group. <br><br>  Virtual Machine Availability and Warranties <br><br>  Cloud Services SLA as it was 99.95%, and remained, given the minimum number of copies of the application (it is equal to two).  With virtual machines, the situation is a bit more confusing - it was decided that several virtual machines for most applications would not be necessary, therefore 99.9% SLA is offered for one instance, and if 99.95% is used for the Availability Set. <br><br>  <b>Availability Set</b> <br><br>  The Availability Set concept is similar to the concept of update domains and error domains, but somewhat expands it ‚Äî virtual machines in the AS are physically located in different rivers (racks) and when updating the host operating system, not all virtual machines in the AS are updated at the same time (Fig. 9). <br><br> <a href=""><img title="clip_image015" src="http://hpcru.files.wordpress.com/2012/08/clip_image015_thumb.jpg" alt="clip_image015" width="512" height="300"></a> <br><br>  Fig.  9. Unified Error and Update Domains and Availability Set <br><br> <a href=""><img title="clip_image017" src="https://habrastorage.org/getpro/habr/post_images/201/7d5/736/2017d573635e319f705ffa1288490b40.jpg" alt="clip_image017" width="514" height="306"></a> <br><br>  Fig.10.  Visual image of various SLA scenarios <br><br>  That, in fact, allows for fault tolerance and redundancy at all levels. <br><br> <a href=""><img title="clip_image019" src="https://habrastorage.org/getpro/habr/post_images/a25/e5a/009/a25e5a0094f54582a7e9d1f1a105eebd.jpg" alt="clip_image019" width="520" height="303"></a> <br><br>  Fig.  11. Fault tolerance at all levels <br><br> <a href=""><img title="clip_image020" src="https://habrastorage.org/getpro/habr/post_images/a64/f62/0fa/a64f620fa7f6d3fc372145dda5e78ef4.png" alt="clip_image020" width="525" height="293"></a> <br><br>  Fig.  12. What is included and what is not included in Windows Azure Virtual Machines SLA <br><br>  <b>Practice</b> <br><br>  There are several methods for creating a virtual machine in Windows Azure, and we‚Äôll cover everything. <br><br>  <b>Virtual machine from the image</b> <br><br>  Actually, the simplest and most understandable method is that there is already an image gallery in the cloud, which currently supports a specific set of operating systems (Fig. 16).  Please note that this list is from a preview version, that is, it will be constantly replenished even by switching to Production. <br><br> <a href=""><img title="clip_image022" src="https://habrastorage.org/getpro/habr/post_images/ee6/047/e29/ee6047e29174d70d7a79e52bd91fdddb.jpg" alt="clip_image022" width="525" height="213"></a> <br><br>  Fig.  13. Gallery of images of virtual machines <br><br>  <em>Let's move on to practice.</em>  <em>Sign in to the</em> <em>Windows</em> <em>Azure</em> <em>Management Portal</em> <em>(</em> <a href="http://manage.windowsazure.com/"><em>http</em> <em>: //</em> <em>manage</em> <em>.</em> <em>Windowsazure</em> <em>.</em> <em>Com</em></a> <em>) using your</em> <em>Windows</em> <em>Live</em> <em>ID</em> <em>credentials</em> <em>(Figure 14).</em> <br><br> <a href=""><img title="clip_image024" src="https://habrastorage.org/getpro/habr/post_images/a0a/cef/643/a0acef6434c41e73082b26984b97b337.jpg" alt="clip_image024" width="532" height="312"></a> <br><br>  Fig.  14. Login page <br><br>  Entering the management portal (Fig. 15), click the <strong>New</strong> button located in the lower left corner of the page to open the <strong>New</strong> <strong>form</strong> dialog box (Fig. 16). <br><br> <a href=""><img title="clip_image026" src="https://habrastorage.org/getpro/habr/post_images/d92/b7a/75b/d92b7a75bc8dc3d3b37b622d343b7ec4.jpg" alt="clip_image026" width="540" height="339"></a> <br><br>  Fig.  15. Windows Azure Management Portal <br><br>  Select the <strong>Virtual</strong> <strong>Machine</strong> dialog that opens.  Choose <strong>From Gallery</strong> (fig. 16) <br><br>  . <a href=""><img title="clip_image028" src="https://habrastorage.org/getpro/habr/post_images/ca8/78c/918/ca878c918f56f8b4e3982fac29c15bd1.jpg" alt="clip_image028" width="543" height="256"></a> <br><br>  Fig.  16. New form <br><br>  Notice that the <strong>VM</strong> <strong>OS</strong> <strong>Selection</strong> dialog box has four display options ‚Äî All (all images), Platform Images (platform image gallery), My Images (customer-provided images), and My Disks (virtual machine disks).  Now select Windows Server 2008 R2 SP1, July 2012 and click <strong>Next</strong> . <br><br>  In the <strong>VM</strong> <strong>Configuration</strong> dialog box (Figure 17), enter the required data, select the instance size (since virtual machines require serious resources, select the smallest instance) and click <strong>Next</strong> . <br><br> <a href=""><img title="clip_image030" src="https://habrastorage.org/getpro/habr/post_images/d90/112/346/d90112346974228c87594471261dac29.jpg" alt="clip_image030" width="566" height="407"></a> <br><br>  Fig.  17. Initial Virtual Machine Configuration <br><br>  In the <strong>VM</strong> <strong>Mode</strong> dialog box (Figure 18), select <strong>Standalone</strong> <strong>Virtual</strong> <strong>Machine</strong> , since we do not have any virtual machines.  Enter a <strong>DNS</strong> <strong>Name</strong> and select a storage account and region, either an affine group or a virtual network.  Click <strong>Next</strong> . <br><br> <a href=""><img title="clip_image032" src="https://habrastorage.org/getpro/habr/post_images/e56/beb/c73/e56bebc735829e2392d33355297ca924.jpg" alt="clip_image032" width="572" height="413"></a> <br><br>  Fig.  18. Initial Virtual Machine Settings <br><br>  Select <strong>Create</strong> <strong>Availability</strong> <strong>Set</strong> and enter a name.  Click <strong>Next</strong> to begin deploying the virtual machine.  After a while, the virtual machine will start. <br><br>  Now let's connect to the created virtual machine via Remote Desktop Connection. <br><br>  Go to the Windows Azure Management Portal and select the virtual machine you created.  Click the Connect button in the control panel below.  In fact, this is a link to the file of connection to your virtual machine, and after clicking you should download the .rdp file with the name of the virtual machine.  Run it and enter the administrator password. <br><br>  Logging on to a virtual machine, you will see the interface of the OS configured for this virtual machine.  We configured Windows Server 2008 R2. <br><br>  Click <strong>Add</strong> <strong>Roles</strong> .  Click <strong>Next</strong> .  Select the <strong>Web</strong> <strong>Server</strong> <strong>(</strong> <strong>IIS</strong> <strong>)</strong> role - we will place in the IIS virtual machine and create a farm of web servers from two virtual servers. <br><br> <a href=""><img title="clip_image034" src="https://habrastorage.org/getpro/habr/post_images/913/1cf/7c5/9131cf7c527f0455ab22b33ef755992d.jpg" alt="clip_image034" width="591" height="434"></a> <br><br>  Fig.  22 <br><br>  Click <strong>Next</strong> and select all necessary components (fig. 19). <br><br> <a href=""><img title="clip_image036" src="https://habrastorage.org/getpro/habr/post_images/956/333/e59/956333e59c1f1816ee98248b105f3459.jpg" alt="clip_image036" width="596" height="438"></a> <br><br>  Fig.  nineteen. <br><br>  On it we will finish this point and we will pass to the following. <br><br>  <b>Creation from own image</b> <br>  The second way to create a virtual machine: create your own image and deploy virtual machines from it.  All this can be done directly on the platform - once you have created a virtual machine from a pre-configured image, you can customize it as you please, then use sysprep for Windows and waagent for Linux and click Capture, first turning off this virtual machine.  Naturally, this process can also be done offline by creating a VHD and downloading it using csupload.exe from Windows Azure SDK 1.7. <br><br>  Since we have already deployed the virtual machine, we will use it. <br><br>  Go to the created virtual machine via RDP and open the Windows \ System32 \ sysprep directory.  Run <strong>sysprep</strong> (fig. 20), select the <strong>generalize</strong> option <br><br>  and <strong>shutdown</strong> as <strong>shutdown</strong> <strong>options</strong> .  Click OK. <br><br> <a href=""><img title="clip_image038" src="https://habrastorage.org/getpro/habr/post_images/913/6f7/8a3/9136f78a31b0b7cfcf4c7ce3b5d290f6.jpg" alt="clip_image038" width="569" height="413"></a> <br><br>  Fig.20.  Sysprep interface <br><br>  After losing the connection to the virtual machine, wait a few minutes before shutting it down - monitor the status of the machine in the Windows Azure management portal - then select the virtual machine and click the <strong>Capture</strong> button on the control panel. <br><br>  In the dialog box that appears, enter the image name.  Check the <strong>‚ÄúI have sysprepped the virtual machine‚Äù</strong> option.  Click <strong>OK</strong> . <br><br>  After the process is completed, the created virtual machine will be deleted, but a new image will appear in the <strong>Images</strong> section (Fig. 21). <br><br> <a href=""><img title="clip_image040" src="https://habrastorage.org/getpro/habr/post_images/344/72b/1a1/34472b1a1689c4e1b0ccb4ed95090a31.jpg" alt="clip_image040" width="577" height="166"></a> <br><br>  Fig.  21. New Virtual Machine Image <br><br>  Now you can create a new virtual machine. <br><br>  Click the <strong>New</strong> button in the lower left corner of the page to open the <strong>New</strong> <strong>form</strong> dialog box.  Select the <strong>Virtual</strong> <strong>Machine</strong> dialog that opens.  Select <strong>From</strong> <strong>Gallery</strong> .  Select your image (fig. 22). <br><br> <a href=""><img title="clip_image042" src="https://habrastorage.org/getpro/habr/post_images/fee/30e/60b/fee30e60bc3abcd06582fafd3619870b.jpg" alt="clip_image042" width="565" height="390"></a> <br><br>  Fig.  22. Gallery of images <br><br>  On the following <strong>Configuration</strong> pages, fill in the required fields (Fig. 23, 24). <br><br> <a href=""><img title="clip_image044" src="https://habrastorage.org/getpro/habr/post_images/f79/399/680/f79399680d7aa893225d3896a138e502.jpg" alt="clip_image044" width="564" height="401"></a> <br><br>  Fig.  23. Initial Virtual Machine Configuration <br><br> <a href=""><img title="clip_image046" src="https://habrastorage.org/getpro/habr/post_images/103/b8b/a77/103b8ba77085242dd8e613d0ee5d37a2.jpg" alt="clip_image046" width="561" height="401"></a> <br><br>  Fig.  24 <br><br>  On the <strong>Availability Sets</strong> page, select <strong>Create Availability</strong> <strong>Set</strong> .  Click OK. <br><br>  Create a second virtual machine from the same image, but on the <strong>VM</strong> <strong>Mode</strong> page, tick the <strong>Connect</strong> <strong>to</strong> <strong>existing</strong> <strong>virtual</strong> <strong>machine</strong> (Figure 25). <br><br> <a href=""><img title="clip_image048" src="https://habrastorage.org/getpro/habr/post_images/1c4/f31/206/1c4f31206db50cb4a6df894cd5dcfc37.jpg" alt="clip_image048" width="546" height="392"></a> <br><br>  Fig.  25 <br><br>  On the <strong>Availability</strong> <strong>Sets</strong> page, select the previously created <strong>Set</strong> . <br><br>  After everything is created and running, configure the end points for both machines.  To do this, go to the virtual machine control panel, on the <strong>Endpoints</strong> tab.  Click <strong>Add</strong> <strong>Endpoint</strong> .  On the <strong>Specify</strong> <strong>Endpoint</strong> <strong>details</strong> page (Figure 26), type http, 80.80. <br><br> <a href=""><img title="clip_image049" src="https://habrastorage.org/getpro/habr/post_images/70e/4c8/70d/70e4c870d60d0d9ab60673c25b42a99c.png" alt="clip_image049" width="560" height="400"></a> <br><br>  Fig.  27. Configure Endpoint Entry <br><br>  Repeat the setting for the second virtual machine, specifying the <strong>load</strong> point on the first <strong>endpoint</strong> on the first configuration page and selecting the created entry point. <br><br>  Wait until the update process is complete and click the link in the <strong>DNS</strong> <strong>Name</strong> field to make sure that <strong>IIS is</strong> working and balancing the load between two instances of our service. <br><br>  <b>Uploading your own VHD</b> <br><br>  The third option that has already been available in Windows Azure for a long time is to load an existing virtual machine in VHD format using csupload.exe or VHDupload from the Windows Azure Training Kit.  We will use the first option. <br><br>  Open <strong>Disk Management</strong> console: in the <strong>Start</strong> menu, type <strong>diskmgmt.msc</strong> in the search <strong>bar</strong> and press <strong>Enter</strong> . <br><br>  In the Disk Management console, open the <strong>Action</strong> menu and select <strong>Create VHD</strong> . <br><br>  In the <strong>Create and Attach Virtual Hard Disk</strong> dialog box, click <strong>Browse</strong> , specify the location and name of the future disk, and then click <strong>Save</strong> .  Specify the size of the <strong>Virtual hard disk size</strong> as <em>16 MB</em> , <strong>Virtual hard disk format</strong> as <strong>Fixed size</strong> , then click <strong>OK</strong> to create and connect the virtual hard disk.  Pay attention to the size of the disk - we will not create a disk for the operating system at this point, we will create it as a data disk, upload it to the cloud, connect it to the virtual machine and view its contents.  If you want to create a disk with the OS, there is nothing easier - create a larger disk, format it in NTFS and upload it to the cloud. <br><br>  Before using a new disk, you must initialize it: right-click on the disk icon for the created disk in the bottom panel of <strong>Disk Management</strong> and click <strong>Initialize Disk</strong> . <br><br>  In the <strong>Initialize Disk</strong> dialog box, make sure that the drive corresponding to the connected VHD is selected, specify the <strong>MBR (Master Boot Record)</strong> and click <strong>OK</strong> . <br><br>  Right-click on the unallocated Unallocated area of ‚Äã‚Äãthe connected virtual hard disk and click <strong>New Simple Volume</strong> .  In the <strong>New Simple Volume Wizard,</strong> click <strong>Next</strong> .  On the next page, leave the <strong>Simple volume size</strong> value the same ‚Äî it should match the <strong>Maximum disk space ‚Äî</strong> and click <strong>Next</strong> .  Assign a drive letter and click <strong>Next</strong> .  Select the formatting type of the new partition.  Specify the <strong>File system</strong> as <em>NTFS</em> , leave the default <strong>Allocation unit size,</strong> and define the <strong>Volume label</strong> as <em>OurVHD</em> .  Make sure you turn on the <strong>Perform a quick format</strong> option and leave it off. <strong>Enable file and folder compression</strong> .  Click <strong>Next</strong> . <br><br>  Check the information on the Summary page and click <strong>Finish</strong> to create a new volume. <br><br>  Wait until the end of formatting, which should take a few seconds.  When <strong>AutoPlay is on,</strong> you will be asked if you need to view the attached drive.  In this case, click <strong>Open folder to view files</strong> .  If the question is not asked, right-click on the volume in the Disk Management console and click <strong>Open</strong> .  Leave the window open.  Copy there any files. <br><br>  Switch to the Disk Management console, right-click on the mounted disk ‚Äî click on the disk, not on the partition area ‚Äî and click <strong>Detach VHD</strong> . <br><br>  In the <strong>Detach Virtual Hard Disk</strong> dialog box, make sure that the option to <strong>remove the disk</strong> is <strong>unchecked</strong> , and then click <strong>OK</strong> . <br><br>  Now you need to load a virtual hard disk (VHD) into your Windows Azure storage.  Let me remind you that virtual hard disks are stored in page blobs in Windows Azure, as well as the fact that you can load or create a hard disk using the repository library API. <br><br>  Before downloading VHD, you need to determine the name and access key to your account ‚Äî to do this, go to the management portal and select the subscription in which your application will be deployed.  Select the storage service from the list of services and record the <strong>name</strong> value (the first entry point URL segment) and the <strong>Primary Access Key access key</strong> by clicking the <strong>View</strong> button (use the <strong>Copy to Clipboard</strong> button to copy the key to the clipboard).  On the new portal, you can see the keys by going to the storage account and clicking <strong>Manage</strong> <strong>Keys</strong> . <br><br> <a href=""><img title="clip_image051" src="https://habrastorage.org/getpro/habr/post_images/61f/41b/948/61f41b948e4af8af6a3ded8a05399d40.jpg" alt="clip_image051" width="601" height="310"></a> <br><br>  Fig.  28. View Windows Azure Storage Account Information <br><br>  Open the Windows Azure Command Prompt with administrator rights and go to the bin folder - there will be a <strong>csupload</strong> utility, which we will use to load the disk into the cloud. <br><br>  Create a certificate using the makecert utility or using the appropriate snap-in in Visual Studio or IIS. <br><br>  makecert -sky exchange -r -n "CN = &lt;CertificateName&gt;" -pe -a sha1 -len 2048 -ss My "&lt;CertificateName&gt; .cer" <br><br>  Download it using the old Windows Azure Management Portal in the Management Certificates certificate store.  Copy the thumbnail of the downloaded certificate. So you should have the following data: Subscription ID, certificate thumbnail, storage key and storage account name. <br><br>  Run the following commands in sequence: <br><br>  csupload Set-Connection "SubscriptionID = &lt;Subscriptionid&gt;; CertificateThumbprint = &lt;Thumbprint&gt;; ServiceManagementEndpoint = https: //management.core.windows.net" <br><br>  csupload.exe Add-Disk -Destination ‚Äúhttp: // [accountname] .blob.core.windows.net / mydisks / mydisk.vhd" -Label ourvhd -LiteralPath "c: \ temp \ ourvhd.vhd" <br><br>  When the message <strong>‚Äú</strong> <strong>Disk</strong> <strong>'</strong> <strong>ourvhd</strong> <strong>.</strong>  <strong>vhd</strong> <strong>'</strong> <strong>is</strong> <strong>registered</strong> <strong>successfully</strong> <strong>‚Äù</strong> , this will mean that your data disk has been uploaded to the image gallery. <br><br>  Please note that you need to use other parameters to load virtual machine images.  Learn more about csupload: <a href="http://msdn.microsoft.com/en-us/library/windowsazure/gg466228.aspx">msdn.microsoft.com/en-us/library/windowsazure/gg466228.aspx</a> <br><br>  Switch back to the new Windows Azure Management Portal to the control panel of a virtual machine.  Click <strong>Attach</strong> and connect the disk from the storage, and then log into the virtual machine via RDP and notice the increased number of disks.  This feature allows you to quickly upload huge amounts of data to the cloud, as well as migrate data to and from the cloud to the local infrastructure. <br><br><br><br>  <b>Linux</b> <br><br><br><br>  And now let's create a Linux virtual machine and connect to it via SSH.  There is nothing easier.  Repeat the process to create an image from the image gallery, but this time choose openSUSE 12.1.  Do not tick off various advanced options like Upload SSH Keys. <br><br>  Connecting to a newly created virtual machine is easy - via ssh, vnc or using putty (Windows), which we will use.  To connect, go to the control panel of the virtual machine and in the <strong>Quick</strong> <strong>Glance</strong> panel (Fig. 29) there will be all the data for connection. <br><br> <a href=""><img title="clip_image053" src="https://habrastorage.org/getpro/habr/post_images/d6a/171/aca/d6a171aca849f3f6aeb92ef6dba0d045.jpg" alt="clip_image053" width="209" height="344"></a> <br><br>  Fig.  29. Quick Glance Data Panel <br><br>  Now start Putty and fill in the required fields with information obtained from the <strong>Quick</strong> <strong>Glance</strong> panel (Fig. 30). <br><br> <a href=""><img title="clip_image055" src="https://habrastorage.org/getpro/habr/post_images/84a/6d4/9be/84a6d49be1ada22c735883c8852c426a.jpg" alt="clip_image055" width="449" height="462"></a> <br><br>  Fig.  30. Interface Putty <br><br>  Click <strong>Open</strong> .  On the security warning, click <strong>Yes</strong> .  Actually, that's all - enter your administrator credentials, and you are inside a virtual machine. <br><br>  To create a dummy image from this virtual machine, you will need to use the Windows Azure Linux Agent (waagent ‚Äìdeprovision).  To do this, run the command <strong>sudo</strong> <strong>/</strong> <strong>usr</strong> <strong>/</strong> <strong>sbin</strong> <strong>/</strong> <strong>waagent</strong> <strong>-</strong> <strong>deprovision</strong> (Fig. 31). <br><br> <a href=""><img title="clip_image057" src="https://habrastorage.org/getpro/habr/post_images/9c1/223/115/9c122311553826eba2b2077bc270f7ae.jpg" alt="clip_image057" width="460" height="293"></a> <br><br>  Fig.  31. Generalization of the image <br><br>  Turn off the virtual machine using the <strong>Shutdown</strong> button on the virtual machine control panel.  After shutdown, click <strong>Capture</strong> .  All other actions are identical to what we performed for the Windows machine.  As you can imagine, we can easily configure load balancing for Linux machines. <br><br>  <b>Summary</b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In general, with the launch of new functionality of virtual machines and virtual networks, there are much more opportunities for simple migration of existing local infrastructures to the cloud, with the possibility of partial migration and further integration of infrastructure parts using virtual networks. </font></font><br></div><p>Source: <a href="https://habr.com/ru/post/150341/">https://habr.com/ru/post/150341/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150333/index.html">Flat lens creates the perfect image.</a></li>
<li><a href="../150334/index.html">Google Analytics for games, social applications. nets</a></li>
<li><a href="../150337/index.html">Migrating Adobe After Effects Projects</a></li>
<li><a href="../150338/index.html">Yandex scored on your cards?</a></li>
<li><a href="../150339/index.html">Convert string to number</a></li>
<li><a href="../150342/index.html">Impressions of working with the Mamba.Ru application platform</a></li>
<li><a href="../150343/index.html">‚ÄúWe do not do that‚Äù or an ideal CAD system for an architect through the eyes of a designer</a></li>
<li><a href="../150344/index.html">MegaFon Mint - Answers to Questions, Denials on Claims</a></li>
<li><a href="../150346/index.html">Open Course on gamification on Coursera</a></li>
<li><a href="../150347/index.html">Cackle commenting system - new features</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>