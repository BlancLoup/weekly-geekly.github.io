<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Survival in moments of critical load</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the life of each visited resource there are moments when the equipment does not cope with the current load. The causes can be very diverse, and the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Survival in moments of critical load</h1><div class="post__text post__text-html js-mediator-article"> In the life of each visited resource there are moments when the equipment does not cope with the current load.  The causes can be very diverse, and they can not always be radically eradicated at a reasonable time.  In such cases, developers are faced with the task of reducing the workload with minimal inconvenience to visitors. <br><br>  I do not pretend to the genius of my decision, but I hope it will help someone. <br><br><a name="habracut"></a><br>  In my case, the problem is that from time to time the load on the database rises sharply.  As usually happens in such cases, an avalanche occurred - requests start to slow down, users get nervous and reload, Kronov scripts slow down and as a result the server ‚Äúhangs‚Äù.  In addition, search robots add problems - they tend to pull the deep pages from the site, which normally do not live in the cache.  As a result, pages for them are generated and the cache is filled with unnecessary data.  With the second part of the problem, you can cope quite easily - just not to cache calls to old pages, or calls from robots.  But it is possible to go further and take the load off the robots at least for a while when the server is overloaded. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I faced two tasks: <br><br>  1. How to determine the moment of occurrence of increased load <br>  2. What can be done at these moments to make life easier? <br><br>  To solve the first task, I used the famous zabbix miracle tool, since it has long been actively and successfully used and allows you to monitor several servers and also execute commands on them when the necessary conditions occur.  For my own case, I chose load average on the database server.  And I need to react on another server where nginx lives. <br><br>  I created a trigger with the condition system.cpu.load [, avg1] .last (0)&gt; 3.5, hung on it executing a remote command <br><br>  HOST: /path/lowerage.sh {STATUS} {ITEM.LASTVALUE} {TIME} <br><br>  And on the server posted a simple script: <br><br> <code>if [ "${1}" != "ON" ] ; then <br> /bin/unlink /tmp/cpu_load_high <br> else <br> /usr/bin/touch /tmp/cpu_load_high <br> fi <br> echo "lowerage ${1} ${2} ${3}" |/usr/bin/mail -s lowerage tmp@tmpmail.ru</code> <br> <br>  As a result, at the moments of increasing the load, a file was created, from which you can already dance further. <br><br>  Smoothly proceed to the actual action. <br><br>  First of all, I limited the launch of Kronov scripts at a critical time.  The solution is trivial, the condition is simply added to the cron.  Example: <br><br>  <i>/ bin / test!</i>  <i>-r / tmp / cpu_load_high &amp;&amp; / usr / bin / fetch -o - <a href="http://site/cron.php">site / cron.php</a></i> <br><br>  Then I began to gently press the search robots.  I decided to cut them off at the nginx level at a critical time.  I had to be smart with the latter, the fact is that nginx does not understand the nested if, but I need at least two conditions.  Rescued feint ears.  A piece of the configuration file that implements the above, cited below: <br><br> <code>if (-f /tmp/cpu_load_high) { <br> set $troubleflag T; <br> } <br> if ($http_user_agent ~ (?:Yandex|Google|Yahoo|Rambler|msnbot) ) { <br> set $oblomflag Y$troubleflag; <br> } <br> if ($oblomflag = YT) { <br> return 444; <br> } <br></code> <br><br>  By the way, I'm not sure that the option with <i>return 444</i> is optimal.  In this case, nginx just breaks the connection.  I think that robots should not be offended by such behavior. <br><br>  That's actually the whole short.  For the future, it is still possible at critical times not to handle any heavy requests - to transfer the user to an apology page. <br><br>  Thanks for attention. <br><br>  UPD: in the comments suggested link <a href="http://googlewebmastercentral.blogspot.com/2006/08/all-about-googlebot.html">googlewebmastercentral.blogspot.com/2006/08/all-about-googlebot.html</a> where Google recommends using the code 503. </div><p>Source: <a href="https://habr.com/ru/post/54856/">https://habr.com/ru/post/54856/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../54850/index.html">Plone hosting in Russia</a></li>
<li><a href="../54851/index.html">Expression Web SuperPreview</a></li>
<li><a href="../54852/index.html">PGP encryption</a></li>
<li><a href="../54853/index.html">Bookmarklamp - concept lamp-bookmarks</a></li>
<li><a href="../54855/index.html">Scato language for learning and just for fun</a></li>
<li><a href="../54857/index.html">Yandex Advertising Campaign - Mocked</a></li>
<li><a href="../54858/index.html">SMS services throw ...</a></li>
<li><a href="../54859/index.html">The music market is disappearing as a phenomenon</a></li>
<li><a href="../54860/index.html">What project is successful?</a></li>
<li><a href="../54862/index.html">How much money do you make a startup?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>