<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Improving 3d engine on js: Gouraud shading</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The babarun post about a 3d engine on js caused a creative impulse to add toning Guro for greater realism. That's what happened (and now also with spe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Improving 3d engine on js: Gouraud shading</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/b4c/207/4eb/b4c2074eb7a585bc0ba886808d889dd6.png"><br>  The <a href="http://habrahabr.ru/users/babarun/" class="user_link">babarun</a> post about a <a href="http://habrahabr.ru/blogs/crazydev/93594/">3d engine on js</a> caused a creative impulse to add <a href="http://en.wikipedia.org/wiki/Gouraud_shading">toning Guro</a> for greater realism.  That's what <a href="http://amaembo.github.io/canvas-gouraud/canvas-3d-gouraud.html"><b>happened</b></a> (and now also with specularity).  Compared with the usual (flat) tint, the normals need to have not for the faces, but for the vertices (that is, for the triangular face, three normals).  For ready-made normals of faces, the vertex normals are calculated by simply averaging the normals of all the faces that include the given vertex;  this is done once before rendering.  The luminance of the vertices is calculated at the beginning of each frame, taking into account the change in the position of the camera. <br><br>  The main difficulty was how to fill the gradient with a triangle. <br><a name="habracut"></a><br>  Pixel access to the image buffer is dismissed as slow.  In canvas there is a <a href="http://dev.w3.org/html5/canvas-api/canvas-2d-api.html">linear gradient</a> , we also need to fill in a triangle so that the corners are given colors.  Generally speaking, this task is not reduced to a linear gradient in general.  A simple example: the three vertices of a triangle are colored red, green, and blue.  However, if the color vectors of the vertices are linearly dependent, as in the <a href="http://habrahabr.ru/users/babarun/" class="user_link">babarun</a> example, the problem can be reduced to a linear gradient.  The only question is how to ask it. <br><br>  So, we have three vertices (x1, y1), (x2, y2), (x3, y3) with colors c1, c2, c3.  To define a linear gradient in canvas, you need to specify the starting point, end point and their colors.  We sort the vertices so that the colors go in ascending order and combine the starting point of the linear gradient with the darkest vertex (x1, y1).  Now we need to choose a direction of a linear gradient such that the lengths of the projections of the vectors (x2, y2) - (x1, y1) and (x3, y3) - (x1, y1) to this direction are proportional to the color differences (c2-c1) and ( c3-c1).  We can fix the color of the end point of the linear gradient to the brightest of the desired (c3), that is, the projection (x3, y3) must exactly fall into the end point.  This condition and the condition of proportionality of projections to color differences give two equations for the coordinates of the end point of a linear gradient.  The equations are easily solved in your favorite solver (I used Maple), the <a href="http://habrahabr.ru/users/babarun/" class="user_link">babarun</a> script <a href="http://habrahabr.ru/users/babarun/" class="user_link">is</a> modified and laid out on the <a href="http://biorainbow.com/~lan/canvas-3d-gouraud.html">server</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      All source code in html-file.  Here are the new features: <br>  calcGradientPos - calculates the position of the end of the linear gradient vector with the beginning at (0,0) (actually, solving a system of equations) <br>  calcFullGradientPos - calls calcGradientPos, shifting the first vertex to (0,0) and then returning back. <br>  getGradient - creates a CanvasGradient object for a given triangle. <br>  paintGradientTriangle - draws a triangle to the canvas.  Vertices are given a double array [3] [3], the first index is the number of the vertex, the second index specifies the x, y coordinates and color (from 0 to 1);  at the end, the color is multiplied by the parameters (r, g, b) - the overall color of the shape. <br>  calcVerticesNormals ‚Äî calculate vertex normals by face normals. <br>  There are also a number of changes in the draw_mesh function, in particular, at the very beginning of the cycle, in which vertices are highlighted. <br><br>  FPS has fallen by half, but the possibilities for optimization have not been exhausted (they were in the original version).  Who wants, may try to improve the result.  I made only a version from 1920 polygons, anyone can easily add the rest. <br><br>  <b>Upd: there</b> was an error with normalization of normals, so it was impossible to make specularity.  Mirror is now added (thanks to <a href="http://habrahabr.ru/users/lsdima/" class="user_link">lsdima</a> for pushing to deal with this). </div><p>Source: <a href="https://habr.com/ru/post/94519/">https://habr.com/ru/post/94519/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../94513/index.html">Musical thieves, senseless and merciless</a></li>
<li><a href="../94515/index.html">ThinkPad Edge 14 - let's say ‚Äúno‚Äù gloss!</a></li>
<li><a href="../94516/index.html">Eurovision Blogosphere 2010</a></li>
<li><a href="../94517/index.html">Comic competition with workable prizes 2.0</a></li>
<li><a href="../94518/index.html">Buy my TV and I'll tell you what to watch.</a></li>
<li><a href="../94524/index.html">Slackware 13.1. Hooray!</a></li>
<li><a href="../94527/index.html">Artificial hand just around the corner</a></li>
<li><a href="../94528/index.html">Firmware 5530 without "frills"</a></li>
<li><a href="../94530/index.html">Service WherePiliska.ru</a></li>
<li><a href="../94537/index.html">Happy Birthday, Habr!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>