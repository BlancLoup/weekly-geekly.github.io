<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Uploading files to Yii</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Having written a number of projects on Yii, I thought about a convenient mechanism for working with downloaded files. Yii offers a set of tools for th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Uploading files to Yii</h1><div class="post__text post__text-html js-mediator-article"> Having written a number of projects on Yii, I thought about a convenient mechanism for working with downloaded files.  Yii offers a set of tools for this purpose, but there is no single mechanism.  In this article I want to offer the idea of ‚Äã‚Äãcentralized processing of downloaded files in Yii. <a name="habracut"></a><br><br>  The task boils down to the following.  You need a convenient mechanism for uploading files and pictures to the server (including the necessary checks), creating thumbnails for pictures and automatically generating <code>img</code> tags and links to download the file.  There is nothing suitable in the <a href="http://www.yiiframework.com/extensions/%3Fcategory%3D7">extensions</a> .  The closest in meaning is the <a href="http://www.yiiframework.com/extension/upload/">upload</a> extension, but it also does not provide a number of necessary functions.  So I decided to write myself.  Right before the publication of the article, I accidentally saw a <a href="http://yiiframework.ru/doc/cookbook/ru/form.file.upload.fat.model">recipe</a> , in which a similar idea was considered. <br><br>  The code examples are for reference only, I inserted them from a working project, but could confuse something.  If you need a working code, at the end of the article there is a link to the project.  So, go ahead! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  The first iteration.  We supplement the standard functionality. </h4><br>  What does Yii offer?  First, the <a href="http://www.yiiframework.com/doc/api/1.1/CUploadedFile">CUploadedFile</a> class, which provides information about the uploaded file and allows you to save it to the server.  Secondly, the <a href="http://www.yiiframework.com/doc/api/1.1/CFileValidator">CFileValidator</a> validator, which checks the loaded file.  Here is how the <a href="http://yiiframework.ru/doc/cookbook/ru/form.file.upload">official documentation</a> recommends downloading files: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//  class MyModel extends CActiveRecord { public $image; public function rules(){ return array( array('image', 'file', 'types'=&gt;'jpg, gif, png'), ); } } //  class MyModelController extends CController { public function actionCreate(){ $modMyModel=new MyModel; if(isset($_POST['MyModel'])){ $modMyModel-&gt;attributes=$_POST['MyModel']; $modMyModel-&gt;id_image=CUploadedFile::getInstance($modMyModel,'image'); if($modMyModel-&gt;save()){ $modMyModel-&gt;id_image-&gt;saveAs('path/to/localFile'); //   ,     //   } } $this-&gt;render('create', array('model'=&gt;$modMyModel)); } } //  </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo CHtml::form('','post',array('enctype'=&gt;'multipart/form-data')); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> ... </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo CHtml::activeFileField($modMyModel, 'image'); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> ... </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo CHtml::endForm(); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><br>  This approach has several disadvantages: <br><br><ol><li>  In the framework there is no dedicated folder for uploading files. </li><li>  File downloads have to be described each time in the controller. </li><li>  This approach cannot be transferred to <code>actionUpdate()</code> , because it waits for the file to be loaded with each call.  And it would be convenient to work with files as with ordinary properties - load when creating a model and, if necessary, reload when it changes. </li><li>  There are no recommendations regarding the subsequent access to the file.  However, <code>path/to/localFile</code> can be stored in the model property. </li></ol><br><br>  Of course, I speak of these shortcomings only in the context of my own projects.  And that's what I want to offer. <br><br>  To begin with we will decide on the place for preservation of files.  In my opinion, the directory <code>.../protected/data/files</code> best place to store <code>.../protected/data/files</code> .  Generally speaking, for files created in the course of work, there is a folder <code>.../protected/runtime</code> , but according to the meaning of the <code>data</code> directory is more suitable for these purposes.  The file name will be generated randomly ( <code>uniqid()</code> ) and stored in the model property <code>$modMyModel-&gt;id_image</code> , in the following paragraphs I will tell you how.  True, this approach has one pitfall - the <code>data</code> directory is closed for accessing from the browser.  How to deal with this - a little later.  Looking ahead, I propose to upload files dynamically via <code>readfile()</code> , and to publish pictures (more precisely, thumbnails of pictures) in the <code>assets</code> folder. <br><br>  With the folder and file name sorted out.  Now let's deal with validation and loading.  Let's start with the form.  Let's do this: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $modMyModel-&gt;id_image <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> CHtml::activeFileField($modMyModel, <span class="hljs-string"><span class="hljs-string">'id_image_file'</span></span>); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><br>  So we will see if the file is loaded.  And the file itself will be loaded with the name <code>id_image_file</code> .  Instead of <code>echo $modMyModel-&gt;id_image</code> you can insert a link to download the file or a thumbnail image. <br><br>  Now validation.  The idea is this: the validator should check if there is a file in <code>$_FILES</code> with the name <code>id_image_file</code> .  If so, create a <code>CUploadedFile</code> object and write it to <code>$modMyModel-&gt;id_image</code> .  Then validate <code>$modMyModel-&gt;id_image</code> standard way.  To do this, create your own validator <code>DFileValidator</code> , inherited from <code>CFileValidator</code> .  And immediately another one - <code>DImageValidator</code> , inherited from <code>DFileValidator</code> , in which we specify the default file types for images. <br><br>  And finally, loading the file and saving the model.  After validation, the uploaded file will be in <code>$modMyModel-&gt;id_image</code> , moreover in the form of <code>CUploadedFile</code> .  In order for the download not to be tied to a specific property, you need to check before saving the model whether any of its properties are objects of the <code>CUploadedFile</code> class, and if they are, load them and save the addresses.  Now the model will look like this: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyModel</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DActiveRecord</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $id_image; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rules</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'id_image'</span></span>, <span class="hljs-string"><span class="hljs-string">'DImageValidator'</span></span>), ); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beforeSave</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;attributes <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $attribute) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($attribute <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> CUploadedFile) { $strSource = uniqid(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($attribute-&gt;saveAs(Yii::getPathOfAlias(<span class="hljs-string"><span class="hljs-string">'application.data.files'</span></span>) . <span class="hljs-string"><span class="hljs-string">'/'</span></span> . $strSource)) <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;$key = $strSource; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::beforeSave(); } }</code> </pre><br><br>  The image property has been replaced by the id_image property consciously.  Further it will be clear why. <br><br><h5>  Let's summarize </h5><br><ol><li>  All files are saved in the folder <code>.../protected/data/files</code> with random names. </li><li>  File loading is performed in the model, before being saved in the database. </li><li>  To mark a property as a file, you need: <br><ol><li>  In the <code>rules()</code> model, assign a validator <code>DFileValidator</code> to this property. </li><li>  In the form, rename the input for this property by adding a <code>'_file'</code> to it. </li></ol><br></li><li>  The <code>actionCreate()</code> and <code>actionUpdate()</code> methods can be left unchanged. </li></ol><br><br><h4>  Second iteration  We connect the database. </h4><br>  We figured out how to upload a file.  But it is not clear how to contact him.  What to write in the <code>src</code> tag parameter <code>img</code> ?  How to give a file to download?  In my opinion, it would be convenient to use the functionality of the Yii model for working with files.  In fact, if a model is matched to each downloaded file, all low-level operations, including downloading, can be assigned to it.  And in the <code>$modMyModel-&gt;id_image</code> store the primary key of this model (now the essence of the name of this property is clear).  Then for <code>$modMyModel</code> it will be possible to determine the corresponding links and write, for example, like this: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//  MyModel: public function relations() { return array( 'image' =&gt; array(self::BELONGS_TO, 'DImage', 'id_image'), ); } //  : $modMyModel = new MyModel; echo $modMyModel-&gt;id_image-&gt;image($htmlOptions); //        img echo $modMyModel-&gt;file-&gt;downloadLink(); //     </span></span></code> </pre><br><br>  In addition, when using the model, the question of storing the original file name (which is lost when saving) is solved by itself. <br><br>  Go. <br><br>  Create a <code>tbl_files</code> table with the fields <code>id, source, name</code> .  Define the <code>DFile</code> model associated with this table.  In it we define a static <code>upload</code> method: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DFile</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DActiveRecord</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $uploadPath; <span class="hljs-comment"><span class="hljs-comment">//     public function init() { $this-&gt;uploadPath = Yii::getPathOfAlias('application.data.files'); } public static function upload($objFile) { $modFile = new DFile; $modFile-&gt;name = $objFile-&gt;name; $modFile-&gt;source = uniqid(); if ($objFile-&gt;saveAs($modFile-&gt;uploadPath . '/' . $modFile-&gt;source)) if ($modFile-&gt;save()) return $modFile; return null; } }</span></span></code> </pre><br><br>  And immediately create an empty class <code>DImage extends DFile</code> .  We will need it later. <br>  Now let's change our model a bit.  Let's define the promised connection with the picture and slightly correct the <code>beforeSave()</code> method: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyModel</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DActiveRecord</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $id_image; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rules</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'id_image'</span></span>, <span class="hljs-string"><span class="hljs-string">'DImageValidator'</span></span>, <span class="hljs-string"><span class="hljs-string">'allowEmpty'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>), ); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">relations</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'image'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::BELONGS_TO, <span class="hljs-string"><span class="hljs-string">'DImage'</span></span>, <span class="hljs-string"><span class="hljs-string">'id_image'</span></span>), ); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beforeSave</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;attributes <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $attribute) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($attribute <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> CUploadedFile) { $modFile = DFile::upload($attribute); <span class="hljs-comment"><span class="hljs-comment">//   DFile $this-&gt;$key = $modFile-&gt;id; } return parent::beforeSave(); } }</span></span></code> </pre><br><br>  In the model's <code>$modMyModel</code> object, you can access the file via <code>$modMyModel-&gt;image</code> .  How profitable it is to use - read on. <br><br><h4>  Third iteration.  Appeals to downloaded files. </h4><br>  Up to this point, we almost did not share files and images.  In fact, their loading is absolutely identical.  The only difference is check before loading.  But validators of <code>DFileValidator</code> and <code>DImageValidator</code> will perfectly cope with this, in which you can specify all the necessary rules. <br><br>  In contrast to the download, access to the downloaded files and images are carried out in different ways.  Files are loaded so that they can be downloaded later, and the pictures - so that they can be watched.  Let's start with the files. <br><br><h5>  Work with files </h5><br>  Again, the files are downloaded in order to download them.  This often requires verification of access rights.  All you need to solve two problems, namely - the provision of links to download and, in fact, the issuance of a file for download. <br><br>  Link generation is convenient to do in <code>DFile</code> .  Like that: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DFile</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DActiveRecord</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">downloadLink</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($htmlOptions = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CHtml::link(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;name, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'/files/file/download'</span></span>, <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id), $htmlOptions); } }</code> </pre><br><br>  The link points to the <code>FileController</code> controller.  We define it: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FileController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DcController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionDownload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ $modFile = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;loadModel($id); header(<span class="hljs-string"><span class="hljs-string">"Content-Type: application/force-download"</span></span>); header(<span class="hljs-string"><span class="hljs-string">"Content-Type: application/octet-stream"</span></span>); header(<span class="hljs-string"><span class="hljs-string">"Content-Type: application/download"</span></span>); header(<span class="hljs-string"><span class="hljs-string">"Content-Disposition: attachment; filename="</span></span> . $modFile-&gt;name); header(<span class="hljs-string"><span class="hljs-string">"Content-Transfer-Encoding: binary "</span></span>); readfile($modFile-&gt;uploadPath . <span class="hljs-string"><span class="hljs-string">'/'</span></span> . $modFile-&gt;source); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ $modFile = DFile::model()-&gt;findByPk($id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($modFile === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CHttpException(<span class="hljs-number"><span class="hljs-number">404</span></span>,<span class="hljs-string"><span class="hljs-string">'The requested page does not exist.'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $modFile; } }</code> </pre><br><br>  I think everything is clear here.  The <code>actionDownload()</code> method does not make any additional checks, but you can easily enable them if necessary.  In the model now, having defined the appropriate link, you can write <code>$modMyModel-&gt;file-&gt;downloadLink()</code> .  Of course, this approach will be less productive than issuing direct links to files.  If performance is critical, you can order files not in a protected <code>data</code> directory, but in another (open) directory, and give direct links. <br><br><h5>  Work with pictures </h5><br>  With pictures, the situation is a bit more complicated.  Images require the creation of thumbnails.  In addition, with pictures, we certainly can not afford to produce dynamic links.  Fortunately, Yii provides a convenient resource publishing mechanism that can be used for our purposes.  The idea is this: we will create and publish miniatures as resources when generating links to a picture.  Here, however, there are a couple of troubles.  First, if you need access to the original picture, you will also have to copy it to the <code>assets</code> folder.  Secondly, the publication will not be possible to implement the standard means of Yii.  The fact is that for each published file, Yii will create its own folder, which will be brute force.  Yes, and the creation of thumbnails immediately in the folder of <code>assets</code> using standard tools will not work. <br><br>  The first problem may not be relevant if there are not very many images being downloaded and access to the original image is not required.  The original images are stored in good resolution, they can be downloaded using the mechanism described above, and only thumbnails are used for display on the screen.  If such a problem occurs, then, alternatively, you can not copy the original image to the <code>assets</code> folder, but create a link (the standard publishing mechanism in Yii suggests publishing with link creation). <br><br>  As for the second problem, you will have to write the publication yourself.  However, not too much to write ... <br><br>  So let's go.  We already have the <code>DImage</code> class inherited from <code>DFile</code> .  We describe the creation of thumbnails and publication: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DImage</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DFile</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $assetsPath; <span class="hljs-comment"><span class="hljs-comment">//      public $assetsUrl; // URL    public $thumbs = array( 'min' =&gt; array('width' =&gt; 150, 'height' =&gt; 150), 'mid' =&gt; array('width' =&gt; 250), 'big' =&gt; array('width' =&gt; 600), ); //   public function init() { $this-&gt;assetsUrl = Yii::app()-&gt;assetManager-&gt;baseUrl . '/files'; $this-&gt;assetsPath = Yii::app()-&gt;assetManager-&gt;basePath . '/files'; if (!is_dir($this-&gt;assetsPath)) mkdir($this-&gt;assetsPath); } //      $this-&gt;assetsPath public function getIsPublished() { foreach ($this-&gt;thumbs as $kThumb =&gt; $vThumb) if (!is_file($this-&gt;assetsPath . '/' . $this-&gt;source . '_' . $kThumb)) return false; return true; } //   public function publish() { if (!$this-&gt;isPublished) foreach ($this-&gt;thumbs as $kThumb =&gt; $vThumb) $this-&gt;createThumb($this-&gt;uploadPath . '/' . $this-&gt;source, $this-&gt;assetsPath . '/' . $this-&gt;source . '_' . $kThumb, $kThumb); return $this-&gt;assetsUrl . '/' . $this-&gt;source; } //   function createThumb($strSrcFile, $strDstFile, $strThumb) { //    $strSrcFile,   $strDstFile } }</span></span></code> </pre><br><br>  To publish thumbnails, I suggest creating a subfolder of <code>files</code> in the <code>assets</code> folder.  Considering that it is recommended to periodically clean the <code>assets/files</code> folder, it is necessary to check the existence of the <code>assets/files</code> folder every time.  And create if needed.  The name of the thumbnail is equal to the name of the image, supplemented by the identifier of the thumbnail.  The image is considered published if all the miniatures are in place.  There is no sense in checking the date of the original and published files, since the uploaded file cannot be changed.  The <code>publish()</code> function returns the URL of the published image (but without a thumbnail), which does not contradict the idea of ‚Äã‚Äãpublishing resources in Yii. <br><br>  And finally, consider the appeal to the uploaded picture.  <code>DImage</code> add the <code>DImage</code> class <code>DImage</code> the <code>image()</code> method: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">image</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($strThumb = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'min'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, $htmlOptions = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CHtml::image(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;publish() . <span class="hljs-string"><span class="hljs-string">'_'</span></span> . $strThumb, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;name, $htmlOptions); }</code> </pre><br><br>  Now, by analogy with files, you can write <code>$modMyModel-&gt;image-&gt;image()</code> in the model.  By the way, if the size of the thumbnails suddenly needs to be changed or added a new one (it happened to me once), and all the files have been uploaded, it will be enough to change the size in the settings and clear the assets folder. <br><br><h4>  Finishing touches </h4><br>  Everything is working.  Pictures are loaded, displayed.  Files uploaded and downloaded.  It remains to comb a little code.  For example, the beforeSave () method can be removed from the MyModel class to the DActiveRecord class, from which, as you have noticed, all models are inherited.  In addition, the display of inputs for files and images can be transferred to the class <code>DActiveForm extends CActiveForm</code> .  Storage of settings can be assigned to the <code>files</code> module. <br><br>  And, according to a good tradition, a link to download a <a href="">working project</a> .  Laying out individual files turned out to be problematic due to the large number of dependencies, so I post the whole project.  The database dump is protected / data / dump.sql.  From the settings - specify the path to Yii, set access to the database.  Base classes and validators are in the protected / components folder, all that concerns files is in the files module. <br><br><h4>  Conclusion </h4><br>  So, this is what we have at the exit: <br><br><ol><li>  Centralized file loading and storage management </li><li>  Convenient interface for creating file properties in models </li><li>  High-level generation of links to download IMG files and tags </li></ol><br><br>  The idea can be developed.  For example, almost all WYCIWYG editors offer an interface for downloading files and images.  To do this, you only need to specify the download address.  A download handler can be enabled in the <code>FileController</code> controller.  But how then publish miniatures? <br><br>  Or else, you can use the suggestions described in the articles <a href="http://habrahabr.ru/post/44610/">Secure upload images to the server.</a>  <a href="http://habrahabr.ru/post/44610/">Part one</a> and <a href="http://habrahabr.ru/post/44615/">Secure upload images to the server.</a>  <a href="http://habrahabr.ru/post/44615/">Part Two</a> .  You can supplement the above mentioned <a href="http://www.yiiframework.com/extension/upload/">upload</a> extension.  You can transfer the functional behavior. <br><br>  In a word, it is too early to consider the proposed solution.  But if the described idea turns out to be useful, he is ready to complete the work and publish the corresponding extension.  Thanks to everyone who read it! </div><p>Source: <a href="https://habr.com/ru/post/156293/">https://habr.com/ru/post/156293/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../156281/index.html">The benefits of a scientific approach for startups</a></li>
<li><a href="../156283/index.html">AnnotatedSQL lib - automatic database generation in Android</a></li>
<li><a href="../156285/index.html">Disable editing model properties in ASP.NET MVC</a></li>
<li><a href="../156289/index.html">Intel¬Æ Inspector XE 2013: Automatic Real-Time Verification and Debugging</a></li>
<li><a href="../156291/index.html">A selection of tools for efficient frontend development</a></li>
<li><a href="../156295/index.html">AutoTracker software. Work with routes and schedules</a></li>
<li><a href="../156299/index.html">Gartner: 10 defining technological trends for the next 5 years</a></li>
<li><a href="../156303/index.html">The Windows Store apps I use everyday, part 1</a></li>
<li><a href="../156305/index.html">Experience in measuring the market for developing mobile applications in Russia. Interview with Anatoly Larin</a></li>
<li><a href="../156309/index.html">PlayStation 3 boot loader protection</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>