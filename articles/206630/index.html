<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PIVOT</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In modern information systems, the decision-making process is often based on consolidated information. In practice, when developing business logic ope...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PIVOT</h1><div class="post__text post__text-html js-mediator-article">  In modern information systems, the decision-making process is often based on consolidated information.  In practice, when developing business logic operating with such information, it is very often necessary to convert rows into columns. <br><br>  The <i>T-SQL</i> syntax has a separate <i>PIVOT</i> construct for performing this conversion.  It is worth noting that in <i>SQL Server 2000 there was no</i> support for the <i>PIVOT</i> construct, so similar problems were solved through multiple CASE WHEN. <br><br>  Actually, why did I mention <i>CASE WHEN</i> , if there is a <i>PIVOT</i> ?  Indeed, by definition, the <i>PIVOT is a</i> more elegant design and, accordingly, should be more efficient. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's test it in practice ... <br><a name="habracut"></a><br>  We will create a table that will contain information about the employee‚Äôs exit to the workplace. <br><br><pre><code class="1c hljs">IF OBJECT_ID('dbo.WorkOut', 'U') IS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> DROP TABLE dbo.WorkOut GO CREATE TABLE dbo.WorkOut ( DateOut DATETIME NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, EmployeeID INT NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, CONSTRAINT PK_WorkOut PRIMARY KEY CLUSTERED (DateOut, EmployeeID) ) GO</code> </pre> <br>  And fill it with test data: <br><br><pre> <code class="1c hljs">INSERT INTO dbo.WorkOut (EmployeeID, DateOut) SELECT TOP <span class="hljs-number"><span class="hljs-number">1500000</span></span> ao.[object_id], ao1.modify_date FROM sys.all_objects ao CROSS JOIN sys.all_objects ao1</code> </pre><br>  Next, we will write a <i>PIVOT</i> request that will return the number of exits for each employee in the context of days: <br><br><pre> <code class="1c hljs">SELECT * FROM ( SELECT EmployeeID , [WeekDay] = DATENAME(WEEKDAY, DateOut) FROM dbo.WorkOut ) t PIVOT ( COUNT([WeekDay]) FOR [WeekDay] IN ( Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday ) ) p</code> </pre><br>  When executing the request, we get the following plan and execution time: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/adc/008/58f/adc00858f0524d5c9574bf6760f2f3aa.png"><br><br>  <i>SQL Server Execution Times:</i> <i><br></i>  <i>CPU time = 5662 ms, elapsed time = 8075 ms.</i> <br><br>  On the plan, you can see the operators <i>Sort</i> and <i>Hash Match</i> .  Their efficient operation depends very much on the size of the incoming data and the available amount of physical memory in order to process this very data. <br><br>  If it is impossible to allocate the required amount of memory, processing of the results will occur in the <i>tempdb</i> database (exclamation mark) - this can lead to a noticeable load on the disk subsystem and an increase in the query execution time: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/940/b39/d3b/940b39d3b5257b58e0f619044da84cd7.png"><br><br>  <i>SQL Server Execution Times:</i> <i><br></i>  <i>CPU time = 6193 ms, elapsed time = 9571 ms.</i> <br><br>  Let's see how the construction of <i>CASE WHEN</i> conditions with similar functionality behaves: <br><br><pre> <code class="1c hljs">SELECT EmployeeID , Monday = COUNT(CASE WHEN [WeekDay] = 'Monday' THEN <span class="hljs-number"><span class="hljs-number">1</span></span> END) , Tuesday = COUNT(CASE WHEN [WeekDay] = 'Tuesday' THEN <span class="hljs-number"><span class="hljs-number">1</span></span> END) , Wednesday = COUNT(CASE WHEN [WeekDay] = 'Wednesday' THEN <span class="hljs-number"><span class="hljs-number">1</span></span> END) , Thursday = COUNT(CASE WHEN [WeekDay] = 'Thursday' THEN <span class="hljs-number"><span class="hljs-number">1</span></span> END) , Friday = COUNT(CASE WHEN [WeekDay] = 'Friday' THEN <span class="hljs-number"><span class="hljs-number">1</span></span> END) , Saturday = COUNT(CASE WHEN [WeekDay] = 'Saturday' THEN <span class="hljs-number"><span class="hljs-number">1</span></span> END) , Sunday = COUNT(CASE WHEN [WeekDay] = 'Sunday' THEN <span class="hljs-number"><span class="hljs-number">1</span></span> END) FROM ( SELECT EmployeeID , [WeekDay] = DATENAME(WEEKDAY, DateOut) FROM dbo.WorkOut ) t GROUP BY EmployeeID</code> </pre><br>  When performing we will get a simpler plan.  At the same time, the execution time will not differ too much from <i>PIVOT</i> (of course, within the framework of the error): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dc4/1b9/0f8/dc41b90f8f197888345e6df056f35fa3.png"><br><br>  <i>SQL Server Execution Times:</i> <i><br></i>  <i>CPU time = 5201 ms, elapsed time = 8400 ms.</i> <br><br>  In conditions of low memory, we get the following results: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0a3/77b/fe7/0a377bfe7d96aa6c9ee9abbf7e4f44ad.png"><br><br>  <i>SQL Server Execution Times:</i> <i><br></i>  <i>CPU time = 6006 ms, elapsed time = 13883 ms.</i> <br><br>  From the obtained data, you can make a small observation - when aggregating data in a single column, there is a clear advantage over the <i>PIVOT</i> design.  Even in a situation where there is a shortage of memory to handle the results. <br><br>  Now let's see how these examples behave when increasing the number of columns by which the aggregation goes. <br><br>  1. Grouping by section: employee + year: <br><br><pre> <code class="1c hljs">SELECT EmployeeID , [Year] , Monday = COUNT(CASE WHEN [WeekDay] = 'Monday' THEN <span class="hljs-number"><span class="hljs-number">1</span></span> END) , ... , Sunday = COUNT(CASE WHEN [WeekDay] = 'Sunday' THEN <span class="hljs-number"><span class="hljs-number">1</span></span> END) FROM ( SELECT EmployeeID , [Year] = YEAR(DateOut) , [WeekDay] = DATENAME(WEEKDAY, DateOut) FROM dbo.WorkOut ) t GROUP BY EmployeeID, [Year]</code> </pre><br><br><img src="https://habrastorage.org/getpro/habr/post_images/8e6/e3d/6ba/8e6e3d6bab4edf3723e969b51cb8728b.png"><br><br>  <i>SQL Server Execution Times:</i> <i><br></i>  <i>CPU time = 5569 ms, elapsed time = 9200 ms.</i> <br><br><pre> <code class="1c hljs">SELECT * FROM ( SELECT EmployeeID , [Year] = YEAR(DateOut) , [WeekDay] = DATENAME(WEEKDAY, DateOut) FROM dbo.WorkOut ) t PIVOT ( COUNT([WeekDay]) FOR [WeekDay] IN ( Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday ) ) p</code> </pre><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f1a/047/8ff/f1a0478ff3febfa86a1efa852f887aef.png"><br><br>  <i>SQL Server Execution Times:</i> <i><br></i>  <i>CPU time = 5454 ms, elapsed time = 8878 ms.</i> <br><br>  If you compare the plans, you can see that the <i>Hash Match</i> operation is more costly when using <i>PIVOT</i> , but the execution time suggests otherwise. <br><br>  2. Grouping by section: employee + year + month <br><br><pre> <code class="1c hljs">SELECT EmployeeID , [Year] , [Month] , Monday = COUNT(CASE WHEN [WeekDay] = 'Monday' THEN <span class="hljs-number"><span class="hljs-number">1</span></span> END) , ... , Sunday = COUNT(CASE WHEN [WeekDay] = 'Sunday' THEN <span class="hljs-number"><span class="hljs-number">1</span></span> END) FROM ( SELECT EmployeeID , [Year] = YEAR(DateOut) , [Month] = MONTH(DateOut) , [WeekDay] = DATENAME(WEEKDAY, DateOut) FROM dbo.WorkOut ) t GROUP BY EmployeeID, [Year], [Month]</code> </pre><br><br><img src="https://habrastorage.org/getpro/habr/post_images/969/f49/c0a/969f49c0ac5783b8190487bd4888f0a0.png"><br><br>  <i>SQL Server Execution Times:</i> <i><br></i>  <i>CPU time = 6365 ms, elapsed time = 9979 ms.</i> <br><br><pre> <code class="1c hljs">SELECT * FROM ( SELECT EmployeeID , [Year] = YEAR(DateOut) , [Month] = MONTH(DateOut) , [WeekDay] = DATENAME(WEEKDAY, DateOut) FROM dbo.WorkOut ) t PIVOT ( COUNT([WeekDay]) FOR [WeekDay] IN ( Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday ) ) p</code> </pre><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c63/573/f73/c63573f734688c77fbdb4b02f1c18177.png"><br><br>  <i>SQL Server Execution Times:</i> <i><br></i>  <i>CPU time = 6193 ms, elapsed time = 9861 ms.</i> <br><br>  As a matter of fact, the situation repeats - <i>SQL Server</i> estimates the <i>PIVOT</i> construction as more costly. <br><br>  But runtime again puts everything in its place. <br><br>  Small conclusions can be drawn from this: in the overwhelming majority of situations, using the <i>PIVOT</i> construct, <i>you</i> can quickly convert columns to rows. <br><br>  A small note is the following: with an increase in the number of columns by which aggregation is taking place, the difference in execution time between PIVOT and CASE WHEN will decrease and at some point will be within the framework of measurement error. <br><br>  All experiments were conducted on <i>SQL Server 2012 SP1 (11.00.3128)</i> . </div><p>Source: <a href="https://habr.com/ru/post/206630/">https://habr.com/ru/post/206630/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../206616/index.html">Epson President: ‚ÄúHome-based 3D plastic printing has no great future. We will only do commercial 3D printers. ‚Äù</a></li>
<li><a href="../206620/index.html">Opencourseware</a></li>
<li><a href="../206622/index.html">We design a convenient email client</a></li>
<li><a href="../206624/index.html">"The largest digital camera" was sent into space</a></li>
<li><a href="../206628/index.html">NodeSchool - interactive lessons on Node.Js</a></li>
<li><a href="../206634/index.html">Earth - peasants, Androids - for all</a></li>
<li><a href="../206636/index.html">Principles of Reactive Programming in Moscow</a></li>
<li><a href="../206638/index.html">How does the selector fiber network work?</a></li>
<li><a href="../206642/index.html">New Year's quest Radmin</a></li>
<li><a href="../206648/index.html">New computer literature for December</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>