<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Take-Out Phone Lines with Grandstream VoIP Gateways</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Customers often come to us with a fairly common problem. In general terms, it can be expressed as follows: the company uses an analog telephone statio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Take-Out Phone Lines with Grandstream VoIP Gateways</h1><div class="post__text post__text-html js-mediator-article">  Customers often come to us with a fairly common problem.  In general terms, it can be expressed as follows: the company uses an analog telephone station to which it is necessary to connect some of the users from a remote location.  It can be a neighboring office, a neighboring city, or even another country - the main thing is that the telephone network does not reach there, but the LAN does not reach, or there is Internet access.  Today we will solve this problem with the help of Grandstream VoIP-gateways of the GXW4xxx series. <br><img src="https://habrastorage.org/files/512/849/e7b/512849e7b3de4893addc9bbab1dabae2.jpg"><br><br><a name="habracut"></a><br>  In fact, this problem has many variations.  For example, forwarding PSTN lines to another location or combining the number capacities of two remote analog PBXs is very similar in meaning and solution to the problem.  Therefore, in order not to introduce unnecessary confusion, we will immediately determine the initial data and take the following illustration for them: <br><img src="https://habrastorage.org/files/be9/9da/ffa/be99daffa61f44799a99153df5123d42.png"><br><br>  There is a head office of the company in which there is an analog PBX, with the numbering of internal phones 2XX.  There is also a remote office with four employees who need to assign internal numbers 301-304.  It is required to provide an opportunity for employees from different offices to directly call each other using an internal short number. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the headquarters of the company, we will place a Grandstream VoIP gateway with FXO ports.  This can be the GXW4104 model (4 ports) or the GXW4108 (8 ports).  And in a remote office, the gateway with FXS ports is GXW4004 (4 ports) or GXW4008 (8 ports).  For simplicity, we <a href="https://arttel.ru/shop/voip-shlyuzy/golosovoj-shlyuz-grandstream-gxw4104">accept</a> that we work with the four- <a href="https://arttel.ru/shop/voip-shlyuzy/golosovoj-shlyuz-grandstream-gxw4104">port GXW4104</a> and <a href="https://arttel.ru/shop/voip-shlyuzy/golosovoj-shlyuz-grandstream-gxw-4004">GXW4004 gateways,</a> respectively. <br><br>  Let's allocate four internal ports in our analog PBX and assign internal numbers to them - 301-304.  We connect the Grandstream GXW4104 to the local network, assign a static IP address and connect the internal PBX ports to the gateway ports (No. 301 to the first port of the gateway, No. 302 to the second, etc.).  At the remote branch, we will also assign a static address to the GXW4004 gateway and connect four analog telephone sets to it. <br><br>  Now we need to solve two subtasks: <br><ol><li>  Allow subscribers of the head office (‚Ññ201, ‚Ññ202) to call the subscribers of the remote office (‚Ññ‚Ññ 301 - 304) </li><li>  Allow remote office subscribers to call subscribers of the company's head office. </li></ol><br>  We will begin the solution to the first problem by configuring GXW4104: <br><br><ol><li>  Section <b>Accounts - Account 1 - General Settings</b> .  In the <b>SIP Server</b> field, specify the IP address of the Grandstream GXW4004 FXS gateway located in the remote office.  If the gateways are located in the same local network or VPNs are combined, we specify the local IP address.  Otherwise, we specify the external IP address of the remote division, and ports on the remote router will have to forward.  We'll talk about port forwarding separately later. <br><br><img src="https://habrastorage.org/files/793/68f/726/79368f726711473d8fcf61db31462abc.jpg"><br><br></li><li>  Section <b>Accounts - Account 1 - SIP Settings</b> .  In the <b>SIP Registration</b> field, select the <i>No</i> value ‚Äî the gateways will interact with each other in the ‚Äúno registration‚Äù mode. <br><br><img src="https://habrastorage.org/files/851/511/580/851511580e5946a294fa88cf5163d6c7.jpg"><br><br></li><li>  Section <b>Settings - Channels Settings - Calling to VoIP</b> .  In the <b>SIP Server</b> field, we specify <i>ch1-4: p1;</i>  This means that calls received from the PBX to any of the FXO ports of the gateway will be redirected to the IP address specified in the section <b>Accounts - Account 1 - General Settings</b> .  If for some reason instead of Account1 we would use Account2, then this entry would look like this: <i>ch1-4: p2;</i>  If we used the eight-port GXW4108 gateway, then we would specify <i>ch1-8</i> to work with all its ports <i>: p1;</i> <br><br><img src="https://habrastorage.org/files/0ab/89b/78a/0ab89b78ae1e48759564a2eab58aa2e0.jpg"><br><br></li><li>  Section <b>Settings - Channels Settings - Calling to VoIP</b> .  It is not enough to know the IP address to which calls should be redirected, you also need a SIP port.  Therefore, in the <b>SIP Destination Port</b> field, we change the default value of <i>ch1-4: 5060</i> to <i>ch1-4: 5060 ++;</i>  The record means that calls from the PBX to the first FXO port will be sent to the SIP port 5060 of the remote gateway, to the second FXO port to be sent to the SIP port 5062, and to the third and fourth ports to the ports 5064 and 5066, respectively.  Based on the SIP port to which the call came, the FXS gateway in the remote branch will be understood for which of its four phones that call is intended. </li><li>  Section <b>Settings - Channels Settings - Calling to VoIP</b> .  The <b>User ID</b> field defaults to <i>ch1-4:.</i>  This is not quite suitable for us, as in this case, the call that came from the PBX will not be automatically redirected to the IP network.  Instead, the gateway will wait for the PBX subscriber who initiated the call to dial some number to which the call should be sent.  It does not suit us, so it would be logical to write the following in this field: <i>ch1: 301; ch2: 302; ch3: 303; ch4: 304</i> .  Then the FXO gateway will add numbers 301-304 (depending on the port) to the SIP message for transmission to the FXS gateway.  But, as we noted earlier, the remote FXS gateway will distribute calls between its phones only on the basis of the SIP port, so such an entry would be unnecessary.  It is enough for us to specify absolutely any value, except for an empty one, so that the FXO gateway starts forwarding calls to the specified IP address on the specified ports.  Records <i>ch1-4: 123;</i>  or <i>ch1-4: x;</i>  will work well. </li></ol><br>  All other settings for the GXW4104 can be left as default.  And these settings are enough to organize communication from the subscribers of the head office with the subscribers of the branch.  Yes, the GXW4004 remote gateway does not even need to be configured, since by default it listens to ports 5060, 5062, 5064 and 5066 and transforms the messages that go to these ports and sends them to ports 1-4, respectively.  Odd SIP ports 5061, 5063, 5065, and 5067 on the FXS gateway are set as default for SIP over TLS. <br><br>  However, we are also required to solve the second task - to organize communication by the subscribers of the remote branch with the subscribers of the head office.  This problem can be solved in two ways: by analogy with the first task, using different SIP-ports for different channels or using dialplan.  Choose the second option: open the web interface of the Grandstream GXW4004 remote gateway and go to the <b>Profile 1</b> section: <br><br><img src="https://habrastorage.org/files/a01/60e/878/a0160e878695450da2ecf26ce5bcb0d4.jpg"><br><br><ol><li>  In the <b>Primary SIP Server</b> field, enter the IP address of the Grandstream GXW4104 FXO gateway located in the head office.  If it is not a local IP address, port forwarding will also be required. </li><li>  In the <b>SIP Registration</b> field, select the <i>No</i> value ‚Äî the gateways will interact with each other in the ‚Äúno registration‚Äù mode. </li><li>  In the <b>Outgoing Call without Registration</b> field, select <i>Yes</i> , thereby allowing outgoing calls to be made in the ‚Äúwithout registration‚Äù mode. </li><li>  In the <b>Dialplan</b> field <b>,</b> specify <i>{&lt;= 99 $ P&gt; x +}</i> .  This entry tells the gateway about the following: allow all numbers consisting of one or more digits (x +) to be dialed and add 99 $ P prefix to each dialed number, where $ P is the number of the FXS port to which the calling phone is connected.  When the subscriber 301 dials the number 202 on his phone, the GXW4004 will transmit the number of the type 99-1-202 to the GXW4104.  If subscriber 303 dials 204, it will be transmitted as 99-3-204.  It is on the basis of this prefix that the FXO gateway at the head office will determine through which FXO port it should transfer the call to the PBX. <br><img src="https://habrastorage.org/files/2a7/5a6/4ce/2a75a64ce3b7432eb93b0886305dc85d.jpg"><br></li></ol><br>  We return to the configuration of the GXW4104 gateway at the head office: open the web interface and go to the <b>FXO Lines&gt; Dialing</b> section. <br><br><ol><li>  In the field <b>Stage Method (1/2)</b> make the record <i>ch1-4: 1;</i>  This means that for all four channels the call will be used without dialing.  If we left the default <i>entry ch1-4: 2</i> , then the subscriber of the remote branch would have to redial the number he needed, after the call was sent to the FXO gateway.  And this is an extra job, because the subscriber once dialed the number he needs. <br><br><img src="https://habrastorage.org/files/474/a8a/249/474a8a2498174f8098e9473bbec0692e.jpg"><br><br></li><li>  In the <b>Prefix to Specify Port</b> field, leave the default value <i>99</i> .  Having found this prefix in the number that came from the branch, the FXO gateway will understand that the next digit is the port number through which it should send the call to the PBX.  Thus, we will ensure that calls from remote subscribers come strictly to their designated ports on the PBX. </li></ol><br>  This completes the configuration of the gateways - now the subscribers of the remote branch can call the head office employees and even to landline numbers via PBXs, if this is not explicitly prohibited on the PBX itself. <br><br><div class="spoiler">  <b class="spoiler_title">About port forwarding</b> <div class="spoiler_text">  What ports should be forwarded? <br><br><ol><li>  In our configuration, these are UDP ports 5060, 5062, 5064, and 5066 for the SIP protocol.  For eight-port gateways, you will also need to forward even-numbered ports 5068 - 5074. </li><li>  RTP voice traffic: 2 ports are used for each communication channel (RTP voice itself + RTCP control).  On the gateways, the starting port is specified in the <b>Local RTP port</b> option, the default for both gateways is 5004, respectively, the first port will be listening on UDP ports 5004 + 5005, for the second one 5006 + 5007, and so on.  Accordingly, when using Local RTP port = 5004, it is necessary to forward ports for the 4-port gateway - ports 5004-5011, and for the 8-port gateway - ports 5004-5019. </li></ol><br>  Naturally, port forwarding is strongly recommended to do with reference to the source address.  Better yet, completely abandon port forwarding and, if possible, organize a VPN network between two remote locations. <br></div></div><br><br><h3>  Multiple remote offices </h3><br>  Change the task a bit.  Suppose we need to connect not one but several remote branches to the central PBX of the company.  Let it be three retail outlets with one subscriber in each: <br><img src="https://habrastorage.org/files/8a3/56b/0d6/8a356b0d613949889cdb98058b839206.png"><br><br>  Instead of four-port gateways, it would be more logical to put inexpensive single-port SIP adapters at these points, for example, Grandstream HT701.  How, then, will the settings on the GXW4104 change?  To pass a call from the subscribers of the head office to the remote subscribers no longer need to use different SIP ports, since now calls for different remote subscribers will be directed to different IP addresses.  And here we encounter the first problem - the number of SIP servers that can be set up on GXW4104 (and even on GXW4108) is limited to three, so more than three locations can be connected via one such FXO gateway. <br><br><ol><li>  Go to the section <b>Accounts - Account 1 - General Settings</b> .  In the <b>SIP-Server</b> field, specify the IP address of the HT701 retail point 1. Do the same for Account 2 and Account 3, specifying the addresses of the gateways from retail point 2 and 3, respectively. <br><br><img src="https://habrastorage.org/files/008/f33/2b8/008f332b80d74e31956e6938f3d9c6a8.jpg"><br><br></li><li>  Section <b>Accounts - Account 1 - SIP Settings</b> .  In the <b>SIP Registration</b> field, select the value <i>No.</i>  Repeat for Account 2 and Account 3. <br><br><img src="https://habrastorage.org/files/92b/d71/004/92bd71004f9c4c0288b0cd29744fcb4c.jpg"><br><br></li><li>  Section <b>Settings - Channels Settings - Calling to VoIP</b> .  In the <b>SIP Server</b> field, we specify <i>ch1: p1; ch2: p2; ch3: p3; ch4: p1;</i>  Although the fourth channel is not used, we must assign a profile for it.  In the <b>SIP Destination Port</b> field, we leave the default value of <i>ch1-4: 5060</i> .  The <b>User ID</b> field is filled in similarly to the previous example, for example, <i>ch1-4: 123;</i> <br><br><img src="https://habrastorage.org/files/47b/ccb/235/47bccb2350304610a820ba8b4b2e54c2.jpg"><br><br></li></ol><br>  Outgoing calls from the central PBX to remote points were earned, since each HT701 listens to its own port 5060 by default and when a call arrives, it initiates a call to the phone connected to the only FXS port.  In order for calls to go the other way, you need to configure each Grandstream HT701.  Go to the HT-701 gateway's web interface and go to the <b>FXS PORT</b> section. <br><br><ol><li>  In the <b>Primary SIP Server</b> field, enter the IP address of the FXO gateway to the Grandstream GXW4104. <br><br><img src="https://habrastorage.org/files/873/ba9/376/873ba9376ce24b3990898461463c04b5.jpg"><br><br></li><li>  In the <b>SIP Registration</b> field, select <i>No</i> <br><br><img src="https://habrastorage.org/files/f21/d04/939/f21d04939913483fa4b1ed204bf612f2.jpg"><br><br></li><li>  In the <b>Dial Plan Prefix</b> field, <b>enter</b> <i>991</i> for the first point (telephone 301), <i>992</i> for the second (302) and <i>993</i> for the third (303).  Based on this prefix, the FXO gateway in the head office will understand through which port the call should be sent to the PBX. <br><br><img src="https://habrastorage.org/files/3cc/226/2c8/3cc2262c8d504ca9b6a6378843d7a1c7.jpg"><br><br></li></ol><br>  If in the settings <b>FXO Lines&gt; Dialing</b> Grandstream GXW4104 in the <b>Stage Method</b> field <b>(1/2) is</b> specified <i>ch1-4: 1</i> , and in the <b>Prefix to Specify Port</b> field is indicated <i>99</i> , then calls from the subscribers of remote points to the side of the PBX will also work. <br><br><h3>  We use IP phones </h3><br>  In this task, the FXO gateway installed in the head office is a key element, which we cannot refuse, since the central PBX, under the terms of the task, does not support the SIP protocol.  If replacing a central PBX is a time consuming and expensive procedure, then replacing analog telephones with SIP-enabled devices in remote branches is quite easy and many of our customers do.  This simplifies the scheme somewhat: <br><img src="https://habrastorage.org/files/aea/e98/27e/aeae9827eddf4290832719301044e286.png"><br><br>  The settings for the GXW4104 do not change compared to the previous example.  IP phone settings consider the example of the model <a href="https://arttel.ru/shop/ip-telefony/ip-telefon-grandstream-gxp1620">Grandstream GXP1620</a> .  Open the Web-interface and go to the section <b>Accounts - Account 1 - General Settings</b> . <br><br><ol><li>  In the <b>Account Name</b> field, enter the phone number - 301, 302 or 303. </li><li>  In the <b>SIP Server</b> field, enter the IP address of the FXO gateway of the Grandstream GXW4104. <br><br><img src="https://habrastorage.org/files/ebc/ade/2b7/ebcade2b796846638deefd2d2df9972c.jpg"><br><br></li><li>  Let's go to the <b>Account 1 - SIP Settings - Basic Settings</b> section and select <i>No</i> in the <b>SIP Registration</b> field. <br><br><img src="https://habrastorage.org/files/3ad/a6a/e56/3ada6ae569a543ab84a2745067c7d411.jpg"><br><br></li><li>  Let's go to the <b>Account 1 - Call Settings</b> section and in the <b>Dial Plan Prefix</b> field, enter the value <i>991</i> for the phone 301, <i>992</i> for the phone 302 and <i>993</i> for the phone 303. <br><br><img src="https://habrastorage.org/files/9dc/f88/b15/9dcf88b151344212aca8beb6bffe415a.jpg"><br><br></li></ol><br>  This completes the configuration of the IP phone - now you can make calls to the phones of subscribers of the central PBX.  It should be noted that not all phones can work in this configuration.  The main requirement for devices - the ability to make calls without registration.  Also, phones must be able to add a prefix to the dialed number.  The second requirement is not mandatory, because instead of using a dialplan, you can route calls from different IP phones to different SIP ports of the FXO gateway, which will allow the latter to send calls to the PBX correctly.  You can also use 2-stage dialing, which, however, is less convenient.  The most popular brands of IP-phones, such as Grandstream, Yealink, Fanvil, Linksys meet the specified requirements and support the work in this configuration. </div><p>Source: <a href="https://habr.com/ru/post/395875/">https://habr.com/ru/post/395875/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../395863/index.html">The mystery of medicine: colon cancer, heart disease and dementia are receding, but no one can explain why</a></li>
<li><a href="../395865/index.html">Contextual commerce is a new trend in e-commerce</a></li>
<li><a href="../395869/index.html">Torrent with 427 million MySpace passwords</a></li>
<li><a href="../395871/index.html">Scientists warn about side effects of weak electrical stimulation of the brain</a></li>
<li><a href="../395873/index.html">Scientists first investigated and described the mechanism of activation of a chain of neurons in the brain responsible for the tendency to aggression</a></li>
<li><a href="../395879/index.html">Discussion: Do HFT Traders Like Their Work?</a></li>
<li><a href="../395881/index.html">Parasitica</a></li>
<li><a href="../395883/index.html">The smart REDMOND Smart plug SkyPlug RSP-100S (Part 2). The main drawback of the outlet and its elimination</a></li>
<li><a href="../395885/index.html">RAO Demands Rakhmaninov Museum Money for Rachmaninov Music</a></li>
<li><a href="../395887/index.html">Construction ITER ahead of schedule. The first plasma is scheduled for 2025</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>