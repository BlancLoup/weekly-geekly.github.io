<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asynchronous WEB in 2018. We write chat on Websocket using Swoole</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The theme of Websocket `s has been touched on more than once in Habr√©, in particular, options for implementing in PHP were considered. However, more t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asynchronous WEB in 2018. We write chat on Websocket using Swoole</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/8p/gc/di/8pgcdiztceoyeqy2os69qvw8rmq.png"><br><br>  The theme of <a href="https://ru.wikipedia.org/wiki/WebSocket">Websocket `s</a> has been touched on more than once in Habr√©, in particular, options for implementing in PHP were considered.  However, more than a year has passed since the <a href="https://habr.com/post/331462/">last article</a> with a review of various technologies, and the PHP world <a href="https://tsh.io/blog/swoole-is-it-node-in-php-or-am-i-wrong/%3Futm_source%3Dtwitter%26utm_medium%3Dsocial%26utm_campaign%3Dphp%26utm_content%3Dfanpage">has something to</a> boast of over time. <br><br>  In this article I want to introduce <a href="https://www.swoole.co.uk/">Swoole</a> to the Russian-speaking community - Asynchronous Open Source framework for PHP, written in C, and delivered as a pecl extension. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      View the resulting application (chat), you can: <a href="http://62.109.21.96/">here</a> . <br>  <a href="https://github.com/EvgeniiR/ws-chat">Sources on github</a> . <br><a name="habracut"></a><br><h2>  Why Swoole? </h2><br>  Surely there will be people who, in principle, will be against using PHP for such purposes, but in favor of PHP they can often play: <br><br><ul><li>  Reluctance to breed a zoo of various languages ‚Äã‚Äãon the project </li><li>  The ability to use the already established code base (if the project is in PHP). </li></ul><br>  Nevertheless, even comparing with node.js / go / erlang and other languages ‚Äã‚Äãnatively offering the asynchronous model, Swoole - a framework written in C and combining the low threshold of entry and powerful functionality can be quite a good candidate. <br><br>  <b>Framework features:</b> <br><br><ul><li>  Event, asynchronous programming model </li><li>  Asynchronous TCP / UDP / HTTP / Websocket / HTTP2 client / server APIs </li><li>  Support IPv4 / IPv6 / Unixsocket / TCP / UDP and SSL / TLS </li><li>  Fast serialization / deserialization of data </li><li>  High performance, expandability, support for up to 1 million simultaneous connections </li><li>  Task Scheduler accurate to milliseconds </li><li>  <a href="https://github.com/swoole/swoole-src">Open source</a> </li><li>  <a href="https://www.swoole.co.uk/coroutine">Coroutines support (Coroutines)</a> </li></ul><br>  <b>Possible uses:</b> <br><br><ul><li>  Microservices </li><li>  Game servers </li><li>  Internet of things </li><li>  Live communication systems </li><li>  WEB API </li><li>  Any other services that require instant response / high speed / asynchronous execution </li></ul><br>  Code samples can be seen on the <a href="https://www.swoole.co.uk/">main page of the site</a> .  In the documentation section for more information about the entire functionality of the framework. <br><br><h2>  Getting Started </h2><br>  Below I will describe the process of writing a simple Websocket server for online chat and the possible difficulties. <br><br>  Before you begin: More information about the classes <a href="https://www.swoole.co.uk/docs/modules/swoole-websocket-server">swoole_websocket_server</a> and <a href="https://www.swoole.co.uk/docs/modules/swoole-server-doc">swoole_server</a> (The second class is inherited from the first). <br>  <a href="https://github.com/EvgeniiR/ws-chat">Sources of the chat.</a> <br><br><div class="spoiler">  <b class="spoiler_title">Installing the framework</b> <div class="spoiler_text"><code>Linux users <br> <br> #!/bin/bash <br> pecl install swoole <br> <br> Mac users <br> <br> # get a list of avaiable packages <br> brew install swoole <br> #!/bin/bash <br> brew install homebrew/php/php71-swoole <br></code> <br></div></div><br>  To use autocomplete in IDE it is suggested to use <a href="https://github.com/wudi/swoole-ide-helper">ide-helper</a> <br><br>  <b>Minimal Websocket Server Template:</b> <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $server = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> swoole_websocket_server(<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-number"><span class="hljs-number">9502</span></span>); $server-&gt;on(<span class="hljs-string"><span class="hljs-string">'open'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($server, $req)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"connection open: {$req-&gt;fd}\n"</span></span>; }); $server-&gt;on(<span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($server, $frame)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"received message: {$frame-&gt;data}\n"</span></span>; $server-&gt;push($frame-&gt;fd, json_encode([<span class="hljs-string"><span class="hljs-string">"hello"</span></span>, <span class="hljs-string"><span class="hljs-string">"world"</span></span>])); }); $server-&gt;on(<span class="hljs-string"><span class="hljs-string">'close'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($server, $fd)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"connection close: {$fd}\n"</span></span>; }); $server-&gt;start();</code> </pre><br>  $ fd is the connection identifier. <br>  Get current connections: <br><br><pre> <code class="php hljs">$server-&gt;connections;</code> </pre> <br>  Inside the $ frame contains all the data sent.  Here is an example of the incoming object in the onMessage function: <br><br><pre> <code class="hljs php">Swoole\WebSocket\Frame Object ( [fd] =&gt; <span class="hljs-number"><span class="hljs-number">20</span></span> [data] =&gt; {<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"login"</span></span>,<span class="hljs-string"><span class="hljs-string">"username"</span></span>:<span class="hljs-string"><span class="hljs-string">"new user"</span></span>} [opcode] =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> [finish] =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> )</code> </pre><br>  Data is sent to the client using the function <br><br><pre> <code class="php hljs">Server::push($fd, $data, $opcode=<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, $finish=<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)</code> </pre> <br>  Learn more about frames and opcodes in Russian - <a href="https://learn.javascript.ru/websockets">learn.javascript</a> .  Section "data format" <br><br>  The most detailed about the protocol Websocket - <a href="https://tools.ietf.org/html/rfc6455">RFC</a> <br><br>  <b>How to save data that came to the server?</b> <br>  Swoole provides functionality for asynchronous work with <a href="https://www.swoole.co.uk/docs/modules/swoole-async-mysql-client">MySQL</a> , <a href="https://www.swoole.co.uk/docs/modules/swoole-async-redis-client">Redis</a> , <a href="https://www.swoole.co.uk/docs/modules/swoole-async-io">file I / O.</a> <br><br>  And also <a href="https://www.swoole.co.uk/docs/modules/swoole-buffer">swoole_buffer</a> , <a href="https://www.swoole.co.uk/docs/modules/swoole-channel">swoole_channel</a> and <a href="https://www.swoole.co.uk/docs/modules/swoole-table">swoole_table</a> <br>  I think the differences are not difficult to understand the documentation.  For storing usernames, I chose swoole_table.  The messages themselves are stored in MySQL. <br><br>  So, initialization of the table of user names: <br><br><pre> <code class="php hljs">$users_table = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> swoole_table(<span class="hljs-number"><span class="hljs-number">131072</span></span>); $users_table-&gt;column(<span class="hljs-string"><span class="hljs-string">'id'</span></span>, swoole_table::TYPE_INT, <span class="hljs-number"><span class="hljs-number">5</span></span>); $users_table-&gt;column(<span class="hljs-string"><span class="hljs-string">'username'</span></span>, swoole_table::TYPE_STRING, <span class="hljs-number"><span class="hljs-number">64</span></span>); $users_table-&gt;create();</code> </pre><br>  Filling data is as follows: <br><br><pre> <code class="php hljs">$count = count($messages_table); $dateTime = time(); $row = [<span class="hljs-string"><span class="hljs-string">'username'</span></span> =&gt; $username, <span class="hljs-string"><span class="hljs-string">'message'</span></span> =&gt; $data-&gt;message, <span class="hljs-string"><span class="hljs-string">'date_time'</span></span> =&gt; $dateTime]; $messages_table-&gt;set($count, $row);</code> </pre><br>  To work with MySQL, I decided not to use the asynchronous model, but to use the standard way, from the web socket server, via PDO <br><br><div class="spoiler">  <b class="spoiler_title">Appeal to the base</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Message[] */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $stmt = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;pdo-&gt;query(<span class="hljs-string"><span class="hljs-string">'SELECT * from messages'</span></span>); $messages = []; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($stmt-&gt;fetchAll() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row) { $messages[] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Message( $row[<span class="hljs-string"><span class="hljs-string">'username'</span></span>], $row[<span class="hljs-string"><span class="hljs-string">'message'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \DateTime($row[<span class="hljs-string"><span class="hljs-string">'date_time'</span></span>]) ); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $messages; }</code> </pre> <br></div></div><br>  Websocket server, it was decided to issue in the form of a class, and start it in the constructor: <br><br><div class="spoiler">  <b class="spoiler_title">Constructor</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ws = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> swoole_websocket_server(<span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span>, <span class="hljs-number"><span class="hljs-number">9502</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ws-&gt;on(<span class="hljs-string"><span class="hljs-string">'open'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($ws, $request)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;onConnection($request); }); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ws-&gt;on(<span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($ws, $frame)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;onMessage($frame); }); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ws-&gt;on(<span class="hljs-string"><span class="hljs-string">'close'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($ws, $id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;onClose($id); }); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ws-&gt;on(<span class="hljs-string"><span class="hljs-string">'workerStart'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(swoole_websocket_server $ws)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;onWorkerStart($ws); }); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ws-&gt;start(); }</code> </pre> <br></div></div><br>  <b>Problems encountered:</b> <br><br><ol><li>  The user connected to the chat breaks the connection after 60 seconds if there is no packet exchange (that is, the user did not send or receive anything) </li><li>  The web server loses connection with MySQL if no interaction takes place for a long time. </li></ol><br>  Decision: <br><br>  In both cases, the implementation of the ping function is needed, which will constantly ping the client in the first case every n seconds, and the MySQL database in the second. <br><br>  Since both functions must work asynchronously, they must be called in the child processes of the server. <br><br>  To do this, they can be initialized at the workerStart event.  We have already defined it in the constructor, and this event already calls the $ this-&gt; onWorkerStart method: <br>  Websocket protocol supports <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_servers">ping-pong</a> out of the box.  Below you can see the implementation on Swoole. <br><br><div class="spoiler">  <b class="spoiler_title">onWorkerStart</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onWorkerStart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(swoole_websocket_server $ws)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;messagesRepository = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessagesRepository(); $ws-&gt;tick(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::PING_DELAY_MS, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($ws)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($ws-&gt;connections <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $id) { $ws-&gt;push($id, <span class="hljs-string"><span class="hljs-string">'ping'</span></span>, WEBSOCKET_OPCODE_PING); } }); }</code> </pre> <br></div></div><br>  Next, I implemented a simple function for pinging a MySQL server every N seconds using swoole \ Timer: <br><br><div class="spoiler">  <b class="spoiler_title">Databasehelper</b> <div class="spoiler_text">  The timer itself starts in initPdo if not already enabled: <br><br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * Init new Connection, and ping DB timer function */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initPdo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$timerId === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || (!Timer::exists(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$timerId))) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$timerId = Timer::tick(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::MySQL_PING_INTERVAL, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ping(); }); } <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$pdo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PDO(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::DSN, DBConfig::USER, DBConfig::PASSWORD, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::OPT); } <span class="hljs-comment"><span class="hljs-comment">/** * Ping database to maintain the connection */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ping</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$pdo-&gt;query(<span class="hljs-string"><span class="hljs-string">'SELECT 1'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (PDOException $e) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::initPdo(); } }</code> </pre><br></div></div><br>  The main part of the work was to write logic for adding, saving, sending messages (no more difficult than the usual CRUD), and then a huge scope for improvements. <br><br>  So far, I've brought my code to a more or less readable form and object-oriented style, implemented a bit of functionality: <br><br>  - Login by name; <br><br><div class="spoiler">  <b class="spoiler_title">- Verify that the name is not taken</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $username * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isUsernameCurrentlyTaken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $username)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;usersRepository-&gt;getByIds(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ws-&gt;connection_list()) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $user) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($user-&gt;getUsername() == $username) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">- Request spammer for spam protection</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Helpers</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Swoole</span></span>\<span class="hljs-title"><span class="hljs-title">Channel</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RequestLimiter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> Channel */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $userIds; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MAX_RECORDS_COUNT = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MAX_REQUESTS_BY_USER = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userIds = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Channel(<span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">64</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/** * Check if there are too many requests from user * and make a record of request from that user * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $userId * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkIsRequestAllowed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $userId)</span></span></span><span class="hljs-function"> </span></span>{ $requestsCount = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRequestsCountByUser($userId); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addRecord($userId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($requestsCount &gt;= <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::MAX_REQUESTS_BY_USER) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $userId * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> int */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRequestsCountByUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $userId)</span></span></span><span class="hljs-function"> </span></span>{ $channelRecordsCount = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userIds-&gt;stats()[<span class="hljs-string"><span class="hljs-string">'queue_num'</span></span>]; $requestsCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $channelRecordsCount; $i++) { $userIdFromChannel = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userIds-&gt;pop(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userIds-&gt;push($userIdFromChannel); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($userIdFromChannel === $userId) { $requestsCount++; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $requestsCount; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $userId */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addRecord</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $userId)</span></span></span><span class="hljs-function"> </span></span>{ $recordsCount = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userIds-&gt;stats()[<span class="hljs-string"><span class="hljs-string">'queue_num'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($recordsCount &gt;= <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::MAX_RECORDS_COUNT) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userIds-&gt;pop(); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userIds-&gt;push($userId); } }</code> </pre> <br>  PS: Yes, the check is on connection id.  Perhaps it makes sense to replace it in this case, for example, with the user's IP address. <br><br>  I'm also not sure that swoole_channel was best suited in this situation.  I think later to reconsider this moment. <br></div></div><br>  - <a href="https://packagist.org/packages/ezyang/htmlpurifier">Simple</a> XSS protection using <a href="https://packagist.org/packages/ezyang/htmlpurifier">ezyang / htmlpurifier</a> <br><br><div class="spoiler">  <b class="spoiler_title">- simple spam filter</b> <div class="spoiler_text">  With the ability to further add additional checks. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Helpers</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SpamFilter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string[] errors */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $errors = []; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $text * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkIsMessageTextCorrect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $text)</span></span></span><span class="hljs-function"> </span></span>{ $isCorrect = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(trim($text))) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;errors[] = <span class="hljs-string"><span class="hljs-string">'Empty message text'</span></span>; $isCorrect = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $isCorrect; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string[] errors */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getErrors</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;errors; } }</code> </pre> <br></div></div><br>  Frontend at the chat is still very raw, because  I am more attracted to the backend, but when there is more time I will try to make it more pleasant. <br><br><h2>  Where to get information, get news about the framework? </h2><br><ul><li>  <a href="https://www.swoole.co.uk/">English official site</a> - useful links, relevant documentation, some comments from users </li><li>  <a href="https://twitter.com/php_swoole">Twitter</a> - current news, useful links, interesting articles </li><li>  <a href="https://github.com/swoole/swoole-src/issues">Issue tracker (Github)</a> - bugs, questions, communication with the creators of the framework.  They answer very smartly (they answered my issue with a question in a couple of hours, helped with the implementation of pingloop). </li><li>  <a href="https://github.com/swoole/swoole-src/issues%3Fq%3Dis%253Aissue%2Bis%253Aclosed">Closed issues</a> - also advise.  A large database of questions from users and answers from the creators of the framework. </li><li>  <a href="https://github.com/swoole/swoole-src/tree/master/tests">Tests written by developers</a> - for almost every module of the documentation there are tests written in PHP, showing use cases. </li><li>  <a href="https://wiki.swoole.com/wiki/page/p-async.html">Chinese wiki framework</a> - all the information is in English, but much more comments from users (google translator to help). </li></ul><br>  <a href="https://rawgit.com/tchiotludo/swoole-ide-helper/english/docs/index.html">API documentation</a> - the description of some classes and functions of the framework in a rather convenient form. <br><br><h3>  Summary </h3><br>  It seems to me that Swoole was very actively developing over the past year, out of the stage when it could be called ‚Äúraw‚Äù, and now it is in competition with the use of node.js / go from the point of view of asynchronous programming and implementation of network protocols. <br><br>  I will be glad to hear different opinions on the topic and feedback from those who already have experience using Swoole <br><br>  You can chat in the described chatik by <a href="http://62.109.21.96/">reference.</a> <br>  Sources are available on <a href="https://github.com/EvgeniiR/ws-chat">Github</a> . </div><p>Source: <a href="https://habr.com/ru/post/427589/">https://habr.com/ru/post/427589/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../427579/index.html">Distributing an iOS application within a company (Enterprise Distribute iOS App in-house)</a></li>
<li><a href="../427581/index.html">Testing Zyxel vs Ubiquiti Access Points</a></li>
<li><a href="../427583/index.html">We communicate with influential journalists in the press: 10 secrets that will increase the likelihood of the publication of your article</a></li>
<li><a href="../427585/index.html">The recipe for a popular and successful MMO game</a></li>
<li><a href="../427587/index.html">Java concentrated on one and a half thousand people. How was Joker 2018</a></li>
<li><a href="../427591/index.html">Architecture as a burden</a></li>
<li><a href="../427593/index.html">The magic of fast teams in Vivaldi 2.1</a></li>
<li><a href="../427595/index.html">Try Micronaut or Honey, I have reduced the framework</a></li>
<li><a href="../427601/index.html">5 + 1 case where the REST API specification plays a huge role</a></li>
<li><a href="../427603/index.html">How to finally start writing tests and not regret it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>