<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FreeBSD versus GRUB</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. This article is devoted to my private struggle against GRUB, well, or for it, this is how to look. 
 It took to put a grub-loader on freebsd...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FreeBSD versus GRUB</h1><div class="post__text post__text-html js-mediator-article">  Good day.  This article is devoted to my private struggle against GRUB, well, or for it, this is how to look. <br>  It took to put a grub-loader on freebsd, of course, many people know about chainloader + 1, but this method was not suitable for me. <br><a name="habracut"></a><br><br><h5>  Prelude </h5><br><br>  So, we put a hornbeam (the first, the second seemed to me too monstrous): <br> <code># cd /usr/ports/sysutils/grub &amp;&amp; make install</code> <br>  Now you need to actually register it as a loader. <br> <code># grub-install /dev/ad8</code> <br>  This is where the problems went.  He tells us the unfortunate news - <i>"The file / boot / grub / stage1 is not read correctly."</i> . <br>  How so?  I myself saw this file when I checked whether the hornbeam was delivered. <br>  Okay, I'll look at the logs: <br> <code># cat /tmp/grub-install.log.XXXXX <br> grub&gt; dump (hd2,0,a)/boot/grub/stage1 /tmp/grub-install.img.XXXXX <br> <br> Error 22: No such partition <br> grub&gt; quit</code> <br> <br>  Error does not tell me anything, because there is a section by itself.  Google did not help, except that it was a question of a bug with a large inode size in ext3, but I have ufs, and there the size is fixed and equal to 128 bytes.  Therefore, I made the decision to dig the sorts myself, despite the fact that the code was written badly in terms of design and structure. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Error 22 </h5><br><br>  We start the study with the definition of a constant corresponding to this error, it is simple - <b>ERR_NO_PART</b> , then we can see who can return this error (in fact, grub'e has a certain errno analogue, that is, a global variable that contains the last error number). <br>  There are only 2 such places, and they are located in 2 neighboring lambda functions (hello gcc!) <b>Next_bsd_partition ()</b> and <b>next_pc_slice ()</b> by name everything is clear - the second lists the bsd slices, the first one lists the sections in these slices. <br><br>  I immediately dismissed the idea of ‚Äã‚Äãstatic analysis, because of the structure of grub'a code - very, very simple, a lot of global variables and almost no arguments for functions.  I also didn‚Äôt really want to debug with gdb, because there is not much experience in this and everything happened on a remote server, so it‚Äôs impossible to use any xxgdb.  Therefore, I chose the simple approach of newbies - we insert printfs in obscure places.  Here I also had difficulties: <br><br><ul><li>  When compiling <a href="">alpha.gnu.org/gnu/grub/grub-0.97.tar.gz, a</a> different result was obtained compared to compiling from ports.  As in the binary structure (for example, the size of ./grub/grub ~ 350Kb versus 150Kb of the port), and in terms of functionality - root (hd _TAB_ produced only 2 disks, instead of the correct 5. <br>  I bypassed this moment very simply - I compiled the version from the ports, but did not clean it ( <b>make clean</b> ), and from / usr / src / ports / sysutils / grub / work / grub took the correct version of the samples and correctly configured. </li><li>  printf has its hornbeam. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> WITHOUT_LIBC_STUBS ... #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> printf grub_printf ... #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre><br>  I wanted to recompile without this define, but I looked at their version and left it as it is.  It supports only d, x, X, u, c, s, and without any accuracy and width, just% LITERAL, in principle, this was enough for me. <br></li></ul><br><br>  I wanted a quicker check, in fact - not to enter the hornbeam console every time and not to type 2 lines.  This is done by a simple command (which I spied in the grub-install shell script): <br> <code>./grub/grub --batch &lt; cmd</code> <br>  Where cmd contains a list of commands, I have in this case: <br> <code>dump (hd2,0,a)/boot/grub/stage1 test_img <br> quit</code> <br> <br>  The workplace is ready, we start "debugging".  We insert printf () into the beginning of those two functions and watch at what level of hierarchy we stumble. <br>  We stumbled over sections, so here we have a cycle: <br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">/* Search next valid BSD partition. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = bsd_part_no + <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; BSD_LABEL_NPARTS (buf); i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (BSD_PART_TYPE (buf, i)) { <span class="hljs-comment"><span class="hljs-comment">/* Note that *TYPE and *PARTITION were set for current PC slice. */</span></span> *type = (BSD_PART_TYPE (buf, i) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | (*type &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>); *start = BSD_PART_START (buf, i); *len = BSD_PART_LENGTH (buf, i); *partition = (*partition &amp; <span class="hljs-number"><span class="hljs-number">0xFF00FF</span></span>) | (i &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>); <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> STAGE1_5 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* XXX */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ((drive &amp; 0x80) &amp;&amp; BSD_LABEL_DTYPE (buf) == DTYPE_SCSI) bsd_evil_hack = 4; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* ! STAGE1_5 */</span></span></span><span class="hljs-meta"> return 1; } }</span></span></code> </pre><br>  By the way, you can pay attention to the interesting position of developers - indents are implemented using a combination of tabs and spaces, that is, 2 tabs, 4 spaces, for example.  Which is very "like" the editor, in which I ruled the code. <br>  If the <b>BSD_PART_TYPE (buf, i)</b> condition never worked, then we <b>‚Äôve</b> concluded that the patricians had run out. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BSD_PART_TYPE(l_ptr, part) \ ( *( (unsigned char *) (((int) l_ptr) + BSD_PART_OFFSET + 12 \ + (part &lt;&lt; 4)) ) )</span></span></code> </pre><br>  This define is ‚Äúvery‚Äù understandable.  For clarification, I had to go to Dr. <b>CPJ Koymans</b> ‚Äôs <b>‚ÄúBooting, Partitioning and File Systems‚Äù</b> . <br>  There is a slice structure, in which we see that at offset 12 from the block describing one section lies the <b>Partition type</b> field, and here it is apparently equal to 0, since the condition does not work. <br>  Checking - <b>bsdlabel / dev / ad8s1</b> , really - it is written that <b>unused</b> .  Well, to fix the matter is not <b>long</b> - <b>bsdlavel -e / dev / ad8s1</b> .  But he does not want - ‚Äúclass not found‚Äù. <br>  Of course, before installing the hornbeam, I checked the box ( <b>sysctl kern.geom.debugflags = 16</b> ), googled, advised to put 17 in the latest versions of the fryah, set it - no result. <br><br>  There was no desire to delve into the bsdlabel'a sorcerers, so <b>ktrace bsdlabel -e / dev / ad8s1 was easier</b> , then <b>kdump |</b>  <b>more</b> . <br> <code>74340 bsdlabel CALL open(0x28201030,O_RDWR,[unused]0xbfbfe9e8) <br> 74340 bsdlabel NAMI "/dev/ad8s1" <br> 74340 bsdlabel RET open -1 errno 1 Operation not permitted <br> 74340 bsdlabel CALL open(0x28097653,O_RDONLY,[unused]0x28050629) <br> 74340 bsdlabel NAMI "/dev/geom.ctl" <br> 74340 bsdlabel RET open 3 <br> 74340 bsdlabel CALL ioctl(0x3,GEOM_CTL,0x28203040) <br> 74340 bsdlabel RET ioctl 0</code> <br>  ‚ÄúOperation not permitted‚Äù, apparently not destiny to edit the system disk on the fly using bsdlabel. <br>  But do not worry - there is gpart: <br> <code>gpart modify -i 1 -t freebsd-ufs /dev/ad8s1</code> <br>  Index 1, for the rule of the section 'a', such logic.  / dev / ad8s1, not / dev / ad8, because we are editing not the slice table (MBR in my case), but the slice itself. <br>  Check bsdlabel'om - success.  Cross your fingers, check how the hornbeam will react to this.  He was positive, but not to the end.  Error 22 replaced the new - <i>Error 17: Cannot mount selected partition</i> . <br><br><h5>  Error 17 </h5><br><br>  From the title, everything is clear - an error with mounting ufs.  However, do not be lazy and put the signal printf in <b>ufs2_mount ()</b> . <br>  And there is.  Function faylitsya.  The reason is also clear - can not find the superblock.  This is a structure that contains basic information about the file system (node ‚Äã‚Äãsize, cluster size, checkboxes, and so on). <br>  A fairly common structure in the architecture of the FS, there is it in ufs2, but grub does not find it.  Let's see where it sits - <b>dumpfs / |</b>  <b>head -2</b> gives this line <i>"superblock location 65536"</i> . <br>  We look in grub: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SBLOCK_FLOPPY 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SBLOCK_UFS1 8192 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SBLOCK_UFS2 65536 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SBLOCK_PIGGY 262144 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SBLOCKSIZE 8192 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SBLOCKSEARCH \ { SBLOCK_UFS2, SBLOCK_UFS1, SBLOCK_FLOPPY, SBLOCK_PIGGY, -1 }</span></span></code> </pre> <br>  We see the treasured number, why not find? <br>  65536 is the offset in bytes, as to what it is considered to be, I was definitely not sure, so I took it with a margin: <br> <code>dd if=/dev/ad8 bs=512 count=200 | hexdump -C | grep 54</code> <br>  We read the first 200 sectors (the section itself began with sector 16, 128 (superblock offset) + 16 (maximum reference point) + 16 (size of superblock) &lt;200, backlash for reliability). <br>  grep 54 - this is what we get the lines that contain byte 0x54, which is in the signature of the superblock, the full size of the signature is 4 bytes. <br> <code>#define FS_UFS2_MAGIC 0x19540119 /* UFS2 fast filesystem magic number */</code> <br>  But how to look for dword'am did not immediately occur, so I looked at a couple of dozen lines.  Fully the signature was found in the 69 sector, it is important 2 times that I was embarrassed.  I took a closer look at dump, there is further mention of <b>FS_UFS1_MAGIC</b> , so this is most likely the loader code, and not the superblock itself. <br><br>  Then I thought that it would be better to search inside the section: <br> <code>dd if=/dev/ad8s1a bs=512 count=200 | hexdump -C | grep 54</code> <br>  And here I was waiting for success - at offset 0x10550 (66896) we see our signature. <br>  The offset is not exactly equal to 65536, because the signature lies at the end of the superblock and not at its beginning, so a ‚Äúdelta‚Äù ( <b>FIELD_OFFSET ()</b> ) is added, which is less than 8192. <br>  As you can see, the superblock is present, and precisely by the offset from the beginning of the section, where it is expected.  Determine the offset with respect, Stupidly go over the first n sectors with a known search string. <br>  We get - 0001a350 (107344), which is equal to 209 sector. It is amusing that our estimated score did not reach quite a bit.  This was due to the fact that I forgot to add the beginning of the slice itself (63), 63 + 16 + 128 == 207, <br>  And 2 sectors occupy the remaining fields of the superblock. <br>  The target sector is calculated in <b>devread (sector, byte_offset)</b> simply: <br> <code>sector + (byte_offset &gt;&gt; SECTOR_BITS) + part_start</code> <br>  The variables <b>sector</b> and <b>byte_offset</b> are arguments and in our case are 0 and 65536 respectively, which of course is correct.  But <b>part_start</b> gives 16. That is also true.  But the hornbeam perceives it as an absolute value, relative to the beginning of the disk, and not the beginning of the slice. <br>  The mane reads " <i>The</i> <i>first partition should start at offset 16</i> ". <br>  But since the system works, and everything is mounted successfully, I think that the bug in the hornbeam.  Therefore, fix it by adding just one character: <br> <code>*start += BSD_PART_START (buf, i);</code> <br>  And now everything goes well - <b>part_start = 0x4F</b> , and the dump is executed. <br>  We will use reassembled hornbeam, so that my fix will enter <b>stage1_5 / stage2</b> . <br>  <b>grub_install</b> went right, everything is fine. <br><br><h5>  The limit on the size of the read file </h5><br><br>  A little off topic, but for ufs, grub'a and fryahi. <br>  The maximum file size grub can read is: <br> <code>(12 + superblock.nindir) * superblock.bsize <br></code> <br>  Superblock parameters are taken from the dumpfs log. <br>  I got about 32 meters on the system, which doesn‚Äôt make me very happy, so I cut out the check from the code. <br>  To do this, comment on this line in <b>fsys_ufs2.c</b> : <br> <code>fsmax = (NDADDR + NINDIR (SUPERBLOCK)) * SUPERBLOCK-&gt;fs_bsize; <br></code> <br><br><h5>  Finita </h5><br><br>  Here is such a small story about how I ran the grub on the fryahe. <br>  What is useful here: <br><ul><li>  Using the ktrace / kdump bundle </li><li>  Mention dumpfs / hexcode / gpart with usecases </li><li>  A little bit about the format of slices and fs. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/118894/">https://habr.com/ru/post/118894/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../118886/index.html">LastPass: ‚ÄúXmarks was not hurt‚Äù</a></li>
<li><a href="../118887/index.html">Apple nuance</a></li>
<li><a href="../118889/index.html">Google added Flash support in Instant Preview</a></li>
<li><a href="../118892/index.html">News 2.0.1-beta</a></li>
<li><a href="../118893/index.html">Clouds for a regular user</a></li>
<li><a href="../118897/index.html">Writing a simple web browser plugin using FireBreath</a></li>
<li><a href="../118898/index.html">Error handling in Go: Defer, Panic and Recover</a></li>
<li><a href="../118901/index.html">The need for a long rest: another trap when planning time</a></li>
<li><a href="../118902/index.html">Standard_Test_Treating_Long_Title</a></li>
<li><a href="../118903/index.html">How to study correctly?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>