<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Python library for Photon Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Over the past few months, I have had to become closely acquainted with the framework for developing client-server games Photon . In this article, I wi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Python library for Photon Server</h1><div class="post__text post__text-html js-mediator-article">  Over the past few months, I have had to become closely acquainted with the framework for developing client-server games <a href="https://www.exitgames.com/">Photon</a> .  In this article, I will not dwell on the pros and cons of Photon, as for this, perhaps, you need experience with more than one framework.  It will be a question of library for work with Photon Server in the Python language. <br><a name="habracut"></a><br>  First, a few words about why it was needed at all and why I did not use one of the already existing client libraries. <br><br>  In the process of working on the server part of the game project, we often had service tasks, such as getting current data directly from the application, graceful stopping the game service (you can‚Äôt just cut down the game server while people are on it).  At the very beginning, a small GUI application was written to work with all the service parts of the application, through which these problems were solved.  But over time, we increasingly wanted to work with these office things through the console, and even Unix.  At the same time, I did not want to recompile everything with the slightest code changes.  For this reason, C #, Java, and C ++ have been flagged.  There was still a variant with JavaScript and node.js, but Python attracted me for a long time and I really wanted to get to know it.  And then such a good case.  Therefore, it was decided to write the library in this language. <br><br>  Since the Photon protocol is not publicly available (or, in any case, I could not find it), I had to decompile the source code of the client library written in Java, study them and rewrite the whole thing in Python.  Java was chosen because this language is closer to me, since the last few years I have been developing in this language.  As it turned out later, after a conversation with the Photon developers, it was better to take the C # library, since it is more recent. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Initially, I wanted to write everything in Python version 2.7 (at the time of writing the current version of the library was 2.7.9), but faced with the difficulty in implementing some things that were already implemented out of the box in 3.4, I decided to keep up with the times . <br><br>  The source of the library can be found on <a href="https://github.com/logarithm/photon-python">github</a> . <br><br>  Let us analyze a small piece of code that uses this library.  The interfaces almost completely coincide with libraries in other languages, so for those who are familiar with Photon, there will be nothing new here. <br><br>  First, let's implement the PeerListener interface: <br><br><pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Connection</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, connected=False)</span></span></span><span class="hljs-function">:</span></span> self.connected = connected <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleListener</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(PeerListener)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, connection)</span></span></span><span class="hljs-function">:</span></span> super().__init__() self.connection = connection <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">debug_return</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, debug_level, message)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">"[{}] - {}"</span></span>.format(debug_level.name, message)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_status_changed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, status_code)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">"[Status changed] - {}"</span></span>.format(status_code.name)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status_code <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> StatusCode.Connect: self.connection.connected = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_operation_response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, op_response)</span></span></span><span class="hljs-function">:</span></span> print(op_response) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_event</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, event_data)</span></span></span><span class="hljs-function">:</span></span> print(op_response)</code> </pre> <br>  We will not process the OperationResponse and the Event yet.  Let's just output them to the console.  It also uses a small Connection class, just like holder for the connection status.  It is useful to us later. <br><br>  Now we‚Äôll write a service thread that will pull the service method from our peer about 10 times per second (developers recommendation): <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceThread</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(threading.Thread)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, pp)</span></span></span><span class="hljs-function">:</span></span> threading.Thread.__init__(self) self.pp = pp self._run = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self._run = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> self._run: self.pp.service() time.sleep(<span class="hljs-number"><span class="hljs-number">100.0</span></span> / <span class="hljs-number"><span class="hljs-number">1000.0</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self._run = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre><br>  And of course the main function: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> connection = Connection() pp = PhotonPeer(enums.ConnectionProtocol.Tcp, SimpleListener(connection)) pp.set_debug_level(DebugLevel.All) pp.connect(your_ip, your_port, your_app_name) service_thread = ServiceThread(pp) service_thread.start() <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> connection.connected <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-comment"><span class="hljs-comment"># Put your code here service_thread.stop() service_thread.join() pp.disconnect()</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">Entirely source here</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> threading <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> photon <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> enums <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> photon.enums <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> DebugLevel, StatusCode <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> photon.listener <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PeerListener <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> photon.peer <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PhotonPeer <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Connection</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, connected=False)</span></span></span><span class="hljs-function">:</span></span> self.connected = connected <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> connection = Connection() pp = PhotonPeer(enums.ConnectionProtocol.Tcp, SimpleListener(connection)) pp.set_debug_level(DebugLevel.All) pp.connect(your_ip, your_port, your_app_name) service_thread = ServiceThread(pp) service_thread.start() <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> connection.connected <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-comment"><span class="hljs-comment"># Put your code here service_thread.stop() service_thread.join() pp.disconnect() class ServiceThread(threading.Thread): def __init__(self, pp): threading.Thread.__init__(self) self.pp = pp self._run = False def run(self): self._run = True while self._run: self.pp.service() time.sleep(100.0 / 1000.0) def stop(self): self._run = False class SimpleListener(PeerListener): def __init__(self, connection): super().__init__() self.connection = connection def debug_return(self, debug_level, message): print("[{}] - {}".format(debug_level.name, message)) def on_status_changed(self, status_code): print("[Status changed] - {}".format(status_code.name)) if status_code is StatusCode.Connect: self.connection.connected = True def on_operation_response(self, op_response): print(op_response) def on_event(self, event_data): print(op_response) if __name__ == "__main__": main()</span></span></code> </pre><br></div></div><br>  Separately, I would like to dwell on the serialization of integer types.  For those who managed to look into the sources, such code may seem a bit strange: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_serialize_byte</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(out, value, set_type)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> set_type: out.extend(bytearray([<span class="hljs-number"><span class="hljs-number">98</span></span>])) value = ((value + ((<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">7</span></span>) - <span class="hljs-number"><span class="hljs-number">1</span></span>)) % (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>)) - ((<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">7</span></span>) - <span class="hljs-number"><span class="hljs-number">1</span></span>) out.extend(struct.pack(<span class="hljs-string"><span class="hljs-string">'&gt;b'</span></span>, value))</code> </pre><br>  This is an example of byte serialization; for other types, everything is the same.  The answer is simple - similar code is here for compatibility with the result of serialization in Java. <br><br>  And finally, about the current limitations: <br><ul><li>  Supports only TCP protocol </li><li>  Does not support encrypted connection </li><li>  Does not support traffic statistics collection. </li></ul><br>  It would be great to add the UDP protocol and handle the last 2 points, but there is no time for it yet.  But the source is open, as they say - all the cards in hand.  Hopefully, we are not the only ones who need it and our work will be useful to someone. <br><br>  <b>PS</b> If someone finds errors / inaccuracies in the code and / or not optimally written sections (which I do not rule out due to not very long acquaintance with Python) - I will be immensely grateful for pointing them out. </div><p>Source: <a href="https://habr.com/ru/post/254455/">https://habr.com/ru/post/254455/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../254445/index.html">Simulation of functional and physical events in a logical paradigm</a></li>
<li><a href="../254447/index.html">Presentation of speakers of the Desktop UI & Business Application conference. Pro backend</a></li>
<li><a href="../254449/index.html">Let's Lab. IS-IS routing protocol. Part 3</a></li>
<li><a href="../254451/index.html">Clickberry - perhaps the most powerful video platform on MS Azure is now open source</a></li>
<li><a href="../254453/index.html">Perl time</a></li>
<li><a href="../254459/index.html">Batyana-kombat for the developer: specially trained dudes, who are like consilers in the mafia</a></li>
<li><a href="../254461/index.html">IP Geo. SQL query optimization</a></li>
<li><a href="../254463/index.html">Layout organization in rails application using rails_ui_kit gem</a></li>
<li><a href="../254465/index.html">Weather Station on Arduino</a></li>
<li><a href="../254467/index.html">RapidMiner - Data Mining and BigData in your home, quickly and without preparation (almost)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>