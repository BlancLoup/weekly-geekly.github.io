<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Encryption in EXT4. How it works?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Paranoia is not treated! But not prosecuted. Therefore, Linux Kernel 4.1 adds support for encrypting the ext4 file system at the level of individual f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Encryption in EXT4. How it works?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://upload.wikimedia.org/wikipedia/commons/f/f0/Tux_ecb.jpg" alt="image" align="left">  Paranoia is not treated!  But not prosecuted.  Therefore, Linux Kernel 4.1 adds support for encrypting the ext4 file system at the level of individual files and directories.  You can only encrypt an empty directory.  All files that will be created in such a directory will also be encrypted.  Only file names and contents are encrypted, metadata is not encrypted, inline data (when file data not exceeding 60 bytes in size is stored in the inode) is not supported in files.  Since the file content is decrypted directly in memory, encryption is available only when the cluster size is the same as PAGE_SIZE, i.e.  equals 4K. <br><a name="habracut"></a><br><h3>  1. How it works </h3><br>  First you need to learn some useful commands. <br><br>  <b>Formatting the volume with the encryption option</b> <br><br><pre><code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># mkfs.ext4 -O encrypt /dev/xxx</span></span></code> </pre> <br>  <b>Enable encryption option on existing volume</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># tune2fs -O encrypt /dev/xxx</span></span></code> </pre> <br>  <b>Creating an encryption key</b> <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># mount /dev/xxx /mnt/xxx $ e4crypt add_key Enter passphrase (echo disabled): Added key with descriptor [8e679e4449bb9235]</span></span></code> </pre> <br>  When creating a key, a volume with encryption support must be mounted, otherwise e4crypt will generate an error ‚ÄúNo salt values ‚Äã‚Äãavailable‚Äù.  If multiple volumes are mounted with the encrypt option, keys for each will be created.  The e4crypt utility is included with e2fsprogs. <br><br>  Keys are added to the Linux Kernel Keyring [1]. <br><br>  <b>Reading the list of keys</b> <br><br><pre> <code class="hljs pgsql">$ keyctl <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Session</span></span> Keyring <span class="hljs-number"><span class="hljs-number">771961813</span></span> <span class="hljs-comment"><span class="hljs-comment">--alswrv 1000 65534 keyring: _uid_ses.1000 771026675 --alswrv 1000 65534 \_ keyring: _uid.1000 803843970 --alsw-v 1000 1000 \_ logon: ext4:8e679e4449bb9235</span></span></code> </pre> <br>  The keys used for encryption are of type ‚Äúlogon‚Äù.  The content (payload) of keys of this type is not available from user space - the keyctl of the read, pipe, print command will return an error.  In this example, the key has the prefix ‚Äúext4‚Äù, but it can also be ‚Äúfscrypt‚Äù.  If the keyctl is not in the system, then you must install the keyutils package. <br><br>  <b>Creating an encrypted directory</b> <br><br><pre> <code class="hljs sql">$ mkdir /mnt/xxx/encrypted_folder $ e4crypt set_policy 8e679e4449bb9235 /mnt/xxx/encrypted_folder/ Key <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">descriptor</span></span> [<span class="hljs-number"><span class="hljs-number">8e679</span></span>e4449bb9235] applied <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> /mnt/xxx/encrypted_folder/.</code> </pre> <br>  Here, the set key handle is passed to the set_policy command without specifying the prefix (ext4) and type (logon).  The same key can encrypt several directories.  To encrypt different directories, you can use different keys.  To find out which key the directory is encrypted with, you need to run the command: <br><br><pre> <code class="hljs ruby">$ e4crypt get_policy /mnt/xxx/encrypted_folder/ <span class="hljs-regexp"><span class="hljs-regexp">/mnt/xxx</span></span><span class="hljs-regexp"><span class="hljs-regexp">/encrypted_folder/</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span>e679e4449bb9235</code> </pre> <br>  Install another security policy on the encrypted directory does not work: <br><br><pre> <code class="hljs sql">$ e4crypt add_key Enter passphrase (echo disabled): Added key <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">descriptor</span></span> [<span class="hljs-number"><span class="hljs-number">9</span></span>dafe822ae6e7994] $ e4crypt set_policy <span class="hljs-number"><span class="hljs-number">9</span></span>dafe822ae6e7994 /mnt/xxx/encrypted_folder/ <span class="hljs-keyword"><span class="hljs-keyword">Error</span></span> [Invalid argument] setting policy. The <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> <span class="hljs-keyword"><span class="hljs-keyword">descriptor</span></span> [<span class="hljs-number"><span class="hljs-number">9</span></span>dafe822ae6e7994] may <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> the existing encryption <span class="hljs-keyword"><span class="hljs-keyword">context</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">directory</span></span> [/mnt/xxx/encrypted_folder/].</code> </pre> <br>  But such a directory can be easily removed: <br><br><pre> <code class="hljs pgsql">$ rm -rf /mnt/xxx/encrypted_folder/ $ ll /mnt/xxx total <span class="hljs-number"><span class="hljs-number">24</span></span> drwxr-xr-x <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> Apr <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span> ./ drwxr-xr-x <span class="hljs-number"><span class="hljs-number">4</span></span> root root <span class="hljs-number"><span class="hljs-number">4096</span></span> Mar <span class="hljs-number"><span class="hljs-number">29</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span> ../ drwx<span class="hljs-comment"><span class="hljs-comment">------ 2 root root 16384 Apr 17 12:41 lost+found/ $</span></span></code> </pre> <br>  <b>File encryption</b> <br><br><pre> <code class="hljs pgsql">$ echo "My secret file content" &gt; /mnt/xxx/encrypted_folder/my_secrets.txt $ cat /mnt/xxx/encrypted_folder/my_secrets.txt My secret file content $ ll /mnt/xxx/encrypted_folder/ total <span class="hljs-number"><span class="hljs-number">12</span></span> drwxr-xr-x <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> Apr <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">25</span></span> ./ drwxr-xr-x <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> Apr <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span> ../ -rw-r<span class="hljs-comment"><span class="hljs-comment">--r-- 1 user user 23 Apr 20 14:26 my_secrets.txt</span></span></code> </pre> <br>  The file names in the directory and the contents of the file will be available as long as a key exists in the keystore with which the directory has been encrypted.  After canceling the key, access to the directory will be severely limited: <br><br><pre> <code class="hljs pgsql">$ keyctl <span class="hljs-keyword"><span class="hljs-keyword">revoke</span></span> <span class="hljs-number"><span class="hljs-number">803843970</span></span> $ keyctl <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Session</span></span> Keyring <span class="hljs-number"><span class="hljs-number">771961813</span></span> <span class="hljs-comment"><span class="hljs-comment">--alswrv 1000 65534 keyring: _uid_ses.1000 771026675 --alswrv 1000 65534 \_ keyring: _uid.1000 803843970: key inaccessible (Key has been revoked)</span></span></code> </pre> <br>  Key revoked, read the contents of the directory: <br><br><pre> <code class="hljs pgsql">$ ll /mnt/xxx/encrypted_folder/ total <span class="hljs-number"><span class="hljs-number">12</span></span> drwxr-xr-x <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> Apr <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">25</span></span> ./ drwxr-xr-x <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> Apr <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span> ../ -rw-r<span class="hljs-comment"><span class="hljs-comment">--r-- 1 user user 23 Apr 20 14:26 BhqTNRNHDBwpa9S1qCaXwC</span></span></code> </pre> <br>  The file name is already abyrvalg.  But still try to read the file: <br><br><pre> <code class="hljs ruby">$ cat /mnt/xxx/encrypted_folder/BhqTNRNHDBwpa9S1qCaXwC <span class="hljs-symbol"><span class="hljs-symbol">cat:</span></span> /mnt/xxx/encrypted_folder/<span class="hljs-symbol"><span class="hljs-symbol">BhqTNRNHDBwpa9S1qCaXwC:</span></span> Required key <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> available</code> </pre> <br>  <b>NOTE:</b> on Ubuntu 17.04 (kernel 4.10.0-19), the directory remains available after removing the key before remounting it. <br><br><pre> <code class="hljs ruby">$ keyctl show Session Keyring <span class="hljs-number"><span class="hljs-number">771961813</span></span> --alswrv <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">65534</span></span> <span class="hljs-symbol"><span class="hljs-symbol">keyring:</span></span> _uid_ses.<span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">771026675</span></span> --alswrv <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">65534</span></span> \<span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-symbol"><span class="hljs-symbol">keyring:</span></span> _uid.<span class="hljs-number"><span class="hljs-number">1000</span></span> $ e4crypt get_policy /mnt/xxx/encrypted_folder/ <span class="hljs-regexp"><span class="hljs-regexp">/mnt/xxx</span></span><span class="hljs-regexp"><span class="hljs-regexp">/encrypted_folder/</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span>e679e4449bb9235</code> </pre> <br>  The directory is encrypted with the key with the descriptor ‚Äú8e679e4449bb9235‚Äù.  The key is not in the repository.  Despite this, the directory and file contents are freely available. <br><br><pre> <code class="hljs pgsql">$ ll /mnt/xxx/encrypted_folder/ total <span class="hljs-number"><span class="hljs-number">12</span></span> drwxr-xr-x <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> Apr <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">25</span></span> ./ drwxr-xr-x <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> Apr <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span> ../ -rw-r<span class="hljs-comment"><span class="hljs-comment">--r-- 1 user user 23 Apr 20 14:26 my_secrets.txt $ cat /mnt/xxx/encrypted_folder/my_secrets.txt My secret file content</span></span></code> </pre> <br>  Remounting: <br><br><pre> <code class="hljs pgsql"># umount /dev/xxx # mount /dev/xxx /mnt/xxx $ ll /mnt/xxx/encrypted_folder/ total <span class="hljs-number"><span class="hljs-number">12</span></span> drwxr-xr-x <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> Apr <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">25</span></span> ./ drwxr-xr-x <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> Apr <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span> ../ -rw-r<span class="hljs-comment"><span class="hljs-comment">--r-- 1 user user 23 Apr 20 14:26 BhqTNRNHDBwpa9S1qCaXwC</span></span></code> </pre> <br><h3>  2. Changes in the file system </h3><br>  In the Superblock: the s_feature_incompat options set on the encryption-enabled volume contains the EXT4_FEATURE_INCOMPAT_ENCRYPT flag, <br>  s_encrypt_algos [4] - stores encryption algorithms;  at the moment it is: <br>  s_encrypt_algos [0] = EXT4_ENCRYPTION_MODE_AES_256_XTS; <br>  s_encrypt_algos [1] = EXT4_ENCRYPTION_MODE_AES_256_CTS; <br>  s_encrypt_pw_salt - also set during formatting. <br><br>  In the inode: i_flags contains the EXT4_ENCRYPT_FL flag and it is from it that one can determine that the object is encrypted. <br><br>  <b>Encrypted directory structure</b> <br><br>  To read the contents of a directory, you need to determine its location on the disk by its inode. <br><br>  <b>1. Determination of inode number:</b> <br><br><pre> <code class="hljs coffeescript">$ stat <span class="hljs-regexp"><span class="hljs-regexp">/mnt/xxx/encrypted_folder/</span></span> File: <span class="hljs-regexp"><span class="hljs-regexp">/mnt/xxx/encrypted_folder/</span></span> Size: <span class="hljs-number"><span class="hljs-number">4096</span></span> Blocks: <span class="hljs-number"><span class="hljs-number">8</span></span> IO Block: <span class="hljs-number"><span class="hljs-number">4096</span></span> directory Device: <span class="hljs-number"><span class="hljs-number">811</span></span>h/<span class="hljs-number"><span class="hljs-number">2065</span></span>d Inode: <span class="hljs-number"><span class="hljs-number">14</span></span> Links: <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  <b>2. Search for inode in the inode table.</b> <br><br>  Aynod 14 belongs to the 0th group, therefore it is necessary to read the table of descriptors of the 0th group and find in it the block number of the inode table.  The 0th group descriptor table is located in the cluster following the superblock: <br><br><pre> <code class="hljs swift"># dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/xxx of=gdt bs=<span class="hljs-number"><span class="hljs-number">4096</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span> skip=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><img src="http://sergeshibaev.ru/images/stories/encryption/gdt.png" alt="image"><br>  <i>Fig.</i>  <i>1. Table of descriptors of the 0th group</i> <br><br>  First, we skip the cluster number of the bitmap block and the inode bitmap, the cluster number of the beginning of the inode table is read by offset 8 bytes from the beginning of the table - 0x00000424 (1060) in BigEndian format.  Anode directory = 14, with an inode size of 256 bytes in the table, it will be at offset 0x0D00 from its beginning.  Thus, it suffices to read only the 1st cluster of the inode table: <br><br><pre> <code class="hljs swift"># dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/xxx of=itable bs=<span class="hljs-number"><span class="hljs-number">4096</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span> skip=<span class="hljs-number"><span class="hljs-number">1060</span></span></code> </pre> <br><img src="https://lh3.googleusercontent.com/HguJyd6cP5KsBDqxsfxy8n4mcT7FD7xdno1ZqPu9Y_ltyHFi1YvcY_MyyVexu-Ost9xsThTBrmdVkbL85QTw0sEiv_cF9xhggnsVc-Wx_sJ3lqAFxRbDvkR0D83pRnqsHdcW4XtV" alt="image"><br>  <i>Fig.</i>  <i>2. Inode encrypted directory.</i> <br><br>  In inode, we define the start of the i_block [] field.  Since  is ext4, then in the first 2 bytes of i_block there is an extents tree header - 0xF30A.  Then you can see the block number in which the encrypted directory is stored - 0x00000402 (1026).  (The figure does not highlight the entire i_block field, but only informative 24 bytes - the remaining 36 bytes are filled with zeros.) <br><br>  <b>3. Reading the directory block:</b> <br><br><pre> <code class="hljs swift"># dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/xxx of=dirdata bs=<span class="hljs-number"><span class="hljs-number">4096</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span> skip=<span class="hljs-number"><span class="hljs-number">1026</span></span></code> </pre> <br><img src="https://lh3.googleusercontent.com/TqVlhTGIQgQ-eIOXbX8Q9K74-c2tj_o0dYytBT032OcZEyco23PMq7ZuMyjq4cE0yoIx_JTal2e5K2JiQN_PmsKG1ftT-VmdUsK-UzIvY2UYylvO8Tdu8Rq9g17dV_R_2jGyGwQT" alt="image"><br>  <i>Fig.</i>  <i>3. Dump the encrypted directory.</i> <br><br>  Details: the first two entries (highlighted in red) are the entries ‚Äú.‚Äù And ‚Äú..‚Äù, respectively, the current and parent directories.  The current directory has an inode 0x0000000E, the record length is 0x000C bytes, the number of characters in the file name is 01, and the entry type 02 is the directory.  The following is the directory name, aligned on a 4-byte boundary - 2E000000 (2E corresponds to the symbol '.' - dot). <br><br>  The next parent directory has an inode 0x00000002 (root directory), a similar record length 0x000C, 02 characters in the name, type also 02, followed by the directory name 2E2E0000 (two dots). <br><br>  Finally, the last entry in this directory has an inode 0x0000000F, the entry size is 0x0FDC, the number of characters in the name is 0x10, type 01 - this is the encrypted file.  As you can see, his name does not match the created my_secrets.txt.  In addition, the original file name is only 14 characters, and not 16 as here. <br><br>  <b>NOTE:</b> especially attentive readers with a calculator may have noticed that  If the encrypted file is the last entry in the directory, then its record size should refer to the block boundary.  However, 0x1000 - 0xC - 0xC = 0xFE8, not 0xFDC.  This is due to the fact that the volume was created with the option "metadata_csum", which is set by default, starting with Ubuntu 16.10.  When this option is enabled, a 12-byte structure is created at the end of each directory block containing the checksum of this block. <br><br>  <b>4. Reading an encrypted file.</b> <br><br>  From the directory dump, we determine that the file has an inin 15 (0xF).  We look for it in the inode table and determine its position on the disk in the same way: <br><br><img src="https://lh5.googleusercontent.com/cIse4-DNjHQfEPUbTfrjbqKnryJQx2ROjamFlCmjHWzfwlpnRGGIoq7G6bjxl2pcT9nVyaniEC3R690WiT5S4fn5XnLmtQ1d9mZLMQLSJzkx72pngrkD1QzuvFAf9FcK1QWULmGT" alt="image"><br>  <i>Fig.</i>  <i>4. Inode encrypted file.</i> <br><br>  Read the contents of the cluster 0x0000AA00 (43520) <br><br><pre> <code class="hljs swift"># dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/xxx of=filedata bs=<span class="hljs-number"><span class="hljs-number">4096</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span> skip=<span class="hljs-number"><span class="hljs-number">43520</span></span></code> </pre> <br><img src="https://lh4.googleusercontent.com/EHd8ww2tYCWetvaGb63IsJoZDGEcuedWXWE32f4tV7SSIoLnx982N8MOrbaBcVrMlwbCtaZry98OsT-wtoqHfclGnEIohkl-Wq4yPTlCGX5BjLnC_WIEF3dQo35-se_r-haJ7KC0" alt="image"><br>  <i>Fig.</i>  <i>5. The contents of the encrypted file</i> <br><br>  And this does not correspond to the information recorded in the file.  The actual file size can be read in the i_size inode field (marked with a blue rectangle in Figure 4): 0x00000017 - this is exactly how much was written by the echo command ‚ÄúMy secret file content‚Äù + the newline character 0x0A. <br><br><h3>  3. Decryption </h3><br>  <b>File name decryption</b> <br><br>  According to EXT4 Encryption Design Document [2], the decryption of file names is performed in two steps: <br><br>  1. DerivedKey = AES-128-ECB (data = MasterKey, key = DirNonce); <br>  2. EncFileName = AES-256-CBC-CTS (data = DecFileName, key = DerivedKey); <br><br>  Those.  At the first stage, you need to get the key for decryption  To do this, use the data of the Master key created by adding the key to the keyring, which are encrypted using the AES-ECB 128-bit DirNonce key.  The second stage uses a fixed initialization vector (IV), filled with zeros.  For AES-ECB, an initialization vector is not needed. <br><br>  What is DirNonce?  In the inode of the encrypted directory there is a extended attribute. <br><br><img src="http://sergeshibaev.ru/images/encryption/dir_inode.png" alt="image"><br>  <i>Fig.</i>  <i>6. Anino encrypted directory and its extended attribute</i> <br><br>  With an inode size of 256 bytes, about a hundred unused bytes (0x100 - EXT2_GOOD_OLD_INODE_SIZE - i_extra_size) remain in the structure, in which information can be stored (red area in Fig. 6).  As can be seen from the header 0xEA020000 in the first four bytes of this area, the extended attribute with index 09 is stored here, the data of which is offset by 0x40 bytes from the header and have a size of 0x1C.  The data area is divided into 3 zones: the first (01 01 04 00) contains algorithms for which the inode was encrypted.  In the second, 8 bytes (8E 67 9E 44 49 BB 92 35) are stored, repeating the key descriptor.  The third one contains a 16-byte one-time code (nonce [3]) used for encrypting the Master Key. <br><br>  Thus, to decrypt the file name, you must: <br><br>  1) read the value of the nameless extended attribute directory with the index 9 ‚Äî we get the non-directory; <br>  2) using the AES-ECB algorithm, encrypt Master Key data using 128 bits of non-directories as the key; <br>  3) using the AES-CBC-CTS algorithm, decrypt the file name using the first 256 bits (half) of the key obtained in the previous step as the key. <br><br>  <b>Decrypt file content</b> <br><br>  It is performed in the same way as the file name decryption procedure, except that the extended attribute value obtained from the inode of the file is used as the nonce.  And instead of CBC, the content is decrypted using the AES-XTS algorithm with a full 64-byte key.  Logical Block Offset is used as IV for the beginning of the file <br><br><img src="https://lh5.googleusercontent.com/BqgJ2Y6k1uOGL8jRlWjJs83G0Leww0c8sZWkulegzu1uwyUFBnDX8C6Yc64Gs7-KP8ArC4QZ5TheQ_hecIKn1lFRR0uLV5ro_5In7vZ4iX71xrPkw_JJkmbW2M9z0Obo79HSvKr1" alt="image"><br>  <i>Fig.</i>  <i>7. Inode encrypted file and its extended attribute.</i> <br><br>  Comparing the value of the extended attribute of the encrypted file and the directory, you can see that their notes are different, while the encryption algorithms and key descriptors are the same (the yellow and blue zones in the figures). <br><br>  The contents of the files are encrypted page by page, so for decrypting the content you must use the whole file cluster (4K), and not the size specified in the i_size inode field. <br><br>  <b>4. Implementation</b> <br><br>  The implementation of the decoder is based on the Linux Kernel Crypto API [4].  Two types of encoders are used in the chain, depending on what is written in / proc / crypto for the ebc (aes), cts (cbc (aes)), xts (aes) algorithms.  Consider the kernel 4.10.0-19: the ebc cipher is implemented via blkcipher, cts (cbc) and xts - via skcipher: <br><br><div class="spoiler">  <b class="spoiler_title">$ cat / proc / crypto</b> <div class="spoiler_text">  $ cat / proc / crypto <br>  name: ecb (aes) <br>  driver: ecb (aes-aesni) <br>  module: kernel <br>  priority: 300 <br>  internal: no <br>  type: blkcipher <br>  blocksize: 16 <br>  min keysize: 16 <br>  max keysize: 32 <br>  ivsize: 0 <br>  geniv: default <br><br>  name: cts (cbc (aes)) <br>  driver: cts (cbc-aes-aesni) <br>  module: kernel <br>  priority: 400 <br>  internal: no <br>  type: skcipher <br>  async: yes <br>  blocksize: 16 <br>  min keysize: 16 <br>  max keysize: 32 <br>  ivsize: 16 <br>  chunksize: 16 <br><br>  name: xts (aes) <br>  driver: xts-aes-aesni <br>  module: aesni_intel <br>  priority: 401 <br>  internal: no <br>  type: skcipher <br>  async: yes <br>  blocksize: 16 <br>  min keysize: 32 <br>  max keysize: 64 <br>  ivsize: 16 <br>  chunksize: 16 <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Implementation of the encoder via blkcipher</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> { ENCRYPT, DECRYPT } cipher_mode; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do_blkcrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> u8* cipher, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> u8* key, u32 key_len, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* iv, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* dst, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* src, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> src_len, cipher_mode mode)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> res; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">crypto_blkcipher</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">blk</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">blkcipher_desc</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">desc</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scatterlist</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sg_src</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sg_dst</span></span></span><span class="hljs-class">;</span></span> blk = crypto_alloc_blkcipher(cipher, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IS_ERR(blk)) { printk(KERN_WARNING <span class="hljs-string"><span class="hljs-string">"Failed to initialize blkcipher mode %s\n"</span></span>, cipher); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PTR_ERR(blk); } res = crypto_blkcipher_setkey(blk, key, key_len); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (res) { printk(KERN_WARNING <span class="hljs-string"><span class="hljs-string">"Failed to set key. len=%#x\n"</span></span>, key_len); crypto_free_blkcipher(blk); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } crypto_blkcipher_set_iv(blk, iv, <span class="hljs-number"><span class="hljs-number">16</span></span>); sg_init_one(&amp;sg_src, src, src_len); sg_init_one(&amp;sg_dst, dst, src_len); desc.tfm = blk; desc.flags = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mode == ENCRYPT) res = crypto_blkcipher_encrypt(&amp;desc, &amp;sg_dst, &amp;sg_src, src_len); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> res = crypto_blkcipher_decrypt(&amp;desc, &amp;sg_dst, &amp;sg_src, src_len); crypto_free_blkcipher(blk); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">The implementation of the encoder through skcipher</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tcrypt_result</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">completion</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">completion</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> err; }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">crypt_complete_cb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct crypto_async_request* req, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> error)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tcrypt_result</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">res</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">req</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error == -EINPROGRESS) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; res-&gt;err = error; complete(&amp;res-&gt;completion); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do_skcrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> u8* cipher, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> u8* key, u32 key_len, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* iv, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* dst, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* src, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> src_len, cipher_mode mode)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scatterlist</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">src_sg</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dst_sg</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">crypto_skcipher</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tfm</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">skcipher_request</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">req</span></span></span><span class="hljs-class"> = 0;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tcrypt_result</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">crypt_res</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> res = -EFAULT; tfm = crypto_alloc_skcipher(cipher, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IS_ERR(tfm)) { printk(KERN_WARNING <span class="hljs-string"><span class="hljs-string">"Failed to initialize skcipher mode %s\n"</span></span>, cipher); res = PTR_ERR(tfm); tfm = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> out; } req = skcipher_request_alloc(tfm, GFP_NOFS); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!req) { printk(KERN_WARNING <span class="hljs-string"><span class="hljs-string">"Couldn't allocate skcipher handle\n"</span></span>); res = -ENOMEM; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> out; } skcipher_request_set_callback(req, CRYPTO_TFM_REQ_MAY_BACKLOG | CRYPTO_TFM_REQ_MAY_SLEEP, crypt_complete_cb, &amp;crypt_res); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (crypto_skcipher_setkey(tfm, key, key_len)) { printk(KERN_WARNING <span class="hljs-string"><span class="hljs-string">"Failed to set key\n"</span></span>); res = -EINVAL; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> out; } sg_init_one(&amp;src_sg, src, src_len); sg_init_one(&amp;dst_sg, dst, src_len); skcipher_request_set_crypt(req, &amp;src_sg, &amp;dst_sg, src_len, iv); init_completion(&amp;crypt_res.completion); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mode == ENCRYPT) res = crypto_skcipher_encrypt(req); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> res = crypto_skcipher_decrypt(req); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> -EINPROGRESS: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> -EBUSY: wait_for_completion(&amp;crypt_res.completion); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!res &amp;&amp; !crypt_res.err) { reinit_completion(&amp;crypt_res.completion); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: printk(<span class="hljs-string"><span class="hljs-string">"Skcipher %scrypt returned with err = %d, result %#x\n"</span></span>, mode == ENCRYPT ? <span class="hljs-string"><span class="hljs-string">"en"</span></span> : <span class="hljs-string"><span class="hljs-string">"de"</span></span>, res, crypt_res.err); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } out: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tfm) crypto_free_skcipher(tfm); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req) skcipher_request_free(req); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Read data (payload) Master Key</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MASTER_KEY_SIZE 64 static int GetMasterKey(const u8* descriptor, u8* raw) { struct key* keyring_key = NULL; const struct user_key_payload* ukp; struct fscrypt_key* master_key; keyring_key = request_key(&amp;key_type_logon, descriptor, NULL); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (IS_ERR(keyring_key)) return -EINVAL; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (keyring_key-&gt;type != &amp;key_type_logon) { printk_once(KERN_WARNING </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%s: key type must be 'logon'\n"</span></span></span><span class="hljs-meta">, __func__); return -EINVAL; } down_read(&amp;keyring_key-&gt;sem); ukp = user_key_payload(keyring_key); master_key = (struct fscrypt_key*)ukp-&gt;data; up_read(&amp;keyring_key-&gt;sem); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (master_key-&gt;size != MASTER_KEY_SIZE) { printk(KERN_WARNING </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Wrong Master key size %#x\n"</span></span></span><span class="hljs-meta">, master_key-&gt;size); return -EINVAL; } memcpy(raw, master_key-&gt;raw, master_key-&gt;size); return 0; }</span></span></code> </pre> <br><br></div></div><br>  <b>NOTE:</b> In kernel versions younger than 4.4, the user_key_payload function is missing.  Key data can be read directly from struct key * keyring_key. <br><br>  <b>File name decryption</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> err; u8 iv[<span class="hljs-number"><span class="hljs-number">16</span></span>] = { <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> }; u8 nonce_dir[<span class="hljs-number"><span class="hljs-number">16</span></span>] = { ... }; u8 master_key[<span class="hljs-number"><span class="hljs-number">64</span></span>], derived_key[<span class="hljs-number"><span class="hljs-number">64</span></span>]; u8 dec_file_name[] = { ... }; u8 enc_file_name[<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(dec_file_name)]; err = do_blkcrypt(<span class="hljs-string"><span class="hljs-string">"ecb(aes)"</span></span>, nonce_dir, <span class="hljs-number"><span class="hljs-number">16</span></span>, iv, derived_key, master_key, MASTER_KEY_SIZE, ENCRYPT); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err; err = do_skcrypt(<span class="hljs-string"><span class="hljs-string">"cts(cbc(aes))"</span></span>, derived_key, MASTER_KEY_SIZE / <span class="hljs-number"><span class="hljs-number">2</span></span>, iv, dec_file_name, enc_file_name, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(dec_file_name), DECRYPT); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err;</code> </pre> <br>  <b>Content decryption</b> <br><br>  To simplify the omitted work with memory.  Suppose 2 x PAGE_SIZE was given to us on the stack. <br><br><pre> <code class="cpp hljs">u8 nonce_file[<span class="hljs-number"><span class="hljs-number">16</span></span>] = { ... }; u8 enc_file_data[PAGE_SIZE] = { ... }; u8 dec_file_data[PAGE_SIZE]; err = do_blkcrypt(<span class="hljs-string"><span class="hljs-string">"ecb(aes)"</span></span>, nonce_file, <span class="hljs-number"><span class="hljs-number">16</span></span>, iv, derived_key, master_key, MASTER_KEY_SIZE, ENCRYPT); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err; err = do_skcrypt(<span class="hljs-string"><span class="hljs-string">"xts(aes)"</span></span>, derived_key, MASTER_KEY_SIZE, iv, dec_file_data, enc_file_data, PAGE_SIZE, DECRYPT); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err;</code> </pre><br>  <b>Headers used (valid for 4.10.0-19)</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;linux/kernel.h&gt; #include &lt;linux/module.h&gt; #include &lt;linux/scatterlist.h&gt; #include &lt;linux/fscrypto.h&gt;</span></span></span></span></code> </pre><br>  <b>Makefile</b> <br><br><pre> <code class="hljs mel">obj-m += ciphertest.o all: make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules clean: make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean</code> </pre><br><h3>  5. Results </h3><br>  Initial data: <br><br><pre> <code class="cpp hljs">u8 master_key[MASTER_KEY_SIZE] = { <span class="hljs-number"><span class="hljs-number">0xa5</span></span>, <span class="hljs-number"><span class="hljs-number">0xb5</span></span>, <span class="hljs-number"><span class="hljs-number">0xc9</span></span>, <span class="hljs-number"><span class="hljs-number">0x23</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0x14</span></span>, <span class="hljs-number"><span class="hljs-number">0xfc</span></span>, <span class="hljs-number"><span class="hljs-number">0xf7</span></span>, <span class="hljs-number"><span class="hljs-number">0x28</span></span>, <span class="hljs-number"><span class="hljs-number">0xdc</span></span>, <span class="hljs-number"><span class="hljs-number">0x90</span></span>, <span class="hljs-number"><span class="hljs-number">0x25</span></span>, <span class="hljs-number"><span class="hljs-number">0x24</span></span>, <span class="hljs-number"><span class="hljs-number">0x9e</span></span>, <span class="hljs-number"><span class="hljs-number">0xe6</span></span>, <span class="hljs-number"><span class="hljs-number">0xbc</span></span>, <span class="hljs-number"><span class="hljs-number">0x7c</span></span>, <span class="hljs-number"><span class="hljs-number">0xa8</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0xe1</span></span>, <span class="hljs-number"><span class="hljs-number">0x94</span></span>, <span class="hljs-number"><span class="hljs-number">0xf6</span></span>, <span class="hljs-number"><span class="hljs-number">0x67</span></span>, <span class="hljs-number"><span class="hljs-number">0x32</span></span>, <span class="hljs-number"><span class="hljs-number">0x33</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4</span></span>, <span class="hljs-number"><span class="hljs-number">0xc1</span></span>, <span class="hljs-number"><span class="hljs-number">0xe8</span></span>, <span class="hljs-number"><span class="hljs-number">0x78</span></span>, <span class="hljs-number"><span class="hljs-number">0x59</span></span>, <span class="hljs-number"><span class="hljs-number">0xab</span></span>, <span class="hljs-number"><span class="hljs-number">0xfb</span></span>, <span class="hljs-number"><span class="hljs-number">0xae</span></span>, <span class="hljs-number"><span class="hljs-number">0xb0</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x5d</span></span>, <span class="hljs-number"><span class="hljs-number">0x2c</span></span>, <span class="hljs-number"><span class="hljs-number">0x69</span></span>, <span class="hljs-number"><span class="hljs-number">0xc3</span></span>, <span class="hljs-number"><span class="hljs-number">0x8f</span></span>, <span class="hljs-number"><span class="hljs-number">0x51</span></span>, <span class="hljs-number"><span class="hljs-number">0x37</span></span>, <span class="hljs-number"><span class="hljs-number">0x26</span></span>, <span class="hljs-number"><span class="hljs-number">0x3f</span></span>, <span class="hljs-number"><span class="hljs-number">0xd1</span></span>, <span class="hljs-number"><span class="hljs-number">0xce</span></span>, <span class="hljs-number"><span class="hljs-number">0x37</span></span>, <span class="hljs-number"><span class="hljs-number">0xef</span></span>, <span class="hljs-number"><span class="hljs-number">0x3f</span></span>, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">0xe3</span></span>, <span class="hljs-number"><span class="hljs-number">0x2d</span></span>, <span class="hljs-number"><span class="hljs-number">0xd5</span></span>, <span class="hljs-number"><span class="hljs-number">0xfd</span></span>, <span class="hljs-number"><span class="hljs-number">0x78</span></span>, <span class="hljs-number"><span class="hljs-number">0x45</span></span>, <span class="hljs-number"><span class="hljs-number">0x62</span></span>, <span class="hljs-number"><span class="hljs-number">0xf3</span></span>, <span class="hljs-number"><span class="hljs-number">0xa5</span></span>, <span class="hljs-number"><span class="hljs-number">0x24</span></span>, <span class="hljs-number"><span class="hljs-number">0x6b</span></span>, <span class="hljs-number"><span class="hljs-number">0xcf</span></span>, <span class="hljs-number"><span class="hljs-number">0x4a</span></span>, <span class="hljs-number"><span class="hljs-number">0x88</span></span> }; u8 enc_file_name[] = { <span class="hljs-number"><span class="hljs-number">0x41</span></span>, <span class="hljs-number"><span class="hljs-number">0xa8</span></span>, <span class="hljs-number"><span class="hljs-number">0x4e</span></span>, <span class="hljs-number"><span class="hljs-number">0x4d</span></span>, <span class="hljs-number"><span class="hljs-number">0xd4</span></span>, <span class="hljs-number"><span class="hljs-number">0x1c</span></span>, <span class="hljs-number"><span class="hljs-number">0x43</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xa7</span></span>, <span class="hljs-number"><span class="hljs-number">0x5a</span></span>, <span class="hljs-number"><span class="hljs-number">0x2f</span></span>, <span class="hljs-number"><span class="hljs-number">0xd5</span></span>, <span class="hljs-number"><span class="hljs-number">0xaa</span></span>, <span class="hljs-number"><span class="hljs-number">0xa0</span></span>, <span class="hljs-number"><span class="hljs-number">0x5d</span></span>, <span class="hljs-number"><span class="hljs-number">0xb0</span></span> }; u8 nonce_dir[] = { <span class="hljs-number"><span class="hljs-number">0x37</span></span>, <span class="hljs-number"><span class="hljs-number">0xba</span></span>, <span class="hljs-number"><span class="hljs-number">0x14</span></span>, <span class="hljs-number"><span class="hljs-number">0x16</span></span>, <span class="hljs-number"><span class="hljs-number">0x3e</span></span>, <span class="hljs-number"><span class="hljs-number">0xa8</span></span>, <span class="hljs-number"><span class="hljs-number">0xd5</span></span>, <span class="hljs-number"><span class="hljs-number">0x48</span></span>, <span class="hljs-number"><span class="hljs-number">0xd1</span></span>, <span class="hljs-number"><span class="hljs-number">0x3c</span></span>, <span class="hljs-number"><span class="hljs-number">0xb5</span></span>, <span class="hljs-number"><span class="hljs-number">0x6a</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0xb7</span></span>, <span class="hljs-number"><span class="hljs-number">0x7c</span></span>, <span class="hljs-number"><span class="hljs-number">0x41</span></span> }; u8 nonce_file[] = { <span class="hljs-number"><span class="hljs-number">0x61</span></span>, <span class="hljs-number"><span class="hljs-number">0x63</span></span>, <span class="hljs-number"><span class="hljs-number">0xb8</span></span>, <span class="hljs-number"><span class="hljs-number">0x31</span></span>, <span class="hljs-number"><span class="hljs-number">0xf4</span></span>, <span class="hljs-number"><span class="hljs-number">0xf5</span></span>, <span class="hljs-number"><span class="hljs-number">0xfc</span></span>, <span class="hljs-number"><span class="hljs-number">0x99</span></span>, <span class="hljs-number"><span class="hljs-number">0x1e</span></span>, <span class="hljs-number"><span class="hljs-number">0x3c</span></span>, <span class="hljs-number"><span class="hljs-number">0xf1</span></span>, <span class="hljs-number"><span class="hljs-number">0x8a</span></span>, <span class="hljs-number"><span class="hljs-number">0x23</span></span>, <span class="hljs-number"><span class="hljs-number">0xaf</span></span>, <span class="hljs-number"><span class="hljs-number">0x1e</span></span>, <span class="hljs-number"><span class="hljs-number">0xa8</span></span> };</code> </pre><br>  The encoded file name enc_file_name is obtained from the dump directory (Fig. 3). <br>  The nonce of the nonce_dir directory is obtained from the dump of the inode directory (Fig. 6) <br>  The nonce of the nonce_file file is obtained from the dump of the inode file (Fig. 7) <br><br>  The master key is shown here fully for clarity.  It can be obtained when debugging e4crypt: <br><br><img src="https://lh3.googleusercontent.com/Xx3w3fLflX-z5aU6FsngBDquRpaSMU6aZxVyw-GaBaB-6JzoHyzH57de18Q-aE6Rcm-_wrmrP7voI69rABIEmxc2DnFS0UZpI6tZZUTuHoOzaL8SevaHHqT6fGXFqcGkebmdra4u" alt="image"><br><br>  The result of the created driver <br><br><img src="https://lh5.googleusercontent.com/h8SqFmkiK3NTAl3hz1G160oFK-LXlyZ5yPGgWxpgT4ffXx2USwgRuBy6RwWZWNWivb5uILWPQkhBlmateLSgLKYMkjyZ9fvYKqaHVacifRuJ_G9uBHn1C9APi_66D5oawrmyTEW4" alt="image"><br><br><div class="spoiler">  <b class="spoiler_title">Links</b> <div class="spoiler_text">  [1] KERNEL KEY RETENTION SERVICE, <a href="https://www.kernel.org/doc/Documentation/security/keys.txt">www.kernel.org/doc/Documentation/security/keys.txt</a> <br>  [2] EXT4 Encryption Design Document, <a href="https://docs.google.com/document/d/1ft26lUQyuSpiu6VleP70_npaWdRfXFoNnB8JYnykNTg/edit">docs.google.com/document/d/1ft26lUQyuSpiu6VleP70_npaWdRfXFoNnB8JYnykNTg/edit</a> <br>  [3] Wikipedia - Nonce, <a href="https://ru.wikipedia.org/wiki/Nonce">ru.wikipedia.org/wiki/Nonce</a> <br>  [4] Linux Kernel Crypto API, <a href="https://www.kernel.org/doc/html/latest/crypto/index.html">www.kernel.org/doc/html/latest/crypto/index.html</a> </div></div></div><p>Source: <a href="https://habr.com/ru/post/327682/">https://habr.com/ru/post/327682/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327670/index.html">Monitoring Docker Swarm with cAdvisor, InfluxDB and Grafana</a></li>
<li><a href="../327674/index.html">Bucardo: Multimaster replication</a></li>
<li><a href="../327676/index.html">We raise our VPN server on Amazon EC2 under Windows Server 2008 r2</a></li>
<li><a href="../327678/index.html">Linus Torvalds introduced the Linux kernel 4.11</a></li>
<li><a href="../327680/index.html">Crowd Marketing: Top 10 Popular Questions</a></li>
<li><a href="../327684/index.html">How to raise your i2p-site (eepsite) on VDS (VPS) under Ubuntu (LAMP). Briefing for beginners</a></li>
<li><a href="../327686/index.html">Structure and execution model of .NET Core applications</a></li>
<li><a href="../327688/index.html">Structural Classification: Examples and Misconceptions</a></li>
<li><a href="../327690/index.html">Carousel on Vanilla.JS. Part 2</a></li>
<li><a href="../327692/index.html">Java, first cup</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>