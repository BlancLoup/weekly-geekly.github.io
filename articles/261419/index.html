<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CIFS in Android, or how I got files from a broken phone</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It so happened that I broke the screen with my beloved Nexus 4. The first thought was ‚ÄúDamn! Now I will be like one of these rogues, with a broken scr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CIFS in Android, or how I got files from a broken phone</h1><div class="post__text post__text-html js-mediator-article">  It so happened that I broke the screen with my beloved Nexus 4. The first thought was ‚ÄúDamn!  Now I will be like one of these rogues, with a broken screen! ‚Äù  But, apparently, the creators of Nexus 4 were ardent opponents of poverty, because together with the broken screen, the touch screen completely failed.  In general, do not worry, take the phone for repair and all.  However, there were files on the phone that I needed right now, and not in a couple of weeks.  But it seemed possible to get them only when the screen was unlocked, the phone required entering a ‚Äúsuper secret‚Äù gesture and categorically did not want to work as an external drive. <br><br><img src="https://habrastorage.org/files/428/113/716/4281137167294d3182bf9a130609ed0c.png"><br><br>  Having rummaged a little with adb I spat on attempts to unlock the screen via the console.  All the tips on hacking the lock screen required the presence of a root, and my phone is not one of these.  It was decided to act from within.  The choice fell on the JCIFS library, as I had previously worked with it and there were no problems with its use. <br><a name="habracut"></a><br>  It was necessary to write an application that would independently copy the files from the phone to a folder shared via Wi-Fi.  Mandatory conditions for such a trick: enabled debugging via USB and the computer to which the phone has already granted permission for debugging, as well as the availability of a Wi-Fi network to which the phone will connect as soon as it sees it (I have a home Wi-Fi). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Preparatory work </h3><br>  Let's create the project with one Activity.  Although she does not see the white light because of the lock screen, but to start the service, which will do the main work, it will be needed. <div class="spoiler">  <b class="spoiler_title">MainActivity.java</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); startService(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, SynchronizeService.class)); } }</code> </pre> <br></div></div><br>  Copying files will be handled by a separate service.  Since the Activity is not visible, it‚Äôs not worth counting on its viability, but the service running in Foreground will perfectly cope with this task. <br><div class="spoiler">  <b class="spoiler_title">SynchronizeService.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SynchronizeService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> FOREGROUND_NOTIFY_ID = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> NotificationCompat.Builder builder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotificationCompat.Builder(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) .setSmallIcon(R.mipmap.ic_launcher) .setContentTitle(getString(R.string.app_name)) .setContentText(getString(R.string.synchronize_service_message)) .setContentIntent(getDummyContentIntent()) .setColor(Color.BLUE) .setProgress(<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); startForeground(FOREGROUND_NOTIFY_ID, builder.build()); <span class="hljs-comment"><span class="hljs-comment">//    CPU    PowerManager powerManager = (PowerManager) getSystemService(POWER_SERVICE); final WakeLock wakeLock = powerManager.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK, "SynchronizeWakelockTag"); wakeLock.acquire(); } @Override public int onStartCommand(Intent intent, int flags, int startId) { return START_NOT_STICKY; } @Override public IBinder onBind(Intent intent) { return null; } }</span></span></code> </pre> </div></div><br>  Before moving on, we add a dependency, the build.gradle file, which will add the JCIFS library to the project. <br><pre> <code class="xml hljs">dependencies { ... compile 'jcifs:jcifs:1.3.17' }</code> </pre> <br>  You also need to add some permissions to the manifest and do not forget to write about our service there.  Ultimately, AndroidManifest.xml I looked like this. <br><div class="spoiler">  <b class="spoiler_title">AndroidManifest.xml</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">package</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ru.kamisempai.wifisynchronizer"</span></span></span><span class="hljs-tag">&gt;</span></span> //      . <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.WAKE_LOCK"</span></span></span><span class="hljs-tag">/&gt;</span></span> //     . <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.INTERNET"</span></span></span><span class="hljs-tag">/&gt;</span></span> //    SD . <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.READ_EXTERNAL_STORAGE"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">application</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:label</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/app_name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:icon</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@mipmap/ic_launcher"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">activity</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".activities.MainActivity"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.action.MAIN"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">category</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.category.LAUNCHER"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">activity</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".services.SynchronizeService"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">application</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><h3>  Copying files </h3><br>  So, all the preparations are complete.  Now, if you start the application, the service messages will appear in the notification list (starting with Android 5, you can configure the display of messages on the lock screen. If the Android version is smaller, you will not see this message), which means the application works as expected and you can proceed to the most delicious - transfer files. <br><br>  In order not to perform network operations in the main thread, let's take the whole thing in AsyncTask. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CopyFilesToSharedFolderTask</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncTask</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Void</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Double</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> File mFolderToCopy; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String mSharedFolderUrl; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> NtlmPasswordAuthentication mAuth; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> FileFilter mFileFilter; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CopyFilesToSharedFolderTask</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(File folderToCopy, String sharedFolderUrl, String user, String password, FileFilter fileFilter)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); mFolderToCopy = folderToCopy; <span class="hljs-comment"><span class="hljs-comment">// ,    . mSharedFolderUrl = sharedFolderUrl; // Url   ,       . mAuth = (user != null &amp;&amp; password != null) ? new NtlmPasswordAuthentication(user + ":" + password) : NtlmPasswordAuthentication.ANONYMOUS; mFileFilter = fileFilter; } }</span></span></code> </pre>  Special attention should be paid to the user and password parameters.  This is the login and password for the network folder that will be used to create NtlmPasswordAuthentication.  If you do not need a password to access the folder, NtlmPasswordAuthentication.ANONYMOUS should be used as the authentication.  It looks simple, however, authentication is the biggest problem you may encounter when working with network folders.  Usually, most problems lurk in improperly setting security policies on a computer.  The best way to verify the settings is to try to open the network folder on your phone, through any other file manager that supports networking. <br><br>  SmbFile is a file for working with network files.  Surprisingly, in JCIFS it is very easy to work with files.  You will feel almost no difference between SmbFile and regular File.  The only thing that catches your eye is the presence of managed exceptions in almost all methods of the class.  And to create an SmbFile object, you need the authentication data that we created earlier. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> mMaxProgress; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> mProgress; ... <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Void... voids)</span></span></span><span class="hljs-function"> </span></span>{ mMaxProgress = getFilesSize(mFolderToCopy); mProgress = <span class="hljs-number"><span class="hljs-number">0</span></span>; publishProgress(<span class="hljs-number"><span class="hljs-number">0</span></span>d); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { SmbFile sharedFolder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SmbFile(mSharedFolderUrl, mAuth); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sharedFolder.exists() &amp;&amp; sharedFolder.isDirectory()) { copyFiles(mFolderToCopy, sharedFolder); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (MalformedURLException e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Invalid URL."</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> e.getMessage(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }</code> </pre>  The doInBackground method returns an error message.  If null is returned, then everything went smoothly and without errors. <br><br>  Files can be many ... No, not so.  They can be VERY MUCH!  Therefore, showing progress is a vital function.  The recursive getFilesSize method calculates the total amount of files that will be needed to calculate the total progress. <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFilesSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(File file)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!checkFilter(file)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (file.isDirectory()) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> size = <span class="hljs-number"><span class="hljs-number">0</span></span>; File[] filesList = file.listFiles(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (File innerFile : filesList) size += getFilesSize(innerFile); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> size; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) file.length(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkFilter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(File file)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mFileFilter == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || mFileFilter.accept(file); }</code> </pre>  The filter passed to the designer helps to eliminate unnecessary files and folders.  For example, you can exclude all folders starting with a dot or add the Android folder to the blacklist. <br><br>  As I said earlier, working with SmbFile is no different from working with a regular file, therefore, the process of transferring data from the phone to the computer is not original.  I even hide this code under the spoiler, so as not to litter the article with even more obvious code. <br><div class="spoiler">  <b class="spoiler_title">CopyFiles and copySingleFile methods</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String LOG_TAG = <span class="hljs-string"><span class="hljs-string">"WiFiSynchronizer"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyFiles</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(File fileToCopy, SmbFile sharedFolder)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!checkFilter(fileToCopy)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-comment"><span class="hljs-comment">//       ,   . if (fileToCopy.exists()) { if (fileToCopy.isDirectory()) { File[] filesList = fileToCopy.listFiles(); //       "/". SmbFile newSharedFolder = new SmbFile(sharedFolder, fileToCopy.getName() + "/"); if (!newSharedFolder.exists()) { newSharedFolder.mkdir(); Log.d(LOG_TAG, "Folder created:" + newSharedFolder.getPath()); } else Log.d(LOG_TAG, "Folder already exist:" + newSharedFolder.getPath()); for (File file : filesList) copyFiles(file, newSharedFolder); //   } else { SmbFile newSharedFile = new SmbFile(sharedFolder, fileToCopy.getName()); //    ,    . // ,   ,      ,       . if (!newSharedFile.exists()) { copySingleFile(fileToCopy, newSharedFile); Log.d(LOG_TAG, "File copied:" + newSharedFile.getPath()); } else Log.d(LOG_TAG, "File already exist:" + newSharedFile.getPath()); //  . mProgress += (double) fileToCopy.length(); publishProgress(mProgress / mMaxProgress * 100d); } } } //       . private void copySingleFile(File file, SmbFile sharedFile) throws IOException { IOException exception = null; InputStream inputStream = null; OutputStream outputStream = null; try { outputStream = new SmbFileOutputStream(sharedFile); inputStream = new FileInputStream(file); byte[] bytesBuffer = new byte[1024]; int bytesRead; while ((bytesRead = inputStream.read(bytesBuffer)) &gt; 0) { outputStream.write(bytesBuffer, 0, bytesRead); } } catch (IOException e) { exception = e; } finally { if (inputStream != null) try { inputStream.close(); } catch (IOException e) { e.printStackTrace(); } if (outputStream != null) try { outputStream.close(); } catch (IOException e) { e.printStackTrace(); } } if (exception != null) throw exception; }</span></span></code> </pre></div></div>  The code is obvious, but there is one, not at all obvious, point - adding the character "/" to the end of the folder name when creating a new SmbFile.  The fact is that JCIFS treats all files that do not end with the "/" character only as a file, not as a directory.  Therefore, if the network folder's Url looks like this: ‚Äúfile: // MY-PC / shared / some_foldel‚Äù, incidents will arise when creating a new folder in the ‚Äúsome_foldel‚Äù folder.  Namely, ‚Äúsome_foldel‚Äù will be dropped, and the new folder will have the URL: ‚Äúfile: // MY-PC / shared / new_folder‚Äù, instead of the expected ‚Äúfile: // MY-PC / shared / some_foldel / new_folder‚Äù.  However, for such folders, the isDirectory, mkdir or listFiles methods will work correctly. <br><br>  Almost done.  Now run this task in the onCreate service. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> FOREGROUND_NOTIFY_ID = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MESSAGE_NOTIFY_ID = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String SHARED_FOLDER_URL = <span class="hljs-string"><span class="hljs-string">"file://192.168.0.5/shared/"</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> File folderToCopy = getFolderToCopy(); CopyFilesToSharedFolderTask task = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CopyFilesToSharedFolderTask(folderToCopy, SHARED_FOLDER_URL, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onProgressUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Double... values)</span></span></span><span class="hljs-function"> </span></span>{ builder.setProgress(<span class="hljs-number"><span class="hljs-number">100</span></span>, values[<span class="hljs-number"><span class="hljs-number">0</span></span>].intValue(), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) .setContentText(String.format(<span class="hljs-string"><span class="hljs-string">"%s %.3f"</span></span>, getString(R.string.synchronize_service_progress), values[<span class="hljs-number"><span class="hljs-number">0</span></span>]) + <span class="hljs-string"><span class="hljs-string">"%"</span></span>); mNotifyManager.notify(FOREGROUND_NOTIFY_ID, builder.build()); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPostExecute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String errorMessage)</span></span></span><span class="hljs-function"> </span></span>{ stopForeground(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (errorMessage == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) showNotification(getString(R.string.synchronize_service_success), Color.GREEN); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> showNotification(errorMessage, Color.RED); stopSelf(); wakeLock.release(); <span class="hljs-comment"><span class="hljs-comment">//    wakeLock } @Override protected void onCancelled(String errorMessage) { //     .   ,    - . //        . stopSelf(); wakeLock.release(); } }; task.execute();</span></span></code> </pre>  In my case, the username and password are not required, I did not specify a filter either.  The onProgressUpdate method is overridden to show the progress status, and onPostExecute shows a message about the end of the download, or about the occurrence of an error, and then terminates the service. <br><br>  Run the application.  There was a message from the launched service.  While the total files are being calculated, an uncertain state of progress is shown.  But the indicator shows 0%, after which the strip gradually, in small, slightly noticeable steps, begins to move to 100%. <br><br><img src="https://habrastorage.org/files/0a1/558/cd3/0a1558cd34ad4236aabc01d4da9713e6.jpg"><br>  When the work was completed, a message was displayed on the screen about a successful result, and I had all the necessary files on my computer, which were previously sharpened on a broken phone. <br><br><h3>  Unexpected conclusions </h3><br>  What was needed I received.  It's time to make a seagull, fall apart on the couch and turn on some serials.  But wait!  Despite the fact that the phone was mine and access to files on it is not contrary to Russian law, I got them without using a password!  At the same time, Root was not on the phone.  This means that with debugging mode on only, it is not difficult to access the contents of the ‚ÄúSD card‚Äù without even knowing the password.  The only thing that saves is that the only thick point in protection against hacking is the need to use a computer that already has debugging rights. <br><br>  Introduced, not long ago, the new version of Android, perhaps, will close this <abbr title="Actually a hole :)">hole</abbr> , because to access the necessary permissions, you will need to confirm the user, which is impossible when the screen is locked.  In the meantime, Android developer, be on the guard, if you do not want someone else to see your nude photos.  And remember, by allowing any computer to debug via USB, you create another loophole for hacking your own phone. <br><br>  Thanks for attention.  I would be glad to see your thoughts in the comments. <br>  Source code can be found at the following link: <a href="https://github.com/KamiSempai/WiFiFolderSynchronizer">github.com/KamiSempai/WiFiFolderSynchronizer</a> <br><br>  <b>UPD:</b> As I expected, there is a simpler solution to my problem.  Namely, use the adb pull command.  Unfortunately, the rare use of adb and the narrow look at the problem prevented me from coming to it.  I tried to unlock the screen, not download files. <br>  Thanks <a href="https://habrahabr.ru/users/evgent/" class="user_link">EvgenT</a> for a good note. </div><p>Source: <a href="https://habr.com/ru/post/261419/">https://habr.com/ru/post/261419/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261405/index.html">Consolidation of offices in 3CX (Part 1. We use trunks)</a></li>
<li><a href="../261409/index.html">Import substitution, as was said</a></li>
<li><a href="../261413/index.html">Skin Detection in Wolfram Language (Mathematica)</a></li>
<li><a href="../261415/index.html">Your cloud hosting in 5 minutes. Part 1: Ansible, Docker, Docker Swarm</a></li>
<li><a href="../261417/index.html">The Subtleties of ES6: Collections (Part 2)</a></li>
<li><a href="../261421/index.html">The magic of tensor algebra: Part 1 - what is a tensor and what is it for?</a></li>
<li><a href="../261425/index.html">Combining Qt and AdMob</a></li>
<li><a href="../261431/index.html">Remote work or freelancing in the outback. Aspects of communication. Part 2. There is a connection</a></li>
<li><a href="../261433/index.html">Good design, bad design ...</a></li>
<li><a href="../261437/index.html">Heme to send SMS (Ruby)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>