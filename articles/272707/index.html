<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bit magic: getting the next lexicographic combination</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Suppose we have some set that consists of N elements. We assume that the elements are numbered from zero to N-1 . A set of k -element s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bit magic: getting the next lexicographic combination</h1><div class="post__text post__text-html js-mediator-article"><h1>  Introduction </h1><br>  Suppose we have some set that consists of <i>N</i> elements.  We assume that the elements are numbered from zero to <i>N-1</i> .  A set of <i>k</i> -element subsets of a given set (combinations) can be represented either as an array of indices of length <i>k</i> .  Or in the form of a sequence of <i>N</i> bits in which exactly <i>k</i> of them are set.  In Donald Knuth, his <acronym>TAoCP</acronym> provides an algorithm for generating combinations in a lexicographical order, when the combinations are specified as an array of indices.  We will try to transfer this algorithm in case of bit masks. <br><a name="habracut"></a><br><h1>  Algorithm </h1><br>  The algorithm for generating the following lexicographic combination is quite simple and consists of two steps.  In the first step, we need to find the smallest index <i>m of the</i> element, the element after which the element is not included in the combination.  Or, which is the same thing that we can increase by one.  This item is replaced by the following.  In the second step, all elements that are smaller than our selected <i>m</i> -th element should be replaced with the smallest possible one.  For example, and we have a combination <i>{8, 5, 4, 3, 2}</i> .  The smallest element that can be incremented by one is <i>5</i> .  We replace it with a six: <i>{8, 6, 4, 3, 2}</i> .  Now remove the three elements that are less than six: <i>{8, 6}</i> .  And add the smallest three elements.  Received <i>{8, 6, 2, 1, 0}</i> - the following combination in lexicographical order. <br><br>  Now we translate this algorithm into the language of bits.  The first step is to search for the lowest bit, immediately to the left of which is a zero.  The second step is to exchange the received unit and zero places.  The third step: all the bits that are younger than that found, we shift to the zero position.  Consider our example?  100111100 ‚Üí 10 <i>0</i> <b>1</b> 11100 ‚Üí 10 <b>1</b> <i>0</i> 11100 ‚Üí 1010 <b>111</b> <i>00</i> ‚Üí 1010 <i>00</i> <b>111</b> ‚Üí 101000111. <br><br><h1>  Bit trick x &amp; -x </h1><br>  I love different bit tricks.  But many programmers are familiar with them rather weakly, and they drive them into a stupor.  For example, not everyone knows that the expression <i>x &amp; -x</i> will turn all bits of a number to zero, with the exception of the youngest unit set.  How does he work? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      By definition, <i>-x = ~ (x-1)</i> .  The simplest illustration: <i>-1 = ~ (1-1) = ~ 0</i> .  Suppose now that the number x has the form <i>nnnn1000</i> , where <i>n</i> are bits that can be set to both zero and one.  Our goal is to show that <i>(nnnn1000 &amp; -nnnn1000) = 00001000</i> .  We <i>get the</i> following chain: <i>nnnn1000 &amp; -nnnn1000 = nnnn1000 &amp; ~ (nnnn1000 - 1) = nnnn1000 &amp; ~ (nnnn0111) = nnnn1000 &amp; √±√±√±√±1000 = 00001000</i> , where <i>√±</i> is the corresponding inverted bit <i>n</i> . <br><br><h1>  Getting the bitmask of the next lexicographic combination </h1><br>  Now we illustrate how thought should work in order to get a bit expression for the next lexicographic combination.  If we add a number to our number, in which only one low bit is left, then as a result of the transfer, the least significant bit before which stands for zero will move to the place of this zero.  All other low bits will be reset to zero: <br><br><pre><code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = x &amp; -x; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b = x + a;</code> </pre> <br>  As a result, if <i>x = 100111100</i> , then <i>a = 000000100</i> , and <i>b = 101000000</i> .  Half done.  It remains only to select the low bits and move them to the right.  In order to set unused bits to zero, the AND operation is most often used.  Taking into account the trick x &amp; -x, the option immediately suggests itself: <br><br><pre> <code class="hljs pgsql"> <span class="hljs-type"><span class="hljs-type">int</span></span> c = b &amp; -b; // <span class="hljs-number"><span class="hljs-number">001000000</span></span> <span class="hljs-type"><span class="hljs-type">int</span></span> c = c - <span class="hljs-number"><span class="hljs-number">1</span></span>; // <span class="hljs-number"><span class="hljs-number">000111111</span></span> <span class="hljs-type"><span class="hljs-type">int</span></span> d = c &amp; x; // <span class="hljs-number"><span class="hljs-number">000111100</span></span></code> </pre><br>  As a result, we get a sequence of bits that can be shifted to the right.  True, the number of bits will be one more than the required number, which is easy to correct by moving another bit to the right. <br><br>  However, you can also use the XOR operation to zero off the matching bits.  Let's try it too: <br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">int</span></span> c = x<span class="hljs-regexp"><span class="hljs-regexp"> ^</span></span> b;</code> </pre><br>  In the general case, for us <i>x</i> can be represented as <i>x = nn ... n011 ... 100 ...</i> , with <i>b = nn..n100 ... 000 ....</i>  Then the operation x ^ b will kill the <i>nnn</i> coinciding at the beginning, leaving only <i>00 ... 0111 ... 100 ....</i>  For our example, <i>c = 001111100</i> .  Unlike the previous case, this sequence of bits is two times longer than required.  Option c XOR requires fewer operations.  Leave it: <br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">int</span></span> a = x &amp; -x; <span class="hljs-attribute"><span class="hljs-attribute">int</span></span> b = x + a; <span class="hljs-attribute"><span class="hljs-attribute">int</span></span> c = x<span class="hljs-regexp"><span class="hljs-regexp"> ^</span></span> b;</code> </pre><br>  Now the sequence of bits, which is stored in <i>s</i> , must be shifted to the right to the lowest bit, and another two "extra" bits.  You can do this "in the forehead": <br><br><pre> <code class="hljs swift"> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> /= a; <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> &lt;&lt;= <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre><br>  The division operation is quite expensive, and if the processor supports getting the index of the low-order bit, then it will be possible to use it as quickly as possible.  For example, for the case of GCC, the corresponding built-in function is called <a href="https://gcc.gnu.org/onlinedocs/gcc/Other-Builtins.html">__builtin_ctz</a> , as a result we get: <br><br><pre> <code class="hljs lisp"> int d = __builtin_ctz(<span class="hljs-name"><span class="hljs-name">x</span></span>) + <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-comment"><span class="hljs-comment">; c &lt;&lt;= d;</span></span></code> </pre><br>  If there is no such instruction, then we can consider the option of obtaining the index through <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D1%2581%25D0%25BB%25D0%25B5%25D0%25B4%25D0%25BE%25D0%25B2%25D0%25B0%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C_%25D0%25B4%25D0%25B5_%25D0%2591%25D1%2580%25D1%2591%25D0%25B9%25D0%25BD%25D0%25B0">the de Bruin sequence</a> , then our code will look something like this: <br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">int</span></span> d = magic_table[(magic_factor * a) &gt;&gt; magic_shift]; <span class="hljs-attribute"><span class="hljs-attribute">c</span></span> &lt;&lt;= d;</code> </pre><br>  As a result, division and shift were replaced by multiplication, two shifts and taking values ‚Äã‚Äãfrom the table. <br><br><h1>  Summarizing </h1><br>  So, as a result, we got the following code: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">static</span></span> inline uint64_t next_combination_mask(uint64_t x) { <span class="hljs-attribute"><span class="hljs-attribute">uint64_t</span></span> a = x &amp; -x; <span class="hljs-attribute"><span class="hljs-attribute">uint64_t</span></span> b = x + a; <span class="hljs-attribute"><span class="hljs-attribute">uint64_t</span></span> c = b<span class="hljs-regexp"><span class="hljs-regexp"> ^</span></span> x; <span class="hljs-attribute"><span class="hljs-attribute">a</span></span> &lt;&lt;= <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">c</span></span> /= a; <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> b | c; }</code> </pre><br>  consisting of six elementary operations with integers, and one division.  Without cycles and conditions.  Which should be performed fairly quickly.  How can it be used in the finished project?  For example, we want to list all the possible combinations of hands that can be obtained in Omaha.  They will be C (52.4) = 270725. This can be done in the following cycle: <br><br><pre> <code class="hljs ruby"> uint64_t current = <span class="hljs-number"><span class="hljs-number">0x0F</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ; uint64_t last = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">52</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">52</span></span>-          <span class="hljs-number"><span class="hljs-number">52</span></span> ,    <span class="hljs-number"><span class="hljs-number">53</span></span>- <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { process_mask(current); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> - ... current = next_combination_mask(current); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (current &lt; last);</code> </pre></div><p>Source: <a href="https://habr.com/ru/post/272707/">https://habr.com/ru/post/272707/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272695/index.html">As I have been rewriting my cryptocurrency with PHP for Go for 8 months. Part 1</a></li>
<li><a href="../272697/index.html">Optimizing hyperparameters in Vowpal Wabbit with the new vw-hyperopt module</a></li>
<li><a href="../272701/index.html">How to graze cats. The history of building a system of control and accounting of working time for an IT company</a></li>
<li><a href="../272703/index.html">The WikiLeaks Revolution: The Digest of Mishaps</a></li>
<li><a href="../272705/index.html">Record and video processing on Android</a></li>
<li><a href="../272709/index.html">Site navigation - burping a bygone era</a></li>
<li><a href="../272711/index.html">Simple metasearch algorithm in Python</a></li>
<li><a href="../272713/index.html">Monte Carlo simulation in Mathcad Express</a></li>
<li><a href="../272715/index.html">Speak at CodeFest</a></li>
<li><a href="../272717/index.html">Samsung launched production of TSV DDR4 128 Gb memory modules for servers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>