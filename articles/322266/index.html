<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tarantool: load testing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the article " Tarantool: Good, Bad, Evil, " a simple voting service was described with a working example in PHP. We saw how easy it is to connect a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tarantool: load testing</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/93d/f8c/8ee/93df8c8eee4a44d0a6e999c9e802e3da.png"></div><br>  In the article " <a href="https://habrahabr.ru/post/321252/">Tarantool: Good, Bad, Evil,</a> " a simple voting service was described with a working example in PHP.  We saw how easy it is to connect and use this NoSQL database in our programs.  However, one important question was left unattended - why?  What are the performance benefits of using NoSQL compared to regular databases? <br><a name="habracut"></a>  Let's go! <br>  To answer this question, I will test one of my servers.  It is spinning a virtual machine with 1 GB of memory and a processor core with the following parameters: <br><br><pre><code class="hljs pgsql">processor: Intel(R) Xeon(R) CPU E5<span class="hljs-number"><span class="hljs-number">-26</span></span>xx (Sandy Bridge) cpu MHz: <span class="hljs-number"><span class="hljs-number">1999.999</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> size: <span class="hljs-number"><span class="hljs-number">4096</span></span> KB bogomips: <span class="hljs-number"><span class="hljs-number">3999.99</span></span></code> </pre> <br>  The disk subsystem on the SSD is not bad: <br><br><pre> <code class="hljs pgsql">hdparm -t /dev/sda1 /dev/sda1: <span class="hljs-keyword"><span class="hljs-keyword">Timing</span></span> buffered disk reads: <span class="hljs-number"><span class="hljs-number">484</span></span> MB <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">3.00</span></span> seconds = <span class="hljs-number"><span class="hljs-number">161.13</span></span> MB/sec</code> </pre> <br>  Our hoster claims that a 100 Mbit band is available for the virtual server.  And, although, our tests showed a great network speed, we take this limitation for granted.  Version <b>nginx 1.6.2</b> , version <b>php / php-fpm 5.6.30</b> , version <b>Tarantool 1.7.3</b> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For testing, we will use the <b>wrk</b> utility.  After several tests with different <b>wrk</b> parameters and a small tuning of <b>nginx</b> , the latter obtained the following configuration: <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">worker_processes</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-section"><span class="hljs-section">events</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">worker_connections</span></span> <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">multi_accept</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">use</span></span> <span class="hljs-literal"><span class="hljs-literal">epoll</span></span>; } <span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-comment"><span class="hljs-comment"># Timeouts keepalive_timeout 60; # TCP options tcp_nodelay on; tcp_nopush on; # Compression gzip on; gzip_comp_level 5; ‚Ä¶ }</span></span></code> </pre><br>  The wrk utility eventually ran with 50 parallel queries.  If you put fewer requests, you can not achieve maximum server performance.  If you put more requests - 100 and higher, then, despite some performance increase request per second, delay began to grow rapidly.  Ultimately, an increase in the number of parallel requests led to losses.  However, on this point there is a beautiful illustration: <br><br><img src="https://habrastorage.org/files/321/e0f/df6/321e0fdf66e744c6bbeb8ca2c2253796.png"><br><br>  <i>From the article by Konstantin Osipov <a href="http://highload.guide/blog/principles-and-methods-of-queuing.html">Principles and techniques for processing queues</a></i> <br><br><h3>  Tarantula test results </h3><br>  Network ping between the measured server and the traffic generator was 32 ms.  Just in case, the test machine was restarted after trial tests for the sake of objectivity of the result.  The following data was obtained: <br><br><pre> <code class="bash hljs">wrk -c50 -d60s -t4 http://ugly.begetan.me/good Running 1m <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://ugly.begetan.me/good 4 threads and 50 connections Thread Stats Avg Stdev Max +/- Stdev Latency 54.48ms 10.15ms 441.17ms 95.62% Req/Sec 220.76 19.43 270.00 74.65% 52760 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 1.00m, 320.86MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Requests/sec: 878.72 Transfer/sec: 5.34MB</code> </pre> <br>  We managed to get a little less than 900 requests per second with a response time of 54 milliseconds.  Is it a lot or a little?  To begin, remember what happens when you access the page in the script of our service. <br><br><ol><li>  The script sees the appeal of a new client and tries to read cookies that are not available. </li><li>  A unique uuid is generated in Tarantula. </li><li>  In Tarantula, the upsert write command is executed, which records the client's uuid, time, IP, and User-Agent </li><li>  The script invokes the Tarantula team, which selects the Top 9 best out of 16 thousand entries using an index by rating. </li></ol><br><img align="right" src="https://habrastorage.org/files/a0e/35d/1bc/a0e35d1bc7294480999ddd78ca8486ce.png"><br>  And all this together takes about 1 millisecond at the lowest possible VPS - there is no place cheaper!  During the tests, there were more than a million entries in the session table, and this does not affect the performance of the server.  It seems to me that this is not bad, is not it? <br><br>  Additional information can be gathered from the <b>top</b> utility output.  As already mentioned, the server was restarted before starting the tests.  A screenshot was taken during the launch of the re-benchmark from the time of the reboot. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b91/eec/1cc/b91eec1cce4443dab49f752b2b735db0.png"></div><br>  The picture shows the distribution of processor time for tasks.  About a quarter of the resources consumed directly by the <b>Tarantula</b> .  The main consumer of resources turned out to be <b>php-fpm handlers</b> , which was expected.  In third place was <b>nginx</b> .  When I increased the number of parallel requests <b>wrk</b> , the CPU time consumed by nginx increased.  Because of this, there were not enough resources for php-fpm and errors <b>499</b> and <b>502</b> occurred in the logs. <br><br>  At this point, it would be correct to rewrite the application, replacing Tarantula with some ordinary SQL database - <b>MySQL</b> or <b>PostgreSQL</b> and compare the results.  However, the author is not a fan of useless work, so he came up with another option.  We will test a bunch of php-fpm without the Tarantula and see how performance changes. <br><br><h3>  Test results without Tarantula </h3><br>  To begin with, let's see why we took exactly 50 simultaneous connections for testing using wrk (the -c50 parameter)?  When we run one test thread, it starts loading the page, one after another.  Due to the presence of the network delay of signal propagation and non-zero request processing time, the load from one stream is very weak.  Therefore, we are starting to increase the number of parallel requests and watch what happens with the test results and server load.  As the number of simultaneous requests grows, the% CPU of the nginx process increases almost evenly.  When the load increases too much, the server no longer has enough processor resources and some test requests get an error.  They either terminate on timeout from the wrk side, or the web server generates an error 502 that the backend is unavailable (in our case, php-fpm). <br><br>  The most important thing about all this is that the test parameters were chosen precisely for our configuration of the hosting and test server.  To test another bundle, for example, in a local network, you need to select other parameters. <br><br>  Now let's look at the chart, and then I'll show you a couple of interesting points. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/5cf/fac/f46/5cffacf469dd48c09a09f19889b1e69f.png"></div><br>  So, instead of appeals to the Tarantula in our program, we stuck a plug, like this, in a peasant way: <br><br><div class="spoiler">  <b class="spoiler_title">action_good ()</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">action_good</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $title = <span class="hljs-string"><span class="hljs-string">'Top of the best stickers for Telegram'</span></span>; <span class="hljs-comment"><span class="hljs-comment">// $top = get_top(10,Tarantool::ITERATOR_LE); $top[0] = array(0, 7, 'Procy', 0, 'https://s.tcdn.co/6fb/382/6fb38239-ce7c-3234-bc8a-e6267086b46a/18.png', 1,-1); $top[1] = array(0, 7, 'Procy', 0, 'https://s.tcdn.co/6fb/382/6fb38239-ce7c-3234-bc8a-e6267086b46a/17.png', 1,-1); $top[2] = array(0, 7, 'Procy', 0, 'https://s.tcdn.co/6fb/382/6fb38239-ce7c-3234-bc8a-e6267086b46a/16.png', 1,-1); $top[3] = array(0, 7, 'Procy', 0, 'https://s.tcdn.co/6fb/382/6fb38239-ce7c-3234-bc8a-e6267086b46a/15.png', 1,-1); $top[4] = array(0, 7, 'Procy', 0, 'https://s.tcdn.co/6fb/382/6fb38239-ce7c-3234-bc8a-e6267086b46a/14.png', 1,-1); $top[5] = array(0, 7, 'Procy', 0, 'https://s.tcdn.co/6fb/382/6fb38239-ce7c-3234-bc8a-e6267086b46a/13.png', 1,-1); $top[6] = array(0, 7, 'Procy', 0, 'https://s.tcdn.co/6fb/382/6fb38239-ce7c-3234-bc8a-e6267086b46a/12.png', 1,-1); $top[7] = array(0, 7, 'Procy', 0, 'https://s.tcdn.co/6fb/382/6fb38239-ce7c-3234-bc8a-e6267086b46a/11.png', 1,-1); $top[8] = array(0, 7, 'Procy', 0, 'https://s.tcdn.co/6fb/382/6fb38239-ce7c-3234-bc8a-e6267086b46a/10.png', 1,-1); $top[9] = array(0, 7, 'Procy', 0, 'https://s.tcdn.co/6fb/382/6fb38239-ce7c-3234-bc8a-e6267086b46a/9.png', 1,-1); $active_good ='class="active"'; $active_bad =''; include_once('top.html'); }</span></span></code> </pre><br></div></div><br>  Also disable and remove all references to the Tarantula in general and run the script.  As can be seen from the graph (a series of nginx + php), with the Tarantula disabled on 50 streams, we received 1150 instead of 879 requests, i.e.  speed increase was only 30%.  Cool?  Not!  In fact, this test says nothing.  Because we initially picked up the load on the site so that it was 100% loaded.  But now we have disabled one resource-intensive process (about 30% of the total time), and our site is no longer fully loaded.  Check? <br><br>  It is seen that the blue graph grows well with a further increase in the load on the server.  And with 150 test streams without the Tarantula, we received almost 3 thousand requests per second, instead of 1 thousand with the Tarantula.  Now everything is correct. <br><br>  By the way, why did Tarantula use only 30% of the CPU in the test, but when it was turned off, did the server's performance increase threefold?  The answer is simple: after turning off the Tarantula, the load on php-fpm workers has also decreased.  The increase in load was due to the increase in CPU consumption by the nginx process.  We drove this load by increasing the number of threads until we began to receive testing errors. <br><br>  Now look at one interesting point.  What is on the Tarantool + Connect graph?  As usual, interesting moments are random.  The situation arose when I first turned off all the calls to the Tarantula procedures and ran the test, but I saw that the Tarantula process continues to have a decent piece of CPU.  It turned out that I forgot to comment out the connection setup procedure, this is the part: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment"># Init database $tarantool = new Tarantool('localhost', 3301, 'good', 'bad'); try { $tarantool-&gt;ping(); } catch (Exception $e) { echo "Exception: ", $e-&gt;getMessage(), "\n"; }</span></span></code> </pre> <br>  The Tarantool + Connect graph shows system performance only with connection initialization, without any computational operations.  It turned out that in our demo application a large part of the utilization of the Tarantula process gives the procedure of establishing the connection, and not the actual computing tasks.  By CPU shares, the exact alignment is as follows: 20% in the case of the Tarantool + Connect test and 28% in the case of full-fledged work as a database. <br><br>  What conclusion can there be?  It is possible that the process of connecting to the Tarantula is a resource-intensive operation, or the PHP driver does not work optimally.  It is important that when establishing a permanent connection, for example, from a daemon written in C, Java or Go, the same operations would use up to 4 times less CPU.  This should be considered when writing programs. <br><br><h3>  WAL or not WAL? </h3><br>  And finally, the last test, which is extremely simple, but very interesting for the developer.  As we already know, Tarantula declares data integrity thanks to the <b>Snapshoot</b> and <b>Write Ahead Log</b> mechanism.  The first creates and records a regular database cast, and the second records all changes in a special change log.  In the event of a sudden shutdown or server crash, the changes are saved and can be restored when the system is restarted. <br><br>  I tested the load with the WAL log turned off.  At 50 streams, the number of rps increased from 879 to 963. It is clear that turning off the additional log file on the disk should speed up the system, which is 100% loaded.  However, it is clear that the increase in speed is close to the measurement error and is absolutely not worth the price to be paid for it.  It is better to be confident in the safety of their precious data. <br><br><h3>  Instead of an afterword </h3><br>  Previously, in web development, a common place was the reasoning on the topic ‚Äúwhy, they say, use fast programming languages ‚Äã‚Äãto write web-frontend, anyway, the database will slow down!‚Äù.  Now, as the capabilities of hardware, virtualization, and NoSQL solutions grow, the base ceases to be a bottleneck in the application. <br><br><img align="left" src="https://habrastorage.org/files/813/781/e78/813781e78bc240d1aea267068fe32839.png">  For me personally, one important question remains unclear.  Is Tarantula really as reliable a repository as its developers are trying to prove?  ‚ÄúAnd what the hell, if not?‚Äù, As sung in one song.  I would like to conduct a data loss test called ‚ÄúBreak the Tarantula‚Äù, but I definitely need help and advice from skeptics, haters, competitors and just Mail.ru haters to simulate tough conditions for real!  Because ‚Äú <i>Plato is my friend, but the truth is more precious!</i>  " <br><br>  And do not forget to vote on the demo site: <a href="http://ugly.begetan.me/">ugly.begetan.me</a> !  And then you have to lay out each time the same raccoon from the TOP section. </div><p>Source: <a href="https://habr.com/ru/post/322266/">https://habr.com/ru/post/322266/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../322252/index.html">What questions to ask at the interview</a></li>
<li><a href="../322254/index.html">Examples of how partners lose money when collaborating with CPA networks</a></li>
<li><a href="../322256/index.html">Why Kotlin sucks</a></li>
<li><a href="../322258/index.html">We write game logic in C #. Part 1/2</a></li>
<li><a href="../322262/index.html">Mustached shooter of twenty-three polygons</a></li>
<li><a href="../322268/index.html">We write game logic in C #. Part 2/2</a></li>
<li><a href="../322270/index.html">In defense, Zuckerberg takes Evan Spiegel "by the throat"</a></li>
<li><a href="../322272/index.html">How to wind 40k views on Habrahabr. Bug or feature?</a></li>
<li><a href="../322274/index.html">Business rule repositories and corresponding code blocks that are embedded in production</a></li>
<li><a href="../322276/index.html">Myths about the CAP theorem</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>