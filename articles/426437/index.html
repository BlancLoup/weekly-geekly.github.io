<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How face recognition helps you find test phones</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, habrovchane! EastBanc Technologies has a large number of projects related to mobile development. In this connection, a whole zoo of devices is req...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How face recognition helps you find test phones</h1><div class="post__text post__text-html js-mediator-article">  Hi, habrovchane!  EastBanc Technologies has a large number of projects related to mobile development.  In this connection, a whole zoo of devices is required for testing at all stages.  And, characteristically, every single device is constantly needed by very different people, and to find it even in one mobile development department of several dozen people is a whole story.  Not to mention the fact that there are testers, designers, PM'y, in the end! <br><br>  And in order not to lose the phone, but to clearly know where he is and with whom, we use an online database that recognizes employees by persons.  Now we will tell how we came to this and implemented it. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/83e/934/a48/83e934a48d88da29a8d0d95c6aca33bc.jpg" alt="image"><br><a name="habracut"></a><br><h2>  Historical context </h2><br>  We had a board with ‚Äúcards‚Äù of devices with basic information and a place for a magnet, indicating an employee.  One was noted about taking a device. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/625/ec6/08d/625ec608d24c28558991679a78dab2e7.jpg" alt="image"><br><br>  This system has its drawbacks - not critical, but generally uncomfortable: <br><br><ul><li>  Magnets are not so easy to move from one place to another. </li><li>  To look at this board, be sure to have to go to another office. </li><li>  And someone may need many devices at once ... So, you need several magnets for one employee. </li><li>  Oh yeah, even the employees sometimes quit and new ones come, which also need to make magnets. </li></ul><br><h4>  Mobile app </h4><br>  In a company that is engaged in business process automation, using the ‚Äúanalog‚Äù solution described above is not very cool.  Naturally, we decided to automate the task of finding the desired device.  The first step was to write a mobile application that knows how to determine and report its location in rooms via Wi-Fi access points.  Along the way, for convenience, they gave the device the ability to report the OS version to the server, and also to show such an important characteristic as the battery charge. <br><br>  It would seem that the problem is solved.  You look at the list in the database where the device last saw Wi-Fi, go there and ... <br><br>  In operation, it turned out that not everything is so simple.  We installed the application on test devices and worked with it for several months.  It turned out that this option is convenient, but also not perfect. <br><br>  Devices are discharged, simply turned off, Wi-Fi access points are swapped from one place to another, and geolocation in itself says only that the device is in the office.  Thank you, captain! <br><br>  You can, of course, try to optimize the existing system, but why not reinvent it based on the technologies of the XXI century?  No sooner said than done. <br><br><h2>  How we wanted it to be </h2><br>  We came up with the concept of a system that would recognize employees by persons, test devices - by special labels, request confirmation of a change in the status of the device, and then make changes to the online database that any employee can see without getting up from the chair. <br><br><h2>  Face recognition </h2><br>  Face recognition in general, the problem solved in 2018.  Therefore, we did not reinvent the wheel and try to train our own models, but took advantage of a ready-made solution.  The most convenient option seemed to be the <a href="https://github.com/ageitgey/face_recognition"><b>FaceRecognition</b></a> module, since  It does not require additional training and works very quickly even without acceleration on the GPU. <br><br>  With the help of the <b>face_locations</b> function, photos of employees were detected in faces, and with the help of <b>face_encodings,</b> signs of a person‚Äôs face were extracted. <br><br>  The data obtained was collected in the database.  To determine a specific employee, using the <b>face_distance</b> function was considered the ‚Äúdifference‚Äù between the encoding of the detected employee and the encodings from the database. <br><br>  In general, at this stage it was possible to go further and create a classifier, for example, based on <a href="https://en.wikipedia.org/wiki/K-nearest_neighbors_algorithm">KNN</a> , so that the system was less sensitive to the dynamics of the employees' faces.  However, in practice this requires much more time.  Yes, and the banal averaging of the encoding of a person‚Äôs face between the one that is now in the database and the one that the system found to change the status of the device was already enough to avoid accumulating an error in practice. <br><br><div class="spoiler">  <b class="spoiler_title">Face Recognition Code</b> <div class="spoiler_text"><pre><code class="python hljs">face_locations = face_recognition.face_locations(rgb_small_frame) face_encodings = face_recognition.face_encodings(rgb_small_frame, face_locations) face_names = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> face_encoding <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> face_encodings: matches = face_recognition.face_distance( known_face_encodings, face_encoding) name = <span class="hljs-string"><span class="hljs-string">"Unknown"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> np.min(matches) &lt;= <span class="hljs-number"><span class="hljs-number">0.45</span></span>: best_match_index = np.argmin(matches) name = known_face_info[str(best_match_index)][<span class="hljs-string"><span class="hljs-string">'name'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: best_match_index = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span></code> </pre> <br></div></div><br><h2>  Device recognition </h2><br>  Initially, the idea arose to use <a href="https://ru.wikipedia.org/wiki/QR-%25D0%25BA%25D0%25BE%25D0%25B4">QR-codes</a> for device recognition, in which to enter information about the device as well.  However, for sustainable recognition of the QR code, it had to be brought very close to the camera, which is inconvenient. <br><br>  As a result, the thought arose about the use of augmented reality markers.  They carry less information, but are much more consistently recognized.  In the course of the experiments, a marker measuring 30 millimeters in size was recognized by the camera with small deviations from the vertical (3-5 degrees) at a distance of up to two and a half meters. <br><br>  This option already looked much better.  Of the entire array of augmented reality markers, <a href="https://www.sciencedirect.com/science/article/pii/S0262885618300799">ARuco</a> was chosen, since  all the necessary tools for working with them are present in the <a href="https://docs.opencv.org/3.1.0/d5/dae/tutorial_aruco_detection.html">opencv-contrib-python</a> delivery. <br><br><div class="spoiler">  <b class="spoiler_title">ARuco marker recognition code</b> <div class="spoiler_text"><pre> <code class="python hljs">self.video_capture = cv2.VideoCapture(<span class="hljs-number"><span class="hljs-number">0</span></span>) ret, frame = self.video_capture.read() gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY) markers = cv2.aruco.detectMarkers(gray, self.dictionary)</code> </pre> <br></div></div><br>  As a result, each device was assigned a numerical index with which the marker was compared with this index. <br><br><h2>  In the bag? </h2><br>  It would seem that we have learned to recognize the device and the face, the work is done.  Fanfare, ovations!  What else might be needed? <br><br>  In fact, the work is just beginning.  Now all components of the system must be made to work stably and quickly "in combat". <br><br>  It is necessary to optimize the cost of server resources in idle, think through the use cases and understand how this should look like graphically. <br><br><h2>  Interface </h2><br>  Perhaps the most important point in the development of such systems is the interface.  Someone may argue, but the user is the central element in such a situation. <br><br>  As quickly as possible, you can implement the frontend part with <a href="https://docs.python.org/3/library/tkinter.html">Tkinter</a> . <br><br><div class="spoiler">  <b class="spoiler_title">A few notes about Tkinter</b> <div class="spoiler_text"><ul><li>  Pay attention to the units in which indents / sizes of elements are set (relative or absolute). </li><li>  Remember that relative and absolute units can be used together (their values ‚Äã‚Äãare simply added together). </li><li>  Parameter <pre> <code class="python hljs">.attributes(<span class="hljs-string"><span class="hljs-string">"-fullscreen"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)</code> </pre>  allows you to make a single-window application that unfolds to full screen, so as not to confuse users with elements of the system interface. </li></ul></div></div><br>  The interface consists of cards with information about the device and the user currently using the device.  Most of the screen is occupied by a catalog of cards - the main accounting tool.  Above is a filter with which you can filter the directory by platform or version of the operating system. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/de5/5ee/b81/de55eeb81d57374bccd0c0c0e47ba3e6.jpg" alt="image"><br><br><h4>  Here are the key components of the interface: </h4><br><ul><li>  <b>Device</b> <br>  The screen displays the device cards with the version of the operating system, the name and ID of the device, as well as the user on whom this device is now registered. </li><li>  <b>Photo fixing</b> <br>  On the right is the control unit, where the image from the webcam is displayed, as well as buttons for registering and editing personal information. <br><br>  The image is displayed to give the user feedback - you definitely hit the screen with a device label. </li><li>  <b>OS version selection</b> <br>  We made a list with the choice of the OS version of interest, because  Often, for testing, you need not a specific device, but a specific version of Android or iOS.  The version filter is made horizontal to save space and to make the list of versions available without scrolling on one screen. </li></ul><br><h2>  Optimization </h2><br>  One pass of any component of the system does not take too long.  However, if you start recognition of markers and faces at the same time, then an attempt to recognize all 30 frames per second provided by the camera will lead to the complete exhaustion of computer resources without a GPU. <br><br>  It is clear that 99% of the time the system will do this work idly. <br><br>  To avoid this, the following optimization decisions were made: <br><br><ol><li>  Only every eighth frame is submitted for processing. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.lastseen + self.rec_threshold &gt; time.time() <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> self.frame_number != <span class="hljs-number"><span class="hljs-number">8</span></span>: ret, frame = self.video_capture.read() self.frame_number += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.frame_number &gt; <span class="hljs-number"><span class="hljs-number">8</span></span>: self.frame_number = <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> frame, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span></code> </pre> </div></div><br>  The delay in the response of the system rises to about 8/30 seconds, while the human response time is about one second.  Accordingly, such a delay will still not be noticeable to the user.  And we have already eight times reduced the load on the system. </li><li>  First, a device marker is searched for in the frame, and only when it is detected, face recognition is triggered.  Since searching for markers in a frame is about 300 times less expensive than searching for faces, we decided that in standby mode we would only check for the presence of a marker. </li><li>  To reduce the ‚Äúbrakes‚Äù when searching for faces when there are no faces on the image, the number_of_time_to_upsample parameter was disabled in the face_locations function. <br><br>  <i>face_locations = face_recognition.face_locations (rgb_small_frame, number_of_times_to_upsample = 0)</i> <br><br>  Due to this, the processing time of a frame in which there are no faces has become equal to the processing time of a frame, where faces are easily detected. </li></ol><br><h2>  What is the result? </h2><br>  At the moment, the system has been successfully deployed on MacMini Late 2009, which has come up under the arm, on two Core 2 Duo cores.  As part of testing, it quite successfully worked even on a single virtual core with 1024 megabytes of RAM and 4 gigabytes of permanent memory in a Docker container.  A touchscreen display was connected to MacMini to make the look minimalist. <br><br>  Now even those users who have not used the old board register their devices with enthusiasm and smile, and the number of unsuccessful searches has become much less! <br><br><h2>  What's next? </h2><br>  In the current system, undoubtedly, there are still a lot of points that one can and would like to improve: <br><br><ul><li>  Make it so that OS controls do not appear when dialog boxes appear (now this is the messagebox from the Tkinter package). </li><li>  Spread calculations and server requests to different threads with interface processing (they are now executed in the main thread, Tkinter's mainloop, which freezes the interface at the time of sending requests to the online database). </li><li>  Lead the interface to the same design with other corporate resources. </li><li>  Make a full-fledged web interface for remote viewing of data. </li><li>  Use voice recognition to confirm / cancel actions and fill in text fields. </li><li>  Implement registering multiple devices at the same time. </li></ul><br>  <b>PS But this is how it works</b> <br>  <i>Video recorded on beta GUI</i> <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://vk.com/video_ext.php" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/426437/">https://habr.com/ru/post/426437/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../426427/index.html">Useful things to "things": a small selection with low prices</a></li>
<li><a href="../426429/index.html">Installing FreeSWITCH 1.8 on Debian 9 (Raspbian Stretch, the basic image of the SmartDomain system MajorDoMo on Rasbperri Pi)</a></li>
<li><a href="../426431/index.html">Qlie visual story engine disassembly</a></li>
<li><a href="../426433/index.html">Delicious SMM for restaurant</a></li>
<li><a href="../426435/index.html">The best specialists are those that I myself have prepared: a course on testing games from the experts of Mail.Ru Group</a></li>
<li><a href="../426439/index.html">Forgery of charts, substitution of quotes and price manipulation: how to hack applications for trading on the stock exchange</a></li>
<li><a href="../426441/index.html">Mail.Ru Group 20 years: Checkpoint code and technology</a></li>
<li><a href="../426443/index.html">It seems we began to forget what space exploration looks like.</a></li>
<li><a href="../426449/index.html">iPhone XS: why is this brand new camera</a></li>
<li><a href="../426451/index.html">A long farewell to Baxter, the gentlest giant among robots</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>