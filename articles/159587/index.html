<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Uploading files to the server in 2012</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At one point, I was faced with the task of creating an API for working with files on the client and uploading them to the server. 

 I work in Mail.Ru...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Uploading files to the server in 2012</h1><div class="post__text post__text-html js-mediator-article">  At one point, I was faced with the task of creating an API for working with files on the client and uploading them to the server. <br><br>  I work in Mail.Ru Mail, and my direct responsibility is to work with JavaScript in all its manifestations.  Attaching files to a letter is one of the main functions of any mail.  We are no exception here: we already had a Flash downloader, which worked quite well and for a long time was fine for us.  However, he had a number of drawbacks.  The entire layout, graphics, business logic, and even localization were sewn into it, as a result of which the decision was cumbersome, and only the Flash developer could make the edit.  At some point, we realized that we needed a new mechanism.  How to create it will be discussed in this article. <br><br><a name="habracut"></a>  Those who wrote the Flash downloader understand the challenges they face: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  cookies will be taken from IE; </li><li>  proxy settings - the same story; </li><li>  Error # 2038, # 2048, ... - floating error, depending on the combination network + browser + Flash Player; </li><li>  AdBlock, etc.  - no comments. </li></ul><br>  And so, looking at all this, we decided: it's time, the moment has come - and we have formed the following requirements: <br><br><ul><li>  multiple file selection; </li><li>  getting information (name, size and mime type); </li><li>  creating a preview image before downloading; </li><li>  scaling, cropping and rotation on the client; </li><li>  upload all that happened to the server + CORS; </li><li>  independence from third-party libraries; </li><li>  extensibility. </li></ul><br><br>  The last 4 years, the possibilities of HTML5, including the <a href="http://caniuse.com/">File API,</a> are being increasingly discussed.  Many articles have been written on this subject, there are working examples.  It would seem that here is a ready-made tool for solving the set tasks.  But is everything as simple as it seems at first glance?  Consider the statistics of <a href="http://top.mail.ru/browsers%3Fid%3D250%26ago%3D1">Mail.Ru</a> users by browsers.  Only the versions that are supported by the File API are selected from the list, albeit not 100%. <br><br><img src="https://habrastorage.org/storage2/aec/9a9/d69/aec9a9d6914a586ea8659596c0984e96.png"><br><br>  As can be seen from the diagram, just over 63% of browsers used support the File API: <br><br><ul><li>  Chrome 10+ (~ 26%) </li><li>  Firefox 3.6+ (~ 19%) </li><li>  Opera 11.10+ (~ 17%) </li><li>  Safari 5.4+ (~ 1.4%) </li></ul><br>  Also, do not forget about mobile devices, whose share is growing day by day.  <b>iOS 6</b> already supports File API. <br><br>  <b>Internet Explorer</b> promises support from version 10. <br><br>  But 63% is not 100%.  So to abandon Flash'a early. <br><br>  Thus, the task was reduced to creating a mechanism that combines both technologies (File API and Flash) and was implemented so that the final developer would not care how the files are loaded.  In the course of the work, the idea arose of arranging all the developments in the form of a separate library (unified API) that would work regardless of the environment and could be used not only within the Mail.Ru Mail, but anywhere. <br><br>  Consider specific examples of how the development process. <br><br><br><h4>  Getting a list of files </h4><br>  This is how getting a list of files on HTML5.  Everything is very simple. <br><br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiple</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> input = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"file"</span></span></span><span class="javascript">); input.addEventListener(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"change"</span></span></span><span class="javascript">, </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>)</span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> files = input.files; }, </span><span class="hljs-literal"><span class="javascript"><span class="hljs-literal">false</span></span></span><span class="javascript">); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  But what to do when the File API is not supported, but is Flash supported?  The basic principle of working with Flash is that all interaction takes place directly through it.  You can not just take and call the file selection dialog. <br><br>  This requires the user to click on Flash.  Only at this moment can a dialogue be opened - such is the security policy. <br><br>  Therefore, the Flash object is placed above the desired input.  This is done very simply: the mouseover event is hung up on the entire document, and when you hover over the input [type = "file"] in the "parent", a Flash object is published and occupies its entire space. <br><br>  When clicking on the flash drive, the file dialog opens, the user selects something in it and clicks OK.  Then the data is transferred from Flash to JS via ExternalInterface.  JS connects the received data with the necessary input and emulates the "change" event. <br><div class="spoiler">  <b class="spoiler_title">Flash -&gt; js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">[[Flash]] --&gt; jsFunc([{ <span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"346515436346"</span></span>, <span class="hljs-comment"><span class="hljs-comment">//   name: "hello-world.png", //   type: "image/png", // mime-type size: 43325 //  }, { // etc. }])</span></span></code> </pre></div></div><br>  All further interaction between JS and Flash will be carried out through the only available method of the Flash object.  The first argument is the name of the command, the second is the parameter object with two required fields: the file id and callback.  The callback will be called from Flash when the command completes. <br><br><pre> <code class="javascript hljs">flash.cmd(<span class="hljs-string"><span class="hljs-string">"imageTransform"</span></span>, { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"346515436346"</span></span>, <span class="hljs-comment"><span class="hljs-comment">//   matrix: { }, //   callback: "__UNIQ_NAME__" });</span></span></code> </pre><br>  After combining the two methods, the API turned out to be as close as possible to Native JS.  The only difference is the way to get the files.  Now we use the API method, since  the input files have a file property only if the browser supports the HTML5 / File API;  in the case of Flash, the list is taken from its associated data. <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js-fileapi-wrapper"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"position: relative"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiple</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> input = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"file"</span></span></span><span class="javascript">); FileAPI.event.on(input, </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"change"</span></span></span><span class="javascript">, </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>)</span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> files = FileAPI.getFiles(input); }); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">or so</b> <div class="spoiler_text"><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js-fileapi-wrapper"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"position: relative"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiple</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> input = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"file"</span></span></span><span class="javascript">); FileAPI.event.on(input, </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"change"</span></span></span><span class="javascript">, </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">evt</span></span></span></span><span class="javascript"><span class="hljs-function">)</span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> files = FileAPI.getFiles(evt); }); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre></div></div><br><br><h4>  Filtration </h4><br>  As a rule, when downloading files there are a number of restrictions.  One of the most popular ones is file size, image type and width / height.  The standard scheme for solving such tasks: first upload the file to the server, and after validation, inform the user that the file did not fit, ‚Äútry again‚Äù.  Creating a filtering method, I tried to solve this problem, giving the opportunity to operate during filtering with more detailed information about the file. <br><br>  What is the difficulty?  The whole point is that initially, after receiving the list of files, we have only minimal information, such as name, size and type.  In order to get more detailed information, the file must be read.  This can be done via <a href="https://developer.mozilla.org/en-US/docs/DOM/FileReader">FileReader</a> . <br><div class="spoiler">  <b class="spoiler_title">IE10 &amp; FileReader</b> <div class="spoiler_text"><pre> <code class="javascript hljs">‚Äã<span class="hljs-comment"><span class="hljs-comment">//    , IE10  HTML5/FileAPI: var reader = new File‚ÄãReader; reader.readAsBinaryString(file); // error: Object doesn't support method or property "readAsBinaryString" ‚Äã// ,  ! var reader = new FileReader; reader.onload = function (evt){ var base64 = evt.result.replace(/^data:[^,]+,/, ''); var binaryString = window.atob(base64); // bingo! }; reader.readAsDataURL(file);</span></span></code> </pre></div></div><br>  The result is the following filtering method: <br><br><pre> <code class="javascript hljs">FileAPI.filterFiles(files, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file, info</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-regexp"><span class="hljs-regexp">/^image/</span></span>.test(file.type) ){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.width &gt; <span class="hljs-number"><span class="hljs-number">320</span></span> &amp;&amp; info.height &gt; <span class="hljs-number"><span class="hljs-number">240</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( file.size ){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> file.size &lt; <span class="hljs-number"><span class="hljs-number">10</span></span> * FileAPI.MB; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ,   File API  Flash,    . //   ,     ,    . return true; } }, function (files, ignore){ if( files.length &gt; 0 ){ // ... } });</span></span></code> </pre><br><br>  Also, out of the box, the definition of the height and width of the image is supported, and it is also possible to realize the collection of the necessary information: <br><br><pre> <code class="javascript hljs">FileAPI.addInfoReader(<span class="hljs-regexp"><span class="hljs-regexp">/^audio/</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file, callback</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    //    callback( false, //    { artist: "...", album: "...", title: "...", ... } ); });</span></span></code> </pre><br><br><br><h4>  Work with images </h4><br>  In the process of creating an API, I wanted to get a tool for working with an image ‚Äî for example, creating a preview ‚Äî and that the basic functionality was supported by HTML5 and Flash. <br><br><br><h5>  Flash </h5>  First of all, it was necessary to understand how to do this through Flash, i.e.  what to transfer to JS to build an image.  As you understand, this is done using the Data URI.  Flash reads the file as Base64, transfers to JS.  We add ‚Äúdata: image / png; base64,‚Äù to the beginning and use the resulting string as ‚Äúsrc‚Äù. <br><br>  Happy end?  Alas, but in IE6-7 there is no support for the Data URI, and IE8 +, which supports the Data URI, does not process more than 32 KB.  In these cases, JS publishes the second flash drive, which transfers Base64, and it restores the image. <br><br><br><h5>  HTML5 </h5>  Here you need to first get the original, and then through the Canvas to carry out the necessary transformation.  The original can be obtained in two ways.  The first is to read the file as a DataURL using FileReader.  The second - <a href="https://developer.mozilla.org/en-US/docs/DOM/window.URL.createObjectURL">URL.createObjectURL</a> creates a link to the file associated with the current tab.  Of course, to create a preview, the second method is enough, but not all browsers support it.  And some do not support the companion URL.revokeObjectURL, which tells the browser that you no longer need to keep a link to the file. <br><br>  After combining all these methods, the FileAPI.Image class turned out: <br><br><ul><li>  <b>crop</b> (x, y, width, height) - cropping; </li><li>  <b>resize</b> (width [, height]) - scaling; </li><li>  <b>rotate</b> (deg) - turn; </li><li>  <b>preview</b> (width, height) - frames and scales; </li><li>  <b>get</b> (callback) - get the final image. </li></ul><br><br>  All of these methods fill the transformation matrix, and only when the get method is called, will it be applied.  Transformation occurs through the Canvas or inside Flash, when working through it. <br><br><div class="spoiler">  <b class="spoiler_title">Matrix description</b> <div class="spoiler_text"><pre> <code class="javascript hljs">{ <span class="hljs-comment"><span class="hljs-comment">//    sx: Number, sy: Number, sw: Number, sh: Number, //   dw: Number, dh: Number, deg: Number }</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Usage example</b> <div class="spoiler_text"><pre> <code class="javascript hljs">FileAPI.Image(imageFle) .crop(<span class="hljs-number"><span class="hljs-number">300</span></span>, <span class="hljs-number"><span class="hljs-number">300</span></span>) .resize(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) .get(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, img</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !err ){ images.appendChild(img); } }) ;</code> </pre></div></div><br><br><h4>  Resize process </h4><br>  In our life, mirrors and soapboxes, which, given a price of 1.2K rubles, give out from 10Mpx, have long been entered.  And when we began to compress these images, we got something like this: <br><br><img src="https://habrastorage.org/storage2/4b7/51f/f89/4b751ff899dbb8c91a51fea3cffe5c89.png"><br><br>  As you can see, nothing good - continuous distortion.  But, if you compress twice, then another and another, until we get the required size, the result is much better. <br><br><img src="https://habrastorage.org/storage2/794/8f5/d8b/7948f5d8b004fc8163c2b6aae166ffb3.png"><br><br>  Here, compare, the difference is obvious: <br><br><img src="https://habrastorage.org/storage2/7d5/5ef/05d/7d55ef05d67821caaa5104d95a7c1038.png"><br><br>  If you add a little sharpe, it will be perfect <br><br>  We also tried other methods, such as bicubic interpolation and Lanczos algorithm.  They give a slightly better result, but very slow: 1.5s vs. 200-300ms.  Also, this method gives the same result in Canvas and Flash. <br><br><br><h4>  File upload </h4><br>  I will summarize the ways in which you can now upload a file to the server. <br><br><br><h5>  iframe </h5>  Yes, and after years he is still in the ranks: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">target</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"__UNIQ__"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/upload"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"post"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">enctype</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"multipart/form-data"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">iframe</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"__UNIQ__"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">iframe</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"files"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"foo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bar"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  First, a transport form is created with the iframe inside (the target attribute of the form and the name iframe must match).  Then you need to move the input [type = "file"] into it, because  if you put a clone, it will be ‚Äúempty‚Äù.  That is why we subscribe to events through API methods to save them when cloning.  Then call form.submit () and the entire contents of the form is sent via the iframe.  The answer is obtained using JSONP. <br><br><br><h5>  Flash / Silverlight </h5>  Flash first appeared, followed by Silverlight, who was about to become a Flash killer, but something didn‚Äôt grow together.  In general, everything is simple there: JS calls the method on the Flash object and passes the id of the file to be loaded, and Flash, in turn, duplicates all states and events in JS. <br><br><br><h5>  XMLHttpRequest + FormData </h5>  Now you can send not just text data, but binary.  This is done very simply: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     var form = new FormData form.append("foo", "bar"); //    POST-, form.append("attach", file); //  ,   blob //    var xhr = new XMLHttpRequest; xhr.open("POST", "/upload", true); xhr.send(form)</span></span></code> </pre><br>  But what to do when you need to send not a file, but, for example, a Canvas?  There are two ways.  The first, which is the most correct and simple one, is, of course, to convert the Canvas to Blob: <br><pre> <code class="javascript hljs">canvasToBlob(canvas, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">blob</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> form = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FormData form.append(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>, <span class="hljs-string"><span class="hljs-string">"bar"</span></span>); form.append(<span class="hljs-string"><span class="hljs-string">"attach"</span></span>, blob, <span class="hljs-string"><span class="hljs-string">"filename.png"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//      // ... });</span></span></code> </pre><br>  As you understand, not everywhere there is an opportunity to turn such a focus.  If the Canvas has no Canvas.toBlob method (or it cannot be implemented), go the other way.  It is also suitable for those browsers that do not support FormData. <br><br>  The essence of this method is to make a multipart request with your hands and send it to the server.  For Canvas, the code will look like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dataURL = canvas.toDataURL(<span class="hljs-string"><span class="hljs-string">"image/png"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    FileReader var base64 = dataURL.replace(/^data:[^,]+,/, ""); //   var binaryString = window.atob(base64); //  Base64 //    muptipart,   var uniq = '1234567890'; var data = [ '--_'+ uniq , 'Content-Disposition: form-data; name="my-file"; filename="hello-world.png"' , 'Content-Type: image/png' , '' , binaryString , '--_'+ uniq +'--' ].join('\r\n'); var xhr = new XMLHttpRequest; xhr.open('POST', '/upload', true); xhr.setRequestHeader('Content-Type', 'multipart/form-data; boundary=_'+uniq); xhr.sendAsBinary(data);</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">If the browser does not support xhr.sendAsBinary</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( xhr.sendAsBinary ){ <span class="hljs-comment"><span class="hljs-comment">// ... } else { var bytes = Array.prototype.map.call(data, function(c){ return c.charCodeAt(0) &amp; 0xff; }); xhr.send(new Uint8Array(bytes).buffer); }</span></span></code> </pre></div></div><br><br>  As a result, the method was born: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = ‚ÄãFileAPI.upload({ <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">'/upload'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: { <span class="hljs-attr"><span class="hljs-attr">foo</span></span>: <span class="hljs-string"><span class="hljs-string">'bar'</span></span> }, <span class="hljs-attr"><span class="hljs-attr">headers</span></span>: { <span class="hljs-string"><span class="hljs-string">'Session-Id'</span></span>: <span class="hljs-string"><span class="hljs-string">'...'</span></span> }, <span class="hljs-attr"><span class="hljs-attr">files</span></span>: { <span class="hljs-attr"><span class="hljs-attr">images</span></span>: imageFiles, <span class="hljs-attr"><span class="hljs-attr">others</span></span>: otherFiles }, <span class="hljs-attr"><span class="hljs-attr">imageTransform</span></span>: { <span class="hljs-attr"><span class="hljs-attr">maxWidth</span></span>: <span class="hljs-number"><span class="hljs-number">1024</span></span>, <span class="hljs-attr"><span class="hljs-attr">maxHeight</span></span>: <span class="hljs-number"><span class="hljs-number">768</span></span> }, <span class="hljs-attr"><span class="hljs-attr">upload</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">xhr</span></span></span><span class="hljs-function">)</span></span>{}, <span class="hljs-attr"><span class="hljs-attr">progress</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event, file</span></span></span><span class="hljs-function">)</span></span>{}, <span class="hljs-attr"><span class="hljs-attr">complete</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, xhr, file</span></span></span><span class="hljs-function">)</span></span>{}, <span class="hljs-attr"><span class="hljs-attr">fileupload</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file, xhr</span></span></span><span class="hljs-function">)</span></span>{}, <span class="hljs-attr"><span class="hljs-attr">fileprogress</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event, file</span></span></span><span class="hljs-function">)</span></span>{}, <span class="hljs-attr"><span class="hljs-attr">filecomplete</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, xhr, file</span></span></span><span class="hljs-function">)</span></span>{} });‚Äã</code> </pre><br><br>  It has a lot of parameters, but I will pay special attention to imageTransform.  Through it the information for image transformation on the client is set.  It works through both Flash and HTML5.  But that's not all: imageTransform can also be multiple: <br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">huge</span></span>: { <span class="hljs-attr"><span class="hljs-attr">maxWidth</span></span>: <span class="hljs-number"><span class="hljs-number">800</span></span>, <span class="hljs-attr"><span class="hljs-attr">maxHeight</span></span>: <span class="hljs-number"><span class="hljs-number">600</span></span>, <span class="hljs-attr"><span class="hljs-attr">rotate</span></span>: <span class="hljs-number"><span class="hljs-number">90</span></span> }, <span class="hljs-attr"><span class="hljs-attr">medium</span></span>: { <span class="hljs-attr"><span class="hljs-attr">width</span></span>: <span class="hljs-number"><span class="hljs-number">320</span></span>, <span class="hljs-attr"><span class="hljs-attr">height</span></span>: <span class="hljs-number"><span class="hljs-number">240</span></span>, <span class="hljs-attr"><span class="hljs-attr">preview</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, <span class="hljs-attr"><span class="hljs-attr">small</span></span>: { <span class="hljs-attr"><span class="hljs-attr">width</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-attr"><span class="hljs-attr">height</span></span>: <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-attr"><span class="hljs-attr">preview</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }</code> </pre><br>  Those.  in addition to the original, three copies of it will also be sent to the server.  What for?  My opinion is this: if you can transfer the load from the server to the client - do it.  The server should remain only minimal validation of incoming data. <br><br>  The upload function also returns an xhr-shaped object, i.e.  it implements some of the properties and methods of XMLHttpRequest, such as: <br><br><ul><li>  <b>status</b> - HTTP status code </li><li>  <b>statusText</b> - HTTP status text </li><li>  <b>responseText</b> - server response </li><li>  <b>getResponseHeader</b> (name) - get server response header </li><li>  <b>getAllResponseHeaders</b> () - get all headers </li><li>  <b>abort</b> () - cancel download </li></ul><br>  Although HTML5 can download files with a single request, the standard Flash engine allows loading only one at a time.  In addition, loading all at once is not a very good idea - the user may change his mind. <br><br>  So, the xhr that the upload returned is actually proxyXHR.  Its methods and properties reflect the state for the file that is currently being loaded.  If the user decides to cancel the download, then the action will be performed for the file that is currently being loaded. <br><br><br><br><h4>  Epilogue </h4><br>  Finally, I want to show you a small example of loading files with drag'n'drop: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"el"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dropzone"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">if</span></span></span><span class="actionscript">( FileAPI.support.dnd ){ </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">// ,     var el = document.getElementById("el"); //     Drag'n'Drop FileAPI.event.dnd(el, function (over){ //  ,    enter/leave   if( over ){ el.classList.add("dropzone_hover"); } else { el.classList.remove("dropzone_hover"); } }, function (dropFiles){ //    FileAPI.upload({ url: "/upload", files: { attaches: dropFiles }, complete: function (err, xhr){ if( !err ){ //   } } }); }); } </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  <strong>The library is on github, bug reports and pull requests are welcome.</strong> <br><br><h6>  useful links </h6>  - <a href="https://github.com/mailru/FileAPI">https://github.com/mailru/FileAPI</a> ( <a href="http://mailru.github.com/FileAPI/">demo</a> ) <br>  - <a href="https://github.com/mailru/">Mail.ru github</a> (Tarantool, fest and more) <br>  - <a href="http://caniuse.com/">input [type = "file" multiple]</a> <br>  - <a href="http://caniuse.com/">File API support</a> <br>  - <a href="https://developer.mozilla.org/en-US/docs/DOM/FileReader">FileReader</a> <br>  - <a href="https://developer.mozilla.org/en-US/docs/DOM/window.URL.createObjectURL">URL.createObjectURL</a> , <a href="https://developer.mozilla.org/en-US/docs/DOM/window.URL.revokeObjectURL">URL.revokeObjectURL</a> <br>  - <a href="https://developer.mozilla.org/en-US/docs/DOM/XMLHttpRequest">XMLHttpRequest</a> <br>  - <a href="https://developer.mozilla.org/en-US/docs/DOM/XMLHttpRequest/FormData">FormData</a> <br><br></div><p>Source: <a href="https://habr.com/ru/post/159587/">https://habr.com/ru/post/159587/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../159569/index.html">List of companies that own domains with keywords</a></li>
<li><a href="../159573/index.html">Statistics on Android devices (2012, November)</a></li>
<li><a href="../159575/index.html">Battle server for Django application: Ubuntu Server 10.04 LTS + django 1.4 + nginx + gunicorn</a></li>
<li><a href="../159577/index.html">Google asks to vote against censorship and restrictions on the Internet</a></li>
<li><a href="../159579/index.html">Linux Administration Olympiad on November 27th</a></li>
<li><a href="../159589/index.html">Deadline theses</a></li>
<li><a href="../159591/index.html">Google promises to return December in Android 4.2 "soon"</a></li>
<li><a href="../159593/index.html">Windows family turns 27 years old</a></li>
<li><a href="../159595/index.html">Reddit users have discovered how to activate Windows 8</a></li>
<li><a href="../159597/index.html">ExQuilla: Thunderbird + Exchange 2010</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>