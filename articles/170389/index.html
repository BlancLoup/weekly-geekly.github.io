<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Basics of thin allocation of volumes on storage systems (or anniversary 3PAR thin provisioning)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This year marks 10 years since the sale of the first 3PAR storage system with Thin Provisioning technology. And despite the fact that the technology h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Basics of thin allocation of volumes on storage systems (or anniversary 3PAR thin provisioning)</h1><div class="post__text post__text-html js-mediator-article">  This year marks 10 years since the sale of the first 3PAR storage system with Thin Provisioning technology.  And despite the fact that the technology has become very popular and in demand, I still haven‚Äôt managed to come up with an sensible description of how it works at a low level.  In this article I will try to highlight the most "dark", in my opinion, the sides of thin provisioning - the technical basis of this technology.  That is, how exactly the host interacts with the storage system.  These technologies are no longer exclusive to 3PAR, since they are now industry standards, but since the thin provisioning technology first appeared in 3PAR, I will allow myself to give all the laurels to these arrays. <br><a name="habracut"></a><br><br><h4>  Why thin provisioning is needed </h4><br>  For those who missed the previous 10 years, I still briefly remind you what thin provisioning is and what it is for, and the rest can, with a clear conscience, skip this section. <br><br>  Thin provisioning is a storage virtualization technology that increases the efficiency of storage system resources.  This technology is necessary to reduce the use of disk space, which is not directly used for storing application data.  In particular, file systems are never 100% full under normal conditions.  However, you always need to have a certain amount of free space to ensure the normal functioning of the file system and to ensure readiness for data growth.  This is not actually used space is allocated for all logical volumes on the storage system.  Logical volumes, the disk space for which is allocated in full at the time of creation on the storage system, are called ‚Äútoast‚Äù.  Such a model of using disk resources appeared together with the first data storage devices and is still alive. <br><img src="https://habrastorage.org/storage2/ba8/cbf/896/ba8cbf8962ae2a7be70cb78d87591d5a.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It has the following disadvantages: <br><ul><li>  Space allocated to one logical volume (but not used) cannot be used by another volume.  With the rapid growth of the volume of data on one logical volume, sooner or later we will rest on its size and the fact that there is a lot of unused disk space on other logical volumes will not help us.  That is, the free disk space is not represented by a common pool from which any volume can take capacity if necessary, but is in fact rigidly tied to each volume.  Besides the fact that it is terribly wasteful, this scheme is also inconvenient if you need to redistribute the capacity between the volumes. </li><li>  Since it is often very difficult to predict the growth of application data, it is usually the size of thick volumes that is chosen with a substantial margin.  According to various studies, the utilization rate of storage systems with thick volumes ranges from 30 to 50 percent.  However, disk space not used for application data costs a certain amount of money that could be spent on much more useful things. </li><li>  When replicating or using snapshots on thick volumes, the disk array works with unused host blocks, as well as with used ones.  Although during replication it would be possible to copy only occupied blocks, and when using snapshots, do not copy (see copy-on-write) the free block into snapshot, but simply mark it not occupied there.  This replication technology is implemented in 3PAR arrays. </li></ul><br><img src="https://habrastorage.org/storage2/b7d/a3a/936/b7da3a93631ab550dff9acd56041cb43.png"><br><br>  To solve such problems, thin provisioning and thin reclamation were invented, which we will discuss in more detail. <br><br><h4>  How thin provisioning works </h4><br>  The concept of thin provisioning is simple and consists of the following: <br><img align="right" src="https://habrastorage.org/storage2/f48/9e2/089/f489e208984b706cca616f7adabf0590.png"><br><ul><li>  At the time of creating a logical volume (LUN) on the disk array does not fully allocate the entire volume of the volume.  The LUN LBA -&gt; Backend physical address matching table is initialized.  The storage system administrator indicates the maximum possible size of the volume and the volume fullness threshold at which it will receive a warning. </li><li>  The allocation of new data blocks for a logical volume occurs as the volume is filled. </li><li>  When the server releases the data blocks, it must report the freed blocks to the storage system in order to return them to the common pool.  The technology is called thin reclamation and is described below. </li><li>  When the server requests the size of the volume (SCSI Read Capacity), the storage system gives the maximum size of the volume that the storage administrator has installed. </li><li>  The sum of the maximum volumes of all volumes on a storage system may exceed the physically available space on the storage system. </li></ul><br><img src="https://habrastorage.org/storage2/063/0ff/e79/0630ffe79b98f4eb909ce712620f0869.png"><br><br>  Based on the foregoing, it is easy to provide a schema for the work of thin provisioning.  When the storage system receives a SCSI Write command (encapsulated on an FC, SAS, iSCSI, etc.) stack, it allocates another piece of data and writes data from SCSI Write there.  In the case of 3PAR, blocks are allocated in the size of 16K. <br><br><h4>  How thin reclamation works </h4><br>  And now we will discuss much more interesting and non-obvious points - how the host interacts with the storage system to return the free disk space to the common pool.  The interaction between the host and the storage system is an extremely important nuance, since only the host knows which blocks can be deleted and which not.  The thin reclamation technology was first implemented on 3PAR arrays and today is an industry standard approved by the International Committee for Information Technology Standardization (INCITS).  The document is called T10 SBC-3 and expands the SCSI standard with new commands to interact with storage systems (these commands were added in the eighteenth revision of the document on February 23, 2009).  There is a similar standard for ATA / SATA devices. <br><br>  To implement thin provisioning, the standard provides for 3 SCSI commands: <br><ol><li>  UNMAP </li><li>  WRITE SAME </li><li>  GET LBA STATUS </li></ol><br>  The standard requires all storage systems with thin provisioning to support at least the UNMAP command or the WRITE SAME command with the unmap bit.  Consider the API described by the protocol. <br><br><h6>  UNMAP </h6><br>  Tells the storage system to release one or more Logical Block Address (LBA) sequential groups.  The storage system should mark LBA data as free (unmapped, in terms of SCSI), free up space on the backend and background process to erase the data that was previously there in case these blocks are then allocated to another host.  In this command, only service information is transmitted in the form of a set of pairs consisting of ‚ÄúLBA Address‚Äù and ‚ÄúNumber of Logical Blocks‚Äù. <br><img src="https://habrastorage.org/storage2/4da/2b3/479/4da2b34794aa960fc5d1455d1d2d19be.png"><br><br><h6>  WRITE SAME </h6><br>  If for some reason the host does not want to use the UNMAP command, it can get a similar effect with the WRITE SAME command.  The unmap bit field is provided for this.  If the WRITE SAME command with the unmap bit set comes to the array with thin provisioning and the volume on the array is thin, then the array will do the same as in the case of the UNMAP command.  It differs from the UNMAP (42h) command in that using WRITE SAME it is not possible to specify a large number of blocks for release.  You can specify only one pair of "LBA Address" and "Number of Logical Blocks". <br><br>  Also, do not forget that the WRITE SAME command is primarily a command for recording data.  In the event that the unmap bit is not set, the storage system does not support thin provisioning, or the volume is thick, then the usual write operation will be performed using the specified LBA.  From this it follows that in these cases, SCSI READ must return exactly the data that was written there.  Here, some manufacturers like the same Hewlett are cunning, and instead of sequentially writing data of the same type (for example, zeros), these blocks are marked in the logical volume metadata as allocated but ‚Äúfilled with zeros‚Äù.  This technology is called zero detection. <br><img src="https://habrastorage.org/storage2/5d6/f18/c14/5d6f18c1416ae821ce927234a13f85dd.png"><br><br><h6>  GET LBA STATUS </h6><br>  This is a service operation (device-specific) and it uses the command code SERVICE ACTION IN (9Eh).  It allows you to find out the server: <br>  1. Does volume thin provisioning. <br>  2. The status of a specific unit on the storage system (whether real capacities are allocated for it on the backend or not). <br>  3. Granularity thin provisioning for volume. <br>  4. Limits (alarm level and maximum volume). <br><br>  The command is very useful, for example, for background searches from the host side for blocks allocated on an array but not used by the host for data storage or when moving from thick to thin volumes. <br><img src="https://habrastorage.org/storage2/a34/59d/867/a3459d86723e49908f44dd6c59262d4c.png"><br><br><h4>  As a conclusion. </h4><br>  I am very glad that you have read to the last lines!  Unfortunately, I didn‚Äôt say anything about file storage, database and OS support for thin provisioning, I didn‚Äôt tell when it makes sense to use it at all - and this is very interesting in my opinion, but unfortunately a voluminous topic.  Maybe I will come back to her later. </div><p>Source: <a href="https://habr.com/ru/post/170389/">https://habr.com/ru/post/170389/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../170371/index.html">IPoE problem</a></li>
<li><a href="../170373/index.html">180 VPS history</a></li>
<li><a href="../170375/index.html">Creating your own control based on TabControl in C #</a></li>
<li><a href="../170379/index.html">About great bikes, or why sometimes you need to write from scratch</a></li>
<li><a href="../170385/index.html">C # console to run simple "scripts"</a></li>
<li><a href="../170391/index.html">Unusual reflections on intellectual property rights</a></li>
<li><a href="../170397/index.html">W3 conference. Video broadcast. Second day</a></li>
<li><a href="../170401/index.html">Moving time on the fly for JVM</a></li>
<li><a href="../170403/index.html">FaceCode. Plugin for SublimeText2 (Linux OS)</a></li>
<li><a href="../170405/index.html">Announcement of intellectual property value at registration</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>