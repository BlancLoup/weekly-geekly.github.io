<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Restrictions (—Åonstraints) PostgreSQL: exclude, partial unique, pending restrictions, etc.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Data integrity is easy to break. It so happens that the value 0 falls into the price field due to an error in the application code (news pops up perio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Restrictions (—Åonstraints) PostgreSQL: exclude, partial unique, pending restrictions, etc.</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/4da/0ab/41c/4da0ab41c8da4eb8b03df7f64a7dbd38.jpg" align="left" width="300">  Data integrity is easy to break.  It so happens that the value 0 falls into the price field due to an error in the application code (news pops up periodically, as in a particular online store, goods were sold for $ 0).  Or it happens that the user was deleted from the table, but some data about him remained in other tables, and this data got out in some kind of interface. <br><br>  PostgreSQL, like any other DBMS, is able to do some checks when inserting / changing data, and it is imperative to be able to use it.  Let's see what we can check: <br><br><h2>  1. Custom subtype via DOMAIN keyword </h2><a name="habracut"></a><br>  In PostgreSQL, you can create your own type based on some int or text with an additional check of some things: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DOMAIN</span></span> us_postal_code <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHECK</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">VALUE</span></span> ~ <span class="hljs-string"><span class="hljs-string">'^\d{5}$'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUE</span></span> ~ <span class="hljs-string"><span class="hljs-string">'^\d{5}-\d{4}$'</span></span> );</code> </pre> <br>  We create the type us_postal_code, in which we regularly check various spellings of it.  Now no one can go there by mistake to write ‚ÄúBarmaleev Street‚Äù, there will only be an index: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, email <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, postal_code us_postal_code ) ;</code> </pre><br>  In addition, it improves the readability of the code, as the type itself explains what lies in it, unlike faceless integer or text. <br><br><h2>  2. Check (especially relevant for checking jsonb and hstore) </h2><br>  Above, we used us_postal_code to use the CHECK operator.  You can write exactly the same in the CREATE TABLE construct. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, email <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, postal_code us_postal_code, <span class="hljs-keyword"><span class="hljs-keyword">CHECK</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">length</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">length</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) &lt;= <span class="hljs-number"><span class="hljs-number">300</span></span>) ) ;</code> </pre><br>  Or in the table with the goods, you can put a check (price&gt; 0), then you will not sell laptops for 0 rubles.  Or you can write a store and use check (superCheckFunction (price)), and check out a bunch of logic in this store. <br><br>  By the way, the varchar (100) type is the same as the text type with an additional check in length. <br>  You have to understand that check happens every time you insert or update, so if you have 100,500 records per second in your table, then you probably shouldn't do checkout. <br><br>  It is important to check with checks universal data types, such as jsonb or hstore, because there you can cram anything.  You can check for the existence of some keys in json or that their value corresponds to what should be there. <br><br><h2>  3. Check for uniqueness, both simple and partial. </h2><br>  A simple check that email from different users should be different: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, email <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, postal_code us_postal_code, deleted <span class="hljs-built_in"><span class="hljs-built_in">boolean</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span>(email) ) ;</code> </pre><br>  However, sometimes you need to check the uniqueness not for the entire table, but only, for example, for users with a certain status. <br><br>  Instead of a simple UNIQUE, you can add such a unique index: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> users_unique_idx <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span>(email) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> deleted = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;</code> </pre><br>  Then the uniqueness of the email will be checked only for undeleted users.  In where you can insert any conditions. <br><br>  It should also be noted that it is possible to create unique indices for two or more fields at once, i.e.  check the unique combination. <br><br><h2>  4. EXCLUDE </h2><br>  Using the EXCLUDE operator, you can make another kind of uniqueness.  The fact is that in the world there are a lot of data types, both embedded and added through extensions.  For example, there is an ip4r data type, with its help you can store a range of ip-addresses in one field. <br><br>  And let's say you need to store non-overlapping ranges in the table.  In general, you can check whether the two ranges intersect using the &amp;&amp; operator; for example, SELECT '127.0.0.0/24' &amp;&amp; '127.0.0.1/32' will return true. <br><br>  As a result, we do simply: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> ip_ranges ( ip_range ip4r, <span class="hljs-keyword"><span class="hljs-keyword">EXCLUDE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> gist (ip_range <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> &amp;&amp;) );</code> </pre><br>  And then when inserting / updating, postgres will look at every line, if it does not intersect with the inserted line (i.e., whether the use of the &amp;&amp; operator returns true).  Thanks to the gist index, this check is very fast. <br><br><h2>  5. NOT NULL </h2><br>  Everything is clear, the column cannot be NULL.  Often (but not necessarily) comes in conjunction with DEFAULT. <br><br>  For example: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, email <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, postal_code us_postal_code, is_married <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span>(email) ) ;</code> </pre><br>  When adding a new column with not null to an existing table, you need to be careful.  The fact is that PostgreSQL adds an ordinary column where null is permissible instantly, even if the table is very large, for example, tens of millions of rows.  Because it does not need to physically change the data on the disk, null in postgres does not take up space.  However, if you add the column name text not null default 'Vasya', then after the fact it is useful to do update each line, and this can take a long time, which may be unacceptable in some situations. <br><br>  Therefore, such columns are often added to huge tables in two stages, i.e.  at first, the new column data is filled in with packs, and only then they put it not null. <br><br><h2>  6. Primary key, i.e.  primary key </h2><br>  Since this is a primary key, it must be unique and cannot be empty.  In general, in PostgreSQL, PRIMARY KEY works like a combination of UNIQUE and NOT NULL. <br><br>  In other databases, PRIMARY KEY does other things, for example, if I'm not mistaken, in MySQL (Innodb), the data is also automatically clustered around PK to speed up access to this field.  (By the way, by the way, this can also be done, but manually, with the CLUSTER command. But usually this is not necessary) <br><br><h2>  7. FOREIGN KEY </h2><br>  For example, you have a table <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> items ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> varhar(<span class="hljs-number"><span class="hljs-number">1000</span></span>), status_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> );</code> </pre><br>  and table with statuses <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> status_dictionary ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, status_name <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) );</code> </pre><br>  You can indicate to the database that the status_id column matches the Id from the status_dictionary table.  For example: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> items ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> varhar(<span class="hljs-number"><span class="hljs-number">1000</span></span>), status_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> status_dictionary(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) );</code> </pre><br>  Now you can write only null or Id from the status_dictionaries table in status_id, and nothing else. <br><br>  You can also do this in two fields: <br><br><pre> <code class="sql hljs"> FOREIGN KEY (a,b) REFERENCES other_table(x,y);</code> </pre><br>  Again, when inserting, there is some overhead, because with each insertion, the DBMS has to trap a lot of things.  Therefore, with (very) intensive insertion, you probably should not abuse the use of the Foreign key. <br><br><h2>  8. DEFERRABLE </h2><br>  If you need to postpone checking for performance for performance, you can mark the constraints with the keyword DEFERRABLE. <br><br>  They are of different kinds, for example, if you make UNIQUE (email) DEFERRABLE INITIALLY DEFERRED, then inside the transaction you can write <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINTS</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">DEFERRED</span></span></code> </pre><br>  And then all checks will be postponed and in fact will occur only before the word commit <br>  This will work for UNIQUE, PRIMARY KEY and REFERENCES, but will not work for NOT NULL and CHECK. </div><p>Source: <a href="https://habr.com/ru/post/311586/">https://habr.com/ru/post/311586/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../311576/index.html">The history of creating an application for finding nannies in Ireland and an electronic waiter</a></li>
<li><a href="../311578/index.html">Processing voice requests in Telegram using Yandex SpeechKit Cloud</a></li>
<li><a href="../311580/index.html">New management features: Intel RealSense and GestureWorks Fusion</a></li>
<li><a href="../311582/index.html">Twelve Useful Chrome DevTools Tips</a></li>
<li><a href="../311584/index.html">About hacking servers FirstVDS</a></li>
<li><a href="../311588/index.html">What to do so that the organizer of the conference wants you</a></li>
<li><a href="../311590/index.html">Dependency Injection with Scala validation using language tools</a></li>
<li><a href="../311592/index.html">Chat bots, and how will Microsoft help us with this?</a></li>
<li><a href="../311594/index.html">Keeping up with the times: Using JWT in ASP.NET Core</a></li>
<li><a href="../311596/index.html">Why traditional anti-money theft protection in RBS systems is vulnerable</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>