<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JavaParser. Lying code easily and naturally</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the world there are many cool little libraries that are not famous, but very useful. The idea is to slowly acquaint Habr with such things. Today I ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JavaParser. Lying code easily and naturally</h1><div class="post__text post__text-html js-mediator-article"><p>  In the world there are many cool little libraries that are not famous, but very useful.  The idea is to slowly acquaint Habr with such things.  Today I will tell about JavaParser. </p><br><p>  JavaParser is a set of tools for parsing, analyzing, transforming and generating Java code.  In other words, if you need to take a piece of javakod and somehow conquer it with improvised methods and without the need for special knowledge, this lib is the very thing. </p><br><p>  Somewhere in the middle of an article, you SUDDENLY can realize what a nightmare and horror you can create with this, and you can‚Äôt wait to finish reading the text and pour me angry comments.  Do not hold back, it is not necessary - immediately skrolte to the very bottom and pour out the soul :) </p><br><p><img src="https://habrastorage.org/webt/1f/zi/lg/1fzilg6zytgqpwoh4ofig8m1fiw.png"><br></p><a name="habracut"></a><br><p>  The code is distributed <a href="https://github.com/javaparser">to the githaba</a> under the Apache, LGPL and GPL licenses.  The authors have made a relatively decent site for the project, and even filed a <a href="https://leanpub.com/javaparservisited">small book</a> distributed completely free of charge - which somehow confirms the seriousness of their intentions. </p><br><p>  I exchanged a couple of questions with the authors on FOSDEM, the authors leave an impression of smart and adequate people.  This article is based <a href="https://fosdem.org/2018/schedule/event/code_how_to_generate_transform_analyze_refactor_java_code/">on their report</a> . </p><br><p>  What does this do?  Initially, it turns the Java code into AST (abstract syntax tree) - parsing.  Secondly, it can take an already ready AST and turn it into a Java code - unparsing. </p><br><p>  What is the ambush, and why do we need libraries at all?  Look: </p><br><pre><code class="java hljs">String habraPostText = <span class="hljs-string"><span class="hljs-string">"  , ,   "</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeHabraPost</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String habraPostText)</span></span></span><span class="hljs-function"> </span></span>{ habraPostText = <span class="hljs-string"><span class="hljs-string">", .   ."</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeHabraPost</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ habraPostText = <span class="hljs-string"><span class="hljs-string">", .   ."</span></span>; }</code> </pre> <br><p>  For both of these methods, the AST in JavaParser will be the same.  A specific node in AST does not know where exactly <code>habraPostText</code> came <code>habraPostText</code> . </p><br><p>  Or for example, we will have methods <code>aMethod(int foo)</code> and <code>aMethod(String foo)</code> , inside of which the variable is printed using <code>System.out.println</code> .  AST will also be the same. </p><br><p>  Therefore, in JavaParser there is a so-called <code>symbol solver</code> , which for each piece of AST calculates specific corresponding pieces of the source code.  They have it in a <a href="https://github.com/javaparser/javasymbolsolver">separate project on GitHub called JSS</a> . </p><br><p>  There is code that JavaParser can calculate without JSS.  For example, if we pull the getter on the field, then the link to the called field is encoded directly into the code.  On the other hand, if there is a method in which the return type is somehow cleverly calculated, then here you need to connect heavy artillery, which is JSS.  Manually writing such a thing would be very difficult. </p><br><p>  Now, why all this may be necessary.  For example, you want to automate the generation of garbage code (hello, Lombok!).  Or to write a transpiler, which will turn the code in some scripting language invented by you into Java. </p><br><p>  The code that does this is very simple.  Let's do the class Habrapost: </p><br><pre> <code class="java hljs">CompilationUnit cu = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CompilationUnit(); cu.setPackageDeclaration(<span class="hljs-string"><span class="hljs-string">"ru.habrahabr.hub.java.examples.javaparser"</span></span>); ClassOrInterfaceDeclaration habraPost = cu.addClass(<span class="hljs-string"><span class="hljs-string">"HabraPost"</span></span>); habraPost.addField(<span class="hljs-string"><span class="hljs-string">"String"</span></span>, <span class="hljs-string"><span class="hljs-string">"title"</span></span>); habraPost.addField(<span class="hljs-string"><span class="hljs-string">"String"</span></span>, <span class="hljs-string"><span class="hljs-string">"text"</span></span>);</code> </pre> <br><p>  And now we add a constructor that forces these fields to be filled: </p><br><pre> <code class="java hljs">habraPost.addConstructor(Modifier.PUBLIC) .addParameter(<span class="hljs-string"><span class="hljs-string">"String"</span></span>, <span class="hljs-string"><span class="hljs-string">"title"</span></span>) .addParameter(<span class="hljs-string"><span class="hljs-string">"String"</span></span>, <span class="hljs-string"><span class="hljs-string">"text"</span></span>) .setBody(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BlockStmt() .addStatement(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExpressionStmt(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AssignExpr( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FieldAccessExpr(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ThisExpr(), <span class="hljs-string"><span class="hljs-string">"title"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NameExpr(<span class="hljs-string"><span class="hljs-string">"title"</span></span>), AssignExpr.Operator.ASSIGN))) .addStatement(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExpressionStmt(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AssignExpr( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FieldAccessExpr(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ThisExpr(), <span class="hljs-string"><span class="hljs-string">"text"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NameExpr(<span class="hljs-string"><span class="hljs-string">"text"</span></span>), AssignExpr.Operator.ASSIGN))));</code> </pre><br><p>  Now we will generate a boilerplate for setters: </p><br><pre> <code class="java hljs">habraPost.addMethod(<span class="hljs-string"><span class="hljs-string">"getTitle"</span></span>, Modifier.PUBLIC).setBody( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BlockStmt().addStatement( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReturnStmt(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NameExpr(<span class="hljs-string"><span class="hljs-string">"title"</span></span>)))); habraPost.addMethod(<span class="hljs-string"><span class="hljs-string">"getText"</span></span>, Modifier.PUBLIC).setBody( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BlockStmt().addStatement( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReturnStmt(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NameExpr(<span class="hljs-string"><span class="hljs-string">"text"</span></span>))));</code> </pre> <br><p>  And now let's print our class to the console: </p><br><pre> <code class="java hljs">System.out.println(cu.toString());</code> </pre> <br><p>  The output will be something like: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> ru.habrahabr.hub.java.examples.javaparser; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HabraPost</span></span></span><span class="hljs-class"> </span></span>{ String title; String text; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HabraPost</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String title, String text)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.title = title; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.text = text; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTitle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> title; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } }</code> </pre> <br><p>  In addition, you can immediately do some research code.  For example, to study its quality and arrange it as an autotest. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">long</span></span> wtfs = getNodes(myAPI, MethodDeclaration.class).stream() .filter(m -&gt; m.getParameters().size &gt; <span class="hljs-number"><span class="hljs-number">10</span></span>) .count(); System.out.println(String.format(<span class="hljs-string"><span class="hljs-string">" ,     : %d"</span></span>, wtfs));</code> </pre> <br><p>  I will not bump into complex examples, since everything is visible on the API.  The only really unusual feature is that you can call JSS and delve into types.  For example, let's find a class that inherits the maximum number of other classes (recursively): </p><br><pre> <code class="java hljs">ResolvedReferenceTypeDeclaration c = getNodes(myAPI, ClassorInterfaceDeclaration).stream() .filter(c -&gt; !c.isInterface()) .map(c -&gt; c.resolve()) <span class="hljs-comment"><span class="hljs-comment">// JSS! .sorted(Comparator.comparingInt(o -&gt; -1 * o.getAllAncestors().size))) .findFirst().get();</span></span></code> </pre> <br><p>  As a result, this lib can be used for automatic refactoring.  To do this, you may not have advanced refactoring inside the IDE, but limit yourself solely to the capabilities of JavaParser.  Let's do refactoring: replacing an older method call with a newer one. </p><br><p>  Remember this story? </p><br><p><img width="400" src="https://habrastorage.org/webt/bk/cj/ln/bkcjln-nw1e0eeislliu5h4kjb0.png"><br></p><br><p>  Suppose we have a method <code>checkMegamozg(Boolean moderatorInAGoodMood)</code> , which <a href="https://habrahabr.ru/users/boomburum/" class="user_link">Boomburum</a> runs in its brain 666 times a day.  You need to turn it into <code>checkHabrahabr(Boolean moderatorInAGoodMood)</code> . </p><br><p>  First we look for the desired method: </p><br><pre> <code class="java hljs">getNodes(myAPI, MethodCallExpr.class).stream() .filter(m -&gt; m.resolveInvokedMethod()). getQialifiedSignature() .equals(<span class="hljs-string"><span class="hljs-string">"ru.habrahabr.Habr.checkMegamozg(java.lang.Boolean)"</span></span>)) .forEach(m -&gt; m.replace(replaceCallsToMegamozg(m)));</code> </pre> <br><p>  Now how exactly the replacement will look like: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodCallExpr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceCallsToMegamozg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ MethodCallExpr newMethodCall = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodCallExpr( methodCall.getScope.get(), <span class="hljs-string"><span class="hljs-string">"checkHabrahabr"</span></span>); newMethodCall.addArgument(methodCall.getArgument(<span class="hljs-number"><span class="hljs-number">0</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newMethodCall; }</code> </pre> <br><p>  Moreover, if somewhere inside the methods there are comments (hello, <a href="https://habrahabr.ru/users/lany/" class="user_link">lany</a> !), JavaParser tries not to lose them.  This is a terribly unpleasant task and the authors are very hovering about this topic. </p><br><p>  As you can see, this lib is like a small Swiss knife, simple and relatively reliable.  In the future, small features such as the built-in template language will be added so that Java classes can not be generated manually, but by loading them from a file and replacing the <code>${}</code> . </p><br><p>  Look like that's it.  Put likes, subscribe, and be sure to tell us what you think about this lib!  In addition, you can order me a mini-review of another library - the best offers will turn into habroposta. </p><br><blockquote>  Minute advertising.  As you probably know, we do conferences.  The closest ones are <a href="http://jbreak.ru/">JBreak 2018</a> and <a href="https://jpoint.ru/">JPoint 2018</a> .  You can come there and chat live with the developers of various modern technologies, for example, there will be <a href="https://2018.jbreak.ru/speakers/6v9tls2dwwae4s6gcs4kkk/">Simon Ritter</a> - Deputy CTO from Azul Systems.  In the same place you can meet c <a href="https://2018.jbreak.ru/speakers/7fuk0541rsoqggsgsicsi0/">Victor Gamow</a> from "Debriefing" and a bunch of other interesting people (and you can also cross with idlers like me).  In short, come in, we are waiting for you. </blockquote></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/348710/">https://habr.com/ru/post/348710/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348698/index.html">Your 5 kopecks: Wi-Fi today and tomorrow</a></li>
<li><a href="../348702/index.html">The biggest IT party in the Urals - the DUMP-2018 conference - will be held on April 13 in Yekaterinburg</a></li>
<li><a href="../348704/index.html">3D engine written in MS Excel formulas</a></li>
<li><a href="../348706/index.html">Atlassian User Group Ufa - the first pancake is not lumpy</a></li>
<li><a href="../348708/index.html">Atmosphere or pain: how to choose music for a computer game</a></li>
<li><a href="../348712/index.html">Translation of the book "Social Architecture": Trademarks for open source projects</a></li>
<li><a href="../348714/index.html">The principle of saving fuel</a></li>
<li><a href="../348716/index.html">We calculate the collective intelligence of Habr (and any other organization of people)</a></li>
<li><a href="../348718/index.html">JavaScript ES6 - spread (syntax) syntax</a></li>
<li><a href="../348720/index.html">Let's do it quickly: voice bot on Dialogflow and Voximplant</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>