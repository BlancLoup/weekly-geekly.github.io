<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hooks are easy (part 3)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Somehow it happened that I had already written several articles about hook libraries on Habr√©. The first was about the general principles and implemen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hooks are easy (part 3)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/ad3/802/710/ad3802710ec84a344d96f0996768959c.jpg" alt="image"><br><br>  Somehow it happened that I had already written several articles about hook libraries on Habr√©.  <a href="https://habrahabr.ru/company/infopulse/blog/140456/">The first</a> was about the general principles and implementation based on Detours, the <a href="https://habrahabr.ru/company/infopulse/blog/213309/">second</a> about the cheaper (but no less functional) madCodeHook library.  Today I will talk about another option - <a href="http://www.nektra.com/products/deviare-api-hook-windows/">Deviare</a> library from Nektra.  ‚ÄúAnother exactly the same library for hooks?‚Äù You ask.  "The same, but not so" - I will answer.  Deviare has several features that distinguish it from both Detours and madCodeHook and make it in some cases much more useful. <br><a name="habracut"></a><br><h5>  <b>The library is distributed under a double license - GPL \ commercial</b> . </h5>  For open source projects, she lives on <a href="https://github.com/nektra/Deviare-InProc/">GitHub</a> , and for those who need support and the right to embed library code in closed products, welcome to the official website. That is, yes, you can directly take and read the library code, pick it up from GitHub and embed it in your open-source project right now without paying a penny to anyone.  Miracle not available for Detours and madCodeHook.  I must say that the project was closed for a long time, but then Nektra decided that it was necessary to be somehow closer to the people. <br><br><h5>  <b>On the basis of the library made a powerful product <a href="http://nektra.com/products/spystudio-api-monitor/">SpyStudio</a></b> </h5>  Before writing any code for hooks, you can simply run this utility and see what it is capable of.  On the basis of Detours and madCodeHook, too, of course, much has been done, but there is somehow no similar software from the authors of the libraries themselves. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  <b>The authors put a bunch of practical examples of using hooks in their blog.</b> </h5>  Here you and <a href="http://blog.nektra.com/main/2013/06/26/sql-server-interception-and-sql-injection-attacks-prevention/">SQL Server hooks</a> to prevent SQL injection, and <a href="http://blog.nektra.com/main/2013/07/23/instrumenting-direct3d-applications-to-capture-video-and-calculate-frames-per-second/">video recording from games</a> drawn via DirectX, and <a href="https://github.com/nektra/Direct3D-Invisible-Walls">cheats</a> , and <a href="http://blog.nektra.com/main/2012/06/13/controlling-the-speed-of-youtube-flash-html5-and-desktop-videos-with-deviare-hooks/">changes in the speed of the player in the browser</a> .  You read - and it becomes immediately clear why you can use hooks. <br><br><h5>  <b>In addition to classic C ++, a COM component is offered that allows you to install hooks from anywhere (C #, Python, VB, Delphi, etc.)</b> </h5>  Yes, you can finally start using hooks without understanding what a pointer to a pointer to an array of pointers is. <br><br><h5>  <b>Hooks can be hung not only on native functions or methods of COM objects, but also on .NET methods</b> </h5>  This feature seems to me not so lethal, because in .NET it seems to be quite good with meta-information and reflection, which means that it was necessary for anyone - he knew how to do it himself.  But so, as a cherry on the cake - why not. <br><br><h5>  <b>The library has long gone through all the "childhood" disease</b> </h5>  Today, it is used by companies from the Fortune 500, and partnership with VmWare allows you to make, <a href="http://blog.nektra.com/main/2013/11/05/nektra-and-vmware-are-collaborating-to-simplify-application-virtualization-packaging/">for example</a> , portable versions of installed applications. <br><br>  I‚Äôm not going to paint kilometers of code here (it‚Äôs silly to do it for an open source library with <a href="https://github.com/nektra/Deviare-InProc/tree/master/Samples">examples</a> on GitHub).  Well, purely so, well. <br><br>  Injection of your library into someone else's process: <br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"NktHookLib.h"</span></span></span><span class="hljs-meta"> NktHookLibHelpers::InjectDllByPidW(dwPid, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">L"myDll.dll"</span></span></span><span class="hljs-meta">);</span></span></code> </pre> <br><br>  Setting the hook to the function: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"NktHookLib.h"</span></span></span><span class="hljs-meta"> typedef int (WINAPI *lpfnMessageBoxW)(__in_opt HWND hWnd, __in_opt LPCWSTR lpText, __in_opt LPCWSTR lpCaption, __in UINT uType); static int WINAPI Hooked_MessageBoxW(__in_opt HWND hWnd, __in_opt LPCWSTR lpText, __in_opt LPCWSTR lpCaption, __in UINT uType); static struct { SIZE_T nHookId; lpfnMessageBoxW fnMessageBoxW; } sMessageBoxW_Hook = { 0, NULL }; int WinMainCRTStartup() { CNktHookLib cHookMgr; HINSTANCE hUser32Dll; LPVOID fnOrigMessageBoxW; DWORD dwOsErr; hUser32Dll = NktHookLibHelpers::GetModuleBaseAddress(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">L"user32.dll"</span></span></span><span class="hljs-meta">); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (hUser32Dll == NULL) { ::MessageBoxW(0, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">L"Error: Cannot get handle of user32.dll"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">L"HookTest"</span></span></span><span class="hljs-meta">, MB_OK|MB_ICONERROR); return 0; } fnOrigMessageBoxW = NktHookLibHelpers::GetProcedureAddress(hUser32Dll, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"MessageBoxW"</span></span></span><span class="hljs-meta">); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (fnOrigMessageBoxW == NULL) { ::MessageBoxW(0, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">L"Error: Cannot get address of MessageBoxW"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">L"HookTest"</span></span></span><span class="hljs-meta">, MB_OK|MB_ICONERROR); return 0; } dwOsErr = cHookMgr.Hook(&amp;(sMessageBoxW_Hook.nHookId), (LPVOID*)&amp;(sMessageBoxW_Hook.fnMessageBoxW), fnOrigMessageBoxW, Hooked_MessageBoxW, NKTHOOKLIB_DisallowReentrancy); ::MessageBoxW(0, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">L"This should be hooked"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">L"HookTest"</span></span></span><span class="hljs-meta">, MB_OK); dwOsErr = cHookMgr.Unhook(sMessageBoxW_Hook.nHookId); ::MessageBoxW(0, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">L"This should NOT be hooked"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">L"HookTest"</span></span></span><span class="hljs-meta">, MB_OK); return 0; } static int WINAPI Hooked_MessageBoxW(__in_opt HWND hWnd, __in_opt LPCWSTR lpText, __in_opt LPCWSTR lpCaption, __in UINT uType) { return ::MessageBoxW(hWnd, lpText, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">L"HOOKED!!!"</span></span></span><span class="hljs-meta">, uType); }</span></span></code> </pre><br><br>  But somehow Notepad is launched from Python, in which the hook to the CreateFileW function is hung: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> win32com.client <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ctypes, sys <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> EventHandlers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> NktSpyMgrEvents <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> AuxFunctions <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> sys.version_info.major &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>: warnings.warn(<span class="hljs-string"><span class="hljs-string">"Need Python 3.0 for this program to run"</span></span>, RuntimeWarning) sys.exit(<span class="hljs-number"><span class="hljs-number">0</span></span>) win32com.client.pythoncom.CoInitialize() spyManager = win32com.client.DispatchWithEvents(<span class="hljs-string"><span class="hljs-string">"DeviareCOM.NktSpyMgr"</span></span>, NktSpyMgrEvents) result = spyManager.Initialize() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> result == <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> (<span class="hljs-string"><span class="hljs-string">"ERROR: Could not initialize the SpyManager. Error code: %d"</span></span> % (result)) sys.exit(<span class="hljs-number"><span class="hljs-number">0</span></span>) notepad = StartNotepadAndHook(spyManager) MessageBox = ctypes.windll.user32.MessageBoxW MessageBox(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-string"><span class="hljs-string">"Press OK to end the demo."</span></span>, <span class="hljs-string"><span class="hljs-string">"Deviare Python Demo"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) notepad.Terminate(<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre><br><br>  Good luck with the library! </div><p>Source: <a href="https://habr.com/ru/post/277995/">https://habr.com/ru/post/277995/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277979/index.html">Alternatives to parse.com</a></li>
<li><a href="../277983/index.html">Software Internet gateway for a company not already small (Shorewall, QoS in full width). Part 3</a></li>
<li><a href="../277987/index.html">Go in terms of PHP programmer</a></li>
<li><a href="../277989/index.html">View design pattern in languages ‚Äã‚Äãwith dependent types</a></li>
<li><a href="../277991/index.html">What does the VxRail hyper-convergent system look like? Online demo, functionality, availability to order</a></li>
<li><a href="../277999/index.html">An example of using the inventory and reporting features in System Center Configuration Manager</a></li>
<li><a href="../278001/index.html">Performance and multithreading at the JPoint 2016 Java Conference</a></li>
<li><a href="../278005/index.html">Implementing a stable UART, at a speed of 921600 baud or more, in Verilog language under FPGA</a></li>
<li><a href="../278007/index.html">What mobile devices do public transport passengers prefer?</a></li>
<li><a href="../278009/index.html">Set operations using Google Guava</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>