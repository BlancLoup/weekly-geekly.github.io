<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we did monitoring requests mongodb</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The use of Mongi in production is a rather controversial topic. 
 On the one hand, everything is simple and convenient: put the data, set up replicati...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we did monitoring requests mongodb</h1><div class="post__text post__text-html js-mediator-article"><img width="190" height="300" src="https://habrastorage.org/files/a81/8f9/55c/a818f955c01848deb2bfda48ab837498.png" align="left"><br><p>  The use of Mongi in production is a rather controversial topic. <br>  On the one hand, everything is simple and convenient: put the data, set up replication, we understand how to shard the base with the growth of data.  On the other hand, there are quite a few <a href="https://habrahabr.ru/post/231213/">scary stories</a> , Aphyr in his last <a href="https://aphyr.com/posts/322-jepsen-mongodb-stale-reads">jepsen test</a> did not draw very positive conclusions. </p><br><p>  In fact, it turns out that there are quite a few projects where mongo is the main data repository, and we were often asked about mongodb support per meter.  We spent a long time with this task, because it is much more difficult to make "sensible" monitoring than to just collect some metrics and set up some alerts.  You must first understand the features of the behavior of software to understand exactly which indicators to track. </p><br><p>  Just about the complexity and problems I want to tell you on the example of the implementation of monitoring requests to mongodb. </p><a name="habracut"></a><br><p>  You need to look at any database from three sides: </p><br><ul><li><p>  Monitoring server resources (processor, memory, disk subsystem, network).  There is nothing difficult here; most monitoring systems deal with it quite well. </p><br></li><li><p>  Monitoring of the internal DB (connections, indexes, caches, work with the disk, temporary tables, replication, sorting, ...).  Such metrics are usually needed to understand how to reconfigure the database, what server resources are missing, and what indexes to create. </p><br></li><li><p>  Monitoring requests (how many what, what requests create load, traffic, request times).  In our experience, most problems with the base arise when the load profile / requests from an application change, for example: </p><br><ul><li>  there was some kind of non-optimal request from the application </li><li>  query conditions changed and the index stopped working efficiently </li><li>  the table has grown and sequential reading has ceased to be fast </li></ul><br></li></ul><br><p>  We have so far limited only to monitoring requests. </p><br><p>  Since we are talking about monitoring, we are not interested in each specific request, we rather want to group all requests according to some identical execution plan (for example, postgresql in <a href="https://www.postgresql.org/docs/9.4/static/pgstatstatements.html">pg_stat_statements</a> groups requests according to a real plan). </p><br><p>  For mongodb, the query identifier is the type of query (find, insert, update, findAndModify, aggregate, and others), the database, the collection, and the bson document with the query itself. <br>  For simplicity, we decided that requests can be grouped by replacing all the field values ‚Äã‚Äãfrom the request with "?"  and sorted by field. </p><br><p>  For example, the query: </p><br><pre><code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"country"</span></span>: <span class="hljs-string"><span class="hljs-string">"RU"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"city"</span></span>: <span class="hljs-string"><span class="hljs-string">"Moscow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"$orderby"</span></span>: {<span class="hljs-attr"><span class="hljs-attr">"age"</span></span>: <span class="hljs-number"><span class="hljs-number">-1</span></span>}}</code> </pre> <br><p>  turn into </p><br><pre> <code class="hljs css">{<span class="hljs-attribute"><span class="hljs-attribute">country</span></span>: ?, city: ?, $orderby: {age: ?}}</code> </pre> <br><p>  and then sort by keys </p><br><pre> <code class="hljs cs">{$<span class="hljs-keyword"><span class="hljs-keyword">orderby</span></span>: {age: ?}, city: ?, country: ?}</code> </pre> <br><p>  Most likely, such queries will use the same indices, regardless of specific conditions. </p><br><p>  The next big question is how to get the whole stream of requests in real time. </p><br><p>  The only regular way in mongodb is <a href="https://docs.mongodb.com/manual/administration/analyzing-mongodb-performance/">profiler</a> .  He writes statistics for each request in a limited collection (capped collection).  The profiler can record either only slow requests (if the execution time is longer than the time specified in <a href="https://docs.mongodb.com/manual/reference/configuration-options/">slowOpThresholdMs</a> ) or record absolutely all requests.  In the second case, the performance of the mongodb itself can subside. </p><br><p>  The advantages of this approach is to include very detailed statistics on the performance of each request. </p><br><p>  But for us it is very critical not to have a negative impact on the performance of our clients' servers, so we cannot use the profiler in the recording mode for all requests.  Only "slow" requests are not enough for us, since we will not see the full picture: </p><br><ul><li>  what requests create the most server load </li><li>  what requests create the main incoming / outgoing traffic to the server </li><li>  for requests of interest to see the distribution of response time </li><li>  what requests how many in pieces in a second </li></ul><br><p>  In our experience, problems often create high-frequency queries that were previously performed by 1ms, and then for some reason, for example, 5ms were executed.  And requests&gt; 100ms (default slowOpThresholdMs) are usually service (admin / statistics) and very rare. </p><br><p>  Since the standard profiler did not fit, we began to dig in the direction of traffic sniffing.  At the first stage it was necessary to clarify a number of questions: </p><br><ul><li>  libraries for go (our agent is written in golang) for sniffing </li><li>  performance (how much the agent will consume resources when listening to a large flow of traffic) </li><li>  parsing <a href="https://docs.mongodb.com/manual/reference/mongodb-wire-protocol/">mongodb protocol</a> </li></ul><br><p>  The prototype of our mongodb plugin was written in a few days using the <a href="https://github.com/google/gopacket">gopacket</a> library.  We intercepted packets through libpcap, parsed the protocol, bson documents were deserialized using <a href="https://godoc.org/labix.org/v2/mgo/bson">mgo</a> . </p><br><p>  Since we do not have a mongodb installation under load, we made a stand and launched a finished <a href="https://github.com/tmcallaghan/sysbench-mongodb">benchmark</a> .  In our case, mongodb and the sinker lived on the same virtual machine with 2 cores and 2Gb of memory.  By load, we saw about 10 thousand packets per second with ~ 60Mbit / s traffic. </p><br><p>  Our prototype under such a load utilized about 70% of a single processor core.  It became clear that it was necessary to profile and optimize the code.  Here it is worthwhile to pay tribute to the standard golang <a href="https://blog.golang.org/profiling-go-programs">profiler</a> , we did not need to invent anything, but simply to tune the most voracious sections of the CPU code and try to allocate memory as little as possible to reduce the load on the GC. </p><br><p>  I can‚Äôt reproduce the optimization process exactly, but I‚Äôll give examples of the most significant changes: </p><br><h2>  bson.Unmarshal slow </h2><br><p>  Bson request document in mongo is roughly a dictionary, the meanings of which can be including the same dictionaries. <br>  Since from the very beginning we decided that we would normalize queries, we can not read the values ‚Äã‚Äãof the elements of the source dictionary at all if they are not dictionaries. <br>  We take the <a href="http://bsonspec.org/spec.html">specification</a> and write our primitive deserializer.  The result was a function of ~ 100 lines. </p><br><div class="spoiler">  <b class="spoiler_title">For example, I will give a piece of analysis of the dictionary element</b> <div class="spoiler_text"><pre> <code class="go hljs">elementValueType, err = reader.ReadByte() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } payload, err = reader.ReadBytes(nullByte) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } elementName = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(payload) <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> elementValueType { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> bsonDouble, bsonDatetime, bsonTimestamp, bsonInt64: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> _, err = reader.ReadN(<span class="hljs-number"><span class="hljs-number">8</span></span>); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> bsonString: l, err = reader.ReadInt() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } payload, err = reader.ReadN(l) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } elementValue = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(payload[:<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(payload)<span class="hljs-number"><span class="hljs-number">-1</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> bsonJsCode, bsonDeprecated, bsonBinary, bsonJsWithScope, bsonArray: l, err = reader.ReadInt() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> _, err = reader.ReadN(l - <span class="hljs-number"><span class="hljs-number">4</span></span>); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> bsonDoc: elementValue, _, _, err = readDocument(reader) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> bsonObjId: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> _, err = reader.ReadN(<span class="hljs-number"><span class="hljs-number">12</span></span>); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> bsonBool: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> _, err = reader.ReadByte(); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> bsonRegexp: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> _, err = reader.ReadBytes(nullByte); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> _, err = reader.ReadBytes(nullByte); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> bsonDbPointer: l, err = reader.ReadInt() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> _, err = reader.ReadN(l - <span class="hljs-number"><span class="hljs-number">4</span></span> + <span class="hljs-number"><span class="hljs-number">12</span></span>); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> bsonInt32: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> _, err = reader.ReadN(<span class="hljs-number"><span class="hljs-number">4</span></span>); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } }</code> </pre> </div></div><br><p>  Of all the options for the fields, we only read the values ‚Äã‚Äãfor bsonDocument (recursively calling ourselves the same) and bsonString (we have additional logic for defining the collection and the type of request), we just skip the other fields. </p><br><h2>  How to catch packages </h2><br><p>  In our tests, the use of <a href="http://man7.org/linux/man-pages/man7/packet.7.html">raw sockets</a> directly turned out to be faster than through pcap. <br>  Maybe it was because of the old version of libpcap, but we planned to do a sniffer only under linux, so we decided not to <a href="">figure</a> it out, but to use <a href="">gopacket.af_packet</a> (all the more, there is no need to link the agent with libpcap). </p><br><p>  Raw sockets are special sockets in linux, through which you can send a fully formed packet to userspace (and not the kernel) or receive packets from a specific network interface.  If we talk about sniffing, packets from the kernel get into userspace through a cyclic buffer, which allows you not to do syscall to intercept each packet.  There is a detailed <a href="http://lxr.free-electrons.com/source/Documentation/networking/packet_mmap.txt">hardcore</a> in the kernel documentation on this topic. </p><br><h2>  ZeroCopy </h2><br><p>  Since we process packets in one stream, we can use the " <a href="">ZeroCopy</a> " sniffer interface.  But at the same time it must be remembered that references to this area of ‚Äã‚Äãmemory cannot be further left in the code. </p><br><h2>  Parsing packages </h2><br><p>  The package parsing interface in gopacket is quite flexible, it supports many different protocols out of the box, the user does not need to think about how top-level data is encapsulated.  But at the same time, this interface imposes the need for a large number of data copying and, as a consequence, a large load on both the CPU and the GC. </p><br><p>  We again decided to throw away all unnecessary :) </p><br><p>  Our task from the original ethernet frame (and at the AF_PACKET output we always get ethernet) to get: </p><br><ul><li>  source ip </li><li>  destination ip </li><li>  source port </li><li>  destination port </li><li>  TCP seq (explain below why it is needed) </li><li>  TCP payload (actual data of the upper level protocol) </li></ul><br><p>  For simplicity, it was decided not to support IPv6 yet. </p><br><div class="spoiler">  <b class="spoiler_title">The result was such a terrible function.</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecodePacket</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">, linkType layers.LinkType, packet *TcpIpPacket)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(err error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> l <span class="hljs-keyword"><span class="hljs-keyword">uint16</span></span> <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> linkType { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> layers.LinkTypeEthernet: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(data) &lt; <span class="hljs-number"><span class="hljs-number">14</span></span> { ethernetTooSmall.Inc(<span class="hljs-number"><span class="hljs-number">1</span></span>) err = errors.New(<span class="hljs-string"><span class="hljs-string">"Ethernet packet too small"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } l = binary.BigEndian.Uint16(data[<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> layers.EthernetType(l) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> layers.EthernetTypeIPv4: data = data[<span class="hljs-number"><span class="hljs-number">14</span></span>:] <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> layers.EthernetTypeLLC: l = <span class="hljs-keyword"><span class="hljs-keyword">uint16</span></span>(data[<span class="hljs-number"><span class="hljs-number">2</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> l&amp;<span class="hljs-number"><span class="hljs-number">0x1</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span> || l&amp;<span class="hljs-number"><span class="hljs-number">0x3</span></span> == <span class="hljs-number"><span class="hljs-number">0x1</span></span> { data = data[<span class="hljs-number"><span class="hljs-number">4</span></span>:] } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { data = data[<span class="hljs-number"><span class="hljs-number">3</span></span>:] } <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: ethernetUnsupportedType.Inc(<span class="hljs-number"><span class="hljs-number">1</span></span>) err = errors.New(<span class="hljs-string"><span class="hljs-string">"Unsupported ethernet type"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: unsupportedLinkProto.Inc(<span class="hljs-number"><span class="hljs-number">1</span></span>) err = errors.New(<span class="hljs-string"><span class="hljs-string">"Unsupported link protocol"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-comment"><span class="hljs-comment">//IP var cmp int if len(data) &lt; 20 { ipTooSmallLength.Inc(1) err = errors.New("Too small IP length") return } version := data[0] &gt;&gt; 4 switch version { case 4: if binary.BigEndian.Uint16(data[6:8])&amp;0x1FFF != 0 { ipNonFirstFragment.Inc(1) err = errors.New("Non first IP fragment") return } if len(data) &lt; 20 { ipTooSmall.Inc(1) err = errors.New("Too small IP packet") return } hl := uint8(data[0]) &amp; 0x0F l = binary.BigEndian.Uint16(data[2:4]) packet.SrcIp[0] = data[12] packet.SrcIp[1] = data[13] packet.SrcIp[2] = data[14] packet.SrcIp[3] = data[15] packet.DstIp[0] = data[16] packet.DstIp[1] = data[17] packet.DstIp[2] = data[18] packet.DstIp[3] = data[19] if l &lt; 20 { ipTooSmallLength.Inc(1) err = errors.New("Too small IP length") return } else if hl &lt; 5 { ipTooSmallHeaderLength.Inc(1) err = errors.New("Too small IP header length") return } else if int(hl*4) &gt; int(l) { ipInvalieHeaderLength.Inc(1) err = errors.New("Invalid IP header length &gt; IP length") return } if cmp = len(data) - int(l); cmp &gt; 0 { data = data[:l] } else if cmp &lt; 0 { if int(hl)*4 &gt; len(data) { ipTruncatedHeader.Inc(1) err = errors.New("Not all IP header bytes available") return } } data = data[hl*4:] case 6: ipV6IsNotSupported.Inc(1) err = errors.New("IPv6 is not supported") return default: ipInvalidVersion.Inc(1) err = errors.New("Invalid IP packet version") return } //TCP if len(data) &lt; 13 { tcpTooSmall.Inc(1) err = errors.New("Too small TCP packet") return } packet.SrcPort = binary.BigEndian.Uint16(data[0:2]) packet.DstPort = binary.BigEndian.Uint16(data[2:4]) packet.Seq = binary.BigEndian.Uint32(data[4:8]) dataOffset := data[12] &gt;&gt; 4 if dataOffset &lt; 5 { tcpInvalidDataOffset.Inc(1) err = errors.New("Invalid TCP data offset") return } dataStart := int(dataOffset) * 4 if dataStart &gt; len(data) { tcpOffsetGreaterThanPacket.Inc(1) err = errors.New("TCP data offset greater than packet length") return } packet.Payload = data[dataStart:] return }</span></span></code> </pre> </div></div><br><p>  For such functions, it is always worth writing <a href="http://dave.cheney.net/2013/06/30/how-to-write-benchmarks-in-go">benchmarks</a> , this time a rather nice picture turned out: </p><br><pre> <code class="hljs">Benchmark_DecodePacket-4 50000000 27.9 ns/op Benchmark_Gopacket-4 1000000 3351 ns/op</code> </pre> <br><p>  That is, we received an acceleration of more than 100 times. </p><br><p>  A significant part of the code of this function is error handling, there you can see the increments of different counters from which we later make the agent's service metrics and we can easily understand why the sniffer is somehow wrong with us.  For example, we are going to find out about the need to add IPv6 support by just this metric. </p><br><p>  We are also not trying to glue tcp payload from different packages, in the case when the data does not fit into the 1 ethernet frame. <br>  If such a packet is mongodb's answer, we are only interested in the header, and for large insert queries, for example, we simply take part of the query from the first packet. </p><br><h2>  Double packs </h2><br><p>  It turned out that if the client and server are on the same server, then we catch the same package 2 times. <br>  I had to do a simple packet deduplicator based on src ip + port, dest ip + port and TCP seq. </p><br><h2>  Total </h2><br><ul><li>  As a result, on our benchmark, the agent began to consume ~ 5% of the core instead of 70% </li><li>  So far we have decided to stop with optimizations, but there are still a few ideas on how to accelerate a little more. </li><li>  Under real load for clients, the agent works approximately with the same indicators (cpu consumption in the same proportion to the number of packages as on the benchmark) </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/308328/">https://habr.com/ru/post/308328/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../308314/index.html">How to install Windows Server 2012 R2 and not get 200 updates after</a></li>
<li><a href="../308316/index.html">The book "Web development using Node and Express. Full use of JavaScript stack ¬ª</a></li>
<li><a href="../308318/index.html">Password Visibility Toggle - Android Support Library, revision 24.2.0</a></li>
<li><a href="../308320/index.html">Selection of servers for video surveillance systems</a></li>
<li><a href="../308326/index.html">Ember: Declarative templating with compiled helpers</a></li>
<li><a href="../308330/index.html">Using C ++ in AWS Lambda</a></li>
<li><a href="../308332/index.html">Moving to the cloud: everything you wanted to know about Office 365 ProPlus</a></li>
<li><a href="../308334/index.html">Major world events, hacktivism and #OpOlympicHacking</a></li>
<li><a href="../308336/index.html">Analyzing errors in open components of Unity3D</a></li>
<li><a href="../308338/index.html">GPS trackers through the eyes of a system administrator</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>