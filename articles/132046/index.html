<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing Windows 7 on USB storage and / or virtual disk VHD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I want to consider the issues of installing on an external USB-drive not the usual set of resuscitation tools, but a full-fledged work...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing Windows 7 on USB storage and / or virtual disk VHD</h1><div class="post__text post__text-html js-mediator-article">  In this article I want to consider the issues of installing on an external USB-drive not the usual set of resuscitation tools, but a full-fledged working OS that you can carry with you.  And if Linux is installed out of the box on any device and works without problems, then Windows is not installed and does not work. <br>  Also, a <a href="https://habr.com/ru/post/132046/">section of this article</a> may be useful when booting Windows on new hardware (when updating a motherboard, etc.). <br><a name="habracut"></a><br>  Initially, there were 2 contradictory demands of the soul: ‚ÄúI carry everything with me‚Äù and ‚ÄúI don‚Äôt want to be loaded,‚Äù which ultimately resulted in the installation of Ubuntu on an external disk.  Everything was wonderful, but there was some kind of incompleteness.  And I decided to install Windows 7 there too. <br><br>  But there were problems: <br><ol><li>  Windows 7 warns of the impossibility of booting from USB (which cares) and does not want to be installed on it; </li><li>  The installer does not know how to work with VHD; </li><li>  When you boot Windows 7 with USB storage, BSOD appears. </li></ol><br>  And they were successfully resolved. <br><br><h4>  We will need </h4><br><ol><li>  The external USB drive itself (in this case, USB-HDD) with partitions created. </li><li>  Virtual machine (in this case I will rely on VMWare Player). <br><ul><li>  It is worth noting that you can use the ImageX utility from the WAIK (Windows Automated Installation Kit, available for free download from the developer‚Äôs site) to unpack the install.wim, you can read about it in other articles, for example, <a href="http://technet.microsoft.com/ru-ru/library/cc748966%2528WS.10%2529.aspx">here</a> , but my soul was very much against downloading something extra, so I decided to get by with VMWare already installed (VMWare Player is available for free download) </li></ul></li><li>  Windows 7 Enterprise or Ultimate (only they support the Native VHD boot).  But you can use another version and put it on the physical partition, and not on the VHD - in this case, you just need to skip the console manipulations during installation. </li></ol><br><h4>  Go </h4><br>  In the virtual machine settings, we connect to the Windows 7 CD-ROM and add the HDD: ‚ÄúUse physical disk‚Äù -&gt; select the disk corresponding to USB (most likely, it is the last).  It is worth noting that other disks at this stage are best removed from the virtual machine.  Boot from the CD and get into the installer. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Installation </h5><br>  Now is the time to point the VHD installer.  The command Shift + F10 opens the console.  Suppose we want to install Windows on C: \ win7.vhd: <br><br> <code>diskpart <br> create vdisk file=C:\win7.vhd type=fixed maximum=25000 <br> select vdisk file=C:\win7.vhd <br> attach vdisk <br> create partition primary <br> list volume <br></code> <br><br>  Make sure we have 3 volume with Fs: UDF, NTFS, RAW.  Well, or more, if the disk has other sections. <br><br>  Now you can leave the console and go to the direct installation.  When choosing an installation destination, we should see Disk 1 Partition 1, which, when selected, will carefully warn Windows 7 about possible problems, but will allow it to continue. <br>  Now you can sit back and relax.  Upon completion of this step, the installer should write the bootloader to a physical partition that will start Windows from a virtual disk.  As a result, we get a working Windows 7 inside the virtual machine.  It's time to get ready to run from USB. <br><br><a name="Prepair_launch"></a><br><h5>  Setup to run from USB </h5><br>  I am not particularly familiar with the features of Windows 7 bootup, but briefly the essence is something like this: the bootloader reads the kernel and the most important drivers (to which USB does not apply) and transfers control to the kernel, which should read everything else, but in our case it will not find anything.  Accordingly, the option itself suggests itself: you must tell the bootloader that USB is crucial and you need to load it first and then transfer control.  And, characteristically, Microsoft gave such opportunities: you need to set the Start key to 0 in the registry at [HKLM / System / CurrentControlSet / services / usb *] addresses. The most annoying thing is that periodically this field itself is reset to 3, judging around when new devices appear.  But this is not a problem.  There are 2 possible solutions (the essence of which, of course, is the same): <br><ol><li>  usbbotfix.bat - I liked it more, because the batch file is easy to edit.  I added improvements <a href="http://reboot.pro/9196/">from here</a> and I added: disabling the creation of 8.3 names, disabling the update of the last access time (well, why do we need extra write operations) and the prohibition of deleting pages with executable code so that the USB driver code is not accidentally dropped (it is quite possible that this is not necessary) , but better to be safe).  This file will also tell the scheduler to call it during Event 20003 - i.e.  when adding new devices. <br>  The content of the file is: <br> <code>@echo off <br> if "%1"=="fix" goto :fix <br> <br> rem -- install task <br> copy /y "%~f0" "%SystemRoot%\system32\usbbootfix.bat" <br> SCHTASKS /Create /RU SYSTEM /SC ONEVENT /MO "*[System[Provider[@Name='Microsoft-Windows-UserPnp'] and EventID=20003]]" /EC System /TN USBBootFix /TR "'%SystemRoot%\system32\usbbootfix.bat' fix" /F <br> rem -- apply other settings <br> fsutil behavior set disablelastaccess 1 <br> fsutil behavior set disable8dot3 1 <br> reg add "HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v DisablePagingExecutive /t REG_DWORD /d 1 /f <br> reg add HKLM\SYSTEM\CurrentControlSet\services\pciide /v Start /t REG_DWORD /d 0x0 /f <br> reg add HKLM\SYSTEM\CurrentControlSet\services\msahci /v Start /t REG_DWORD /d 0x0 /f <br> reg add HKLM\SYSTEM\CurrentControlSet\services\intelide /v Start /t REG_DWORD /d 0x0 /f <br> reg add HKLM\SYSTEM\CurrentControlSet\services\viaide /v Start /t REG_DWORD /d 0x0 /f <br> rem -- run :fix once after install <br> <br> :fix <br> call :fixservice usbehci "Boot Bus Extender" <br> call :fixservice usbohci "Boot Bus Extender" <br> call :fixservice usbuhci "Boot Bus Extender" <br> call :fixservice usbhub "System Bus Extender" <br> call :fixservice usbstor "SCSI miniport" <br> goto :eof <br> <br> :fixservice <br> setlocal <br> set Start= <br> set Group= <br> for /f "skip=2 tokens=1,2,*" %%I in ('reg query HKLM\SYSTEM\CurrentControlSet\services\%~1') do ( <br> if "%%I"=="Start" set Start=%%K <br> if "%%I"=="Group" set Group=%%K <br> ) <br> if not "%Start%"=="0x0" reg add HKLM\SYSTEM\CurrentControlSet\services\%~1 /v Start /t REG_DWORD /d 0x0 /f <br> if not "%Group%"=="%~2" reg add HKLM\SYSTEM\CurrentControlSet\services\%~1 /v Group /t REG_SZ /d "%~2" /f <br> endlocal <br> goto :eof <br></code> <br></li><li>  UsbBootWatcher.exe is a time-tested solution, is installed as a service and is called when the registry keys that we select are changed.  You can take it <a href="http://www.911cd.net/forums//index.php%3Fshowtopic%3D22473%26hl%3Drun%2Bvista%2Bfrom%2Busb">here</a> . </li></ol><br><br><a name="Inaccessible_boot_device"></a><br><h5>  If the system does not boot </h5><br>  If we have already arrived at a new place and it turned out that the OS does not want to start up, it will have to be repaired with what we have: the Repair boot section, into which Windows will most likely offer to boot after an unsuccessful attempt (if it does not, then before loading) press F8).  Then open the ‚ÄúCommand Prompt‚Äù (in case of a failed automatic recovery, click ‚ÄúView advanced options‚Äù before this). <br><ol><li>  Run the registry editor with the command "regedit".  It is worth noting that this is the registry of the recovery system. </li><li>  We connect the necessary register (more precisely, a beehive).  We are interested in "[HKLM / SYSTEM /]", it is stored in the% WINDIR% \ System32 \ Config \ System file.  To do this, we focus on ‚ÄúHKEY_LOCAL_MACHINE‚Äù, in the menu choose File -&gt; Load Hive -&gt; desired file -&gt; Key name: ‚Äúnn‚Äù (if installed on the VHD, you need to connect it to the console). </li><li>  In a loaded hive, there should be several ControlSet *s, the desired one is recorded in ‚ÄúSelect / Current‚Äù.  Go to "ControlSet * / services".  The <a href="https://habr.com/ru/post/132046/">section above</a> describes what to do and why.  But It is worth noting that in the case of launch not from USB, keys like ‚Äúatapi‚Äù, ‚Äúpciide‚Äù, ‚Äúintelide‚Äù, ‚Äúmsahci‚Äù and similar ones may be of interest. </li></ol><br><br><h5>  USB boot </h5><br>  Because  restart once again all the laziness, we check again in the virtual machine.  Turn it off, delete all HDDs in the settings, start up, transfer USB-HDD to the virtual machine and ... We understand that our disk is not visible.  But in the list of what is required, BIOS support for booting from USB was not mentioned. <br>  Downloading the <a href="http://www.plop.at/en/bootmanagerdl.html">plop boot manager</a> - there are iso and img images in the archive.  We indicate to the virtual machine to boot from the plpbt.iso disk (or plpbt.img for floppy) and already it will transfer control to the bootloader from USB.  Everything should go well and eventually Windows 7 will start and say that a new device has been found. <br><br>  Now we can transfer the external drive to any other real machine and start.  That's all.  Your suggestions on practical application are interesting. <br><br><h5>  Brief summary </h5><br><ol><li>  we start the virtual machine, having connected usb-hdd and the installer of Windows 7; </li><li>  during the installation process, we indicate that we want to install on the VHD (optional); </li><li>  change driver loading priority; </li><li>  we start from USB, if the BIOS fails, then we use plpbt. </li></ol><br><h4>  Important notes / unresolved issues </h4><br><ol><li>  before loading the kernel, there may be problems with accessing the disk to addresses above 137Gb (I had) - you can only advise to transfer the partition to the beginning of the disk (actually, including because of this restriction, I installed it on the VHD and did not create new section); </li><li>  after each booting, Windows reports that something has changed and it is necessary to re-order the swap - it is best to specify the explicit size of the swap and assign it to D: (physical partition, C: - virtual disk), but when you run it on another machine, the question again will occur, and if the memory size is different there, the swap will be automatically selected; </li><li>  honest guys offer to call% windir% \ system32 \ sysprep \ sysprep.exe before transferring to another hardware, but I noticed that this is not necessary and even harmful (they re-suggest creating a user / settings are reset / an extra restart is required after searching for drivers) - personally everything works fine for me and on condition of normal shutdown and, which is typical, if the system was previously started on this equipment, then the restart will take place instantly, all drivers will pick up automatically and without restarts; </li><li>  the boot loader (bootmgr, Boot \) must be located on the physical disk (done automatically), but I would like to reset everything inside the VHD and transfer control to it from grub.  <a href="http://www.vmlite.com/">These guys</a> made their grub with the vhd module, but I didn‚Äôt master it (first I had to edit the Makefiles to create the vhd.mod, but after copying to / boot / grub /, the ‚Äúinsmod vhd‚Äù command ended with the error ‚Äúincompatible license "; A more detailed study of the vhd.c code showed that changes were made to the code of grub-1.97 itself, which did not suit me, because Ubuntu uses grub-1.99). </li></ol><br><br><h4>  Used sources </h4><br><ul><li>  <a href="http://reboot.pro/9196/">Description usbbootfix.bat</a> ; </li><li>  <a href="http://www.911cd.net/forums//index.php%3Fshowtopic%3D22473%26hl%3Drun%2Bvista%2Bfrom%2Busb">Description UsbBootWatcher</a> ; </li><li>  <a href="http://www.sat-fishers.com/forum/showthread.php%3Ft%3D2823">VHD module description for GRUB</a> ; </li><li>  <a href="http://www.plop.at/">USB boot if BIOS doesn't allow</a> ; </li><li>  <a href="http://technet.microsoft.com/en-us/library/cc785435%2528WS.10%2529.aspx">Article about fsutil</a> . </li><li>  <a href="http://www.sarov.info/index.php%3Fch%3Dtext1%26view%3Darticle%26id%3D279%26chapter%3D10%26prevview%3Dviewcat">Actions when replacing the motherboard</a> . </li></ul><br><br>  PS And the prices for drives have recently skyrocketed due to the flooding of Taiwan. </div><p>Source: <a href="https://habr.com/ru/post/132046/">https://habr.com/ru/post/132046/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132040/index.html">Cosmopoly IT world after the crisis</a></li>
<li><a href="../132041/index.html">Lectures of Microsoft Russia executives at the Polytechnic Museum</a></li>
<li><a href="../132042/index.html">Writing Windows Sidebar gadget from scratch</a></li>
<li><a href="../132043/index.html">Hakintosh - is the game worth the candle?</a></li>
<li><a href="../132045/index.html">Google OpenClass - LMS with a social bias</a></li>
<li><a href="../132047/index.html">Painting and nails</a></li>
<li><a href="../132048/index.html">An example of writing an Executive Summary based on a real project</a></li>
<li><a href="../132049/index.html">Facebook removed the private information request form</a></li>
<li><a href="../132053/index.html">OpenGL iBooks-like page turning animation</a></li>
<li><a href="../132054/index.html">Version 1.6.0 released</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>