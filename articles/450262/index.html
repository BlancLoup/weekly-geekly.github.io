<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Typescript library automation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to immediately make a reservation: this article does not give a ready-to-use recipe. This is rather my story of traveling to the world of Types...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Typescript library automation</h1><div class="post__text post__text-html js-mediator-article">  I want to immediately make a reservation: this article does not give a ready-to-use recipe.  This is rather my story of traveling to the world of Typescript and NodeJS, as well as the results of my experiments.  However, at the end of the article there will be a link to the GitLab repository, which you can see, and maybe take something you like.  It may even be in my experience to create your automated solution. <br><a name="habracut"></a><br><h1>  Why do you need it </h1><br>  So why bother to create libraries at all, or in the specific case of NPM packages? <br><br><ol><li>  Reuse code between projects. <br><br>  It all started with the fact that I noticed the habit of creating a folder / tools in projects.  In addition, I also take most of this folder with me when I switch to a new project.  And then I asked myself the question, why not make an NPM package instead of copy-paste and then just connect it to any project? </li><li>  Different life cycle.  In one of the applications, as a dependency, there was a large corporate component assembly.  It was possible to update it entirely, even if only one component was updated.  Changes in other components could break something and we didn‚Äôt always have enough estimated time to retest it.  This model is very inconvenient.  When each package serves its purpose or a small set of related goals, they can already be updated when it is really needed.  Also, the next versions of the package are released only when they have some changes, not ‚Äúfor the company‚Äù. </li><li>  Separate the secondary code from the main business logic.  DDD has the principle of domain distillation; it assumes that parts of the code that do not belong to the main domain are identified and isolated from them.  And how to better isolate than to carry this code into a separate project. <br>  By the way, the distillation of the domain is very similar to the principle of SRP only at a different level. </li><li>  Own code coverage.  In one of the projects where I participated, the code coverage was about 30%.  And the library that I took out of it has a coverage of about 100%.  The project, although it lost the percentage of coverage, as it was in the red zone before rendering, remained.  And the library has such enviable indicators to this day, after almost a year and 4 major versions. </li><li>  Open Source.  The code does not contain business logic - the first candidate for separation from the project, so it can be made open. </li></ol><br><h1>  Start new libraries "expensive" </h1><br>  There is such a problem: in order to create a library, it is not enough to create a git repository under it.  You also need to configure the task so that the project can be collected, conduct a static check (lint) and test.  Also, in addition to testing, it is advisable to collect code coverage.  In addition, the package will have to publish each time manually.  And still need to write a readme.  Here only I can not help with readme. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, what can be done with all these tedious, uninteresting tasks? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e7d/23c/060/e7d23c0601b80abf5e381f3f9e51c5ad.jpg"><br><br><h1>  First step: Seed </h1><br>  I started everything by creating a seed project.  A sort of starter kit, he had the same structure as my first project to make the code in a separate package.  I created in it gulp task and scripts that would build, test and assemble the package cover in one action.  Now, to create another project, I had to clone the seed into a new folder and change origin, so that it points to the newly created GitHub repository (then I also used GitHub). <br><br>  This way of creating projects gives another advantage.  Now changes concerning construction or testing of the project are made once, in the project seed.  And copy-paste these changes are no longer necessary.  Instead, in the final project, the next time I have to work with it, I create a second remote with the name seed and take these changes from there. <br><br>  And it worked for me for a while.  Until I used seed in a project where several developers participated.  I wrote a three-step instruction: take the last master, build and publish it.  And at some point, one of the developers, for some reason, performed the first step and the third.  How is that even possible? <br><br><h1>  Second step: Automatic publishing </h1><br>  Despite the fact that it was a single mistake, such manual actions as publishing are boring.  Therefore, I decided that it is necessary to automate it.  In addition, CI was needed to prevent red commits from entering the master.  At first I tried to use Travis CI, but rested on the following restriction.  He considers pull-request in master to be equivalent to commit in master.  And I had to do different things. <br><br>  One of my colleagues advised to pay attention to GitLab and his CI, and everything that I wanted worked there. <br><br>  I created the following project management process, applied when I need to fix a bug, add new functionality, or create a new version: <br><br><ol><li>  I create a branch from the master.  I am writing code and tests in it. </li><li>  I create merge request. </li><li>  GitLab CI automatically runs tests in the node: latest container </li><li>  The request is Code Review. </li><li>  After the request is empty, GitLab runs a second set of scripts.  This set creates a tag on the commit with the version number.  The version number is taken from package.json if it is manually increased there, if not, then the last published version is taken and auto-incremented. </li><li>  The script builds the project and runs the tests again. </li><li>  The last steps the version tag is sent to the repository and the package is published in NPM. </li></ol><br>  Thus, the version specified in the tag always coincides with the version of the package published from this commit.  In order for these operations to work, in a project on GitLab, you need to specify environment variables with repository access keys and NPM. <br><br><h1>  Last step: Automate everything </h1><br>  At this point, I have already automated a lot, but there still remained a lot of manual actions to create a project.  This, of course, was progress anyway, because actions were done once on a project, and not on each version.  But still, the instruction consisted of 11 steps.  And I myself was mistaken a couple of times while doing these steps.  Then I decided that once I began to automate, then I need to bring this to the end. <br><br>  For this full automation to work, but the computer I need to have 3 files in the .ssh folder.  I figured that this folder is fairly secure, since the private key id_rsa is already stored there.  This file will also be used to enable GitLab CI to transfer tags to the repository. <br><br>  The second file I put there is ‚Äúgitlab‚Äù, it contains the access key to the GitLab API.  And the third file is ‚Äúnpm‚Äù, the access key for publishing the package. <br><br>  And here begins the magic.  All you need to create a new package is to run one command in the seed folder: ‚Äúgulp startNewLib -n [npmName] / [libName]‚Äù.  Done, the package is created, ready for development and auto-publishing. <br><br>  For example, the ‚Äúvlr / validity‚Äù package was created this way. <br><br>  This command does the following: <br><br><ol><li>  Creates a project on GitLab </li><li>  Clones the seed into a local folder next to the folder from which the command is running. </li><li>  Changes origin to the project created in step 1 </li><li>  Pulls the master branch </li><li>  Creates environment variables in a project from files in the .ssh folder </li><li>  Creates the firstImplementation branch </li><li>  Changes the library name in package.json, commits and pulls the thread </li></ol><br>  All that is needed after this is to put the code there and create a merge request. <br><br>  As a result, one can be proud of, from the moment when a decision is made to render some code in a separate project until the publication of the first version takes about five minutes.  Four of which take two GitLabCI pipelines, and one minute to run the above command, drag the code, and click buttons in the GitLab interface to create and then query. <br><br>  There are some limitations: The GitLab name must match the name in npm.  And yet, this command, unlike the rest of the functionality in the seed project, works only on Windows. <br><br>  If you are interested in this seed project, you can <a href="https://gitlab.com/vlr/tslib-seed">study it at the following link</a> . </div><p>Source: <a href="https://habr.com/ru/post/450262/">https://habr.com/ru/post/450262/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450242/index.html">Why did you need another PHP framework?</a></li>
<li><a href="../450244/index.html">How to write and promote White Paper?</a></li>
<li><a href="../450248/index.html">Preserving the element color in the Navisworks database</a></li>
<li><a href="../450252/index.html">Mission ‚ÄúChang'e-4‚Äù - the fifth lunar day for the landing module and rover ‚ÄúYuytu-2‚Äù</a></li>
<li><a href="../450260/index.html">My experience of digitalization of the state or the history of the birth platform Digit</a></li>
<li><a href="../450264/index.html">Detailed review of 3CX v16</a></li>
<li><a href="../450266/index.html">Honest resume programmer</a></li>
<li><a href="../450268/index.html">Marketing for a startup: how to attract thousands of users from around the world without spending $ 200</a></li>
<li><a href="../450270/index.html">Zastone ZT-A19 Radio Station: Performance Measurement</a></li>
<li><a href="../45028/index.html">Determine the load on the Apache server</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>