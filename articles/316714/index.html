<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Xamarin Modular Application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, you will learn about interesting problems and their solutions that arose in the process of developing a "designer" of applications bu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Xamarin Modular Application</h1><div class="post__text post__text-html js-mediator-article"><p>  In this article, you will learn about interesting problems and their solutions that arose in the process of developing a "designer" of applications built on a modular architecture in the company <a href="http://notissimus.com/">Notissimus</a> .  The project is under active development, so we will be happy to hear your opinion in the comments, and we also invite you to the final in 2016 <a href="https://aka.ms/event_xamarin_81216">metap</a> for Xamarin developers.  All interested in asking under the cat. </p><br><img src="https://habrastorage.org/files/3d3/fb1/a2a/3d3fb1a2a7e94408adc1c1dc9e7cf60b.jpg"><a name="habracut"></a><br><p>  <em>Further narration will be conducted on behalf of the authors.</em> </p><br><h1>  Formulation of the problem </h1><br><h2>  What does the customer want? </h2><br><p>  The client is capricious, therefore the requirements for the final product (application) will be different for each.  However, you can highlight common Wishlist: </p><br><ul><li>  customize the functionality for themselves; </li><li>  edit or completely replace the design; </li><li>  own the source code; </li><li>  be able to continue development in your / other team. </li></ul><br><p>  These four Wishlist does not change from client to client, but they can appear / disappear.  After defining the women you need to understand what they mean to a simple programmer: </p><br><ul><li>  modularity - you need a basic project with additions in the form of plug-ins; </li><li>  customization flexibility - it should be possible to redefine business logic and UI modules; </li><li>  licensing and protection of the source code - it must be necessary, since it is planned to transfer the source to the side. </li></ul><br><h2>  Solution scheme </h2><br><p>  Having defined our tasks, we decided to use the following scheme: </p><br><p><img src="https://habrastorage.org/files/691/ce1/c7a/691ce1c7a0b14441b552bd36e44c5d10.png" alt="solution scheme"></p><br><h1>  Solution Architecture </h1><br><h2>  Base modules </h2><br><p>  What are the basic modules?  First, it is a kind of architectural unit, consisting of three main elements: API, Core and UI.  Secondly, this is a structure completely independent of nothing, except the fundamental Base project, which gathers all the groundwork and basic elements for quickly assembling and connecting new modules (for example, a project to simplify working with the API, * LookupService, wrapper over DB, base ViewModel'i, base classes for UIViewController'ov, etc.).  Thus, at the heart of each module lies one or another part or parts of the fundamental Base module. </p><br><p>  Examples of basic modules are: </p><br><ul><li>  authorization module and display information about the user; </li><li>  chat module; </li><li>  Favorite module; </li><li>  contact module; </li><li>  navigation module *; </li><li>  other‚Ä¶ </li></ul><br><p>  The navigation module is * because it is not a basic module in its pure form, since the logic of processing this navigation on the UI layer strongly depends on the selected type of navigation (menu, or tab, or something else) and the entry point to the application also depends starting ViewModel with which the application starts. </p><br><h2>  Top level modules </h2><br><p>  These are the modules that depend on the business segment for which the project is being developed.  The reasons why it was decided to separate them into a separate layer are obvious, but we still list them: </p><br><ul><li>  base layer modules are unloaded and become truly universal - there is no need to install various crutches for the required interaction between modules; </li><li>  it is possible to refer from one module to another, since these modules belong to one segment, inside it they are completely universal and can be reused; </li><li>  we get the opportunity to write only the logic that is required for this particular segment - we unload the modules and the application: we keep small size and speed of work. </li></ul><br><p>  Examples of such modules are: </p><br><ul><li>  directory module; </li><li>  cart module and checkout; </li><li>  stock and news module; </li><li>  store address module; </li><li>  other‚Ä¶ </li></ul><br><p>  It is necessary to add goods to the basket from the catalog module and the implementation of this through additional wrappers without a direct link to the basket module cannot be called a convenient way. </p><br><h2>  Run Project </h2><br><p>  This is the project with which you can interact with the client or its developer.  He contains: </p><br><ul><li>  links to all connected modules and packages required for operation; </li><li>  a set of graphics used in the design of the application; </li><li>  font set; </li><li>  color palette; </li><li>  typing with localization; </li><li>  set of client settings. </li></ul><br><p>  What can a regular user do with this project, guided by the specification: </p><br><ul><li>  change icons / pictures; </li><li>  change fonts; </li><li>  change texts; </li><li>  change colors. </li></ul><br><p>  What a developer can do with this project: </p><br><ul><li>  same as user; </li><li>  change settings in configs; </li><li>  replace any part of the logic in the connected modules (for example, change the type of navigation); </li><li>  add additional modules. </li></ul><br><h1>  Module architecture </h1><br><h2>  API </h2><br><p>  This is the Portable Class Library - a library (project) code in which it can be executed on any platform, be it iOS or Android.  Standard API project contains such elements as: </p><br><ul><li>  Model'i received from the server and used in Core; </li><li>  Service'y, inside which there is a call to certain API methods; </li><li>  "Registrar" of all services contained in the project. </li></ul><br><div class="spoiler">  <b class="spoiler_title">The service is as follows</b> <div class="spoiler_text"><pre><code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IAuthService { /// &lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; ///    e-mail   /// &lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// &lt;<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>&gt;  &lt;/<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>&gt; /// &lt;param <span class="hljs-type"><span class="hljs-type">name</span></span>="email"&gt;E-mail&lt;/param&gt; /// &lt;param <span class="hljs-type"><span class="hljs-type">name</span></span>="password"&gt;&lt;/param&gt; Task&lt;string&gt; SignIn(string email, string <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>); /// &lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; ///    e-mail   .  /// &lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// &lt;<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>&gt;  &lt;/<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>&gt; /// &lt;param <span class="hljs-type"><span class="hljs-type">name</span></span>="email"&gt;E-mail&lt;/param&gt; /// &lt;param <span class="hljs-type"><span class="hljs-type">name</span></span>="socialTypeName"&gt;  . &lt;/param&gt; /// &lt;param <span class="hljs-type"><span class="hljs-type">name</span></span>="additionalFields"&gt; &lt;/param&gt; Task&lt;string&gt; SignInSocial(string email, string socialTypeName, <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; additionalFields = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); /// &lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; ///    e-mail   /// &lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// &lt;<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>&gt;  &lt;/<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>&gt; /// &lt;param <span class="hljs-type"><span class="hljs-type">name</span></span>="email"&gt;E-mail&lt;/param&gt; /// &lt;param <span class="hljs-type"><span class="hljs-type">name</span></span>="password"&gt;&lt;/param&gt; /// &lt;param <span class="hljs-type"><span class="hljs-type">name</span></span>="additionalFields"&gt; &lt;/param&gt; Task&lt;string&gt; SignUp(string email, string <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; additionalFields = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); /// &lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; ///    /// &lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// &lt;<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>&gt;  &lt;/<span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>&gt; /// &lt;param <span class="hljs-type"><span class="hljs-type">name</span></span>="email"&gt;E-mail&lt;/param&gt; Task&lt;string&gt; RecoveryPassword(string email); /// &lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; ///   /// &lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// &lt;param <span class="hljs-type"><span class="hljs-type">name</span></span>="token"&gt;  &lt;/param&gt; Task SignOut(string token); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> AuthService : BaseService, IAuthService { #region IAuthService implementation <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SignIn(string email, string <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> await Post&lt;string&gt;(SIGN_IN_URL, ToStringContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> { email, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> })); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SignInSocial(string email, string socialTypeName, <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; additionalFields = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> await Post&lt;string&gt;(SIGN_IN_SOCIAL_URL, ToStringContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> { email, socialTypeName, additionalFields })); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; SignUp(string email, string <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;string, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; additionalFields = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> await Post&lt;string&gt;(SIGN_UP_URL, ToStringContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> { email, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>, additionalFields })); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;string&gt; RecoveryPassword(string email) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> await Post&lt;string&gt;(RECOVERY_PASSWORD_URL, ToStringContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> { email })); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task SignOut(string token) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Post(SIGN_OUT_URL, ToStringContent(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> { token })); } #endregion }</code> </pre> </div></div><br><p>  After adding a service to a project, additional actions are not required to register it, the ‚Äúregistrar‚Äù does everything himself thanks to the following lines: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">CreatableTypes</span></span>() <span class="hljs-selector-class"><span class="hljs-selector-class">.EndingWith</span></span>("<span class="hljs-selector-tag"><span class="hljs-selector-tag">Service</span></span>") <span class="hljs-selector-class"><span class="hljs-selector-class">.AsInterfaces</span></span>() <span class="hljs-selector-class"><span class="hljs-selector-class">.RegisterAsLazySingleton</span></span>();</code> </pre> <br><h2>  Core </h2><br><p>  It is also a PCL project, fully built on the use of the opportunities that MvvmCross provides us with.  A standard Core project contains the following elements: </p><br><ul><li>  a set of ViewModels ‚Äî abstractions of screens in which there can only be: implementations of the ICommand interface, simple properties and methods of navigation; </li><li>  VmServices are services tied to specific ViewModels and contain all the business logic.  Each such service performs strictly one function, for example: </li></ul><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IMenuVmService</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IEnumerable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuildItemsFromJsonConfig</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MenuVmService</span></span> : <span class="hljs-title"><span class="hljs-title">IMenuVmService</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IEnumerable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuildItemsFromJsonConfig</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... } }</code> </pre> <br><ul><li>  Model'i - additional models used in Core and sometimes in the UI (for example, models used in the construction of dialogues and notifications for the user).  The most common model in Core is the set of objects with which the database works; </li><li>  Service'es are specific services, as a rule, these are either services for working with a database, or only declared service interfaces (the platform has such a service, for example, <code>IDeviceService</code> , which receives information about the current device); </li><li>  Messages are messages used for interaction between unrelated parts of the Core (for example, to alert one ViewModel about action in another) or to transfer parameters from the UI layer to the Core and vice versa. </li></ul><br><p>  Before starting the development, we discussed that most of the logic in Core can be redefined and each can be replaced completely with your implementation.  And if everything is clear with the replacement of services via IoC, then with the replacement of ViewModels, everything is not obvious.  There was a question: ‚Äúhow to implement it?‚Äù.  The answer was the implementation of the <code>ViewModelLookupService</code> . </p><br><h3>  ViewModelLookupService </h3><br><p>  This is a service that allows the ViewModel interface to register its implementation.  The principle is similar to IoC, only ViewModelLookupService does not work with VM instances.  How, then, does navigation take place?  The point is that the VM method ShowViewModel () takes in the type of VM that you want to display.  Thus, when registering a view of a model in a service, full information about the type of VM interface and the type of VM implementation is taken and stored in the service.  When accessing the service to obtain a registered implementation, it accesses the stored data and returns the type of implementation back. </p><br><p>  This gives us the opportunity to set our model implementations in configs.  Example: </p><br><div class="spoiler">  <b class="spoiler_title">Configuring list items in the Menu module</b> <div class="spoiler_text"><pre> <code class="hljs objectivec">... <span class="hljs-string"><span class="hljs-string">"items"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"icon"</span></span>:<span class="hljs-string"><span class="hljs-string">"res:Images/Menu/catalog.png"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"AppRopio.ECommerce.Products.Core.ViewModels.IProductsViewModel"</span></span>, <span class="hljs-string"><span class="hljs-string">"default"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span> }, { <span class="hljs-string"><span class="hljs-string">"icon"</span></span>:<span class="hljs-string"><span class="hljs-string">"res:Images/Menu/basket.png"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"AppRopio.ECommerce.Basket.Core.ViewModels.IBasketViewModel"</span></span>, <span class="hljs-string"><span class="hljs-string">"badge"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span> }, { <span class="hljs-string"><span class="hljs-string">"icon"</span></span>:<span class="hljs-string"><span class="hljs-string">"res:Images/Menu/history.png"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"AppRopio.ECommerce.OrdersHistory.Core.ViewModels.IOrdersHistoryViewModel"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"icon"</span></span>:<span class="hljs-string"><span class="hljs-string">"res:Images/Menu/favorites.png"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"AppRopio.ECommerce.Favorites.Core.ViewModels.IFavoritesViewModel"</span></span> } ] ...</code> </pre> </div></div><br><p>  Thus, you can set a list element: name, type of VM'ki, which you should try to get from <code>ViewModelLookupService</code> when you click on an element and call up navigation logic, as well as set a badge on the item and designate one of the items as the start screen. </p><br><p>  Thanks to the introduction of the <code>ViewModelLookupService</code> all VM's have got their own interface - it also allows you not to lose the possibility of replacing the logic when you bind a VM to the UI layer.  Also registration of implementations of your ViewModels in the <code>ViewModelLookupService</code> is a prerequisite for each module. </p><br><h3>  RouterService </h3><br><p>  In fact, with navigation from the Menu module through the <code>ViewModelLookupService</code> not so simple.  After implementing this mechanism, we thought that the navigation module should not have an explicit binding to the type being navigated, and also should be able to perform some logic before navigating to a menu item (for example, the menu can have the Personal Account or Order History item, access to which must be blocked before user authorization).  Therefore, it was decided to develop a mechanism for RouterService. </p><br><p>  <code>RouterService</code> is a service that manages navigation by type of VM interface.  Call it occurs as follows: </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnItemSelected</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IMenuItemVM item</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!RouterService.NavigatedTo(item.Type)) MvxTrace.Trace(MvvmCross.Platform.Platform.MvxTraceLevel.Error, <span class="hljs-string"><span class="hljs-string">"NavigationError: "</span></span>, <span class="hljs-string"><span class="hljs-string">$"Can't navigate to ViewModel of type </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{item.Type}</span></span></span><span class="hljs-string">"</span></span>); }</code> </pre> <br><p>  To handle a navigation event on any type, a module needs to register its implementation <code>IRouterSubscriber</code> for this type in <code>IRouterSubscriber</code> , which contains only two methods: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IRouterSubscriber</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CanNavigatedTo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> type</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FailedNavigatedTo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> type</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre> <br><p>  The first is called inside the <code>RouterService.NavigatedTo(...)</code> method if a <code>item.Type</code> been registered with the <code>item.Type</code> type.  The second, if the first method returned false or any error occurred during other stages of navigation. </p><br><p>  When implementing the first method, the subscriber is obliged to process the type that came to him, perform the required checks and, if they pass, obtain a registered type of model implementation from <code>ViewModelLookupService</code> and navigate to it, otherwise it is necessary to return <code>false</code> .  There are no limitations when implementing <code>FailedNavigatedTo(...)</code> . </p><br><p>  Thus, the navigation processing to key points was removed from the Menu module and allowed to navigate to any ViewModel'i and perform any logic (for example, when tapping on a menu item, you need to navigate not to the screen, but to open the company‚Äôs website) </p><br><h2>  Ui </h2><br><p>  The layer consists of two types of projects: </p><br><ul><li>  iOS Class Library; </li><li>  Android Class Library. </li></ul><br><p>  Each of the projects necessarily contains: </p><br><ul><li>  implementation of platform services interfaces; </li><li>  user interfaces - screens built by abstractions - ViewModel'yam. </li></ul><br><p>  We will look at the implementation of platform services a bit later, the implementation of user interfaces is no different from what you are doing now, so let's take a closer look at using the various client settings of the application. </p><br><p>  There are two types of settings: </p><br><ul><li>  configurations - affect the operation of Core and the interaction logic inside and between modules (for example, the above configuration of the Menu module); </li><li>  thematic - affect the rendering of various components in the UI module layer. </li></ul><br><p>  The settings file itself is a .json document.  Settings are loaded once into special services that start when the module starts.  Configuring settings are loaded into Core into ConfigServices, thematic ones are loaded into UI in ThemeServices.  The procedure for downloading json from a file is fairly standard, with the exception that Core is PCL, that is, there are no tools for working with files (see. NET Standard 2.0).  This led to the introduction of a special service <code>ISettingsService</code> , the implementation of which is located in the UI layer of the fundamental Base module, which allows the logic to load information about the settings without problems. </p><br><h1>  Stages of developing a new module and connecting it to the existing system </h1><br><p>  Before developing a new module, you will need to purchase and download the source codes of its application from the client‚Äôs personal account.  Thus, you will have a solution with two running projects (for iOS and for Android) with the already created architecture and the selected settings.  Now we will consider only the creation of a photo gallery module from scratch for an existing iOS application.  The module will receive images from the device‚Äôs camera, send them to the server, save to an album, and display them in the collection. </p><br><h2>  Creation of architecture </h2><br><p>  First, for convenience, create a new Solution Folder, call it Photogallery.  After that, we consistently add three projects to this folder: </p><br><ul><li>  Portable Library - Photogallery.API; </li><li>  Portable Library - Photogallery.Core; </li><li>  iOS Class Library - Photogallery.iOS. </li></ul><br><p>  Remove automatically created <code>MyClass.cs</code> and add the following links to projects: </p><br><ul><li>  Photogallery.API - Base.API; </li><li>  Photogallery.Core - Base.Core + Photogallery.API; </li><li>  Photogallery.iOS - Base.iOS + Base.Core + Base.API + Photogallery.Core + Photogallery.API; </li><li>  XamarinMeetUp.iOS - Base.iOS + Base.Core + Base.API + Photogallery.iOS + Photogallery.Core + Photogallery.API. </li></ul><br><p>  It is also necessary to connect the MvvmCross package from NuGet to each project. </p><br><h2>  Add API service </h2><br><p>  When photographing our plugin will send photos to a server to save history (or, for example, to publish).  To do this, you need to add a project to the API, which will perform this work.  Create a Services folder in the project and add an <code>IPhotoService</code> interface to <code>IPhotoService</code> in which we describe the required functionality. </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IPhotoService</span></span> { <span class="hljs-function"><span class="hljs-function">Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendPhoto</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] photoData</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre> <br><p>  Now we will write the service implementation: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PhotoService</span></span> : <span class="hljs-title"><span class="hljs-title">BaseService</span></span>, <span class="hljs-title"><span class="hljs-title">IPhotoService</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PHOTO_URL = <span class="hljs-string"><span class="hljs-string">"photo"</span></span>; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">region</span></span></span><span class="hljs-meta"> IPhotoService implementation public async Task SendPhoto(byte[] photoData) { await Post(PHOTO_URL, new ByteArrayContent(photoData)); } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endregion</span></span></span><span class="hljs-meta"> }</span></span></code> </pre> <br><p>  Thanks to the implementation of the <code>BaseService</code> in the Base.API project of the Base module, the request for the required URL is executed in just one line.  Similarly, you can add an implementation of the method of receiving photos from the server.  The API entry point is taken from the settings in the running project and is used as the URL prefix for all requests.  If, for some reason, the implementation of the Post (...) method does not suit you, you can contact the query service directly. </p><br><p>  To make the service work, it remains to register it.  To do this, create an App class in the API project and write the following code in it: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span> : <span class="hljs-title"><span class="hljs-title">MvxApplication</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Initialize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { CreatableTypes() .EndingWith(<span class="hljs-string"><span class="hljs-string">"Service"</span></span>) .AsInterfaces() .RegisterAsLazySingleton(); } }</code> </pre> <br><p>  Here in the <code>Initialize</code> method, we automatically register all services in the API as Lazy singletones for their subsequent call from the Core part. </p><br><h2>  Creating a ViewModel and Service </h2><br><p>  For this module we will create a simple VM, which will contain only a list of photos received from the user and a button for adding a new photo to it.  In the Core project, we create the ViewModels folder, inside it the Photogallery folder and add a new interface <code>IPhotogalleryViewModel</code> and a new class <code>PhotogalleryViewModel</code> , which we inherit from the interface and from <code>BaseViewModel</code> . </p><br><p>  Add the following lines to IPhotogalleryViewModel interface: </p><br><pre> <code class="hljs swift"><span class="hljs-type"><span class="hljs-type">ObservableCollection</span></span>&lt;<span class="hljs-type"><span class="hljs-type">IPhotoItemVM</span></span>&gt; <span class="hljs-type"><span class="hljs-type">Items</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-type"><span class="hljs-type">ICommand</span></span> <span class="hljs-type"><span class="hljs-type">AddPhotoCommand</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; }</code> </pre> <br><p>  Items - the list of displayed photos; AddPhotoCommand - adding a new photo to the collection. </p><br><p>  Downloading all the photos and the logic of receiving a new photo will be in the service that implements the interface: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IPhotogalleryVmService</span></span> { Task&lt;ObservableCollection&lt;IPhotoItemVM&gt;&gt; LoadItems(); <span class="hljs-function"><span class="hljs-function">Task&lt;IPhotoItemVM&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPhotoFromUser</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre> <br><p>  <code>VmService</code> will, for receiving a new photo, contact the camera service of the device, the implementation of which will be on each platform, and, for downloading photos from the album, to the album service. </p><br><div class="spoiler">  <b class="spoiler_title">Platform Services Interfaces</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ICameraService</span></span> { Task&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]&gt; TakePhoto(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IPhotoAlbumService</span></span> { Task&lt;List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]&gt;&gt; LoadPhotosFrom(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> albumName); }</code> </pre> </div></div><br><p>  It remains only to register the available services in Core and ViewModel'i (registration of viewmode occurs for the possibility of their subsequent replacement).  Everything happens by analogy with the API - an App.cs is created in which the Initialize method is redefined as follows: </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Initialize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> API.App()).Initialize(); CreatableTypes() .EndingWith(<span class="hljs-string"><span class="hljs-string">"Service"</span></span>) .AsInterfaces() .RegisterAsLazySingleton(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vmLookupService = Mvx.Resolve&lt;IViewModelLookupService&gt;(); vmLookupService.Register&lt;IPhotogalleryViewModel&gt;(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(PhotogalleryViewModel)); }</code> </pre> <br><h2>  Elaboration of a simple layout on iOS and implementation of platform services </h2><br><p>  First, we implement all platform services.  Let's start with the camera service.  Create a Services folder in the iOS project and add the CameraService to it: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CameraService</span></span> : <span class="hljs-title"><span class="hljs-title">ICameraService</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Task&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]&gt; TakePhoto() { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotImplementedException(); } }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Implementation of the TakePhoto () method</b> <div class="spoiler_text"><pre> <code class="hljs coffeescript">public async Task&lt;byte[]&gt; TakePhoto() { var mediaFile = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> CrossMedia.Current.TakePhotoAsync( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StoreCameraMediaOptions { DefaultCamera = CameraDevice.Rear }); var stream = mediaFile.GetStream(); var bytes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> byte[stream.Length]; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> stream.ReadAsync(bytes, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int)</span></span></span><span class="hljs-function">stream.Length); PHAssetCollection assetCollection = null; var userCollection = PHAssetCollection.FetchAssetCollections</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PHAssetCollectionType.Album, PHAssetCollectionSubtype.Any, </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">; if </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(userCollection != </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> assetCollection = userCollection.FirstOrDefault</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(nsObject =&gt; (nsObject </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">as</span></span></span></span><span class="hljs-function"><span class="hljs-params"> PHAssetCollection).LocalizedTitle == ALBUM_NAME)</span></span></span><span class="hljs-function"> as PHAssetCollection; if </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(assetCollection == </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> { string assetCollectionIdentifier = string.Empty; PHPhotoLibrary.SharedPhotoLibrary.PerformChanges(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { var creationRequest = PHAssetCollectionChangeRequest.CreateAssetCollection(ALBUM_NAME); assetCollectionIdentifier = creationRequest.PlaceholderForCreatedAssetCollection.LocalIdentifier; }, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bool success, NSError error)</span></span></span><span class="hljs-function"> =&gt;</span></span> { assetCollection = PHAssetCollection.FetchAssetCollections(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { assetCollectionIdentifier }, <span class="hljs-literal"><span class="hljs-literal">null</span></span>).firstObject <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> PHAssetCollection; PHPhotoLibrary.SharedPhotoLibrary.PerformChanges(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { var assetChangeRequest = PHAssetChangeRequest.FromImage(UIImage.LoadFromData(NSData.FromArray(bytes))); var assetCollectionChangeRequest = PHAssetCollectionChangeRequest.ChangeRequest(assetCollection); assetCollectionChangeRequest.AddAssets(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { assetChangeRequest.PlaceholderForCreatedAsset }); }, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bool s, NSError e)</span></span></span><span class="hljs-function"> =&gt;</span></span> { }); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { PHPhotoLibrary.SharedPhotoLibrary.PerformChanges(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { var assetChangeRequest = PHAssetChangeRequest.FromImage(UIImage.LoadFromData(NSData.FromArray(bytes))); var assetCollectionChangeRequest = PHAssetCollectionChangeRequest.ChangeRequest(assetCollection); assetCollectionChangeRequest.AddAssets(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { assetChangeRequest.PlaceholderForCreatedAsset }); }, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bool success, NSError error)</span></span></span><span class="hljs-function"> =&gt;</span></span> { }); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bytes; }</code> </pre> </div></div><br><p>  We also add a service for working with photo albums: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PhotoAlbumService</span></span> : <span class="hljs-title"><span class="hljs-title">IPhotoAlbumService</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Task&lt;List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]&gt;&gt; LoadPhotosFrom(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> albumName) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotImplementedException(); } }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Implementing the LoadPhotosFrom method (string albumName)</b> <div class="spoiler_text"><pre> <code class="hljs javascript">public Task&lt;List&lt;byte[]&gt;&gt; LoadPhotosFrom(string albumName) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> photos = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;byte[]&gt;<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">var</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tcs</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">new</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TaskCompletionSource</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">List</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">byte</span></span></span><span class="hljs-function">[]&gt;&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">var</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">userCollection</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PHAssetCollection</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">FetchAssetCollections</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PHAssetCollectionType.Album, PHAssetCollectionSubtype.Any, </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">if</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">userCollection != </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">var</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">meetUpAssetCollection</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">userCollection</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">FirstOrDefault</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">nsObject =&gt; (nsObject </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">as</span></span></span></span><span class="hljs-function"><span class="hljs-params"> PHAssetCollection</span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LocalizedTitle</span></span></span><span class="hljs-function"> == "</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Xamarin</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MeetUp</span></span></span><span class="hljs-function">") </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">as</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PHAssetCollection</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">if</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">meetUpAssetCollection != </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">var</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">meetUpPhotoResult</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PHAsset</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">FetchAssets</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">meetUpAssetCollection, </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">if</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">meetUpPhotoResult.Count &gt; </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span></span><span class="hljs-function">) </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">meetUpPhotoResult</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Enumerate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(NSObject element, nuint index, out bool stop</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> asset = element <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> PHAsset; PHImageManager.DefaultManager.RequestImageData(asset, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, (data, dataUti, orientation, info) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bytes = data.ToArray(); photos.Add(bytes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (index == <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">nuint</span></span></span><span class="hljs-function">)</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">meetUpPhotoResult</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Count</span></span></span><span class="hljs-function"> - 1) </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tcs</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TrySetResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">photos</span></span></span><span class="hljs-function">); }); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stop</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">index</span></span></span><span class="hljs-function"> == (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">nuint</span></span></span><span class="hljs-function">)</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">meetUpPhotoResult</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Count</span></span></span><span class="hljs-function">; }); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">else</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">return</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">new</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Task</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">List</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">byte</span></span></span><span class="hljs-function">[]&gt;&gt;(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="hljs-function">) =&gt;</span></span> photos); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Task&lt;List&lt;byte[]&gt;&gt;<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="hljs-function">) =&gt;</span></span> photos); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tcs.Task; }</code> </pre> </div></div><br><p>  Do not forget to add the keys <code>NSCameraUsageDescription</code> and <code>NSPhotoLibraryUsageDescription</code> . </p><br><p>  To make a screen, add a View folder to the project, create a Photogallery folder in it and add a <code>PhotogalleryViewController</code> .  Add two elements to the Interface Builder on <code>PhotogalleryViewController</code> - <code>UICollectionView</code> and <code>UIButton</code> and create <code>UICollectionView</code> and <code>UIButton</code> for them, respectively.  Now we can bind them in the <code>BindControls</code> method: </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BindControls</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _photoCollection.RegisterNibForCell(PhotogalleryCell.Nib, PhotogalleryCell.Key); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dataSource = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MvxCollectionViewSource(_photoCollection, PhotogalleryCell.Key); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.CreateBindingSet&lt;PhotogalleryViewController, IPhotogalleryViewModel&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>.Bind(dataSource).To(vm =&gt; vm.Items); <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>.Bind(_addPhotoBtn).To(vm =&gt; vm.AddPhotoCommand); <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>.Apply(); _photoCollection.DataSource = dataSource; _photoCollection.ReloadData(); }</code> </pre> <br><p>  Now our module is fully operational, it remains only to connect it to the main project. </p><br><h2>  Connecting a new module to the main project </h2><br><p>  To connect our module, you must perform six steps: </p><br><p>  <strong>The first</strong> .  Add a <code>PluginLoader</code> class to the Core project, which will start the initialization of App.cs. </p><br><div class="spoiler">  <b class="spoiler_title">Pluginloader</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PluginLoader</span></span> : <span class="hljs-title"><span class="hljs-title">IMvxPluginLoader</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> PluginLoader Instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PluginLoader(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _loaded; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EnsureLoaded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_loaded) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> App().Initialize(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> manager = Mvx.Resolve&lt;IMvxPluginManager&gt;(); manager.EnsurePlatformAdaptionLoaded&lt;PluginLoader&gt;(); MvxTrace.Trace(<span class="hljs-string"><span class="hljs-string">"Auth plugin is loaded"</span></span>); _loaded = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre> </div></div><br><p>  <strong>The second</strong> .  Add a plugin class to the UI, in which the ViewController and platform services will be registered. </p><br><div class="spoiler">  <b class="spoiler_title">Plugin</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Plugin</span></span> : <span class="hljs-title"><span class="hljs-title">IMvxPlugin</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> viewLookupService = Mvx.Resolve&lt;IViewLookupService&gt;(); viewLookupService.Register&lt;IPhotogalleryViewModel, PhotogalleryViewController&gt;(); Mvx.RegisterSingleton&lt;ICameraService&gt;(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CameraService()); Mvx.RegisterSingleton&lt;IPhotoAlbumService&gt;(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PhotoAlbumService()); } }</code> </pre> </div></div><br><p>  <strong>Third</strong>  Add the <code>XMU_PhotogalleryPluginBootstrap</code> class to the project being <code>XMU_PhotogalleryPluginBootstrap</code> . </p><br><div class="spoiler">  <b class="spoiler_title">XMU_PhotogalleryPluginBootstrap</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XMU_PhotogalleryPluginBootstrap</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MvxLoaderPluginBootstrapAction</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PluginLoader, Photogallery.iOS.Plugin</span></span></span><span class="hljs-class">&gt; </span></span>{ }</code> </pre> </div></div><br><p>  <strong>Fourth</strong> .  Register navigation on the photo gallery from the menu in the config. </p><br><div class="spoiler">  <b class="spoiler_title">Photo Gallery Navigation</b> <div class="spoiler_text"><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"icon"</span></span>:<span class="hljs-string"><span class="hljs-string">"res:Images/Menu/photo.png"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"Photogallery.Core.ViewModels.Photogallery.IPhotogalleryViewModel"</span></span> }</code> </pre> </div></div><br><p>  <strong>Fifth</strong>  Add handling event navigation to Core plugin. </p><br><div class="spoiler">  <b class="spoiler_title">PhotogalleryRouterSubscriber</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PhotogalleryRouterSubscriber</span></span> : <span class="hljs-title"><span class="hljs-title">MvxNavigatingObject</span></span>, <span class="hljs-title"><span class="hljs-title">IRouterSubscriber</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> VM_TYPE = (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IPhotogalleryViewModel)).FullName; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CanNavigatedTo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> type</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> type == VM_TYPE ? ShowViewModel(LookupService.Resolve(type)) : <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FailedNavigatedTo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> type</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//nothing } }</span></span></code> </pre> </div></div><br><p>  <strong>The sixth</strong> .  And register it in App.cs. </p><br><div class="spoiler">  <b class="spoiler_title">Register PhotogalleryRouterSubscriber</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> routerService = Mvx.Resolve&lt;IRouterService&gt;(); routerService.Register&lt;IPhotogalleryViewModel&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PhotogalleryRouterSubscriber());</code> </pre> </div></div><br><p>  Run our project and make sure everything works as planned. </p><br><h1>  Conclusion </h1><br><p>  We reviewed the main points when working with our platform.  The main thoughts that I wanted to convey: </p><br><ul><li>  You are not limited by anything; </li><li>  Try MvvmCross; </li><li>  Be innovative. </li></ul><br><p>  The discussion of the thoughts that appeared in the process of reading is suggested to be moved to the comments.  Thanks for reading! </p><br><h1>  About the authors </h1><br><p><img src="https://habrastorage.org/files/a81/3c8/b03/a813c8b03d404008aa3f01bf3cea957b.jpg" align="left" width="120">  <a href="https://habrahabr.ru/users/pocheshire/topics/">Maxim Evtukh</a> - Developer of mobile applications on the Xamarin framework in the NOTISSIMUS company.  In mobile development since 2013.  In his spare time, he studies the issue of improving MvvmCross and supporting <a href="https://github.com/pocheshire/BottomNavigationBar">GitHub</a> controls for implementing new Material Design guides. <br><br><br><img src="https://habrastorage.org/files/92b/1d9/248/92b1d9248c954b64b16d5157f586aa60.jpg" align="left" width="120">  Denis Kretov - Technical Director at NOTISSIMUS.  Specializes in the development of mobile applications for online stores, as well as solutions based on iBeacon. </p><br><p>  <em>Other articles from our Xamarin blog can be found at <a href="https://habrahabr.ru/search/%3Ftarget_type%3Dposts%26q%3D%255Bxamarincolumn%255D%26order_by%3Ddate">#xamarincolumn</a> .</em> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/316714/">https://habr.com/ru/post/316714/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316698/index.html">VKontakte will sell advertising under the new scheme and share revenue with community owners.</a></li>
<li><a href="../316700/index.html">KitchenCI + Ansible for Windows and Linux</a></li>
<li><a href="../316702/index.html">Interesting IT-vacancies on My Circle for the week, November 7-13</a></li>
<li><a href="../316706/index.html">The implementation of multiplayer in the game. Comparison of Game Center, Steamworks and GameSparks features</a></li>
<li><a href="../316708/index.html">Function length</a></li>
<li><a href="../316716/index.html">New Year's Eve Prank Using SSH Tunnel</a></li>
<li><a href="../316720/index.html">We build PVS-Studio in Anjuta DevStudio (Linux)</a></li>
<li><a href="../316722/index.html">35 resources that will be interesting to the creators of startups</a></li>
<li><a href="../316724/index.html">Personal experience: the organization of Workflow in the TFS tracker</a></li>
<li><a href="../316726/index.html">How to put things in order if you run out of power</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>