<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hierarchical data. In search of the optimal solution</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Exploring the vast spaces of the Internet, I had to work hard on how to still create a non-heavy asp.net c # code to handle the so-called ‚Äúpig ears‚Äù, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hierarchical data. In search of the optimal solution</h1><div class="post__text post__text-html js-mediator-article">  Exploring the vast spaces of the Internet, I had to work hard on how to still create a non-heavy asp.net c # code to handle the so-called ‚Äúpig ears‚Äù, which contain the classical parent-child model in the database.  Immediately make a reservation in SQL Server 2008, which already has the ability to work with hierarchical data in the OTV (CTE is the English version of the abbreviation). <br><a name="habracut"></a><br>  In my system, a business process model is built, which must meet the SADT standard and the table looks as shown below in Figure 1. <br><br><img src="https://habrastorage.org/storage2/d99/49c/5a3/d9949c5a3bb5ee7508c952b2d527fd23.png"><br>  Figure 1. Model <br><br>  Here BPNumber is a number that characterizes the order of a business process at its level of hierarchy.  For example, the subsystem of the SU (‚ÄúEducational Management‚Äù) -1, the ‚ÄúDepartment‚Äù - 2, and then the ‚ÄúDean's Office‚Äù - 3 comes first (fig. 2). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For example, the result should look something like this: <br><img src="https://habrastorage.org/storage2/47e/c1c/017/47ec1c017f43bf914d7dc0f1cf95b1bf.png"><br>  Figure 2. Result <br><br>  Having considered the examples of implementation described by other authors, as well as the help from msdn, the author came to the conclusion that dragging everything out with one list to the Public Television and processing asp.net later on the server to build the request with recursion, and bypassing it by building xml for downloading In the tree, you still need to write numerous code.  I did not think optimally. <br>  Having decided that t-sql is not short, I continued the search in other directions.  And I found this article <a href="http://www.gotdotnet.ru/blogs/sadomovalex/8845/">working with hierarchical data in asp.net mvc</a> .  Can really help someone? <br><br>  But the solution found here <a href="http://techbrij.com/display-hierarchical-data-with-treeview-in-asp-net">Display Hierarchical Data with TreeView in ASP.NET 2.0 was</a> struck with simplicity and taking it as a basis, I solved the above task to display such a list as necessary.  To convert a NULL value to -1, change the query as follows: <br><br><pre><code class="cs hljs">SqlCommand dbCommand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlCommand(<span class="hljs-string"><span class="hljs-string">"SELECT [BusinessProcessID], [BPName], [ProjectID], case when [BusinessProcessIDTOP] IS NULL then -1 else [BusinessProcessIDTOP] end as [BusinessProcessIDTOP] FROM [BusinessProcess] WHERE ([ProjectID] = "</span></span> + HiddenField1.Value.ToString() + <span class="hljs-string"><span class="hljs-string">") order by BPNumber"</span></span>, myConn);</code> </pre> <br><br>  Listing 1. Search for the top node <br>  Well, the whole listing looks like this <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Data.SqlClient; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">bptree</span></span> : <span class="hljs-title"><span class="hljs-title">System</span></span>.<span class="hljs-title"><span class="hljs-title">Web</span></span>.<span class="hljs-title"><span class="hljs-title">UI</span></span>.<span class="hljs-title"><span class="hljs-title">Page</span></span> { DataTable dtTree = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataTable(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Page_Load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { String strConnect = SqlDataSource1.ConnectionString; SqlConnection myConn = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlConnection(strConnect); myConn.Open(); SqlCommand dbCommand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlCommand(<span class="hljs-string"><span class="hljs-string">"SELECT [BusinessProcessID], [BPName], [ProjectID], case when [BusinessProcessIDTOP] IS NULL then -1 else [BusinessProcessIDTOP] end as [BusinessProcessIDTOP] FROM [BusinessProcess] WHERE ([ProjectID] = "</span></span> + HiddenField1.Value.ToString() + <span class="hljs-string"><span class="hljs-string">") order by BPNumber"</span></span>, myConn); SqlDataAdapter da = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlDataAdapter(dbCommand); da.Fill(dtTree); da.Dispose(); dbCommand.Dispose(); myConn.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!IsPostBack) AddNodes(<span class="hljs-number"><span class="hljs-number">-1</span></span>, TreeView1.Nodes); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddNodes</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id, TreeNodeCollection tn</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (DataRow dr <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dtTree.Select(<span class="hljs-string"><span class="hljs-string">"BusinessProcessIDTOP = "</span></span> + id)) { TreeNode sub = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TreeNode(dr[<span class="hljs-string"><span class="hljs-string">"BPName"</span></span>].ToString(), dr[<span class="hljs-string"><span class="hljs-string">"BusinessProcessID"</span></span>].ToString()); tn.Add(sub); AddNodes(Convert.ToInt32(sub.Value), sub.ChildNodes); } } }</code> </pre><br>  Listing 2. Solving a problem in 2 methods <br><br>  But what about the OTV.  So for the tasks described below, I think they are better suited: <br><ul><li>  Search for a specified node level </li><li>  Path calculations (for example with files) </li><li>  Finding nodes that have the necessary ancestors </li><li>  Well, mass calculations, which are defined in the set </li></ul><br>  For example, here‚Äôs the t-sql code with the OTB: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/******    ******/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> cte_bp([BusinessProcessID] ,[BPName],[BusinessProcessIDTOP], <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> ,paths) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [BusinessProcessID] ,[BPName] ,[BusinessProcessIDTOP], <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">level</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>([BPName]<span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>))+<span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [cmk].[dbo].[BusinessProcess] <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> [ProjectID]=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> BusinessProcessIDTOP <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [BusinessProcess].[BusinessProcessID] ,[BusinessProcess].[BPName] ,[BusinessProcess].[BusinessProcessIDTOP], <span class="hljs-keyword"><span class="hljs-keyword">level</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>, d.paths +<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>([BusinessProcess].[BPName] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>))+<span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [cmk].[dbo].[BusinessProcess] <span class="hljs-keyword"><span class="hljs-keyword">Inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> cte_bp <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> d <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> d.BusinessProcessID=BusinessProcess.BusinessProcessIDTOP ) <span class="hljs-comment"><span class="hljs-comment">-- Statement using the CTE SELECT *, SPACE(level)+BPName as ch FROM cte_bp order by paths,BusinessProcessID</span></span></code> </pre><br>  Listing 3. Working with OTV <br><br>  Here is the result returned: <br><br><img src="https://habrastorage.org/storage2/9d7/6bc/8e8/9d76bc8e86a2b3264023ea941c94e750.png"><br>  Figure 3. Query result <br><br>  I think this example will help those who, like the author of this topic, are looking for a trivial and fast solution for displaying hierarchical data stored on SQL Server 2008 and higher. </div><p>Source: <a href="https://habr.com/ru/post/187664/">https://habr.com/ru/post/187664/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../187650/index.html">Plug - home cloud storage</a></li>
<li><a href="../187654/index.html">Cache secrets, or how to spend 1000 cycles for 10 teams</a></li>
<li><a href="../187658/index.html">What are the types of project managers?</a></li>
<li><a href="../187660/index.html">Building drbd mirrors on Proxmox-3.0</a></li>
<li><a href="../187662/index.html">Poll. Would you like to participate in a project like Mars One?</a></li>
<li><a href="../187666/index.html">The dual education system in Germany - what it is and what it is eaten with</a></li>
<li><a href="../187668/index.html">Golang daemon</a></li>
<li><a href="../187672/index.html">New book Koflera. Linux Installation, configuration, administration</a></li>
<li><a href="../187674/index.html">97-year-old painter paints pictures in Microsoft Paint</a></li>
<li><a href="../187678/index.html">Ancient device - scales</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>