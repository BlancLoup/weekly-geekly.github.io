<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How-to: Object-Oriented Python Backtesting</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Well-known British trader and developer Mike Halls-Moore wrote in his blog an article about how to create an object-oriented backtesting system for fi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How-to: Object-Oriented Python Backtesting</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habrahabr.ru/company/itinvest/blog/276151/"><img src="https://habrastorage.org/files/b00/c71/8ca/b00c718ca10b48069f227eb33fe33644.png"></a> <br><br>  Well-known British trader and developer Mike Halls-Moore <a href="https://www.quantstart.com/articles/Research-Backtesting-Environments-in-Python-with-pandas">wrote</a> in his blog an article about how to create an object-oriented backtesting system for financial trading strategies on the stock exchange.  We bring to your attention the main thoughts of this material. <a name="habracut"></a><br><br><h4>  What is backtesting </h4><br>  By backtesting we understand the process of applying a specific trading strategy to a historical date in order to evaluate its possible performance in the past.  This, however, does not provide any guarantee that the system will be successful in the future.  Nevertheless, there are ways to ‚Äúfilter out‚Äù strategies that are definitely not worthy of spending time and money on them in the course of real trading. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Creating a reliable backtesting system is not easy, because it must be able to successfully simulate the behavior of various components that affect the performance of an algorithmic trading strategy.  Lack of data, problems on the communication channels between the client and the broker, delays in the execution of the application - these are just a few factors that can affect whether the transaction will be successful or not. <br><br>  Not all of these factors are known in advance, so as the trader finds out what else affects the trading process on the stock exchange, the backtesting system is usually added to reflect this new knowledge.  In this article we will look at an example of creating such a simple system using Python. <br><br><h4>  Types of backtesting systems </h4><br>  There are two main types of backtesting systems.  One of them is called ‚Äúresearch-based‚Äù and is used mostly in the early stages of evaluating strategies when it is necessary to select the most promising for further work.  Such systems are often written in Python, R or Matlab, since in this case the speed of development is more important than the speed of work. <br><br>  The next type is event-oriented back-testers (event-based).  In their case, the backtesting process follows the scenario as close as possible (if not identical) to real trading.  The system realistically models market data and the process of order execution, which allows for a deeper assessment of the analyzed strategy. <br><br>  Often, such systems are written in C ++, because the speed of their work already plays an important role.  Although for testing strategies that do not imply extremely high speed, you can still use Python (here we considered creating an <a href="http://habrahabr.ru/company/itinvest/blog/270215/">event-oriented back tester</a> in this language). <br><br><h4>  Python object oriented backtester </h4><br>  The object-oriented approach to developing a backtester has its advantages: <br><br><ul><li>  The interfaces of each component of the system can be designed in advance, but their internal content can be modified or replaced later in the course of the project. </li><li>  It allows you to effectively perform unit testing. </li><li>  With the help of inheritance and composition, you can design new components that extend the system. </li></ul><br>  In our example, we will create a simple backtester who can work with a strategy that uses only one financial instrument (for example, a stock).  For such a system will require the following components: <br><br><ul><li>  <b>Strategy</b> - the Strategy class with a certain frequency receives the Pandas data frame containing bars, that is, a list of data points on the opening price, maximum, minimum, closing price and trading volume for the trading period (Open-High-Low-Close-Volume, OHLCV) .  Strategy then creates a list of signals that consist of a timestamp and an element from the set {1,0, -1}, indicating a long position, a position hold or a short sale. </li><li>  <b>Portfolio</b> - most of the backtesting itself will be implemented by the Portfolio class.  It will receive a set of signals and create rows of positions from them, matching from the available funds.  The task of the Portfolio facility is to create a capital curve, analyze the basic transaction costs and track transactions. </li><li>  <b>Performance</b> - this object uses a portfolio to get statistics on its effectiveness.  In particular, it calculates the characteristics of risk and capital return, the profitability or loss ratio of transactions, as well as information about the drawdown of the amount of available funds. </li></ul><br><br>  As it is easy to see, in this case we exclude objects related to risk management, application processing (that is, the system does not know how to work with limit orders) or complex modeling of transaction costs.  The challenge here is to create a basic backtester that can be improved afterwards. <br><br><h4>  Implementation </h4><br>  Now consider the implementation of each object used: <br><br><h5>  Strategy </h5><br>  The Strategy object will process pricing, mean-reversion, momentum, and volatility strategies.  The strategies that are considered in this example are always based on time series, that is, ‚Äúprice driven‚Äù (price driven).  In particular, this implies that the object will receive not ticks of bidding information as input, but a set of OHLCV indicators.  Thus, the maximum possible detail here is 1 second bars. <br><br>  In addition, the Strategy class will generate alarm recommendations.  This means that he will advise the Portfolio object what action is best to prepend.  The Portfolio class will then analyze the data along with these recommendations in order to generate a set of signals to enter or exit a position. <br><br>  The class interface will be implemented using the methodology of <a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D0%25B1%25D1%2581%25D1%2582%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BA%25D0%25BB%25D0%25B0%25D1%2581%25D1%2581">abstract base classes</a> .  The Python code will be in the backtest.py file.  The Strategy class requires that any implemented subclass use the generate_signals method. <br><br>  In order for the Strategy not to create an instance (also known as asbtraktny), you must use the ABCMeta and abstractmethod objects from the abc module.  Set the <code>_metaclass_</code> class <code>_metaclass_</code> to ABCMeta and decorate the <code>generate_signals</code> method using the <code>abstractmethod</code> decorator. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backtest.py from abc import ABCMeta, abstractmethod class Strategy(object): """Strategy ‚Äî    ,           Strategy     ,      - pandas.          .""" __metaclass__ = ABCMeta @abstractmethod def generate_signals(self): """    ,        ,    (1, -1 or 0).""" raise NotImplementedError("Should implement generate_signals()!")</span></span></code> </pre><br><h5>  Portfolio </h5><br>  The Portfolio class contains most of the trading logic.  For this backtester, this object will be responsible for determining the position size, risk analysis and transaction costs.  In the course of further development, these tasks need to be separated into separate components, but now they can be combined in one class. <br><br>  To implement this class, we will use pandas - this library can save a lot of time here.  The only point is to avoid iterating the dataset using the <code>for d in ‚Ä¶</code> syntax.  The fact is that NumPy optimizes loops using vectorized operations.  Therefore, when using pandas, direct iterations are almost never met. <br><br>  The task of the Portfolio class is to ultimately generate a sequence of transactions and a capital curve, which will then be analyzed by the Performance class.  In order to do this, the class must receive a series of recommendations from the Strategy object (in more complex cases, there may be many such objects). <br><br>  The Portfolio class needs to be told how to apply capital to a particular set of trading signals, how to account for transaction costs, and what types of exchange orders should be used.  The Strategy object works with data bars, so assumptions must be made on the basis of the price that exists at the time the order is executed.  Since the maximum and minimum prices of any current bar are a priori unknown, it is only possible to use the opening and closing prices (of the previous bar).  In reality, however, when using market orders (market) it is impossible to guarantee the execution of an order at a specific price, so the price here will be no more than an assumption. <br><br>  In this case, the backtester will also ignore everything related to the concept of collateral and restrictions on the part of the broker, assuming that it is possible to open long and short positions in any financial instrument without any liquidity restrictions.  Of course, this is an unrealistic assumption, so during the development of the project it should be removed. <br><br>  We continue to study the code: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backtest.py class Portfolio(object): """      (   ),        Strategy.""" __metaclass__ = ABCMeta @abstractmethod def generate_positions(self): """    ,            . """ raise NotImplementedError("Should implement generate_positions()!") @abstractmethod def backtest_portfolio(self): """              (   ) ‚Äî     , /    .. Produces a portfolio object that can be examined by other classes/functions.""" raise NotImplementedError("Should implement backtest_portfolio()!")</span></span></code> </pre><br>  These are the basic descriptions of the abstract base classes Strategy and Portfolio.  Now it's time to create dedicated implementations of these classes so that the system can more efficiently process the test strategy. <br><br>  We <code>RandomForecastStrategy</code> start by creating a Strategy subclass called <code>RandomForecastStrategy</code> ‚Äî its only task is to generate random signals to buy or short sell stocks.  At first glance, this makes no sense, however, such a simple strategy will allow us to illustrate the work of the object-oriented backtesting framework. <br><br>  Create a new file <code>random_forecast.py</code> with the module code with random recommendations: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># random_forecast.py import numpy as np import pandas as pd import Quandl # Necessary for obtaining financial data easily from backtest import Strategy, Portfolio class RandomForecastingStrategy(Strategy): """  Strategy         long  short.       """ def __init__(self, symbol, bars): """Requires the symbol ticker and the pandas DataFrame of bars""" self.symbol = symbol self.bars = bars def generate_signals(self): """  pandas DataFrame,    .""" signals = pd.DataFrame(index=self.bars.index) signals['signal'] = np.sign(np.random.randn(len(signals))) #         NaN-: signals['signal'][0:5] = 0.0 return signals</span></span></code> </pre><br>  Now, having received a test system for creating recommendations, you must create an implementation of the Portfolio object.  This object will include most of the backtesting code.  It will create two separate data frames - the first one will contain positions (positions), it will be used to store the number of instruments purchased or sold during the bar.  Next - the portfolio contains the market prices of all positions for each bar, as well as the amount of available funds.  This allows you to build a capital curve to evaluate strategy performance. <br><br>  Implementing a Portfolio object requires deciding how to handle transaction costs, market orders, etc.  In this example, it is assumed that it is possible to open long and short positions without limitations of the collateral, to buy and sell clearly at the bar‚Äôs opening price, transaction costs are zero (price slippage, broker and exchange commissions, etc.) are discarded, and the number of shares for purchase or sale is indicated directly for each transaction. <br><br>  Next is the continuation of the file <code>random_forecast.py</code> : <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># random_forecast.py class MarketOnOpenPortfolio(Portfolio): """ Portfolio   ,   100   ,       .  ,    ,          . : symbol - ,   . bars -     . signals -  pandas  (1, 0, -1)   . initial_capital -     .""" def __init__(self, symbol, bars, signals, initial_capital=100000.0): self.symbol = symbol self.bars = bars self.signals = signals self.initial_capital = float(initial_capital) self.positions = self.generate_positions() def generate_positions(self): """  'positions'           100 ,    {1, 0, -1}    .""" positions = pd.DataFrame(index=signals.index).fillna(0.0) positions[self.symbol] = 100*signals['signal'] return positions def backtest_portfolio(self): """       ‚Äî           ( ).          ‚Äî       .   portfolio,     .""" #   'pos_diff'   portfolio     ,      ,      portfolio = self.positions*self.bars['Open'] pos_diff = self.positions.diff() #             'holdings'  'cash' portfolio['holdings'] = (self.positions*self.bars['Open']).sum(axis=1) portfolio['cash'] = self.initial_capital - (pos_diff*self.bars['Open']).sum(axis=1).cumsum() #       ('cash')          portfolio['total'] = portfolio['cash'] + portfolio['holdings'] portfolio['returns'] = portfolio['total'].pct_change() return portfolio</span></span></code> </pre><br>  Now you need to tie everything together using the <code>_main_</code> function: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">"__main__"</span></span>: <span class="hljs-comment"><span class="hljs-comment">#    SPY (ETF,      S&amp;P500)  Quandl (     'pip install Quandl' symbol = 'SPY' bars = Quandl.get("GOOG/NYSE_%s" % symbol, collapse="daily") #          SPY rfs = RandomForecastingStrategy(symbol, bars) signals = rfs.generate_signals() #   SPY portfolio = MarketOnOpenPortfolio(symbol, bars, signals, initial_capital=100000.0) returns = portfolio.backtest_portfolio() print returns.tail(10)</span></span></code> </pre><br>  The output of the program is presented below (in each particular case it will differ due to the different selected date ranges and the use of randomization): <br><br><img src="https://habrastorage.org/files/3ad/c60/754/3adc607548be40c4b047fb6a4eb7348c.png"><br><br>  In this case, it is clear that the strategy leads to losses, which is not surprising, given its features.  In order to transform this test case into a more efficient backtester, you also need to create a Performance object that will accept input from Portfolio and issue a set of performance metrics on which to base your decision on filtering the strategy. <br><br>  In addition, you can improve the Portfolio object so that it more realistic takes into account information about transaction costs (for example, slippage or broker commission).  You can also include the ‚Äúpredictive engine‚Äù directly into the Strategy object, which should also allow you to achieve the best results. <br><br>  That's all for today!  Thank you for your attention, and do not forget to subscribe to <a href="http://habrahabr.ru/company/itinvest/blog/">our blog</a> . <br><br><h4>  Other articles about creating trading robots: </h4><br><ul><li>  <a href="https://habrahabr.ru/post/260581/">What programming languages ‚Äã‚Äãand why are used in finance</a> </li><li>  <a href="https://habrahabr.ru/post/250169/">What to consider when developing the first trading robot</a> </li><li>  <a href="https://habrahabr.ru/post/249299/">What to consider when developing a strategy for a trading robot</a> </li><li>  <a href="https://habrahabr.ru/post/238839/">Back to the Future: Testing a Trading Robot with Historical Data</a> </li><li>  <a href="https://habrahabr.ru/post/224353/">Step-by-step guide to the development of a trading system for the stock market</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/276151/">https://habr.com/ru/post/276151/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276139/index.html">The simplest 3D game on libGDX for Android with 200 lines of code</a></li>
<li><a href="../276141/index.html">We fool the DPI with two scripts</a></li>
<li><a href="../276145/index.html">IaaS for business: How Russian business moves to the ‚Äúcloud‚Äù</a></li>
<li><a href="../276147/index.html">Half a year working with Blend4Web. Is it worth it?</a></li>
<li><a href="../276149/index.html">Hacking Kaspersky Crackme: a study of the protective mechanism (Part 1)</a></li>
<li><a href="../276153/index.html">How much did Google pay for the lost google.com domain?</a></li>
<li><a href="../276155/index.html">Symfony2 interceptor of exceptions using services or how to avoid using Event Listener</a></li>
<li><a href="../276157/index.html">Video Surveillance Solutions Need Enterprise Level Strategy</a></li>
<li><a href="../276159/index.html">Real-Time Games and Cross Domain Connection</a></li>
<li><a href="../276163/index.html">Migrating data from various types of storage using EMC VPLEX and EMC RecoverPoint technologies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>