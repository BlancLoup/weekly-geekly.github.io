<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sality virus modifies the DNS service of routers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Win32 / Sality file infector family has been known for a long time and has been using a P2P-based botnet since 2003. Sality can act both as a viru...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sality virus modifies the DNS service of routers</h1><div class="post__text post__text-html js-mediator-article">  The <a href="http://www.virusradar.com/en/Win32_Sality/detail">Win32 / Sality</a> file infector family has been known for a long time and has been using a P2P-based botnet since 2003. Sality can act both as a virus and as a downloader of other malicious programs that are used to send spam, create DDoS, generate ad traffic or hack VoIP accounts.  Commands and files transmitted over the Sality network are encrypted using RSA (the so-called digital signature).  The modular architecture of the malicious program, as well as the longevity of the botnet, show how well the attackers approached the creation of this malicious code. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/49f/01f/c8e/49f01fc8e2ff988fc68f448b9b9194ab.png"><br><br>  We tracked the <b>Win32 / Sality</b> botnet for a long time and observed more than 115,000 available IP addresses that were instructed by ‚Äúsuper peers‚Äù to maintain the botnet in working condition and coordinate them.  We saw similar Sality components that he downloaded onto infected computers.  Some of them were similar and differed only in behavior.  However, recently, we have discovered a new component with previously unnoticed properties.  Unlike the already known Sality components, which are used to steal passwords from FTP accounts and send spam, it has the ability to substitute the address of the router‚Äôs primary DNS server (DNS hijacking).  According to our telemetry data, this component appeared at the end of October 2013. It was named <b>Win32 / Rbrute</b> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>  The Win32 / RBrute component adds truly new features to the work of Win32 / Sality.  The first module, detected by ESET as <b>Win32 / RBrute.A</b> , searches the webpages of the router's <b>control</b> panels by scanning a specific set of IP addresses to change the record of the main DNS server.  The new fraudulent DNS server redirects users to a fake Google Chrome browser installation webpage when they access websites containing the words ‚Äúgoogle‚Äù or ‚Äúfacebook‚Äù in the domain name.  Instead of a browser, the user is downloaded a malicious Win32 / Sality file itself.  Thus, the attackers secure their new installations and the expansion of the botnet of this malware family. <br><br>  The IP address that is used as the primary DNS server on the compromised router is actually part of the Win32 / Sality network.  There is another modification of the malware, <b>Win32 / RBrute.B</b> , it installs Sality on compromised computers and can act as a DNS or HTTP proxy server to deliver a fake Google Chrome browser installer to users who have been redirected through a malicious router. <br><br>  We can say that the modification technique of the main DNS router is already quite common for various purposes, starting with the purpose of stealing online banking data and ending with blocking client connections to security vendors' websites.  This was especially true in connection with the recent discovery of vulnerabilities in the firmware of various models of routers.  Win32 / RBrute.A tries to find the administrative web pages of routers by scanning a range of IP addresses received from the C &amp; C server.  In the future, a report on this operation will be sent back to the C &amp; C server.  At the time of our analysis, Win32 / RBrute.A was used to gain access to the following router models: <br><br><ul><li>  Cisco routers that contain the string "level_15_" in the HTTP protocol realm attribute </li><li>  D-Link DSL-2520U </li><li>  D-Link DSL-2542B </li><li>  D-Link DSL-2600U </li><li>  Huawei EchoLife </li><li>  TP-LINK </li><li>  TP-Link TD-8816 </li><li>  TP-Link TD-8817 </li><li>  TP-Link TD-8817 2.0 </li><li>  TP-Link TD-8840T </li><li>  TP-Link TD-8840T 2.0 </li><li>  TP-Link TD-W8101G </li><li>  TP-Link TD-W8151N </li><li>  TP-Link TD-W8901G </li><li>  TP-Link TD-W8901G 3.0 </li><li>  TP-Link TD-W8901GB </li><li>  TP-Link TD-W8951ND </li><li>  TP-Link TD-W8961ND </li><li>  TP-Link TD-W8961ND </li><li>  ZTE ZXDSL 831CII </li><li>  ZTE ZXV10 W300 </li></ul><br>  If a web page is found, the C &amp; C server sends the bot a small list of ten brute force passwords.  In the case when the bot picked up the desired password and can log into the account of the router, it will begin to change the settings of the DNS server.  It is interesting to note that to gain access to the administrative panel account, only the password search method is used without exploiting any vulnerability.  Authentication can be done with the usernames ‚Äúadmin‚Äù or ‚Äúsupport‚Äù, although previous versions also tried to use ‚Äúroot‚Äù and ‚ÄúAdministrator‚Äù.  Below is a list of passwords that were transmitted from the C &amp; C server to the bot: <br><br><ul><li>  empty line </li><li>  111111 </li><li>  12345 </li><li>  123456 </li><li>  12345678 </li><li>  abc123 </li><li>  admin </li><li>  Administrator </li><li>  consumer </li><li>  dragon </li><li>  gizmodo </li><li>  iqrquksm </li><li>  letmein </li><li>  lifehack </li><li>  monkey </li><li>  password </li><li>  qwerty </li><li>  root </li><li>  soporteETB2006 </li><li>  support </li><li>  tadpassword </li><li>  trustno1 </li><li>  we0Qilhxtx4yLGZPhokY </li></ul><br>  In case of successful login, the malicious code changes the address of the main DNS server to a fake one, reports a successful infection operation to C &amp; C and continues scanning the range of IP addresses.  After such a DNS modification has been made, all requests for address resolvers will go through this server to malicious users, who will relay them to web pages with fake Google Chrome browser installers, in the case of the presence of the ‚Äúfacebook‚Äù or ‚Äúgoogle‚Äù domains in the original request. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/90b/4de/f1a/90b4def1a77fe95d4cfe0a00dcdf1b44.png"><br>  Fig.  The webpage if the domain is successfully redirected, which contains the word "google." <br><br>  This malware is somewhat similar to the well-known DNSChanger, which redirected users to install malware through advertising fake software.  On the advertising sites themselves, the user is redirected through a malicious DNS. <br><br>  In the case of Sality, as soon as the computer is exposed to infection through a fake Google Chrome browser installer launched by a user, the configuration of the DNS server in Windows is changed to 8.8.8.8 by malicious code by modifying the <i>NameServer</i> registry <i>value</i> to the specified value in HKLM \ SYSTEM \ ControlSet001 \ Services \ Tcpip \ Parameters \ Interfaces \ {network interface UUID}.  This IP address is not malicious and belongs <a href="http://ru.wikipedia.org/wiki/Google_Public_DNS">to Google's</a> alternative <a href="http://ru.wikipedia.org/wiki/Google_Public_DNS">DNS server</a> . <br><br>  After the installation of the DNS server is completed, the DNS record of the router for this PC becomes useless and the OS will use the server explicitly specified in the registry.  On the other hand, other computers that will try to connect to this router will be subjected to malicious redirections, since the router's DNS record is still modified. <br><br>  The Win32 / Sality malware, which modifies the router's DNS service, consists of two executable files: a router address scanner and a DNS / HTTP server. <br><br>  The address scanner is detected by ESET as <b>Win32 / RBrute.A</b> .  At the beginning of his work, he creates a mutex with the name "19867861872901047sdf", which allows him to keep track of an already running instance of malware.  Then every minute he checks the hard-wired IP address in the code to get the command.  The command can be of two types: check the range of IP addresses or try to log into the account of the control panel of the router to modify the DNS service.  The instruction for checking the range of addresses comes with the IP address of the beginning of the range and the number of addresses.  Win32 / RBrute.A will send an HTTP GET request to TCP port 80, hoping to get an error 401 - Unauthorized.  The router model will be extracted from the HTTP protocol's realm attribute (more precisely, see its <a href="http://tools.ietf.org/html/rfc2617">authentication scheme</a> ).  If a router is found, the malicious program sends its IP address back to C &amp; C. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ae5/242/30a/ae524230aa8281880c38d0b9d69b40bd.png"><br>  Fig.  A block diagram of the work of Win32 / RBrute.A. <br><br>  After the IP address is sent to C &amp; C, the bot receives a command to enter the control panel of the router.  It uses the login and password issued by C &amp; C.  In case of successful login, the malicious code modifies the address of the main DNS server, which will now point to another computer infected with another modification of RBrute - <b>Win32 / RBrute.B</b> . <br><br>  Earlier we mentioned a component of a malicious program that acts as a DNS / HTTP server.  It is detected as Win32 / RBrute.B. and the execution of its code is divided into three streams: a control flow, a DNS server flow and an HTTP server flow.  Although this malicious component can simultaneously run both DNS and HTTP services, in fact, it selects one of them to run using a randomly generated value.  A special constant in the formula is used to ensure that in 80% of the cases the bot will act as a DNS server, although in the initial period of tracking the operation using this malicious program, we observed a constant that guaranteed 50% of the cases as DNS. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/337/938/692/337938692221067e998d9ba152df02e3.png"><br>  Fig.  Code to select a DNS or HTTP server to start. <br><br>  RBrute.B has another branch of the code, which is executed when the above code worked incorrectly. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/42c/4a9/fee/42c4a9feead3df67457460b3c74b9681.png"><br>  Fig.  Another mechanism for launching HTTP / DNS server streams in malicious code. <br><br>  RBrute operators can manually start the above streams by sending a specially crafted DNS or HTTP request.  Like RBrute.A, RBrute.B uses a special mutex named "SKK29MXAD" to prevent its second copy from running on an infected system. <br><br>  The control thread is used to send data collected by the malware back to the C &amp; C server.  Every two minutes RBrute.B sends a data packet to a hard-wired IP address.  This package contains information about the system in which the bot is running.  The managing server will then provide the bot with an IP address that will be used to deliver the fake Google Chrome installer.  If the bot is running in DNS server mode, the IP address of the C &amp; C server will be the same as the address you want to use as a distribution server of a fake browser installer.  Otherwise, the management server will send the IP address that is outside the Sality P2P infrastructure and will be used to distribute fake Chrome installers. <br><br>  The following is information about the system that is sent by the control flow to a remote server. <br><br><ul><li>  The system name is <i>GetComputerName ()</i> . </li><li>  The recorded time is <i>GetLocalTime ()</i> . </li><li>  Country - <i>GetLocaleInfo ()</i> . </li><li>  The path to the Windows directory is <i>GetWindowsDirectoryA ()</i> . </li><li>  The product name of the OS is from the system registry HKEY_LOCAL_MACHINE \ SOFTWARE \ Microsoft \ Windows NT \ CurrentVersion \ Product Name. </li><li>  Processor names - from the registry HKEY_LOCAL_MACHINE \ HARDWARE \ DESCRIPTION \ System \ CentralProcessor \ &lt;CPU #&gt; \ ProcessorNameString. </li><li>  Memory size of <i>GlobalMemoryStatus ()</i> . </li><li>  The presence of a debugger - <i>IsDebuggerPresent ()</i> . </li><li>  The amount of memory used by the <i>GetProcessMemoryInfo ()</i> malware. </li><li>  The running time of the malicious program is in minutes. </li><li>  The number of threads that are running. </li></ul><br>  Information package has the following format: <br><br><blockquote>  0x00 DWORD Test_Count (CRC32) <br>  0x04 WORD <i>useful_size_load</i> <br>  0x06 BYTE <i>not_used</i> <br>  0x07 BYTE <i>work_mode</i> (HTTP - 0x32 or DNS - 0x64) </blockquote><br>  Below is a screenshot of the package information sent to C &amp; C. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4d7/6db/87f/4d76db87f3ce7b36c108d660974a9543.png"><br>  Fig.  Package sent by the bot to the remote server.  Blue is the checksum field, red is the payload size field, black is the encrypted server operation mode constant, and green is the encrypted system information. <br><br>  Information about the system can be (in the package encrypted using RC4): <br><br>  <b>9BC13555 | 03.24.2014 21: 56: 27 | United States | C: \ WINDOWS | Microsoft Windows XP | proc # 0 QEMU Virtual CPU version 1.0 | 1 | 358 | 511 | 1117 | 1246 | 0 | 2 | 0 | 0 |</b> <br><br>  The management server will then respond with a packet that contains the IP address to use.  The package has the form. <br><br><blockquote>  0x00 DWORD Test_Count (CRC32) <br>  0x04 WORD <i>useful_size_load</i> <br>  0x06 BYTE <i>not_used</i> <br>  0x07 BYTE <i>command</i> (0x02 - start or 0x03 - stop the service) <br>  0x08 DWORD IP_address_service (System running Win32 / Rbrute.B or another HTTP server) </blockquote><br>  The DNS server component stream is waiting for requests that contain the words ‚Äúgoogle‚Äù or ‚Äúfacebook‚Äù in the domain name.  If it detects a similar request, an IP address of the HTTP server required by the attackers, which they previously sent to this bot (Win32 / Rbrute.B) via C &amp; C, is sent to the unsuspecting client.  If the request does not contain these two words, it will be redirected to the Google DNS service ("8.8.8.8" or "8.8.4.4"), and then to the client. <br><br>  A bot sending a request to the server via the UDP protocol on port 53 of a packet with the constant ‚Äú0xCAFEBABE‚Äù in the payload field will result in the setting of the ‚Äúudme‚Äù flag in the HKEY_CURRENT_USER \ SOFTWARE \ Fihd4 registry section.  This flag ensures that the DNS server stream will be started after a reboot.  The server must respond with the constant "0xDEADCODE" to confirm that this action is completed. <br><br>  We mentioned a separate HTTP service stream in Win32 / RBrute.B.  Consider it in more detail.  This service serves users who have been redirected through a malicious DNS router to download a fake Google Chrome browser distribution.  When receiving a request via HTTP, the service flow will first analyze the User-Agent parameter in the header.  Further service behavior depends on what is in this parameter. <br><br>  If the User-Agent parameter contains the string "linux" or "playstation", the service will simply break the connection.  If the User-Agent contains information that the browser is used on a mobile device (there are "android", "tablet", "Windows CE", "blackberry" or "opera mini"), then the service may respond with a fake browser installer .  Also, a fake Chrome installer will be delivered if the User-Agent contains ‚Äúopera‚Äù, ‚Äúfirefox‚Äù, ‚Äúchrome‚Äù, ‚Äúmsie‚Äù, or something else. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5ce/0ad/3ab/5ce0ad3ab94e1dcb3c4acc41323484e9.png"><br><br>  As in the case of the DNS service, the operator can itself influence the behavior of the HTTP service by sending a specially formed HTTP packet.  He can do this by sending a GET or POST request with a special User-Agent "BlackBerry9000 / 5.0.0.93 Profile / MIDP-2.0 Configuration / CLDC-2.1 VendorID / 831", which will cause the bot to set the "htme" flag in the HKEY_CURRENT_USER \ SOFTWARE registry key \ Fihd4.  This ensures that the HTTP server starts after a reboot.  The server (bot with Win32 / RBrute.B) must respond with the message ‚Äúkenji oke‚Äù to confirm the execution of the command. <br><br>  All Sality components that need to receive connections from the network incorporate the same code to add a special Windows Firewall rule that allows inbound connections for the malware process.  Such an operation is performed by adding the parameter " <i>harmful_file_program_name: *: Enabled: ipsec</i> " to the registry key HKEY_LOCAL_MACHINE \ SYSTEM \ CurrentControlSet \ Services \ SharedAccess \ Parameters \ FirewallPolicy \ StandardProfile \ AuthorizedApplications \ List.  Below is the function code <i>add_to_firewall_exception Sality</i> , which performs this operation. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/030/fb1/4a0/030fb14a08ba28e8ac4cffd46221191a.png"><br><br>  In the Win32 / RBrute.B component, this function is called at the beginning of the execution of the malicious program. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/298/37c/202/29837c20290bb8c00d2755a3ea534e08.png"><br>  Fig.  From here, the <i>add_to_firewall_exception</i> function is <i>called</i> . <br><br>  A similar code is in the spam bot component, which belongs to Sality. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a5c/2df/d85/a5c2dfd8531f9c7fa3e2609bd5386f4e.png"><br>  Fig.  Spam bot code Sality, in which <i>add_to_firewall_exception</i> is <i>called</i> . <br><br>  Our telemetry data shows that Win32 / Sality activity is currently declining, or at least remains at the same level as in 2012. We believe that the reduction in the number of detections is due to the low efficiency of current users' infection vectors.  This could explain the fact that attackers are looking for new ways to spread Win32 / Sality. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9a4/6fa/5f0/9a46fa5f047ea40c4a4d0a42c000b2e1.png"><br><br>  If we look at the statistics of Sality detections over the last year, we will see a slight increase in the number of detections, approximately in December 2013. This date coincides with the time of the first activity of the RBrute component, which replaces the router's DNS service. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/38c/b70/ff6/38cb70ff6cad38a505198f0b655e43cf.png"><br><br>  We are not sure whether the RBrute component is real for attackers, since the vast majority of routers are only listened to by a rigidly fixed address space (i.e., 192.168.0.0/16), which makes the control panel inaccessible from the Internet.  In addition, the RBrute component does not brute forcefully, but only tries to apply ten passwords from its list. <br><br>  <b>Conclusion</b> <br><br>  Simple vectors infecting users with Win32 / Sality malicious code may not be efficient enough to keep the botnet population at an appropriate level.  The attackers needed a new way to distribute the malware and in this way became the DNS hijacking for the router.  Depending on whether the selected router is susceptible to exploitation, many users connected to it may be victims of redirections.  We recommend using secure passwords for accounts of control panels of routers, and also to check whether it is really necessary to allow access to it from the Internet. </div><p>Source: <a href="https://habr.com/ru/post/218655/">https://habr.com/ru/post/218655/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../218645/index.html">Smart watch do it yourself for 1500 rubles. Part 2 - Board and Components</a></li>
<li><a href="../218647/index.html">QR codes for Linux kernel crash reports</a></li>
<li><a href="../218649/index.html">FundingTo - fundraising according to your rules. Part two</a></li>
<li><a href="../218651/index.html">Who to entrust your business? Part 1 - Accounting</a></li>
<li><a href="../218653/index.html">Students-doctors virtually operate three-dimensional bodies</a></li>
<li><a href="../218659/index.html">Chromecast has received new features - Support for "live" broadcasts</a></li>
<li><a href="../218661/index.html">Implications of OpenSSL HeartBleed</a></li>
<li><a href="../218663/index.html">The original method of avoiding conflict as a type of psychological struggle</a></li>
<li><a href="../218667/index.html">3D printer ‚Äúfor all‚Äù collected $ 1 million instead of $ 50,000 (in just 2 days) on Kickstarter</a></li>
<li><a href="../218669/index.html">Myths and legends about Big Data</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>