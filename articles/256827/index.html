<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reverse engineering integer division by constant</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So it happens that sometimes you reverse the code that deals with some kind of routine that does not involve any serious calculations and then suddenl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reverse engineering integer division by constant</h1><div class="post__text post__text-html js-mediator-article">  So it happens that sometimes you reverse the code that deals with some kind of routine that does not involve any serious calculations and then suddenly multiply by a large constant (cry that there is no asylum highlighter for Habr√©): <br><br><pre><code class="dos hljs">mov edx, [ebp+end_of_buffer] mov eax, [ebp+src] mov ecx, edx sub ecx, eax mov edx, <span class="hljs-number"><span class="hljs-number">80808081</span></span>h mov eax, ecx imul edx lea eax, [edx+ecx] mov edx, eax sar edx, <span class="hljs-number"><span class="hljs-number">7</span></span> mov eax, ecx sar eax, <span class="hljs-number"><span class="hljs-number">1</span></span>Fh sub edx, eax mov eax, edx</code> </pre> <br><a name="habracut"></a><br>  For those who do not know x86 assembler, I will explain: <br><br><pre> <code class="dos hljs">mov edx, [ebp+end_of_buffer] mov eax, [ebp+src] mov ecx, edx sub ecx, eax ; ecx =   mov edx, <span class="hljs-number"><span class="hljs-number">80808081</span></span>h ; edx = -<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">139</span></span> <span class="hljs-number"><span class="hljs-number">062</span></span> <span class="hljs-number"><span class="hljs-number">143</span></span> mov eax, ecx ; eax = ecx imul edx ;   eax*edx ;    edx:eax</code> </pre><br>  At first glance, this is surprising, especially for a beginner, but my goal is not to puzzle, but to explain, therefore I reveal the cards: this is how the integer division by constant is optimized.  Yes Yes.  Integer division by a previously known Kostant can be replaced by integer multiplication by another constant and by processing the result with a file.  This will be faster, since the multiplication takes place somewhere around five processor cycles, and the division is about 25. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I wasn‚Äôt banned in Google, but I didn‚Äôt find how to find the original divider, but I found several optimization guides telling how to calculate the multiplier for such a replacement.  However, it was reported in the form of a ready-made algorithm, with no explanation behind the mathematics behind it. <br><br>  The math associated with the possibility of such a replacement is to replace the divisor b by the inverse number 1 / b and multiply by it.  But what if we deal with integer arithmetic and 1 / b will be rounded to zero whenever b&gt; 1?  Very simple: to do this, you need to represent the number 1 / b as a number with a fixed point.  In this case, the integer part of the number will always be zero, and the zeros after the point are dropped to the first unit.  The number of zeroes thrown away is remembered in order to make later acc.  shift. <br><br>  So.  How to understand what constant division occurs in the source code?  Perform the inverse operation: translate a binary number with a fixed point in decimal format: <br>  0x80808081 = 2 ^ (- 1) + 2 ^ (- 9) + 2 ^ (- 17) + 2 ^ (- 25) + 2 ^ (- 31) = A <br>  We get the inverse number B = 1 / A. <br><br>  Further in the listing we see that there is a shift to the right by 7 digits: <br><br><pre> <code class="dos hljs">sar edx, <span class="hljs-number"><span class="hljs-number">7</span></span></code> </pre><br>  This is compensation for discarding leading zeros.  It corresponds to division by 2 ^ 7 degrees, that is, by 128. We do the inverse operation: <br><br>  X = B * 128 ~ 255. <br><br>  But you can solve it differently: <br>  X ~ 1 / (2 ^ (- 1 - 7) + 2 ^ (- 9 - 7) + 2 ^ (- 17 - 7) + 2 ^ (- 25 - 7) + 2 ^ (- 31 - 7)) <br><br>  Rounding in this case is not terrible, since integer division is also performed with rounding. <br><br>  Thus, in my case, the authors divided the buffer size by 255. <br><br>  PS: In this case, the study of the driver of one closed USB-glands was performed.  No copy protection program was harmed. </div><p>Source: <a href="https://habr.com/ru/post/256827/">https://habr.com/ru/post/256827/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256817/index.html">Native Script. One code for all platforms</a></li>
<li><a href="../256819/index.html">Interesting notes on C # and CLR</a></li>
<li><a href="../256821/index.html">How IQueryable and LINQ Data Providers Work</a></li>
<li><a href="../256823/index.html">Features of conceptual domain modeling</a></li>
<li><a href="../256825/index.html">What prepares us for C # 7 (Part 1. Tuples)</a></li>
<li><a href="../256829/index.html">Features of the introduction of DLL and installation of hooks in Modern-applications Windows 8/10</a></li>
<li><a href="../256831/index.html">As we thought out the designer for children's robotics. #one</a></li>
<li><a href="../256835/index.html">Fans of Chinese pioneers</a></li>
<li><a href="../256839/index.html">Remote control of lighting on standard wiring</a></li>
<li><a href="../256841/index.html">The Telecommunications Regulatory Authority of India (TRAI) leaked more than 2 million email addresses; revenge on Anonymous India</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>