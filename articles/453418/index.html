<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What you need to know before switching to Akka toolkit to implement Event Sourcing and CQRS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, dear readers Habr. My name is Rustem and I am the main developer in the Kazakhstan IT company DAR. In this article, I‚Äôll tell you what you need...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What you need to know before switching to Akka toolkit to implement Event Sourcing and CQRS</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello, dear readers Habr.  My name is Rustem and I am the main developer in the Kazakhstan IT company DAR.  In this article, I‚Äôll tell you what you need to know before switching to Event Sourcing and CQRS using the Akka toolkit. </p><br><p>  Around 2015, we began to design our ecosystem.  After analyzing and relying on the experience of working with Scala and Akka, we decided to focus on the Akka toolkit.  We also had successful implementations of Event Sourcing templates with CQRS and not so much.  Accumulated expertise in this area, which I want to share with readers.  We will look at how Akka implements these patterns, as well as what tools are available and talk about Akka pitfalls.  I hope that after reading this article, you will have more understanding of the risks of switching to Akka toolkit. </p><a name="habracut"></a><br><p>  On articles CQRS and Event Sourcing many articles on Habr√© and on other resources have been written.  This article is intended for readers who already understand what CQRS and Event Sourcing are.  In the article I want to concentrate on Akka. </p><br><h3 id="domain-driven-design">  Domain-driven design </h3><br><p>  A lot of materials have been written about Domain-Driven Design (DDD).  There are both opponents and supporters of this approach.  From myself I want to add that if you decide to switch to Event Sourcing and CQRS, then it would be good to learn DDD.  In addition, the DDD philosophy is felt in all Akka tools. </p><br><p>  In fact, Event Sourcing and CQRS are just a small part of the big picture called Domain-Driven Design.  When designing and developing, you may have many questions about how to properly implement these patterns and integrate them into the ecosystem, and knowing DDD will make your life easier. </p><br><blockquote>  In this article, the term entity (entity by DDD) will denote the Persistence Actor which has a unique identifier. </blockquote><br><h3 id="pochemu-scala">  Why Scala? </h3><br><p>  People often ask us why Scala, and not Java.  One of the reasons is Akka.  The framework itself is written in the Scala language with support for the Java language.  Here it must be said that there is also a implementation on <a href="https://getakka.net/">.NET</a> , but this is another topic.  In order not to provoke a discussion, I will not write than Scala is better or worse than Java.  I just tell a couple of examples, which, in my opinion, Scala has an advantage over Java when working with Akka: </p><br><ul><li> Unchangeable objects.  In Java, you need to write immutable objects yourself.  Believe me, it is not easy and not very convenient to constantly write the final parameters.  In the Scala <code>case class</code> already immutable with the built-in <code>copy</code> function </li><li>  The style of writing code.  When implemented in Java, you will still write in the Scala style, that is, functionally. </li></ul><br><p>  Here is an example of actor implementation on Scala and Java: </p><br><p>  <strong>Scala:</strong> </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DemoActor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">props</span></span></span></span>(magicNumber: <span class="hljs-type"><span class="hljs-type">Int</span></span>): <span class="hljs-type"><span class="hljs-type">Props</span></span> = <span class="hljs-type"><span class="hljs-type">Props</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">DemoActor</span></span>(magicNumber)) } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DemoActor</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">magicNumber: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Actor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function"> </span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> x: <span class="hljs-type"><span class="hljs-type">Int</span></span> =&gt; sender() ! (x + magicNumber) } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeOtherActor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Actor</span></span></span><span class="hljs-class"> </span></span>{ context.actorOf(<span class="hljs-type"><span class="hljs-type">DemoActor</span></span>.props(<span class="hljs-number"><span class="hljs-number">42</span></span>), <span class="hljs-string"><span class="hljs-string">"demo"</span></span>) <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br><p>  <strong>Java:</strong> </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DemoActor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractActor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Props </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">props</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Integer magicNumber)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Props.create(DemoActor.class, () -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DemoActor(magicNumber)); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Integer magicNumber; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DemoActor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Integer magicNumber)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.magicNumber = magicNumber; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Receive </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createReceive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> receiveBuilder() .match( Integer.class, i -&gt; { getSender().tell(i + magicNumber, getSelf()); }) .build(); } } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeOtherActor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractActor</span></span></span><span class="hljs-class"> </span></span>{ ActorRef demoActor = getContext().actorOf(DemoActor.props(<span class="hljs-number"><span class="hljs-number">42</span></span>), <span class="hljs-string"><span class="hljs-string">"demo"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br><p>  (Example taken from <a href="https://doc.akka.io/docs/akka/2.5.22/actors.html%3Flanguage%3Dscala">here</a> ) </p><br><p>  Notice the implementation of the <code>createReceive()</code> method using the example of the Java language.  Inside, through the <code>ReceiveBuilder</code> factory, pattern-matching is implemented.  <code>receiveBuilder()</code> is a method from Akka to support lambda expressions, namely pattern-matching in Java.  In Scala, this is implemented natively.  Agree, the code in Scala is shorter and easier to read. </p><br><ul><li>  Documentation and examples.  Despite the fact that in the official documentation there are examples in Java, on the Internet almost all examples are on Scala.  Also, it will be easier for you to navigate the source code of the Akka library. </li></ul><br><blockquote>  In terms of performance, there will be no difference between Scala and Java, since everything is spinning in the JVM. </blockquote><br><h3 id="hranilische">  Storage </h3><br><p>  Before implementing Event Sourcing using Akka Persistence, I recommend choosing a base for permanent data storage in advance.  The choice of base depends on the system requirements, on your desires and preferences.  Data can be stored both in NoSQL and RDBMS, and in the file system, such as LevelDB from <a href="https://github.com/google/leveldb">Google</a> . </p><br><p>  It is important to note that Akka Persistence is not responsible for writing and reading data from the database, but does this through a plug-in that the Akka Persistence API must implement. </p><br><p>  After choosing a tool for storing data, you need to select a <a href="https://index.scala-lang.org/search%3Ftopics%3Dakka-persistence%26_ga%3D2.217878805.2056531324.1557841814-1170194506.1552912520.">plugin</a> from the list, or write it yourself.  The second option, I do not recommend why reinvent the wheel. </p><br><p>  For permanent data storage, we decided to stop at Cassandra.  The fact is that we needed a reliable, fast and distributed base.  In addition, Typesafe themselves accompany the <a href="https://github.com/akka/akka-persistence-cassandra">plugin</a> , which fully implements the <a href="https://doc.akka.io/docs/akka/current/persistence-journals.html">Akka Persistence API</a> .  It is constantly updated and in comparison with others, the Cassandra plugin has more complete documentation. </p><br><p>  It is worth mentioning that the plugin also has several problems.  For example, there is still no stable version (at the time of this writing, the latest version is 0.97).  For us, the biggest problem we encountered when using this plugin was the loss of events when reading Persistent Query for some entities.  For the full picture, below is a CQRS diagram: </p><br><p><img src="https://habrastorage.org/webt/xd/3o/hk/xd3ohkb_wfvtfds2qangxxoctws.png"></p><br><p>  Persistent Entity distributes entity events to tags using the consistent hash algorithm (for example, 10 shards): </p><br><p><img src="https://habrastorage.org/webt/eb/sq/zj/ebsqzjcj_nom7zs4pyizzkq5o0q.png"></p><br><p>  Then, Persistent Query subscribes to these tags and starts a stream that adds data to Elastic Search.  Since Cassandra is in a cluster, events will be scattered across the nodes.  Some nodes may subside and will respond more slowly than others.  There is no guarantee that you will receive events in a strict order.  To solve this problem, the plugin is implemented in such a way that if it receives an unordered event, such as <code>entity-A event NR 2</code> , then it waits for a certain time for the original event and if it does not receive it, it will simply ignore all the events of this entity.  Even about this there were discussions in Gitter.  If anyone is interested, you can read the correspondence between @kotdv and plug-in developers: <a href="https://gitter.im/akka/akka-persistence-cassandra%3Fat%3D5c44857283189945241cffd8">Gitter</a> </p><br><p>  <strong>How can this misunderstanding be resolved:</strong> </p><br><ul><li>  You need to update the plugin to the latest version.  In the latest versions, the Typesafe developers have solved many problems related to the Eventual Consistency.  But, we are still waiting for a stable version. </li><li>  More precise settings have been added to the component that is responsible for receiving events.  You can try to increase the waiting time for unordered events for more reliable plug-in operation: c <code>assandra-query-journal.events-by-tag.eventual-consistency.delay=10s</code> </li><li>  Configure Cassandra as recommended by DataStax.  Put garbage collector G1 and allocate as much memory as possible for <a href="https://docs.datastax.com/en/cassandra/3.0/cassandra/operations/opsTuneJVM.html">Cassandra</a> . </li></ul><br><p>  In the end, we solved the problem with missing events, but now there is a stable data delay on the Persistence Query side (from five to ten seconds).  It was decided to leave the approach to the data that is used for analytics, and where speed is important, we manually post events to the bus.  The main thing is to choose the appropriate mechanism for processing or publishing data: at-least-once or at-most-once.  A good description from Akka can be read <a href="https://doc.akka.io/docs/akka/current/general/message-delivery-reliability.html%3Flanguage%3Dscala">here</a> .  It was important for us to maintain the consistency of the data and therefore, after successfully writing data to the database, we entered a transition state that controls the successful publication of data on the bus.  Below is a sample code: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeEntity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uuid</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> } <span class="hljs-comment"><span class="hljs-comment">/** * ,    . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DidSomething</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">uuid: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">/**</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*/</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LastEventPublished</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">uuid: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">/**</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">@param</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unpublishedEvents</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">‚Äì</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*/</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">State</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">unpublishedEvents: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Seq</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Event</span></span></span></span><span class="hljs-class"><span class="hljs-params">]</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">State</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updated</span></span></span></span>(event: <span class="hljs-type"><span class="hljs-type">Event</span></span>): <span class="hljs-type"><span class="hljs-type">State</span></span> = event <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> evt: <span class="hljs-type"><span class="hljs-type">DidSomething</span></span> =&gt; copy( unpublishedEvents = unpublishedEvents :+ evt ) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> evt: <span class="hljs-type"><span class="hljs-type">LastEventPublished</span></span> =&gt; copy( unpublishedEvents = unpublishedEvents.filter(_.uuid != evt.uuid) ) } } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeEntity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersistentActor</span></span></span><span class="hljs-class"> </span></span>{ ‚Ä¶ persist(newEvent) { evt =&gt; updateState(evt) publishToEventBus(evt) } ‚Ä¶ }</code> </pre> <br><p>  If for some reason it was not possible to publish the event, then when you next start <code>SomeEntity</code> , he will know that the <code>DidSomething</code> event <code>DidSomething</code> not reach the bus and try again to republish the data. </p><br><h3 id="serializator">  Serializer </h3><br><p>  Serialization is an equally important point in using Akka.  It has an internal module - <a href="https://doc.akka.io/docs/akka/current/serialization.html">Akka Serialization</a> .  This module is used to serialize messages when exchanging them between actors and storing them through the Persistence API.  The default is Java serializer, but another is recommended.  The problem is that Java Serializer is slow and takes up a lot of space.  There are two popular solutions: JSON and Protobuf.  JSON, though slow, is easier to implement and maintain.  If you need to minimize the cost of serialization and data storage, you can stop at Protobuf, but then the development process will go slower.  In addition to the Domain Model, you will have to write another Data Model.  Do not forget about the versioned data.  Be prepared to constantly write mapping between the Domain Model and the Data Model. </p><br><p><img src="https://habrastorage.org/webt/ag/fk/h0/agfkh04g1ykq5ymlxl0ma5ciwmo.png"></p><br><p>  Added a new event - write mapping.  Change the data structure - write a new version of the Data Model and change the mapping function.  Do not forget about the tests for serializers.  In general, the work will not be enough, but in the end you get loosely coupled components. </p><br><h3 id="vyvody">  findings </h3><br><ul><li>  Carefully examine and select the appropriate base and plugin.  I recommend to choose a plugin that is well accompanied and will not stop in the development.  The area is relatively new, there are still a lot of flaws that have to be solved </li><li>  If you select distributed storage, you will have to solve the problem with a delay of up to 10 seconds yourself, or accept this </li><li>  The complexity of serialization.  You can sacrifice speed and stop at JSON, or choose Protobuf and write a lot of adapters and support them. </li><li>  There are also pluses of this template, these are weakly connected components and independent development teams that build one big system. </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/453418/">https://habr.com/ru/post/453418/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../45341/index.html">Habr Editor Update</a></li>
<li><a href="../453410/index.html">Do not throw smart bulbs in the trash, or danger of IoT</a></li>
<li><a href="../453412/index.html">Top 3D Shop became the exclusive distributor of UFactory</a></li>
<li><a href="../453414/index.html">The rise and fall of IEO, all you need to know about the new wave of fundraising</a></li>
<li><a href="../453416/index.html">How configuration in .NET Core works</a></li>
<li><a href="../45342/index.html">rbPopup.jQuery</a></li>
<li><a href="../453422/index.html">Introducing ITSM: 10 Habratopic and Expert Materials for "Quick Dive" in the subject</a></li>
<li><a href="../453428/index.html">Raise code readability in iOS development</a></li>
<li><a href="../453430/index.html">How I wrote my monitoring</a></li>
<li><a href="../453432/index.html">From critics to algorithms: the fading voice of elites in the music world</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>