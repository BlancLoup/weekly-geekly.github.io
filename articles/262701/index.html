<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating CloudFoundry / IBM Bluemix buildpack or Awk web service (gawk)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="gawk - stare gaping, goggle 



 No further, I‚Äôll really describe how to run an Awk (Gawk) web service on IBM Bluemix. 

 CloudFoundry and the IBM Blu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating CloudFoundry / IBM Bluemix buildpack or Awk web service (gawk)</h1><div class="post__text post__text-html js-mediator-article">  <i>gawk - stare gaping, goggle</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d47/1ba/d73/d471bad737c54eb1b36484964272f13a.jpg"></div><br><br>  No further, I‚Äôll really describe how to run an Awk (Gawk) web service on IBM Bluemix. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      CloudFoundry and the <a href="http://bluemix.net/">IBM Bluemix</a> platform based on it support <a href="https://github.com/cloudfoundry-community/cf-docs-contrib/wiki/Buildpacks">many different</a> programming languages ‚Äã‚Äãand web frameworks.  All this thanks to the support of buildpacks (my translation of the word buildpack).  Buildpack can be considered as a plugin that is responsible for installing and setting up the application execution environment.  Build a pack usually in two cases. <br><a name="habracut"></a><br><br><h3>  Why write buildpack? </h3><br>  In the first case, the language or framework is supported, but the application requires third-party libraries, such as OpenCV, which cannot be installed as a dependency manager standard for this language (npm, pip, bundler).  In this case, the existing buildpack is modified to which the installation of the necessary libraries is added.  Most buildpacks are on github, a fork is made with which you can deploy the application. <br><br>  The second case is more rare - the language is not yet supported, i.e.  No one has created a buildpack yet.  In this case, you will have to make it from scratch, which will be described below.  I was looking for a long time what language is not yet supported by CloudFoundry, the choice fell on Brainfuck.  Unfortunately, when I added the buildpack, I realized that I could not quickly write a web server in this language.  The search showed that others had difficulties with this task. <br><br>  To make it a little clearer, the problem is that the buildpack sets up the environment into which the user application is then placed, the port and the host name are transferred to it through the environment variables, where the application should start processing HTTP requests.  Those.  simple hello world is not enough.  I continued searching and found the implementation of the web servers in <a href="http://www.pugo.org:8080/">PostScript</a> and <a href="http://awk.info/%3Ftools/server">Awk (more precisely, gawk)</a> .  In the end, I chose Awk and started writing a new buildpack. <br><br><h3>  Ok, what do we write? </h3><br>  <a href="http://docs.cloudfoundry.org/buildpacks/custom.html">The documentation</a> describes well the general concepts, you can also see the finished buildpacks.  In the simplest case, you need to create a bin folder and place 3 executable files in it: <br><br>  <b>detect</b> - determines whether this buildpack can be applied to the application.  If so, the script should return 0 and type the name of the language or framework.  In our case, we check the availability of app.awk in the application root, we introduce such an agreement. <br><br><pre><code class="hljs pgsql">#!/usr/bin/env bash # bin/detect &lt;build-dir&gt; # <span class="hljs-keyword"><span class="hljs-keyword">Any</span></span> awk web app must have app.awk file <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -f <span class="hljs-meta"><span class="hljs-meta">$1</span></span>/app.awk ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> echo "gawk" <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> fi <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><br>  <b>compile</b> should install everything you need and compile a custom application, if required.  In our case, you need to download and install gawk.  To save time during the deployment of the application, it was possible to build it manually for different versions of Ubuntu and select the appropriate one at this step.  But building gawk is not such a costly process, and the cache is also supported, so for most projects the compilation will be done once.  But we will definitely get the file compiled for the required OS version and architecture. <br><br><pre> <code class="hljs mel">#!/usr/bin/<span class="hljs-keyword"><span class="hljs-keyword">env</span></span> bash # bin/compile &lt;build-dir&gt; &lt;cache-dir&gt; set -e build_dir=$1 cache_dir=$2 awk_cache=$cache_dir/gawk<span class="hljs-number"><span class="hljs-number">-4.1</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> awk_url=<span class="hljs-string"><span class="hljs-string">"http://ftp.gnu.org/gnu/gawk/gawk-4.1.3.tar.gz"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -f $awk_cache/gawk ]; then echo <span class="hljs-string"><span class="hljs-string">"Using cached gawk"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> # download and compile gawk mkdir -p $awk_cache curl -o $cache_dir/gawk.tar.gz <span class="hljs-string"><span class="hljs-string">"$awk_url"</span></span> cd $cache_dir tar zxvf gawk.tar.gz cd $awk_cache ./configure make fi # copy gawk to build dir cp $awk_cache/gawk $build_dir # set path and test gawk PATH=$build_dir:$PATH gawk -V # create a launcher to wrap <span class="hljs-keyword"><span class="hljs-keyword">env</span></span> vars passing echo <span class="hljs-string"><span class="hljs-string">"#!/usr/bin/env bash\n"</span></span> &gt; $build_dir/awk-start echo <span class="hljs-string"><span class="hljs-string">"/app/gawk -v PORT=\"\$PORT\" -v HOST=\"\$VCAP_APP_HOST\" -f \$1"</span></span> &gt;&gt; $build_dir/awk-start chmod +x $build_dir/awk-start</code> </pre><br><br>  The first argument is the place to build the files (build_dir), the second is the cache.  Our task is to put the necessary files to run in build_dir, in our case it is gawk.  In addition, the Awk script does not have access to environment variables, and we need to know which port CloudFoundry allocates to us for launching (the PORT environment variable).  So I made a little wrap for easy launch. <br><br>  <b>release</b> - passes the metadata needed to launch the application.  Typically, these are environment variables and the default launch string.  It will be used if the application does not provide this information, which is usually done in the Procfile file. <br><br><pre> <code class="hljs pgsql">#!/usr/bin/env bash # bin/<span class="hljs-keyword"><span class="hljs-keyword">release</span></span> &lt;build-dir&gt; cat &lt;&lt;EOF config_vars: <span class="hljs-type"><span class="hljs-type">PATH</span></span>: /app:$<span class="hljs-type"><span class="hljs-type">PATH</span></span> default_process_types: web: /app/awk-<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> app.awk EOF</code> </pre><br><br>  We check the work of scripts locally, then we post everything on github, remember the address <a href="https://github.com/hashmap/gawk-buildpack">https://github.com/hashmap/gawk-buildpack</a> <br><br><h3>  Understand how to run everything? </h3><br>  Now we write application.  Create a folder gawktest, in her file app.awk <br><br><pre> <code class="hljs pgsql"># A Web <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Awk # a simple, single <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, web <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> built <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> gawk. # based <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> code form http://awk.<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>/?tools/<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> Michael Sanders <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> { host = "/inet/tcp/" PORT "/0/0" # host string status = <span class="hljs-number"><span class="hljs-number">200</span></span> # <span class="hljs-number"><span class="hljs-number">200</span></span> == OK reason = "OK" # <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> response RS = ORS = "\r\n" # <span class="hljs-keyword"><span class="hljs-keyword">header</span></span> <span class="hljs-type"><span class="hljs-type">line</span></span> terminators doc = Setup() # html document len = length(doc) + length(ORS) # length <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> document print "Staring AWK server" <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { print "HTTP/1.0", status, reason |&amp; host print "Connection: Close" |&amp; host print "Pragma: no-cache" |&amp; host print "Content-length:", len |&amp; host print ORS doc |&amp; host <span class="hljs-keyword"><span class="hljs-keyword">close</span></span>(host) # <span class="hljs-keyword"><span class="hljs-keyword">close</span></span> client <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> host |&amp; getline # wait <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> client request } } <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> Setup() { tmp = "&lt;html&gt;\ &lt;head&gt;&lt;title&gt;Simple gawk server&lt;/title&gt;&lt;/head&gt;\ &lt;body&gt;\ Hello from awk!\ &lt;/body&gt;\ &lt;/html&gt;" <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tmp }</code> </pre><br><br>  We check application work locally: <br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">gawk</span></span> -v PORT=<span class="hljs-number"><span class="hljs-number">8080</span></span> -f app.awk</code> </pre><br><br>  Now you can send to Bluemix, do the standard cf push, but also specify the address of our buildpack: <br><br><pre> <code class="hljs perl">gawktest cf <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> gawktest -b https:<span class="hljs-regexp"><span class="hljs-regexp">//github</span></span>.com/hashmap/gawk-buildpack Updating app gawktest in org xxx@gmail.com / space dev as xxx@gmail.com... OK Uploading gawktest... Uploading app files from: <span class="hljs-regexp"><span class="hljs-regexp">/Users/alex</span></span><span class="hljs-regexp"><span class="hljs-regexp">/projects/gawktest</span></span> Uploading <span class="hljs-number"><span class="hljs-number">32.3</span></span>K, <span class="hljs-number"><span class="hljs-number">3</span></span> files Done uploading OK Stopping app gawktest in org xxx@gmail.com / space dev as xxx@gmail.com... OK Starting app gawktest in org xxx@gmail.com / space dev as xxx@gmail.com... -----&gt; Downloaded app <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> (<span class="hljs-number"><span class="hljs-number">8.0</span></span>K) -----&gt; Downloaded app buildpack cache (<span class="hljs-number"><span class="hljs-number">11</span></span>M) Cloning into <span class="hljs-string"><span class="hljs-string">'/tmp/buildpacks/gawk-buildpack'</span></span>... Using cached gawk GNU Awk <span class="hljs-number"><span class="hljs-number">4.1</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span>, API: <span class="hljs-number"><span class="hljs-number">1.1</span></span> Copyright (C) <span class="hljs-number"><span class="hljs-number">1989</span></span>, <span class="hljs-number"><span class="hljs-number">1991</span></span>-<span class="hljs-number"><span class="hljs-number">2015</span></span> Free Software Foundation. This program is free software; you can redistribute it <span class="hljs-keyword"><span class="hljs-keyword">and</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">or</span></span> modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version <span class="hljs-number"><span class="hljs-number">3</span></span> of the License, <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (at your option) any later version. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> more details. You should have received a copy of the GNU General Public License along with this program. If <span class="hljs-keyword"><span class="hljs-keyword">not</span></span>, see http:<span class="hljs-regexp"><span class="hljs-regexp">//www</span></span>.gnu.org/licenses/. -----&gt; Uploading droplet (<span class="hljs-number"><span class="hljs-number">724</span></span>K) <span class="hljs-number"><span class="hljs-number">1</span></span> of <span class="hljs-number"><span class="hljs-number">1</span></span> instances running App started OK App gawktest was started using this command <span class="hljs-string"><span class="hljs-string">`/app/awk-start app.awk`</span></span> Showing health <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> status <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> app gawktest in org xxx@gmail.com / space dev as xxx@gmail.com... OK requested <span class="hljs-keyword"><span class="hljs-keyword">state</span></span>: started instances: <span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> usage: <span class="hljs-number"><span class="hljs-number">64</span></span>M <span class="hljs-keyword"><span class="hljs-keyword">x</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> instances urls: gawktest.mybluemix.net <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> uploaded: Wed Jul <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span> UTC <span class="hljs-number"><span class="hljs-number">2015</span></span> stack: lucid64 buildpack: https:<span class="hljs-regexp"><span class="hljs-regexp">//github</span></span>.com/hashmap/gawk-buildpack <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> since cpu memory disk details <span class="hljs-comment"><span class="hljs-comment">#0 running 2015-07-15 03:22:08 PM 0.0% 1.1M of 64M 1.9M of 1G</span></span></code> </pre><br><br><h3>  Final Captions </h3><br>  Everything works and is <a href="http://gawktest.mybluemix.net/">available</a> , at least for now, do not forget that the server is single-user.  Since  this is not the first run, the already compiled gawk was simply copied from the cache.  When you first launch a new application, you will see how it is downloaded, unpacked and assembled.  Also for debugging, the gawk version and its license are printed. <br><br>  If anyone writes a web framework on Brainfuck - let me know. </div><p>Source: <a href="https://habr.com/ru/post/262701/">https://habr.com/ru/post/262701/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262689/index.html">The most interesting materials about Visual Studio 2015</a></li>
<li><a href="../262693/index.html">FPGA verification. What is it?</a></li>
<li><a href="../262695/index.html">YandexBot follows the links that the user follows.</a></li>
<li><a href="../262697/index.html">Automatic migrations to Peewee</a></li>
<li><a href="../262699/index.html">Remote enable by Mac address C # (Wake On Lan)</a></li>
<li><a href="../262703/index.html">The distance spectra of simple sets and their associations (part 2)</a></li>
<li><a href="../262705/index.html">Multiplication of Karatsuba and C ++ 11</a></li>
<li><a href="../262707/index.html">Obtaining international IT certificates</a></li>
<li><a href="../262709/index.html">We build a performance bench on the example of the server Set Retail 10</a></li>
<li><a href="../262711/index.html">Fast and convenient IL generation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>