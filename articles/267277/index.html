<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to write test code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you are a programmer (or something worse than an architect), can you answer this simple question: how to write NOT test code? Are you thinking? If ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to write test code</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/0c8/7d8/069/0c87d8069bd448ec97d6195e4348da5d.jpg" alt="image"></div><br><br>  If you are a programmer (or something worse than an architect), can you answer this simple question: how to write NOT test code?  Are you thinking?  If you can hardly name at least 3 ways to achieve non-testable code, then the article is for you. <br><br>  Many will say: why do I need to know how to write non-testable code, do you want to teach me bad?  The answer is: if you know the typical patterns of non-testable code, then, if they exist, you can easily see them in your project.  And, as you know, the recognition of the problem is half the way to treatment.  The article also provides an answer to how this treatment is actually carried out.  I ask under the cat. <br><a name="habracut"></a><br>  The article will not focus on a specific programming language, the following is relevant for all procedural languages.  But, as it seems to me, the article will be especially useful for those who program in dynamic interpreted languages ‚Äã‚Äãand have not had serious experience in developing typed compiled languages.  It is in the code of this category of developers that I most often noticed the patterns described below.  Examples will be in pseudocode, similar to Java, C #, and TypeScript. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At once I will make a reservation that the article will not consider the question of how to write tests.  On this subject, and so there are many articles.  The question of how to write code so that it can be simply and beautifully tested, and the resulting tests are simple and supported, will be considered.  Further, the notion of a test means a beautiful and clean unit test, which is written without various hacks, without additional ‚Äúmagic‚Äù libraries for replacing dependencies on the fly, and other fun that makes reading and support of tests difficult.  That is the test in the finest sense of the word. <br><br>  A bit of philosophy.  Is it worth writing tests at all?  My opinion: if you create a project that will develop, then you just need tests.  In addition to the fact that the tests perform their direct function (they allow to check the compliance of the code with the requirements), they as a side effect ‚Äústraighten out‚Äù the design of the classes.  This is because tests cannot be written on a class with a ‚Äúcrooked‚Äù design, therefore, in order to achieve testability, one has to refactor a class.  Or, if tests are written before the code, the class design is immediately born the right one.  The test code is reusable, since we can reuse it in tests.  And reusability is an important criterion for proper class design.  The same tests, perhaps, but not necessarily, will improve the architecture of the application as a whole.  As someone well noticed: the class design is only as good as this class can be tested using unit tests. <br><br><h2>  The list of the main killers of the code under test: </h2><br><ul><li>  <a href="https://habr.com/ru/company/mailru/blog/267277/">mining knowledge</a> </li><li>  <a href="https://habr.com/ru/company/mailru/blog/267277/">new operator in business code</a> </li><li>  <a href="https://habr.com/ru/company/mailru/blog/267277/">global variables and singletons</a> </li><li>  <a href="https://habr.com/ru/company/mailru/blog/267277/">experienced designer</a> </li></ul><br><br><h3><a name="a2"></a>  Mining knowledge </h3><br>  Knowledge extraction occurs when a method requires one set of arguments, but does not use them directly, but begins to pick these arguments in search of other objects.  Typical scenarios: <br><ul><li>  the method walks on the object through more than one point (.) </li><li>  the method does not directly use its argument (uses it to get other information) </li></ul><br>  A method or constructor must require what it really needs to work.  He doesn‚Äôt have to worry about how to get / calculate it all, doing any work.  It is necessary to require the minimum necessary set of arguments for their work. <br><br>  Life example: when in a store you are asked to pay for a purchase, what do you do: give a wallet so that the cashier can take the money from there, or do you give money?  I think the analogy is clear - the cashier class should require the money, rather than the purse class, to enter the calculation method. <br>  Consider a couple of examples. <br><br><div class="spoiler">  <b class="spoiler_title">before: untested code</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DiscountCard</span></span></span><span class="hljs-class"> </span></span>{ DiscountCard(UserContext userContext) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.user = userContext.getUser(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.level = userContext.getLevel(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.order = userContext.getOrder(); } <span class="hljs-comment"><span class="hljs-comment">// ... } //  UserContext userContext = new UserContext(); userContext.setUser(new User("Ivan")); PlanLevel level = new PlanLevel(143, "yearly"); userContext.setLevel(level); Order order = new Order("SuperDeluxe", 100, true); userContext.setOrder(order); DiscountCard discountCard = new DiscountCard(userContext); //  </span></span></code> </pre> <br></div></div><br>  DiscountCard does not directly use userContext.  The one who will write the test will need to examine the device of the DiscountCard class in order to understand what objects are really required there, because the userContext can contain dozens of objects for initialization.  And this time and the risk of doing something wrong, and as a result, the test may be wrong.  Let's make it so that DiscountCard needs what it really needs: <br><br><div class="spoiler">  <b class="spoiler_title">after: test code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DiscountCard</span></span></span><span class="hljs-class"> </span></span>{ DiscountCard(User user, PlanLevel level, Order order) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.user = user; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.level = level; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.order = order; } <span class="hljs-comment"><span class="hljs-comment">// ... } //  User user = new User("Ivan"); PlanLevel level = new PlanLevel(143, "yearly"); Order order = new Order("SuperDeluxe", 100, true); DiscountCard discountCard = new DiscountCard(user, level, order); //  </span></span></code> </pre><br></div></div><br>  Also, this example intentionally illustrates the famous <b>ServiceLocator</b> pattern, which stores all the dependencies of the application.  That is why such a pattern is considered an anti-pattern.  Try to avoid it. <br><br>  Consider another example of mining knowledge: <br><br><div class="spoiler">  <b class="spoiler_title">before: untested code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SalesTaxCalculator</span></span></span><span class="hljs-class"> </span></span>{ TaxTable taxTable; SalesTaxCalculator(TaxTable taxTable) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.taxTable = taxTable; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">computeSalesTax</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User user, Invoice invoice)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  "user"    Address address = user.getAddress(); float amount = invoice.getSubTotal(); return amount * taxTable.getTaxRate(address); } } //  SalesTaxCalculator calc = new SalesTaxCalculator(new TaxTable()); Address address = new Address(" 23 ..."); //     "user" User user = new User(address, ...); Invoice invoice = new Invoice(1, new ProductX(95.00)); assertEquals(calc.computeSalesTax(user, invoice), 100);</span></span></code> </pre><br></div></div><br>  In the test, you must create a class User, although it only requires an address.  The same can be said about the class Invoice.  Again, from the one who writes the test, it is required to ‚Äúgo through‚Äù the code of SalesTaxCalculator in order to figure out what is really needed there.  Bagoic place. <br><br>  Also, SalesTaxCalculator cannot be reused in another project that does not have the User and Invoice classes. <br><br><div class="spoiler">  <b class="spoiler_title">after: test code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SalesTaxCalculator</span></span></span><span class="hljs-class"> </span></span>{ TaxTable taxTable; SalesTaxCalculator(TaxTable taxTable) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.taxTable = taxTable; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">computeSalesTax</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Address address, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> amount)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> amount * taxTable.getTaxRate(address); } } <span class="hljs-comment"><span class="hljs-comment">//  SalesTaxCalculator calc = new SalesTaxCalculator(new TaxTable()); Address address = new Address(" 23 ..."); assertEquals(calc.computeSalesTax(address, 95.00), 100);</span></span></code> </pre><br></div></div><br>  Now the class requires only what is needed, and the tests become transparent. <br><br><h3><a name="a3"></a>  New operator in business code </h3><br>  Perhaps this pattern can be given a gold medal for creating non-testable code. <br>  Let's start parsing with a simple example: <br><br><div class="spoiler">  <b class="spoiler_title">before: untested code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">House</span></span></span><span class="hljs-class"> </span></span>{ Kitchen kitchen; Bedroom bedroom = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bedroom(); House() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.kitchen = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Kitchen(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Refrigerator()); } <span class="hljs-comment"><span class="hljs-comment">// ... } //  House house = new House(); // ,    //    kitchen  bedroom</span></span></code> </pre><br></div></div><br>  In this code, everything is bad.  It is impossible to test it, because calling any method of House will lead to a call to the kitchen and / or bedroom, and we do not control them.  If they communicate with the database or send requests to the network, then the tests are doomed.  With the help of polymorphism, it is impossible to replace the kitchen or bedroom, our house is rigidly tied to certain classes.  How to make the code testable? <br><br><div class="spoiler">  <b class="spoiler_title">after: test code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">House</span></span></span><span class="hljs-class"> </span></span>{ Kitchen kitchen; Bedroom bedroom; House(Kitchen kitchen, Bedroom bedroom) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.kitchen = kitchen; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bedroom = bedroom; } <span class="hljs-comment"><span class="hljs-comment">// ... } //  Kitchen kitchen = new DummyKitchen(null); Bedroom bedroom = new DummyBedroom(); House house = new House (kitchen, bedroom); // ,     </span></span></code> </pre><br></div></div><br>  Now our class House requires the designer everything that it needs to work.  And he doesn't care where it comes from.  Any business class should require ready-made instances of its dependencies in its constructor; this is the main principle. <br><br>  But some readers will say: ‚ÄúJust a minute.  If now all the dependencies need to be demanded in the constructor, then in order to create a ‚Äúdeep‚Äù child class (a class located in the depth of the application dependency graph), I will have to push all dependencies of this class through the parent classes.  And this will lead to the fact that the constructors of the ‚Äúupper‚Äù classes (classes that are closer to the beginning of the dependency graph) will turn into a collection of everything.  As for the example, this means that the class that makes the <b>new House</b> will now have to demand the most in the designer kitchen, and the bedroom.  But why should he know about them?  Well this is nonsense. " <br><br>  Only in these arguments there is one mistake.  Following the above principle, the class that creates House should NOT create it at all.  After all, according to the principle, he himself must demand House to himself in dependence.  But then where, in the end, will take the class House?  It will be created at the start of the application (if the lifetime of the House coincides with the lifetime of the application) or a factory creates it (if the lifetime of the House is less than the lifetime of the application): <br><br><div class="spoiler">  <b class="spoiler_title">House class creation</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HouseFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">House </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Kitchen kitchen = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Kitchen(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Refrigerator()); Bedroom bedroom = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bedroom(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> House (kitchen, bedroom); } }</code> </pre><br></div></div><br>  But some will again object: ‚ÄúSo now, create a factory for each class, increasing the amount of code by 2 times?  Well this is nonsense. ‚Äù  In fact, one factory creates and links classes with the same lifetime.  But in real applications there is not such a large amount of code with different lifetime.  For example, consider what types of objects, divided by different lifetimes, exist in a web application: <br><ul><li>  long living objects (created at the start of the application) </li><li>  session objects </li><li>  request objects </li><li>  rarely objects with a lifetime shorter than the query </li></ul><br>  So it‚Äôs enough for four factories for a typical web application.  Therefore, do not be afraid of them (and below, in conclusion, it will be shown how factories can not be written at all). <br>  Thus, we can distinguish two groups of code: <br><ul><li>  business code group </li><li>  binding code group </li></ul><br>  Business code - a code that reflects business logic, a code that will change when customer requirements change.  This is the main category of code, which is why we are writing code. <br><br>  Binding code is a code that allows a business code to interact, it links it together.  Binding code does not contain any business logic.  These include factories, the starting point of the application and other connecting sites.  In the binding code, there is a lot of operator <b>new</b> . <br><br>  This approach with the division of code into 2 groups allows you to avoid mixing the logic of the application with the creation of the object graph of the application.  Therefore, always when using the new operator, think about whether you use it in that group of code. <br><br><h6>  An exception: </h6><br>  The <b>new</b> operator can be used in business code to create storage objects that do not contain behavior (for example, HashMap, Array). <br><br>  Consider another common case in the following example: <br><br><div class="spoiler">  <b class="spoiler_title">before: untested code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DocumentActions</span></span></span><span class="hljs-class"> </span></span>{ Network network; DocumentModel documentModel; DocumentActions(Network network, DocumentModel documentModel) { <span class="hljs-comment"><span class="hljs-comment">//    this.network = network; this.documentModel = documentModel; } changeTextStyle(int textOffset, TextStyle style) { Revision revision = new Revision(this.network, this.documentModel, textOffset); revision.updateTextStyle(style); revision.apply(); } insertParagraph(int textOffset, ParagraphProps props, ParagraphStyle style) { Revision revision = new Revision(this.network, this.documentModel, textOffset); revision.addParagraph(props); revision.updateParagraphStyle(style); revision.apply(); } //      new Revision } //  //        Network network = new Network(...); DocumentModel documentModel = new DocumentModel(...); DocumentActions docActions = new DocumentActions(network, documentModel); //      docActions</span></span></code> </pre><br></div></div><br>  The DocumentActions class in each of its methods creates a Revision class, making it impossible for tests to substitute the implementation of this class for mocks.  Worse, DocumentActions requires classes in the constructor that it does not use.  But what to do if every time you need to create a Revision you need to give the third argument textOffset, which is not known in advance?  Output: create a class that will take the knowledge of how to create Revision.  And this is nothing like a factory: <br><br><div class="spoiler">  <b class="spoiler_title">after: test code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DocumentActions</span></span></span><span class="hljs-class"> </span></span>{ RevisionFactory revisionFactory; DocumentActions(RevisionFactory revisionFactory) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.revisionFactory = revisionFactory; } changeTextStyle(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> textOffset, TextStyle style) { Revision revision = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.revisionFactory.build(textOffset); revision.updateTextStyle(style); revision.apply(); } insertParagraph(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> textOffset, ParagraphProps props, ParagraphStyle style) { Revision revision = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.revisionFactory.build(textOffset); revision.addParagraph(props); revision.updateParagraphStyle(style); revision.apply(); } <span class="hljs-comment"><span class="hljs-comment">//      this.revisionFactory.build } class RevisionFactory { Network network; DocumentModel documentModel; RevisionFactory(Network network, DocumentModel documentModel) { this.network = network; this.documentModel = documentModel; } Revision build(int textOffset) { return new Revision(this.network, this.documentModel, textOffset); } } //  class MyMockRevision extends Revision { //    } class MyMockRevisionFactory extends RevisionFactory { public Revision revision; Revision build(int textOffset) { this.revision = new MyMockRevision(this.network, this.documentModel, textOffset); return this.revision; } } RevisionFactory revisionFactory = new MyMockRevisionFactory(null, null); DocumentActions docActions = new DocumentActions(revisionFactory); //   //    Revision  revisionFactory.revision</span></span></code> </pre><br></div></div><br>  The factory knows that Network and DocumentModel are definitely needed to create Revision.  Therefore, she herself requires these classes for herself.  And all the dynamic parameters (textOffset), for creating Revision, will be required as arguments of the factory build method. <br><br>  Now, if in the future the Revision class will require another constant argument to the constructor, then it is not difficult to correct the RevisionFactory a bit, and the DocumentActions class will remain completely unchanged. <br><br><h3><a name="a4"></a>  Global variables and singletons </h3><br>  I think everyone will agree that global variables are evil.  But many do not see anything wrong with singletons, although in essence these are all the same global variables.  So what are the bad singltons?  Here are 2 reasons (although any of them are enough): <br><br>  1) The problem with using singletons is that they introduce tight connectivity to the code.  By creating a singleton, you say that your classes can only work with a single implementation that singleton provides.  You do not pledge to replace it.  This makes it difficult to test the class in isolation from the singleton, because the very nature of the test requires the ability to replace implementations with alternative ones.  Until you change this design, you force yourself to rely on the correct operation of the singleton to test any of its clients. <br><br>  2) The presence of singletons makes your classes lie about their dependencies, as it introduces "invisible" dependencies.  To understand the real dependencies of a class, you need to read its code completely, instead of just looking at the list of constructor / method dependencies.  And sooner or later it will lead to the fact that the tests will begin to influence each other, through a hidden global state. <br><br>  A practical example illustrating both problems at once: in a web application, it became necessary to log user actions.  For this we created a singleton, which was used in a number of classes.  I‚Äôll mention that Singleton used jQuery to get additional information from the DOM.  Everything went well until it was necessary to reuse part of the classes in the node version of the application.  This version periodically began to fall during testing.  It turned out that classes that used the logger singleton fell into this version, and the node does not have a DOM.  These classes used the ‚Äúinvisible‚Äù dependency (reason 2), with the result that this situation turned out to be possible.  It was not possible to replace the logger with another one (reason 1), due to which some classes had to be redone. <br><br>  Some will say: "I deliberately use singleton to have only a single instance of the class for the entire application."  But when creating a singleton, you make a class instance unique to the entire code execution space (jvm in java, rhino or V8 in javascript), and not in the whole application.  It's just that in most cases there is only one application inside the code execution space, and it turns out that these spaces are the same.  But this is not the case for tests.  Each test is a part of an application running in the same execution space with other tests. <br><br>  It turns out that many of your mini applications start to live in one execution space, in which there are unique and irreplaceable singltons.  This is where the side effects of singletons appear, when tests begin to influence each other. <br><br>  In addition, you may someday need to have more than one copy of the application or its part in the same code execution space.  Then the application space will not be equal to the code execution space.  And there will be nothing else left but to do the job of getting rid of singletons. <br><br>  Consider this example: you are assigned to test the PhoneAccount class, which is responsible for operations with a telephone account.  Without thinking, you write: <br><br><div class="spoiler">  <b class="spoiler_title">attempt 1</b> <div class="spoiler_text"><pre> <code class="java hljs">PhoneAccount phoneAccount = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PhoneAccount(<span class="hljs-string"><span class="hljs-string">'79008001020'</span></span>); phoneAccount.addMoney(<span class="hljs-number"><span class="hljs-number">100</span></span>); expect(phoneAccount.getBalance()).toBe(<span class="hljs-number"><span class="hljs-number">100</span></span>);</code> </pre><br></div></div><br>  You start your test in isolation and in runtime you get an access error to null.  Something went wrong?  You ask a colleague who wrote this class.  He thinks a long time that he needs to initialize the singleton PhoneAccountTransactionProcessor class.  You think: "how should I have guessed this?".  Then add: <br><br><div class="spoiler">  <b class="spoiler_title">attempt 2</b> <div class="spoiler_text"><pre> <code class="java hljs">PhoneAccountTransactionProcessor.init(...); PhoneAccount phoneAccount = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PhoneAccount(<span class="hljs-string"><span class="hljs-string">'79008001020'</span></span>); phoneAccount.addMoney(<span class="hljs-number"><span class="hljs-number">100</span></span>); expect(phoneAccount.getBalance()).toBe(<span class="hljs-number"><span class="hljs-number">100</span></span>);</code> </pre><br></div></div><br>  But again, when you start, you get an access error to null.  In perplexity, you again ask your colleague: ‚ÄúWhat am I doing wrong?‚Äù.  What do you get the answer: ‚ÄúDid you initialize the transaction queue - AccountTransactionQueue?‚Äù.  You get a little annoyed with the code, but something tells you that this will not stop there, and ask not to leave the ‚Äúexperienced‚Äù colleague. <br><br><div class="spoiler">  <b class="spoiler_title">attempt 3</b> <div class="spoiler_text"><pre> <code class="java hljs">AccountTransactionQueue.start(...); PhoneAccountTransactionProcessor.init(...); PhoneAccount phoneAccount = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PhoneAccount(<span class="hljs-string"><span class="hljs-string">'79008001020'</span></span>); phoneAccount.addMoney(<span class="hljs-number"><span class="hljs-number">100</span></span>); expect(phoneAccount.getBalance()).toBe(<span class="hljs-number"><span class="hljs-number">100</span></span>);</code> </pre><br></div></div><br>  And again a mistake.  But you don‚Äôt have time to ask a question how a colleague gives out: ‚ÄúYou didn‚Äôt connect the transaction database!‚Äù.  Finishing, taking a deep breath: <br><br><div class="spoiler">  <b class="spoiler_title">attempt 4</b> <div class="spoiler_text"><pre> <code class="java hljs">TransactionsDataBase.connect(...) AccountTransactionQueue.start(...); PhoneAccountTransactionProcessor.init(...); PhoneAccount phoneAccount = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PhoneAccount(<span class="hljs-string"><span class="hljs-string">'79008001020'</span></span>); phoneAccount.addMoney(<span class="hljs-number"><span class="hljs-number">100</span></span>); expect(phoneAccount.getBalance()).toBe(<span class="hljs-number"><span class="hljs-number">100</span></span>);</code> </pre><br></div></div><br>  Finally, the test passes. <br><br>  I think you already understand what is wrong with this code - some kind of black magic.  Three classes lie about their dependencies, the order of initializations should be exactly this, although the code does not dictate to you exactly this order. <br><br>  And what if there are no singltons, and each class will require everything it needs to work in a constructor? <br><br><div class="spoiler">  <b class="spoiler_title">correct code</b> <div class="spoiler_text"><pre> <code class="java hljs">TransactionsDataBase db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransactionsDataBase(...); AccountTransactionQueue transactionQueue; transactionQueue = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AccountTransactionQueue(db); PhoneAccountTransactionProcessor transactionProcessor; transactionProcessor = PhoneAccountTransactionProcessor(transactionQueue); PhoneAccount phoneAccount = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PhoneAccount(<span class="hljs-string"><span class="hljs-string">'79008001020'</span></span>, transactionProcessor); phoneAccount.addMoney(<span class="hljs-number"><span class="hljs-number">100</span></span>); expect(phoneAccount.getBalance()).toBe(<span class="hljs-number"><span class="hljs-number">100</span></span>);</code> </pre><br></div></div><br>  Now there is no magic, no hidden channels of communication between classes.  Any new team member will be able to write such a test on his own, because he will immediately see all the dependencies.  The code itself dictates the order of initialization; it cannot be done otherwise.  And this is a huge plus, because in real applications there may be dozens of lines with the initialization of classes.  And one more important conclusion: in such code, it is possible to pass null instead of a class (where possible) or replace the class with a mock.  In the singleton code it was impossible. <br><br>  Another example: <br><br><div class="spoiler">  <b class="spoiler_title">before: untested code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoginService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> LoginService instance; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoginService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> LoginService </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (instance == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RealLoginService(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; } <span class="hljs-comment"><span class="hljs-comment">//     //     ,   ! static setForTest(LoginService testDouble) { instance = testDouble; } //    //     ,   ! static resetForTest() { instance = null; } // ... } //    class AdminDashboard { boolean isAuthenticatedAdminUser(User user) { LoginService loginService = LoginService.getInstance(); return loginService.isAuthenticatedAdmin(user); } } //  AdminDashboard adminDashboard = new AdminDashboard() assertTrue(adminDashboard.isAuthenticatedAdminUser(user)); //    LoginService,    //  </span></span></code> </pre><br></div></div><br>  Removing singleton: <br><br><div class="spoiler">  <b class="spoiler_title">after: test code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoginService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... } //    class AdminDashboard { AdminDashboard(LoginService loginService) { this.loginService = loginService; } boolean isAuthenticatedAdminUser(User user) { return this.loginService.isAuthenticatedAdmin(user); } } //  AdminDashboard adminDashboard = new AdminDashboard(new MockLoginService()); assertTrue(adminDashboard.isAuthenticatedAdminUser(user));</span></span></code> </pre><br></div></div><br>  Now you can easily and easily replace the LoginService, as well as the ‚Äútest-only‚Äù methods are not needed. <br><br><h6>  Exceptions, in which cases the singletons can still be used: </h6><br><ul><li>  Singleton can be used for immutable objects, that is, for those that do not change during the life of the application.  For example: constant settings </li><li>  Singleton can be used when an object with information is not used in an application.  For example, logger or google analyst.  The application only writes information, but cannot read it.  Such singletons are safe for the application, since they seem to have no global status, it‚Äôs just a pipe to nowhere.  But if you need to test that writing to the logs really happens, then you will have to change the dependencies and lower the logger into the constructor. </li></ul><br>  Also, some system objects have hidden global variables, such as <b>math.random</b> and <b>new Date ()</b> .  If you want to test classes that use such objects, then you need to create your own wrappers with them in order to be able to replace them. <br><br><h3><a name="a1"></a>  Experienced designer </h3><br>  The hardened constructor is a constructor that does something other than initializing the fields of its class.  Strictly speaking, the constructor should be responsible only for initializing the class fields, and any other work violates the Single Responsibility Principle.  Such ‚Äúextra‚Äù work in the constructor makes it difficult to test it, since the test cannot transfer its dependency stubs to the class under test.  Here are typical patterns of experienced designers: <br><ul><li>  <a href="https://habr.com/ru/company/mailru/blog/267277/">initialization of constructor arguments</a> </li><li>  <a href="https://habr.com/ru/company/mailru/blog/267277/">conditions and cycles</a> </li><li>  <a href="https://habr.com/ru/company/mailru/blog/267277/">transferring part of the constructor to other class methods</a> </li><li>  <a href="https://habr.com/ru/company/mailru/blog/267277/">extraction of knowledge from arguments</a> </li><li>  <a href="https://habr.com/ru/company/mailru/blog/267277/">creating class fields in new</a> </li><li>  <a href="https://habr.com/ru/company/mailru/blog/267277/">calls to any static methods</a> </li></ul><br><br>  The last 3 patterns are characteristic not only for designers, therefore they were considered for the general case above. <br><br><h4><a name="a5"></a>  Initialization of constructor arguments </h4><br><div class="spoiler">  <b class="spoiler_title">before: untested code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Metro</span></span></span><span class="hljs-class"> </span></span>{ TicketPrices ticketPrices; Metro(TicketPrices ticketPrices) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ticketPrices = ticketPrices; ticketPrices.setCostCalculator(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MoscowCostCalculatorWithVerySlowConstructor()); } } <span class="hljs-comment"><span class="hljs-comment">//    TicketPrices ticketPrices = new TicketPrices(); Metro metro = new Metro(ticketPrices); expect(metro.isWork()).toBe(true);</span></span></code> </pre><br></div></div><br>  The constructor of the Metro class does not fulfill its duty - initializes the argument.  This code is bad for many reasons, but we are interested in testability.  If initialization is slow, all tests on Metro will take a long time. <br><br><div class="spoiler">  <b class="spoiler_title">after: test code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Metro</span></span></span><span class="hljs-class"> </span></span>{ TicketPrices ticketPrices; Metro(TicketPrices ticketPrices) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ticketPrices = ticketPrices; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TicketPricesFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">TicketPrices </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ TicketPrices ticketPrices = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TicketPrices(); ticketPrices.setCostCalculator(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VerySlowMoscowCostCalculator()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ticketPrices; } } <span class="hljs-comment"><span class="hljs-comment">// test TicketPrices ticketPrices = new TicketPrices(); ticketPrices.setCostCalculator(null); Metro metro = new Metro(ticketPrices); expect(metro.isWork()).toBe(true);</span></span></code> </pre><br></div></div><br>  Now in the test we can not create classes that are not necessary for the test, replacing them with dummies.  The logic of creating and initializing TicketPrices has gone to the factory. <br><br><h4><a name="a6"></a>  Conditions and cycles </h4><br><div class="spoiler">  <b class="spoiler_title">before: untested code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Car</span></span></span><span class="hljs-class"> </span></span>{ IEngine engine; Car() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FLAG_ENGINE.get()){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.engine = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> V8Engine(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.engine = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> V12Engine(); } } } <span class="hljs-comment"><span class="hljs-comment">// test // ,   FLAG_ENGINE    Car car = new Car(); //       </span></span></code> </pre><br></div></div><br>  The test is tied to a certain flag.     2  . <br><br><div class="spoiler"> <b class="spoiler_title">:  </b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Car</span></span></span><span class="hljs-class"> </span></span>{ IEngine engine; Car(IEngine engine) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.engine = engine; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EngineFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">IEngine </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isV8)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isV8){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> V8Engine(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> V12Engine(); } } } <span class="hljs-comment"><span class="hljs-comment">//  ar   Car car = new Car(new EngineFactory().build(FLAG_ENGINE.get())); // test IEngine simpleEngine = new SimpleEngine(); Car car = new Car(simpleEngine); //   , simpleEngine    //    </span></span></code> </pre><br></div></div><br><br><h4><a name="a7"></a>        </h4><br><div class="spoiler">  <b class="spoiler_title">before: untested code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Voicemail</span></span></span><span class="hljs-class"> </span></span>{ User user; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Call&gt; calls; Voicemail(User user) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.user = user; } init(Server server) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.calls = server.getCallsFor(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.user); } <span class="hljs-comment"><span class="hljs-comment">//   ,  !!! setCalls(List&lt;Call&gt; calls) { this.calls = calls; } // ... } //  User dummyUser = new DummyUser(); Voicemail voicemail = new Voicemail(dummyUser); voicemail.setCalls(buildListOfTestCalls());</span></span></code> </pre><br></div></div><br>       init,      ,     . init     ,       calls     init.  ,    ,     .    .     ‚Äî       .             .       init.  ,     init, initialize, setup   ,        .     Voicemail      (server.getCallsFor).        Voicemail: <br><br><div class="spoiler"> <b class="spoiler_title">:  </b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Voicemail</span></span></span><span class="hljs-class"> </span></span>{ List&lt;Call&gt; calls; Voicemail(List&lt;Call&gt; calls) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.calls = calls; } <span class="hljs-comment"><span class="hljs-comment">// ... } class ProviderGetCalls { List&lt;Call&gt; getCalls(Server server, User user) { return server.getCallsFor(user); } } //  Voicemail voicemail = new Voicemail(buildListOfTestCalls()); //     </span></span></code> </pre><br></div></div><br><br><h3>  Conclusion </h3><br>  ,      (   new   ,      ),  ,       <b>Dependency Injection</b> . <br><br>      IoC ,     ‚Äî        (),     .      IoC     .    IoC     ‚Äî      . <br><br>  ,    IoC  (   ),   ,      Dependency Injection.      ,     . <br><br>    ,           .       (  ),     (  ¬´¬ª     angular <a href="http://misko.hevery.com/about/">Mi≈°ko Hevery</a> ),        . </div><p>Source: <a href="https://habr.com/ru/post/267277/">https://habr.com/ru/post/267277/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../267257/index.html">New PHP, Part 1: Return types</a></li>
<li><a href="../267265/index.html">The digest of interesting materials for the mobile developer # 121 (September 14-20)</a></li>
<li><a href="../267269/index.html">Monitoring delays during online video broadcasts and teleconferences</a></li>
<li><a href="../267271/index.html">It's harder for Chinese data center operators to use freecooling.</a></li>
<li><a href="../267273/index.html">Linux in a device based on the Altera SoC FPGA chip: restore lost functionality</a></li>
<li><a href="../267279/index.html">The digest of interesting materials from the world of web development and IT for the last week No. 177 (September 14 - 20, 2015)</a></li>
<li><a href="../267281/index.html">PHP Digest number 70 - interesting news, materials and tools (September 6 - 20, 2015)</a></li>
<li><a href="../267283/index.html">We count working days from Moment.js</a></li>
<li><a href="../267289/index.html">Overview of opportunities for working with Microsoft for startups</a></li>
<li><a href="../267291/index.html">Router reservation using VRRP protocol</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>