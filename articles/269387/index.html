<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Oracle regular expressions. Dangerous range</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Oracle developer, who often uses regular expressions in code, especially on bases with orthodox settings, may sooner or later encounter a phenomen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Oracle regular expressions. Dangerous range</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/01b/768/4f4/01b7684f4e9848379102b3c798272fea.jpg"><br><br>  The Oracle developer, who often uses <a href="http://docs.oracle.com/database/121/ADFNS/adfns_regexp.htm">regular expressions</a> in code, especially on bases with orthodox settings, may sooner or later encounter a phenomenon that you can‚Äôt name except mysticism.  A long search for the causes of the problem can lead to weight loss, appetite and provoke various kinds of psychosomatic disorders - all of which I will now try to prevent.  And the regexp_replace function will help me in this.  It can have up to 6 arguments: <br><br>  <b>REGEXP_REPLACE</b> ( <br><ol><li>  source_string </li><li>  template, </li><li>  replacement_string </li><li>  the position of the start of the match with the template (default 1), </li><li>  the number of the occurrence of the pattern in the source string (by default, 0 - all occurrences), </li><li>  modifier (for now dark horse) </li></ol>  ) <br>  Returns the modified source_line in which all occurrences of the pattern are replaced by the value passed in the replace_string parameter.  Often use the short version of the function, where the first 3 arguments are given, which is enough to solve many problems.  I'll do it too.  Suppose we need in the string 'MASK: lower case' to mask all lowercase characters with asterisks.  To specify a range of lowercase characters, the pattern '[az]' should be suitable.  Check 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> regexp_replace(<span class="hljs-string"><span class="hljs-string">'MASK: lower case'</span></span>, <span class="hljs-string"><span class="hljs-string">'[az]'</span></span>, <span class="hljs-string"><span class="hljs-string">'*'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">result</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual</code> </pre> <br>  Expectation <br><pre> <code class="sql hljs">+<span class="hljs-comment"><span class="hljs-comment">------------------+ | RESULT | +------------------+ | MASK: ***** **** | +------------------+</span></span></code> </pre><br>  Reality <br><pre> <code class="sql hljs">+<span class="hljs-comment"><span class="hljs-comment">------------------+ | RESULT | +------------------+ | *A**: ***** **** | +------------------+</span></span></code> </pre><br>  If on your base this phenomenon is not reproduced, it means that you are lucky so far.  But more often begin digging in encodings, converting strings from one set of characters to another, and over time comes about this state <br><a name="habracut"></a><br><img src="https://habrastorage.org/files/0b1/784/0bc/0b17840bcda8468fb1e7f51796a5fb63.jpg"><br><br>  <b>Establishing diagnosis.</b> <br><br>  The question arises - what is so special about the letter 'A' that it has not been replaced, because the other uppercase characters should not have been either.  Maybe, besides her, are there any other correct letters?  It is necessary to watch the entire alphabet of capital letters. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> regexp_replace(<span class="hljs-string"><span class="hljs-string">'ABCDEFJHIGKLMNOPQRSTUVWXYZ'</span></span>, <span class="hljs-string"><span class="hljs-string">'[az]'</span></span>, <span class="hljs-string"><span class="hljs-string">'*'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> alphabet <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual +<span class="hljs-comment"><span class="hljs-comment">----------------------------+ | ALPHABET | +----------------------------+ | A************************* | +----------------------------+</span></span></code> </pre><br>  But. <br><br>  And the joke is this.  If the 6th function argument is not explicitly specified - a modifier, for example, 'i' is case-insensitive, or 'c' is case-sensitive when comparing the source string with a pattern, then the regular expression uses the NLS_SORT parameter of the session / base by default.  I have it like this: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.nls_session_parameters <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> parameter = <span class="hljs-string"><span class="hljs-string">'NLS_SORT'</span></span> +<span class="hljs-comment"><span class="hljs-comment">---------+ | VALUE | +---------+ | RUSSIAN | +---------+</span></span></code> </pre><br>  This parameter sets the sorting method in ORDER BY.  If we are talking about the sorting of simple single characters, then each of them in the binary representation corresponds to a number (NLSSORT ‚Äì code) and the sorting actually occurs according to the magnitude of these numbers. <br><br>  For a visual example, take the first few and last few characters of the alphabet, both lowercase and uppercase, and put them in a conditionally unordered table set, let's call it ABC.  Then we sort this set by the SYMBOL field and next to each symbol we display its NLSSORT ‚Äì code in HEX format. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> ABC <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">column_value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> symbol <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(sys.odcivarchar2list(<span class="hljs-string"><span class="hljs-string">'A'</span></span>,<span class="hljs-string"><span class="hljs-string">'B'</span></span>,<span class="hljs-string"><span class="hljs-string">'C'</span></span>,<span class="hljs-string"><span class="hljs-string">'X'</span></span>,<span class="hljs-string"><span class="hljs-string">'Y'</span></span>,<span class="hljs-string"><span class="hljs-string">'Z'</span></span>,<span class="hljs-string"><span class="hljs-string">'a'</span></span>,<span class="hljs-string"><span class="hljs-string">'b'</span></span>,<span class="hljs-string"><span class="hljs-string">'c'</span></span>,<span class="hljs-string"><span class="hljs-string">'x'</span></span>,<span class="hljs-string"><span class="hljs-string">'y'</span></span>,<span class="hljs-string"><span class="hljs-string">'z'</span></span>)) ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> symbol, nlssort(symbol) nls_code_hex <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ABC <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> symbol</code> </pre><br><table border="1"><tbody><tr><th>  SYMBOL </th><th>  NLS_CODE_HEX </th></tr><tr><td>  A </td><td>  14000100 </td></tr><tr><td>  a </td><td>  14000200 </td></tr><tr><td>  B </td><td>  19000100 </td></tr><tr><td>  b </td><td>  19000200 </td></tr><tr><td>  C </td><td>  1E000100 </td></tr><tr><td>  c </td><td>  1E000200 </td></tr><tr><td>  X </td><td>  7D000100 </td></tr><tr><td>  x </td><td>  7D000200 </td></tr><tr><td>  Y </td><td>  82000100 </td></tr><tr><td>  y </td><td>  82000200 </td></tr><tr><td>  Z </td><td>  87000100 </td></tr><tr><td>  z </td><td>  87000200 </td></tr></tbody></table><br>  The request contains the ORDER BY by the SYMBOL field, but in fact the database was sorted according to the values ‚Äã‚Äãfrom the NLS_CODE_HEX field. <br><br>  Now let's go back to the range from the template and look at the table - what is vertically between the character 'a' (code 14000200) and 'z' (code 87000200)?  All but the capital letter 'A'.  This is all an asterisk and replaced.  And the code 14000100 of the letter 'A' did not fall into the range of replacement from 14000200 to 87000200. <br><br>  Cyrillic is the same story.  Below is a query with similar results, their reasons are now not difficult to understand. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, regexp_replace(<span class="hljs-string"><span class="hljs-string">'ABCDEFJHIGKLMNOPQRSTUVWXYZ'</span></span>, <span class="hljs-string"><span class="hljs-string">'[az]'</span></span>, <span class="hljs-string"><span class="hljs-string">'*'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">result</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>, regexp_replace(<span class="hljs-string"><span class="hljs-string">'abcdefjhigklmnopqrstuvwxyz'</span></span>, <span class="hljs-string"><span class="hljs-string">'[AZ]'</span></span>, <span class="hljs-string"><span class="hljs-string">'*'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>, regexp_replace(<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'[-]'</span></span>, <span class="hljs-string"><span class="hljs-string">'*'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>, regexp_replace(<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'[-]'</span></span>, <span class="hljs-string"><span class="hljs-string">'*'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual</code> </pre><br><table border="1"><tbody><tr><th>  ID </th><th>  RESULT </th></tr><tr><td>  one </td><td>  A ************************* </td></tr><tr><td>  2 </td><td>  ************************* z </td></tr><tr><td>  3 </td><td>  BUT***************************** </td></tr><tr><td>  four </td><td>  *****************************I </td></tr></tbody></table><br>  <b>Treatment.</b> <br><br>  Explicitly specify a case-sensitive modifier <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> regexp_replace(<span class="hljs-string"><span class="hljs-string">'MASK: lower case'</span></span>, <span class="hljs-string"><span class="hljs-string">'[az]'</span></span>, <span class="hljs-string"><span class="hljs-string">'*'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'c'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual +<span class="hljs-comment"><span class="hljs-comment">------------------+ | RESULT | +------------------+ | MASK: ***** **** | +------------------+</span></span></code> </pre><br>  In some sources they write that the modifier 'c' is set by default, but just that we saw that this is not quite so.  And if someone doesn‚Äôt see, it means that the NLS_SORT parameter of its session / base is most likely set to BINARY and the sorting is in accordance with the actual character codes.  Indeed, if you change the session parameter, the problem will go away. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SESSION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NLS_SORT=<span class="hljs-built_in"><span class="hljs-built_in">BINARY</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> regexp_replace(<span class="hljs-string"><span class="hljs-string">'MASK: lower case'</span></span>, <span class="hljs-string"><span class="hljs-string">'[az]'</span></span>, <span class="hljs-string"><span class="hljs-string">'*'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">result</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual +<span class="hljs-comment"><span class="hljs-comment">------------------+ | RESULT | +------------------+ | MASK: ***** **** | +------------------+</span></span></code> </pre><br>  Tests, if anything, were conducted in Oracle 12c. <br><br>  In the meantime, everything.  Good health. </div><p>Source: <a href="https://habr.com/ru/post/269387/">https://habr.com/ru/post/269387/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269377/index.html">Api-platform</a></li>
<li><a href="../269379/index.html">Analysis of options for building telephony based on Microsoft Skype For Business</a></li>
<li><a href="../269381/index.html">Pirate metrics: how to create an AARRR email campaign from Dave McClure. Part 1</a></li>
<li><a href="../269383/index.html">Embed JSON in Embedded? Easy peasy</a></li>
<li><a href="../269385/index.html">Cache in Drupal from A to Z</a></li>
<li><a href="../269389/index.html">Xamarin.UITest</a></li>
<li><a href="../269391/index.html">ShishNashKi</a></li>
<li><a href="../269393/index.html">Security Week 43: hard prime numbers, cryptography in HDD, Adobe and Oracle patches</a></li>
<li><a href="../269395/index.html">Golden Site distributed elephants to the best Internet projects.</a></li>
<li><a href="../269397/index.html">Instant download of desktop and mobile sites: part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>