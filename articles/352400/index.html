<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Transferring a running Linux system to XFS from HDD to a smaller SSD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! I present to your attention the Russian version of the article " Migrating CentOS system from HDD to smaller SSD on XFS filesystem " by Deni...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Transferring a running Linux system to XFS from HDD to a smaller SSD</h1><div class="post__text post__text-html js-mediator-article"><p>  Hi, Habr!  I present to your attention the Russian version of the article " <a href="http://dsavenko.me/migrating-centos-system-from-hdd-to-smaller-ssd-on-xfs-filesystem/">Migrating CentOS system from HDD to smaller SSD on XFS filesystem</a> " by Denis Savenko. </p><br><p><img src="https://habrastorage.org/webt/8l/wp/nc/8lwpncwhbo2kfqnjpjfq6wmuhl0.png" alt="Cover Image"></p><br><p>  This article is a Russian-language version of the previously published article in English with minor adjustments for the audience.  Immediately make a reservation - I am not a Linux maniac or even a professional system administrator, so it is likely that sometimes I could use unusual, or even stupid solutions.  I will be very grateful to you if you point me to them in the comments so that I can improve this guide instead of just reading the article.  Thank you in advance for this. </p><br><p>  I think I'm not the only one who at some point decided to buy an SSD disk for a running system.  In my case, it was a working system on <strong>CentOS 7</strong> on my <a href="http://dsavenko.me/fully-functional-linux-server-in-just-a-5-on-5-inch-box/">tiny home</a> server.  Next, I wanted to transfer it "as is" to a new disk.  But as it turned out, it is not so easy to do, given the following: </p><br><ul><li>  The new SSD drive was much smaller than the HDD already installed (seriously, SSD is still quite expensive compared to disk drives). </li><li> Partitions on the same disk were formatted in the <code>xfs</code> file system.  This is not surprising, given the fact that <strong>CentOS</strong> , starting with version 7, offers this file system "by default" (along with other RHEL-based systems, such as <strong>Red Hat Enterprise Linux 7</strong> , <strong>Oracle Linux 7).</strong> or <strong>Scientific Linux 7</strong> ). </li><li>  A working system should remain unchanged, including the configuration, installed software, access rights and other attributes of the file system. </li></ul><a name="habracut"></a><br><p>  Let me explain why the things I described above are serious complications of the task before us. </p><br><p>  First, if the size of the new disk were the same or larger than the previous one, the full cloning of data partitions could be applied.  To do this, there are a lot of utilities, such as <strong>dd</strong> , <strong>ddrescue</strong> , <strong>partclone</strong> or even <strong>clonezilla</strong> .  The only thing that would have to be done afterwards is to tweak a couple of configuration files in the boot partition.  If you use LVM for your partitions (which is also the default option on <strong>CentOS 7</strong> ), the task could be even simpler ‚Äî a new disk is added to the logical volume, then the data is transferred to another physical medium inside the logical volume using the <code>pvmove</code> command. and the old disk is removed from the partition, but this is not possible with a smaller amount of new physical media. </p><br><p>  Then, if a file system other than <code>xfs</code> , for example, a fairly popular <code>ext4</code> , was used, the old partition of the disk could be compressed to the size of the new disk.  Then any actions from those described above are performed and you are in queens.  However, resizing partitions by <code>xfs</code> impossible due to its implementation - you can only enlarge partitions when using it. </p><br><p>  Last but not least, if we did not have the task to transfer a working configured system while preserving all the metadata, it would be easier to simply install the system from scratch to a new disk, saving a couple of important files in advance.  It did not suit me for two reasons - firstly, my hair was standing up at the thought that I would have to repeat all the same actions that I performed for several days in a row, and secondly, it was just not sporting.  I was sure that with a proper understanding of the technical features, transferring a working system to another disk should not have been an impossible task. </p><br><p>  Nevertheless, I have developed and tested a detailed step-by-step plan for moving a working system on at least two different environments, taking into account all the above limitations. </p><br><h2 id="etap-1-podgotovka">  Stage 1. Preparation </h2><br><p>  Here is a list of what we need to transfer: </p><br><ol><li>  Actually, the working system subject to migration.  In my case it was CentOS 7.4, but I am sure that the situation will not differ from any other Linux system running on <code>xfs</code> . </li><li>  Live CD or USB flash drive with any Linux distribution.  For simplicity, I will build on the same CentOS 7.4 Live CD.  I prefer the Gnome version, but this is a matter of taste.  The choice of this distribution is due to the fact that, firstly, I already had it, and secondly, the toolkit we needed to transfer, and in particular <code>xfsdump</code> delivered with it immediately.  I will not dwell here on how to create a boot disk or USB flash drive with a Live CD distribution, as I assume that the reader should handle this without me. </li><li>  The amount of data on the old drive should not exceed the size of the new disk (be it an SSD or any other smaller disk).  In my case, only about 10 GB was occupied, so I did not even think about what to get rid of. </li><li>  A cup of hot coffee. </li></ol><br><h2 id="etap-2-migraciya">  Stage 2. Migration </h2><br><p>  We take a cup of coffee and start the transfer process from launching the system from the live CD distribution prepared.  Then open the terminal and go to superuser mode with the command <code>su -</code> </p><br><blockquote>  Further in this manual it is assumed that all commands are executed on behalf of the superuser ( <code>root</code> ). </blockquote><br><h3 id="shag-1-razreshenie-udalyonnogo-dostupa-opcionalno">  Step 1. Allow remote access (optional) </h3><br><p>  For me, it is more convenient to have remote access to the machine on which I will carry out the transfer, since  I have the opportunity to simply copy the previously prepared commands into my <strong>PuTTY</strong> terminal.  If you downloaded this guide in the browser on the target machine, feel free to skip to the next step - everything described here is not needed. </p><br><p>  In order to allow remote access, you must set a password for the <code>root</code> and start the SSH daemon: </p><br><pre> <code class="hljs pgsql">su passwd systemctl <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> sshd</code> </pre> <br><p>  Now you can connect to the target machine with your SSH client (for example, <strong>PuTTY</strong> ). </p><br><h3 id="shag-2-razbivka-diska-na-razdely">  Step 2. Partitioning the disk </h3><br><p>  You can use your favorite utility for this.  For example, Gnome has a pre-installed disk management utility.  Also on the Internet, they praise <code>gparted</code> , but I intentionally used <code>fdisk</code> , because, for example, <code>gparted</code> simply did not recognize my NVMe SSD disk. </p><br><p>  The disk should be broken in the image of the old disk.  I am not a partitioning maniac, so my partitioning scheme was standard: </p><br><ul><li>  <code>/boot</code> - standard 1GB partition; </li><li>  4G swap partition; </li><li>  <code>/</code> - root partition, LVM volume group with the name "main", occupying the remaining disk space. </li></ul><br><p>  So, let's proceed to the breakdown of the new disk: </p><br><pre> <code class="bash hljs">lsblk <span class="hljs-comment"><span class="hljs-comment">#        ,     nvme0n1 fdisk /dev/nvme0n1 n #    ( /boot) p # primary partition #    (1- ) #    (  ) +1G #    /boot #  n #    (  LVM volume group) p # primary partition #    (2- ) #    (   ) #    (100%  ) #  a #   "bootable" 1 #  10  p # ,     w #     </span></span></code> </pre> <br><p>  The <code>/boot</code> partition should be a standard Linux partition, so we immediately create a file system on it: </p><br><pre> <code class="hljs">mkfs.xfs /dev/nvme0n1p1 -f</code> </pre> <br><p>  And now we need to create an LVM structure for the second partition on the disk.  <code>newmain</code> new LVM group <code>newmain</code> (later rename): </p><br><pre> <code class="bash hljs">pvcreate /dev/nvme0n1p2 <span class="hljs-comment"><span class="hljs-comment">#    LVM-   vgcreate newmain /dev/nvme0n1p2 #   LVM-         LVM- lvcreate -L 4G -n swap newmain #     4   swap lvcreate -l 100%FREE -n root newmain #         </span></span></code> </pre> <br><p>  Now we are ready to create a file system on new logical partitions: </p><br><pre> <code class="bash hljs">mkfs.xfs /dev/newmain/root <span class="hljs-comment"><span class="hljs-comment">#       mkswap -L swap /dev/newmain/swap #  swap    swapon /dev/newmain/swap</span></span></code> </pre> <br><h3 id="shag-3-aktivnaya-faza">  Step 3. Active Phase </h3><br><p>  Before we start, let's make both LVM groups active (because we work from under the Live CD): </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">vgchange</span></span> -ay main vgchange -ay newmain</code> </pre> <br><p>  Create directories for mount points and mount old and new partitions of our disks to the system: </p><br><pre> <code class="bash hljs">mkdir -p /mnt/old/boot mkdir -p /mnt/old/root mkdir -p /mnt/new/boot mkdir -p /mnt/new/root mount /dev/sda1 /mnt/old/boot mount /dev/nvme0n1p1 /mnt/new/boot mount /dev/main/root /mnt/old/root mount /dev/newmain/root /mnt/new/root</code> </pre> <br><p>  Make sure that everything is in order with the help of the <code>lsblk</code> : </p><br><pre> <code class="bash hljs">lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 931.5G 0 disk ‚îú‚îÄsda1 8:1 0 1G 0 part /mnt/old/boot ‚îî‚îÄsda2 8:2 0 930.5G 0 part ‚îú‚îÄmain-swap 253:0 0 3.6G 0 lvm [SWAP] ‚îî‚îÄmain-root 253:1 0 926.9G 0 lvm /mnt/old/root nvme0n1 259:0 0 119.2G 0 disk ‚îú‚îÄnvme0n1p1 259:3 0 1G 0 part /mnt/new/boot ‚îî‚îÄnvme0n1p2 259:4 0 118.2G 0 part ‚îú‚îÄnewmain-swap 253:5 0 4G 0 lvm [SWAP] ‚îî‚îÄnewmain-root 253:6 0 114.2G 0 lvm /mnt/new/root</code> </pre> <br><p>  If you see something like this, you did everything right.  And here the real magic begins - we are going to use <code>xfsdump</code> to migrate our data.  This utility is smart enough and knows about the internal structure of the <code>xfs</code> file system, which allows it to copy only the blocks occupied by data, which, in turn, firstly allows us to copy data to a smaller disk, and secondly, greatly accelerates the transfer process.  So, let's dump the data with this utility, and deploy this data in a new place on the fly: </p><br><pre> <code class="bash hljs">xfsdump -l0 -J - /mnt/old/boot | xfsrestore -J - /mnt/new/boot xfsdump -l0 -J - /mnt/old/root | xfsrestore -J - /mnt/new/root</code> </pre> <br><p>  A few words about the flags used: </p><br><ul><li>  <code>-J</code> reduces the size of feedback; </li><li>  <code>-</code> Tells <code>xfsdump</code> and <code>xfsrestore</code> use standard <code>stdout</code> and <code>stdin</code> streams, respectively, instead of files. </li></ul><br><p>  This procedure <strong>may take some time</strong> (depending on the amount of your data).  Therefore, here you will need a cup of coffee prepared in advance, which is time to drink, or else it will cool down. </p><br><p>  If everything went well, your data was completely copied and all the metadata was saved.  Now you need to tweak a couple of configuration files and reinstall Grub2 to a new disk to make it bootable. </p><br><h3 id="shag-4-delaem-novyy-disk-zagruzochnym">  Step 4. Making the new disk bootable </h3><br><p>  The first thing to do is find out the UUID for the old and new boot partitions ( <code>/boot</code> ) with the <code>blkid</code> : </p><br><pre> <code class="bash hljs">blkid ... /dev/nvme0n1p1: UUID=<span class="hljs-string"><span class="hljs-string">"3055d690-7b2d-4380-a3ed-4c78cd0456ba"</span></span> TYPE=<span class="hljs-string"><span class="hljs-string">"xfs"</span></span> ... /dev/sda1: UUID=<span class="hljs-string"><span class="hljs-string">"809fd5ba-3754-4c2f-941a-ca0b6fb5c86e"</span></span> TYPE=<span class="hljs-string"><span class="hljs-string">"xfs"</span></span> ...</code> </pre> <br><p>  Assuming that <code>sda1</code> is the old <code>\boot</code> partition, and <code>nvme0n1p1</code> is new, we replace the UUID in the configuration files on the new mount point: </p><br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">"s/809fd5ba-3754-4c2f-941a-ca0b6fb5c86e/3055d690-7b2d-4380-a3ed-4c78cd0456ba/g"</span></span> /mnt/new/root/etc/fstab sed -i <span class="hljs-string"><span class="hljs-string">"s/809fd5ba-3754-4c2f-941a-ca0b6fb5c86e/3055d690-7b2d-4380-a3ed-4c78cd0456ba/g"</span></span> /mnt/new/boot/grub2/grub.cfg</code> </pre> <br><p>  These two commands will prepare your system configuration files for the new disk. </p><br><p>  Now it's time to rename the LVM groups and unmount the disks: </p><br><pre> <code class="bash hljs">umount /mnt/{old,new}/{boot,root} vgrename -v {,old}main vgrename -v {new,}main</code> </pre> <br><p>  The only thing left to do is reinstall the bootloader.  This should be done using <code>chroot</code> : </p><br><pre> <code class="bash hljs">mount /dev/main/root /mnt mkdir -p /mnt/boot mount /dev/nvme0n1p1 /mnt/boot mount -t devtmpfs /dev /mnt/dev mount -t proc /proc /mnt/proc mount -t sysfs /sys /mnt/sys chroot /mnt/ grub2-install /dev/nvme0n1</code> </pre> <br><h3 id="shag-5-posledniy-shtrih">  Step 5. The final touch </h3><br><p>  At this stage, all data should be transferred and the new disk should be bootable.  You just need to restart, remove the Live CD from the drive, and select the new disk in the BIOS to boot: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">systemctl</span></span> reboot -f</code> </pre> <br><blockquote>  If something went wrong and the system does not boot, you can always ‚Äúroll back‚Äù to the old disk, simply by re-launching the Live CD and renaming the LVM groups back by executing <code>vgrename -v {,new}main</code> and <code>vgrename -v {old,}main</code> , and then restart again. </blockquote><p>  At the same time, the mandatory part of the program is over and we have successfully transferred the working system to a new disk.  Old disk can be removed from the computer. </p><br><hr><br><h2 id="ispolzovanie-starogo-hdd-v-kachestve-media-hranilischa">  Using the old HDD as a media storage </h2><br><p>  If you, like me, after transferring the system, want to use your old disk as a media storage, this is also easy. </p><br><p>  First, repartition the old disk. </p><br><pre> <code class="bash hljs">fdisk /dev/sda d <span class="hljs-comment"><span class="hljs-comment">#   2 d #   1 n #   p # primary partition #  1 #   #    #  p # ,    w #   </span></span></code> </pre> <br><p>  We will not create a file system on disk directly.  Instead, we will create a new LVM group to which we will add this disk.  This will allow us in the future to easily add new disks to this group without unnecessary trouble (the logical drive will remain the same): </p><br><pre> <code class="bash hljs">pvcreate /dev/sda1 <span class="hljs-comment"><span class="hljs-comment">#   LVM- vgcreate media /dev/sda1 #  LVM- lvcreate -l 100%FREE -n media1 media #         vgchange -ay media #   LVM-  mkfs.xfs /dev/media/media1 #       mkdir -p /var/media #      mount /dev/media/media1 /var/media #     </span></span></code> </pre> <br><p>  In order to save changes after rebooting the system, you should also add an entry for the mount point in <code>/etc/fstab</code> : </p><br><pre> <code class="bash hljs">/dev/mapper/media-media1 /var/media xfs defaults 0 0</code> </pre> <br><h2 id="gotovo">  Done! </h2><br><p>  Now it can be argued that we successfully transferred the system running on <code>xfs</code> to a new smaller disk.  As a bonus, we began to use the old disk as a media storage. </p><br><hr><br><h2 id="update-02042018">  UPDATE 04/02/2018 </h2><br><p>  Since we were transferring the system to SSD, then, as advised in the comments, it would be good to switch on the periodic execution of the <code>trim</code> command after the transfer in the running system (garbage collector for SSD disks, which allows not losing performance over time).  To do this, run the command: </p><br><pre> <code class="bash hljs">systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> fstrim.timer</code> </pre> <br><p>  This will enable <code>trim</code> on the new system once a week on any <code>systemd</code> system.  In case you or your system do not use <code>systemd</code> , there is a <a href="https://www.digitalocean.com/community/tutorials/how-to-configure-periodic-trim-for-ssd-storage-on-linux-servers">comprehensive guide</a> from DigitalOcean for almost any case. </p><br><hr><br><p>  Please leave your comments if you find a mistake or know a better way how to perform certain actions.  I hope this manual will be useful to you! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/352400/">https://habr.com/ru/post/352400/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352390/index.html">Full translation of the book about building communities: "Social Architecture"</a></li>
<li><a href="../352392/index.html">Smooth text scaling</a></li>
<li><a href="../352394/index.html">General cleaning in the company: how we turned shops</a></li>
<li><a href="../352396/index.html">How to recover a lost password to the archive using a video card</a></li>
<li><a href="../352398/index.html">Why does retail and goods delivery business move to IaaS: case review</a></li>
<li><a href="../352402/index.html">CLOUD At: a new US bill provides access to personal data abroad</a></li>
<li><a href="../352404/index.html">Changing the main stack from .NET to Java</a></li>
<li><a href="../352408/index.html">PHP 5.x - old people here (wrong) place</a></li>
<li><a href="../352410/index.html">QA in mobile game development or how to build a process in an indie company</a></li>
<li><a href="../352412/index.html">Tomorrow is March 31st. Please back up</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>