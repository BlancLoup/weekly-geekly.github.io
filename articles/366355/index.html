<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The work of WiFi modules "Master Keith" in the control system of home automation OpenHAB. Part 1: Connection and Setup</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A noticeable number of wireless devices for home automation has appeared in the Master Keith product range, but it is often difficult to assemble them...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The work of WiFi modules "Master Keith" in the control system of home automation OpenHAB. Part 1: Connection and Setup</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/744/190/a32/744190a3276d4215b251d7b2b42e8e4a.jpg" width="500"><br><br>  A noticeable number of wireless devices for home automation has appeared in the Master Keith product range, but it is often difficult to assemble them into some kind of optimal home control system due to the lack of necessary, and most importantly, convenient software.  To solve this problem, we will try to use the already existing popular home automation systems.  This is real!  For example, the OpenHAB home automation system is an open project, about which quite a lot has already been written, even in the Russian part of the Internet. <br><a name="habracut"></a><br>  One of these publications: <a href="http://habrahabr.ru/post/232969/">"OpenHAB - become a programmer of your own home"</a> (I recommend reading, if you have not done so before). <br><br>  The distribution for a very simple installation of OpenHAB can be taken absolutely free <a href="http://www.openhab.org/getting-started/downloads.html">here</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It will be logical if I omit the description of OpenHAB and the way it is installed on the computer.  The purpose of the article is to figure it out for yourself and show you some examples of connecting the Master Keith modules to OpenHAB. <br><br>  First of all, you will need to download and install the Runtime core - the main OpenHAB module, which is independent of the operating system. <br><br><img src="https://habrastorage.org/files/a37/0d7/4f3/a370d74f35ea49eb946e711198e84762.jpg" width="700"><br><br>  For simplicity, I will use the usual text editor Notepad, since all the files you will have to deal with are text files.  Just in the future, we will save them not in the .txt format, but with the necessary extensions;  with what exactly - let's figure it out as we go ... <br><br>  Having installed the demo version, I began to try various settings, and when it began to work, I removed all the ‚Äúextras‚Äù so as not to interfere.  The result was a small configuration called "Test Drive MK".  It can be downloaded and installed on your computer, so as not to type manually. <br><br>  Another necessary preparatory step was to connect all the devices under test to the same local network as the computer with OpenHAB installed. <br><br><img src="https://habrastorage.org/files/172/b39/917/172b3991779d42788ad52f71398d899c.jpg" width="700"><br><br>  So‚Ä¶ <br>  Test drive device number 1 <br>  <a href="http://masterkit.ru/shop/smarthome/smarthouse/1910043">MP3500 Wi-Fi relay, 2 channels</a> (based on ESP8266). <br><br>  This is the first module in the line of devices based on the ESP8266 Wi-Fi chip, which is so popular today.  It allows using a simple Android application (such as DEMO) to click two relyushkami, count the time each load.  To do this, you must either connect to its own wireless network, or connect it to your home Wi-Fi network. <br><br><img src="https://habrastorage.org/files/aa1/e7e/c7f/aa1e7ec7f4da4efcbd910237ae5693a9.jpg" width="200"><br><br>  I chose the latter, and using the included Configurator I connected the module to the same local network as OpenHAB.  The module itself is controlled by AT commands like! SetR0_1, and sends a response of the format! LEDOFF1.  The commands are described in detail in the WORK PRINCIPLE section. <br><br>  Now directly on configuring OpenHAB.  All the files that we will change are in the folder C: \ OpenHab \ configurations.  This folder should be saved as a backup. <br><br>  <b>1. General settings.</b>  Find in the folder C: \ OpenHab \ configurations file openhab.cfg.  These are the basic system settings.  Next, from the OpenHAB DEMO configuration, we remove the extra comments (lines starting with #).  For us here, it is important to correctly launch the necessary "TCP - UDP Binding" - a driver for communicating with devices using TCP / UDP protocols, which will provide communication with the MP3500 module using the UDP protocol.  We make all the settings specifically for UDP (only the necessary lines with explanations are left): <br><br>  <i>########### TCP - UDP Binding ########################</i> <i><br></i>  <i># Listening port for incoming connections of modules of the MP3500, 3502 family</i> <i><br></i>  <i>udp: port = 7777</i> <i><br></i>  <i># Maximum buffer size for read data and other fine-tuning</i> <i><br></i>  <i>udp: buffersize = 1024</i> <i><br></i>  <i>udp: itemsharedconnections = true</i> <i><br></i>  <i>udp: bindingsharedconnections = true</i> <i><br></i>  <i>udp: directionssharedconnections = true</i> <i><br></i>  <i>udp: selecttimeout = 1000</i> <i><br></i>  <i>udp: charset = ASCII</i> <i><br><br></i>  <i># Allow mask when addressing ip: port, for example 192.168.0.1:*</i> <i><br></i>  <i>udp: addressmask = true</i> <i><br></i>  <i># Without this parameter, banding will not start at all: update interval</i> <i><br></i>  <i>udp: refreshinterval = 250</i> <br><br>  <b>2. System interface.</b>  After we have dealt with the system settings, we will deal with the WEB interface.  In many ways (but not completely), the file with the extension .sitemaps is responsible for it.  The name of the file itself determines the address of the site on the network, which you will type on the browser command line. <br><br><img src="https://habrastorage.org/files/b0f/901/d36/b0f901d36fe740c29f51f57d7919bad1.jpg"><br><br>  The file is located in the folder C: \ OpenHab \ configurations \ sitemaps.  To get such a picture of the main screen: <br><br><img src="https://habrastorage.org/files/4f8/385/a57/4f8385a574d54d8dabdf13a942618fae.jpg" width="700"><br><br>  The following content is required for the testdrive.sitemap file: <br><br>  <i>// The title is described here.</i> <i><br></i>  <i>sitemap testdrive label = "Master Kit - OpenHAB"</i> <i><br></i>  <i>{</i> <i><br></i>  <i>Frame label = "Test drive modules Master Kit for home automation" {</i> <i><br></i>  <i>// Create a group for Wi-Fi modules</i> <i><br></i>  <i>Group item = gFF label = "Wi-Fi modules" icon = "cellar"</i> <i><br></i>  <i>}</i> <i><br></i>  <i>// Leave to confirm that the system is "live" display of time and date.</i>  <i>In // configuration file for this, I left a link to the site of time and its update period:</i> <i><br></i>  <i>Frame label = "Date and time" {</i> <i><br></i>  <i>Text item = Date</i> <i><br></i>  <i>Text item = Time</i> <i><br></i>  <i>}</i> <br><br>  <b>Do not lose the braces {} - they are important!</b> <br><br>  <b>3. Description of the MP3500 module in the system and how to control it.</b>  All controls are described in the file with the .items extension, which is located in the C: \ OpenHab \ configurations \ items folder. <br><br>  Group gFF (All) // Creates an interface page for Wi-Fi modules <br>  Group WIFI_3500 "MP3500 Wi-Fi Relay, 2 Channels" (gFF) <br><br>  / * Page for working with MP3500 WiFi relay, 2 channels * / <br><br>  Switch MP3500_R1 "MP3500_Relay 1" (WIFI_3500) {udp = "&gt; [ON: 192.168.2.109: 7777: MAP (MP3500_R1.map)],&gt; [OFF: 192.168.2.109: 7777: MAP (MP3500_R1.map)]"} <br><br>  Switch MP3500_R2 "MP3500_Relay 2" (WIFI_3500) {udp = "&gt; [ON: 192.168.2.109: 7777: MAP (MP3500_R2.map)],&gt; [OFF: 192.168.2.109: 7777: MAP (MP3500_R2.map)]"} <br><br>  Switch MP3500_R2_Button "MP3500_Relay 2 Pulse" (WIFI_3500) {udp = "&gt; [ON: 192.168.2.109: 7777: MAP (MP3500_R2_Pulse.map)]]} <br><br>  Switch MP3500_Request "MP3500 Request Status" (WIFI_3500) {udp = "&gt; [ON: 192.168.2.109: 7777: MAP (MP3500_Info.map)]"} <br><br>  String MP3500_Stat "Answer received: [:% s]" (WIFI_3500) {udp = "&lt;[192.168.2.109:*:'REGEX ((.*))]] ']"} <br><br>  / * NTP binding demo item * / <br>  DateTime Date "Today: [% 1 $ tA,% 1 $ td.% 1 $ tm.% 1 $ tY]" {ntp = "Europe / Moscow: en_EN"} <br>  DateTime Time "Moscow time: [% tT]" {ntp = "Europe / Moscow: en_EN"} <br><br>  A file with this content forms the following page on the screen. <br><br>  <b>Attention!</b>  In the file, the text relating to one element (Item), should be written in one line.  On the page of this publication, this text in one line does not fit;  See the source file testdrive.items. <br><br>  Group elements are responsible for grouping controls and for navigating to them on the page.  DateTime elements provide a date and time display on the main page.  For the control page by the MP3500 module itself, there are 4 elements of the type Switch and one type of String. <br><br>  For example, I made switches for each of the outputs.  These are MP3500_Relay 1 and MP3500_Relay 2. A switched on light bulb and a blue color of the switch engine indicate that the relay is on and, respectively, vice versa.  This is the most common way to control a relay. <br><br>  The third top element MP3500 Relay 2 Impulse demonstrates the ability of the WiFi relay to operate in a pulsed mode, that is, by pressing the button, the relay is switched on for a period of time specified by you in the program, for example, 2 seconds.  After this, the relay returns to the off state, and the on-screen switch together with the light bulb also goes into the off state. <br><br><img src="https://habrastorage.org/files/80c/355/cdd/80c355cdd49b4e8aa730bf4f68b1f9f8.jpg" width="700"><br><br>  I did not find in the OpenHAB description an item of the BUTTON type, so resetting the switch to the off state had to be done by using the RULES tool (Rules), but more on that below. <br><br>  The button MP3500 Request Status allows you to read information from the module about its state, namely: each relay is on or off and the operation time of each relay in minutes is the motorcycle hours counter.  Sometimes this is useful, for example, for analyzing heating costs.  You can find out how many hours a day the heater is running to maintain the set temperature. <br><br>  And the response line is received. Actually, the module response is displayed.  In the figure above, you can see that channel 1 is enabled. <br><br>  Now we will analyze the command structure that controls the relay through the TCP / UDP Binding we are running.  The overall command pattern looks like this: <br><br>  udp = "[:::], [:::], ..." <br><br>  (I remind you once again - the text is written in one line).  Read more <a href="https://github.com/openhab/openhab/wiki/TCP-Binding">here</a> . <br><br>  From the template can be seen: <br><br>  ‚Ä¢ you can select a protocol, in our case it is udp; <br>  ‚Ä¢ you can specify the direction of transmission, incoming or outgoing; <br>  ‚Ä¢ bind to the event - the OpenHAB team; <br>  ‚Ä¢ specify the IP address and port; <br>  ‚Ä¢ and ... the most interesting thing is to specify the transformation or transformation rule, since to send a command to the port in an explicit form - a combination of symbols of the type! SetR0_1 will not work. <br><br>  More information about the rules of transformation (this is important)!  For storage of transformation rules files with the .map extension are used.  They are stored in the C: \ OpenHab \ configurations \ transform folder.  As usual, these are simple text files with the contents of the form: <br><br>  ON =! StartPulseR2,2 \ r <br>  OFF =! SetR0_2 \ r <br><br>  That is, you describe the correspondence between the OpenHAB team and the command of the module itself.  In the first line, for example, on the ON command, which is generated inside OpenHAB when you click on the switch image, a character string is sent to the port itself! StartPulseR2,2 \ r, which will force the MP3500 module to work.  This approach has some disadvantages in that for each control you have to create your own file, but if you give them a clear name, then you can live.  My folder with files turned out like this: <br><br><img src="https://habrastorage.org/files/e44/960/990/e44960990b9a4077a046f83bfa258d45.jpg"><br><br>  Now consider a specific line, for example: <br><br>  <i>Switch MP3500_R1 "MP3500_Relay 1" (WIFI_3500) {udp = "&gt; [ON: 192.168.2.109: 7777: MAP (MP3500_R1.map)],&gt; [OFF: 192.168.2.109: 7777: MAP (MP3500_R1.map)]"}</i> <br><br>  In human language, it translates as: <br><br>  - <i>Switch MP3500_R1</i> - element of type Switch with the name of the system MP3500_R1; <br>  - <i>‚ÄúMP3500_Relay 1‚Äù</i> - the name that we see on the screen; <br>  - <i>(WIFI_3500)</i> - belongs to the group WIFI_3500; <br>  - <i>udp = "&gt; [ON: 192.168.2.109: 7777: MAP (MP3500_R1.map)]</i> - reads like this: in the case of the ON command, establish an outgoing connection with the address on the network 192.168.2.109 * and send characters through the port 7777 via the UDP protocol which are in the file MP3500_R1.map; <br>  - <i>&gt; [OFF: 192.168.2.109: 7777: MAP (MP3500_R1.map)] "}</i> - similarly for the OFF command. If there were other commands, they could be written similarly, separated by commas. <br>  * the specific address that my router specifically assigned to my module, you will have your address.  If there are difficulties - contact the <a href="http://masterkit.ru/%3F1910043">technical support service Master Keith</a> . <br><br>  All text is written all in one line.  We must not forget or skip round, square and just brackets, quotes and commas - everything matters.  Often for this reason, the device does not work. <br><br>  This command reads the module‚Äôs response and displays it in the ‚ÄúAnswer received‚Äù line. <br><br>  <i>String MP3500_Stat "Answer received: [:% s]" (WIFI_3500) {udp = "&lt;[192.168.2.109:*:'REGEX ((.*)) ']"}</i> <br><br>  Please note - there is already an incoming connection and I used a mask (*) in order to read the signal from any port.  If you specify port 7777, then nothing will be read.  On this, I "killed" a couple of evenings.  But now it does not threaten you.  Consider the new and incomprehensible parts of the command: <br><br>  'REGEX ((. *))' Is the ‚ÄúRegular Expression‚Äù function, with which you can find and select the necessary parts of the text in the read line.  Used in many programming languages.  Read more <a href="https://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B5%25D0%25B3%25D1%2583%25D0%25BB%25D1%258F%25D1%2580%25D0%25BD%25D1%258B%25D0%25B5_%25D0%25B2%25D1%258B%25D1%2580%25D0%25B0%25D0%25B6%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F">here</a> . <br><br>  I will explain how to use this mechanism as needed when connecting the following modules (still a nuisance!), And this, the simplest case, is deciphered as follows: read (capture) any number of any characters in the incoming line except the ending sign. <br><br>  [:% s] - this part of the command displays the read value on the screen. <br><br>  <b>4. Work.</b>  This is the minimum that is needed in order to start managing the MP3500 Wi-Fi relay.  We give food, we wait for registration in a network and we start to press buttons. <br><br>  You can preview a short video: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/crjXXKszSzI%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjc9EwptL1CMXOx2ncwuSnyxrmLXw" frameborder="0" allowfullscreen=""></iframe><br><br>  <b>5. And finally, a</b> few words on how to make the switch on the screen automatically go OFF in the BUTTON mode.  To do this, we find in the folder C: \ OpenHab \ configurations \ rules the file testdrive.rules.  We use the capabilities of the internal timer of the system. <br><br>  If you do not consider the standard connection of the necessary libraries and the declaration of variables, then the main element of the code is this: <br><br>  <i>if (receivedCommand == ON) {</i> <i><br></i>  <i>if (timer == null) {</i> <i><br></i>  <i>timer = createTimer (now.plusSeconds (2)) [|</i> <i><br></i>  <i>sendCommand (MP3500_R2_Button, OFF)</i> <br><br>  If the received command is ON and the timer is reset, we start a new cycle of the timer until ‚Äúfrom now‚Äù to ‚Äúplus N‚Äù seconds and then send the OFF command to the desired element.  2 is just the number of seconds that I use to control the relay in the ON =! StartPulseR2,2 \ r command, that is, turn on relay 2 for 2 seconds. <br><br>  It was an introductory part, it will be shorter and more interesting further, because you will not have to talk about basic things, such as the location of folders.  Winter is just around the corner, we will connect WiFi - the <a href="http://masterkit.ru/shop/smarthome/smarthouse/1910141">MP3502 thermostat</a> to OpenHAB. <br><br>  I hope that you will install OpenHAB on your computer and will also begin experiments on managing your home. <br><br>  ps  By the way, OpenHAB has a mobile application! <br><br>  Posted by: <a href="http://geektimes.ru/users/miklebor/" class="user_link">Miklebor</a> </div><p>Source: <a href="https://habr.com/ru/post/366355/">https://habr.com/ru/post/366355/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../366343/index.html">Moov Now is your personal sports trainer: swimming, running, boxing, cycling</a></li>
<li><a href="../366345/index.html">Apple will employ 86 specialists in artificial intelligence and machine learning</a></li>
<li><a href="../366347/index.html">Interfaces and Cables: Sound podcast transcript</a></li>
<li><a href="../366349/index.html">GTX 980 Ti and Oculus Rift</a></li>
<li><a href="../366353/index.html">Apple and Microsoft do not want to give correspondence of their users to public services</a></li>
<li><a href="../366357/index.html">In the UK, banned "sexually offensive" advertising smartphone</a></li>
<li><a href="../366359/index.html">The association of small UAVs is calling under the wing</a></li>
<li><a href="../366361/index.html">Robot Hobot-188 for automatic washing of windows</a></li>
<li><a href="../366363/index.html">All hands on deck! Update on Build 10536</a></li>
<li><a href="../366367/index.html">Ask Ethan # 29: The Most Famous Failed Experiment</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>