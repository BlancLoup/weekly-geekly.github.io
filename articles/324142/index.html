<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Setting up automatic deployment of independent development environments on one machine (Docker, Ansible, TeamCity)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this post I will tell how we, in TheQuestion, realized our long-held dream - separate, automatically deployed development environments for each ind...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Setting up automatic deployment of independent development environments on one machine (Docker, Ansible, TeamCity)</h1><div class="post__text post__text-html js-mediator-article"><p>  In this post I will tell how we, in TheQuestion, realized our long-held dream - separate, automatically deployed development environments for each individual task. </p><br><p><img src="https://habrastorage.org/files/4c6/971/609/4c6971609bb8466cae6c28889da489c7.png" alt="image // picture"></p><a name="habracut"></a><br><p>  From the very beginning, our development was built as follows: </p><br><ul><li> There is a <code>master</code> branch on GitHub, for which continuous integration is configured - full automation of deployment to a single test server, whose architecture repeats production as much as possible. </li><li>  Each new task is conducted in the developer's fork-branch, then a pool of requests to the <code>master</code> opens, which eventually goes there. </li></ul><br><p>  It should be said that the CI for the <code>master</code> branch is arranged in a quite usual way: </p><br><ol><li>  Push on githab </li><li>  TeamCity sees a new commit and makes <code>make</code> </li><li>  Automatic tests run </li><li>  Docker containers are going to </li><li>  Ansible Deploit Containers </li></ol><br><p>  I wanted to keep this sequence and tools in order not to change a lot. </p><br><p>  The obvious disadvantage of one dev'a is that it can only watch one branch at a time, the unfinished tasks interfere with each other and you have to resolve permanent conflicts.  Our goal was the following: as soon as a new branch is created on GitHub, a separate dev is created for it. </p><br><p>  At first glance, the task is not difficult - we look in the API of our cloud platform and before the first commit in the new branch starts its path, we create a separate server for this branch - everything is simple, there is already a development on a single machine, thanks to Ansible! </p><br><p>  But there is one significant problem: our database.  Its full sweep from a compressed dump (you must also download it) on a modest machine takes about two hours.  You can of course deploy it all to more productive machines or just wait, but you would have to suffer from the cloud API (even if you would have to rewrite everything when moving to another) and did not want to pay an extra penny for each new car.  So, for our solution, one medium machine is used. </p><br><p>  <strong>TeamCity</strong> </p><br><p>  This is a great tool that almost doesn‚Äôt need to be customized.  The only thing that is required of him is to tell the scripts which branch he works with. <br>  So change the only <code>Build Step: command line</code> of </p><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> clusters/dev make</code> </pre> <br><p>  turned into </p><br><pre> <code class="hljs dos">export branch_name=<span class="hljs-variable"><span class="hljs-variable">%teamcity.build.branch%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> clusters/dev make</code> </pre> <br><p>  <strong>Docker</strong> </p><br><p>  With one virgin, each part of the infrastructure, whether part of an application, Sphinx, Redis, Nginx, or PostgreSQL was launched inside a separate container.  Which were started with the indication - <code>--network-mode=host</code> , that is, each <code>ip:port</code> container coincided with <code>localhost:port</code> host machine. </p><br><p>  As you understand, for several devs this is not a ride, firstly the containers should communicate only with the containers of one branch, secondly, <code>nginx</code> should know the internal IP of each container he needs. </p><br><p>  This is <code>Docker network</code> comes to the rescue and the launch of containers turns from </p><br><pre> <code class="hljs pgsql">docker run /<span class="hljs-type"><span class="hljs-type">path</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>/Dockerfile</code> </pre> <br><p>  at </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> network create <span class="hljs-variable"><span class="hljs-variable">${branch_name}</span></span> --opt com.docker.network.bridge.name=<span class="hljs-variable"><span class="hljs-variable">${branch_name}</span></span> docker run --network=<span class="hljs-variable"><span class="hljs-variable">${branch_name}</span></span> -e branch_name=<span class="hljs-variable"><span class="hljs-variable">${branch_name}</span></span> /path/to/Dockerfile</code> </pre> <br><p>  This gives us: </p><br><ul><li>  the name of the docker network matches the name of the branch </li><li>  the name of the network interface is the same as the name of the branch </li><li>  containers of each branch are in the same docker network, which allows them to communicate by their names (the docker creates DNS records within each <code>bridge</code> its network) </li><li>  inside the containers, an environment variable is created with the name of the branch needed to generate various configs </li></ul><br><p>  <strong>PostgreSQL</strong> </p><br><p>  We run it in the container with <code>--network=host</code> , as before, so that the DBMS is one, but for each branch there is its own user and its own database. </p><br><p>  The task of quickly deploying a new database is perfectly solved with templates: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> db_name <span class="hljs-keyword"><span class="hljs-keyword">TEMPLATE</span></span> template_name</code> </pre> <br><p>  Plus, every day I would like to have a fresh copy of the database with the sales, so that when creating a branch, build on it (also flows in a separate container with <code>--network=host</code> ) </p><br><p>  To do this, create two databases.  Every night we spend two hours unrolling a fresh dump into one: </p><br><pre> <code class="hljs pgsql">pg_restore -v -Fc -c -d template_new dump_today.dump</code> </pre> <br><p>  and if successful: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> template_today; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> template_today <span class="hljs-keyword"><span class="hljs-keyword">TEMPLATE</span></span> template_new;</code> </pre> <br><p>  As a result, we have a fresh pattern every morning, which will remain even if the next dump comes broken and turns around unsuccessfully. </p><br><p>  When creating a new branch, create a database from a template </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> db_${branch_name}; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> db_${branch_name} OWNER db_${branch_name} <span class="hljs-keyword"><span class="hljs-keyword">TEMPLATE</span></span> template_today;</code> </pre> <br><p>  Thus, creating a separate base for a branch takes 20 minutes, not 2 hours, and the connection to it from within the docker containers is done via the <code>eth0</code> interface, which always points to the host‚Äôs IP address. </p><br><p>  <strong>nginx</strong> </p><br><p>  We will also install it on the host machine, and we will collect the configuration using <code>docker inspect</code> - this command gives complete information about the containers, from which we need one thing: the IP address, which we substitute into the configuration template. </p><br><p>  And due to the fact that the name of the network interface coincides with the name of the branch, it can generate configs for all devs in one single script: </p><br><pre> <code class="hljs bash"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> network <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(ip -o -4 as | awk <span class="hljs-string"><span class="hljs-string">'{ print $2 }'</span></span> | cut -d/ -f1); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${network}</span></span></span><span class="hljs-string">"</span></span> == <span class="hljs-string"><span class="hljs-string">"eth0"</span></span> ] || [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${network}</span></span></span><span class="hljs-string">"</span></span> == <span class="hljs-string"><span class="hljs-string">"lo"</span></span> ] || [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${network}</span></span></span><span class="hljs-string">"</span></span> == <span class="hljs-string"><span class="hljs-string">"docker0"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> IP=$(docker inspect -f <span class="hljs-string"><span class="hljs-string">"{{.NetworkSettings.Networks.</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${network}</span></span></span><span class="hljs-string">.IPAddress}}"</span></span> <span class="hljs-variable"><span class="hljs-variable">${container_name}</span></span>) sed -i <span class="hljs-string"><span class="hljs-string">"s/{{ ip }}/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${IP}</span></span></span><span class="hljs-string">/g"</span></span> <span class="hljs-variable"><span class="hljs-variable">${nginx_conf_path}</span></span> sed -i <span class="hljs-string"><span class="hljs-string">"s/{{ branch_name }}/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${network}</span></span></span><span class="hljs-string">.site.url/g"</span></span> <span class="hljs-variable"><span class="hljs-variable">${nginx_conf_path}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><p>  <strong>Deleting branches</strong> </p><br><p>  Because of the short life of each branch, except <code>master</code> , there is a need to periodically delete everything that relates to a branch - the nginx config, containers, base. </p><br><p>  Unfortunately, I could not find how to get TeamCity to tell that the branch was deleted, so I had to be clever. </p><br><p>  When a regular branch is added, a file with its name is created on the machine: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">touch</span></span> /branches/<span class="hljs-variable"><span class="hljs-variable">${branch_name}</span></span></code> </pre> <br><p>  This allows you to memorize not only all the branches that we have, but also their last modification time (it coincides with the file modification time).  It is very useful to delete a branch not immediately, but a week after it stops being used.  It looks something like this: </p><br><pre> <code class="hljs mel">#!/usr/bin/<span class="hljs-keyword"><span class="hljs-keyword">env</span></span> bash MAX_BRANCH_AGE=<span class="hljs-number"><span class="hljs-number">7</span></span> branches_to_delete=() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> branch <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(find /branches -maxdepth <span class="hljs-number"><span class="hljs-number">1</span></span> -mtime +${MAX_BRANCH_AGE}); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> branch=$(<span class="hljs-keyword"><span class="hljs-keyword">basename</span></span> ${branch}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ ${branch} == <span class="hljs-string"><span class="hljs-string">"master"</span></span> ]; then <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> fi branches_to_delete+=(${branch}) done dbs=() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> db <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(docker <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> -it postgresql gosu postgres psql -c <span class="hljs-string"><span class="hljs-string">"select datname from pg_database"</span></span> | \ grep db_ | \ cut -d<span class="hljs-string"><span class="hljs-string">'_'</span></span> -f <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> dbs+=(${db}) done <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> branch <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ${branches_to_delete[@]}; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> db <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ${dbs[@]}; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ ${branch} != ${db} ]; then <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> fi # branch <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> rm /branches/${branch} # nginx rm /etc/nginx/sites-enabled/${branch} # containers docker rm -f $(docker ps -a | grep ${branch}- | awk <span class="hljs-string"><span class="hljs-string">'{ print $1 }'</span></span>) # db docker <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> -i postgresql gosu postgres psql &lt;&lt;-EOSQL DROP USER db_${branch}; DROP DATABASE db_${branch}; EOSQL done done service nginx reload</code> </pre> <br><p>  <strong>Several pitfalls</strong> </p><br><p>  As soon as everything worked and was locked up in the <code>master</code> - he was not going to.  It turns out that the word <code>master</code> key for the <code>iproute2</code> utility, so that <code>ifconfig</code> began to be used together to determine the IP containers. </p><br><p>  It was: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ip</span></span> -o -<span class="hljs-number"><span class="hljs-number">4</span></span> as <span class="hljs-variable"><span class="hljs-variable">${branch_name}</span></span> | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$2</span></span></span><span class="hljs-string"> }'</span></span> | cut -d/ -f1</code> </pre> <br><p>  has become: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ifconfig</span></span> <span class="hljs-variable"><span class="hljs-variable">${branch_name}</span></span> | grep <span class="hljs-string"><span class="hljs-string">'inet addr:'</span></span> | cut -d: -f2 | awk <span class="hljs-string"><span class="hljs-string">'{ print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">}'</span></span></code> </pre> <br><p>  As soon as the <code>thq-1308</code> branch was created (by the task number from <code>Jira</code> ), it did not assemble.  And all because of the dash.  It interferes in several places: PostgreSQL and the Docker Inspect output template. <br>  As a result, we find out the host IP: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> inspect -f <span class="hljs-string"><span class="hljs-string">"{{.NetworkSettings.IPAddress}}"</span></span> <span class="hljs-variable"><span class="hljs-variable">${network}</span></span>-theq</code> </pre> <br><p>  Change the owners of all tables in the new database: </p><br><pre> <code class="hljs bash">tables=`gosu postgres psql -h <span class="hljs-variable"><span class="hljs-variable">${DB_HOST}</span></span> -qAt -c <span class="hljs-string"><span class="hljs-string">"SELECT tablename FROM pg_tables WHERE schemaname = 'public';"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DB_NAME}</span></span></span><span class="hljs-string">"</span></span>` <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> tbl <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$tables</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> gosu postgres psql -h <span class="hljs-variable"><span class="hljs-variable">${DB_HOST}</span></span> -d <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DB_NAME}</span></span></span><span class="hljs-string">"</span></span> &lt;&lt;-EOSQL ALTER TABLE <span class="hljs-variable"><span class="hljs-variable">$tbl</span></span> OWNER TO <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DB_USER}</span></span></span><span class="hljs-string">"</span></span>; EOSQL <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><p>  In general, that's all.  I didn‚Äôt give complete commands, scripts (except perhaps the last one), ansible roles - there is nothing special there, but I hope I didn‚Äôt miss the point.  Ready to answer all questions in the comments. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/324142/">https://habr.com/ru/post/324142/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324130/index.html">Criminal Code of the developer</a></li>
<li><a href="../324132/index.html">What to do if you are locked in rbash</a></li>
<li><a href="../324136/index.html">Splunk. Introduction to machine data analysis - part 1. Examples of SPL queries and log visualization</a></li>
<li><a href="../324138/index.html">Sending files to the Xamarin.Forms application. Part 1</a></li>
<li><a href="../324140/index.html">How to find vulnerabilities and protect your WordPress site</a></li>
<li><a href="../324144/index.html">Java memory leak diagnostics</a></li>
<li><a href="../324146/index.html">Top 3 NPS Survey Services (Consumer Loyalty Index)</a></li>
<li><a href="../324148/index.html">What is a ‚Äúmaster data management system‚Äù and why is it needed?</a></li>
<li><a href="../324150/index.html">How to increase production efficiency with augmented reality?</a></li>
<li><a href="../324152/index.html">Practical application of Fourier transform for signal processing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>