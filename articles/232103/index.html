<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Node.js + HTML5 + js = online action game. Play on Node.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It has long been wondered, why writing online games for node.js is so rare, especially in Habr√©? 
 After all, what praises sang a noda when it appeare...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Node.js + HTML5 + js = online action game. Play on Node.js</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/ad2/b1e/8c9/ad2b1e8c9d044326a9f298c6fbaf9d61.png"><br><br>  It has long been wondered, why writing online games for node.js is so rare, especially in Habr√©? <br>  After all, what praises sang a noda when it appeared, and how many predicted the good (or bad) this platform, and something new is not much added. <br><br>  I decided to check whether such an approach to the game is doomed to failure, and why.  I have to say right away, the results have encouraged me! <br>  Under the cut the details and problems that I encountered during the development process. <br><a name="habracut"></a><br><h4>  Brief background </h4><br>  As a 4th year student of cybernetics, I received from a programming teacher a proposal to participate in a competition held by STEP and several other companies in combination.  The contest <a href="http://www.goldenbyte.org/">‚ÄúGolden Byte‚Äù</a> has been held not for the first year and I thought that this is a great opportunity to try myself in the field of game development.  Having experience of 1.5 years in a web studio as a developer (php, js, html, well, everything is as usual), I decided not to hesitate for a long time and applied for the nomination " <a href="http://goldenbyte.org/ru/nomination/first.htm">Game design</a> ".  Fortunately, my friend and I (an amateur artist) had some ideas (thoughts) about the concept of a browser game. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Go! </h4><br>  The essence of the game in brief. <br><br>  Browser time killer.  Two teams of plastic soldiers run around the computer desk and destroy each other, fighting for possession of the table.  The team wins by typing a certain number of kills.  Control: WASD + mouse. <br><br>  A design document was drafted in a couple of days, sent and approved by the jury of the competition.  At this point, I have already defined the platform on which the server part will be based, the client, in general, the basic architecture.  The decision was made in favor of Node.js (server), js + html5 (client).  Data about the map, items, available units are stored in xml format and lie on the server. <br><br>  Sketches of units were drawn while I sawed the code. <br><br><img src="https://habrastorage.org/files/7de/292/01e/7de29201ecf6435bb7ca2724904662af.png"><img src="https://habrastorage.org/files/40d/885/a4e/40d885a4efd64905a314b44c2ee5c21f.png"><br><br>  Features and background to the game here lay out, I think it is not appropriate. <br><br><h4>  Logics </h4><br>  So, I faced several implementation problems, and since I still had no business with the node, I had to adjust to the situation. <br><br>  As a client-server communication method, I chose Web sockets, connected socket.io, a couple of shamans and dances, and voila, there is a connection.  The first sketches a la movement and synchronization were carried out with clumsily drawn pictures in a picture (for clarity). <br><br><img src="https://habrastorage.org/files/789/2c6/2eb/7892c62ebf4c43c1af720be2cd24c839.png"><br><br>  Data fly in json format. <br><br>  The process of what is happening in the background was approximately as follows. <br><br><ol><li>  The user enters the site, receives primary data on the map, all the necessary service information, first packet. </li><li>  The user sees the main screen.  - Download the necessary images (preload). </li><li>  The user anonymously connects socket.io with the server, registers it in session. </li><li>  The user chooses which side he will play for - a request is sent, a mark about the side is put. </li><li>  The user chooses which character he will play for - a request is sent, a mark about the character is put. </li><li>  The player is placed on the respawn point, based on the map settings. </li><li>  The process of data exchange with the server begins, and the game itself (below is the algorithm). </li></ol><br><br>  The action synchronization algorithm was thought up as follows: <br><br><ul><li>  The server has an interval of 50 ms, which sends the necessary info to the connected users, the location and actions of the players. (A list of player objects is sent). </li><li>  Users have a catch-event for messages and when they catch it, check which package came in, main / first / system, etc. </li><li>  In response, a packet is flying from the user with the current user action.  Only keystrokes fly, all calculations take place on the server (is it possible to go there, where you find yourself, etc., etc.). </li></ul><br><br>  And so in a circle. <br><br><h4>  Drawing </h4><br>  As a field for drawing, I used canvas.  After a brief viewing of popular libraries, I thought that I still do it more for myself, and not for the competition.  But it's much nicer to write my bike, especially in a new area for me, so it was decided to write my own small rendering engine. <br><br>  Well, as it should be, setInterval, requestAnimationFrame, and all the knowledge that remained on geometry and elementary algebra went to the course. <br>  After rendering the background, the active area of ‚Äã‚Äãthe screen was selected, which is visible to the user, minus the difference in the area of ‚Äã‚Äãthe object being drawn.  At this perimeter, the core is rendered.  On the server, everything is regularly sorted according to the distance from the screen (in height) so that the picture of the soldier standing on does not overlap the soldier standing closer to the screen. <br><br>  By this time, I already had a ready-made set of sprites for drawing a unit.  I added a method to render the animation of sprites to the engine, as a result I got the following: <br><br><img src="https://habrastorage.org/files/39e/ab5/a16/39eab5a1688647878c59404e33971ee8.png"><br><br>  So, at the moment I was ready: <br><br><ul><li>  Drawing units with animation </li><li>  Drawing objects </li><li>  Uneven Table Borders (inability to pass for them) </li><li>  Moving around the map </li></ul><br><br>  Unit sprites were rendered in 3Dmax and glued together.  It looked like this (clickable): <br> <a href=""><img src="https://habrastorage.org/files/a4d/e2e/2b7/a4de2e2b7ffb4bff85272fce352fd64f.png"></a> <br><br><h4>  And, of course, boevka </h4><br>  The combat unit is implemented quite simply.  When you click the left mouse button on the field, the character turns in that direction and hits.  The right mouse button is a block to the side in the direction of the mouse.  A character has certain characteristics that determine his speed / vitality / fatigue / range_ impact / dmg, etc. <br><br>  And again, all calculations occur on the server, the player receives only the result of his keystrokes. <br><br><h4>  Some service information / statistics </h4><br>  VPS server for 5 euros per month: <br>  CPU 1200 Mhz, 256MB RAM, Debian OS. <br><br>  Map 3000 to 3000 (one-dimensional array, followed by conversion).  When the server starts, it initializes, takes 900 ms.  When was a two-dimensional array, took 6500 ms. <br><br>  5MB client channel.  40 connections (20 to 20).  Data exchange was ensured and a constant FPS was maintained without sags 30-60. <br><br><img src="https://habrastorage.org/files/0d5/5cd/ead/0d55cdead53b486f9ea686540edc9497.png"><br><br><h4>  Some more pictures: </h4><br>  Main screen: <br><br><img src="https://habrastorage.org/files/393/d9c/d63/393d9cd630f1435b9405adf7c420a6cc.png"><br><br>  Scroll the mouse wheel: <br><br><img src="https://habrastorage.org/files/02d/920/0ea/02d9200eabfd4af6819006717a435bfd.png"><br><br>  Blue team win: <br><br><img src="https://habrastorage.org/files/a35/043/0de/a350430de4de43258c5f5c8ae7140580.png"><br><br>  Cross-browser compatibility is provided for Chrome, Mozilla, Opera, Explorer 10+.  In general, everything that supports canvas and Websockets. <br><br>  There was also an adapted version for those who came from the phone (the interface is not finished, but it works). <br><br><img src="https://habrastorage.org/files/f59/3e0/36e/f593e036e69040ef8d7289b107e506f2.png"><br><br><h4>  Total </h4><br>  All the work took about one and a half months of work after study and work. <br>  I will not give a link to the game, the poor server will not sustain the habraeffect, and I'm not ready yet for load testing. <br>  At a competition in my city, my friend and I took 2nd place, which in principle did not upset me, but only spurred.  I made the game more for myself, but in the future, maybe we will redo the graphics, and it will be possible to share it, but it is still too early to talk about it. <br><br>  For those who want to see my clumsy code, here is the git repository.  Just do not spit, now I see how ugly everything is, although I did it only half a year ago: <a href="https://github.com/amikstrike/wn">https://github.com/amikstrike/wn</a> <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/232103/">https://habr.com/ru/post/232103/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../232091/index.html">Intel Pro 2500 - new SSD series with hardware encryption</a></li>
<li><a href="../232093/index.html">NASA confirms the performance of the "impossible" wave engine that does not use reactive mass - EmDrive</a></li>
<li><a href="../232095/index.html">ERPXE like a magic pill</a></li>
<li><a href="../232097/index.html">Writing a simple interpreter in C ++ using TDD, part 3</a></li>
<li><a href="../232099/index.html">Clean and dirty test environments</a></li>
<li><a href="../232107/index.html">Motivation in a person‚Äôs life, or my little experience (introduction)</a></li>
<li><a href="../232109/index.html">The Rosetta interplanetary station measured the surface temperature of the comet Churyumov-Gerasimenko</a></li>
<li><a href="../232111/index.html">XBMC Media Player Renamed to Kodi</a></li>
<li><a href="../232113/index.html">Switching layouts with CapsLock on Ubuntu 14.04</a></li>
<li><a href="../232117/index.html">10 most popular video reports from 404fest 2013</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>