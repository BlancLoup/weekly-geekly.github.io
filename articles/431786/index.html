<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The story of what not to do during development</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prologue: To begin with, I will tell you about the project, so that there are ideas about how we worked on the project and to recreate the pain we fel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The story of what not to do during development</h1><div class="post__text post__text-html js-mediator-article">  <b>Prologue:</b> To begin with, I will tell you about the project, so that there are ideas about how we worked on the project and to recreate the pain we felt. <br><br>  I, as a developer, joined the project in 2015-2016, I don‚Äôt remember exactly, but he worked 2-3 years earlier.  The project was very popular in its field, namely game servers.  How strange it did not sound, but projects on game servers are being carried out to this day, I recently saw vacancies and worked a bit in one team.  Since the game servers are built on an already created game, therefore, the script language that is built into the game engine is used for development. <br><br>  We are developing a project from Garry's Mod (Gmod) almost from scratch, it is important to note that at the time of this writing, Harry is already creating a new S &amp; Box project on the Unreal Engine.  We still sit on the Source. <br><blockquote>  Which is generally not suitable for our server theme. </blockquote><img src="https://habrastorage.org/getpro/habr/post_images/a7c/086/fef/a7c086fef0487def7d3bd7b5b50f9b8d.jpg" alt="image"><br><a name="habracut"></a><br>  ‚ÄúWhat is your story scary?‚Äù - you ask. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We have a strong theme of the game server, namely ‚ÄúStalker‚Äù and even with elements of role-playing games (RP), the question immediately arises - ‚ÄúAnd how to implement it all on one server?‚Äù. <br><br>  Given that the Source engine is old (the 2013 version is used in Gmod also 32 bit), you can‚Äôt make big maps, small restrictions on the number of Entity, Mesh and many other things. <br><blockquote>  Who worked on the engine, will understand. </blockquote>  It turns out, the task is generally impossible, to make a pure multiplayer stalker with quests, RPG-elements from the original and preferably a small story. <br><br>  First of all, the initial writing was difficult (many actions from the category: throwing out the subject, picking up the subject were written from scratch), hoping that it would be easier further, but the requirements grew.  The mechanics of the game was ready, it remained to make the intellect, the agrade, and all sorts of things.  In general, all endured as they could. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c41/7d4/fbf/c417d4fbf4cc7ac27df898fafa43e228.png" alt="image"><br><br>  The problems began already during the operation of the first version of the release, namely (lags, server delays). <br><br>  It seems a powerful server could easily handle requests and keep the whole Gamemode. <br><br><div class="spoiler">  <b class="spoiler_title">Simple gamemode description</b> <div class="spoiler_text">  This is the name of a complex of scripts written to describe the mechanics of the server itself. <br>  For example: we want the themes of the now popular "Royal Battles", which means that the name should also correspond to the mechanics of the game too.  ‚ÄúSpawning players on the plane, you can pick up things, players can communicate, you can‚Äôt wear more than 1 helmet, etc.‚Äù - all this is described by the game mechanics on the server. <br></div></div><br>  Lags were both on the server side due to the large number of players, since one player eats up a lot of RAM about 80-120 mb (not counting more items in the inventory, skills, etc.), and on the client side there was a strong decrease fps <br><br>  CPU power was not enough for processing physics, it was necessary to use objects with physical properties less. <br><br>  So even in addition were our samopisny scripts that were not optimized at all. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ca9/5c2/4f2/ca95c24f21b7f1011fb654065eb2b8ef.png" alt="image"><br><br>  First of all, we of course read the article on optimization in Lua.  It even reached the point where they wanted to write a DLL in C ++, but the problem arose in downloading the DLL from the server by the clients.  Using C ++ for a DLL, you can write a program that quietly intercepts the data, the Gmod developers added an extension to the exceptions for clients to download (security, although in fact it never was).  Although it would be convenient and Gmod would become more flexible, but more dangerous. <br><br>  Then we looked at the profiler (since smart people wrote it) and there was horror in the functions, it was noted that initially there were very slow functions in the Gmod library. <br><br>  If you tried to write in Gmod, then you know perfectly well that there is a library built-in called math. <br><br>  And the slowest functions in it are of course math.Clamp and math.Round. <br><br>  Having rummaged in the code of people, it was noticed that the functions were thrown in different directions, almost everywhere it is used, but incorrectly! <br><br>  <u>Let's get to practice.</u>  For example, we want to round off the coordinates of the position vector to move the entity (for example, the player). <br><br><pre><code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> x = <span class="hljs-number"><span class="hljs-number">12.5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> y = <span class="hljs-number"><span class="hljs-number">14.9122133</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> z = <span class="hljs-number"><span class="hljs-number">12.111</span></span> LocalPlayer():SetPos( Vector( Math.Round(x), Math.Round(y), Math.Round(z) )</code> </pre> <br>  3 complex rounding functions, but nothing serious, unless of course in the cycle and not often used, but Clamp is even harder. <br><br>  The following code is often used in projects and no one wants to change anything. <br><br><pre> <code class="lua hljs">self:setLocalVar(<span class="hljs-string"><span class="hljs-string">"hunger"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.Clamp(current + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>))</code> </pre><br>  For example, self points to the player's object and it has a local variable we‚Äôve invented that when reset to the server is reset to zero, math.Clamp is essentially like a loop, makes a smooth assignment, like a smooth interface to do on Clamp. <br><br>  Problems arise when it works on every player who enters the server.  It is rarely the case, but if 5-15 enter the server at once (depending on server configuration) at one point in time and this small and simple function starts working for everyone, then there will be good CPU delays on the server.  Still worse if math.Clamp in a loop. <br><br>  Optimization is actually very simple; you localize heavily loading functions.  It seems primitive, but in 3 gamemode and many add-ons I saw this slow code. <br><br>  If you need to get the value and use it in the future, do not get it again if it does not change.  After all, a player entering the server in any case will get a hunger equal to 100, so this code is several times faster. <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> value = <span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.Clamp(current + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) self:setLocalVar(<span class="hljs-string"><span class="hljs-string">"hunger"</span></span>, value)</code> </pre><br>  All is well, they began to look further, that yes how it works.  As a result, we started to optimize everything. <br><br>  We noticed that the standard for cycle was slow and we decided to invent our own bike which would be faster (we didn‚Äôt forget about blackjack) and the game began. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/989/1a7/d62/9891a7d62cc782069db99995886f381e.jpg" alt="image"><br><br><div class="spoiler">  <b class="spoiler_title">SPOILER</b> <div class="spoiler_text">  We even managed to make the fastest loop on Lua Gmod, but on condition that there should be more than 100 elements. <br></div></div><br>  Judging by the time spent on our cycle and its use in the code, we tried in vain to do this because it found application only in the spawn on the anomaly map after ejecting and cleaning them. <br>  <u>And so to the code.</u>  For example, you need to find all the entities with the name at the beginning of the anom, this is the name of the class we have anomalies. <br><br>  Here is for the normal Lua Gmod scripter: <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> anomtable = ents.FindByClass(<span class="hljs-string"><span class="hljs-string">"anom_*"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k, v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">pairs</span></span>(anomtable) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> v:Remove() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Here is for the smoker: <br><br>  It is immediately obvious that such a <s>g *</s> code will be slower than the standard ‚Äúfor in pairs‚Äù, but as it turned out not. <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> b, key = ents.FindByClass(<span class="hljs-string"><span class="hljs-string">"anom_*"</span></span>), <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span> key = <span class="hljs-built_in"><span class="hljs-built_in">next</span></span>(b, key) b[key]:Remove() <span class="hljs-keyword"><span class="hljs-keyword">until</span></span> key != <span class="hljs-literal"><span class="hljs-literal">nil</span></span></code> </pre><br><br>  For a complete analysis of these loop options, they need to be translated into a regular Lua script. <br>  For example, anomtable will have 5 elements. <br>  Removal is replaced by the usual addition.  The main thing to see is the difference in the number of instructions between the two options for the implementation of a for loop. <br><br>  Vanilla cycle: <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> anomtable = { <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k, v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">pairs</span></span>(anomtable) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> v = v + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Our great: <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> b, key = { <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span> }, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span> key = <span class="hljs-built_in"><span class="hljs-built_in">next</span></span>(b, key) b[key] = b[key] + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">until</span></span> key ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span></code> </pre><br>  Let's take a look at the interpreter code ( <b>like an assembler, it is not recommended to look under the spoiler as a high-level programmer</b> ). <br><br>  <u>Just in case, remove the june from the screens.</u>  <u>I warned.</u> <br><br><div class="spoiler">  <b class="spoiler_title">Vanilla cycle disassembler</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">; Name: for1.lua ; Defined at line: 0 ; #Upvalues: 0 ; #Parameters: 0 ; Is_vararg: 2 ; Max Stack Size: 7 1 [-]: NEWTABLE R0 5 0 ; R0 := {} 2 [-]: LOADK R1 K0 ; R1 := 1 3 [-]: LOADK R2 K1 ; R2 := 2 4 [-]: LOADK R3 K2 ; R3 := 3 5 [-]: LOADK R4 K3 ; R4 := 4 6 [-]: LOADK R5 K4 ; R5 := 5 7 [-]: SETLIST R0 5 1 ; R0[(1-1)*FPF+i] := R(0+i), 1 &lt;= i &lt;= 5 8 [-]: GETGLOBAL R1 K5 ; R1 := pairs 9 [-]: MOVE R2 R0 ; R2 := R0 10 [-]: CALL R1 2 4 ; R1,R2,R3 := R1(R2) 11 [-]: JMP 13 ; PC := 13 12 [-]: ADD R5 R5 K0 ; R5 := R5 + 1 13 [-]: TFORLOOP R1 2 ; R4,R5 := R1(R2,R3); if R4 ~= nil then begin PC = 12; R3 := R4 end 14 [-]: JMP 12 ; PC := 12 15 [-]: RETURN R0 1 ; return</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Disassembler cycle cycle</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">; Name: for2.lua ; Defined at line: 0 ; #Upvalues: 0 ; #Parameters: 0 ; Is_vararg: 2 ; Max Stack Size: 6 1 [-]: NEWTABLE R0 5 0 ; R0 := {} 2 [-]: LOADK R1 K0 ; R1 := 1 3 [-]: LOADK R2 K1 ; R2 := 2 4 [-]: LOADK R3 K2 ; R3 := 3 5 [-]: LOADK R4 K3 ; R4 := 4 6 [-]: LOADK R5 K4 ; R5 := 5 7 [-]: SETLIST R0 5 1 ; R0[(1-1)*FPF+i] := R(0+i), 1 &lt;= i &lt;= 5 8 [-]: LOADNIL R1 R1 ; R1 := nil 9 [-]: GETGLOBAL R2 K5 ; R2 := next 10 [-]: MOVE R3 R0 ; R3 := R0 11 [-]: MOVE R4 R1 ; R4 := R1 12 [-]: CALL R2 3 2 ; R2 := R2(R3,R4) 13 [-]: MOVE R1 R2 ; R1 := R2 14 [-]: GETTABLE R2 R0 R1 ; R2 := R0[R1] 15 [-]: ADD R2 R2 K0 ; R2 := R2 + 1 16 [-]: SETTABLE R0 R1 R2 ; R0[R1] := R2 17 [-]: EQ 1 R1 K6 ; if R1 == nil then PC := 9 18 [-]: JMP 9 ; PC := 9 19 [-]: RETURN R0 1 ; return</code> </pre> <br></div></div><br>  Inexperienced, just by glancing, the normal cycle is faster, because there are fewer instructions (15 vs 19). <br><br>  But we must not forget that every instruction in the interpreter has processor cycles. <br>  Judging by the disassembled code in the first cycle there is a forloop instruction written in advance for working with an array, the array is loaded into memory becomes global, we jump on the elements and add a constant. <br><br>  In the second variant, the method is different, which is more based on memory, it gets the table, changes the element, sets the table, checks for nil and calls it again. <br>  Our second cycle is fast due to the fact that there are too many conditions and actions in one instruction (R4, R5: = R1 (R2, R3); if R4 ~ = nil then begin PC = 12; R3: = R4 end) because of this She eats a lot <s>and</s> eats CPU cycles for execution, the last one is also more tied up with memory. <br><br>  The forloop instruction with a large number of elements is surrendered to our cycle in the speed of passage of all elements.  This is due to the fact that addressing directly to the address is faster, less than any buns from pairs.  (And we have no denial) <br><blockquote>  In general, in secret, any use of the negative in the code slows it down; it has already been tested with tests and time.  Negative logic will work more slowly since there is a separate ‚Äúinverter‚Äù computing unit in the processor ALU, you need to contact the inverter to operate the unary operand (not,!) And this will take additional time. </blockquote>  <b>Conclusion:</b> Everything standard is not always better, your bikes can be useful, but again on a real project you shouldn‚Äôt invent them if you care about release speed.  As a result, we have a complete development from 2014 to the present day, a sort of another ‚Äúwaiter‚Äù.  Although it seems like an ordinary game server which is set up in 1 day and is fully configured for the game in 2 days, but you must be able to contribute something new. <br><br>  This long-term project still saw the second version of itself where optimization is very much in the code, but I will tell you about other optimizations in the following articles.  Support criticism or comment, correct if I am mistaken. </div><p>Source: <a href="https://habr.com/ru/post/431786/">https://habr.com/ru/post/431786/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../431768/index.html">I so wanted to get into the program committee of the conference, and here I am, and what will we do?</a></li>
<li><a href="../431770/index.html">How to change your life by starting the development of the OpenSource project (continued)</a></li>
<li><a href="../431772/index.html">How to find out in two clicks the real name of the owner of the email or phone number using PayPal or a hole in privacy?</a></li>
<li><a href="../431774/index.html">In Japan, began broadcasting in 8K format</a></li>
<li><a href="../431780/index.html">Conversations with the "Higher Mind". Limits in the creation of artificial intelligence</a></li>
<li><a href="../431790/index.html">How to create a website or application, taking into account users with special needs</a></li>
<li><a href="../431792/index.html">The digest of interesting materials for the mobile developer # 277 (November 26 - December 2)</a></li>
<li><a href="../431794/index.html">Proof of the Goldbach binary hypothesis</a></li>
<li><a href="../431796/index.html">NASA signs development lunar module development contracts with private companies</a></li>
<li><a href="../431800/index.html">Ministry of Communications proposes to entrust the creation of a 5G network to a single operator</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>