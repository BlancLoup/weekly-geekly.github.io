<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Supersonic" upload photos to the Cloud using your own NSInputStream</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The fastest download of photos and videos from the device to the server was our main priority when developing the Cloud Mail.Ru mobile app for iOS . I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Supersonic" upload photos to the Cloud using your own NSInputStream</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/436/4f9/014/4364f9014fd71c5500254663fb16068f.png"><br><br>  The fastest download of photos and videos from the device to the server was our main priority when developing the <a href="https://itunes.apple.com/ru/app/oblako-mail.ru/id696551382%3Fmt%3D8">Cloud Mail.Ru</a> mobile app <a href="https://itunes.apple.com/ru/app/oblako-mail.ru/id696551382%3Fmt%3D8">for iOS</a> .  In addition, since the very first version of the application, we have provided users with the ability to enable automatic uploading of the entire contents of the system gallery to the server.  This is very convenient for those who are worried about the possible loss of the phone, however, as you understand, it increases the amount of transmitted data at times. <br><br>  So, we set ourselves the task of making the download of photos and videos from the Mail.Ru Clouds mobile application not just good, but close to perfect.  The result was our library <a href="https://github.com/pavelosipov/POSInputStreamLibrary">POSInputStreamLibrary</a> , which implements streaming download to the network photos and videos from the system gallery iOS.  Thanks to its tight integration with the ALAssetLibrary and CFNetwork frameworks, the load in the application is very fast and does not require a single byte of free space on the device.  I will <a href="https://developer.apple.com/library/ios/documentation/cocoa/reference/foundation/classes/nsinputstream_class/reference/reference.html">discuss the</a> implementation of the native inheritor of the <a href="https://developer.apple.com/library/ios/documentation/cocoa/reference/foundation/classes/nsinputstream_class/reference/reference.html">NSInputStream</a> class from the iOS Developer Library in this post. <br><a name="habracut"></a><br><img src="https://habrastorage.org/getpro/habr/post_images/3ae/539/ce7/3ae539ce71214bf574fcfd42cce53024.jpg" align="right">  During the service for the benefit of Mail.Ru Cloud, the <a href="https://github.com/pavelosipov/POSInputStreamLibrary">POSBlobInputStream</a> stream <a href="https://github.com/pavelosipov/POSInputStreamLibrary">has</a> acquired a very rich functionality: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li> initialization of the stream URL <code>ALAsset</code> </li><li>  support synchronous and asynchronous modes </li><li>  automatic reinitialization after the <code>ALAsset</code> object </li><li>  caching data reading from <code>ALAsset</code> </li><li>  the ability to specify the offset from which reading will begin </li><li>  ability to integrate with arbitrary data source </li></ul><br>  The meaning of each of these possibilities is explained in a separate paragraph.  Before reviewing them, it remains only to say that the source code of the library is available <a href="https://github.com/pavelosipov/POSInputStreamLibrary">here</a> , as well as in the <a href="https://github.com/CocoaPods/Specs/tree/master/POSInputStreamLibrary">main</a> <a href="http://cocoapods.org/">CocoaPods</a> <a href="https://github.com/CocoaPods/Specs/tree/master/POSInputStreamLibrary">repository</a> . <br><br><h2>  Initializing the stream URL ALAsset </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/396/92d/815/39692d8159ef6ad0d54fd68d3c1703d5.jpg" align="right">  Until all the functionality of the application was limited to downloading photos, everything was simple.  The image from the gallery was saved to a temporary file, on the basis of which the standard file stream was created.  The latter was fed to the input of <code>NSURLRequest</code> for streaming into the network. <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSInputStream</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSInputStreamExtensions</span></span></span><span class="hljs-class">) // ... + (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inputStreamWithFileAtPath</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">path</span></span></span><span class="hljs-class">; // ... @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSMutableURLRequest</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSMutableHTTPURLRequest</span></span></span><span class="hljs-class">) // ... - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">setHTTPBodyStream</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSInputStream</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inputStream</span></span></span><span class="hljs-class">; // ... @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Clickable: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/8a0/9bc/f7f/8a09bcf7f2d6b8dad70f085ba71331aa.png"></a> <br><br>  The requirement to support video downloads made this approach unusable.  The huge size of the clips caused the following problems: <br><br><ul><li>  download required a large amount of free space on the device </li><li>  the time of saving the video to a temporary file could reach 10 or more minutes </li></ul><br>  To overcome these inconveniences, the <code>POSBlobInputStream</code> class was developed.  It is initialized by the URL of the gallery object and reads the data directly without creating temporary files. <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSInputStream</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">POS</span></span></span><span class="hljs-class">) + (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSInputStream</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pos_inputStreamWithAssetURL</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSURL</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assetURL</span></span></span><span class="hljs-class">; + (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSInputStream</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pos_inputStreamWithAssetURL</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSURL</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assetURL</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">asynchronous</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BOOL</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">asynchronous</span></span></span><span class="hljs-class">; + (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSInputStream</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pos_inputStreamForCFNetworkWithAssetURL</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSURL</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assetURL</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Clickable: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/6d0/f4f/a05/6d0f4fa057a2a02b77df3cb1e16f9536.png"></a> <br><br>  At first, I had a feeling that the implementation of POSBlobInputStream would take the least amount of time, since the interface of its base class is trivial. <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSInputStream</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSStream</span></span></span><span class="hljs-class"> - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSInteger</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">read</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">buffer</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">maxLength</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSUInteger</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">len</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BOOL</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">getBuffer</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> **)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">buffer</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSUInteger</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">len</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BOOL</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hasBytesAvailable</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Moreover, according to the <a href="https://developer.apple.com/library/ios/documentation/cocoa/reference/foundation/classes/nsinputstream_class/reference/reference.html">documentation</a> , <code>getBuffer:length:</code> is not necessary to support, so it would seem that only 2 methods need to be implemented.  Their mapping to the <code>ALAssetRepresentation</code> interface also did not cause <code>ALAssetRepresentation</code> issues. <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ALAssetRepresentation</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> // ... - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">long</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">long</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSUInteger</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">getBytes</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">buffer</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fromOffset</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">long</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">long</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">offset</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSUInteger</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSError</span></span></span><span class="hljs-class"> **)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">; // ... @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  However, after lowering the new <code>POSBlobInputStream</code> into the water, I was unpleasantly surprised.  The call of any method of the NSStream base class ended with the exception of the form: <br><pre> <code class="bash hljs">*** -propertyForKey: only defined <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> abstract class. Define -[POSBlobInputStream propertyForKey:]</code> </pre><br>  The reason is that <code>NSInputStream</code> is an abstract class, and each of its init methods creates an object from one of the <code>NSInputStream</code> classes.  In Objective-C, this pattern is called <a href="https://developer.apple.com/library/ios/documentation/general/conceptual/devpedia-cocoacore/ClassCluster.html">class cluster</a> .  Thus, the implementation of its own stream requires the implementation, including all <code>NSStream</code> methods, and there is a room full of them. <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSStream</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">open</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">close</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSStreamDelegate</span></span></span><span class="hljs-class">&gt;)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">delegate</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">setDelegate</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSStreamDelegate</span></span></span><span class="hljs-class">&gt;)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">delegate</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">propertyForKey</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">key</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BOOL</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">setProperty</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">forKey</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">key</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scheduleInRunLoop</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSRunLoop</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aRunLoop</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">forMode</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mode</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">removeFromRunLoop</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSRunLoop</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aRunLoop</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">forMode</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mode</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSStreamStatus</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">streamStatus</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSError</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">streamError</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><h2>  Synchronous and asynchronous operation modes POSBlobInputStream </h2><br>  When developing <code>POSBlobInputStream</code> most difficult was to implement a mechanism for asynchronous notification of state changes.  In <code>NSStream</code> the <code>scheduleInRunLoop:forMode:</code> <code>removeFromRunLoop:forMode:</code> and <code>setDelegate:</code> methods are responsible for it.  Thanks to them, you can create threads that at the time of opening do not have a byte of information.  <code>POSBlobInputStream</code> exploits this feature for the following purposes: <br><br><ul><li>  An implementation of the non-blocking version of the <code>open</code> method.  <code>POSBlobInputStream</code> is considered open as soon as it was able to obtain an <code>ALAssetRepresentation</code> object by its <code>NSURL</code> .  As you know, using the iOS SDK, this can only be done asynchronously.  Thus, the presence of a mechanism for asynchronous notification of a stream status change from <code>NSStreamStatusNotOpen</code> to <code>NSStreamStatusOpen</code> or <code>NSStreamStatusError</code> is very useful here. </li><li>  Informing of a read data stream by sending an <code>NSStreamEventHasBytesAvailable</code> event. </li></ul><br>  For illustrative purposes, below are implementations of the file checksum using POSBlobInputStream.  We begin by considering the synchronous version. <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSInputStream</span></span> *stream = [<span class="hljs-built_in"><span class="hljs-built_in">NSInputStream</span></span> pos_inputStreamWithAssetURL:assetURL asynchronous:<span class="hljs-literal"><span class="hljs-literal">NO</span></span>]; [stream open]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([stream streamStatus] == <span class="hljs-built_in"><span class="hljs-built_in">NSStreamStatusError</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">NSParameterAssert</span></span>([stream streamStatus] == <span class="hljs-built_in"><span class="hljs-built_in">NSStreamStatusOpen</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ([stream hasBytesAvailable]) { uint8_t buffer[kBufferSize]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> readCount = [stream read:buffer maxLength:kBufferSize]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (readCount &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (readCount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([stream streamStatus] != <span class="hljs-built_in"><span class="hljs-built_in">NSStreamStatusAtEnd</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } [stream close];</code> </pre><br>  For all its simplicity, this code has one invisible feature.  If you execute it in the main thread, then deadlock will occur.  The fact is that the open method blocks the calling thread until the iOS SDK returns <code>ALAsset</code> in the main thread.  If the <code>open</code> function itself is called in the main thread, then we get a classic deadlock.  Why a synchronous implementation of the flow was needed at all will be described below in the section ‚ÄúFeatures of Integration with NSURLRequest‚Äù. <br>  The asynchronous version of the checksum count looks a bit more complicated. <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChecksumCalculator</span></span></span><span class="hljs-class"> () &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSStreamDelegate</span></span></span><span class="hljs-class">&gt; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChecksumCalculator</span></span></span><span class="hljs-class"> - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">calculateChecksumForStream</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSInputStream</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aStream</span></span></span><span class="hljs-class"> </span></span>{ aStream.delegate = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; [aStream open]; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_async</span></span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number"><span class="hljs-number">0</span></span>), ^{ <span class="hljs-built_in"><span class="hljs-built_in">NSRunLoop</span></span> *runLoop = [<span class="hljs-built_in"><span class="hljs-built_in">NSRunLoop</span></span> currentRunLoop]; [aStream scheduleInRunLoop:runLoop forMode:<span class="hljs-built_in"><span class="hljs-built_in">NSDefaultRunLoopMode</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) { <span class="hljs-keyword"><span class="hljs-keyword">@autoreleasepool</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (![runLoop runMode:<span class="hljs-built_in"><span class="hljs-built_in">NSDefaultRunLoopMode</span></span> beforeDate:[<span class="hljs-built_in"><span class="hljs-built_in">NSDate</span></span> dateWithTimeIntervalSinceNow:kRunLoopInterval]]) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NSStreamStatus</span></span> streamStatus = [aStream streamStatus]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (streamStatus == <span class="hljs-built_in"><span class="hljs-built_in">NSStreamStatusError</span></span> || streamStatus == <span class="hljs-built_in"><span class="hljs-built_in">NSStreamStatusClosed</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }} }); } <span class="hljs-meta"><span class="hljs-meta">#pragma mark - NSStreamDelegate - (void)stream:(NSStream *)aStream handleEvent:(NSStreamEvent)eventCode { switch (eventCode) { case NSStreamEventHasBytesAvailable: { [self updateChecksumForStream:aStream]; } break; case NSStreamEventEndEncountered: { [self notifyChecksumCalculationCompleted]; [_stream close]; } break; case NSStreamEventErrorOccurred: { [self notifyErrorOccurred:[_stream streamError]]; [_stream close]; } break; } } @end</span></span></code> </pre><br>  <code>ChecksumCalculator</code> sets itself up as a <code>POSBlobInputStream</code> event <code>POSBlobInputStream</code> .  As soon as a stream has new data, or, on the contrary, ends, or an error occurs, it sends the corresponding events.  Please note that it is possible to specify in which thread to send them.  For example, in the code listing below, they will come into a workflow created by GCD. <br><br><h2>  Features of integration with ALAssetLibrary </h2><br>  When working with ALAssetLibrary, consider the following: <br><br><ul><li>  <code>ALAssetRepresentation</code> methods is very expensive.  <code>POSBlobInputStream</code> tries to minimize their number by caching the results.  For example, there is a minimum data block that will be read when the <code>read:maxLength:</code> method is called, and only after it has been exhausted will a new call occur. </li><li>  <code>ALAssetRepresentation</code> may become invalid.  So, on iOS 5.x this happens when saving a photo to the phone‚Äôs gallery.  From the point of view of client code, this looks like the return of a null value by the <code>getBytes:fromOffset:length:error:</code> method of the <code>getBytes:fromOffset:length:error:</code> object.  In this case, it is known that the data are not fully read.  In this case, <code>POSBlobInputStream</code> receives the <code>ALAssetRepresentation</code> again.  It is worth noting that when working in synchronous mode at the time of reinitialization, the calling thread is blocked, but not in the asynchronous mode. </li></ul><br><br><h2>  Features integration with NSURLRequest </h2><br>  The implementation of the network layer of the iOS SDK in general and the <code>NSURLRequest</code> in particular is based on the CFNetwork framework.  Over the long years of his life, he has amassed quite a few cabinets with skeletons.  But first things first. <br><br>  <code>NSInputStream</code> is one of the " <a href="https://developer.apple.com/library/ios/documentation/General/Conceptual/CocoaEncyclopedia/Toll-FreeBridgin/Toll-FreeBridgin.html">toll-free bridged</a> " classes of the iOS SDK.  It can be brought to <a href="https://developer.apple.com/library/ios/documentation/CoreFoundation/Reference/CFReadStreamRef/Reference/reference.html">CFReadStreamRef</a> and work with it in the future as with an object of this type.  This property underlies the implementation of <code>NSURLRequest</code> .  The latter issues <code>POSBlobInputStream</code> for its twin brother, and CFNetwork communicates with it already using the C-interface.  In theory, all C-calls to <code>CFReadStream</code> should be <code>CFReadStream</code> to calls to the corresponding <code>NSInputStream</code> methods.  However, in practice there are two serious deviations: <br><br><ol><li>  Not all calls are proxied.  For some, this procedure has to be done independently.  I will not dwell on this here, since there are good articles on this subject on the Internet: <a href="http://blog.octiplex.com/2011/06/how-to-implement-a-corefoundation-toll-free-bridged-nsinputstream-subclass/">How to implement a CoreFoundation toll-free bridget NSInputStream</a> , <a href="http://bjhomer.blogspot.ru/2011/04/subclassing-nsinputstream.html">Subclassing NSInputStream</a> . </li><li>  Proxy <a href="https://developer.apple.com/library/ios/documentation/CoreFoundation/Reference/CFReadStreamRef/Reference/reference.html">CFReadStreamGetError</a> causes the application to crash.  This exclusive knowledge was obtained by analyzing the crash-logs of the application and meditating on the <a href="">source code of CFStream</a> .  Apparently, for this reason, this function is marked outdated in the documentation, but, nevertheless, its use has not yet been eradicated from all places of CFNetwork.  So, every time <code>NSInputStream</code> informs CFNetwork about an error, the framework tries to get its description using this unfortunate function.  The result is sad. </li></ol><br>  To combat the second problem, there are not so many options.  Since it is impossible to refactor CFNetwork, it remains only not to provoke him into hostile actions.  In order for CFNetwork not to try to get a description of the error, you should under no circumstances tell it about its occurrence.  For this reason, <code>POSBlobInputStream</code> got the property <code>shouldNotifyCoreFoundationAboutStatusChange</code> .  If the flag is set, then: <br><br><ol><li>  the thread will not send notifications about changing its status via callbacks C </li><li>  The <code>streamStatus</code> method <code>streamStatus</code> never return <code>NSStreamStatusError</code> </li></ol><br>  The only way to find out about the occurrence of an error when the flag is raised is to implement the <code>NSStreamDelegate</code> protocol by some class and set it as a delegate to the stream (see the example of checksum calculation above). <br><br>  Another unpleasant discovery is that CFNetwork works with a stream in synchronous mode.  Despite the fact that the framework subscribes to notifications, it is still for some reason engaged in its poll-ing.  For example, the <code>open</code> method is called several times in a loop, and if the stream does not have time to go to the open state during this time interval, it is recognized as spoiled.  This feature of the network framework was the reason for the <code>POSBlobInputStream</code> support of synchronous operation, albeit with limitations. <br><br><h2>  Support for reading data with offset </h2><br>  The Mail.Ru Cloud iOS application can load files.  This functionality allows you to save traffic and user time in the case when part of the downloaded file is already in the repository.  To implement this requirement, <code>POSBlobInputStream</code> was trained to read the contents of a photo not from the beginning, but from a certain position.  The offset in it is set by the <code>NSStreamFileCurrentOffsetKey</code> property.  Due to the fact that it is also used to shift the beginning of the standard file stream, it is possible to specify it uniformly. <br><br><h2>  Support for arbitrary data sources </h2><br>  <code>POSBlobInputStream</code> was created to upload photos and videos from the gallery.  However, it is designed so that, if necessary, you can use other data sources.  For streaming from other sources, it is necessary to implement the <code>POSBlobInputStreamDataSource</code> protocol. <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">POSBlobInputStreamDataSource</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class">&gt; // // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Self</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">explanatory</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">KVO</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">compliant</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">properties</span></span></span><span class="hljs-class">. @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">readonly</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">getter</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">isOpenCompleted</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BOOL</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">openCompleted</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">readonly</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BOOL</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hasBytesAvailable</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">readonly</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">getter</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">isAtEnd</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BOOL</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">atEnd</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">readonly</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSError</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">; // // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">selector</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">will</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">called</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">before</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">anything</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">else</span></span></span><span class="hljs-class">. - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">open</span></span></span><span class="hljs-class">; // // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Data</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Source</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">configuring</span></span></span><span class="hljs-class">. - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">propertyForKey</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">key</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BOOL</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">setProperty</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">forKey</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">key</span></span></span><span class="hljs-class">; // // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Data</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Source</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">. // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">The</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">contracts</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">these</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">selectors</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">are</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">same</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">as</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSInputStream</span></span></span><span class="hljs-class">. - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSInteger</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">read</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">buffer</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">maxLength</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSUInteger</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">maxLength</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BOOL</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">getBuffer</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> **)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">buffer</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSUInteger</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bufferLength</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Properties are used not only to obtain the status of the data source, but also to inform the flow of its change using the KVO mechanism. <br><br><h2>  Total </h2><br>  During the work on the stream, I spent a lot of time on the network in search of any analogues.  First of all, I didn‚Äôt want to reinvent the wheel, and secondly, things are going much faster if we keep a certain pattern in front of our eyes.  Unfortunately, I could not find any good implementations.  The scourge of most analogs is the implementation of asynchronous work.  At best, as in the <a href="https://github.com/bjhomer/HSCountingInputStream">HSC countingInputStream</a> , an internal object of one of the standard flows is used for event dispatching, which is incorrect.  Often, asynchronous operation is not supported at all, as, for example, in <a href="">NTVStreamMux</a> : <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#pragma mark Undocumented but necessary NSStream Overrides (fuck you Apple) - (void) _scheduleInCFRunLoop:(NSRunLoop*) inRunLoop forMode:(id)inMode { /* FUCK YOU APPLE */ } - (void) _setCFClientFlags:(CFOptionFlags)inFlags callback:(CFReadStreamClientCallBack)inCallback context:(CFStreamClientContext)inContext { /* NO SERIOUSLY, FUCK YOU */ }</span></span></code> </pre><br>  <code>POSBlobInputStream</code> , in turn, is one of the key components of the Mail.Ru Cloud application.  During the service, he was tested in battle by an army of users.  Many rakes were collected and leveled, and at the moment the flow is one of the most stable components.  Use, write extensions, and, of course, I will be glad to any feedback. <br><br>  <i>Pavel Osipov,</i> <i><br></i>  <i>Cloud Development Team Leader for iOS</i> <br></div><p>Source: <a href="https://habr.com/ru/post/216247/">https://habr.com/ru/post/216247/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216235/index.html">The sacred cow, karma and mustache: how and why the Indians are not indifferent to IB</a></li>
<li><a href="../216237/index.html">Windows Pocket Concept</a></li>
<li><a href="../216239/index.html">As I was called paranoid and what came of it</a></li>
<li><a href="../216241/index.html">Facebook vs. Google: the battle of technology giants has moved to the sky</a></li>
<li><a href="../216243/index.html">The second meeting of the Kiev Android developers in Ciklum March 22</a></li>
<li><a href="../216251/index.html">Create an application on Doophp 1.5</a></li>
<li><a href="../216253/index.html">Urban Jungle Street View: Plants Beat the Cities</a></li>
<li><a href="../216255/index.html">Video reports from the conference LoveQA. The second part of</a></li>
<li><a href="../216257/index.html">Fantastic story</a></li>
<li><a href="../216259/index.html">LG Optimus L1 II: Ultra Budget Segment, Korean Version</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>