<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The first steps into the world of the web in real time</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. I have long wanted to write about something more than WP. I noticed that the more you try to progress as a developer, the more trivial it se...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The first steps into the world of the web in real time</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/a74/3f9/07a/a743f907ad2244899868b3fa01a7087c.png"><br><br>  Good day.  I have long wanted to write about something more than WP.  I noticed that the more you try to progress as a developer, the more trivial it seems that you want to write about.  But oh well, maybe my experience will be quite useful to someone.  The cycle of notes will be focused primarily on those who are just starting to collect their first realtime web applications. <br><br>  So, the task is to synchronize what the user sees and what is in the database.  Previously, I used the Pusher service for such tasks, but recently I prefer to use Centrifuge.  I anticipate the question of how much better is the usual redis / socket.io / node.js bundle.  Out of the box, private channels, simple integration, scaling, api, message history in the channel, unsubscribing and subscribing users to the channel and much more, which allows you to quickly build the desired application prototype without inflating the technology stack.  It works for me, everyone has their own way.  By the way, the language on the backend is php, and, accordingly, on the front end is js. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What came out of this, some nuances - you can see below. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Here I will add links to the following notes.</b> <div class="spoiler_text">  1. <a href="http://habrahabr.ru/post/268717/">We assemble a simple prototype</a> <br>  2. Enter private channels <br>  3. We write simple crm as an example <br></div></div><br><h3>  We assemble a simple prototype </h3><br>  As a first example, take the following task.  On the screen there will be a graph that is the same for all users and is updated as data becomes available. <br><br><img src="https://habrastorage.org/files/5e3/7bd/690/5e37bd690a9943d3815b54225ba8a8bc.gif"><br><br>  For simplicity, the broker at this stage will work in insecure mode: <br><br><ul><li>  Disable verification of tokens and timestamps; </li><li>  Allow anonymous access to all channels; </li><li>  Customers are allowed to post messages to all channels; </li><li>  Removed connection test. </li></ul><br>  Of course, this should not be done in combat mode, but it will work for our purposes and for the sake of understanding the concept. <br><br><h4>  Debut </h4><br>  First you need to deploy a centrifuge on the server.  This is done in a few simple steps: <br><br><ol><li>  Select the required executable file for your platform in the <a href="https://github.com/centrifugal/centrifugo/releases">repository</a> ; </li><li>  As a transport I prefer to use Redis.  But if you want, you can and http. </li><li>  We write a <a href="https://gist.github.com/tw3eX/7923b64d7e1cd90c7a1b">small config</a> for our project; </li><li>  We start the centrifuge at port 8002 and drive the whole thing under <a href="https://gist.github.com/tw3eX/d0037ad73de637b1a76e">nginx</a> . </li></ol><br><h4>  Mitchel spiel </h4><br>  The centrifuge is working, ready to connect customers and send them messages.  Now it's up to backend. <br><br>  We generate <b>composer.json</b> , do <b>composer require predis / predis</b> , write a couple of classes.  Actually the module of sending messages to the broker and transport, through radishes.  Since  The centrifuge at this stage works in insecure mode, there is no need to generate tokens and the task is even more simplified. <br><br><img src="https://habrastorage.org/files/451/053/8f3/4510538f382b49a696314bd5eda1bbe1.png"><br><br><blockquote>  If anyone is interested - the <a href="https://github.com/tw3eX/habrahabr1_example/tree/master">final version of the outline</a> and <a href="http://tw3ex.ru/">demo</a> .  The demo points are destroyed every 240 seconds, you can simply click the button to add new ones to the history and refresh the page.  In the real world, of course, data is taken from api, in the following notes we will return to this. </blockquote><br>  As a result, now we can send messages to users from the backend.  Something like this: <br><br><pre><code class="php hljs">... <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span>.<span class="hljs-string"><span class="hljs-string">'/vendor/autoload.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Push</span></span>\<span class="hljs-title"><span class="hljs-title">Push</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">RedisCommunucate</span></span>\<span class="hljs-title"><span class="hljs-title">Communicate</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Predis</span></span>\<span class="hljs-title"><span class="hljs-title">Client</span></span>; $redisClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Communicate(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Client()); $push = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Push(<span class="hljs-string"><span class="hljs-string">'development'</span></span>, <span class="hljs-string"><span class="hljs-string">'secret'</span></span>, $redisClient); <span class="hljs-comment"><span class="hljs-comment">//   "chart" $push-&gt;publish('chart', ['point' =&gt; rand(0,10)]); ...</span></span></code> </pre> <br><pre> <code class="php hljs">... <span class="hljs-comment"><span class="hljs-comment">//    "publish" public function publish($channel, $data = []) { return $this-&gt;send("publish", ["channel" =&gt; $channel, "data" =&gt; $data]); } public function send($method, $params = []) { if (empty($params)) { $params = new \StdClass(); } $data = json_encode(["method" =&gt; $method, "params" =&gt; $params]); return $this-&gt;communicate -&gt;communicate( $this-&gt;projectKey, ["data" =&gt; $data] ); } ...</span></span></code> </pre><br><pre> <code class="php hljs">... <span class="hljs-comment"><span class="hljs-comment">// redis rpush public function communicate($projectId, $data) { $toSend = array( "project" =&gt; $projectId ); $data['data'] = json_decode($data['data']); $toSend = array_merge($toSend, $data); $toSend['data'] = array($toSend['data']); $this-&gt;redisClient-&gt;rpush("centrifugo.api", json_encode($toSend)); } ...</span></span></code> </pre><br>  And on this the first part of the task can be considered complete.  Now it's up to the front end. <br><br><h4>  Endgame </h4><br>  Let's take c3.js as a library for graphics.  We connect c3, sockjs, centrifuge.js. <br><br><pre> <code class="html hljs xml">... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://cdn.jsdelivr.net/sockjs/1.0/sockjs.min.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://rawgit.com/centrifugal/centrifuge-js/master/centrifuge.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> ...</code> </pre><br>  Connect with a centrifuge, catch points.  And make a button to pull the server to generate new points. <br><br><pre> <code class="hljs lua">... var chart; // . var centrifuge = new Centrifuge({ url: <span class="hljs-string"><span class="hljs-string">'http://socket.logistics.app/connection'</span></span>, project: <span class="hljs-string"><span class="hljs-string">'development'</span></span>, insecure: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }); //   , centrifuge.on(<span class="hljs-string"><span class="hljs-string">'connect'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { //    , var subscription = centrifuge.subscribe(<span class="hljs-string"><span class="hljs-string">'chart'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span></span> { //      , chart.flow({ columns: [ [<span class="hljs-string"><span class="hljs-string">'sample'</span></span>, message.data.point] ], duration: <span class="hljs-number"><span class="hljs-number">100</span></span> }); }); //    .    -   api. subscription.on(<span class="hljs-string"><span class="hljs-string">'ready'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { subscription.history(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span></span> { var data = message.data.map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(point)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> point.data.point }); data.<span class="hljs-built_in"><span class="hljs-built_in">reverse</span></span>(); data.unshift(<span class="hljs-string"><span class="hljs-string">'sample'</span></span>); chart = c3.generate({ bindto: <span class="hljs-string"><span class="hljs-string">'#chart'</span></span>, data: { columns: [ data ] } }); }); }); }); //   centrifuge.connect(); //  ,        $(<span class="hljs-string"><span class="hljs-string">'.random'</span></span>).click(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ $.get(<span class="hljs-string"><span class="hljs-string">'/random.php'</span></span>); }); ...</code> </pre><br>  The task is completed, we open the <a href="http://tw3ex.ru/">page</a> with a demo on different devices or just in different browsers.  When a new point appears - the schedule is updated.  Yes, at this stage it all works extremely unsafe.  But to understand the concept - just right.  Of the known problems, the solution of which I would like to describe in the following notes: <br><br><ul><li>  If new points come between obtaining the histori and subscribing to the channel, they will be lost. </li><li>  Sort points.  If they come extremely often, they will be added in the wrong order. </li><li>  We considered only adding data to the end.  But there is more list data.  And let's say we use <a href="https://www.datatables.net/">datatables</a> to display the <a href="https://www.datatables.net/">labels</a> .  And the data is updated, come from the centrifuge, but we are on the third page of the table with filters / sorting.  And the question is how to synchronize it. </li></ul><br>  In general, I will be glad if it is interesting to someone and doubly happy if it helps someone.  I think that everyone wants in his projects, when one user performs some kind of action, everyone else could immediately see the updated data.  Thank you for your attention, see you soon. </div><p>Source: <a href="https://habr.com/ru/post/268717/">https://habr.com/ru/post/268717/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268703/index.html">What can a student expect in IT, and what options are there at all</a></li>
<li><a href="../268705/index.html">Create the first application for Apple watchOS 2</a></li>
<li><a href="../268707/index.html">Tablet for the elderly. How the project has evolved over the past two years</a></li>
<li><a href="../268709/index.html">Conquering Emacs Modes: A Guide for DIY</a></li>
<li><a href="../268715/index.html">Office as Platform Issue 6 - a quick start for SharePoint Online developer</a></li>
<li><a href="../268719/index.html">Linux Maker's Life</a></li>
<li><a href="../268721/index.html">How ABBYY Cloud OCR SDK helps to catch cheap flights</a></li>
<li><a href="../268723/index.html">Netbeans IDE 8.1 - Yet RC</a></li>
<li><a href="../268725/index.html">Preparing and launching an Email campaign in Siebel CRM</a></li>
<li><a href="../268727/index.html">DPC without copper</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>