<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make Push notifications in Safari browser on macOS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, it was necessary to implement push notifications into their web services, having found instructions on the Internet found a lot of things fo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make Push notifications in Safari browser on macOS</h1><div class="post__text post__text-html js-mediator-article">  Recently, it was necessary to implement push notifications into their web services, having found instructions on the Internet found a lot of things for GCM, Firebase, etc.  but no detailed or step-by-step instructions for the Safari browser (on macOS, I don‚Äôt know or will work in Windows).  In principle, Firebase in Safari asked for permission to be notified, and even got into the settings, but this is just dust in the eyes, because  It is clear that the browser did not want to receive any notifications from Firebase. <br>  I did all this according <a href="https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/NotificationProgrammingGuideForWebsites/PushNotifications/PushNotifications.html">to this instruction</a> here, there are many useful things, but there is a lot of things missing, you have to constantly search for and collect something, so I decided to write an article in and out: ‚ÄúHow to make Push notifications in Safari on macOS‚Äù who will come in handy! <br><br>  The instruction implies that you have an Apple developer account.  I don‚Äôt know if I‚Äôm paying for free, I haven‚Äôt tried it for free (I use corporate). <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Here are the queries from Firebase</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/bv/5c/hq/bv5chqc7yu1olbg_npp4hbexgwk.png"><br><img src="https://habrastorage.org/webt/ud/zk/dt/udzkdtot52adkghoz6_eb4b7qzc.png"><br></div></div><br><h2>  Step 1: Register Website Push ID </h2><br>  Go to your developer account, and <a href="https://developer.apple.com/account/ios/identifier/websitePushId">here we</a> register a new Website Push ID: <br><br><div class="spoiler">  <b class="spoiler_title">Website Push ID</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/m2/sf/kw/m2sfkwaqk55v8cmmv_6lfckv0pa.png"><br><img src="https://habrastorage.org/webt/-t/yp/la/-typla_watqvwjht1cyutknyu_8.png"><br><img src="https://habrastorage.org/webt/wb/i6/bv/wbi6bvzjysthl3adckxln2n_xjm.png"><br><img src="https://habrastorage.org/webt/aa/od/ho/aaodhomjn01easf6cd_ihkkpm1i.png"><br></div></div><br><h2>  Step 2: Request a certificate in Keychain on MacOS </h2><br>  We go into the keychain, in the menu we select ‚ÄúCertification Assistant‚Äù - ‚ÄúRequest a certificate from a certification authority‚Äù, enter your mail, name, and select ‚ÄúSaved on Disk‚Äù and choose where to save the file. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Certificate Request</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/lh/gf/i_/lhgfi_elowhzwj39v-imhibijg8.png"><br><img src="https://habrastorage.org/webt/wb/c9/rq/wbc9rq0bfbyzi8prtsbnz_ugzx8.png"><br></div></div><br><h2>  Step 3: Generate the certificate </h2><br>  Go back to the developer account, click on the plus sign here, thereby create a new certificate, select the ‚ÄúWebsite Push ID Certificate‚Äù option, select our generated Website Push ID, then, then, and then select the file generated in the second step, then we will be told that everything is okay, and will download the file.  Naturally, swing it to your computer, and double-clicking on it, add it to your keychain. <br><br><div class="spoiler">  <b class="spoiler_title">Certificate Generation</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/jx/rr/yx/jxrryxf-9iec08tplfagvn6inic.png"><br><img src="https://habrastorage.org/webt/pv/25/u6/pv25u69yqeutcboze_migypo3ow.png"><br><img src="https://habrastorage.org/webt/st/j3/ul/stj3ul9s4iziujrebqv3a_vbkbk.png"><br><img src="https://habrastorage.org/webt/ly/y-/im/lyy-imh4ajrg88ahpngcfyjgjb4.png"><br><img src="https://habrastorage.org/webt/my/hd/ng/myhdngptbtmabn6neppatxatmli.png"><br></div></div><br><h2>  Step 4: Export Key and Certificate </h2><br>  When I did this for the first time, I spent about an hour of time, until I realized what was needed from me, but the magic was simple: you had to export not only the certificate, but also the key!  To do this, it is necessary to ‚Äúopen‚Äù and export both the key and the certificate in turn, right-click on the certificate and choose ‚ÄúExport‚Äù and the same for the key.  I advise you to immediately name the certificate apns-pro-cert and the key apns-pro-key, this in order to just copy the commands in the next step and not rewrite the file names on your own.  Also, when exporting, specify passwords, and remember, when converting, you will need to enter them. <br><br><div class="spoiler">  <b class="spoiler_title">Export key and certificate</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/h5/xn/ib/h5xnibjlo3zj5hvrhoffmggvvhk.png"><br><img src="https://habrastorage.org/webt/lv/tm/kq/lvtmkqvp0i15kufympfscyxxnvu.png"><br><img src="https://habrastorage.org/webt/dc/l4/09/dcl409orks_eatfvg3dukpwlkg8.png"><br></div></div><br><h2>  Step 5: Converting the certificate to p12 </h2><br>  I found a very <a href="https://gist.github.com/shahdhiren/9ca059ac0762f7ef0fcf71a79ed5b022">cool instruction</a> on which I converted the certificate into <b>pem</b> format from <b>p12</b> (which is needed both for sending notifications and for generating files (will be further)).  We need a "Production Phase".  I duplicate the code here, otherwise I got into many articles where links were indicated and they turned out to be broken. <br><br><pre><code class="hljs sql">Step 1: <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> Certificate .pem <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Certificate .p12 Command: openssl pkcs12 -clcerts -nokeys -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> apns-pro-cert.pem -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> apns-pro-cert.p12 Step <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Key</span></span> .pem <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Key</span></span> .p12 Command : openssl pkcs12 -nocerts -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> apns-pro-key.pem -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> apns-pro-key.p12 Step <span class="hljs-number"><span class="hljs-number">3</span></span>: Optional (<span class="hljs-keyword"><span class="hljs-keyword">If</span></span> you want <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> remove pass phrase asked <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">second</span></span> step) Command : openssl rsa -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> apns-pro-key.pem -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> apns-pro-<span class="hljs-keyword"><span class="hljs-keyword">key</span></span>-noenc.pem Step <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Now</span></span> we have <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">merge</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">Key</span></span> .pem <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> Certificate .pem <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> Production .pem needed <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Push Notifications <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Production Phase <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> App Command : cat apns-pro-cert.pem apns-pro-<span class="hljs-keyword"><span class="hljs-keyword">key</span></span>-noenc.pem &gt; apns-pro.pem (<span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>rd step <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> performed ) Command : cat apns-pro-cert.pem apns-pro-key.pem &gt; apns-pro.pem (<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span>) Step <span class="hljs-number"><span class="hljs-number">5</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Check</span></span> certificate validity <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> connectivity <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> APNS Command: openssl s_client -<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> gateway.push.apple.com:<span class="hljs-number"><span class="hljs-number">2195</span></span> -cert apns-pro-cert.pem -<span class="hljs-keyword"><span class="hljs-keyword">key</span></span> apns-pro-key.pem (<span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>rd step <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> performed ) Command: openssl s_client -<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> gateway.push.apple.com:<span class="hljs-number"><span class="hljs-number">2195</span></span> -cert apns-pro-cert.pem -<span class="hljs-keyword"><span class="hljs-keyword">key</span></span> apns-pro-<span class="hljs-keyword"><span class="hljs-keyword">key</span></span>-noenc.pem (<span class="hljs-keyword"><span class="hljs-keyword">If</span></span> performed )</code> </pre> <br>  Carefully look at step 3 (which deletes the password) and then step 4 and 5, which differ depending on whether you did step 3 or not, I personally did not do, and left the password, how you do it - decide for yourself. <br><br><div class="spoiler">  <b class="spoiler_title">Certificate conversion to p12</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/su/07/y7/su07y7k60reqw7mudasp4vou3ye.png"><br></div></div><br><h2>  Step 6: We throw certificates on the site </h2><br>  It is better to put them above the folder so that they do not have access from the web, we only need 2 files from all received: apns-pro.pem - to send notifications, and apns-pro-cert.p12 to generate a notification package ( will be further). <br><br><h2>  Step 7: Preparing Resources </h2><br>  In order for the browser to allow you to receive requests from your website, you need to create the correct batch of files, which will include icons, manifest.json, signature, website.json, when you first request notifications, the browser downloads it all to itself and stores it locally.  To do this, make such a structure, put it all in the root of our site. <br><br>  Specification: In the website.json file <b>‚ÄúurlFormatString‚Äù: ‚Äú <a href="https://awery.workreports.pro/">awery.workreports.pro/#/app/%@</a> ‚Äù,</b> this is the link that the user will click on the notification, <b>% @</b> is the <b>url-argument</b> that can be passed to the user Different types of notifications went through different paths. <br><br><div class="spoiler">  <b class="spoiler_title">We prepare resources</b> <div class="spoiler_text">  Reduce pictures (who didn't know - a cool resource: <a href="https://tinypng.com/">tinypng.com</a> reduces the weight of pictures for the web) <br><img src="https://habrastorage.org/webt/yk/i7/in/yki7inbif2bo9p9vutqeifgo8iy.png"><br><img src="https://habrastorage.org/webt/go/ou/pe/gooupeplq2ducc1mxkzflmtcqxo.png"><br></div></div><br><h2>  Step 8: Archive Generation </h2><br>  To get the correct files manifest.json and signature, you must use the generation file from Apple.  I tweaked it a bit, deleted a bit more, this one works as it should. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// This script creates a valid push package. // This script assumes that the website.json file and iconset already exist. // This script creates a manifest and signature, zips the folder, and returns the push package. // Use this script as an example to generate a push package dynamically. $certificate_path = "../certs/apns-pro-cert.p12"; // Change this to the path where your certificate is located $certificate_password = "PASSPHRASE"; // Change this to the certificate's import password // Convenience function that returns an array of raw files needed to construct the package. function raw_files() { return array( 'icon.iconset/icon_16x16.png', 'icon.iconset/icon_16x16@2x.png', 'icon.iconset/icon_32x32.png', 'icon.iconset/icon_32x32@2x.png', 'icon.iconset/icon_128x128.png', 'icon.iconset/icon_128x128@2x.png', 'website.json' ); } // Copies the raw push package files to $package_dir. function copy_raw_push_package_files($package_dir) { mkdir($package_dir . '/icon.iconset'); foreach (raw_files() as $raw_file) { copy("pushPackage.raw/$raw_file", "$package_dir/$raw_file"); } } // Creates the manifest by calculating the SHA1 hashes for all of the raw files in the package. function create_manifest($package_dir) { // Obtain SHA1 hashes of all the files in the push package $manifest_data = array(); foreach (raw_files() as $raw_file) { $manifest_data[$raw_file] = sha1(file_get_contents("$package_dir/$raw_file")); } file_put_contents("$package_dir/manifest.json", json_encode((object)$manifest_data)); } // Creates a signature of the manifest using the push notification certificate. function create_signature($package_dir, $cert_path, $cert_password) { // Load the push notification certificate $pkcs12 = file_get_contents($cert_path); $certs = array(); if(!openssl_pkcs12_read($pkcs12, $certs, $cert_password)) { exit('Something wrong with certificate. Err 1'); return; } $signature_path = "$package_dir/signature"; // Sign the manifest.json file with the private key from the certificate $cert_data = openssl_x509_read($certs['cert']); $private_key = openssl_pkey_get_private($certs['pkey'], $cert_password); openssl_pkcs7_sign("$package_dir/manifest.json", $signature_path, $cert_data, $private_key, array(), PKCS7_BINARY | PKCS7_DETACHED); // Convert the signature from PEM to DER $signature_pem = file_get_contents($signature_path); $matches = array(); if (!preg_match('~Content-Disposition:[^\n]+\s*?([A-Za-z0-9+=/\r\n]+)\s*?-----~', $signature_pem, $matches)) { exit('Something wrong with certificate. Err 2'); return; } $signature_der = base64_decode($matches[1]); file_put_contents($signature_path, $signature_der); } // Zips the directory structure into a push package, and returns the path to the archive. function package_raw_data($package_dir) { $zip_path = "$package_dir.zip"; // Package files as a zip file $zip = new ZipArchive(); if (!$zip-&gt;open("$package_dir.zip", ZIPARCHIVE::CREATE)) { error_log('Could not create ' . $zip_path); return; } $raw_files = raw_files(); $raw_files[] = 'manifest.json'; $raw_files[] = 'signature'; foreach ($raw_files as $raw_file) { $zip-&gt;addFile("$package_dir/$raw_file", $raw_file); } $zip-&gt;close(); return $zip_path; } // Creates the push package, and returns the path to the archive. function create_push_package() { global $certificate_path, $certificate_password; // Create a temporary directory in which to assemble the push package $package_dir = '/tmp/pushPackage' . time(); if (!mkdir($package_dir)) { unlink($package_dir); die; } copy_raw_push_package_files($package_dir); create_manifest($package_dir); create_signature($package_dir, $certificate_path, $certificate_password); $package_path = package_raw_data($package_dir); return $package_path; } // MAIN $package_path = create_push_package(); if (empty($package_path)) { http_response_code(500); die; } header("Content-type: application/zip"); echo file_get_contents($package_path); die;</span></span></code> </pre><br>  We put it in the file and call it, he will give us an answer to download the file right away, just call it ‚ÄúpushPackage.zip‚Äù. Save, unpack and check if all the necessary files were created (namely, signature). <br><br><h2>  Step 9: Making the v1 folder (or setting up the routing) </h2><br>  I made a folder v1, in which I put the necessary files, an archive that we generated in the previous step, and an index.php file for processing requests.  It is necessary for the site to respond to such requests: <br><br>  <b>/ v1 / pushPackages / {website}</b> should give the archive in response <br>  <b>/ v1 / devices / {device} / registrations / {website}</b> for registration and deletion (GET / POST - DELETE) <br>  <b>/ v1 / log</b> for error logging <br><br>  In fact, you need to make the workers only a route that gives the archive in return, the rest can simply give up 200 status, without much processing, but you can (and preferably) do everything as it should.  The route <b>/ v1 / devices / {device} / registrations / {website}</b> in the <b>device</b> will be passed to the token and on the <b>website</b> your registered ID (in my case it is com.pro.workreports.awery) if the POST (or GET) request then we register device, if the DELETE request is then deleted.  But there will be another way, from JS'a. <br><br>  On the route <b>/ v1 / log</b> you will receive errors, if suddenly something is wrong.  For the first time it helped me a lot, I understood that I didn‚Äôt finish it and repaired it. <br><br><div class="spoiler">  <b class="spoiler_title">Folder v1</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/r5/lm/er/r5lmertc6rjlhyse65o7ocg8r9k.png"><br></div></div><br><h2>  Step 10: Request a token from JS'a </h2><br>  I have Firebase on my site (for notifications in Chrome) and APNS for safari notifications.  So that both works correctly - I do a check (application on AngularJS): <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">'safari'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">window</span></span> &amp;&amp; <span class="hljs-string"><span class="hljs-string">'pushNotification'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.safari) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> permissionData = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.safari.pushNotification.permission(<span class="hljs-string"><span class="hljs-string">'web.com.example.domain'</span></span>); $scope.checkRemotePermission(permissionData); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">//FIREBASE HERE }</span></span></code> </pre> <br>  and <b>checkRemotePermission</b> function: <br><br><pre> <code class="javascript hljs">$scope.checkRemotePermission = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">permissionData</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (permissionData.permission === <span class="hljs-string"><span class="hljs-string">'default'</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// This is a new web service URL and its validity is unknown. window.safari.pushNotification.requestPermission( 'https://awery.workreports.pro', // The web service URL. 'web.pro.workreports.awery', // The Website Push ID. {}, // Data that you choose to send to your server to help you identify the user. $scope.checkRemotePermission // The callback function. ); } else if (permissionData.permission === 'denied') { if($rootScope.log) console.war('User not allowed notifications'); } else if (permissionData.permission === 'granted') { // The web service URL is a valid push provider, and the user said yes. // permissionData.deviceToken is now available to use. console.log(permissionData.deviceToken, 'YEAH!'); $rootScope.sendTokenToServer(permissionData.deviceToken, 'safari'); } };</span></span></code> </pre><br>  And of course, there is no point in describing the <b>sendTokenToServer</b> function, it accepts a token and a device type as input and stores it in the database, I think you can handle it. <br><br><div class="spoiler">  <b class="spoiler_title">Request rights</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/yn/wi/gv/ynwigvd-h7ugga490la7jehfyhy.png"><br></div></div><br><h2>  Step 11: Sending a notification from the backend: </h2><br>  The script to send notifications to Safari is the same as on iOS, just leave it here: <br><br><pre> <code class="php hljs">$sql = <span class="hljs-string"><span class="hljs-string">"SELECT * FROM `user_devices` WHERE `id_user` = ? AND `type` = ?"</span></span>; $tokens = $dbh-&gt;fetchAll($sql, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($id_user, <span class="hljs-string"><span class="hljs-string">'safari'</span></span>)); $result = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($tokens) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { $ctx = stream_context_create(); stream_context_set_option($ctx, <span class="hljs-string"><span class="hljs-string">'ssl'</span></span>, <span class="hljs-string"><span class="hljs-string">'local_cert'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/certs/apns-pro.pem'</span></span>); stream_context_set_option($ctx, <span class="hljs-string"><span class="hljs-string">'ssl'</span></span>, <span class="hljs-string"><span class="hljs-string">'passphrase'</span></span>, <span class="hljs-string"><span class="hljs-string">'PASSPHAREHERE'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// $fp = stream_socket_client( 'ssl://gateway.push.apple.com:2195', $err, $errstr, 60, STREAM_CLIENT_CONNECT | STREAM_CLIENT_PERSISTENT, $ctx); if (!$fp) $log-&gt;addError("Failed to connect: $err $errstr"); else { foreach ($tokens as $token) { $deviceToken = $token['token']; // Create the payload body $payload = json_encode(array( 'aps' =&gt; array( 'alert' =&gt; array( 'title' =&gt; $title, 'body' =&gt; $message, 'action' =&gt; 'Details' ), 'url-args' =&gt; array($route!=''?route:'generalUser/notifications/list') ) )); $msg = chr(0) . pack('n', 32) . pack('H*', $deviceToken) . pack('n', strlen($payload)) . $payload; $result = fwrite($fp, $msg, strlen($msg)); $log-&gt;addInfo('Push SAFARI send successfully; result ' . $result . ' Sent message: "' . $payload . '"; ID user: ' . $id_user); } fclose($fp); } }</span></span></code> </pre> <br>  Everything is very clear here - I catch all the tokens of the user with the type ‚Äúsafari‚Äù and send notifications for all the tokens. <br><br><h2>  Step 12: Testing </h2><br>  We try to launch the site, allow notifications, * look, or the token is saved *, and try to send.  <i>Try sending from a different browser, and Safari should be closed.</i>  If everything is done correctly, you will see a notification!  They are beautiful, more beautiful than from Chrome, they look like native, and come more often, because  I and Firebase and Safari see that sometimes there are Safari notifications, but they don't always come from Chrome. <br><br><div class="spoiler">  <b class="spoiler_title">Testing</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ig/kc/jq/igkcjqm0s-l2ijkpxctpkxwrkba.png"><br><img src="https://habrastorage.org/webt/ky/sk/_m/kysk_mowbeavftugyh6eg-5x14o.png"><br></div></div><br>  If suddenly after reading the article there are still questions or misunderstandings - write, I will, if possible, answer in the comments.  I will be glad to constructive criticism and comments.  I do not pretend to a super advanced programmer, so I admit that somewhere I may not be quite right.  But according to this algorithm, I made notifications for 2 of my resources and everywhere they work. </div><p>Source: <a href="https://habr.com/ru/post/357862/">https://habr.com/ru/post/357862/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../357852/index.html">European companies are concerned about the ban on VPN in Russia</a></li>
<li><a href="../357854/index.html">How to download VPS: your Nextcloud cloud</a></li>
<li><a href="../357856/index.html">Uber hid a powerful cyber attack with data theft 57 million customers and drivers</a></li>
<li><a href="../357858/index.html">The Ministry of Communications and the Ministry of Foreign Affairs will create an autonomous DNS root server system in the BRICS countries</a></li>
<li><a href="../357860/index.html">Yandex.Catalog stops accepting applications and closes soon</a></li>
<li><a href="../357864/index.html">Roskomnadzor will conduct an "experiment" on blocking Zello Internet radio in Russia</a></li>
<li><a href="../357866/index.html">Roskomnadzor continues to destroy the Internet: it's Google's turn</a></li>
<li><a href="../357880/index.html">Arduino programmable relay</a></li>
<li><a href="../357882/index.html">Laser link between two Arduino Morse code</a></li>
<li><a href="../357884/index.html">Forecaster Class for Weather Station or Weather Predictor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>