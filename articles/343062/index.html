<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SQL Server 2017 JSON</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When Microsoft rushes from one extreme to another for many years in a row, you gradually get used to it and expect everything new with some skepticism...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SQL Server 2017 JSON</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/4a/62/mj/4a62mja5edpjipft3eatedefpc4.png"><br><br>  When <i>Microsoft</i> rushes from one extreme to another for many years in a row, you gradually get used to it and expect everything new with some skepticism.  Over time, this feeling becomes only stronger and subconsciously does not expect anything good. <br><br>  But sometimes everything turns out exactly the opposite.  <i>Microsoft</i> throws out of the box a perfectly working functionality that breaks all established life stereotypes.  You are waiting for the new functionality of the next rake, but, with every minute, more and more you realize that this is exactly what you have missed all these years. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Such a pathetic introduction has certain reasons, because for a long time on <i>Microsoft Connect</i> support for working with <i>JSON</i> on <i>SQL Server</i> was one of the most popular features.  Years passed and unexpectedly this functionality was implemented along with the release of <i>SQL Server 2016</i> .  Looking ahead to say that it came out very well, but <i>Microsoft</i> did not stop there and in <i>SQL Server 2017</i> significantly improved the performance of the already fast <i>JSON</i> parser. <br><a name="habracut"></a><br><h3>  Content: </h3><br>  1. <a href="https://habr.com/ru/post/343062/">Datatypes</a> <br>  2. <a href="https://habr.com/ru/post/343062/">Storage</a> <br>  3. <a href="https://habr.com/ru/post/343062/">Compress / Decompress</a> <br>  4. <a href="https://habr.com/ru/post/343062/">Compression</a> <br>  5. <a href="https://habr.com/ru/post/343062/">ColumnStore</a> <br>  6. <a href="https://habr.com/ru/post/343062/">Create JSON</a> <br>  7. <a href="https://habr.com/ru/post/343062/">Check JSON</a> <br>  8. <a href="https://habr.com/ru/post/343062/">JsonValue</a> <br>  9. <a href="https://habr.com/ru/post/343062/">OpenJson</a> <br>  10. <a href="https://habr.com/ru/post/343062/">String Split</a> <br>  11. <a href="https://habr.com/ru/post/343062/">Lax &amp; strict</a> <br>  12. <a href="https://habr.com/ru/post/343062/">Modify</a> <br>  13. <a href="https://habr.com/ru/post/343062/">Convert implicit</a> <br>  14. <a href="https://habr.com/ru/post/343062/">Indexes</a> <br>  15. <a href="https://habr.com/ru/post/343062/">Parser performance</a> <br>  <a href="https://habr.com/ru/post/343062/">Video</a> <br><br><h3>  1. Datatypes </h3><a name="b1"></a><br>  <i>JSON</i> support on <i>SQL Server is</i> initially available for all editions.  In this case, a separate data type, as in the case of <i>XML</i> , <i>Microsoft has</i> not provided.  Data in <i>JSON</i> on <i>SQL Server is</i> stored as plain text: in <i>Unicode</i> ( <i>NVARCHAR / NCHAR</i> ) or <i>ANSI</i> ( <i>VARCHAR / CHAR</i> ) format. <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @JSON_ANSI <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = <span class="hljs-string"><span class="hljs-string">'[{"NƒÖme":"Len≈çvo „É¢„Éá460"}]'</span></span> , @JSON_Unicode <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">'[{"NƒÖme":"Len≈çvo „É¢„Éá460"}]'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(@JSON_ANSI), @JSON_ANSI <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(@JSON_Unicode), @JSON_Unicode</code> </pre> <br>  The main thing to keep in mind is how much space a given data type takes (2 bytes per character, if we store data as <i>Unicode</i> , or 1 byte for <i>ANSI</i> strings).  Also, do not forget to put ‚Äú <i>N</i> ‚Äù before <i>Unicode</i> constants.  Otherwise, you can run into a bunch of fun situations: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--- ---------------------------- 25 [{"Name":"Lenovo ??460"}] 50 [{"NƒÖme":"Len≈çvo „É¢„Éá460"}]</span></span></code> </pre> <br>  It seems simple, but no.  Further we will see that the selected data type affects not only the size, but also the speed of parsing. <br><br>  In addition, <i>Microsoft</i> strongly recommends not using <a href="https://docs.microsoft.com/en-us/sql/database-engine/deprecated-database-engine-features-in-sql-server-2017"><i>deprecated</i></a> data types - <i>NTEXT / TEXT</i> .  For those who by virtue of their habit still use them, we will do a small investigative experiment: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-comment"><span class="hljs-comment">#varchar DROP TABLE IF EXISTS #nvarchar DROP TABLE IF EXISTS #ntext GO CREATE TABLE #varchar (x VARCHAR(MAX)) CREATE TABLE #nvarchar (x NVARCHAR(MAX)) CREATE TABLE #ntext (x NTEXT) GO DECLARE @json NVARCHAR(MAX) = N'[{"Manufacturer":"Lenovo","Model":"ThinkPad E460","Availability":1}]' SET STATISTICS IO, TIME ON INSERT INTO #varchar SELECT TOP(50000) @json FROM [master].dbo.spt_values s1 CROSS JOIN [master].dbo.spt_values s2 OPTION(MAXDOP 1) INSERT INTO #nvarchar SELECT TOP(50000) @json FROM [master].dbo.spt_values s1 CROSS JOIN [master].dbo.spt_values s2 OPTION(MAXDOP 1) INSERT INTO #ntext SELECT TOP(50000) @json FROM [master].dbo.spt_values s1 CROSS JOIN [master].dbo.spt_values s2 OPTION(MAXDOP 1) SET STATISTICS IO, TIME OFF</span></span></code> </pre><br>  The insertion speed in the latter case will vary significantly: <br><br><pre> <code class="sql hljs">varchar: CPU time = 32 ms, elapsed time = 28 ms nvarchar: CPU time = 31 ms, elapsed time = 30 ms ntext: CPU time = 172 ms, elapsed time = 190 ms</code> </pre> <br>  In addition, it must be remembered that <i>NTEXT / TEXT is</i> always stored on <i>LOB</i> pages: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> obj_name = OBJECT_NAME(p.[object_id]) , a.[type_desc] , a.total_pages , total_mb = a.total_pages * <span class="hljs-number"><span class="hljs-number">8</span></span> / <span class="hljs-number"><span class="hljs-number">1024.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.allocation_units a <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.partitions p <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> p.[partition_id] = a.container_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> p.[object_id] <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ( OBJECT_ID(<span class="hljs-string"><span class="hljs-string">'#nvarchar'</span></span>), OBJECT_ID(<span class="hljs-string"><span class="hljs-string">'#ntext'</span></span>), OBJECT_ID(<span class="hljs-string"><span class="hljs-string">'#varchar'</span></span>) )</code> </pre> <br><pre> <code class="sql hljs">obj_name type_desc total_pages total_mb <span class="hljs-comment"><span class="hljs-comment">------------- -------------- ------------ ----------- varchar IN_ROW_DATA 516 4.031250 varchar LOB_DATA 0 0.000000 nvarchar IN_ROW_DATA 932 7.281250 nvarchar LOB_DATA 0 0.000000 ntext IN_ROW_DATA 188 1.468750 ntext LOB_DATA 1668 13.031250</span></span></code> </pre> <br>  For reference, starting with <i>SQL Server 2005,</i> for variable-length types, the rule ‚ÄúOn which pages to store data‚Äù was changed.  In general, if the size exceeds 8060 bytes, then the data is placed on the <i>LOB</i> page, otherwise it is stored in <i>IN_ROW</i> .  It is clear that in this case, <i>SQL Server</i> optimizes data storage on pages. <br><br>  And the last reason not to use <i>NTEXT / TEXT</i> is the fact that all <i>JSON</i> functions with deprecated data types are not trite with each other: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-comment"><span class="hljs-comment">#ntext WHERE ISJSON(x) = 1</span></span></code> </pre> <br><pre> <code class="sql hljs">Msg 8116, Level 16, State 1, Line 63 Argument data type ntext is invalid for argument 1 of isjson function.</code> </pre> <br><h3>  2. Storage </h3><a name="b2"></a><br>  Now let's see how profitable <i>JSON</i> storage as <i>NVARCHAR / VARCHAR</i> is compared to similar data presented in the form of <i>XML</i> .  In addition, we will try to store the <i>XML</i> in the native format, as well as present it as a string: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @XML_Unicode <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">' &lt;Manufacturer Name="Lenovo"&gt; &lt;Product Name="ThinkPad E460"&gt; &lt;Model Name="20ETS03100"&gt; &lt;CPU&gt;i7-6500U&lt;/CPU&gt; &lt;Memory&gt;16&lt;/Memory&gt; &lt;SSD&gt;256&lt;/SSD&gt; &lt;/Model&gt; &lt;Model Name="20ETS02W00"&gt; &lt;CPU&gt;i5-6200U&lt;/CPU&gt; &lt;Memory&gt;8&lt;/Memory&gt; &lt;HDD&gt;1000&lt;/HDD&gt; &lt;/Model&gt; &lt;Model Name="20ETS02V00"&gt; &lt;CPU&gt;i5-6200U&lt;/CPU&gt; &lt;Memory&gt;4&lt;/Memory&gt; &lt;HDD&gt;500&lt;/HDD&gt; &lt;/Model&gt; &lt;/Product&gt; &lt;/Manufacturer&gt;'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @JSON_Unicode <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">' [ { "Manufacturer": { "Name": "Lenovo", "Product": { "Name": "ThinkPad E460", "Model": [ { "Name": "20ETS03100", "CPU": "Intel Core i7-6500U", "Memory": 16, "SSD": "256" }, { "Name": "20ETS02W00", "CPU": "Intel Core i5-6200U", "Memory": 8, "HDD": "1000" }, { "Name": "20ETS02V00", "CPU": "Intel Core i5-6200U", "Memory": 4, "HDD": "500" } ] } } } ]'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @XML_Unicode_D <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">'&lt;Manufacturer Name="Lenovo"&gt;&lt;Product Name="ThinkPad E460"&gt;&lt;Model Name="20ETS03100"&gt;&lt;CPU&gt;i7-6500U&lt;/CPU&gt;&lt;Memory&gt;16&lt;/Memory&gt;&lt;SSD&gt;256&lt;/SSD&gt;&lt;/Model&gt;&lt;Model Name="20ETS02W00"&gt;&lt;CPU&gt;i5-6200U&lt;/CPU&gt;&lt;Memory&gt;8&lt;/Memory&gt;&lt;HDD&gt;1000&lt;/HDD&gt;&lt;/Model&gt;&lt;Model Name="20ETS02V00"&gt;&lt;CPU&gt;i5-6200U&lt;/CPU&gt;&lt;Memory&gt;4&lt;/Memory&gt;&lt;HDD&gt;500&lt;/HDD&gt;&lt;/Model&gt;&lt;/Product&gt;&lt;/Manufacturer&gt;'</span></span> , @JSON_Unicode_D <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">'[{"Manufacturer":{"Name":"Lenovo","Product":{"Name":"ThinkPad E460","Model":[{"Name":"20ETS03100","CPU":"Intel Core i7-6500U","Memory":16,"SSD":"256"},{"Name":"20ETS02W00","CPU":"Intel Core i5-6200U","Memory":8,"HDD":"1000"},{"Name":"20ETS02V00","CPU":"Intel Core i5-6200U","Memory":4,"HDD":"500"}]}}}]'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">XML</span></span> <span class="hljs-keyword"><span class="hljs-keyword">XML</span></span> = @XML_Unicode , @XML_ANSI <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = @XML_Unicode , @XML_D <span class="hljs-keyword"><span class="hljs-keyword">XML</span></span> = @XML_Unicode_D , @XML_ANSI_D <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = @XML_Unicode_D , @JSON_ANSI <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = @JSON_Unicode , @JSON_ANSI_D <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = @JSON_Unicode_D <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'XML Unicode'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(@XML_Unicode), <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(@XML_Unicode_D)) , (<span class="hljs-string"><span class="hljs-string">'XML ANSI'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(@XML_ANSI), <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(@XML_ANSI_D)) , (<span class="hljs-string"><span class="hljs-string">'XML'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">XML</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(@XML_D)) , (<span class="hljs-string"><span class="hljs-string">'JSON Unicode'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(@JSON_Unicode), <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(@JSON_Unicode_D)) , (<span class="hljs-string"><span class="hljs-string">'JSON ANSI'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(@JSON_ANSI), <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(@JSON_ANSI_D)) ) t(DataType, Delimeters, NoDelimeters)</code> </pre> <br>  When performing we get the following results: <br><br><pre> <code class="sql hljs">DataType Delimeters NoDelimeters <span class="hljs-comment"><span class="hljs-comment">------------ ----------- -------------- XML Unicode 914 674 XML ANSI 457 337 XML 398 398 JSON Unicode 1274 604 JSON ANSI 637 302</span></span></code> </pre> <br>  It may seem that the most profitable option is native <i>XML</i> .  This is partly true, but there are nuances.  <i>XML is</i> always stored as <i>Unicode</i> .  In addition, due to the fact that <i>SQL Server</i> uses a binary format for storing this data, everything is compressed into some standardized dictionary with pointers.  That is why formatting inside XML does not affect the final size of the data. <br><br>  With strings, everything is different, so I would not recommend storing formatted <i>JSON</i> .  The best option is to cut out all unnecessary characters when saving and format the data on demand already on the client. <br><br>  If you want to further reduce the size of <i>JSON</i> data, then we have several options at our disposal. <br><br><h3>  3. Compress / Decompress </h3><a name="b3"></a><br>  In <i>SQL Server 2016</i> , new <i><a href="https://docs.microsoft.com/en-us/sql/t-sql/functions/compress-transact-sql">COMPRESS</a> / <a href="https://docs.microsoft.com/en-us/sql/t-sql/functions/decompress-transact-sql">DECOMPRESS</a></i> functions have been <i><a href="https://docs.microsoft.com/en-us/sql/t-sql/functions/decompress-transact-sql">implemented</a></i> , which add support for <i>GZIP</i> compression: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'XML Unicode'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">COMPRESS</span></span>(@XML_Unicode)), <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">COMPRESS</span></span>(@XML_Unicode_D))) , (<span class="hljs-string"><span class="hljs-string">'XML ANSI'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">COMPRESS</span></span>(@XML_ANSI)), <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">COMPRESS</span></span>(@XML_ANSI_D))) , (<span class="hljs-string"><span class="hljs-string">'JSON Unicode'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">COMPRESS</span></span>(@JSON_Unicode)), <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">COMPRESS</span></span>(@JSON_Unicode_D))) , (<span class="hljs-string"><span class="hljs-string">'JSON ANSI'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">COMPRESS</span></span>(@JSON_ANSI)), <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">COMPRESS</span></span>(@JSON_ANSI_D))) ) t(DataType, CompressDelimeters, CompressNoDelimeters)</code> </pre> <br>  Results for the previous example: <br><br><pre> <code class="sql hljs">DataType CompressDelimeters CompressNoDelimeters <span class="hljs-comment"><span class="hljs-comment">------------ -------------------- -------------------- XML Unicode 244 223 XML ANSI 198 180 JSON Unicode 272 224 JSON ANSI 221 183</span></span></code> </pre> <br>  Everything is well compressed, but you need to remember one thing.  Suppose that the data initially came in <i>ANSI</i> , and then the type of the variable changed to <i>Unicode</i> : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @t <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (val VARBINARY(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @t <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">COMPRESS</span></span>(<span class="hljs-string"><span class="hljs-string">'[{"Name":"ThinkPad E460"}]'</span></span>)) <span class="hljs-comment"><span class="hljs-comment">-- VARCHAR(8000) , (COMPRESS(N'[{"Name":"ThinkPad E460"}]')) -- NVARCHAR(4000) SELECT val , DECOMPRESS(val) , CAST(DECOMPRESS(val) AS NVARCHAR(MAX)) , CAST(DECOMPRESS(val) AS VARCHAR(MAX)) FROM @t</span></span></code> </pre> <br>  The <i>COMPRESS</i> function returns different binary sequences for <i>ANSI / Unicode,</i> and upon subsequent reading we will encounter a situation that some data is stored as <i>ANSI</i> , and some - in <i>Unicode</i> .  It is extremely difficult then to guess which type of cast to make: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">---------------------------- -------------------------------------------------------Á≠õ‰∏¢Êµ°‚â•‚à∫Ê°îÊπ©ÂÅ´Êë°‰î†„ò¥‚à∞ÂµΩ [{"Name":"ThinkPad E460"}] [{"Name":"ThinkPad E460"}] [ { " N ame " : " T hink P ad E 4 6 0 " } ]</span></span></code> </pre> <br>  If we want to build a loaded system, then using the <i>COMPRESS</i> function will slow down the insertion: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> tempdb <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-comment"><span class="hljs-comment">#Compress DROP TABLE IF EXISTS #NoCompress GO CREATE TABLE #NoCompress (DatabaseLogID INT PRIMARY KEY, JSON_Val NVARCHAR(MAX)) CREATE TABLE #Compress (DatabaseLogID INT PRIMARY KEY, JSON_CompressVal VARBINARY(MAX)) GO SET STATISTICS IO, TIME ON INSERT INTO #NoCompress SELECT DatabaseLogID , JSON_Val = ( SELECT PostTime, DatabaseUser, [Event], [Schema], [Object], [TSQL] FOR JSON PATH, WITHOUT_ARRAY_WRAPPER ) FROM AdventureWorks2014.dbo.DatabaseLog OPTION(MAXDOP 1) INSERT INTO #Compress SELECT DatabaseLogID , JSON_CompressVal = COMPRESS(( SELECT PostTime, DatabaseUser, [Event], [Schema], [Object], [TSQL] FOR JSON PATH, WITHOUT_ARRAY_WRAPPER )) FROM AdventureWorks2014.dbo.DatabaseLog OPTION(MAXDOP 1) SET STATISTICS IO, TIME OFF</span></span></code> </pre> <br>  And it is very significant: <br><br><pre> <code class="sql hljs">NoCompress: CPU time = 15 ms, elapsed time = 25 ms Compress: CPU time = 218 ms, elapsed time = 280 ms</code> </pre> <br>  In this case, the size of the table will be reduced: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> obj_name = OBJECT_NAME(p.[object_id]) , a.[type_desc] , a.total_pages , total_mb = a.total_pages * <span class="hljs-number"><span class="hljs-number">8</span></span> / <span class="hljs-number"><span class="hljs-number">1024.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.partitions p <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.allocation_units a <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> p.[partition_id] = a.container_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> p.[object_id] <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ( OBJECT_ID(<span class="hljs-string"><span class="hljs-string">'#Compress'</span></span>), OBJECT_ID(<span class="hljs-string"><span class="hljs-string">'#NoCompress'</span></span>) )</code> </pre> <br><pre> <code class="sql hljs">obj_name type_desc total_pages total_mb <span class="hljs-comment"><span class="hljs-comment">-------------- ------------- ------------ --------- NoCompress IN_ROW_DATA 204 1.593750 NoCompress LOB_DATA 26 0.203125 Compress IN_ROW_DATA 92 0.718750 Compress LOB_DATA 0 0.000000</span></span></code> </pre> <br>  In addition, reading from the table of compressed data then slows down the <i>DECOMPRESS</i> function: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> IO, <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-comment"><span class="hljs-comment">#NoCompress WHERE JSON_VALUE(JSON_Val, '$.Event') = 'CREATE_TABLE' SELECT DatabaseLogID, [JSON] = CAST(DECOMPRESS(JSON_CompressVal) AS NVARCHAR(MAX)) FROM #Compress WHERE JSON_VALUE(CAST(DECOMPRESS(JSON_CompressVal) AS NVARCHAR(MAX)), '$.Event') = N'CREATE_TABLE' SET STATISTICS IO, TIME OFF</span></span></code> </pre> <br>  Logical reads will be reduced, but execution speed will remain extremely low: <br><br><pre> <code class="sql hljs">Table 'NoCompress'. Scan count 1, logical reads 187, ... CPU time = 16 ms, elapsed time = 37 ms Table 'Compress'. Scan count 1, logical reads 79, ... CPU time = 109 ms, elapsed time = 212 ms</code> </pre> <br>  Alternatively, you can add a <i>PERSISTED</i> computed column: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-comment"><span class="hljs-comment">#Compress ADD EventType_Persisted AS CAST(JSON_VALUE(CAST( DECOMPRESS(JSON_CompressVal) AS NVARCHAR(MAX)), '$.Event') AS VARCHAR(200)) PERSISTED</span></span></code> </pre> <br>  Or create a calculated column and based on it an index: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-comment"><span class="hljs-comment">#Compress ADD EventType_NonPersisted AS CAST(JSON_VALUE(CAST( DECOMPRESS(JSON_CompressVal) AS NVARCHAR(MAX)), '$.Event') AS VARCHAR(200)) CREATE INDEX ix ON #Compress (EventType_NonPersisted)</span></span></code> </pre> <br>  Sometimes network latency affects performance much more than the examples I gave above.  Imagine that on the client we can shrink <i>JSON</i> <i>GZIP</i> data and send it to the server: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">json</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>] , t.[object_id] , [<span class="hljs-keyword"><span class="hljs-keyword">columns</span></span>] = ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> c.column_id, c.[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>], c.system_type_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.all_columns c <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> c.[object_id] = t.[object_id] <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JSON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AUTO</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.all_objects t <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JSON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AUTO</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> InitialSize = <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>) / <span class="hljs-number"><span class="hljs-number">1048576.</span></span> , CompressSize = <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">COMPRESS</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>)) / <span class="hljs-number"><span class="hljs-number">1048576.</span></span></code> </pre> <br>  For me, this became a ‚Äúsaving circle‚Äù when I tried to reduce network traffic on one of the projects: <br><br><pre> <code class="sql hljs">InitialSize CompressSize <span class="hljs-comment"><span class="hljs-comment">-------------- ------------- 1.24907684 0.10125923</span></span></code> </pre> <br><h3>  4. Compression </h3><a name="b4"></a><br>  To reduce the size of the tables, you can also use data compression.  Previously, compression was only available in the <i>Enterprise</i> edition.  But with the release of <i>SQL Server 2016 SP1</i> , this functionality can even be used on <i>Express</i> : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> AdventureWorks2014 <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-comment"><span class="hljs-comment">#InitialTable DROP TABLE IF EXISTS #None DROP TABLE IF EXISTS #Row DROP TABLE IF EXISTS #Page GO CREATE TABLE #None (ID INT, Val NVARCHAR(MAX), INDEX ix CLUSTERED (ID) WITH (DATA_COMPRESSION = NONE)) CREATE TABLE #Row (ID INT, Val NVARCHAR(MAX), INDEX ix CLUSTERED (ID) WITH (DATA_COMPRESSION = ROW)) CREATE TABLE #Page (ID INT, Val NVARCHAR(MAX), INDEX ix CLUSTERED (ID) WITH (DATA_COMPRESSION = PAGE)) GO SELECT h.SalesOrderID , JSON_Data = ( SELECT p.[Name] FROM Sales.SalesOrderDetail d JOIN Production.Product p ON d.ProductID = p.ProductID WHERE d.SalesOrderID = h.SalesOrderID FOR JSON AUTO ) INTO #InitialTable FROM Sales.SalesOrderHeader h SET STATISTICS IO, TIME ON INSERT INTO #None SELECT * FROM #InitialTable OPTION(MAXDOP 1) INSERT INTO #Row SELECT * FROM #InitialTable OPTION(MAXDOP 1) INSERT INTO #Page SELECT * FROM #InitialTable OPTION(MAXDOP 1) SET STATISTICS IO, TIME OFF</span></span></code> </pre> <br><pre> <code class="sql hljs">None: CPU time = 62 ms, elapsed time = 68 ms Row: CPU time = 94 ms, elapsed time = 89 ms Page: CPU time = 125 ms, elapsed time = 126 ms</code> </pre> <br>  Page-level compression uses algorithms that find similar pieces of data and replace them with smaller values.  Compression at the line level cuts types down to the minimum required, and also cuts off extra characters.  For example, our column is of type <i>INT</i> , which takes 4 bytes, but values ‚Äã‚Äãless than 255 are stored there. For such records, the type is truncated, and the data on the disk takes up space as if it were <i>TINYINT</i> . <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> tempdb <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> obj_name = OBJECT_NAME(p.[object_id]) , a.[type_desc] , a.total_pages , total_mb = a.total_pages * <span class="hljs-number"><span class="hljs-number">8</span></span> / <span class="hljs-number"><span class="hljs-number">1024.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.partitions p <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.allocation_units a <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> p.[partition_id] = a.container_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> p.[object_id] <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (OBJECT_ID(<span class="hljs-string"><span class="hljs-string">'#None'</span></span>), OBJECT_ID(<span class="hljs-string"><span class="hljs-string">'#Page'</span></span>), OBJECT_ID(<span class="hljs-string"><span class="hljs-string">'#Row'</span></span>))</code> </pre> <br><pre> <code class="sql hljs">obj_name type_desc total_pages total_mb <span class="hljs-comment"><span class="hljs-comment">---------- ------------- ------------ --------- None IN_ROW_DATA 1156 9.031250 Row IN_ROW_DATA 1132 8.843750 Page IN_ROW_DATA 1004 7.843750</span></span></code> </pre> <br><h3>  5. ColumnStore </h3><a name="b5"></a><br>  But what I like most is the <i>ColumnStore</i> indexes, which are getting better and better from version to version in <i>SQL Server</i> . <br><br>  The main idea of ‚Äã‚Äãthe <i>ColumnStore</i> is to split the data in the table into <i>RowGroups of</i> approximately 1 million rows and compress the data in columns within this group.  Due to this, significant savings in disk space, reduction of logical reads and acceleration of analytical queries are achieved.  Therefore, if there is a need to store an archive with <i>JSON</i> information, then you can create a clustered <i>ColumnStore</i> index: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> AdventureWorks2014 <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-comment"><span class="hljs-comment">#CCI DROP TABLE IF EXISTS #InitialTable GO CREATE TABLE #CCI (ID INT, Val NVARCHAR(MAX), INDEX ix CLUSTERED COLUMNSTORE) GO SELECT h.SalesOrderID , JSON_Data = CAST( ( SELECT p.[Name] FROM Sales.SalesOrderDetail d JOIN Production.Product p ON d.ProductID = p.ProductID WHERE d.SalesOrderID = h.SalesOrderID FOR JSON AUTO ) AS VARCHAR(8000)) -- SQL Server 2012..2016 INTO #InitialTable FROM Sales.SalesOrderHeader h SET STATISTICS TIME ON INSERT INTO #CCI SELECT * FROM #InitialTable SET STATISTICS TIME OFF</span></span></code> </pre> <br>  The insertion speed in the table will approximately correspond to <i>PAGE</i> compression.  In addition, you can fine-tune the process under the <i>OLTP</i> load due to the <a href="http://www.nikoport.com/2016/02/04/columnstore-indexes-part-76-compression-delay/"><i>COMPRESSION_DELAY</i></a> option. <br><br><pre> <code class="sql hljs">CCI: CPU time = 140 ms, elapsed time = 136 ms</code> </pre> <br>  Before <i>SQL Server 2017 ColumnStore,</i> indexes did not support data types <i>[N] VARCHAR (MAX)</i> , but together with the release of the new version we were allowed to store rows of any length in the <a href="https://docs.microsoft.com/en-us/sql/database-engine/whats-new-in-sql-server-2017"><i>ColumnStore</i></a> . <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> tempdb <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> o.[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>] , s.used_page_count / <span class="hljs-number"><span class="hljs-number">128.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.indexes i <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.dm_db_partition_stats s <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> i.[object_id] = s.[object_id] <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> i.index_id = s.index_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.objects o <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> i.[object_id] = o.[object_id] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> i.[object_id] = OBJECT_ID(<span class="hljs-string"><span class="hljs-string">'#CCI'</span></span>)</code> </pre> <br>  The gains from this are sometimes very impressive: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">------ --------- CCI 0.796875</span></span></code> </pre> <br><h3>  6. Create JSON </h3><a name="b6"></a><br>  Now let's look at how <i>JSON</i> can be generated.  If you have already worked with <i>XML</i> in <i>SQL Server</i> , then everything is done by analogy. <br><br>  The easiest way to use <i>JSON</i> is to use <i>FOR JSON AUTO</i> .  In this case, an array of <i>JSON</i> from the objects will be generated: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-comment"><span class="hljs-comment">#Users GO CREATE TABLE #Users ( UserID INT , UserName SYSNAME , RegDate DATETIME ) INSERT INTO #Users VALUES (1, 'Paul Denton', '20170123') , (2, 'JC Denton', NULL) , (3, 'Maggie Cho', NULL) SELECT * FROM #Users FOR JSON AUTO</span></span></code> </pre> <br><pre> <code class="sql hljs">[ { "UserID":1, "UserName":"Paul Denton", "RegDate":"2029-01-23T00:00:00" }, { "UserID":2, "UserName":"JC Denton" }, { "UserID":3, "UserName":"Maggie Cho" } ]</code> </pre> <br>  It is important to note that <i>NULL</i> values ‚Äã‚Äãare ignored.  If we want to include them in <i>JSON</i> , then we can use the <i>INCLUDE_NULL_VALUES</i> option: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> UserID, RegDate <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-comment"><span class="hljs-comment">#Users FOR JSON AUTO, INCLUDE_NULL_VALUES</span></span></code> </pre> <br><pre> <code class="sql hljs">[ { "UserID":1, "RegDate":"2017-01-23T00:00:00" }, { "UserID":2, "RegDate":null }, { "UserID":3, "RegDate":null } ]</code> </pre> <br>  If you need to get rid of square brackets, then the <i>WITHOUT_ARRAY_WRAPPER</i> option will help us: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP(<span class="hljs-number"><span class="hljs-number">1</span></span>) UserID, UserName <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-comment"><span class="hljs-comment">#Users FOR JSON AUTO, WITHOUT_ARRAY_WRAPPER</span></span></code> </pre> <br><pre> <code class="sql hljs">{ "UserID":1, "UserName":"Paul Denton" }</code> </pre> <br>  If we want to combine the results with the root element, then the <i>ROOT</i> option is provided for this: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> UserID, UserName <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-comment"><span class="hljs-comment">#Users FOR JSON AUTO, ROOT('Users')</span></span></code> </pre> <br><pre> <code class="sql hljs">{ "Users":[ { "UserID":1, "UserName":"Paul Denton" }, { "UserID":2, "UserName":"JC Denton" }, { "UserID":3, "UserName":"Maggie Cho" } ] }</code> </pre> <br>  If you want to create <i>JSON</i> with a more complex structure, assign the desired name to the properties, group them, then you need to use the expression <i>FOR JSON PATH</i> : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP(<span class="hljs-number"><span class="hljs-number">1</span></span>) UserID , UserName <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Detail.FullName] , RegDate <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Detail.RegDate] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-comment"><span class="hljs-comment">#Users FOR JSON PATH</span></span></code> </pre> <br><pre> <code class="sql hljs">[ { "UserID":1, "Detail":{ "FullName":"Paul Denton", "RegDate":"2017-01-23T00:00:00" } } ]</code> </pre> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>] , t.[object_id] , [<span class="hljs-keyword"><span class="hljs-keyword">columns</span></span>] = ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> c.column_id, c.[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.columns c <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> c.[object_id] = t.[object_id] <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JSON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AUTO</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.tables t <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JSON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AUTO</span></span></code> </pre> <br><pre> <code class="sql hljs">[ { "name":"<span class="hljs-comment"><span class="hljs-comment">#Users", "object_id":1483152329, "columns":[ { "column_id":1, "name":"UserID" }, { "column_id":2, "name":"UserName" }, { "column_id":3, "name":"RegDate" } ] } ]</span></span></code> </pre> <br><h3>  7. Check JSON </h3><a name="b7"></a><br>  To verify the correctness of the <i>JSON</i> format, there is an <a href="https://docs.microsoft.com/en-us/sql/t-sql/functions/isjson-transact-sql"><i>ISJSON</i></a> function that returns 1 if it is <i>JSON</i> , 0 if not, and <i>NULL</i> if <i>NULL</i> was passed. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @json1 <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">'{"id": 1}'</span></span> , @json2 <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">'[1,2,3]'</span></span> , @json3 <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">'1'</span></span> , @json4 <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">''</span></span> , @json5 <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ISJSON(@json1) <span class="hljs-comment"><span class="hljs-comment">-- 1 , ISJSON(@json2) -- 1 , ISJSON(@json3) -- 0 , ISJSON(@json4) -- 0 , ISJSON(@json5) -- NULL</span></span></code> </pre> <br><h3>  8. JsonValue </h3><a name="b8"></a><br>  To extract the scalar value from <i>JSON</i> , you can use the <a href="https://docs.microsoft.com/en-us/sql/t-sql/functions/json-value-transact-sql"><i>JSON_VALUE</i></a> function: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">json</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">' { "UserID": 1, "UserName": "JC Denton", "IsActive": true, "Date": "2016-05-31T00:00:00", "Settings": [ { "Language": "EN" }, { "Skin": "FlatUI" } ] }'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> JSON_VALUE(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>, <span class="hljs-string"><span class="hljs-string">'$.UserID'</span></span>) , JSON_VALUE(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>, <span class="hljs-string"><span class="hljs-string">'$.UserName'</span></span>) , JSON_VALUE(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>, <span class="hljs-string"><span class="hljs-string">'$.Settings[0].Language'</span></span>) , JSON_VALUE(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>, <span class="hljs-string"><span class="hljs-string">'$.Settings[1].Skin'</span></span>) , JSON_QUERY(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>, <span class="hljs-string"><span class="hljs-string">'$.Settings'</span></span>)</code> </pre> <br><h3>  9. OpenJson </h3><a name="b9"></a><br>  The table function <a href="https://docs.microsoft.com/en-us/sql/relational-databases/json/json-data-sql-server"><i>OPENJSON</i></a> is used to parse the tabular data.  Immediately it is worth noting that it will only work on databases with a compatibility level of 130 and higher. <br><br>  There are 2 modes of operation of the <i>OPENSON</i> function.  The simplest one is without a schema for the resulting sample: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">json</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">' { "UserID": 1, "UserName": "JC Denton", "IsActive": true, "RegDate": "2016-05-31T00:00:00" }'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENJSON(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>)</code> </pre> <br>  In the second mode, we can ourselves describe how the returned result will look like: the names of the columns, their number, where to get the values ‚Äã‚Äãfor them: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">json</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">' [ { "User ID": 1, "UserName": "JC Denton", "IsActive": true, "Date": "2016-05-31T00:00:00", "Settings": [ { "Language": "EN" }, { "Skin": "FlatUI" } ] }, { "User ID": 2, "UserName": "Paul Denton", "IsActive": false } ]'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENJSON(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENJSON(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>, <span class="hljs-string"><span class="hljs-string">'$[0]'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENJSON(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>, <span class="hljs-string"><span class="hljs-string">'$[0].Settings[0]'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENJSON(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> ( UserID <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-string"><span class="hljs-string">'$."User ID"'</span></span> , UserName SYSNAME , IsActive <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> , RegDate DATETIME <span class="hljs-string"><span class="hljs-string">'$.Date'</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">Settings</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JSON</span></span> , Skin SYSNAME <span class="hljs-string"><span class="hljs-string">'$.Settings[1].Skin'</span></span> )</code> </pre> <br>  If our document has a nested hierarchy, the following example will help: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">json</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">' [ { "FullName": "JC Denton", "Children": [ { "FullName": "Mary", "Male": "0" }, { "FullName": "Paul", "Male": "1" } ] }, { "FullName": "Paul Denton" } ]'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.FullName, c.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENJSON(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> ( FullName SYSNAME , Children <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JSON</span></span> ) t <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">APPLY</span></span> OPENJSON(Children) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> ( ChildrenName SYSNAME <span class="hljs-string"><span class="hljs-string">'$.FullName'</span></span> , Male TINYINT ) c</code> </pre> <br><h3>  10. String Split </h3><a name="b10"></a><br>  With the release of <i>SQL Server 2016</i> , the function <a href="https://docs.microsoft.com/en-us/sql/t-sql/functions/string-split-transact-sql"><i>STRING_SPLIT</i></a> appeared.  And everyone breathed a sigh of relief that now there‚Äôs no need to invent a bicycle to separate the lines into tokens.  However, there is another alternative - the <i>OPENJSON</i> construction, which we considered earlier.  Let's test a few split line options: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @x <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = <span class="hljs-string"><span class="hljs-string">'1'</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">REPLICATE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-string"><span class="hljs-string">',1'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>)), <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ;<span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> cte <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> s = <span class="hljs-number"><span class="hljs-number">1</span></span> , e = <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">NULLIF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CHARINDEX</span></span>(<span class="hljs-string"><span class="hljs-string">','</span></span>, @x, <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">LEN</span></span>(@x) + <span class="hljs-number"><span class="hljs-number">1</span></span>) , v = <span class="hljs-keyword"><span class="hljs-keyword">SUBSTRING</span></span>(@x, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">NULLIF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CHARINDEX</span></span>(<span class="hljs-string"><span class="hljs-string">','</span></span>, @x, <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">LEN</span></span>(@x) + <span class="hljs-number"><span class="hljs-number">1</span></span>) - <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> s = <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, e) + <span class="hljs-number"><span class="hljs-number">1</span></span> , e = <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">NULLIF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CHARINDEX</span></span>(<span class="hljs-string"><span class="hljs-string">','</span></span>, @x, e + <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">LEN</span></span>(@x) + <span class="hljs-number"><span class="hljs-number">1</span></span>) , v = <span class="hljs-keyword"><span class="hljs-keyword">SUBSTRING</span></span>(@x, e + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">NULLIF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CHARINDEX</span></span>(<span class="hljs-string"><span class="hljs-string">','</span></span>, @x, e + <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">LEN</span></span>(@x) + <span class="hljs-number"><span class="hljs-number">1</span></span>)- e - <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> cte <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> e &lt; <span class="hljs-keyword"><span class="hljs-keyword">LEN</span></span>(@x) + <span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> v <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> cte <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEN</span></span>(v) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPTION</span></span> (MAXRECURSION <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> tcvalue(<span class="hljs-string"><span class="hljs-string">'(./text())[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'INT'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> x = <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">XML</span></span>, <span class="hljs-string"><span class="hljs-string">'&lt;i&gt;'</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span>(@x, <span class="hljs-string"><span class="hljs-string">','</span></span>, <span class="hljs-string"><span class="hljs-string">'&lt;/i&gt;&lt;i&gt;'</span></span>) + <span class="hljs-string"><span class="hljs-string">'&lt;/i&gt;'</span></span>).query(<span class="hljs-string"><span class="hljs-string">'.'</span></span>) ) a <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">APPLY</span></span> x.nodes(<span class="hljs-string"><span class="hljs-string">'i'</span></span>) t(c) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> STRING_SPLIT(@x, N<span class="hljs-string"><span class="hljs-string">','</span></span>) <span class="hljs-comment"><span class="hljs-comment">-- NCHAR(1)/CHAR(1) SELECT [value] FROM OPENJSON(N'[' + @x + N']') -- [1,2,3,4] SET STATISTICS TIME OFF</span></span></code> </pre> <br>  If you look at the results, you can see that <i>OPENJSON</i> in some cases may be faster than the <i>STRING_SPLIT</i> function <i>,</i> not to mention the crutches with <i>XML</i> and <i>CTE</i> : <br><br><pre> <code class="sql hljs"> 500k 100k 50k 1000 <span class="hljs-comment"><span class="hljs-comment">------------- ------- ------ ------ ------ CTE 29407 2406 1266 58 XML 6520 1084 553 259 STRING_SPLIT 4665 594 329 27 OPENJSON 2606 506 273 19</span></span></code> </pre> <br>  Moreover, if we have a high-loaded <i>OLTP</i> , then there is no obvious difference <i>between OPENJSON</i> and <i>STRING_SPLIT</i> (1000 iterations + 10 values, separated by commas): <br><br><pre> <code class="sql hljs">CTE = 4629 ms XML = 4397 ms STRING_SPLIT = 4011 ms OPENJSON = 4047 ms</code> </pre> <br><h3>  11. Lax &amp; strict </h3><a name="b11"></a><br>  Beginning with <i>SQL Server 2005</i> , the possibility of validating <i>XML</i> from the database by using <i>XML SCHEMA COLLECTION has appeared</i> .  We describe the schema for <i>XML</i> , and then based on it we can verify the correctness of the data.  There is no such functionality explicitly for <i>JSON</i> , but there is a workaround. <br><br>  As far as I remember, there are 2 types of expressions for <i>JSON</i> : <i>strict</i> and <i>lax</i> (used by default).  The difference is that if we specify non-existent or incorrect paths during parsing, then for <i>lax</i> expressions we get <i>NULL</i> , and in the case of <i>strict</i> - an error: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">json</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">' { "UserID": 1, "UserName": "JC Denton" }'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> JSON_VALUE(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>, <span class="hljs-string"><span class="hljs-string">'$.IsActive'</span></span>) , JSON_VALUE(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>, <span class="hljs-string"><span class="hljs-string">'lax$.IsActive'</span></span>) , JSON_VALUE(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>, <span class="hljs-string"><span class="hljs-string">'strict$.UserName'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> JSON_VALUE(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>, <span class="hljs-string"><span class="hljs-string">'strict$.IsActive'</span></span>)</code> </pre> <br><pre> <code class="sql hljs">Msg 13608, Level 16, State 2, Line 12 Property cannot be found on the specified JSON path.</code> </pre> <br><h3>  12. Modify </h3><a name="b12"></a><br>  To modify the data inside <i>JSON</i> there is a function <a href="https://docs.microsoft.com/en-us/sql/t-sql/functions/json-modify-transact-sql"><i>JSON_MODIFY</i></a> .  The examples are quite simple, so it makes no sense to describe them in detail: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">json</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">' { "FirstName": "JC", "LastName": "Denton", "Age": 20, "Skills": ["SQL Server 2014"] }'</span></span> <span class="hljs-comment"><span class="hljs-comment">-- 20 -&gt; 22 SET @json = JSON_MODIFY(@json, '$.Age', CAST(JSON_VALUE(@json, '$.Age') AS INT) + 2) -- "SQL 2014" -&gt; "SQL 2016" SET @json = JSON_MODIFY(@json, '$.Skills[0]', 'SQL 2016') SET @json = JSON_MODIFY(@json, 'append $.Skills', 'JSON') SELECT * FROM OPENJSON(@json) -- delete Age SELECT * FROM OPENJSON(JSON_MODIFY(@json, 'lax$.Age', NULL)) -- set NULL SELECT * FROM OPENJSON(JSON_MODIFY(@json, 'strict$.Age', NULL)) GO DECLARE @json NVARCHAR(100) = N'{ "price": 105.90 }' -- rename SET @json = JSON_MODIFY( JSON_MODIFY(@json, '$.Price', CAST(JSON_VALUE(@json, '$.price') AS NUMERIC(6,2))), '$.price', NULL) SELECT @json</span></span></code> </pre> <br><h3>  13. Convert implicit </h3><a name="b13"></a><br>  And here we start to get to the most interesting, namely issues related to performance. <br><br>  When parsing <i>JSON,</i> you need to remember one thing - <i>OPENJSON</i> and <i>JSON_VALUE</i> return the result in <i>Unicode</i> , if we do not override it.  In the <i>AdventureWorks</i> database, the <i>AccountNumber</i> column has the <i>VARCHAR</i> data type: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> AdventureWorks2014 <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">json</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">'{ "AccountNumber": "AW00000009" }'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> IO <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> CustomerID, AccountNumber <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Sales.Customer <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> AccountNumber = JSON_VALUE(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>, <span class="hljs-string"><span class="hljs-string">'$.AccountNumber'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> CustomerID, AccountNumber <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Sales.Customer <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> AccountNumber = <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(JSON_VALUE(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>, <span class="hljs-string"><span class="hljs-string">'$.AccountNumber'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> IO <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span></code> </pre> <br>  The difference in logical readings is: <br><br><pre> <code class="sql hljs">Table 'Customer'. Scan count 1, logical reads 37, ... Table 'Customer'. Scan count 0, logical reads 2, ...</code> </pre> <br>  Due to the fact that the data types between the column and the result of the function do not coincide with us, <i>SQL Server</i> has to perform implicit type conversion based on precedence.  In our case, to <i>NVARCHAR</i> .  Alas, but all the calculations and transformations on the index column most often lead to <i>IndexScan</i> : <br><br><img src="https://habrastorage.org/webt/lx/tz/wh/lxtzwh-3ltippjhrixmp5xafxzm.png"><br><br>  If, however, we explicitly indicate the type, as in the column, then we get <i>IndexSeek</i> : <br><br><img src="https://habrastorage.org/webt/be/m8/xh/bem8xhmvawxe8sq0l6ski6pvohk.png"><br><br><h3>  14. Indexes </h3><a name="b14"></a><br>  Now consider how you can index <i>JSON</i> objects.  As I said at the beginning, in <i>SQL Server 2016</i> a separate data type for <i>JSON</i> was not added, unlike XML.  Therefore, you can use any string data types to store it. <br><br>  If someone has experience with <i>XML</i> , he remembers that there are several types of indexes for this format in <i>SQL Server</i> that can speed up certain selections.  For string types in which storage of <i>JSON</i> is supposed, such indexes simply do not exist. <br><br>  Alas, <i>JSONB was</i> not delivered.  The development team was in a hurry with the release of <i>JSON</i> functionality and said the following: ‚ÄúIf you miss the speed, we will add <i>JSONB</i> in the next version‚Äù.  With the release of <i>SQL Server 2017</i> this did not happen. <br><br>  And here we come to the aid of calculated columns, which can be certain properties from <i>JSON</i> documents for which you need to do a search, and create indexes based on these columns. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> AdventureWorks2014 <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-comment"><span class="hljs-comment">#JSON GO CREATE TABLE #JSON ( DatabaseLogID INT PRIMARY KEY , InfoJSON NVARCHAR(MAX) NOT NULL ) GO INSERT INTO #JSON SELECT DatabaseLogID , InfoJSON = ( SELECT PostTime, DatabaseUser, [Event], [Schema], [Object], [TSQL] FOR JSON PATH, WITHOUT_ARRAY_WRAPPER ) FROM dbo.DatabaseLog</span></span></code> </pre> <br>  Each time parsing the same data is not very rational: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> IO, <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-comment"><span class="hljs-comment">#JSON WHERE JSON_VALUE(InfoJSON, '$.Schema') + '.' + JSON_VALUE(InfoJSON, '$.Object') = 'Person.Person' SET STATISTICS IO, TIME OFF</span></span></code> </pre> <br><pre> <code class="sql hljs">Table 'JSON'. Scan count 1, logical reads 187, ... CPU time = 16 ms, elapsed time = 29 ms</code> </pre> <br>             : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-comment"><span class="hljs-comment">#JSON ADD ObjectName AS JSON_VALUE(InfoJSON, '$.Schema') + '.' + JSON_VALUE(InfoJSON, '$.Object') GO CREATE INDEX IX_ObjectName ON #JSON (ObjectName) GO SET STATISTICS IO, TIME ON SELECT * FROM #JSON WHERE JSON_VALUE(InfoJSON, '$.Schema') + '.' + JSON_VALUE(InfoJSON, '$.Object') = 'Person.Person' SELECT * FROM #JSON WHERE ObjectName = 'Person.Person' SET STATISTICS IO, TIME OFF</span></span></code> </pre> <br>    <i>SQL Server</i>  ,       : <br><br><pre> <code class="sql hljs">Table 'JSON'. Scan count 1, logical reads 13, ... CPU time = 0 ms, elapsed time = 1 ms Table 'JSON'. Scan count 1, logical reads 13, ... CPU time = 0 ms, elapsed time = 1 ms</code> </pre> <br>  ,     ,   ,            . <br><br>       -    <i>JSON</i> ,        ,      , ,  ‚Äî       <i>JSON</i> : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> AdventureWorks2014 <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> dbo.LogJSON <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> dbo.LogJSON ( DatabaseLogID <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> , InfoJSON <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> pk PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (DatabaseLogID) ) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.LogJSON <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DatabaseLogID , InfoJSON = ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> PostTime, DatabaseUser, [<span class="hljs-keyword"><span class="hljs-keyword">Event</span></span>], ObjectName = [<span class="hljs-keyword"><span class="hljs-keyword">Schema</span></span>] + <span class="hljs-string"><span class="hljs-string">'.'</span></span> + [<span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JSON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PATH</span></span>, WITHOUT_ARRAY_WRAPPER ) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.DatabaseLog <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.fulltext_catalogs <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>] = <span class="hljs-string"><span class="hljs-string">'JSON_FTC'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> FULLTEXT <span class="hljs-keyword"><span class="hljs-keyword">CATALOG</span></span> JSON_FTC <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> FULLTEXT <span class="hljs-keyword"><span class="hljs-keyword">CATALOG</span></span> JSON_FTC <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> ACCENT_SENSITIVITY = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> AUTHORIZATION dbo <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.fulltext_indexes <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [object_id] = OBJECT_ID(N<span class="hljs-string"><span class="hljs-string">'dbo.LogJSON'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> FULLTEXT <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dbo.LogJSON <span class="hljs-keyword"><span class="hljs-keyword">DISABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> FULLTEXT <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dbo.LogJSON <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> FULLTEXT <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dbo.LogJSON (InfoJSON) <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> pk <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> JSON_FTC <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.LogJSON <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> CONTAINS(InfoJSON, <span class="hljs-string"><span class="hljs-string">'ALTER_TABLE'</span></span>)</code> </pre> <br><h3> 15. Parser performance </h3><a name="b15"></a><br>    , ,      .    <i>JSON</i>    <i>XML</i>  <i>SQL Server</i> ?     ,    . <br><br>  2    <i>JSON</i>  <i>XML</i> : <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/* EXEC sys.sp_configure 'show advanced options', 1 GO RECONFIGURE GO EXEC sys.sp_configure 'xp_cmdshell', 1 GO RECONFIGURE WITH OVERRIDE GO */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> AdventureWorks2014 <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-comment"><span class="hljs-comment">##get_xml DROP PROCEDURE IF EXISTS ##get_json GO CREATE PROCEDURE ##get_xml AS SELECT r.ProductID , r.[Name] , r.ProductNumber , d.OrderQty , d.UnitPrice , r.ListPrice , r.Color , r.MakeFlag FROM Sales.SalesOrderDetail d JOIN Production.Product r ON d.ProductID = r.ProductID FOR XML PATH ('Product'), ROOT('Products') GO CREATE PROCEDURE ##get_json AS SELECT ( SELECT r.ProductID , r.[Name] , r.ProductNumber , d.OrderQty , d.UnitPrice , r.ListPrice , r.Color , r.MakeFlag FROM Sales.SalesOrderDetail d JOIN Production.Product r ON d.ProductID = r.ProductID FOR JSON PATH ) GO DECLARE @sql NVARCHAR(4000) SET @sql = 'bcp "EXEC ##get_xml" queryout "X:\sample.xml" -S ' + @@servername + ' -T -w -r -t' EXEC sys.xp_cmdshell @sql SET @sql = 'bcp "EXEC ##get_json" queryout "X:\sample.txt" -S ' + @@servername + ' -T -w -r -t' EXEC sys.xp_cmdshell @sql</span></span></code> </pre> <br>   <i>OPENJSON</i> , <i>OPENXML</i>  <i>XQuery</i> : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">xml</span></span> <span class="hljs-keyword"><span class="hljs-keyword">XML</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">xml</span></span> = BulkColumn <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENROWSET(<span class="hljs-keyword"><span class="hljs-keyword">BULK</span></span> <span class="hljs-string"><span class="hljs-string">'X:\sample.xml'</span></span>, SINGLE_BLOB) x <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @jsonu <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @jsonu = BulkColumn <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENROWSET(<span class="hljs-keyword"><span class="hljs-keyword">BULK</span></span> <span class="hljs-string"><span class="hljs-string">'X:\sample.txt'</span></span>, SINGLE_NCLOB) x <span class="hljs-comment"><span class="hljs-comment">/* XML: CPU = 891 ms, Time = 886 ms NVARCHAR: CPU = 141 ms, Time = 166 ms */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ProductID = tcvalue(<span class="hljs-string"><span class="hljs-string">'(ProductID/text())[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'INT'</span></span>) , [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] = tcvalue(<span class="hljs-string"><span class="hljs-string">'(Name/text())[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'NVARCHAR(50)'</span></span>) , ProductNumber = tcvalue(<span class="hljs-string"><span class="hljs-string">'(ProductNumber/text())[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'NVARCHAR(25)'</span></span>) , OrderQty = tcvalue(<span class="hljs-string"><span class="hljs-string">'(OrderQty/text())[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'SMALLINT'</span></span>) , UnitPrice = tcvalue(<span class="hljs-string"><span class="hljs-string">'(UnitPrice/text())[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'MONEY'</span></span>) , ListPrice = tcvalue(<span class="hljs-string"><span class="hljs-string">'(ListPrice/text())[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'MONEY'</span></span>) , Color = tcvalue(<span class="hljs-string"><span class="hljs-string">'(Color/text())[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'NVARCHAR(15)'</span></span>) , MakeFlag = tcvalue(<span class="hljs-string"><span class="hljs-string">'(MakeFlag/text())[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'BIT'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> @xml.nodes(<span class="hljs-string"><span class="hljs-string">'Products/Product'</span></span>) t(c) <span class="hljs-comment"><span class="hljs-comment">/* CPU time = 6203 ms, elapsed time = 6492 ms */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @doc <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> EXEC sys.sp_xml_preparedocument @doc <span class="hljs-keyword"><span class="hljs-keyword">OUTPUT</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">xml</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENXML(@doc, <span class="hljs-string"><span class="hljs-string">'/Products/Product'</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> ( ProductID <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> , [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) , ProductNumber <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">25</span></span>) , OrderQty <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span> , UnitPrice MONEY , ListPrice MONEY , Color <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>) , MakeFlag <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> ) EXEC sys.sp_xml_removedocument @doc <span class="hljs-comment"><span class="hljs-comment">/* CPU time = 2656 ms, elapsed time = 3489 ms CPU time = 3844 ms, elapsed time = 4482 ms CPU time = 0 ms, elapsed time = 4 ms */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENJSON(@jsonu) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> ( ProductID <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> , [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) , ProductNumber <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">25</span></span>) , OrderQty <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span> , UnitPrice MONEY , ListPrice MONEY , Color <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>) , MakeFlag <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> ) <span class="hljs-comment"><span class="hljs-comment">/* CPU time = 1359 ms, elapsed time = 1642 ms */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span></code> </pre> <br>      <i>JSON_VALUE</i>  <i>XQuery</i> : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @jsonu <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">'[ {"User":"Sergey Syrovatchenko","Age":28,"Skills":["SQL Server","T-SQL","JSON","XML"]}, {"User":"JC Denton","Skills":["Microfibral Muscle","Regeneration","EMP Shield"]}, {"User":"Paul Denton","Age":32,"Skills":["Vision Enhancement"]}]'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @jsonu_f <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">'[ { "User":"Sergey Syrovatchenko", "Age":28, "Skills":[ "SQL Server", "T-SQL", "JSON", "XML" ] }, { "User":"JC Denton", "Skills":[ "Microfibral Muscle", "Regeneration", "EMP Shield" ] }, { "User":"Paul Denton", "Age":32, "Skills":[ "Vision Enhancement" ] } ]'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">json</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = @jsonu , @json_f <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = @jsonu_f <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">xml</span></span> <span class="hljs-keyword"><span class="hljs-keyword">XML</span></span> = N<span class="hljs-string"><span class="hljs-string">' &lt;Users&gt; &lt;User Name="Sergey Syrovatchenko"&gt; &lt;Age&gt;28&lt;/Age&gt; &lt;Skills&gt; &lt;Skill&gt;SQL Server&lt;/Skill&gt; &lt;Skill&gt;T-SQL&lt;/Skill&gt; &lt;Skill&gt;JSON&lt;/Skill&gt; &lt;Skill&gt;XML&lt;/Skill&gt; &lt;/Skills&gt; &lt;/User&gt; &lt;User Name="JC Denton"&gt; &lt;Skills&gt; &lt;Skill&gt;Microfibral Muscle&lt;/Skill&gt; &lt;Skill&gt;Regeneration&lt;/Skill&gt; &lt;Skill&gt;EMP Shield&lt;/Skill&gt; &lt;/Skills&gt; &lt;/User&gt; &lt;User Name="Paul Denton"&gt; &lt;Age&gt;28&lt;/Age&gt; &lt;Skills&gt; &lt;Skill&gt;Vision Enhancement&lt;/Skill&gt; &lt;/Skills&gt; &lt;/User&gt; &lt;/Users&gt;'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @i <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> , @<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> , @<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) , @<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) , @s DATETIME , @runs <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-number"><span class="hljs-number">100000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @t <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> ( iter <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> , data_type <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) , [<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>) , [<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>] <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>) , time_ms <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @i = <span class="hljs-number"><span class="hljs-number">1</span></span>, @s = <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @i &lt;= @runs <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = JSON_VALUE(@jsonu, <span class="hljs-string"><span class="hljs-string">'$[0].Age'</span></span>) , @i += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @t <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'@jsonu'</span></span>, <span class="hljs-string"><span class="hljs-string">'$[0].Age'</span></span>, <span class="hljs-string"><span class="hljs-string">'INT'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(ms, @s, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @i = <span class="hljs-number"><span class="hljs-number">1</span></span>, @s = <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @i &lt;= @runs <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = JSON_VALUE(@jsonu_f, <span class="hljs-string"><span class="hljs-string">'$[0].Age'</span></span>) , @i += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @t <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'@jsonu_f'</span></span>, <span class="hljs-string"><span class="hljs-string">'$[0].Age'</span></span>, <span class="hljs-string"><span class="hljs-string">'INT'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(ms, @s, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @i = <span class="hljs-number"><span class="hljs-number">1</span></span>, @s = <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @i &lt;= @runs <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = JSON_VALUE(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>, <span class="hljs-string"><span class="hljs-string">'$[0].Age'</span></span>) , @i += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @t <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'@json'</span></span>, <span class="hljs-string"><span class="hljs-string">'$[0].Age'</span></span>, <span class="hljs-string"><span class="hljs-string">'INT'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(ms, @s, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @i = <span class="hljs-number"><span class="hljs-number">1</span></span>, @s = <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @i &lt;= @runs <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = JSON_VALUE(@json_f, <span class="hljs-string"><span class="hljs-string">'$[0].Age'</span></span>) , @i += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @t <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'@json_f'</span></span>, <span class="hljs-string"><span class="hljs-string">'$[0].Age'</span></span>, <span class="hljs-string"><span class="hljs-string">'INT'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(ms, @s, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @i = <span class="hljs-number"><span class="hljs-number">1</span></span>, @s = <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @i &lt;= @runs <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = @xml.value(<span class="hljs-string"><span class="hljs-string">'(Users/User[1]/Age/text())[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'INT'</span></span>) , @i += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @t <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'@xml'</span></span>, <span class="hljs-string"><span class="hljs-string">'(Users/User[1]/Age/text())[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'INT'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(ms, @s, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @i = <span class="hljs-number"><span class="hljs-number">1</span></span>, @s = <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @i &lt;= @runs <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span> = JSON_VALUE(@jsonu, <span class="hljs-string"><span class="hljs-string">'$[1].User'</span></span>) , @i += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @t <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'@jsonu'</span></span>, <span class="hljs-string"><span class="hljs-string">'$[1].User'</span></span>, <span class="hljs-string"><span class="hljs-string">'NVARCHAR'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(ms, @s, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @i = <span class="hljs-number"><span class="hljs-number">1</span></span>, @s = <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @i &lt;= @runs <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span> = JSON_VALUE(@jsonu_f, <span class="hljs-string"><span class="hljs-string">'$[1].User'</span></span>) , @i += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @t <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'@jsonu_f'</span></span>, <span class="hljs-string"><span class="hljs-string">'$[1].User'</span></span>, <span class="hljs-string"><span class="hljs-string">'NVARCHAR'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(ms, @s, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @i = <span class="hljs-number"><span class="hljs-number">1</span></span>, @s = <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @i &lt;= @runs <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span> = JSON_VALUE(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>, <span class="hljs-string"><span class="hljs-string">'$[1].User'</span></span>) , @i += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @t <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'@json'</span></span>, <span class="hljs-string"><span class="hljs-string">'$[1].User'</span></span>, <span class="hljs-string"><span class="hljs-string">'VARCHAR'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(ms, @s, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @i = <span class="hljs-number"><span class="hljs-number">1</span></span>, @s = <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @i &lt;= @runs <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span> = JSON_VALUE(@json_f, <span class="hljs-string"><span class="hljs-string">'$[1].User'</span></span>) , @i += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @t <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'@json_f'</span></span>, <span class="hljs-string"><span class="hljs-string">'$[1].User'</span></span>, <span class="hljs-string"><span class="hljs-string">'VARCHAR'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(ms, @s, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @i = <span class="hljs-number"><span class="hljs-number">1</span></span>, @s = <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @i &lt;= @runs <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span> = @xml.value(<span class="hljs-string"><span class="hljs-string">'(Users/User[2]/@Name)[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'NVARCHAR(100)'</span></span>) , @i += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @t <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'@xml'</span></span>, <span class="hljs-string"><span class="hljs-string">'(Users/User[2]/@Name)[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'NVARCHAR'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(ms, @s, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @i = <span class="hljs-number"><span class="hljs-number">1</span></span>, @s = <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @i &lt;= @runs <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span> = @xml.value(<span class="hljs-string"><span class="hljs-string">'(Users/User[2]/@Name)[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'VARCHAR(100)'</span></span>) , @i += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @t <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'@xml'</span></span>, <span class="hljs-string"><span class="hljs-string">'(Users/User[2]/@Name)[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'VARCHAR'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(ms, @s, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @i = <span class="hljs-number"><span class="hljs-number">1</span></span>, @s = <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @i &lt;= @runs <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span> = JSON_VALUE(@jsonu, <span class="hljs-string"><span class="hljs-string">'$[2].Skills[0]'</span></span>) , @i += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @t <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'@jsonu'</span></span>, <span class="hljs-string"><span class="hljs-string">'$[2].Skills[0]'</span></span>, <span class="hljs-string"><span class="hljs-string">'NVARCHAR'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(ms, @s, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @i = <span class="hljs-number"><span class="hljs-number">1</span></span>, @s = <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @i &lt;= @runs <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span> = JSON_VALUE(@jsonu_f, <span class="hljs-string"><span class="hljs-string">'$[2].Skills[0]'</span></span>) , @i += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @t <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'@jsonu_f'</span></span>, <span class="hljs-string"><span class="hljs-string">'$[2].Skills[0]'</span></span>, <span class="hljs-string"><span class="hljs-string">'NVARCHAR'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(ms, @s, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @i = <span class="hljs-number"><span class="hljs-number">1</span></span>, @s = <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @i &lt;= @runs <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span> = JSON_VALUE(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>, <span class="hljs-string"><span class="hljs-string">'$[2].Skills[0]'</span></span>) , @i += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @t <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'@json'</span></span>, <span class="hljs-string"><span class="hljs-string">'$[2].Skills[0]'</span></span>, <span class="hljs-string"><span class="hljs-string">'VARCHAR'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(ms, @s, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @i = <span class="hljs-number"><span class="hljs-number">1</span></span>, @s = <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @i &lt;= @runs <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span> = JSON_VALUE(@json_f, <span class="hljs-string"><span class="hljs-string">'$[2].Skills[0]'</span></span>) , @i += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @t <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'@json_f'</span></span>, <span class="hljs-string"><span class="hljs-string">'$[2].Skills[0]'</span></span>, <span class="hljs-string"><span class="hljs-string">'VARCHAR'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(ms, @s, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @i = <span class="hljs-number"><span class="hljs-number">1</span></span>, @s = <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @i &lt;= @runs <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span> = @xml.value(<span class="hljs-string"><span class="hljs-string">'(Users/User[3]/Skills/Skill/text())[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'VARCHAR(100)'</span></span>) , @i += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @t <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'@xml'</span></span>, <span class="hljs-string"><span class="hljs-string">'(Users/User[3]/Skills/Skill/text())[1]'</span></span>, <span class="hljs-string"><span class="hljs-string">'VARCHAR'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(ms, @s, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> @t</code> </pre> <br>  : <br><br><pre> <code class="sql hljs">iter data_type path type 2016 SP1 2017 RTM <span class="hljs-comment"><span class="hljs-comment">------ ---------- --------------------------------------- --------- ----------- ----------- 1 @jsonu $[0].Age INT 830 273 2 @jsonu_f $[0].Age INT 853 300 3 @json $[0].Age INT 963 374 4 @json_f $[0].Age INT 987 413 5 @xml (Users/User[1]/Age/text())[1] INT 23333 24717 6 @jsonu $[1].User NVARCHAR 1047 450 7 @jsonu_f $[1].User NVARCHAR 1153 567 8 @json $[1].User VARCHAR 1177 570 9 @json_f $[1].User VARCHAR 1303 693 10 @xml (Users/User[2]/@Name)[1] NVARCHAR 18864 20070 11 @xml (Users/User[2]/@Name)[1] VARCHAR 18913 20117 12 @jsonu $[2].Skills[0] NVARCHAR 1347 746 13 @jsonu_f $[2].Skills[0] NVARCHAR 1563 980 14 @json $[2].Skills[0] VARCHAR 1483 860 15 @json_f $[2].Skills[0] VARCHAR 1717 1094 16 @xml (Users/User[3]/Skills/Skill/text())[1] VARCHAR 19510 20767</span></span></code> </pre> <br>       ‚Äî     <i>JSON_VALUE</i>  <i>OPENJSON</i> .       ,     . <br><br> C <i>JSON</i>    ‚Äî     ,     : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">json</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">json</span></span> = BulkColumn <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENROWSET(<span class="hljs-keyword"><span class="hljs-keyword">BULK</span></span> <span class="hljs-string"><span class="hljs-string">'X:\sample.txt'</span></span>, SINGLE_NCLOB) x <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT_BIG</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENJSON(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> ( ProductID <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> , ProductNumber <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">25</span></span>) , OrderQty <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span> , UnitPrice MONEY , ListPrice MONEY , Color <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Color = <span class="hljs-string"><span class="hljs-string">'Black'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT_BIG</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENJSON(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (Color <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Color = <span class="hljs-string"><span class="hljs-string">'Black'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT_BIG</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OPENJSON(@<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> JSON_VALUE(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-string"><span class="hljs-string">'$.Color'</span></span>) = <span class="hljs-string"><span class="hljs-string">'Black'</span></span> <span class="hljs-comment"><span class="hljs-comment">/* 2016 SP1: CPU time = 1140 ms, elapsed time = 1144 ms CPU time = 781 ms, elapsed time = 789 ms CPU time = 2157 ms, elapsed time = 2144 ms 2017 RTM: CPU time = 1016 ms, elapsed time = 1034 ms CPU time = 718 ms, elapsed time = 736 ms CPU time = 1282 ms, elapsed time = 1286 ms */</span></span></code> </pre> <br><h3>  Brief conclusions </h3><br><ul><li>    <i>JSON</i>   2  10  ,   <i>XML</i> . </li><li>  <i>JSON</i>   ,   <i>XML</i> . </li><li>  <i>JSON</i>   <i>Unicode</i>   5-15% . </li><li>   <i>JSON</i>      <i>CPU</i> . </li><li>  <i>SQL Server 2017</i>       <i>JSON</i> . </li></ul><br><h3>  /  </h3><br><pre> <code class="sql hljs">Windows 8.1 Pro 6.3 x64 Core i5 3470 3.2GHz, DDR3-1600 32Gb, Samsung 850 Evo 250Gb SQL Server 2016 SP1 Developer (13.0.4001.0) SQL Server 2017 RTM Developer (14.0.1000.169)</code> </pre> <br><h3>  Video </h3><a name="video"></a><br>      ,    ¬´¬ª     : <a href="https://www.youtube.com/watch%3Fv%3DXR2QS-9PQ8w"><i>SQL Server 2016 / 2017: JSON</i></a> .        . <br><br> +        : <a href="http://db-devs.com/blog/archive/sql-server-2017-json/"><i>SQL Server 2017: JSON</i></a> <br><br><h3>   ... </h3><br>   ,       .  ,   24/7,        -,     <i>GitHub</i> .      ,      -       ,      . <br><br> ,   ‚Äî   .      ,  ,   .             <i>JSON</i>  <i>SQL Server 2016 / 2017</i> .  ,       .  ,  <i>JSON</i>    ,    . </div><p>Source: <a href="https://habr.com/ru/post/343062/">https://habr.com/ru/post/343062/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343048/index.html">Free PBX for 1 year, overview webinars, training course in Moscow and completion of 3CX v14 support</a></li>
<li><a href="../343050/index.html">Best VPN Solutions for Linux Users</a></li>
<li><a href="../343052/index.html">Intel has removed a vulnerability in the Management Engine subsystem found by Positive Technologies experts</a></li>
<li><a href="../343054/index.html">Explanation of SNARKs. Homomorphic hiding and blind computation of polynomials (translation)</a></li>
<li><a href="../343058/index.html">Release Rust 1.22 (and 1.22.1)</a></li>
<li><a href="../343064/index.html">When hackers are faster than antiviruses</a></li>
<li><a href="../343068/index.html">Black Friday in the Infobox</a></li>
<li><a href="../343082/index.html">Data from Google Spreadsheets on your site</a></li>
<li><a href="../343084/index.html">WebGL: transfer game from mobile platform to desktop</a></li>
<li><a href="../343086/index.html">Example of reengineering a real business process or when there is no forest behind the trees</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>