<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Network Services Windows 2012 - DNS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At one time, I discovered for myself a simple truth: if you want to remember something, conduct a summary (even when reading a book), and if you want ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Network Services Windows 2012 - DNS</h1><div class="post__text post__text-html js-mediator-article">  At one time, I discovered for myself a simple truth: if you want to remember something, conduct a summary (even when reading a book), and if you want to consolidate and systematize, bring it to people (write an article).  Therefore, after two years of work in system integration (a field that I used to be a system administrator, I considered it as a cornucopia for the pumping thirsty specialists) when I realized that knowledge was gradually replaced by documentation editing and configuration skills on manuals and instructions to maintain Forms I started writing articles about basic things.  For example, here is about DNS.  Then I did it more for myself, but I thought - suddenly someone will come in handy. <br><br>  Service in modern networks, if not key, then one of those.  Those for whom the DNS service is not new, can easily skip the first part. <br><br><h4>  Content: </h4><br>  1. Basic information <br>  2. A little about the format of the DNS message <br>  3. TCP and UDP <br>  4. DNS in Windows Server 2008 and 2012 <br>  5. DNS and Active directory <br>  6. Sources of information 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      (no anchors, so the content is without links) <br><a name="habracut"></a><br><br><h4>  1. Basic information </h4><br>  DNS is a database containing, in the main, information about the mapping of the names of network objects to their IP addresses.  "Basically" - because there and some more information is stored.  Or rather, resource records (Resource Records - RR) of the following types: <br><br>  <i>And this</i> is the very mapping of the symbolic name of the domain to its IP address. <br><br>  <i>AAAA</i> is the same as A, but for IPv6 addresses. <br><br>  <i>CNAME</i> - Canonical NAME - a pseudonym.  If you need a server with an unreadable name, such as nsk-dc2-0704-ibm, on which the corporate portal is spinning, responding also to the portal name, you can create another type A record for it, with the name portal and the same IP address.  But then, in the case of changing the IP address (anything happens), you will need to recreate all such records again.  And if you make a CNAME named portal pointing to nsk-dc2-0704-ibm, then you won't have to change anything. <br><br>  <i>MX</i> - Mail eXchanger - pointer to the mail exchanger.  Like CNAME, it is a symbolic pointer to an already existing record of type A, but in addition to the name it also contains priority.  There may be several MX records for one mail domain, but first of all mail will be sent to the server for which a lower value is specified in the priority field.  If it is unavailable - to the next server, etc. <br><br>  <i>NS</i> - Name Server - contains the name of the DNS server responsible for this domain.  Naturally for each record of type NS there should be a corresponding record of type A. <br><br>  <i>SOA</i> - Start of Authority - indicates which of the NS servers stores reference information about this domain, contact information of the person responsible for the zone, storage timings of information in the cache. <br><br>  <i>SRV</i> is a pointer to the server, the holder of a service (used for AD services and, for example, for Jabber).  In addition to the server name contains such fields as Priority (priority) - similar to MX, Weight (weight) - used for load balancing between servers with the same priority - clients select a server randomly with a probability based on weight and Port Number is the port number, where the service "listens" to requests. <br><br>  All of the above record types are found in the forward lookup zone of the DNS.  There is also a reverse lookup zone - there are stored <i>PTR</i> records - PoinTeR - the record is opposite to type A. It stores the mapping of the IP address to its symbolic name.  Required for processing reverse requests - determining the host name by its IP address.  Not required for DNS operation, but needed for various diagnostic tools, as well as for some types of antispam protection in mail services. <br><br>  In addition, the zones themselves that store information about the domain are of two types (classically): <br><br>  <i>The main (primary)</i> - is a text file containing information about the hosts and services of the domain.  The file can be edited. <br><br>  <i>Additional (secondary)</i> is also a text file, but, unlike the main file, it cannot be edited.  Tightened automatically from the server storing the main zone.  Increases availability and reliability. <br><br>  To register a domain on the Internet, it is necessary that at least two DNS servers store information about it. <br><br>  In Windows 2000, this type of zone appeared as <i>integrated into AD</i> - the zone is not stored in a text file, but in the AD database, which allows it to replicate to other domain controllers along with AD, using its replication mechanisms.  The main advantage of this option is the ability to implement secure dynamic DNS registration.  That is, only computers that are members of a domain can create records about themselves. <br><br>  In Windows 2003, there was also a <i>stub zone - a stub zone</i> .  It stores information only about DNS servers that are authoritative for this domain.  That is, NS records.  This is similar in meaning to <i>conditional forwarding</i> , which appeared in the same version of Windows Server, but the list of servers to which requests are sent is updated automatically. <br><br><h5>  Iterative and recursive queries. </h5><br>  It is clear that a single DNS server does not know about all domains on the Internet.  Therefore, when receiving a request to an unknown address, for example, metro.yandex.ru, the following sequence of iterations is initiated: <br><br>  The DNS server refers to one of the Internet root servers that store information about the authorized holders of the first-level or zone domains (ru, org, com, etc.).  He informs the client about the received address of the authorized server. <br><br>  The client contacts the ru ruler with the same request. <br><br>  The DNS server of the RU zone looks for the corresponding entry in its cache and, if it does not find it, returns to the client the address of the server that is authoritative for the second-level domain - in our case, yandex.ru <br><br>  The client accesses DNS yandex.ru with the same request. <br><br>  Yandex DNS returns the desired address. <br><br>  Such a sequence of events is rare in our time.  Because there is such a thing as a recursive query ‚Äî this is when the DNS server to which the client initially turned, performs all iterations on behalf of the client and then returns the ready response to the client, and also keeps the received information in the cache.  Support for recursive queries can be disabled on the server, but most servers support it. <br><br>  The client, as a rule, makes a request that has the ‚Äúrecursion required‚Äù flag. <br><br><h4>  2. A little about the format of the DNS message </h4><br>  The message consists of a 12-byte header followed by 4 variable-length fields. <br><br>  The header consists of the following fields: <br><img src="https://habrastorage.org/getpro/habr/post_images/450/0ee/f4a/4500eef4a0a8599c44c4511d4f5cac2d.gif"><br><br><h5>  DNS message format </h5><br>  Identification - in this field a certain identifier is generated by the client, which is then copied into the corresponding field of the server's response so that you can understand to which request the answer came. <br><br>  Flags is a 16-bit field divided into 8 parts: <br><br><ul><li>  <b>QR</b> (message type), 1-bit field: 0 indicates the request, 1 indicates the response. </li><li>  <b>opcode</b> ( <b>opcode</b> ), 4-bit field.  Normal value is 0 (standard query).  Other values ‚Äã‚Äãare 1 (inverse request) and 2 (server status request). </li><li>  <b>AA</b> is a 1-bit flag that means ‚Äúauthoritative answer‚Äù.  The DNS server has permissions for this domain in the questions section. </li><li>  <b>TC</b> is a 1-bit field that means truncated.  In the case of UDP, this means that the full size of the response exceeded 512 bytes, but only the first 512 bytes of the response were returned. </li><li>  <b>RD</b> is a 1-bit field that means ‚Äúrecursion desired‚Äù.  The bit may be set in the request and then returned in the response.  This flag requires the DNS server to process this request itself (i.e., the server must determine the required IP address itself, and not return the address of another DNS server), which is called a recursive query.  If this bit is not set and the requested DNS server does not have an authoritative response, the requested server will return a list of other DNS servers that need to be addressed in order to receive a response.  This is called an iterative query.  We will look at examples of both types of queries in the following examples. </li><li>  <b>RA</b> is a 1-bit field that means ‚Äúrecursion is possible‚Äù (recursion available).  This bit is set to 1 in the response if the server supports recursion.  We will see in our examples that most DNS servers support recursion, with the exception of a few root servers (horse servers are not able to process recursive requests due to their workload). </li><li>  <b>0</b> - This 3-bit field must be 0. </li><li>  <b>rcode</b> is a 4-bit return code field.  Typical values ‚Äã‚Äãare 0 (no errors) and 3 (name errors).  The name error is returned only from the authoritative DNS server and means that the domain name specified in the request does not exist. </li></ul><br><br>  The following four 16-bit fields indicate the number of points in the four variable-length fields that complete the recording.  In a request, the number of questions is usually 1, and the remaining three counters are 0. In the response, the number of answers is at least 1, and the remaining two counters can be either zero or non-zero. <br><br>  Example (obtained using WinDump when executing the ping <a href="http://www.ru/">www.ru command</a> ): <br><br> <code><a href="http://www.ru/"></a> IP KKasachev-nb.itcorp.it.ru.51036 &gt; ns1.it.ru.53: 36587+ A? www.ru. (24)</code> <br> <code>IP ns1.it.ru.53 &gt; KKasachev-nb.itcorp.it.ru.51036: 36587 1/2/5 A 194.87.0.50 (196)</code> <br> <br>  The first line is the query: the name of my PC, 51036 is the randomly selected send port, 53 is the previously known DNS server port, 36587 is the request identifier, + - ‚Äúrecursion is required‚Äù, A is a type A write request, the question mark means that request, not answer.  In brackets - the length of the message in bytes. <br><br>  The second line is the server response: to the specified source port with the specified request ID.  The response contains one RR (DNS resource record), which is a response to the request, 2 authority records and 5 some additional records.  The total response length is 196 bytes. <br><br><h4>  3. TCP and UDP </h4><br>  There is a rumor that DNS works over UDP (port 53).  This is indeed the default - requests and responses are sent via UDP.  However, the above-mentioned presence of a TC (Truncated) flag in the message header.  It is set to 1 if the response size exceeds 512 bytes ‚Äî the limit for the UDP response ‚Äî which means it was cut off and only the first 512 bytes came to the client.  In this case, the client repeats the request, but already via TCP, which, due to its specificity, can safely transfer large amounts of data. <br><br>  Also, transfer of zones from main servers to additional servers is carried out via TCP, since in this case much more than 512 bytes are transmitted. <br><br><h4>  4. DNS in Windows Server 2008 and 2012 </h4><br>  In Windows 2008, the following features appeared: <br><br><h5>  Background loading zones </h5><br>  In very large organizations with extremely large areas that use Active Directory Domain Services for storing DNS data, restarting the DNS server can last an hour or more while DNS data is retrieved from the directory service.  At the same time, the DNS server is not available for servicing client requests all the time while the loading of Active Directory Domain Services zones lasts. <br>  The DNS server running Windows Server 2008 now loads the zone data from Active Directory Domain Services in the background during a reboot, thereby allowing it to process requests for data from other zones.  When you start the DNS server, the following actions are performed: <br><ul><li>  all zones to be loaded are determined; </li><li>  root links are loaded from files or AD DS storage; </li><li>  all zones with file support are loaded, that is, zones stored in files, and not in Active Directory Domain Services; </li><li>  processing of requests and remote procedure calls (RPC) begins; </li><li>  One or more threads are created to load zones stored in Active Directory Domain Services. </li></ul><br><br>  Since the zone load task is performed in separate streams, the DNS server can process requests during zone loading.  If the DNS client requests data for a host in a zone that is already loaded, the DNS server responds with the data (or, if appropriate, a negative response).  If the query is made for a node that is not yet loaded into memory, the DNS server reads the node data from Active Directory Domain Services and updates the list of node records accordingly. <br><br><h5>  IPv6 address support </h5><br>  Internet Protocol Version 6 (IPv6) defines addresses that are 128 bits long, as opposed to IP version 4 (IPv4) addresses, which are 32 bits long. <br>  DNS servers running Windows Server 2008 now fully support both IPv4 addresses and IPv6 addresses.  The dnscmd command-line tool also accepts addresses in both formats.  The forwarding server list can contain both IPv4 addresses and IPv6 addresses.  DHCP clients can also register IPv6 addresses along with (or instead of) IPv4 addresses.  Finally, DNS servers now support the ip6.arpa domain namespace for reverse mapping. <br><br><h5>  DNS client changes </h5><br>  LLMNR name resolution <br>  DNS client computers can use the Link-local Multicast Name Resolution name resolution (also called the DNS multicast system or mDNS) to resolve names on a local network segment where the DNS server is not available.  For example, when a subnet is isolated from all DNS servers on the network due to router failure, clients on that subnet that support LLMNR name resolution can still resolve names using a peer-to-peer scheme before reconnecting to the network. <br>  In addition to resolving names in the event of a network failure, LLMNR may also be useful when deploying peer-to-peer networks, for example, in airport lounges. <br><br>  <b>The changes in Windows 2012</b> regarding DNS have affected mainly the DNSSEC technology (ensuring DNS security by adding digital signatures to DNS records), in particular, providing dynamic updates that were not available when DNSSEC was enabled in Windows Server 2008. <br><br><h4>  5. DNS and Active directory </h4><br>  Active Directory relies heavily on DNS.  With it, domain controllers are looking for each other to replicate.  With its help (and services Netlogon) clients define domain controllers for authorization. <br><br>  To ensure the search, in the process of raising the role of the domain controller on the server, its Netlogon service registers the corresponding A and SRV records in DNS. <br><br>  SRV records logged by the Net Logon service: <br><br>  <i>_ldap._tcp.DnsDomainName</i> <i><br></i>  <i>_ldap._tcp.SiteName._sites.DnsDomainName</i> <i><br></i>  <i>_ldap._tcp.dc._msdcs.DnsDomainName</i> <i><br></i>  <i>_ldap._tcp.SiteName._sites.dc._msdcs.DnsDomainName</i> <i><br></i>  <i>_ldap._tcp.pdc._msdcs.DnsDomainName</i> <i><br></i>  <i>_ldap._tcp.gc._msdcs.DnsForestName</i> <i><br></i>  <i>_ldap._tcp.SiteName._sites.gc._msdcs.</i>  <i>Dnsforestname</i> <i><br></i>  <i>_gc._tcp.DnsForestName</i> <i><br></i>  <i>_gc._tcp.SiteName._sites.DnsForestName</i> <i><br></i>  <i>_ldap._tcp.DomainGuid.domains._msdcs.DnsForestName</i> <i><br></i>  <i>_kerberos._tcp.DnsDomainName.</i> <i><br></i>  <i>_kerberos._udp.DnsDomainName</i> <i><br></i>  <i>_kerberos._tcp.SiteName._sites.DnsDomainName</i> <i><br></i>  <i>_kerberos._tcp.dc._msdcs.DnsDomainName</i> <i><br></i>  <i>_kerberos.tcp.SiteName._sites.dc._msdcs.DnsDomainName</i> <i><br></i>  <i>_kpasswd._tcp.DnsDomainName</i> <i><br></i>  <i>_kpasswd._udp.DnsDomainName</i> <br><br>  The first part of the SRV record identifies the service that the SRV record points to.  The following services exist: <br><br>  <b><i>_ldap</i></b> - Active Directory is an LDAP-compatible directory service with domain controllers that act as LDAP servers.  _Ldap SRV records identify LDAP servers on the network.  These servers can be Windows Server 2000+ domain controllers or other LDAP servers; <br><br>  <b><i>_kerberos</i></b> - <b><i>_kerberos</i></b> SRV records identify all key distribution centers (KDCs) in the network.  They can be domain controllers with Windows Server 2003 or other KDC servers; <br><br>  <b><i>_kpassword</i></b> ‚Äî identifies the kerberos password change servers on the network; <br><br>  <b><i>_gc</i></b> is an entry relating to the global catalog function in Active Directory. <br><br>  In the _mcdcs subdomain, only Microsoft Windows Server domain controllers are registered.  They make and main records and records in this subdomain.  Non-Microsoft services only make master records. <br><br>  Records that contain the site identifier SiteName are needed in order for the client to find a domain controller for authorization in his site, and not to log in to another city through slow channels. <br><br>  <b><i>DomainGuid</i></b> - global domain identifier.  The record containing it is needed in case the domain is renamed. <br><br><h5>  How is the DC searching process? </h5><br>  When a user logs in, the client initiates a DNS locator, using a Remote Procedure Call (RPC) by the NetLogon service.  As the initial data, the computer name, domain name and site name are transferred to the procedure. <br><br>  The service sends one or more requests using the DsGetDcName () API. <br><br>  The DNS server returns the requested list of servers, sorted according to priority and weight.  The client then sends an LDAP request using UDP port 389 for each of the entry addresses in the order they were returned. <br><br>  All available domain controllers respond to this request, reporting their health. <br><br>  After detecting a domain controller, the client establishes an LDAP connection with it to gain access to Active Directory.  As part of their dialogue, the domain controller determines to which site the client is located, based on its IP address.  And if it turns out that the client didn‚Äôt apply to the nearest DC, but, for example, recently moved to another site and habitually requested DC from the old one (information about the site is cached on the client as a result of the last successful login), the controller sends him the name of his (client) new site.  If the client has already tried to find a controller in this site, but to no avail, he continues to use the one found.  If not, a new DNS request is initiated with an indication of the new site. <br><br>  The Netlogon service caches information about the location of the domain controller, so as not to initiate the entire procedure every time a DC is accessed.  However, if a ‚Äúnon-optimal‚Äù DC is used (located in another site), the client clears this cache after 15 minutes and initiates searches again (in an attempt to find its optimal controller). <br><br>  If the computer does not have information about its site in the cache, it will contact any domain controller.  In order to prevent this behavior, you can configure NetMask Ordering on DNS.  Then the DNS will issue a list of DCs in such a way that the controllers located on the same network as the client are first. <br><br>  Example: <i>Dnscmd / Config / LocalNetPriorityNetMask 0x0000003F</i> will specify the subnet mask 255.255.255.192 for the priority DCs.  The default mask is 255.255.255.0 (0x000000FF) <br><br><h4>  Information sources: </h4><br>  <a href="http://www.hardline.ru/4/49/1236/1630-25.html">www.hardline.ru/4/49/1236/1630-25.html</a> <br><br>  <a href="http://www.inadmin.ru/2010/02/26/dns-internet-domain/">www.inadmin.ru/2010/02/26/dns-internet-domain</a> <br><br>  <a href="http://minergimn.ru/statii/16-adwin2003132">minergimn.ru/statii/16-adwin2003132</a> <br><br>  <a href="http://technet.microsoft.com/ru-ru/library/cc728909.aspx">technet.microsoft.com/ru-ru/library/cc728909.aspx</a> <br><br>  <a href="http://support.microsoft.com/kb/247811/en-us%3Ffr%3D1">support.microsoft.com/kb/247811/en-us?fr=1</a> </div><p>Source: <a href="https://habr.com/ru/post/214439/">https://habr.com/ru/post/214439/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../214425/index.html">Writing a web service on Go (part two)</a></li>
<li><a href="../214427/index.html">iStodo: cross-platform organizer for students</a></li>
<li><a href="../214431/index.html">Block free SD recording on Android 4.4 devices</a></li>
<li><a href="../214433/index.html">As a messenger Line can be used to promote mobile games</a></li>
<li><a href="../214435/index.html">Apply Apache POI, docx4j and springframework.jdbc</a></li>
<li><a href="../214443/index.html">Photo excursion to the data center "DataPro Tver", Part 1</a></li>
<li><a href="../214445/index.html">3G / 4G Access Network Security</a></li>
<li><a href="../214453/index.html">Debugging Applications with dtrace</a></li>
<li><a href="../214457/index.html">The first cars with iOS on board will be shown at the Geneva Motor Show</a></li>
<li><a href="../214463/index.html">VK: 451 Unavailable For Legal Reasons</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>