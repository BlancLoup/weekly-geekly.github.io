<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Log server Elasticsearch + Logstash + Kibana4 + Beats (windows / linux). Installation and Setup</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There was a question of centralized storage and processing of logs from servers based on Linux and Windows. My choice fell on products from Elastic. 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Log server Elasticsearch + Logstash + Kibana4 + Beats (windows / linux). Installation and Setup</h1><div class="post__text post__text-html js-mediator-article">  There was a question of centralized storage and processing of logs from servers based on Linux and Windows.  My choice fell on products from Elastic. <br>  Most of the articles I read on installing Elastic applications seemed rather vague and incomplete to me. <br><a name="habracut"></a><br>  The main and only source of information that I used: <a href="https://www.elastic.co/guide/index.html">www.elastic.co/guide/index.html</a> . <br><br>  This manual is of course not exhaustive, but is sufficient for the initial installation and configuration of the working log server elasticsearch + logtash + kibana4 + beats (windows \ linux-agents). <br><br>  Detailed information, additional features, and also ‚Äúreal kung-fu‚Äù are available in the <a href="https://www.elastic.co/guide/index.html">official documentation</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      From words to deeds. <br><br><h4>  We will collect and glue </h4><br><ul><li>  <i>Logstash-2.2.0</i> - processing incoming logs </li><li>  <i>Elasticsearch-2.2.0</i> - log storage </li><li>  <i>Kibana-4.2.2</i> - web interface </li><li>  <i>Topbeat 1.1.0</i> - Getting information about the infrastructure of Linux-systems </li><li>  <i>Filebeat 1.1.0</i> - Display logs in real-time Linux-systems </li><li>  <i>Packetbeat 1.1.0</i> - Analysis of packet data in a network of Linux-systems </li><li>  <i>Winlogbeat 1.1.0</i> - Analysis of Windows logs. </li><li>  Operating System - Ubuntu Server 14.04 (trusty) x86_x64 </li></ul><br>  I will not describe the installation of Ubuntu Server; <a href="http://google.gik-team.com/%3Fq%3D%25D0%25A3%25D1%2581%25D1%2582%25D0%25B0%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B0%2BUbuntu%2BServer">comprehensive information</a> is available <a href="http://google.gik-team.com/%3Fq%3D%25D0%25A3%25D1%2581%25D1%2582%25D0%25B0%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B0%2BUbuntu%2BServer">on the web</a> . <br><br><h4>  Training </h4><br>  Updating: <br><br><pre><code class="bash hljs">sudo apt-get update &amp;&amp; apt-get upgrade</code> </pre> <br>  Edit hosts and hostname: <br><br><pre> <code class="bash hljs">sudo vi /etc/hosts</code> </pre><br><pre> <code class="bash hljs">127.0.0.1 localhost 10.0.10.33 elk-server.ss.lu elk-server</code> </pre><br><pre> <code class="bash hljs">sudo <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> ‚Äúelk-server.ss.lu‚Äù &gt; /etc/hostname sudo service hostname restart &amp;&amp; /etc/init.d/networking restart</code> </pre><br>  Install Java 8: <br><br><pre> <code class="bash hljs">sudo add-apt-repository -y ppa:webupd8team/java sudo apt-get update sudo apt-get -y install oracle-java8-installer</code> </pre><br>  We create catalogs that we need for packing packages: <br><br><pre> <code class="bash hljs">sudo mkdir -p ~/ELK/releases/beats/filebeat/ sudo mkdir -p ~/ELK/releases/beats/packetbeat/ sudo mkdir -p ~/ELK/releases/beats/topbeat/ sudo mkdir -p ~/ELK/releases/beats/winlogbeat</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Install Elasticsearch:</b> <div class="spoiler_text">  Go to the website <a href="https://www.elastic.co/downloads/elasticsearch">www.elastic.co/downloads/elasticsearch</a> and download the current (2.2.0) version: <br><br><pre> <code class="bash hljs">sudo <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/ELK/releases/ sudo wget https://download.elasticsearch.org/elasticsearch/release/org/elasticsearch/distribution/deb/elasticsearch/2.2.0/elasticsearch-2.2.0.deb</code> </pre><br>  Install: <br><br><pre> <code class="bash hljs">sudo dpkg ‚Äìi elasticsearch-2.2.0.deb</code> </pre><br>  We edit the configuration /etc/elasticsearch/elasticsearch.yml: <br><br>  Uncomment and edit the cluster.name and node.name sinks: <br><br><pre> <code class="bash hljs">sudo sed -i <span class="hljs-string"><span class="hljs-string">"s|# cluster.name: my-application|cluster.name: elk-server.ss.lu|"</span></span> /etc/elasticsearch/elasticsearch.yml sudo sed -i <span class="hljs-string"><span class="hljs-string">"s|# node.name: node-1| node.name: mynodename|"</span></span> /etc/elasticsearch/elasticsearch.yml</code> </pre><br>  (instead of "elk-server.ss.lu" and "mynodename" you can insert your own values) <br>  It should work like this: <br><br> <code>cluster.name: elk-server.ss.lu <br> node.name: mynodename <br></code> <br>  Add to autoload: <br><br><pre> <code class="bash hljs">sudo update-rc.d elasticsearch defaults 95 10</code> </pre><br>  Run: <br><br><pre> <code class="bash hljs">sudo /etc/init.d/elasticsearch start</code> </pre><br>  Checking: <br><br><pre> <code class="bash hljs">sudo curl http://localhost:9200</code> </pre><br>  The correct conclusion: <br><br><pre> <code class="bash hljs">{ <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"qq"</span></span>, <span class="hljs-string"><span class="hljs-string">"cluster_name"</span></span> : <span class="hljs-string"><span class="hljs-string">"elk-server.qq.qu"</span></span>, <span class="hljs-string"><span class="hljs-string">"version"</span></span> : { <span class="hljs-string"><span class="hljs-string">"number"</span></span> : <span class="hljs-string"><span class="hljs-string">"2.2.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"build_hash"</span></span> : <span class="hljs-string"><span class="hljs-string">"8ff36d139e16f8720f2947ef62c8167a888992fe"</span></span>, <span class="hljs-string"><span class="hljs-string">"build_timestamp"</span></span> : <span class="hljs-string"><span class="hljs-string">"2016-01-27T13:32:39Z"</span></span>, <span class="hljs-string"><span class="hljs-string">"build_snapshot"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"lucene_version"</span></span> : <span class="hljs-string"><span class="hljs-string">"5.4.1"</span></span> }, <span class="hljs-string"><span class="hljs-string">"tagline"</span></span> : <span class="hljs-string"><span class="hljs-string">"You Know, for Search"</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Install Logstash:</b> <div class="spoiler_text">  Download the current (2.2.0) version of Logstash <a href="https://www.elastic.co/downloads/logstash">www.elastic.co/downloads/logstash</a> and install: <br><br><pre> <code class="bash hljs">sudo <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/ELK/releases/ sudo wget https://download.elastic.co/logstash/logstash/packages/debian/logstash_2.2.0-1_all.deb sudo dpkg ‚Äìi logstash_2.2.0-1_all.deb</code> </pre><br>  Create an INPUT file for ‚Äúbits‚Äù ... <br><br><pre> <code class="bash hljs">sudo vi /etc/logstash/conf.d/input-beats.conf</code> </pre><br>  ... and copy the code there: <br><br><pre> <code class="bash hljs">input { beats { port =&gt; 5044 } }</code> </pre><br>  This will mean that logstash will start listening to port 5044. This port is the default for this version and will be spelled out in bits.  You can ask any other. <br><br>  Creating an OUTPUT file ... <br><br><pre> <code class="bash hljs">sudo vi /etc/logstash/conf.d/output-elasticsearch.conf</code> </pre><br>  ... and copy the code there to communicate with elasticsearch: <br><br><pre> <code class="bash hljs">output { elasticsearch { hosts =&gt; [<span class="hljs-string"><span class="hljs-string">"localhost:9200"</span></span>] sniffing =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span> manage_template =&gt; <span class="hljs-literal"><span class="hljs-literal">false</span></span> index =&gt; <span class="hljs-string"><span class="hljs-string">"%{[@metadata][beat]}-%{+YYYY.MM.dd}"</span></span> document_type =&gt; <span class="hljs-string"><span class="hljs-string">"%{[@metadata][type]}"</span></span> } }</code> </pre><br>  We check the config for errors, run it, and enter it into autorun: <br><br><pre> <code class="bash hljs">sudo service logstash configtest sudo service logstash restart sudo update-rc.d logstash defaults 96 9</code> </pre><br>  Check port: <br><br><pre> <code class="bash hljs">netstat -a | grep 5044</code> </pre><br>  Example of successful work: <br><br><pre> <code class="bash hljs">tcp6 0 0 [::]:5044 [::]:* LISTEN</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Install Kibana</b> <div class="spoiler_text">  Download and install the public key: <br><pre> <code class="bash hljs">sudo wget -qO - https://packages.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -</code> </pre><br>  Add a repository: <br><br><pre> <code class="bash hljs">sudo <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb http://packages.elastic.co/kibana/4.4/debian stable main"</span></span> | sudo tee -a /etc/apt/sources.list</code> </pre><br>  Update the repository and install: <br><br><pre> <code class="bash hljs">sudo apt-get update &amp;&amp; sudo apt-get install kibana</code> </pre><br><pre> <code class="bash hljs">sudo update-rc.d kibana defaults 95 10</code> </pre><br>  Run: <br><br><pre> <code class="bash hljs">sudo service kibana start</code> </pre><br>  Connect: <br><br><pre> <code class="bash hljs">http://ip_elk-server.ss.lu:5601</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/ecd/140/28d/ecd14028d7d1c77365ff4e325a824b12.jpg" alt="image"><br><br>  We are asked to create the first index, but for now we leave everything as it is and move on to setting up clients. </div></div><br><div class="spoiler">  <b class="spoiler_title">Beats</b> <div class="spoiler_text">  We put on customers.  To begin with, download and install several ready-made Kibana dashboards with Beats indices: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/ELK/releases/beats/ sudo curl -L -O http://download.elastic.co/beats/dashboards/beats-dashboards-1.1.0.zip sudo unzip beats-dashboards-1.1.0.zip <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> beats-dashboards-1.1.0/ ./load.sh</code> </pre><br>  Go to the web: <br><br><pre> <code class="bash hljs">http://ip_elk-server.ss.lu:5601</code> </pre><br>  And we see that Kibana dashboards with Beats indices were added: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/38d/7a9/36c/38d7a936c0fa8e2c1bfbe7ac95a7e8b5.jpg" alt="image"><br><br><div class="spoiler">  <b class="spoiler_title">Topbeat 1.1.0 (Linux)</b> <div class="spoiler_text">  Retrieving server infrastructure data. <br>  Transmits information about the processor, memory usage.  For each process, information about parents, pid, status, etc. is displayed.  Also Topbeat allows you to view information about the file system - the state of the disks, the amount of free space, etc. <br><br>  Installation (on client): <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/ELK/releases/beats/topbeat/ sudo curl -L -O https://download.elastic.co/beats/topbeat/topbeat_1.1.0_amd64.deb sudo dpkg -i topbeat_1.1.0_amd64.deb</code> </pre><br>  You need to add Topbeat index templates to the server so that Elasticsearch can correctly analyze input information: <br><br><pre> <code class="bash hljs">sudo curl -XPUT <span class="hljs-string"><span class="hljs-string">'http://localhost:9200/_template/topbeat'</span></span> -d@/etc/topbeat/topbeat.template.json</code> </pre><br>  With a successful download, we should see: <br><br> <code>{"acknowledged":true} <br></code> <br>  The topbeat.template.json file is created when you install Topbeat and has a default location of /etc/topbeat/topbeat.template.json.  Therefore, if for some reason we will not install Beats clients on the ELK server, we will need to copy this template from the client to the server, or create this file on the server and copy its contents there (from the client).  And then download it <b>curl -XPUT 'eel_server_server: 9200 / _template / topbeat' -d@/PATH/topbeat.template.json</b> . <br>  But we will assume that the Bits are installed on the server and have the following location <b>/etc/topbeat/topbeat.template.json</b> . <br><br>  We edit the config (on the client): <br><br><pre> <code class="bash hljs">sudo vi /etc/topbeat/topbeat.yml</code> </pre><br>  In the output block, you need to comment on the appeal to elasticsearch, because we will use logstash: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">### Elasticsearch as output #elasticsearch: #hosts: ["localhost:9200"]</span></span></code> </pre><br>  Uncomment the block with Logstash, specify its IP address and port: <br><br><pre> <code class="bash hljs"> logstash: hosts: [<span class="hljs-string"><span class="hljs-string">"ip_elk-server.ss.lu:5044"</span></span>]</code> </pre><br>  Important: do not use tabs to move the cursor in the config!  Only spaces.  Otherwise, you get an error: <br><br><pre> <code class="bash hljs">Loading config file error: YAML config parsing failed on /etc/topbeat /topbeat.yml: yaml: line 14: found character that cannot start any token. Exiting.</code> </pre><br>  If the Logstash server is located on the external network, then the forward server of the port must be configured on the remote server's firewall, in this case 5044 (tcp / udp). <br>  Additional logging options are well described in configs. <br><br>  We start the service: <br><br><pre> <code class="bash hljs">sudo /etc/ini.d/topbeat start</code> </pre><br>  Open the Kibana interface and observe the incoming information: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4ef/9a0/9af/4ef9a09afd798665286cc274b5452db7.png" alt="image"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Filebeat 1.1.0 (LINUX)</b> <div class="spoiler_text">  Transmits information from dynamic files to the server, which we will specify: <br><br>  Setting: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/ELK/releases/beats/filebeat/ sudo curl -L -O https://download.elastic.co/beats/filebeat/filebeat_1.1.0_amd64.deb sudo dpkg -i filebeat_1.1.0_amd64.deb</code> </pre><br>  Add indexes on the server (by analogy with how we set up Topbeat. Ie, if there is no template on the server, we create it): <br><br><pre> <code class="bash hljs">sudo curl -XPUT <span class="hljs-string"><span class="hljs-string">'http://localhost:9200/_template/filebeat?pretty'</span></span> -d@/etc/filebeat/filebeat.template.json</code> </pre><br>  Open the config: <br><br><pre> <code class="bash hljs">sudo vi /etc/filebeat/filebeat.yml</code> </pre><br>  Specify from which files we will take information (by default, all files from / var / log are with the .log extension): <br><br><pre> <code class="bash hljs">prospectors: paths: - /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/*.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span></code> </pre><br>  We specify what we need on this client, for example: <br><br><pre> <code class="bash hljs">paths: <span class="hljs-comment"><span class="hljs-comment"># - /var/log/*.log - /var/log/elasticsearch/*.log - /var/log/syslog - /var/log/nginx/*.log # - c:\programdata\elasticsearch\logs\*</span></span></code> </pre><br>  <b>Remember about the lack of tabs in the code!</b> <br><br>  We will also use logstash to handle indexes: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">### Elasticsearch as output #elasticsearch: # Array of hosts to connect to. # Scheme and port can be left out and will be set to the default (http and 9200) # In case you specify and additional path, the scheme is required: http://localhost:9200/path # IPv6 addresses should always be defined as: https://[2001:db8::1]:9200 #hosts: ["localhost:9200"] ... ### Logstash as output logstash: # The Logstash hosts hosts: ["ip_elk-server.ss.lu:5044"]</span></span></code> </pre><br>  Run: <br><br><pre> <code class="bash hljs">sudo /etc/init.d/filebeat start</code> </pre><br>  We look the information from Filebeat: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7bc/c13/294/7bcc13294a8ca8a3c1c23c77872433f6.png" alt="image"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Packetbeat 1.1.0 (Linux)</b> <div class="spoiler_text">  Very useful tool.  Analyzes traffic between servers.  Instantly detects errors.  Analyzes protocols DNS, HTTP, MySQL, PostgreSQL, GLC, Memcache and others. <br><br>  It is configured in the same way as Topbeat / Filebeat: <br><br><pre> <code class="bash hljs">sudo apt-get install libpcap0.8 sudo curl -L -O https://download.elastic.co/beats/packetbeat/packetbeat_1.1.0_amd64.deb sudo dpkg -i packetbeat_1.1.0_amd64.deb</code> </pre><br>  Edit the cofig (comment on Elasticsearch and set up Logstash) <br>  output: <br><br><pre> <code class="bash hljs"> <span class="hljs-comment"><span class="hljs-comment">#elasticsearch: #hosts: ["localhost:9200"] logstash: hosts: ["ip_elk-server.ss.lu:5044""]</span></span></code> </pre><br>  Go to the server and add an index for Packetbeat: <br><br><pre> <code class="bash hljs">sudo curl -XPUT <span class="hljs-string"><span class="hljs-string">'http://localhost:9200/_template/packetbeat'</span></span> -d@/etc/packetbeat/packetbeat.template.json</code> </pre><br>  Run: <br><br><pre> <code class="bash hljs">sudo /etc/ini.d/packetbeat start</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Winlogbeat (Windows)</b> <div class="spoiler_text">  Download <a href="https://www.elastic.co/downloads/beats/winlogbeat">www.elastic.co/downloads/beats/winlogbeat</a> .  Unpack in C: \ and rename to Winlogbeat.  Start PowerShell from admin and install the service: <br><br><pre> <code class="dos hljs">PS C:\Users\Administrator&gt; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> 'C:\Winlogbeat' PS C:\Winlogbeat&gt; .\install-service-winlogbeat.ps1</code> </pre><br>  If we see a message stating that scripts are disabled on the system by default (and it will be so), then we simply create a policy for Winlogbeat: <br><br><pre> <code class="dos hljs">PowerShell.exe -ExecutionPolicy UnRestricted -File .\install-service-winlogbeat.ps1</code> </pre><br><pre> <code class="dos hljs">Security warning Run only scripts that you trust. While scripts from the internet can be useful, this script can potentially harm your computer. <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> you trust this script, use the Unblock-File cmdlet to allow the script to run without this warning message. <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> you want to run C:\Program Files\Winlogbeat\install-service-winlogbeat.ps1? [D] <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> run [R] Run once [S] Suspend [?] <span class="hljs-built_in"><span class="hljs-built_in">Help</span></span> (default is "D"): R Status Name DisplayName ------ ---- ----------- Stopped winlogbeat winlogbeat</code> </pre><br>  Before starting the service, we rule in the config - C: \ Winlogbeat \ winlogbeat.yml. <br><br><pre> <code class="dos hljs"><span class="hljs-function"><span class="hljs-function">output: #</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">elasticsearch</span></span></span><span class="hljs-function">: # </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hosts</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">localhost</span></span></span><span class="hljs-function">:9200 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logstash</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hosts</span></span></span><span class="hljs-function">: ["</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ip_elk</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">server.ss.lu</span></span></span><span class="hljs-function">:5044"]</span></span></code> </pre><br>  The event_logs block lists the main system logs that need to be transported to Logstash: <br><br><pre> <code class="bash hljs">winlogbeat: registry_file: C:/ProgramData/winlogbeat/.winlogbeat.yml event_logs: - name: Application - name: Security - name: System logging: to_files: <span class="hljs-literal"><span class="hljs-literal">true</span></span> files: path: C:/winlogbeat/winlogbeat/Logs level: info</code> </pre><br>  In event_logs, you can add other magazines, a list of which can be viewed as: <br><br><pre> <code class="dos hljs">PS C:\Users\Administrator&gt; Get-EventLog *</code> </pre><br>  If the system is higher than Vista, then you can specify the channels: <br><br><pre> <code class="dos hljs">PS C:\Users\Administrator&gt; Get-WinEvent -ListLog * | <span class="hljs-built_in"><span class="hljs-built_in">Format</span></span>-List -Property LogName</code> </pre><br>  Next we need to upload the indexes for winlogbeat to the server as we did for topbeat, filebeat, packetbeat.  This can be done remotely: <br><br><pre> <code class="bash hljs">PS C:\Winlogbeat&gt; Invoke-WebRequest -Method Put -InFile winlogbeat.template.json -Uri http://IP_address_elk-server:9200/_template/winlogbeat?pretty</code> </pre><br>  There are problems with this method, you can do the following: <br><br>  Create an index file on the server winlogbeat.template.json <br>  sudo vi ~ / ELK / releases / beats / winlogbeat / winlogbeat.template.json.  On the Windows client, open the file <b>C: \ winlogbeat \ winlogbeat.template.json</b> and copy its contents into the file <b>~ / ELK / releases / beats / winlogbeat / winlogbeat.template.json</b> . <br><br><pre> <code class="bash hljs">{ <span class="hljs-string"><span class="hljs-string">"mappings"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_default_"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_all"</span></span>: { <span class="hljs-string"><span class="hljs-string">"enabled"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"norms"</span></span>: { <span class="hljs-string"><span class="hljs-string">"enabled"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> } }, <span class="hljs-string"><span class="hljs-string">"dynamic_templates"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"template1"</span></span>: { <span class="hljs-string"><span class="hljs-string">"mapping"</span></span>: { <span class="hljs-string"><span class="hljs-string">"doc_values"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"ignore_above"</span></span>: 1024, <span class="hljs-string"><span class="hljs-string">"index"</span></span>: <span class="hljs-string"><span class="hljs-string">"not_analyzed"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"{dynamic_type}"</span></span> }, <span class="hljs-string"><span class="hljs-string">"match"</span></span>: <span class="hljs-string"><span class="hljs-string">"*"</span></span> } } ], <span class="hljs-string"><span class="hljs-string">"properties"</span></span>: { <span class="hljs-string"><span class="hljs-string">"@timestamp"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"date"</span></span> }, <span class="hljs-string"><span class="hljs-string">"message"</span></span>: { <span class="hljs-string"><span class="hljs-string">"index"</span></span>: <span class="hljs-string"><span class="hljs-string">"analyzed"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> } } } }, <span class="hljs-string"><span class="hljs-string">"settings"</span></span>: { <span class="hljs-string"><span class="hljs-string">"index.refresh_interval"</span></span>: <span class="hljs-string"><span class="hljs-string">"5s"</span></span> }, <span class="hljs-string"><span class="hljs-string">"template"</span></span>: <span class="hljs-string"><span class="hljs-string">"winlogbeat-*"</span></span> }</code> </pre><br>  Then (on the server) we load this index on elasticsearch so that it can correctly analyze the information and provide it with the usual format: <br>  Go to the directory where we have created the file <b>winlogbeat.template.json</b> . <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/ELK/releases/beats/winlogbeat ll  12 drwxr-xr-x 2 root root 4096 . 8 23:10 ./ drwxr-xr-x 7 root root 4096 . 8 16:00 ../ -rw-r--r-- 1 root root 729 . 8 23:10 winlogbeat.template.json <span class="hljs-comment"><span class="hljs-comment">#   sudo curl -XPUT 'http://localhost:9200/_template/winlogbeat' -d@winlogbeat.template.json</span></span></code> </pre><br>  The output should be: <br><br> <code>{"acknowledged":true} <br></code> <br>  We go to the client and run the service winlogbeat.  After this, we begin to monitor the data through Kibana, defining the view from the loaded indexes: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/92e/061/016/92e061016dbb8c1b27795fc74a808099.jpg" alt="image"><br><br>  We look at dashboards: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6ff/082/46a/6ff08246a2948ff08fc89aa220121396.jpg" alt="image"><br></div></div><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Logs and logs</b> <div class="spoiler_text">  View indexes: <br><pre> <code class="bash hljs">curl <span class="hljs-string"><span class="hljs-string">'localhost:9200/_cat/indices?v'</span></span></code> </pre><br>  Delete all indexes: <br><br><pre> <code class="bash hljs">curl -XDELETE <span class="hljs-string"><span class="hljs-string">'localhost:9200/*'</span></span></code> </pre><br>  Instead of * you can specify an unwanted index, for example: <br><br>  curl -XDELETE 'localhost: 9200 / winlogbeat-2016.02.10' <br><br>  To delete old logs, you need to install the "Python" module: <br><br><pre> <code class="bash hljs">pip install elasticsearch-curator</code> </pre><br>  If pip is not installed, then install: <br><br><pre> <code class="bash hljs">apt-get install python-pip</code> </pre><br>  Configure Cron: <br><br><pre> <code class="bash hljs">crontab -e</code> </pre><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#     5 : 20 0 20 0 * * * root /usr/local/bin/curator --host localhost delete --disk-space 5 &gt;/dev/null #   , , 30 : 20 0 * * * root /usr/local/bin/curator --host localhost delete --older-than 30 &gt;/dev/null</span></span></code> </pre><br>  View nodes: <br><br><pre> <code class="bash hljs">curl <span class="hljs-string"><span class="hljs-string">'localhost:9200/_cat/nodes?v'</span></span></code> </pre><br>  View Elasticsearch job status: <br><br><pre> <code class="bash hljs">curl <span class="hljs-string"><span class="hljs-string">'localhost:9200/_cat/health?v'</span></span></code> </pre><br>  That's all. <br><br>  This is enough to run a full-fledged log server, scatter conveyors to customers and understand the principles. <br><br>  Additional settings (optimization, geoip settings, etc.) are described in the official documentation and configs. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/277029/">https://habr.com/ru/post/277029/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277017/index.html">Hit Parade of the City Hackathon Projects</a></li>
<li><a href="../277019/index.html">Technosphere Mail.Ru - 2 years</a></li>
<li><a href="../277021/index.html">We disassemble decorators ES2016</a></li>
<li><a href="../277023/index.html">The book "Head First. Programming for Android ¬ª</a></li>
<li><a href="../277025/index.html">From complex to simple: we start a virtual server Windows / Linux</a></li>
<li><a href="../277031/index.html">MyHTML - HTML parser on the "bare" C with POSIX Threads support</a></li>
<li><a href="../277033/index.html">Generators in ES6 and asynchronous code in a new way</a></li>
<li><a href="../277035/index.html">Initial Setup of Extreme Networks Wireless Controllers</a></li>
<li><a href="../277037/index.html">Ultima 2C is a free ERP II class solution based on Ultima Businessware platform.</a></li>
<li><a href="../277041/index.html">Multichannel site upgrade. How to make your life easier</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>