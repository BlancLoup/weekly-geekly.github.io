<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We control the iRobot Roomba robot vacuum cleaner via IR</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Before the new year, I had a useful pet - iRobot Roomba 630. This is the most idle Roomba model without the functions of a scheduler. In general, I do...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We control the iRobot Roomba robot vacuum cleaner via IR</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/349/7c8/990/3497c89909cebac4cbdfa3e78e8eb281.jpg" align="left"><br>  Before the new year, I had a useful pet - iRobot Roomba 630. This is the most idle Roomba model without the functions of a scheduler.  In general, I do not need these functions, I would like to control the robot from a PC, then it would be possible to run it remotely.  To control the robot, the iRobot company produces an IR remote control, ‚ÄúThat's it!‚Äù - I thought and decided to try to make an IR transmitter to control Roomb-th.  All interested in asking under the cat! <br><br><a name="habracut"></a><br><br><h5>  How it works </h5><br>  Of course, the first thing I began to look for on the Internet is the Roomb exchange protocol.  There is not much information, but I found the most detailed description on the forum <a href="http://www.robotreviews.com/">www.robotreviews.com</a> , in particular, an interesting <a href="http://www.robotreviews.com/chat/viewtopic.php%3Fp%3D17071">message</a> , here is its abbreviated quote: <br><blockquote>  The remote control IR stream consists of 8 bits each 4ms in duration.  According to the paper, each bit is started by a 1ms low period.  If the value is 0, the pulse stays low for 2 more ms.  If the pulse goes high for 2ms, if the value is 1. </blockquote><br><div class="spoiler">  <b class="spoiler_title">Also, the author lists the codes he found teams</b> <div class="spoiler_text">  Remote Button IR Stream Sensor Code <br>  Left: 10000001 129 <br>  Forward: 10000010 130 <br>  Right: 10000011 131 <br>  Spot: 10000100 132 <br>  Max: 10000101 133 <br>  Clean: 10001000 136 <br>  Pause: 10001001 137 <br>  Power: 10001010 138 <br>  Forward / Left: 10001011 139 <br>  Forward / Right: 10001100 140 <br>  Docking station: Behind: 11110010 242 <br>  Docking station: Right: 11110110 246 <br>  Docking station: Slightly right: 11110111 247 <br>  Docking station: Left: 11111010 250 <br>  Docking station: Slightly left: 11111011 251 <br>  Docking station: Middle: 11111110 254 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      === codes found by me ... not exactly sure === <br>  Docking station: Distant ????????  248 <br>  Docking station: Distant ????????  244 <br>  Docking station: Distant ????????  240 <br>  Not sure ????  ????????  252 <br></div></div><br>  With the specified intervals, it did not work for me and I went the other way: on the same forum, the <a href="http://www.robotreviews.com/chat/viewtopic.php%3Ft%3D8682">codes for irshell were uploaded to manage with the PSP</a> . <br><div class="spoiler">  <b class="spoiler_title">Here they are</b> <div class="spoiler_text">  TITLE = Roomba <br>  UP = Up <br>  0000 0069 0000 0008 0070 0027 0023 0070 0023 0070 0023 0070 0023 0070 0023 0070 0070 0027 0023 030B <br>  LEFT = Left <br>  0000 0069 0000 0008 0070 0027 0023 0070 0023 0070 0023 0070 0023 0070 0023 0070 0023 0070 0070 02C8 <br>  RIGHT = Right <br>  0000 0067 0000 0008 0072 0024 0024 0072 0024 0072 0024 0072 0024 0072 0024 0072 0072 0024 0072 02D0 <br>  CIRCLE = Spot <br>  0000 0067 0000 0008 0074 0024 0024 0074 0024 0074 0024 0074 0024 0074 0074 0024 0024 0074 0024 0314 <br>  CROSS = Clean <br>  0000 0069 0000 0008 0071 0027 0023 0071 0023 0071 0023 0071 0071 0027 0023 0071 0023 0071 0023 030B <br>  TRIANGLE = Dock (MAX on older models?) <br>  0000 0069 0000 0008 0070 0027 0024 0070 0024 0070 0024 0070 0024 0070 0070 0027 0024 0070 0070 02C8 <br>  L_SQUARE = ‚Äã‚ÄãPower off <br>  0000 0069 0000 0008 0070 0027 0023 0070 0023 0070 0023 0070 0070 0027 0023 0070 0070 0027 0023 030B <br>  L_TRIANGLE = Pause <br>  0000 0069 0000 0008 0070 0023 0023 0070 0023 0070 0023 0070 0070 0023 0023 0070 0023 0070 0070 02C8 <br></div></div><br>  Here, the commands are written in hexadecimal codes, this is the so-called Pronto IR format.  I found a good <a href="http://www.hifi-remote.com/infrared/prontoirformats.pdf">description</a> ( <a href="http://yadi.sk/d/xh7cRWUO2IzNd">Yandex.Disk</a> - just in case) their recording turned out to be quite simple. <br><div class="spoiler">  <b class="spoiler_title">Some illustrations from the format description.</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/7e5/c15/32d/7e5c1532d039d4a25affc191e695350f.png"><br><img src="https://habrastorage.org/storage2/185/240/cd0/185240cd0a413088807142ee3250a859.png"><br></div></div><br>  Consider the example of the Clean command, because  She was for me the most interesting: <br> <code>0000 0069 0000 0008 0071 0027 0023 0071 0023 0071 0023 0071 0071 0027 0023 0071 0023 0071 0023 030B</code> <br> <br>  0000 - Tells us that this is Pronto RAW format, illustrations of its records above. <br>  0069 - Carrier frequency: 69 <sub>16</sub> = 105 <sub>10</sub> ;  f = 4.145146 MHz / 105 = 39.477663 kHz. <br>  0000 - This means there is no starting recurring command. <br>  0008 - A repeated command consists of 8 bits. <br>  Next is the recording of a repeating command, in the form of the number of periods of the carrier frequency. <br>  0071 - The first pack with a length of 71‚Äì16 periods, i.e.  approximately 2862 Œºs. <br>  0027 - We don‚Äôt transfer anything 27 27 periods, i.e.  approximately 988 Œºs. <br>  Further - by analogy.  It turns out that the signal should look like this: <br><img src="https://habrastorage.org/storage2/7ec/345/5a8/7ec3455a810153253007e489442e5afb.png"><br>  If the first pack is one and the second is zero, then the command codes from the message from the forum are correct: <br><table><tbody><tr><th>  Team </th><th>  Code </th></tr><tr><td>  LEFT </td><td>  129 </td></tr><tr><td>  FORWARD </td><td>  130 </td></tr><tr><td>  Right </td><td>  131 </td></tr><tr><td>  Spot </td><td>  132 </td></tr><tr><td>  DOCK </td><td>  133 </td></tr><tr><td>  CLEAN </td><td>  136 </td></tr><tr><td>  PAUSE </td><td>  137 </td></tr><tr><td>  Power </td><td>  138 </td></tr><tr><td>  FORWARD_LEFT </td><td>  139 </td></tr><tr><td>  FORWARD_RIGHT </td><td>  140 </td></tr></tbody></table><br><h5>  Manufacturing </h5><br>  Of course, you could buy any IR transmitter connected via USB and feed the above mentioned Pronto Raw codes to the special program and that's it!  I didn‚Äôt like this idea, at first I wanted my IR transmitter to be used separately from a PC, i.e.  It should be with buttons and a battery, but then I decided to leave the remote with the button for later.  I wanted the transmitter to be controlled via USB-UART and that it understands just text commands, then it could even be connected to the router. <br><br>  The scheme turned out pretty simple: <br><br><img src="https://habrastorage.org/storage2/0db/f2c/ebc/0dbf2cebc667f3960e1937d2c0c7b7bb.png"><br><br>  Components: <br><ul><li>  FTDI FT232RL </li><li>  Atmel ATtiny2313-20SU in a SOIC20 package </li><li>  7.3728 MHz Quartz </li><li>  4 capacitors 0.1 on microfarad SMD0805 </li><li>  2 capacitors at 20pF </li><li>  1 tantalum 10 ŒºF capacitor </li><li>  1 SMD LED (size 1206) to indicate the operation of the FT232 (optional) </li><li>  1 SMD 560 ohm resistor for the LED (again, optional) </li><li>  1 IR LED, I used L-34F3C </li><li>  1 SMD 100 ohm resistor for IR LED. </li></ul><br>  The signal to the IR diode is fed through the 5 pins of the MK, of course, it would be better to control the transistor, but I wanted to make the circuit as simple as possible.  When choosing a resistor R2, you need to remember that the maximum current for ATtiny2313 is 200 mA for all pins, and for 1 output is 40 mA. <br><br>  The information LED is connected to the CBUS3 pin of the FT232 chip; by default, the PWREN # signal is output to it, i.e.  the LED is on when the FT232 is connected to the PC and initialized.  Another function can be assigned to this output, for example, RXTXLED # - then the LED will blink during data transfer.  This can be done using the <a href="">FT_PROG</a> utility.  Utilities for Linux that can change the purpose of the conclusions I did not find something. <br><br>  Since  at home I use Ubuntu OS, I decided to part the board in KiCAD (this is certainly not Altium Designer, but it does its job), I used all the components from the standard libraries: <br><br><img src="https://habrastorage.org/storage2/ad8/ecd/05e/ad8ecd05e2e22533258c4127a33e9a24.png"><br><br>  Archive with KiCAD project: <a href="http://yadi.sk/d/e6Zn8reC2JCJM">Remote_USB_PCB.zip</a> <br>  The fee is one-sided, etched by the LUT method. <br>  It is worth noting that I specifically chose a controller in the SOIC package, since  it is easier to place it on the board and it is also easier to poison / solder.  But the distance between the legs of the FT232RL is quite small, so after transferring the toner to the board, before etching, you need to clear the distance between the leads from the paper residue with some sharp object.  I was too lazy and did not do it, as a result I had to cut the grounds in some places, otherwise they merged. <br><br>  Because of my desire for simplicity, the board was originally quartz-free, and looked like this: <br><img src="https://habrastorage.org/storage2/061/646/d1d/061646d1d8ada606bd7e046da10e69ee.png"><br>  But, apparently, the stability of the internal RC-generator was not enough and Roomba did not react to the commands, although the oscillograms of several periods showed that everything was fine.  As a result, I primed the quartz on trimming the unnecessary board from above: <br><img src="https://habrastorage.org/storage2/865/063/de6/865063de697ded6c2f049a2f449e11dd.jpg"><br><br><h5>  Programming </h5><br>  The program is written in C (AVR-GCC), wrote mainly in CodeBloks, but once it had to be debugged in Atmel Studio.  The code does not claim to be ‚Äúcorrect‚Äù and ‚Äúbeautiful‚Äù at all, t.ch.  I ask you to take this into account and not to criticize strongly (but useful instructions are welcome). <br><div class="spoiler">  <b class="spoiler_title">Listing</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/*  - Irobot Roomba    USB-UART (FTDI FT232R).    Atmel ATTINY2313. FUSE-: Fuse Low Byte: CKDIV|CKOUT|SUT|SKSEL| 0 | 1 |10 |0100 | 0x64 Default 1 | 1 |10 |1100 | 0b11101100=0xEC   7.3728  */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> F_CPU 8E6 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//#define __AVR_ATtiny2313__ #include &lt;avr/io.h&gt; //#include &lt;stdio.h&gt; //#include &lt;stdint.h&gt; //#include &lt;stdlib.h&gt; //#include &lt;util/delay.h&gt; //#include &lt;string.h&gt; //#include &lt;avr/pgmspace.h&gt; /*------&lt;&gt;-----*/ // 39477  //39500   25,3  #define P_GEN {TCNT0=0; PORTB |= 0x1F; while (TCNT0 &lt; 93); PORTB &amp;= ~0x1F; while (TCNT0 &lt; 186);} #define TX_LFCR tx_uart(0x0A); tx_uart(0x0D); //Roomba : #define LEFT 129 #define FORWARD 130 #define RIGHT 131 #define SPOT 132 #define DOCK 133 #define CLEAN 136 #define PAUSE 137 #define POWER 138 #define FORWARD_LEFT 139 #define FORWARD_RIGHT 140 /*------&lt;   &gt;------*/ volatile unsigned char data; unsigned char status; /*----------------&lt;:&gt;----------------*/ void init(void) { //    /1: //CLKPR = (1&lt;&lt;CLKPCE); //CLKPR = (0&lt;&lt;CLKPS0)|(0&lt;&lt;CLKPS1)|(0&lt;&lt;CLKPS2)|(0&lt;&lt;CLKPS3); // : PORTD = 0x0; DDRD = 0x0; PORTB = 0x0; DDRB = 0xFF; // UART: UCSRA = 0x0; UCSRB = (1&lt;&lt;RXEN)|(1&lt;&lt;TXEN)|(0&lt;&lt;UCSZ2); UCSRC = (0&lt;&lt;UMSEL)|(0&lt;&lt;USBS)|(1&lt;&lt;UCSZ1)|(1&lt;&lt;UCSZ0); //UBRR = Fosc/16/BR - 1 UBRRH = 0x0; UBRRL = 23; //  UART- 19200 } void ir_tx(unsigned char data_ir) { /* RAW Pronto    Clean: 0000 0069 0000 0008 0071 0027 0023 0071 0023 0071 0023 0071 0071 0027 0023 0071 0023 0071 0023 030B  : 1: __________ 2862uS |988uS |_____ 0: _____ 887uS| 2862uS |__________    ~16870 uS */ int cnt,repeat; // : TCCR0B = (0&lt;&lt;CS12)|(0&lt;&lt;CS11)|(1&lt;&lt;CS10); //   f/1 TCCR1B = (0&lt;&lt;CS12)|(1&lt;&lt;CS11)|(1&lt;&lt;CS10); //   f/64 for (repeat=0;repeat&lt;10;repeat++) { for (cnt=0; cnt&lt;8; cnt++) { TCNT1=0; if (data_ir &amp; (0x80 &gt;&gt; cnt)) { // 1 while (TCNT1 &lt; 330) P_GEN; while (TCNT1 &lt; (330+114)) ; } else { // 0 while (TCNT1 &lt; 113) P_GEN; while (TCNT1 &lt; (330+114)) ; } } TCNT1=0; while (TCNT1 &lt; 1950) ; } } void tx_uart(unsigned char tx_data) { UDR = tx_data; while (!(UCSRA &amp; (1&lt;&lt;UDRE))); } void tx_help(void) { int sc; const unsigned char help1[] = "Use:CSDPWLRF &lt; &gt;"; for (sc=0;sc &lt; 23;sc++) { tx_uart(help1[sc]); } } /*-----------------&lt;  &gt;-----------------------*/ int main(void) { init(); for(;;) { while (!(UCSRA &amp; (1&lt;&lt;RXC))) ; //  status = UCSRA; data = UDR; switch (data) { case '+': PORTB |= (1&lt;&lt;PB6); break; case '-': PORTB &amp;= ~(1&lt;&lt;PB6); break; case 'c': case 'C': ir_tx(CLEAN); TX_LFCR break; case 's': case 'S': ir_tx(SPOT); TX_LFCR break; case 'd': case 'D': ir_tx(DOCK); TX_LFCR break; case 'p': case 'P': ir_tx(PAUSE); TX_LFCR break; case 'w': case 'W': ir_tx(POWER); TX_LFCR break; case 'l': case 'L': ir_tx(LEFT); TX_LFCR break; case 'r': case 'R': ir_tx(RIGHT); TX_LFCR break; case 'f': case 'F': ir_tx(FORWARD); TX_LFCR break; case '&lt;': ir_tx(FORWARD_LEFT); TX_LFCR break; case '&gt;': ir_tx(FORWARD_RIGHT); TX_LFCR break; default: tx_help(); TX_LFCR break; } } }</span></span></span></span></code> </pre><br></div></div><br>  Archive with the project: <a href="http://yadi.sk/d/gNuNWhuN2JEI2">Roomba_Remote_USB.zip</a> |  <a href="http://yadi.sk/d/ux1foI6t2JMOO">Separately hex file</a> <br>  Stitched the USBasp programmer using the avrdude utility. <br>  To flush the Fuse bits, run with the following parameters: <br><pre> <code class="bash hljs">avrdude -p t2313 -c usbasp -U lfuse:w:0xEC:m</code> </pre><br>  To flash the hex file: <br><pre> <code class="bash hljs">avrdude -p t2313 -c usbasp -U flash:w:./bin/Debug/Roomba_Remote.elf.hex</code> </pre><br>  To send a command, you need to type the corresponding character in the terminal: <br><table><tbody><tr><th>  Team </th><th>  Symbol </th></tr><tr><td>  LEFT </td><td>  L </td></tr><tr><td>  FORWARD </td><td>  F </td></tr><tr><td>  Right </td><td>  R </td></tr><tr><td>  Spot </td><td>  S </td></tr><tr><td>  DOCK </td><td>  D </td></tr><tr><td>  CLEAN </td><td>  C </td></tr><tr><td>  PAUSE </td><td>  P </td></tr><tr><td>  Power </td><td>  W </td></tr><tr><td>  FORWARD_LEFT </td><td>  &lt; </td></tr><tr><td>  FORWARD_RIGHT </td><td>  &gt; </td></tr></tbody></table><br>  There is one more undocumented function - see listing.  ;-) <br>  The controller responds to the correct command with a newline, to the incorrect short help. <br><br>  A small video demonstration of the work: <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/s_dgvPtBM7E%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700191,15700253&amp;usg=ALkJrhjsH6z5iYi4I87ky4yVbGw8tEOAQA" frameborder="0" allowfullscreen=""></iframe><br><br>  Now I am not satisfied with the range of work: you need to send the LED exactly to Roomb-y, and this is not very convenient.  In this connection, I am thinking of replacing the resistor R2 with a resistor with a lower rating, for example, 68 Ohm, or changing the IR LED. <br>  I am also thinking about a regular remote with buttons, and therefore there is a poll below. <br><br>  PS <br>  Spelling errors and design errors please report through the LAN. </div><p>Source: <a href="https://habr.com/ru/post/168033/">https://habr.com/ru/post/168033/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../168017/index.html">One and a half years of life under the sign of IT. As manager manager</a></li>
<li><a href="../168025/index.html">Mega: security review</a></li>
<li><a href="../168027/index.html">Tweetping - all tweets on the world map live</a></li>
<li><a href="../168029/index.html">Mactracker - encyclopedia of Apple devices</a></li>
<li><a href="../168031/index.html">Tail scaling</a></li>
<li><a href="../168035/index.html">Table with backlight for sealing boards</a></li>
<li><a href="../168037/index.html">By analyzing news, researchers can predict natural disasters.</a></li>
<li><a href="../168039/index.html">NooLite-2, or smart home for dummies</a></li>
<li><a href="../168049/index.html">Google agreed with French publishers for 60 million euros</a></li>
<li><a href="../168055/index.html">Announced the first smartphones based on Clover Trail and Lexington</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>