<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Caching in django</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In continuation of my article about templates, I want to tell you about the implementation of caching in Django. The main focus will be on caching par...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Caching in django</h1><div class="post__text post__text-html js-mediator-article">  In continuation of my <a href="http://habrahabr.ru/blog/django/39423.html">article</a> about templates, I want to tell you about the implementation of caching in Django.  The main focus will be on caching parts of the template - this question was raised <a href="http://habrahabr.ru/blog/php/38628.html">here</a> and was the reason for writing these two articles.  In the previous article I was too carried away with the description of the patterns themselves, so I will try to correct this. <br><br><a name="habracut"></a><br><br>  What is caching, and what benefits it gives under load, I think no need to explain to anyone.  (You can read the introductory words at the beginning of the relevant section of the Django documentation, the links are at the end of the article.) <br><ul><li>  whole site; </li><li>  specific page; </li><li>  plot template; </li><li>  some data. </li></ul><br>  Let us dwell on the implementation of this in Django. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Connect and configure </h3><br>  Setting up the caching mechanism in Django is very simple.  In the project settings file, you need to specify the <code>CACHE_BACKEND</code> variable containing cache storage parameters: where, how long and how much.  The following storage types are supported: <br><ul><li>  Memcached (including on another machine); </li><li>  database; </li><li>  file system; </li><li>  local memory. </li></ul><br>  The following cache options are supported: <br><ul><li>  <code>timeout</code> - cache update time, in seconds; </li><li>  <code>max_entries</code> - the maximum number of entries in the cache; </li><li>  <code>cull_frequency</code> is the percentage of old records that is deleted when <code>max_entries</code> . </li></ul><br>  The syntax is described in the documentation, and there is no point in repeating it. <br>  For those who have their own servers or the opportunity to allocate a couple of gigabytes of memory for the cache, I think this article will be of little interest.  Therefore, I will not describe storage in Memcached and local memory.  The choice between the database and the FS will give the reader.  How much faster one way or another I did not compare.  For myself, I chose the FS because  DB is already loaded. <br>  In addition, for ease of development, a ‚Äúdummy‚Äù repository is maintained, which actually does not store anything. <br><br><h3>  Retreat: production &amp; development version </h3><br>  I think it would be appropriate to describe the method of painlessly combining these two versions. <br>  The main Django project configuration file is <code>settings.py</code> .  I added two more files: <code>settings_dev.py</code> and <code>settings_pub.py</code> , and in <code>settings.py</code> wrote: <br><pre> import platform
 DEV_MODE = (platform.node ()! = 'Dpp.su')<font></font>
<font></font>
 if DEV_MODE:
	 DEBUG = True
	 from settings_dev import *
 else:
	 DEBUG = False
	 from settings_pub import *
</pre><br>  The platform.node function returns the name of the computer, and I compare it with the name of my server.  Perhaps you can come up with a more universal solution, but this is enough for me. <br>  Thus, the different settings I put into these files. <br>  In our case, the variable <code>CACHE_BACKEND</code> in <code>settings_dev.py</code> will be equal to <code>'dummy:///'</code> , and in <code>settings_pub.py</code> - <code>'file:///path/to/cache/'</code> <br><br><h3>  Caching the entire site </h3><br>  To cache the entire site, add <code>'django.middleware.cache.CacheMiddleware'</code> to the list <code>MIDDLEWARE_CLASSES</code> and the variable <code>CACHE_MIDDLEWARE_SECONDS</code> . <br>  All pages without parameters are cached. <br>  Read more in the documentation. <br><br><h3>  Page caching (view) </h3><br>  To cache a page, use the <code>cache_page</code> function: <br><pre> from django.views.decorators.cache import cache_page
 def cache_this (request):
	 ...
 cache_this = cache_page (cache_this, 60 * 15)
</pre><br>  You can also use it as a decorator: <br><pre> @cache_page (60 * 15)
 def cache_this (request):
	 ...
</pre><br>  The parameter is the cache refresh time in seconds. <br><br><h3>  Data caching </h3><br>  For caching data, the Django cache provides the expected functions: <code>set, get, delete</code> and a couple extras.  Cache settings are taken from the variable <code>CACHE_BACKEND</code> .  Details in the documentation. <br><br>  The previous part of the article mostly duplicated the Django documentation - specifically to show those unfamiliar with junga, but familiar with Habr that caching in Django does not require any effort from the programmer. <br><br><h2>  Template fragment caching </h2><br>  Caching parts of the template seems to me the most convenient to use.  For dynamic sites (read ‚Äúin general‚Äù) you cannot cache the entire page.  And in the template we cache only the section we need. <br>  First, in the template you need to connect the library of caching tags. <br><pre> {% load cache%}
</pre><br>  The cache tag takes two required parameters: the cache refresh time (in seconds) and the name of the cache to be cached. <br><pre> {% cache 500 sidebar%}
	 .. sidebar ..
 {% endcache%}
</pre><br>  In addition, you can pass any number of additional parameters to store multiple versions of the cache.  Examples may be different versions of the cache depending on the user name or on the page number when paginated by the data inside the block. <br><pre> {% cache 500 sidebar request.user.username%}
	 .. sidebar for logged in user ..
 {% endcache%}
 {% cache 500 sidebar page%}
	 .. content varies by page parameter ..
 {% endcache%}
</pre><br>  I will try to show clearly what happens at this and what advantages it gives us. <br>  Take an example from the previous article.  For the <code>blog/tag_index.htm</code> template, the following tree will be built (for color matching, see the previous article): <br><img width="339" height="338" src="https://habrastorage.org/getpro/habr/post_images/bf4/1d7/dda/bf41d7dda27adc6d5eaa3a52047f99c7.png" alt="Template block tree" hspace="10" vspace="10"><br>  What can I cache?  First of all, it is necessary to cache rarely changing data retrieved from the database. <br>  If we give the user the opportunity to change the information in the "basement" of the site, it is worth caching it - it changes very rarely. <br><pre> {% block footer%}
	 {% cache 5000 foot%}
		 {% block copyright%}
		 {% endblock%}
	 {% endcache%}
 {% endblock%}
</pre><br>  Looking closely at the examples of templates in the previous article, you can see that the second column (sidebar) does not change for all pages of the blog.  Since quite a few requests are executed to fill it (I have a list of tags, the number of articles for each tag, a list of recent articles), it is worth caching. <br><pre> {% block sidebar%}
	 {% cache 500 blog_sidebar%}
		 {% block tags%}
		 {% endblock%}
		 {% block recent%}
		 {% endblock%}
	 {% endcache%}
 {% endblock%}
</pre><br>  The list of articles also makes quite a lot of requests: you need to select articles depending on the page and for each article choose the corresponding tags. <br><pre> {% block content%}
	 {{tag.title}}
	 {{tag.text}}
	 {% cache 500 article_list tag.id page%}
		 {{block.super}}
	 {% endcache%}
 {% endblock%}
</pre><br>  We get the following picture: <br><img width="431" height="338" src="https://habrastorage.org/getpro/habr/post_images/aaf/d79/71c/aafd7971c717b8ef16b48facdc48ed1b.png" alt="Template block tree + caching" hspace="10" vspace="10"><br>  What happens when this page is requested? <br>  When constructing a tree, for each tag, the functions that construct it are called, which provide data for drawing.  It is at this point that requests are prepared in the database.  Requests themselves directly occur when accessing data due to their lazy nature in Django.  Then the template parser scans the tree and for each block calls the draw function.  In the case of a caching tag, tags embedded in it will be constructed and drawn only if the cache has not yet been created or is outdated. <br>  If you do not use tags (be lazy to ‚Äúproduce‚Äù tags for one request into the database), then all the data must be provided to the template itself.  Yes, due to the lazy nature of requests in Django, the difference is not very significant.  However, it turns out not very logical - the controller seems to have worked, but nobody used the results of its work.  You can even write a bunch of Python code in the expr tags inside the template itself - the cache doesn't care.  However, such ‚Äúviolations‚Äù of architecture are much more difficult to maintain.  And if another person wrote it ... working in a web-studio and supporting a bunch of websites, I was convinced. <br><br>  Now a comment on the <a href="http://habrahabr.ru/blog/php/38628.html">article</a> , which was the reason for writing all this. <br>  <a href="https://habrahabr.ru/users/dmmd/" class="user_link">dmmd</a> , in fact, you offer a rudimentary version of what is implemented in Django: tags and lazy requests to the database.  The essence remains the same, but the architecture of Django seems to me to be much more slender, obvious and, accordingly, easier to maintain. <br><br>  Links to official documentation: <br><ul><li>  <a href="http://www.djangoproject.com/documentation/cache/">djangodocs: Django's cache framework</a> </li><li>  <a href="http://www.djangobook.com/en/1.0/chapter13/">djangobook: Django's cache framework</a> </li><li>  <a href="http://cargo.caml.ru/djangobook/ch13.html">djangobook (translation): Caching</a> </li></ul><br><br>  PS: this is, as always, a reprint from my <a href="http://dpp.su/">blog.</a> </div><p>Source: <a href="https://habr.com/ru/post/23402/">https://habr.com/ru/post/23402/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../234009/index.html">mCube: a miniature accelerometer of a new type that can even turn clothes into a fitness tracker</a></li>
<li><a href="../23401/index.html">client side xslt conversion</a></li>
<li><a href="../234011/index.html">We make Oculus Rift a little better.</a></li>
<li><a href="../234017/index.html">Summer School of High Performance Computing in Biology and Medicine Available Online</a></li>
<li><a href="../234019/index.html">Led romb</a></li>
<li><a href="../234021/index.html">This video will be eternal or widely available to increase the capacity of the DVR (NVR / DVR)</a></li>
<li><a href="../234023/index.html">Google Project Tango: disassembling the "spatial tablet" from iFixit (4 out of 10 on the repair scale)</a></li>
<li><a href="../234027/index.html">How startups like Dropbox, Airbnb, Groupon and others got their first users.</a></li>
<li><a href="../234029/index.html">28 Curious Facts About Online Marketing</a></li>
<li><a href="../23403/index.html">Night photo for everyone</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>