<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience of using ‚Äúcoordinators‚Äù in a real ‚ÄúiOS‚Äù -project</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The world of modern programming is rich in trends, and for the world of programming ‚ÄúiOS‚Äù applications this is doubly true. I hope I am not much mista...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience of using ‚Äúcoordinators‚Äù in a real ‚ÄúiOS‚Äù -project</h1><div class="post__text post__text-html js-mediator-article">  The world of modern programming is rich in trends, and for the world of programming <a href="https://developer.apple.com/ios/">‚ÄúiOS‚Äù</a> applications this is doubly true.  I hope I am not much mistaken in asserting that one of the most ‚Äúfashionable‚Äù architectural patterns of recent years is the ‚Äúcoordinator‚Äù.  So, our team some time ago realized the overwhelming desire to try this technique on themselves.  Moreover, a very successful case has turned up - a significant change in logic and total re-planning of navigation in the application. <br><a name="habracut"></a><br><h2>  Problem </h2><br>  It often happens that controllers start taking on too much: ‚Äúgiving commands‚Äù directly to the <a href="https://developer.apple.com/documentation/uikit/uinavigationcontroller"><code>UINavigationController</code></a> that owns it, ‚Äúcommunicating‚Äù with their own ‚Äúbrothers‚Äù controllers (even initializing them and passing to the navigation stack) - in general, do a lot of things than they are not supposed to even suspect. <br><br>  One of the possible ways to avoid this is the ‚Äúcoordinator‚Äù.  And, as it turned out, it is quite easy to use and very flexible: the template is able to manage the navigation events of both small modules (representing perhaps only one screen) and the entire application (launching its ‚Äúflow‚Äù, relatively speaking, from <a href="https://developer.apple.com/documentation/uikit/uiapplicationdelegate"><code>UIApplicationDelegate</code></a> ). <br><br><h2>  Story </h2><br>  <a href="https://martinfowler.com/">Martin Fowler</a> in his book <a href="https://amazon.com/Patterns-Enterprise-Application-Architecture-Martin/dp/0321127420">‚ÄúPatterns of Enterprise Application Architecture‚Äù</a> called this pattern <a href="https://martinfowler.com/eaaCatalog/applicationController.html">‚ÄúApplication Controller‚Äù</a> .  And his first popularizer in the iOS environment is <a href="http://khanlou.com/">Sorush Khanlu</a> : it all started with <a href="https://vimeo.com/144116310">his</a> 2015 <a href="https://vimeo.com/144116310">NSSpain talk</a> .  Then a <a href="http://khanlou.com/2015/01/the-coordinator/">review article</a> appeared <a href="http://khanlou.com/2015/01/the-coordinator/">on his website</a> , which had several sequels (for example, <a href="http://khanlou.com/2015/10/coordinators-redux/">this</a> ). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And then many reviews followed (the ‚Äúios coordinators‚Äù request produces dozens of results of varying quality and degree of detail), including even a <a href="https://raywenderlich.com/158-coordinator-tutorial-for-ios-getting-started">guide on Ray Wenderlich</a> and <a href="https://hackingwithswift.com/articles/71/how-to-use-the-coordinator-pattern-in-ios-apps">an article from Paul Hudson on his ‚ÄúHacking with Swift‚Äù</a> in a series of materials on how to get rid of the problem "Massive" controller. <br><br>  Looking ahead, the most visible topic for discussion is the problem of the return button in the <code>UINavigationController</code> , the click on which is not handled by our code, and we can only get a <a href="https://en.wikipedia.org/wiki/Callback_(computer_programming)">callback</a> . <br><br>  Actually, why is this a problem?  Coordinators, like any objects, in order to exist in memory need to be owned by some other object.  As a rule, when building a navigation system with the help of coordinators, some coordinators generate others and keep a strong link on them.  Upon ‚Äúleaving the zone of responsibility‚Äù of the generated coordinator, control returns to the generating coordinator, and the memory occupied by the generated one must be released. <br><br>  Soroush has <a href="http://khanlou.com/2017/05/back-buttons-and-coordinators/">his own vision of solving this problem</a> , and also notes a couple of <a href="https://irace.me/navigation-coordinators">worthy</a> <a href="https://hackernoon.com/coordinators-routers-and-back-buttons-c58b021b32a">approaches</a> .  But we will come back to this. <br><br><h2>  First approach </h2><br>  <i>Before starting to show the real code, I would like to clarify that although the principles are fully consistent with those we came to the project, excerpts from the code and examples of its use are simplified and shortened where it does not interfere with their perception.</i> <br><br>  When we first started experimenting with the coordinators in the team, we did not have much time and freedom of action for this: it was necessary to reckon with the existing principles and navigation device.  The first implementation of the coordinators was based on a common ‚Äúrouter‚Äù that owns and manages the <code>UINavigationController</code> .  He can do everything with <a href="https://developer.apple.com/documentation/uikit/uiviewcontroller"><code>UIViewController</code></a> instances with respect to navigation - ‚Äúpush‚Äù / ‚Äúpop‚Äù, ‚Äúpresent‚Äù / ‚Äúdismiss‚Äù, plus manipulations with the <a href="https://developer.apple.com/documentation/uikit/uiwindow/1621581-rootviewcontroller">‚Äúroot‚Äù controller</a> .  An example of the interface of such a router: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> UIKit protocol Router { func present(_ module: UIViewController, animated: Bool) func dismissModule(animated: Bool, completion: (() -&gt; Void)?) func push(_ module: UIViewController, animated: Bool, completion: (() -&gt; Void)?) func popModule(animated: Bool) func setAsRoot(_ module: UIViewController) func popToRootModule(animated: Bool) }</code> </pre> <br>  The concrete implementation is initialized with the <code>UINavigationController</code> instance and does not contain anything particularly tricky in itself.  The only restriction is that other instances of <code>UINavigationController</code> cannot be passed as interface argument values ‚Äã‚Äã(for obvious reasons: <code>UINavigationController</code> cannot contain <code>UINavigationController</code> in its stack ‚Äî this is a <a href="https://developer.apple.com/documentation/uikit"><code>UIKit</code></a> constraint). <br><br>  The coordinator, like any object, needs an owner ‚Äî another object that will hold a link to it.  The link to the root can be stored by the object generating it, but each coordinator can also generate other coordinators.  Therefore, a basic interface was written to provide a mechanism for managing the generated coordinators: <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Coordinator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> childCoordinators = [<span class="hljs-type"><span class="hljs-type">Coordinator</span></span>]() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dependency coordinator: Coordinator)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... } func remove(dependency coordinator: Coordinator) { // ... } }</span></span></code> </pre> <br>  One of the implied merits of coordinators is the encapsulation of knowledge about specific subclasses of <code>UIViewController</code> .  To ensure the interaction of the router and coordinators, we introduced the following interface: <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Presentable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">presented</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">UIViewController</span></span> }</code> </pre> <br>  Then each specific coordinator should inherit from the <code>Coordinator</code> and implement the <code>Presentable</code> interface, and the router interface should take the following form: <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Router</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">present</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> module: Presentable, animated: Bool)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dismissModule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(animated: Bool, completion: </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span></span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>)?) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> module: Presentable, animated: Bool, completion: </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span></span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>)?) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">popModule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(animated: Bool)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setAsRoot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> module: Presentable)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">popToRootModule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(animated: Bool)</span></span></span></span> }</code> </pre> <br>  (The <code>Presentable</code> approach also allows coordinators to be used inside modules that are written to interact directly with <code>UIViewController</code> instances without exposing them (modules) to cardinal processing.) <br><br>  A brief example of this is all about: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FirstCoordinator</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Coordinator</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Presentable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">presented</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">UIViewController</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">UIViewController</span></span>() } } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SecondCoordinator</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Coordinator</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Presentable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">presented</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">UIViewController</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">UIViewController</span></span>() } } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> nc = <span class="hljs-type"><span class="hljs-type">UINavigationController</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> router = <span class="hljs-type"><span class="hljs-type">RouterImpl</span></span>(navigationController: nc) <span class="hljs-comment"><span class="hljs-comment">// Router implementation. router.setAsRoot(FirstCoordinator()) router.push(SecondCoordinator(), animated: true, completion: nil) router.popToRootModule(animated: true)</span></span></code> </pre> <br><h2>  Next approximation </h2><br>  Then one day the moment of a total rework of navigation and absolute freedom of expression!  The moment when nothing prevented trying to implement navigation on the coordinators using the cherished <code>start()</code> method - a version that captivated initially with its simplicity and brevity. <br><br>  The capabilities of the <code>Coordinator</code> mentioned above will obviously not be redundant.  But to the common interface, you need to add the same method: <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Coordinator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dependency coordinator: Coordinator)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dependency coordinator: Coordinator)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseCoordinator</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Coordinator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> childCoordinators = [<span class="hljs-type"><span class="hljs-type">Coordinator</span></span>]() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dependency coordinator: Coordinator)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... } func remove(dependency coordinator: Coordinator) { // ... } func start() { } }</span></span></code> </pre> <br>  <a href="https://apple.com/swift/">‚ÄúSwift‚Äù</a> does not offer the possibility to declare abstract classes (since it is more oriented towards the protocol-oriented approach than the more classical, <a href="https://en.wikipedia.org/wiki/Object-oriented_programming">object-oriented</a> ), therefore the <code>start()</code> method can be either left with an empty implementation or shoved there is something like <a href="https://developer.apple.com/documentation/swift/1538698-fatalerror"><code>fatalError(_:file:line:)</code></a> (forcing the method to override this method by successors).  Personally, I prefer the first option. <br><br>  But Swift has a great opportunity to add default protocol implementation methods, so the first thought, of course, was not to declare the base class, but to do something like this: <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Coordinator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dependency coordinator: Coordinator)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... } func remove(dependency coordinator: Coordinator) { // ... } }</span></span></code> </pre> <br>  But protocol extensions cannot declare stored fields, and the implementation of these two methods obviously must be based on a private stored type property. <br><br>  The basis of any particular coordinator will look like this: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeCoordinator</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseCoordinator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... } }</span></span></code> </pre> <br>  Any dependencies that are necessary for the functioning of the coordinator can be added to the initializer.  As a typical case, an instance of <code>UINavigationController</code> . <br><br>  If it is the root coordinator whose responsibility is to display the root <code>UIViewController</code> , the coordinator can, for example, accept a new instance of <code>UINavigationController</code> with an empty stack. <br><br>  Inside himself, the coordinator during event processing (about this later) can pass this <code>UINavigationController</code> on to other coordinators, which it spawns.  And they can also do with the current state of navigation what they need: ‚Äúpush‚Äù, ‚Äúpresent‚Äù, and at least replace the entire navigation stack. <br><br><h3>  Possible interface improvements </h3><br>  As it turned out later, not every coordinator will generate other coordinators, therefore not all of them should depend on such a base class.  Therefore, one of the colleagues from the adjacent team offered to get rid of inheritance and introduce the dependency manager interface as an external dependency: <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CoordinatorDependencies</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dependency coordinator: Coordinator)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dependency coordinator: Coordinator)</span></span></span></span> } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultCoordinatorDependencies</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CoordinatorDependencies</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> dependencies = [<span class="hljs-type"><span class="hljs-type">Coordinator</span></span>]() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dependency coordinator: Coordinator)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... } func remove(dependency coordinator: Coordinator) { // ... } } final class SomeCoordinator: Coordinator { private let dependencies: CoordinatorDependencies init(dependenciesManager: CoordinatorDependencies = DefaultCoordinatorDependencies()) { dependencies = dependenciesManager } func start() { // ... } }</span></span></code> </pre> <br><h3>  Handle user generated events </h3><br>  Well, the coordinator created and somehow initiated a new mapping.  Most likely, the user looks at the screen and sees a certain set of visual elements with which he can interact: buttons, text fields, etc. Some of them provoke navigation events, and they should be managed by the coordinator who generated this controller.  To solve this problem, we use traditional <a href="https://en.wikipedia.org/wiki/Delegation_pattern">delegation</a> . <br><br>  Suppose there is a subclass of <code>UIViewController</code> : <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeViewController</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIViewController</span></span></span><span class="hljs-class"> </span></span>{ }</code> </pre> <br>  And the coordinator, who adds it to the stack: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeCoordinator</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Coordinator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> dependencies: <span class="hljs-type"><span class="hljs-type">CoordinatorDependencies</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> navigationController: <span class="hljs-type"><span class="hljs-type">UINavigationController?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(navigationController: <span class="hljs-type"><span class="hljs-type">UINavigationController</span></span>, dependenciesManager: <span class="hljs-type"><span class="hljs-type">CoordinatorDependencies</span></span> = <span class="hljs-type"><span class="hljs-type">DefaultCoordinatorDependencies</span></span>()) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.navigationController = navigationController dependencies = dependenciesManager } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> vc = <span class="hljs-type"><span class="hljs-type">SomeViewController</span></span>() navigationController?.pushViewController(vc, animated: <span class="hljs-literal"><span class="hljs-literal">true</span></span>) } }</code> </pre> <br>  We delegate to the same coordinator the handling of the corresponding controller events.  Here, in fact, the classical scheme is used: <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeViewControllerRoute</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSomeEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeViewController</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIViewController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> route: <span class="hljs-type"><span class="hljs-type">SomeViewControllerRoute?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(route: <span class="hljs-type"><span class="hljs-type">SomeViewControllerRoute</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.route = route <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(nibName: <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, bundle: <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">required</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>?(coder aDecoder: <span class="hljs-type"><span class="hljs-type">NSCoder</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">fatalError</span></span>(<span class="hljs-string"><span class="hljs-string">"init(coder:) has not been implemented"</span></span>) } <span class="hljs-meta"><span class="hljs-meta">@IBAction</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buttonAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { route?.onSomeEvent() } } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeCoordinator</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Coordinator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> dependencies: <span class="hljs-type"><span class="hljs-type">CoordinatorDependencies</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> navigationController: <span class="hljs-type"><span class="hljs-type">UINavigationController?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(navigationController: <span class="hljs-type"><span class="hljs-type">UINavigationController</span></span>, dependenciesManager: <span class="hljs-type"><span class="hljs-type">CoordinatorDependencies</span></span> = <span class="hljs-type"><span class="hljs-type">DefaultCoordinatorDependencies</span></span>()) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.navigationController = navigationController dependencies = dependenciesManager } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> vc = <span class="hljs-type"><span class="hljs-type">SomeViewController</span></span>(route: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) navigationController?.pushViewController(vc, animated: <span class="hljs-literal"><span class="hljs-literal">true</span></span>) } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeCoordinator</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeViewControllerRoute</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSomeEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... } }</span></span></code> </pre> <br><h3>  Handling the return button </h3><br>  Another <a href="https://hackingwithswift.com/articles/175/advanced-coordinator-pattern-tutorial-ios">good overview of the architectural template under discussion was published by Paul Hudson on his website Hacking with Swift</a> , one might even say, a manual.  It also contains a simple, straightforward explanation of one of the possible solutions to the above mentioned return button problem: the coordinator (if necessary) declares himself a delegate of the <code>UINavigationController</code> instance passed to him and tracks the event of interest to us. <br><br>  This approach has a small flaw: the delegate of <code>UINavigationController</code> can only be the successor of <a href="https://developer.apple.com/documentation/objectivec/nsobject"><code>NSObject</code></a> . <br><br>  So, there is a coordinator who spawns another coordinator.  This, another one, on the <code>start()</code> call, adds a <code>UIViewController</code> to the <code>UINavigationController</code> stack.  By clicking on the back button on the <a href="https://developer.apple.com/documentation/uikit/uinavigationbar"><code>UINavigationBar</code></a> all that needs to be done is to let the originating coordinator know that the generated coordinator has finished its work (flow).  To do this, we have introduced another delegation tool: each delegate is assigned a delegate whose interface is implemented by the originating coordinator: <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CoordinatorFlowListener</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onFlowFinished</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(coordinator: Coordinator)</span></span></span></span> } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainCoordinator</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Coordinator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> dependencies: <span class="hljs-type"><span class="hljs-type">CoordinatorDependencies</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> navigationController: <span class="hljs-type"><span class="hljs-type">UINavigationController</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(navigationController: <span class="hljs-type"><span class="hljs-type">UINavigationController</span></span>, dependenciesManager: <span class="hljs-type"><span class="hljs-type">CoordinatorDependencies</span></span> = <span class="hljs-type"><span class="hljs-type">DefaultCoordinatorDependencies</span></span>()) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.navigationController = navigationController dependencies = dependenciesManager <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> someCoordinator = <span class="hljs-type"><span class="hljs-type">SomeCoordinator</span></span>(navigationController: navigationController, flowListener: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) dependencies.add(someCoordinator) someCoordinator.start() } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainCoordinator</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CoordinatorFlowListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onFlowFinished</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(coordinator: Coordinator)</span></span></span></span> { dependencies.remove(coordinator) <span class="hljs-comment"><span class="hljs-comment">// ... } } final class SomeCoordinator: NSObject, Coordinator { private weak var flowListener: CoordinatorFlowListener? private weak var navigationController: UINavigationController? init(navigationController: UINavigationController, flowListener: CoordinatorFlowListener) { self.navigationController = navigationController self.flowListener = flowListener } func start() { // ... } } extension SomeCoordinator: UINavigationControllerDelegate { func navigationController(_ navigationController: UINavigationController, didShow viewController: UIViewController, animated: Bool) { guard let fromVC = navigationController.transitionCoordinator?.viewController(forKey: .from) else { return } if navigationController.viewControllers.contains(fromVC) { return } if fromVC is SomeViewController { flowListener?.onFlowFinished(coordinator: self) } } }</span></span></code> </pre> <br>  In the example above, the <code>MainCoordinator</code> does nothing: it simply launches the ‚Äúflow‚Äù of another coordinator - in real life, of course, it is useless.  In our application, the <code>MainCoordinator</code> receives data from outside, according to which it determines the state of the application - authorized, unauthorized, etc.  - and what kind of screen you need to show.  Depending on this, it launches the flow of the corresponding coordinator.  If the child coordinator has finished his work, the main coordinator receives a signal about this through the <code>CoordinatorFlowListener</code> and, say, starts the flow of another coordinator. <br><br><h2>  Conclusion </h2><br>  The surviving solution, of course, has a number of drawbacks (like any solution to any problem). <br><br>  Yes, you have to use a lot of delegation, but it is simple and has a common direction: from the generator to the generator (from the controller to the coordinator, from the generated coordinator to the generator). <br><br>  Yes, in order to be saved from memory leaks, you have to add a <code>UINavigationController</code> delegate method to each coordinator with a nearly identical implementation.  (The first approach lacks this disadvantage, but instead more generously shares its internal knowledge of the appointment of a specific coordinator.) <br><br>  But the biggest drawback of this approach is that, in real life, the coordinators, unfortunately, will know a little more about the world around them than we would like.  More precisely, they will have to add elements of logic, depending on external conditions, about which the coordinator is not directly informed.  Basically, this is, in fact, what happens by calling the <code>start()</code> method or by calling <code>onFlowFinished(coordinator:)</code> .  And anything can happen in these places, and this will always be ‚Äúhardcoded‚Äù behavior: adding a controller to the stack, replacing the stack, returning to the root controller - whatever.  And it all depends not on the competencies of the current controller, but on the external conditions. <br><br>  Nevertheless, the code turns out to be ‚Äúcute‚Äù and concise, working with it is really nice, and navigation is traced by code much easier.  It seemed to us that, with the mentioned defects, being aware of them, it is quite possible to exist. <br><blockquote>  Thank you for reading this place!  Hope to learn something useful for yourself.  And if you suddenly want "more than me", then here is a <a href="https://twitter.com/lazarevzubov">link to my Twitter</a> . </blockquote></div><p>Source: <a href="https://habr.com/ru/post/444038/">https://habr.com/ru/post/444038/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../444026/index.html">MODX Digest # 1 (February 25 - March 11, 2019)</a></li>
<li><a href="../444030/index.html">Chinese online retailer Gearbest has made public a database of millions of customers' personal data.</a></li>
<li><a href="../444032/index.html">Why a 3D printer is not a printer</a></li>
<li><a href="../444034/index.html">7 deadly sins manager</a></li>
<li><a href="../444036/index.html">Accelerate C / C ++ file I / O without straining too much</a></li>
<li><a href="../444040/index.html">Autocentric ranking. Yandex's report on finding a relevant audience for Zen authors</a></li>
<li><a href="../444044/index.html">In Europe will be processed iron data center</a></li>
<li><a href="../444050/index.html">Discussion: Will DNA Store Mass?</a></li>
<li><a href="../444056/index.html">Internet providers in Crimea sharply increased prices for services</a></li>
<li><a href="../444058/index.html">When children realize that their whole life is already online</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>