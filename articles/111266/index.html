<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Intercepting system calls with ptrace</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ptrace (from process trace) is a system call in some unix-like systems (including Linux, FreeBSD, Max OS X), which allows you to trace or debug a sele...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Intercepting system calls with ptrace</h1><div class="post__text post__text-html js-mediator-article">  <b>ptrace</b> (from process trace) is a system call in some unix-like systems (including Linux, FreeBSD, Max OS X), which allows you to trace or debug a selected process.  We can say that ptrace gives you complete control over the process: you can change the course of the program, watch and change values ‚Äã‚Äãin memory or state of registers.  It is worth mentioning that we do not get any additional rights in this case - the possible actions are limited to the rights of the running process.  In addition, when tracing a program with a setuid bit, this bit itself does not work - privileges are not raised. <br><br>  The article will show how to intercept system calls on the example of Linux. <br><a name="habracut"></a><br><h4>  1. A little about ptrace </h4><br>  Here is the prototype of the ptrace function: <br><blockquote><code><font color="black">#include &lt;sys/ptrace.h&gt; <br> <font color="#0000ff">long</font> ptrace( <font color="#0000ff">enum</font> __ptrace_request request, pid_t pid, <font color="#0000ff">void</font> *addr, <font color="#0000ff">void</font> *data);</font></code> </blockquote> <ul><li>  <b>request</b> is an action that needs to be performed, for example PTRACE_CONT, PTRACE_PEEKTEXT </li><li>  <b>pid</b> - tracer process identifier </li><li>  <b>addr</b> and <b>data</b> depend on <b>request</b> 'a </li></ul>  You can start a trace in two ways: attach to an already running process (PTRACE_ATTACH), or start it yourself using PTRACE_TRACEME.  We will consider the second case, it is a little bit simpler, but the essence is the same.  You can use the following arguments to control the trace: <br><ul><li>  PTRACE_SINGLESTEP - step-by-step program execution, control will be transferred after the execution of each instruction;  such tracing is slow enough </li><li>  PTRACE_SYSCALL - continue program execution until entering or exiting a system call </li><li>  PTRACE_CONT - just continue the program </li></ul>  For more information - <i>man ptrace</i> . <br><br><h4>  2. View system calls </h4><br>  Let's write a program to display a list of system calls used by the program (a simple analogue of the strace utility). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, first you need to make a <b>fork</b> - the parent process will debug the child: <br><br><blockquote> <code><font color="black"><font color="#0000ff">int</font> main( <font color="#0000ff">int</font> argc, <font color="#0000ff">char</font> *argv[]) { <br> pid_t pid = fork(); <br> <font color="#0000ff">if</font> (pid) <br> parent(pid); <br> <font color="#0000ff">else</font> <br> child(); <br> <font color="#0000ff">return</font> 0; <br> }</font></code> </blockquote> <br>  In the child process, everything is simple - we start the trace with PTRACE_TRACEME and run the necessary program: <br><br><blockquote> <code><font color="black"><font color="#0000ff">void</font> child() { <br> ptrace(PTRACE_TRACEME, 0, 0, 0); <br> execl( <font color="#A31515">"/bin/echo"</font> , <font color="#A31515">"/bin/echo"</font> , <font color="#A31515">"Hello, world!"</font> , NULL); <br> perror( <font color="#A31515">"execl"</font> ); <br> }</font></code> </blockquote> <br>  When <b>execl is</b> executed <b>, the</b> traced process will stop, passing its new state to its parent.  Therefore, the parent process must first wait for the program to start using <b>waitpid</b> (you can just <b>wait</b> , since the child process is only one): <br><br><blockquote> <code><font color="black"><font color="#0000ff">int</font> status; <br> waitpid(pid, &amp;status, 0);</font></code> </blockquote> <br>  In order to somehow distinguish between system calls and other stops (for example, SIGTRAP), a special parameter PTRACE_O_TRACESYSGOOD is provided - when stopped on a system call, the parent process will receive the status <b>SIGTRAP |</b>  <b>0x80</b> : <br><br><blockquote> <code><font color="black">ptrace(PTRACE_SETOPTIONS, pid, 0, PTRACE_O_TRACESYSGOOD);</font></code> </blockquote> <br>  Now you can loop through PTRACE_SYSCALL before exiting the program, and watch the value of the <b>eax</b> register to determine the system call number.  For this we use PTRACE_GETREGS.  It should be noted that the <b>eax</b> register is replaced at the moment of stopping, and therefore it is necessary to use the saved <b>state.orig_eax</b> : <br><br><blockquote> <code><font color="black"><font color="#0000ff">while</font> (!WIFEXITED(status)) { <br> <br> <font color="#0000ff">struct</font> user_regs_struct state; <br> <br> ptrace(PTRACE_SYSCALL, pid, 0, 0); <br> waitpid(pid, &amp;status, 0); <br> <br> <font color="#008000">// at syscall</font> <br> <font color="#0000ff">if</font> (WIFSTOPPED(status) &amp;&amp; WSTOPSIG(status) &amp; 0x80) { <br> ptrace(PTRACE_GETREGS, pid, 0, &amp;state); <br> printf( <font color="#A31515">"SYSCALL %d at %08lx\n"</font> , state.orig_eax, state.eip); <br> <br> <font color="#008000">// skip after syscall</font> <br> ptrace(PTRACE_SYSCALL, pid, 0, 0); <br> waitpid(pid, &amp;status, 0); <br> } <br> <br> }</font></code> </blockquote> <br>  Running the program, we will see something like this: <br><br><blockquote> <code><font color="black">... <br> SYSCALL 6 at b783a430 <br> SYSCALL 197 at b783a430 <br> SYSCALL 192 at b783a430 <br> SYSCALL 4 at b783a430 <br> Hello, world! <br> SYSCALL 6 at b783a430 <br> SYSCALL 91 at b783a430 <br> SYSCALL 6 at b783a430 <br> SYSCALL 252 at b783a430</font></code> </blockquote> <br>  As you can see, after the system call number 4 (and this is <b>sys_write</b> ), our text is displayed. <br><br><h4>  3. Intercept system call </h4><br>  Now let's try to intercept the call and do something good.  The <b>write</b> system call looks like this: <br><br><blockquote> <code><font color="black">write(fd, buf, n);</font></code> </blockquote> <ul><li>  ebx: fd - file descriptor (number) </li><li>  ecx: buf - a pointer to text to display </li><li>  edx: n - number of bytes </li></ul>  To replace the text, use PTRACE_POKETEXT: <br><br><blockquote> <code><font color="black"><font color="#008000">// sys_write</font> <br> <font color="#0000ff">if</font> (state.orig_eax == 4) { <br> <font color="#0000ff">char</font> * text = ( <font color="#0000ff">char</font> *)state.ecx; <br> ptrace(PTRACE_POKETEXT, pid, ( <font color="#0000ff">void</font> *)(text+7), 0x72626168); <font color="#008000">//habr</font> <br> ptrace(PTRACE_POKETEXT, pid, ( <font color="#0000ff">void</font> *)(text+11), 0x00000a21); <font color="#008000">//!\n</font> <br> }</font></code> </blockquote> <br>  Run, and ... <br><br><blockquote> <code><font color="black">... <br> SYSCALL 6 at 00556416 <br> SYSCALL 197 at 00556416 <br> SYSCALL 192 at 00556416 <br> SYSCALL 4 at 00556416 <br> Hello, habr! <br> SYSCALL 6 at 00556416 <br> SYSCALL 91 at 00556416 <br> SYSCALL 6 at 00556416 <br> SYSCALL 252 at 00556416</font></code> </blockquote> <br>  Thus, we intercepted the <b>sys_write</b> system call in the <b>/ bin / echo</b> program to display our text.  This is just a simple example of using ptrace.  With it, you can also easily make memory dumps (this, by the way, helps a lot with solving Linux cracks), set breakpoints (using PTRACE_SINGLESTEP or replacing instructions with 0xCC), analyze registers / variables and much more.  <b>ptrace is</b> very useful, for example, when you can‚Äôt quickly get to the problem area of ‚Äã‚Äãthe code - if you have to jump, replace data in the debugger, and then the program dies and you have to do everything anew;  if you write a program for debugging with ptrace, all these actions need to be described only once, and they will be performed automatically.  Of course, in some debuggers you can write scripts - but they are probably inferior in capabilities. <br><br>  <b>UPD:</b> forgot to post the full <a href="">source</a> <br><br><h4>  4. What to read </h4><br>  <a href="http://linux.die.net/man/2/ptrace">man ptrace</a> <br>  <a href="http://linux.die.net/man/2/wait">man wait</a> <br>  <a href="http://www.linuxjournal.com/node/6100">Playing with ptrace, part I</a> <br>  <a href="http://www.linuxjournal.com/node/6210">Playing with ptrace, part II</a> <br>  <a href="http://bluemaster.iu.hio.no/edu/dark/lin-asm/syscalls.html">syscalls table</a> </div><p>Source: <a href="https://habr.com/ru/post/111266/">https://habr.com/ru/post/111266/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../111259/index.html">10 years of practice. Part 2: Resources</a></li>
<li><a href="../111261/index.html">Why is Opera not worldwide popular?</a></li>
<li><a href="../111262/index.html">"The escape"</a></li>
<li><a href="../111264/index.html">Drupal Forms API. Part 1 - for Drupal 6</a></li>
<li><a href="../111265/index.html">Organization of team development of database structures</a></li>
<li><a href="../111267/index.html">Zappos.com: How to earn $ 1 billion on shoes?</a></li>
<li><a href="../111268/index.html">Creating a non-blocking TCP server using OTP principles</a></li>
<li><a href="../111270/index.html">Animation in Google Docs</a></li>
<li><a href="../111271/index.html">Lexicon for the market of advanced tactile technology</a></li>
<li><a href="../111272/index.html">Programming on the machine Post</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>