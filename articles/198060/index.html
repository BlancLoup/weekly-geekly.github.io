<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>VirtualDub Check</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Just now, I sat down and checked the VirtualDub project with PVS-Studio. The choice was random. I think the most important thing is to regularly check...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>VirtualDub Check</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/4a0/517/cc2/4a0517cc2eed1c6f75175563320a3169.jpg" alt="PVS-Studio, VirtualDub"><br>  Just now, I sat down and checked the VirtualDub project with PVS-Studio.  The choice was random.  I think the most important thing is to regularly check / recheck various projects to show how the PVS-Studio code analyzer is developing.  And what project will be tested is not so important.  Errors are everywhere.  We already checked the VirtualDub project in 2011, but then almost nothing interesting was found.  So I decided to see how things are, after 2 years. <br><br><a name="habracut"></a><br><br>  I downloaded the VirtualDub-1.10.3-src.7z archive from the <a href="http://www.viva64.com/go.php%3Furl%3D1307">VirtualDub</a> website.  For analysis, I used <a href="http://www.viva64.com/ru/pvs-studio-download/">PVS-Studio</a> version 5.10.  I spent about an hour on the analysis, so do not judge strictly.  Surely, I missed something.  Conversely, he could consider the correct code as suspicious.  I ask those who support the VirtualDub project not to rely on my report, but to make an independent verification.  We always <a href="http://www.viva64.com/ru/b/0193/">go to the</a> open-source community and are ready to allocate the registration key. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I also want to ask Avery Lee to treat this article with understanding.  Last time, he <a href="http://www.viva64.com/go.php%3Furl%3D756">very painfully</a> perceived the mention of VirtualDub in one of my articles.  I didn‚Äôt want to, and I don‚Äôt want to say that any program is buggy.  <a href="http://www.viva64.com/ru/examples/">Software bugs are everywhere</a> .  My goal is to show the benefits that static code analysis can provide.  Along the way, this will make open-source projects a bit more reliable.  It is wonderful. <br><br>  Of course, one-time checks are ineffective.  But with this, unfortunately, I can not do anything.  Using or not using regular static analysis tools depends on the developers.  I can only try to explain the benefits of regular use.  Here is one of the interesting notes on this topic: <a href="http://www.viva64.com/ru/b/0105/">Leo Tolstoy and static code analysis</a> . <br><br>  However, this article is about errors, but not the methodology of using static analysis.  Let's see what new interesting things the PVS-Studio analyzer found in VirtualDub. <br><br><h2>  Virtual Destructors </h2><br>  In the C ++ programming language, the destructor of a polymorphic base class must be declared virtual.  This is the only way to ensure the correct destruction of the derived class object through a pointer to the corresponding base class. <br><br>  I know everyone knows that.  However, this does not prevent to forget to declare the destructor virtual. <br><br>  VirtualDub has a class VDDialogBaseW32: <br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VDDialogBaseW32</span></span></span><span class="hljs-class"> {</span></span> .... ~VDDialogBaseW32(); .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> INT_PTR </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DlgProc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PreNCDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; .... }</code> </pre> <br>  As you can see, it contains virtual functions.  However, the destructor is not declared virtual.  Naturally, he inherited his classes.  For example, VDDialogAudioFilterFormatConvConfig: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VDDialogAudioFilterFormatConvConfig</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> VDDialogBaseW32 { .... };</code> </pre> <br>  Error deleting an object looks like this: <br><pre> <code class="cpp hljs">INT_PTR CALLBACK VDDialogBaseW32::StaticDlgProc(....) { VDDialogBaseW32 *pThis = (VDDialogBaseW32 *)GetWindowLongPtr(hwnd, DWLP_USER); .... <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> pThis; .... }</code> </pre> <br>  A warning issued by PVS-Studio: VDDialogBaseW32 class contains virtual functions.  VirtualDub gui.cpp 997 <br><br>  As you can see, the pointer to the base class is used to destroy the object.  Such an object deletion will lead to undefined program behavior. <br><br>  A similar problem exists with the VDMPEGAudioPolyphaseFilter class. <br><br><h2>  More about undefined behavior </h2><br>  There are no questions about errors related to virtual destructor.  A much more slippery topic is shift operations.  Here is one such example: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> AVIVideoGIFOutputStream::write(....) { { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;palsize; ++i) dict[i].mPrevAndLastChar = (<span class="hljs-number"><span class="hljs-number">-1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">16</span></span>) + i; .... }</code> </pre> <br>  One may argue that this is a completely reliable code that has been used successfully for more than 10 years.  However, all the same, here we are dealing with an undefined program behavior.  Here is what the standard says about such constructions: <br><br>  <i>The shift operators &lt;&lt; and &gt;&gt; group left-to-right.</i> <br><br>  <i>shift-expression &lt;&lt; additive-expression</i> <br><br>  <i>shift-expression &gt;&gt; additive-expression</i> <br><br>  <i>This is an integral part of this article.</i> <br><br>  <i>1. The promoted left operand.</i>  <i>If you are the right operand.</i> <br><br>  <i>2. The value of E1 &lt;&lt; E2 is E1 left-shifted E2 bit positions;</i>  <i>vacated bits are zero-filled.</i>  <i>If it is an unsigned pattern, it can be reduced to a minimum.</i>  <b><i>Otherwise, if it is a non-negative value, and if it is an E1 * 2 ^ E2, it is a representation of the result;</i></b>  <b><i>otherwise, the behavior is undefined.</i></b> <br><br>  <i>3. The value of E1 &gt;&gt; E2 is E1 right-shifted E2 bit positions.</i>  <i>It is an insignia of the E1 / 2 ^ E2</i> <b><i>.</i></b>  <b><i>If E1 has a signed value</i></b> <br><br>  The fact that the code works is luck.  When mastering a new compiler or other keys for optimization, the program may unexpectedly change its behavior.  You can read more about shifts and whether or not to edit the code, in the article " <a href="http://www.viva64.com/ru/b/0142/">Without knowing the ford, do not climb into the water. Part Three</a> ". <br><br>  Here is the complete <a href="http://www.viva64.com/external-pictures/txt/VirtualDub-ub.txt">list of places</a> where the PVS-Studio analyzer detected Undefined behavior or Unspecified behavior in the VirtualDub project. <br><br><h2>  Typos </h2><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ModuleInfo *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CrashGetModules</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *&amp;ptr)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(*pszHeap++); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pszHeap[<span class="hljs-number"><span class="hljs-number">-1</span></span>]==<span class="hljs-string"><span class="hljs-string">'.'</span></span>) period = pszHeap<span class="hljs-number"><span class="hljs-number">-1</span></span>; .... }</code> </pre> <br>  Diagnostic message issued by PVS-Studio: V529 Odd semicolon ';'  after 'while' operator.  VirtualDub crash.cpp 462 <br><br>  Notice the semicolon after the 'while'.  Here either the error or the code is incorrectly formatted.  I think this is a mistake.  The cycle ‚Äúwhile (* pszHeap ++);‚Äù will pass to the end of the line and as a result, the variable 'pszHeap' will point to memory <a href="http://www.viva64.com/ru/t/0088/">after the terminal zero</a> .  The ‚Äúif (pszHeap [-1] == '.')‚Äù Check does not make sense.  At the address ‚ÄúpszHeap [-1]‚Äù there is always a terminal zero. <br><br>  Consider another typo when working with strings. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> VDBackfaceService::Execute(...., <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *s) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*s == <span class="hljs-string"><span class="hljs-string">'"'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(*s &amp;&amp; *s != <span class="hljs-string"><span class="hljs-string">'"'</span></span>) ++s; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { .... }</code> </pre> <br>  Diagnostic message issued by PVS-Studio: V637 Two opposite conditions were encountered.  The second condition is always false.  Check lines: 183, 184. VirtualDub backface.cpp 183 <br><br>  This code should skip everything in quotes.  At least, I think so.  However, the condition (* s &amp;&amp; * s! = '"') Is immediately false. Perhaps the code should look like this: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*s == <span class="hljs-string"><span class="hljs-string">'"'</span></span>) { ++s; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(*s &amp;&amp; *s != <span class="hljs-string"><span class="hljs-string">'"'</span></span>) ++s; }</code> </pre> <br><h2>  The new operator generates exceptions for memory allocation errors. </h2><br>  In the old code, it is often possible to meet the check that returned the new operator.  It looks like this: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *p = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">10</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!p) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;</code> </pre> <br>  Modern compilers that support the C ++ standard of the language should throw an exception if memory could not be allocated.  It is possible to make the 'new' operator not generate exceptions, but this has nothing to do with the cases under consideration. <br><br>  Thus, if (! P) is an extra check.  In general, such a code is harmless.  Excess check.  Nothing wrong. <br>  However, the old code can lead to unpleasant consequences.  Consider a fragment from the project VirtualDub. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> HexEditor::Find(HWND hwndParent) { .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *next = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[nFindLength+<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *searchbuffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[<span class="hljs-number"><span class="hljs-number">65536</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *revstring = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[nFindLength]; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!next || !searchbuffer || !revstring) { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>[] next; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>[] searchbuffer; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>[] revstring; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } .... }</code> </pre> <br>  Diagnostic message issued by PV-Studio: V668: it was not using the 'new' operator.  The exception will be generated in the case of memory allocation error.  VirtualDub hexviewer.cpp 2012 <br><br>  If an exception is raised in the string ‚Äúchar * revstring = new char [nFindLength];‚Äù, a memory leak will occur.  Operators delete [] will not be called.  Not a critical error, but still worth mentioning about it. <br><br>  <a href="http://www.viva64.com/external-pictures/txt/VirtualDub-new.txt">Here</a> , all the places where the pointer is checked in VirtualDub after calling the 'new' operator are listed. <br><br><h2>  Link to the destroyed object </h2><br><pre> <code class="cpp hljs">vdlist_iterator&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>--(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) { <span class="hljs-function"><span class="hljs-function">vdlist_iterator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; mp = mp-&gt;mListNodePrev; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tmp; }</code> </pre> <br>  Diagnostic message issued by PVS-Studio: V558 Function returns the reference to the temporary local object: tmp.  VirtualDub vdstl.h 460 <br><br>  The function is implemented incorrectly.  It returns a reference to the local 'tmp' object.  After exiting the function, it will be destroyed.  Working with this link will result in undefined behavior. <br><br>  By the way, the operator ++, located nearby, is implemented correctly. <br><br><h2>  At the beginning we use, then we check </h2><br>  In different programs, it is often possible to encounter an error, when the pointer is first dereferenced, and only then, compared with NULL.  Such errors do not manifest themselves for a very long time, since the equality of the NULL pointer is an abnormal rare situation.  These shortcomings also exist in the VirtualDub code.  Example: <br><pre> <code class="cpp hljs">LRESULT YUVCodec::DecompressGetFormat(BITMAPINFO *lpbiInput, BITMAPINFO *lpbiOutput) { BITMAPINFOHEADER *bmihInput = &amp;lpbiInput-&gt;bmiHeader; BITMAPINFOHEADER *bmihOutput = &amp;lpbiOutput-&gt;bmiHeader; LRESULT res; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!lpbiOutput) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(BITMAPINFOHEADER); .... }</code> </pre> <br>  Diagnostic message issued by PVS-Studio: V595 The "lpbiOutput" pointer was used against it.  Check lines: 82, 85. VirtualDub yuvcodec.cpp 82 <br><br>  At the beginning, the lpbiOutput pointer is dereferenced.  Then it is checked: "if (! LpbiOutput)".  Such an error usually occurs during the refactoring process.  New code is inserted before the necessary checks.  To correct the above code, you need to change the sequence of actions: <br><pre> <code class="cpp hljs">LRESULT YUVCodec::DecompressGetFormat(BITMAPINFO *lpbiInput, BITMAPINFO *lpbiOutput) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!lpbiOutput) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(BITMAPINFOHEADER); BITMAPINFOHEADER *bmihInput = &amp;lpbiInput-&gt;bmiHeader; BITMAPINFOHEADER *bmihOutput = &amp;lpbiOutput-&gt;bmiHeader; LRESULT res; .... }</code> </pre> <br>  Other places where the analyzer issues a V595 warning are listed <a href="http://www.viva64.com/external-pictures/txt/VirtualDub-595.txt">here</a> . <br><br><h2>  Work with type HRESULT </h2><br><pre> <code class="cpp hljs">VDPosition AVIReadTunnelStream::TimeToPosition(VDTime timeInUs) { AVISTREAMINFO asi; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (AVIStreamInfo(pas, &amp;asi, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span> asi)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> VDRoundToInt64(timeInUs * (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>)asi.dwRate / (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>)asi.dwScale * (<span class="hljs-number"><span class="hljs-number">1.0</span></span> / <span class="hljs-number"><span class="hljs-number">1000000.0</span></span>)); }</code> </pre> <br>  Diagnostic message issued by PVS-Studio: V545 Such conditional expression for AVRTreamInfoA (pas, &amp; asi, sizeof asi) '.  The SUCCEEDED or FAILED macro should be used instead.  VirtualDub avireadhandlertunnelw32.cpp 230 <br><br>  The AVIStreamInfo () function returns a value of type HRESULT.  This type cannot be interpreted as 'bool'.  The information stored in a variable of type HRESULT has a rather <a href="http://www.viva64.com/go.php%3Furl%3D422">complex structure</a> .  To check the HRESULT value, you must use the SUCCEEDED or FAILED macro declared in WinError.h.  This is how these macros work: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FAILED(hr) (((HRESULT)(hr)) </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; 0) #define SUCCEEDED(hr) (((HRESULT)(hr)) &gt;= 0)</span></span></span></span></code> </pre> <br>  The correct code is: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FAILED(AVIStreamInfo(pas, &amp;asi, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span> asi)))</code> </pre> <br>  PVS-Studio issues similar warnings on the following lines: <ul><li>  avireadhandlertunnelw32.cpp 238 </li><li>  avireadhandlertunnelw32.cpp 335 </li><li>  inputfileavi.cpp 440 </li><li>  context_d3d11.cpp 959 </li></ul><br><h2>  Magic numbers </h2><br>  Setting the length of a string with a number is not a good idea.  It is very easy to make a mistake by counting characters.  Example: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> VDOpenGLBinding::Attach(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">memcmp</span></span>(start, <span class="hljs-string"><span class="hljs-string">"GL_EXT_blend_subtract"</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>)) .... }</code> </pre> <br>  Diagnostic message issued by PVS-Studio: V512 A call of the 'memcmp' function will be "GL_EXT_blend_subtract".  Riza opengl.cpp 393 <br><br>  The length of the string "GL_EXT_blend_subtract" is not 20, but 21 characters.  The error is noncritical.  In practice, there will be no collisions.  However, such magic numbers should be avoided.  It is better to use a special macro to calculate the length of the string.  Example: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LiteralStrLen(S) (sizeof(S) / sizeof(S[0]) - 1)</span></span></code> </pre> <br>  In C ++, you can make a more secure template function: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> N&gt; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> (&amp;ArraySizeHelper(T (&amp;<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>)[N]))[N]; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> N&gt; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> LiteralStrLen(T (&amp;<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>)[N]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(ArraySizeHelper(<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>)) - <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br>  The advantage of the second option is that you cannot accidentally pass a simple pointer as an argument.  This technique is described in more detail in the article " <a href="http://www.viva64.com/ru/a/0074/">PVS-Studio vs Chromium</a> ". <br><br><h2>  Absolute ways </h2><br><pre> <code class="cpp hljs">VDDbgHelpDynamicLoaderW32::VDDbgHelpDynamicLoaderW32() { hmodDbgHelp = LoadLibrary( <span class="hljs-string"><span class="hljs-string">"c:\\program files\\debugging tools for windows\\dbghelp"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!hmodDbgHelp) { hmodDbgHelp = LoadLibrary(<span class="hljs-string"><span class="hljs-string">"c:\\program files (x86)\\...... .... }</span></span></code> </pre> <br>  Diagnostic message issued by PVS-Studio: V631 Consider inspecting the 'LoadLibraryA' function call.  It is considered a poor style.  VirtualDub leaks.cpp 67, 69 <br><br>  I think it's clear why this code is bad.  Of course, the code is associated with debugging, and hardly any negative impact on end users.  But still, it would be better <a href="http://www.viva64.com/go.php%3Furl%3D1308">to get the right path</a> to Program Files. <br><br><h2>  Invalid argument </h2><br><pre> <code class="cpp hljs">sint64 rva; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tool_lookup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%08I64x %s + %x [%s:%d]\n"</span></span>, addr, sym-&gt;name, addr-sym-&gt;rva, fn, line); .... }</code> </pre> <br>  Diagnostic message issued by PVS-Studio: V576 Incorrect format.  Consider checking the fourth argument of the printf function.  The argument is expected to be not greater than 32-bit.  Asuka lookup.cpp 56 <br><br>  The variable 'rva' is a 64-bit type.  This means that 8 bytes will be pushed onto the stack.  The printf () function is a function with a <a href="http://www.viva64.com/ru/t/0069/">variable number of arguments</a> .  The type of data that it must process is specified using the format string.  In this case, the 'rva' variable will be processed as a 32-bit variable ("% x"). <br><br>  This error will lead to failure or not depends on how the compiler organizes the transfer of arguments and on the bitness of the platform.  For example, in <a href="http://www.viva64.com/ru/t/0055/">Win64,</a> all integer types are first converted to the 64-bit type, and then pushed onto the stack.  Problems that the variable will take in a stack more places, than it is necessary, will not be. <br><br>  However, if the variable 'rva' stores values ‚Äã‚Äãgreater than INT_MAX, its value in any case will be printed incorrectly. <br><br>  The analyzer issues similar warnings here: <ul><li>  dubstatus.cpp 360 </li><li>  lookup.cpp 58 </li></ul><br><h2>  Wrong comparisons </h2><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> VDVideoCompressorVCM::GetState(vdfastvector&lt;uint8&gt;&amp; data) { DWORD res; .... res = ICGetState(hic, data.data(), size); .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (res &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> MyICError(<span class="hljs-string"><span class="hljs-string">"Video compression"</span></span>, res); }</code> </pre> <br>  Diagnostic message issued by PVS-Studio: V547 Expression 'res &lt;0' is always false.  Unsigned type value is never &lt;0. Riza w32videocodecpack.cpp 828 <br><br>  Variable 'res' we have unsigned type DWORD.  This means that the expression "res &lt;0" is always equal to the value 'false'. <br><br>  A similar test is contained here: w32videocodec.cpp 284. <br><br>  Consider another similar error. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ICERR_CUSTOM -400L static const char *GetVCMErrorString(uint32 icErr) { .... </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (icErr &lt;= ICERR_CUSTOM) err = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"A codec-specific error occurred."</span></span></span><span class="hljs-meta">; .... }</span></span></code> </pre> <br>  Diagnostic message issued by PVS-Studio: V605 Consider verifying the expression: icErr &lt;= - 400L.  An unsigned value is compared to the number -400.  system error_win32.cpp 54 <br><br>  The variable 'icErr' is of type 'unsigned'.  Therefore, before comparing, the number '-400' will be implicitly converted to 'unsigned'.  The value of '-400' will turn into 4294966896. Thus, the comparison (icErr &lt;= -400) is equivalent to (icErr &lt;= 4294966896).  Apparently, this is not what the programmer wanted. <br><br><h2>  Miscellaneous strange </h2><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> AVIOutputFile::finalize() { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stream.mChunkCount &amp;&amp; hdr.dwScale &amp;&amp; stream.mChunkCount) .... }</code> </pre> <br>  Diagnostic message issued by PVS-Studio: V501 There are identical sub-expressions of the operator.  VirtualDub avioutputfile.cpp 761 <br><br>  The variable 'stream.mChunkCount' is checked twice.  One check is superfluous or you forgot to check something else. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> VDVideoCompressorVCM::Start(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *inputFormat, uint32 inputFormatSize, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *outputFormat, uint32 outputFormatSize, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VDFraction&amp; frameRate, VDPosition frameCount) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;hic = hic; .... }</code> </pre> <br>  Diagnostic message issued by PVS-Studio: V570 The 'this-&gt; hic' variable is assigned to itself.  Riza w32videocodecpack.cpp 253 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> VDDialogAudioConversionW32::RecomputeBandwidth() { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsDlgButtonChecked(mhdlg, IDC_PRECISION_NOCHANGE)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mbSourcePrecisionKnown &amp;&amp; mbSource16Bit) bps *= <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> bps = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsDlgButtonChecked(mhdlg, IDC_PRECISION_16BIT)) bps *= <span class="hljs-number"><span class="hljs-number">2</span></span>; .... }</code> </pre> <br>  Diagnostic message issued by PVS-Studio: V646 Consider inspecting the application's logic.  It's possible that 'else' keyword is missing.  VirtualDub optdlg.cpp 120 <br><br>  The code may be incorrectly formatted.  Or perhaps the 'else' keyword is forgotten. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> VDCaptureDriverScreen::Init(VDGUIHandle hParent) { .... mbAudioHardwarePresent = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; mbAudioHardwarePresent = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; .... }</code> </pre> <br>  Diagnostic message issued by PVS-Studio: V519 The 'mbAudioHardwarePresent' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 274, 275. VDCapture cap_screen.cpp 275 <br><br><h2>  Conclusion </h2><br>  As you can see, even with a one-time start, static analysis can be useful.  But it is much more useful to run it regularly.  After all, warnings (warnings) in the compiler, programmers include not once before the release, but use them constantly.  The same situation with the static analysis tools.  Their constant use allows you to quickly eliminate errors.  You can consider PVS-Studio as a kind of add-on for the compiler, which gives out more interesting warnings.  The best option is to use <a href="http://www.viva64.com/ru/d/0218/">incremental</a> code <a href="http://www.viva64.com/ru/d/0218/">analysis</a> .  You will find new errors immediately after compiling the modified files. </div><p>Source: <a href="https://habr.com/ru/post/198060/">https://habr.com/ru/post/198060/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../198038/index.html">The new Nexus appeared in its own Google Play store for as low as $ 349.</a></li>
<li><a href="../198044/index.html">Dark patterns: interfaces designed to cheat</a></li>
<li><a href="../198052/index.html">Programming language J. Amateur look. Part 1. Introduction</a></li>
<li><a href="../198054/index.html">About how we made the game for google play</a></li>
<li><a href="../198056/index.html">The isoHunt BitTorrent tracker closes after being defeated against MPAA</a></li>
<li><a href="../198062/index.html">Listen to music from Google Play Music</a></li>
<li><a href="../198066/index.html">Programming language J. Amateur look. Part 2. Tacit Programming</a></li>
<li><a href="../198068/index.html">Method for generating test tasks based on AND / OR trees and its software implementation</a></li>
<li><a href="../198072/index.html">Seek advice from experts and colleagues (mobile solutions)</a></li>
<li><a href="../198076/index.html">Business tablet HP ElitePad 900, or What should be a tablet for business?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>