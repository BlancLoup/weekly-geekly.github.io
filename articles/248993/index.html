<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Map of the latest photos of all people from these cities VK using VKScript</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article we will make a map with the latest photos from the social network VK.COM added to it. The map shows photos not of individuals, but of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Map of the latest photos of all people from these cities VK using VKScript</h1><div class="post__text post__text-html js-mediator-article">  In this article we will make a map with the latest photos from the social network VK.COM added to it.  The map shows photos not of individuals, but of cities.  The map is updated online, which allows you to visually see what is happening in the world. <br><br><img src="https://habrastorage.org/files/e10/665/0ec/e106650ec05a4c9d8dfcb3c836f65989.PNG"><br><a name="habracut"></a><br>  I will use the <a href="https://github.com/Leaflet/Leaflet">Leaflet</a> library to draw a map. <br><br>  Let's pass authorization of the VK application and configure the card: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="javascript hljs">VK.init({ <span class="hljs-attr"><span class="hljs-attr">apiId</span></span>: <span class="hljs-number"><span class="hljs-number">2866099</span></span> <span class="hljs-comment"><span class="hljs-comment">// ID   VK }); var map = L.map('map',{maxBounds:[[-90, -180],[90, 180]]}).setView([56.94497418, 91.7578125], 3); L.tileLayer('http://a.tile.openstreetmap.org/{z}/{x}/{y}.png', { minZoom: 2 }).addTo(map);</span></span></code> </pre> <br><br>  If you want to do something similar for one point on the map, then the code below will suit you, but it does not suit us, since you need to receive photos from a variety of points on the map. <br><div class="spoiler">  <b class="spoiler_title">Here is the code below</b> <div class="spoiler_text"><pre> <code class="javascript hljs">getPhotos(<span class="hljs-number"><span class="hljs-number">55.75030364</span></span>, <span class="hljs-number"><span class="hljs-number">37.62336731</span></span>, <span class="hljs-number"><span class="hljs-number">50000</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPhotos</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">lat_,long_,radius_,count_, old_photo</span></span></span><span class="hljs-function">) </span></span>{ VK.Api.call(<span class="hljs-string"><span class="hljs-string">'photos.search'</span></span>, {<span class="hljs-attr"><span class="hljs-attr">lat</span></span>: lat_, <span class="hljs-attr"><span class="hljs-attr">long</span></span>: long_, <span class="hljs-attr"><span class="hljs-attr">radius</span></span>: radius_, <span class="hljs-attr"><span class="hljs-attr">count</span></span>: count_, <span class="hljs-attr"><span class="hljs-attr">sort</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">v</span></span>: <span class="hljs-string"><span class="hljs-string">'5.27'</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(r.response) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;r.response.items.length;i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r.response.items[i].id != old_photo) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> myIcon = L.divIcon({<span class="hljs-attr"><span class="hljs-attr">html</span></span>: <span class="hljs-string"><span class="hljs-string">'&lt;div style="background-image: url('</span></span> + r.response.items[i].photo_75 + <span class="hljs-string"><span class="hljs-string">');" class="icon_photo"&gt;&lt;/div&gt;'</span></span>}); L.marker([r.response.items[i].lat, r.response.items[i].long], { <span class="hljs-attr"><span class="hljs-attr">bounceOnAdd</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">icon</span></span>: myIcon, <span class="hljs-attr"><span class="hljs-attr">riseOnHover</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }).addTo(map).bindPopup(<span class="hljs-string"><span class="hljs-string">'&lt;center&gt;&lt;a href="http://vk.com/photo'</span></span> + r.response.items[i].owner_id + <span class="hljs-string"><span class="hljs-string">'_'</span></span> + r.response.items[i].id + <span class="hljs-string"><span class="hljs-string">'" target="_blank"&gt;  &lt;br/&gt;&lt;div style="background-image: url('</span></span> + r.response.items[i].photo_604 + <span class="hljs-string"><span class="hljs-string">');" class="icon_photo2"&gt;&lt;/div&gt;&lt;/a&gt;&lt;/center&gt;'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i == <span class="hljs-number"><span class="hljs-number">0</span></span>) old_photo = r.response.items[<span class="hljs-number"><span class="hljs-number">0</span></span>].id; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ getPhotos(lat_, long_, <span class="hljs-number"><span class="hljs-number">50000</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, old_photo); }, <span class="hljs-number"><span class="hljs-number">3000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> alert(r.error.error_msg); }); }</code> </pre><br></div></div><br><br>  The problem is that the API VK restriction to 3 requests per second, from the client, so we will use <a href="https://vk.com/dev/execute"><b>execute</b></a> , it will allow to collect information about 25 coordinates in one request. <br><br>  I already wrote about execute in the <a href="http://habrahabr.ru/post/248725/">previous article</a> , so I‚Äôll not write again. <br><br>  So, let's go to the code using <b>VKScript</b> . <br><br>  We will declare two arrays, in one we will store the coordinates of cities, and in the other the last added photo to the city (this is necessary so that no duplicates are added to the map). <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> map_ordinates = [[<span class="hljs-number"><span class="hljs-number">55.7503</span></span>, <span class="hljs-number"><span class="hljs-number">37.6233</span></span>],[<span class="hljs-number"><span class="hljs-number">56.8497</span></span>, <span class="hljs-number"><span class="hljs-number">53.2198</span></span>],[<span class="hljs-number"><span class="hljs-number">55.7858</span></span>, <span class="hljs-number"><span class="hljs-number">49.1500</span></span>],[<span class="hljs-number"><span class="hljs-number">59.9659</span></span>,<span class="hljs-number"><span class="hljs-number">30.3434</span></span>],[<span class="hljs-number"><span class="hljs-number">57.9848</span></span>,<span class="hljs-number"><span class="hljs-number">56.3598</span></span>],[<span class="hljs-number"><span class="hljs-number">54.5975</span></span>,<span class="hljs-number"><span class="hljs-number">56.0961</span></span>],[<span class="hljs-number"><span class="hljs-number">54.9271</span></span>,<span class="hljs-number"><span class="hljs-number">73.4106</span></span>],[<span class="hljs-number"><span class="hljs-number">51.5360</span></span>,<span class="hljs-number"><span class="hljs-number">39.1772</span></span>],[<span class="hljs-number"><span class="hljs-number">55.0091</span></span>,<span class="hljs-number"><span class="hljs-number">82.9193</span></span>],[<span class="hljs-number"><span class="hljs-number">56.4867</span></span>,<span class="hljs-number"><span class="hljs-number">85.0177</span></span>],[<span class="hljs-number"><span class="hljs-number">58.1272</span></span>,<span class="hljs-number"><span class="hljs-number">52.6636</span></span>],[<span class="hljs-number"><span class="hljs-number">51.1586</span></span>,<span class="hljs-number"><span class="hljs-number">71.4907</span></span>],[<span class="hljs-number"><span class="hljs-number">49.8946</span></span>,<span class="hljs-number"><span class="hljs-number">73.2348</span></span>],[<span class="hljs-number"><span class="hljs-number">50.4365</span></span>,<span class="hljs-number"><span class="hljs-number">30.5255</span></span>],[<span class="hljs-number"><span class="hljs-number">56.0415</span></span>,<span class="hljs-number"><span class="hljs-number">51.9645</span></span>]]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> map_old_photo = [];</code> </pre><br><br>  By the way, why do I have a binding to the cities?  The fact is that the <a href="https://vk.com/dev/photos.search"><b>photos.search</b></a> method returns data only in a certain radius, the center of which is the coordinates from the <b>map_ordinates</b> array. <br><br>  And add the <b>getPhotos</b> function: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// radius_ - , count_ -      . function getPhotos(radius_, count_) { //           var code = 'return ['; for (var i=0;i&lt;map_ordinates.length;i++) { code += 'API.photos.search({"lat": "' + map_ordinates[i][0] + '", "long": "' + map_ordinates[i][1] + '", "radius": "' + radius_ + '", "count": "' + count_ + '", "sort": 0, "v": "5.27"})'; if (i != map_ordinates.length-1) code += ','; } code += '];'; VK.Api.call("execute", {code: code}, function(data) { if (data.response) { for (var i=0;i&lt;data.response.length;i++) { for (var j=0;j&lt;data.response[i].items.length;j++) { if (data.response[i].items[j].id != map_old_photo[i]) { var myIcon = L.divIcon({html: '&lt;div style="background-image: url(' + data.response[i].items[j].photo_75 + ');" class="icon_photo"&gt;&lt;/div&gt;'}); L.marker([data.response[i].items[j].lat, data.response[i].items[j].long], { bounceOnAdd: true, icon: myIcon, riseOnHover: true }).addTo(map).bindPopup('&lt;center&gt;&lt;a href="http://vk.com/photo' + data.response[i].items[j].owner_id + '_' + data.response[i].items[j].id + '" target="_blank"&gt;  &lt;br/&gt;&lt;div style="background-image: url(' + data.response[i].items[j].photo_604 + ');" class="icon_photo2"&gt;&lt;/div&gt;&lt;/a&gt;&lt;/center&gt;'); if (j == 0) map_old_photo[i] = data.response[i].items[0].id; } else break; } } setTimeout(function() { getPhotos(50000, 20); }, 3000); } else alert(data.error.error_code + ' ' + data.error.error_msg); }); }</span></span></code> </pre><br><br>  You can call a function by passing 2 parameters into it: the radius and the number of photos requested in one request. <br><br><pre> <code class="javascript hljs">getPhotos(<span class="hljs-number"><span class="hljs-number">5000</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>);</code> </pre><br>  I had to do authorization, despite the fact that the method is open just does not return data. <br><br>  Example sources: <a href="https://github.com/romkagolovadvayha/photomapsVKAPI">github.com/romkagolovadvayha/photomapsVKAPI</a> <br><br>  Example: <a href="http://chebrecords.ru/www/">go to</a> </div><p>Source: <a href="https://habr.com/ru/post/248993/">https://habr.com/ru/post/248993/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../248981/index.html">Dynamic do-it-yourself java code compilation</a></li>
<li><a href="../248983/index.html">How-to: Automate accounting tasks hosting provider</a></li>
<li><a href="../248985/index.html">CSS Auditing: Style Sheets Shouldn't Be Horrible</a></li>
<li><a href="../248987/index.html">CTB-Locker - a new modification of the FileCoder cryptographer</a></li>
<li><a href="../248991/index.html">Automatic Age Assessment System for Face Images</a></li>
<li><a href="../248995/index.html">Guide to the Car Tutorial (Unity3d) part 3 of 3</a></li>
<li><a href="../248997/index.html">Details about the new Microsoft rendering engine for Project Spartan</a></li>
<li><a href="../248999/index.html">Generating fake data for your javascript application using faker</a></li>
<li><a href="../249001/index.html">New Flash Player vulnerabilities are exploited in-the-wild</a></li>
<li><a href="../249005/index.html">Attention, application ideas contest for Microsoft and Mojio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>