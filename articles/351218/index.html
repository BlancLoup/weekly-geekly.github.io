<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Flask Mega-Tutorial, Part XV: Improving Application Structure</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="(edition 2018) 
 Miguel grinberg 



 There 


 This is the fifteenth installment of the Flask Mega-Textbook series, in which I am going to restructur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Flask Mega-Tutorial, Part XV: Improving Application Structure</h1><div class="post__text post__text-html js-mediator-article"><h2 id="izdanie-2018">  (edition 2018) </h2><br><h3 id="miguel-grinberg">  <em>Miguel grinberg</em> </h3><br><hr><br><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://habrahabr.ru/post/350626/">There</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p><br><p>  This is the fifteenth installment of the Flask Mega-Textbook series, in which I am going to restructure the application using a style suitable for larger applications. </p><a name="habracut"></a><br><p>  Under the spoiler is a list of all articles in this 2018 series. </p><br><div class="spoiler">  <b class="spoiler_title">Table of contents</b> <div class="spoiler_text"><ul><li>  <a href="https://habrahabr.ru/post/346306/"><strong>Chapter 1: Hello world!</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346340/"><strong>Chapter 2: Templates</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346342/"><strong>Chapter 3: Web Forms</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346344/"><strong>Chapter 4: Database</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346346/"><strong>Chapter 5: User Logins</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346348/"><strong>Chapter 6: Profile Page and Avatars</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346880/"><strong>Chapter 7: Error Handling</strong></a> </li><li>  <a href="https://habrahabr.ru/post/347450/"><strong>Chapter 8: Subscribers, Contacts, and Friends</strong></a> </li><li>  <a href="https://habrahabr.ru/post/347926/"><strong>Chapter 9: Pagination</strong></a> </li><li>  <a href="https://habrahabr.ru/post/348566/"><strong>Chapter 10: Email Support</strong></a> </li><li>  <a href="https://habrahabr.ru/post/349060/"><strong>Chapter 11: Reconstruction</strong></a> </li><li>  <a href="https://habrahabr.ru/post/349604/"><strong>Chapter 12: Date and Time</strong></a> </li><li>  <a href="https://habrahabr.ru/post/350148/"><strong>Chapter 13: I18n and L10n</strong></a> 351218 </li><li>  <a href="https://habrahabr.ru/post/350626/"><strong>Chapter 14: Ajax</strong></a> </li><li>  <a href="https://habrahabr.ru/post/351218/"><strong>Chapter 15: Improving Application Structure</strong></a> (This article) </li><li>  <a href="https://habrahabr.ru/post/351900/"><strong>Chapter 16: Full Text Search</strong></a> </li><li>  <a href="https://habrahabr.ru/post/352266/"><strong>Chapter 17: Deploying to Linux</strong></a> </li><li>  <a href="https://habrahabr.ru/post/352830/"><strong>Chapter 18: Deploying to Heroku</strong></a> </li><li>  <a href="https://habrahabr.ru/post/353234/"><strong>Chapter 19: Deploying to Docker Containers</strong></a> </li><li>  <a href="https://habrahabr.ru/post/353804/"><strong>Chapter 20: JavaScript Magic</strong></a> </li><li>  Chapter 21: User Notifications (Available April 24, 2018) </li><li>  Chapter 22: Reference Tasks (Available May 1, 2018) </li><li>  Chapter 23: Application Programming Interfaces (APIs) (Available May 8, 2018) </li></ul></div></div><br><p>  <em>Note 1: If you are looking for old versions of this course, this is <a href="https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-i-hello-world-legacy" title="here">here</a> .</em> </p><br><p>  <em>Note 2: If suddenly you would like to speak in support of my (Miguel) work, or simply do not have the patience to wait for the article for a week, I (Miguel Greenberg) offer the full version of this manual (in English) in the form of an electronic book or video.</em>  <em>For more information, visit <a href="http://learn.miguelgrinberg.com/" title="learn.miguelgrinberg.com">learn.miguelgrinberg.com</a> .</em> </p><br><p>  Microblog is already a decent sized app!  And I thought it would be time to discuss how the Flask application can grow without becoming a garbage dump or simply too complicated to manage.  Flask is a framework that is designed to enable you to organize your project in any way, and as part of this philosophy, it allows you to change or adapt the structure of the application as it grows larger, or as your needs or experience level change. </p><br><p>  In this chapter, I‚Äôm going to discuss some of the patterns that apply to large applications, and to demonstrate them, I‚Äôm going to make some changes to how my Microblog project is structured in order to make the code more maintainable and better organized.  But, of course, in the true spirit of Flask, I urge you to accept these changes only as a recommendation, on how to organize your own projects. </p><br><p>  <em>GitHub links for this chapter:</em> <a href="">Browse</a> , <a href="">Zip</a> , <a href="">Diff</a> . </p><br><h2 id="tekuschie-ogranicheniya">  Current Restrictions </h2><br><p>  In the current state of the application there are two main problems.  If you look at how the application is structured, you will notice that there are several different subsystems that can be identified, but the code that supports them is all mixed up, without any clear boundaries.  Let's look at what these subsystems are: </p><br><ul><li>  The user authentication subsystem, which includes some view functions in <em>app / routes.py</em> , some forms in <em>app / forms.py</em> , some templates in <em>app / templates,</em> and email support in <em>app / email.py</em> . </li><li>  The error subsystem, which defines error handlers in <em>app / errors.py</em> and templates in <em>app / templates</em> . </li><li>  The main functionality of the application, which includes the display and recording of blog posts, user profiles and subsequent events, as well as live translations of blog posts that are distributed in a large number of application modules and templates. </li></ul><br><p>  Thinking about these three subsystems, which I have defined, and how they are structured, you can probably notice the pattern.  Until now, the logic of the organization, which I followed, is based on the presence of modules dedicated to the various functions of the application.  There is a module for viewing functions, another for web forms, one for errors, one for emails, a directory for HTML templates and so on.  Although it is a structure that makes sense for small projects, as soon as a project starts growing, it tends to make some of these modules really big and dirty. </p><br><p>  One way to see the problem clearly is to consider how you will start the second project, reusing as much as you can from the first.  For example, the part responsible for authenticating the user should work well in other applications.  But if you want to use this code as is, you will have to go into several modules and copy / paste the relevant sections into new files in the new project.  See how awkward this is?  Wouldn't it be better if this project had all the authentication files separated from the rest of the application?  <em>The blueprints</em> feature of Flask helps to achieve a more practical organization that simplifies code reuse. </p><br><p> The second problem is not so obvious.  A Flask application instance is created as a global variable in <em><code>app/__init__.py</code></em> , and then imported by many application modules.  Although this in itself is not a problem, using an application as a global variable can complicate some scenarios, in particular those associated with testing.  Imagine that you want to test this application in different configurations.  Because an application is defined as a global variable, it is actually not possible to create an instance of two applications using different configuration variables.  Another situation, which is not ideal, is that all tests use the same application, so the test can make changes to the application that affect another test that is performed later.  Ideally, you want all the tests to run on the original application instance. </p><br><p>  In fact, you can see all this in the <em>tests.py</em> module.  I resort to the configuration change trick after it has been installed in the application to direct tests to use the in-memory database instead of the SQLite database (default) on a disk basis.  I have no other way to change the configured database, because by the time the tests were run, the application was already created and configured.  For this particular situation, changing the configuration after it has been applied to the application seems to work fine, but in other cases it does not help, and in any case it is a bad practice that can lead to unclear and difficult to find errors. </p><br><p>  The best solution would be not to use a global variable for the application, but instead use the <em>application factory</em> function to create the function at run time.  This will be a function that accepts a configuration object as an argument and returns an instance of the Flask application configured by these settings.  If I could modify the application to work with the application factory function, then writing tests that require special configuration would be easier, because each test could create its own application. </p><br><p>  In this chapter, I am going to reorganize the application by introducing the element schema for the three subsystems listed above and the application factory functions.  It will not be advisable to show you a detailed list of changes, because there are small changes in almost every file that is part of the application, so I'm going to discuss the steps I took to refactor, and you can <a href="">download the</a> application with these changes. </p><br><h2 id="blueprints">  Blueprints </h2><br><p>  In Flask, a project is a logical structure, which is a subset of the application.  A project can include elements such as routes, view functions, forms, templates, and static files.  If you write your project in a separate Python package, you have a component that encapsulates elements related to a specific function of the application. </p><br><p>  The contents of the circuit elements is initially at rest.  To associate these elements, you must register the element schema in the application.  During registration, all items added to the item map are passed to the application.  Thus, it is possible to present the scheme of elements as temporary storage for the functionality of the application, which helps to organize the code. </p><br><h2 id="obrabotka-oshibok-blueprint">  Blueprint error handling </h2><br><p>  The first element schema I created was encapsulated to support error handlers.  The structure of this concept is as follows: </p><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">app</span></span>/ errors/ &lt;-- blueprint  __init__.py &lt;-- blueprint  handlers.py &lt;-- error  templates/ errors/ &lt;-- error  <span class="hljs-number"><span class="hljs-number">404.</span></span>html <span class="hljs-number"><span class="hljs-number">500.</span></span>html __init__.py &lt;-- blueprint </code> </pre> <br><p>  In essence, I moved the <em>app / errors.py module</em> to <em>app / errors / handlers.py</em> and the two error templates in <em>app / templates / errors</em> so that they are separate from the other templates.  I also had to change the <code>render_template()</code> calls in both error handlers to use the subdirectory of the new error template.  After that, I added the blueprint creation to the <em><code>app/errors/__init__.py</code></em> and registering the project with <em><code>app/__init__.py</code></em> after creating the application instance. </p><br><p>  I should note that the schemas of the elements of Flask can be configured on a separate directory for templates or static files.  I decided to move the templates to the subdirectory of the application templates directory so that all templates are in the same hierarchy, but if you prefer to have templates belonging to the element scheme inside the element scheme package, this is supported.  For example, if you add the <code>template_folder= 'templates'</code> argument to the <code>Blueprint()</code> constructor, you can save the element's schema templates in <em>app / errors / templates</em> . </p><br><p>  Creating a layout of elements is much like creating an application.  This is done in the <code>__init__.py</code> module of the blueprint package: </p><br><blockquote>  <em><code>app/errors/__init__.py</code></em> : Errors blueprint. </blockquote><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Blueprint bp = Blueprint(<span class="hljs-string"><span class="hljs-string">'errors'</span></span>, __name__) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app.errors <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> handlers</code> </pre> <br><p>  The <code>Blueprint</code> class accepts the schema name of the elements, the name of the base module (usually set to <code>__name__</code> , as in an instance of the Flask application), and several optional arguments that I don‚Äôt need in this case.  After creating the element schema object, I import the <em>handlers.py</em> module so that error handlers in it are registered in the element schema.  This import is down to avoid circular dependencies. </p><br><p>  In the <em>handlers.py</em> module <em>,</em> instead of attaching error handlers to an application using the <code>@app.errorhandler</code> decorator, I use the <code>@app.errorhandler</code> blueprint decorator.  Although both decorators achieve the same end result, the idea is to try to make the layout of the elements independent of the application so that it is more portable.  I also need to change the path to the two error patterns to accommodate the new error subdirectory to which they were moved. </p><br><p>  The final step to complete the refactoring of error handlers is to register the element schema in the application: </p><br><blockquote>  <em><code>app/__init__.py</code></em> : registration of the element schema in the application. </blockquote><br><pre> <code class="hljs swift">app = <span class="hljs-type"><span class="hljs-type">Flask</span></span>(__name__) # ... from app.errors <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> bp as errors_bp app.register_blueprint(errors_bp) # ... from app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> routes, models # &lt;--     !</code> </pre> <br><p>  To register the element map, use the <code>register_blueprint()</code> method of the Flask application instance.  When registering a circuit of elements, all presentation functions, templates, static files, error handlers, etc., are connected to the application.  I put the import of the schema of elements right above <code>app.register_blueprint()</code> to avoid circular dependencies. </p><br><h2 id="autentifikaciya-blueprint">  Blueprint authentication </h2><br><p>  The process of refactoring the functions of authentication of an application into a project is quite similar to the processing of error handlers.  Here is the refactoring scheme: </p><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">app</span></span>/ auth/ &lt;-- blueprint  __init__.py &lt;-- blueprint  email.py &lt;-- authentication emails forms.py &lt;-- authentication forms routes.py &lt;-- authentication routes templates/ auth/ &lt;-- blueprint  login.html register.html reset_password_request.html reset_password.html __init__.py &lt;-- blueprint </code> </pre> <br><p>  To create this project, I had to transfer all functions related to authentication to the new modules that I created in the project.  This includes several browsing features, web forms, and support functions, such as a function that sends password reset tokens by email.  I also moved the templates to a subdirectory to separate them from the rest of the application, as it did with error pages. </p><br><p>  When determining routes in the scheme of elements, uses the decorator <code>@bp.route</code> instead of <code>@app.route</code> .  It also requires changing the syntax used in <code>url_for()</code> to create URLs.  For normal browsing functions attached directly to an application, the first argument to <code>url_for()</code> is the name of the view function.  If the route is defined in the element scheme, this argument must include the name of the element scheme and the name of the view function, separated by a period.  So, for example, I had to replace all <code>url_for('login')</code> <code>url_for('auth.')</code> with <code>url_for('auth.')</code> , and the same for the rest of the view functions. </p><br><p>  To register the scheme of <code>auth</code> elements in the application, I used a slightly different format: </p><br><blockquote>  <em><code>app/__init__.py</code></em> : Register the authentication element scheme in the application. </blockquote><br><pre> <code class="hljs kotlin"># ... from app.auth <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> bp <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> auth_bp app.register_blueprint(auth_bp, url_prefix=<span class="hljs-string"><span class="hljs-string">'/auth'</span></span>) # ...</code> </pre> <br><p>  The <code>register_blueprint()</code> call in this case has an additional argument <code>url_prefix</code> .  This is completely optional, but Flask gives you the ability to append the element scheme under the URL prefix, so any routes defined in the element scheme receive this prefix in their URLs.  In many cases, this is useful as a kind of "namespace" that separates all routes in the circuit of elements from other routes in the application or other schemes of elements.  For authentication, I thought it would be nice to have all the routes starting with <em><code>/auth</code></em> , so I added a prefix.  Thus, now the login URL will be <em><a href="http://localhost:5000/auth/login">http: // localhost: 5000 / auth / login</a></em> .  Since I use <code>url_for()</code> to generate a URL, all URLs will automatically include the prefix. </p><br><h2 id="osnovnaya-shema-elementov-prilozheniya">  The main scheme of the elements of the application </h2><br><p>  The third element schema contains the main application logic.  To refactor this element schema, the same process is required as for the previous two element schemas.  I gave this element scheme the name <code>main</code> , so all <code>url_for()</code> calls that refer to the view functions should have gotten <code>main</code> .  prefix.  Given that this is the main functionality of the application, I decided to leave the templates in the same places.  This is not a problem, because I moved the templates from two other element schemas into subdirectories. </p><br><h2 id="shablon-fabrika-prilozheniy">  Application Pattern </h2><br><p>  As I mentioned in the introduction to this chapter, having an application as a global variable leads to some complications, mainly in the form of restrictions for some test scenarios.  Before I introduced the element schemas, the application had to be a global variable, because all the presentation functions and error handlers had to be decorated with functions that are in the <code>app</code> , such as <code>@app.route</code> .  But now that all the routes and error handlers have been moved to the element schemas, there are far fewer reasons to keep the application global. </p><br><p>  So I'm going to add the <code>create_app()</code> function, which creates an instance of the Flask application, and exclude a global variable.  The conversion was not trivial, we had to understand several difficulties, but let's first consider the function of the application factory: </p><br><blockquote>  <em><code>app/__init__.py</code></em> : Application factory function. </blockquote><br><pre> <code class="hljs vhdl"># ... db = SQLAlchemy() migrate = Migrate() login = LoginManager() login.login_view = <span class="hljs-symbol"><span class="hljs-symbol">'auth</span></span>.login' login.login_message = _l(<span class="hljs-symbol"><span class="hljs-symbol">'Please</span></span> log <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> this page.') mail = Mail() bootstrap = Bootstrap() moment = Moment() babel = Babel() def create_app(config_class=Config): app = Flask(__name__) app.config.from_object(config_class) db.init_app(app) migrate.init_app(app, db) login.init_app(app) mail.init_app(app) bootstrap.init_app(app) moment.init_app(app) babel.init_app(app) # ...    blueprint registration <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> app.debug <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> app.testing: # ...    logging setup <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> app</code> </pre> <br><p>  You have seen that most of the Flask extensions are initialized by creating an instance of the extension and passing the application as an argument.  If the application does not exist as a global variable, there is an alternative mode in which extensions are initialized in two steps.  An extension instance is first created in the global scope, as before, but no arguments are passed to it.  This creates an instance of the extension that is not attached to the application.  During the creation of an application instance in the factory function, you must call the <code>init_app()</code> method in the extension instance in order to bind it to a known application. </p><br><p>  Other tasks performed during initialization remain unchanged, but are transferred to the factory function instead of being in the global area.  This includes registration of the element schema and logging configuration.  Note that I added a <code>not app.testing</code> condition to a condition that decides whether to enable or disable e-mail and file logging so that all these logs are skipped during unit tests.  The <code>app.testing</code> flag will be <code>True</code> when performing unit tests due to the fact that the <code>TESTING</code> variable is set to <code>True</code> in the configuration. </p><br><p>  So who calls the application factory function?  The obvious place to use this feature is the top-level <em>microblog.py</em> script, which is the only module in which the application now exists in the global scope.  Another place is in <em>test.py</em> , and I will discuss unit testing in more detail in the next section. </p><br><p>  As I mentioned above, most of the links to the application are gone with the introduction of the schema of the elements, but some of them are still present in the code that I have to consider.  For example, all <em>app / models.py</em> , <em>app / translate.py</em> and <em>app / main / routes.py applications</em> have links to <code>app.config</code> .  Fortunately, the Flask developers tried to simplify the browsing functions to access the application instance without having to import it, as I have done so far.  The variable <code>current_app</code> from Flask, is a special ‚Äúcontext‚Äù variable Flask, which initializes the application before sending the request.  You have already seen another context variable before, the <code>g</code> variable, in which I store the current locale.  These two, along with <code>current_user</code> Flask-Login and several others that you have not seen, are conditionally ‚Äúmagic‚Äù variables, since they work as global variables, but are only available during the processing of a request and only in the stream that processes it. </p><br><p>  Replacing the <code>current_app</code> variable in Flask eliminates the need to import an application instance as a global variable.  I was able to replace all <code>app.config</code> mentions with <code>current_app.config</code> without any difficulty with a simple search and replace. </p><br><p>  <em>The app / email.py</em> module was a bit of a problem, so I had to use a little trick: </p><br><blockquote>  <em>app / email.py</em> : Passing an instance of an application to another thread. </blockquote><br><pre> <code class="hljs python"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> current_app <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_async_email</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(app, msg)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> app.app_context(): mail.send(msg) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_email</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subject, sender, recipients, text_body, html_body)</span></span></span><span class="hljs-function">:</span></span> msg = Message(subject, sender=sender, recipients=recipients) msg.body = text_body msg.html = html_body Thread(target=send_async_email, args=(current_app._get_current_object(), msg)).start()</code> </pre> <br><p>  In the <code>send_email()</code> function, the application instance is passed as an argument to the background thread, which then delivers the email without blocking the main application.  <code>current_app</code>    <code>send_async_email()</code> ,     ,   ,   <code>current_app</code> ‚Äî   ,   ,    .    <code>current_app</code>    .  <code>current_app</code>           ,   <code>current_app</code>     <em>proxy object</em> ,      .  ,  -   ,   <code>current_app</code>   .         ,    -,       .  <code>current_app._get_current_object()</code>       ,    ,       . </p><br><p>   " " ‚Äî   <em>app/cli.py</em> ,          .     <code>current_app</code>  ,      ,      ,    ,  <code>current_app</code>  .        ,     ,          <code>register()</code> ,    <code>app</code>   : </p><br><blockquote> <em>app/cli.py</em> :    . </blockquote><br><pre> <code class="hljs python"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> click <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">register</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(app)</span></span></span><span class="hljs-function">:</span></span> @app.cli.group() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">translate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Translation and localization commands."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> @translate.command() @click.argument(<span class="hljs-string"><span class="hljs-string">'lang'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(lang)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Initialize a new language."""</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... @translate.command() def update(): """Update all languages.""" # ... @translate.command() def compile(): """Compile all languages.""" # ...</span></span></code> </pre> <br><p>      <code>register()</code>  <em>microblog.py</em> .   <em>microblog.py</em>  : </p><br><blockquote> <em>microblog.py</em> :     . </blockquote><br><pre> <code class="hljs python"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_app, db, cli <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> User, Post app = create_app() cli.register(app) @app.shell_context_processor <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make_shell_context</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {<span class="hljs-string"><span class="hljs-string">'db'</span></span>: db, <span class="hljs-string"><span class="hljs-string">'User'</span></span>: User, <span class="hljs-string"><span class="hljs-string">'Post'</span></span> :Post}</code> </pre> <br><h2 id="unit-testing-improvements"> Unit Testing Improvements </h2><br><p>       ,   ,      ,        .      ,     ,      ,    . </p><br><p>   <em>tests.py</em>       ,       ,    ,       ,      .  ,         ,       . </p><br><p>  <code>create_app()</code>       .     <code>Config</code>   <em>config.py</em> ,       ,    ,       .    ,      : </p><br><blockquote> <em>tests.py</em> :  . </blockquote><br><pre> <code class="hljs python"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> config <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Config <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestConfig</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Config)</span></span></span><span class="hljs-class">:</span></span> TESTING = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> SQLALCHEMY_DATABASE_URI = <span class="hljs-string"><span class="hljs-string">'sqlite://'</span></span></code> </pre> <br><p>      <code>Config</code>     SQLAlchemy     SQLite  .     <code>TESTING</code>   True,       ,    ,    ,        . </p><br><p>   ,       <code>setUp()</code>  <code>tearDown()</code> ,           ,     .                 : </p><br><blockquote> <em>tests.py</em> :     . </blockquote><br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UserModelCase</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unittest</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TestCase</span></span></span><span class="hljs-class">): def setUp(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">): self.app = create_app(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TestConfig</span></span></span><span class="hljs-class">) self.app_context = self.app.app_context() self.app_context.push() db.create_all() def tearDown(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">): db.session.remove() db.drop_all() self.app_context.pop()</span></span></code> </pre> <br><p>      <code>self.app</code> ,    ,   .   <code>db.create_all()</code> ,     .  <code>db</code>  ,    ,      URI    <code>app.config</code> ,       ,        ,      . ,   <code>db</code> ,     <code>self.app</code> ,     ? </p><br><p>    <em> </em> .   <code>current_app</code> ,  -       ,      ?         ,     ,     .   ,   ,   ,  <code>current_app</code>  .    ,      Python.     ,    <code>python</code> ,    <code>flask shell</code> ,  ,    . </p><br><pre> <code class="hljs javascript">&gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> current_app &gt;&gt;&gt; current_app.config[<span class="hljs-string"><span class="hljs-string">'SQLALCHEMY_DATABASE_URI'</span></span>] Traceback (most recent call last): ... RuntimeError: Working outside <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> application context. &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_app &gt;&gt;&gt; app = create_app() &gt;&gt;&gt; app.app_context().push() &gt;&gt;&gt; current_app.config[<span class="hljs-string"><span class="hljs-string">'SQLALCHEMY_DATABASE_URI'</span></span>] <span class="hljs-string"><span class="hljs-string">'sqlite:////home/miguel/microblog/app.db'</span></span></code> </pre> <br><p>    !     Flask   ,   <code>current_app</code>  <code>g</code>  .   ,      .   <code>db.create_all()</code>       <code>setUp()</code>          ,    <code>db.create_all()</code>   <code>current_app.config</code> ,  ,    .    <code>tearDown()</code>   ,      . </p><br><p>    ,        ,   Flask.   <em>request context</em> ,   ,     .        ,    <code>request</code>  <code>session</code> Flask,   <code>current_user</code> Flask-Login. </p><br><h2 id="peremennye-okruzheniya">  Environment variables </h2><br><p>    ,    ,     ,    ,  ,    .      ,     , URL-     API Microsoft Translator. , ,     ,   ,    ,      ,      . </p><br><p>    ,     ,      <code>.env</code>    .         ,           . </p><br><p>   Python,   <em>.env</em> ,  <code>python-dotenv</code> . ,    : </p><br><pre> <code class="hljs sql">(venv) $ pip <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> python-dotenv</code> </pre> <br><p>   <em>config.py</em> ‚Äî  ,      ,     <em>.env</em>    <code>Config</code> ,      : </p><br><blockquote> <em>config.py</em> :   .env   . </blockquote><br><pre> <code class="hljs lua">import <span class="hljs-built_in"><span class="hljs-built_in">os</span></span> from dotenv import load_dotenv basedir = <span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>.abspath(<span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>.dirname(__file__)) load_dotenv(<span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>.join(basedir, <span class="hljs-string"><span class="hljs-string">'.env'</span></span>)) class Config(object): # ...</code> </pre> <br><p> ,      <em>.env</em>    ,    . ,      <em>.env</em> -    .    ,      ,     . </p><br><p>  <em>.env</em> -       ,        <code>FLASK_APP</code>  <code>FLASK_DEBUG</code> ,          ,  ,        . </p><br><p>      <em>.env</em> ,    ,            25-     ,   API Microsoft Translator          : </p><br><pre> <code class="hljs pgsql">SECRET_KEY=a-really-long-<span class="hljs-keyword"><span class="hljs-keyword">and</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">unique</span></span>-key-that-nobody-knows MAIL_SERVER=localhost MAIL_PORT=<span class="hljs-number"><span class="hljs-number">25</span></span> MS_TRANSLATOR_KEY=&lt;your-translator-key-here&gt;</code> </pre> <br><h2 id="fayl-requirements">  Requirements </h2><br><p>            Python.   -       ,       ,     ,       <em>requirements.txt</em>           .       : </p><br><pre> <code class="hljs pgsql">(venv) $ pip <span class="hljs-keyword"><span class="hljs-keyword">freeze</span></span> &gt; requirements.txt</code> </pre> <br><p>  <code>pip freeze</code>    ,    ,  ,   <em>requirements.txt</em> . ,           ,     ,   : </p><br><pre> <code class="hljs sql">(venv) $ pip <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> -r requirements.txt</code> </pre> <br><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://habrahabr.ru/post/350626/">There</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/351218/">https://habr.com/ru/post/351218/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351206/index.html">Own game analytics for $ 300 per month</a></li>
<li><a href="../351208/index.html">What should be the product manager. One opinion from Yandex</a></li>
<li><a href="../351212/index.html">Transient Woodpecker: a short history of the object "Chernobyl-2"</a></li>
<li><a href="../351214/index.html">Ideal requirements, and how to deal with it</a></li>
<li><a href="../351216/index.html">Strong typing for TypeScript Vue.js applications</a></li>
<li><a href="../351220/index.html">FastTrack Training. "Network Basics". "The Basics of Telephony." Part 1. Eddie Martin. December 2012</a></li>
<li><a href="../351222/index.html">Pros and cons of doing business in the United States: observations after a year of development of their company</a></li>
<li><a href="../351224/index.html">JD Humanoid Robot and Microsoft Cognitive Services</a></li>
<li><a href="../351226/index.html">I am a network architect and this worries me</a></li>
<li><a href="../351228/index.html">A study of cyber attacks in 2017: 47% of attacks are directed at the infrastructure of companies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>