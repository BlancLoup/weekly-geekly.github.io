<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Esp8266 control via the Internet using the MQTT protocol</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! This article will tell you in detail and show how literally in 20 minutes of free time, configure the remote control of the esp8266 module usin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Esp8266 control via the Internet using the MQTT protocol</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/965/077/1d6/9650771d6b1c4668af4e40ab3b2a1be6.jpg"><br>  Hello!  This article will tell you in detail and show how literally in 20 minutes of free time, configure the remote control of the esp8266 module using an Android application using the MQTT protocol. <br><br>  The idea of ‚Äã‚Äãremote control and monitoring has always excited the minds of people keen on electronics and programming.  After all, the opportunity at any time to receive or send the necessary data, regardless of its location, provides ample opportunities.  In my past articles ( <a href="https://geektimes.ru/post/255546/">Article 1</a> and <a href="https://geektimes.ru/post/258504/">Article 2</a> ) I tried to consider several accessible and relatively simple embodiments of remote control of microcontrollers via the Internet.  However, time and the whole world do not stand still - progress continues its inexorable movement forward.  During this short time, the esp8266 module has gained wide popularity due to its low price and integrated wi-fi has become one of the main components of the Smart Home. <br><a name="habracut"></a><br>  At the moment, MQTT is the most advanced and most popular data transfer protocol between individual devices within the ‚ÄúSmart Home‚Äù systems.  It has several advantages over other protocols: <br>  - low traffic consumption; <br>  - the connection between the client and the server is always open; <br>  - does not load the Internet channel; <br>  - no delays in data transmission; <br>  - A convenient system of subscriptions to topics; <br>  All this makes it possible to monitor and control in real time.  However, MQTT requires its own server, which serves as an intermediary between network clients.  There are two ways to either create your own server or use third-party services. <br><br>  The described control system consists of two main parts: the MQTT server (it is usually one) and clients, which can be quite a lot.  In our case, the application on Android and the esp8266 module will act as clients. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The algorithm of the system is as follows.  Clients connect to the server and immediately after connecting, each of them subscribes to and topics of interest.  All communication between clients transits through the server, which redirects the data to other clients based on their subscriptions. <br><br>  <b>MQTT server.</b> <br><br>  In our case, we will use the extremely convenient service <a href="https://www.cloudmqtt.com/">www.cloudmqtt.com</a> which has a free tariff plan (Cute Cat), which will completely cover the needs for the implementation of a small, own "smart home" system. <br><img src="https://habrastorage.org/files/10a/4cc/9a9/10a4cc9a9f2d4bf2b6d7f5992d1659b1.jpg"><br>  We will register on the site and get the necessary data to access the server.  When configuring clients, you should use a regular Port (without SSL and TLS). <br><img src="https://habrastorage.org/files/d8d/504/e22/d8d504e220584810946c7a098a252f63.jpg"><br><br>  <b>Android application.</b> <br><br>  Our application will act as a control panel for the microcontroller, and will also receive and display all received information from esp8266. <br><br>  The application is called <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.thn.iotmqttdashboard%26hl%3Dru">IoT MQTT Dashboard</a> and is a ready mqtt client with a small number of very convenient widgets.  More information about working with the application can be viewed on the video. <br><br>  <b>Esp8266.</b> <br><br>  The module is stitched in the Arduino programming environment, but I want to note that the module has problems with the firmware in the latest versions of Arduino, so I recommend using version 1.6.4. <br>  For example, an LED (5 pin) and a ds18b20 temperature sensor (2 pin) are connected to esp8266. <br>  Since it is necessary to receive data to control the LED, the esp must be subscribed to the corresponding ‚Äútest / led‚Äù topic after connection, otherwise all sent data will pass by our microcontroller. <br>  You do not need a subscription to send temperature data, but when you transfer temperature values, you must specify the topic to which this data will go. <br><br>  Below is a sketch with detailed comments. <br><br><div class="spoiler">  <b class="spoiler_title">Sketch Esp8266_mqtt.ino</b> <div class="spoiler_text"><code>//    5  <br> //   ds18b20  2  <br> <br> #include &lt;ESP8266WiFi.h&gt; <br> #include &lt;PubSubClient.h&gt; <br> #include &lt;OneWire.h&gt; <br> #include &lt;DallasTemperature.h&gt; <br> <br> #define ONE_WIRE_BUS 2 <br> OneWire oneWire(ONE_WIRE_BUS); <br> DallasTemperature sensors(&amp;oneWire); <br> <br> const char *ssid = "AIRPORT"; //     <br> const char *pass = "PASSWORD"; //     <br> <br> const char *mqtt_server = "server"; //   MQTT <br> const int mqtt_port = 11140; //      MQTT <br> const char *mqtt_user = "Login"; //    <br> const char *mqtt_pass = "Pass"; //    <br> <br> #define BUFFER_SIZE 100 <br> <br> bool LedState = false; <br> int tm=300; <br> float temp=0; <br> <br> //      <br> <br> void callback(const MQTT::Publish&amp; pub) <br> { <br> Serial.print(pub.topic()); //       <br> Serial.print(" =&gt; "); <br> Serial.print(pub.payload_string()); //        <br> <br> String payload = pub.payload_string(); <br> <br> if(String(pub.topic()) == "test/led") //         <br> { <br> int stled = payload.toInt(); //      integer <br> digitalWrite(5,stled); //           <br> } <br> } <br> <br> WiFiClient wclient; <br> PubSubClient client(wclient, mqtt_server, mqtt_port); <br> <br> void setup() { <br> <br> sensors.begin(); <br> Serial.begin(115200); <br> delay(10); <br> Serial.println(); <br> Serial.println(); <br> pinMode(5, OUTPUT); <br> } <br> <br> void loop() { <br> //   wi-fi <br> if (WiFi.status() != WL_CONNECTED) { <br> Serial.print("Connecting to "); <br> Serial.print(ssid); <br> Serial.println("..."); <br> WiFi.begin(ssid, pass); <br> <br> if (WiFi.waitForConnectResult() != WL_CONNECTED) <br> return; <br> Serial.println("WiFi connected"); <br> } <br> <br> //   MQTT  <br> if (WiFi.status() == WL_CONNECTED) { <br> if (!client.connected()) { <br> Serial.println("Connecting to MQTT server"); <br> if (client.connect(MQTT::Connect("arduinoClient2") <br> .set_auth(mqtt_user, mqtt_pass))) { <br> Serial.println("Connected to MQTT server"); <br> client.set_callback(callback); <br> client.subscribe("test/led"); //        <br> } else { <br> Serial.println("Could not connect to MQTT server"); <br> } <br> } <br> <br> if (client.connected()){ <br> client.loop(); <br> TempSend(); <br> } <br> <br> } <br> } //    <br> <br> //      <br> void TempSend(){ <br> if (tm==0) <br> { <br> sensors.requestTemperatures(); //      <br> float temp = sensors.getTempCByIndex(0); <br> client.publish("test/temp",String(temp)); //        <br> Serial.println(temp); <br> tm = 300; //       3  <br> } <br> tm--; <br> delay(10); <br> } <br></code> <br></div></div><br><br>  As a result, we get a handy tool for remote control and data monitoring, which is quite easy to learn and will even be a beginner. <br><br>  <b>Video with a demonstration of the control system</b> <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/q36C4rYAKVA%3Ffeature%3Doembed&amp;xid=17259,15700002,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhj2V6b6ULuB9KucPZhs_15AOqcJ2w" frameborder="0" allowfullscreen=""></iframe><br><br>  <b>Detailed video tutorial on setting up the system</b> <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/PTPZv15Td58%3Ffeature%3Doembed&amp;xid=17259,15700002,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhiYDWKIIWdOydUT5pb0oTXmcoaaSA" frameborder="0" allowfullscreen=""></iframe><br><br>  <b>One application for managing esp8266 via the MQTT protocol</b> <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/0GcrRmu15HM%3Ffeature%3Doembed&amp;xid=17259,15700002,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgXaaRVu3aeN3TktMoF0RPAwjrk0w" frameborder="0" allowfullscreen=""></iframe><br><br>  <b>LED strip control via the Internet</b> <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/ESSKNfxiSRY%3Ffeature%3Doembed&amp;xid=17259,15700002,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhdIFDoO6QKfZngi7VqXfuM_tSP2A" frameborder="0" allowfullscreen=""></iframe><br><br>  If you have any questions about this material, I recommend watching the second part of the video, where the material is presented more clearly. <br><br>  The archive contains a sketch and all the necessary libraries for flashing a microcontroller with a sketch from an example. <br>  I draw your attention that the library ESP8266WiFi.h is not included in this archive, it is installed via the Boards manager in the Arduino environment. <br><br>  <a href=""><b>ARCHIVE</b></a> <br><br>  MQTT server - <a href="https://www.cloudmqtt.com/">www.cloudmqtt.com</a> <br><br>  Link to the IoT MQTT Dashboard app - <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.thn.iotmqttdashboard%26hl%3Dru">play.google.com/store/apps/details?id=com.thn.iotmqttdashboard&amp;hl=en</a> <br><br>  Thank you all for your attention. </div><p>Source: <a href="https://habr.com/ru/post/393277/">https://habr.com/ru/post/393277/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../393265/index.html">Hacked printers in German universities printed many anti-Semitic leaflets</a></li>
<li><a href="../393269/index.html">8 trifles from China for the organization of the workplace IT-specialist</a></li>
<li><a href="../393271/index.html">At the exhibition in Moscow showed the aviation "engine of the future" PD-14 and rocket engine NK-33</a></li>
<li><a href="../393273/index.html">A student from Penza has handed over a handwritten essay with a flown encoding</a></li>
<li><a href="../393275/index.html">SpaceX will try again to land the Falcon 9 stage on the offshore platform</a></li>
<li><a href="../393279/index.html">The performance of the Kepler telescope is fully restored</a></li>
<li><a href="../393281/index.html">Polaroid cameras in 2016</a></li>
<li><a href="../393285/index.html">Huawei Technologies. Great combination of price / quality</a></li>
<li><a href="../393287/index.html">The robot on three axes</a></li>
<li><a href="../393291/index.html">To steal $ 81 million from the Central Bank of Bangladesh was possible thanks to switches for $ 10 and the lack of software protection network</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>