<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How Microsoft Excel works with row heights</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sometimes I get bored and, armed with a debugger, I start digging in different programs. This time, my choice fell on Excel and there was a desire to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How Microsoft Excel works with row heights</h1><div class="post__text post__text-html js-mediator-article"><p>  Sometimes I get bored and, armed with a debugger, I start digging in different programs.  This time, my choice fell on Excel and there was a desire to understand how it operates with the heights of rows, what it stores, how it considers the height of a range of cells, etc.  I parsed Excel 2010 (excel.exe, 32bit, version 14.0.4756.1000, SHA1 a805cf60a5542f21001b0ea5d142d1cd0ee00b28). </p><a name="habracut"></a><br><h2 id="nachnyom-s-teorii">  Let's start with the theory </h2><br><p>  If you refer to the VBA documentation for Microsoft Office, you can see that the height of the series can somehow be obtained through two properties: </p><br><ul><li>  <a href="https://docs.microsoft.com/en-us/office/vba/api/excel.range.rowheight" title="Rowheight">The measured</a> row is measured in points.  Read / write Double; </li><li>  <a href="https://docs.microsoft.com/en-us/office/vba/api/excel.range.height" title="Height">Height</a> - Returns to each range.  Read-only. </li></ul><br><p>  And if to glance also here: <a href="https://support.office.com/en-us/article/excel-specifications-and-limits-1672b34d-7043-467e-8e27-269d656771c3" title="Excel specifications and limits">Excel specifications and limits</a> .  You may find that the maximum row height is 409 points.  Unfortunately, this is not the only case where Microsoft‚Äôs official documents are a little cunning.  In fact, in Excel code, the maximum row height is specified as 2047 pixels, which will be 1535.25 in points.  And the maximum font size is 409.55 points.  It‚Äôs impossible to get a row of such a huge height by simple assignment in VBA / Interop, but you can take a row, set its first cell with the font of Cambria Math, and set the font size to 409.55 points.  Then Excel will calculate the height of the row based on the cell format by its tricky algorithm, get a number exceeding 2047 pixels (take a word) and set the maximum possible height of the row itself.  If you ask the height of this series through the UI, then Excel sovret that the height of 409.5 points, but if you request the height of the series through VBA, you get honest 1535.25 points, which equals 2047 pixels.  True, after saving the document, the height will still be reset to 409.5 points.  This manipulation can be seen here on this video: <a href="http://recordit.co/ivnFEsELLI">http://recordit.co/ivnFEsELLI</a> </p><br><p>  I knowingly mentioned pixels in the previous paragraph.  Excel actually stores and calculates the cell sizes in integers (it generally does everything as much as possible in integers).  Most often these are pixels multiplied by some factor.  Interestingly, Excel stores the appearance scale as an ordinary fraction, for example, the 75% scale will be stored as two numbers 3 and 4. And when you need to display a row, Excel will take the row height as an integer number of pixels, multiply by 3 and divide by 4. But to perform this operation, it will be at the very end of this effect, that everything is considered in fractional numbers.  To make sure of this, write the following code in VBA: </p><br><pre><code class="vbscript hljs">w.Rows(<span class="hljs-number"><span class="hljs-number">1</span></span>).RowHeight = <span class="hljs-number"><span class="hljs-number">75.375</span></span> Debug.Print w.Rows(<span class="hljs-number"><span class="hljs-number">1</span></span>).Height</code> </pre> <br><p>  VBA will give 75, because  75.375 pixels will be 100.5 pixels, and Excel cannot afford it and will drop the fractional part up to 100 pixels.  When VBA requests the height of the row in points, Excel will honestly translate 100 pixels to points and return 75. </p><br><p>  In principle, we‚Äôve already got to write a class in C # that will describe the information about the height of the series: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RowHeightInfo</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> Value { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//    ,   4. public ushort Flags { get; set; } //  }</span></span></code> </pre> <br><p>  You still have to take my word for it, but in Excel, the height of the row is stored that way.  Ie, if it is set that the row height is 75 points, it will be 100 in pixels, then 400 will be stored in Value. I don‚Äôt find out what all the bits in Flags mean (it‚Äôs difficult and time to figure out the flag values), but I know for sure that 0x4000 is set for rows whose height is set manually, and 0x2000 is set for hidden rows.  In general, for visible rows with a manually set height, Flags most often equals 0x4005, and for rows whose height is calculated based on the formatting, Flags equals either 0xA or 0x800E. </p><br><h2 id="sprashivaem-vysotu-ryada">  We ask row height </h2><br><p>  Now, in principle, you can look at the method from excel.exe, which returns the height of the series by its index (thanks to HexRays for the beautiful code): </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __userpurge GetRowHeight@&lt;eax&gt;(<span class="hljs-keyword"><span class="hljs-keyword">signed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowIndex@&lt;edx&gt;, SheetLayoutInfo *sheetLayoutInfo@&lt;esi&gt;, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> flag) { RowHeightInfo *rowHeightInfo; <span class="hljs-comment"><span class="hljs-comment">// eax int result; // ecx if ( sheetLayoutInfo-&gt;dword1A0 ) return sheetLayoutInfo-&gt;defaultFullRowHeightMul4 | (~(sheetLayoutInfo-&gt;defaultRowDelta2 &gt;&gt; 14 &lt;&lt; 15) &amp; 0x8000); if ( rowIndex &lt; sheetLayoutInfo-&gt;MinRowIndexNonDefault ) return sheetLayoutInfo-&gt;defaultFullRowHeightMul4 | (~(sheetLayoutInfo-&gt;defaultRowDelta2 &gt;&gt; 14 &lt;&lt; 15) &amp; 0x8000); if ( rowIndex &gt;= sheetLayoutInfo-&gt;MaxRowIndexNonDefault ) return sheetLayoutInfo-&gt;defaultFullRowHeightMul4 | (~(sheetLayoutInfo-&gt;defaultRowDelta2 &gt;&gt; 14 &lt;&lt; 15) &amp; 0x8000); rowHeightInfo = GetRowHeightCore(sheetLayoutInfo, rowIndex); if ( !rowHeightInfo ) return sheetLayoutInfo-&gt;defaultFullRowHeightMul4 | (~(sheetLayoutInfo-&gt;defaultRowDelta2 &gt;&gt; 14 &lt;&lt; 15) &amp; 0x8000); result = 0; if ( flag || !(rowHeightInfo-&gt;Flags &amp; 0x2000) ) result = rowHeightInfo-&gt;Value; if ( !(rowHeightInfo-&gt;Flags &amp; 0x4000) ) result |= 0x8000u; return result; }</span></span></code> </pre> <br><p>  What is dword1A0 I did not find out, because  I could not find the place where this flag is set: ( <br>  What is defaultRowDelta2 for me, too, still remains a mystery.  When excel calculates row height based on a format, it represents it as the sum of two numbers.  defaultRowDelta2 is the second number of this sum for the standard row height.  The value of the flag parameter is also mysterious, since  everywhere where I saw the call of this method in flag was passed false. <br>  The class SheetLayoutInfo also appears in this method.  I called it that way because it contains a lot of any information about the appearance of the sheet.  In SheetLayoutInfo there are such fields as: </p><br><ul><li>  DefaultFullRowHeightMul4 - standard row height; </li><li>  MinRowIndexNonDefault - the index of the first row, whose height differs from the standard; </li><li>  MaxRowIndexNonDefault - the index of the row following the last one, whose height differs from the standard one; </li><li>  DefaultRowDelta2 is that part of the sum of the standard row height. </li><li>  GroupIndexDelta - more on that later </li></ul><br><p>  In principle, the logic of this method is quite clear: </p><br><ol><li>  If the row index is less than the first with a non-standard height, then we return the standard one; </li><li>  If the index of the series is greater than the last with a non-standard height, then return the standard one; </li><li>  Otherwise, we get a rowHeightInfo object for the row from the GetRowHeightCore method; </li><li>  If rowHeightInfo == null, return the standard row height; </li><li>  There is magic with flags, but in general we return what is in rowHeightInfo.Value and set the 16th bit in the response if the row height was not set manually. </li></ol><br><p>  If you rewrite this code in C #, you get something like the following: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> HiddenRowMask = <span class="hljs-number"><span class="hljs-number">0x2000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> CustomHeightMask = <span class="hljs-number"><span class="hljs-number">0x4000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> DefaultHeightMask = <span class="hljs-number"><span class="hljs-number">0x8000</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">ushort</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRowHeight</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex, SheetLayoutInfo sheetLayoutInfo</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> defaultHeight = (<span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span>) (sheetLayoutInfo.DefaultFullRowHeightMul4 | (~(sheetLayoutInfo.DefaultRowDelta2 &gt;&gt; <span class="hljs-number"><span class="hljs-number">14</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">15</span></span>) &amp; DefaultHeightMask)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &lt; sheetLayoutInfo.MinRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defaultHeight; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &gt;= sheetLayoutInfo.MaxRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defaultHeight; RowHeightInfo rowHeightInfo = GetRowHeightCore(sheetLayoutInfo, rowIndex); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowHeightInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defaultHeight; <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((rowHeightInfo.Flags &amp; HiddenRowMask) == <span class="hljs-number"><span class="hljs-number">0</span></span>) result = rowHeightInfo.Value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((rowHeightInfo.Flags &amp; CustomHeightMask) == <span class="hljs-number"><span class="hljs-number">0</span></span>) result |= DefaultHeightMask; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><p>  Now you can see what's going on inside GetRowHeightCore: </p><br><pre> <code class="cpp hljs">RowHeightInfo *__<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRowHeightCore</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SheetLayoutInfo *sheetLayoutInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">signed</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex)</span></span></span><span class="hljs-function"> </span></span>{ RowHeightInfo *result; <span class="hljs-comment"><span class="hljs-comment">// eax RowsGroupInfo *rowsGroupInfo; // ecx int rowInfoIndex; // edx result = 0; if ( rowIndex &lt; sheetLayoutInfo-&gt;MinRowIndexNonDefault || rowIndex &gt;= sheetLayoutInfo-&gt;MaxRowIndexNonDefault ) return result; rowsGroupInfo = sheetLayoutInfo-&gt;RowsGroups[sheetLayoutInfo-GroupIndexDelta + (rowIndex &gt;&gt; 4)]; result = 0; if ( !rowsGroupInfo ) return result; rowInfoIndex = rowsGroupInfo-&gt;Indices[rowIndex &amp; 0xF]; if ( rowInfoIndex ) result = (rowsGroupInfo + 8 * (rowInfoIndex + rowsGroupInfo-&gt;wordBA + rowsGroupInfo-&gt;wordBC - rowsGroupInfo-&gt;wordB8)); return result; }</span></span></code> </pre> <br><ol><li>  Again, at the beginning, Excel checks whether the index of the series is among the rows with a modified height and if not, returns null. </li><li>  Finds the desired group of series, if there is no such group, then returns null. </li><li>  Gets the index of a row in a group. </li><li>  Then, by the index of the series, find the required object of the RowHeightInfo class.  wordBA, wordBC, wordB8 - some kind of constant.  They change only with the story.  In principle, they do not affect the understanding of the algorithm. </li></ol><br><p>  Here it is necessary to deviate from the topic and tell more about RowsGroupInfo.  Excel stores RowHeightInfo in groups of 16 pieces, where the i-th group, represented by the RowsGroupInfo class, will store information about rows from i √ó 16 to i √ó 16 + 15 inclusive. </p><br><p>  But information about the height of the rows in RowsGroupInfo is stored in a somewhat unusual way.  Most likely because of the need to maintain history in Excel. </p><br><p>  There are three important fields in RowsGroupInfo: Indices, HeightInfos, and RowsCount, the second one is not visible in the code above (it should be in this line: (rowsGroupInfo + 8 √ó (...)), since rowInfoIndex can take very different values I have seen even more than 1000 and I have no idea how to set such a structure in IDA. The RowsCount field is not found in the code above, but it is there that stores how many really non-standard rows are stored in a group. <br>  In addition, SheetLayoutInfo has GroupIndexDelta - the difference between the real group index and the index of the first group with a modified row height. </p><br><p>  The Indices field stores RowHeightInfo offsets for each index of a row within a group.  They are stored there in order, but in HeightInfos RowHeightInfo is already stored in the order of change. </p><br><p>  Suppose we have a new blank sheet and we somehow changed the height of row number 23. This row lies in the second group of 16 rows, then: </p><br><ol><li>  Excel will determine the group index for this series.  In the current case, the index will be 1 and will change GroupIndexDelta = -1. </li><li>  Create a RowsGroupInfo class object for the group of rows and put it in sheetLayoutInfo-&gt; RowsGroups under the index 0 (sheetLayoutInfo-&gt; GroupIndexDelta + 1); </li><li>  In RowsGroupInfo Excel will allocate memory for 16 4-byte Indices, for RowsCount, wordBA, wordBC and wordB8, etc ..; </li><li>  Then Excel calculates the index of the series in the group through the operation of bitwise AND (this is much faster than taking the remainder of the division): rowIndex &amp; 0xF.  The required index in the group will be: 23 &amp; 0xF = 7; </li><li>  After that, Excel gets an offset for the index 7: offset = Indices [7].  If offset = 0, then Excel allocates 8 bytes at the end of RowsGroupInto, increments RowsCount by one and writes the new offset to Indices [7].  In any case, at the end of Excel will write down the information about the new height of the series and flags by offset in RowsGroupInfo. </li></ol><br><p>  The C # RowsGroupInfo class itself would look like this: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RowsGroupInfo</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] Indices { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;RowHeightInfo&gt; HeightInfos { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RowsGroupInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Indices = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[SheetLayoutInfo.MaxRowsCountInGroup]; HeightInfos = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;RowHeightInfo&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; SheetLayoutInfo.MaxRowsCountInGroup; i++) { Indices[i] = <span class="hljs-number"><span class="hljs-number">-1</span></span>; } } }</code> </pre> <br><p>  The GetRowHeightCore method would look like this: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> RowHeightInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRowHeightCore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SheetLayoutInfo sheetLayoutInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &lt; sheetLayoutInfo.MinRowIndexNonDefault || rowIndex &gt;= sheetLayoutInfo.MaxRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; RowsGroupInfo rowsGroupInfo = sheetLayoutInfo.RowsGroups[sheetLayoutInfo.GroupIndexDelta + (rowIndex &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>)]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowsGroupInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowInfoIndex = rowsGroupInfo.Indices[rowIndex &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rowInfoIndex != <span class="hljs-number"><span class="hljs-number">-1</span></span> ? rowsGroupInfo.HeightInfos[rowInfoIndex] : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre> <br><p>  And that‚Äôs what SetRowHeight would look like (I didn‚Äôt list its excel.exe code): </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetRowHeight</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ushort</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newRowHeight, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ushort</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flags, SheetLayoutInfo sheetLayoutInfo</span></span></span><span class="hljs-function">)</span></span> { sheetLayoutInfo.MaxRowIndexNonDefault = Math.Max(sheetLayoutInfo.MaxRowIndexNonDefault, rowIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>); sheetLayoutInfo.MinRowIndexNonDefault = Math.Min(sheetLayoutInfo.MinRowIndexNonDefault, rowIndex); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> realGroupIndex = rowIndex &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sheetLayoutInfo.RowsGroups.Count == <span class="hljs-number"><span class="hljs-number">0</span></span>) { sheetLayoutInfo.RowsGroups.Add(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); sheetLayoutInfo.GroupIndexDelta = -realGroupIndex; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sheetLayoutInfo.GroupIndexDelta + realGroupIndex &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bucketSize = -(sheetLayoutInfo.GroupIndexDelta + realGroupIndex); sheetLayoutInfo.RowsGroups.InsertRange(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo[bucketSize]); sheetLayoutInfo.GroupIndexDelta = -realGroupIndex; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sheetLayoutInfo.GroupIndexDelta + realGroupIndex &gt;= sheetLayoutInfo.RowsGroups.Count) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bucketSize = sheetLayoutInfo.GroupIndexDelta + realGroupIndex - sheetLayoutInfo.RowsGroups.Count + <span class="hljs-number"><span class="hljs-number">1</span></span>; sheetLayoutInfo.RowsGroups.AddRange(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo[bucketSize]); } RowsGroupInfo rowsGroupInfo = sheetLayoutInfo.RowsGroups[sheetLayoutInfo.GroupIndexDelta + realGroupIndex]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowsGroupInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { rowsGroupInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo(); sheetLayoutInfo.RowsGroups[sheetLayoutInfo.GroupIndexDelta + realGroupIndex] = rowsGroupInfo; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowInfoIndex = rowsGroupInfo.Indices[rowIndex &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>]; RowHeightInfo rowHeightInfo; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowInfoIndex == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { rowHeightInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowHeightInfo(); rowsGroupInfo.HeightInfos.Add(rowHeightInfo); rowsGroupInfo.Indices[rowIndex &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>] = rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { rowHeightInfo = rowsGroupInfo.HeightInfos[rowInfoIndex]; } rowHeightInfo.Value = newRowHeight; rowHeightInfo.Flags = flags; }</code> </pre> <br><h2 id="nemnogo-praktiki">  Some practice </h2><br><p>  After examining the above example of changing the height of row 23 in Excel memory, there will be something like this (I set the row 23 to the height of 75 points): </p><br><div class="spoiler">  <b class="spoiler_title">sheetLayoutInfo</b> <div class="spoiler_text"><ul><li>  DefaultFullRowHeightMul4 = 80 </li><li>  DefaultRowDelta2 = 5 </li><li>  MaxRowIndexNonDefault = 24 </li><li>  MinRowIndexNonDefault = 23 </li><li>  GroupIndexDelta = -1 </li><li>  RowsGroups Count = 1 <br><ul><li>  [0] RowsGroupInfo </li><li>  HeightInfos Count = 1 <br><ul><li>  [0] RowHeightInfo </li><li>  Flags = 0x4005 </li><li>  Value = 100 </li></ul></li><li>  Indices <br><ul><li>  [0] = -1 </li><li>  [1] = -1 </li><li>  [2] = -1 </li><li>  [3] = -1 </li><li>  [4] = -1 </li><li>  [5] = -1 </li><li>  [6] = -1 </li><li>  [7] = 0 </li><li>  [8] = -1 </li><li>  [9] = -1 </li><li>  [10] = -1 </li><li>  [11] = -1 </li><li>  [12] = -1 </li><li>  [13] = -1 </li><li>  [14] = -1 </li><li>  [15] = -1 </li></ul></li></ul></li></ul></div></div><br>  Here and in the following example, I will lay out a schematic representation of how the data in Excel memory looks, made in Visual Studio from self-written classes, because the direct memory dump is not very informative. <br>  Now let's try to hide row 23. To do this, set the 0x2000 bit of the Flags.  We will change the memory to live.  The result can be seen on this video: <a href="http://recordit.co/79vYIbwbzB">http://recordit.co/79vYIbwbzB</a> . <br>  If you hide any rows, Excel does the same. <br>  Now let's set the height of the row not explicitly, but through the cell format.  Let cell A20 have a font of 40 points in height, then the cell height in points will be 45.75 and in Excel memory it will be something like this: <br><div class="spoiler">  <b class="spoiler_title">sheetLayoutInfo</b> <div class="spoiler_text"><ul><li>  DefaultFullRowHeightMul4 = 80 </li><li>  DefaultRowDelta2 = 5 </li><li>  MaxRowIndexNonDefault = 24 </li><li>  MinRowIndexNonDefault = 20 </li><li>  GroupIndexDelta = -1 </li><li>  RowsGroups Count = 1 <br><ul><li>  [0] RowsGroupInfo </li><li>  HeightInfos Count = 2 <br><ul><li>  [0] RowHeightInfo </li><li>  Flags = 0x4005 </li><li>  Value = 100 </li><li>  [1] RowHeightInfo </li><li>  Flags = 0x800E </li><li>  Value = 244 </li></ul></li><li>  Indices <br><ul><li>  [0] = -1 </li><li>  [1] = -1 </li><li>  [2] = -1 </li><li>  [3] = -1 </li><li>  [4] = 1 </li><li>  [5] = -1 </li><li>  [6] = -1 </li><li>  [7] = 0 </li><li>  [8] = -1 </li><li>  [9] = -1 </li><li>  [10] = -1 </li><li>  [11] = -1 </li><li>  [12] = -1 </li><li>  [13] = -1 </li><li>  [14] = -1 </li><li>  [15] = -1 </li></ul></li></ul></li></ul></div></div><br><p>  You may notice that Excel always stores the height of the row, if it is not standard.  Even if the height is not specified explicitly, but is calculated based on the contents of the cells or the format, Excel will still count it once and put the result in the appropriate group. </p><br><h2 id="razbiraemsya-so-vstavkoyudaleniem-ryadov">  Understanding row insertion / deletion </h2><br><p>  It would be interesting to make out what happens when inserting / deleting rows.  The corresponding code in excel.exe is easy to find, but there was no desire to disassemble it, you can take a look at some of it: </p><br><div class="spoiler">  <b class="spoiler_title">sub_305EC930</b> <div class="spoiler_text"><p>  The a5 flag determines which operation is currently taking place. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __userpurge sub_305EC930@&lt;eax&gt;(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a1@&lt;eax&gt;, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a2@&lt;edx&gt;, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a3@&lt;ecx&gt;, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a4, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a5, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a6) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v6; <span class="hljs-comment"><span class="hljs-comment">// esi int v7; // ebx int v8; // edi int v9; // edx int v10; // ecx size_t v11; // eax _WORD *v12; // ebp size_t v13; // eax size_t v14; // eax int v15; // eax unsigned __int16 *v16; // ecx _WORD *v17; // eax _WORD *v18; // ecx int v19; // edx __int16 v20; // bx int v21; // eax _WORD *v22; // ecx int v24; // edx int v25; // eax int v26; // esi int v27; // ebx size_t v28; // eax int v29; // ebp size_t v30; // eax int v31; // esi size_t v32; // eax int v33; // eax unsigned __int16 *v34; // ecx int v35; // eax _WORD *v36; // edx _WORD *v37; // ecx int v38; // eax __int16 v39; // bx int v40; // eax _WORD *v41; // ecx int v42; // [esp+10h] [ebp-48h] int v43; // [esp+10h] [ebp-48h] int v44; // [esp+14h] [ebp-44h] char v45; // [esp+14h] [ebp-44h] int Dst[16]; // [esp+18h] [ebp-40h] int v47; // [esp+5Ch] [ebp+4h] int v48; // [esp+60h] [ebp+8h] v6 = a1; v7 = a1 &amp; 0xF; v8 = a2; if ( !a5 ) { v24 = a4 - a1; v25 = a1 - a3; v43 = a4 - v6; if ( v7 &gt;= v25 ) v7 = v25; v47 = a4 - v7; v26 = v6 - v7; v27 = v7 + 1; v48 = v27; if ( !v8 ) return v27; v28 = 4 * v24; if ( (4 * v24) &gt; 0x40 ) v28 = 64; v45 = v27 + v26; v29 = (v27 + v26) &amp; 0xF; memmove(Dst, (v8 + 4 * v29), v28); v30 = 4 * v27; if ( (4 * v27) &gt; 0x40 ) v30 = 64; v31 = v26 &amp; 0xF; memmove((v8 + 4 * (v47 &amp; 0xF)), (v8 + 4 * v31), v30); v32 = 4 * v43; if ( (4 * v43) &gt; 0x40 ) v32 = 64; memmove((v8 + 4 * v31), Dst, v32); if ( !a6 ) return v48; v33 = v29; if ( v29 &lt; v29 + v43 ) { v34 = (v8 + 4 * v29 + 214); do { Dst[v33++] = *v34 &gt;&gt; 15; v34 += 2; } while ( v33 &lt; v29 + v43 ); } v35 = (v45 - 1) &amp; 0xF; if ( v35 &gt;= v31 ) { v36 = (v8 + 4 * ((v27 + v47 - 1) &amp; 0xF) + 214); v37 = (v8 + 4 * ((v45 - 1) &amp; 0xF) + 214); v38 = v35 - v31 + 1; do { v39 = *v37 ^ (*v37 ^ *v36) &amp; 0x7FFF; v37 -= 2; *v36 = v39; v36 -= 2; --v38; } while ( v38 ); v27 = v48; } v40 = v31; if ( v31 &gt;= v31 + v43 ) return v27; v41 = (v8 + 4 * v31 + 214); do { *v41 = *v41 &amp; 0x7FFF | (LOWORD(Dst[v40++]) &lt;&lt; 15); v41 += 2; } while ( v40 &lt; v31 + v43 ); return v27; } v9 = a1 - a4; v10 = a3 - a1; v42 = a1 - a4; v48 = 16 - v7; if ( 16 - v7 &gt;= v10 ) v48 = v10; if ( !v8 ) return v48; v11 = 4 * v9; if ( (4 * v9) &gt; 0x40 ) v11 = 64; v12 = (v8 + 4 * (a4 &amp; 0xF)); v44 = a4 &amp; 0xF; memmove(Dst, v12, v11); v13 = 4 * v48; if ( (4 * v48) &gt; 0x40 ) v13 = 64; memmove(v12, (v8 + 4 * v7), v13); v14 = 4 * v42; if ( (4 * v42) &gt; 0x40 ) v14 = 64; memmove((v8 + 4 * ((a4 + v48) &amp; 0xF)), Dst, v14); if ( !a6 ) return v48; v15 = a4 &amp; 0xF; if ( v44 &lt; v44 + v42 ) { v16 = (v8 + 4 * v44 + 214); do { Dst[v15++] = *v16 &gt;&gt; 15; v16 += 2; } while ( v15 &lt; v44 + v42 ); } if ( v7 &lt; v48 + v7 ) { v17 = (v8 + 4 * v7 + 214); v18 = v12 + 107; v19 = v48; do { v20 = *v17 ^ (*v17 ^ *v18) &amp; 0x7FFF; v17 += 2; *v18 = v20; v18 += 2; --v19; } while ( v19 ); } v21 = a4 &amp; 0xF; if ( v44 &gt;= v44 + v42 ) return v48; v22 = (v8 + 4 * (v44 + v48) + 214); do { *v22 = *v22 &amp; 0x7FFF | (LOWORD(Dst[v21++]) &lt;&lt; 15); v22 += 2; } while ( v21 &lt; v44 + v42 ); return v48; }</span></span></code> </pre> </div></div><br><p>  In addition, in appearance, you can roughly understand what is happening there, and finish the rest by indirect signs. <br>  Let's try to identify these indirect signs.  First, we set the height for rows 16 through 64 inclusive in a random order.  Then before the next one under the index 39 we insert a new row.  The new row will copy the height of row 38. <br>  Let's look at the information in the row groups before and after adding the row, I highlighted the bold differences: </p><br><table><thead><tr><th>  Before adding a row </th><th>  After adding a row </th></tr></thead><tbody><tr><td>  Offsets in the first group: </td><td>  Offsets in the first group: </td></tr><tr><td>  0E, 04, 07, 00, 05, 0A, 09, 0F, 03, 06, 08, 0D, 01, 0B, 0C, 02 </td><td>  0E, 04, 07, 00, 05, 0A, 09, 0F, 03, 06, 08, 0D, 01, 0B, 0C, 02 </td></tr><tr><td>  The values ‚Äã‚Äãof the heights of the rows in the first group: </td><td>  The values ‚Äã‚Äãof the heights of the rows in the first group: </td></tr><tr><td>  05, 2B, 35, 45, 4B, 50, 5B, 6B, 7B, 8B, A5, AB, B0, B5, E0, 100 </td><td>  05, 2B, 35, 45, 4B, 50, 5B, 6B, 7B, 8B, A5, AB, B0, B5, E0, 100 </td></tr><tr><td>  Offsets in the second group: </td><td>  Offsets in the second group: </td></tr><tr><td>  06, 02, 0E, 09, 01, 07, <strong>0F, 0C</strong> , 00, 0A, 04, 0B, 03, 08, <strong>0D, 05</strong> </td><td>  06, 02, 0E, 09, 01, 07, <strong>0F, 05, 0C</strong> , 00, 0A, 04, 0B, 03, 08, <strong>0D</strong> </td></tr><tr><td>  The values ‚Äã‚Äãof the heights of the rows in the second group: </td><td>  The values ‚Äã‚Äãof the heights of the rows in the second group: </td></tr><tr><td>  10, 15, 20, 25, 30, <strong>75</strong> , 85, 90, 9B, A0, C5, CB, D0, D5, E5, F0 </td><td>  10, 15, 20, 25, 30, <strong>F0</strong> , 85, 90, 9B, A0, C5, CB, D0, D5, E5, F0 </td></tr><tr><td>  Offsets in the third group: </td><td>  Offsets in the third group: </td></tr><tr><td>  0C, 08, 0E, 07, 0A, 01, 06, 0F, 09, 0D, 00, 05, 0B, 02, 04, <strong>03</strong> </td><td>  <strong>03</strong> , 0C, 08, 0E, 07, 0A, 01, 06, 0F, 09, 0D, 00, 05, 0B, 02, 04 </td></tr><tr><td>  The values ‚Äã‚Äãof the heights of the rows in the third group: </td><td>  The values ‚Äã‚Äãof the heights of the rows in the third group: </td></tr><tr><td>  0B, 1B, 3B, <strong>40</strong> , 55, 60, 65, 70, 80, 95, BB, C0, DB, EB, F5, FB </td><td>  0B, 1B, 3B, <strong>75</strong> , 55, 60, 65, 70, 80, 95, BB, C0, DB, EB, F5, FB </td></tr><tr><td>  Offsets in the fourth group: </td><td>  Offsets in the fourth group: </td></tr><tr><td>  _ </td><td>  <strong>00</strong> </td></tr><tr><td>  The values ‚Äã‚Äãof the heights of the rows in the fourth group: </td><td>  The values ‚Äã‚Äãof the heights of the rows in the fourth group: </td></tr><tr><td>  _ </td><td>  <strong>40</strong> </td></tr></tbody></table><br><p>  It turns out that it was expected: Excel inserts a new row in the second group with index 7 (39 &amp; 0xF), whose offset is 0x05, copies the row height of index 6, while the last row, which was offset 05, is pushed into the next group, and from there the last row is pushed into the fourth, etc. </p><br><p>  Now let's see what happens if you delete the 29th row. </p><br><table><thead><tr><th>  Before removing a row </th><th>  After removing a row </th></tr></thead><tbody><tr><td>  Offsets in the first group: </td><td>  Offsets in the first group: </td></tr><tr><td>  0E, 04, 07, 00, 05, 0A, 09, 0F, 03, 06, 08, 0D, 01, <strong>0B, 0C, 02</strong> </td><td>  0E, 04, 07, 00, 05, 0A, 09, 0F, 03, 06, 08, 0D, 01, <strong>0C, 02, 0B</strong> </td></tr><tr><td>  The values ‚Äã‚Äãof the heights of the rows in the first group: </td><td>  The values ‚Äã‚Äãof the heights of the rows in the first group: </td></tr><tr><td>  05, 2B, 35, 45, 4B, 50, 5B, 6B, 7B, 8B, A5, <strong>AB</strong> , B0, B5, E0, 100 </td><td>  05, 2B, 35, 45, 4B, 50, 5B, 6B, 7B, 8B, A5, <strong>85</strong> , B0, B5, E0, 100 </td></tr><tr><td>  Offsets in the second group: </td><td>  Offsets in the second group: </td></tr><tr><td>  <strong>06</strong> , 02, 0E, 09, 01, 07, 0F, 05, 0C, 00, 0A, 04, 0B, 03, 08, 0D </td><td>  02, 0E, 09, 01, 07, 0F, 05, 0C, 00, 0A, 04, 0B, 03, 08, 0D, <strong>06</strong> </td></tr><tr><td>  The values ‚Äã‚Äãof the heights of the rows in the second group: </td><td>  The values ‚Äã‚Äãof the heights of the rows in the second group: </td></tr><tr><td>  10, 15, 20, 25, 30, F0, <strong>85</strong> , 90, 9B, A0, C5, CB, D0, D5, E5, F0 </td><td>  10, 15, 20, 25, 30, F0, <strong>75</strong> , 90, 9B, A0, C5, CB, D0, D5, E5, F0 </td></tr><tr><td>  Offsets in the third group: </td><td>  Offsets in the third group: </td></tr><tr><td>  <strong>03</strong> , 0C, 08, 0E, 07, 0A, 01, 06, 0F, 09, 0D, 00, 05, 0B, 02, 04 </td><td>  0C, 08, 0E, 07, 0A, 01, 06, 0F, 09, 0D, 00, 05, 0B, 02, 04, <strong>03</strong> </td></tr><tr><td>  The values ‚Äã‚Äãof the heights of the rows in the third group: </td><td>  The values ‚Äã‚Äãof the heights of the rows in the third group: </td></tr><tr><td>  0B, 1B, 3B, <strong>75</strong> , 55, 60, 65, 70, 80, 95, BB, C0, DB, EB, F5, FB </td><td>  0B, 1B, 3B, <strong>40</strong> , 55, 60, 65, 70, 80, 95, BB, C0, DB, EB, F5, FB </td></tr><tr><td>  Offsets in the fourth group: </td><td>  Offsets in the fourth group: </td></tr><tr><td>  00 </td><td>  00 </td></tr><tr><td>  The values ‚Äã‚Äãof the heights of the rows in the fourth group: </td><td>  The values ‚Äã‚Äãof the heights of the rows in the fourth group: </td></tr><tr><td>  <strong>40</strong> </td><td>  <strong>50</strong> </td></tr></tbody></table><br><p>  In principle, when deleting a row, the operations are inverse to the insert.  At the same time, the fourth group continues to exist and the value of the row height is filled there with the standard height with the corresponding flag - 0x8005. </p><br><p>  This data is enough to reproduce this algorithm in C #: </p><br><div class="spoiler">  <b class="spoiler_title">InsertRow</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InsertRow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SheetLayoutInfo sheetLayoutInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &gt;= sheetLayoutInfo.MaxRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; RowHeightInfo etalonRowHeightInfo = GetRowHeightCore(sheetLayoutInfo, rowIndex); RowHeightInfo newRowHeightInfo = etalonRowHeightInfo != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? etalonRowHeightInfo.Clone() : CreateDefaultRowHeight(sheetLayoutInfo); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> realGroupIndex = (rowIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> newRowInGroupIndex = (rowIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> groupIndex; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (groupIndex = realGroupIndex + sheetLayoutInfo.GroupIndexDelta; groupIndex &lt; sheetLayoutInfo.RowsGroups.Count; groupIndex++, newRowInGroupIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex == SheetLayoutInfo.MaxGroupsCount) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; RowsGroupInfo rowsGroupInfo = sheetLayoutInfo.RowsGroups[groupIndex]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowsGroupInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((newRowHeightInfo.Flags &amp; CustomHeightMask) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; rowsGroupInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo(); sheetLayoutInfo.RowsGroups[groupIndex] = rowsGroupInfo; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowInfoIndex = rowsGroupInfo.Indices[newRowInGroupIndex]; RowHeightInfo lastRowHeightInGroup; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowInfoIndex == <span class="hljs-number"><span class="hljs-number">-1</span></span> || rowsGroupInfo.HeightInfos.Count &lt; SheetLayoutInfo.MaxRowsCountInGroup) { lastRowHeightInGroup = GetRowHeightCore(sheetLayoutInfo, ((groupIndex - sheetLayoutInfo.GroupIndexDelta) &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) + SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span>); Array.Copy(rowsGroupInfo.Indices, newRowInGroupIndex, rowsGroupInfo.Indices, newRowInGroupIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>, SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span> - newRowInGroupIndex); rowsGroupInfo.HeightInfos.Add(newRowHeightInfo); rowsGroupInfo.Indices[newRowInGroupIndex] = rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lastIndex = rowsGroupInfo.Indices[SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span>]; lastRowHeightInGroup = rowsGroupInfo.HeightInfos[lastIndex]; Array.Copy(rowsGroupInfo.Indices, newRowInGroupIndex, rowsGroupInfo.Indices, newRowInGroupIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>, SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span> - newRowInGroupIndex); rowsGroupInfo.HeightInfos[lastIndex] = newRowHeightInfo; rowsGroupInfo.Indices[newRowInGroupIndex] = lastIndex; } newRowHeightInfo = lastRowHeightInGroup ?? CreateDefaultRowHeight(sheetLayoutInfo); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((newRowHeightInfo.Flags &amp; CustomHeightMask) != <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; groupIndex != SheetLayoutInfo.MaxGroupsCount) { SetRowHeight(((groupIndex - sheetLayoutInfo.GroupIndexDelta) &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) + newRowInGroupIndex, newRowHeightInfo.Value, newRowHeightInfo.Flags, sheetLayoutInfo); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sheetLayoutInfo.MaxRowIndexNonDefault = Math.Min(sheetLayoutInfo.MaxRowIndexNonDefault + <span class="hljs-number"><span class="hljs-number">1</span></span>, SheetLayoutInfo.MaxRowsCount); } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">RemoveRow</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveRow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SheetLayoutInfo sheetLayoutInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &gt;= sheetLayoutInfo.MaxRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> realGroupIndex = rowIndex &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> newRowInGroupIndex = rowIndex &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> groupIndex; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (groupIndex = realGroupIndex + sheetLayoutInfo.GroupIndexDelta; groupIndex &lt; sheetLayoutInfo.RowsGroups.Count; groupIndex++, newRowInGroupIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex &lt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { sheetLayoutInfo.RowsGroups.Insert(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); sheetLayoutInfo.GroupIndexDelta++; groupIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex == SheetLayoutInfo.MaxGroupsCount) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newRowHeightInfo = groupIndex == SheetLayoutInfo.MaxGroupsCount - <span class="hljs-number"><span class="hljs-number">1</span></span> ? <span class="hljs-literal"><span class="hljs-literal">null</span></span> : GetRowHeightCore(sheetLayoutInfo, (groupIndex - sheetLayoutInfo.GroupIndexDelta + <span class="hljs-number"><span class="hljs-number">1</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>); RowsGroupInfo rowsGroupInfo = sheetLayoutInfo.RowsGroups[groupIndex]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowsGroupInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newRowHeightInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || (newRowHeightInfo.Flags &amp; CustomHeightMask) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; rowsGroupInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo(); sheetLayoutInfo.RowsGroups[groupIndex] = rowsGroupInfo; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newRowHeightInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { newRowHeightInfo = CreateDefaultRowHeight(sheetLayoutInfo); } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowInfoIndex = rowsGroupInfo.Indices[newRowInGroupIndex]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowInfoIndex == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = newRowInGroupIndex; i &lt; SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span>; i++) { rowsGroupInfo.Indices[i] = rowsGroupInfo.Indices[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]; } rowsGroupInfo.HeightInfos.Add(newRowHeightInfo); rowsGroupInfo.Indices[SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span>] = rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = newRowInGroupIndex; i &lt; rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; i++) { rowsGroupInfo.Indices[i] = rowsGroupInfo.Indices[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]; } rowsGroupInfo.Indices[rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>] = rowInfoIndex; rowsGroupInfo.HeightInfos[rowInfoIndex] = newRowHeightInfo; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(rowIndex &lt;= sheetLayoutInfo.MinRowIndexNonDefault) { sheetLayoutInfo.MinRowIndexNonDefault = Math.Max(sheetLayoutInfo.MinRowIndexNonDefault - <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } }</code> </pre> </div></div><br><p>  <a href="https://gist.github.com/tdkkdt/1cc84ac8a9e201201f8b5aa2e5fe1ed2"><strong>All the above code can be found on GitHub</strong></a> </p><br><h2 id="vyvody">  findings </h2><br><p>  Excel code is not the first time surprising interesting techniques.  This time I found out how he keeps information about the heights of the rows.  If the community is interested, in the next article I will show how Excel considers the height of the range of cells (spoiler: there is something similar to the SQRT decomposition, but for some reason without caching sums), there you can also see how it applies scaling in integers . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/435426/">https://habr.com/ru/post/435426/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../435416/index.html">DIY project technique. Part intro</a></li>
<li><a href="../435418/index.html">Using SQLite in Flutter</a></li>
<li><a href="../435420/index.html">The future of the fight against crime is the study of tree genealogies</a></li>
<li><a href="../435422/index.html">How in Silicon Valley relate to experienced people</a></li>
<li><a href="../435424/index.html">Parse & Android: recommendations for novice developers</a></li>
<li><a href="../435428/index.html">Remote control of Fceux emulator using Python</a></li>
<li><a href="../435430/index.html">The coolest new CES 2019</a></li>
<li><a href="../435432/index.html">New Year, New GitHub: Unlimited Free Private Repositories</a></li>
<li><a href="../435434/index.html">We use annotations in PHP to the maximum</a></li>
<li><a href="../435436/index.html">5 IT infrastructure trends: forecast for 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>