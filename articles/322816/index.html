<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automated testing of bots for Telegram</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It seems that time is a river that suddenly pereklinilo, and she decided to flow in a circle. It is this impression that appears at first glance when ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automated testing of bots for Telegram</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/a96/477/6d8/a964776d86b8468186fd9ef7f749fe0f.gif" align="left">  It seems that time is a river that suddenly pereklinilo, and she decided to flow in a circle.  It is this impression that appears at first glance when you see that bots in messengers have become popular again.  But this impression is deceptive.  A lot has changed - the power behind the bots, the ability for them to process multimedia information, the availability of information about users, the scope of coverage ... In general, this is clearly not a nostalgic trend, but a really useful technology that will continue to evolve. <br><br>  Bots are getting harder, they take on many of the functions of other channels.  For example, instead of making phone calls and listening to the recorded girl for half an hour, which tells you to go into tone mode and type a magic sequence of characters, the same can be done with the help of a bot.  And it will be faster, more convenient, more flexible and cheaper. <br><br>  For some personal project, I wanted to write a bot with a rather complex branching logic (for example, it could be a support or diagnostic system with deep nesting).  At the same time, the graph of this logic has a huge number of ramifications.  In general, it quickly became apparent that automated testing is indispensable - otherwise, I will definitely miss something.  And how much I was surprised when I learned that <a href="http://stackoverflow.com/questions/36891407/use-telegram-client-for-bot-testing-not-bot-api/42489240">there is simply no</a> way to test the logic of bots! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Of course, you can register an additional bot for testing, but this is a variant of the curve and ugly.  Appeal to external api during tests, a stub that will not allow anyone to communicate with the bot, a limit on the speed of sending messages once a second ... If you send a message once a second, a graph from some 60 vertices will be tested for more than a minute!  And I'm not talking about the fact that we have no way to simulate the increased load on the bot, with which it rests on the limit of 30 messages per second ... In general, I realized that again I would have to do something different. <br><a name="habracut"></a><br><h2>  Two solutions to the problem </h2><br><h3>  Superstructure </h3><br>  The first option with a huge speed of implementation is just an add-on over the most popular Node.JS library for the implementation of Telegram bots - <a href="https://www.npmjs.com/package/node-telegram-bot-api">node-telegram-bot-api</a> .  Made quite simple - an event handler is rewritten to send data, after which we process the data using our own method and send a manually generated request.  It looks like this: <br><br><pre><code class="javascript hljs">describe(<span class="hljs-string"><span class="hljs-string">'Telegram Test'</span></span>, ()=&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> myBot = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestBot(telegramBot); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> testChat = <span class="hljs-number"><span class="hljs-number">0</span></span>; it(<span class="hljs-string"><span class="hljs-string">'should greet Masha'</span></span>, () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> telegramTest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TelegramTest(telegramBot); testChat++; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> telegramTest.sendUpdate(testChat, <span class="hljs-string"><span class="hljs-string">'/ping'</span></span>) .then(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">)=&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data.text === <span class="hljs-string"><span class="hljs-string">'pong'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> telegramTest.sendUpdate(testChat, <span class="hljs-string"><span class="hljs-string">'/start'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">`Wrong answer for ping! (was </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${data.text}</span></span></span><span class="hljs-string">)`</span></span>); }) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">=&gt;</span></span> telegramTest.sendUpdate(testChat, data.keyboard[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>].text)) .then(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">)=&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data.text === <span class="hljs-string"><span class="hljs-string">'Hello, Masha!'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'Wrong greeting!'</span></span>); }); }); });</code> </pre> <br>  You can find the bot that is used for this example on the library page, as well as this example itself - you do not want to give an extra copy-peysta. <br><br><h3>  Own server of API Telegram </h3><br>  The solution above is good for quickly testing some simple things and will cover most of the testing needs.  However, what to do if we want to, say, test how our bot works under heavy load?  In this case, the only logical way out is to implement your own Telegram API.  It sounds pretty scary, but in fact we need a simple implementation that is compatible with current libraries for bots and allows us to send client requests.  By the way, as a side feature - it turns out that we are making a full-fledged server with which you can work from any other technology stack - at least a python, at least C #, at least. <br><br>  To make the long story short, I made this option.  With him, testing the logic of the same bot looks like this: <br><br><pre> <code class="javascript hljs"> it(<span class="hljs-string"><span class="hljs-string">'should greet Masha'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFull</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.slow(<span class="hljs-number"><span class="hljs-number">400</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.timeout(<span class="hljs-number"><span class="hljs-number">800</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> serverConfig = {<span class="hljs-attr"><span class="hljs-attr">port</span></span>: <span class="hljs-number"><span class="hljs-number">9000</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> server = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TelegramServer(serverConfig); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> token = <span class="hljs-string"><span class="hljs-string">'sampleToken'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> client = server.getClient(token); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> message = client.makeMessage(<span class="hljs-string"><span class="hljs-string">'/start'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> telegramBot, testBot; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> server.start() .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">=&gt;</span></span> client.sendMessage(message)) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">=&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> botOptions = {<span class="hljs-attr"><span class="hljs-attr">polling</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">baseApiUrl</span></span>: server.ApiURL}; telegramBot = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TelegramBot(token, botOptions); testBot = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestBot(telegramBot); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.getUpdates(); }) .then(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">updates</span></span></span><span class="hljs-function">)=&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(colors.blue(<span class="hljs-string"><span class="hljs-string">`Client received messages: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-built_in"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-built_in">JSON</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.stringify(updates.result)}</span></span></span><span class="hljs-string">`</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (updates.result.length !== <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'updates queue should contain one message!'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> keyboard = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(updates.result[<span class="hljs-number"><span class="hljs-number">0</span></span>].message.reply_markup).keyboard; message = client.makeMessage(keyboard[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>].text); client.sendMessage(message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.getUpdates(); }) .then(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">updates</span></span></span><span class="hljs-function">)=&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(colors.blue(<span class="hljs-string"><span class="hljs-string">`Client received messages: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-built_in"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-built_in">JSON</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.stringify(updates.result)}</span></span></span><span class="hljs-string">`</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (updates.result.length !== <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'updates queue should contain one message!'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (updates.result[<span class="hljs-number"><span class="hljs-number">0</span></span>].message.text !== <span class="hljs-string"><span class="hljs-string">'Hello, Masha!'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'Wrong greeting message!'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }) });</code> </pre> <br>  That is, we are raising a server on our local port, further standardly setting up the bot to work with this server, and simply send it messages from bots and clients.  The client object can be obtained directly from the server, or you can write your client - the server simply accepts messages in standard JSON format at a specific address. <br><br><h2>  Todo </h2><br>  Of course, there are a huge amount of all sorts of useful things that can be added.  For example, now the message queue is stored simply in an array in RAM.  Timeout emulation is not implemented, and only one client is supported at the same time (the server simply sends all messages to the client, who applied to it for data from a specific bot identified by a token).  There is also support only for sending text messages.  This is due to the fact that I currently only interested in the text. <br><br>  The first project is nothing special to add, and the second is likely to develop in the direction of my personal needs.  But I‚Äôm looking forward to the support of the open source community.  MIT license, support for Node.js 4 and 6 (5 will also work, but it will not pass tests, because the bot used for the test is incompatible with Node 5. However, I already created a <a href="https://github.com/yagop/node-telegram-bot-api/pull/298">pull request</a> for this), repositories are waiting for your pull requests from the code issued by the linter configuration included in the project.  There are some tests too.  Perhaps over time there will be support for bots for other instant messengers. <br><br>  If you are interested in the theme of bots, then stay in touch.  It will be interesting. <br><br><h2>  Links </h2><br><ol><li>  <a href="https://www.npmjs.com/package/telegram-test">The first implementation</a> (add-on node-telegram-bot-api); </li><li>  <a href="https://www.npmjs.com/package/telegram-test-api">The second implementation</a> (Telegram API emulation); </li><li>  <a href="https://habrahabr.ru/post/317666/">A good article</a> about dealing with restrictions on the speed of sending messages to go; </li><li>  <a href="https://core.telegram.org/bots/faq">Official limits</a> on the speed of sending messages. </li></ol></div><p>Source: <a href="https://habr.com/ru/post/322816/">https://habr.com/ru/post/322816/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../322802/index.html">How I got into the PayPal server through a bug in downloading files and got access to remote code execution</a></li>
<li><a href="../322804/index.html">Choosing the right error handling strategy (parts 3 and 4)</a></li>
<li><a href="../322806/index.html">A bit about functors and higher order functions in Swift</a></li>
<li><a href="../322812/index.html">The real hero in the programming world: who is he?</a></li>
<li><a href="../322814/index.html">Updating the application code on a running server</a></li>
<li><a href="../322818/index.html">Announcement of HolyJS 2017 Piter: More JavaScript, good and different</a></li>
<li><a href="../322820/index.html">Models of buying advertising in traffic arbitration</a></li>
<li><a href="../322822/index.html">The reverse side of the operation of payment technologies based on NFC and MST</a></li>
<li><a href="../322824/index.html">SK Telecom begins work on quantum cryptosystems</a></li>
<li><a href="../322826/index.html">Lecture about responsibility</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>