<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Samba4 as AD + file server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I will step by step prepare for using Samba4 as a domain controller, along with an additional file server, also based on Samba4. What...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Samba4 as AD + file server</h1><div class="post__text post__text-html js-mediator-article">  In this article, I will step by step prepare for using Samba4 as a domain controller, along with an additional file server, also based on Samba4.  What do we get in the end?  Two configured servers with samba4, the first as a domain controller, the second as a member server with user files.  I have been working on this bundle for about a month, for a sim, I don‚Äôt share the final recipe, I just don‚Äôt have the right ... <br><br><img src="https://habrastorage.org/getpro/habr/post_images/557/ac2/fcf/557ac2fcfe287688c634620b22cbd855.png"><br><br>  A little background: the company uses a file server based on samba3.6 with LDAP Backend, which contains a list of all users and groups with access rights.  Access rights to directories are set using xattr_acl (Extended file attributes), LDAP stores a list of users with matching access groups.  Actually it is required to move from this infrastructure to samba4 ... <br><a name="habracut"></a><br>  1) We are preparing two servers for samba4, I use the SUSE Linux Enterprise 11 Service Pack 3 distribution (SLES11 SP3) as an enterprise standard, so I will deploy everything on its basis.  Then you can build a samba from source, this is optional, but I use a ready-made assembly from sernet, which you can get for free just by registering on the portal - <a href="https://portal.enterprisesamba.com/">Portal Enterprise Samba</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Sernet builds samba for several distributions - Debian, Ubuntu, RHEL, CentOS, SLES, openSUSE. <br>  I used Samba4 version 4.1.6 <br><br>  2) On the first server, which in our country will play the role of DC, install sernet-samba-ad.  If you have any problems, you can look at the official instructions - <a href="https://wiki.samba.org/index.php/Samba_AD_DC_HOWTO">Samba AD DC HOWTO</a> .  We are not forgetting to register the name of our future domain in our DNS server indicating our new server. <br><br>  Next, we perform the creation of a domain using samba-tools. <br><br><pre><code class="bash hljs">samba-tool domain provision --use-rfc2307 --interactive</code> </pre> <br>  The system will ask for several parameters that you need to specify, for example, such as a domain name, etc., and also ask you to set a password.  Actually only the domain name and you need to specify, all other questions can be left with the answers by default.  The administrator password must comply with standard Windows password policies, i.e.  have at least one small and one big letter, as well as numbers, plus at least 8 characters. <br><br>  We copy the newly configured samba Kerberos config to the default location. <br><br><pre> <code class="bash hljs">cp /var/lib/samba/private/krb5.conf /etc/krb5.conf</code> </pre><br>  To verify the correct operation of Kerberos, you can install krb5-client and check the operation of authentication. <br><br><pre> <code class="bash hljs">kinit administrator@EXAMPLE.COM klist</code> </pre><br>  klist should show information on tickets, if everything is ok, go ahead. <br><br>  It is necessary to correct the file / etc / default / sernet-samba <br>  Rule SAMBA_START_MODE = to the next. <br><br><pre> <code class="bash hljs">SAMBA_START_MODE=<span class="hljs-string"><span class="hljs-string">"ad"</span></span></code> </pre><br>  After that, you can run the samba <br><br><pre> <code class="bash hljs">/etc/init.d/sernet-samba-ad start</code> </pre><br>  If the launch was successful, we can assume that our domain controller has already been deployed. <br><br>  We edit the /etc/nsswitch.conf file so that the system sees the users of the domain and the group, and also can properly set permissions on the files.  We bring these two lines to the following form: <br><br><pre> <code class="bash hljs">passwd: compat winbind group: compat winbind</code> </pre><br>  Restart the system and check if it works ... with the help of the getent passwd and getent group.  We need to see groups and users from our domain.  For more information about this step, you can read the official instructions - <a href="https://wiki.samba.org/index.php/Samba4/Winbind">Samba4 / Winbind</a> <br><br>  It remains to enter into the domain of any machine with Windows for administration, I think this will not cause problems. <br><br>  3) On the machine with Windows, which we entered into the domain, install the admin pack.  We use equipment on management of users in AD. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6ae/8eb/466/6ae8eb466a1a4a049129a2a6bde8c25d.png"><br><br>  Each group and user must be assigned to unix uid \ gid for the future normal operation of xattr_acl on our second server. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ecb/219/4d2/ecb2194d2e6566a083f32f9e72bdfc5b.png"><br><br>  4) It's time to start preparing our second server, which will act as a member server and will be a file server in the domain. <br><img align="right" src="https://habrastorage.org/getpro/habr/post_images/41b/979/b0c/41b979b0cf2b340581351b8edc256f14.png"><br>  Install sssd, the standard SLES11 repository has version 1.9.4, which is fine for us.  Also install sssd-tools.  sssd is needed to get users with unix attributes from our domain.  For more information about the setting, you can read in the official instructions - <a href="https://wiki.samba.org/index.php/Local_user_management_and_authentication/sssd">Local user management and authentication / sssd</a> <br>  We will configure AD communications through Kerberos. <br><br>  On the first server (DC), you need to export the keytab from Kerberos. <br><br><pre> <code class="bash hljs">samba-tool domain exportkeytab /etc/krb5.sssd.keytab --principal=__DC$ chown root:root /etc/krb5.sssd.keytab chmod 600 /etc/krb5.sssd.keytab</code> </pre><br>  For safety, we chop off excess rights.  Copy the keytab file to our second server along the same path. <br><br>  Editing sssd.conf <br><br><pre> <code class="bash hljs">[sssd] services = nss, pam config_file_version = 2 domains = default [nss] [pam] [domain/default] ad_hostname = smbad.samba4.servdesk.ru ad_server = smbad.samba4.servdesk.ru ad_domain = samba4.servdesk.ru ldap_schema = rfc2307bis id_provider = ldap access_provider = simple <span class="hljs-comment"><span class="hljs-comment"># on large directories, you may want to disable enumeration for performance reasons enumerate = true auth_provider = krb5 chpass_provider = krb5 ldap_sasl_mech = gssapi ldap_sasl_authid = smbad$@SAMBA4.SERVDESK.RU krb5_realm = SAMBA4.SERVDESK.RU krb5_server = smbad.samba4.servdesk.ru krb5_kpasswd = smbad.samba4.servdesk.ru ldap_krb5_keytab = /etc/krb5.sssd.keytab ldap_krb5_init_creds = true ldap_referrals = false ldap_uri = ldap://smbad.samba4.servdesk.ru ldap_search_base = dc=samba4,dc=servdesk,dc=ru dyndns_update=false ldap_id_mapping=false ldap_user_object_class = user ldap_user_name = samAccountName ldap_user_uid_number = uidNumber ldap_user_gid_number = gidNumber ldap_user_home_directory = unixHomeDirectory ldap_user_shell = loginShell ldap_group_object_class = group ldap_group_name = cn ldap_group_member = member</span></span></code> </pre><br>  Do not forget to correct the name of your DC and your domain on your own.  Put sssd into autorun, reboot the server. <br>  Then you can reset the cache and check our groups with users. <br><br><pre> <code class="bash hljs">sss_cache -UG getent group ... Schema Admins:*:10110:Administrator Domain Users:*:10103: DnsAdmins:*:10117: servdesk:*:10102:<span class="hljs-built_in"><span class="hljs-built_in">test</span></span></code> </pre><br>  The list should include our groups and users with uid \ gid, which we asked in AD for the hardware in Windows. <br><br>  5) Go to setting up samba4 on the second server, install sernet-samba-nmbd, sernet-samba-smbd, sernet-samba-winbind and all dependencies for them.  More details about the setting can be found in the official instructions - <a href="https://wiki.samba.org/index.php/Samba/Domain_Member">Samba / Domain Member</a> <br><br>  Create smb.conf, my file looks like this: <br><br><pre> <code class="bash hljs">[global] workgroup = SAMBA4 security = ADS realm = SAMBA4.SERVDESK.RU <span class="hljs-comment"><span class="hljs-comment"># map untrusted to domain = Yes idmap config *:backend = tdb idmap config *:range = 70001-80000 # idmap config SAMBA4:default = yes idmap config SAMBA4:backend = ad idmap config SAMBA4:schema_mode = rfc2307 idmap config SAMBA4:range = 500-40000 # idmap_ldb:use rfc2307 = yes winbind nss info = rfc2307 winbind trusted domains only = no winbind use default domain = yes # winbind enum users = yes # winbind enum groups = yes #create mask = 0777 #directory mask = 0777 vfs objects = acl_xattr btrfs map acl inherit = Yes store dos attributes = Yes [data1] path = /data1/ read only = no</span></span></code> </pre><br>  We do not forget to correct the config for yourself, you need to change the domain name to yours. <br><br>  We correct our hosts file in it we need to directly specify the name of our member server, otherwise the DNS zones will not be automatically updated in AD. <br><br><pre> <code class="bash hljs">127.0.0.1 localhost 127.0.0.1 samba3.samba4.servdesk.ru samba3</code> </pre><br>  Run the login procedure to our domain. <br><br><pre> <code class="bash hljs">net ads join -U administrator</code> </pre><br>  You will need to enter an administrator password. <br><br>  Actually after this, our member server is already in the domain. <br>  You can try the Windows machine connects to it under your login password and create some folder to check the rights ... <br>  Created a folder 123, check the rights. <br><br><pre> <code class="bash hljs">getfacl /data1/123 <span class="hljs-comment"><span class="hljs-comment"># file: data1/123 # owner: test # group: Domain\040Users user::rwx user:test:rwx group::rx group:servdesk:rwx group:Domain\040Users:rx mask::rwx other::rx default:user::rwx default:user:test:rwx default:group::rx default:group:servdesk:rwx default:group:Domain\040Users:rx default:mask::rwx default:other::rx</span></span></code> </pre><br>  As you can see, all rights are correctly set. <br><br>  Then you can start transferring users to our new domain, as well as set permissions on folders according to your wishes. <br>  You can also use glusterfs along with samba4 to create a fault-tolerant file server, but that's another story ... <br><br>  If anyone has questions, I will be happy to assist. </div><p>Source: <a href="https://habr.com/ru/post/216173/">https://habr.com/ru/post/216173/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216157/index.html">Unicorn became interested in the microworld</a></li>
<li><a href="../216159/index.html">Cellular network in Yakutia: what happens to base stations at -60 Celsius</a></li>
<li><a href="../216163/index.html">Sculpting pixel cartoon Simpsons Coach Gag in Excel</a></li>
<li><a href="../216167/index.html">Chromebook + Haswell = Acer C720</a></li>
<li><a href="../216169/index.html">Interaction of vulnerability scanners with Metasploit. Part 2</a></li>
<li><a href="../216177/index.html">How I did USB MFP wireless</a></li>
<li><a href="../216179/index.html">Data collection methods for analyzing the effectiveness of contextual advertising in offline sales</a></li>
<li><a href="../216181/index.html">C ++ web application, or taming the FastCGI daemon</a></li>
<li><a href="../216185/index.html">Work with Korutins in Unity</a></li>
<li><a href="../216187/index.html">Kohana-form: module of management and form generation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>