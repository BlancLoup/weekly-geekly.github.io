<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Missing Index Case</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The point, of course, is not as interesting as that of Russinovich, but, I hope, it will be useful for some developers. The main purpose of the presen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Missing Index Case</h1><div class="post__text post__text-html js-mediator-article">  <em>The point, of course, is not as interesting as that of Russinovich, but, I hope, it will be useful for some developers.</em>  <em>The main purpose of the presentation is to show the means by which we can analyze the behavior of the program at the lowest level.</em> <br><br>  So, there is an application written in C # that uses the .net framework 1.1 (yes).  After some changes, the application started throwing out such a uninformative exception: <a name="habracut"></a><br><blockquote><code>System.NullReferenceException: Object reference not set to an instance of an object. <br> at System.Data.DataTable. <font color="#0000ff">ResetIndexes</font> () <br> at System.Data.Merger.MergeTable(DataTable src, DataTable dst) <br> at System.Data.Merger.MergeTableData(DataTable src) <br> at System.Data.Merger.MergeTable(DataTable src) <br> at System.Data.DataSet.Merge(DataTable table, Boolean preserveChanges, MissingSchemaAction missingSchemaAction) <br> at Com.Product.App.RequestForm. <font color="#008000">InitEdit</font> (InitRequestArgs args)</code> </blockquote> <br>  InitEdit is a form function in an application that initializes data.  The source code line of the application on which it is thrown: <br><blockquote> <code><font color="black">dsRequestList.Merge(dsLast.Tables[ <font color="#A31515">"TABLE_REQUESTS"</font> ], <font color="#0000ff">false</font> , MissingSchemaAction.Ignore);</font></code> </blockquote> <br>  The code of the ResetIndexes function, which shows us the Reflector, is not very difficult to say: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">internal</font> <font color="#0000ff">void</font> ResetIndexes () </li><li>  { </li><li>  <font color="#0000ff">this</font> .RecomputeCompareInfo (); </li><li>  <font color="#0000ff">if</font> ( <font color="#0000ff">this</font> .indexes! = <font color="#0000ff">null</font> ) </li><li>  { </li><li>  <font color="#0000ff">this</font> .SetShadowIndexes (); </li><li>  <font color="#0000ff">try</font> </li><li>  { </li><li>  <font color="#0000ff">int</font> count = <font color="#0000ff">this</font> .shadowIndexes.Count; </li><li>  <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt;count; i ++) </li><li>  { </li><li>  ((Index) <font color="#0000ff">this</font> .shadowIndexes [i]). Reset (); </li><li>  } </li><li>  } </li><li>  <font color="#0000ff">finally</font> </li><li>  { </li><li>  <font color="#0000ff">this</font> .shadowIndexes = <font color="#0000ff">null</font> ; </li><li>  } </li><li>  } </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  It seems like there are no problems.  The function runs through the indices and causes each <em>Reset</em> .  Where can there be an exception?  <strong>SetShadowIndexes</strong> simply calls " <strong>this.shadowIndexes = this.LiveIndexes;</strong> " So, at the time of execution of line No. 9, <strong>shadowIndexes is</strong> non-zero.  So, it seems reasonable, I think, to assume that somewhere inside this array there is a null element, and, accordingly, falls on line 12. I think the problem is this, I said to myself and went to work. <br><br>  We start windbg, connect to the process, load Son of Strike debugger (sos.dll) into the debugger.  I think everyone knows what it is, and there is no need to explain. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Put a stopping point on our function: <br><br><blockquote> <code>0:023&gt; !bp app.exe Com.Product.App.RequestForm. <font color="#008000">InitEdit</font> <br> Setting breakpoint at : 0xcef7988 <br> bp 0xcef7988 " .echo [DEFAULT] [hasThis] Boolean Com.Product.App.RequestForm.InitEdit(Class Com.Product.Tickets.InitArgs) " <br> Setting breakpoint at : 0xcef7a38 <br> bp 0xcef7a38 " .echo [DEFAULT] [hasThis] Boolean Com.Product.App.RequestForm.InitEdit(Class Com.Product.App.Requests.InitRequestArgs) "</code> </blockquote> <br><br>  (I need only the second function, so turn off the first point with the windbg command: bd 0). <br><br>  You cannot put a stopping point directly on <strong>ResetIndexes</strong> , since the application uses datasets quite intensively and we will have to miss a lot of false calls. <br>  Therefore, the points must be arranged sequentially, as the necessary functions are called. <br><br>  After the debugger stops at <strong>InitEdit</strong> , put a dot on the <strong>DataSet.Merge</strong> : <br><blockquote> <code>0:000&gt; !bp system.data.dll System.Data.DataSet.Merge <br> Setting breakpoint at : 0x8185418 <br> bp 0x8185418 " .echo [DEFAULT] [hasThis] Void System.Data.DataSet.Merge(Class System.Data.DataSet) "</code> </blockquote> <br>  (again, the SoS will put a stop on all overloaded Merge functions, so we get rid of unnecessary ones) <br><br>  After <strong>DataSet.Merge</strong> you need to go to <strong>System.Data.Merger.MergeTable</strong> , from where <strong>DataTable.ResetIndexes</strong> is called. <br><br>  Check that the argument is really the one we expect: <br><blockquote> <code>0:000&gt; !clrstack -a 1 <br> Thread 0 <br> ESP EIP <br> ESP/REG Object Name <br> eax 0x191cca10 Com.Product.App.Requests.dsRequests/TABLE_USERSDataTable <br> ecx 0x1562815c System.Data.Merger <br> <strong>edx</strong> <font color="#0000ff">0x1952b684 System.Data.DataTable</font> <br> esi 0x1562815c System.Data.Merger <br> edi 0x1952b684 System.Data.DataTable <br> 0x0012e9b4 0x08186d00 [DEFAULT] [hasThis] Void System.Data.Merger.MergeTable(Class System.Data.DataTable,Class System.Data.DataTable) <br> EDI 0x1952b684 ESI 0x1562815c EBX 0x00000000 EDX 0x1952b684 ECX 0x1562815c <br> EAX 0x191cca10 EBP 0x0012e9dc ESP 0x0012e9b4 EIP 0x08186d00</code> </blockquote> <br><br>  We look at the name of the table, which is passed as a parameter. <br><blockquote> <code>0:000&gt; !do (edx) <br> Name: System.Data.DataTable <br> MethodTable 0x04a633f8 <br> EEClass 0x04a37244 <br> Size 232(0xe8) bytes <br> GC Generation: 2 <br> mdToken: 0x0200003d (c:\winxp\assembly\gac\system.data\1.0.5000.0__b77a5c561934e089\system.data.dll) <br> FieldDesc*: 0x04a62544 <br> MT Field Offset Type Attr Value Name <br> 0x7b308b0c 0x4000583 0x4 CLASS instance 0x00000000 site <br> ... <br> 0x04a633f8 0x40003fa 0x34 CLASS instance 0x15628170 extendedProperties <br> 0x04a633f8 0x40003fb <font color="#0000ff">0x38 CLASS instance 0x1952bc2c tableName</font> <br> 0x04a633f8 0x40003fc 0x3c CLASS instance 0x00000000 tableNamespace <br> ...</code> </blockquote> <br><br>  The table name is written in the field with offset 0x38 from the beginning of the object. <br><br> <code>0:000&gt; !do poi(edx+38) <br> String: TABLE_USERS</code> <br> <br>  TABLE_USERS - not the table that we need, so go ahead until we meet <br><br><blockquote> <code>0:000&gt; !do <font color="#0000ff">poi(edx+38)</font> <br> String: TABLE_REQUESTS</code> </blockquote> <br><br>  Only then add a <strong>breakpoint</strong> in <strong>ResetIndexes</strong> , run the program further, and stop again. <br><br><blockquote> <code>0:000&gt; g <br> <font color="#0000ff">[DEFAULT] [hasThis] Void System.Data.DataTable.ResetIndexes()</font> <br> eax=191c76ec ebx=00000001 ecx=191c70b4 edx=0006471c esi=19508a4c edi=19221a28 <br> eip=07eff838 esp=0012e988 ebp=191c70b4 iopl=0 nv up ei ng nz na po cy <br> cs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000283 <br> 07eff838 55 push ebp <br> 0:000&gt; <strong>!clrstack -a 1</strong> <br> Thread 0 <br> ESP EIP <br> ESP/REG Object Name <br> eax 0x191c76ec System.Collections.ArrayList <br> ecx <font color="#0000ff">0x191c70b4 Com.Product.App.Requests.dsRequests/TABLE_REQUESTSDataTable</font> <br> esi 0x19508a4c System.Data.DataRow <br> edi 0x19221a28 System.Data.DataTable <br> ebp 0x191c70b4 Com.Product.App.Requests.dsRequests/TABLE_REQUESTSDataTable <br> 0x0012e988 0x07eff838 [DEFAULT] [hasThis] Void System.Data.DataTable.ResetIndexes() <br> EDI 0x19221a28 ESI 0x19508a4c EBX 0x00000001 EDX 0x0006471c ECX 0x191c70b4 <br> EAX 0x191c76ec EBP 0x191c70b4 ESP 0x0012e988 EIP 0x07eff838</code> </blockquote> <br><br>  This is passed to ecx, take it and see what is in the <strong>indexes</strong> field: <br><br><blockquote> <code>0:000&gt; <strong>!do ecx</strong> <br> Name: Com.Product.App.Requests.dsRequests/TABLE_REQUESTSDataTable <br> MethodTable 0x10bb39f4 <br> EEClass 0x10ac9a40 <br> Size 580(0x244) bytes <br> GC Generation: 2 <br> mdToken: 0x02000296 <br> FieldDesc*: 0x10bb2eb4 <br> MT Field Offset Type Attr Value Name <br> 0x7b308b0c 0x4000583 0x4 CLASS instance 0x00000000 site <br> ... <br> 0x04a633f8 0x40003f8 0x2c CLASS <font color="#0000ff">instance 0x191c76ec indexes</font> <br> 0x04a633f8 0x40003f9 0x30 CLASS instance 0x00000000 shadowIndexes <br> 0x04a633f8 0x40003fa 0x34 CLASS instance 0x15629d98 extendedProperties <br> ... <br></code> </blockquote><br><br>  So far, all right.  At the time of entry into <strong>ResetIndexe</strong> s, the indexes field is zero, then set using <strong>SetShadowIndexes</strong> . <br><br><blockquote> <code>0:000&gt; <strong>!dc <font color="#0000ff">0x191c76ec</font></strong> <br> Going to dump the Collection passed. <br> Name: System.Collections.ArrayList <br> GC Generation: 2 <br> <br> Address MT Class Name <br> 0x1557971c 0x08121b80 System.Data.Index <br> 0x1559e420 0x08121b80 System.Data.Index <br> 0x1559e508 0x08121b80 System.Data.Index <br> 0x1559e5f0 0x08121b80 System.Data.Index <br> 0x1559e6d8 0x08121b80 System.Data.Index <br> 0x1559e7c0 0x08121b80 System.Data.Index <br> 0x1559e8a8 0x08121b80 System.Data.Index <br> 0x1559e990 0x08121b80 System.Data.Index <br> 0x1559ea78 0x08121b80 System.Data.Index <br> 0x1559eb60 0x08121b80 System.Data.Index <br> 0x1559ec48 0x08121b80 System.Data.Index <br> 0x1559ed30 0x08121b80 System.Data.Index <br> 0x1559ee18 0x08121b80 System.Data.Index <br> 0x1559ef00 0x08121b80 System.Data.Index <br> 0x1559efe8 0x08121b80 System.Data.Index <br> 0x1559f0d0 0x08121b80 System.Data.Index <br> 0x1559f1b8 0x08121b80 System.Data.Index <br> 0x156f1a9c 0x08121b80 System.Data.Index <br> 0x156f4cd4 0x08121b80 System.Data.Index <br> 0x157962b0 0x08121b80 System.Data.Index <br> 0x157ba910 0x08121b80 System.Data.Index</code> </blockquote> <br><br>  Hmm ... my main theory is falling apart.  There are no zero elements there.  Here is bad luck.  Well, let's continue the execution of the code, and look at the exceptions from inside the windbg.  Release the program.  When an exception occurs, the debugger stops: <br><blockquote> <code>0:000&gt; g <br> (1638.1738): Access violation - code c0000005 (first chance) <br> First chance exceptions are reported before any exception handling. <br> This exception may be expected and handled. <br> eax=191c70b4 ebx=00000015 ecx=00000000 edx=00000014 esi=195b0894 edi=00000014 <br> eip=07eff899 esp=0012e960 ebp=0012e984 iopl=0 nv up ei ng nz ac pe cy <br> cs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00010297 <br> 07eff899 8b01 <font color="#0000ff">mov eax,dword ptr [ecx] ds:0023:00000000=????????</font></code> </blockquote> <br><br>  We execute the <em>! Analyze -v</em> command, the result of which is incredibly punctuated with various kinds of data about the exception that occurred.  I give a compressed form: <br><br> <code>0:000&gt; !analyze -v <br> <br> ******************************************************************************* <br> * * <br> * Exception Analysis * <br> * * <br> ******************************************************************************* <br> <br> FAULTING_IP: <br> +7eff899 <br> 07eff899 8b01 mov eax,dword ptr [ecx] <br> <br> EXCEPTION_RECORD: ffffffff -- (.exr 0xffffffffffffffff) <br> .exr 0xffffffffffffffff <br> ExceptionAddress: 07eff899 <br> ExceptionCode: c0000005 (Access violation) <br> ExceptionFlags: 00000000 <br> NumberParameters: 2 <br> Parameter[0]: 00000000 <br> Parameter[1]: 00000000 <br> <font color="#0000ff">Attempt to read from address 00000000</font> <br> <br> FAULTING_THREAD: 00001738 <br> <br> DEFAULT_BUCKET_ID: NULL_POINTER_READ <br> <br> PROCESS_NAME: App.exe <br> <br> ERROR_CODE: (NTSTATUS) 0xc0000005 - The instruction at "0x%08lx" referenced memory at "0x%08lx". The memory could not be "%s". <br> <br> READ_ADDRESS: 00000000 <br> <br> FAILED_INSTRUCTION_ADDRESS: <br> +7eff899 <br> <font color="#0000ff">07eff899 8b01 mov eax,dword ptr [ecx]</font> <br> <br> NTGLOBALFLAG: 0 <br> <br> APPLICATION_VERIFIER_FLAGS: 0 <br> <br> IP_ON_HEAP: 08186f34 <br> <br> MANAGED_STACK: !dumpstack -EE <br> !dumpstack -EE <br> Thread 0 <br> <font color="#0000ff">Current frame: (MethodDesc 0x4a63200 +0x61 System.Data.DataTable.ResetIndexes)</font> <br> ChildEBP RetAddr Caller,Callee <br> 0012e984 08186f34 (MethodDesc 0x31fcff0 +0x234 System.Data.Merger.MergeTable) <br> 0012e9b0 08185790 (MethodDesc 0x31fd020 +0x48 System.Data.Merger.MergeTableData) <br> 0012e9dc 0818e31f (MethodDesc 0x31fcfe0 +0x2f System.Data.Merger.MergeTable) <br> 0012e9ec 0818e2b1 (MethodDesc 0x7ec0ce8 +0x61 System.Data.DataSet.Merge) <br> 0012ea00 0cef8056 (MethodDesc 0x7c8f8d0 +0x61e Com.Product.App.RequestForm.InitEdit) <br> 0012ec3c 26a117e7 (MethodDesc 0x10eaee98 +0x57 Com.Product.Core.Entities.EntityContextCache..ctor) <br> 0012ec50 0cef79df (MethodDesc 0x7c8f8c0 +0x57 Com.Product.App.RequestForm.InitEdit) <br> 0012ec74 0818d593 (MethodDesc 0x7ec0448 +0x2b Com.CommonComponents.Tools.PerformanceTimer.sAddCheckPoint) <br> 0012ec84 0cef7933 (MethodDesc 0x7c8da68 +0x8b Com.Product.Tickets.Ticket.OnInit) <br> 0012ecb4 0cef7706 (MethodDesc 0x7d509e8 +0x6e Com.Product.App.RequestForm.OnInit) <br> 0012ecf4 0cef766b (MethodDesc 0x7c8da58 +0x1b Com.Product.Tickets.Ticket.Init) <br> [   ] <br> --------- <br></code> <br><br>  Call stack we have already seen, though in a somewhat abbreviated version.  But the code now we will understand.  Let's take a look at the code that caused the exception: <br> <code>07eff899 8b01 mov eax,dword ptr [ecx] ds:0023:00000000=????????</code> <br> <br>  The value is read from the memory at the address that is contained in ECX, and there (in ECX), as we see, zero ... <br><br>  Let's now take a look at the ResetIndexes function, turned by a caring jit compiler into executable code for an x86 processor.  I will repeat the function code in C #, and we will now compare it with the assembly code. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">internal</font> <font color="#0000ff">void</font> ResetIndexes () </li><li>  { </li><li>  <font color="#0000ff">this</font> .RecomputeCompareInfo (); </li><li>  <font color="#0000ff">if</font> ( <font color="#0000ff">this</font> .indexes! = <font color="#0000ff">null</font> ) </li><li>  { </li><li>  <font color="#0000ff">this</font> .SetShadowIndexes (); </li><li>  <font color="#0000ff">try</font> </li><li>  { </li><li>  <font color="#0000ff">int</font> count = <font color="#0000ff">this</font> .shadowIndexes.Count; </li><li>  <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt;count; i ++) </li><li>  { </li><li>  ((Index) <font color="#0000ff">this</font> .shadowIndexes [i]). Reset (); </li><li>  } </li><li>  } </li><li>  <font color="#0000ff">finally</font> </li><li>  { </li><li>  <font color="#0000ff">this</font> .shadowIndexes = <font color="#0000ff">null</font> ; </li><li>  } </li><li>  } </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br><br>  Now disassemble from windbg.  The function is small, but the assembly code is two pages: ( <br><br> <font><code>0:000&gt; !u <br> No value passed in, defaulting to EIP <br> Will print '&gt;&gt;&gt; ' at address: 0x07eff899 <br> Normal JIT generated code <br> [DEFAULT] [hasThis] Void System.Data.DataTable.ResetIndexes() <br> Begin 0x07eff838, size 0xc4 <br> 07eff838 push    ebp <br> 07eff839 mov     ebp,esp <br> 07eff83b sub     esp,18h <br> 07eff83e push    edi <br> 07eff83f push    esi <br> 07eff840 push    ebx                     ;   . <br> 07eff841 mov     dword ptr [ebp-8],0     ; <br> 07eff848 mov     dword ptr [ebp-14h],ecx ;   "ebp-14h"    <br> ;  DataTable,    <br> ;  , this. <br> 07eff84b mov     ecx,dword ptr [ebp-14h] <br> 07eff84e call    07eff420 (System.Data.DataTable.RecomputeCompareInfo) ; (3)     <br> 07eff853 mov     eax,dword ptr [ebp-14h] <br> 07eff856 cmp     dword ptr [eax+2Ch],0   ; (4) if (this.indexes != null) <br> 07eff85a jne <font color="#0000ff"><strong>07eff863</strong></font> <br> 07eff85c pop     ebx <br> 07eff85d pop     esi <br> 07eff85e pop     edi <br> 07eff85f mov     esp,ebp <br> 07eff861 pop     ebp <br> 07eff862 ret                             ; ,    indexes == null <br> <font color="#0000ff"><strong>07eff863</strong></font> mov     ecx,dword ptr [ebp-14h] <br> 07eff866 call    dword ptr ds:[4A634CCh] ; (6) this.LiveIndexes <br> 07eff86c mov     ebx,dword ptr [ebp-14h] <br> 07eff86f lea     edx,[ebx+30h]           ; (6) this.indexes <br> 07eff872 call    01003048                ; (6) indexes = LiveIndexes, , <br> ;  -  <br> ;  SetShadowIndexes, <br> ; , ,  <br> ;     . <br> 07eff877 mov     eax,dword ptr [ebp-14h] ; (9) <br> 07eff87a mov     dword ptr [ebp-18h],eax ; (9) <br> 07eff87d mov     ecx,dword ptr [eax+30h] ; (9) ECX    shadowIndexes. <br> 07eff880 mov     eax,dword ptr [ecx]     ; (9)    : <br> ; (9)     (,    [ecx]) - <br> ; (9)    MethodTable  , <br> 07eff882 call    dword ptr [eax+0D0h]    ; (9)  ,     <br> ; (9)  0xD0     - <br> ; (9)   ,  ArrayList.Count, <br> 07eff888 mov     ebx,eax                 ; (9)     eax. <br> ; (9) ,    07eff877 <br> ; (9)   -    <br> ; (9) int count = this.shadowIndexes.Count; <br> 07eff88a xor     edi,edi                 ;(10) int i = 0; <br> 07eff88c cmp     ebx,0                   ;(10)  , <br> ;(10)  shadowIndexes.Count == 0. <br> 07eff88f jle <font color="#008000"><strong>07eff8cc</strong></font> <br> <font color="#ff0000"><strong>07eff891</strong></font> mov     eax,dword ptr [ebp-18h] ;(12) <br> 07eff894 mov     ecx,dword ptr [eax+30h] ;(12) ECX    shadowIndexes. <br> 07eff897 mov     edx,edi <br> <font color="#0000ff">&gt;&gt;&gt; 07eff    mov     eax,dword ptr [ecx]</font> ;(12)   MethodTable <br> ;(12)   shadowIndexes ( ArrayList) <br> 07eff89b call    dword ptr [eax+0A0h]    ;(12)  shadowIndexes[i] <br> 07eff8a1 mov     edx,eax <br> 07eff8a3 mov     ecx,8121B80h <br> 07eff8a8 call    mscorwks!JIT_ChkCastClass (791e381f)   ;(12) <br> ;(12)  : ((Index)this.shadowIndexes[i]) <br> 07eff8ad mov     esi,eax <br> 07eff8af cmp     dword ptr [esi],eax <br> 07eff8b1 mov     ecx,esi <br> 07eff8b3 call    dword ptr ds:[8121C44h] ;(12)  Index.InitRecords(); <br> 07eff8b9 mov     edx,dword ptr ds:[2208EC4h] <br> 07eff8bf mov     ecx,esi <br> 07eff8c1 call    dword ptr ds:[8121C54h] ;(12)  Index.OnListChanged(); <br> ;(12)  ,  Index.Reset(), <br> ;(12)    <br> ;(12) InitRecords  OnListChanged <br> ;(12)    , <br> <br> 07eff8c7  inc     edi                     ;(10)  i++   for. <br> 07eff8c8  cmp     edi,ebx                 ;(10)  <br> 07eff8ca  jl <font color="#ff0000"><strong>07eff891</strong></font> ;(10)   - "i &lt; count".    . <br> ;(10)      <br> ;(10)  :    <br> ;(10)     . <br> <font color="#008000"><strong>07eff8cc</strong></font> mov     dword ptr [ebp-0Ch],0 <br> 07eff8d3  mov     dword ptr [ebp-8],0FCh <br> 07eff8da  push    7EFF8EEh <br> 07eff8df  jmp     07eff8e1 <br> 07eff8e1  mov     eax,dword ptr [ebp-14h] <br> 07eff8e4  mov     dword ptr [eax+30h],0   ;(17)  shadowIndexes <br> ;(17)   finally. <br> 07eff8eb  pop     eax <br> 07eff8ec  jmp     eax <br> 07eff8ee  mov     dword ptr [ebp-8],0 <br> 07eff8f5  pop     ebx <br> 07eff8f6  pop     esi <br> 07eff8f7  pop     edi <br> 07eff8f8  mov     esp,ebp <br> 07eff8fa  pop     ebp <br> 07eff8fb  ret <br></code></font> <br>  The line on which the exception is generated is marked with "&gt;&gt;&gt;", and it becomes clear that it‚Äôs not a buggy element in the shadowIndexes list that is to blame, but the array itself ‚Äî somewhere in the looping process, the value of shadowIndexes becomes null. <br><br>  Identify the culprit is now quite simple. <br><br>  Let's look at the DataTable fields (0x1990a1d4 - this is the very this value from ECX): <br><blockquote> <code>0:000&gt; dd 0x1990a1d4 + 2c <br> 1990a200 <font color="#0000ff">1990a80c</font> <font color="#008000">1990a80c</font> 15b03c88 0142ea34 <br> 1990a210 00000000 011e11f4 00000000 00000000 <br> 1990a220 01200c24 00000000 00000000 00000000 <br> 1990a230 0124ca7c 155796bc 15579758 00000000 <br> 1990a240 00000000 00000000 155a4c5c 00000000 <br> 1990a250 00000000 00000000 00000000 00000000 <br> 1990a260 15ae8eec 00000000 00000000 1990a824 <br> 1990a270 1990a418 1990a480 1990a4e8 00000002</code> </blockquote> <br><br>  At 1990a200, there are indexes (field with offset 2c), next to it is shadowIndexes.  Put a breakpoint <em>to write</em> to this memory area. <br><br> <code>0:000&gt; ba w 4 <font color="#008000">1990a204</font></code> <br> <br>  And run the program, which after a few unforgettable moments, falls back into the debugger.  It means that a certain value was recorded at the address of interest. <br><br><blockquote> <code>0:000&gt; g <br> Breakpoint 12 hit <br> eax=1990a80c ebx=00000000 ecx=1990a80c edx=1990a204 esi=1990a1d4 edi=1990a1d4 <br> eip=0100304a esp=0012e288 ebp=0012e2b4 iopl=0 nv up ei pl zr na pe nc <br> cs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000246 <br> 0100304a 81f81c825715 cmp eax,1557821Ch</code> </blockquote> <br><br>  We see that the current instruction is ‚Äúcmp eax, 1557821Ch‚Äù.  At first glance, this is strange.  It is shown because such a breakpoint is triggered after a write event. <br><br>  The! Clrstack command displays the call stack, full reflection (the last method in the System.Reflection.RuntimeMethodInfo.InternalInvoke stack, which is not very useful for us). <br><br>  Use dumpstack. <br><br> <code>0:000&gt; !dumpstack -ee <br> Thread 0 <br> Current frame: <br> ChildEBP RetAddr Caller,Callee <br> 0012e284 0814f725 (MethodDesc 0x4a631c0 +0x2d System.Data.DataTable.RecordStateChanged) <br> 0012e2b4 08144d6d (MethodDesc 0x4a63280 +0x1c5 System.Data.DataTable.SetNewRecord) <br> 0012e314 08145b29 (MethodDesc 0x812c488 +0x29 System.Data.DataRow.EndEdit) <br> 0012e328 081458d9 (MethodDesc 0x812c3c8 +0x131 System.Data.DataRow.set_Item) <br> 0012e348 03206651 (MethodDesc 0x812c3a8 +0x49 System.Data.DataRow.set_Item) <br> 0012e360 0320bac2 (MethodDesc 0x7ec3760 +0x5a Com.Product.Core.Entities.EntityAdapter.DBAssign) <br> <font color="#0000ff">0012e394 2ea362d7 (MethodDesc 0x7ec3d90 +0x3f Com.Product.Core.Entities.Request.set_Price) <br> 0012e3b8 2ea359ea (MethodDesc 0x7c8faa0 +0x252 Com.Product.App.RequestForm.UpdatePrice <br> 0012e494 0cefdf89 (MethodDesc 0x7d50218 +0x1a1 Com.Product.App.RequestForm.panel1_RadioButtonsValueRealyChanged)</font> <br> 0012e4b0 7b8808cd (MethodDesc 0x7b9e38c8 +0x45 System.Windows.Forms.Control.AccessibilityNotifyClients) <br> 0012e4c4 0cefd04c (MethodDesc 0xb989dd8 +0x4c Com.Product.CommonControls.DBControls.NullableRadioButtonsPanel.OnRadioButtonsValueReallyChanged) <br> 0012e4e4 7b92a038 (MethodDesc 0x7ba1ea48 +0x68 System.Windows.Forms.RadioButton.set_Checked) <br> 0012e4f0 0cefcda1 (MethodDesc 0xb989d78 +0x111 Com.Product.CommonControls.DBControls.NullableRadioButtonsPanel.set_RadioButtonsValue) <br> 0012e760 799dd8c1 (MethodDesc 0x79bb1468 +0x141 System.Reflection.RuntimeMethodInfo.InternalInvoke) <br> 0012e7a4 799dd768 (MethodDesc 0x79bb1458 +0x18 System.Reflection.RuntimeMethodInfo.Invoke) <br> 0012e7bc 7b1f5c81 (MethodDesc 0x7b328e20 +0x139 System.ComponentModel.ReflectPropertyDescriptor.SetValue) <br> 0012e810 7b8a1973 (MethodDesc 0x7ba38350 +0xd3 System.Windows.Forms.Binding.SetPropValue) <br> 0012e82c 7b8a16d8 (MethodDesc 0x7ba38330 +0x50 System.Windows.Forms.Binding.FormatObject) <br> 0012e840 7b8a1888 (MethodDesc 0x7ba38340 +0x38 System.Windows.Forms.Binding.PushData) <br> 0012e848 7b8a311c (MethodDesc 0x7ba38938 +0x8c System.Windows.Forms.BindingManagerBase.PushData) <br> 0012e85c 7b8bcde7 (MethodDesc 0x7ba38cf8 +0x37 System.Windows.Forms.CurrencyManager.CurrencyManager_PushData) <br> 0012e87c 7b8a1996 (MethodDesc 0x7ba38350 +0xf6 System.Windows.Forms.Binding.SetPropValue) <br> 0012e88c 7b8bdc33 (MethodDesc 0x7ba38df8 +0x5b System.Windows.Forms.CurrencyManager.OnItemChanged) <br> <font color="#0000ff">0012e8ac 7b8a1878 (MethodDesc 0x7ba38340 +0x28 System.Windows.Forms.Binding.PushData)</font> <br> 0012e8b4 7b8a1ad9 (MethodDesc 0x7ba38390 +0x59 System.Windows.Forms.Binding.UpdateIsBinding) <br> 0012e8bc 7b8bdff0 (MethodDesc 0x7ba38e88 +0x110 System.Windows.Forms.CurrencyManager.UpdateIsBinding) <br> 0012e8d0 7b8bdec8 (MethodDesc 0x7ba38e78 +0x8 System.Windows.Forms.CurrencyManager.UpdateIsBinding) <br> 0012e8d4 7b8bd78c (MethodDesc 0x7ba38db8 +0x1c4 System.Windows.Forms.CurrencyManager.List_ListChanged) <br> 0012e900 08181927 (MethodDesc 0x812ce50 +0x37 System.Data.DataView.OnListChanged) <br> 0012e928 10c456ac (MethodDesc 0x812ce40 +0x34 System.Data.DataView.IndexListChanged) <br> 0012e930 10525133 (MethodDesc 0x812ce30 +0x33 System.Data.DataView.FireEvent) <br> 0012e940 10c45663 (MethodDesc 0x31fada0 +0x2b System.Data.DataViewListener.IndexListChanged) <br> 0012e950 0814c5bc (MethodDesc 0x81219d0 +0x1c System.Data.Index.OnListChanged) <br> <font color="#0000ff">0012e958 07eff8c7 (MethodDesc 0x4a63200 +0x8f System.Data.DataTable.ResetIndexes)</font> <br> 0012e984 08186f34 (MethodDesc 0x31fcff0 +0x234 System.Data.Merger.MergeTable) <br> 0012e9b0 08185790 (MethodDesc 0x31fd020 +0x48 System.Data.Merger.MergeTableData) <br> 0012e9dc 0818e31f (MethodDesc 0x31fcfe0 +0x2f System.Data.Merger.MergeTable) <br> 0012e9ec 0818e2b1 (MethodDesc 0x7ec0ce8 +0x61 System.Data.DataSet.Merge) <br> 0012ea00 0cef8056 (MethodDesc 0x7c8f8d0 +0x61e Com.Product.App.RequestForm.InitEdit) <br> 0012ec3c 26a117e7 (MethodDesc 0x10eaee98 +0x57 Com.Product.Core.Entities.EntityContextCache..ctor) <br> 0012ec50 0cef79df (MethodDesc 0x7c8f8c0 +0x57 Com.Product.App.RequestForm.InitEdit) <br> 0012ec74 0818d593 (MethodDesc 0x7ec0448 +0x2b Com.CommonComponents.Tools.PerformanceTimer.sAddCheckPoint) <br> 0012ec84 0cef7933 (MethodDesc 0x7c8da68 +0x8b Com.Product.Tickets.Ticket.OnInit) <br> 0012ecb4 0cef7706 (MethodDesc 0x7d509e8 +0x6e Com.Product.App.RequestForm.OnInit) <br> 0012ecf4 0cef766b (MethodDesc 0x7c8da58 +0x1b Com.Product.Tickets.Ticket.Init) <br> ....</code> <br> <br>  Well, actually, the culprit was found.  The key calls are highlighted in the stack: ResetIndexes raises the OnListChanged event, which smoothly flows into the binding, which calls the UpdatePrice application function.  This function, by coincidence, changes the data in dataset, which leads to the premature vanishing of shadowIndexes. <br><br>  Several movements with tech nano-hammer sisharpa, the culprit is punished, the program works.  Hooray! </div><p>Source: <a href="https://habr.com/ru/post/52441/">https://habr.com/ru/post/52441/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../52433/index.html">Dell: ‚ÄúFreedom netbook!‚Äù</a></li>
<li><a href="../52435/index.html">Famous magazine is looking for authors among habrauzerov</a></li>
<li><a href="../52436/index.html">BenQ all-in-one</a></li>
<li><a href="../52438/index.html">Cartoon "Gypsy": A card inside out</a></li>
<li><a href="../52439/index.html">Bookmarklet to create multi-line status VKontakte</a></li>
<li><a href="../52445/index.html">Contextual advertising for small online stores</a></li>
<li><a href="../52446/index.html">Start</a></li>
<li><a href="../52451/index.html">I downloaded from the torrent - robbed the author</a></li>
<li><a href="../52452/index.html">Drawn blogs</a></li>
<li><a href="../52453/index.html">Planarium. 10,000 tasks.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>