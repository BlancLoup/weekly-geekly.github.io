<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Another option for generating thumbnails for images using AWS Lambda & golang + nodejs + nginx</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello dear users of Habr! 

 My name is Nikita, at the moment I‚Äôm working with a backend developer in a mobile app startup. Finally, I had a really no...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Another option for generating thumbnails for images using AWS Lambda & golang + nodejs + nginx</h1><div class="post__text post__text-html js-mediator-article">  Hello dear users of Habr! <br><br>  My name is Nikita, at the moment I‚Äôm working with a backend developer in a mobile app startup.  Finally, I had a really non-trivial and quite interesting task, the solution of which I want to share with you. <br><br>  What is actually going to talk?  In the developed mobile application has work with images.  As you can easily guess: where there are pictures, there are likely to be previews.  Another condition, practically the first general task that was set for me: to make it all work and scale in the cloud on Amazon.  If there are some lyrics: there was a telephone conversation with an acquaintance of a business partner in hands-free mode, where I received a packet of valuable instructions whose main idea sounds simple: move away from server-side thinking.  Well, ok, we leave so we leave. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Image generation is a rather expensive operation in terms of resources.  This section of the backend predictably did not perform well on this kind of ‚Äúload testing‚Äù that I conducted on a very dead VDS with almost default LAMP settings, at least without additional tuning, where all non-optimized places will come out immediately and guaranteed.  For this reason, I decided to remove this task away from the php backend.  Let him do what gives a more or less uniform load, namely queries to the database, application logic and JSON responses, and so on, of uninteresting API shny routine.  Those who are familiar with Amazon will say: what's the problem?  Why can't I set up scaling EC2 instances in automatic mode and leave this task to PHP?  I answer: ‚Äúso microservice‚Äù.  But seriously - there are a lot of nuances in the context of the backend architecture beyond this article, so I will leave this question unanswered.  Everyone will answer it in the context of their architecture, if it arises.  I just want to propose a solution and you are welcome under the cat. <br><a name="habracut"></a><br>  Introductory: images are stored in the conditional s3 bucket.mydomain, hereinafter referred to everywhere as bucket.  The content of the bucket is considered static and publicly available, but the listing is prohibited, so each object has a public-read ACL, while the bucket non public read itself, the file structure inside the bucket has the form folder / subfolder / filename.ext. <br><br>  This article does not fully describe the architecture of the file work of the backend, only a part is described here (simplified) using the example for the photo preview.  The remaining parts of the backend work with the file system are beyond the scope of this article. <br><br>  I am a supporter of solutions when the image of the desired size is pre-generated and simply given from the file system.  Although there was an experience of applying watermarks dynamically (i.e., the image was always generated in a new way), which showed quite good results (I expected more work than it turned out).  You shouldn‚Äôt be directly afraid to do them dynamically, this approach also has the right to life, but in general I consider the most optimal solution to be when the preview is generated 1 time for some event and then given from the file system, if it is there, in case if not, an attempt is made to generate it again.  This gives quite good controllability and can be useful if the requirements for the size of the preview have changed.  This approach was implemented in the current task.  But there is one important point - it is necessary to "agree" (perhaps with yourself) on the uri-scheme.  In my case (again, simplified again), it looks like this: <br><br><ul><li>  / <b>photo</b> /some/file.jpg - give the source file </li><li>  / <b>prew / preset</b> /some/file.jpg - give preview for file.jpg </li></ul><br>  There is a new word <b>preset</b> , what is it?  In the process of implementation, I thought, and if you parse the second uri segment for width / height, then it turns out you can dig a hole for yourself.  And what will happen if some clever man wants from 1 to over9000 to iterate over the values ‚Äã‚Äãof the second uri segment?  By this, I agreed with the other participants of the development process on the topic of what size thumbnails are needed.  It turned out several "presets" of different sizes, the name of which is transmitted as the second segment of the uri.  Again, returning to the issue of manageability, if for some reason you need to change the size of the preview, it will be enough to correct the environment variables in the prewmanager, which will be discussed a little later, and delete irrelevant files from the file system. <br><br>  In general, the scheme of work looks like the figure: <br><br><img src="https://habrastorage.org/webt/cf/it/g_/cfitg_4ajp6fwzvhhdcholg8sui.png" alt="image"><br><br>  What's going on here: <br>  In request 1, which / <b>photo</b> / nginx proxies the request for s3.  In principle, it does the same in request 2, since the files and previews themselves are stored in one bucket, since  Following the official AWS documentation, the number of objects inside the bucket is unlimited.  But there is one difference, if is indicated on the diagram.  He is engaged in that changes the way of processing 403/404 response from s3.  By the way about 403 answer.  The thing is that if you access the repository WITHOUT credentials (my case), i.e.  actually having access ONLY to public-read objects, then due to the lack of listing rights (Amazon will give 403 instead of 404, this causes an entry in the config file: error_page 403 404 = 404 /404.jpg; A piece of the config where this work looks like : <br><br><pre><code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$s3_bucket</span></span> <span class="hljs-string"><span class="hljs-string">'bucket.s3.amazonaws.com'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$req_proxy_str</span></span> <span class="hljs-variable"><span class="hljs-variable">$s3_bucket</span></span><span class="hljs-variable"><span class="hljs-variable">$1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">error_page</span></span> <span class="hljs-number"><span class="hljs-number">403</span></span> <span class="hljs-number"><span class="hljs-number">404</span></span> =<span class="hljs-number"><span class="hljs-number">404</span></span> /<span class="hljs-number"><span class="hljs-number">404</span></span>.jpg; <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$request_uri</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~* /prew/(.*))</span></span>{ <span class="hljs-attribute"><span class="hljs-attribute">error_page</span></span> <span class="hljs-number"><span class="hljs-number">403</span></span> <span class="hljs-number"><span class="hljs-number">404</span></span> = <span class="hljs-variable"><span class="hljs-variable">@prewmanager</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">proxy_http_version</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Authorization <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$s3_bucket</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Real-IP <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-For <span class="hljs-variable"><span class="hljs-variable">$proxy_add_x_forwarded_for</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_hide_header</span></span> x-amz-id-<span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_hide_header</span></span> x-amz-request-id; <span class="hljs-attribute"><span class="hljs-attribute">proxy_hide_header</span></span> Set-Cookie; <span class="hljs-attribute"><span class="hljs-attribute">proxy_ignore_headers</span></span> <span class="hljs-string"><span class="hljs-string">"Set-Cookie"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_buffering</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_intercept_errors</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://<span class="hljs-variable"><span class="hljs-variable">$req_proxy_str</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /<span class="hljs-number"><span class="hljs-number">404</span></span>.jpg { <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /var/www/error/; internal; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-variable"><span class="hljs-variable">@prewmanager</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://prewnamager_host:8180; <span class="hljs-attribute"><span class="hljs-attribute">proxy_redirect</span></span> http://prewnamager_host:8180 /; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-For <span class="hljs-variable"><span class="hljs-variable">$proxy_add_x_forwarded_for</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-Proto <span class="hljs-variable"><span class="hljs-variable">$scheme</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span> ; }</code> </pre> <br>  As you can see, prewmanager is proxied to some kind of network service.  Here it is the whole point of this article.  This service, written in nodejs, it launches aws lambda written in go, ‚Äúblocks‚Äù further calls to the processed uri until the lambda function completes and returns the result of aws lambda to everyone who waits.  Unfortunately, I can‚Äôt give the whole prewmanager code, so I‚Äôll try to illustrate it with separate sections (forgive) the first fully functional version of the script.  In the production of a more beautiful version, but alas.  However, nevertheless, as ‚Äúunderstand the logic of work‚Äù, it is possible to use this code as a sketch, in my opinion, quite fit. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   requre, process.env.*  .. const lambda = new AWS.Lambda({...}); const rc = redis.createClient(...); const getAsync = promisify(rc.get).bind(rc); function make404Response(response) { //          404  --   } function makeErrorResponse(response) { //       } // AWS Lambda   base64    content-type function makeResultResponse(response, response_payload) { let buff = new Buffer(response_payload.data, 'base64'); response.statusCode = 200; response.setHeader('Content-Type', response_payload.content_type); response.end(buff); return; } http.createServer(async function(request, response) { //    uri,       .. //  redis,    (null)     AWS lambda //               //    --     let reply = false; try { reply = await getAsync(redis_key); } catch (err) { } if(reply === null) { //    30  rc.set(redis_key, 'blocked', 'EX', 30); //      // ,     -- 404 switch (preset) { case "preset_name_1": var request_payload = { src_key: "photo/" + aws_ob_key, src_bucket: src_bucket, dst_bucket: dst_bucket, root_folder: dst_root, preset_name: preset, rewrite_part: "photo", width: 1440 }; var params = { FunctionName: "my_lambda_function_name", InvocationType: "RequestResponse", LogType: "Tail", Payload: JSON.stringify(request_payload), }; lambda.invoke(params, function(err, data) { if (err) { makeErrorResponse(response); } else { rc.set(redis_key, data.Payload, 'EX', 30); let response_payload = JSON.parse(data.Payload); if(response_payload.status == true) { makeResultResponse(response, response_payload); } else { console.log(response_payload.error); makeErrorResponse(response); } } }); break; ... default: make404Response(response); } } else if (reply === false) { //      makeErrorResponse(response); } else { //      2  //     -- blocked //    , ..   if(reply == 'blocked') { let res; let i = 0; const intervalId = setInterval(async function() { try { res = await getAsync(redis_key); } catch (err) { } if (res != null &amp;&amp; res != 'blocked') { let response_payload = JSON.parse(res); if(response_payload.status == true) { makeResultResponse(response, response_payload); } else { console.log(response_payload.error); makeErrorResponse(response); } clearInterval(intervalId); } else { i++; //      if(i &gt; 100) { makeErrorResponse(response); clearInterval(intervalId); } } }, 500); } } }).listen(port);</span></span></code> </pre><br>  Where did radishes come from and why?  In this task, I reasoned: since we are in a cloud where instances with radish I can scale as much as I like on one side, and on the other when there was a question about blocking repeated calls of a function with the same parameters, what if not radishes, which also already used in the project?  Locally keep in memory and write knee ‚Äúgarbadzh collector‚Äù?  Why when you can just stick this data (or the blocking flag in radishes) with a certain time to live and this wonderful tool will take care of all this.  Well, the same is logical. <br><br>  And finally, I‚Äôll quote the entire function code for AWS Lambda that was written in Go.  I ask you not to kick the pain because this is the third binar after ‚Äúhello world‚Äù and there it‚Äôs still in little detail that was written and compiled by me.  Here is a <a href="https://github.com/nikicoder/awslambdaresizer">link to the githab</a> where it is posted, please pull-requests if something is wrong.  But in general, everything works, but as they say there is no limit to perfection.  JSON-payload is required for the function to work, if there are requests, I‚Äôll add instructions on how to test the function, a JSON-payload ªa example, etc. <br><br>  A few words about setting up AWS Lambda: everything is simple there.  Create a function, set enviroments, maximum time and memory allocation.  Pour archive and use.  But there is a nuance that goes beyond the scope of this article: IAM is his name.  The user, the role, the rights will also have to be set up, without this, I fear nothing will come of it. <br><br>  In conclusion, I want to say that this system has already been tested in production, although I cannot boast with highload, but in general there were no problems at all.  In the context of the current political situation: yes, we are one of the first to fall under the blocking of the Amazon.  Literally the very first day.  But the noise did not raise and distract from the work of lawyers, and set up nginx on the Russian hosting.  In general, I believe that Amazon s3 is such a convenient, well-documented and supported storage that due to the <s>baldness of the brazers memeas</s> advisors and other non-surgeon surgeons, at least it is not worth refusing.  And the above nginx config, since all the static on my subdomain is located, almost a line in the line with minimal changes was transferred to a server in the Russian Federation and during the working day everyone forgot about it. <br><br>  Thank you all for your attention. </div><p>Source: <a href="https://habr.com/ru/post/354226/">https://habr.com/ru/post/354226/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354210/index.html">The announcement of the mitap ThinkPHP # 16 in Kharkov</a></li>
<li><a href="../354214/index.html">Payment Management Privat24 from Google-tables</a></li>
<li><a href="../354216/index.html">Forbes: Alibaba and Uber have become the most profitable companies for investors</a></li>
<li><a href="../354220/index.html">Applying recurrent layers to solve multiple paths</a></li>
<li><a href="../354224/index.html">slowpoke is not the fastest database</a></li>
<li><a href="../354228/index.html">Hyper-v cluster of two nodes, without external storage or hyperconvergence on the knee</a></li>
<li><a href="../354230/index.html">What is wrong with 3D PDF and eDrawings. How do we replace the 3D viewer in our application</a></li>
<li><a href="../354232/index.html">How not to go crazy with Scrum? Experience a growing project</a></li>
<li><a href="../354234/index.html">Release Node.js 10 and NPM 6</a></li>
<li><a href="../354236/index.html">Why the creation of a simple preview on the links in Wikipedia took four years</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>