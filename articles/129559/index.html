<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ringed networks, or why do we need STP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The essence of the problem 
 The purpose of the switch network life (also known as a switch) is the relentless forwarding of packets from the sender t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ringed networks, or why do we need STP</h1><div class="post__text post__text-html js-mediator-article"><h4>  The essence of the problem </h4><br>  The purpose of the switch network life (also known as a switch) is the relentless forwarding of packets from the sender to the recipient.  To optimize the operation, the switch contains a so-called.  A CAM table containing the addresses of the devices from which he once received packets, and the numbers of the physical ports from which these same packets were received. <br><br>  In other words, if the switch recently received a packet from computer A on port 1, then the ‚Äúcomp.  A ‚Äù-&gt;‚Äú port 1 ‚Äù, and further packets addressed to computer A, are automatically forwarded <b>only</b> to port 1, and nowhere else, which saves network bandwidth and makes passive traffic interceptors ineffective. <br><br>  But what should a switch do if a broadcast packet arrives? <br>  It is logical to assume that such packets are sent <b>to all ports, in addition, from where they were originally received</b> . <br>  That, with a certain network configuration, can lead to very sad consequences ... <br><a name="habracut"></a><br>  Suppose several switches are connected in such a way that closed loops form in the system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/bf4/99c/5c4/bf499c5c47661cf5ad5bea40e3b0435c.jpg" alt="image"><br><br>  What happens if the broadcast packet comes to switch 1 from the cloud?  He will propagate it and transmit to ports 1, 2 and 3 (the packet came from port 4, so it will not be sent back to it).  Switch 2, having received a packet on port 2, will send copies of it to ports 1 and 3. Switch 3, if it receives a packet on port 1, will send copies of it to ports 2 and 3. Switch 4, after receiving a packet on port 3, will send copies to ports 1 and 2. After that, <b>each</b> copy, being transferred from the device to the device, will be multiplied according to the same scheme more and more until they totally occupy all the available bandwidth (or do not clog the brains of the devices until they lose their functionality). <br><br>  But, at the same time, it‚Äôs impossible to do completely without ‚Äúloops‚Äù in the network, since fault tolerance is the most important feature of a good network.  That is, between any two important nodes of the network (I do not take into account the computer of an ordinary user) there should be more than one physical path in case a channel or an intermediate device fails.  And that means loops. <br><br><h4>  STP to the rescue </h4><br>  The problem of the above-described ‚Äúbroadcast storms‚Äù is solved by the launch of the STP protocol (or one of its extensions) on the switches. <br><br>  <i>The Spanning Tree Protocol, or the protocol of the extending tree, brings the network to a ‚Äútree-like‚Äù view - with the root and the ‚Äúbranches‚Äù growing out of it.</i>  <i>One of the switches becomes the ‚Äúroot‚Äù (root bridge), then all the others calculate the ‚Äúcost‚Äù (cost) of reaching the root from all of its ports that have such an opportunity (that is, in essence, looped off somewhere, far away), and <b>disable</b> all non-optimal links.</i>  <i>Thus, breaking the "loop".</i>  <i>If further failure occurs in the network, and the ‚Äúroot‚Äù suddenly turns out to be unreachable through a working port, the best of the previously blocked ones will turn on and the connection will be restored.</i> <br><br><h5>  And now more </h5><br>  The main workhorse of STP are Bridge Protocol Data Units aka BPDU.  These are ‚Äúprobe‚Äù packets sent by switches and containing: <br>  1) root switch identifier (Root ID); <br>  2) the identifier of the switch that generated the packet (Bridge ID); <br>  3) the cost of the path from the second to the first (Cost); <br>  4) the port from which the BPDU was pulled. <br><br>  Suppose the network just turned on.  Switches about each other do not know anything.  We need to find each other and choose who will become the "root" of the tree.  Switches together begin to pour into all ports of the BPDU, where they indicate the ‚Äúroot‚Äù of themselves (Root ID = Bridge ID). <br><br>  STP works in such a way that it wins the ‚Äúroot picks‚Äù switch with the <b>lowest</b> Bridge ID, which consists of two parts: 2-byte priority (default 32768) and the MAC address of the switch.  Thus, if no settings were made, and all priorities are equal, the switch with the smallest MAC address will win.  There is a very non-zero probability that this will be the oldest (and probably the lowest performing) switch in the organization, with a logical outcome ... Don't forget about this, friends.  Adjust your priorities! <br><br>  So, the switch with the lowest ID ignores the received BPDU comrades and continues to bend its line - to send its BPDU every 2 seconds, the same as the very first one.  It is the ‚Äúroot‚Äù of the topology; it will not disconnect its ports. <br>  But the others, having received a BPDU with a Root ID value less than their own Bridge ID, understand that the ‚Äúroot‚Äù is somewhere there.  They stop sending out their BPDUs.  From now on, they simply relay the ‚Äúroot‚Äù switch BPDU, substituting the Bridge ID for themselves, and recalculating the ‚Äúcost‚Äù of reaching the ‚Äúroot‚Äù (adding their share to the existing BPDU). <br><br>  The value of the cost depends solely on the speed of the interface from which the BPDU came, and can be viewed by those interested in, <a href="http://en.wikipedia.org/wiki/Spanning_Tree_Protocol">for example, here</a> . <br><br>  The port from which the best cost root BPDU was obtained is called the <b>root port</b> , it always works.  Ports from which the worst-cost BPDUs are derived obviously lead to loops, which you should get rid of.  Such links are blocked on one side by the switch, whose Bridge ID is lower.  But they are not completely blocked, because we need to be able to bring them back to life in the event of a failure.  BPDUs in such links continue to be sent and received. <br>  If the Bridge ID is the same in both packets (for example, the switches are connected by more than one cable), the one with the lower number of the sending port is indicated (Fa0 / 1 will win against Fa0 / 2). <br><br><h6>  Types of ports </h6><br>  In the classic STP defined by the 802.1d standard, the ports can be: <br><br>  1) Root port - leads to the root, has the lowest cost among fellows, is included. <br>  2) Designated port - leads not to the ‚Äúroot‚Äù, but in some network segment, it works. <br>  For obvious reasons, the root switch does not have a single root port.  All its ports are designated. <br>  3) Blocked port - leads to the root and has a better path cost.  Blocked for all traffic except BPDU.  On the other hand, on this link there is a working designated port. <br><br><h6>  States and Transitions </h6><br>  But the most interesting is the state of the ports.  Above, I divided them by only 2 - running or blocked.  In fact, there are more of them, for the simple reason that the work of an STP is not at all instantaneous; it takes time.  And to create a storm in the network - it is very fast.  Therefore, ‚Äúto avoid,‚Äù so to speak, the ports pass through a chain of states in the process of work. <br><br>  1) Listening - the port is turned on (plugged in cable / gave power). <br>  Transmit traffic scary - and suddenly a loop?  Therefore, no traffic <b>is transmitted except for BPDU</b> .  We are looking for the root, we estimate which ports will work. <br>  Duration - 15 seconds by default, the diode on the switch blinks orange. <br>  2) Learning <br>  It is still scary to send traffic, but the switch already accepts packets in addition to BPDUs, stores MAC addresses in the CAM table. <br>  Duration - 15 seconds by default. <br>  3) Forwarding <br>  The lightbulb blinked in joyous green, the port was up and transmitting data. <br>  4) Blocking / Disabled <br>  Well here everything is clear by name.  Either the link had to be turned off in order not to create a loop, or the port is administratively turned off. <br><br>  Please note that at least 30 seconds elapse from the moment the port is turned on until the data transfer begins.  In the case of a fast loading computer (or an IP phone stuck into the port), this can be a problem.  (It is decided to turn on the portfast mode, but this is a topic for another conversation.) <br><br>  In the event of a network failure, somewhere where BPDU used to go, they stop walking.  And Blocked ports, which are now receiving the best BPDUs, after waiting for a timeout (20 seconds), are switched to Designated mode, passing a chain of states Listening - Learning - Forwarding (+30 seconds). <br>  Thus, network recovery can take up to 50 seconds.  But, you see, it is much better than the inoperability after a failure in general. <br><br><h4>  And finally </h4><br>  Subsequently, the shortcomings of STP, which I mentioned (slow recovery of network operation), and which I did not mention, were solved by extensions to the protocol. <br>  Consider them briefly. <br><br>  1) RSTP (Rapid, fast) <br><br>  Keeps in memory of the candidate for replacement of the failed Root port (second place in the degree of ‚Äúbest‚Äù), and is able to switch to it very quickly, without waiting for all timers.  Didn't get 3 BPDUs in a row on the Root port?  Switching without much thought. <br><br>  2) PVST + (Per VLAN, over VLAN) <br><br>  Why block the entire link?  A waste of resources!  And let's calculate for each VLAN its topology STP, independent.  Thus, for one VLAN some links will be blocked, and for another - others.  The law is respected and the benefits are certain.  At the same time, in the sent BPDU the VLAN number is stored ... in priority.  The 12 low bits are given as the VLAN number, and of the 4 high bits, the priority is actually formed (having only 16 legal values ‚Äã‚Äãin this scenario, with a step of 4096).  The default priority field for VLAN 3 will thus be 32768 + 3 = 32771. <br><br>  3) Rapid PVST <br><br>  Cisco proprietary combines the properties of the first two. <br><br>  4) MSTP (Multiple) <br><br>  PVST + is good, no doubt, but what if we have over 9000 VLANs?  Calculation of topologies for each of them can greatly load the processor.  And is it necessary if we are not engaged in fine-tuning of each received topology?  MST allows you to group VLANs in the so-called.  Instance (sets), calculating the topology already for these, larger formations. <br><br><h6>  In the process of writing </h6><br>  Wikipedia and the remains of CCNA knowledge in the head were used. <br><br></div><p>Source: <a href="https://habr.com/ru/post/129559/">https://habr.com/ru/post/129559/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../129550/index.html">Increase the speed of calculations in Matlab</a></li>
<li><a href="../129551/index.html">Optimize Ubuntu (and other Linux) under SSD</a></li>
<li><a href="../129554/index.html">On-line + Off-line access to the working mailbox</a></li>
<li><a href="../129557/index.html">The life cycle of UIViewController</a></li>
<li><a href="../129558/index.html">Memory organization in Windows OS</a></li>
<li><a href="../129560/index.html">How mod_rewrite actually works. A guide for continuing</a></li>
<li><a href="../129561/index.html">Principles of partnership in the startup MyClasses.org - the story beckoning to the Dominican Republic</a></li>
<li><a href="../129563/index.html">Added ‚Äúhelicopter mode‚Äù to Google Maps</a></li>
<li><a href="../129564/index.html">On the "top of the world" set the webcam</a></li>
<li><a href="../129566/index.html">New site onepicturetutorial.com - lessons in one picture</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>