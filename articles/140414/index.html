<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Caching in Yii using tags</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Yii allows you to cache data in the form of an array returned directly from the database. 
 And the caching system has different dependencies. But non...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Caching in Yii using tags</h1><div class="post__text post__text-html js-mediator-article">  Yii allows you to cache data in the form of an array returned directly from the database. <br>  And the caching system has different dependencies.  But none of these dependencies allows you to automatically track changes in the table without referring to it (I mean CDbCacheDependency), which is meaningless in a loaded system. <br><br>  For such things came up with the so-called tagging.  Those.  some kind of tag is created, which is saved with all the caches associated with this table.  And as soon as it changes, all related caches must reboot.  As it turned out in Yii, this is done very simply. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is worth mentioning that for more comfort Active Record is used. <br><br>  It is done this way.  Create a new dependency and save it, for example, in components: <br><br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * CTagCacheDependency class. * * CTagCacheDependency represents a dependency based on a autoincrement(timestamp) of tags * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@author</span></span></span><span class="hljs-comment"> Roman &lt;astronin</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@gmail</span></span></span><span class="hljs-comment">.com&gt; * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@since</span></span></span><span class="hljs-comment"> 1.0 */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CTagCacheDependency</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CCacheDependency</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> autoincrement(timestamp) param is used to * check if the dependency has been changed. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $tag; <span class="hljs-comment"><span class="hljs-comment">/** * Cache component, by default used - cache * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> CCache */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $cache; <span class="hljs-comment"><span class="hljs-comment">/** * Name of cache component, by default used - cache * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $cacheName; <span class="hljs-comment"><span class="hljs-comment">/** * Constructor. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $tag value of the tag for module */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($tag=null, $cacheName=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'cache'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;tag=$tag; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheName = $cacheName; } <span class="hljs-comment"><span class="hljs-comment">/** * Generates the data needed to determine if dependency has been changed. * This method returns the integer(timestamp). * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed the data needed to determine if dependency has been changed. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateDependentData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;tag!==<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache = Yii::app()-&gt;getComponent(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheName); $t = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache-&gt;get(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;tag); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($t === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { $t = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache-&gt;set(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;tag, $t); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $t; } } }</code> </pre> <br><br>  In the model we indicate when we will use the new dependency.  Since we want to do this for the whole model, we add code to the <b>beforeFind</b> function: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beforeFind</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache(<span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CTagCacheDependency(get_class(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>))); <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::beforeFind(); }</code> </pre><br><br>  Well, or wherever we want, the main thing here is "$ this-&gt; cache (30, new CTagCacheDependency (get_class ($ this)));" <br><br><ul><li>  30 - cache storage time, but it is better to put this value into a variable </li><li>  CTagCacheDependency - our new dependency class </li><li>  get_class ($ this) - tag name - model name </li></ul><br><br>  As a tag, we simply have the name of a class, a model associated with a particular table. <br><br>  Well, when we delete or save something, we write in the right places (in the functions afterDelete, afterSave): <br><br><pre> <code class="php hljs">Yii::app()-&gt;cache-&gt;set(get_class(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>), microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br><br><ul><li>  0 - endless storage </li><li>  get_class ($ this) - tag name - model name </li><li>  microtime (true) - new tag value </li></ul><br><br>  This way we update the tag associated with this model, and accordingly with the table.  Now that the tag is updated as a result of updating the table, all caches with a dependency on this tag will have to be updated. <br><br>  The default cache is used - component: cache.  But you can specify your other. <br><br>  Used Books: <br><ul><li>  <a href="http://www.opennet.ru/base/dev/memcached_tips.txt.html">http://www.opennet.ru/base/dev/memcached_tips.txt.html</a> </li></ul><br><br>  <b>UPD Important!</b> <br><br>  <b>Updated CTagCacheDependency</b> class <b>code</b> <br><br>  Now the constructor takes the name of the Component as a string.  For example: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache($duration, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CTagCacheDependency(get_class(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>), <span class="hljs-string"><span class="hljs-string">'cache'</span></span>));</code> </pre><br><br>  <b>Made because of incorrect work with memcache.</b> <br><br></div><p>Source: <a href="https://habr.com/ru/post/140414/">https://habr.com/ru/post/140414/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../140404/index.html">Why does the Feistel network work? Explanation "on the fingers"</a></li>
<li><a href="../140405/index.html">Bitcasa has started!</a></li>
<li><a href="../140409/index.html">Django Admin Actions - actions with an intermediate page</a></li>
<li><a href="../140411/index.html">Create moving pictures with Processing</a></li>
<li><a href="../140412/index.html">Muz.ru gives audio for free</a></li>
<li><a href="../140415/index.html">Connecting a color LCD touch screen to a microcontroller</a></li>
<li><a href="../140417/index.html">Intellect cards as a good way to systematize any activity.</a></li>
<li><a href="../140418/index.html">AtContent.com. Internal structure and architecture</a></li>
<li><a href="../140421/index.html">The history of one community or how to change thinking</a></li>
<li><a href="../140422/index.html">Production control</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>