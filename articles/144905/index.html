<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Comparison of the speed of range-based for, foreach (Qt) and some of the STL when calculating the sum of container elements</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I am involved in developing a C ++ project using the Qt framework. In our project, Qt containers are used in many places and the macro foreach is ofte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Comparison of the speed of range-based for, foreach (Qt) and some of the STL when calculating the sum of container elements</h1><div class="post__text post__text-html js-mediator-article">  I am involved in developing a C ++ project using the Qt framework.  In our project, Qt containers are used in many places and the macro foreach is often used to bypass elements.  At one point, I wondered how justified the use of this macro was.  In addition, I really wanted to "touch" c ++ 11 in action.  And that's what I managed to find out at the moment ... <a name="habracut"></a><br><br><h4>  Writing support functions </h4><br>  Containers in STL and Qt do not have a common base class, so an attempt was made to avoid template functions in order not to write a test function for each container, since Qt containers support STL-style iterators. <br>  At the moment, my main function for testing looks like this: <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> TEST_CLASS&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runTests</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> testCycles)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> container = makeTestClass&lt;TEST_CLASS&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> TestProcs; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> tests = TestProcs::getRegisteredTests&lt;TEST_CLASS&gt;(); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Run test for type:"</span></span> &lt;&lt; <span class="hljs-keyword"><span class="hljs-keyword">typeid</span></span>(TEST_CLASS()).name() &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> test : tests) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> warmResultsTest = makeTestResults(*container, test.second, testCycles, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"\""</span></span> &lt;&lt; test.first &lt;&lt; <span class="hljs-string"><span class="hljs-string">"\" results(ms):"</span></span> &lt;&lt; getResultsString(warmResultsTest) &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; } }</code> </pre> <br>  The testCycles parameter specifies the number of iterations per test.  The makeTestClass template function constructs a class for testing.  For vectors, it looks like this: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> TEST_CLASS&gt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;TEST_CLASS&gt; makeTestClass() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span> &lt; TEST_CLASS &gt; (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TEST_CLASS(VECTOR_SIZE, <span class="hljs-number"><span class="hljs-number">0</span></span>)); }</code> </pre><br>  Well, for QList something like this: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;&gt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;QList&lt;TestType&gt; &gt; makeTestClass() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span> &lt; QList&lt;TestType&gt; &gt; (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QList&lt;TestType&gt;( QList&lt;TestType&gt;::fromVector(QVector&lt;TestType&gt;(VECTOR_SIZE)))); }</code> </pre><br>  TestProcs :: getRegisteredTests returns a vector from the test name and procedure to perform the test on the container. <br>  makeTestResults itself executes the test a specified number of times and returns the vector of the measured execution time for each iteration.  According to this data, the average, minimum and maximum value of the test run iteration time is considered. <br><br><h4>  The list of tests that I conducted </h4><br><ul><li>  std :: accumulate (doAccumulateTest) </li><li>  Qt macro foreach (doQtForeachTest) </li><li>  range-based for (doNewForTestt) </li><li>  STL-style for (doSTLForTest) </li><li>  STL-style for calculating the end of a container outside of a loop (doSTLForTest2) </li></ul><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> TestProcs { <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CONTAINER&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doAccumulateTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CONTAINER&amp; container)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CONTAINER::value_type sum = <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CONTAINER::value_type(); sum = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::accumulate(container.begin(), container.end(), sum); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum; } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CONTAINER&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doQtForeachTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CONTAINER&amp; container)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CONTAINER::value_type sum = <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CONTAINER::value_type(); foreach(<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> item, container) { sum += item; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum; } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CONTAINER&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doNewForTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CONTAINER&amp; container)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CONTAINER::value_type sum = <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CONTAINER::value_type(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> item : container) { sum += item; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum; } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CONTAINER&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doSTLForTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CONTAINER&amp; container)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CONTAINER::value_type sum = <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CONTAINER::value_type(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> it = container.begin(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; it != container.end(); ++it) { sum += *it; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum; } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CONTAINER&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doSTLForTest2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CONTAINER&amp; container)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CONTAINER::value_type sum = <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CONTAINER::value_type(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> it = container.begin(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> end = container.end(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; it != end; ++it) { sum += *it; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum; } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> TEST_CLASS&gt; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Typedefs&lt;TEST_CLASS&gt;::TestProcRecord&gt;&amp; getRegisteredTests() { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Typedefs&lt;TEST_CLASS&gt;::TestProcRecord&gt; tests { { <span class="hljs-string"><span class="hljs-string">"New for"</span></span>, &amp;doNewForTest&lt;TEST_CLASS&gt; }, { <span class="hljs-string"><span class="hljs-string">"Accumulate"</span></span>, &amp;doAccumulateTest&lt;TEST_CLASS&gt; }, { <span class="hljs-string"><span class="hljs-string">"Qt foreach"</span></span>, &amp;doQtForeachTest&lt;TEST_CLASS&gt; }, { <span class="hljs-string"><span class="hljs-string">"STL for"</span></span>, &amp;doSTLForTest&lt;TEST_CLASS&gt; }, { <span class="hljs-string"><span class="hljs-string">"STL for 2"</span></span>, &amp;doSTLForTest2&lt;TEST_CLASS&gt; } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tests; } }</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Test results </h4><br>  The list of containers subjected to testing: <br><ul><li>  QVector &lt;qint32&gt; (runTests &lt;QVector &lt;TestType&gt;&gt; (TEST_CYCLES)) </li><li>  std :: vector &lt;qint32&gt; (runTests &lt;std :: vector &lt;TestType&gt;&gt; (TEST_CYCLES)) </li><li>  QList &lt;qint32&gt; (runTests &lt;QList &lt;TestType&gt;&gt; (TEST_CYCLES)) </li></ul><br>  The number of iterations for each test = 20. <br>  The size of the container data is 30 megabytes. <br>  Time was measured using the difference in <a href="http://ru.wikipedia.org/wiki/Rdtsc">rdtsc</a> divided by <br>  per 100,000. <br>  Actually, the results table (less value means faster): <br><img src="http://habrastorage.org/storage2/7dd/84c/282/7dd84c2823e3b4ac3283838e6fcbc875.jpg"><br><br>  Graphical presentation of data for the result table: <br><img src="http://habrastorage.org/storage2/09d/922/4e1/09d9224e1e213a9b7016a29f420f2f0c.jpg"><br><br><img src="http://habrastorage.org/storage2/08e/044/b5e/08e044b5eabbf3d861a574047e0e2d4a.jpg"><br><br><img src="http://habrastorage.org/storage2/246/310/308/246310308b063afb1272dd96b6d9e77b.jpg"><br><br><h4>  Total </h4><br>  What I learned for myself by conducting the tests: <br><ul><li>  The foreach macro is almost always slower than the "correct" STL cycles (such that the final iterator value is calculated before the loop begins) </li><li>  The macro foreach is categorically contraindicated for use with STL-containers, because  makes a deep copy of containers (in Qt containers COW is used, therefore they are not subject to catastrophic "subsidence" of performance) </li><li>  For std :: vector, it doesn't matter where the final iterator value is calculated (before the start of the loop or ‚Äúinside‚Äù the body) </li></ul><br>  My opinion is that you need to stop using the foreach macro in Qt projects. <br><br>  Thanks for attention. <br><br>  <b>PS:</b> yes, I know that you can write "&gt;&gt;" without a space. <br>  <a href="">Source</a> </div><p>Source: <a href="https://habr.com/ru/post/144905/">https://habr.com/ru/post/144905/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144900/index.html">PHPmotion on Debian 6 Squeeze</a></li>
<li><a href="../144901/index.html">According to Cisco forecasts, in 2016 global Internet traffic will amount to 1. 3 zettabyte</a></li>
<li><a href="../144902/index.html">Especially strong novelties of Sony: Xperia acro S and Xperia go</a></li>
<li><a href="../144903/index.html">Top places on Google+</a></li>
<li><a href="../144904/index.html">Banks. Errors and Vulnerabilities</a></li>
<li><a href="../144906/index.html">So.cl: Microsoft's Search Engine</a></li>
<li><a href="../144910/index.html">What is the cause of the blockage? Web application statistics</a></li>
<li><a href="../144911/index.html">Happy Hacking Keyboard</a></li>
<li><a href="../144913/index.html">Dirty programming with a pure soul: the development of heuristic systems (part 2)</a></li>
<li><a href="../144914/index.html">IPO Vkontakte postponed indefinitely due to the failure of Facebook</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>