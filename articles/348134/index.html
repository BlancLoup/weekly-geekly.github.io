<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Chromium: other errors</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Go  We are completing a series of articles on recommendations for writing high-quality code using the example of errors found in the Chromium project....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Chromium: other errors</h1><div class="post__text post__text-html js-mediator-article">  Go <img src="https://habrastorage.org/getpro/habr/post_images/053/5f4/994/0535f4994594b698c8f8fccc796c22a5.png" alt="Shipping errors" align="left">  We are completing a series of articles on recommendations for writing high-quality code using the example of errors found in the Chromium project.  After writing 6 articles, we still have a lot of unexamined errors.  These errors are heterogeneous and it is difficult to compile information about them on a particular topic.  Therefore, in this seventh article, the most interesting defects will be simply selected and considered. <br><br>  As I wrote in the <a href="https://habrahabr.ru/company/pvs-studio/blog/347536/">introductory article</a> , looking through the report issued by the PVS-Studio analyzer, I noticed about 250 errors in the Chromium project and the libraries used in it.  I looked at the report quite fluently, so, in fact, you can find a lot more mistakes. <br><br>  After the introductory article, I wrote another 6, where I looked at various patterns of errors.  I wrote these articles, wrote, and still, I have about 70 examples of errors.  Based on the remaining bugs, I find it difficult to make articles on various topics.  I may be tired.  However, there is another reason - I‚Äôm waiting for the <a href="https://ru.wikipedia.org/wiki/XNU">XNU</a> verification <a href="http://cppfiles.com/xnu.txt">report</a> and I don‚Äôt wait for them to work out. <br><a name="habracut"></a><br>  Therefore, I decided to complete a series of articles about Chromium and write this latest article, where I will consider the most interesting of the remaining errors.  I remind you that the full list of errors is given here: <a href="http://cppfiles.com/chromium.txt">chromium.txt</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Undefined and unspecified behavior </h2><br>  Chromium project. <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> DeviceMediaAsyncFileUtil::CreateOrOpen( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;FileSystemOperationContext&gt; context, ....) { .... CreateSnapshotFile( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(context), url, base::Bind( &amp;NativeMediaFileUtil::CreatedSnapshotFileForCreateOrOpen, base::RetainedRef(context-&gt;task_runner()), file_flags, callback)); }</code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v522/">warning</a> : <a href="https://www.viva64.com/ru/w/v522/">V522</a> CWE-476 Dereferencing of the null pointer 'context' might take place.  device_media_async_file_util.cc 322 <br><br>  Depending on the luck, and more precisely on the compiler used, this code can both work correctly and lead to the dereferencing of the null pointer. <br><br>  Whether dereferencing a null pointer or not depends on the order in which the arguments are calculated when the <i>CreateSnapshotFile</i> function is <i>called</i> .  In C ++, the order of evaluation of the function's arguments is unspecified (unspecified behavior).  If the <i>std :: move (context)</i> argument is calculated first, then the <i>context-&gt; task_runner ()</i> will dereference the null pointer. <br><br>  <b>Recommendation.</b>  Do not try to cram as many actions as possible in one line - this often fails.  Write a simple code, and it is more likely to get the right one. <br><br>  Chromium project. <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unordered_map</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; thread_colors_; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> TraceLog::EventToConsoleMessage(....) { .... thread_colors_[thread_name] = (thread_colors_.size() % <span class="hljs-number"><span class="hljs-number">6</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>; .... }</code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v708/">warning</a> : <a href="https://www.viva64.com/ru/w/v708/">V708</a> CWE-758 Dangerous construction is used: 'm [x] = m.size ()', where 'm' is of 'unordered_map' class.  This may lead to undefined behavior.  trace_log.cc 1343 <br><br>  This code is so complex that it is even incomprehensible whether there is now indefinite behavior in it or not.  The fact is that the C ++ standard is changing and some constructions that previously led to undefined behavior become correct.  Let me explain this with simple examples: <br><br><pre> <code class="cpp hljs">i = ++i + <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-comment"><span class="hljs-comment">// undefined behavior until C++11 i = i++ + 2; // undefined behavior until C++17 f(i = -2, i = -2); // undefined behavior until C++17 f(++i, ++i); // undefined behavior until C++17, // unspecified after C++17 i = ++i + i++; // undefined behavior cout &lt;&lt; i &lt;&lt; i++; // undefined behavior until C++17 a[i] = i++; // undefined behavior until C++17 n = ++i + i; // undefined behavior</span></span></code> </pre> <br>  Let's return to the code from the Chromium project.  The expression <i>thread_colors_ [thread_name]</i> may or may not create a new element in the container and return a reference to an already existing element.  The main thing is that <i>thread_colors_ [thread_name]</i> can change the number of elements in an associative container. <br><br>  The expression <i>(thread_colors_.size ()% 6) + 1</i> depends on the number of elements in the <i>thread_colors_</i> associative container. <br><br>  Different values ‚Äã‚Äãwill be obtained depending on whether the expression to the left of the assignment operator = or the expression to the right is evaluated first. <br><br>  What determines the order of calculation?  From the version of the language used.  In any case, do not write so.  This code is very difficult to understand. <br><br>  <b>Recommendation.</b>  The advice is the same: do not try to cram as many actions as possible into one line. <br><br>  ICU library. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">U_DRAFT uint32_t U_EXPORT2 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ubiditransform_transform</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> UBiDiAction *action = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (action + <span class="hljs-number"><span class="hljs-number">1</span></span>) { updateSrc(....); } .... }</code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v694/">warning</a> : <a href="https://www.viva64.com/ru/w/v694/">V694</a> CWE-571 The condition (action + 1) is only false if there is a pointer overflow which is undefined behavior anyway.  ubiditransform.cpp 502 <br><br>  The condition is always true.  Theoretically, it can become false if an overflow occurs, but this leads to an undefined behavior. <br><br>  WebRTC library. <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;SdpVideoFormat&gt; StereoDecoderFactory::GetSupportedFormats() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;SdpVideoFormat&gt; formats = ....; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span>&amp; format : formats) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= if (cricket::CodecNamesEq(....)) { .... formats.push_back(stereo_format); // &lt;= } } return formats; }</span></span></code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v789/">warning</a> : <a href="https://www.viva64.com/ru/w/v789/">V789</a> CWE-672 iterators  stereocodecfactory.cc 89 <br><br>  The analyzer detected an iterator in the range-based for loop.  The above code is similar to the following: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> format = begin(formats), __end = end(formats); format != __end; ++format) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cricket::CodecNamesEq(....)) { .... formats.push_back(stereo_format); } }</code> </pre> <br>  Now you can see that when the <i>push_back</i> function is called, <i>invalidation of the</i> <i>format</i> and <i>__end</i> iterators can occur if memory reallocation occurs within the vector. <br><br>  <b>Recommendation.</b>  Remember that in range-based for loops it is impossible, as in loops organized with the help of iterators, to change the number of elements in a container. <br><br><h2>  Errors in logic </h2><br>  Chromium project. <br><br><pre> <code class="cpp hljs">STDMETHOD(GetInputScopes)(InputScope** input_scopes, UINT* count) override { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!count || !input_scopes) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> E_INVALIDARG; *input_scopes = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;InputScope*&gt;(CoTaskMemAlloc( <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(InputScope) * input_scopes_.size())); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!input_scopes) { *count = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> E_OUTOFMEMORY; } .... }</code> </pre> <br>  PVS-Studio Warning: <a href="https://www.viva64.com/ru/w/v649/">V649</a> CWE-561 There are two 'if' statements with identical conditional expressions.  The first 'if' statement contains function return.  This means that the statement is senseless.  Check lines: 67, 71. tsf_input_scope.cc 71 <br><br>  It makes no sense to re-check the pointer <i>input_scopes</i> , since if it is zero, the check at the beginning of the function will work, and the function will return the status <i>E_INVALIDARG</i> . <br><br>  The error is that in the " <i>if (! Input_scopes)</i> " forgot the * operator.  Because of this, the pointer that the <i>CoTaskMemAlloc</i> function returns is not checked.  The code should be: <br><br><pre> <code class="cpp hljs">*input_scopes = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;InputScope*&gt;(CoTaskMemAlloc( <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(InputScope) * input_scopes_.size())); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!*input_scopes) { *count = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> E_OUTOFMEMORY; }</code> </pre> <br>  Skia Library. <br><br><pre> <code class="cpp hljs">SkOpSpan* SkOpContour::undoneSpan() { SkOpSegment* testSegment = &amp;fHead; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> allDone = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (testSegment-&gt;done()) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } allDone = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> testSegment-&gt;undoneSpan(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((testSegment = testSegment-&gt;next())); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (allDone) { fDone = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; }</code> </pre> <br>  PVS-Studio analyzer considers this code suspicious immediately for two reasons: <br><br><ul><li>  <a href="https://www.viva64.com/ru/w/v547/">V547</a> CWE-571 Expression 'allDone' is always true.  skopcontour.cpp 43 </li><li>  <a href="https://www.viva64.com/ru/w/v1001/">V1001</a> CWE-563 The "AllDone" variable is assigned.  skopcontour.cpp 40 </li></ul><br>  Very suspicious code, but it‚Äôs hard for me to understand how it should work and what exactly the error here is.  Those <i>interested</i> can try to figure out how the <i>undoneSpan</i> function should look like. <br><br>  WebKit library. <br><br><pre> <code class="cpp hljs">WebString StringConstraint::ToString() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> first = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span>&amp; iter : exact_) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!first) builder.Append(<span class="hljs-string"><span class="hljs-string">", "</span></span>); builder.Append(<span class="hljs-string"><span class="hljs-string">'"'</span></span>); builder.Append(iter); builder.Append(<span class="hljs-string"><span class="hljs-string">'"'</span></span>); } .... }</code> </pre> <br>  PVS-Studio Warning: V547 CWE-570 Expression '! First' is always always false.  webmediaconstraints.cpp 302 <br><br>  Since the variable <i>first is</i> always <i>true</i> , commas between elements will not be added.  The correct code is: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> first = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span>&amp; iter : exact_) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (first) first = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> builder.Append(<span class="hljs-string"><span class="hljs-string">", "</span></span>); builder.Append(<span class="hljs-string"><span class="hljs-string">'"'</span></span>); builder.Append(iter); builder.Append(<span class="hljs-string"><span class="hljs-string">'"'</span></span>); }</code> </pre> <br>  ICU library. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> CollationDataBuilder::setPrimaryRangeAndReturnNext(....) { .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Short range: Set individual CE32s. for(;;) { utrie2_set32(....); ++start; primary = Collation::incThreeBytePrimaryByOffset(....); if(start &gt; end) { return primary; } } modified = TRUE; // &lt;= } }</span></span></code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v779/">warning</a> : <a href="https://www.viva64.com/ru/w/v779/">V779</a> CWE-561 Unreachable code detected.  It is possible that an error is present.  collationdatabuilder.cpp 392 <br><br>  A loop can only be interrupted by calling the <i>return statement</i> .  This means that the assignment after the loop will never be executed. <br><br>  Ced Library <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HzBoostWhack</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DetectEncodingState* destatep, uint8 byte1, uint8 byte2)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((byte2 == <span class="hljs-string"><span class="hljs-string">'{'</span></span>) || (byte2 == <span class="hljs-string"><span class="hljs-string">'}'</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">// Found ~{ or ~} Boost(destatep, F_HZ_GB_2312, kBoostOnePair); } else if ((byte2 == '~') || (byte2 == '\n')) { // neutral destatep-&gt;enc_prob[F_HZ_GB_2312] += 0; } else { // Illegal pair Whack(destatep, F_HZ_GB_2312, kBadPairWhack); } }</span></span></code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v751/">warning</a> : <a href="https://www.viva64.com/ru/w/v751/">V751</a> Parameter 'byte1' is not used inside function body.  compact_enc_det.cc 2559 <br><br>  It is very suspicious that the argument <i>byte1 is</i> not used in the function.  I do not know if it is a mistake or not.  Even if not an error, it is better not to write like that.  Such code will puzzle both those who will accompany it and various analyzers. <br><br><h2>  Wrong expectations </h2><br>  Sometimes programmers mistakenly imagine how certain functions or constructions of a language work.  Let's look at some such errors. <br><br>  Chromium project. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnConvertedClientDisconnected</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// We have no direct way of tracking which // PdfToEmfConverterClientPtr got disconnected as it is a // movable type, short of using a wrapper. // Just traverse the list of clients and remove the ones // that are not bound. std::remove_if( g_converter_clients.Get().begin(), g_converter_clients.Get().end(), [](const mojom::PdfToEmfConverterClientPtr&amp; client) { return !client.is_bound(); }); }</span></span></code> </pre> <br>  PVS-Studio warning: V530 CWE-252 The return value of the function 'remove_if' is required to be utilized.  pdf_to_emf_converter.cc 44 <br><br>  The <i>remove_if</i> function <i>does</i> n‚Äôt delete anything, it only swaps the elements in the container.  Most likely, it should be written here: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> trash = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::remove_if(........); g_converter_clients.Get().erase(trash, g_converter_clients.Get().end());</code> </pre> <br>  V8 engine. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> StringStream::Add(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'f'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'g'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'G'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'e'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'E'</span></span>: { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> value = current.data_.u_double_; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> inf = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::isinf(value); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inf == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { Add(<span class="hljs-string"><span class="hljs-string">"-inf"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inf == <span class="hljs-number"><span class="hljs-number">1</span></span>) { Add(<span class="hljs-string"><span class="hljs-string">"inf"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::isnan(value)) { Add(<span class="hljs-string"><span class="hljs-string">"nan"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { EmbeddedVector&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>&gt; formatted; SNPrintF(formatted, temp.start(), value); Add(formatted.start()); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } .... }</code> </pre> <br>  PVS-Studio warning: V547 CWE-570 Expression 'inf == - 1' is always false.  string-stream.cc 149 <br><br>  Description of the function <i>std :: isinf</i> : <a href="http://en.cppreference.com/w/cpp/numeric/math/isinf">isinf</a> . <br><br>  As you can see, the <i>std :: isinf function</i> returns the <i>bool</i> type.  Thus, this function is clearly used incorrectly. <br><br>  Skia Library. <br><br><pre> <code class="cpp hljs">GrGLProgram* GrGLProgramBuilder::finalize() { .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; binary(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[length]); .... }</code> </pre> <br>  PVS-Studio <a href="https://www.viva64.com/ru/w/v554/">warning</a> : <a href="https://www.viva64.com/ru/w/v554/">V554</a> CWE-762 Incorrect use of unique_ptr.  The memory is allocated with 'new []' will be cleaned using 'delete'.  grglprogrambuilder.cpp 272 <br><br>  Memory is allocated using the <i>new []</i> operator, and will be freed using the <i>delete</i> operator.  The class <i>unique_ptr</i> needs to be told how to manage memory. <br>  The correct code is: <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[]&gt; binary(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[length]);</code> </pre> <br>  Another similar blunder in the Skia library: <br><br><pre> <code class="cpp hljs">GrGLProgram* GrGLProgramBuilder::finalize() { .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>&gt; data((<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*) <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(dataLength)); .... }</code> </pre> <br>  PVS-Studio warning: V554 CWE-762 Incorrect use of unique_ptr.  The memory allocated with 'malloc' will be cleaned using 'delete'.  grglprogrambuilder.cpp 275 <br><br>  Obviously, one of the programmers found out about the existence of the class <i>std :: unique_ptr</i> , but cannot use it yet :).  Memory is allocated using the <i>malloc</i> function, and freed using the <i>delete</i> operator. <br><br>  The correct code is: <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*)(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)&gt; data((<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*) <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(dataLength), <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">free</span></span>);</code> </pre> <br>  WebKit library. <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ScrollAnchorData</span></span></span><span class="hljs-class"> {</span></span> WebString selector_; WebFloatPoint offset_; <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> simhash_; ScrollAnchorData(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> WebString&amp; selector, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> WebFloatPoint&amp; offset, <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> simhash) : selector_(selector), offset_(offset), simhash_(simhash) {} ScrollAnchorData() { ScrollAnchorData(WebString(), WebFloatPoint(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>); } };</code> </pre> <br>  PVS-Studio Warning: <a href="https://www.viva64.com/ru/w/v603/">V603</a> CWE-665  If you wish to call the constructor, 'this-&gt; ScrollAnchorData :: ScrollAnchorData (....)' should be used.  webscrollanchordata.h 49 <br><br>  This is not a call to one constructor from another constructor.  An unnamed object is simply created and immediately destroyed. <br><br><h2>  Poor pointer checks </h2><br>  Very often, programs incorrectly written to check whether the pointer is zero or not.  Errors of this type can be divided into two main options: <br><br>  <b>The first option</b> is when the pointer is first dereferenced, and only then checked: <br><br><pre> <code class="cpp hljs">p[n] = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!p) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;</code> </pre> <br>  <b>The second option</b> is when first checking the pointer before using it, and then forgetting to do it: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p) p[<span class="hljs-number"><span class="hljs-number">0</span></span>] = x; p[<span class="hljs-number"><span class="hljs-number">1</span></span>] = y;</code> </pre> <br>  Errors of the first type are detected by the <a href="https://www.viva64.com/ru/w/v595/">V595</a> diagnostics, and those of the second type are diagnosed by the <a href="https://www.viva64.com/ru/w/v1004/">V1004</a> . <br><br>  Such errors do not always lead to problems.  First, it happens that the pointer never becomes zero.  In this case, there is no error at all, but there is only an extra check, which confuses both people reading the code and code analyzers.  Secondly, it happens that the pointer becomes zero in extremely rare cases, and therefore the error does not affect the typical scenarios of the program. <br><br>  Nevertheless, messages V595 and V1004 deserve close attention and editing code.  The PVS-Studio analyzer issued a bunch of such messages for Chromium code and libraries.  Unfortunately, as I described in the introductory article, due to the <i>DCHECK</i> macro <i>,</i> most of them are false positives.  Therefore, I was very quickly tired of viewing these messages.  A closer look at the messages V595 and V1004 should be after configuring the analyzer. <br><br>  In any case, I assure you that the errors associated with incorrect verification of pointers are complete.  Some of them you can find by looking into the file <a href="http://cppfiles.com/chromium.txt">chromium.txt</a> .  To find the rest, you need heroes who set up the analyzer and learn a new report. <br><br>  I will not give here all the noticed errors, as they are of the same type.  I will show only two examples for each diagnostics, so that it is completely clear what kind of errors are being discussed. <br><br>  V595, the first example, the project Chromium. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> PaintOpReader::ReadFlattenable(sk_sp&lt;T&gt;* val) { <span class="hljs-comment"><span class="hljs-comment">// .... //   val     . // .... val-&gt;reset(static_cast&lt;T*&gt;(SkValidatingDeserializeFlattenable( const_cast&lt;const char*&gt;(memory_), bytes, T::GetFlattenableType()))); if (!val) SetInvalid(); .... }</span></span></code> </pre> <br>  PVS-Studio warning: V595 CWE-476  Check lines: 124, 126. paint_op_reader.cc 124 <br><br>  The <i>val</i> pointer is dereferenceed without checking for equality <i>nullptr</i> . <br><br>  V595, the second example, the Chromium project. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> HttpAuthHandlerRegistryFactory::RegisterSchemeFactory( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&amp; scheme, HttpAuthHandlerFactory* factory) { factory-&gt;set_http_auth_preferences(http_auth_preferences()); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> lower_scheme = base::ToLowerASCII(scheme); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (factory) factory_map_[lower_scheme] = base::WrapUnique(factory); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> factory_map_.erase(lower_scheme); }</code> </pre> <br>  PVS-Studio warning: V595 CWE-476  Check lines: 122, 124. http_auth_handler_factory.cc 122 <br><br>  The <i>factory</i> pointer is dereferenceed without checking for <i>nullptr</i> equality. <br><br>  V1004, the first example, is a PDFium library. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CFX_PSRenderer::SetClip_PathStroke(...., <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CFX_Matrix* pObject2Device, ....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pObject2Device) { .... } .... m_ClipBox.Intersect( pObject2Device-&gt;TransformRect(rect).GetOuterRect()); .... }</code> </pre> <br>  PVS-Studio warning: V1004 CWE-476 The 'pObject2Device' pointer was used unsafely after it was verified against nullptr.  Check lines: 237, 248. cfx_psrenderer.cpp 248 <br><br>  The <i>pObject2Device</i> pointer may be null, as evidenced by checking this pointer for <i>nullptr</i> equality.  However, further the pointer is dereferenced without prior verification. <br><br>  V1004, the second example, is the SwiftShader library. <br><br><pre> <code class="cpp hljs">VertexProgram::VertexProgram(...., <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VertexShader *shader) : VertexRoutine(state, shader), shader(shader), r(shader-&gt;dynamicallyIndexedTemporaries) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(shader &amp;&amp; shader-&gt;containsBreakInstruction()) { enableBreak = ....; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(shader &amp;&amp; shader-&gt;containsContinueInstruction()) { enableContinue = ....; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(shader-&gt;isInstanceIdDeclared()) { instanceID = ....; } }</code> </pre> <br>  PVS-Studio warning: V1004 CWE-476 The 'shader' pointer was used unsafely after it was verified against nullptr.  Check lines: 43, 53. vertexprogram.cpp 53 <br><br>  The <i>shader</i> pointer can be null, as evidenced by checking this pointer for <i>nullptr</i> equality.  However, further the pointer is dereferenced without prior verification. <br><br><h2>  Greetings to Google developers </h2><br>  The PVS-Studio team sends its greetings to Google‚Äôs developers and is ready to cooperate.  It is possible to discuss at least two options: <br><br><ol><li>  You can license the PVS-Studio product so that all the developers of Chrome, Chromium, as well as the authors of third-party libraries used in these projects can use it.  Anyway, you can make all Google employees have a license. </li><li>  You can conclude a contract, within the framework of which our team will customize the PVS-Studio analyzer to the needs of the company, correct all errors that it can find, regularly conduct code audits and correct new errors. </li></ol><br>  Try PVS-Studio.  <a href="https://www.viva64.com/ru/about-feedback/">Write to us</a> .  We will help with project verification and issue a temporary license for detailed information. <br><br><h2>  Conclusion </h2><br>  Thanks to everyone who got to the end of the series of articles.  I hope you were interested. <br><br>  As you can see, even in such a high-quality project as Chromium there are a lot of errors that the PVS-Studio analyzer is able to detect.  I suggest you start using it in your projects. <br><br><p> <a href="https://www.viva64.com/en/b/0559/"><img src="https://habrastorage.org/webt/ts/z9/km/tsz9kmyjtteajhd4x1au60rsrvq.png" align="left"></a> </p><br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Andrey Karpov.  <a href="https://www.viva64.com/en/b/0559/">Chromium: Miscellaneous Defects</a> . </div><p>Source: <a href="https://habr.com/ru/post/348134/">https://habr.com/ru/post/348134/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348124/index.html">Why most people do not use two-factor authentication?</a></li>
<li><a href="../348126/index.html">Can I use the CQRS pattern in GO?</a></li>
<li><a href="../348128/index.html">R as a lifeline for the system administrator</a></li>
<li><a href="../348130/index.html">[DotNetBook] Stackalloc: forgotten C # command</a></li>
<li><a href="../348132/index.html">From Amazon EC2 to Mail.ru Infra: Test Cloud VPS (Linux)</a></li>
<li><a href="../348136/index.html">The most correct implementation of splash screen</a></li>
<li><a href="../348138/index.html">Isometric depth sorting for moving platforms</a></li>
<li><a href="../348140/index.html">Four ways to fool a deep learning neural network</a></li>
<li><a href="../348142/index.html">The history of hacking a single WordPress plugin - or how you allow vulnerabilities in your projects</a></li>
<li><a href="../348148/index.html">Road to War: AI Total War Series Games</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>