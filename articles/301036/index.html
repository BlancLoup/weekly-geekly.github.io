<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Best Go practices, six years in</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In 2014, I spoke at the opening of the GopherCon conference with a report entitled ‚ÄúGo: Best Practices for Production Environments ‚Äù. In SoundCloud, w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Best Go practices, six years in</h1><div class="post__text post__text-html js-mediator-article">  In 2014, I spoke at the opening of the GopherCon conference with a report entitled ‚ÄúGo: <a href="https://peter.bourgon.org/go-in-production">Best Practices for Production Environments</a> ‚Äù.  In <a href="https://soundcloud.com/">SoundCloud,</a> we were one of the first Go users, and by that time already two years had written on it and supported <a href="https://soundcloud.com/">Go</a> in combat in one form or another.  During this time we have learned something, and I tried to share a part of this experience. <br><br>  Since then, I continued to program on Go throughout the entire working day, first in the SoundCloud teams responsible for operations and infrastructure, and now I work at <a href="https://www.weave.works/">Weaveworks</a> on <a href="https://www.weave.works/products/weave-scope/">Weave Scope</a> and <a href="https://github.com/weaveworks/mesh">Weave Mesh</a> .  I also worked hard on the <a href="https://github.com/go-kit/kit">Go kit</a> , an open source microservice toolkit.  And all this time I took an active part in the development of the Go-programmers community, met with many developers at meetings and conferences throughout Europe and in the USA, collecting their success stories and failures. <br><br>  In November 2015, on the <a href="https://blog.golang.org/6years">sixth anniversary of the</a> release of Go, I recalled my first performance.  Which of the best practices have passed the test of time?  Which ones are outdated or become ineffective?  Have any new techniques appeared?  In March, I had the opportunity to speak at <a href="https://qconlondon.com/">QCon London</a> , where I spoke about the best practices of 2014 and the further development of Go until 2016.  This post presents a squeeze from my speech. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Key points I highlighted in the text as Top Tips - the best tips. <br><br>  Here is the content: <br><br><ol><li>  <a href="https://habrahabr.ru/company/mailru/blog/301036/">Development environment</a> </li><li>  <a href="https://habrahabr.ru/company/mailru/blog/301036/">Repository structure</a> </li><li>  <a href="https://habrahabr.ru/company/mailru/blog/301036/">Formatting and style</a> </li><li>  <a href="https://habrahabr.ru/company/mailru/blog/301036/">Configuration</a> </li><li>  <a href="https://habrahabr.ru/company/mailru/blog/301036/">Program development</a> </li><li>  <a href="https://habrahabr.ru/company/mailru/blog/301036/">Logging and metrics</a> </li><li>  <a href="https://habrahabr.ru/company/mailru/blog/301036/">Testing</a> </li><li>  <a href="https://habrahabr.ru/company/mailru/blog/301036/">Dependency management</a> </li><li>  <a href="https://habrahabr.ru/company/mailru/blog/301036/">Build and Deploy</a> </li><li>  <a href="https://habrahabr.ru/company/mailru/blog/301036/">Conclusion</a> </li></ol><a name="habracut"></a><br><a name="1"></a><h1>  Development environment </h1><br>  Go environment agreements are based on the use of GOPATH.  In 2014, I defended the view that there should be a single global variable GOPATH.  Since then, my position has softened somewhat.  I still think that, other things being equal, this is the best option, but much also depends on the specifics of your project, team and other things. <br><br>  If you or your company create mostly executable binaries, then using a separate GOPATH for each project can provide certain advantages.  For such cases, you can use the new <a href="https://getgb.io/">gb</a> utility from Dave Cheney and contributors, replacing the standard <code>go</code> tools for this purpose.  On the utility there are already many positive reviews. <br><br>  Some developers use GOPATH with two directories (two-entry), for example <code>$HOME/go/external:$HOME/go/internal</code> .  The go-command always knew how to handle such cases: <code>go get</code> downloads the dependency to the directory by the first path, so this solution can be useful if you need to strictly separate the internal code from the third-party. <br><br>  I noticed that some developers forget to put <code>GOPATH/bin</code> in their <code>PATH</code> .  But this makes it easy to run the executable files you get with <code>go get</code> , and also makes it easier to work with the (preferred) <code>go install</code> code mechanism.  There is no reason not to do this. <br><br><h4>  ‚ú™ <b>Top Tip</b> - <code>$GOPATH/bin</code> in your <code>$PATH</code> , this will make it easier to access installed programs. </h4><br>  Thanks to all kinds of editors and IDE, the development environment has continuously improved.  If you are a vim fan, then everything went perfectly for you: thanks to the tireless and incredibly effective work of Fatih Arslan ( <a href="https://twitter.com/fatih">Fatih Arslan</a> ), the <a href="https://github.com/fatih/vim-go">vim-go</a> plugin has turned into a real work of art, the best tool in its class.  I‚Äôm not so familiar with <a href="https://ru.wikipedia.org/wiki/Emacs">Emacs</a> , but Dominic <a href="https://twitter.com/dominikhonnef">Honnef is</a> <a href="">go-mode.el governing</a> this area. <br><br>  Moving on, many still successfully use the <a href="https://www.sublimetext.com/">Sublime Text</a> + <a href="https://github.com/DisposaBoy/GoSublime">GoSublime combination</a> .  In terms of speed it is difficult to compete.  But apparently, recently more and more attention is paid to editors based on <a href="http://electron.atom.io/">Electron</a> .  There are a lot of fans of the <a href="https://atom.io/">Atom</a> + <a href="https://atom.io/packages/go-plus">go-plus</a> bundle, especially among developers, who often have to switch from some language to JavaScript.  A bunch of <a href="https://code.visualstudio.com/">Visual Studio Code</a> + <a href="https://github.com/Microsoft/vscode-go">vscode-go</a> was a dark horse: it runs slower than Sublime Text, but noticeably faster than Atom, and at the same time, by default it perfectly supports important features for me, like click-to-definition (transition to the object definition by click ).  I have been using this bundle every day for six months now, since Thomas Adam ( <a href="https://github.com/tecbot">Thomas Adam</a> ) introduced me to her.  Great thing. <br><br>  As for the full IDE, we can mention the specially created <a href="https://github.com/visualfc/liteide">LiteIDE</a> , which is regularly updated and has its audience of fans.  There is also an interesting plugin for Go <a href="https://github.com/go-lang-plugin-org/go-lang-idea-plugin">Intellij</a> , which is constantly improving. <br><br><a name="2"></a><h1>  Repository structure </h1><br>  We had enough time for the projects to become more mature, and as a result a number of clear approaches were developed.  <i>What</i> your project is about depends on how you structure your repository.  If we are talking about a closed project or an internal project of a company, then you can break away: let it have its own GOPATH, use a custom build tool, do anything if it brings you pleasure and improves your productivity. <br><br>  But if it is a public project (for example, open source), then the rules become stricter.  Your code must be compatible with <code>go get</code> , since this is the way most Go developers will want to take advantage of your work. <br>  The ideal repository structure depends on the types of your entities.  If these are exclusively executable binaries or libraries, then you need to be sure that consumers can use <code>go get</code> or import along the base path.  So place package main or main code for import into <code>github.com/name/repo</code> , and use subfolders for support packages. <br><br>  If your repository is a combination of binary files and libraries, then you should define the <i>main</i> entity and put it in the root of the repository.  For example, if your repository for the most part consists of executable files, but can also be used as a library, then you probably prefer to structure it like this: <br><br><pre> <code class="go hljs">github.com/peterbourgon/foo/ main.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-comment"><span class="hljs-comment">// package main main_test.go // package main lib/ foo.go // package foo foo_test.go // package foo</span></span></code> </pre><br>  Useful advice: in the <code>lib/</code> subfolder it is better to name the package according to the name of the library, and not the folder itself;  that is, in this example, <code>package foo</code> instead of <code>package lib</code> .  This is an exception to fairly strict Go-idioms, but in practice it is very convenient for users.  Similarly, the excellent <a href="https://github.com/tsenart/vegeta">tsenart / vegeta</a> repository is <a href="https://github.com/tsenart/vegeta">built</a> , a tool for load testing HTTP services. <br><br><h4>  ‚ú™ <b>Top Tip</b> - If your foo repository mainly consists of executable binary files, put the library code in the <code>lib/</code> subfolder and name the <code>package foo</code> . </h4><br>  If your repository is basically a library, but also includes one or two executable programs, then the structure could be: <br><br><pre> <code class="go hljs">github.com/peterbourgon/foo foo.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-comment"><span class="hljs-comment">// package foo foo_test.go // package foo cmd/ foo/ main.go // package main main_test.go // package main</span></span></code> </pre><br>  It turns out the inverted structure, when the library code is put in the root, and the executable program code is stored in the <code>cmd/foo/</code> subfolder.  The intermediate level <code>cmd/</code> convenient for two reasons: <br><br><ul><li>  The Go toolkit automatically names the binaries by the folder name in which package main is located, so that we get the best file names without possible conflicts with other packages in the repository. </li><li>  If your users use <code>go get</code> on the path that contains <code>/cmd/</code> , they immediately understand what they got.  The repository of the <a href="https://github.com/constabulary/gb">gb build</a> utility is similarly arranged. </li></ul><br><h4>  ‚ú™ <b>Top Tip</b> - If the main purpose of your repository is a library, then place the code of the executable programs in subfolders within <code>cmd/</code> . </h4><br>  The main point here: take care of users ‚Äî simplify the use of the core functionality of your project.  It seems to me that this abstract idea ‚Äî focusing on user needs ‚Äî is in keeping with the very spirit of Go. <br><br><a name="3"></a><h1>  Formatting and style </h1><br>  Here, little has changed.  This is one of those places where Go has gone the right way, and I really appreciate community agreements and the stability of the language regarding this.  <a href="https://github.com/golang/go/wiki/CodeReviewComments">Code Review Comments are</a> great and should be the minimum set necessary to meet the criteria during a code revision.  And if you have conflicting situations or contradictions in the names, you can use an excellent set of <a href="https://talks.golang.org/2014/names.slide">idiomatic naming</a> conventions for Andrew Gerrand. <br><br><h4>  ‚ú™ <b>Top Tip</b> - Use Andrew Gerrand's naming conventions. </h4><br>  As for the toolkit, everything here has only become better.  Configure your editor so that when saving gofmt is initiated, and better <a href="https://github.com/bradfitz/goimports">goimports</a> (I hope no one will have any objections here).  Using the go vet utility <a href="https://github.com/golang/go/issues/9171">almost</a> never leads to false positives, so you can easily make it part of your pre-commit hook.  And pay attention to the <a href="https://github.com/alecthomas/gometalinter">gometalinter</a> code quality monitoring utility.  It <i>may</i> have false positives, so it makes sense to somehow <a href="https://github.com/weaveworks/mesh/blob/master/lint">label your own agreements</a> . <br><br><a name="4"></a><h1>  Configuration </h1><br>  The configuration lies between the runtime environment and the process.  It should be explicit and well documented.  I still use and recommend using the flag package, but would still prefer the configuration to be more familiar.  I would like to get the standard syntax of arguments in getopts-style, so that there are detailed and brief form of the arguments.  I also want the usage text to be much smaller. <br><br>  Applications that follow the <a href="http://12factor.net/">Twelve-Factor App</a> are motivated to use environment variables for configuration, and I think this is normal, <i>provided that each variable is also defined as a flag</i> .  Here, the obviousness is important: changing the runtime behavior of an application should be performed in an easily detectable and documented way. <br><br>  I already said in 2014, but I consider it necessary to repeat: <a href="https://robots.thoughtbot.com/where-to-define-command-line-flags-in-go">define and disassemble the flags inside func main ()</a> .  Only <code>func main()</code> has the right to decide which flags will be available to the user.  If your library allows you to configure your behavior, then configuration parameters should be part of type constructors.  Transferring the configuration to the global scope of the packages creates the illusion of benefits, but the savings are false: you break the code modularity, so it will be more difficult for other developers to understand dependencies, and it will also be much more difficult to write independent, parallelized tests. <br><br><h4>  ‚ú™ <b>Top Tip</b> - Only <code>func main()</code> has the right to decide which flags will be available to the user. </h4><br>  I think the community may well create a comprehensive package of flags in which all these properties will be combined.  It may already exist.  If so, <a href="https://twitter.com/peterbourgon">let me know</a> .  I would definitely use it. <br><br><a name="5"></a><h1>  Program development </h1><br>  In the conversation, I used the configuration as a starting point to discuss a number of other aspects of program development (I did not raise this topic in 2014).  First, let's look at the constructors.  If we correctly parameterize all our dependencies, then the designers can become quite large. <br><br><pre> <code class="go hljs">foo, err := newFoo( *fooKey, bar, <span class="hljs-number"><span class="hljs-number">100</span></span> * time.Millisecond, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Fatal(err) } <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> foo.<span class="hljs-built_in"><span class="hljs-built_in">close</span></span>()</code> </pre><br>  Sometimes it is better to express such a construction with the help of a configuration object: structures that accept <i>optional</i> parameters that determine the behavior of the object being constructed.  Suppose that the <code>fooKey</code> parameter <code>fooKey</code> required, and all others either have reasonable default values ‚Äã‚Äãor are optional. <br><br>  I often see projects in which configuration objects are constructed in some separate way: <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//    cfg := fooConfig{} cfg.Bar = bar cfg.Period = 100 * time.Millisecond cfg.Output = nil foo, err := newFoo(*fooKey, cfg) if err != nil { log.Fatal(err) } defer foo.close()</span></span></code> </pre><br>  But it is much better to construct an object at a time, using a single expression, using the so-called structure initialization syntax. <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//    cfg := fooConfig{ Bar: bar, Period: 100 * time.Millisecond, Output: nil, } foo, err := newFoo(*fooKey, cfg) if err != nil { log.Fatal(err) } defer foo.close()</span></span></code> </pre><br>  There are no expressions when the object is in an intermediate, wrong state.  At the same time, all fields are beautifully delimited and indented, reflecting the definition of <code>fooConfig</code> . <br><br>  Note that we construct the <code>cfg</code> object and use it immediately.  In this case, by directly embedding the structure declaration in the <code>newFoo</code> constructor, we can avoid another stage of the intermediate state and save another line of code. <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//    foo, err := newFoo(*fooKey, fooConfig{ Bar: bar, Period: 100 * time.Millisecond, Output: nil, }) if err != nil { log.Fatal(err) } defer foo.close()</span></span></code> </pre><br>  Fine. <br><br><h4>  ‚ú™ <b>Top Tip</b> - To avoid an incorrect intermediate state, use a literal structure initialization.  Wherever possible, embed structure declarations. </h4><br>  Now turn to the topic of reasonable defaults.  Note that the <code>Output</code> parameter can be <code>nil</code> . <br><br>  Suppose it is <code>io.Writer</code> .  If we don‚Äôt do anything special, then when we want to use it in our <code>foo</code> object, we first have to check for nil. <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(f *foo)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> f.Output != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { fmt.Fprintf(f.Output, <span class="hljs-string"><span class="hljs-string">"start\n"</span></span>) } <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br>  This is not great.  It is much better and safer to be able to use the output value without checking for its existence. <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(f *foo)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { fmt.Fprintf(f.Output, <span class="hljs-string"><span class="hljs-string">"start\n"</span></span>) <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br>  So here we need to provide something useful by default.  Thanks to the interface types, we have the ability to transfer something that provides a no-op-implementation (i.e., an implementation that does not perform any operations, a stub. - Note of the translator) of the interface.  Therefore, the stdlib ioutil package comes with a no-op <code>io.Writer</code> called <code>ioutil.Discard</code> . <br><br><h4>  ‚ú™ <b>Top Tip</b> - Avoid checking for nil with no-op default implementations. </h4><br>  You could pass this to the <code>fooConfig</code> object, but this is a rather fragile solution.  If the calling code forgets to do it in the place of the call, then we again get the parameter <code>nil</code> .  Instead, we can protect ourselves inside the constructor. <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newFoo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(..., cfg fooConfig)</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cfg.Output == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { cfg.Output = ioutil.Discard } <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br>  This is just the use of Go-idioms "make zero value useful."  That is, we allow zero ( <code>nil</code> ) to provide good default behavior (no-op). <br><br><h4>  ‚ú™ <b>Top Tip</b> - Make the null value useful, especially in configuration objects. </h4><br>  Let‚Äôs go back to the constructor.  The <code>fooKey</code> , <code>bar</code> , <code>period</code> and <code>output</code> parameters are <i>dependencies</i> .  The success of starting and running the <code>foo</code> object <i>depends</i> on each of them.  What I definitely learned in six years of daily programming on Go and observing large projects is that you need <b>to make dependencies explicit</b> . <br><br><h4>  ‚ú™ <b>Top Tip</b> - Make dependencies explicit! </h4><br>  I believe that ambiguous or implicit dependencies are the cause of an incredible amount of labor for technical support, confusion, bugs and unpaid technical debt.  Consider the process () method of type <code>foo</code> : <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(f *foo)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { fmt.Fprintf(f.Output, <span class="hljs-string"><span class="hljs-string">"start\n"</span></span>) result := f.Bar.compute() log.Printf(<span class="hljs-string"><span class="hljs-string">"bar: %v"</span></span>, result) <span class="hljs-comment"><span class="hljs-comment">// Whoops! // ... }</span></span></code> </pre><br>  <code>fmt.Printf</code> autonomous, does not affect and does not depend on the global state.  In functional terms, it has something like <i>referential transparency</i> .  So this is not an addiction.  Obviously, it is <code>f.Bar</code> .  Curiously, <code>log.Printf</code> affects the global (within the package) <code>log.Printf</code> object, which is simply not obvious due to the free <code>Printf</code> function.  So this is also an addiction. <br><br>  What do we do with all these dependencies?  <b>Let's make them explicit</b> .  Since the process () method writes to the log during its work, either the method or the <code>foo</code> object itself must accept the logging object as a dependency.  For example, <code>log.Printf</code> should become <code>f.Logger.Printf</code> . <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(f *foo)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { fmt.Fprintf(f.Output, <span class="hljs-string"><span class="hljs-string">"start\n"</span></span>) result := f.Bar.compute() f.Logger.Printf(<span class="hljs-string"><span class="hljs-string">"bar: %v"</span></span>, result) <span class="hljs-comment"><span class="hljs-comment">// . // ... }</span></span></code> </pre><br>  We are accustomed to counting side specific types of work like logging.  Therefore, we are pleased to use supporting libraries like global loggers to ease our burden.  But logging, like metrics, often plays a crucial role in the functioning of a service.  And hiding dependencies in the global visibility space can ‚Äî and does it ‚Äî hit us the same way, either in the form of something seemingly harmless, like logging, or in the form of some other, more important, subject component, which we did not take care of parameterization .  Protect yourself from future pain by using strict rules: make all your dependencies <i>explicit</i> . <br><br><h4>  ‚ú™ <b>Top Tip</b> - Loggers are dependencies, as are links to other components, database clients, command line arguments, etc. </h4><br>  Of course, we also need to take care of obtaining a reasonable silence for our logger. <br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newFoo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(..., cfg fooConfig)</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... if cfg.Logger == nil { cfg.Logger = log.New(ioutil.Discard, ...) } // ... }</span></span></code> </pre><br><a name="6"></a><h1>  Logging and metrics </h1><br>  Speaking of the problem as a whole: with logging I had a lot more experience in combat, which only strengthened my respect for the problem.  Logging is expensive, much more expensive than you think, and can quickly become a bottleneck in your system.  I covered this topic <a href="https://peter.bourgon.org/blog/2016/02/07/logging-v-instrumentation.html">in</a> detail <a href="https://peter.bourgon.org/blog/2016/02/07/logging-v-instrumentation.html">in a separate post</a> , but if in brief: <br><br><ul><li>  Log only <i>information that provides a basis for action</i> , read by a person or a machine. </li><li>  Avoid overly detailed logging, you may need general information and data for debugging. </li><li>  Use structured logging.  Although I am biased, I recommend <a href="https://github.com/go-kit/kit/tree/master/log">go-kit / log</a> . </li><li>  Loggers are dependencies! </li></ul><br>  Where logging is expensive, metrics are cheap.  Remove metrics from any significant component of your code base.  If this is a resource, like a queue, then measure it using <a href="http://www.brendangregg.com/usemethod.html">the Brendan Gregg USE method</a> : Utilization, Saturation, Error count (rate).  If this is some kind of endpoint, then measure using <a href="https://twitter.com/LindsayofSF/status/692191001692237825">the RED method of Tom Wilkie</a> : Request count (rate), Error count (rate), Duration. <br><br>  If you have the opportunity to choose in this matter, then I recommend using <a href="https://prometheus.io/">Prometheus</a> as a measuring system.  And of course, metrics are also dependencies! <br><br>  Let's digress from loggers and metrics and look directly at the global state.  Here are some facts about Go: <br><br><ul><li>  <code>log.Print</code> uses a fixed global <code>log.Logger</code> . </li><li>  <code>http.Get</code> uses a fixed global <code>http.Client</code> . </li><li>  <code>http.Server</code> by default uses a fixed global <code>log.Logger</code> . </li><li>  <code>database/sql</code> uses a fixed global driver registry. </li><li>  <code>func init</code> exists only to have a side effect on the global state of the package. </li></ul><br>  These facts are tolerated separately, but difficult in general.  That is, how can we test the output sent to the log by components using a fixed global logger?  We'll have to redirect this data, but how to test them in parallel?  None?  The answer is unsatisfactory.  Or, say, there are two independent components that generate HTTP requests with different requirements, how do we manage this?  Using standard global <code>http.Client</code> is quite difficult to do.  See an example: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { resp, err := http.Get(<span class="hljs-string"><span class="hljs-string">"http://zombo.com"</span></span>) <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br>  http.Get calls global in the http package.  It has an implicit global dependency, which we can quite easily get rid of: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(client *http.Client)</span></span></span></span> { resp, err := client.Get(<span class="hljs-string"><span class="hljs-string">"http://zombo.com"</span></span>) <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br>  Just pass <code>http.Client</code> as a parameter.  But this is a specific type (concrete type), so if we want to test this function, we will have to provide a specific http.Client, which will surely force us to establish the actual connection via HTTP.  This is not good.  You can do better: pass an interface that can perform ( <code>Do</code> ) HTTP requests. <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Doer <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { Do(*http.Request) (*http.Response, error) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(d Doer)</span></span></span></span> { req, _ := http.NewRequest(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, <span class="hljs-string"><span class="hljs-string">"http://zombo.com"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) resp, err := d.Do(req) <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br>  <code>http.Client</code> automatically satisfies the <code>Doer</code> interface, but now we are free to pass on our implementation of <code>Doer</code> to our test.   :     <code>foo</code>      <code>foo</code> ,     ,  <code>http.Client</code>   ,  . <br><br>     ‚Ä¶ <br><br><a name="7"></a><h1>  Testing </h1><br>  2014                   ,      -  .     (stdlib)          .         .    Go  ,  <i>  </i> .           ,        .    testing     . <br><br>  TDD/BDD   ,  DSL   ,        ,      .      ,       .  ,   ,    ,         <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25B0%25D1%2580%25D0%25B3%25D0%25BE-%25D0%25BA%25D1%2583%25D0%25BB%25D1%258C%25D1%2582"> </a> ,      . <i>When in Go, do as Gophers do (   Go,  ,    )</i> :            ‚Äî   Go,  , ,   . <br><br>  ,       .          GOPATH,      ,        ,        DSL  .   ,    ,  . ,      . <br><br>        .   (Mitchell Hashimoto)          ( <a href="https://speakerdeck.com/mitchellh/advanced-testing-with-go">SpeakerDeck</a> , <a href="https://www.youtube.com/watch%3Fv%3Dyszygk1cpEc">YouTube</a> ),  . <br><br>   : ,      Go   ,                  .  ,       ,       ,   . <br><br><h4> ‚ú™ <b>Top Tip</b> ‚Äî       . </h4><br>      <code>http.Client</code> , ,         -  ,     .    - -,        HTTP-,    ,    ,    .          -     -   . <br><br><h4> ‚ú™ <b>Top Tip</b> ‚Äî     ,  . </h4><br><a name="8"></a><h1>   </h1><br>   .  2014     ,           (vendor).  - :            .  ,  Go 1.6 GO15VENDOREXPERIMENT      vendor/    .       . ,  ,   .     : <br><br><ul><li> <a href="https://github.com/FiloSottile/gvt">FiloSottile/gvt</a>   .  ,     gb   ,    . </li><li> <a href="https://github.com/Masterminds/glide">Masterminds/glide</a>   :          .   . </li><li> <a href="https://github.com/kardianos/govendor">kardianos/govendor</a>   , , ,       .     - (   ,     ,  ‚Äî  vendor.json. ‚Äî . ). </li><li> <a href="https://github.com/constabulary/gb">constabulary/gb</a>    go        .    ,           ,    . </li></ul><br><h4> ‚ú™ <b>Top Tip</b> ‚Äî          . </h4><br>    .  Go        .       ,  .      ,    1.5   ,        .    ,      : <a href="https://groups.google.com/forum/">1</a> , <a href="https://groups.google.com/forum/">2</a> .  ,   : <b></b>      . <br><br><h4> ‚ú™ <b>Top Tip</b> ‚Äî       . </h4><br>      ,                  ()  API.   ,         . <br><br>        open source ,      ,       .   ,       ,      .  GO15VENDOREXPERIMENT     ,       . <br><br>  ,       .  Etcd  ,   <a href="https://github.com/coreos/etcd/tree/60425de0ff0dc8a2e7898fcd56f16669d4e4933b/cmd">     </a> ,      ,        Go     Windows. ,     ,   ,    . ,     ,    <a href="https://github.com/golang/go/issues/15162"> </a>  ,     -  . <br><br><a name="9"></a><h1>    </h1><br>   ,     (  )  <code>go install</code>  <code>go build</code> .  <code>install</code>   <code>$GOPATH/pkg</code>    ,    .      <code>$GOPATH/bin</code>   ,      . <br><br><h4> ‚ú™ <b>Top Tip</b> ‚Äî  <code>go install</code>  <code>go build</code> . </h4><br>     ,     ,  <a href="https://getgb.io/">gb</a> .       .      ,    Go 1.5 -  ¬´ ¬ª.      GOOS  GOARCH,     go-.       . <br><br>    ,   , ,        ,  Ruby,  Python,   JVM.  :      ,   <a href="https://medium.com/%40kelseyhightower/optimizing-docker-images-for-static-binaries-b5696e26eb07">  </a> ‚Äî  FROM scratch. Go    ,     . <br><br>       :   ,        , ‚Äî     -.          .  ,    AMI    EC2,       .           . <br><br><a name="10"></a><h1>  Conclusion </h1><br> Top Tips: <br><br><ol><li>  <code>$GOPATH/bin</code>   <code>$PATH</code> ,        . </li><li>    foo       ,        lib/   <code>package foo</code> . </li><li>      ‚Äî ,          cmd/. </li><li>      . </li><li>   <code>func main()</code>   ,     . </li><li>     ,    . ,  ,   . </li><li>    nil   no-op-  . </li><li>    ,    . </li><li> <b>  !</b> </li><li>   ,        ,   ,     . . </li><li>       . </li><li>     ,  . </li><li>          . </li><li>       . </li><li>  <code>go install</code>  <code>go build</code> . </li></ol><br> Go    ,        ,  -  .   ‚Äî     ‚Äî           .         ( <a href="https://go-proverbs.github.io/">Go Proverbs</a> ),       ,     ¬´  ¬ª (up the stack)   ,   ,          Go. <br><br>           Go. </div><p>Source: <a href="https://habr.com/ru/post/301036/">https://habr.com/ru/post/301036/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../301024/index.html">Announcement: on June 8, Microsoft will host a virtual forum, Data. Technology. SQL Server 2016 ¬ª</a></li>
<li><a href="../301026/index.html">Review conference ProfsoUX-2016</a></li>
<li><a href="../301028/index.html">ReactOS 0.4.1 release and answer to the question ‚ÄúCan I patch ReactOS under KDE4?‚Äù</a></li>
<li><a href="../301030/index.html">Metromarathon Algorithm. As a Yandex analyst, I calculated that all stations can be visited in one day.</a></li>
<li><a href="../301032/index.html">12 week sketch marathon, do or die</a></li>
<li><a href="../301040/index.html">What browsers do with your JavaScript code: about optimizations in JS engines using V8 as an example</a></li>
<li><a href="../301042/index.html">Angular 2 brings the world to the frontend galaxy</a></li>
<li><a href="../301044/index.html">Five ways to paginate in Postgres, from basic to outlandish</a></li>
<li><a href="../301046/index.html">Test lab v.9: impossible or nothing</a></li>
<li><a href="../301048/index.html">EDS of CIS countries in Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>