<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Track updates from MongoDB Replica Set Oplog using Scala and Akka Streams</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I present to your attention the translation of the article Tailing the MongoDB Replica Set Oplog with Scala and Akka Streams . 
 Introduction 
 In thi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Track updates from MongoDB Replica Set Oplog using Scala and Akka Streams</h1><div class="post__text post__text-html js-mediator-article">  <em>I present to your attention the translation of the article <a href="http://khamrakulov.de/tailing_the_mongodb_replica_set_oplog_with_scala_and_akka_streams/">Tailing the MongoDB Replica Set Oplog with Scala and Akka Streams</a> .</em> <br><h2>  Introduction </h2><br>  In this article I will try to explain how to monitor updates in MongoDB Oplog with the help of the <a href="http://mongodb.github.io/mongo-scala-driver/1.1/getting-started/">Scala driver MongoDB</a> and <a href="http://doc.akka.io/docs/akka/2.4.2/scala/stream/index.html">Akka Streams</a> . <br>  The examples given in this article should not be considered and used in production environment. <br>  Each of us knows the Unix command <code>tail -f</code> , the <code>Tailable Cursor</code> has the same concept.  MongoDB provides the ability to use this feature by default and does not require additional libraries and tools.  As for <code>Oplog</code> , this is the same collection as everyone else and nothing new is required. <br>  If you want to learn more about <code>Oplog</code> and the <code>Tailable Cursor</code> , then you can find more information in the MongoDB documentation: <br><ul><li>  <a href="https://docs.mongodb.org/manual/core/replica-set-oplog/">Replica Set Oplog</a> </li><li>  <a href="https://docs.mongodb.org/manual/tutorial/create-tailable-cursor/">Create Tailable Cursor</a> </li></ul><br>  The project created in this article is conveniently located on <a href="https://github.com/htimur/mongo_oplog_akka_streams">Github</a> . <br><a name="habracut"></a><br><h2>  Libraries and Tools </h2><br><ul><li>  <a href="http://www.scala-lang.org/documentation/getting-started.html">Scala v2.11.7</a> </li><li>  <a href="http://mongodb.github.io/mongo-scala-driver/1.1/getting-started/">MongoDB Scala Driver v1.1.0</a> </li><li>  <a href="http://doc.akka.io/docs/akka/2.4.2/scala/stream/index.html">Akka Streams Module v2.4.2</a> </li></ul><br>  An example of the build.sbt file: <br><pre> <code class="scala hljs">name := <span class="hljs-string"><span class="hljs-string">"MongoDB Replica Set oplog tailing with Akks Streams"</span></span> version := <span class="hljs-string"><span class="hljs-string">"1.0"</span></span> scalaVersion := <span class="hljs-string"><span class="hljs-string">"2.11.7"</span></span> libraryDependencies ++= <span class="hljs-type"><span class="hljs-type">Seq</span></span>( <span class="hljs-string"><span class="hljs-string">"ch.qos.logback"</span></span> % <span class="hljs-string"><span class="hljs-string">"logback-classic"</span></span> % <span class="hljs-string"><span class="hljs-string">"1.1.5"</span></span>, <span class="hljs-string"><span class="hljs-string">"org.mongodb.scala"</span></span> %% <span class="hljs-string"><span class="hljs-string">"mongo-scala-driver"</span></span> % <span class="hljs-string"><span class="hljs-string">"1.1.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"com.typesafe.akka"</span></span> %% <span class="hljs-string"><span class="hljs-string">"akka-slf4j"</span></span> % <span class="hljs-string"><span class="hljs-string">"2.4.2"</span></span>, <span class="hljs-string"><span class="hljs-string">"com.typesafe.akka"</span></span> %% <span class="hljs-string"><span class="hljs-string">"akka-stream"</span></span> % <span class="hljs-string"><span class="hljs-string">"2.4.2"</span></span> )</code> </pre> <br>  You will also need MongoDB Replica Set, I can recommend the official <a href="https://hub.docker.com/_/mongo/">mongo docker</a> image. <br><h2>  Request to monitor MongoDB Oplog </h2><br>  Assuming that you already have an established connection, let's define the request.  The following is an example: <br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> collection: <span class="hljs-type"><span class="hljs-type">MongoCollection</span></span>[<span class="hljs-type"><span class="hljs-type">Document</span></span>] = _ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> observable = collection.find(in(<span class="hljs-string"><span class="hljs-string">"op"</span></span>, <span class="hljs-string"><span class="hljs-string">"i"</span></span>, <span class="hljs-string"><span class="hljs-string">"d"</span></span>, <span class="hljs-string"><span class="hljs-string">"u"</span></span>)) .cursorType(<span class="hljs-type"><span class="hljs-type">CursorType</span></span>.<span class="hljs-type"><span class="hljs-type">TailableAwait</span></span>) .noCursorTimeout(<span class="hljs-literal"><span class="hljs-literal">true</span></span>)</code> </pre> <br>  As you can see from the request, we define a <code>tailable</code> cursor <code>tailable</code> no <code>timeout</code> , and the <code>op</code> field that defines the type of operation in <code>Oplog</code> should be a <a href="https://ru.wikipedia.org/wiki/CRUD">CRUD</a> operation <code>i/d/u</code> . <br><h2>  A bit about Akka Streams terminology </h2><br>  Complete documentation in English is available <a href="http://doc.akka.io/docs/akka/2.4.2/scala/stream/index.html">here</a> . <br>  In Akka Stream, the data stream processing scheme is defined by the following abstractions: <br>  <strong>Source</strong> ‚Äî A data processing stage with only one exit point, providing data elements as soon as the underlying data processing elements are ready to be received. <br>  <strong>Sink</strong> - The stage of processing data with only one entry point, requesting and receiving data elements with the possibility of slowing down the receipt of data from the overlying element. <br>  <strong>Flow</strong> - The stage of processing data with only one entry and exit point, which connects the flow of data and transforms the elements passing through it. <br>  <strong>RunnableGraph</strong> - This is a <code>Flow</code> that is connected to <code>Source</code> and <code>Sink</code> and is ready to execute the <code>run()</code> command. <br>  In our case, we will only use <code>Source</code> and <code>Sink</code> , since we will only follow the updates without changing the incoming data. <br><h4>  MongoDB Scala Driver and Akka Stream </h4><br>  Unfortunately, there is no default option for integrating Akka Streams and MongoDB drivers, but Akka Streams has the ability to integrate with <a href="http://www.reactive-streams.org/">Reactive Streams</a> , as well as the newly published, new, official, asynchronous MongoDB Scala driver.  The new driver uses the <code>Observable</code> model, which can be converted to Reactive Streams <code>Publisher</code> with just a few lines of code, and the MongoDB team has already given <a href="https://github.com/mongodb/mongo-scala-driver/blob/master/examples/src/test/scala/rxStreams/Implicits.scala">an example of an <code>implicit</code> conversion</a> that we will use as the contact point between the two libraries. <br><h2>  Stream Source Declaration </h2><br>  <code>Source</code> definition is very easy.  From <code>Oplog</code> we will receive <code>Document</code> objects, this will be the type of the <code>Source</code> stream. <br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> source: <span class="hljs-type"><span class="hljs-type">Source</span></span>[<span class="hljs-type"><span class="hljs-type">Document</span></span>, <span class="hljs-type"><span class="hljs-type">NotUsed</span></span>] = _</code> </pre> <br>  At the moment, we have a <code>FindObservable[Document]</code> object from a MongoDB <code>Oplog</code> request and a <code>Source[Document, NotUsed]</code> resource type, so how do we convert one into the other? <br>  The magic of implicit conversion will help us in this.  Type <code>Source</code> contains a method: <br><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromPublisher</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>](publisher: <span class="hljs-type"><span class="hljs-type">Publisher</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]): <span class="hljs-type"><span class="hljs-type">Source</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>, <span class="hljs-type"><span class="hljs-type">NotUsed</span></span>]</code> </pre> <br>  which converts the Reactive Streams <code>Publisher</code> type to <code>Source</code> , we also have an implicit conversion from MongoDB <code>Observable</code> to <code>Publisher</code> .  Now we can link all the parts: <br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> rxStreams.<span class="hljs-type"><span class="hljs-type">Implicits</span></span>._ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> collection: <span class="hljs-type"><span class="hljs-type">MongoCollection</span></span>[<span class="hljs-type"><span class="hljs-type">Document</span></span>] = _ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> observable = collection.find(in(<span class="hljs-string"><span class="hljs-string">"op"</span></span>, <span class="hljs-string"><span class="hljs-string">"i"</span></span>, <span class="hljs-string"><span class="hljs-string">"d"</span></span>, <span class="hljs-string"><span class="hljs-string">"u"</span></span>)) .cursorType(<span class="hljs-type"><span class="hljs-type">CursorType</span></span>.<span class="hljs-type"><span class="hljs-type">TailableAwait</span></span>) .noCursorTimeout(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> source: <span class="hljs-type"><span class="hljs-type">Source</span></span>[<span class="hljs-type"><span class="hljs-type">Document</span></span>, <span class="hljs-type"><span class="hljs-type">NotUsed</span></span>] = <span class="hljs-type"><span class="hljs-type">Source</span></span>.fromPublisher(observable)</code> </pre> <br>  It was pretty easy, wasn't it? <br><h4>  What to do next? </h4><br>  All that you can imagine, for the time being, I will simply output all data in <code>STDOUT</code> : <br><pre> <code class="scala hljs">source.runWith(<span class="hljs-type"><span class="hljs-type">Sink</span></span>.foreach(println))</code> </pre> <br>  or you can use shortcuts: <br><pre> <code class="scala hljs">source.runForeach(println)</code> </pre> <br>  this will output all CRUD operations from the MongoDB Replica Set from the beginning of the <code>Oplog</code> collection to the end and will keep track of new arrivals. <br>  You can specify a more specific query, define databases and collections from which you want to receive updates, as well as you can define the time frame for incoming documents.  This I will leave for you. <br><h4>  Why do we need it? </h4><br>  Perhaps you thought about why we need to convert <code>Observable</code> to <code>Publisher</code> , and then also to <code>Source</code> , while we could just use Reactive Streams <code>Publisher</code> or <code>Observable</code> . <br>  The point is that the <code>Observables</code> model and the Reactive Streams API provide common mechanisms for transferring data in an asynchronous lossless framework, while the Akka Streams API focuses on the transformation of the data stream. <br>  So if you are only interested in transferring data from <code>Oplog</code> somewhere, you can follow the <code>Observables</code> model provided by the MongoDB driver, but if you need to transform the data stream, the choice falls on the Akka Stream. <br><h2>  Conclusion </h2><br>  As you can see from the article, tracking MongoDB Oplog is a very simple task, especially in the Replica Set.  Other pitfalls may arise, if it is MongoDB Sharded Cluster, it will be covered in the next article. <br>  Of course, this post does not cover all aspects of this topic, for example, error handling, delivery guarantees, etc.  This can be implemented in various ways and is not the topic of this article. <br></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/278441/">https://habr.com/ru/post/278441/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278429/index.html">Fresh exhibition ISE - new LEDs, screens in the windows and how to break the screen that does not break</a></li>
<li><a href="../278431/index.html">First hakaton 2GIS</a></li>
<li><a href="../278435/index.html">Image binarization: Bradley algorithm</a></li>
<li><a href="../278437/index.html">If programmers were making pancakes (according to kosher methodologies)</a></li>
<li><a href="../278439/index.html">We fix the error of installing updates Windows 7</a></li>
<li><a href="../278443/index.html">Physical web concept. Bluetooth beacons. Comparison of iBeacon, AltBeacon and Eddystone standards</a></li>
<li><a href="../278445/index.html">Pomp - metaframe for parsing sites</a></li>
<li><a href="../278447/index.html">Ralph Baer: "Video Games, I'm your father!"</a></li>
<li><a href="../278449/index.html">Meet at CodeFest</a></li>
<li><a href="../278451/index.html">Dream job or a small history of mobile development</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>