<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The practice of using the lottie library in the bank‚Äôs mobile application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 

 At one time, the Product Owner asked us to think about creating an effective process for introducing animation into our application on an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The practice of using the lottie library in the bank‚Äôs mobile application</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr! <br><br>  At one time, the Product Owner asked us to think about creating an effective process for introducing animation into our application on android / ios.  At that time we did the task of pre-filling the application with personal data for the loan product, and the response from the server took some time, during which we wanted to show a beautiful loading animation. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/0f/zx/te/0fzxtebssjpev57e8wic-slkpu8.png" width="300"></div><a name="habracut"></a><br>  The task was clear: the designer wanted to draw beautifully, to give the source code to both at once. <br>  platforms without dopilivany on his part, and so that all this does not lag on old devices (yes, we still support android 4.1). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>What were my options for introducing animation:</b> <br><br><ol><li>  Handles using animated vector drawable.  The pros are that the rendering works. <br>  in a separate thread (starting with api 25), the downsides are the difficulty of creating such animations and a small number of manipulations with objects.  For simple animations, this all works well, but a little harder, and hell begins.  Yes, and on different platforms you will not get. </li><li>  Gif - weigh a lot, have a fixed size, and therefore do not scale normally.  And you will not make any manipulations with them. </li><li>  Sequence png (no comments). </li></ol><br>  Having rummaged some time towards the native vector animation of android and gif (oh god, we still considered this option), I remembered the wonderful library Lottie, and showed it to my colleagues. <br><br>  After some tests with different devices, we decided that the library should be implemented, especially since its capabilities were impressive.  The designer was especially pleased, now he could do almost any animation in Adobe After Effects, and export it to a json file with a few clicks.  We were delighted, but first things first. <br><br>  Lottie was designed and implemented by Airbnb in response to a growing demand for cross-platform animation, so it works the same (well, almost) on all platforms.  The developers themselves claim that their goal is to realize the maximum number of After Effects features, and they succeeded in that.  Now implementing a Lottie animation is as easy as inserting a picture into an ImageView. <br><br>  <b>Key 3 classes:</b> <br><br><ol><li>  LottieAnimationView is an inheritor of ImageView, and the easiest way to use animation.  You can describe the animation in xml, or in the code, most methods are supported. </li><li>  LottieDrawable - the heir to Drawable, with the same functionality as the previous class, allows you to apply animation to any view. </li><li>  LottieComposition and its companion LottieCompositionFactory allow you to preload animations from various sources and apply them to LottieDrawable and LottieAnimationView. </li></ol><br><h4>  Resource download </h4><br>  Supports resource loading from: <br><br><ol><li>  res / raw </li><li>  src / assets </li><li>  Json strings </li><li>  Any url from the network leading to a json or zip file (implemented through HttpURLConnection, in order not to add external dependencies. If you have animation with images, then you need to use zip) </li><li>  InputStream json or zip file </li></ol><br><h4>  Caching animation </h4><br>  The cool thing is that all the animations loaded via res / raw or assets are saved with LRU cache, which allows you not to waste user time again on loading and parsing the animation, as in the case of complex animation it may take some time.  What's even cooler if you need to preload the animation, and then in the next snippet to display the animation instantly, you can use the code <br><br><pre><code class="kotlin hljs">LottieCompositionFactory.fromRawRes(context, rawFile)</code> </pre> <br>  The animation is cached using the rawFile key, and where you really need to use it, it will start almost instantly. <br><br><h4>  Progress management </h4><br>  Lottie allows you to set the current animation state via setProgress (...).  This can be useful if you want to animate the file download status, scroll position, various gestures, etc.  I saw various implementations on BottomSheets, PullToRefresh, CollapsingToolbarLayout. <br><br>  Here's how to use progress with AppBarLayout: <br><br><pre> <code class="kotlin hljs">appBarLayout.addOnOffsetChangedListener(AppBarLayout.OnOffsetChangedListener { appBarLayout, verticalOffset -&gt; <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> percent = Math.abs(verticalOffset).toFloat()/appBarLayout.totalScrollRange animationView.progress = percent })</code> </pre><br><h4>  Looping </h4><br>  Lottie supports looping playback of setRepeatMode () or setRepeatCount () not only the whole animation, but also any fragment within (0.0 ... 1.0).  This is implemented by the properties setMinFrame, setMaxFrame, setMinAndMaxFrame.  We used this to not implement 3 animations for different file loading states: idle, progress, complete.  Here is a small piece of code that solves this: <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (loadingStatus) { LoadingStatus.IDLE -&gt; { animationView.setMaxProgress(<span class="hljs-number"><span class="hljs-number">0.1f</span></span>) } LoadingStatus.PROGRESS -&gt; { animationView.setMinAndMaxProgress(<span class="hljs-number"><span class="hljs-number">0.2f</span></span>, <span class="hljs-number"><span class="hljs-number">0.9f</span></span>) animationView.repeatCount = LottieDrawable.INFINITE animationView.playAnimation() } LoadingStatus.COMPLETE -&gt; { animationView.setMinAndMaxProgress(<span class="hljs-number"><span class="hljs-number">0.9f</span></span>, <span class="hljs-number"><span class="hljs-number">1f</span></span>) animationView.repeatCount = <span class="hljs-number"><span class="hljs-number">1</span></span> animationView.playAnimation() }}</code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mi/iw/iu/miiwiupaeldyjmhfegtkruqn9jo.gif" width="250"></div><br><h4>  Pictures </h4><br>  One of the main advantages of Lottie for us is that the library supports the insertion of images directly into the animation.  Moreover, you can insert both a static image and a dynamic image downloaded from the Internet.  Now I will explain how it works. <br><br>  In the case of a static picture, everything is simple: the designer uploads to you an archive containing json plus the picture itself. <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"v"</span></span>: <span class="hljs-string"><span class="hljs-string">"5.1.13"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fr"</span></span>: <span class="hljs-number"><span class="hljs-number">29.9700012207031</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ip"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"op"</span></span>: <span class="hljs-number"><span class="hljs-number">47.0000019143492</span></span>, <span class="hljs-attr"><span class="hljs-attr">"w"</span></span>: <span class="hljs-number"><span class="hljs-number">1034</span></span>, <span class="hljs-attr"><span class="hljs-attr">"h"</span></span>: <span class="hljs-number"><span class="hljs-number">1334</span></span>, <span class="hljs-attr"><span class="hljs-attr">"nm"</span></span>: <span class="hljs-string"><span class="hljs-string">" 1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ddd"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"assets"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"image_0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"w"</span></span>: <span class="hljs-number"><span class="hljs-number">130</span></span>, <span class="hljs-attr"><span class="hljs-attr">"h"</span></span>: <span class="hljs-number"><span class="hljs-number">436</span></span>, <span class="hljs-attr"><span class="hljs-attr">"u"</span></span>: <span class="hljs-string"><span class="hljs-string">"images/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"p"</span></span>: <span class="hljs-string"><span class="hljs-string">"img_0.png"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"comp_0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"layers"</span></span>: [ ... ]}] }</code> </pre> <br>  This img_0.png, this is the picture that you need to put in src / assets, and which will be inside the animation. <br><br>  For dynamic loading, the setImageAssetDelegate method is used, to which you must transfer a bitmap.  We preload the picture with Glide, so at the stage of opening the fragment with animation and the picture, everything comes from the cache, so everything is pretty fast.  Here is the code: <br><br><pre> <code class="kotlin hljs">glideLoader.loadAsBitmap(imageUrl).into(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>: CustomTarget&lt;Bitmap&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResourceReady</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(resource: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Bitmap</span></span></span></span><span class="hljs-function"><span class="hljs-params">, transition: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Transition</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Bitmap</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;?)</span></span></span></span> { viewAnimation.setImageAssetDelegate(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>: ImageAssetDelegate { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchBitmap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(asset: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">LottieImageAsset</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span>: Bitmap { asset?.let { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> resizeBitmap =Bitmap.createScaledBitmap(resource, it.width, it.height, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resizeBitmap } ?: run { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resource } } }) setAnimation(viewAnimation, animationImage) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onLoadCleared</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(placeholder: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Drawable</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span> {} })</code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/eb/i3/ly/ebi3lylquqmqr2yljlo3jllm-ja.gif" width="250"></div><br><h4>  Performance </h4><br>  Of course, it is better not to use a lot of animation on screens where the user spends a lot of time, as it is demanding on the processor.  According to our tests, the processor load on some animations reaches 20%.  Therefore, the ideal case of such an animation is interactive elements that work once. <br><br>  If the animation on some devices slows down, sometimes it helps <br><br><pre> <code class="kotlin hljs">viewAnimation.useHardwareAcceleration(<span class="hljs-literal"><span class="hljs-literal">true</span></span>)</code> </pre> <br>  However, developers recommend using this method with caution, since different phones use hardware acceleration differently, so instead of acceleration, you can get the opposite effect. <br><br><h4>  Conclusion </h4><br>  In general, using the Lottie library greatly simplifies the implementation of animation in the application. <br><br>  <b>The main advantages of lottie, which we have identified:</b> <br><br><ol><li>  Small library size (300 kb) </li><li>  Cross-platform solution ios / android / web </li><li>  Download animations from the network </li><li>  Progress management and looping on any site </li><li>  A large number of features from the after effects allows the designer to realize the intended effect. </li></ol><br>  <b>Minuses:</b> <br><br><ol><li>  Rendering is performed in the main stream, and fps can drop significantly in an application. </li><li>  Parsing a lottie animation can take a significant amount of time with complex animations. </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4v/l9/i7/4vl9i7i2nta0osmi8rj3x6oixzm.gif" width="250"></div><br>  By the way, to check how resource-intensive animation, you can use the official <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.airbnb.lottie">Lottie</a> application <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.airbnb.lottie">from Google Play</a> .  There is a Render Graph, where you can see the time for rendering a frame, and also see what the animation will look like if you cut it into frames, or how hardwareAcceleration will affect and much more. </div><p>Source: <a href="https://habr.com/ru/post/459852/">https://habr.com/ru/post/459852/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459840/index.html">XAML Hot Reload Preview for Xamarin.Forms has been released</a></li>
<li><a href="../459842/index.html">Luxor</a></li>
<li><a href="../459844/index.html">Penguin in the window: the potential and prospects for WSL2</a></li>
<li><a href="../45985/index.html">Chrome will support extensions.</a></li>
<li><a href="../459850/index.html">Amateur radio technology: how I ordered the installation of a PCB in a Chinese factory</a></li>
<li><a href="../459858/index.html">Research of modern Malware Cerberus for Android</a></li>
<li><a href="../459860/index.html">Configure ClickHouse for integration testing in gitlab-ci</a></li>
<li><a href="../459862/index.html">Berkeley DB STL Interface</a></li>
<li><a href="../459866/index.html">Solving a task with pwnable.kr 02 - collision. Hash collision</a></li>
<li><a href="../459870/index.html">Sample Model-View-Update Architecture on F #</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>