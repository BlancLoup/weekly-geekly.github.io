<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The command line of a Linux photographer is retired!</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I take a great interest in a photo from the Change-8M. Then there were long expectations of Friday or Saturday (printing usually went on the night of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The command line of a Linux photographer is retired!</h1><div class="post__text post__text-html js-mediator-article">  I take a great interest in a photo from the Change-8M.  Then there were long expectations of Friday or Saturday (printing usually went on the night of the weekend), and before that there were very long waiting times for photographic film, chemicals, photographic paper (for scarcity).  Now I grew up, became big and lazy.  My soap box is almost always with me: either in a backpack, or somewhere in my pocket.  I photograph everything that aroused interest.  In this case, there can be one photo per day (I went from work), and maybe a lot at once (purposefully went out for a walk).  And if with a purposeful case I‚Äôve most likely to pick up the photos with salt and sort them out, then in rare cases I‚Äôll forget and then it turns out that I need to sort the photos taken in a dozen different days.  Recently, getting purposefully getting less and less, so the number of single photographs grew.  And one of these days, inspired by <a href="http://habrahabr.ru/post/128527">last year‚Äôs article</a> , I decided to simplify my hobby.  Since Linux is on a computer (openSUSE 12.1), there should be no unsolvable problems - I thought.  And I wanted it to copy itself and not need to poke anywhere.  Well, since I‚Äôm not a real Linux user (the first and last script was in the third year of 0x0C years ago), I‚Äôll say at once that not everything worked out. <br><a name="habracut"></a><br>  I keep photos in one place, a separate catalog with a date for a separate event, even if there is one photo: ‚Äú2009.05.20 Night Peter‚Äù, ‚Äú2011.08.20 Lavna Falls‚Äù, ‚Äú2012.07.24 Dusya is sleeping‚Äù.  Thoughts are already coming that need at least one more level - a year, but for the time being I suffer.  My or not my photos (in the case of collective campaigns) - it does not matter to me, everything will be in the same catalog for the event.  I‚Äôll find my photos if necessary. <br>  For automatic sorting, you need to track the moment of connecting the desired memory card and run the sorting script.  On Linux, the udev daemon is responsible for hardware.  Therefore, to begin to learn how to handle it. <br><br><h5>  udev </h5>  udev monitors the hardware and creates a node for each device in the / dev directory.  This is convenient, but there is a small nuance: devices of one class will be named sequentially depending on the order of their connection.  Therefore, the initial option is to press a button on the script that would copy everything where necessary ‚Äî not suitable (you never know what other disks will be connected, but to track a specific disk you will have to complicate the script, and you didn‚Äôt want to press somewhere after connecting the card) .  But it can be configured so that a particular disk is mounted at the desired point - this is already good, but not enough.  Its biggest plus: the launch of an arbitrary script for some events suitable for the filter.  To begin with, let's look at what attributes and events we can attach to uniquely determine the fact of inserting a memory card into the card reader.  The ultimate goal of this section is the udev card matching rules file. <br>  To view the characteristics of devices, you can use the program udevadm.  But she needs a device name.  Therefore, you must first determine the name of the disk in the card reader.  We use the easiest way.  First, we look at what drives we already have in the system: <br><pre><code class="bash hljs">&gt;ls -1 /dev/sd* /dev/sda /dev/sda1 /dev/sdb /dev/sdb1 /dev/sdc /dev/sdc1 /dev/sdd /dev/sdd1 /dev/sde /dev/sde1 /dev/sdf /dev/sdg /dev/sdh /dev/sdi</code> </pre> <br>  Insert the card into the reader and repeat the command: <br><pre> <code class="bash hljs">&gt;ls -1 /dev/sd* /dev/sda /dev/sda1 /dev/sdb /dev/sdb1 /dev/sdc /dev/sdc1 /dev/sdd /dev/sdd1 /dev/sde /dev/sde1 /dev/sdf /dev/sdg /dev/sdh /dev/sdh1 /dev/sdi</code> </pre><br>  It can be seen that the inserted card is hidden under the name / dev / sdh1.  I will say secretly that the last 4 disks (sdf, sdg, sdh, sdi) are all card readers, and you could determine its disks by running the same command before and after connecting the reader to the computer, even without a memory card (before me it is a little later it came when he had already determined the name of the volume in the manner described). <br><br>  Now we look at the characteristics of this card reader and card.  You need to find something for which it will be possible to cling to for more or less unambiguous determination of the fact of the appearance of the card in the reader.  Here we will need any of his disk names.  This command will display a list of attributes of all devices, starting with the one specified by the name and up to the root, in a udev-like format: <br><div class="spoiler">  <b class="spoiler_title">Udevadm output</b> <div class="spoiler_text"><pre> <code class="bash hljs">&gt;udevadm info -a -n /dev/sdh1 Udevadm info starts with the device specified by the devpath and <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> walks up the chain of parent devices. It prints <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> every device found, all possible attributes <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the udev rules key format. A rule to match, can be composed by the attributes of the device and the attributes from one single parent device. looking at device <span class="hljs-string"><span class="hljs-string">'/devices/pci0000:00/0000:00:02.1/usb1/1-1/1-1:1.0/host10/target10:0:0/10:0:0:2/block/sdh/sdh1'</span></span>: KERNEL==<span class="hljs-string"><span class="hljs-string">"sdh1"</span></span> SUBSYSTEM==<span class="hljs-string"><span class="hljs-string">"block"</span></span> DRIVER==<span class="hljs-string"><span class="hljs-string">""</span></span> ATTR{partition}==<span class="hljs-string"><span class="hljs-string">"1"</span></span> ATTR{start}==<span class="hljs-string"><span class="hljs-string">"2048"</span></span> ATTR{size}==<span class="hljs-string"><span class="hljs-string">"153600"</span></span> ATTR{ro}==<span class="hljs-string"><span class="hljs-string">"0"</span></span> ATTR{alignment_offset}==<span class="hljs-string"><span class="hljs-string">"0"</span></span> ATTR{discard_alignment}==<span class="hljs-string"><span class="hljs-string">"0"</span></span> ATTR{<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>}==<span class="hljs-string"><span class="hljs-string">" 146 4 738 319 0 0 0 0 0 319 319"</span></span> ATTR{inflight}==<span class="hljs-string"><span class="hljs-string">" 0 0"</span></span> looking at parent device <span class="hljs-string"><span class="hljs-string">'/devices/pci0000:00/0000:00:02.1/usb1/1-1/1-1:1.0/host10/target10:0:0/10:0:0:2/block/sdh'</span></span>: KERNELS==<span class="hljs-string"><span class="hljs-string">"sdh"</span></span> SUBSYSTEMS==<span class="hljs-string"><span class="hljs-string">"block"</span></span> DRIVERS==<span class="hljs-string"><span class="hljs-string">""</span></span> ATTRS{range}==<span class="hljs-string"><span class="hljs-string">"16"</span></span> ATTRS{ext_range}==<span class="hljs-string"><span class="hljs-string">"256"</span></span> ATTRS{removable}==<span class="hljs-string"><span class="hljs-string">"1"</span></span> ATTRS{ro}==<span class="hljs-string"><span class="hljs-string">"0"</span></span> ATTRS{size}==<span class="hljs-string"><span class="hljs-string">"7745536"</span></span> ATTRS{alignment_offset}==<span class="hljs-string"><span class="hljs-string">"0"</span></span> ATTRS{discard_alignment}==<span class="hljs-string"><span class="hljs-string">"0"</span></span> ATTRS{capability}==<span class="hljs-string"><span class="hljs-string">"51"</span></span> ATTRS{<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>}==<span class="hljs-string"><span class="hljs-string">" 1352 1239 73856 8882 4 18 22 735 0 3608 9615"</span></span> ATTRS{inflight}==<span class="hljs-string"><span class="hljs-string">" 0 0"</span></span> ATTRS{events}==<span class="hljs-string"><span class="hljs-string">"media_change"</span></span> ATTRS{events_async}==<span class="hljs-string"><span class="hljs-string">""</span></span> ATTRS{events_poll_msecs}==<span class="hljs-string"><span class="hljs-string">"-1"</span></span> looking at parent device <span class="hljs-string"><span class="hljs-string">'/devices/pci0000:00/0000:00:02.1/usb1/1-1/1-1:1.0/host14/target14:0:0/14:0:0:2'</span></span>: KERNELS==<span class="hljs-string"><span class="hljs-string">"14:0:0:2"</span></span> SUBSYSTEMS==<span class="hljs-string"><span class="hljs-string">"scsi"</span></span> DRIVERS==<span class="hljs-string"><span class="hljs-string">"sd"</span></span> ATTRS{device_blocked}==<span class="hljs-string"><span class="hljs-string">"0"</span></span> ATTRS{<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>}==<span class="hljs-string"><span class="hljs-string">"0"</span></span> ATTRS{scsi_level}==<span class="hljs-string"><span class="hljs-string">"0"</span></span> ATTRS{vendor}==<span class="hljs-string"><span class="hljs-string">"Generic-"</span></span> ATTRS{model}==<span class="hljs-string"><span class="hljs-string">"SD/MMC "</span></span> ATTRS{rev}==<span class="hljs-string"><span class="hljs-string">"1.00"</span></span> ATTRS{state}==<span class="hljs-string"><span class="hljs-string">"running"</span></span> ATTRS{timeout}==<span class="hljs-string"><span class="hljs-string">"30"</span></span> ATTRS{iocounterbits}==<span class="hljs-string"><span class="hljs-string">"32"</span></span> ATTRS{iorequest_cnt}==<span class="hljs-string"><span class="hljs-string">"0x220"</span></span> ATTRS{iodone_cnt}==<span class="hljs-string"><span class="hljs-string">"0x220"</span></span> ATTRS{ioerr_cnt}==<span class="hljs-string"><span class="hljs-string">"0x21f"</span></span> ATTRS{evt_media_change}==<span class="hljs-string"><span class="hljs-string">"0"</span></span> ATTRS{queue_depth}==<span class="hljs-string"><span class="hljs-string">"1"</span></span> ATTRS{queue_type}==<span class="hljs-string"><span class="hljs-string">"none"</span></span> ATTRS{max_sectors}==<span class="hljs-string"><span class="hljs-string">"240"</span></span> looking at parent device <span class="hljs-string"><span class="hljs-string">'/devices/pci0000:00/0000:00:02.1/usb1/1-1/1-1:1.0/host14/target14:0:0'</span></span>: KERNELS==<span class="hljs-string"><span class="hljs-string">"target14:0:0"</span></span> SUBSYSTEMS==<span class="hljs-string"><span class="hljs-string">"scsi"</span></span> DRIVERS==<span class="hljs-string"><span class="hljs-string">""</span></span> looking at parent device <span class="hljs-string"><span class="hljs-string">'/devices/pci0000:00/0000:00:02.1/usb1/1-1/1-1:1.0/host14'</span></span>: KERNELS==<span class="hljs-string"><span class="hljs-string">"host14"</span></span> SUBSYSTEMS==<span class="hljs-string"><span class="hljs-string">"scsi"</span></span> DRIVERS==<span class="hljs-string"><span class="hljs-string">""</span></span> looking at parent device <span class="hljs-string"><span class="hljs-string">'/devices/pci0000:00/0000:00:02.1/usb1/1-1/1-1:1.0'</span></span>: KERNELS==<span class="hljs-string"><span class="hljs-string">"1-1:1.0"</span></span> SUBSYSTEMS==<span class="hljs-string"><span class="hljs-string">"usb"</span></span> DRIVERS==<span class="hljs-string"><span class="hljs-string">"usb-storage"</span></span> ATTRS{bInterfaceNumber}==<span class="hljs-string"><span class="hljs-string">"00"</span></span> ATTRS{bAlternateSetting}==<span class="hljs-string"><span class="hljs-string">" 0"</span></span> ATTRS{bNumEndpoints}==<span class="hljs-string"><span class="hljs-string">"02"</span></span> ATTRS{bInterfaceClass}==<span class="hljs-string"><span class="hljs-string">"08"</span></span> ATTRS{bInterfaceSubClass}==<span class="hljs-string"><span class="hljs-string">"06"</span></span> ATTRS{bInterfaceProtocol}==<span class="hljs-string"><span class="hljs-string">"50"</span></span> ATTRS{supports_autosuspend}==<span class="hljs-string"><span class="hljs-string">"1"</span></span> ATTRS{interface}==<span class="hljs-string"><span class="hljs-string">"Bulk-In, Bulk-Out, Interface"</span></span> looking at parent device <span class="hljs-string"><span class="hljs-string">'/devices/pci0000:00/0000:00:02.1/usb1/1-1'</span></span>: KERNELS==<span class="hljs-string"><span class="hljs-string">"1-1"</span></span> SUBSYSTEMS==<span class="hljs-string"><span class="hljs-string">"usb"</span></span> DRIVERS==<span class="hljs-string"><span class="hljs-string">"usb"</span></span> ATTRS{configuration}==<span class="hljs-string"><span class="hljs-string">"CARD READER"</span></span> ATTRS{bNumInterfaces}==<span class="hljs-string"><span class="hljs-string">" 1"</span></span> ATTRS{bConfigurationValue}==<span class="hljs-string"><span class="hljs-string">"1"</span></span> ATTRS{bmAttributes}==<span class="hljs-string"><span class="hljs-string">"80"</span></span> ATTRS{bMaxPower}==<span class="hljs-string"><span class="hljs-string">"500mA"</span></span> ATTRS{urbnum}==<span class="hljs-string"><span class="hljs-string">"10885"</span></span> ATTRS{idVendor}==<span class="hljs-string"><span class="hljs-string">"0bda"</span></span> ATTRS{idProduct}==<span class="hljs-string"><span class="hljs-string">"0151"</span></span> ATTRS{bcdDevice}==<span class="hljs-string"><span class="hljs-string">"5195"</span></span> ATTRS{bDeviceClass}==<span class="hljs-string"><span class="hljs-string">"00"</span></span> ATTRS{bDeviceSubClass}==<span class="hljs-string"><span class="hljs-string">"00"</span></span> ATTRS{bDeviceProtocol}==<span class="hljs-string"><span class="hljs-string">"00"</span></span> ATTRS{bNumConfigurations}==<span class="hljs-string"><span class="hljs-string">"1"</span></span> ATTRS{bMaxPacketSize0}==<span class="hljs-string"><span class="hljs-string">"64"</span></span> ATTRS{speed}==<span class="hljs-string"><span class="hljs-string">"480"</span></span> ATTRS{busnum}==<span class="hljs-string"><span class="hljs-string">"1"</span></span> ATTRS{devnum}==<span class="hljs-string"><span class="hljs-string">"15"</span></span> ATTRS{devpath}==<span class="hljs-string"><span class="hljs-string">"1"</span></span> ATTRS{version}==<span class="hljs-string"><span class="hljs-string">" 2.00"</span></span> ATTRS{maxchild}==<span class="hljs-string"><span class="hljs-string">"0"</span></span> ATTRS{quirks}==<span class="hljs-string"><span class="hljs-string">"0x0"</span></span> ATTRS{avoid_reset_quirk}==<span class="hljs-string"><span class="hljs-string">"0"</span></span> ATTRS{authorized}==<span class="hljs-string"><span class="hljs-string">"1"</span></span> ATTRS{manufacturer}==<span class="hljs-string"><span class="hljs-string">"Generic"</span></span> ATTRS{product}==<span class="hljs-string"><span class="hljs-string">"USB2.0-CRW"</span></span> ATTRS{serial}==<span class="hljs-string"><span class="hljs-string">"20060413092100000"</span></span> looking at parent device <span class="hljs-string"><span class="hljs-string">'/devices/pci0000:00/0000:00:02.1/usb1'</span></span>: KERNELS==<span class="hljs-string"><span class="hljs-string">"usb1"</span></span> SUBSYSTEMS==<span class="hljs-string"><span class="hljs-string">"usb"</span></span> DRIVERS==<span class="hljs-string"><span class="hljs-string">"usb"</span></span> ATTRS{configuration}==<span class="hljs-string"><span class="hljs-string">""</span></span> ATTRS{bNumInterfaces}==<span class="hljs-string"><span class="hljs-string">" 1"</span></span> ATTRS{bConfigurationValue}==<span class="hljs-string"><span class="hljs-string">"1"</span></span> ATTRS{bmAttributes}==<span class="hljs-string"><span class="hljs-string">"e0"</span></span> ATTRS{bMaxPower}==<span class="hljs-string"><span class="hljs-string">" 0mA"</span></span> ATTRS{urbnum}==<span class="hljs-string"><span class="hljs-string">"222"</span></span> ATTRS{idVendor}==<span class="hljs-string"><span class="hljs-string">"1d6b"</span></span> ATTRS{idProduct}==<span class="hljs-string"><span class="hljs-string">"0002"</span></span> ATTRS{bcdDevice}==<span class="hljs-string"><span class="hljs-string">"0301"</span></span> ATTRS{bDeviceClass}==<span class="hljs-string"><span class="hljs-string">"09"</span></span> ATTRS{bDeviceSubClass}==<span class="hljs-string"><span class="hljs-string">"00"</span></span> ATTRS{bDeviceProtocol}==<span class="hljs-string"><span class="hljs-string">"00"</span></span> ATTRS{bNumConfigurations}==<span class="hljs-string"><span class="hljs-string">"1"</span></span> ATTRS{bMaxPacketSize0}==<span class="hljs-string"><span class="hljs-string">"64"</span></span> ATTRS{speed}==<span class="hljs-string"><span class="hljs-string">"480"</span></span> ATTRS{busnum}==<span class="hljs-string"><span class="hljs-string">"1"</span></span> ATTRS{devnum}==<span class="hljs-string"><span class="hljs-string">"1"</span></span> ATTRS{devpath}==<span class="hljs-string"><span class="hljs-string">"0"</span></span> ATTRS{version}==<span class="hljs-string"><span class="hljs-string">" 2.00"</span></span> ATTRS{maxchild}==<span class="hljs-string"><span class="hljs-string">"6"</span></span> ATTRS{quirks}==<span class="hljs-string"><span class="hljs-string">"0x0"</span></span> ATTRS{avoid_reset_quirk}==<span class="hljs-string"><span class="hljs-string">"0"</span></span> ATTRS{authorized}==<span class="hljs-string"><span class="hljs-string">"1"</span></span> ATTRS{manufacturer}==<span class="hljs-string"><span class="hljs-string">"Linux 3.1.10-1.16-desktop ehci_hcd"</span></span> ATTRS{product}==<span class="hljs-string"><span class="hljs-string">"EHCI Host Controller"</span></span> ATTRS{serial}==<span class="hljs-string"><span class="hljs-string">"0000:00:02.1"</span></span> ATTRS{authorized_default}==<span class="hljs-string"><span class="hljs-string">"1"</span></span> looking at parent device <span class="hljs-string"><span class="hljs-string">'/devices/pci0000:00/0000:00:02.1'</span></span>: KERNELS==<span class="hljs-string"><span class="hljs-string">"0000:00:02.1"</span></span> SUBSYSTEMS==<span class="hljs-string"><span class="hljs-string">"pci"</span></span> DRIVERS==<span class="hljs-string"><span class="hljs-string">"ehci_hcd"</span></span> ATTRS{vendor}==<span class="hljs-string"><span class="hljs-string">"0x10de"</span></span> ATTRS{device}==<span class="hljs-string"><span class="hljs-string">"0x077c"</span></span> ATTRS{subsystem_vendor}==<span class="hljs-string"><span class="hljs-string">"0x1043"</span></span> ATTRS{subsystem_device}==<span class="hljs-string"><span class="hljs-string">"0x82e7"</span></span> ATTRS{class}==<span class="hljs-string"><span class="hljs-string">"0x0c0320"</span></span> ATTRS{irq}==<span class="hljs-string"><span class="hljs-string">"22"</span></span> ATTRS{local_cpus}==<span class="hljs-string"><span class="hljs-string">"00000000,00000000,00000000,0000000f"</span></span> ATTRS{local_cpulist}==<span class="hljs-string"><span class="hljs-string">"0-3"</span></span> ATTRS{numa_node}==<span class="hljs-string"><span class="hljs-string">"0"</span></span> ATTRS{dma_mask_bits}==<span class="hljs-string"><span class="hljs-string">"32"</span></span> ATTRS{consistent_dma_mask_bits}==<span class="hljs-string"><span class="hljs-string">"32"</span></span> ATTRS{<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>}==<span class="hljs-string"><span class="hljs-string">"1"</span></span> ATTRS{broken_parity_status}==<span class="hljs-string"><span class="hljs-string">"0"</span></span> ATTRS{msi_bus}==<span class="hljs-string"><span class="hljs-string">""</span></span> ATTRS{companion}==<span class="hljs-string"><span class="hljs-string">""</span></span> ATTRS{uframe_periodic_max}==<span class="hljs-string"><span class="hljs-string">"100"</span></span> looking at parent device <span class="hljs-string"><span class="hljs-string">'/devices/pci0000:00'</span></span>: KERNELS==<span class="hljs-string"><span class="hljs-string">"pci0000:00"</span></span> SUBSYSTEMS==<span class="hljs-string"><span class="hljs-string">""</span></span> DRIVERS==<span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre> </div></div><br>  As written in a note, you can use the properties of the device itself and the properties of one of the parent devices to write the rules. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We will write the rules for connecting the first section of the memory card (in order to immediately cut off the cards without partitions, although I did not try to do such, and the camera writes exclusively in the first section).  The volume sdh1 itself has few unique properties.  Here, except that the device name KERNEL == "sdh1" and the subsystem of this device SUBSYSTEM == "block".  But such properties will have any flash drive.  And, as I said earlier, it‚Äôs not a fact that the next time the system calls our volume sdh1, and suddenly I‚Äôll buy myself another camera with xD-Picture or CompactFlash in general (which would be sdf, sdg, sdi) - I wouldn‚Äôt like to for this rewrite the rules.  Luckily, udev supports jokers and therefore in this part for the rule we take the expression KERNEL == "sd? 1" (or even "sd *"), which will mean the first volume of the mapped drive, and under what specific letter it will be - we don‚Äôt important, the script will still get the name completely without the joker. <br><br>  Let's go to the next device.  /devices/pci0000:00/0000:00:02.1/usb1/1-1/1-1:1.0/host14/target14 Sample track / 14 , only ATTRS {events} == "media_change", but again this attribute will be on any flash drive. <br><br>  The following device /devices/pci0000:00/0000:00:02.1/usb1/1-1/1-1:1.0/host14/target14 Sampling track / 14 and the track is more specific variant of ATTRS { model} == "SD / MMC", but tied to this attribute, we will only respond to SD-cards and ignore other possible options of memory cards.  In the next three devices, we again find nothing interesting.  The following device /devices/pci0000:00/0000:00:02.1/usb1/1-1 is more interesting: <br><pre> <code class="bash hljs">SUBSYSTEMS==<span class="hljs-string"><span class="hljs-string">"usb"</span></span> DRIVERS==<span class="hljs-string"><span class="hljs-string">"usb"</span></span> ATTRS{configuration}==<span class="hljs-string"><span class="hljs-string">"CARD READER"</span></span> ATTRS{idVendor}==<span class="hljs-string"><span class="hljs-string">"0bda"</span></span> ATTRS{idProduct}==<span class="hljs-string"><span class="hljs-string">"0151"</span></span> ATTRS{product}==<span class="hljs-string"><span class="hljs-string">"USB2.0-CRW"</span></span> ATTRS{serial}==<span class="hljs-string"><span class="hljs-string">"20060413092100000"</span></span></code> </pre> <br>  Judging by the attributes, this is the card reader itself and that‚Äôs what we need (the remaining devices already have a USB connection).  Total in the rules of correspondence, we will rely on the attributes of the card reader and the first volume of the memory card: <br><pre> <code class="bash hljs">ACTION==<span class="hljs-string"><span class="hljs-string">"add"</span></span>, KERNEL==<span class="hljs-string"><span class="hljs-string">"sd?1"</span></span>, SUBSYSTEMS==<span class="hljs-string"><span class="hljs-string">"usb"</span></span>, ATTRS{configuration}==<span class="hljs-string"><span class="hljs-string">"CARD READER"</span></span>, ATTRS{idVendor}==<span class="hljs-string"><span class="hljs-string">"0bda"</span></span>, ATTRS{idProduct}==<span class="hljs-string"><span class="hljs-string">"0151"</span></span></code> </pre> <br>  And they inserted another event (ACTION == "add") of adding the device, since  copying after the card is removed from the reader is impossible purely physically.  <sup>I thought here: there is still the attribute ATTR {ro} == "0" - it can also be added to the rules, otherwise, if the disk is write-protected, then nothing can be moved (but it can be copied, although it can be slightly scattered extra directories depending on the file type names of the camera), but I will not do this for myself.</sup> <br><br>  As you probably already noticed, the ATTR / KERNEL / SUBSYSTEM / DRIVER keys are used for the device itself, and the ATTRS / KERNELS / SUBSYSTEMS / DRIVERS keys are already used for its parents with the letter S on the end. <br><br>  I have another reader for microSD cards, so in its configuration there is an empty line and you can only be attached via idVendor and idProduct.  In one of the previous versions of the udev rules file (I started writing the script somewhere in the middle of August and did not update the system until October, and somewhere in that period this attribute was added, and indeed many attributes for this reader changed ) the vendor and device attributes were used, which (having changed slightly since they disappeared) I left, although there is no special need for them now.  In this version of the filter, it will act only for this model of the card reader and connecting some other model will not cause any effect. <br><br>  We defined the filters, and actions have not yet been assigned.  Since  we need to execute a specific script, then we add an action to the filter: <br><pre> <code class="bash hljs">RUN+=<span class="hljs-string"><span class="hljs-string">"/root/bin/PhotoSort.sh %k"</span></span></code> </pre> <br>  % k in the script parameters - volume name generated by the system (what is displayed in the KERNEL key of the disk is sdh1);  /root/bin/PhotoSort.sh is the name of our future script. <br><br>  The final udev rule file looks like this: <br><pre> <code class="bash hljs">&gt;cat /etc/udev/rules.d/99-lumix.rules <span class="hljs-comment"><span class="hljs-comment">#      ACTION=="add", KERNEL=="sd?1", SUBSYSTEMS=="usb", ATTRS{configuration}=="CARD READER", ATTRS{idVendor}=="0bda", ATTRS{idProduct}=="0151", RUN+="/root/bin/PhotoSort.sh %k" #      #ACTION=="add", KERNEL=="sd?1", SUBSYSTEMS=="pci", ATTR{events}=="media_change", ATTRS{vendor}=="0x10de", ATTRS{device}=="0x077e", RUN+="/root/bin/PhotoSort.sh %k"</span></span></code> </pre> <br>  Now we save this text in the /etc/udev/rules.d/ directory (we need root rights) under an arbitrary name (I have 99-lumix.rules).  The udev daemon processes files from this directory in alphabetical order until it finds a filter that matches the conditions.  After finding the appropriate rule, no further file processing is performed.  Therefore, the number for our rule can be set small ‚Äî it will be processed earlier and will not be covered with any other rule. <br><br>  If you want to keep track of all the connected flash drives and cards, then you can rely on the level below after the reader itself and cling to SUBSYSTEMS == "usb", DRIVERS == "usb-storage" - they definitely should be on the cards and flash drives.  But for the time being I am only watching the reader - there was no need for the rest. <br><br><h5>  bash </h5>  And now we write a script to sort photos from the connected card.  The original version supported the sorting of the entire disk only.  In the course of operation, I also wanted to process the already existing catalogs (unsorted sorts), therefore I had to change and add a little.  Here we will consider the second version, which can sort media files (media file extensions are specified in the script itself in the parameters of the find command) from the disk and from the directory. <br><br>  First, briefly about the algorithm of the script.  Determine what we will handle - a volume or directory.  If the volume is, then it should be mounted at the beginning (and if the mount point is already occupied, and it is used only by this script, then the script will complete its work), and at the end do not forget to unmount it.  After mounting, the presence of a hidden .PhotoSort file is checked in which the settings for this card are stored.  His absence serves as a signal that some ordinary card has been inserted and nothing needs to be done with it.  In this file, you can specify the name of the disk (required only for logging - explained at the end) and the directory for saving files if the standard does not fit (I thought to make a separate storage for the mobile phone).  The export directory can also be specified by the second parameter to the script in the command line or in the udev rules file. <br><br>  Then all the media files from the specified and nested directories (because cameras save photos in different directories that we don‚Äôt know in advance) need to be sorted by the time they were created.  Here lies the catch: in Linux there is no such thing as a file creation time, but there is only the time of the last access to the file and it is updated when manipulating pictures, so you cannot rely on it.  The file name also cannot be: DSC08655.JPG made on 02.05 should go after MOV08554.MPG from 29.04, which in turn should be processed after P1170007.JPG from 19.04.  This problem is especially acute if we have several cameras from different manufacturers who took pictures of the same event (aka "party").  EXIF comes to the rescue - among other things, it has the attribute DateTimeOriginal and CreateDate (there is some difference between them: at least the first one has no video files and if it is not read for some reason, the second one will be read) and these attributes in ordinary situations do not change.  But I don‚Äôt know how to count files from all subdirectories starting from a given one, sorted by these attributes, so all files are renamed in a loop (exiftool can do this, but I left a loop for the log), adding the time for creating a snapshot or video to the name (so that it can be sorted in chronological order by file name). <br><br>  The second cycle distributes files to directories: a new directory is created when the break between the current file and the previous one becomes more than five hours (5 * 60 * 60) - it is for this that we sorted the files in chronological order.  Five hours - a figure from the ceiling.  I have not yet had pictures from one event so that the break between frames was more than that time.  There were tours, with long journeys between POIs, but the road took less than five hours, and if more, then it was a different city.  There were weddings and holidays passing into another day, and even though the date changed, but the event remained the same.  So, while the break is small, we save it in the same directory as the previous file.  The catalog name is set as YYYYMMDD_HH - the clock (taken from the first file of the new event) is added to the catalog name because of two events of the same day, otherwise, when going to the second day, we get the same catalog name, and at least its creation will fail, but later saves files will be carried to the same directory. <br><br>  Everything that happens is written to the log (this is how I checked the functioning of the script), as well as commands to return the files back to disk (it was useful for debugging - I performed a piece of the file and the test media files were returned back to the card with their old names).  Additional processing (rotation, reduction, signing) - I don‚Äôt use it, anyway then I‚Äôll watch, delete and do it all (and I don‚Äôt put a signature on the photos).  The place where this can be done is indicated by a comment in the text of the script. <br><div class="spoiler">  <b class="spoiler_title">The script itself:</b> <div class="spoiler_text"><pre> <code class="bash hljs">&gt;cat /root/bin/PhotoSort.sh <span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #/root/bin/PhotoSort.sh #requires: bash,coreutils,findutils,exiftool,sed,util-linux #cat /etc/udev/rules/99-lumix.rules ##      #ACTION=="add", KERNEL=="sd?1", SUBSYSTEMS=="usb", ATTRS{configuration}=="CARD READER", ATTRS{idVendor}=="0bda", ATTRS{idProduct}=="0151", RUN+="/root/bin/PhotoSort.sh %k" ##      ##ACTION=="add", KERNEL=="sd?1", SUBSYSTEMS=="pci", ATTR{events}=="media_change", ATTRS{vendor}=="0x10de", ATTRS{device}=="0x077e", RUN+="/root/bin/PhotoSort.sh %k" #      udev #udevadm info -a -p $(udeadm info -q path -n /dev/sd*)  udevadm info -a -n /dev/sd* #http://www.arccomm.ru/OpenSource/Dev/udev.html if [[ -z "$1" ]] then echo             , echo      echo $(basename "$0") Source [DestDir] echo Source -    ,    echo DestDir -  ,     echo   ,    echo   ,      .PhotoCopy echo             echo    -   \( \) echo : echo $(basename "$0") sdd1 -    /dev/sdd1. echo         sdd1     .PhotoCopy echo        echo $(basename "$0") . ~/Photo -     \(.\)       echo    ~/Photo/  exit 1 #    fi if [[ ${1:0:1} == "/" || ${1:0:1} == "." || ${1:0:1} == "~" ]] then #   if [[ -d "$1" ]] then disk="$1" else echo    exit 2 #     fi else #   #   dev="/dev/$1" if [[ ! -e "$dev" ]] then #   ,     (      ,   ) exit 0 fi #    disk="/mnt/photo" fi #    if [[ ! -z "$2" ]] then #     photo="$2" else photo="/mnt/temp/Photo" #  ,  fi sphoto="" #    #         photodir="" # -:         -  log="/var/log/photosort.log" #      lastfiletime=0 #     curfiletime=0 #   -  #export XAUTHORITY="/home/%username%/.Xauthority" #export DISPLAY=:0.0 #notify-send Photoes "FlashCard found" #     - ?  - ,         if [[ -n "$dev" ]] then grep -q "$disk" /etc/mtab if [[ $? -eq 0 ]] #     , grep  0 then #  -   echo "#=- $(date -u +%Y.%m.%d\ %T)    -=#" exit 10 #   ,    -   fi #  if [[ ! -d "$disk" ]] then #     - mkdir "$disk" &amp;&gt;&gt;"$log" echo "#"    "$disk" &gt;&gt; "$log" fi mount -t vfat -o noatime,rw,noexec,users,iocharset=utf8 "$dev" "$disk" &amp;&gt;&gt; "$log" if [[ ! -e "$disk"/.PhotoCopy ]] then #       ,    umount "$disk" &amp;&gt;&gt; "$log" exit 0 #   ,       ,       fi # :      $2,         #  -   ( /dev)    (  root) sphoto=$(head -n1 "$disk"/.PhotoCopy) #           ,        if [[ ${sphoto:0:1} == "/" &amp;&amp; -d "$sphoto" ]] then #    ,    ,   photo="$sphoto" fi sphoto=$(tail -n1 "$disk"/.PhotoCopy) #        echo $(date -u +%Y.%m.%d\ %T)    "$sphoto" &gt;&gt; "$log" else if [[ ! -z "$2" ]] then photo="$2" #    fi log="./PhotoSort.log" #      echo "#" $(date -u +%Y.%m.%d\ %T)    "$photo" &gt;&gt; "$log" echo cd $(pwd) &gt;&gt; "$log" #     ,            fi #       # NB!:     - ,     #   ,       , #    (     ) #    (     -  ) for file in $(find "$disk" -type f \( -name '*.JPG' -o -name '*.MOV' -o -name '*.MPG' -o -name '*.THM' -o -name '*.MP4' -o -name '*.AVI' \) -and -not -name '*_*' -and -not -name '* *') do # exiftool   : # Date/Time Original : 2011:07:30 15:35:52 #     20110730153552 curfiletime=$(exiftool -DateTimeOriginal "$file" | cut -d: -f2- | sed 's/[:\ ]//g') #    if [[ $curfiletime == "" ]] then curfiletime=$(exiftool -CreateDate "$file" | cut -d: -f2- | sed 's/[:\ ]//g') #    fi mv "$file" $(dirname "$file")/"$curfiletime"_$(basename "$file") &amp;&gt;&gt; "$log" #  echo mv $(dirname "$file")/"$curfiletime"_$(basename "$file") "$file" &gt;&gt; "$log" #     done #      # (      ,       -  -     ,  ,  ) for file in $(find "$disk" -type f -name '*.JPG' -o -name '*.MOV' -o -name '*.MPG' -o -name '*.THM' -o -name '*.MP4' -o -name '*.AVI' | sort) do # exiftool  ,               ,     curfiletime=$(exiftool -DateTimeOriginal "$file" | sed -r 's/^.+: ([0-9]+):([0-9]+):([0-9]+) ([0-9]+):([0-9]+):([0-9]+)/\1-\2-\3 \4:\5:\6/g') if [[ $curfiletime == "" ]] then curfiletime=$(exiftool -CreateDate "$file" | sed -r 's/^.+: ([0-9]+):([0-9]+):([0-9]+) ([0-9]+):([0-9]+):([0-9]+)/\1-\2-\3 \4:\5:\6/g') fi curfiletime=$(date -d "$curfiletime" +%s) #       if (( $curfiletime - $lastfiletime &gt; 5*60*60 )) #        : 5*60*60 ,           then photodir=$(date -d @$curfiletime +%Y.%m.%d_%H) #       if [[ ! -d "$photo"/"$photodir" ]] #    - then mkdir "$photo"/"$photodir" &amp;&gt;&gt; "$log" chown nobody:users "$photo"/"$photodir" &amp;&gt;&gt; "$log" chmod 0777 "$photo"/"$photodir" &amp;&gt;&gt; "$log" echo "#" $(date -u +%Y.%m.%d\ %T)    "$photodir" &gt;&gt; "$log" fi lastfiletime="$curfiletime" fi echo "#" $(date -u +%Y.%m.%d\ %T)   "$file"  "$photo"/"$photodir"/$(basename "$file") &gt;&gt; "$log" echo copy "$photo"/"$photodir"/$(basename "$file") "$file" &gt;&gt; "$log" #        -  (/ , gps   ) mv "$file" "$photo"/"$photodir"/ &amp;&gt;&gt; "$log" chown nobody:users "$photo"/"$photodir"/$(basename "$file") &amp;&gt;&gt; "$log" chmod 0666 "$photo"/"$photodir"/$(basename "$file") &amp;&gt;&gt; "$log" done if [[ -n "$dev" ]] then echo $(date -u +%Y.%m.%d\ %T)   &gt;&gt; "$log" #    umount "$disk" &amp;&gt;&gt; "$log" fi exit 0</span></span></code> </pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Explanation of some points: exiftool returns strings like "Date / Time Original: 2011: 07: 30 15:35:52" this line needs to be converted to "20110730153552" (note: the Internet is full of examples where the separator is not a colon, but a vertical trait - see what you have): </font></font><br><br><pre> <code class="bash hljs">curfiletime=$(exiftool -DateTimeOriginal <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">"</span></span> | cut -d: -f2- | sed <span class="hljs-string"><span class="hljs-string">'s/[:\ ]//g'</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cut will cut everything after the first colon, and sed will remove all spaces and colons from the resulting string. </font><font style="vertical-align: inherit;">I am sure that you can do only sed'om, but with RegExpami not very friendly.</font></font><br><br><pre> <code class="bash hljs">curfiletime=$(exiftool -DateTimeOriginal <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string">"</span></span> | sed -r <span class="hljs-string"><span class="hljs-string">'s/^.+: ([0-9]+):([0-9]+):([0-9]+) ([0-9]+):([0-9]+):([0-9]+)/\1-\2-\3 \4:\5:\6/g'</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The same line converts to "2011-07-30 15:35:52". </font><font style="vertical-align: inherit;">Again, perhaps there is a more elegant solution. </font><font style="vertical-align: inherit;">This is so that the date could be treated as a date (in any format, the string cannot be dropped into it).</font></font><br><br><h5>  Using </h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The script processes the specified directory and all attached to it (for a memory card, this will be its root and everything deeper) as one. </font></font><br><br><pre> <code class="bash hljs">./PhotoSort.sh sdh1</code> </pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">so the script is called from udev to sort the sdh1 disk. In this case, the presence of a file with settings in its root will be checked. The disk was transferred to us or the directory is determined by the first character: if it will be ~ / or. - means a directory, otherwise - a disk.</font></font><br><br><pre> <code class="bash hljs">./PhotoSort.sh ~/AllFromParty</code> </pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as well, you can sort all the photo and video files from all the directories nested in ~ / AllFromParty (including himself). </font><font style="vertical-align: inherit;">Everything will be saved to the default directory specified in the script (photo = "/ mnt / temp / Photo"). </font><font style="vertical-align: inherit;">If there were files from several cameras in the source directory, then there may be some dissynchronization in the file names due to the fact that the time between the cameras was not synchronized, or even never exhibited. </font><font style="vertical-align: inherit;">What can cause the distribution of files from different cameras in different directories. </font><font style="vertical-align: inherit;">Then, before performing the sorting, you need to adjust the time in the EXIF ‚Äã‚Äãtags: exiftool "-DateTimeOriginal + = 00.00.0000 02:37:30" * .JPG - will shift the time in the DateTimeoriginal tag by 2:37:30 to the future for all JPG files from the current directory.</font></font><br><br><pre> <code class="bash hljs">./PhotoSort.sh ~/AllFromParty /media/backup/Photoes</code> </pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the same as above, but everything will be saved in the / media / backup / Photoes directory </font></font><br><br><h5>   </h5><ol><li>     <br>   :   , KDE   ,   ,          .  ,   ,     (     ). </li><li>        ,    .    ini-. </li><li>      .    .        RUN+=  ,         -  .      udev' ,  KDE ,      ‚Äî   .     ,      . </li><li>    .PhotoSort         udev'   .       ,  root   -    .    - .     (,  )          . </li><li>    , dosfslabel    .  udev -     .  -          . </li><li>    :            .          Caanoo ‚Äî     .PhotoSort  . </li><li>          - ,      RO   . </li><li>  .   ,      - ,          ? </li></ol><br><h5>  References </h5><h5> <a href="http://www.opennet.ru/docs/RUS/bash_scripting_guide/">  Bash-</a> <br> <a href="http://ru.gentoo-wiki.com/wiki/HOWTO_Udev_%25D0%25B8_%25D0%25B0%25D0%25B2%25D1%2582%25D0%25BE%25D0%25BC%25D0%25BE%25D0%25BD%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25BD%25D0%25BE%25D1%2581%25D0%25B8%25D1%2582%25D0%25B5%25D0%25BB%25D0%25B5%25D0%25B9">HOWTO: udev   </a> <br> <a href="http://rus-linux.net/lib.php%3Fname%3DMyLDP/sys-conf/udev.html">udev.    </a> ( <a href="http://www.arccomm.ru/OpenSource/Dev/udev.html">   </a> ) </h5></div><p>Source: <a href="https://habr.com/ru/post/158371/">https://habr.com/ru/post/158371/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../158353/index.html">The very first guide to FORTRAN</a></li>
<li><a href="../158355/index.html">ZigBee specification. Security</a></li>
<li><a href="../158357/index.html">How to connect the online store to the payment system? The history of one company</a></li>
<li><a href="../158359/index.html">Will the merged letter die?</a></li>
<li><a href="../158363/index.html">New Chromebook for $ 199 - Acer C7</a></li>
<li><a href="../158375/index.html">Roskomnadzor registry. More questions than answers</a></li>
<li><a href="../158377/index.html">Switch to Percona XtraDB Cluster. One possible configuration</a></li>
<li><a href="../158379/index.html">Key people on the #AndroidDev tag</a></li>
<li><a href="../158381/index.html">Interview with CYBERMANIAC</a></li>
<li><a href="../158383/index.html">How ninja prototypes did. Ninjamock.com - interface designer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>