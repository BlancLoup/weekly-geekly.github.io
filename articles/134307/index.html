<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SFTP support in midnight commander</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is a translation of a note about my testing of SFTP support in the midnight commander. The original in English is published on my blog . 

 I con...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SFTP support in midnight commander</h1><div class="post__text post__text-html js-mediator-article">  This is a translation of a note about my testing of SFTP support in the midnight commander.  The original in English is published on my <a href="http://blog.tataranovich.com/2011/12/sftp-suppot-in-midnight-commander.html">blog</a> . <br><br>  I continue to follow the development of SFTP support in the midnight commander, this week I talked to the author - authorization via ssh-agent appeared in sftp support.  To celebrate, I quickly threw the package and tested it. <a name="habracut"></a><br><br>  And the first disappointment is that midnight cannot log in through an agent.  I tried the previous authorization schemes that worked in the previous version: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  password - works without problems; </li><li>  by key it works, but only for keys that are not protected by a password (apparently this is a library restriction). </li></ul><br>  Having tried different options with the agent - asked the author how he works.  It turned out that no problem.  Later I found <a href="http://www.libssh2.org/examples/ssh2_agent.html">an example of authorization via ssh-agent</a> on the libssh2 developer site and tried to compile it. <br><br><pre><code class="hljs pgsql">$ gcc -o agent_auth -Wall -I/usr/<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> -I. -lssh2 ssh2_agent.c ssh2_agent.c: <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-string"><span class="hljs-string">'main'</span></span>: ssh2_agent.c:<span class="hljs-number"><span class="hljs-number">99</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">warning</span></span>: implicit declaration <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-string"><span class="hljs-string">'libssh2_session_handshake'</span></span> /home/andrey/tmp/ccmczn2V.o: <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> `main<span class="hljs-string"><span class="hljs-string">': ssh2_agent.c:(.text+0x1a8): undefined reference to `libssh2_session_handshake'</span></span> collect2: ld returned <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> status</code> </pre> <br>  The error message suggested that the example was designed for a version that is newer than the one in the debian squeeze repository.  I tried to compile the current version of libssh2 (1.3.0) and reassemble an example with a new library already. <br><br><pre> <code class="hljs ruby">$ gcc -o agent_auth -Wall -I$PWD/libssh2/<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> -I. -L$PWD/libssh2/lib -lssh2 ssh2_agent.c</code> </pre><br>  After this, the example was assembled without errors, but refused to work, referring to the impossibility of the connection. <br><br><pre> <code class="hljs pgsql">$ LD_LIBRARY_PATH=$PWD/libssh2/lib ./agent-auth localhost andrey failed <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>! zsh: segmentation fault ./agent_auth localhost andrey</code> </pre><br>  Running under strace showed that, firstly, the connection goes to 255.255.255.255 instead of 127.0.0.1, and secondly, the example code tries to free resources without checking their use.  Hence segfault on exit. <br><br><pre> <code class="hljs pgsql">munmap(<span class="hljs-number"><span class="hljs-number">0xb7813000</span></span>, <span class="hljs-number"><span class="hljs-number">4096</span></span>) = <span class="hljs-number"><span class="hljs-number">0</span></span> socket(PF_INET, SOCK_STREAM, IPPROTO_IP) = <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>, {sa_family=AF_INET, sin_port=htons(<span class="hljs-number"><span class="hljs-number">22</span></span>), sin_addr=inet_addr("255.255.255.255")}, <span class="hljs-number"><span class="hljs-number">16</span></span>) = <span class="hljs-number"><span class="hljs-number">-1</span></span> ENETUNREACH (Network <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> unreachable) <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>, "failed to connect!\n", <span class="hljs-number"><span class="hljs-number">19</span></span>failed <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>! ) = <span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-comment"><span class="hljs-comment">--- SIGSEGV (Segmentation fault) @ 0 (0) --- +++ killed by SIGSEGV +++ zsh: segmentation fault strace -f ./agent_auth localhost username</span></span></code> </pre><br>  Added check before freeing resources <br><br><pre> <code class="hljs cs">--- ssh2_agent.c.orig <span class="hljs-number"><span class="hljs-number">2011</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span><span class="hljs-number"><span class="hljs-number">-08</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>:<span class="hljs-number"><span class="hljs-number">41.000000000</span></span> +<span class="hljs-number"><span class="hljs-number">0300</span></span> +++ ssh2_agent.c <span class="hljs-number"><span class="hljs-number">2011</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span><span class="hljs-number"><span class="hljs-number">-09</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">10.000000000</span></span> +<span class="hljs-number"><span class="hljs-number">0300</span></span> @@ <span class="hljs-number"><span class="hljs-number">-231</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span> +<span class="hljs-number"><span class="hljs-number">231</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span> @@ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *argv[]</span></span></span><span class="hljs-function">) */ shutdown: - - </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">libssh2_agent_disconnect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">agent</span></span></span><span class="hljs-function">)</span></span>; - libssh2_agent_free(agent); + <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (agent) { + libssh2_agent_disconnect(agent); + + libssh2_agent_free(agent); + } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(session) {</code> </pre><br>  Then rebuilt and launched. <br><br><pre> <code class="hljs ruby">$ gcc -o agent_auth -Wall -I$PWD/libssh2/<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> -I. -L$PWD/libssh2/lib -lssh2 ssh2_agent.c $ LD_LIBRARY_PATH=$PWD/libssh2/lib ./agent_auth localhost andrey failed to connect!</code> </pre><br>  Already better - the segfault at the output disappeared, but swears at the inability to connect.  Looking at the code again.  Inet_addr () is used to convert the host to a format understandable connect () function. <br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> (argc &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-attribute"><span class="hljs-attribute">hostaddr</span></span> = inet_addr(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]); } <span class="hljs-section"><span class="hljs-section">else</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">hostaddr</span></span> = htonl(0x7F000001); }</code> </pre><br>  I look in man 3 inet_addr and see that the function converts the symbolic entry of the ip address into its binary representation.  Bingo!  I after all transfer a host name as localhost.  Replacing localhost with 127.0.0.1 I get a working example. <br><br><pre> <code class="hljs sql">$ LD_LIBRARY_PATH=$PWD/libssh2/lib ./agent_auth 127.0.0.1 andrey Fingerprint: FA F3 92 9E C4 AE 14 B4 FC BE ED 2A E8 33 0C 1E 34 09 9F B3 Authentication methods: publickey,password Authentication <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> username andrey <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> /home/andrey/.ssh/id_rsa <span class="hljs-keyword"><span class="hljs-keyword">failed</span></span>! <span class="hljs-keyword"><span class="hljs-keyword">Authentication</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> username andrey <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> /home/andrey/.ssh/id_dsa succeeded! all done!</code> </pre><br>  Now it's up to you to build libssh2 (1.3.0) for squeeze and rebuild midnight with the new version of the library.  The finished assembly can be picked up <a href="http://www.tataranovich.com/public/mc-sftp/2011-12-08/">here.</a> <br></div><p>Source: <a href="https://habr.com/ru/post/134307/">https://habr.com/ru/post/134307/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134300/index.html">Rating Top-50 digital agencies of Russia-2011</a></li>
<li><a href="../134302/index.html">Linking a data model in C ++ with a QML view using a map example</a></li>
<li><a href="../134303/index.html">REST vs SOAP. Part 2. How easier and more efficient to organize communication platforms?</a></li>
<li><a href="../134305/index.html">The dark side of ContentProvider</a></li>
<li><a href="../134306/index.html">How far from the idea of ‚Äã‚Äãthe game to its realization: an interview with the developers of the Yocto Technology Group</a></li>
<li><a href="../134308/index.html">Google+ has introduced face recognition on uploaded photos.</a></li>
<li><a href="../134309/index.html">Another client for the site TechDays.ru</a></li>
<li><a href="../134310/index.html">Canobuvosti, 121st edition</a></li>
<li><a href="../134311/index.html">19 first steps for offline store online</a></li>
<li><a href="../134312/index.html">LocalHero for Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>