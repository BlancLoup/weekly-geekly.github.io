<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What is under the hood of virtual disks? (on the example of VHD and VHDX)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Have you ever worked with virtual machines, created virtual disks? If yes, then you probably noticed such convenient features as dynamic increase in d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What is under the hood of virtual disks? (on the example of VHD and VHDX)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/cd7/79a/082/cd779a082a634957a676ac68bab5a230.png"><br><br>  Have you ever worked with virtual machines, created virtual disks?  If yes, then you probably noticed such convenient features as dynamic increase in disk size (the ability to store only what was recorded) and the ability to create snapshots - snapshots of the disk status.  If you are interested in knowing exactly how this capabilities are achieved and how the data is stored in the VHD and VHDX files - welcome under cat. <br><a name="habracut"></a><br><h2>  Fixed drives </h2><br><img align="right" src="https://habrastorage.org/files/257/304/095/257304095f4a4a1e9d3c1cb4879a2a58.png">  A virtual disk is usually a simple file within which everything that a virtual machine writes to a disk device is stored.  For fixed disks, a full file is immediately allocated, which does not change in size in the future. <br><br>  However, here it is necessary to make a reservation, and recall the possibilities of many file systems to create "compressed" files.  Usually, compression is achieved by not storing file-filled blocks (for example, NTFS, XFS, and VMFS do so).  Even if your file system is free 500GB, you can easily create a fixed 1TB virtual disk and work with it until you run out of space. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Fixed disks can be stored in two ways: <br><ul><li>  <i>Simple image files</i> .  They are RAW, they are flat (* flat.vmdk for example).  Here the name is clear.  Such files (almost) do not contain any specific metadata.  A fixed VHD may contain 512 bytes of its metadata at the end of the file.  Otherwise, it can not be distinguished from a copy of the "real" disk to a file. </li><li>  <i>Degenerate dynamic disks</i> .  Such disks are stored in the same format as dynamic ones, only all the required space is allocated immediately upon creation.  As if the dynamic disk immediately after creation was prescribed from beginning to end.  You will get this file if you create a fixed VHDX. </li></ul><br><br><h2>  Dynamic VHD </h2><br>  File systems write to disk in a chaotic manner.  To ensure a gradual increase in the virtual disk file under such conditions, a translation system is necessary.  One of the easiest ways to translate is a table, which for each logical block will indicate its location within the file or say that such a block has not yet been allocated. <br><br><div style="text-align:center;"><img width="530" src="https://habrastorage.org/files/98d/e80/568/98de805681e54a59bb6b216297a5e1b9.png"></div><br><br>  It is this idea that is in the format of dynamic VHD (and not only).  The logical space of a virtual disk (what the OS inside the virtual machine sees as a disk) is divided into blocks of equal size, for example, 2 megabytes each, which are addressed using BAT - Block Allocation table. <br><br>  When creating snapshots, it may be necessary to give the status ‚Äúempty-allocated‚Äù not a separate block, but a separate sector in the block.  Therefore, each block is supplied with a bitmap, which is written before the block.  With a logical sector size of 512 bytes and a block size of 2 megabytes, the bitmap for the block will occupy exactly 1 sector (512 * 8 = 2,097,152 / 512).  Those.  one generalized block will occupy 4097 sectors. <br><br><div style="text-align:center;"><img width="300" src="https://habrastorage.org/files/4c7/730/fe9/4c7730fe9057483ea90d11886855fe91.png"></div><br><br>  In addition to the BAT and generic blocks, the VHD file also contains the Hard Disk Footer (512B) structure at the very end and a copy at the very beginning.  And Dynamic Disk Header (1024 bytes) at the beginning of the file.  They store various metadata about a virtual disk: its size, format version, time stamps, block size, BAT offset, number of entries in it, and so on. <br><br>  To summarize, the contents of the VHD file looks like this (proportions are conditional): <br><br><div style="text-align:center;"><img width="300" src="https://habrastorage.org/files/1b5/1b3/923/1b51b39239f248d59b6c1974b1655005.png"></div><br><br><h2>  Dynamic VHDX </h2><br>  The format of a dynamic VHDX is a general idea similar to VHD - the logical space is also divided into blocks that are addressed by a special translation table, there are also bitmaps to clarify the status of a particular sector.  But there are many differences in the details. <br><br>  To begin with, in VHDX, the size of one bitmap is fixed - 1 megabyte.  And it already covers several blocks.  For example, with a logical sector size of 512 bytes (VHDX can also ‚Äúgive up‚Äù a sector of 4096 bytes) and a block size of 2 megabytes, one bitmap ‚Äúcovers‚Äù 2,048 blocks.  This value is also called the <b>chunk ratio</b> . <br><br><div style="text-align:center;"><img width="150" src="https://habrastorage.org/files/919/22f/a7c/91922fa7c311434193143b728e870fd3.png"></div><br><br>  The second difference is that the block with bitmap is independently addressed from BAT.  First, there are 2048 cells (chunk ratio) that address the corresponding data blocks, then there is a cell addressing the bitmap block, and so on. <br><br>  The next difference is that the BAT entry now also stores the status of the block.  The data block is: <br><ul><li>  NOT_PRESENT - absent; </li><li>  UNDEFINED - undefined (space is allocated in the file, but there is irrelevant data there); </li><li>  ZERO - filled with zeros (space in the file is not allocated); </li><li>  UNMAPPED - UNMAP command was executed for all sectors of the block; </li><li>  FULLY_PRESENT - the block is fully present: </li><li>  PARTIALLY_PRESENT - the block is partially present. </li></ul><br>  An entry for a bitmap block can have only two statuses: <br><ul><li>  NOT_PRESENT - no bitmap block; </li><li>  PRESENT - a bitmap block is present. </li></ul><br>  Bitmaps and partially present data blocks can only be in differential disks, which appear when creating snapshots (I will tell about them below).  In other cases, there are no bitmaps, and data blocks have other statuses. <br><br>  In general, the structure of a VHDX file looks like this: <br><br><div style="text-align:center;"><img width="550" src="https://habrastorage.org/files/57f/344/52b/57f34452b88444dfb1fc359be56ee24e.png"></div><br><br>  Briefly about the remaining sections: <br><ul><li>  At the very beginning of the disk is the FileIdentifier structure - it contains the signature and comment about the application that created the VHDX file.  This is it opened in the HEX editor in the screenshot at the beginning of the article; </li><li>  Further there are two versions (for protection against failure) of the header.  It shows the offset and size of the log, as well as some other parameters; </li><li>  A log is a cyclic buffer through which all operations on metadata, except Headers, are performed.  This is done, again, to protect against sudden outages; </li><li>  Introduced the concept of regions.  The specification lists only 2 types of regions: BAT and Metadata, but it is assumed that there may be more.  Regions are addressed using the table of regions, which is stored in two copies (and here is the protection from failures); </li><li>  Metadata records are stored in the Metadata region, they are addressed using a metadata table, to which applications can add metadata of their own types.  According to the specification, we have to find records about block size, logical sector size, disk size, and others. </li></ul><br><h2>  Snapshots </h2><br>  <i>Snapshot</i> is a snapshot of the state of a virtual disk at some point in time.  Having such a snapshot, we can roll back all changes made after this point. <br><br>  If we are talking about VHD and VHDX disks, then when creating a snapshot, a new file is created in which all subsequent changes are recorded.  This file is called "delta" or "differential disk" (from the English. Differencing). <br><br>  Earlier we said that the format of dynamic disks allows you to store only recorded data.  The same format is great for storing only modified data.  Yes, delta files have exactly the same format as dynamic disks.  Only the interpretation of free blocks changes.  For a delta, a free block means that you should not just return the zeros, but try to read the block from the previous layer ‚Äî if there is a previous delta, then from it, and if not, then from the basic disk. <br><br><div style="text-align:center;"><img width="500" src="https://habrastorage.org/files/55f/f47/62e/55ff4762e3b949e2ac63e43479822c24.png"></div><br><br>  If we remove the upper delta, we get the previous fixed state, and if both are, then the earliest. <br><br><h2>  A look at the data recovery </h2><br>  In terms of data recovery, virtual disks are bad first of all because additional translation levels are introduced between the file and the disk. <br><br><div style="text-align:center;"><img width="650" src="https://habrastorage.org/files/3e1/147/701/3e1147701b3a4096a4312aae6861545d.png"></div><br><br>  Each level is additional data mixing, which increases fragmentation, and a potential point of failure.  Any BAD sector now has much more possibilities to make a lot of problems. <br><br>  In general, to read the data of a file from a virtual disk, you must have <br><ul><li>  physical disk file system metadata that describes the location of the virtual disk file; </li><li>  metadata of the virtual disk itself (BAT, etc.); </li><li>  file system metadata on the virtual disk describing the location of the file. </li></ul><br>  If you are very lucky, the data recovery task can turn into a puzzle assembly without a sample.  Not that I discouraged using virtual disks, but the easier the data is stored, the easier it will be to restore them. <br><br><h2>  Literature </h2><br><ol><li> <a href="https://technet.microsoft.com/en-us/virtualization/bb676673.aspx">Virtual Hard Disk Image Format Specification</a> </li><li>  <a href="https://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34750">VHDX Format Specification v1.00</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/262517/">https://habr.com/ru/post/262517/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262501/index.html">Android development best practices</a></li>
<li><a href="../262507/index.html">Effective video encoding in Linux with Nvidia NVENC: part 1, general</a></li>
<li><a href="../262509/index.html">Let Docker roam around the cluster on the Raspberry Pi</a></li>
<li><a href="../262511/index.html">Hazardous 0day vulnerabilities discovered in Adobe Flash Player and Oracle Java</a></li>
<li><a href="../262515/index.html">Beginners Ethical Hacking Courses: A New Set</a></li>
<li><a href="../262519/index.html">Another camera for FreeTrack</a></li>
<li><a href="../262521/index.html">Arduino -> FLProg -> RS-485 -> Modbus</a></li>
<li><a href="../262523/index.html">Visual Studio Code - code editor for Linux, OS X and Windows</a></li>
<li><a href="../262525/index.html">How we ensured communication at the summits of the SCO and BRICS</a></li>
<li><a href="../262527/index.html">How to make Jenkins make your life easier and become happy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>