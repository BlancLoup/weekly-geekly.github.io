<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple test libjit vs llvm</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=""And experience, son of difficult mistakes" (c) You know who 

 Since childhood, I was interested in questions like " who wins - an elephant or a whal...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple test libjit vs llvm</h1><div class="post__text post__text-html js-mediator-article">  "And experience, son of difficult mistakes" (c) You know who <br><br>  Since childhood, I was interested in questions like " <i>who wins - an elephant or a whale</i> ."  Or, for example, " <i>who is stronger - a tiger or a lion</i> ."  Now that I‚Äôve grown up, the questions have changed a bit.  Now I'm interested in particular - which is cooler than <b>libjit</b> or <b>llvm</b> . <br><br>  It is clear that a simple way to answer such a question is not products that have ecological niches that do not completely coincide, but you can always write a simple test and see how pleasant it was to write, how fast the result is being fulfilled, and at least make impressions about the products from laudatory articles and, so to speak, personal experience. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  So.  A simple task is the sieve of Eratosthenes, or the search for prime numbers. </h4><br><a name="habracut"></a><br>  I took the implementation for the basics, which is listed in Wikipedia, to which I added a cycle to launch the eratosthene sieve many times.  It turned out like this: <br><br><blockquote> <code><font color="gray">001</font> : <strong>program</strong> erato <strong>;</strong> <br> <font color="gray">002:</font> <br> <font color="gray">003:</font> <strong>procedure</strong> <font color="#990000"><strong>eratosphen</strong></font> (n <strong>:</strong> <font color="#445588"><strong>integer</strong></font> ) <strong>;</strong> <br> <font color="gray">004:</font> <strong>var</strong> <br> <font color="gray">005:</font> a <strong>:</strong> <strong>array</strong> [ <font color="#009999">0</font> <strong>..</strong> <font color="#009999">100000</font> ] <strong>of</strong> <font color="#445588"><strong>byte</strong></font> <strong>;</strong> <br> <font color="gray">006:</font> q <strong>:</strong> <font color="#445588"><strong>integer</strong></font> <strong>;</strong> <br> <font color="gray">007:</font> i <strong>,</strong> j <strong>:</strong> <font color="#445588"><strong>integer</strong></font> <strong>;</strong> <br> <font color="gray">008:</font> <strong>begin</strong> <br> <font color="gray">009:</font> <font color="#999999">FillChar</font> (a <strong>,</strong> <font color="#999999">sizeof</font> (a) <strong>,</strong> <font color="#009999">1</font> ) <strong>;</strong> <br> <font color="gray">010:</font> q <strong>:=</strong> <font color="#999999">round</font> ( <font color="#999999">sqrt</font> (n)) <strong>;</strong> <br> <font color="gray">011:</font> <strong>for</strong> i <strong>:=</strong> <font color="#009999">2</font> <strong>to</strong> q <strong>do</strong> <br> <font color="gray">012:</font> <strong>if</strong> a[i] <strong>=</strong> <font color="#009999">1</font> <strong>then</strong> <br> <font color="gray">013:</font> <strong>begin</strong> <br> <font color="gray">014:</font> j <strong>:=</strong> i <strong>*</strong> i <strong>;</strong> <br> <font color="gray">015:</font> <strong>while</strong> j <strong>&lt;=</strong> n <strong>do</strong> <br> <font color="gray">016:</font> <strong>begin</strong> <br> <font color="gray">017:</font> a[j] <strong>:=</strong> <font color="#009999">0</font> <strong>;</strong> <br> <font color="gray">018:</font> j <strong>:=</strong> j <strong>+</strong> i <strong>;</strong> <br> <font color="gray">019:</font> <strong>end</strong> <strong>;</strong> <br> <font color="gray">020:</font> <strong>end</strong> <strong>;</strong> <br> <font color="gray">021:</font> <strong>end</strong> <strong>;</strong> <br> <font color="gray">022:</font> <br> <font color="gray">023:</font> <strong>var</strong> i <strong>:</strong> <font color="#445588"><strong>integer</strong></font> <strong>;</strong> <br> <font color="gray">024:</font> <strong>begin</strong> <br> <font color="gray">025:</font> <font color="#999999">Writeln</font> ( <font color="#bb8844">'Poexali'</font> ) <strong>;</strong> <br> <font color="gray">026:</font> <strong>for</strong> i <strong>:=</strong> <font color="#009999">1</font> <strong>to</strong> <font color="#009999">5000</font> <strong>do</strong> <br> <font color="gray">027:</font> eratosphen( <font color="#009999">100000</font> ) <strong>;</strong> <br> <font color="gray">028:</font> <strong>end</strong> <strong>.</strong> <br> <font color="gray">029:</font></code> </blockquote> <br><br><h5>  LIBJIT option </h5><br><br>  When using libjit, you get this program: <br><br><blockquote> <code><font><font color="gray">001</font> : <font color="#999999"><strong>#include &lt;stdio.h&gt; <br> <font color="gray">002:</font> #include &lt;jit/jit.h&gt; <br> <font color="gray">003:</font></strong></font> <br> <font color="gray">004:</font> <font color="#445588"><strong>unsigned</strong></font> <font color="#445588"><strong>int</strong></font> <font color="#990000"><strong>myprint</strong></font> ( <font color="#445588"><strong>unsigned</strong></font> <font color="#445588"><strong>int</strong></font> a) { <br> <font color="gray">005:</font> printf( <font color="#bb8844">" %d</font> <font color="#bb8844">\n</font> <font color="#bb8844">"</font> ,a); <br> <font color="gray">006:</font> } <br> <font color="gray">007:</font> <br> <font color="gray">008:</font> jit_function_t main_function, erato; <br> <font color="gray">009:</font> <br> <font color="gray">010:</font> <br> <font color="gray">011:</font> <font color="#445588"><strong>void</strong></font> <font color="#990000"><strong>create_erato</strong></font> () <br> <font color="gray">012:</font> { <br> <font color="gray">013:</font> jit_type_t params[ <font color="#009999">1</font> ]; <br> <font color="gray">014:</font> jit_type_t signature; <br> <font color="gray">015:</font> jit_label_t for_begin <strong>=</strong> jit_label_undefined; <br> <font color="gray">016:</font> jit_label_t end_for <strong>=</strong> jit_label_undefined; <br> <font color="gray">017:</font> jit_label_t end_if <strong>=</strong> jit_label_undefined; <br> <font color="gray">018:</font> jit_label_t while_end <strong>=</strong> jit_label_undefined; <br> <font color="gray">019:</font> jit_label_t while_begin <strong>=</strong> jit_label_undefined; <br> <font color="gray">020:</font> jit_label_t print_end <strong>=</strong> jit_label_undefined; <br> <font color="gray">021:</font> jit_label_t print_begin <strong>=</strong> jit_label_undefined; <br> <font color="gray">022:</font> jit_label_t print_if <strong>=</strong> jit_label_undefined; <br> <font color="gray">023:</font> <font color="#445588"><strong>void</strong></font> <strong>*</strong> args[ <font color="#009999">2</font> ]; <br> <font color="gray">024:</font> jit_uint result; <br> <font color="gray">025:</font> jit_value_t n,a,one1,szero,uint1,two2; <br> <font color="gray">026:</font> jit_int arg1; <br> <font color="gray">027:</font> jit_intrinsic_descr_t tofloat <strong>=</strong> {jit_type_nfloat, <font color="#999999">NULL</font> , jit_type_uint, <font color="#999999">NULL</font> }; <br> <font color="gray">028:</font> jit_intrinsic_descr_t toint <strong>=</strong> {jit_type_uint, <font color="#999999">NULL</font> , jit_type_nfloat, <font color="#999999">NULL</font> }; <br> <font color="gray">029:</font> jit_value_t temp1,temp2,q; <br> <font color="gray">030:</font> jit_value_t i,j,elem; <br> <font color="gray">031:</font> jit_value_t for_cond, if_cond, while_cond, print_cond; <br> <font color="gray">032:</font> jit_value_t tmpi, tmp3,tmp4; <br> <font color="gray">033:</font> <font color="#999988"><em>/* Create a context to hold the JIT's primary state */</em></font> <br> <font color="gray">034:</font> <font color="#999988"><em>/* Build the erato signature */</em></font> <br> <font color="gray">035:</font> params[ <font color="#009999">0</font> ] <strong>=</strong> jit_type_uint; <br> <font color="gray">036:</font> signature <strong>=</strong> jit_type_create_signature (jit_abi_cdecl, jit_type_uint, params, <font color="#009999">1</font> , <font color="#009999">1</font> ); <br> <font color="gray">037:</font> <br> <font color="gray">038:</font> <font color="#999988"><em>/* allocate sieve storage and init it by 1 */</em></font> <br> <font color="gray">039:</font> n <strong>=</strong> jit_value_get_param(erato, <font color="#009999">0</font> ); <br> <font color="gray">040:</font> <br> <font color="gray">041:</font> <font color="#999988"><em>//jit_insn_call_native(erato, "print", myprint, signature, &amp;n ,1,0); <br> <font color="gray">042:</font></em></font> a <strong>=</strong> jit_insn_alloca(erato,n); <br> <font color="gray">043:</font> one1 <strong>=</strong> jit_value_create_nint_constant(erato, jit_type_ubyte, <font color="#009999">1</font> ); <br> <font color="gray">044:</font> szero <strong>=</strong> jit_value_create_nint_constant(erato,jit_type_ubyte, <font color="#009999">0</font> ); <br> <font color="gray">045:</font> jit_insn_memset(erato,a, one1,n); <br> <font color="gray">046:</font> <font color="#999988"><em>/* convert to float, sqrt and convert to int back */</em></font> <br> <font color="gray">047:</font> temp1 <strong>=</strong> jit_insn_call_intrinsic(erato, <font color="#bb8844">"convert_to_float"</font> , jit_uint_to_nfloat, <strong>&amp;</strong> tofloat ,n, <font color="#999999">NULL</font> ); <br> <font color="gray">048:</font> temp2 <strong>=</strong> jit_insn_sqrt(erato, temp1); <br> <font color="gray">049:</font> q <strong>=</strong> jit_insn_call_intrinsic(erato, <font color="#bb8844">"convert_to_int"</font> ,jit_nfloat_to_uint, <strong>&amp;</strong> toint ,temp2, <font color="#999999">NULL</font> ); <br> <font color="gray">050:</font> <br> <font color="gray">051:</font> <font color="#999988"><em>/* for i = 2 to q do*/</em></font> <br> <font color="gray">052:</font> two2 <strong>=</strong> jit_value_create_nint_constant(erato,jit_type_uint, <font color="#009999">2</font> ); <br> <font color="gray">053:</font> i <strong>=</strong> jit_value_create(erato,jit_type_uint); <br> <font color="gray">054:</font> jit_insn_store(erato,i,two2); <br> <font color="gray">055:</font> jit_insn_label(erato, <strong>&amp;</strong> for_begin); <br> <font color="gray">056:</font> for_cond <strong>=</strong> jit_insn_gt(erato, i, q); <br> <font color="gray">057:</font> jit_insn_branch_if(erato,for_cond, <strong>&amp;</strong> end_for); <br> <font color="gray">058:</font> <br> <font color="gray">059:</font> <font color="#999988"><em>// if <br> <font color="gray">060:</font></em></font> elem <strong>=</strong> jit_insn_load_elem(erato, a, i, jit_type_ubyte); <br> <font color="gray">061:</font> if_cond <strong>=</strong> jit_insn_eq(erato, elem, one1); <br> <font color="gray">062:</font> jit_insn_branch_if_not(erato,if_cond, <strong>&amp;</strong> end_if); <br> <font color="gray">063:</font> <br> <font color="gray">064:</font> <font color="#999988"><em>// j = i*i <br> <font color="gray">065:</font></em></font> j <strong>=</strong> jit_value_create(erato, jit_type_uint); <br> <font color="gray">066:</font> tmp3 <strong>=</strong> jit_insn_mul(erato, i, i); <br> <font color="gray">067:</font> jit_insn_store(erato,j, tmp3); <br> <font color="gray">068:</font> <br> <font color="gray">069:</font> <font color="#999988"><em>// while <br> <font color="gray">070:</font></em></font> jit_insn_label(erato, <strong>&amp;</strong> while_begin); <br> <font color="gray">071:</font> while_cond <strong>=</strong> jit_insn_gt(erato,j,n); <br> <font color="gray">072:</font> jit_insn_branch_if(erato, while_cond, <strong>&amp;</strong> while_end); <br> <font color="gray">073:</font> <br> <font color="gray">074:</font> jit_insn_store_elem(erato,a,j,szero); <br> <font color="gray">075:</font> <br> <font color="gray">076:</font> tmp4 <strong>=</strong> jit_insn_add(erato,j,i); <br> <font color="gray">077:</font> jit_insn_store(erato,j,tmp4); <br> <font color="gray">078:</font> <font color="#999988"><em>//while end <br> <font color="gray">079:</font></em></font> jit_insn_branch(erato, <strong>&amp;</strong> while_begin); <br> <font color="gray">080:</font> jit_insn_label(erato, <strong>&amp;</strong> while_end); <br> <font color="gray">081:</font> <font color="#999988"><em>// end if <br> <font color="gray">082:</font></em></font> jit_insn_label(erato, <strong>&amp;</strong> end_if); <br> <font color="gray">083:</font> <br> <font color="gray">084:</font> <font color="#999988"><em>//  end for i=2 to q <br> <font color="gray">085:</font></em></font> uint1 <strong>=</strong> jit_value_create_nint_constant(erato,jit_type_uint, <font color="#009999">1</font> ); <br> <font color="gray">086:</font> tmpi <strong>=</strong> jit_insn_add(erato,i,uint1); <br> <font color="gray">087:</font> jit_insn_store(erato,i,tmpi); <br> <font color="gray">088:</font> jit_insn_branch(erato, <strong>&amp;</strong> for_begin); <br> <font color="gray">089:</font> jit_insn_label(erato, <strong>&amp;</strong> end_for); <br> <font color="gray">090:</font> <br> <font color="gray">091:</font> jit_insn_return(erato, i); <br> <font color="gray">092:</font> <br> <font color="gray">093:</font> <font color="#999988"><em>/* Compile the erato */</em></font> <br> <font color="gray">094:</font> jit_dump_function(stderr, erato, <font color="#bb8844">"erato"</font> ); <br> <font color="gray">095:</font> <br> <font color="gray">096:</font> jit_function_compile(erato); <br> <font color="gray">097:</font> } <br> <font color="gray">098:</font> <br> <font color="gray">099:</font> <br> <font color="gray">100:</font> <font color="#445588"><strong>void</strong></font> <font color="#990000"><strong>create_main</strong></font> () <br> <font color="gray">101:</font> { <br> <font color="gray">102:</font> jit_label_t for_begin <strong>=</strong> jit_label_undefined; <br> <font color="gray">103:</font> jit_label_t end_for <strong>=</strong> jit_label_undefined; <br> <font color="gray">104:</font> jit_value_t temp_args[ <font color="#009999">1</font> ]; <br> <font color="gray">105:</font> jit_value_t temp3,tmpi,one,n,the_i,for_cond,alot,place_for_i; <br> <font color="gray">106:</font> jit_type_t params[ <font color="#009999">2</font> ]; <br> <font color="gray">107:</font> jit_type_t signature; <br> <font color="gray">108:</font> <br> <font color="gray">109:</font> n <strong>=</strong> jit_value_get_param(main_function, <font color="#009999">0</font> ); <br> <font color="gray">110:</font> alot <strong>=</strong> jit_value_get_param(main_function, <font color="#009999">1</font> ); <br> <font color="gray">111:</font> <br> <font color="gray">112:</font> one <strong>=</strong> jit_value_create_nint_constant(main_function,jit_type_int, <font color="#009999">1</font> ); <br> <font color="gray">113:</font> the_i <strong>=</strong> jit_value_create(main_function,jit_type_uint); <br> <font color="gray">114:</font> <br> <font color="gray">115:</font> place_for_i <strong>=</strong> jit_insn_alloca(main_function, jit_value_create_nint_constant(main_function,jit_type_int, <font color="#009999">4</font> ) ); <br> <font color="gray">116:</font> <br> <font color="gray">117:</font> jit_insn_store(main_function,place_for_i,one); <br> <font color="gray">118:</font> <br> <font color="gray">119:</font> jit_insn_label(main_function, <strong>&amp;</strong> for_begin); <br> <font color="gray">120:</font> the_i <strong>=</strong> jit_insn_load(main_function,place_for_i); <br> <font color="gray">121:</font> <br> <font color="gray">122:</font> for_cond <strong>=</strong> jit_insn_gt(main_function, the_i, n); <br> <font color="gray">123:</font> jit_insn_branch_if(main_function,for_cond, <strong>&amp;</strong> end_for); <br> <font color="gray">124:</font> <br> <font color="gray">125:</font> temp_args[ <font color="#009999">0</font> ] <strong>=</strong> alot; <br> <font color="gray">126:</font> tmpi <strong>=</strong> jit_insn_call (main_function, <font color="#bb8844">"erato"</font> , erato, <font color="#999999">NULL</font> , temp_args, <font color="#009999">1</font> , JIT_CALL_NOTHROW); <br> <font color="gray">127:</font> <br> <font color="gray">128:</font> temp3 <strong>=</strong> jit_insn_add(main_function,the_i,one); <br> <font color="gray">129:</font> <br> <font color="gray">130:</font> jit_insn_store(main_function,place_for_i,temp3); <br> <font color="gray">131:</font> <br> <font color="gray">132:</font> jit_insn_branch(main_function, <strong>&amp;</strong> for_begin); <br> <font color="gray">133:</font> jit_insn_label(main_function, <strong>&amp;</strong> end_for); <br> <font color="gray">134:</font> <br> <font color="gray">135:</font> jit_insn_return(main_function, alot); <br> <font color="gray">136:</font> <br> <font color="gray">137:</font> jit_dump_function(stderr, main_function, <font color="#bb8844">"main"</font> ); <br> <font color="gray">138:</font> jit_function_compile(main_function); <br> <font color="gray">139:</font> <font color="#999988"><em>//  jit_dump_function(stderr, main_function, "main_compiled"); <br> <font color="gray">140:</font></em></font> <br> <font color="gray">141:</font> } <br> <font color="gray">142:</font> <br> <font color="gray">143:</font> <font color="#445588"><strong>int</strong></font> <font color="#990000"><strong>main</strong></font> ( <font color="#445588"><strong>int</strong></font> argc, <font color="#445588"><strong>char</strong></font> <strong>**</strong> argv) <br> <font color="gray">144:</font> { <br> <font color="gray">145:</font> jit_context_t context; <br> <font color="gray">146:</font> <font color="#445588"><strong>void</strong></font> <strong>*</strong> args[ <font color="#009999">2</font> ]; <br> <font color="gray">147:</font> jit_uint result; <br> <font color="gray">148:</font> jit_int arg1,arg2; <br> <font color="gray">149:</font> jit_type_t params[ <font color="#009999">2</font> ]; <br> <font color="gray">150:</font> jit_type_t signature,sign1; <br> <font color="gray">151:</font> <br> <font color="gray">152:</font> context <strong>=</strong> jit_context_create(); <br> <font color="gray">153:</font> <br> <font color="gray">154:</font> <font color="#999988"><em>/* Lock the context while we build and compile the function */</em></font> <br> <font color="gray">155:</font> jit_context_build_start(context); <br> <font color="gray">156:</font> <br> <font color="gray">157:</font> <font color="#999988"><em>/* Build the function signature */</em></font> <br> <font color="gray">158:</font> params[ <font color="#009999">0</font> ] <strong>=</strong> jit_type_int; <br> <font color="gray">159:</font> signature <strong>=</strong> jit_type_create_signature  (jit_abi_cdecl, jit_type_int, params, <font color="#009999">1</font> , <font color="#009999">1</font> ); <br> <font color="gray">160:</font> <br> <font color="gray">161:</font> erato <strong>=</strong> jit_function_create(context, signature); <br> <font color="gray">162:</font> create_erato(); <br> <font color="gray">163:</font> <br> <font color="gray">164:</font> params[ <font color="#009999">0</font> ] <strong>=</strong> jit_type_int; <br> <font color="gray">165:</font> params[ <font color="#009999">1</font> ] <strong>=</strong> jit_type_int; <br> <font color="gray">166:</font> signature <strong>=</strong> jit_type_create_signature  (jit_abi_cdecl, jit_type_int, params, <font color="#009999">2</font> , <font color="#009999">1</font> ); <br> <font color="gray">167:</font> <br> <font color="gray">168:</font> main_function <strong>=</strong> jit_function_create(context, signature); <br> <font color="gray">169:</font> create_main(); <br> <font color="gray">170:</font> <br> <font color="gray">171:</font> <font color="#999988"><em>/* Unlock the context */</em></font> <br> <font color="gray">172:</font> jit_context_build_end(context); <br> <font color="gray">173:</font> <br> <font color="gray">174:</font> <font color="#999988"><em>// jit_dump_function(stderr, main_function, "main"); <br> <font color="gray">175:</font></em></font> <font color="#999988"><em>/* Execute the function and print the result */</em></font> <br> <font color="gray">176:</font> arg1 <strong>=</strong> <font color="#009999">100000</font> ; <br> <font color="gray">177:</font> arg2 <strong>=</strong> <font color="#009999">50000</font> ; <br> <font color="gray">178:</font> args[ <font color="#009999">0</font> ] <strong>=</strong> <strong>&amp;</strong> arg1; <br> <font color="gray">179:</font> args[ <font color="#009999">1</font> ] <strong>=</strong> <strong>&amp;</strong> arg2; <br> <font color="gray">180:</font> <br> <font color="gray">181:</font> jit_function_apply(main_function, args, <strong>&amp;</strong> result); <br> <font color="gray">182:</font> <br> <font color="gray">183:</font> <font color="#999988"><em>/* Clean up */</em></font> <br> <font color="gray">184:</font> jit_context_destroy(context); <br> <font color="gray">185:</font> <br> <font color="gray">186:</font> <font color="#999988"><em>/* Finished */</em></font> <br> <font color="gray">187:</font> <strong>return</strong> <font color="#009999">0</font> ; <br> <font color="gray">188:</font> } <br> <font color="gray">189:</font> <br> <br></font></code> </blockquote> <code><font><font color="gray">001</font> : <font color="#999999"><strong>#include &lt;stdio.h&gt; <br> <font color="gray">002:</font> #include &lt;jit/jit.h&gt; <br> <font color="gray">003:</font></strong></font> <br> <font color="gray">004:</font> <font color="#445588"><strong>unsigned</strong></font> <font color="#445588"><strong>int</strong></font> <font color="#990000"><strong>myprint</strong></font> ( <font color="#445588"><strong>unsigned</strong></font> <font color="#445588"><strong>int</strong></font> a) { <br> <font color="gray">005:</font> printf( <font color="#bb8844">" %d</font> <font color="#bb8844">\n</font> <font color="#bb8844">"</font> ,a); <br> <font color="gray">006:</font> } <br> <font color="gray">007:</font> <br> <font color="gray">008:</font> jit_function_t main_function, erato; <br> <font color="gray">009:</font> <br> <font color="gray">010:</font> <br> <font color="gray">011:</font> <font color="#445588"><strong>void</strong></font> <font color="#990000"><strong>create_erato</strong></font> () <br> <font color="gray">012:</font> { <br> <font color="gray">013:</font> jit_type_t params[ <font color="#009999">1</font> ]; <br> <font color="gray">014:</font> jit_type_t signature; <br> <font color="gray">015:</font> jit_label_t for_begin <strong>=</strong> jit_label_undefined; <br> <font color="gray">016:</font> jit_label_t end_for <strong>=</strong> jit_label_undefined; <br> <font color="gray">017:</font> jit_label_t end_if <strong>=</strong> jit_label_undefined; <br> <font color="gray">018:</font> jit_label_t while_end <strong>=</strong> jit_label_undefined; <br> <font color="gray">019:</font> jit_label_t while_begin <strong>=</strong> jit_label_undefined; <br> <font color="gray">020:</font> jit_label_t print_end <strong>=</strong> jit_label_undefined; <br> <font color="gray">021:</font> jit_label_t print_begin <strong>=</strong> jit_label_undefined; <br> <font color="gray">022:</font> jit_label_t print_if <strong>=</strong> jit_label_undefined; <br> <font color="gray">023:</font> <font color="#445588"><strong>void</strong></font> <strong>*</strong> args[ <font color="#009999">2</font> ]; <br> <font color="gray">024:</font> jit_uint result; <br> <font color="gray">025:</font> jit_value_t n,a,one1,szero,uint1,two2; <br> <font color="gray">026:</font> jit_int arg1; <br> <font color="gray">027:</font> jit_intrinsic_descr_t tofloat <strong>=</strong> {jit_type_nfloat, <font color="#999999">NULL</font> , jit_type_uint, <font color="#999999">NULL</font> }; <br> <font color="gray">028:</font> jit_intrinsic_descr_t toint <strong>=</strong> {jit_type_uint, <font color="#999999">NULL</font> , jit_type_nfloat, <font color="#999999">NULL</font> }; <br> <font color="gray">029:</font> jit_value_t temp1,temp2,q; <br> <font color="gray">030:</font> jit_value_t i,j,elem; <br> <font color="gray">031:</font> jit_value_t for_cond, if_cond, while_cond, print_cond; <br> <font color="gray">032:</font> jit_value_t tmpi, tmp3,tmp4; <br> <font color="gray">033:</font> <font color="#999988"><em>/* Create a context to hold the JIT's primary state */</em></font> <br> <font color="gray">034:</font> <font color="#999988"><em>/* Build the erato signature */</em></font> <br> <font color="gray">035:</font> params[ <font color="#009999">0</font> ] <strong>=</strong> jit_type_uint; <br> <font color="gray">036:</font> signature <strong>=</strong> jit_type_create_signature (jit_abi_cdecl, jit_type_uint, params, <font color="#009999">1</font> , <font color="#009999">1</font> ); <br> <font color="gray">037:</font> <br> <font color="gray">038:</font> <font color="#999988"><em>/* allocate sieve storage and init it by 1 */</em></font> <br> <font color="gray">039:</font> n <strong>=</strong> jit_value_get_param(erato, <font color="#009999">0</font> ); <br> <font color="gray">040:</font> <br> <font color="gray">041:</font> <font color="#999988"><em>//jit_insn_call_native(erato, "print", myprint, signature, &amp;n ,1,0); <br> <font color="gray">042:</font></em></font> a <strong>=</strong> jit_insn_alloca(erato,n); <br> <font color="gray">043:</font> one1 <strong>=</strong> jit_value_create_nint_constant(erato, jit_type_ubyte, <font color="#009999">1</font> ); <br> <font color="gray">044:</font> szero <strong>=</strong> jit_value_create_nint_constant(erato,jit_type_ubyte, <font color="#009999">0</font> ); <br> <font color="gray">045:</font> jit_insn_memset(erato,a, one1,n); <br> <font color="gray">046:</font> <font color="#999988"><em>/* convert to float, sqrt and convert to int back */</em></font> <br> <font color="gray">047:</font> temp1 <strong>=</strong> jit_insn_call_intrinsic(erato, <font color="#bb8844">"convert_to_float"</font> , jit_uint_to_nfloat, <strong>&amp;</strong> tofloat ,n, <font color="#999999">NULL</font> ); <br> <font color="gray">048:</font> temp2 <strong>=</strong> jit_insn_sqrt(erato, temp1); <br> <font color="gray">049:</font> q <strong>=</strong> jit_insn_call_intrinsic(erato, <font color="#bb8844">"convert_to_int"</font> ,jit_nfloat_to_uint, <strong>&amp;</strong> toint ,temp2, <font color="#999999">NULL</font> ); <br> <font color="gray">050:</font> <br> <font color="gray">051:</font> <font color="#999988"><em>/* for i = 2 to q do*/</em></font> <br> <font color="gray">052:</font> two2 <strong>=</strong> jit_value_create_nint_constant(erato,jit_type_uint, <font color="#009999">2</font> ); <br> <font color="gray">053:</font> i <strong>=</strong> jit_value_create(erato,jit_type_uint); <br> <font color="gray">054:</font> jit_insn_store(erato,i,two2); <br> <font color="gray">055:</font> jit_insn_label(erato, <strong>&amp;</strong> for_begin); <br> <font color="gray">056:</font> for_cond <strong>=</strong> jit_insn_gt(erato, i, q); <br> <font color="gray">057:</font> jit_insn_branch_if(erato,for_cond, <strong>&amp;</strong> end_for); <br> <font color="gray">058:</font> <br> <font color="gray">059:</font> <font color="#999988"><em>// if <br> <font color="gray">060:</font></em></font> elem <strong>=</strong> jit_insn_load_elem(erato, a, i, jit_type_ubyte); <br> <font color="gray">061:</font> if_cond <strong>=</strong> jit_insn_eq(erato, elem, one1); <br> <font color="gray">062:</font> jit_insn_branch_if_not(erato,if_cond, <strong>&amp;</strong> end_if); <br> <font color="gray">063:</font> <br> <font color="gray">064:</font> <font color="#999988"><em>// j = i*i <br> <font color="gray">065:</font></em></font> j <strong>=</strong> jit_value_create(erato, jit_type_uint); <br> <font color="gray">066:</font> tmp3 <strong>=</strong> jit_insn_mul(erato, i, i); <br> <font color="gray">067:</font> jit_insn_store(erato,j, tmp3); <br> <font color="gray">068:</font> <br> <font color="gray">069:</font> <font color="#999988"><em>// while <br> <font color="gray">070:</font></em></font> jit_insn_label(erato, <strong>&amp;</strong> while_begin); <br> <font color="gray">071:</font> while_cond <strong>=</strong> jit_insn_gt(erato,j,n); <br> <font color="gray">072:</font> jit_insn_branch_if(erato, while_cond, <strong>&amp;</strong> while_end); <br> <font color="gray">073:</font> <br> <font color="gray">074:</font> jit_insn_store_elem(erato,a,j,szero); <br> <font color="gray">075:</font> <br> <font color="gray">076:</font> tmp4 <strong>=</strong> jit_insn_add(erato,j,i); <br> <font color="gray">077:</font> jit_insn_store(erato,j,tmp4); <br> <font color="gray">078:</font> <font color="#999988"><em>//while end <br> <font color="gray">079:</font></em></font> jit_insn_branch(erato, <strong>&amp;</strong> while_begin); <br> <font color="gray">080:</font> jit_insn_label(erato, <strong>&amp;</strong> while_end); <br> <font color="gray">081:</font> <font color="#999988"><em>// end if <br> <font color="gray">082:</font></em></font> jit_insn_label(erato, <strong>&amp;</strong> end_if); <br> <font color="gray">083:</font> <br> <font color="gray">084:</font> <font color="#999988"><em>//  end for i=2 to q <br> <font color="gray">085:</font></em></font> uint1 <strong>=</strong> jit_value_create_nint_constant(erato,jit_type_uint, <font color="#009999">1</font> ); <br> <font color="gray">086:</font> tmpi <strong>=</strong> jit_insn_add(erato,i,uint1); <br> <font color="gray">087:</font> jit_insn_store(erato,i,tmpi); <br> <font color="gray">088:</font> jit_insn_branch(erato, <strong>&amp;</strong> for_begin); <br> <font color="gray">089:</font> jit_insn_label(erato, <strong>&amp;</strong> end_for); <br> <font color="gray">090:</font> <br> <font color="gray">091:</font> jit_insn_return(erato, i); <br> <font color="gray">092:</font> <br> <font color="gray">093:</font> <font color="#999988"><em>/* Compile the erato */</em></font> <br> <font color="gray">094:</font> jit_dump_function(stderr, erato, <font color="#bb8844">"erato"</font> ); <br> <font color="gray">095:</font> <br> <font color="gray">096:</font> jit_function_compile(erato); <br> <font color="gray">097:</font> } <br> <font color="gray">098:</font> <br> <font color="gray">099:</font> <br> <font color="gray">100:</font> <font color="#445588"><strong>void</strong></font> <font color="#990000"><strong>create_main</strong></font> () <br> <font color="gray">101:</font> { <br> <font color="gray">102:</font> jit_label_t for_begin <strong>=</strong> jit_label_undefined; <br> <font color="gray">103:</font> jit_label_t end_for <strong>=</strong> jit_label_undefined; <br> <font color="gray">104:</font> jit_value_t temp_args[ <font color="#009999">1</font> ]; <br> <font color="gray">105:</font> jit_value_t temp3,tmpi,one,n,the_i,for_cond,alot,place_for_i; <br> <font color="gray">106:</font> jit_type_t params[ <font color="#009999">2</font> ]; <br> <font color="gray">107:</font> jit_type_t signature; <br> <font color="gray">108:</font> <br> <font color="gray">109:</font> n <strong>=</strong> jit_value_get_param(main_function, <font color="#009999">0</font> ); <br> <font color="gray">110:</font> alot <strong>=</strong> jit_value_get_param(main_function, <font color="#009999">1</font> ); <br> <font color="gray">111:</font> <br> <font color="gray">112:</font> one <strong>=</strong> jit_value_create_nint_constant(main_function,jit_type_int, <font color="#009999">1</font> ); <br> <font color="gray">113:</font> the_i <strong>=</strong> jit_value_create(main_function,jit_type_uint); <br> <font color="gray">114:</font> <br> <font color="gray">115:</font> place_for_i <strong>=</strong> jit_insn_alloca(main_function, jit_value_create_nint_constant(main_function,jit_type_int, <font color="#009999">4</font> ) ); <br> <font color="gray">116:</font> <br> <font color="gray">117:</font> jit_insn_store(main_function,place_for_i,one); <br> <font color="gray">118:</font> <br> <font color="gray">119:</font> jit_insn_label(main_function, <strong>&amp;</strong> for_begin); <br> <font color="gray">120:</font> the_i <strong>=</strong> jit_insn_load(main_function,place_for_i); <br> <font color="gray">121:</font> <br> <font color="gray">122:</font> for_cond <strong>=</strong> jit_insn_gt(main_function, the_i, n); <br> <font color="gray">123:</font> jit_insn_branch_if(main_function,for_cond, <strong>&amp;</strong> end_for); <br> <font color="gray">124:</font> <br> <font color="gray">125:</font> temp_args[ <font color="#009999">0</font> ] <strong>=</strong> alot; <br> <font color="gray">126:</font> tmpi <strong>=</strong> jit_insn_call (main_function, <font color="#bb8844">"erato"</font> , erato, <font color="#999999">NULL</font> , temp_args, <font color="#009999">1</font> , JIT_CALL_NOTHROW); <br> <font color="gray">127:</font> <br> <font color="gray">128:</font> temp3 <strong>=</strong> jit_insn_add(main_function,the_i,one); <br> <font color="gray">129:</font> <br> <font color="gray">130:</font> jit_insn_store(main_function,place_for_i,temp3); <br> <font color="gray">131:</font> <br> <font color="gray">132:</font> jit_insn_branch(main_function, <strong>&amp;</strong> for_begin); <br> <font color="gray">133:</font> jit_insn_label(main_function, <strong>&amp;</strong> end_for); <br> <font color="gray">134:</font> <br> <font color="gray">135:</font> jit_insn_return(main_function, alot); <br> <font color="gray">136:</font> <br> <font color="gray">137:</font> jit_dump_function(stderr, main_function, <font color="#bb8844">"main"</font> ); <br> <font color="gray">138:</font> jit_function_compile(main_function); <br> <font color="gray">139:</font> <font color="#999988"><em>//  jit_dump_function(stderr, main_function, "main_compiled"); <br> <font color="gray">140:</font></em></font> <br> <font color="gray">141:</font> } <br> <font color="gray">142:</font> <br> <font color="gray">143:</font> <font color="#445588"><strong>int</strong></font> <font color="#990000"><strong>main</strong></font> ( <font color="#445588"><strong>int</strong></font> argc, <font color="#445588"><strong>char</strong></font> <strong>**</strong> argv) <br> <font color="gray">144:</font> { <br> <font color="gray">145:</font> jit_context_t context; <br> <font color="gray">146:</font> <font color="#445588"><strong>void</strong></font> <strong>*</strong> args[ <font color="#009999">2</font> ]; <br> <font color="gray">147:</font> jit_uint result; <br> <font color="gray">148:</font> jit_int arg1,arg2; <br> <font color="gray">149:</font> jit_type_t params[ <font color="#009999">2</font> ]; <br> <font color="gray">150:</font> jit_type_t signature,sign1; <br> <font color="gray">151:</font> <br> <font color="gray">152:</font> context <strong>=</strong> jit_context_create(); <br> <font color="gray">153:</font> <br> <font color="gray">154:</font> <font color="#999988"><em>/* Lock the context while we build and compile the function */</em></font> <br> <font color="gray">155:</font> jit_context_build_start(context); <br> <font color="gray">156:</font> <br> <font color="gray">157:</font> <font color="#999988"><em>/* Build the function signature */</em></font> <br> <font color="gray">158:</font> params[ <font color="#009999">0</font> ] <strong>=</strong> jit_type_int; <br> <font color="gray">159:</font> signature <strong>=</strong> jit_type_create_signature  (jit_abi_cdecl, jit_type_int, params, <font color="#009999">1</font> , <font color="#009999">1</font> ); <br> <font color="gray">160:</font> <br> <font color="gray">161:</font> erato <strong>=</strong> jit_function_create(context, signature); <br> <font color="gray">162:</font> create_erato(); <br> <font color="gray">163:</font> <br> <font color="gray">164:</font> params[ <font color="#009999">0</font> ] <strong>=</strong> jit_type_int; <br> <font color="gray">165:</font> params[ <font color="#009999">1</font> ] <strong>=</strong> jit_type_int; <br> <font color="gray">166:</font> signature <strong>=</strong> jit_type_create_signature  (jit_abi_cdecl, jit_type_int, params, <font color="#009999">2</font> , <font color="#009999">1</font> ); <br> <font color="gray">167:</font> <br> <font color="gray">168:</font> main_function <strong>=</strong> jit_function_create(context, signature); <br> <font color="gray">169:</font> create_main(); <br> <font color="gray">170:</font> <br> <font color="gray">171:</font> <font color="#999988"><em>/* Unlock the context */</em></font> <br> <font color="gray">172:</font> jit_context_build_end(context); <br> <font color="gray">173:</font> <br> <font color="gray">174:</font> <font color="#999988"><em>// jit_dump_function(stderr, main_function, "main"); <br> <font color="gray">175:</font></em></font> <font color="#999988"><em>/* Execute the function and print the result */</em></font> <br> <font color="gray">176:</font> arg1 <strong>=</strong> <font color="#009999">100000</font> ; <br> <font color="gray">177:</font> arg2 <strong>=</strong> <font color="#009999">50000</font> ; <br> <font color="gray">178:</font> args[ <font color="#009999">0</font> ] <strong>=</strong> <strong>&amp;</strong> arg1; <br> <font color="gray">179:</font> args[ <font color="#009999">1</font> ] <strong>=</strong> <strong>&amp;</strong> arg2; <br> <font color="gray">180:</font> <br> <font color="gray">181:</font> jit_function_apply(main_function, args, <strong>&amp;</strong> result); <br> <font color="gray">182:</font> <br> <font color="gray">183:</font> <font color="#999988"><em>/* Clean up */</em></font> <br> <font color="gray">184:</font> jit_context_destroy(context); <br> <font color="gray">185:</font> <br> <font color="gray">186:</font> <font color="#999988"><em>/* Finished */</em></font> <br> <font color="gray">187:</font> <strong>return</strong> <font color="#009999">0</font> ; <br> <font color="gray">188:</font> } <br> <font color="gray">189:</font></font> <br> <br></code> <br>  General impressions - it is written quite easily, documentation is detailed, there are examples, so - I put + <br><br><h5>  LLVM option </h5><br><br><blockquote> <code><font color="gray">001</font> : <font color="#999999"><strong>#include "llvm/DerivedTypes.h" <br> <font color="gray">002:</font> #include "llvm/LLVMContext.h" <br> <font color="gray">003:</font> #include "llvm/Module.h" <br> <font color="gray">004:</font> #include "llvm/Analysis/Verifier.h" <br> <font color="gray">005:</font> #include "llvm/Support/IRBuilder.h" <br> <font color="gray">006:</font> #include "llvm/ExecutionEngine/ExecutionEngine.h" <br> <font color="gray">007:</font> #include "llvm/ExecutionEngine/JIT.h" <br> <font color="gray">008:</font> #include "llvm/PassManager.h" <br> <font color="gray">009:</font> #include "llvm/Analysis/Verifier.h" <br> <font color="gray">010:</font> #include "llvm/Target/TargetData.h" <br> <font color="gray">011:</font> #include "llvm/Target/TargetSelect.h" <br> <font color="gray">012:</font> #include "llvm/Transforms/Scalar.h" <br> <font color="gray">013:</font> <br> <font color="gray">014:</font> #include &lt;iostream&gt; <br> <font color="gray">015:</font> #include &lt;vector&gt; <br> <font color="gray">016:</font> #include &lt;list&gt; <br> <font color="gray">017:</font> #include &lt;map&gt; <br> <font color="gray">018:</font> #include &lt;stdlib.h&gt; <br> <font color="gray">019:</font> #include &lt;cstring&gt; <br> <font color="gray">020:</font> #include &lt;string&gt; <br> <font color="gray">021:</font> #include &lt;stdio.h&gt; <br> <font color="gray">022:</font></strong></font> <strong>using</strong> <strong>namespace</strong> llvm; <br> <font color="gray">023:</font> <strong>using</strong> <strong>namespace</strong> std; <br> <font color="gray">024:</font> <br> <font color="gray">025:</font> Value <strong>*</strong> ErrorV( <strong>const</strong> <font color="#445588"><strong>char</strong></font> <strong>*</strong> Str) <br> <font color="gray">026:</font> { <br> <font color="gray">027:</font> cerr <strong>&lt;&lt;</strong> Str <strong>&lt;&lt;</strong> endl; <br> <font color="gray">028:</font> <strong>return</strong> <font color="#009999">0</font> ; <br> <font color="gray">029:</font> } <br> <font color="gray">030:</font> <br> <font color="gray">031:</font> <strong>static</strong> Module <strong>*</strong> TheModule; <br> <font color="gray">032:</font> <strong>static</strong> IRBuilder <strong>&lt;&gt;</strong> Builder(getGlobalContext()); <br> <font color="gray">033:</font> <strong>static</strong> map <strong>&lt;</strong> string, Value <strong>*</strong> <strong>&gt;</strong> NamedValues; <br> <font color="gray">034:</font> <strong>static</strong> ExecutionEngine <strong>*</strong> TheExecutionEngine; <br> <font color="gray">035:</font> <br> <font color="gray">036:</font> <font color="#445588"><strong>int</strong></font> main() <br> <font color="gray">037:</font> { <br> <font color="gray">038:</font> InitializeNativeTarget(); <br> <font color="gray">039:</font> LLVMContext <strong>&amp;</strong> Context <strong>=</strong> getGlobalContext(); <br> <font color="gray">040:</font> TheModule <strong>=</strong> <strong>new</strong> Module( <font color="#bb8844">"erato"</font> , Context); <br> <font color="gray">041:</font> <br> <font color="gray">042:</font> std <strong>::</strong> string ErrStr; <br> <font color="gray">043:</font> TheExecutionEngine <strong>=</strong> <br> <font color="gray">044:</font> EngineBuilder(TheModule).setErrorStr( <strong>&amp;</strong> ErrStr).create(); <br> <font color="gray">045:</font> <strong>if</strong> ( <strong>!</strong> TheExecutionEngine) { <br> <font color="gray">046:</font> fprintf(stderr, <font color="#bb8844">"Could not create ExecutionEngine: %s</font> <font color="#bb8844">\n</font> <font color="#bb8844">"</font> , <br> <font color="gray">047:</font> ErrStr.c_str()); <br> <font color="gray">048:</font> exit( <font color="#009999">1</font> ); <br> <font color="gray">049:</font> } <br> <font color="gray">050:</font> <br> <font color="gray">051:</font> <br> <font color="gray">052:</font> <strong>const</strong> Type <strong>*</strong> voidType <strong>=</strong> Type <strong>::</strong> getVoidTy(Context); <br> <font color="gray">053:</font> <strong>const</strong> Type <strong>*</strong> i32Type <strong>=</strong> IntegerType <strong>::</strong> get(Context, <font color="#009999">32</font> ); <br> <font color="gray">054:</font> <strong>const</strong> Type <strong>*</strong> i8Type <strong>=</strong> IntegerType <strong>::</strong> get(Context, <font color="#009999">8</font> ); <br> <font color="gray">055:</font> <strong>const</strong> Type <strong>*</strong> FType <strong>=</strong> Type <strong>::</strong> getDoubleTy(Context); <br> <font color="gray">056:</font> <strong>const</strong> Type <strong>*</strong> SType <strong>=</strong> PointerType <strong>::</strong> get(i8Type, <font color="#009999">0</font> ); <br> <font color="gray">057:</font> <br> <font color="gray">058:</font> Value <strong>*</strong> zero <strong>=</strong> ConstantInt <strong>::</strong> get(i32Type, <font color="#009999">0</font> ); <br> <font color="gray">059:</font> Value <strong>*</strong> one <strong>=</strong> ConstantInt <strong>::</strong> get(i32Type, <font color="#009999">1</font> ); <br> <font color="gray">060:</font> Value <strong>*</strong> two <strong>=</strong> ConstantInt <strong>::</strong> get(i32Type, <font color="#009999">2</font> ); <br> <font color="gray">061:</font> Constant <strong>*</strong> n100000 <strong>=</strong> ConstantInt <strong>::</strong> get(i32Type, <font color="#009999">100000</font> ); <br> <font color="gray">062:</font> Constant <strong>*</strong> n50000 <strong>=</strong> ConstantInt <strong>::</strong> get(i32Type, <font color="#009999">50000</font> ); <br> <font color="gray">063:</font> <br> <font color="gray">064:</font> Value <strong>*</strong> i8zero <strong>=</strong> ConstantInt <strong>::</strong> get(i8Type, <font color="#009999">0</font> ); <br> <font color="gray">065:</font> Value <strong>*</strong> i8one <strong>=</strong> ConstantInt <strong>::</strong> get(i8Type, <font color="#009999">1</font> ); <br> <font color="gray">066:</font> <br> <font color="gray">067:</font> <br> <font color="gray">068:</font> <br> <font color="gray">069:</font> vector <strong>&lt;</strong> <strong>const</strong> Type <strong>*&gt;</strong> def_args; <br> <font color="gray">070:</font> <br> <font color="gray">071:</font> def_args.push_back(SType); <br> <font color="gray">072:</font> FunctionType <strong>*</strong> fdefinition <strong>=</strong> FunctionType <strong>::</strong> get(voidType, def_args, <strong>true</strong> ); <br> <font color="gray">073:</font> func_printf <strong>=</strong> Function <strong>::</strong> Create(fdefinition, GlobalValue <strong>::</strong> ExternalLinkage, <font color="#bb8844">"printf"</font> , TheModule); <br> <font color="gray">074:</font> func_printf <strong>-&gt;</strong> setCallingConv(CallingConv <strong>::</strong> C); <br> <font color="gray">075:</font> def_args.clear(); <br> <font color="gray">076:</font> <br> <font color="gray">077:</font> <font color="#999988"><em>// declare double @llvm.sqrt.f64(double) nounwind readonly <br> <font color="gray">078:</font></em></font> <br> <font color="gray">079:</font> def_args.push_back(FType); <br> <font color="gray">080:</font> FunctionType <strong>*</strong> fdefinition_sqrt <strong>=</strong> FunctionType <strong>::</strong> get(FType, def_args, <strong>false</strong> ); <br> <font color="gray">081:</font> Function <strong>*</strong> func_sqrt <strong>=</strong> Function <strong>::</strong> Create(fdefinition_sqrt, GlobalValue <strong>::</strong> ExternalLinkage, <font color="#bb8844">"llvm.sqrt.f64"</font> , TheModule); <br> <font color="gray">082:</font> func_sqrt <strong>-&gt;</strong> setCallingConv(CallingConv <strong>::</strong> C); <br> <font color="gray">083:</font> def_args.clear(); <br> <font color="gray">084:</font> <br> <font color="gray">085:</font> <font color="#999988"><em>// declare void @llvm.memset.i32(i8* nocapture, i8, i32, i32) nounwind <br> <font color="gray">086:</font></em></font> <br> <font color="gray">087:</font> def_args.push_back(SType); <br> <font color="gray">088:</font> def_args.push_back(i8Type); <br> <font color="gray">089:</font> def_args.push_back(i32Type); <br> <font color="gray">090:</font> def_args.push_back(i32Type); <br> <font color="gray">091:</font> FunctionType <strong>*</strong> fdefinition_memset <strong>=</strong> FunctionType <strong>::</strong> get(voidType, def_args, <strong>false</strong> ); <br> <font color="gray">092:</font> Function <strong>*</strong> func_memset <strong>=</strong> Function <strong>::</strong> Create(fdefinition_memset, GlobalValue <strong>::</strong> ExternalLinkage, <font color="#bb8844">"llvm.memset.i32"</font> , TheModule); <br> <font color="gray">093:</font> func_memset <strong>-&gt;</strong> setCallingConv(CallingConv <strong>::</strong> C); <br> <font color="gray">094:</font> def_args.clear(); <br> <font color="gray">095:</font> <br> <font color="gray">096:</font> <br> <font color="gray">097:</font> <font color="#999988"><em>// Construct eratosphene() <br> <font color="gray">098:</font></em></font> Function <strong>*</strong> func_ef <strong>=</strong> cast <strong>&lt;</strong> Function <strong>&gt;</strong> (TheModule <strong>-&gt;</strong> getOrInsertFunction( <font color="#bb8844">"erato"</font> , voidType, i32Type, <font color="#999999">NULL</font> )); <br> <font color="gray">099:</font> func_ef <strong>-&gt;</strong> setCallingConv(CallingConv <strong>::</strong> C); <br> <font color="gray">100:</font> BasicBlock <strong>*</strong> ef_start_block <strong>=</strong> BasicBlock <strong>::</strong> Create(Context, <font color="#bb8844">"efcode"</font> , func_ef); <br> <font color="gray">101:</font> IRBuilder <strong>&lt;&gt;</strong> efcodeIR(ef_start_block); <br> <font color="gray">102:</font> format <strong>=</strong> efcodeIR.CreateGlobalStringPtr( <font color="#bb8844">"%d"</font> , <font color="#bb8844">".format"</font> ); <br> <font color="gray">103:</font> <br> <font color="gray">104:</font> BasicBlock <strong>*</strong> ef_mainloop <strong>=</strong> BasicBlock <strong>::</strong> Create(Context, <font color="#bb8844">"Main_loop"</font> , func_ef); <br> <font color="gray">105:</font> BasicBlock <strong>*</strong> ef_mainloopbody <strong>=</strong> BasicBlock <strong>::</strong> Create(Context, <font color="#bb8844">"Main_loop.body"</font> , func_ef); <br> <font color="gray">106:</font> BasicBlock <strong>*</strong> ef_ifbody <strong>=</strong> BasicBlock <strong>::</strong> Create(Context, <font color="#bb8844">"if.body"</font> , func_ef); <br> <font color="gray">107:</font> BasicBlock <strong>*</strong> ef_whileloop <strong>=</strong> BasicBlock <strong>::</strong> Create(Context, <font color="#bb8844">"While_loop"</font> , func_ef); <br> <font color="gray">108:</font> BasicBlock <strong>*</strong> ef_whileloopbody <strong>=</strong> BasicBlock <strong>::</strong> Create(Context, <font color="#bb8844">"While_loop.body"</font> , func_ef); <br> <font color="gray">109:</font> BasicBlock <strong>*</strong> ef_mainloopcont <strong>=</strong> BasicBlock <strong>::</strong> Create(Context, <font color="#bb8844">"Main_loop.cont"</font> , func_ef); <br> <font color="gray">110:</font> BasicBlock <strong>*</strong> ef_mainloopend <strong>=</strong> BasicBlock <strong>::</strong> Create(Context, <font color="#bb8844">"Main_loop.end"</font> , func_ef); <br> <font color="gray">111:</font> <br> <font color="gray">112:</font> <font color="#999988"><em>// Set name for argument <br> <font color="gray">113:</font></em></font> Function <strong>::</strong> arg_iterator ef_args <strong>=</strong> func_ef <strong>-&gt;</strong> arg_begin(); <br> <font color="gray">114:</font> Argument <strong>*</strong> upbound <strong>=</strong> ef_args; <br> <font color="gray">115:</font> upbound <strong>-&gt;</strong> setName( <font color="#bb8844">"upbound"</font> ); <br> <font color="gray">116:</font> <br> <font color="gray">117:</font> Value <strong>*</strong> a <strong>=</strong> efcodeIR.CreateAlloca(i8Type, upbound, <font color="#bb8844">"a"</font> ); <br> <font color="gray">118:</font> Value <strong>*</strong> temp1 <strong>=</strong> efcodeIR.CreateUIToFP(upbound, FType, <font color="#bb8844">"tmp.1"</font> ); <br> <font color="gray">119:</font> Value <strong>*</strong> temp2 <strong>=</strong> efcodeIR.CreateCall(func_sqrt, temp1, <font color="#bb8844">"temp.2"</font> ); <br> <font color="gray">120:</font> Value <strong>*</strong> q <strong>=</strong> efcodeIR.CreateFPToUI(temp2, i32Type, <font color="#bb8844">"q"</font> ); <br> <font color="gray">121:</font> efcodeIR.CreateCall4(func_memset, a, i8one, upbound, one); <br> <font color="gray">122:</font> efcodeIR.CreateBr(ef_mainloop); <br> <font color="gray">123:</font> efcodeIR.SetInsertPoint(ef_mainloop); <br> <font color="gray">124:</font> PHINode <strong>*</strong> i <strong>=</strong> efcodeIR.CreatePHI(i32Type, <font color="#bb8844">"i"</font> ); <br> <font color="gray">125:</font> i <strong>-&gt;</strong> addIncoming(two, ef_start_block); <br> <font color="gray">126:</font> Value <strong>*</strong> cond <strong>=</strong> efcodeIR.CreateICmpUGT(i, q, <font color="#bb8844">"cond"</font> ); <br> <font color="gray">127:</font> efcodeIR.CreateCondBr(cond, ef_mainloopend, ef_mainloopbody); <br> <font color="gray">128:</font> efcodeIR.SetInsertPoint(ef_mainloopbody); <br> <font color="gray">129:</font> Value <strong>*</strong> eptr <strong>=</strong> efcodeIR.CreateGEP(a, i, <font color="#bb8844">"eptr"</font> ); <br> <font color="gray">130:</font> Value <strong>*</strong> elem <strong>=</strong> efcodeIR.CreateLoad(eptr, <font color="#bb8844">"elem"</font> ); <br> <font color="gray">131:</font> Value <strong>*</strong> ifcond <strong>=</strong> efcodeIR.CreateICmpEQ(i8zero, elem, <font color="#bb8844">"ifcond"</font> ); <br> <font color="gray">132:</font> efcodeIR.CreateCondBr(ifcond, ef_mainloopcont, ef_ifbody); <br> <font color="gray">133:</font> efcodeIR.SetInsertPoint(ef_ifbody); <br> <font color="gray">134:</font> Value <strong>*</strong> jfirst <strong>=</strong> efcodeIR.CreateMul(i, i, <font color="#bb8844">"j.first"</font> ); <br> <font color="gray">135:</font> efcodeIR.CreateBr(ef_whileloop); <br> <font color="gray">136:</font> efcodeIR.SetInsertPoint(ef_whileloop); <br> <font color="gray">137:</font> PHINode <strong>*</strong> j <strong>=</strong> efcodeIR.CreatePHI(i32Type, <font color="#bb8844">"j"</font> ); <br> <font color="gray">138:</font> j <strong>-&gt;</strong> addIncoming(jfirst, ef_ifbody); <br> <font color="gray">139:</font> Value <strong>*</strong> whilecond <strong>=</strong> efcodeIR.CreateICmpUGT(j, upbound, <font color="#bb8844">"while.cond"</font> ); <br> <font color="gray">140:</font> efcodeIR.CreateCondBr(whilecond, ef_mainloopcont, ef_whileloopbody); <br> <font color="gray">141:</font> efcodeIR.SetInsertPoint(ef_whileloopbody); <br> <font color="gray">142:</font> Value <strong>*</strong> elemref <strong>=</strong> efcodeIR.CreateGEP(a, j, <font color="#bb8844">"elem.ref"</font> ); <br> <font color="gray">143:</font> efcodeIR.CreateStore(i8zero, elemref); <br> <font color="gray">144:</font> Value <strong>*</strong> jnext <strong>=</strong> efcodeIR.CreateAdd(j, i, <font color="#bb8844">"j.next"</font> ); <br> <font color="gray">145:</font> j <strong>-&gt;</strong> addIncoming(jnext, ef_whileloopbody); <br> <font color="gray">146:</font> efcodeIR.CreateBr(ef_whileloop); <br> <font color="gray">147:</font> efcodeIR.SetInsertPoint(ef_mainloopcont); <br> <font color="gray">148:</font> Value <strong>*</strong> inext <strong>=</strong> efcodeIR.CreateAdd(i, one, <font color="#bb8844">"i.next"</font> ); <br> <font color="gray">149:</font> i <strong>-&gt;</strong> addIncoming(inext, ef_mainloopcont); <br> <font color="gray">150:</font> efcodeIR.CreateBr(ef_mainloop); <br> <font color="gray">151:</font> <br> <font color="gray">152:</font> efcodeIR.SetInsertPoint(ef_mainloopend); <br> <font color="gray">153:</font> efcodeIR.CreateRetVoid(); <br> <font color="gray">154:</font> <br> <font color="gray">155:</font> <font color="#999988"><em>// Contruct void main() <br> <font color="gray">156:</font></em></font> Function <strong>*</strong> func_main <strong>=</strong> cast <strong>&lt;</strong> Function <strong>&gt;</strong> (TheModule <strong>-&gt;</strong> getOrInsertFunction( <font color="#bb8844">"main"</font> , voidType, <font color="#999999">NULL</font> )); <br> <font color="gray">157:</font> func_main <strong>-&gt;</strong> setCallingConv(CallingConv <strong>::</strong> C); <br> <font color="gray">158:</font> BasicBlock <strong>*</strong> mnblock <strong>=</strong> BasicBlock <strong>::</strong> Create(Context, <font color="#bb8844">"maincode"</font> , func_main); <br> <font color="gray">159:</font> IRBuilder <strong>&lt;&gt;</strong> mainIR(mnblock); <br> <font color="gray">160:</font> <br> <font color="gray">161:</font> BasicBlock <strong>*</strong> mn_testloop <strong>=</strong> BasicBlock <strong>::</strong> Create(Context, <font color="#bb8844">"Test_loop"</font> , func_main); <br> <font color="gray">162:</font> BasicBlock <strong>*</strong> mn_tloopbody <strong>=</strong> BasicBlock <strong>::</strong> Create(Context, <font color="#bb8844">"Tloop_body"</font> , func_main); <br> <font color="gray">163:</font> BasicBlock <strong>*</strong> mn_endloop <strong>=</strong> BasicBlock <strong>::</strong> Create(Context, <font color="#bb8844">"End_loop"</font> , func_main); <br> <font color="gray">164:</font> <br> <font color="gray">165:</font> mainIR.CreateBr(mn_testloop); <br> <font color="gray">166:</font> mainIR.SetInsertPoint(mn_testloop); <br> <font color="gray">167:</font> PHINode <strong>*</strong> maini <strong>=</strong> mainIR.CreatePHI(i32Type, <font color="#bb8844">"i"</font> ); <br> <font color="gray">168:</font> maini <strong>-&gt;</strong> addIncoming(zero, mnblock); <br> <font color="gray">169:</font> Value <strong>*</strong> mainloopcond <strong>=</strong> mainIR.CreateICmpUGT(maini, n100000, <font color="#bb8844">"loop_cond"</font> ); <br> <font color="gray">170:</font> mainIR.CreateCondBr(mainloopcond, mn_endloop, mn_tloopbody); <br> <font color="gray">171:</font> mainIR.SetInsertPoint(mn_tloopbody); <br> <font color="gray">172:</font> mainIR.CreateCall(func_ef, n50000); <br> <font color="gray">173:</font> Value <strong>*</strong> maininext <strong>=</strong> mainIR.CreateAdd(maini, one, <font color="#bb8844">"i.next"</font> ); <br> <font color="gray">174:</font> maini <strong>-&gt;</strong> addIncoming(maininext, mn_tloopbody); <br> <font color="gray">175:</font> mainIR.CreateBr(mn_testloop); <br> <font color="gray">176:</font> mainIR.SetInsertPoint(mn_endloop); <br> <font color="gray">177:</font> mainIR.CreateRetVoid(); <br> <font color="gray">178:</font> <br> <font color="gray">179:</font> TheModule <strong>-&gt;</strong> dump(); <br> <font color="gray">180:</font> <br> <font color="gray">181:</font> <font color="#445588"><strong>void</strong></font> <strong>*</strong> FPtr <strong>=</strong> TheExecutionEngine <strong>-&gt;</strong> getPointerToFunction(func_main); <br> <font color="gray">182:</font> <font color="#445588"><strong>void</strong></font> ( <strong>*</strong> FP) () <strong>=</strong> ( <font color="#445588"><strong>void</strong></font> ( <strong>*</strong> )()) FPtr; <br> <font color="gray">183:</font> FP(); <br> <font color="gray">184:</font> } <br> <font color="gray">185:</font></code> </blockquote> <br><br>  So, we compare: <br><br>  <b>By verbosity</b> - almost nostril in the nostril.  Both here and there you can throw out a couple of lines / comments or add a couple of lines, but this does not make the weather - the size of the code is about the same. <br><br>  <b>By speed</b> - <br>  LibJit option: <br><br> <code>walrus@home:~/sand/erato$ gcc t2_test.c -o ts -ljit <br> walrus@home:~/sand/erato$ for i in `seq 1 10`; do /usr/bin/time -f '%U' ./ts; done <br> 14.22 <br> 14.17 <br> 14.12 <br> 14.19 <br> 14.18 <br> 14.24 <br> 14.15 <br> 14.14 <br> 14.15 <br> 14.15 <br></code> <br>  Average 14.17 seconds <br><br>  LLVM option - <br> <code>walrus@home:~/sand/erato/llvm$ g++ ts.cc -o ts `llvm-config --cxxflags --libs` -lrt -ldl <br> walrus@home:~/sand/erato/llvm$ for i in `seq 1 10`; do /usr/bin/time -f '%U' ./ts; done <br> 13.83 <br> 13.75 <br> 13.82 <br> 13.76 <br> 13.76 <br> 13.78 <br> 13.76 <br> 13.76 <br> 13.76 <br> 13.76 <br></code> <br>  The average is 13.77 seconds. <br><br>  The difference was 2.88% in favor of llvm. <br><br>  By the way, a similar C program prepared with gcc -O1 gave the same 13.79 seconds. <br><br>  <b>On ambush</b> - llvm unpleasant features unnoticed.  Do libjit - this dog does not save the value of registers when calling a function!  All that is needed to remain intact, it is better to keep in memory before calling any function.  As its jibjit-ovskoy, and external.  I didn't find it in the documentation, and spent a couple of hours trying to understand what kind of trouble it was.  The problem was finally clarified only by viewing the generated assembler. <br><br><h4>  Morality </h4><br><br>  Uh ... I can't figure out what the moral is here </div><p>Source: <a href="https://habr.com/ru/post/99786/">https://habr.com/ru/post/99786/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../99773/index.html">New Skype for iPhone with multitasking and abandonment of plans to introduce a charge for 3G calls</a></li>
<li><a href="../99775/index.html">Revolution begins today</a></li>
<li><a href="../99780/index.html">New version of first-person shooter Sauerbraten - Justice Edition</a></li>
<li><a href="../99781/index.html">Commentary of the day: Reanimation!</a></li>
<li><a href="../99782/index.html">How to build a Rubik's Cube 5x5x5 (part 2)</a></li>
<li><a href="../99787/index.html">I ‚ô• Nokia?</a></li>
<li><a href="../99792/index.html">Asynchrony: why it does not do it right?</a></li>
<li><a href="../99794/index.html">Setting the time limit of the script</a></li>
<li><a href="../99797/index.html">Handy Light. How a teenager tricked Apple</a></li>
<li><a href="../99801/index.html">Eco-print</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>