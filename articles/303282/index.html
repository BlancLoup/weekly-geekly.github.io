<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Yandex opens ClickHouse</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today, the internal development of the company Yandex - analytical ClickHouse database , has become available to everyone. Sources are published on Gi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Yandex opens ClickHouse</h1><div class="post__text post__text-html js-mediator-article">  Today, the internal development of the company Yandex - <a href="https://clickhouse.yandex/">analytical ClickHouse database</a> , has become available to everyone.  Sources are published on <a href="https://github.com/yandex/ClickHouse">GitHub</a> under the Apache 2.0 license. <br><br> <a href="https://habrahabr.ru/company/yandex/blog/303282/"><img src="https://habrastorage.org/files/d9b/066/e61/d9b066e61e1f480a977d889dc03ded99.png"><br></a> <br>  ClickHouse allows you to perform analytical queries online using real-time updated data.  The system can scale up to tens of trillion records and petabytes of stored data.  Using ClickHouse opens up opportunities that were previously even hard to imagine: you can save the entire data stream without prior aggregation and quickly receive reports in any sections.  ClickHouse was developed in Yandex for the tasks of <a href="https://metrika.yandex.ru/">Yandex. Metrics</a> - the second largest web analytics system in the world. <br><br>  In this article, we will explain how and why ClickHouse appeared in Yandex and what it can do;  Let's compare it with other systems and show how to raise it in ourselves with minimal effort. <br><a name="habracut"></a><br><h1>  Where is the ClickHouse niche </h1><br>  Why would someone need to use ClickHouse when there are many other technologies for working with big data? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If you just need to keep logs, you have many options.  You can upload logs to Hadoop, analyze them using Hive, Spark or Impala.  In this case, it is not at all necessary to use ClickHouse.  Everything becomes more complicated if you need to perform online requests for non-aggregated data coming into the system in real time.  To solve this problem, open technologies of suitable quality still did not exist. <br><br>  There are separate areas in which other systems can be used.  They can be classified as follows: <br><br><ol><li>  Commercial OLAP DBMS for use in its own infrastructure. <br>  Examples: <a href="http://www8.hp.com/ru/ru/software-solutions/advanced-sql-big-data-analytics/">HP Vertica</a> , <a href="http://www.actian.com/products/big-data-analytics-platforms-with-hadoop/vector-smp-analytics-database/">Actian Vector</a> , <a href="http://www.actian.com/products/big-data-analytics-platforms-with-hadoop/matrix-mpp-analytics-databases/">Actian Matrix</a> , <a href="http://www.exasol.com/en/">EXASol</a> , <a href="https://go.sap.com/cis/cmp/ppc/crm-ru15-3di-ppc-it-a2/index.html">Sybase IQ</a> and others. <br>  Our differences: we made the technology open and free. <br><br></li><li>  Cloud solutions. <br>  Examples: <a href="http://aws.amazon.com/redshift/">Amazon Redshift</a> and <a href="https://cloud.google.com/bigquery/">Google BigQuery</a> . <br>  Our differences: the client can use ClickHouse in its infrastructure and not pay for the clouds. <br><br></li><li>  Add-ins over Hadoop. <br>  Examples: <a href="http://impala.io/">Cloudera Impala</a> , <a href="http://spark.apache.org/sql/">Spark SQL</a> , <a href="https://prestodb.io/">Facebook Presto</a> , <a href="https://drill.apache.org/">Apache Drill</a> . <br>  Our differences: <br><ul><li>  Unlike Hadoop, ClickHouse allows you to serve analytical queries even as part of a publicly available public service such as Yandex.Metrica; </li><li>  ClickHouse does not need to deploy Hadoop infrastructure to function, it is easy to use, and even suitable for small projects; </li><li>  ClickHouse allows you to download data in real time and independently deals with their storage and indexing; </li><li>  Unlike Hadoop, ClickHouse works in geographically distributed data centers. </li></ul><br></li><li>  Open-source OLAP DBMS. <br>  Examples: <a href="https://github.com/infinidb/infinidb">InfiniDB</a> , <a href="https://www.monetdb.org/">MonetDB</a> , <a href="https://github.com/LucidDB/luciddb">LucidDB</a> . <br>  The development of all these projects has been abandoned; they have never been mature enough and, in fact, never left the alpha version.  These systems were not distributed, which is critical for processing large data.  The active development of ClickHouse, the maturity of technology and the orientation to the practical needs arising from the processing of big data are provided by the tasks of Yandex.  Without the use of ‚Äúin combat‚Äù on real tasks that go beyond the capabilities of existing systems, it would be impossible to create a quality product. <br><br></li><li>  Open-source systems for analytics, non-Relational OLAP DBMS. <br>  Examples: <a href="http://druid.io/">Metamarkets Druid</a> , <a href="http://kylin.apache.org/">Apache Kylin</a> . <br>  Our differences: ClickHouse does not require data pre-aggregation.  ClickHouse supports the SQL language dialect and provides the convenience of relational databases. <br></li></ol><br>  As part of the rather narrow niche in which ClickHouse is located, it still has no alternatives.  Within the wider field of application, ClickHouse may be more profitable than other systems in terms of <a href="https://clickhouse.yandex/benchmark.html">request processing speed</a> , resource efficiency and ease of operation. <br><br><img src="https://habrastorage.org/files/37e/1b6/556/37e1b65562844a7a9c2477f9b5f7cda1.png"><br>  <i>Map of clicks in Yandex. Metric and the corresponding request in ClickHouse</i> <br><br>  Initially, we developed ClickHouse exclusively for <a href="https://metrika.yandex.ru/">Yandex.Metrica</a> tasks - in order to build reports interactively using non-aggregated logs of user actions.  Due to the fact that the system is a full-fledged DBMS and has a very broad functionality, already at the beginning of its use in 2012, <a href="https://clickhouse.yandex/reference_ru.html">detailed documentation</a> was written.  This distinguishes ClickHouse from many typical internal developments ‚Äî specialized and embedded data structures for solving specific problems, such as, for example, Metrage and OLAPServer, which I described in a <a href="http://habrahabr.ru/company/yandex/blog/273305/">previous article</a> . <br><br>  The developed functionality and availability of detailed documentation has led to the fact that ClickHouse has gradually spread to many departments of Yandex.  Suddenly it turned out that the system can be installed according to the instructions and works out of the box, that is, does not require the involvement of developers.  ClickHouse was used in Direct, Market, Mail, AdFox, Webmasters, in monitoring and in business analytics.  ClickHouse allowed either to solve problems for which there were no suitable tools before, or to solve tasks by orders of magnitude more efficiently than other systems. <br><br>  Gradually, there was a demand for the use of ClickHouse, not only in the internal products of Yandex.  For example, in 2013, ClickHouse was used to analyze metadata about the events of the <a href="https://www.yandex.com/company/press_center/press_releases/2012/2012-04-10/">LHCb experiment at CERN</a> .  The system could be used more widely, but at the time this was hindered by a closed status.  Another example: Yandex‚Äôs open-source <a href="https://tech.yandex.ru/tank/">Yandex.Tank</a> technology uses ClickHouse for storing telemetry data, whereas for external users only MySQL was available as a database, which is poorly suited for this task. <br><br>  As the user base expanded, it became necessary to spend a little more effort on the development, although not very much as compared to the effort required to solve the Metric tasks.  But as a reward we get improved product quality, especially in terms of usability. <br><br>  Expansion of the user base allows us to consider examples of use, which without this would hardly have occurred to me.  It also allows you to quickly find bugs and inconveniences that are important, including for the main use of ClickHouse, in Metric.  Without a doubt, all this improves the quality of the product.  Therefore, it is beneficial for us to make ClickHouse open today. <br><br><h1>  How to stop being afraid and start using ClickHouse </h1><br>  Let's try working with ClickHouse on the example of ‚Äútoy‚Äù open data - information on air travel in the United States from 1987 to 2015.  This cannot be called big data (only 166 million lines, 63 GB of uncompressed data), but you can quickly download them and start experimenting.  You can download data <a href="https://yadi.sk/d/pOZxpa42sDdgm">from here</a> . <br><br>  Data can also be downloaded from the source.  How to do this is written <a href="https://github.com/yandex/ClickHouse/raw/master/doc/example_datasets/1_ontime.txt">here</a> . <br><br>  First, install ClickHouse on one server.  Below you will also see how to install ClickHouse on a cluster with sharding and replication. <br><br>  On Ubuntu and Debian Linux, you can install ClickHouse from <a href="https://clickhouse.yandex/">prebuilt packages</a> .  On other Linux-based systems, you can <a href="">build ClickHouse from source</a> and install it yourself. <br><br>  The clickhouse-client package contains the <a href="https://clickhouse.yandex/reference_ru.html">clickhouse-client</a> program, a ClickHouse client for working interactively.  The clickhouse-server-base package contains a clickhouse-server binary, and clickhouse-server-common contains configuration files for the server. <br><br>  Server configuration files are in / etc / clickhouse-server /.  The main thing you should pay attention to before starting work is the path element - the place where data is stored.  It is not necessary to directly modify the config.xml file ‚Äî this is not very convenient when updating packages.  Instead, you can override the desired items <a href="https://clickhouse.yandex/reference_ru.html">in the files in the config.d directory</a> . <br>  It also makes sense to pay attention to the <a href="https://clickhouse.yandex/reference_ru.html">settings of access rights</a> . <br><br>  The server does not start itself when installing the package and does not restart itself when updating. <br>  To start the server, run: <br><br><pre><code class="bash">sudo service clickhouse-server start</code></pre><br>
   -   /var/log/clickhouse-server/.<br>
   Ready for connections  ,    .<br>
<br>
   ,   clickhouse-client.<br>
<br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text">   :<br>
<pre><code class="bash">
clickhouse-client
clickhouse-client --host=... --port=... --user=... --password=...
</code></pre><br>
  :<br>
<pre><code class="bash">
clickhouse-client -m
clickhouse-client --multiline
</code></pre><br>
   batch :<br>
<pre><code class="bash">
clickhouse-client --query='SELECT 1'
echo 'SELECT 1' | clickhouse-client
</code></pre><br>
    :<br>
<pre><code class="bash">
clickhouse-client --query='INSERT INTO table VALUES' &lt; data.txt
clickhouse-client --query='INSERT INTO table FORMAT TabSeparated' &lt; data.tsv
</code></pre><br>
</div></div><br>
<br>
<h3>    </h3><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="bash">
$ clickhouse-client --multiline
ClickHouse client version 0.0.53720.
Connecting to localhost:9000.
Connected to ClickHouse server version 0.0.53720.

:) CREATE TABLE ontime
(
    Year UInt16,
    Quarter UInt8,
    Month UInt8,
    DayofMonth UInt8,
    DayOfWeek UInt8,
    FlightDate Date,
    UniqueCarrier FixedString(7),
    AirlineID Int32,
    Carrier FixedString(2),
    TailNum String,
    FlightNum String,
    OriginAirportID Int32,
    OriginAirportSeqID Int32,
    OriginCityMarketID Int32,
    Origin FixedString(5),
    OriginCityName String,
    OriginState FixedString(2),
    OriginStateFips String,
    OriginStateName String,
    OriginWac Int32,
    DestAirportID Int32,
    DestAirportSeqID Int32,
    DestCityMarketID Int32,
    Dest FixedString(5),
    DestCityName String,
    DestState FixedString(2),
    DestStateFips String,
    DestStateName String,
    DestWac Int32,
    CRSDepTime Int32,
    DepTime Int32,
    DepDelay Int32,
    DepDelayMinutes Int32,
    DepDel15 Int32,
    DepartureDelayGroups String,
    DepTimeBlk String,
    TaxiOut Int32,
    WheelsOff Int32,
    WheelsOn Int32,
    TaxiIn Int32,
    CRSArrTime Int32,
    ArrTime Int32,
    ArrDelay Int32,
    ArrDelayMinutes Int32,
    ArrDel15 Int32,
    ArrivalDelayGroups Int32,
    ArrTimeBlk String,
    Cancelled UInt8,
    CancellationCode FixedString(1),
    Diverted UInt8,
    CRSElapsedTime Int32,
    ActualElapsedTime Int32,
    AirTime Int32,
    Flights Int32,
    Distance Int32,
    DistanceGroup UInt8,
    CarrierDelay Int32,
    WeatherDelay Int32,
    NASDelay Int32,
    SecurityDelay Int32,
    LateAircraftDelay Int32,
    FirstDepTime String,
    TotalAddGTime String,
    LongestAddGTime String,
    DivAirportLandings String,
    DivReachedDest String,
    DivActualElapsedTime String,
    DivArrDelay String,
    DivDistance String,
    Div1Airport String,
    Div1AirportID Int32,
    Div1AirportSeqID Int32,
    Div1WheelsOn String,
    Div1TotalGTime String,
    Div1LongestGTime String,
    Div1WheelsOff String,
    Div1TailNum String,
    Div2Airport String,
    Div2AirportID Int32,
    Div2AirportSeqID Int32,
    Div2WheelsOn String,
    Div2TotalGTime String,
    Div2LongestGTime String,
    Div2WheelsOff String,
    Div2TailNum String,
    Div3Airport String,
    Div3AirportID Int32,
    Div3AirportSeqID Int32,
    Div3WheelsOn String,
    Div3TotalGTime String,
    Div3LongestGTime String,
    Div3WheelsOff String,
    Div3TailNum String,
    Div4Airport String,
    Div4AirportID Int32,
    Div4AirportSeqID Int32,
    Div4WheelsOn String,
    Div4TotalGTime String,
    Div4LongestGTime String,
    Div4WheelsOff String,
    Div4TailNum String,
    Div5Airport String,
    Div5AirportID Int32,
    Div5AirportSeqID Int32,
    Div5WheelsOn String,
    Div5TotalGTime String,
    Div5LongestGTime String,
    Div5WheelsOff String,
    Div5TailNum String
)
ENGINE = MergeTree(FlightDate, (Year, FlightDate), 8192);
</code></pre><br>
</div></div><br>
    <a href="https://clickhouse.yandex/reference_ru.html">MergeTree</a>.   MergeTree      .     ,     ,         .<br>
<br>
,               -,          ,       ,       .<br>
<br>
<h3>   </h3><br>
<pre><code class="bash">xz -v -c -d &lt; ontime.csv.xz | clickhouse-client --query="INSERT INTO ontime FORMAT CSV"</code></pre><br>
 INSERT  ClickHouse      <a href="https://clickhouse.yandex/reference_ru.html"> </a>.       O(1) .    INSERT     .     <a href="https://clickhouse.yandex/reference_ru.html">    </a>.        max_insert_block_size (= 1&nbsp;048&nbsp;576   ),  :     ,    .       ,    ,    .   exactly-once ,  <a href="https://clickhouse.yandex/reference_ru.html"> </a>,  :          ,    ,       .        localhost,         exactly-once .<br>
<br>
 INSERT    MergeTree  ,    SELECT.              SELECT-.<br>
<br>
       ,       String ,    <a href="https://clickhouse.yandex/reference_ru.html">Enum</a>   .        (:   ,   ),    ,    Enum-  .      (:  , URL),     String.<br>
<br>
-, ,          Year, Quarter, Month, DayOfMonth, DayOfWeek,     FlightDate.  ,       ,         ,    .   ClickHouse    ,   <a href="https://clickhouse.yandex/reference_ru.html"> </a>  . ,    :   ClickHouse ‚Äî  <a href="https://en.wikipedia.org/wiki/Column-oriented_DBMS"> </a>,          .   ‚Äî    ClickHouse.<br>
<br>
<h3>    </h3><br>
<br>
<ul>
<li><div class="spoiler"><b class="spoiler_title">      2015 ;</b><div class="spoiler_text"><pre><code class="sql">SELECT
    OriginCityName,
    DestCityName,
    count(*) AS flights,
    bar(flights, 0, 20000, 40)
FROM ontime WHERE Year = 2015 GROUP BY OriginCityName, DestCityName ORDER BY flights DESC LIMIT 20
</code></pre><img src="https://habrastorage.org/files/a85/18a/200/a8518a200d6d405a95ee80ea1c8e1c90.png"><br>
<pre><code class="sql">SELECT
    OriginCityName &lt; DestCityName ? OriginCityName : DestCityName AS a,
    OriginCityName &lt; DestCityName ? DestCityName : OriginCityName AS b,
    count(*) AS flights,
    bar(flights, 0, 40000, 40)
FROM ontime WHERE Year = 2015 GROUP BY a, b ORDER BY flights DESC LIMIT 20
</code></pre><img src="https://habrastorage.org/files/d35/78d/b55/d3578db55e304bd7b5eba818abdb53f5.png"><br>
</div></div><br>
</li>
<li><div class="spoiler"><b class="spoiler_title">     ;</b><div class="spoiler_text"><pre><code class="sql">SELECT OriginCityName, count(*) AS flights FROM ontime GROUP BY OriginCityName ORDER BY flights DESC LIMIT 20
</code></pre><img src="https://habrastorage.org/files/ef4/141/f34/ef4141f348234773a5349c4bd3e8f804.png"></div></div><br>
</li>
<li><div class="spoiler"><b class="spoiler_title">        ;</b><div class="spoiler_text"><pre><code class="sql">SELECT OriginCityName, uniq(Dest) AS u FROM ontime GROUP BY OriginCityName ORDER BY u DESC LIMIT 20
</code></pre><img src="https://habrastorage.org/files/240/9f4/9d1/2409f49d11fb4aa1b8b5ff34cf9ca75d.png"></div></div><br>
</li>
<li><div class="spoiler"><b class="spoiler_title">       ;</b><div class="spoiler_text"><pre><code class="sql">SELECT DayOfWeek, count() AS c, avg(DepDelay &gt;  60) AS delays FROM ontime GROUP BY DayOfWeek ORDER BY DayOfWeek
</code></pre><img src="https://habrastorage.org/files/885/e50/793/885e507930e34b7c8f788d25e7ca2bcf.png"></div></div><br>
</li>
<li><div class="spoiler"><b class="spoiler_title">  ,         ;</b><div class="spoiler_text"><pre><code class="sql">SELECT OriginCityName, count() AS c, avg(DepDelay &gt;  60) AS delays
FROM ontime
GROUP BY OriginCityName
HAVING c &gt;  100000
ORDER BY delays DESC
LIMIT 20
</code></pre><img src="https://habrastorage.org/files/ac2/926/56d/ac292656d03946d0aba35c75783a31f2.png"></div></div><br>
</li>
<li><div class="spoiler"><b class="spoiler_title">   ;</b><div class="spoiler_text"><pre><code class="sql">SELECT OriginCityName, DestCityName, count(*) AS flights, avg(AirTime) AS duration
FROM ontime
GROUP BY OriginCityName, DestCityName
ORDER BY duration DESC
LIMIT 20
</code></pre><img src="https://habrastorage.org/files/7b3/c2e/685/7b3c2e685832439b8c373bf2015131d2.png"></div></div><br>
</li>
<li><div class="spoiler"><b class="spoiler_title">   ,  ;</b><div class="spoiler_text"><pre><code class="sql">SELECT Carrier, count() AS c, round(quantileTDigest(0.99)(DepDelay), 2) AS q
FROM ontime GROUP BY Carrier ORDER BY q DESC
</code></pre><img src="https://habrastorage.org/files/49c/332/e3d/49c332e3d93146ba8f46beef6b2b02b0.png"></div></div><br>
</li>
<li><div class="spoiler"><b class="spoiler_title">   ;</b><div class="spoiler_text"><pre><code class="sql">SELECT Carrier, min(Year), max(Year), count()
FROM ontime GROUP BY Carrier HAVING max(Year) &lt; 2015 ORDER BY count() DESC
</code></pre><img src="https://habrastorage.org/files/249/56f/1a2/24956f1a2efc48d78212586958aa036c.png"></div></div><br>
</li>
<li><div class="spoiler"><b class="spoiler_title">       2015 ;</b><div class="spoiler_text"><pre><code class="sql">SELECT
    DestCityName,
    sum(Year = 2014) AS c2014,
    sum(Year = 2015) AS c2015,
    c2015 / c2014 AS diff
FROM ontime
WHERE Year IN (2014, 2015)
GROUP BY DestCityName
HAVING c2014 &gt;  10000 AND c2015 &gt;  1000 AND diff &gt;  1
ORDER BY diff DESC
</code></pre><img src="https://habrastorage.org/files/f31/32f/4d1/f3132f4d1c0d42eab26d9111afe7771a.png"></div></div><br>
</li>
<li><div class="spoiler"><b class="spoiler_title">       .</b><div class="spoiler_text"><pre><code class="sql">SELECT
    DestCityName,
    any(total),
    avg(abs(monthly * 12 - total) / total) AS avg_month_diff
FROM
(
    SELECT DestCityName, count() AS total
    FROM ontime GROUP BY DestCityName HAVING total &gt; 100000
)
ALL INNER JOIN
(
    SELECT DestCityName, Month, count() AS monthly
    FROM ontime GROUP BY DestCityName, Month HAVING monthly &gt; 10000
)
USING DestCityName
GROUP BY DestCityName
ORDER BY avg_month_diff DESC
LIMIT 20
</code></pre><img src="https://habrastorage.org/files/26b/2c7/aae/26b2c7aae21a4c76800cb1c7a33a374d.png"></div></div><br>
</li>
</ul><br>
<br>
<h3>  ClickHouse     </h3><br>
      ClickHouse  ,   .    ClickHouse    ,       ,          <a href="https://clickhouse.yandex/reference_ru.html">Distributed-</a>.<br>
<br>
<a href="https://clickhouse.yandex/reference_ru.html">Distributed-</a>   ¬´¬ª      ClickHouse.  SELECT-       ,      .           Distributed-,     .<br>
<br>
<div class="spoiler"><b class="spoiler_title">    ,          </b><div class="spoiler_text"><pre><code class="xml">&lt;remote_servers&gt;
    &lt;perftest_3shards_1replicas&gt;
        &lt;shard&gt;
            &lt;replica&gt;
                &lt;host&gt;example-perftest01j.yandex.ru&lt;/host&gt;
                &lt;port&gt;9000&lt;/port&gt;
            &lt;/replica&gt;
        &lt;/shard&gt;
        &lt;shard&gt;
            &lt;replica&gt;
                &lt;host&gt;example-perftest02j.yandex.ru&lt;/host&gt;
                &lt;port&gt;9000&lt;/port&gt;
            &lt;/replica&gt;
        &lt;/shard&gt;
        &lt;shard&gt;
            &lt;replica&gt;
                &lt;host&gt;example-perftest03j.yandex.ru&lt;/host&gt;
                &lt;port&gt;9000&lt;/port&gt;
            &lt;/replica&gt;
        &lt;/shard&gt;
    &lt;/perftest_3shards_1replicas&gt;
&lt;/remote_servers&gt;
</code></pre><br>
</div></div><br>
  :<br>
<pre><code class="sql">CREATE TABLE ontime_local (...) ENGINE = MergeTree(FlightDate, (Year, FlightDate), 8192);</code></pre><br>
  ,       :<br>
<pre><code class="sql">CREATE TABLE ontime_all AS ontime_local ENGINE = Distributed(perftest_3shards_1replicas, default, ontime_local, rand());</code></pre><br>
   Distributed-     ‚Äî     ,       .  Distributed-     <a href="https://clickhouse.yandex/reference_ru.html">  remote</a>.<br>
<br>
 ,      ,  <a href="https://clickhouse.yandex/reference_ru.html">INSERT SELECT</a>  Distributed-.<br>
<br>
<pre><code class="sql">INSERT INTO ontime_all SELECT * FROM ontime;</code></pre><br>
,     ,    ,      <a href="https://clickhouse.yandex/reference_ru.html"> </a>.<br>
<br>
  , -       ,      ,    . <div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><img src="https://habrastorage.org/files/ece/020/129/ece020129fdf4a18a6e75daf2e699cb9.png"><br>
<br>
 ,      .   ,    <a href="https://github.com/tdunning/t-digest/raw/master/docs/t-digest-paper/histo.pdf">t-digest</a>   ‚Äî     .</div></div><br>
        ,       .               ,    -. (   .)<br>
<br>
<div class="spoiler"><b class="spoiler_title">    ,       </b><div class="spoiler_text"><pre><code class="xml">&lt;remote_servers&gt;
    ...
    &lt;perftest_1shards_3replicas&gt;
        &lt;shard&gt;
            &lt;replica&gt;
                &lt;host&gt;example-perftest01j.yandex.ru&lt;/host&gt;
                &lt;port&gt;9000&lt;/port&gt;
             &lt;/replica&gt;
             &lt;replica&gt;
                &lt;host&gt;example-perftest02j.yandex.ru&lt;/host&gt;
                &lt;port&gt;9000&lt;/port&gt;
             &lt;/replica&gt;
             &lt;replica&gt;
                &lt;host&gt;example-perftest03j.yandex.ru&lt;/host&gt;
                &lt;port&gt;9000&lt;/port&gt;
             &lt;/replica&gt;
        &lt;/shard&gt;
    &lt;/perftest_1shards_3replicas&gt;
&lt;/remote_servers&gt;
</code></pre><br>
</div></div><br>
   (    )  <a href="http://zookeeper.apache.org/">ZooKeeper</a>. ClickHouse            .    ZooKeeper   .<br>
<br>
    ZooKeeper  :        ,      ,      .      ‚Äî     ClickHouse       .<br>
<br>
<div class="spoiler"><b class="spoiler_title">  ZooKeeper   </b><div class="spoiler_text"><pre><code class="xml">&lt;zookeeper-servers&gt;
    &lt;node&gt;
        &lt;host&gt;zoo01.yandex.ru&lt;/host&gt;
        &lt;port&gt;2181&lt;/port&gt;
    &lt;/node&gt;
    &lt;node&gt;
        &lt;host&gt;zoo02.yandex.ru&lt;/host&gt;
        &lt;port&gt;2181&lt;/port&gt;
    &lt;/node&gt;
    &lt;node&gt;
        &lt;host&gt;zoo03.yandex.ru&lt;/host&gt;
        &lt;port&gt;2181&lt;/port&gt;
    &lt;/node&gt;
&lt;/zookeeper-servers&gt;
</code></pre><br>
</div></div><br>
  ,     ‚Äî      .<br>
<br>
<pre><code class="xml">&lt;macros&gt;
    &lt;shard&gt;01&lt;/shard&gt;
    &lt;replica&gt;01&lt;/replica&gt;
&lt;/macros&gt;
</code></pre><br>
        ,    ,    ‚Äî   ,     .       -      ,     ,     ‚Äî        .<br>
<br>
<pre><code class="sql">CREATE TABLE ontime_replica (...)
ENGINE = ReplicatedMergeTree(
    '/clickhouse_perftest/tables/{shard}/ontime',
    '{replica}',
    FlightDate,
    (Year, FlightDate),
    8192);
</code></pre><br>
 ,      <a href="https://clickhouse.yandex/reference_ru.html">ReplicatedMergeTree</a>,       ZooKeeper,   ,    .<br>
<br>
<pre><code class="sql">INSERT INTO ontime_replica SELECT * FROM ontime;</code></pre><br>
    multi-master.       ,       .    ,     ,        .   ,      .             .         .<br>
<br>
<h1>    ClickHouse</h1><br>
    ,           <a href="http://stackoverflow.com/">StackOverflow</a>   ¬´clickhouse¬ª.         <a href="https://groups.google.com/group/clickhouse"></a>       clickhouse-feedback@yandex-team.ru.        ClickHouse ,       .    <a href="https://yandex.ru/jobs/vacancies/dev/%3Ftags%3Dc%252B%252B"></a>  <a href="https://yandex.ru/jobs/vacancies/interns/summer"></a>.</div><p>Source: <a href="https://habr.com/ru/post/303282/">https://habr.com/ru/post/303282/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303272/index.html">Free school for Android developers in Kazan</a></li>
<li><a href="../303274/index.html">Social network for refrigerators, microwaves and toasters</a></li>
<li><a href="../303276/index.html">Introducing Kerio Control 9.1</a></li>
<li><a href="../303278/index.html">OFFF 2016</a></li>
<li><a href="../303280/index.html">Reasons for leaving Amazon, Northrop Grumman, Salesforce offline server farms</a></li>
<li><a href="../303284/index.html">We invite you to the Microsoft BI User Group, the topic of the meeting is ‚Äúworking with 1C effectively‚Äù</a></li>
<li><a href="../303286/index.html">Black Box Challenge Summary</a></li>
<li><a href="../303288/index.html">On Habr√© opened the registration of full accounts?</a></li>
<li><a href="../303290/index.html">Tony Robbins seminar review ‚ÄúFree your inner strength‚Äù. Day 4. The power of clean energy (part 1)</a></li>
<li><a href="../303292/index.html">This Friday will be the 7th DevConf 2016 Community Conference</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>