<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Performance analysis of individual subsystems of the program for Linux perf report</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Usually, to prepare a profiling report on Linux, I used only the simplest options for running perf report (the performance data itself should be obtai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Performance analysis of individual subsystems of the program for Linux perf report</h1><div class="post__text post__text-html js-mediator-article"><p> Usually, to prepare a profiling report on Linux, I used only the simplest options for running <code>perf report</code> (the performance data itself should be obtained before <code>perf report</code> started with the <code>perf record</code> command, <a href="http://stackoverflow.com/questions/1777556/alternatives-to-gprof/10958510">here you can read more with an example</a> ): </p><br><p>  Module report: </p><br><pre> <code class="bash hljs">$ perf report --stdio --kallsyms=/boot/System.map-$(uname -r) --sort=dso -g none</code> </pre> <br><p>  Feature Report: </p><br><pre> <code class="bash hljs">perf report -g none --stdio --kallsyms=/boot/System.map-$(uname -r)</code> </pre> <br><p>  Function report with callgraph construction: </p><br><pre> <code class="bash hljs">perf report --stdio --kallsyms=/boot/System.map-$(uname -r) -g</code> </pre> <br><p>  For many situations, such reports were enough to find performance problems.  However, some time ago I was faced with a situation where the callgraph report showed a very large call tree and it was difficult to understand. </p><a name="habracut"></a><br><p>  For a better understanding of the performance report, I wanted to break it into separate reports that would correspond exactly to the program's subsystems: </p><br><ol><li>  Subsystem receiving messages, the main function: <code>amqp_service::on_message()</code> </li><li>  Message processing subsystem, main function: <code>input_handler::execute()</code> </li><li>  Notification distribution subsystem, main function: <code>event_handler::on_msg()</code> </li></ol><br><p>  It turned out that Linux perf has a key that allows you to select only events related to one function in the call stack: </p><br><pre> <code class="bash hljs"> -p, --parent=&lt;regex&gt; A regex filter to identify parent. The parent is a <span class="hljs-built_in"><span class="hljs-built_in">caller</span></span> of this <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> and searched through the callchain, thus it requires callchain information recorded. The pattern is <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the exteneded regex format and defaults to <span class="hljs-string"><span class="hljs-string">"^sys_|^do_page_fault"</span></span></code> </pre> <br><p>  This key allowed me to analyze the performance separately for each function important to me.  Previously, it must be said that according to the report, the total number of events in perf.dat was: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Event count (approx.): 72784958041</span></span></code> </pre> <br><h4 id="analiz-amqp_serviceon_message">  Analysis amqp_service :: on_message () </h4><br><p>  Building a report on amqp_service :: on_message (): </p><br><pre> <code class="bash hljs">$ perf report -x --stdio --kallsyms=/boot/System.map-$(uname -r) \ -g -p <span class="hljs-string"><span class="hljs-string">"amqp_service::on_message"</span></span></code> </pre> <br><p>  The number of events with this filter </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Event count (approx.): 1590851860</span></span></code> </pre> <br><p>  It turns out that 1590851860 events are approximately 2% of the total number of events 72784958041. That is, this function did not generate many events even under heavy load.  Just in case, I look at what functions were in the top, when <code>amqp_service::on_message()</code> and whether or not there was <code>pthread_mutex_lock()/pthread_mutex_unlock()</code> in the top: </p><br><pre> <code class="bash hljs">$ perf report -x --stdio --kallsyms=/boot/System.map-$(uname -r) \ -g -p <span class="hljs-string"><span class="hljs-string">"amqp_service::on_message"</span></span> | \ grep -E -e <span class="hljs-string"><span class="hljs-string">"^[ ]+[0-9]"</span></span> | sed -re <span class="hljs-string"><span class="hljs-string">'s/[ ]+data_provider::.*+$//'</span></span> | head 29.38% data_provider [kernel.kallsyms] [k] clear_page_c 11.09% data_provider libc-2.12.so [.] memcpy 6.01% data_provider [kernel.kallsyms] [k] __alloc_pages_nodemask 5.27% data_provider [kernel.kallsyms] [k] compact_zone 4.44% data_provider [kernel.kallsyms] [k] page_fault 4.08% data_provider [kernel.kallsyms] [k] get_pageblock_flags_group 4.05% data_provider [kernel.kallsyms] [k] __reset_isolation_suitable 3.55% data_provider [kernel.kallsyms] [k] compaction_alloc 1.78% data_provider libpthread-2.12.so [.] pthread_mutex_lock 1.61% data_provider [kernel.kallsyms] [k] __mem_cgroup_commit_charge</code> </pre> <br><p>  From this data and the full report with callgraph for <code>amqp_service::on_message()</code> I see that under load, the function basically spends time copying messages.  Blocking on mutexes in this function is not a problem, only 1.8% under load, there is no large contention on mutexes in this function and in functions called from it according to the report. </p><br><h4 id="analiz-funkcii-input_handlerexecute">  Analysis of the function input_handler :: execute (). </h4><br><p>  Building a report for this particular function: </p><br><pre> <code class="bash hljs">$ perf report -x --stdio --kallsyms=/boot/System.map-$(uname -r) \ -g -p <span class="hljs-string"><span class="hljs-string">"input_handler::execute"</span></span></code> </pre> <br><p>  Number of events with this filter: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Event count (approx.): 16423187486</span></span></code> </pre> <br><p>  It turns out that 16423187486 events are 22% of the total number of events 72784958041. This is already a large amount of work regarding the total number of events of the perf and here I looked more closely at where the algorithm spends time. </p><br><pre> <code class="bash hljs">$ perf report -x --stdio --kallsyms=/boot/System.map-$(uname -r) \ -g -p <span class="hljs-string"><span class="hljs-string">"input_handler::execute"</span></span> | \ grep -E -e <span class="hljs-string"><span class="hljs-string">"^[ ]+[0-9]"</span></span> | sed -re <span class="hljs-string"><span class="hljs-string">'s/[ ]+data_provider::.*+$//'</span></span> | head 7.31% data_provider data_provider.005.00 [.] dtl::basic_string_ref&lt;char, std::char_traits&lt;char&gt; &gt;::empty() const 7.19% data_provider data_provider.005.00 [.] dtl::string_parser::fail() const 4.95% data_provider data_provider.005.00 [.] dtl::string_parser::eof() const 4.87% data_provider data_provider.005.00 [.] dtl::string_parser::peek() const 3.46% data_provider data_provider.005.00 [.] meta::json::decoder::parse_value(dtl::basic_string_ref&lt;char, std::char_traits&lt;char&gt; &gt;&amp;) 3.08% data_provider data_provider.005.00 [.] dtl::basic_string_ref&lt;char, std::char_traits&lt;char&gt; &gt;::operator[](unsigned long) const 2.53% data_provider data_provider.005.00 [.] dtl::basic_string_ref&lt;char, std::char_traits&lt;char&gt; &gt;::remove_prefix(unsigned long) 2.30% data_provider data_provider.005.00 [.] dtl::hash_seq(unsigned char const*, unsigned long) 2.21% data_provider data_provider.005.00 [.] bool dtl::strtou&lt;(unsigned char)10, unsigned char&gt;(dtl::basic_string_ref&lt;char, std::char_traits&lt;char&gt; &gt;&amp;, unsigned char&amp;)</code> </pre> <br><p>  However, judging by this data, the function performs a large number of decoding, but there are no problems with scaling in the code - there is no significant number of pthread_mutex_lock () calls.  That is, you can add more streams for input_handler :: execute () and expect an increase in overall performance. </p><br><h4 id="analiz-funkcii-event_handleron_msg">  Analysis of the event_handler :: on_msg () function. </h4><br><p>  I will skip the analysis of the number of events and just note that the calls made from this function, more than all the time spent in blocking.  This may require corrections, since such a large number of blocks is bad for scaling. </p><br><pre> <code class="bash hljs">$ perf report -x --stdio --kallsyms=/boot/System.map-$(uname -r) \ -g -p <span class="hljs-string"><span class="hljs-string">"event_handler::on_msg"</span></span> | \ grep -E -e <span class="hljs-string"><span class="hljs-string">"^[ ]+[0-9]"</span></span> | sed -re <span class="hljs-string"><span class="hljs-string">'s/[ ]+data_provider::.*+$//'</span></span> | head 6.73% data_provider libpthread-2.12.so [.] pthread_mutex_lock 4.90% data_provider libpthread-2.12.so [.] pthread_mutex_unlock 4.45% data_provider data_provider.005.00 [.] std::__atomic_base&lt;unsigned int&gt;::operator++() 3.84% data_provider [kernel.kallsyms] [k] _spin_lock 3.54% data_provider data_provider.005.00 [.] std::__atomic_base&lt;unsigned long&gt;::fetch_add(unsigned long, std::memory_order) 3.47% data_provider data_provider.005.00 [.] dtl::intrusive_ptr&lt;meta::object&gt;::intrusive_ptr(dtl::intrusive_ptr&lt;meta::object&gt; const&amp;) 2.92% data_provider data_provider.005.00 [.] (anonymous namespace)::page_allocator_base::allocate_obj(dtl::page_allocation_info&amp;) 2.70% data_provider data_provider.005.00 [.] std::char_traits&lt;char&gt;::length(char const*) 2.18% data_provider data_provider.005.00 [.] dtl::string::size() const 1.96% data_provider data_provider.005.00 [.] dtl::string::create_(dtl::basic_string_ref&lt;char, std::char_traits&lt;char&gt; &gt; const&amp;)</code> </pre> <br><p>  As a result, building a report using the <code>--parent</code> key helped to analyze the performance of individual parts of my program.  However, due to the fact that the Lua library used was apparently compiled without <code>-fno-omit-frame-pointer</code> , some of the functions that were performed in <code>input_handler::execute()</code> when analyzed with <code>--parent</code> were not included in the report, although and there is a general report. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/305188/">https://habr.com/ru/post/305188/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../305166/index.html">IT outsourcing should not hinder innovation - it's time to rethink</a></li>
<li><a href="../305168/index.html">What is OT?</a></li>
<li><a href="../305172/index.html">Social media in 2017. What to expect?</a></li>
<li><a href="../305182/index.html">Visualization of financial data. Mitap Ministry of Finance with developers, journalists and designers</a></li>
<li><a href="../305184/index.html">How to set up a network bridge (br0) on Ubuntu Linux 14.04 and 16.04 LTS</a></li>
<li><a href="../305204/index.html">Roman Nester, co-founder of Segmento - about the future of advertising technologies on the Internet</a></li>
<li><a href="../305246/index.html">Big Binary in my Rust?</a></li>
<li><a href="../305252/index.html">2D magic in detail. Part one. Shine</a></li>
<li><a href="../305254/index.html">ThinkPwn vulnerability in computer firmware was more serious than it seemed before</a></li>
<li><a href="../305256/index.html">ORegex: Is it fast enough for objects?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>