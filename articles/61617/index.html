<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We expand and improve Cache in ASP.NET</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About ASP.NET-object Cache surely every web developer on the .NET platform knows. It's not at all strange, because this is the only solution for cachi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We expand and improve Cache in ASP.NET</h1><div class="post__text post__text-html js-mediator-article">  About ASP.NET-object <a title="Class description" href="http://msdn.microsoft.com/ru-ru/library/system.web.caching.cache.aspx">Cache</a> surely every web developer on the .NET platform knows.  It's not at all strange, because this is the only solution for caching web application data in ASP.NET available directly from the box. <br>  Rather functional and lightweight, equipped with mechanisms for priority, crowding out, dependencies and callbacks, Cache is well suited for small applications, working inside the AppDomain.  It seems that Microsoft has provided everything that is needed ... But I, nevertheless, want to make it a little better.  What exactly? <a name="habracut"></a><br><br><h3>  Sync Updates </h3><br><br>  Cached data, like much in our world, tends to lose relevance over time.  Therefore, after the allotted time interval expires or when one of the dependencies changes, the saved item will disappear from the cache, and we will have to put it there again.  MSDN <a href="http://msdn.microsoft.com/ru-ru/library/xhy3h9f9.aspx">will tell</a> us how to do this, and we will write this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#2B91AF">List</font> &lt;Product&gt; products; <br> products = ( <font color="#2B91AF">List</font> &lt;Product&gt;)Cache[ <font color="#A31515">"Products"</font> ]; <br> <font color="#0000ff">if</font> (products == <font color="#0000ff">null</font> ) <br> { <br> products = db.Products.ToList(); <br> Cache.Insert( <font color="#A31515">"Products"</font> , products); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Everything looks right, but exactly as long as we are not aware that the code can be executed simultaneously in several threads.  And in these few lines we have just organized the classic race condition.  Of course, nothing terrible will happen, just the cache entry will be updated several times, and each time we will go to the database.  But this is an extra job, and it can be avoided by applying the usual double-check blocking.  Like this: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">private static</font> <font color="#0000ff">object</font> _lock = <font color="#0000ff">new</font> <font color="#0000ff">object</font> (); <br> <br> ... <br> <br> <font color="#0000ff">object</font> value; <br> <font color="#0000ff">if</font> ((value = Cache[ <font color="#A31515">"Products"</font> ]) == <font color="#0000ff">null</font> ) <br> { <br> <font color="#0000ff">lock</font> (_lock) <br> { <br> <font color="#0000ff">if</font> ((value = Cache[ <font color="#A31515">"Products"</font> ]) == <font color="#0000ff">null</font> ) <br> { <br> value = db.Products.ToList(); <br> Cache.Insert( <font color="#A31515">"Products"</font> , value); <br> } <br> } <br> } <br> <font color="#0000ff">var</font> products = ( <font color="#2B91AF">List</font> &lt;Product&gt;)value;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Thus, we guarantee that only one thread will go to the database for a list of goods, and the rest will wait for its return.  You can write such code whenever we work with the cache, but it is better to implement the extension of the Cache object using the extension method. <br><br><h4>  So, </h4><br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">static</font> T Get&lt;T&gt;( <font color="#0000ff">this</font> Cache cache, <font color="#0000ff">string</font> key, <font color="#0000ff">object</font> @lock, Func&lt;T&gt; selector, <br> <font color="#2B91AF">DateTime</font> absoluteExpiration) <br> { <br> <font color="#0000ff">object</font> <font color="#0000ff">value</font> ; <br> <font color="#0000ff">if</font> (( <font color="#0000ff">value</font> = cache.Get(key)) == <font color="#0000ff">null</font> ) <br> { <br> <font color="#0000ff">lock</font> (@lock) <br> { <br> <font color="#0000ff">if</font> (( <font color="#0000ff">value</font> = cache.Get(key)) == <font color="#0000ff">null</font> ) <br> { <br> <font color="#0000ff">value</font> = selector(); <br> cache.Insert(key, <font color="#0000ff">value</font> , <font color="#0000ff">null</font> , <br> absoluteExpiration, Cache.NoSlidingExpiration, <br> CacheItemPriority.Normal, <font color="#0000ff">null</font> ); <br> } <br> } <br> } <br> <font color="#0000ff">return</font> (T) <font color="#0000ff">value</font> ;</font> <br> } <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  If an item with the specified key is found in the cache, the method will simply return it, otherwise it will lock and perform the download.  Constructs <code>value = Cache.Get(key)</code> are needed in order not to get the same race when deleting a cache item in another thread.  Now, to get our list of products, we can write only one line, and the rest will take over the rest.  Overload can be added to taste :) <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">private static object</font> myLock = <font color="#0000ff">new object()</font> ; <br> ... <br> <font color="#0000ff">var</font> products = Cache.Get&lt; <font color="#2B91AF">List</font> &lt;Product&gt;&gt;( <font color="#A31515">"Products"</font> , myLock, <br> () =&gt; db.Products.ToList(), <font color="#2B91AF">DateTime</font> .Now.AddMinutes(10));</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  So, we dealt with one task, but there is still something interesting.  For example, a situation when it is necessary to declare several related cache elements invalid at once.  ASP.NET Cache provides us with the ability to create dependencies on one or more elements.  Like that: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">string</font> [] dependencies = { <font color="#A31515">"parent"</font> }; <br> Cache.Insert( <font color="#A31515">"child"</font> , someData, <br> <font color="#0000ff">new</font> CacheDependency( <font color="#0000ff">null</font> , dependencies)); <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  And when the <i>parent</i> element is updated, the <i>child</i> element will be deleted.  Nothing like yet?  Well, a little more code, and we will have a full-fledged ... <br><br><h3>  Tag and group invalidation support </h3><br><br>  The tagging subsystem will work quite transparently, using the already described key dependency mechanism in the cache.  Such keys will be - guess what?  - tags.  When adding an item to the cache with a certain collection of tags, we will create an appropriate number of keys in the cache and dependence on them. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">static</font> CacheDependency CreateTagDependency( <br> <font color="#0000ff">this</font> Cache cache, <font color="#0000ff">params string</font> [] tags) <br> { <br> <font color="#0000ff">if</font> (tags == <font color="#0000ff">null</font> || tags.Length &lt; 1) <br> <font color="#0000ff">return</font> <font color="#0000ff">null</font> ; <br> <br> <font color="#0000ff">long</font> version = <font color="#2B91AF">DateTime</font> .UtcNow.Ticks; <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; tags.Length; ++i) <br> { <br> cache.Add( <font color="#A31515">"_tag:"</font> + tags[i], version, <font color="#0000ff">null</font> , <br> <font color="#2B91AF">DateTime</font> .MaxValue, Cache.NoSlidingExpiration, <br> CacheItemPriority.NotRemovable, <font color="#0000ff">null</font> ); <br> } <br> <font color="#0000ff">return</font> <font color="#0000ff">new</font> CacheDependency( <font color="#0000ff">null</font> , tags.Select(s =&gt; <br> <font color="#A31515">"_tag:"</font> + s).ToArray()); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Here, as the value of the tag version, I use the current time, as recommended in the <a href="http://habrahabr.ru/blogs/webdev/43539/">article on Memcached</a> , but in our case we don‚Äôt have to compare anything, ASP.NET will do this.  Now, when adding an item to the cache, we can easily create a dependency on the tags we specified. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">ache.Insert( <font color="#A31515">"key"</font> , <font color="#0000ff">value</font> , ache.CreateTagDependency( <font color="#A31515">"tag1"</font> , <font color="#A31515">"tag2"</font> ));</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  It remains quite a bit - to ensure the reset of such a group of elements in the cache.  To do this, you just need to update the cache elements that represent the tags of interest.  Everything else happens by itself. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">void</font> Invalidate( <font color="#0000ff">this</font> Cache cache, <font color="#0000ff">params</font> <font color="#0000ff">string</font> [] tags) <br> { <br> <font color="#0000ff">long</font> version = <font color="#2B91AF">DateTime</font> .UtcNow.Ticks; <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; tags.Length; ++i) <br> { <br> cache.Insert( <font color="#A31515">"_tag:"</font> + tags[i], version, <font color="#0000ff">null</font> , <br> <font color="#2B91AF">DateTime</font> .MaxValue, Cache.NoSlidingExpiration, <br> CacheItemPriority.NotRemovable, <font color="#0000ff">null</font> ); <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Notice that the method that creates the tag dependency uses the <code>cache.Add</code> method, and here is the <code>cache.Insert</code> .  The essential difference between these otherwise very similar methods is that the first writes information to the cache only if the specified key was not created earlier, and the second writes it in any case, overwriting the old data.  This distinction is very important in our case, because when we simply add an item to the cache, we do not need to update the already existing tags. <br><br>  On this, it seems, and all ... <br><br><h3>  I demand the continuation of the banquet! </h3><br><br>  And there is still much to continue.  For example, you can modify the Get method described here so that, instead of immediately deleting, the cache data temporarily ‚Äúmoved‚Äù to another cell, and instead of blocking, return the requested information from it while new data is loaded into the cache. <br><br>  Instead of extension-methods, you can make a certain abstraction of the caching provider and work with any storage without changing the application code or completely disable the cache when debugging, use IoC ... you never know! <br><br>  And I hope that the approaches described in my article will be useful for you;) <br><br>  <b>UPDATE</b> : Looking with my own eye on my own code, I saw one bad thing in it - the lock during synchronization was set for the entire cache.  So I modified the extension-method <i>Get</i> to accept a custom object for blocking. <br><br></div><p>Source: <a href="https://habr.com/ru/post/61617/">https://habr.com/ru/post/61617/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../61611/index.html">Great firewall goes to the Chinese home</a></li>
<li><a href="../61612/index.html">The future is for engineers, not economists</a></li>
<li><a href="../61613/index.html">The first certified seller of Google AdWords advertising in Belarus</a></li>
<li><a href="../61615/index.html">The first Japanese netbook with WiMAX</a></li>
<li><a href="../61616/index.html">Wean Chrome to eat hard drives</a></li>
<li><a href="../61622/index.html">Jointech JE100 - e-book with LCD display</a></li>
<li><a href="../61623/index.html">VCR Digital Video Memo</a></li>
<li><a href="../61624/index.html">WWDC 09 live</a></li>
<li><a href="../61625/index.html">Project blogs are the easiest way to share information within a company.</a></li>
<li><a href="../61626/index.html">Version 1.0.6</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>