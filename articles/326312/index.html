<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to write a chat bot for vk.com in 3 minutes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Unfortunately, at the moment there are no good libraries on Python2, in order to quickly create a chat bot. Below I will show how easy it is to write ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to write a chat bot for vk.com in 3 minutes</h1><div class="post__text post__text-html js-mediator-article"><p>  Unfortunately, at the moment there are no good libraries on Python2, in order to quickly create a chat bot.  Below I will show how easy it is to write a primitive chat bot for VK using the VK API. </p><br><p>  The article is written for beginners to show that there is nothing difficult to write bots in Python. <a name="habracut"></a></p><br><h4 id="avtorizaciya">  Authorization </h4><br><p>  We need a library <a href="https://github.com/python273/vk_api">vk_api</a> .  You can log in to VK in two ways: <br>  - as user <br>  - As a community </p><br><p>  In the first case, you will need to enter a username and password.  In the second case, in the group, you must enable "Community Messages" and create an API access key: </p><br><p><img src="https://habrastorage.org/files/add/e71/d93/adde71d9387c4b829f901ba06e74f559" alt="image"></p><br><p><img src="https://habrastorage.org/files/bf9/79f/6ed/bf979f6edbb0499bbb758659eef85a2e" alt="image"></p><br><p>  Authorization in two lines: </p><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> vk_api vk = vk_api.VkApi(login = <span class="hljs-string"><span class="hljs-string">'login'</span></span>, password = <span class="hljs-string"><span class="hljs-string">'password'</span></span>) <span class="hljs-comment"><span class="hljs-comment">#vk_api.VkApi(token = 'a02d...e83fd') #   vk.auth()</span></span></code> </pre> <br><h4 id="otpravka-soobscheniy">  Sending messages </h4><br><p>  Now we will write a short function that sends the message to the selected person. </p><br><p>  <strong>PS The</strong> community can send messages only to previously written users. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write_msg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user_id, s)</span></span></span><span class="hljs-function">:</span></span> vk.method(<span class="hljs-string"><span class="hljs-string">'messages.send'</span></span>, {<span class="hljs-string"><span class="hljs-string">'user_id'</span></span>:user_id,<span class="hljs-string"><span class="hljs-string">'message'</span></span>:s})</code> </pre> <br><p>  In vk.method we can call any method from the <a href="https://vk.com/dev/methods">VK API</a> and pass parameters in the form of a dictionary. </p><br><p>  In this case, we call the <a href="">messages.send</a> method and pass the user id and message text as parameters. </p><br><h4 id="priem-soobscheniy">  Receive messages </h4><br><p>  Fine!  We learned how to send messages, it remains to learn how to receive them.  For this we need the <a href="">messages.get</a> method. </p><br><p>  Several parameters to pay attention to: </p><br><p>  1) out - if this parameter is 1, the server will return outgoing messages. <br>  2) count - the number of messages that must be received. <br>  3) time_offset - the maximum time elapsed from the moment of sending the message to the current moment in seconds. <br>  4) last_message_id - ID of the message received before the one that needs to be returned last (provided that no more than count messages were received after it) </p><br><pre> <code class="python hljs">values = {<span class="hljs-string"><span class="hljs-string">'out'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-string"><span class="hljs-string">'count'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>,<span class="hljs-string"><span class="hljs-string">'time_offset'</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>} vk.method(<span class="hljs-string"><span class="hljs-string">'messages.get'</span></span>, values)</code> </pre> <br><p>  In our case, this method will return all received messages in the last 60 seconds, if there have of course been less than 100, and if more, then the last 100. </p><br><p>  As a result, we get a list of items: </p><br><pre> <code class="python hljs">{<span class="hljs-string"><span class="hljs-string">u'count'</span></span>: <span class="hljs-number"><span class="hljs-number">3441</span></span>, <span class="hljs-string"><span class="hljs-string">u'items'</span></span>: [{<span class="hljs-string"><span class="hljs-string">u'body'</span></span>: <span class="hljs-string"><span class="hljs-string">u'\u041f\u0438\u0448\u0435\u043c \u0431\u043e\u0442\u0430 \u0434\u043b\u044f \u0432\u043a!'</span></span>, <span class="hljs-string"><span class="hljs-string">u'date'</span></span>: <span class="hljs-number"><span class="hljs-number">1491934484</span></span>, <span class="hljs-string"><span class="hljs-string">u'id'</span></span>: <span class="hljs-number"><span class="hljs-number">7387</span></span>, <span class="hljs-string"><span class="hljs-string">u'out'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">u'read_state'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">u'title'</span></span>: <span class="hljs-string"><span class="hljs-string">u' ... '</span></span>, <span class="hljs-string"><span class="hljs-string">u'user_id'</span></span>: <span class="hljs-number"><span class="hljs-number">23107592</span></span>}, {<span class="hljs-string"><span class="hljs-string">u'body'</span></span>: <span class="hljs-string"><span class="hljs-string">u'\u041f\u0440\u0438\u0432\u0435\u0442 \u0425\u0430\u0431\u0440!'</span></span>, <span class="hljs-string"><span class="hljs-string">u'date'</span></span>: <span class="hljs-number"><span class="hljs-number">1491934479</span></span>, <span class="hljs-string"><span class="hljs-string">u'id'</span></span>: <span class="hljs-number"><span class="hljs-number">7386</span></span>, <span class="hljs-string"><span class="hljs-string">u'out'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">u'read_state'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">u'title'</span></span>: <span class="hljs-string"><span class="hljs-string">u' ... '</span></span>, <span class="hljs-string"><span class="hljs-string">u'user_id'</span></span>: <span class="hljs-number"><span class="hljs-number">23107592</span></span>}]}</code> </pre> <br><p>  Explained in simple terms, items are what can be distinguished in the dialogue. </p><br><p><img src="https://habrastorage.org/files/b1f/348/a1a/b1f348a1a9f94220acf70820339f09ef" alt="image"></p><br><p>  The final chord, we make an eternal cycle, where we will reply "Hello, Habr!" To each message. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: response = vk.method(<span class="hljs-string"><span class="hljs-string">'messages.get'</span></span>, values) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> response[<span class="hljs-string"><span class="hljs-string">'items'</span></span>]: values[<span class="hljs-string"><span class="hljs-string">'last_message_id'</span></span>] = response[<span class="hljs-string"><span class="hljs-string">'items'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'id'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response[<span class="hljs-string"><span class="hljs-string">'items'</span></span>]: write_msg(item[<span class="hljs-string"><span class="hljs-string">u'user_id'</span></span>],<span class="hljs-string"><span class="hljs-string">u', !'</span></span>) time.sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p>  Chat bot ready. </p><br><p>  <strong>PS</strong> We remember the last_message_id parameter to process only new messages next time. </p><br><div class="spoiler">  <b class="spoiler_title">Full code</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- import time import vk_api vk = vk_api.VkApi(login = 'login', password = 'password') #vk_api.VkApi(token = 'a02d...e83fd') #   vk.auth() values = {'out': 0,'count': 100,'time_offset': 60} def write_msg(user_id, s): vk.method('messages.send', {'user_id':user_id,'message':s}) while True: response = vk.method('messages.get', values) if response['items']: values['last_message_id'] = response['items'][0]['id'] for item in response['items']: write_msg(item[u'user_id'],u', !') time.sleep(1)</span></span></code> </pre> </div></div><br><p>  It turned out 17 lines of code.  Successes! </p><br><p>  <strong>UPD 9/17/18:</strong> <br>  Unfortunately, in the new version (5.80) VK API, the 'messages.get' method was removed and this article is no longer relevant.  Now use the longpoll system to create bots.  An example on the vk_api module for Python can be found <a href="https://github.com/python273/vk_api/blob/master/examples/longpoll.py">here</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/326312/">https://habr.com/ru/post/326312/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326296/index.html">Oscillating link model in resonant oscillation mode in Python</a></li>
<li><a href="../326298/index.html">Problems with the speed of the "gettimeofday" and "clock_gettime" system calls in AWS EC2</a></li>
<li><a href="../326302/index.html">Writing a 2-d game in Java # 2</a></li>
<li><a href="../326304/index.html">Why use static types in javascript? (Example of static typing on Flow)</a></li>
<li><a href="../326308/index.html">Google released technical data and TPU appointment</a></li>
<li><a href="../326314/index.html">Delta has lost $ 150 million due to the desire of the manufacturer of emergency generators for the data center</a></li>
<li><a href="../326316/index.html">Useful Plugins and Security Tips for WordPress</a></li>
<li><a href="../326318/index.html">In the Canadian airport discovered devices to spy on smartphones</a></li>
<li><a href="../326320/index.html">(Not) for protothreads lovers dedicated to: High-level functions for working with 1-Wire</a></li>
<li><a href="../326322/index.html">5 stages of implementation of a CRM system. Fascinating about the important</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>