<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Strategies to speed up code on R, part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The for loop in R can be very slow if it is applied in its pure form, without optimization, especially when it comes to dealing with large data sets. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Strategies to speed up code on R, part 1</h1><div class="post__text post__text-html js-mediator-article"> The for loop in R can be very slow if it is applied in its pure form, without optimization, especially when it comes to dealing with large data sets.  There are a number of ways to make your code faster, and you will probably be surprised to know how much. <br><br>  This article describes several approaches, including simple changes in logic, parallel processing and <code>Rcpp</code> , increasing the speed by several orders of magnitude, so that 100 million rows of data or even more can be processed normally. <br><br>  Let's try to speed up the code with a for loop and a conditional operator (if-else) to create a column that is added to the data set (data frame, df).  The code below creates this initial data set. <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#    col1 &lt;- runif (12^5, 0, 2) col2 &lt;- rnorm (12^5, 0, 2) col3 &lt;- rpois (12^5, 3) col4 &lt;- rchisq (12^5, 2) df &lt;- data.frame (col1, col2, col3, col4)</span></span></code> </pre><br>  In this part: vectorization, only true conditions, ifelse. <br>  In the next part: which, apply, byte-by-byte compilation, Rcpp, data.table. <br><a name="habracut"></a><br><h4>  Logic we are going to optimize </h4><br>  For each row in this dataset (df), check if the sum of the values ‚Äã‚Äãexceeds 4. If so, the new fifth variable is ‚Äúgreater_than_4‚Äù, otherwise - ‚Äúlesser_than_4‚Äù. <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#    R:      system.time({ for (i in 1:nrow(df)) { # for every row if ((df[i, 'col1'] + df[i, 'col2'] + df[i, 'col3'] + df[i, 'col4']) &gt; 4) { # check if &gt; 4 df[i, 5] &lt;- "greater_than_4" #    5-  } else { df[i, 5] &lt;- "lesser_than_4" #    5-  } } })</span></span></code> </pre><br>  All subsequent calculations of processing time were carried out on MAC OS X with a 2.6 GHz processor and 8GB of RAM. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Vectorize and highlight data structures in advance. </h4><br>  Always initialize your data structures and output variables, setting the required length and data type before starting the calculation loop.  Try not to increase the amount of your data step by step inside the loop.  Let's compare how vectorization improves speed on different data sizes from 1,000 to 100,000 rows. <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#      output &lt;- character (nrow(df)) #    system.time({ for (i in 1:nrow(df)) { if ((df[i, 'col1'] + df[i, 'col2'] + df[i, 'col3'] + df[i, 'col4']) &gt; 4) { output[i] &lt;- "greater_than_4" } else { output[i] &lt;- "lesser_than_4" } } df$output})</span></span></code> </pre><br><img src="https://habrastorage.org/files/32d/ac8/6dc/32dac86dce8f4c59a03acd8756efddf8.png" width="60%"><br>  <i>Source code and vectorized code</i> <br><br><h4>  Remove conditional statements outside the loop. </h4><br>  Carrying out conditional checks beyond the bounds of a cycle is comparable in terms of gain with vectorization itself.  Tests were conducted on ranges from 100,000 to 1,000,000 lines.  The speed win is huge again. <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#     ,       output &lt;- character (nrow(df)) condition &lt;- (df$col1 + df$col2 + df$col3 + df$col4) &gt; 4 #     system.time({ for (i in 1:nrow(df)) { if (condition[i]) { output[i] &lt;- "greater_than_4" } else { output[i] &lt;- "lesser_than_4" } } df$output &lt;- output })</span></span></code> </pre><br><img src="https://habrastorage.org/files/90c/b87/4e2/90cb874e219a478c96ca4145d03fa103.png" width="60%"><br>  <i>Check condition out of cycle</i> <br><br><h4>  Run the loop for true conditions only. </h4><br>  Another optimization that can be used here is to start the loop only by true conditions, after having previously initialized the output vector with False values.  Acceleration here is highly dependent on the number of cases with True in your data. <br><br>  The tests compare the performance of this and previous improvements on data from 1,000,000 to 10,000,000 rows.  Notice the increase in the number of zeros here.  As expected, there is a very definite noticeable improvement. <br><pre> <code class="python hljs">output &lt;- character(nrow(df)) condition &lt;- (df$col1 + df$col2 + df$col3 + df$col4) &gt; <span class="hljs-number"><span class="hljs-number">4</span></span> system.time({ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>:nrow(df))[condition]) { <span class="hljs-comment"><span class="hljs-comment">#       if (condition[i]) { output[i] &lt;- "greater_than_4" } else { output[i] &lt;- "lesser_than_4" } } df$output })</span></span></code> </pre><br><img src="https://habrastorage.org/files/ad4/032/520/ad403252074e4c1286810c1800462a61.png" width="60%"><br>  <i>Run the loop only on true conditions.</i> <br><br><h4>  Use ifelse () where possible </h4><br>  This logic can be made much faster and easier using <code>ifelse()</code> .  The syntax is similar to the <code>if</code> function in MS Excel, but the acceleration is phenomenal, especially since there is no preallocation, and the condition is checked every time.  This seems like a very profitable way to speed up the execution of simple loops. <br><pre> <code class="python hljs">system.time({ output &lt;- ifelse ((df$col1 + df$col2 + df$col3 + df$col4) &gt; <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"greater_than_4"</span></span>, <span class="hljs-string"><span class="hljs-string">"lesser_than_4"</span></span>) df$output &lt;- output })</code> </pre><br><img src="https://habrastorage.org/files/fe6/d73/a27/fe6d73a2789e422795dfa465f8284804.png" width="60%"><br>  <i>Only true conditions and ifelse</i> </div><p>Source: <a href="https://habr.com/ru/post/277681/">https://habr.com/ru/post/277681/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277671/index.html">Math on the fingers: linear-quadratic controller</a></li>
<li><a href="../277673/index.html">Free Photoshop Script: Export Vector Layers from PSD to SVG</a></li>
<li><a href="../277675/index.html">Linux Mint distributions have been compromised</a></li>
<li><a href="../277677/index.html">We authenticate requests in the microservice application using nginx and JWT</a></li>
<li><a href="../277679/index.html">We write shell scripts in Python and is it possible to replace them with Bash</a></li>
<li><a href="../277687/index.html">Hotel module 3CX Hotel Phone System</a></li>
<li><a href="../277691/index.html">Digital signature, fast course (translation of the 17th chapter of Powershell in depth)</a></li>
<li><a href="../277693/index.html">Strategies to speed up code on R, part 2</a></li>
<li><a href="../277695/index.html">Top 6 netty optimizations</a></li>
<li><a href="../277697/index.html">The digest of interesting materials from the world of web development and IT for the last week? 199 (February 15 - 21, 2016)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>