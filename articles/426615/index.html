<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write CLI on NodeJS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good evening everyone. 


 There was a task to write your immersive CLI on node.js. Previously used for this purpose vorpal . This time, I wanted to d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write CLI on NodeJS</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/9n/z-/6e/9nz-6ebjedo4dhwkzglci-7q-g8.png"></p><br><p>  Good evening everyone. </p><br><p>  There was a task to write your immersive CLI on node.js.  Previously used for this purpose <a href="https://www.npmjs.com/package/vorpal">vorpal</a> .  This time, I wanted to do without unnecessary dependencies and, in addition to this, considered the possibility of accepting command arguments in a different way. </p><br><p>  With vorpal commands were written as follows: </p><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">setValue</span></span> -s <span class="hljs-number"><span class="hljs-number">1</span></span> -v <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Agree, every time to write <code>-s</code> is not very convenient. </p><br><p>  In the end, the team turned into the following: </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  How it can be implemented - under the cut </p><a name="habracut"></a><br><ol><li>  Also a good bonus is the transfer of several arguments in the form of a list of values, separated by a space and in the form of an array. </li></ol><br><h2 id="vvod-teksta">  text input </h2><br><p>  To enter text I use <code>readline</code> .  In the following way we create an interface with auto-completion support: </p><br><pre> <code class="hljs pgsql"> let commandlist = []; commandlist.push("set", "get", "stored", "read", "description"); commandlist.push("watch", "unwatch"); commandlist.push("getbyte", "getitem", "progmode"); commandlist.push("ping", "state", "reset", "help"); <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> completer(<span class="hljs-type"><span class="hljs-type">line</span></span>) { const hits = commandlist.<span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>(c =&gt; c.startsWith(<span class="hljs-type"><span class="hljs-type">line</span></span>)); // <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> completions <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-built_in"><span class="hljs-built_in">found</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [hits.length ? hits : commandlist, <span class="hljs-type"><span class="hljs-type">line</span></span>]; } /// init repl const rl = readline.createInterface({ <span class="hljs-keyword"><span class="hljs-keyword">input</span></span>: process.stdin, output: process.stdout, prompt: "bobaos&gt; ", completer: completer }); const console_out = msg =&gt; { process.stdout.clearLine(); process.stdout.cursorTo(<span class="hljs-number"><span class="hljs-number">0</span></span>); console.log(msg); rl.prompt(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); };</code> </pre> <br><p>  <code>console.log</code> works as expected, i.e.  displays the text on the current line and transfers the line, and if it is called on any external event that does not depend on the text input, the data will be output to the input line.  Therefore, we use the function console_out, which, after outputting to the console, calls the readline input line. </p><br><h2 id="parser">  parser </h2><br><p>  It would seem that the line can be divided into spaces, separate the individual parts and process.  But then it will be impossible to transfer string parameters containing a space;  and in any case it will be necessary to remove extra spaces and tabs. </p><br><p>  Initially, the parser planned to implement itself, rewriting the descending recursive parser from the book of Herbert Shildt on C.  In the process of writing, I found the <a href="https://www.npmjs.com/package/ebnf">ebnf</a> package, and, <a href="https://www.npmjs.com/package/ebnf">becoming</a> interested in and familiarizing <a href="https://www.npmjs.com/package/ebnf">myself</a> with the BNF / EBNF syntax definition systems, I decided to use it in my application. </p><br><h2 id="grammatika">  grammar </h2><br><p>  We make descriptions of commands and arguments in the grammar file. <br>  First, let's define the following: </p><br><ol><li>  The expression consists of one line.  We do not need to process more than two lines. </li><li>  At the beginning of the expression is the command identifier.  Further arguments. </li><li>  There are a limited number of commands, so each of them is written in the grammar file. </li></ol><br><p>  The input point is as follows: </p><br><pre> <code class="hljs sql">command ::= (<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>|<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>|<span class="hljs-keyword"><span class="hljs-keyword">stored</span></span>|<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>|description|getbyte|watch|unwatch|ping|state|<span class="hljs-keyword"><span class="hljs-keyword">reset</span></span>|getitem|progmode|<span class="hljs-keyword"><span class="hljs-keyword">help</span></span>) WS*</code> </pre> <br><p>  WS * means whitespace - space or tab characters.  Described as follows: </p><br><pre> <code class="hljs smalltalk"><span class="hljs-type"><span class="hljs-type">WS</span></span> ::= [<span class="hljs-symbol"><span class="hljs-symbol">#x20</span></span><span class="hljs-symbol"><span class="hljs-symbol">#x09</span></span><span class="hljs-symbol"><span class="hljs-symbol">#x0A</span></span><span class="hljs-symbol"><span class="hljs-symbol">#x0D</span></span>]+</code> </pre> <br><p>  What does the space character, tab, or line break, occurring once and more. </p><br><p>  Let's go to the teams. <br>  The simplest, without arguments: </p><br><pre> <code class="hljs go">ping ::= <span class="hljs-string"><span class="hljs-string">"ping"</span></span> WS* state ::= <span class="hljs-string"><span class="hljs-string">"state"</span></span> WS* reset ::= <span class="hljs-string"><span class="hljs-string">"reset"</span></span> WS* help ::= <span class="hljs-string"><span class="hljs-string">"help"</span></span> WS*</code> </pre> <br><p>  Further, the commands that take as input a list of natural numbers separated by a space, or an array. </p><br><pre> <code class="hljs go">BEGIN_ARRAY ::= WS* #x5B WS* <span class="hljs-comment"><span class="hljs-comment">/* [ left square bracket */</span></span> END_ARRAY ::= WS* #x5D WS* <span class="hljs-comment"><span class="hljs-comment">/* ] right square bracket */</span></span> COMMA ::= WS* #x2C WS* <span class="hljs-comment"><span class="hljs-comment">/* , comma */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> ::= [<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-number"><span class="hljs-number">-9</span></span>]* UIntArray ::= BEGIN_ARRAY (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> WS* (COMMA <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)*) END_ARRAY UIntList ::= (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> WS*)* get ::= <span class="hljs-string"><span class="hljs-string">"get"</span></span> WS* ( UIntList | UIntArray )</code> </pre> <br><p>  Thus, for the get command, the following examples would be correct: </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>]</code> </pre> <br><p>  Next, the set command, which accepts a pair of id: value, or an array of values. </p><br><pre> <code class="hljs 1c">COLON ::= WS* <span class="hljs-string"><span class="hljs-string">":"</span></span> WS* Number ::= <span class="hljs-string"><span class="hljs-string">"-"</span></span>? (<span class="hljs-string"><span class="hljs-string">"0"</span></span> <span class="hljs-string"><span class="hljs-string">| [1-9] [0-9]*) ("</span></span>.<span class="hljs-string"><span class="hljs-string">" [0-9]+)? (("</span></span>e<span class="hljs-string"><span class="hljs-string">" | "</span></span>E<span class="hljs-string"><span class="hljs-string">") ( "</span></span>-<span class="hljs-string"><span class="hljs-string">" | "</span></span>+<span class="hljs-string"><span class="hljs-string">" )? ("</span></span><span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">" | [1-9] [0-9]*))? String ::= '"</span></span>' [^"]* '<span class="hljs-string"><span class="hljs-string">"' | "</span></span>'" [^']* <span class="hljs-string"><span class="hljs-string">"'"</span></span> <span class="hljs-literal"><span class="hljs-literal">Null</span></span> ::= <span class="hljs-string"><span class="hljs-string">"null"</span></span> Bool ::= <span class="hljs-string"><span class="hljs-string">"true"</span></span> <span class="hljs-string"><span class="hljs-string">| "</span></span>false<span class="hljs-string"><span class="hljs-string">" Value ::= Number | String | Null | Bool DatapointValue ::= uint COLON Value DatapointValueArray ::= BEGIN_ARRAY (DatapointValue WS* (COMMA DatapointValue)*)? END_ARRAY set ::= "</span></span>set<span class="hljs-string"><span class="hljs-string">" WS* ( DatapointValue | DatapointValueArray )</span></span></code> </pre> <br><p>  Thus, for the set command, the following entry forms are correct: </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-number"><span class="hljs-number">255</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-number"><span class="hljs-number">21.42</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-number"><span class="hljs-number">999</span></span>: <span class="hljs-string"><span class="hljs-string">"hello, friend"</span></span>]</code> </pre> <br><h2 id="obrabatyvaem-v-js">  we process in js </h2><br><p>  Read the file, create a parser object. </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> grammar = fs.readFileSync(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${__dirname}</span></span></span><span class="hljs-string">/grammar`</span></span>, <span class="hljs-string"><span class="hljs-string">"utf8"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> parser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Grammars.W3C.Parser(grammar);</code> </pre> <br><p>  Further, during data entry, the readline object instance is signaled by the line event, which is processed with the following function: </p><br><pre> <code class="hljs pgsql">let parseCmd = <span class="hljs-type"><span class="hljs-type">line</span></span> =&gt; { let res = <span class="hljs-keyword"><span class="hljs-keyword">parser</span></span>.getAST(<span class="hljs-type"><span class="hljs-type">line</span></span>.trim()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (res.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> === "command") { let cmdObject = res.children[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> processCmd(cmdObject); } };</code> </pre> <br><p>  If the command was written correctly, the parser returns a tree, where each element has a type field, children, and a text field.  The type field takes the value of the type of the current element.  Those.  if we send the ping command to the parser, the tree will look like a trace.  in the following way: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"command"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"ping"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"children"</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"ping"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"ping"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"children"</span></span>: [] }] }</code> </pre> <br><p>  We write in the form: </p><br><pre> <code class="hljs pgsql">command ping <span class="hljs-type"><span class="hljs-type">Text</span></span> = "ping"</code> </pre> <br><p>  For the "get 1 2 3" command, </p><br><pre> <code class="hljs cs">command <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> UIntList <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> Text = <span class="hljs-string"><span class="hljs-string">"1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> Text = <span class="hljs-string"><span class="hljs-string">"2"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> Text = <span class="hljs-string"><span class="hljs-string">"3"</span></span></code> </pre> <br><p>  Next, we process each command, do the necessary actions, and output the result to the console. </p><br><p>  The result is a very user-friendly interface that speeds up work with a minimum of dependencies.  Will explain: </p><br><p>  in the graphical interface (ETS) to read the group addresses (for example), you must enter one group address in the input field, then click (or several TABs) to send a request. </p><br><p>  In the interface implemented via vorpal, the command is as follows: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">readValue</span></span> -s <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p>  Or: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">readValues</span></span> -s <span class="hljs-string"><span class="hljs-string">"1, 3"</span></span></code> </pre> <br><p>  With the use of the parser, it is possible to avoid unnecessary "-s" elements and quotes. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">read</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br><h2 id="ssylki">  links </h2><br><ol><li>  <a href="">https://github.com/bobaoskit/bobaos.tool</a> - project repository.  You can look at the code. </li><li>  <a href="http://menduz.com/ebnf-highlighter/">http://menduz.com/ebnf-highlighter/</a> - you can edit and check grammar on the fly. </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/426615/">https://habr.com/ru/post/426615/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../426603/index.html">Spinning the spiral: math and hallucinations</a></li>
<li><a href="../426605/index.html">Static analysis of PHP code on the example of PHPStan, Phan and Psalm</a></li>
<li><a href="../426609/index.html">In Office 365 and other MS products will add voice I / O mode for dyslexics</a></li>
<li><a href="../426611/index.html">Integration with SAP ERP, for example with Django-python, using the oData (rest) protocol</a></li>
<li><a href="../426613/index.html">Do not let the 3D printer lazy</a></li>
<li><a href="../426617/index.html">License to drive a car, or why applications should be Single-Activity</a></li>
<li><a href="../426621/index.html">Compact strings in Java 9</a></li>
<li><a href="../426623/index.html">This is an electric bus: what do we know about transport with a battery</a></li>
<li><a href="../426625/index.html">Multilingual trees in Yii2 on the example of creating a menu module</a></li>
<li><a href="../426627/index.html">Flexbox usage examples</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>