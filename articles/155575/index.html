<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Start using Tarantool in a Java project</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the article below, I will try to briefly talk about what Tarantool is and how to start using it in an existing project if you are programming in Ja...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Start using Tarantool in a Java project</h1><div class="post__text post__text-html js-mediator-article">  In the article below, I will try to briefly talk about what Tarantool is and how to start using it in an existing project if you are programming in Java.  If you are programming in another language, then you may be interested in some of the tools available in the connector, such as the ability to edit xlog files and create snap files from any data.  If you do not know what Tarantool is, then it is better to read <a href="http://habrahabr.ru/post/133435/">this post</a> . <br><a name="habracut"></a><br>  <a href="http://tarantool.org/">Tarantool</a> is a key tuple data store.  All data and indexes are stored in RAM.  Values ‚Äã‚Äãconstitute a tuple, further <b>tuple</b> , tuples - space, further <b>space</b> , spaces - data model.  Three data types are supported: 32-bit without signed integer, 64-bit without signed integer and binary string, then <b>NUM</b> , <b>NUM64</b> and <b>STR,</b> respectively.  For any space, the type and structure of the primary index must be defined, for example: HASH by fields 1.2 where 1 is NUM and 2 is NUM64.  Secondary indexes are set in the same way as primary indexes.  <a href="http://ru.wikipedia.org/wiki/DML">DML</a> operations are atomic at the tuple level and are performed only on the primary index.  To perform several operations atomically you need to use the built-in language <a href="http://ru.wikipedia.org/wiki/Lua">Lua</a> .  Data safety is ensured by saving a snapshot of the current state, then a <b>snapshot</b> , and a binary log, then <b>xlog</b> .  <a href="http://ru.wikipedia.org/wiki/Slab">Slab is</a> used to store tuples. <br><br>  The examples below use the java connector, more information about it can be found at <a href="http://dgreenru.github.com/tarantool-java/">dgreenru.github.com/tarantool-java</a> .  The latest stable version at the time of writing <b>0.1.2</b> .  Below, I will consider an example of using additional functionality that allows you to transfer and synchronize data with any other repositories. <br><br><h4>  An example of transferring a MySQL table to the Tarantool Box: </h4>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs ruby">mysql&gt; desc user; +------------+--------------+------+-----+-------------------+----------------+ <span class="hljs-params"><span class="hljs-params">| Field |</span></span> Type <span class="hljs-params"><span class="hljs-params">| Null |</span></span> Key <span class="hljs-params"><span class="hljs-params">| Default |</span></span> Extra <span class="hljs-params"><span class="hljs-params">| +------------+--------------+------+-----+-------------------+----------------+ |</span></span> id <span class="hljs-params"><span class="hljs-params">| int(11) |</span></span> NO <span class="hljs-params"><span class="hljs-params">| PRI |</span></span> NULL <span class="hljs-params"><span class="hljs-params">| auto_increment |</span></span> <span class="hljs-params"><span class="hljs-params">| username |</span></span> varchar(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-params"><span class="hljs-params">| NO |</span></span> UNI <span class="hljs-params"><span class="hljs-params">| NULL |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> email <span class="hljs-params"><span class="hljs-params">| varchar(255) |</span></span> NO <span class="hljs-params"><span class="hljs-params">| UNI |</span></span> NULL <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">| enabled |</span></span> tinyint(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-params"><span class="hljs-params">| NO |</span></span> <span class="hljs-params"><span class="hljs-params">| 1 |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> registered <span class="hljs-params"><span class="hljs-params">| timestamp |</span></span> NO <span class="hljs-params"><span class="hljs-params">| |</span></span> CURRENT_TIMESTAMP <span class="hljs-params"><span class="hljs-params">| |</span></span> +------------+--------------+------+-----+-------------------+----------------+ <span class="hljs-number"><span class="hljs-number">5</span></span> rows <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set</code> </pre> <br><br>  Primary index id and 2 secondary unique index username and email.  You can select <i>auto_increment</i> and <i>timestamp</i> from non-portable places.  For the first, you can use the stored procedure <b>box.auto_increment</b> , and for the second, you can store data in either <i>yyyyMMddhhmmss</i> or seconds.  If the user table is small enough, then you can simply read the data from mysql and insert it into the Tarantool Box, I will not dwell on this task, but will tell you what to do if the table is very large, i.e.  contains a lot of records, even if each of them is small.  First you need to upload data in a convenient format for us, preferably not taking up much server resources. <br><br><pre> <code class="bash hljs">mysql&gt; select * into outfile <span class="hljs-string"><span class="hljs-string">'/tmp/user'</span></span> from user; Query OK, 73890541 rows affected $ head -1 /tmp/user 1 username email@domain.tld 1 2012-10-14 01:27:05</code> </pre><br><br>  Having copied the file to the necessary server or local computer, you can proceed to its processing and conversion to the Tarantool Box format.  In the example below, for simplicity, escape sequences are not considered.  If you have tabs, line breaks, carriage returns, backslash, or fields that contain NULL values ‚Äã‚Äãin the tables, you need to add their own processing. <br><br><pre> <code class="java hljs">BufferedReader reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferedReader(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InputStreamReader(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GZIPInputStream(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInputStream(<span class="hljs-string"><span class="hljs-string">"/tmp/user.gz"</span></span>)), <span class="hljs-string"><span class="hljs-string">"utf-8"</span></span>)); SnapshotWriter writer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SnapshotWriter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(<span class="hljs-string"><span class="hljs-string">"/tmp/user.snap"</span></span>).getChannel()); String line = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; DateFormat indf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleDateFormat(<span class="hljs-string"><span class="hljs-string">"yyyy-MM-dd hh:mm:ss"</span></span>); DateFormat outdf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleDateFormat(<span class="hljs-string"><span class="hljs-string">"yyyyMMddhhmmss"</span></span>); Pattern pattern = Pattern.compile(<span class="hljs-string"><span class="hljs-string">"\t"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((line = reader.readLine()) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { String[] values = pattern.split(line); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (values.length == <span class="hljs-number"><span class="hljs-number">5</span></span>) { Integer id = Integer.parseInt(values[<span class="hljs-number"><span class="hljs-number">0</span></span>]); String username = values[<span class="hljs-number"><span class="hljs-number">1</span></span>]; String email = values[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] enabled = { Byte.valueOf(values[<span class="hljs-number"><span class="hljs-number">3</span></span>]) }; Long registered = Long.parseLong(outdf.format(indf.parse(values[<span class="hljs-number"><span class="hljs-number">4</span></span>]))); Tuple tuple = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Tuple(<span class="hljs-number"><span class="hljs-number">5</span></span>).setInt(<span class="hljs-number"><span class="hljs-number">0</span></span>, id).setString(<span class="hljs-number"><span class="hljs-number">1</span></span>, username, <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>) .setString(<span class="hljs-number"><span class="hljs-number">2</span></span>, email, <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>).setBytes(<span class="hljs-number"><span class="hljs-number">3</span></span>, enabled).setLong(<span class="hljs-number"><span class="hljs-number">4</span></span>, registered); writer.writeRow(<span class="hljs-number"><span class="hljs-number">0</span></span>, tuple); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { System.err.println(<span class="hljs-string"><span class="hljs-string">"Line should be splited in 5 parts, but has "</span></span> + values.length + <span class="hljs-string"><span class="hljs-string">" for "</span></span> + line); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { System.err.println(<span class="hljs-string"><span class="hljs-string">"Can't parse line "</span></span> + line); e.printStackTrace(); } } writer.close(); reader.close();</code> </pre><br><br>  As a result, we have a file <br><br><pre> <code class="bash hljs">$ ls -sh /tmp/user.snap 16.1G /tmp/user.snap</code> </pre><br><br>  now you need to adjust space 0 accordingly. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#         slab . #        slab, #        2 . #       24 . slab_alloc_arena = 24 #          xlog . rows_per_wal = 500000 #      space 0 space[0].enabled = 1 # id.   box.auto_increment     TREE. space[0].index[0].type = "TREE" space[0].index[0].unique = 1 space[0].index[0].key_field[0].fieldno = 0 space[0].index[0].key_field[0].type = "NUM" #username space[0].index[1].type = "HASH" space[0].index[1].unique = 1 space[0].index[1].key_field[0].fieldno = 1 space[0].index[1].key_field[0].type = "STR" #password space[0].index[2].type = "HASH" space[0].index[2].unique = 1 space[0].index[2].key_field[0].fieldno = 2 space[0].index[2].key_field[0].type = "STR"</span></span></code> </pre><br><br>  Next, we need to replace the 00000000000000000001.snap located in the work_dir folder from the configuration file with the file we created. <br><br><pre> <code class="bash hljs">$ mv /tmp/user.snap /var/lib/tarantool/00000000000000000001.snap</code> </pre><br><br>  and try to start the server <br><br><pre> <code class="bash hljs">$ tarantool_box --background $ ps -C tarantool_box -o pid=,cmd= 8853 tarantool_box: primary pri: 33013 sec: 33014 adm: 33015</code> </pre><br><br>  also look at the tarantool.log file, in case of a successful launch it will end in lines similar to the ones below, in case of an error, you will immediately see the reason. <br><br><pre> <code class="bash hljs">1350504007.249 7127 1/<span class="hljs-built_in"><span class="hljs-built_in">sched</span></span> _ I&gt; Space 0: <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> 1350504007.249 7127 101/33013/primary _ I&gt; bound to port 33013 1350504007.249 7127 101/33013/primary _ I&gt; I am primary 1350504007.249 7127 102/33014/secondary _ I&gt; bound to port 33014 1350504007.250 7127 103/33015/admin _ I&gt; bound to port 33015 1350504007.251 7127 1/<span class="hljs-built_in"><span class="hljs-built_in">sched</span></span> _ C&gt; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> level 4 1350504007.251 7127 1/<span class="hljs-built_in"><span class="hljs-built_in">sched</span></span> _ C&gt; entering event loop</code> </pre><br><br>  Further, the correctness of data insertion can be checked in a simple way <br><br><pre> <code class="bash hljs">$ tarantool -a 127.0.0.1 127.0.0.1&gt; select * from t0 <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> k0 = 1 Select OK, 1 rows affected [1, <span class="hljs-string"><span class="hljs-string">'username'</span></span>, <span class="hljs-string"><span class="hljs-string">'email@domain.tld'</span></span>, <span class="hljs-string"><span class="hljs-string">'\x01'</span></span>, <span class="hljs-string"><span class="hljs-string">'\x21\x8b\xe4\xc9\x4c\x12'</span></span>] 127.0.0.1&gt; select * from t0 <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> k1 = <span class="hljs-string"><span class="hljs-string">'username'</span></span> Select OK, 1 rows affected [1, <span class="hljs-string"><span class="hljs-string">'username'</span></span>, <span class="hljs-string"><span class="hljs-string">'email@domain.tld'</span></span>, <span class="hljs-string"><span class="hljs-string">'\x01'</span></span>, <span class="hljs-string"><span class="hljs-string">'\x21\x8b\xe4\xc9\x4c\x12'</span></span>] 127.0.0.1&gt; select * from t0 <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> k2 = <span class="hljs-string"><span class="hljs-string">'email@domain.tld'</span></span> Select OK, 1 rows affected [1, <span class="hljs-string"><span class="hljs-string">'username'</span></span>, <span class="hljs-string"><span class="hljs-string">'email@domain.tld'</span></span>, <span class="hljs-string"><span class="hljs-string">'\x01'</span></span>, <span class="hljs-string"><span class="hljs-string">'\x21\x8b\xe4\xc9\x4c\x12'</span></span>]</code> </pre><br><br>  those.  we checked the data on the 3 keys specified by us in the config.  Then you can see the amount of memory consumed by the process in the system and the <b>show slab</b> command report in the Tarantool Box console. <br><br>  Tarantool Box is running, now you need to take care of backing up data and maintaining the MySQL table up to date in case some queries use data from it for their own purposes.  This is fairly simple to organize using the ReplicationClient class.  It will allow you to have an almost complete backup of xlog without using a full-fledged slave server and organize updating the table in MySQL without the cost of additional resources and time.  Do not forget to specify <b>replication_port</b> in the config to make replication possible.  The class described below saves all the logs received from the server into files with a length of 50 thousand records.  The algorithm is quite simple: <br>  1. search for existing logs <br>  2. determine the maximum lsn <br>  3. connection to the replication port <br>  4. translate the file into the file <br>  The MySQL update logic is missing in this code, but it is easy to implement it by slightly changing the loop in the main function.  The difficult place is the extension of the class <b>ReplicationClient</b> code, which writes the received data into a binary log, expanding it to the xlog format.  At this point, you can not stop too much, because  This example is more likely a blank for a real application than a demonstration of usage. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Backup</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> DecimalFormat xlogNameFormat = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DecimalFormat(<span class="hljs-string"><span class="hljs-string">"00000000000000000000"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String folder; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> FileChannel xlogChannel; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> row; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> limit = <span class="hljs-number"><span class="hljs-number">50000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lsn = <span class="hljs-number"><span class="hljs-number">0L</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ReplicationClient client; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> XLogWriter writer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setLimit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> limit)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.limit = limit; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Backup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String folder, String host, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> port)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.folder = folder; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLatestLSN</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String folder)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException, FileNotFoundException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> File backupFolder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(folder); String[] xlogs = backupFolder.list(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FilenameFilter() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(File dir, String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name.endsWith(<span class="hljs-string"><span class="hljs-string">".xlog"</span></span>); } }); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> hasLogs = xlogs != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; xlogs.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hasLogs) { Arrays.sort(xlogs); XLogReader reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XLogReader(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInputStream(folder + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + xlogs[xlogs.length - <span class="hljs-number"><span class="hljs-number">1</span></span>]).getChannel()); XLogEntry xlogEntry = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((xlogEntry = reader.nextEntry()) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { lsn = xlogEntry.header.lsn; } reader.close(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ getLatestLSN(folder); System.out.println(<span class="hljs-string"><span class="hljs-string">"Planning to start from lsn: "</span></span> + lsn); Runtime.getRuntime().addShutdownHook(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) { close(); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"Can't close xlog"</span></span>, e); } } })); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ByteBuffer rowStartMarker = ByteBuffer.allocate(<span class="hljs-number"><span class="hljs-number">4</span></span>).order(ByteOrder.LITTLE_ENDIAN).putInt(Const.ROW_START_MARKER); client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReplicationClient(SocketChannel.open(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InetSocketAddress(<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-number"><span class="hljs-number">33016</span></span>)), lsn + <span class="hljs-number"><span class="hljs-number">1L</span></span>) { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> ByteBuffer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readBody</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Header header)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Backup.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.xlogChannel == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Backup.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.xlogChannel = nextFile(folder); } ByteBuffer body = <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.readBody(header); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.header.flip(); rowStartMarker.flip(); <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (Backup.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (rowStartMarker.hasRemaining()) Backup.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.xlogChannel.write(rowStartMarker); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.header.hasRemaining()) Backup.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.xlogChannel.write(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.header); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (body.hasRemaining()) Backup.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.xlogChannel.write(body); Backup.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.xlogChannel.force(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); body.flip(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> body; } }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> XLogEntry </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextEntry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ XLogEntry entry = client.nextEntry(); lsn = entry.header.lsn; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (++row &gt;= limit) { close(); xlogChannel = nextFile(folder); row = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> entry; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> FileChannel </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String folder)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ String fileName = folder + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + xlogNameFormat.format(lsn + <span class="hljs-number"><span class="hljs-number">1L</span></span>) + <span class="hljs-string"><span class="hljs-string">".xlog"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(fileName).createNewFile(); FileChannel channel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(fileName, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>).getChannel(); writer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XLogWriter(channel); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> channel; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (writer != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { writer.close(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Backup backup = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Backup(<span class="hljs-string"><span class="hljs-string">"/home/dgreen/backup"</span></span>, <span class="hljs-string"><span class="hljs-string">"localhost"</span></span>, <span class="hljs-number"><span class="hljs-number">33016</span></span>); backup.start(); XLogEntry entry = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((entry = backup.nextEntry()) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { StringBuilder pk = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; entry.tuple.size(); i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pk.length() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { pk.append(<span class="hljs-string"><span class="hljs-string">" - "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (entry.tuple.getBytes(i).length) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: pk.append(String.valueOf(entry.tuple.getInt(i))); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>: pk.append(String.valueOf(entry.tuple.getLong(i))); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: pk.append(entry.tuple.getString(i, <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>)); } } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (entry.op) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Update.OP_CODE: System.out.println(<span class="hljs-string"><span class="hljs-string">"Got update on #"</span></span> + pk.toString()); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Insert.OP_CODE: System.out.println(<span class="hljs-string"><span class="hljs-string">"Got insert "</span></span> + pk.toString()); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Delete.OP_CODE: System.out.println(<span class="hljs-string"><span class="hljs-string">"Got delete of #"</span></span> + pk.toString()); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: System.out.println(<span class="hljs-string"><span class="hljs-string">"Got unknown op "</span></span> + entry.op + <span class="hljs-string"><span class="hljs-string">" "</span></span> + pk.toString()); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } }</code> </pre><br><br>  I would also like to separately note that when using the functionality of working with xlog files, it is almost impossible to lose data, even if you accidentally delete a tuple or clear the entire space, using the <b>XLogReader</b> and <b>XLogWriter classes</b> you can easily edit xlog. <br><br>  On this, in principle, everything, once again I remind you that in more detail about the connector you can find out at <a href="http://dgreenru.github.com/tarantool-java">dgreenru.github.com/tarantool-java</a> , the source code of the examples used is available in the repository on the github. </div><p>Source: <a href="https://habr.com/ru/post/155575/">https://habr.com/ru/post/155575/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../155561/index.html">Sony has released a 20-inch tablet with Windows 8</a></li>
<li><a href="../155563/index.html">The quarter-finals of the Moscow region Acm Icpc</a></li>
<li><a href="../155565/index.html">Overcoming a disconnection of a remote connection in the absence of user actions</a></li>
<li><a href="../155567/index.html">How we collect data for Nokia Maps</a></li>
<li><a href="../155571/index.html">Perl6 - Classes</a></li>
<li><a href="../155579/index.html">Thinking Reactively. Meteor js</a></li>
<li><a href="../155587/index.html">"Gray" phones in Ukraine. Should I buy?</a></li>
<li><a href="../155591/index.html">How to understand how much you are worth, or payroll clusters in action!</a></li>
<li><a href="../155593/index.html">We equip the workplace of the programmer in the village</a></li>
<li><a href="../155597/index.html">ZTE V881 smartphone review</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>