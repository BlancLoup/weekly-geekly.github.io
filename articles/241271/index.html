<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating custom OIDs for monitoring systems on Cach√© using SNMP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day (evenings, nights, mornings - underline as necessary) to all habrogens! 
 This post focuses on monitoring the Cach√© instance using SNMP . Sur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating custom OIDs for monitoring systems on Cach√© using SNMP</h1><div class="post__text post__text-html js-mediator-article">  Good day (evenings, nights, mornings - underline as necessary) to all habrogens! <br>  This post focuses on monitoring the Cach√© instance using <a href="https://ru.wikipedia.org/wiki/SNMP">SNMP</a> .  Surely, many Cach√© users are already using this to some extent.  Monitoring via SNMP has been supported in a standard Cach√© installation for a long time, but not all parameters of interest are available from the ‚Äúbox‚Äù.  For example, I would like to see the monitoring of the number of CSP sessions, more detailed information on the use of a license, private KPIs of the system being used, etc. <br>  In this article, you will learn how to add your own settings for monitoring Cach√© using SNMP. <br><a name="habracut"></a><br>  <b>What we already have</b> <br>  Cach√© can be monitored using SNMP.  A list of what is already supported can be seen in the files &lt;Install_dir&gt; / SNMP directory.  Usually there are 2 files: <i>ISC-CACHE.mib</i> and <i>ISC-ENSEMBLE.mib</i> .  We are interested in the file for Cach√© - <i>ISC-CACHE.mib</i> .  For example, we are interested in what we can get regarding licenses and sessions.  The table shows the corresponding OIDs, taking into account that the hierarchy is taken from the root for Intersystems - <i>1.3.6.1.4.1.16563</i> <br><table><tbody><tr><th>  OID </th><th>  Title </th><th>  Description </th><th>  Data type </th></tr><tr><td>  .1.1.1.1.10 </td><td>  cacheSysLicenseUsed </td><td>  The current number of licenses used on this Cach√© instance </td><td>  INTEGER </td></tr><tr><td>  .1.1.1.1.11 </td><td>  cacheSysLicenseHigh </td><td>  The high-water mark for licenses used on this Cach√© instance </td><td>  INTEGER </td></tr><tr><td>  .1.2.16 </td><td>  cacheLicenseExceed </td><td>  A license for a license has exceeded the license available or allowed </td><td>  Trap message </td></tr><tr><td>  .1.1.1.1.6 </td><td>  cacheSysCurUser </td><td>  Current number of users on this cach√© instance </td><td>  INTEGER </td></tr></tbody></table><br>  Many important indicators are missing in the delivery, for example, the number of CSP sessions, license information is incomplete and, of course, there is no monitoring of application-specific indicators. <br>  An example of what we would like to know: <br><ul><li>  How many CSP users do we have? </li><li>  Limiting our license to users; </li><li>  When the license key is over. </li></ul><br>  Add a couple of parameters to evaluate the performance.  The parameters themselves are in the delivery, but we want to know their increment per minute, for example: <br><ul><li>  The increase in "global" links per minute; </li><li>  The number of commands executed per minute; </li><li>  The number of call routines per minute. </li></ul><br><br>  <b>How to add "your" parameters</b> <br>  You can rely on the document " <a href="">Monitoring Cach√© using SNMP</a> ". <br>  Our test instance (TEST) is version <i>Cach√© 2013.1.3</i> .  The operating system is <i>Linux CentOS release 6.5 (Final)</i> .  Installing Cache on Linux OS is described in <a href="http://habrahabr.ru/company/intersystems/blog/217567/">habr</a> .  The native <a href="">documentation from InterSystems</a> will also be useful. <br>  Here is a brief work plan: <br><ol><li>  Create a class to collect metrics; </li><li>  Register and activate a new class in Cach√© with ^% SYSMONMGR; </li><li>  Create a custom MIB using the methods of the class <a href="">MonitorTools.SNMP.</a>  To begin with, PEN (Private Enterprise Number) will take the fictitious 99990, then you need to register with IANA.  This procedure is free, takes a week or two and is accompanied by a short correspondence of the form ‚Äúwhy did you need your PEN‚Äù; </li><li>  We start the monitoring service with the connected Cach√© subagent; </li><li>  Using snmpwalk, we check that our newly created custom OIDs are available to us; </li><li>  We add our OIDs to a third-party monitoring system.  For example, take <a href="http://www.zabbix.com/download.php">Zabbix</a> .  Zabbix documentation can be found <a href="http://www.zabbix.com/documentation.php">here</a> .  By installing and configuring Zabbix specifically on CentOS, you can see it <a href="https://www.zabbix.com/documentation/ru/2.0/manual/installation/install_from_packages">here</a> .  Make sure the monitoring works; </li><li>  Add the launch of the system monitor in our TEST area at system startup. </li></ol><br>  And now we carry out the plan point by point. <br>  <b>1. Create a class to collect metrics</b> <br>  The metrics collection class is inherited from <a href="">% Monitor.Adaptor</a> .  In the studio go to the area% SYS.  Export the Monitor package.  The package contains a private class Sample, which is not visible from the Studio, but is available when exporting to xml. <br>  Suppose our work area is a TEST area.  Go to her.  Import the class Monitor.Sample here.  We create a class in which we describe the implementation of withdrawing the 6 metrics indicated above in the section ‚ÄúWhat we already have‚Äù. <br><div class="spoiler">  <b class="spoiler_title">Class metrics.snmp.Metrics</b> <div class="spoiler_text">  <font color="#000080">Class metrics.snmp.Metrics Extends% Monitor.Adaptor</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#000080">/// Give the application a name.</font>  <font color="#000080">This allows you to group different</font> <font color="#000080"><br></font>  <font color="#000080">/// classes together under the same SNMP MIB.</font> <font color="#000080"><br></font>  <font color="#000080">/// The default is the package name.</font> <font color="#000080"><br></font>  <font color="#000080">Parameter</font> <font color="#000000">APPLICATION =</font> <font color="#800080">"Monitoring"</font> <font color="#000000">;</font> <font color="#000000"><br></font>  <font color="#000080">/// CSP sessions count</font> <font color="#000080"><br></font>  <font color="#000080">Property</font> <font color="#000000">Sessions</font> <font color="#000080">As% Monitor.Integer</font> <font color="#000000">;</font> <font color="#000000"><br></font>  <font color="#000080">/// License user limit</font> <font color="#000080"><br></font>  <font color="#000080">Property</font> <font color="#000000">KeyLicenseUnits</font> <font color="#000080">As% Monitor.Integer</font> <font color="#000000">;</font> <font color="#000000"><br></font>  <font color="#000080">/// License key expiration date</font> <font color="#000080"><br></font>  <font color="#000080">Property</font> <font color="#000000">KeyExpirationDate</font> <font color="#000080">As% Monitor.String</font> <font color="#000000">;</font> <font color="#000000"><br></font>  <font color="#000080">/// Global references speed</font> <font color="#000080"><br></font>  <font color="#000080">Property</font> <font color="#000000">GloRefSpeed</font> <font color="#000080">As% Monitor.Integer</font> <font color="#000000">;</font> <font color="#000000"><br></font>  <font color="#000080">/// Number of commands executed</font> <font color="#000080"><br></font>  <font color="#000080">Property</font> <font color="#000000">ExecutedSpeed</font> <font color="#000080">As% Monitor.Integer</font> <font color="#000000">;</font> <font color="#000000"><br></font>  <font color="#000080">/// Number of routine loads / save</font> <font color="#000080"><br></font>  <font color="#000080">Property</font> <font color="#000000">RoutineLoadSpeed</font> <font color="#000080">As% Monitor.Integer</font> <font color="#000000">;</font> <font color="#000000"><br></font>  <font color="#000080">/// The method is REQUIRED.</font>  <font color="#000080">It is where the Application Monitor</font> <font color="#000080"><br></font>  <font color="#000080">/// calls to collect data samples</font> <font color="#000080"><br></font>  <font color="#000080">/// ^ SNMP server process when requested.</font> <font color="#000080"><br></font>  <font color="#000080">Method</font> <font color="#000000">GetSample ()</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#000000">..</font> <font color="#0000ff">Sessions</font> <font color="#000000">= ..</font> <font color="#0000ff">getSessions</font> <font color="#000000">()</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#000000">..</font> <font color="#0000ff">KeyLicenseUnits</font> <font color="#000000">= ..</font> <font color="#0000ff">getKeyLicenseUnits</font> <font color="#000000">()</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#000000">..</font> <font color="#0000ff">KeyExpirationDate</font> <font color="#000000">= ..</font> <font color="#0000ff">getKeyExpirationDate</font> <font color="#000000">()</font> <font color="#000000"><br><br></font>  <font color="#0000ff">set</font> <font color="#800000">perfList</font> <font color="#000000">= ..</font> <font color="#0000ff">getPerformance</font> <font color="#000000">()</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#000000">..</font> <font color="#0000ff">GloRefSpeed</font> <font color="#000000">=</font> <font color="#0000ff">$ listget</font> <font color="#000000">(</font> <font color="#800000">perfList</font> <font color="#000000">, 1)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#000000">..</font> <font color="#0000ff">ExecutedSpeed</font> <font color="#000000">=</font> <font color="#0000ff">$ listget</font> <font color="#000000">(</font> <font color="#800000">perfList</font> <font color="#000000">, 2)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#000000">..</font> <font color="#0000ff">RoutineLoadSpeed</font> <font color="#000000">=</font> <font color="#0000ff">$ listget</font> <font color="#000000">(</font> <font color="#800000">perfList</font> <font color="#000000">, 3)</font> <font color="#000000"><br></font>  <font color="#0000ff">quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br></font>  <font color="#000080">/// Get CSP sessions count</font> <font color="#000080"><br></font>  <font color="#000080">Method</font> <font color="#000000">getSessions ()</font> <font color="#000080">As% Integer</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#008000">// q $ system.License.CSPUsers () // This method will only work if we dont 'use WebAddon</font> <font color="#008000"><br></font>  <font color="#008000">// This will work even if we use WebAddon</font> <font color="#008000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">csp</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#0000ff">try</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">set</font> <font color="#800000">cn</font> <font color="#000000">=</font> <font color="#0000ff">$ NAMESPACE</font> <font color="#0000ff"><br></font>  <font color="#0000ff">znspace</font> <font color="#008000">"%</font> <font color="#0000ff">sys</font> <font color="#008000">"</font> <font color="#008000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">db</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">SYS.Stats.Dashboard</font> <font color="#000000">).</font>  <font color="#0000ff">Sample</font> <font color="#000000">()</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">csp</font> <font color="#000000">=</font> <font color="#800000">db</font> <font color="#000000">.</font>  <font color="#0000ff">CSPSessions</font> <font color="#0000ff"><br></font>  <font color="#0000ff">znspace</font> <font color="#800000">cn</font> <font color="#800000"><br></font>  <font color="#800080">}</font> <font color="#0000ff">catch</font> <font color="#800000">e</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">set</font> <font color="#800000">csp</font> <font color="#000000">=</font> <font color="#008000">"0"</font> <font color="#008000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">quit</font> <font color="#800000">csp</font> <font color="#800000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br></font>  <font color="#000080">/// Get license user's power</font> <font color="#000080"><br></font>  <font color="#000080">Method</font> <font color="#000000">getKeyLicenseUnits ()</font> <font color="#000080">As% Integer</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">quit $ system</font> <font color="#008080">.License</font> <font color="#000000">.</font>  <font color="#0000ff">KeyLicenseUnits</font> <font color="#000000">()</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br></font>  <font color="#000080">/// Get license expiration date in human-readable format</font> <font color="#000080"><br></font>  <font color="#000080">Method</font> <font color="#000000">getKeyExpirationDate ()</font> <font color="#000080">As% String</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">quit $ zdate</font> <font color="#000000">(</font> <font color="#0000ff">$ system</font> <font color="#008080">.License</font> <font color="#000000">.</font> <font color="#0000ff">KeyExpirationDate</font> <font color="#000000">(), 3)</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br></font>  <font color="#000080">/// Get performance metrics (gloref, rourines etc.)</font> <font color="#000080"><br></font>  <font color="#000080">Method</font> <font color="#000000">getPerformance (</font> <font color="#ff00ff">param</font> <font color="#000080">As% String</font> <font color="#000000">)</font> <font color="#000080">As% Integer</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">cn</font> <font color="#000000">=</font> <font color="#0000ff">$ NAMESPACE</font> <font color="#0000ff"><br></font>  <font color="#0000ff">znspace</font> <font color="#008000">"%</font> <font color="#0000ff">sys</font> <font color="#008000">"</font> <font color="#008000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">m</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">SYS.Monitor.SystemSensors</font> <font color="#000000">).</font>  <font color="#0000ff">% New</font> <font color="#000000">()</font> <font color="#000000"><br></font>  <font color="#0000ff">do</font> <font color="#800000">m</font> <font color="#000000">.</font>  <font color="#0000ff">GetSensors</font> <font color="#000000">()</font> <font color="#000000"><br></font>  <font color="#0000ff">znspace</font> <font color="#800000">cn</font> <font color="#800000"><br></font>  <font color="#0000ff">quit $ listbuild</font> <font color="#000000">(</font> <font color="#800000">m</font> <font color="#000000">.</font> <font color="#0000ff">SensorReading</font> <font color="#000000">(</font> <font color="#008000">"GlobalRefsPerMin"</font> <font color="#000000">),</font> <font color="#000000"><br></font>  <font color="#800000">m</font> <font color="#000000">.</font>  <font color="#0000ff">SensorReading</font> <font color="#000000">(</font> <font color="#008000">"RoutineCommandsPerMin"</font> <font color="#000000">),</font> <font color="#000000"><br></font>  <font color="#800000">m</font> <font color="#000000">.</font>  <font color="#0000ff">SensorReading</font> <font color="#000000">(</font> <font color="#008000">"RoutineLoadsPerMin"</font> <font color="#000000">))</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br></font>  <font color="#000000">}</font> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </div></div><br>  We check that the data we need is unloaded by calling the GetSample () method: <br><div class="spoiler">  <b class="spoiler_title">Checking GetSample () operation</b> <div class="spoiler_text">  TEST&gt; sx = ## class (metrics.snmp.Metrics).% New () <br><br>  TEST&gt; d x.GetSample () <br><br>  TEST&gt; zw x <br>  x = &lt;OBJECT REFERENCE&gt; [2@metrics.snmp.Metrics] <br>  + ----------------- general information - |  oref value: 2 <br>  |  class name: metrics.snmp.Metrics <br>  |  reference count: 2 <br>  + ----------------- attribute values ‚Äã‚Äã- |  ExecutedSpeed ‚Äã‚Äã= 1155679 <br>  |  GloRefSpeed ‚Äã‚Äã= 171316 <br>  |  KeyExpirationDate = "2014-10-11" <br>  |  KeyLicenseUnits = 100 <br>  |  RoutineLoadSpeed ‚Äã‚Äã= 186 <br>  |  Sessions = 1 <br></div></div><br>  <b>2. Register and activate a new class in Cach√© with ^% SYSMONMGR</b> <br>  Open the terminal and go to the TEST area: <br><div class="spoiler">  <b class="spoiler_title">We connect the system monitor</b> <div class="spoiler_text">  [root @ server ~] # csession test -U test <br>  Host: server, Instance: TEST <br><br>  TEST&gt; <b>d ^% SYSMONMGR</b> <br>  1. Select <b>item 5, Manage Application Monitor.</b> <br>  2. Select <b>item 2, Manage Monitor Classes.</b> <br>  3. Select <b>item 3, Register Monitor System Classes.</b>  Watching the compilation: <br><br>  Export to XML began on 08/18/2014 16:00:51 <br>  Exported class: Monitor.Sample <br>  Export completed successfully. <br><br>  The download began on 08/18/2014 16:00:51 <br>  Download file /opt/intersystems/ensemble/mgr/Temp/45DDB3FppRHCuw.stream as xml <br>  Import Class: Monitor.Sample <br>  Class Compilation: Monitor.Sample <br>  Compiling the program :: Monitor.Sample.G1.MAC <br>  Compile table: Monitor.Sample <br>  Compile the program: Monitor.Sample.1 <br>  Download completed successfully. <br><br>  4. Select <b>item 1, Activate / Deactivate Monitor Class</b> <br>  Class ?? <br>  Num MetricsClassName Activated <br>  1)% Monitor.System.AuditCount N <br>  ... <br>  15) metrics.snmp.Metrics N <br><br>  Class?  15 metrics.snmp.Metrics <br>  Activate class?  Yes =&gt; Yes <br><br>  5. Select <b>item 6, Exit</b> <br>  6. Once again, select <b>item 6, Exit</b> <br>  7. Choose <b>item 1, Start / Stop System Monitor</b> <br>  8. Choose <b>item 2, Stop System Monitor</b> <br>  Stopping System Monitor ... System Monitor not running! <br><br>  9. Choose <b>item 1, Start System Monitor</b> <br>  Starting System Monitor ... System Monitor started <br>  10. Choose <b>item 3, Exit</b> <br>  11. Select <b>item 4, View System Monitor State</b> <br>  Component state <br>  System Monitor OK <br>  % SYS.Monitor.AppMonSensor <br></div></div><br>  3. <b>Create a custom MIB</b> <br>  A custom MIB is created using the methods of the <a href="">MonitorTools.SNMP</a> class.  For example, PEN (Private Enterprise Number) will take the dummy, 99990, then the PEN must be registered with <a href="">IANA</a> .  View already registered rooms <a href="http://www.iana.org/assignments/enterprise-numbers/enterprise-numbers">here</a> .  For example, PEN InterSystems has the number 16563. <br>  <i>16563</i> <i><br></i>  <i>InterSystems</i> <i><br></i>  <i>Robert Davis</i> <i><br></i>  <i>rdavis &amp; intersystems.com</i> <br>  To create a MIB file, we will use the <a href="">MonitorTools.SNMP</a> class, in particular, the <a href="">CreateMIB ()</a> method.  This method takes 10 arguments as input: <br><table><tbody><tr><th>  Name and type of argument </th><th>  Description </th><th>  What we substitute </th></tr><tr><td>  AppName As <a href="">% String</a> </td><td>  app name </td><td>  The value of the APPLICATION parameter of the class metrics.snmp.Metrics - Monitoring </td></tr><tr><td>  Namespace As <a href="">% String</a> </td><td>  Our area </td><td>  TEST </td></tr><tr><td>  EntID As <a href="">% Integer</a> </td><td>  PEN companies </td><td>  99990 (Fiction) </td></tr><tr><td>  AppID As <a href="">% Integer</a> </td><td>  OID applications within the company </td><td>  42 </td></tr><tr><td>  Company As <a href="">% String</a> </td><td>  company name (uppercase) </td><td>  fiction </td></tr><tr><td>  Prefix As <a href="">% String</a> </td><td>  the prefix of all the SNMP objects we create </td><td>  fiction </td></tr><tr><td>  CompanyShort As <a href="">% String</a> </td><td>  short company prefix (uppercase) </td><td>  fict </td></tr><tr><td>  MIBname As <a href="">% String</a> </td><td>  MIB file name </td><td>  ISC-TEST </td></tr><tr><td>  Contact As <a href="">% String</a> </td><td>  contact information (in particular, address) </td><td>  Leave the default value: Earth, Russia, Somewhere in the forests, Subject: ISC-TEST.mib </td></tr><tr><td>  List As <a href="">% Boolean</a> </td><td>  Analog verbose.  Show the progress of the job to create a MIB file </td><td>  one </td></tr></tbody></table><br>  Actually, the creation of a MIB file: <br><div class="spoiler">  <b class="spoiler_title">CreateMIB ()</b> <div class="spoiler_text"> % SYS&gt; <b>d ## class (MonitorTools.SNMP) .CreateMIB ("Monitoring", "TEST", 99990,42, "fiction", "fict", "fiction", "ISC-TEST", 1)</b> <br>  Create SNMP structure for Application - Monitoring <br>  Group - Metrics <br>  ExecutedSpeed ‚Äã‚Äã= Integer <br>  GloRefSpeed ‚Äã‚Äã= Integer <br>  KeyExpirationDate = String <br>  KeyLicenseUnits = Integer <br>  RoutineLoadSpeed ‚Äã‚Äã= Integer <br>  Sessions = Integer <br><br>  Create MIB file for Monitoring <br>  Generate table Metrics <br>  Add object ExecutedSpeed, Type = Integer <br>  Add object GloRefSpeed, Type = Integer <br>  Add object KeyExpirationDate, Type = String <br>  Add object KeyLicenseUnits, Type = Integer <br>  Add object RoutineLoadSpeed, Type = Integer <br>  Add object Sessions, Type = Integer <br>  MIB done. <br></div></div><br>  A new MIB ISC-TEST.mib has appeared in the &lt;Install_dir&gt; / mgr / TEST directory. <br><br>  4. <b>Start the monitoring service with the connected Cach√© subagent.</b> <br>  Open the <i>System Administration</i> Control Panel <i>-&gt; Security -&gt; Services -&gt;% Service_Monitor (click) -&gt; Service Enabled (check)</i> . <br><img src="https://habrastorage.org/files/401/9c6/45e/4019c645eec74304ab82c9fef78259fc.jpg"><br><img src="https://habrastorage.org/files/b1e/1bb/915/b1e1bb915d284c439a8db7ca005c0b90.jpg"><br>  We also indicate that we want to start the SNMP subagent when Cach√© starts (click Configure Monitor Settings): <br><img src="https://habrastorage.org/files/405/611/d01/405611d01ee441e2b1509de630f0e826.jpg"><br>  On Linux CentOS, we use the net-snmp package for SNMP monitoring.  We install it, configure it on the use of subagents, and that the master agent and subagents will communicate via the standard port 705. <br><br>  <i>[root @ server ~] # grep -i agentx / etc / services</i> <i><br></i>  <i>agentx 705 / tcp # AgentX</i> <i><br></i>  <i>agentx 705 / udp # AgentX</i> <br><br>  A small article on the snmpd.conf configuration file in addition to the <a href="http://www.net-snmp.org/docs/man/snmpd.conf.html">mana</a> can be viewed on <a href="http://www.cyberciti.biz/nixcraft/linux/docs/uniqlinuxfeatures/mrtg/mrtg_config_step_3.php">cyberciti</a> .  Here is our final setting: <br><div class="spoiler">  <b class="spoiler_title">Our snmpd.conf</b> <div class="spoiler_text">  [root @ server ~] # yum install net-snmp <br>  [root @ server ~] # grep '^ [^ #]' /etc/snmp/snmpd.conf <br>  master agentx <br>  agentXSocket TCP: localhost: 705 <br>  com2sec local localhost public <br>  group MyRWGroup v1 local <br>  group MyRWGroup v2c local <br>  group MyRWGroup usm local <br>  view all included .1 80 <br>  view system included .iso.org.dod <br>  access MyROGroup "" any noauth exact all none none <br>  access MyRWGroup "any noauth exact all all none <br>  syslocation server (edit /etc/snmp/snmpd.conf) <br>  syscontact Root &lt;root @ localhost&gt; (configure /etc/snmp/snmp.local.conf) <br>  dontLogTCPWrappersConnects yes <br></div></div><br>  Restarting Linux snmpd and snmptrapd demons.  We start the ^ SNMP service to get started with the Cach√© SNMP subagent: <br>  <i>% Sys&gt; d start ^ SNMP</i> <br><br>  5. <b>Check that our newly created user OIDs are available</b> . <br>  This can be done using snmpwalk - we will show an OID that displays the number of CSP sessions: <br><br>  <i>[root @ server mgr] # snmpwalk -On -v 2c -c public localhost 1.3.6.1.4.1.99990</i> <i><br></i>  <i>.1.3.6.1.4.1.99990.42.1.1.1.1.4.84.69.86.84 = INTEGER: 448035</i> <i><br></i>  <i>.1.3.6.1.4.1.99990.42.1.1.1.2.4.84.69.88.8 = INTEGER: 64190</i> <i><br></i>  <i>.1.3.6.1.4.1.99990.42.1.1.1.3.4.84.69.83.84 = STRING: "2014-10-11"</i> <i><br></i>  <i>.1.3.6.1.4.1.99990.42.1.1.1.4.4.84.69.86.84 = INTEGER: 200</i> <i><br></i>  <i>.1.3.6.1.4.1.99990.42.1.1.1.4.4.84.69.83.84 = INTEGER: 93</i> <i><br></i>  <i>.1.3.6.1.4.1.99990.42.1.1.1.6.4.84.69.83.84 = INTEGER: 1</i> <br><br>  The file ISC-TEST.mib indicates the sequence of our OIDs: <br><br>  <i>FictMetricsR :: =</i> <i><br></i>  <i>SEQUENCE {</i> <i><br></i>  <i>fictExecutedSpeed ‚Äã‚ÄãInteger32,</i> <i><br></i>  <i>fictGloRefSpeed ‚Äã‚ÄãInteger32,</i> <i><br></i>  <i>fictKeyExpirationDate DisplayString,</i> <i><br></i>  <i>fictKeyLicenseUnits Integer32,</i> <i><br></i>  <i>fictRoutineLoadSpeed ‚Äã‚ÄãInteger32,</i> <i><br></i>  <i>fictSessions Integer32</i> <i><br></i>  <i>}</i> <i><br></i> <br>  Accordingly, for example, the number of sessions is the last OID 1.3.6.1.4.1.99990.42.1.1.1.6.  You can compare with the number of sessions shown by SMP dashboard: <br><img src="https://habrastorage.org/files/571/bfe/ec8/571bfeec878c4a38be2698907b316c6e.jpg"><br><br>  6. <b>Add our OIDs to a third-party monitoring system.</b> <br>  For example, take <a href="http://www.zabbix.com/download.php">Zabbix</a> .  Zabbix documentation can be found <a href="http://www.zabbix.com/documentation.php">here</a> .  By installing and configuring Zabbix specifically on CentOS, you can see it <a href="https://www.zabbix.com/documentation/ru/2.0/manual/installation/install_from_packages">here</a> .  Zabbix was chosen as a system that allows not only to draw graphics, but also to monitor Plain Text (in our case, this is the license expiration date and license power by users).  After adding our 6 metrics to the <a href="https://www.zabbix.com/documentation/ru/2.0/manual/config/items/item">Items of</a> our local host and creating 4 <a href="https://www.zabbix.com/documentation/ru/2.0/manual/config/visualisation/graphs/custom">graphs</a> and 2 PlainText parameters (like <a href="https://www.zabbix.com/documentation/2.0/manual/config/visualisation/screens">screen</a> elements), we see the following picture (an example of a small ‚Äúlive‚Äù system is shown): <br><img src="https://habrastorage.org/files/e4e/055/d32/e4e055d321864fb9b59024efebe8b28a.jpg"><br>  At the top - information about when the license ends, and how many license slots we have.  The graphs speak for themselves. <br><br>  7. <b>Add the launch of the system monitor in our TEST area at system startup</b> <br>  There is a good <a href="http://docs.intersystems.com/documentation/cache/cache51/PDFS/AZSS_ZStartZStop.pdf">document</a> on the use of custom routines that are triggered when Cach√© starts and stops.  They are called respectively% ZSTART and% ZSTOP. <br>  What we are interested in in all of this is to raise the system monitor (^% SYSMONMGR) in the TEST user area at the start.  By default, this monitor starts only in the% SYS area.  Accordingly, we will consider only the program ^% ZSTART.  Source% ZSTART.mac (create and save it in the% SYS area). <br><div class="spoiler">  <b class="spoiler_title">Our autostart</b> <div class="spoiler_text">  <font color="#ff0000">% ZSTART</font> <font color="#008000">;</font>  <font color="#008000">User startup routine.</font> <font color="#008000"><br></font>  <font color="#ff0000">SYSTEM</font> <font color="#008000">;</font> <font color="#008000"><br></font>  <font color="#008000">;</font>  <font color="#008000">Cache starting</font> <font color="#008000"><br></font>  <font color="#0000ff">do $ zu</font> <font color="#000000">(9,</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#008000">"Starting System Monitor in TEST namespace by ^% ZSTART ... Begin"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">znspace</font> <font color="#008000">"TEST"</font> <font color="#008000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">sc</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% SYS.Monitor</font> <font color="#000000">).</font>  <font color="#0000ff">Start</font> <font color="#000000">()</font> <font color="#000000"><br></font>  <font color="#0000ff">do $ system</font> <font color="#008080">.OBJ</font> <font color="#000000">.</font>  <font color="#0000ff">DisplayError</font> <font color="#000000">(</font> <font color="#800000">sc</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">if</font> <font color="#000000">(</font> <font color="#800000">sc</font> <font color="#000000">= 1)</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">do $ zutil</font> <font color="#000000">(9,</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#008000">"Starting System Monitor in TEST namespace by ^% ZSTART ... OK"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#0000ff">else</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">do $ zutil</font> <font color="#000000">(9,</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#008000">"Starting System Monitor in TEST namespace by ^% ZSTART ... ERROR"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#008000">;</font>  <font color="#008000">Starting SNMP</font> <font color="#008000"><br></font>  <font color="#0000ff">znspace</font> <font color="#008000">"%</font> <font color="#0000ff">sys</font> <font color="#008000">"</font> <font color="#008000"><br></font>  <font color="#0000ff">do</font> <font color="#ff0000">start</font> <font color="#000000">^ SNMP</font> <font color="#000000"><br></font>  <font color="#0000ff">quit</font> <font color="#0000ff"><br></font>  <font color="#ff0000">LOGIN</font> <font color="#008000">;</font> <font color="#008000"><br></font>  <font color="#008000">;</font>  <font color="#008000">a user logs into Cache (user account or telnet)</font> <font color="#008000"><br></font>  <font color="#0000ff">quit</font> <font color="#0000ff"><br></font>  <font color="#ff0000">JOB</font> <font color="#008000">;</font> <font color="#008000"><br></font>  <font color="#008000">;</font>  <font color="#008000">JOB'd process begins</font> <font color="#008000"><br></font>  <font color="#0000ff">quit</font> <font color="#0000ff"><br></font>  <font color="#ff0000">CALLIN</font> <font color="#008000">;</font> <font color="#008000"><br></font>  <font color="#008000">;</font>  <font color="#008000">a process enters via CALLIN interface</font> <font color="#008000"><br></font>  <font color="#0000ff">quit</font> <br></div></div><br><br>  Restart (if possible) Cach√© to make sure that the collection of SNMP statistics after the restart of Cach√© continues. <br>  That's all.  Perhaps someone will have comments on the choice of monitoring parameters or code, but the task was to show the possibility of such monitoring in principle, and you can always add the necessary parameter or refactor the code in the future. <br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/241271/">https://habr.com/ru/post/241271/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../241261/index.html">Microsoft Azure Cloud Hot Announcements: Bigger, Faster, and More Open</a></li>
<li><a href="../241263/index.html">Rushim Captcha SilkRoad 2.0</a></li>
<li><a href="../241265/index.html">How to quickly and easily write DSL in Ruby</a></li>
<li><a href="../241267/index.html">Ciklum Java Subbotnik in Kiev, November 1</a></li>
<li><a href="../241269/index.html">GenerationS named the best technological startups in Russia</a></li>
<li><a href="../241273/index.html">Published ranking of countries most affected by hackers</a></li>
<li><a href="../241275/index.html">Ecmascript 6 - what you can use now</a></li>
<li><a href="../241277/index.html">LinkMeUp. Issue number 20. Xgu.ru and networking technology courses</a></li>
<li><a href="../241281/index.html">Recognition and automatic solution of equations</a></li>
<li><a href="../241283/index.html">Business consultant in small and medium-sized businesses. Who is it and why is it needed?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>