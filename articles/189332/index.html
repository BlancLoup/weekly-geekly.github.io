<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SIP client interaction. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article, we looked at the simple interaction of SIP clients without using a proxy server. Such interaction in practice is extremely ra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SIP client interaction. Part 2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/643/583/958/64358395829d404a792872b83a17b4f9.jpg"><br><br>  In the previous <a href="http://habrahabr.ru/post/188352">article,</a> we looked at the simple interaction of SIP clients without using a proxy server.  Such interaction in practice is extremely rare, but it is excellent for understanding the basics of SIP. <br><br>  Now that we have dealt with the basic things, I propose to go over to the actual operation of the protocol. <br><a name="habracut"></a><br>  In this article I plan to consider three questions: <br><ol><li>  Selection of transport protocol and search for proxy; </li><li>  Work through a proxy; </li><li>  Registration on the proxy server. </li></ol><br><h4>  Select a transport protocol and search for proxy </h4><br>  Since the SIP protocol supports several transport protocols (UDP, TCP, SCTP, TLS), it is necessary to somehow determine which protocol to use.  For this there are several ways. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The first method involves the explicit indication of the transport in the SIP URI (except TLS).  It looks like this: <br><br><img src="https://habrastorage.org/storage2/696/d46/2fb/696d462fb1c9f937ed13af710cb6381e.jpg"><br><br>  If the transport is not explicitly specified, then the following algorithm works: <br><ol><li>  If the SIP URI contains an IP address, UDP is used for the SIP URI, and TCP for SIPS (Secure SIP). </li><li>  If the IP address is not specified, but the port is specified, then the SIP URI is UDP, and the SIPS is TCP. </li><li>  If there is no IP address and port, but there is a corresponding NAPTR record in the DNS, then ‚ÄúSIP + D2U‚Äù corresponds to UDP, ‚ÄúSIP-D2T‚Äù indicates TCP and ‚ÄúSIP-D2S‚Äù indicates SCTP.  NAPTR contains a link to the SRV record that will be used to search for the Proxy server.  If NAPTR remains, then a query should be executed to find the SRV record. </li><li>  The result of the SRV request will be the name and port of the proxy server. </li><li>  If there is no SRV record, an A or AAAA request is made.  In this case, UDP is used for the SIP URI, and TCP is used for SIPS. </li></ol><br>  In order to better understand, consider an example when we want to contact the client sip: ivan@domain.ru: <br><br><img src="https://habrastorage.org/storage2/c6b/7e0/0f4/c6b7e00f475bd937911ecadae8fa2e49.jpg"><br><br>  So, we found out the parameters of Ivan's Proxy server.  Now I propose to consider the use of Proxy in the framework of the SIP-dialogue. <br><br>  <i><b>Remark for those who do not know what NAPTR.</b></i>  <i>I learned that there is such a type of DNS record only when I wrote this article, so do not despair.</i>  <i>A little more about NAPTR <a href="http://en.wikipedia.org/wiki/NAPTR_record">here</a> .</i> <br><br><h4>  Proxy Interaction </h4><br>  Why do we need SIP Proxy?  As I said, in the example from the 1st part of the article, clients knew each other's IP addresses and could communicate directly.  In real life, clients often receive addresses dynamically, so there is no point in ‚Äúremembering‚Äù one or another IP.  The first thing that comes to mind in this situation is to use A-records DNS and determine the real valid address.  However, the following problem lies here: the IP address identifies the particular device, not the user on it.  The peculiarity of SIP interaction is that the message exchange takes place not at the device-device level, but on user-user.  At the same time, one user can simultaneously use several SIP clients: on a mobile phone, on a work computer, on a home computer, and on a SIP phone.  How to be? <br><br>  SIP proposes the following solution: a SIP Proxy is created and each user registers his device with this Proxy (more precisely, users register with the registration server, and the Proxy has access to the registration database, but for simplicity, we assume that it is the same server).  How this is done, I will show below.  For now, just remember that Proxy knows exactly how to find a particular client user. <br><br>  When Peter calls Ivan, the following sequence of actions is performed: <br><ol><li>  Peter's SIP client determines Ivan‚Äôs SIP Proxy address and protocol (see above for how to do this) </li><li>  The client sends an INVITE request to the proxy. </li><li>  The proxy server looks at which devices Ivan has registered with and sends a request to all these devices. </li><li>  Ivan answers the call on one of the devices and sends 200 OK to the Proxy </li><li>  Proxy redirects 200 OK to Peter </li><li>  Peter receives Ivan‚Äôs SIP address on a specific device from the Contact field in the light 200 OK and sends the answer directly, bypassing Prxoy </li><li>  All subsequent communication also goes directly. </li></ol><br>  On the diagram, it looks like this: <br><br><img src="https://habrastorage.org/storage2/b3d/982/d22/b3d982d22084ec734ba37ff5cf036c6c.jpg"><br><br>  For those who have studied the first part of the article, everything looks quite familiar;  only intermediate proxy server was added.  Accordingly, the messaging has changed slightly. <br><br>  <i>Before we go into detail, a small remark.</i>  <i><b>Within SIP, two types of URIs are shared</b> .</i>  <i>The first of these is the user URI, also known as the address of recorf (AOR).</i>  <i>A request sent to this address involves searching the proxy database and sending the request to one or more devices.</i>  <i>The second is the device URI (or rather, the user on the device).</i>  <i>The device URI is usually called a contact and is contained, respectively, in the Contact field of a SIP message.</i>  <i>AOR is contained in the From and To fields.</i> <br><br><img src="https://habrastorage.org/storage2/a91/f8a/9ad/a91f8a9ad871492433e7aac8e4532cb8.jpg"><br><br><h5>  Start of conversation </h5><br>  So, Peter sends INVITE for Ivan to the proxy server: <br><br><img src="https://habrastorage.org/storage2/4c8/a8d/7a9/4c8a8d7a913ee74a6c86447eae6e56b0.jpg"><br>  The proxy server redirects the request to all Ivan's SIP clients.  For simplicity, suppose Ivan uses only one device.  In order for the SIP client to understand that the request was redirected through a proxy, the server adds its via header field: <br><br><img src="https://habrastorage.org/storage2/a09/c75/f73/a09c75f73cd16e0168df9d8c1bf350a0.jpg"><br><br>  Ivan's SIP client sends the answer to 180 Ringing (Ivan hears the call).  At the same time, he adds a tag in the To field and indicates his contact in the Contact field.  In addition, in the first via field, the received parameter was added, this parameter shows from which address the client Ivan received the request (that is, the address of the proxy server, as Ivan sees it).  This is useful to know to solve problems: <br><br><img src="https://habrastorage.org/storage2/6a2/b03/aab/6a2b03aabeb625b8c710330257990dd1.jpg"><br><br>  The proxy accordingly forwards the request to Peter‚Äôs client.  At the same time he removes his via: <br><br><img src="https://habrastorage.org/storage2/19e/dfc/554/19edfc554403531095f433038b4cff62.jpg"><br><br>  After sending 180 Ringing, as soon as Ivan answers the call, Ivan‚Äôs client sends a 200 OK response to Prxoy: <br><br><img src="https://habrastorage.org/storage2/4db/388/584/4db388584929bcc800071c454b5b5d60.jpg"><br><br>  Proxy sends this answer to Peter, removing at the same time via: <br><br><img src="https://habrastorage.org/storage2/1c1/5bf/aac/1c15bfaacd1b229031f6fe9d36c1558d.jpg"><br><br>  Now the fun part.  Peter's client sends an ACK message directly to Ivan's client, bypassing the proxy.  Moreover, if Ivan simultaneously used several SIP clients, the answer came precisely to the one that was needed.  What makes it possible? <br><br>  200 OK sent from the client on which Ivan picked up the phone.  Moreover, in the Contact field of the 200 OK response there is a URI corresponding to the user Ivan on a specific device.  Thus, the client of Peter sends the ASC to this device, after which the participation of the Proxy is no longer required: <br><br><img src="https://habrastorage.org/storage2/40e/3cb/dcb/40e3cbdcb8cc6746bdcdb4e53efff740.jpg"><br><br>  All other messages, including media traffic, bypass the proxy. <br><br><h5>  End of conversation </h5><br>  At the end of the conversation, Ivan‚Äôs client sends BYE directly to Peter‚Äôs client: <br><br><img src="https://habrastorage.org/storage2/533/26a/938/53326a9380ed428928096a156ca6ffb2.jpg"><br><br>  Peter responds by confirming: <br><br><img src="https://habrastorage.org/storage2/422/350/f82/422350f8219fa154a0396b2f04a85e62.jpg"><br>  Here everything is as in the first part of the article. <br><br>  So, we have considered the interaction of SIP-clients with the participation of the Prox-server.  Only one question remains: how did Proxy find out Ivan‚Äôs clients ‚Äôaddresses?  Using the registration procedure.  How this happens, I will tell below. <br><br><h4>  SIP registration </h4><br>  Registration is as follows: <br><br><img src="https://habrastorage.org/storage2/705/d54/70d/705d5470d2720a1367a71ed88fde74d3.jpg"><br><br>  Let's take a closer look at each of the messages.  Ivan sends a Register request to the server (for simplicity, we assume that the registration server role is installed on proxy.domain.ru).  The most important thing in this query is the Contact field.  This is Ivan‚Äôs address on a specific device: <br><br><img src="https://habrastorage.org/storage2/5ea/520/572/5ea520572c11ec9490d0983c33296101.jpg"><br><br>  In response, the server sends 401 Unauthorized, i.e. authorization request.  The most important field in the answer is WWW-Authenticate.  It is not difficult to guess that realm is a domain, and algorithm indicates which hash algorithm we will use.  Interest is the nonce field: <br><br><img src="https://habrastorage.org/storage2/826/9f1/44e/8269f144ea6231245a506bc6eba83126.jpg"><br><br>  Nonce is short for number used once.  Nonce is a one-time random sequence that Ivan‚Äôs client will combine with a password string, after which he will generate an MD5 hash from the resulting string and put the result in a new request in the WWW-Authenticate field (in fact, it is somewhat more complicated, but for simplicity, we assume that all that way).  To do this, use the response parameter. <br><br>  Why do you need nonce?  If the client generated MD5 from the password and did not use nonce, then the hash would be the same each time.  An attacker could intercept such a hash and use it for authorization.  It would be as insecure as passing a password in clear text. <br><br>  If you use nonce, MD5 is taken each time from a new line and turns out to be different.  Therefore, even intercepting the hash, the attacker is likely to not be able to use it for authorization. <br><br>  By the way, please note that the new registration request has a CSeq one more: <br><br><img src="https://habrastorage.org/storage2/b7b/fa4/474/b7bfa44742010c8aa689ed53043118cb.jpg"><br><br>  The server also combines nonce with Ivan's password and receives an MD5 hash.  After that, he compares his hash with the hash received from Ivan.  If they match, the server sends 200 OK.  Notice that the expires parameter has been added to the Contact field.  In this case, the registration will be stored in the server database for 3600 seconds or one hour: <br><br><img src="https://habrastorage.org/storage2/02d/816/298/02d816298a31ba2a89b4da3f08905663.jpg"><br><br>  If Ivan wants to renew the registration, he must send another REGISTER during this hour. <br><br>  What if Ivan uses several SIP-enabled devices at once?  Everything is very simple - you need to send a request for registration from each of them. <br><br>  After the corresponding entry appears in the database of the registration server, the proxy server will be able to redirect requests to Ivan's SIP clients. <br><br><h4>  Bonus for those who are interested </h4><br>  You may have noticed that, in response to a registration request, the server sends a response containing To-tag: <br><br><img src="https://habrastorage.org/storage2/02d/816/298/02d816298a31ba2a89b4da3f08905663.jpg"><br><br>  It is clear that when installing the dialog, this tag helps to avoid re-receiving the same message.  There is a rule for this: if the message does not contain To-tag and the UAS has already received a message with the same CSeq, From-tag and Call-ID, then the message is discarded.  What is the need for To-tag, if we do not establish a dialogue with the registration server.  The best answer I could find is that in RFC 3261 it is written that a 200 OK answer that comes to a request without To-tag should contain To-tag.  That is, it is not necessary for anything, but it is so accepted. <br><br>  I hope that the operation of the SIP protocol, after reading the article, has become more understandable to you.  I will be glad to your comments. </div><p>Source: <a href="https://habr.com/ru/post/189332/">https://habr.com/ru/post/189332/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../189310/index.html">Access to Netflix over IPv6 from outside the States</a></li>
<li><a href="../189314/index.html">We try Orchard CMS for a corporate site</a></li>
<li><a href="../189320/index.html">How GIL works in Ruby. Part 1</a></li>
<li><a href="../189328/index.html">Voronezh entered into a contract with the bank, making their changes, and is going to sue 24 million rubles</a></li>
<li><a href="../189330/index.html">BitByte Festival is a meeting place for the IT community</a></li>
<li><a href="../189334/index.html">ICFPC 2013 coming soon</a></li>
<li><a href="../189338/index.html">6 ways to protect copyright</a></li>
<li><a href="../189340/index.html">Surprise from Microsoft, or who is PCBP for Russia</a></li>
<li><a href="../189344/index.html">Correct analytics in a mobile application</a></li>
<li><a href="../189346/index.html">ASP.NET 2.0 Login control + MySQL, VS2008, authorization of users on the site</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>