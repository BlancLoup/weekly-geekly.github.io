<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Suricata as IPS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 It is sad to see that the articles on the prevention or prevention of intrusions on the site are so unpopular. 
 The course of the young fi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Suricata as IPS</h1><div class="post__text post__text-html js-mediator-article"><h4>  Foreword </h4><br>  It is sad to see that the articles on the prevention or prevention of intrusions on the site are so unpopular. <br>  <a href="https://habr.com/post/60769/">The course of the young fighter: protected by the router.</a>  <a href="https://habr.com/post/60769/">Continuation: IPS</a> - <b>5</b> pluses. <br>  <a href="https://habr.com/post/123474/">SNORT as a service IPS</a> - <b>25</b> advantages. <br>  <a href="https://habr.com/post/120700/">OSSEC: Big Brother is watching you</a> - <b>13</b> plus points. <br>  However, articles on the analysis of the consequences of penetration are very popular.  I will try to throw in another popularization of information security. <br><h4>  Suricata Description </h4><br><img src="https://habrastorage.org/storage3/0f7/6ae/891/0f76ae891d8b7c570dc2c2a0506edf1c.jpg"><br>  Intrusion Prevention System is a software or hardware network and computer security system that detects intrusions or security breaches and automatically protects them. <br>  IPS systems can be viewed as an extension of Intrusion Detection Systems (IDS), since the task of tracking attacks remains the same.  However, they differ in that IPS must monitor activity in real time and quickly implement actions to prevent attacks.  Possible measures are blocking traffic flows in the network, dropping connections, and issuing signals to the operator.  IPS can also perform packet defragmentation, TCP packet reordering to protect against packets with modified SEQ and ACK numbers. <br>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D1%2581%25D1%2582%25D0%25B5%25D0%25BC%25D0%25B0_%25D0%25BF%25D1%2580%25D0%25B5%25D0%25B4%25D0%25BE%25D1%2582%25D0%25B2%25D1%2580%25D0%25B0%25D1%2589%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F_%25D0%25B2%25D1%2582%25D0%25BE%25D1%2580%25D0%25B6%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B9">wiki</a> <br><br>  <a href="http://suricata-ids.org/">Suricata</a> is an open source IPS / IDS system.  Founded by developers who worked on the IPS version of Snort.  The main difference between Suricata and Snort is the ability to use the GPU in IDS mode, a more advanced IPS system, multitasking, as a result, high performance that allows processing traffic up to 10Gbit on conventional equipment, and much more, including full support for the Snort rule format.  It is better to read about everything on the <a href="http://suricata-ids.org/features/all-features/">official site</a> .  Today we will lose IPS. <br><a name="habracut"></a><br>  Suricata uses two IPS modes: <b>NFQ</b> and <b>AF_PACKET</b> <br><br>  <b>NFQ</b> IPS mode works as follows: <br>  1) Package gets into iptables <br>  2) The iptables rule sends it to the NFQUEUE queue, for example <b>iptables -I INPUT -p tcp -j NFQUEUE</b> <br>  3) From the NFQUEUE queue, packets can be processed at the user level, as Suricata does <br>  4) Suricata runs packages according to the configured rules (rules) and depending on them can make one of three verdicts: <b>NF_ACCEPT</b> , <b>NF_DROP</b> and the most interesting - <b>NF_REPEAT</b> . <br>  5) Packets that fall into NF_REPEAT can be labeled in the system and sent back to the beginning of the <b>current</b> iptables table, which gives a huge potential for influencing the further fate of packets using iptables rules. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Starting from version 1.4, Suricata can work as an IPS using the <b>AF_PACKET</b> system's zero copy mode, but with some limitations.  The system should work as a gateway with two network interfaces.  If the packet falls under the DROP rule, it is simply not forwarded to the second interface.  The advantages of zero copy are in the speed of packet processing, which providers will undoubtedly like, who in case of inaction risk running into Roskomnadzor fines. <br><br>  The installation of Suricata on Ubuntu is described on the official <a href="https://redmine.openinfosecfoundation.org/projects/suricata/wiki/Ubuntu_Installation_-_Personal_Package_Archives_(PPA)">Wiki.</a> <br><br><h4>  Consider the example of NFQ on the WEB server </h4><br>  Configure the original iptables rule: <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    ,    80-   &lt;b&gt;&lt;/b&gt;    0x1/0x1     iptables -t mangle -I PREROUTING -p tcp -m tcp --dport 80 -m mark ! --mark 0x1/0x1 -j NFQUEUE --queue-num 0</span></span></code> </pre> <br>  <i>Use mangle, because</i>  <i>This table is one of the first packages in the path.</i> <br>  The option <b>--queue-bypass</b> appeared in kernel <b>2.6.38</b> and allows you to skip all packets in the queue in the absence of an application listening to the NFQUEUE.  Those.  if Suricata is not running, then all packages that fall under the rules will go on as if nothing had happened. <br>  The option <b>--queue-num</b> sets the queue number. <br>  <b>-m mark!</b>  <b>--mark 0x1 / 0x1</b> ignores all packets that have already been processed by Suricata <br><br>  Configure Suricata in IPS mode (relative to the standard configuration that comes in the package): <br><pre> <code class="ruby hljs"><span class="hljs-symbol"><span class="hljs-symbol">nfq:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">mode:</span></span> repeat <span class="hljs-comment"><span class="hljs-comment">#      repeat-mark: 1 repeat-mask: 1 ... ... ... default-rule-path: /etc/suricata rule-files: - test.rules #    </span></span></code> </pre><br><br>  The Suricata rule that responds to the TEST text in the package (/etc/suricata/test.rules): <br><pre> <code class="hljs pgsql">pass tcp <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> (content: "TEST"; msg: "TEST was marked!"; nfq_set_mark:<span class="hljs-number"><span class="hljs-number">0x2</span></span>/<span class="hljs-number"><span class="hljs-number">0xffffffff</span></span>; sid:<span class="hljs-number"><span class="hljs-number">2455</span></span>;)</code> </pre> <br>  <i>sid must be unique</i> <br><br>  In conjunction with the setting of Suricata and the rule, the labeling and mask of the ‚Äúbad‚Äù package will be: <b>0x02 /</b> 0xfe (0xff XOR 0x01 = 0xfe) <br><br>  We start Suricata: <br><pre> <code class="bash hljs">suricata -q 0 -c /etc/suricata/suricata.yaml</code> </pre><br><br>  Further packet parsing with iptables rules: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  ,     iptables -t mangle -A PREROUTING -p tcp -m tcp --dport 80 -m mark --mark 0x2/0xfe -j LOG --log-prefix "TEST packet detected"</span></span></code> </pre><br>  After running on the remote client: <br><pre> <code class="bash hljs">curl http://221.141.200.189/TEST</code> </pre><br>  The following entry will appear in / var / log / syslog: <br><pre> <code class="bash hljs">Sep 9 14:23:06 server kernel: [ 2897.581561] TEST packet detectedIN=eth0 OUT= MAC=c5:d5:08:8f:2d:be:ce:df:3e:af:8c:06:08:00 SRC=97.17.34.191 DST=221.141.200.189 LEN=133 TOS=0x00 PREC=0x00 TTL=64 ID=57685 DF PROTO=TCP SPT=33949 DPT=80 WINDOW=115 RES=0x00 ACK PSH URGP=0 MARK=0x3</code> </pre> <br><br>  Do not forget that Suricata labels only packages.  In order for the rule to work for the entire connection, it is necessary to mark it: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#       iptables -t mangle -A PREROUTING -m mark --mark 0x2/0xfe -j CONNMARK --save-mark #  ,     iptables -t mangle -A PREROUTING -m connmark --mark 0x2/0xfe -j LOG --log-prefix "TEST connection detected" #  ,        iptables -t mangle -A PREROUTING -m connmark --mark 0x2/0xfe -j CONNMARK --restore-mark</span></span></code> </pre><br><br>  If you pay attention to a wonderful addition to iptables like RAW DNAT / SNAT, then using Suricata you can direct different types of traffic to different destination addresses.  Here, too, there are several nuances as a loss of the integrity of the connection, but this is easy to solve using proxy software that can restore connections on the fly. <br><br>  In addition, Suricata can modify packages on the fly.  For example: <br><pre> <code class="hljs pgsql">pass tcp <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> (content: "TEST"; replace:"SETS"; msg: "TEST was marked!"; nfq_set_mark:<span class="hljs-number"><span class="hljs-number">0x2</span></span>/<span class="hljs-number"><span class="hljs-number">0xffffffff</span></span>; sid:<span class="hljs-number"><span class="hljs-number">2455</span></span>;)</code> </pre><br>  Replaces the text in the package TEST SETS, but under one condition - the replacement data must be exactly the same size as the original.  In this case, the command: <br><pre> <code class="bash hljs">curl -v http://221.141.200.189/TEST</code> </pre><br>  save to the web server log: <br><pre> <code class="hljs objectivec"><span class="hljs-number"><span class="hljs-number">97.17</span></span><span class="hljs-number"><span class="hljs-number">.34</span></span><span class="hljs-number"><span class="hljs-number">.191</span></span> - - [<span class="hljs-number"><span class="hljs-number">09</span></span>/Sep/<span class="hljs-number"><span class="hljs-number">2013</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span> +<span class="hljs-number"><span class="hljs-number">0400</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /SETS HTTP/1.1"</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">151</span></span> <span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-string"><span class="hljs-string">"curl/7.26.0"</span></span></code> </pre><br><br><h4>  Consider an example with AF_PACKET on the gateway </h4><br>  Everything is easier here.  The configuration suricata.yaml should look something like this: <br><pre> <code class="ruby hljs">af-<span class="hljs-symbol"><span class="hljs-symbol">packet:</span></span> - <span class="hljs-symbol"><span class="hljs-symbol">interface:</span></span> eth<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">threads:</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-symbol"><span class="hljs-symbol">defrag:</span></span> yes cluster-<span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> cluster_flow cluster-<span class="hljs-symbol"><span class="hljs-symbol">id:</span></span> <span class="hljs-number"><span class="hljs-number">98</span></span> copy-<span class="hljs-symbol"><span class="hljs-symbol">mode:</span></span> ips copy-<span class="hljs-symbol"><span class="hljs-symbol">iface:</span></span> eth1 buffer-<span class="hljs-symbol"><span class="hljs-symbol">size:</span></span> <span class="hljs-number"><span class="hljs-number">64535</span></span> use-<span class="hljs-symbol"><span class="hljs-symbol">mmap:</span></span> yes - <span class="hljs-symbol"><span class="hljs-symbol">interface:</span></span> eth1 <span class="hljs-symbol"><span class="hljs-symbol">threads:</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> cluster-<span class="hljs-symbol"><span class="hljs-symbol">id:</span></span> <span class="hljs-number"><span class="hljs-number">97</span></span> <span class="hljs-symbol"><span class="hljs-symbol">defrag:</span></span> yes cluster-<span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> cluster_flow copy-<span class="hljs-symbol"><span class="hljs-symbol">mode:</span></span> ips copy-<span class="hljs-symbol"><span class="hljs-symbol">iface:</span></span> eth<span class="hljs-number"><span class="hljs-number">0</span></span> buffer-<span class="hljs-symbol"><span class="hljs-symbol">size:</span></span> <span class="hljs-number"><span class="hljs-number">64535</span></span> use-<span class="hljs-symbol"><span class="hljs-symbol">mmap:</span></span> yes</code> </pre><br>  <i>The number of handler threads must be no more than one for kernels older than 3.6, otherwise increasing the number of threads will cause an infinite loop.</i> <br>  <i>The MTU on both network interfaces must be identical.</i> <br><br>  We start Suricata: <br><pre> <code class="bash hljs">suricata -c /etc/suricata/suricata.yaml --af-packet</code> </pre> <br><br><h4>  Conclusion </h4><br>  Suricata is a flexible packet processing tool that allows you to change routes depending on the content of the packet, detect attacks and prevent bad packets from entering the system (for example, drop or replace packets until they reach the WEB server).  Perhaps now <s>government</s> providers are using Suricata as DPI. <br><br>  For writing the article, information was used from the <a href="http://home.regit.org/">blog of</a> one of the Suricata developers and the official <a href="https://redmine.openinfosecfoundation.org/projects/suricata/wiki">Wiki</a> . </div><p>Source: <a href="https://habr.com/ru/post/192884/">https://habr.com/ru/post/192884/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../192870/index.html">Mongodb 3.2 release some details</a></li>
<li><a href="../192872/index.html">How specifically to release the Internet</a></li>
<li><a href="../192874/index.html">Evolution of modular javascript</a></li>
<li><a href="../192876/index.html">Do not put all your eggs in someone else's basket (from the book Passionate Programmer by Chad Fowler)</a></li>
<li><a href="../192882/index.html">The invisible release of FreeType 2.5 - a breakthrough in font rendering</a></li>
<li><a href="../192886/index.html">New for web designer # 8 for August 2013</a></li>
<li><a href="../192888/index.html">DivX 10 released with support for HEVC video compression standard</a></li>
<li><a href="../192892/index.html">Set in circles 239</a></li>
<li><a href="../192894/index.html">Illustrious Russian accountant. He also improved the scores</a></li>
<li><a href="../192896/index.html">How not to free the Internet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>