<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Migrating VMware physical and virtual server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There was a server in a faraway country. It was not bad in terms of technical specifications for its time - Intel Core Quad Q6600 2.4GHz 8GB RAM, Inte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Migrating VMware physical and virtual server</h1><div class="post__text post__text-html js-mediator-article">  There was a server in a faraway country.  It was not bad in terms of technical specifications for its time - Intel Core Quad Q6600 2.4GHz 8GB RAM, Intel DQ965GF motherboard, 3ware7xxx / 8xxx raid controller and 2 SATA 300GB drives in a raid 1 array. <br><br>  And once one of the disks in the raid decided to die on this server - and once decided, it died.  It was natural to assume that where one disk died, there the second one can die ‚Äî it needs to be changed.  Yes, and expanding disk space does not hurt, we thought. <br>  Somehow, with a sin in half, they bought new 2TB disks - a crisis and in distant bourgeois countries were with hard disks.  The server was critical, but it was possible to turn it off and torment it for a while - there were doubles. <br><br>  We decided to upgrade the software ... <br><a name="habracut"></a><br>  The server was CentOS 4.5 x64, the old one was tortured, the vmware server was installed 2nd and under the server there were already three virtual machines with windows 2003 server with ms sql and some programs, freebsd and suse.  Over the years, from an important need was only windows and in the future it was planned to plant some more virtual machines there - it means you need to change the platform. <br>  We stopped at vSphere hypervisor - but for a simple ESXi.  Having studied the Internet - I did not find the experience of installing ESXi on such a specific hardware - the Intel 82556DM network card and the raid controller could not work - the search in the official compatibility list did not give a positive result.  It would be inconvenient to install an additional network card and it would take a long time.  Well and without raid it was possible to do. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In general, we decided to try.  I am writing a letter to technical support in order to install new hard drives and install esxi 5.0.  After some time, they said that they installed esxi 4.1u1, that the raid didn‚Äôt see, but on the integrated ICH controller it works and you can see both drives.  Gave a password so we went to see this happiness. <br><br>  Went to see.  It seems to work.  Now the second task is to migrate the windows server 2003 virtual machine from the vmware server to the vmware vsphere hypervisor environment.  Came up with several options - <br>  <b>first</b> upload a disk image or a ready virtual machine with centos / linux to a stack and connect old disks as Raw devices mapping, install a converter and convert to esxi. <br>  <b>the second</b> is to try to trite the ext3 partition to esxi - but unfortunately it seems impossible. <br>  <b>the third</b> is to copy over SCP / FTP / HTTP somewhere else, convert there and then copy back over SCP or via vclient. <br>  <b>the fourth</b> is to put the old centos vmware converter inside and convert it in place. <br>  <b>the fifth</b> is to raise another virtual machine with windows and put the converter there. <br><br>  While thinking - technical support inserted the disks into the USB-SATA adapter and connected to the server - bare ESXi, of course, could not understand what can be done with this option.  Then they wrote that they were doubtful to see the raid array except from its own operating system. <br><br>  They tried to install the converter into Centos - they installed it, but for some reason it did not work to connect to it remotely - possibly due to non-standard ports specified when installing the converter, since the standard ports were occupied.  Well, after thinking, it seemed that the entire virtual machine was first downloaded via the client to my local machine, and then back - 30 gig of traffic and God forbid the Internet to fall off - generally unreliable. <br>  Plus, the converter simply does not convert the machine into a file ‚Äî it necessarily requires connecting to either the host or vCenter. <br><br>  We did not try to mount ext3 partitions to esxi - in the options of the mount command, you did not see ext3 of the file system type - it looked bad. <br><br>  In general, we did this - I packed the files of the virtual machine and downloaded them to my computer.  I installed a vmware converter and converted it to a local esxi host.  For reliability and compatibility, I connected via ssh to the local esxi and archived the disabled virtual machine using tar - the virtual machine directories are located in / vmfs / volumes / datastore /.  The parameter z compresses the archive. <br>  It turned out a 7GB file from 17GB. <br><br>  I wrote to technical support to install new winchesters and run esxi.  Then I connected to the remote esxi by WinSCP and started uploading the archive.  The speed just killed - 30kB / s, about 3 days of copying.  As it turned out, the resume is not supported, tar in esxi does not seem to work with broken archives.  Just in case, I decided to try the standard vclient to upload the archive to the repository - the speed was about 10 times more and in 7 hours the archive began to download. <br><br>  Then I went through ssh to the remote esxi and unpacked the tar of the virtual machine, added it to Inventory and started it.  Updated vmware tools, network card and restored network settings. <br><br>  To improve reliability, I created a virtual machine with windows 2003 server (so that vmware memory compression technology worked and less resources were spent).  I added another network card with ‚Äúgray‚Äù IP addresses to both machines, created another vSwitch, added VMKernel to it, ticked Management traffic in it and assigned an ip address from the same ‚Äúgray‚Äù range.  Put and configured veeam backup.  To reduce paid traffic through the Internet and for security, veeam connects to esxi via a ‚Äúgray‚Äù ip address and makes copies of virtual machines from one storage hard drive to the second ‚Äî so that in case of a failure, you can quickly recover. <br><br>  If it were not for the slow speed of copying via the Internet, then a simple 30 minutes maximum would be. <br><br>  Most likely, we have missed some migration options - can someone tell me clever ideas, as there are still a couple of about the same tasks for migration. <br><habracut></habracut></div><p>Source: <a href="https://habr.com/ru/post/136448/">https://habr.com/ru/post/136448/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136441/index.html">Search using filters on Yandex.Maps and data about your organization</a></li>
<li><a href="../136443/index.html">Wanted: author in the prime of life</a></li>
<li><a href="../136444/index.html">Hits App Store and the harsh reality</a></li>
<li><a href="../136445/index.html">Droider Chart. Issue 85, from Vegas</a></li>
<li><a href="../136447/index.html">February 10: {ruby & ruby ‚Äã‚Äãon rails}</a></li>
<li><a href="../136449/index.html">Restricting access to repositories</a></li>
<li><a href="../136450/index.html">Dynamic password</a></li>
<li><a href="../136451/index.html">Hello to readers Habra</a></li>
<li><a href="../136453/index.html">Cut the Rope to HTML5</a></li>
<li><a href="../136454/index.html">Sketch - 100 seconds about SONY</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>