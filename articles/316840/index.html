<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to gently get into the guts of WebRTC when transmitting voice and video</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="WebRTC is an interesting technology, but a bit confusing. First of all, the fact that this is not one technology, but a combine. Capture video from th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to gently get into the guts of WebRTC when transmitting voice and video</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/f34/001/18f/f3400118fa0d426e8fb64c7107307248.png" width="256" align="left">  WebRTC is an interesting technology, but a bit confusing.  First of all, the fact that this is not one technology, but a combine.  Capture video from the camera and sound from the microphone.  Establish a peer-to-peer connection between two browsers, with NAT piercing as much as possible.  Transmission of audio and video on this connection, with the understanding that realtime data is being transmitted: codecs, bandwidth, frame loss, that's all.  And finally, playback of the received in the window of another browser.  Or not a browser, this is already going down.  Oh yeah, still - realtime transmission of user data in the same way for games, sensors, and all that where tcp websocket lags are unacceptable.  We at Voximplant are constantly digging into the guts of technology so that customers have high-quality sound and video in all cases, and not just for the local 100 megabyte.  And we were very pleased to read last week an interesting article that tells how to dig in these guts properly.  We also offer you to read the adapted translation, especially for Habr! <br><a name="habracut"></a><br>  WebRTC 1.0 uses <a href="https://en.wikipedia.org/wiki/Session_Description_Protocol">SDP</a> to learn the capabilities of two connecting parties.  Many people do not like using the protocol from the telephony of the 90s, but the cruel reality is that SDP <a href="https://webrtchacks.com/tag/ortc/">will be with us for a long time</a> .  And if you want to get into the guts of WebRTC really deep: switch codecs, change the width of the data transfer channel, then you have to get your hands dirty in the SDP. <br><br>  Recently, a conference on WebRTC was held in Boston.  Nick Gauthier from <a href="https://meetspaceapp.com/">MeetSpace</a> told how he changed SDP and used other tricks to do a videoconference for 10 people.  Without a single server, that is, each browser sent a stream of 9 other.  Such tasks occur infrequently, but the ability to manually control the width of the WebRTC channel can be very useful.  Video presentation can be seen <a href="https://www.youtube.com/watch%3Fv%3DX2gLy4QRK9k%26feature%3Dyoutu.be%26list%3DPLJulS80le865-N8aE3LOTPp84BMUGIuUf">here</a> .  And below I will tell you how he did all this. <br><br>  Without our intervention, <b>PeerConnection</b> uses the entire available channel width to ensure the maximum video quality.  Or sound.  Which is very cool if video conferencing is the only thing your computer is doing right now.  But what if you use GMail in parallel?  Or do you have a mobile connection with a ‚Äúfloating‚Äù channel width?  Or, like with us at MeetSpace, do you establish a 10-way connection and <b>PeerConnection</b> 's communicate with each other? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this post, I want to show you how you can parse and modify SDP on the fly using JavaScript to set the maximum width of the channel used. <br><br><h2>  Where to modify SDP </h2><br>  First we need to get the SDP data.  The very first SDP packet is created when the <b>PeerConnection</b> object creates an <b>Offer</b> , which you need to pass to the second connection negotiating side: <br><br><pre><code class="javascript hljs">peerConnection.createOffer( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">offer</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.debug(<span class="hljs-string"><span class="hljs-string">"The offer SDP:"</span></span>, offer.sdp); peerConnection.setLocalDescription(offer); <span class="hljs-comment"><span class="hljs-comment">// your signaling code to communicate the offer goes here } );</span></span></code> </pre> <br><br>  What should be done?  Modify SDP package before we give it to the second side.  It is fortunate that WebRTC does not include ‚Äúsignaling‚Äù in the standard and the developer‚Äôs responsibility is to transfer Offer'ov between two connecting parties: <br><br><pre> <code class="javascript hljs">peerConnection.createOffer( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">offer</span></span></span><span class="hljs-function">) </span></span>{ peerConnection.setLocalDescription(offer); <span class="hljs-comment"><span class="hljs-comment">// modify the SDP after calling setLocalDescription offer.sdp = setMediaBitrates(offer.sdp); // your signaling code to communicate the offer goes here } );</span></span></code> </pre><br><br>  In the code above, we call the <b>setMediaBitrates</b> function, which will apply the modifications we need and return the modified SDP package (I will tell the details later).  A curious nuance: you can not change the package between calls to <b>createOffer</b> / <b>createAnswer</b> and <b>setLocalDescription</b> .  So we will change it before transferring to the second contracting party.  When the packet reaches the second side, we will also have to change the second SDP packet, which WebRTC will create on the second side as ‚ÄúAnswer‚Äù.  This is necessary because ‚ÄúOffer‚Äù sounds ‚ÄúThis is the width of the channel that I can use,‚Äù but ‚ÄúAnswer‚Äù also sounds like ‚ÄúAnd this is the width of the channel that I can use.‚Äù  It is necessary to limit from both ends of the pipe: <br><br><pre> <code class="javascript hljs">peerConnection.setRemoteDescription(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RTCSessionDescription(offer)).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ peerConnection.createAnswer().then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">answer</span></span></span><span class="hljs-function">) </span></span>{ peerConnection.setLocalDescription(answer); <span class="hljs-comment"><span class="hljs-comment">// modify the SDP after calling setLocalDescription answer.sdp = setMediaBitrates(answer.sdp); // your signaling code to communicate the answer goes here }; };</span></span></code> </pre><br><br>  Now that we have chosen the places to modify the SDP, we can begin the modification itself! <br><br><h2>  How to parse SDP </h2><br>  I highly recommend reading the post from Ant√≥n Rom√°n <a href="https://webrtchacks.com/update-anatomy-webrtc-sdp-anton-roman/">"Anatomy of WebRTC SDP"</a> , it will help to understand what SDP is and how it works.  It was from this post that my own adventure began.  I also recommend the specification: <a href="https://tools.ietf.org/html/rfc4566">RFC 4566 SDP: Session Description Protocol</a> .  The link will lead you to the 5th section of the 7th page, where the format is described.  For those who do not like to read long specs, a short squeeze: SDP is a UTF-8 text, broken down into strings like "=". <br><br>  Pay attention to the important thing hidden in the depth of the 5th section of the documentation: order of indication types.  I will not repeat here a huge piece of text, and again I will give a squeeze.  At the beginning of the SDP there is a section followed by repeated ‚Äúmedia descriptions‚Äù.  Their order will always be the same: ‚Äúm‚Äù, ‚Äúi‚Äù, ‚Äúc‚Äù, ‚Äúb‚Äù, ‚Äúk‚Äù, ‚Äúa‚Äù. <br><br>  That's not all.  Now you need to look at the FC 3556 <a href="https://tools.ietf.org/html/rfc3556">Session Description Protocol (SDP) Bandwidth Modifiers for RTP Control Protocol (RTCP)</a> .  This specification describes how to set the channel width using a ‚Äútype‚Äù with a value of ‚Äúb‚Äù.  The corresponding SDP string is ‚Äúb = AS: XXX‚Äù, where XXX is the channel width that we want to set.  The acronym "AS" stands for "Application Specific Maximum", that is, the maximum allowable channel width.  Also from RFC we see that the value is set in kilo <b>bits</b> per second, kbps.  So, our code will work according to this algorithm: <br><br><pre> <code class="hljs 1c"> , <span class="hljs-keyword"><span class="hljs-keyword"></span></span> <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  <span class="hljs-string"><span class="hljs-string">"m=audio"</span></span> <span class="hljs-keyword"><span class="hljs-keyword"></span></span> <span class="hljs-string"><span class="hljs-string">"m=video"</span></span>    type <span class="hljs-string"><span class="hljs-string">"i"</span></span>  <span class="hljs-string"><span class="hljs-string">"c"</span></span> <span class="hljs-keyword"><span class="hljs-keyword"></span></span> <span class="hljs-built_in"><span class="hljs-built_in"></span></span>  type <span class="hljs-string"><span class="hljs-string">"b"</span></span>,   <span class="hljs-keyword"><span class="hljs-keyword"></span></span> <span class="hljs-built_in"><span class="hljs-built_in"></span></span>   <span class="hljs-built_in"><span class="hljs-built_in"></span></span>,    type <span class="hljs-string"><span class="hljs-string">"b"</span></span></code> </pre> <br><br><h2>  How to modify SDP </h2><br>  For most WebRTC video calls, the media description for the video and the media description for the sound will be used in the protocol.  In our example, we limit the video stream to 500kb / s and the audio stream to 50kb / s: <br><br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setMediaBitrates</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sdp</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> setMediaBitrate(setMediaBitrate(sdp, <span class="hljs-string"><span class="hljs-string">"video"</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>), <span class="hljs-string"><span class="hljs-string">"audio"</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setMediaBitrate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sdp, media, bitrate</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lines = sdp.split(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> line = <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; lines.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lines[i].indexOf(<span class="hljs-string"><span class="hljs-string">"m="</span></span>+media) === <span class="hljs-number"><span class="hljs-number">0</span></span>) { line = i; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (line === <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.debug(<span class="hljs-string"><span class="hljs-string">"Could not find the m line for"</span></span>, media); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sdp; } <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.debug(<span class="hljs-string"><span class="hljs-string">"Found the m line for"</span></span>, media, <span class="hljs-string"><span class="hljs-string">"at line"</span></span>, line); <span class="hljs-comment"><span class="hljs-comment">// Pass the m line line++; // Skip i and c lines while(lines[line].indexOf("i=") === 0 || lines[line].indexOf("c=") === 0) { line++; } // If we're on ab line, replace it if (lines[line].indexOf("b") === 0 { console.debug("Replaced b line at line", line); lines[line] = "b=AS:"+bitrate; return lines.join("\n"); } // Add a new b line console.debug("Adding new b line before line", line); var newLines = lines.slice(0, line) newLines.push("b=AS:"+bitrate) newLines = newLines.concat(lines.slice(line, lines.length)) return newLines.join("\n") }</span></span></code> </pre><br></div></div><br>  It's all!  To be honest, I was very tense when I first encountered SDP.  The overwhelming number of small details that need to be understood.  But by and large it is just a set of strings, each of which defines something to connect.  We do not need regexps, since the sections always have the same order.  In our case, we simply replaced the string with type ‚Äúb‚Äù, so even we didn't have to parse. <br><br>  I hope this article will help you better understand how WebRTC works and how to modify it to fit your needs. </div><p>Source: <a href="https://habr.com/ru/post/316840/">https://habr.com/ru/post/316840/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316830/index.html">ISUII AmigaVirtual - universal AI for everyone</a></li>
<li><a href="../316832/index.html">Demo cloud access to Ultimate 2C</a></li>
<li><a href="../316834/index.html">Tips for Indie Developers: The Dark Triad and Five Tips with Top ROI</a></li>
<li><a href="../316836/index.html">How not to use the Repository pattern</a></li>
<li><a href="../316838/index.html">Bot for telegram with status in DBMS and text classification</a></li>
<li><a href="../316844/index.html">JetBrains tools are half cheaper for companies</a></li>
<li><a href="../316846/index.html">CTFzone write-ups - MISC it all up</a></li>
<li><a href="../316848/index.html">10 unique Internet entrepreneurs of Russia</a></li>
<li><a href="../316850/index.html">Veeam Availability Suite 9.5 - about updates to Veeam ONE, as well as free NFR keys</a></li>
<li><a href="../316854/index.html">"Performance is a feature." Interview with Marco Cecconi, Stack Overflow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>