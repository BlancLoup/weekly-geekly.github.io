<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The constexpr qualifier in C ++ 11 and C ++ 14</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the new features of C ++ 11 is the constexpr . With it you can create variables, functions and even objects that will be calculated at the comp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The constexpr qualifier in C ++ 11 and C ++ 14</h1><div class="post__text post__text-html js-mediator-article"> One of the new features of C ++ 11 is the <code>constexpr</code> .  With it you can create variables, functions and even objects that will be calculated at the compilation stage.  This is convenient, because earlier for such purposes it was necessary to use templates.  But it's not so simple.  Those who are not so familiar with <code>constexpr</code> may get the impression that now there will be no problems with calculations at the compilation stage.  But <code>constexpr</code> expressions are severely constrained. <br><br>  The first part will tell you about <code>constexpr</code> , what will be the changes in the C ++ 14 standard, and the second part will be an example of using <code>constexpr</code> : a library that considers the result of a mathematical expression in a string. <br>  With it you can write the following code: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> x = <span class="hljs-string"><span class="hljs-string">"(4^2-9)/8+2/3"</span></span>_solve; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Answer is "</span></span> &lt;&lt; x;</code> </pre><br>  And the answer in the form of a fraction will be obtained at the compilation stage: <br> <code>Answer is 37/24</code> <br>  Immediately I warn you, the code of this library is difficult to understand. <br>  To whom this topic is interesting, welcome under the cat! <br><a name="habracut"></a><br><h2>  What is constexpr? </h2><br>  First, a <code>constexpr</code> words about what the <code>constexpr</code> .  As already mentioned, it can be used to perform some operations at the compilation stage.  It looks like this: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = sum (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-comment"><span class="hljs-comment">//        }</span></span></code> </pre><br><h4>  constexpr function </h4><br> <code>constexpr _ _ ()</code> <br>  The <code>constexpr</code> added in C ++ 11 before the function means that if the parameter values ‚Äã‚Äãcan be calculated at the compilation stage, then the return value should also be counted at the compilation stage.  If the value of at least one parameter is unknown at compile time, the function will be launched at runtime (and no compilation error will be displayed). <br><br><h4>  constexpr variable </h4><br> <code>constexpr  = expression;</code> <br>  The key word in this case is the creation of a constant.  And expression should be known at the compilation stage. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Consider this example: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new_sum</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a1 = new_sum (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-comment"><span class="hljs-comment">// : constexpr- constexpr int a2 = sum (5, 12); // :  sum   constexp- int a3 = new_sum (5, 12); // :       int a4 = sum (5, 12); //  }</span></span></code> </pre><br><br>  <code>constexpr</code> variable is a constant ( <code>const</code> ), but the constant is not a constexpr variable. <br><br>  In the case of "loss" <code>constexpr</code> -specific variable to return it back will not work, even if the value can be considered at the compilation stage.  <code>constexpr</code> -specifier cannot be added using const_cast, since constexpr is not a cv-specifier (this is <code>const</code> and <code>volatile</code> ).  This code will not work: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inc</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = inc (<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b = inc (a); <span class="hljs-comment"><span class="hljs-comment">// : a   constexpr-, -       constexpr }</span></span></code> </pre><br><br>  Function parameters cannot be <code>constexpr</code> .  That is, it will not be possible to create an exclusively <code>constexpr</code> -function that can only work at the compilation stage. <br><br>  Also, <code>constexpr</code> functions can work with classes, this will be discussed later. <br><br>  GCC, starting with version 4.4, supports <code>constexpr</code> functions, Clang also supports version 2.9, and Visual Studio 2013 does not support (but in Visual Studio "14" CTP has finally added support). <br><br><h2>  Restrictions </h2><br>  Now that you understand how all this is convenient, you can add a spoonful of tar in a barrel of honey.  And quite a big spoon. <br><br>  Let's start with the <code>constexpr</code> variable constraints.  The constexpr variable type must be a literal type, that is, one of the following: <br><ul><li>  Scalar type </li><li>  Pointer </li><li>  Array of scalar types </li><li>  A class that satisfies the following conditions: <br><ul><li>  It has a default destructor </li><li>  All nonstatic class members must be literal types. </li><li>  The class must have at least one <code>constexpr</code> (but not the copy and move constructor) or no constructors at all </li></ul><br></li></ul><br>  <code>constexpr</code> variable must satisfy the following conditions: <br><ul><li>  Her type must be literal. </li><li>  She should be immediately assigned a value or called <code>constexpr</code> </li><li>  Constructor parameters or assigned values ‚Äã‚Äãcan only contain literals or <code>constexpr</code> -variables and <code>constexpr</code> -functions </li></ul><br>  There seems to be nothing unusual.  The main restrictions are imposed on the constexpr-functions: <br><ul><li>  It can not be virtual ( <code>virtual</code> ) </li><li>  It must return a literal type ( <code>void</code> cannot be returned <b>*</b> ) </li><li>  All parameters must be of literal type. </li><li>  The function body should contain only the following: <br><ul><li> <code>static_assert</code> </li> <li>  <code>typedef</code> or <code>using</code> that declare all types except classes and enums ( <code>enum</code> ) </li><li>  <code>using</code> to specify the visibility of names or namespaces ( <code>namespace</code> ) </li><li>  <b>Exactly</b> one <code>return</code> , which can contain only literals or <code>constexpr</code> -variables and <code>constexpr</code> -functions </li></ul><br></li></ul><br>  <b>*</b> <i>With C ++ 14, <code>void</code> will also be a literal type.</i> <br><br>  The <code>constexpr</code> are subject to the same restrictions as the functions, with the exception of the clause about <code>return</code> and the addition of one new clause: <br>  All nonstatic class members and base class members must be initialized in some way (in the constructor, using initialization lists or initializing class members when they are declared), and the expressions assigned to them must contain only literals or <code>constexpr</code> variables and <code>constexpr</code> -functions. <br><br>  It turns out that in functions it is impossible to initialize variables, create loops and <code>if-else</code> .  On the one hand, these restrictions are made due to the fact that the compiler needs to at least somehow monitor the execution of the program during compilation (recursion is easier to interrupt than cycles).  On the other hand, writing complex functions becomes problematic. <br><br>  Of course, all the same, all these possibilities can be realized.  Instead of cycles, use recursion, instead of the <code>if-else</code> , the operator ‚Äú <code>? :</code>  <code>? :</code> ", And instead of creating variables, use the function values. <br><br>  All this strongly resembles functional programming.  In functional programming languages, as a rule, it is also impossible to create variables and there are no cycles.  Indeed, you can call functions, higher-order functions can also be implemented using function pointers (unfortunately, anonymous functions (lambdas) cannot be used in <code>constexpr</code> ).  Also, all constexpr-functions are pure functions (depend only on their parameters and return only their result).  To write <code>constexpr</code> algorithms, you must have at least a basic knowledge of functional programming. <br><br>  But here C ++ has big problems with syntax: anonymous functions cannot be used, all functions of the function are one long expression, but with the addition of the operator ‚Äú <code>? :</code>  <code>? :</code> ‚ÄùThe code is completely unreadable.  Also, all this is accompanied by incomprehensible error messages that can take hundreds of lines. <br><br>  But the problems do not end there.  When you write some <code>constexpr</code> function, which will then be used frequently, it would be good to return a readable error.  Here you can mistakenly assume that <code>static_assert</code> is suitable for this.  But <code>static_assert</code> cannot be used, since the parameters of the functions cannot be <code>constexpr</code> , which is why the values ‚Äã‚Äãof the parameters are not guaranteed to be known at the compilation stage. <br>  How to display errors?  The only more or less normal way I found is to throw an exception: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">div</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (y == <span class="hljs-number"><span class="hljs-number">0</span></span>) ? <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::logic_error (<span class="hljs-string"><span class="hljs-string">"x can't be zero"</span></span>) : (y / x); }</code> </pre><br>  In the case of a function call at compile time, we see an error that the <code>throw</code> construct cannot be in the constexpr function, and the function will throw an exception at runtime. <br>  It will be difficult to find an error, but at least something. <br><div class="spoiler">  <b class="spoiler_title">Error example in gcc 4.8.2</b> <div class="spoiler_text">  Main.cpp: 16:24: in constexpr expansion of 'MathCpp :: operator "" _solve (((const char *) "(67 + 987 ^ (7-3 * 2)) * (34-123) + 17 ^ 2/0 + (- 1) "), 37ul) ' <br>  MathCpp.h: 115: 28: in constexpr expansion of 'MathCpp :: solve (str, ((size_t) size))' <br>  MathCpp.h: 120: 103: in constexpr expansion of 'MathCpp :: get_addsub (MathCpp :: SMathData (str, ((int) size), 0))' <br>  MathCpp.h: 209: 89: in constexpr expansion of MathCpp :: _ get_addsub (data.MathCpp :: SMathData :: create ((((int) MathCpp :: get_muldiv (data) .MathCpp :: SMathValue :: end) + 1)), MathCpp :: get_muldiv (data) .MathCpp :: SMathValue :: value) ' <br>  MathCpp.h: 217: 50: in constexpr expansion of 'MathCpp :: get_muldiv (data.MathCpp :: SMathData :: create ((((int) data.MathCpp :: SMathData :: start) + 1))))' <br>  MathCpp.h: 181: 83: in constexpr expansion of 'MathCpp :: _ get_muldiv (data.MathCpp :: SMathData :: create ((((int) MathCpp :: get_pow (data). MathCpp :: SMathValue :: end) + 1)), MathCpp :: get_pow (data) .MathCpp :: SMathValue :: value) ' <br>  MathCpp.h: 38: 111: error: expression '&lt;throw-expression&gt;' is not a constant-expression <br>  #define math_assert (condition, description) ((condition)? INVALID_VALUE: (throw std :: logic_error (description), INVALID_VALUE)) <br>  ^ <br>  MathCpp.h: 195: 15: note: in expansion of macro 'math_assert' <br>  ?  math_assert (false, "Division by zero") <br></div></div><br>  This way of outputting an error does not yet correspond to the standard of the language; nothing prevents the compiler from always giving an error stating that you cannot use <code>throw</code> in the <code>constexpr</code> functions.  In GCC 4.8.2, this works, but in Visual Studio ‚Äú14‚Äù the CTP C ++ compiler does not. <br><br>  As a result, it is difficult to write, difficult to debug, difficult to understand such constructions. <br>  But everything is not so bad, in C ++ 14 very many restrictions will be removed. <br><br><h2>  Changes in C ++ 14 </h2><br>  As already mentioned, in the new standard, <code>void</code> will also be a literal type, and now it will be possible to create functions that, for example, will check the values ‚Äã‚Äãof parameters for correctness. <br><br>  The second minor change is that now the <code>constexpr</code> class member functions are not constant. <br>  In C ++ 11, the following lines were equivalent, but in C ++ 14, this is no longer the case: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">car</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// C++11:     const, C++14 -   constexpr int foo (int a) const; };</span></span></code> </pre><br>  An explanation for this can be found <a href="http://habrahabr.ru/post/184250/">here</a> . <br><br>  Finally, a major change allows the use of almost any constructs in <code>constexpr</code> functions and constructors. <br>  Now the body of <code>constexpr</code> -functions can contain any constructions, except: <br><ul><li>  Assembler inserts </li><li>  Keyword <code>goto</code> </li><li>  Definitions of variables of non-literal type or <code>static</code> and <code>thread_safe</code> variables.  All variables must be initialized when defined. </li></ul><br><br>  And the body of the <code>constexpr</code> should now satisfy more loyal conditions: <br><ul><li>  It must meet all <code>constexpr</code> conditions <code>constexpr</code> </li><li>  All non-static members must be of literal type. </li><li>  A similar condition is that all non-static members of a class must be initialized in some way. </li><li>  Now you can use the <code>union</code> ‚Äôs, but with some restrictions </li></ul><br><br>  As a result, after the appearance of compilers that support C ++ 14, it will be possible to write constexpr-functions that are almost no different from the usual ones.  In the meantime, you have to write quite confusing code. <br><br><h2>  An example of using constexpr in C ++ 11 </h2><br>  As an example of using constexpr, a library will be given that will read the result of a mathematical expression that is in a line. <br><br>  So, we want to be able to write such code: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> n = <span class="hljs-string"><span class="hljs-string">"(67+987^(7-3*2))*(34-123)+17^2+(-1)"</span></span>_solve; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Answer is "</span></span> &lt;&lt; n;</code> </pre><br>  Another new feature of C ++ 11 is used here: custom literals.  In this case, they are good because the function is guaranteed to be called at compile time, even if the resulting value is not assigned to a <code>constexpr</code> variable. <br><br>  A custom literal is declared this way: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> _solve (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* str, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">solve</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* str, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> _solve (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* str, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> solve (str, size); }</code> </pre><br>  The following macro will be used as an assertion: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> math_assert(condition,description) ((condition) ? 0 : (throw std::logic_error (description), 0))</span></span></code> </pre><br>  The library can add, subtract, multiply, divide, raise, there is also support for brackets.  It will be implemented using recursive descent. <br><br>  The priorities of the operators will be as follows (from higher to lower): <br><ol><li>  Addition and subtraction </li><li>  Multiplication and division </li><li>  Erection in the whole degree </li></ol><br>  The functions of reading the number, degree, sum, and so on will take one parameter: the structure of <code>SMathData</code> .  A string is stored in it, its size and the <code>start</code> variable - where to start reading: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SMathData</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SMathData</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* _str, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _size, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _start)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">str</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_str)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_size)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_start)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> SMathData </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _start)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SMathData (str, size, _start); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">char_start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> char_at (start); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">char_at</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pos)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (pos &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; pos &lt; size) ? str[pos] : ((pos == size) ? <span class="hljs-number"><span class="hljs-number">0</span></span> : (math_assert (<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"Internal error: out of bounds"</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* str; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> size; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> start; };</code> </pre><br>  And return these functions will be the structure of <code>SMathValue</code> .  It stores the calculated value and <code>end</code> is a variable in which the end of the number, sum, product or something else is written: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SMathValue</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SMathValue</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _value, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _end)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">value</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_value)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_end)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> SMathValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_end</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dend)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SMathValue (value, end + dend); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> value; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> end; };</code> </pre><br><br>  For reading the numbers there will be 3 functions (one main and two auxiliary): <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//   (  ). constexpr SMathValue get_number (const SMathData data); //        (    ). //  positive == true,     ,   false -  . i -    . constexpr SMathValue _get_number (const SMathData data, const int i, const bool positive); //        (start -  ). constexpr int _get_number_end (const SMathData data); constexpr SMathValue get_number (const SMathData data) { return (data.char_start() == '-') ? (math_assert (data.char_at (data.start + 1) &gt;= '0' &amp;&amp; data.char_at (data.start + 1) &lt;= '9', "Not a digit"), _get_number (data.create (data.start + 1), _get_number_end (data.create (data.start + 1)), false)) : (math_assert (data.char_start() &gt;= '0' &amp;&amp; data.char_start() &lt;= '9', "Digit required"), _get_number (data, _get_number_end (data), true)); } constexpr SMathValue _get_number (const SMathData data, const int i, const bool positive) { return (i &gt;= data.start) ? SMathValue (_get_number (data, i - 1, positive).value * 10 + (positive ? 1 : -1) * (data.char_at (i) - '0'), i) : SMathValue (0, data.start - 1); } constexpr int _get_number_end (const SMathData data) { return (data.char_start() &gt;= '0' &amp;&amp; data.char_start() &lt;= '9') ? _get_number_end (data.create (data.start + 1)) : (data.start - 1); }</span></span></code> </pre><br>  Here such confused construction turns out.  <code>get_number</code> checks that the current index is actually a number and calls <code>_get_number</code> , passing the end of the number as the first iteration (the number is read from right to left). <br><br>  Working with brackets: <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// get branum -   get bracket or number. constexpr SMathValue get_branum (const SMathData data); constexpr SMathValue get_branum (const SMathData data) { return (data.char_start() == '(') ? (math_assert (data.char_at (get_addsub (data.create (data.start + 1)).end + 1) == ')', "')' required"), get_addsub (data.create (data.start + 1)).add_end (1)) : get_number (data); }</span></span></code> </pre><br>  If the current index is a number, the function calls <code>get_number</code> ; otherwise, the function counts the expression in brackets. <br><br>  Next comes the exponentiation function: <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//      . constexpr SMathValue get_pow (const SMathData data); //  .  ,  start         ( ), //     '^',   . value -    ( ). constexpr SMathValue _get_pow (const SMathData data, const int value); constexpr SMathValue get_pow (const SMathData data) { return _get_pow (data.create (get_branum (data).end + 1), get_branum (data).value); } constexpr SMathValue _get_pow (const SMathData data, const int value) { return (data.char_start() == '^') ? _get_pow (data.create // start (get_branum (data.create (data.start + 1)).end + 1), // value math_pow (value, get_branum (data.create (data.start + 1)).value)) : SMathValue (value, data.start - 1); }</span></span></code> </pre><br>  The <code>_get_pow</code> function checks that the current character is <code>'^'</code> .  If this is the case, the function calls itself (or rather, <code>get_pow</code> ), passing there a new value equal to <code>value</code> in the degree read_value. <br><br>  It turns out that the string <code>"25"</code> correctly processed if <code>get_pow</code> called for it.  Since in this case the number is simply read, after which it will return. <br>  <code>math_pow</code> is a simple <code>constexpr</code> function. <br><div class="spoiler">  <b class="spoiler_title">Implementation math_pow</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">math_pow</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _math_pow (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> value); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">math_pow</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> math_assert (y &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Power can't be negative"</span></span>), _math_pow (x, y.to_int(), <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _math_pow (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> value) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (y == <span class="hljs-number"><span class="hljs-number">0</span></span>) ? value : (x * _math_pow (x, y - <span class="hljs-number"><span class="hljs-number">1</span></span>, value)); }</code> </pre><br></div></div><br>  Product and division are processed in one function: <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//      . constexpr SMathValue get_muldiv (const SMathData data); //  .  _get_pow. constexpr SMathValue _get_muldiv (const SMathData data, const int value); constexpr SMathValue get_muldiv (const SMathData data) { return _get_muldiv (data.create (get_pow (data).end + 1), get_pow (data).value); } constexpr SMathValue _get_muldiv (const SMathData data, const int value) { return (data.char_start() == '*') ? _get_muldiv (data.create // start (get_pow (data.create (data.start + 1)).end + 1), // value value * get_pow (data.create (data.start + 1)).value) : ((data.char_start() == '/') ? (get_pow (data.create (data.start + 1)).value == 0) ? math_assert (false, "Division by zero") : _get_muldiv (data.create // start (get_pow (data.create (data.start + 1)).end + 1), // value value / get_pow (data.create (data.start + 1)).value) : SMathValue (value, data.start - 1)); }</span></span></code> </pre><br>  It is rather difficult to understand this construction, it is also difficult to write it.  Here there is a check whether the current character is <code>'*'</code> , if so, then the function calls itself, multiplying <code>value</code> by the read number (or expression).  In the case of <code>'/'</code> function behaves similarly, only before this there is a check that the denominator is not zero.  If the current character is not <code>'*'</code> or <code>'/'</code> , then the value is simply returned. <br><br>  Similarly, with the sum and difference: <br><div class="spoiler">  <b class="spoiler_title">Implementation get_addsub</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> SMathValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_addsub</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> SMathData data)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> SMathValue _get_addsub (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SMathData data, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMathVariable value); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> SMathValue </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_addsub</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> SMathData data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _get_addsub (data.create (get_muldiv (data).end + <span class="hljs-number"><span class="hljs-number">1</span></span>), get_muldiv (data).value); } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> SMathValue _get_addsub (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SMathData data, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMathVariable value) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (data.char_start() == <span class="hljs-string"><span class="hljs-string">'+'</span></span>) ? _get_addsub (data.create <span class="hljs-comment"><span class="hljs-comment">// start (get_muldiv (data.create (data.start + 1)).end + 1), // value value + get_muldiv (data.create (data.start + 1)).value) : ((data.char_start() == '-') ? _get_addsub (data.create // start (get_muldiv (data.create (data.start + 1)).end + 1), // value value - get_muldiv (data.create (data.start + 1)).value) : SMathValue (value, data.start - 1)); }</span></span></code> </pre><br>  The functions <code>get_addsub</code> and <code>_get_addsub</code> similar to the functions <code>get_muldiv</code> and <code>_getmuldiv</code> respectively. <br></div></div><br>  Finally, it remains to implement the <code>solve</code> function: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> CMathVariable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">solve</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* str, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// get_value ,      // ( ,  value.end == size),   . constexpr int get_value (const int size, const SMathValue value); constexpr int solve (const char* str, const size_t size) { return get_value (static_cast&lt;int&gt; (size), get_addsub (SMathData (str, static_cast&lt;int&gt; (size), 0))); } constexpr int get_value (const int size, const SMathValue value) { return math_assert (value.end + 1 == size, "Digit or operator required"), value.value; }</span></span></code> </pre><br>  And the last thing you can do: use your class of numbers, in which the numerator and denominator will be stored as separate variables.  There is nothing special here, just all the functions and the constructor have the <code>constexpr</code> . <br><div class="spoiler">  <b class="spoiler_title">Own class of numbers</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CMathVariable</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> numerator_; <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> denominator_; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CMathVariable</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> numerator, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> denominator)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> int64_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sign_</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> uint64_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gcd_</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> CMathVariable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reduce_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">explicit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CMathVariable</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> number)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> CMathVariable <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> + (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMathVariable&amp; n) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> CMathVariable <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> - (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMathVariable&amp; n) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> CMathVariable <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> * (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMathVariable&amp; n) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> CMathVariable <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> / (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMathVariable&amp; n) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> int64_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">numerator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> uint64_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">denominator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_plus_inf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_menus_inf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_nan</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_inf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_usual</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_integer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_int</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">force_to_int</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_double</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> CMathVariable <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> - (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMathVariable&amp; n); <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> CMathVariable <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> + (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMathVariable&amp; n); <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::ostream&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> &lt;&lt; (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::ostream&amp; os, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMathVariable&amp; var); }; <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> CMathVariable <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> - (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMathVariable&amp; n); <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> CMathVariable <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> + (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMathVariable&amp; n); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::ostream&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> &lt;&lt; (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::ostream&amp; os, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMathVariable&amp; var); <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> CMathVariable::CMathVariable (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> number) : numerator_ (number), denominator_ (<span class="hljs-number"><span class="hljs-number">1</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> CMathVariable::CMathVariable (<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> numerator, <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> denominator) : numerator_ (numerator), denominator_ (denominator) { } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> CMathVariable::sign_ (<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> a) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) - (a &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> CMathVariable::gcd_ (<span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> a, <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> b) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (b == <span class="hljs-number"><span class="hljs-number">0</span></span>) ? a : gcd_ (b, a % b); } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> CMathVariable CMathVariable::reduce_() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (numerator_ == <span class="hljs-number"><span class="hljs-number">0</span></span>) ? CMathVariable (<span class="hljs-number"><span class="hljs-number">0</span></span>, sign_ (denominator_)) : ((denominator_ == <span class="hljs-number"><span class="hljs-number">0</span></span>) ? CMathVariable (sign_ (numerator_), <span class="hljs-number"><span class="hljs-number">0</span></span>) : CMathVariable (numerator_ / gcd_ (<span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span>&gt; (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">abs</span></span> (numerator_)), denominator_), denominator_ / gcd_ (<span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span>&gt; (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">abs</span></span> (numerator_)), denominator_))); } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> CMathVariable::numerator() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> numerator_; } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> CMathVariable::denominator() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> denominator_; } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CMathVariable::is_plus_inf() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> denominator_ == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; numerator_ &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CMathVariable::is_menus_inf() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> denominator_ == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; numerator_ &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CMathVariable::is_nan() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> denominator_ == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; numerator_ == <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CMathVariable::is_inf() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> denominator_ == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; numerator_ != <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CMathVariable::is_usual() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> denominator_ != <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CMathVariable::is_integer() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> denominator_ == <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CMathVariable::to_int() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; (numerator_ / denominator_); } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CMathVariable::force_to_int() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (!(denominator_ == <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; (numerator_) == numerator_) ? (<span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::logic_error (<span class="hljs-string"><span class="hljs-string">"CMathVariable can't be represented by int"</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>) : <span class="hljs-number"><span class="hljs-number">0</span></span>), to_int(); } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> CMathVariable::to_double() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>&gt; (numerator_) / denominator_; } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> CMathVariable CMathVariable::<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> + (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMathVariable&amp; n) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CMathVariable ( <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span>&gt; (n.denominator_ / gcd_ (denominator_, n.denominator_)) * numerator_ + <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span>&gt; (denominator_ / gcd_ (denominator_, n.denominator_)) * n.numerator_, denominator_ / gcd_ (denominator_, n.denominator_) * n.denominator_).reduce_(); } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> CMathVariable CMathVariable::<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> - (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMathVariable&amp; n) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CMathVariable ( <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span>&gt; (n.denominator_ / gcd_ (denominator_, n.denominator_)) * numerator_ - <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span>&gt; (denominator_ / gcd_ (denominator_, n.denominator_)) * n.numerator_, denominator_ / gcd_ (denominator_, n.denominator_) * n.denominator_).reduce_(); } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> CMathVariable CMathVariable::<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> * (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMathVariable&amp; n) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CMathVariable ( numerator_ * n.numerator_, denominator_ * n.denominator_).reduce_(); } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> CMathVariable CMathVariable::<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> / (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMathVariable&amp; n) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CMathVariable ( numerator_ * <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span>&gt; (n.denominator_) * (n.numerator_ ? sign_ (n.numerator_) : <span class="hljs-number"><span class="hljs-number">1</span></span>), denominator_ * <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span>&gt; (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">abs</span></span> (n.numerator_))).reduce_(); } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> CMathVariable <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> + (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMathVariable&amp; n) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n; } <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> CMathVariable <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> - (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMathVariable&amp; n) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CMathVariable (-n.numerator_, n.denominator_); } <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::ostream&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> &lt;&lt; (<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::ostream&amp; stream, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CMathVariable&amp; var) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (var.is_plus_inf()) stream &lt;&lt; <span class="hljs-string"><span class="hljs-string">"+inf"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (var.is_menus_inf()) stream &lt;&lt; <span class="hljs-string"><span class="hljs-string">"-inf"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (var.is_nan()) stream &lt;&lt; <span class="hljs-string"><span class="hljs-string">"nan"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (var.denominator() == <span class="hljs-number"><span class="hljs-number">1</span></span>) stream &lt;&lt; var.numerator(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> stream &lt;&lt; var.numerator() &lt;&lt; <span class="hljs-string"><span class="hljs-string">" / "</span></span> &lt;&lt; var.denominator(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stream; }</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After that, you need to slightly change the code of the recursive descent and eventually get what you want. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Writing a recursive descent on constexpr-functions took about a day, although the usual recursive descent is written without problems in an hour. </font><font style="vertical-align: inherit;">The problems were with a confusion with brackets, with the complexity of debugging, with incomprehensible errors, with an ill-conceived architecture (yes, now even for recursive descent, everything must be carefully thought out). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The repository with this library is here: </font></font><a href="https://bitbucket.org/jjeka/mathcpp"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://bitbucket.org/jjeka/mathcpp</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> If you have any shortcomings or questions, write! </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I believe that it is already time to create a hub dedicated to C ++ 11/14.</font></font></div><p>Source: <a href="https://habr.com/ru/post/228181/">https://habr.com/ru/post/228181/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../228159/index.html">Power sources</a></li>
<li><a href="../228163/index.html">How to ease the pain of payment. 7 studies on the psychology of finance</a></li>
<li><a href="../228169/index.html">ReadyScript - our look at CMS for online stores</a></li>
<li><a href="../228171/index.html">How to make money on Android games</a></li>
<li><a href="../228179/index.html">Moto E - the best budget for Android KitKat</a></li>
<li><a href="../228187/index.html">Review of the most interesting materials on data analysis and machine learning No. 3 (review of online courses)</a></li>
<li><a href="../228189/index.html">From graphene learned to make a flexible and durable thread</a></li>
<li><a href="../228193/index.html">SQLite is now for mobile C # applications for any platform</a></li>
<li><a href="../228195/index.html">The work of the Haar cascade in OpenCV in pictures: theory and practice</a></li>
<li><a href="../228199/index.html">Sounds of venus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>