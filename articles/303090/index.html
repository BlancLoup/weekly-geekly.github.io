<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>vrf-table-label</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today we will talk about the team vrf-table-label. First, recall the methods for generating vrf tags. Labels can be generated in three ways - per-vrf,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>vrf-table-label</h1><div class="post__text post__text-html js-mediator-article">  Today we will talk about the team vrf-table-label.  First, recall the methods for generating vrf tags.  Labels can be generated in three ways - per-vrf, per-prefix and per-next-hop. <br><br>  <i>per-prefix</i> - one label - one client prefix, that is, if we have 100 client vrfs and each client has 100 prefixes, then we get 100x100 = 10,000 tags, which is very wasteful by today's standards.  This default vrf tag allocation method is used in Cisco routers. <br><br>  <i>per-next-hop</i> - one label for all client prefixes that have the same next-hop.  If the client router is connected to the PE router with one link, then all prefixes will have the same next-hop, which means the same label.  This is the default vrf tag allocation mechanism in JunOS. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>per-vrf</i> - one label for the entire vrf.  In terms of label distribution, this mode is very economical: if we have 100 client vrfs and each client has 100 prefixes, then we get 100x1 = 100 labels.  With this distribution of vrf tags, the router should do besides the mpls lookup also the ip lookup. <a name="habracut"></a><br><br>  As it was written above, by default JunOS uses the per-next-hop label distribution.  If you want to change this behavior, you will have to give the vrf-table-label command (for fans of confused configurations, the distribution of labels can be set using the policy) or use a tunnel PIC.  Now we will analyze how everything works with this command and without it.  We will use just such a scheme with Option C. <br><img src="https://habrastorage.org/files/545/f46/482/545f464824d64ac3941662e34f366f6c.jpg"><br>  <b>Without vrf-table label command</b> (and creating vt-interface). <br>  The configuration of vrf on PE1 is as follows: <br><pre><code class="cpp hljs">bormoglotx@PE1&gt; show configuration routing-instances CE1 instance-type vrf; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3.10</span></span>; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3.20</span></span>; route-distinguisher <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>; vrf-target { <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> target:<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> target:<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span>; } protocols { ospf { <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> ospf-<span class="hljs-keyword"><span class="hljs-keyword">export</span></span>; area <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> { interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3.10</span></span>; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3.20</span></span>; } } }</code> </pre> <br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show configuration interfaces ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3</span></span> description <span class="hljs-string"><span class="hljs-string">"to SW1"</span></span>; vlan-tagging; unit <span class="hljs-number"><span class="hljs-number">10</span></span> { description <span class="hljs-string"><span class="hljs-string">"to CE1 site 1"</span></span>; vlan-id <span class="hljs-number"><span class="hljs-number">10</span></span>; family inet { address <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span>; } } unit <span class="hljs-number"><span class="hljs-number">20</span></span> { description <span class="hljs-string"><span class="hljs-string">"to CE1 site 2"</span></span>; vlan-id <span class="hljs-number"><span class="hljs-number">20</span></span>; family inet { address <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span>; } }</code> </pre><br>  Accordingly, the router begins to generate vpnv4 prefixes and transfer them to router reflectors.  In our case, the router-reflector has the address 10.0.10.10: <br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show route advertising-protocol bgp <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> CE1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">9</span></span> destinations, <span class="hljs-number"><span class="hljs-number">9</span></span> routes (<span class="hljs-number"><span class="hljs-number">9</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) Prefix Nexthop MED Lclpref AS path * <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> Self <span class="hljs-number"><span class="hljs-number">100</span></span> I * <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> Self <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> I * <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> Self <span class="hljs-number"><span class="hljs-number">100</span></span> I * <span class="hljs-number"><span class="hljs-number">20.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> Self <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> I</code> </pre><br>  PE1 sends four paths to the reflector: two connected networks and two / 32 (Lupbacks of CE routers), which it receives via ospf.  Let's see what labels were generated for these prefixes: <br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show route advertising-protocol bgp <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> detail CE1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">9</span></span> destinations, <span class="hljs-number"><span class="hljs-number">9</span></span> routes (<span class="hljs-number"><span class="hljs-number">9</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) * <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span> entry, <span class="hljs-number"><span class="hljs-number">1</span></span> announced) BGP group RR type Internal Route Distinguisher: <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> VPN Label: <span class="hljs-number"><span class="hljs-number">299888</span></span> Nexthop: Self Flags: Nexthop Change Localpref: <span class="hljs-number"><span class="hljs-number">100</span></span> AS path: [<span class="hljs-number"><span class="hljs-number">1</span></span>] I Communities: target:<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> * <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span> entry, <span class="hljs-number"><span class="hljs-number">1</span></span> announced) BGP group RR type Internal Route Distinguisher: <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> VPN Label: <span class="hljs-number"><span class="hljs-number">299888</span></span> Nexthop: Self Flags: Nexthop Change MED: <span class="hljs-number"><span class="hljs-number">2</span></span> Localpref: <span class="hljs-number"><span class="hljs-number">100</span></span> AS path: [<span class="hljs-number"><span class="hljs-number">1</span></span>] I Communities: target:<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> rte-type:<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> * <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span> entry, <span class="hljs-number"><span class="hljs-number">1</span></span> announced) BGP group RR type Internal Route Distinguisher: <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> VPN Label: <span class="hljs-number"><span class="hljs-number">299904</span></span> Nexthop: Self Flags: Nexthop Change Localpref: <span class="hljs-number"><span class="hljs-number">100</span></span> AS path: [<span class="hljs-number"><span class="hljs-number">1</span></span>] I Communities: target:<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> * <span class="hljs-number"><span class="hljs-number">20.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span> entry, <span class="hljs-number"><span class="hljs-number">1</span></span> announced) BGP group RR type Internal Route Distinguisher: <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> VPN Label: <span class="hljs-number"><span class="hljs-number">299904</span></span> Nexthop: Self Flags: Nexthop Change MED: <span class="hljs-number"><span class="hljs-number">2</span></span> Localpref: <span class="hljs-number"><span class="hljs-number">100</span></span> AS path: [<span class="hljs-number"><span class="hljs-number">1</span></span>] I Communities: target:<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> rte-type:<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  For clarity, select only the values ‚Äã‚Äãof the tags from the conclusions: <br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show route advertising-protocol bgp <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> detail | match label VPN Label: <span class="hljs-number"><span class="hljs-number">299888</span></span> VPN Label: <span class="hljs-number"><span class="hljs-number">299888</span></span> VPN Label: <span class="hljs-number"><span class="hljs-number">299904</span></span> VPN Label: <span class="hljs-number"><span class="hljs-number">299904</span></span></code> </pre><br>  You can see that for prefixes from a range of 10.0.0.0/8, label 299888 is generated, and for prefixes from a range of 20.0.0.0/8, label 299904. But there is one not very pleasant nuance - in this case JunOS does not produce ip lookup.  What does it threaten with?  You will not be able to use filters, since the ip header is not analyzed. <br><br>  Let's check it in practice. <br>  According to the output below, PE1, having received a packet labeled 299904, simply sends it to the ge-0/0 / 3.20 interface: <br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show route table mpls<span class="hljs-number"><span class="hljs-number">.0</span></span> label <span class="hljs-number"><span class="hljs-number">299904</span></span> mpls<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">11</span></span> destinations, <span class="hljs-number"><span class="hljs-number">11</span></span> routes (<span class="hljs-number"><span class="hljs-number">11</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">299904</span></span> *[VPN/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">46</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3.20</span></span>, Pop</code> </pre><br>  and for packets labeled 299888 - to the interface ge-0/0 / 3.10: <br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show route table mpls<span class="hljs-number"><span class="hljs-number">.0</span></span> label <span class="hljs-number"><span class="hljs-number">299888</span></span> mpls<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">11</span></span> destinations, <span class="hljs-number"><span class="hljs-number">11</span></span> routes (<span class="hljs-number"><span class="hljs-number">11</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">299888</span></span> *[VPN/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">46</span></span>:<span class="hljs-number"><span class="hljs-number">25</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3.10</span></span>, Pop</code> </pre><br>  As you can see, the router will remove the tag and send the packet to the interface depending on the incoming tag, without doing ip lookup, which we will now see. <br><br>  Check the availability of vpnv4 routes on PE2: <br><pre> <code class="cpp hljs">PE2<span class="hljs-meta"><span class="hljs-meta">#sh ip bgp vpnv4 rd 1:1 labels Network Next Hop In label/Out label Route Distinguisher: 1:1 10.0.0.0/24 10.0.10.1 nolabel/299888 10.1.1.1/32 10.0.10.1 nolabel/299888 20.0.0.0/24 10.0.10.1 nolabel/299904 20.1.1.1/32 10.0.10.1 nolabel/299904</span></span></code> </pre><br>  Now let's look at the routing table on CE2: <br><pre> <code class="cpp hljs">CE2<span class="hljs-meta"><span class="hljs-meta">#sh ip rou | b Ga Gateway of last resort is not set 10.0.0.0/8 is variably subnetted, 5 subnets, 2 masks O E2 10.0.0.0/24 [110/10] via 10.0.1.1, 00:22:32, GigabitEthernet1/0.10 C 10.0.1.0/24 is directly connected, GigabitEthernet1/0.10 L 10.0.1.2/32 is directly connected, GigabitEthernet1/0.10 O E2 10.1.1.1/32 [110/10] via 10.0.1.1, 00:22:32, GigabitEthernet1/0.10 C 10.1.1.2/32 is directly connected, Loopback0 20.0.0.0/8 is variably subnetted, 2 subnets, 2 masks O E2 20.0.0.0/24 [110/10] via 10.0.1.1, 00:22:32, GigabitEthernet1/0.10 O E2 20.1.1.1/32 [110/10] via 10.0.1.1, 00:22:32, GigabitEthernet1/0.10</span></span></code> </pre><br>  Everything is great - there are routes.  Now we can start tracing to 20.0.0.2 - address CE1-2: <br><pre> <code class="cpp hljs">CE2<span class="hljs-meta"><span class="hljs-meta">#traceroute 20.0.0.2 Type escape sequence to abort. Tracing the route to 20.0.0.2 1 10.0.1.1 36 msec 32 msec 8 msec 2 10.1.3.2 [MPLS: Labels 20/18/299904 Exp 0] 56 msec 64 msec 60 msec 3 10.1.2.1 [MPLS: Labels 18/299904 Exp 0] 72 msec 108 msec 40 msec 4 10.2.0.1 [MPLS: Labels 299952/299904 Exp 0] 60 msec 88 msec 60 msec 5 10.0.3.2 [MPLS: Labels 299808/299904 Exp 0] 76 msec 68 msec 64 msec 6 10.0.2.1 [MPLS: Label 299904 Exp 0] 60 msec 52 msec 64 msec 7 20.0.0.2 60 msec 60 msec 56 msec</span></span></code> </pre><br>  Everything is predictable - standard tracing via Option C. <br><img src="https://habrastorage.org/files/17f/882/3c2/17f8823c238c4440a1fbdfb411ff288d.jpg"><br>  Now let's start tracing up to 20.0.0.1 - this is the address of the PE1 interface in the direction of the client (at the very beginning of the article the interface setting is shown) <br><pre> <code class="cpp hljs">CE2<span class="hljs-meta"><span class="hljs-meta">#traceroute 20.0.0.1 Type escape sequence to abort. Tracing the route to 20.0.0.1 1 10.0.1.1 40 msec 4 msec 16 msec 2 10.1.3.2 [MPLS: Labels 20/18/299904 Exp 0] 80 msec 64 msec 60 msec 3 10.1.2.1 [MPLS: Labels 18/299904 Exp 0] 56 msec 60 msec 72 msec 4 10.2.0.1 [MPLS: Labels 299952/299904 Exp 0] 48 msec 76 msec 112 msec 5 10.0.3.2 [MPLS: Labels 299808/299904 Exp 0] 68 msec 96 msec 64 msec 6 10.0.2.1 [MPLS: Label 299904 Exp 0] 80 msec 68 msec 4 msec 7 20.0.0.2 92 msec 72 msec 64 msec 8 20.0.0.1 96 msec 48 msec 88 msec</span></span></code> </pre><br>  Comparing the output with the previous one, we see that up to 20.0.0.1 one hop more.  How so, because 20.0.0.1 - the gateway for the network 20.0.0.0/24?  If you look closely, we see that the packet from the PE router (10.0.2.1 - core facing interface) was sent to the CE router (address 20.0.0.2) and returned to the PE router (20.0.0.1).  As I said, JunOS didn‚Äôt do ip lookup and just forwarded the packet to the client interface, but the client‚Äôs router checked the destination address of the ip packet and sent it back to PE1 (see the figure below): <br><img src="https://habrastorage.org/files/960/72b/371/96072b371f884f37b28cc69d7554fb4c.jpg"><br>  That is, in our case, the router received a packet with a tag from the network core, looked in the table mpls.0 what needs to be done with the packet, removed the tag and sent it to the interface in the direction of the client. <br><img src="https://habrastorage.org/files/737/5bc/f76/7375bcf7680e4449b71ddd6002a097c5.jpg"><br>  If we hang any filter on our PE router on the client interface or configure qos, in view of the above, the traffic will not be processed according to the installed filters. <br><br>  Let's hang on the interface in the direction of the client filter: <br><pre> <code class="cpp hljs">bormoglotx@PE1<span class="hljs-meta"><span class="hljs-meta"># show firewall family inet filter To-CE1-2 term 1 { from { destination-address { 20.0.0.0/24; } } then { reject; } } term 2 { then accept; } [edit] bormoglotx@PE1# show interfaces ge-0/0/3.20 description </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"to CE1 site 2"</span></span></span><span class="hljs-meta">; vlan-id 20; family inet { filter { output To-CE1-2; } address 20.0.0.1/24; }</span></span></code> </pre><br>  And now we will launch a ping to the network 20.0.0.0/24 with CE2: <br><pre> <code class="cpp hljs">CE2<span class="hljs-meta"><span class="hljs-meta">#ping 20.0.0.2 Type escape sequence to abort. Sending 5, 100-byte ICMP Echos to 20.0.0.2, timeout is 2 seconds: !!!!! Success rate is 100 percent (5/5), round-trip min/avg/max = 64/69/72 ms</span></span></code> </pre><br>  There is a filter, but it does not work.  Let's change this situation by enabling the vrf-table label option: <br><pre> <code class="cpp hljs">[edit] bormoglotx@PE1<span class="hljs-meta"><span class="hljs-meta"># set routing-instances CE1 vrf-table-label</span></span></code> </pre><br>  Let's try to run the ping again to the network 20.0.0.0/24 with CE2: <br><pre> <code class="cpp hljs">CE2<span class="hljs-meta"><span class="hljs-meta">#ping 20.0.0.2 Type escape sequence to abort. Sending 5, 100-byte ICMP Echos to 20.0.0.2, timeout is 2 seconds: UUUUU Success rate is 0 percent (0/5)</span></span></code> </pre><br>  Now the host is unreachable - the filter is working.  Remove the filter and run the ping again to check: <br><pre> <code class="cpp hljs">[edit] bormoglotx@PE1<span class="hljs-meta"><span class="hljs-meta"># deactivate interfaces ge-0/0/3.20 family inet filter [edit] bormoglotx@PE1# show | compare [edit interfaces ge-0/0/3 unit 20 family inet] ! inactive: filter { ... }</span></span></code> </pre><br><pre> <code class="cpp hljs">CE2<span class="hljs-meta"><span class="hljs-meta">#ping 20.0.0.2 Type escape sequence to abort. Sending 5, 100-byte ICMP Echos to 20.0.0.2, timeout is 2 seconds: !!!!! Success rate is 100 percent (5/5), round-trip min/avg/max = 60/88/148 ms</span></span></code> </pre><br>  All perfectly.  Now we have seen clearly what pitfalls await us with the default mechanism for the distribution of vrf tags in JunOS.  Since we have already given the vrf-table-label command above and have deactivated the filter, we‚Äôll proceed to discuss the operation of the router <b>with the vrf-table-label option enabled</b> . <br><br>  Let's see the routes that PE1 announces on the router: <br>  bormoglotx @ PE1&gt; show route advertising-protocol bgp 10.0.10.10 <br><pre> <code class="cpp hljs">CE1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">9</span></span> destinations, <span class="hljs-number"><span class="hljs-number">9</span></span> routes (<span class="hljs-number"><span class="hljs-number">9</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) Prefix Nexthop MED Lclpref AS path * <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> Self <span class="hljs-number"><span class="hljs-number">100</span></span> I * <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> Self <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> I * <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> Self <span class="hljs-number"><span class="hljs-number">100</span></span> I * <span class="hljs-number"><span class="hljs-number">20.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> Self <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> I</code> </pre><br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show route advertising-protocol bgp <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> detail CE1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">9</span></span> destinations, <span class="hljs-number"><span class="hljs-number">9</span></span> routes (<span class="hljs-number"><span class="hljs-number">9</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) * <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span> entry, <span class="hljs-number"><span class="hljs-number">1</span></span> announced) BGP group RR type Internal Route Distinguisher: <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> VPN Label: <span class="hljs-number"><span class="hljs-number">16</span></span> Nexthop: Self Flags: Nexthop Change Localpref: <span class="hljs-number"><span class="hljs-number">100</span></span> AS path: [<span class="hljs-number"><span class="hljs-number">1</span></span>] I Communities: target:<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> * <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span> entry, <span class="hljs-number"><span class="hljs-number">1</span></span> announced) BGP group RR type Internal Route Distinguisher: <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> VPN Label: <span class="hljs-number"><span class="hljs-number">16</span></span> Nexthop: Self Flags: Nexthop Change MED: <span class="hljs-number"><span class="hljs-number">2</span></span> Localpref: <span class="hljs-number"><span class="hljs-number">100</span></span> AS path: [<span class="hljs-number"><span class="hljs-number">1</span></span>] I Communities: target:<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> rte-type:<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> * <span class="hljs-number"><span class="hljs-number">20.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span> entry, <span class="hljs-number"><span class="hljs-number">1</span></span> announced) BGP group RR type Internal Route Distinguisher: <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> VPN Label: <span class="hljs-number"><span class="hljs-number">16</span></span> Nexthop: Self Flags: Nexthop Change Localpref: <span class="hljs-number"><span class="hljs-number">100</span></span> AS path: [<span class="hljs-number"><span class="hljs-number">1</span></span>] I Communities: target:<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> * <span class="hljs-number"><span class="hljs-number">20.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span> entry, <span class="hljs-number"><span class="hljs-number">1</span></span> announced) BGP group RR type Internal Route Distinguisher: <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> VPN Label: <span class="hljs-number"><span class="hljs-number">16</span></span> Nexthop: Self Flags: Nexthop Change MED: <span class="hljs-number"><span class="hljs-number">2</span></span> Localpref: <span class="hljs-number"><span class="hljs-number">100</span></span> AS path: [<span class="hljs-number"><span class="hljs-number">1</span></span>] I Communities: target:<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> rte-type:<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  As you can see, now we have only one label for all routes from vrf CE1: <br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show route advertising-protocol bgp <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> detail | match label VPN Label: <span class="hljs-number"><span class="hljs-number">16</span></span> VPN Label: <span class="hljs-number"><span class="hljs-number">16</span></span> VPN Label: <span class="hljs-number"><span class="hljs-number">16</span></span> VPN Label: <span class="hljs-number"><span class="hljs-number">16</span></span></code> </pre><br>  Run the trace again from CE2 to 20.0.0.1: <br><pre> <code class="cpp hljs">CE2<span class="hljs-meta"><span class="hljs-meta">#traceroute 20.0.0.1 Type escape sequence to abort. Tracing the route to 20.0.0.1 1 10.0.1.1 32 msec 16 msec 20 msec 2 10.1.3.2 [MPLS: Labels 20/18/16 Exp 0] 76 msec 48 msec 68 msec 3 10.1.2.1 [MPLS: Labels 18/16 Exp 0] 68 msec 48 msec 56 msec 4 10.2.0.1 [MPLS: Labels 299952/16 Exp 0] 52 msec 48 msec 52 msec 5 10.0.3.2 [MPLS: Labels 299808/16 Exp 0] 52 msec 52 msec 52 msec 6 20.0.0.1 76 msec 52 msec 72 msec</span></span></code> </pre><br>  Now icmp packets do not loop through CE1-2. <br>  The route itself on PE1 now looks a little different: <br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show route table mpls<span class="hljs-number"><span class="hljs-number">.0</span></span> label <span class="hljs-number"><span class="hljs-number">16</span></span> mpls<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> destinations, <span class="hljs-number"><span class="hljs-number">10</span></span> routes (<span class="hljs-number"><span class="hljs-number">10</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">16</span></span> *[VPN/<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span> to table CE1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span>, Pop</code> </pre><br>  In the usual language, when receiving a packet with a label 16, you must remove the label and make an ip lookup in the table CE1.inet.0.  Why is this function not implemented in Juniper when generating per-nex-hop tags?  The point is Juniper hardware architecture - PFE cannot do both mpls and ip lookup at the same time.  To implement a double lookup, we need the so-called Tunnel Services PIC, then a tunnel PIC (vt-fpc / pic / port.unit-number interface).  Here is the PIC in the M120 chassis: <br><img src="https://habrastorage.org/files/18f/533/b66/18f533b66f8341ba9ca432e8abfc3e18.jpg"><br>  Note: You can read about creating a vt-interface and adding it to vrf <br><br>  Now the packet processing algorithm will be changed: the router accepted the packet with a tag from the network core, looked in the mpls.0 table what needs to be done with the packet, removed the tag and sent it to the vt interface, then the packet from the vt interface again goes to the PFE, but without the tag and PFE can do ip lookup (and then send to the client). <br><img src="https://habrastorage.org/files/44b/d21/a88/44bd21a887a646458208ef1293f32a10.jpg"><br>  But the need for a tunnel PIC imposes certain restrictions on the use of this function.  Therefore, if you do not have such a PIC, then you can give the vrf-table-label command and JunOS automatically creates a virtual lsi (label switching interface) interface (supported by ACX, M, MX, T Series platforms) that performs exactly the same function as vt-interface: <br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show interfaces terse | match lsi lsi up up lsi<span class="hljs-number"><span class="hljs-number">.0</span></span> up up inet</code> </pre><br>  This interface is not available for configuration.  For each vrf, a separate lsi interface is created, which is associated with the label generated for this vrf.  For example, create another vrf and see how many lsi interfaces are now: <br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show configuration routing-instances ? Possible completions: &lt;[Enter]&gt; Execute <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> command &lt;instance_name&gt; Routing instance name CE1 Routing instance name CE2 Routing instance name + apply-groups Groups from which to inherit configuration data + apply-groups-except Don't inherit configuration data from these groups | Pipe through a command</code> </pre><br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show interfaces terse | match lsi lsi up up lsi<span class="hljs-number"><span class="hljs-number">.0</span></span> up up inet lsi<span class="hljs-number"><span class="hljs-number">.1</span></span> up up inet</code> </pre><br><br>  You can see which lsi unit corresponds to a routing instance with the command: show interfaces lsi routing-instance-instance-name, for example, in our case: <br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show interfaces lsi routing-instance CE1 | match logical Logical interface lsi<span class="hljs-number"><span class="hljs-number">.0</span></span> (Index <span class="hljs-number"><span class="hljs-number">71</span></span>) (SNMP ifIndex <span class="hljs-number"><span class="hljs-number">524</span></span>) bormoglotx@PE1&gt; show interfaces lsi routing-instance CE2 | match logical Logical interface lsi<span class="hljs-number"><span class="hljs-number">.1</span></span> (Index <span class="hljs-number"><span class="hljs-number">81</span></span>) (SNMP ifIndex <span class="hljs-number"><span class="hljs-number">525</span></span>)</code> </pre><br>  The lsi interface is created for vpls routing-instance (no-tunnel-services command), the traffic is then processed as described above, except that vpls operates only mac addresses without knowing anything about client ip addresses, but this is completely other story. <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/303090/">https://habr.com/ru/post/303090/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303078/index.html">IT Music Fest: guitar instead of Claudia and music instead of code</a></li>
<li><a href="../303082/index.html">Security Week 23: all passwords were stolen, not by TeamViewer, Lenovo asks to remove the vulnerable utility</a></li>
<li><a href="../303084/index.html">PyConRu: why?</a></li>
<li><a href="../303086/index.html">Intel is going to fight microprocessor-level exploits</a></li>
<li><a href="../303088/index.html">Case: a new site in the TOP Yandex for a year and a half</a></li>
<li><a href="../303094/index.html">Rostelecom invites to Hakaton all who are looking for the glory of bigdat superheroes</a></li>
<li><a href="../303096/index.html">How do brands communicate with ‚Äúself generation‚Äù?</a></li>
<li><a href="../303098/index.html">Creating a blog on symfony 2.8 lts [Part 5.1]</a></li>
<li><a href="../303100/index.html">Carefully, redesign: "voice of the people" vs "eye of the designer"</a></li>
<li><a href="../303104/index.html">RDS, how does it work? We get down to the lowest level of the OSI model</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>