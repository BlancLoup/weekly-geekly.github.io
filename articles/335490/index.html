<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Developing a telegram bot using Spring</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Write bots telegrams? Does your development productivity want the best? Looking for something new? Then I ask for cat. 



 The idea is the following:...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Developing a telegram bot using Spring</h1><div class="post__text post__text-html js-mediator-article"><p>  Write bots telegrams?  Does your development productivity want the best?  Looking for something new?  Then I ask for cat. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/web/795/9d9/408/7959d94084db47a6b7e796b7ecd450ee.png" width="400"></div><a name="habracut"></a><br><p>  The idea is the following: slyamzit spring mvc architecture and transfer to telegram api. <br>  It should look something like this: </p><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@BotController</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleOkayController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@BotRequestMapping</span></span>(value = <span class="hljs-string"><span class="hljs-string">"/ok"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> SendMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ok</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Update update)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SendMessage() .setChatId(update.getMessage().getChatId()) .setText(<span class="hljs-string"><span class="hljs-string">"okay bro, okay!"</span></span>); } }</code> </pre> <br><p>  or </p><br><div class="spoiler">  <b class="spoiler_title">Bins example</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@BotController</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StartController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Filter shopMenu; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PayTokenService payTokenService; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ItemService itemService; <span class="hljs-meta"><span class="hljs-meta">@BotRequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/shop"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> SendMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateInitMenu</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Update update)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SendMessage() .setChatId(update.getMessage().getChatId().toString()) .setText(<span class="hljs-string"><span class="hljs-string">"  !"</span></span>) .setReplyMarkup(shopMenu.getSubMenu(<span class="hljs-number"><span class="hljs-number">0L</span></span>, <span class="hljs-number"><span class="hljs-number">4L</span></span>, <span class="hljs-number"><span class="hljs-number">1L</span></span>)); <span class="hljs-comment"><span class="hljs-comment">// &lt;-- } @BotRequestMapping(value = "/buyItem", method = BotRequestMethod.EDIT) public List&lt;BotApiMethod&gt; bayItem(Update update) { .................... Item item = itemService.findById(id); // &lt;-- return Arrays.asList(new EditMessageText() .setChatId(update.getMessage().getChatId()) .setMessageId(update.getMessage().getMessageId()) .setText("  ,   "), new SendInvoice() .setChatId(Integer.parseInt(update.getMessage().getChatId().toString())) .setDescription(item.getDescription()) .setTitle(item.getName()) .setProviderToken(payTokenService.getPayToken()) ........................ .setPrices(item.getPrice()) ); } }</span></span></code> </pre> </div></div><br><p>  This gives the following benefits: </p><br><ul><li>  Do not write custom logic to select a message handler from the user. </li><li>  Ability to inject different beans into our @BotController </li><li>  As a consequence of the previous two points - a significant reduction in the amount of code </li><li>  Potentially (although I have not done this yet) the arguments of the custom handler method can be expressed in the form of those arguments that are really needed! </li><li>  Ability to create serious enterprise solutions using spring </li></ul><br><p>  Let's now see how this can be started in our project. </p><br><div class="spoiler">  <b class="spoiler_title">Annotations</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Target</span></span>({ElementType.TYPE}) <span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RetentionPolicy.RUNTIME) <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> BotController { String[] value() <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> {}; } <span class="hljs-meta"><span class="hljs-meta">@Target</span></span>({ElementType.METHOD}) <span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RetentionPolicy.RUNTIME) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> BotRequestMapping { String[] value() <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> {}; BotRequestMethod[] method() <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> {BotRequestMethod.MSG}; }</code> </pre> </div></div><br><p>  Create your handler container in the form of a regular HashMap </p><br><div class="spoiler">  <b class="spoiler_title">Container</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BotApiMethodContainer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(BotApiMethodContainer.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, BotApiMethodController&gt; controllerMap; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> BotApiMethodContainer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstanse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Holder.INST; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addBotController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String path, BotApiMethodController controller)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(controllerMap.containsKey(path)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BotApiMethodContainerException(<span class="hljs-string"><span class="hljs-string">"path "</span></span> + path + <span class="hljs-string"><span class="hljs-string">" already add"</span></span>); LOGGER.trace(<span class="hljs-string"><span class="hljs-string">"add telegram bot controller for path: "</span></span> + path); controllerMap.put(path, controller); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BotApiMethodController </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBotApiMethodController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String path)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> controllerMap.get(path); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BotApiMethodContainer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ controllerMap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Holder</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> BotApiMethodContainer INST = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BotApiMethodContainer(); } }</code> </pre> </div></div><br><p>  We will store the wrapper controllers in the container (for a pair of @BotController and @BotRequestMapping) </p><br><div class="spoiler">  <b class="spoiler_title">Controller wrapper</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BotApiMethodController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(BotApiMethodController.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Object bean; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Method method; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Process processUpdate; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BotApiMethodController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object bean, Method method)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bean = bean; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.method = method; processUpdate = typeListReturnDetect() ? <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::processList : <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::processSingle; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">successUpdatePredicate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Update update)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;BotApiMethod&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Update update)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!successUpdatePredicate(update)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> processUpdate.accept(update); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IllegalAccessException | InvocationTargetException e) { LOGGER.error(<span class="hljs-string"><span class="hljs-string">"bad invoke method"</span></span>, e); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">typeListReturnDetect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> List.class.equals(method.getReturnType()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;BotApiMethod&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processSingle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Update update)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InvocationTargetException, IllegalAccessException </span></span>{ BotApiMethod botApiMethod = (BotApiMethod) method.invoke(bean, update); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> botApiMethod != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? Collections.singletonList(botApiMethod) : <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(<span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;BotApiMethod&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Update update)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InvocationTargetException, IllegalAccessException </span></span>{ List&lt;BotApiMethod&gt; botApiMethods = (List&lt;BotApiMethod&gt;) method.invoke(bean, update); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> botApiMethods != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? botApiMethods : <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(<span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Process</span></span></span></span>{ <span class="hljs-function"><span class="hljs-function">List&lt;BotApiMethod&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Update update)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InvocationTargetException, IllegalAccessException</span></span>; } }</code> </pre> </div></div><br><p>  Now, when we have this codebase, the question arises: how can Spring make the container automatically fill so that we can use it? </p><br><p>  To do this, we implement a special bin - BeanPostProcessor.  This makes it possible to catch bins during their initialization.  Our controllers have scope by default - singleton, it means they will be initialized with the start of the context! </p><br><div class="spoiler">  <b class="spoiler_title">TelegramUpdateHandlerBeanPostProcessor</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TelegramUpdateHandlerBeanPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeanPostProcessor</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ordered</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(TelegramUpdateHandlerBeanPostProcessor.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BotApiMethodContainer container = BotApiMethodContainer.getInstanse(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Class&gt; botControllerMap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessBeforeInitialization</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object bean, String beanName)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> BeansException </span></span>{ Class&lt;?&gt; beanClass = bean.getClass(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (beanClass.isAnnotationPresent(BotController.class)) botControllerMap.put(beanName, beanClass); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bean; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessAfterInitialization</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object bean, String beanName)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> BeansException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!botControllerMap.containsKey(beanName)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bean; Object original = botControllerMap.get(beanName); Arrays.stream(original.getClass().getMethods()) .filter(method -&gt; method.isAnnotationPresent(BotRequestMapping.class)) .forEach((Method method) -&gt; generateController(bean, method)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bean; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object bean, Method method)</span></span></span><span class="hljs-function"> </span></span>{ BotController botController = bean.getClass().getAnnotation(BotController.class); BotRequestMapping botRequestMapping = method.getAnnotation(BotRequestMapping.class); String path = (botController.value().length != <span class="hljs-number"><span class="hljs-number">0</span></span> ? botController.value()[<span class="hljs-number"><span class="hljs-number">0</span></span>] : <span class="hljs-string"><span class="hljs-string">""</span></span>) + (botRequestMapping.value().length != <span class="hljs-number"><span class="hljs-number">0</span></span> ? botRequestMapping.value()[<span class="hljs-number"><span class="hljs-number">0</span></span>] : <span class="hljs-string"><span class="hljs-string">""</span></span>); BotApiMethodController controller = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (botRequestMapping.method()[<span class="hljs-number"><span class="hljs-number">0</span></span>]){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MSG: controller = createControllerUpdate2ApiMethod(bean, method); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> EDIT: controller = createProcessListForController(bean, method); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (controller != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { container.addBotController(path, controller); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> BotApiMethodController </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createControllerUpdate2ApiMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object bean, Method method)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BotApiMethodController(bean, method) { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">successUpdatePredicate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Update update)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> update!=<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; update.hasMessage() &amp;&amp; update.getMessage().hasText(); } }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> BotApiMethodController </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createProcessListForController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object bean, Method method)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BotApiMethodController(bean, method) { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">successUpdatePredicate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Update update)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> update!=<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; update.hasCallbackQuery() &amp;&amp; update.getCallbackQuery().getData() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getOrder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>; } }</code> </pre> </div></div><br><p>  Initialize the context in which all our bins are registered and - voila!  You can select handlers for messages, for example, like this: </p><br><div class="spoiler">  <b class="spoiler_title">Handler selection</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SelectHandle</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> BotApiMethodContainer container = BotApiMethodContainer.getInstanse(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> BotApiMethodController </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getHandle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Update update)</span></span></span><span class="hljs-function"> </span></span>{ String path; BotApiMethodController controller = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (update.hasMessage() &amp;&amp; update.getMessage().hasText()) { path = update.getMessage().getText().split(<span class="hljs-string"><span class="hljs-string">" "</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].trim(); controller = container.getControllerMap().get(path); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (controller == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) controller = container.getControllerMap().get(<span class="hljs-string"><span class="hljs-string">""</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (update.hasCallbackQuery()) { path = update.getCallbackQuery().getData().split(<span class="hljs-string"><span class="hljs-string">"/"</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>].trim(); controller = container.getControllerMap().get(path); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> controller != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? controller : <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FakeBotApiMethodController(); } }</code> </pre> </div></div><br><p>  <strong>P.S</strong> <br>  Telegram is developing very rapidly.  Using bots, we can organize our stores, give commands to our various Internet things, organize blog feeds and much more.  And most importantly, all this in a single application! </p><br><p>  References: </p><br><ul><li>  <a href="https://github.com/rubenlagus/TelegramBots">java lib for base telegram api</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/335490/">https://habr.com/ru/post/335490/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335476/index.html">Practical business of ontology: a story c advanced</a></li>
<li><a href="../335478/index.html">Writing extensions for PHP 7 in C ++</a></li>
<li><a href="../335480/index.html">Learn App Shortcuts on Android Nougat 7.1</a></li>
<li><a href="../335484/index.html">Create a checklist for helpdesk implementation</a></li>
<li><a href="../335488/index.html">Rethinking PID 1. Part 2</a></li>
<li><a href="../335492/index.html">Information economy: why the cost of technology companies is so high</a></li>
<li><a href="../335494/index.html">Accuracy through inaccuracy: Improving Time-objects</a></li>
<li><a href="../335498/index.html">Cursed Earths - We improve running and experience with teammates</a></li>
<li><a href="../335504/index.html">Getting root access to LG smart TVs on webOS</a></li>
<li><a href="../335506/index.html">‚ÄúOne of the daily processes accelerates from 3 hours to 15 minutes‚Äù: Andrei Bogoslovsky about in-memory computing at SberTech</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>