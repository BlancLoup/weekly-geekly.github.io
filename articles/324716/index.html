<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Splunk. Introduction to machine data analysis - part 2. Enrichment of data from external directories and work with geo-data</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue to tell and show how Splunk works, in particular, to talk about the capabilities of the SPL search query language. 

 In this article, bas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Splunk. Introduction to machine data analysis - part 2. Enrichment of data from external directories and work with geo-data</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/c21/d75/60f/c21d7560f4d5431291b2b10a1d8814e5.jpg"><br><br>  We continue to tell and show how Splunk works, in particular, to talk about the capabilities of the SPL search query language. <br><br>  In this article, based on the <a href="https://yadi.sk/d/OjbNMbSn3GJUYT">test data</a> (web server logs) available for everyone to download, we show: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  How to enrich logs with information from external directories </li><li>  How can you visualize geographic data (data with coordinates) </li><li>  How to group chains of events in a transaction and work with them </li></ul><br>  Under the cat you will find both the examples of search queries themselves and the result of their execution.  You can <a href="http://tssolution.ru/splunk/">download the</a> free version of Splunk, download the <a href="https://yadi.sk/d/OjbNMbSn3GJUYT">test data</a> and repeat everything on your local computer. <br><a name="habracut"></a><br>  On how to install Splunk and download the test data we described in <a href="https://habrahabr.ru/company/tssolution/blog/324136/">previous</a> articles of our blog. <br><br><h2>  Enriching data with information from external directories </h2><br>  Consider the data we have. <br><br><pre><code class="python hljs">sourcetype=access*</code> </pre> <br><img src="https://habrastorage.org/files/7d8/4c6/b4a/7d84c6b4ac86473d8805126ca1bee284.png"><br><br>  These are access log events, which contain information about the actions of site visitors (according to legend, this is the website of the online store of the company that sells computer games).  Therefore, in the logs we have such fields as (the most interesting for processing and requests): <br><br><ul><li>  action - actions of the site visitor </li><li>  clientip - ip-address of the site visitor </li><li>  productId - product code </li><li>  categoryId - product category </li><li>  JSESSIONID - session id session </li></ul><br>  As we already told in the <a href="https://habrahabr.ru/company/tssolution/blog/324136/">previous post</a> , with the help of Splunk we can build various analytics through search queries.  For example, we can calculate how much and what products were bought for a certain time period: <br><br><pre> <code class="python hljs">sourcetype=access* action=purchase | stats count by productId | sort -count</code> </pre> <br><img src="https://habrastorage.org/files/656/3c7/5d0/6563c75d07834388a43e467f9cb5e90f.png"><br><br>  <b>But!</b>  Since in our logs there is no longer any information about the product other than productId, we do not see what kind of product it is, how much it costs, and so on.  Therefore, it would be convenient to load the corresponding fields from the external directory. <br><br>  As a reference, take a <a href="https://yadi.sk/i/a2SXKomg3GHAb8">simple csv</a> file with the information we are interested in about the product name and its price, and load it into Splunk.  I must say that this is the easiest manual method of enrichment.  It is clear that Splunk can take data from relational databases, make requests to the API, and more. <br><br>  After you have downloaded the reference book, you need to upload it to Splunk and mark up the fields.  Detailed instructions <a href="https://docs.splunk.com/Documentation/Splunk/6.5.2/PivotTutorial/AddlookupfilestoSplunk">here</a> .  If you did everything correctly, you should get the following search query results: <br><br><pre> <code class="python hljs">| inputlookup prices_lookup</code> </pre> <br><img src="https://habrastorage.org/files/353/887/a93/353887a93cd04e159dcac284546cbe7c.png"><br><br>  In fact, we simply added a label with a reference book in Splunk, now let's make the system ‚Äúadd‚Äù the values ‚Äã‚Äãof these fields to our events.  It is clear that it will not change the initial events in any way, but simply logically tighten the fields. <br><br>  Go to the tab Settings ‚Üí Lookups ‚Üí Automatic lookups ‚Üí New <br><br>  <b>Name:</b> - any name <br>  <b>Lookup table:</b> prices_lookup (or how you set up your table) <br>  <b>Sourcetype:</b> access_combined_wcookie <br>  <b>Lookup input fields:</b> productId = productId <br>  <b>Lookup output fields:</b> price = price, product_name = product_name, sale_price = sale_price <br><br><img src="https://habrastorage.org/files/e20/dbc/1c7/e20dbc1c7817408b87624f594ece0187.png"><br><br>  After that, we save everything and change <i>Permissions</i> to <i>All Apps</i> and <i>Read / Write everyone</i> as the previous instructions. <br><br>  If everything is done correctly, then when searching for this sourcetype, the fields we added must be accessible (in order to display them at the bottom of each event, go to the <i>All fields</i> tab and select them as <i>Interesting fields</i> ).  Note that the events themselves do not have this information, as they have not changed. <br><br><pre> <code class="python hljs">sourcetype=<span class="hljs-string"><span class="hljs-string">"access_combined_wcookie"</span></span> product_name=<span class="hljs-string"><span class="hljs-string">"*"</span></span></code> </pre> <br><img src="https://habrastorage.org/files/a14/504/f69/a14504f69c6d4121ae2cd03f87165822.png"><br><br>  Now the results of our queries may be much more interesting.  For example, we can calculate the same analytics only with reference to money and financial results. <br><br><pre> <code class="python hljs">sourcetype=<span class="hljs-string"><span class="hljs-string">"access_combined_wcookie"</span></span> action=purchase | eval profit=price-sale_price | stats values(productId) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">" "</span></span>, values(sale_price) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">" "</span></span>, values(price) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">" "</span></span>, count <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>, sum(profit) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>, by product_name | sort -<span class="hljs-string"><span class="hljs-string">""</span></span> | rename product_name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre> <br><img src="https://habrastorage.org/files/802/6d9/f93/8026d9f93abc40b38bebdbe370b77bdf.png"><br><br>  It is clear that this example is more about the BI story.  However, this example of connecting reference books is replicated in other subject areas.  For example, if we talk about information security, we can load information from the vulnerability databases using the CVE code. <br><br>  And yes, I completely forgot!  For easy reference editing, Splunk has a special <a href="https://splunkbase.splunk.com/app/1724/">Lookup Editor</a> application that you can download for free from SplunkBase. <br><br><h2>  Visualization of data with geographic coordinates </h2><br>  Sometimes it is very useful to put the results of analytical queries on a geographic map.  Here the situation is divided into 2 cases: the first is when there are already fields in the data such as latitude and longitude (thanks to them we can put something on the map), the second is when there are no these fields.  In our example, that is, in our data, just the second case (we have a lot of online store visitors from different places, but we don‚Äôt have data on their latitude and longitude, but we have their ip-address).  Splunk has built-in functionality for determining latitude and longitude (as well as a city, country and region) based on ip-address, <a href="https://docs.splunk.com/Documentation/Splunk/6.5.2/SearchReference/Iplocation">iplocation</a> command. <br><br><pre> <code class="python hljs">sourcetype=<span class="hljs-string"><span class="hljs-string">"access_combined_wcookie"</span></span> | iplocation clientip</code> </pre> <br>  As a result of this request, you should see fields with latitude, longitude, the name of the city, country and region. <br><br><img src="https://habrastorage.org/files/c98/a32/e0b/c98a32e0b61a4c3abdd489c9057bde4c.png"><br><br>  Now we build some analytical query and plot it on the map.  For example, let's calculate the profit for each product and see where it was bought.  For this we use the built-in function <a href="https://docs.splunk.com/Documentation/Splunk/6.5.2/SearchReference/Geostats">geostats</a> . <br><br><pre> <code class="python hljs">sourcetype=<span class="hljs-string"><span class="hljs-string">"access_combined_wcookie"</span></span> action=purchase | iplocation clientip | eval profit=price-sale_price | geostats sum(profit) by product_name</code> </pre> <br><img src="https://habrastorage.org/files/7a2/b34/8db/7a2b348dbcc6419f847bb1ed4f91a9fa.png"><br><br>  We can also use another option of visualization and see the profitability in the context of countries, for this the <a href="http://docs.splunk.com/Documentation/Splunk/6.5.2/SearchReference/Geom">geom</a> command is used. <br><br><pre> <code class="python hljs">sourcetype=<span class="hljs-string"><span class="hljs-string">"access_combined_wcookie"</span></span> action=purchase | iplocation clientip | eval profit=price-sale_price | stats sum(profit) by Country | geom geo_countries featureIdField=Country</code> </pre> <br><img src="https://habrastorage.org/files/f68/c48/0a4/f68c480a4cc4414cadcacfc7a1f7a7c8.png"><br><br>  By default, there is mapping by country and state of the USA, but you can always make your own, based on latitude and longitude and add it to Splunk.  For example, it can be regions of Rosii, or urban districts. <br><br><h2>  Transactions or grouping of chains of events in time </h2><br>  In the case when we have a consistent chain of events, for example, the process of sending e-mail, some kind of financial transaction, or, as is the case with our data - visiting a web site, it may be necessary to combine these events into a transaction.  That is, from the group of individual events of events, it is obvious to separate the chain, grouping them by a specific attribute. <br><br>  In our case, this JSESSIONID field is a unique user session number.  For grouping use the <a href="https://docs.splunk.com/Documentation/Splunk/6.5.2/SearchReference/Transaction">transaction</a> command. <br><br><pre> <code class="python hljs">sourcetype=<span class="hljs-string"><span class="hljs-string">"access_combined_wcookie"</span></span> | transaction JSESSIONID endswith=<span class="hljs-string"><span class="hljs-string">"purchase"</span></span></code> </pre> <br><img src="https://habrastorage.org/files/a4b/848/441/a4b848441739490a8f6c56417a43df9a.png"><br><br>  After that we get grouped events, as well as new fields: the duration of the transaction, and the number of grouped events. <br><br>  Now you can calculate, for example, statistics on the duration of the sessions, that is, the time during which visitors decided to make a purchase. <br><br><pre> <code class="python hljs">sourcetype=<span class="hljs-string"><span class="hljs-string">"access_combined_wcookie"</span></span> | transaction JSESSIONID endswith=<span class="hljs-string"><span class="hljs-string">"purchase"</span></span> | search duration&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> | stats min(duration), max(duration), avg(duration)</code> </pre> <br><img src="https://habrastorage.org/files/af6/adc/847/af6adc847a244d6fa02999209e4d76bf.png"><br><br>  You can also count the number of competitive sessions in each period of time, for this there is a <a href="https://docs.splunk.com/Documentation/Splunk/latest/SearchReference/Concurrency">concurrency</a> team. <br><br><pre> <code class="python hljs">sourcetype=<span class="hljs-string"><span class="hljs-string">"access_combined_wcookie"</span></span> | transaction JSESSIONID | concurrency duration=duration</code> </pre> <br><img src="https://habrastorage.org/files/f3b/7ae/257/f3b7ae2578864be8b3a9f7603bcc8896.png"><br><br>  As a result, a new <i>concurrency</i> field is created, which considers competitive sessions, but, unfortunately, due to the fact that we have only one competitive session at a time, we have only one competitive session, so this example is not very effective. <br><br><h2>  Conclusion </h2><br>  Of course, the examples are very simple, but I hope, representative. <br><br>  This concludes this article! <br><br>  Write your questions if something doesn‚Äôt work or it didn‚Äôt work =) <br><br>  Once again, links to download <a href="https://yadi.sk/d/OjbNMbSn3GJUYT">data</a> and <a href="https://yadi.sk/i/a2SXKomg3GHAb8">reference c prices</a> . <br><br><h2>  PS </h2><br>  <b>On June 28, 2018,</b> ‚Äú <a href="http://tssolution.tilda.ws/study-splunk">Splunk Getting Started</a> ‚Äù will be taught <b>in Moscow</b> , where in 6 hours the participants will receive a theoretical base and practical skills for working in Splunk.  Learn more about learning and register at this <a href="http://tssolution.tilda.ws/study-splunk">link</a> . </div><p>Source: <a href="https://habr.com/ru/post/324716/">https://habr.com/ru/post/324716/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324704/index.html">Bug of the month: relay race from PC-Lint to PVS-Studio</a></li>
<li><a href="../324706/index.html">Updated Yii2 plugin for PhpStorm</a></li>
<li><a href="../324708/index.html">Need an energy efficient data center? Then you should build it under water.</a></li>
<li><a href="../324710/index.html">Elements, universes and registers of rules</a></li>
<li><a href="../324714/index.html">Nearly dismissed under article ... on Habr√©</a></li>
<li><a href="../324718/index.html">Windows hook: just about complicated</a></li>
<li><a href="../324720/index.html">Ensure the availability of user data in Microsoft Dynamics CRM using Veeam Backup & Replication</a></li>
<li><a href="../324722/index.html">God mode VKontakte</a></li>
<li><a href="../324724/index.html">How to assemble an icon font from a sketch file</a></li>
<li><a href="../324728/index.html">Shader fur on webgl 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>