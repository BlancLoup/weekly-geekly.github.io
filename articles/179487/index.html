<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Protection of Android applications from hacking</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we will briefly describe how you can protect your program from hacking without integrating a standard solution from Google and provid...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Protection of Android applications from hacking</h1><div class="post__text post__text-html js-mediator-article">  In this article, we will briefly describe how you can protect your program from hacking without integrating a standard solution from Google and provide an example of a working code.  Interesting?  We ask under the cut! <br><br><a name="habracut"></a><br><br><h4>  What is the weakness of Google Application Licensing? </h4>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The fact is that this mechanism is well known to developers and its hacking is not difficult.  All you need is to download apktool, find the class LicenseChecker and slightly correct the checkAccess method. <br><br><h4>  How to implement your own protection? </h4><br><br>  Obviously, any protection can be broken.  This method is not a silver bullet, but it has the right to life.  To verify the uniqueness of the application, it makes sense to check the certificate with which this application was signed.  Information about the certificate can be read from PackageInfo: <br><br><pre><code class="java hljs">PackageInfo info =getPackageManager().getPackageInfo(getPackageName(), <span class="hljs-number"><span class="hljs-number">0</span></span>); Signature[] signatures = info.signatures;</code> </pre> <br><br>  The zero element of the array will contain the necessary information about the key with which the application was signed.  Save the key itself, you will need it very soon. <br>  It is logical that doing such a check in Java does not make sense, since a similar technique using apktool will bury your protection in a few minutes.  Therefore, this test should be moved to the netiv level. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* rsa = <span class="hljs-string"><span class="hljs-string">"PUT_YOUR_RSA_KEY_HERE"</span></span>; <span class="hljs-function"><span class="hljs-function">jint </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">verifyCertificate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv *env, jobject obj, jobject cnt)</span></span></span><span class="hljs-function"> </span></span>{ jclass cls = env-&gt;GetObjectClass(cnt); jmethodID mid = env-&gt;GetMethodID(cls, <span class="hljs-string"><span class="hljs-string">"getPackageManager"</span></span>, <span class="hljs-string"><span class="hljs-string">"()Landroid/content/pm/PackageManager;"</span></span>); jmethodID pnid = env-&gt;GetMethodID(cls, <span class="hljs-string"><span class="hljs-string">"getPackageName"</span></span>, <span class="hljs-string"><span class="hljs-string">"()Ljava/lang/String;"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mid == <span class="hljs-number"><span class="hljs-number">0</span></span> || pnid == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ERROR; } jobject pacMan_o = env-&gt;CallObjectMethod(cnt, mid); jclass pacMan = env-&gt;GetObjectClass(pacMan_o); jstring packName = (jstring) env-&gt;CallObjectMethod(cnt, pnid); <span class="hljs-comment"><span class="hljs-comment">/*flags = PackageManager.GET_SIGNATURES*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> flags = <span class="hljs-number"><span class="hljs-number">0x40</span></span>; mid = env-&gt;GetMethodID(pacMan, <span class="hljs-string"><span class="hljs-string">"getPackageInfo"</span></span>, <span class="hljs-string"><span class="hljs-string">"(Ljava/lang/String;I)Landroid/content/pm/PackageInfo;"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mid == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ERROR; } jobject pack_inf_o = (jobject) env-&gt;CallObjectMethod(pacMan_o, mid, packName, flags); jclass packinf = env-&gt;GetObjectClass(pack_inf_o); jfieldID fid; fid = env-&gt;GetFieldID(packinf, <span class="hljs-string"><span class="hljs-string">"signatures"</span></span>, <span class="hljs-string"><span class="hljs-string">"[Landroid/content/pm/Signature;"</span></span>); jobjectArray signatures = (jobjectArray) env-&gt;GetObjectField(pack_inf_o, fid); jobject signature0 = env-&gt;GetObjectArrayElement(signatures, <span class="hljs-number"><span class="hljs-number">0</span></span>); mid = env-&gt;GetMethodID(env-&gt;GetObjectClass(signature0), <span class="hljs-string"><span class="hljs-string">"toByteArray"</span></span>, <span class="hljs-string"><span class="hljs-string">"()[B"</span></span>); jbyteArray cert = (jbyteArray) env-&gt;CallObjectMethod(signature0, mid); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cert == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ERROR; } jclass BAIS = env-&gt;FindClass(<span class="hljs-string"><span class="hljs-string">"java/io/ByteArrayInputStream"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (BAIS == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ERROR; } mid = env-&gt;GetMethodID(BAIS, <span class="hljs-string"><span class="hljs-string">"&lt;init&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"([B)V"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mid == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ERROR; } jobject input = env-&gt;NewObject(BAIS, mid, cert); jclass CF = env-&gt;FindClass(<span class="hljs-string"><span class="hljs-string">"java/security/cert/CertificateFactory"</span></span>); mid = env-&gt;GetStaticMethodID(CF, <span class="hljs-string"><span class="hljs-string">"getInstance"</span></span>, <span class="hljs-string"><span class="hljs-string">"(Ljava/lang/String;)Ljava/security/cert/CertificateFactory;"</span></span>); jstring X509 = env-&gt;NewStringUTF(<span class="hljs-string"><span class="hljs-string">"X509"</span></span>); jobject cf = env-&gt;CallStaticObjectMethod(CF, mid, X509); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cf == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ERROR; } <span class="hljs-comment"><span class="hljs-comment">//"java/security/cert/X509Certificate" mid = env-&gt;GetMethodID(CF, "generateCertificate", "(Ljava/io/InputStream;)Ljava/security/cert/Certificate;"); if (mid == 0) { return ERROR; } jobject c = env-&gt;CallObjectMethod(cf, mid, input); if (c == 0) { return ERROR; } jclass X509Cert = env-&gt;FindClass("java/security/cert/X509Certificate"); mid = env-&gt;GetMethodID(X509Cert, "getPublicKey", "()Ljava/security/PublicKey;"); jobject pk = env-&gt;CallObjectMethod(c, mid); if (pk == 0) { return ERROR; } mid = env-&gt;GetMethodID(env-&gt;GetObjectClass(pk), "toString", "()Ljava/lang/String;"); if (mid == 0) { return ERROR; } jstring all = (jstring) env-&gt;CallObjectMethod(pk, mid); const char * all_char = env-&gt;GetStringUTFChars(all, NULL); char * out = NULL; if (all_char != NULL) { char * startString = strstr(all_char, "modulus:"); char * end = strstr(all_char, "public exponent"); bool isJB = false; if (startString == NULL) { //4.1.x startString = strstr(all_char, "modulus="); end = strstr(all_char, ",publicExponent"); isJB = true; } if (startString != NULL &amp;&amp; end != NULL) { int len; if (isJB) { startString += strlen("modulus="); len = end - startString; } else { startString += strlen("modulus:"); len = end - startString - 5; /* -5 for new lines*/ } out = new char[len + 2]; strncpy(out, startString, len); out[len] = '\0'; } } env-&gt;ReleaseStringUTFChars(all, all_char); char * is_found = strstr(out, rsa); //      if (IS_DEBUG) { return is_found != NULL ? 0 : 1; } else { return is_found != NULL ? 1 :0; } }</span></span></code> </pre><br><br><h4>  What to do next? </h4><br><br>  It is necessary to move some of its functionality to the same library and before returning the value to check the certificate for authenticity.  And do not forget about the fantasy that is needed in order to confuse a potential hacker.  Suppose you determine that this copy of the application is not genuine.  It makes no sense to clearly talk about it, it‚Äôs much more fun to add a random element to the program‚Äôs actions.  For example, if you have a game, you can add strength to your opponents or make the player more vulnerable.  You can also add random drops, for example, in 10% of cases (a fair comment from the habrauser <a href="http://habrahabr.ru/users/zagayevskiy/" class="user_link">zagayevskiy</a> : random drops will ruin the karma of your program.).  It all depends on you. <br><br>  Here is a simple example of a possible implementation: <br><br>  First, we write a class that makes a library call to get some data. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YourClass</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> { System.loadLibrary(<span class="hljs-string"><span class="hljs-string">"name_of_library"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSomeValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context ctx)</span></span></span></span>; }</code> </pre><br><br>  The init method is needed in order not to trigger certificate authentication every time. <br><br>  Implementing nouveau methods: <br><br><pre> <code class="cpp hljs">jint isCertCorrect = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-function">JNIEXPORT </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> JNICALL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_com_your_package_YourClass_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv *env, jobject obj, jobject ctx)</span></span></span><span class="hljs-function"> </span></span>{ isCertCorrect = verifyCertificate(env, obj, ctx); } <span class="hljs-function"><span class="hljs-function">JNIEXPORT jint JNICALL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_com_your_package_YourClass_getSomeValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv *env, jobject obj)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isCertCorrect ) { <span class="hljs-comment"><span class="hljs-comment">//    } else { //    }</span></span></code> </pre><br><br>  This protection option can also be hacked by disassembling, but this requires a completely different level of knowledge and much more time than in the case of the implementation of protection at the Java level.  In the presence of certain means, I washed the purchase of an obfuscator for the C code, in which case hacking would be a far from trivial task. <br><br><h4>  Protection of the application in the presence of the server side. </h4><br><br>  If part of the application logic is implemented on the server, it makes sense to put the certificate authentication on the server.  Alternatively, you can use the following algorithm: <br><br><ol><li>  The server generates private and public RSA keys; </li><li>  The client sends a request to the server and receives the public key; </li><li>  On the client, we implement a native library with a function of the form String getInfo (String publicKey);  the function must read the certificate, add some random value to it, then encrypt the resulting string using the public RSA key; <br></li><li>  The client makes a new request to the server, sending the resulting string.  The server performs decoding, separating the certificate from a random variable and checking it for authenticity; </li><li>  Depending on the results of the verification, the server responds to all of the following client requests. </li></ol><br><br>  We hope this mechanism will help Habr's readers to increase earnings from their Android applications. </div><p>Source: <a href="https://habr.com/ru/post/179487/">https://habr.com/ru/post/179487/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../179471/index.html">How we did the right production</a></li>
<li><a href="../179473/index.html">Forms in Angularjs. How I found love</a></li>
<li><a href="../179475/index.html">Privileged Account Management</a></li>
<li><a href="../179481/index.html">Moving to MySQL 5.6, is it worth it?</a></li>
<li><a href="../179483/index.html">Laser weapons destroy a rocket at a distance of 1.5 km (video)</a></li>
<li><a href="../179489/index.html">On the other side of a like: our Facebook people</a></li>
<li><a href="../179493/index.html">Money received using the Diablo 3 bug will go to charity</a></li>
<li><a href="../179495/index.html">Three professional deformation IT specialists</a></li>
<li><a href="../179497/index.html">Build target platform. Equinox for developer</a></li>
<li><a href="../179499/index.html">How stable is your job and what's in that backpack?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>