<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ruby Web Parsing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is a translation of the article ‚ÄúWeb Scraping with Ruby‚Äù , which I found useful when learning the Ruby programming language. Parsing interests me...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ruby Web Parsing</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/c44/b48/f18/c44b48f1806b45152f5fda5ad46c2af4.jpg" alt="image"><br>  <i>This is a translation of the article <a href="https://www.chrismytton.uk/2015/01/19/web-scraping-with-ruby/">‚ÄúWeb Scraping with Ruby‚Äù</a> , which I found useful when learning the Ruby programming language.</i>  <i>Parsing interests me for personal reasons.</i>  <i>It seems to me that this is not only a useful skill, but also a good way to learn a language.</i> <br><a name="habracut"></a><br>  Ruby Web Parsing is easier than you might think.  Let's start with a simple example: I want to get a beautifully formatted JSON array of objects representing a list of movies from a <a href="http://www.cubecinema.com/programme">local independent cinema</a> site. <br><br>  In the beginning, we need a way to download an html page that contains all the movie ads.  Ruby has a built-in http client, <code>Net::HTTP</code> , and an add-on above it - <code>open-uri</code> . <br><br><div class="spoiler">  <b class="spoiler_title">Open-uri</b> <div class="spoiler_text">  Open-uri is good for basic things, like the ones we do in the lesson, but it has some <a href="https://bugs.ruby-lang.org/issues/3719">problems</a> , so you may want to find another http client for the production environment. <br></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, the first thing to do is download html from a remote server. <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'open-uri'</span></span> url = <span class="hljs-string"><span class="hljs-string">'http://www.cubecinema.com/programme'</span></span> html = open(url)</code> </pre><br>  Great, now we have a page that we want to parse, now we need to get some information out of it.  The best tool for this is <a href="http://www.nokogiri.org/">Nokogiri</a> .  We are creating a new instance of Nokogiri for our html, which we have just downloaded. <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'nokogiri'</span></span> doc = Nokogiri::HTML(html)</code> </pre><br>  Nokogiri is cool because it allows you to access html using CSS selectors, which, in my opinion, is much more convenient than using xpath. <br><br>  Ok, now we have a document from which we can pull a list of movies.  Each element of the list has the following html structure, as shown below. <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"showing"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"event_7557"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/programme/event/live-stand-up-monty-python-and-the-holy-grail,7557/"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">alt</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Picture for event Live stand up + Monty Python and the Holy Grail"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tags"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/programme/view/comedy/"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tag_comedy"</span></span></span><span class="hljs-tag">&gt;</span></span>comedy<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/programme/view/dvd/"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tag_dvd"</span></span></span><span class="hljs-tag">&gt;</span></span>dvd<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/programme/view/film/"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tag_film"</span></span></span><span class="hljs-tag">&gt;</span></span>film<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/programme/event/live-stand-up-monty-python-and-the-holy-grail,7557/"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pre_title"</span></span></span><span class="hljs-tag">&gt;</span></span>Comedy Combo presents<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> Live stand up + Monty Python and the Holy Grail <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"post_title"</span></span></span><span class="hljs-tag">&gt;</span></span>Rare screening from 35mm!<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"event_details"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"start_and_pricing"</span></span></span><span class="hljs-tag">&gt;</span></span> Sat 20 December | 19:30 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"copy"</span></span></span><span class="hljs-tag">&gt;</span></span>Brave (and not so brave) Knights of the Round Table! Gain shelter from the vicious chicken of Bristol as we gather to bear witness to this 100% factually accurate retelling ... [<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"more"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/programme/event/live-stand-up-monty-python-and-the-holy-grail,7557/"</span></span></span><span class="hljs-tag">&gt;</span></span>more...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span>]<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><h1>  <font color="#cc0000">Html processing</font> </h1><br>  Each movie has a css class <code>.showing</code> , so that we can select all the shows and process them in turn. <br><br><pre> <code class="ruby hljs">showings = [] doc.css(<span class="hljs-string"><span class="hljs-string">'.showing'</span></span>).each <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|showing|</span></span> showing_id = showing[<span class="hljs-string"><span class="hljs-string">'id'</span></span>].split(<span class="hljs-string"><span class="hljs-string">'_'</span></span>).last.to_i tags = showing.css(<span class="hljs-string"><span class="hljs-string">'.tags a'</span></span>).map { <span class="hljs-params"><span class="hljs-params">|tag|</span></span> tag.text.strip } title_el = showing.at_css(<span class="hljs-string"><span class="hljs-string">'h1 a'</span></span>) title_el.children.each { <span class="hljs-params"><span class="hljs-params">|c|</span></span> c.remove <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> c.name == <span class="hljs-string"><span class="hljs-string">'span'</span></span> } title = title_el.text.strip dates = showing.at_css(<span class="hljs-string"><span class="hljs-string">'.start_and_pricing'</span></span>).inner_html.strip dates = dates.split(<span class="hljs-string"><span class="hljs-string">'&lt;br&gt;'</span></span>).map(&amp;<span class="hljs-symbol"><span class="hljs-symbol">:strip</span></span>).map { <span class="hljs-params"><span class="hljs-params">|d|</span></span> DateTime.parse(d) } description = showing.at_css(<span class="hljs-string"><span class="hljs-string">'.copy'</span></span>).text.gsub(<span class="hljs-string"><span class="hljs-string">'[more...]'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>).strip showings.push( <span class="hljs-symbol"><span class="hljs-symbol">id:</span></span> showing_id, <span class="hljs-symbol"><span class="hljs-symbol">title:</span></span> title, <span class="hljs-symbol"><span class="hljs-symbol">tags:</span></span> tags, <span class="hljs-symbol"><span class="hljs-symbol">dates:</span></span> dates, <span class="hljs-symbol"><span class="hljs-symbol">description:</span></span> description ) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Let's take a look at the code presented above. <br><br><pre> <code class="ruby hljs">showing_id = showing[<span class="hljs-string"><span class="hljs-string">'id'</span></span>].split(<span class="hljs-string"><span class="hljs-string">'_'</span></span>).last.to_i</code> </pre><br>  In the beginning, we take a unique id id, which is kindly set as an attribute of the html identifier in the markup.  Using square brackets, we can access the attributes of the elements.  Thus, in the case of the html presented above, <code>showing['id']</code> should be "event_7557".  We are interested only in a numeric identifier, so we divide the result using the underscore <code>.split('_')</code> and then take the last element from the resulting array and convert it to the integer format <code>.last.to_i</code> . <br><br><pre> <code class="ruby hljs">tags = showing.css(<span class="hljs-string"><span class="hljs-string">'.tags a'</span></span>).map { <span class="hljs-params"><span class="hljs-params">|tag|</span></span> tag.text.strip }</code> </pre><br>  Here we find all the tags for a movie using the <code>.css</code> method, which returns an array of matching elements.  Then we map (use the map method) elements, take the text from them and remove spaces in it.  For our html, the result will be <code>["comedy", "dvd", "film"]</code> . <br><br><pre> <code class="ruby hljs">title_el = showing.at_css(<span class="hljs-string"><span class="hljs-string">'h1 a'</span></span>) title_el.children.each { <span class="hljs-params"><span class="hljs-params">|c|</span></span> c.remove <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> c.name == <span class="hljs-string"><span class="hljs-string">'span'</span></span> } title = title_el.text.strip</code> </pre><br>  The code for getting the title is a bit more complicated, because this element in html contains some additional span elements with prefixes and suffixes.  We take the header using <code>.at_css</code> , which returns one matching element.  Then we iterate over each descendant of the header and delete the extra spans.  At the end, when the span is removed, we get the header text and clean it from extra spaces. <br><br><pre> <code class="ruby hljs">dates = showing.at_css(<span class="hljs-string"><span class="hljs-string">'.start_and_pricing'</span></span>).inner_html.strip dates = dates.split(<span class="hljs-string"><span class="hljs-string">'&lt;br&gt;'</span></span>).map(&amp;<span class="hljs-symbol"><span class="hljs-symbol">:strip</span></span>).map { <span class="hljs-params"><span class="hljs-params">|d|</span></span> DateTime.parse(d) }</code> </pre><br>  Next, the code for the date and time of the show.  It is a little more complicated here, because films can show several days and, sometimes, the price can be in the same element.  We map the dates that we find using <code>DateTime.parse</code> and as a result we get an array of Ruby objects - <code>DateTime</code> . <br><br><pre> <code class="ruby hljs">description = showing.at_css(<span class="hljs-string"><span class="hljs-string">'.copy'</span></span>).text.gsub(<span class="hljs-string"><span class="hljs-string">'[more...]'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>).strip</code> </pre><br>  Getting the description is a fairly simple process, the only thing that needs to be done is to remove the text <code>[more...]</code> using <code>.gsub</code> <br><br><pre> <code class="ruby hljs">showings.push( <span class="hljs-symbol"><span class="hljs-symbol">id:</span></span> showing_id, <span class="hljs-symbol"><span class="hljs-symbol">title:</span></span> title, <span class="hljs-symbol"><span class="hljs-symbol">tags:</span></span> tags, <span class="hljs-symbol"><span class="hljs-symbol">dates:</span></span> dates, <span class="hljs-symbol"><span class="hljs-symbol">description:</span></span> description )</code> </pre><br>  Now, having all the necessary parts in the variables, we can write them into our hash (hash), created to display all the films. <br><br><h1>  <font color="#cc0000">Json output</font> </h1><br>  Now that every movie is taken from us and we have their array, we can convert the result into JSON format. <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'json'</span></span> puts JSON.pretty_generate(showings)</code> </pre><br>  This code displays an array of showings recoded in JSON format, when running the script, the output can be redirected to a file or another program for further processing. <br><br><h1>  <font color="#cc0000">Putting it all together</font> </h1><br>  Having collected all the parts in one place, we get the full version of our script: <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'open-uri'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'nokogiri'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'json'</span></span> url = <span class="hljs-string"><span class="hljs-string">'http://www.cubecinema.com/programme'</span></span> html = open(url) doc = Nokogiri::HTML(html) showings = [] doc.css(<span class="hljs-string"><span class="hljs-string">'.showing'</span></span>).each <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|showing|</span></span> showing_id = showing[<span class="hljs-string"><span class="hljs-string">'id'</span></span>].split(<span class="hljs-string"><span class="hljs-string">'_'</span></span>).last.to_i tags = showing.css(<span class="hljs-string"><span class="hljs-string">'.tags a'</span></span>).map { <span class="hljs-params"><span class="hljs-params">|tag|</span></span> tag.text.strip } title_el = showing.at_css(<span class="hljs-string"><span class="hljs-string">'h1 a'</span></span>) title_el.children.each { <span class="hljs-params"><span class="hljs-params">|c|</span></span> c.remove <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> c.name == <span class="hljs-string"><span class="hljs-string">'span'</span></span> } title = title_el.text.strip dates = showing.at_css(<span class="hljs-string"><span class="hljs-string">'.start_and_pricing'</span></span>).inner_html.strip dates = dates.split(<span class="hljs-string"><span class="hljs-string">'&lt;br&gt;'</span></span>).map(&amp;<span class="hljs-symbol"><span class="hljs-symbol">:strip</span></span>).map { <span class="hljs-params"><span class="hljs-params">|d|</span></span> DateTime.parse(d) } description = showing.at_css(<span class="hljs-string"><span class="hljs-string">'.copy'</span></span>).text.gsub(<span class="hljs-string"><span class="hljs-string">'[more...]'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>).strip showings.push( <span class="hljs-symbol"><span class="hljs-symbol">id:</span></span> showing_id, <span class="hljs-symbol"><span class="hljs-symbol">title:</span></span> title, <span class="hljs-symbol"><span class="hljs-symbol">tags:</span></span> tags, <span class="hljs-symbol"><span class="hljs-symbol">dates:</span></span> dates, <span class="hljs-symbol"><span class="hljs-symbol">description:</span></span> description ) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> puts JSON.pretty_generate(showings)</code> </pre><br>  If you save it to a file, for example, <code>scraper.rb</code> and run <code>ruby scraper.rb</code> , then you should see the output in JSON format.  It should be similar to what is presented below. <br><br><pre> <code class="hljs json">[ { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">7686</span></span>, <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Harry Dean Stanton - Partly Fiction"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tags"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"dcp"</span></span>, <span class="hljs-string"><span class="hljs-string">"film"</span></span>, <span class="hljs-string"><span class="hljs-string">"ttt"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"dates"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"2015-01-19T20:00:00+00:00"</span></span>, <span class="hljs-string"><span class="hljs-string">"2015-01-20T20:00:00+00:00"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"A mesmerizing, impressionistic portrait of the iconic actor in his intimate moments, with film clips from some of his 250 films and his own heart-breaking renditions of American folk songs. ..."</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">7519</span></span>, <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Bang the Bore Audiovisual Spectacle: VA AA LR + Stephen Cornford + Seth Cooke"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tags"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"music"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"dates"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"2015-01-21T20:00:00+00:00"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"An evening of hacked TVs, 4 screen cinematic drone and electroacoustics. VAAALR: Vasco Alves, Adam Asnan and Louie Rice create spectacles using distress flares, C02 and junk electronics. Stephen Cornford: ..."</span></span> } ]</code> </pre><br>  Everything.  And this is just a basic example of parsing.  It is more difficult to parse a site that requires you to log in at the beginning.  For such cases, I recommend looking in the direction of <a href="http://docs.seattlerb.org/mechanize/GUIDE_rdoc.html">mechanize</a> , which works on Nokogiri. <br><br>  I hope this introduction to parsing will give you ideas about the data you want to see in a more structured format using the methods described above. <br><br>  I also plan to translate <a href="https://www.chrismytton.uk/2015/01/22/advanced-web-scraping-with-mechanize/">another article on the topic of parsing</a> from the same author. <br><br>  All articles in the series: <br><ul><li>  Ruby Web Parsing </li><li>  <a href="http://habrahabr.ru/post/253439/">Advanced website parsing with Mechanize</a> </li><li>  <a href="http://habrahabr.ru/post/262991/">Using morph.io for web parsing</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/252379/">https://habr.com/ru/post/252379/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252365/index.html">How did we get $ 30k from Google RISE, how to continue teaching children to program and how to become a partner in our team?</a></li>
<li><a href="../252367/index.html">All you need to know about game constructors. 3 indie developers share their experience at Gamemaker, Construct 2, Clickteam fusion 2.5</a></li>
<li><a href="../252369/index.html">Installing RSAT for Windows 10 TP</a></li>
<li><a href="../252371/index.html">Rake, .NET, COM and dynamic</a></li>
<li><a href="../252375/index.html">Habraeffect for 130,000 cameras Moscow</a></li>
<li><a href="../252381/index.html">Thermometer on Raspberry pi with wireless sensor on rf 433 and MK attiny85</a></li>
<li><a href="../252387/index.html">10 tips on working in Sketch</a></li>
<li><a href="../252389/index.html">Some subtleties of working with Github and NPM - with taste of ES6</a></li>
<li><a href="../252391/index.html">What is wrong with changing * _defconfig when working with Linux kernel sources</a></li>
<li><a href="../252393/index.html">The nuances of commercial development on WordPress</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>