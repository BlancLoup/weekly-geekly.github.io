<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Working with multiple databases in Ruby on Rails 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. I am a beginner (relatively) Ruby on Rails developer. Currently I am developing an application that uses several databases. Information on this...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Working with multiple databases in Ruby on Rails 3</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/801/936/a7a/801936a7a7ea0e0692a84046ce44bc15.jpg" align="left">  Hello.  I am a beginner (relatively) Ruby on Rails developer.  Currently I am developing an application that uses several databases.  Information on this issue on the Internet is not as much as we would like, so I decided to put it all together and share it with the media community. <br>  Again, I consider myself a newcomer to the rails, so this is not an article on how to do it right.  This is just a collection of notes about what and how I did it. <br><a name="habracut"></a><br>  I have a rather specific task, but the code is not so much and it is not difficult to remake it to fit my needs. <br><br><h4>  Task </h4><br>  It is necessary to make a certain CRM for companies selling certain goods.  Companies work with several brands at once, and each brand needs its own CRM with a separate database.  In my implementation, the company is determined by the subdomain, and the brand from the URL, for example, the URL company1.myapp.dev/brand1/ tells us that we work with the company1 company and the brand1 brand. <br><br><h4>  It all starts with models </h4><br>  In this case, it was logical to distinguish 2 models: Company and Brand. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Company </h5><br><ul><li>  db_user: string - Username for connecting to the DBMS </li><li>  db_password: string - Password </li><li>  db_host: string - Database Server Address </li><li>  db_port: integer - DBMS server port </li><li>  subdomain: string - the name of the subdomain for the company </li><li>  alias: string - Alternate address (for example, the company will want to link the CRM to its website crm.company1.dev) </li><li>  active: boolean - To quickly disable access to CRM </li><li>  name: string - Company name </li></ul><br><h5>  Brand </h5><br><ul><li>  name: string - Brand name </li><li>  db_name: string - database name </li><li>  company_id: integer - Link to company </li></ul><br><br>  <b>Note:</b> most often the database needs to be switched only by domain, so the Brand model can be removed and the db_name field transferred to the Company model.  If you plan to use only the DBMS on the local server, then you can completely remove the db_user, db_host, etc. fields.  I plan to sometime go to cloud services and it can come in handy. <br><br>  The tables for these models should be in each database with which the application will work, but the data will be stored only in one (production or development, depending on your RAILS_ENV).  In order for the application to search for data only in a specific database, you need to use the <a href="http://api.rubyonrails.org/classes/ActiveRecord/Base.html">establish_connection</a> method. <br><br><h6>  /models/company.rb </h6><br><pre><code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Company</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">establish_connection</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">production</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">brands</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dependent</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">destroy</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validates</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subdomain</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db_user</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db_host</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db_port</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">presence</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><br><h6>  /models/brand.rb </h6><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Brand</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">establish_connection</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">production</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">belongs_to</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">company</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validates</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db_name</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">presence</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><br><h4>  Write the code </h4><br><h5>  routes.rb </h5><br>  Since we always need to know which brand we are working with now, we need to wrap everything in scope. <br><pre> <code class="ruby hljs">MyApp::Application.routes.draw <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> scope <span class="hljs-string"><span class="hljs-string">':brand'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> resource <span class="hljs-symbol"><span class="hljs-symbol">:sessions</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">only:</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:new</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:create</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:destroy</span></span>] <span class="hljs-comment"><span class="hljs-comment">#  .. match '/' =&gt; redirect("/%{brand}/orders"), as: 'brand_root' end root :to =&gt; "main#index" end</span></span></code> </pre><br><h5>  application.rb </h5><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationController</span></span></span><span class="hljs-class"> &lt; ActionController::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">protect_from_forgery</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">before_filter</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">override_db</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">before_filter</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">authenticate_user!</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">not_found</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">raise</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ActionController::RoutingError</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Not</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Found</span></span></span><span class="hljs-class">') </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#    scope,     #     ,    #      # Ex:  orders_path(brand: </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@current</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_brand.name)    orders_path def url_options if </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@current</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_brand.present? { :brand =&gt; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@current</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_brand.name }.merge(super) else super end end private #     def override_db </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@current</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_company = Company.where("(subdomain = ? or alias = ?) AND active = ?", request.env['HTTP_HOST'][/^[\w\-]+/], request.env['HTTP_HOST'], true).first not_found unless </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@current</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_company.present? &amp;&amp; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@current</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_company.brands.present? if params[:brand].present? </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@current</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_brand = </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@current</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_company.brands.find_by_name params[:brand] if </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@current</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_brand.present? ActiveRecord::Base.clear_cache! ActiveRecord::Base.establish_connection( :adapter =&gt; "postgresql", :host =&gt; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@current</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_company.db_host, :username =&gt; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@current</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_company.db_user, :password =&gt; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@current</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_company.db_password, :database =&gt; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@current</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_company.db_name ) redefine_uploaders_store_dir else redirect_to root_url end end end #    CarrierWave def redefine_uploaders_store_dir CarrierWave::Uploader::Base.descendants.each do |d| d.class_eval &lt;&lt;-RUBY, __FILE__, __LINE__+1 def store_dir "uploads/#{</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@current</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_company.subdomain}/\#{model.class.to_s.underscore}/\#{mounted_as}/\#{model.id}" end RUBY end end end</span></span></span></span></code> </pre><br><br>  Before connecting to the new database, it is necessary to clear the ActiveRecord cache (ActiveRecord :: Base.clear_cache! Or ActiveRecord :: Base.connection_pool.pool_reloadable_connections!). <br>  The redefine_uploaders_store_dir method overrides the directories in which CarrierWave will store files.  You could not do this hack, the probability of a conflict is very small (the names of the files and the id of the models must match), but it is there, so I decided to make sure. <br><br><h4>  Another little thing without which nothing will work </h4><br>  In config / environments / production.rb, you need to disable class caching. <br><pre> <code class="ruby hljs">config.cache_classes = <span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre><br><br>  Yes, productivity is declining, but I don‚Äôt know how to solve this problem otherwise <br><br><h4>  Sessions </h4><br>  In my case, a session can store a lot of data, so I need to store it in a database, not in cookies.  In addition, on the main page I have an authorization form for different brands and I would like to show the user in which he is already authorized and can enter by pressing one button, and for which you still need to enter a password.  Therefore, you need to store the session in one database, and not spread over several. <br>  First we tell the rails to use ActiveRecord for storing sessions: <br><pre> <code class="bash hljs">rails g session_migration rake db:migrate</code> </pre><br><h6>  config / initializers / session_store.rb </h6><br><pre> <code class="ruby hljs">MyApp::Application.config.session_store <span class="hljs-symbol"><span class="hljs-symbol">:active_record_store</span></span></code> </pre><br><br>  And then we tell them to use a certain database to store them: <br><h6>  config / environment.rb </h6><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># Load the rails application require File.expand_path('../application', __FILE__) # Initialize the rails application MyApp::Application.initialize! ActiveRecord::SessionStore::Session.establish_connection "production"</span></span></code> </pre><br><br>  <b>Note:</b> just in case I will make a reservation that ‚Äúproduction‚Äù here and in models is not the name of the database, but the name of the section in config / database.yml. <br><br><h4>  Migrations </h4><br>  For migrations, you can use this solution: <br><h6>  lib / tasks / multimigrate.rake </h6><br><pre> <code class="ruby hljs">namespace <span class="hljs-symbol"><span class="hljs-symbol">:db</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> desc <span class="hljs-string"><span class="hljs-string">"Migrations for all databases"</span></span> task <span class="hljs-symbol"><span class="hljs-symbol">:multimigrate</span></span> =&gt; <span class="hljs-symbol"><span class="hljs-symbol">:environment</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Company.all.each <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|company|</span></span> company.brands.each <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|brand|</span></span> puts <span class="hljs-string"><span class="hljs-string">"Run migration for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{company.name}</span></span></span><span class="hljs-string"> (</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{brand.name}</span></span></span><span class="hljs-string">)"</span></span> sh <span class="hljs-string"><span class="hljs-string">"cd </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{Rails.root.to_s}</span></span></span><span class="hljs-string"> &amp;&amp; bundle exec rake db:migrate RAILS_ENV=</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{brand.db_name}</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br>  For everything to work, all databases must be listed in database.yml.  For myself, I came up with the rule that the section (environment) in database.yml will be called like a database. <br>  Now, when I add a new company to the admin, the controller adds a new section to database.yml, but you can also assign this model (I don‚Äôt know how kosher it will be, but convenient).  Like that: <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Brand</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">establish_connection</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">production</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">belongs_to</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">company</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">after_save</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sync_to_yml</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validates</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db_name</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">presence</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sync_to_yml</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db_config</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YAML</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">load_file</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Rails</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">root</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_s</span></span></span><span class="hljs-class"> + '/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">database</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">yml</span></span></span><span class="hljs-class">') </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db_config</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db_name</span></span></span><span class="hljs-class">] = { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">adapter</span></span></span><span class="hljs-class">' =&gt; '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">postgresql</span></span></span><span class="hljs-class">', '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">encoding</span></span></span><span class="hljs-class">' =&gt; '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unicode</span></span></span><span class="hljs-class">', '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">database</span></span></span><span class="hljs-class">' =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db_name</span></span></span><span class="hljs-class">, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pool</span></span></span><span class="hljs-class">' =&gt; 5, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">username</span></span></span><span class="hljs-class">' =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">company</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db_user</span></span></span><span class="hljs-class">, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password</span></span></span><span class="hljs-class">' =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">company</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db_password</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">present?</span></span></span><span class="hljs-class"> ? </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">company</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db_password</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class"> } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">company</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db_host</span></span></span><span class="hljs-class"> != '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">localhost</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db_config</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db_name</span></span></span><span class="hljs-class">].</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">merge</span></span></span><span class="hljs-class">( { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host</span></span></span><span class="hljs-class">' =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">company</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db_host</span></span></span><span class="hljs-class">, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">port</span></span></span><span class="hljs-class">' =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">company</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db_port</span></span></span><span class="hljs-class"> } ) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">File</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">open</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Rails</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">root</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_s</span></span></span><span class="hljs-class"> + '/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">database</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">yml</span></span></span><span class="hljs-class">', '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">w</span></span></span><span class="hljs-class">' ) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">out</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YAML</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dump</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db_config</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">out</span></span></span><span class="hljs-class"> ) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  <b>Attention!</b>  Code not tested.  Just suggested how to do it.  In addition, you still need to add a callback to after_destroy. <br><br>  It seems to be all, it turned out to rewrite the existing Rails application for working with several databases is very simple.  I would be happy to share the sources that helped me in solving, but there were a lot of them and it would be difficult to find them (in one word, laziness).  But I can give the source to the <a href="http://www.designshak.com/tech-talk/ruby-on-rails">picture for the post</a> . </div><p>Source: <a href="https://habr.com/ru/post/143761/">https://habr.com/ru/post/143761/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143755/index.html">Which way of registering / entering the site is preferable for you?</a></li>
<li><a href="../143756/index.html">Arduino in a snack machine</a></li>
<li><a href="../143758/index.html">144 million dollars button</a></li>
<li><a href="../143759/index.html">Competition for display design of the news feed Habr</a></li>
<li><a href="../143760/index.html">All blogger.com blocked by Beeline by court order?</a></li>
<li><a href="../143762/index.html">Details of the kitchen development Diablo II (from 2000)</a></li>
<li><a href="../143763/index.html">Interactive Universe Scale</a></li>
<li><a href="../143764/index.html">Ponobalize: Meat grinder</a></li>
<li><a href="../143765/index.html">Customize your google</a></li>
<li><a href="../143766/index.html">Creating a 1k / 4k intro for Linux, part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>