<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>NetApp ONTAP & ESXi 6.x tuning</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuing the topic of optimizing the ESXi host for interoperating with NetApp ONTAP storage systems, this article will be enlightened on optimizing ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>NetApp ONTAP & ESXi 6.x tuning</h1><div class="post__text post__text-html js-mediator-article">  Continuing the topic of optimizing the ESXi host for interoperating with NetApp ONTAP <abbr title="Storage System">storage</abbr> systems, this article will be enlightened on optimizing VMWare ESXi 6.X performance, previous articles were devoted to tuning <a href="http://habrahabr.ru/post/245357/">Linux</a> , <a href="http://habrahabr.ru/post/243153/">Windows</a> and <a href="https://habrahabr.ru/post/247833/">VMware ESXi 5.X</a> <abbr title="Operating system">OS</abbr> in <abbr title="Storage Area Network">SAN</abbr> .  NetApp has been working closely with VMware for a long time, which can be confirmed by the fact that the <a href="https://habrahabr.ru/post/321366/">vVOL</a> technology <a href="https://habrahabr.ru/post/321366/">was implemented as</a> one of the first in the release of <a href="http://community.netapp.com/t5/Tech-OnTap-Articles/NetApp-Unlocks-the-Power-of-VMware-VVOLs/ta-p/86939">Clustered Data ONTAP 8.2.1 (August 2014)</a> , while vSphere 6.0 has not even been released yet.  NetApp was the first to announce support for vVol from NFS (Perhaps NetApp is still the only one here, I don‚Äôt follow).  In this connection, ONTAP storage systems are extremely popular in this environment. <br>  This article will be useful to owners of storage systems with ONTAP, and the part about <a href="https://habr.com/ru/post/303844/">Disk Alignment</a> will be useful not only to owners of NetApp. <br><br><img src="https://habrastorage.org/files/722/21e/ff6/72221eff6da541d5bd1890a60a38f4b5.png"><br>  To search for a bottleneck, a sequential exception technique is usually performed.  I suggest first thing to start with the <abbr title="Storage System">storage system</abbr> .  And move on to the <a href="http://habrahabr.ru/post/243045/">storage system</a> -&gt; Network ( <a href="http://habrahabr.ru/post/243119/">Ethernet</a> / FC) -&gt; Host ( <a href="http://habrahabr.ru/post/243153/">Windows</a> / <a href="http://habrahabr.ru/post/245357/">Linux</a> / <b>VMware ESXi</b> ) -&gt; Application. <br><a name="habracut"></a><br>  There are a couple of basic documents you need to rely on when configuring VMware + NetApp: <br><br>  <a href="https://kb.netapp.com/support/index%3Fpage%3Dcontent%26id%3D1015266%26pmv%3Dprint%26impressions%3Dfalse">How to configure VMware vSphere 6.x on ONTAP 8.x</a> <br>  <a href="https://library.netapp.com/ecm/ecm_download_file/ECMP12405914">Virtual Storage Console 6.0 for VMware vSphere Installation</a> <br>  <a href="https://www.netapp.com/us/media/tr-4128.pdf">TR-4128: vSphere 6 on NetApp MetroCluster 8.3</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  <a href="https://habr.com/ru/post/303844/">Hypervisor</a> </h4><a name="Hypervisor"></a><br>  You don‚Äôt have to give the guest <abbr title="Operating system">OS</abbr> all server resources; first, the hypervisor needs to leave at least 4GB of <abbr title="RAM">RAM</abbr> , and secondly, the opposite effect is sometimes observed when adding guest <abbr title="Operating system">OS</abbr> resources, this needs to be selected empirically. <br><br><h5>  <a href="https://habr.com/ru/post/303844/">Swap</a> </h5><a name="SWAP"></a><br>  This section is in a <a href="http://habrahabr.ru/post/247631/">separate post</a> . <br><br><h4>  <a href="https://habr.com/ru/post/303844/">Guest OS</a> </h4><a name="GOS"></a><br>  Tuning settings is needed for two purposes: <br><ul><li>  Optimization of the speed of the guest <abbr title="Operating system">OS</abbr> </li><li>  Normal operation in <abbr title="High availability">HA</abbr> pair, with the failure of one controller (takeover) and the resumption of its work (giveback) </li></ul><br><br><h5>  <a href="https://habr.com/ru/post/303844/">Disk alignment</a> </h5><a name="alignment"></a><br>  To optimize performance, you may need <a href="https://kb.netapp.com/support/index%3Fpage%3Dcontent%26id%3D1010881">to eliminate <i>disk misalignment</i></a> .  <i>Misalignment</i> can be obtained in two cases: <br><ol><li>  due to incorrectly chosen geometry of the moon when it was created in the <abbr title="Storage System">storage system</abbr> .  Such an error can be created only in the <abbr title="Storage Area Network">SAN</abbr> environment. </li><li>  inside virtual disks of virtual machines.  Maybe both in <abbr title="Storage Area Network">SAN</abbr> and in <abbr title="Network area storage">NAS</abbr> environment </li></ol><br><br>  Let's look at these cases. <br><div class="spoiler">  <b class="spoiler_title">Fully aligned blocks on a VMFS datastore</b> <div class="spoiler_text">  First, consider fully aligned blocks on the <abbr title="Virtual Machine File System">VMFS</abbr> datastor and storage boundaries. <br><img src="https://habrastorage.org/files/25d/94c/450/25d94c450dfe4720b08ad31fa8fb428b.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">The first case - Misalignment with VMFS</b> <div class="spoiler_text">  The first case is when there is a <abbr title="Virtual Machine File System">VMFS</abbr> datastor <i>misalignment</i> regarding storage.  To eliminate the first type of problem, you must create a moon with the correct geometry and move the virtual machines there. <br><img src="https://habrastorage.org/files/1da/718/628/1da7186286d94f4691dc7b58e42c8394.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">The second case is the offset inside the guest OS</b> <div class="spoiler_text">  The second situation, with displaced file system partitions within the guest <abbr title="Operating system">OS</abbr> with respect to the <abbr title="Write Anywhere File Layout">WAFL</abbr> file structure, can be obtained in older Linux distributions and Windows 2003 and older.  Since the problem is ‚Äúinside the virtual machine‚Äù, it can be observed on both NFS and VMFS datastores, as well as in RDM and vVOL.  As a rule, this is due to the non-optimal allocation of the MBR partition table or to the machines that were converted from physical to virtual.  You can check this in <a href="https://kb.netapp.com/support/index%3Fpage%3Dcontent%26id%3D1013644%26actp%3Dsearch%26viewlocale%3Den_US%26searchid%3D1419848156220"><abbr title="Operating system">the</abbr> Windows guest <abbr title="Operating system">OS</abbr></a> using the <i>dmdiag.exe -v</i> utility (the value of the Rel Sec field must be a multiple of 4KB per <abbr title="Write Anywhere File Layout">WAFL</abbr> ).  More on <a href="https://kb.netapp.com/support/index%3Fpage%3Dcontent%26id%3D1010803%26actp%3Dsearch%26viewlocale%3Den_US%26searchid%3D1419848156220">diagnosing misalignment for windows</a> machines.  For details on how to eliminate such situations, see the <a href="http://media.netapp.com/documents/tr-3747.pdf">TR-3747 Best Practices for File Alignment in Virtual Environments</a> . <br><img src="https://habrastorage.org/files/d2f/af1/13a/d2faf113a58c4bb6ad5c9fd088a6dcc3.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Misalignment on two levels</b> <div class="spoiler_text">  And of course, you can get <i>misalignment</i> on two levels at once: both at the <abbr title="Virtual Machine File System">VMFS</abbr> datastor level and at the guest <abbr title="Operating system">OS</abbr> file system level.  Read more about <a href="http://habrahabr.ru/post/243045/">finding misalignment from the ONTAP repository</a> . <br><img src="https://habrastorage.org/files/e7f/fb3/f48/e7ffb3f482a44eca891a2a71b60857c6.png"><br><br>  In the newly created VMFS5 (not an upgrade from VMFS3), the block is 1MB in size with 8KB sub-blocks. <br></div></div><br><br><h5>  <a href="https://habr.com/ru/post/303844/">takeover / giveback</a> </h5><a name="takeover-giveback"></a><br>  To work out with takeover / giveback in the <abbr title="High availability">HA</abbr> pair, you need to configure the correct guest <abbr title="Operating system">OS</abbr> timeouts.  Since the cluster can have different models of storage systems, disk, hybrid and All Flash systems, and data can migrate between these systems, it is recommended to use the worst timeout value (for disk systems), namely 60 seconds: <br><table><tbody><tr><th>  OS </th><th>  Updated Guest OS Tuning for SAN: ESXi 5 and later, or ONTAP 8.1 and later (SAN) <br></th></tr><tr><td>  Windows </td><td>  disk timeout = 60 </td></tr><tr><td>  Linux </td><td>  disk timeout = 60 </td></tr><tr><td>  Solaris </td><td>  disk timeout = 60;  busy retry = 300;  not ready retry = 300;  reset retry = 30;  max.  throttle = 32;  min.  throttle = 8;  corrected VID / PID specification </td></tr></tbody></table><br>  The <abbr title="Operating system">OS</abbr> default values ‚Äã‚Äãfor <abbr title="Network file system">NFS are</abbr> satisfactory, and the settings for the guest <abbr title="Operating system">OS</abbr> do not need to be changed. <br><br>  These values ‚Äã‚Äãare set manually or using scripts available in the VSC: <br><div class="spoiler">  <b class="spoiler_title">Windows</b> <div class="spoiler_text">  Set the value of the disk access delay 60 seconds using the registry (set in seconds, in hexadecimal form). <br><pre><code class="dos hljs">[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\Disk] "TimeOutValue"=dword:<span class="hljs-number"><span class="hljs-number">0000003</span></span>c</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Linux</b> <div class="spoiler_text">  Set the disk access delay value to 60 seconds by creating a udev rule (specified in seconds, in hexadecimal form). <br><pre> <code class="bash hljs">DRIVERS==<span class="hljs-string"><span class="hljs-string">"sd"</span></span>, SYSFS{TYPE}==<span class="hljs-string"><span class="hljs-string">"0|7|14"</span></span>, RUN+=<span class="hljs-string"><span class="hljs-string">"/bin/sh -c 'echo 60 &gt; /sys$</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DEVPATH</span></span></span><span class="hljs-string">/timeout'"</span></span></code> </pre>  (Linux distributions may have a different location for setting udev rules).  VMware Tools for Linux guest <abbr title="Operating system">OS</abbr> automatically sets the udev rule with a delay value for the virtual disk equal to 180 seconds.  You can run the <i>grep command</i> for ‚ÄúVMware‚Äù vendor ID in the folder with udev rules to find the script that sets this value and change it if necessary.  Remember to check this value. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Solaris</b> <div class="spoiler_text">  Set the value of 60 sec delay (specified in seconds, in hexadecimal form) for the disk in the <i>/ etc / system</i> file: <pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span> sd:sd_io_time=0x3c</code> </pre> <br>  Additional settings can be made to the <i>/kernel/drv/sd.conf</i> file: <br>  Solaris 10.0 GA - Solaris 10u6: <br><pre> <code class="bash hljs">sd-config-list=<span class="hljs-string"><span class="hljs-string">"NETAPP LUN"</span></span>,<span class="hljs-string"><span class="hljs-string">"netapp-sd-config"</span></span>, <span class="hljs-string"><span class="hljs-string">"VMware Virtual"</span></span>,<span class="hljs-string"><span class="hljs-string">"netapp-sd-config"</span></span>; netapp-sd-config=1,0x9c01,32,0,0,0,0,0,0,0,0,0,300,300,30,0,0,8,0,0;</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Solaris 10u7 and newer and Solaris 11</b> <div class="spoiler_text"><pre> <code class="bash hljs">sd-config-list= <span class="hljs-string"><span class="hljs-string">"NETAPP LUN"</span></span>,<span class="hljs-string"><span class="hljs-string">"physical-block-size:4096,retries-busy:300,retries-timeout:16,retries-notready:300,retries-reset:30,throttle-max:32,throttle-min:8"</span></span>, <span class="hljs-string"><span class="hljs-string">"VMware Virtual"</span></span>,<span class="hljs-string"><span class="hljs-string">"physical-block-size:4096,retries-busy:300,retries-timeout:16,retries-notready:300,retries-reset:30,throttle-max:32,throttle-min:8"</span></span>;</code> </pre><br>  Note: there are two spaces between vendor ID NETAPP and ID LUN, as well as between the words "VMware" and "Virtual" in the config above. <br></div></div><br><br><h4>  <a href="https://habr.com/ru/post/303844/">FC / FCoE Switch Zoning Settings</a> </h4><a name="zoning"></a><br>  Learn more about <a href="http://habrahabr.ru/post/260107/">zoning</a> recommendations <a href="http://habrahabr.ru/post/260107/">for NetApp in pictures</a> . <br><br><h5>  <a href="https://habr.com/ru/post/303844/">ALUA</a> </h5><a name="ALUA"></a><br>  For ONTAP 8.X and 9.X, <abbr title="Asymmetric Logical Unit Access">ALUA is</abbr> always enabled for all block protocols: <abbr title="Internet Small Computer System Interface">iSCSI</abbr> / <abbr title="Fiber channel">FC</abbr> / <abbr title="Fiber channel over ethernet">FCoE</abbr> . <br>  If the host has correctly defined the <abbr title="Asymmetric Logical Unit Access">ALUA</abbr> , then the <i>Storage Array Type plug-in</i> will display the <i>VMW_SATP_ALUA</i> .  For <abbr title="Asymmetric Logical Unit Access">ALUA</abbr> , <abbr title="Asymmetric Logical Unit Access">either</abbr> the <i>Most Recently Used</i> or <i>Round Robin</i> algorithm is allowed to use - any. <br><img src="https://habrastorage.org/files/b67/029/f29/b67029f29a3e4b048badff994469b0bb.png"><br><br>  <i>Round Robin</i> will be more productive if there are more than one path to the controller.  In the case of using Microsoft Cluster + <abbr title="RAW Device Mapping">RDM</abbr> disks, the <i>Most Recently Used</i> balancing mechanism is recommended. <br><br>  Below is a table of recommended load balancing settings.  Learn more about the <a href="http://habrahabr.ru/post/243045/">NetApp ONTAP, ALUA logic and load balancing for block protocols</a> . <br><table><tbody><tr><th>  Mode </th><th>  <abbr title="Asymmetric Logical Unit Access">ALUA</abbr> </th><th>  Protocol </th><th>  ESXi Policy <br></th><th>  ESXi Path Balancing <br></th></tr><tr><td>  ONTAP 9.x / 8.x (Clustered) </td><td>  Enabled </td><td>  <abbr title="Fiber channel">FC</abbr> / <abbr title="Fiber channel over ethernet">FCoE</abbr> / <abbr title="Internet Small Computer System Interface">iSCSI</abbr> </td><td>  VMW_SATP_ALUA </td><td>  Most Recently Used </td></tr><tr><td>  ONTAP 9.x / 8.x (Clustered) </td><td>  Enabled </td><td>  <abbr title="Fiber channel">FC</abbr> / <abbr title="Fiber channel over ethernet">FCoE</abbr> / <abbr title="Internet Small Computer System Interface">iSCSI</abbr> </td><td>  VMW_SATP_ALUA </td><td>  Round robin </td></tr></tbody></table><br><div class="spoiler">  <b class="spoiler_title">Check the applicable policy to the checked moon / datastore</b> <div class="spoiler_text"><pre> <code class="bash hljs">~ <span class="hljs-comment"><span class="hljs-comment"># esxcli storage nmp device list naa.60a980004434766d452445797451376b Device Display Name: NETAPP Fibre Channel Disk (naa.60a980004434766d452445797451376b) Storage Array Type: VMW_SATP_ALUA Storage Array Type Device Config: {implicit_support=on;explicit_support=off; explicit_allow=on;alua_followover=on;{TPG_id=1,TPG_state=ANO}{TPG_id=0,TPG_state=AO}} Path Selection Policy: VMW_PSP_RR Path Selection Policy Device Config: {policy=rr,iops=1000,bytes=10485760,useANO=0; lastPathIndex=0: NumIOsPending=0,numBytesPending=0} Path Selection Policy Device Custom Config: Working Paths: vmhba2:C0:T6:L119, vmhba1:C0:T7:L119 Is Local SAS Device: false Is USB: false Is Boot USB Device: false</span></span></code> </pre><br></div></div><br><br><h4>  <a href="https://habr.com/ru/post/303844/">ESXi host settings</a> </h4><a name="ESXI_configurations"></a><br>  For the ESXi host to work optimally, it is necessary to set recommended parameters for it. <br><br><table><tbody><tr><th>  Parameter </th><th>  Protocol (s) </th><th>  ESXi 6.x with DataONTAP 8.x </th><th>  ESXi 6.x with DataONTAP 9.x </th></tr><tr><td>  Net.TcpipHeapSize </td><td>  iSCSI / NFS </td><td colspan="2">  32 </td></tr><tr><td>  Net.TcpipHeapMax </td><td>  iSCSI / NFS </td><td colspan="2">  512 </td></tr><tr><td>  NFS.MaxVolumes </td><td>  Nfs </td><td colspan="2">  256 </td></tr><tr><td>  NFS41.MaxVolumes </td><td>  NFS 4.1 </td><td colspan="2">  256 </td></tr><tr><td>  NFS.HeartbeatMaxFailures </td><td>  Nfs </td><td colspan="2">  ten </td></tr><tr><td>  NFS.HeartbeatFrequency </td><td>  Nfs </td><td colspan="2">  12 </td></tr><tr><td>  NFS.HeartbeatTimeout </td><td>  Nfs </td><td colspan="2">  five </td></tr><tr><td>  NFS.MaxQueueDepth </td><td>  Nfs </td><td colspan="2">  64 </td></tr><tr><td>  Disk.QFullSampleSize </td><td>  iSCSI / FC / FCoE </td><td colspan="2">  32 </td></tr><tr><td>  Disk.QFullThreshold </td><td>  iSCSI / FC / FCoE </td><td colspan="2">  eight </td></tr></tbody></table><br>  There are several ways to do this: <br><br><ul><li>  Using the Command Line Interface (CLI) on ESXi 6.x hosts. </li><li>  Using vSphere Client / vCenter Server. </li><li>  Using the Remote CLI tool from VMware. </li><li>  Using the VMware Management Appliance (VMA). </li><li>  By applying the Host Profile, deploying it from an already configured ESXi 6.x to other hosts. </li></ul><br><br><div class="spoiler">  <b class="spoiler_title">An example of setting advanced parameters from ESX 6.x CLI</b> <div class="spoiler_text">  The esxcfg-advcfg utility used in these examples is located in the / usr / sbin folder for the ESXi host. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  iSCSI/NFS #esxcfg-advcfg -s 32 /Net/TcpipHeapSize #esxcfg-advcfg -s 512 /Net/TcpipHeapMax #  NFS #esxcfg-advcfg -s 256 /NFS/MaxVolumes #esxcfg-advcfg -s 10 /NFS/HeartbeatMaxFailures #esxcfg-advcfg -s 12 /NFS/HeartbeatFrequency #esxcfg-advcfg -s 5 /NFS/HeartbeatTimeout #esxcfg-advcfg -s 64 /NFS/MaxQueueDepth #  NFS v4.1 #esxcfg-advcfg -s 256 /NFS41/MaxVolumes #  iSCSI/FC/FCoE #esxcfg-advcfg -s 32 /Disk/QFullSampleSize #esxcfg-advcfg -s 8 /Disk/QFullThreshold</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Checking advanced settings from ESX 6.x CLI</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  iSCSI/NFS #esxcfg-advcfg -g /Net/TcpipHeapSize #esxcfg-advcfg -g /Net/TcpipHeapMax #  NFS #esxcfg-advcfg -g /NFS/MaxVolumes #esxcfg-advcfg -g /NFS/HeartbeatMaxFailures #esxcfg-advcfg -g /NFS/HeartbeatFrequency #esxcfg-advcfg -g /NFS/HeartbeatTimeout #esxcfg-advcfg -g /NFS/MaxQueueDepth #  NFS v4.1 #esxcfg-advcfg -g /NFS41/MaxVolumes #  iSCSI/FC/FCoE #esxcfg-advcfg -g /Disk/QFullSampleSize #esxcfg-advcfg -g /Disk/QFullThreshold</span></span></code> </pre><br></div></div><br><h5>  <a href="https://habr.com/ru/post/303844/">HBA</a> </h5><a name="HBA"></a><br>  NetApp typically recommends using "default values" for <abbr title="Host bus adapter">HBAs</abbr> set by the adapter manufacturer for ONTAP systems with an ESXi host.  If they have been changed, you must return them to the factory settings.  Check out relevant best practices.  For example, if we are talking about DB2 virtualization in a VMware environment on NetApp, then it is recommended ( <a href="http://www.netapp.com/us/media/wp-7109.pdf">see page 21</a> ) to increase the queue length to 64 on ESXi (as written in <a href="http://kb.vmware.com/selfservice/microsites/search.do%3Flanguage%3Den_US%26cmd%3DdisplayKC%26externalId%3D1267">Vmware KB 1267</a> ). <br><div class="spoiler">  <b class="spoiler_title">Qlogic HBA setup example on ESXi</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    Qlogic  ESXi 5.5  6.0 # esxcli system module list | grep qln #    Qlogic  ESXi 5.5  6.0 # esxcli system module parameters set -p qlfxmaxqdepth=64 -m qlnativefc</span></span></code> </pre><br></div></div><br><br><h5>  <a href="https://habr.com/ru/post/303844/">VSC</a> </h5><h5><a name="VSC"></a><br>  The NetApp <abbr title="Virtual Storage Console">VSC</abbr> plugin (is free <abbr title="Software">software</abbr> ) sets the recommended settings on the ESXi host and <abbr title="Host bus adapter">HBA</abbr> adapter: queue, delay, and others.  The plugin itself integrates into vCenter.  Saves time and eliminates the human factor during the test when setting parameters on an ESXi host to work more effectively with NetApp.  Allows you to perform basic operations to manage storage from vCenter, necessary for the administrator of virtualized environments.  Access rights to the repository using <abbr title="Virtual Storage Console">VSC</abbr> can be flexibly configured for multiple users using <abbr title="Role-based Access Control">RBAC</abbr> .  VSC is required to configure vVOL. <br>  A version of the plugin is available only for the web client.  Version 6 and newer is supported. <br><img src="https://habrastorage.org/files/a91/53b/93c/a9153b93c6bf48ce840e28b6baedf716.png"><br><br></h5><h4>  <a href="https://habr.com/ru/post/303844/">Ethernet</a> </h4><a name="Ethernet"></a><br><h5>  <a href="https://habr.com/ru/post/303844/">Jumbo frames</a> </h5><a name="Jumbo_frames"></a><br>  If <abbr title="Internet Small Computer System Interface">iSCSI</abbr> is used, it is highly recommended to use Jumbo Frames on Ethernet with a speed higher than or equal to 1Gb.  Read more in the article about <a href="http://habrahabr.ru/post/243119/">Ethernet with NetApp ONTAP</a> .  Do not forget about the recommendations of VMware settings LACP, Port-channel, Spanning Tree, PortFast, Flowcontrol. <br><br><h5>  <a href="https://habr.com/ru/post/303844/">ESXi &amp; MTU9000</a> </h5><h5><a name="ESXi_and_MTU9000"></a><br>  Remember to create the right network adapter - VMware recommends using VMXNEE3.  Starting with ESXi 5.0, VMXNET3 supports Jumbo Frames.  The E1000e network adapter supports speed of 1GB networks and MTU 9000 - it is installed for all created VMs by default (except Linux).  Standard virtual network adapter type "Flexible" supports MTU 1500. <a href="http://kb.vmware.com/selfservice/microsites/search.do%3Flanguage%3Den_US%26cmd%3DdisplayKC%26externalId%3D1001805">More.</a> <br><img src="https://habrastorage.org/files/c78/e12/7e7/c78e127e777b4220b20d008098cd2a1f.png"><br><br>  Also, do not forget that the <i>port group</i> installed for the virtual network adapter of your virtual machine must be connected to a virtual switch with the MTU 9000 setting set for the entire switch. <br><img src="https://habrastorage.org/files/bc3/e89/3fb/bc3e893fb3e4473c8138183efcd3b34a.png"><br><br></h5><h4>  <a href="https://habr.com/ru/post/303844/">NAS and VAAI</a> </h4><a name="NAS"></a><br>  ONTAP systems support VMware <abbr title="vStorage APIs for Array Integration">VAAI</abbr> primitives by downloading part of the routine data management tasks on a datastore from host to storage, where this is more logical to do.  In a <abbr title="Storage Area Network">SAN</abbr> environment with ESXi 4.1+ and higher with ONTAP 8.0 and higher, <abbr title="vStorage APIs for Array Integration">VAAI is</abbr> automatically supported and does not require any manipulation.  For the <abbr title="Network area storage">NAS</abbr> environment, NetApp has released a plugin that allows such optimization for the <abbr title="Network file system">NFS</abbr> protocol.  This requires the installation of a <i>NetAppNFSVAAI</i> kernel <i>module</i> for each ESXi host.  <a href="https://habr.com/ru/post/303844/">VSC</a> can install the <abbr title="Network file system">NFS</abbr> <abbr title="vStorage APIs for Array Integration">VAAI</abbr> plugin automatically from vCenter.  In order for it to function, you need to <a href="https://kb.netapp.com/support/index%3Fpage%3Dcontent%26id%3D1014234%26act%3DSAT%26impressions%3Dfalse%26newguid%3D3cfa2cb3cf9544c597c8479f7ff38ca3">properly configure the NFS ball for VAAI</a> , for which you must meet several requirements: <br><ul><li>  Configure ESXi server access (RO, RW and Superuser must be in SYS or ANY state, and NFS3 <b><u>And</u></b> NFS4 access must be activated).  Even if NFS4 will not be used, it should be on the access list. </li><li>  All parent entries in the junction path must allow root read access and NFSv4 access.  In most cases, this means that the root volume for the Storage Virtual Server (Vserver) should have the minimum superuser setting set to SYS for the corresponding client that will use the VAAI access to one of the nested volums.  It is recommended to deny write access directly to Vserver root. </li><li>  It is necessary to enable vStorage support on the volume. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Example of setting VAAI on ONTAP</b> <div class="spoiler_text"><pre> <code class="bash hljs">cm3240c-rtp::&gt; <span class="hljs-built_in"><span class="hljs-built_in">export</span></span>-policy rule show -vserver vmware -policyname vmware_access -ruleindex 2 (vserver <span class="hljs-built_in"><span class="hljs-built_in">export</span></span>-policy rule show) Vserver: vmware Policy Name: vmware_access Rule Index: 1 Access Protocol: nfs3 &lt;---- needs to be <span class="hljs-string"><span class="hljs-string">'nfs'</span></span> or <span class="hljs-string"><span class="hljs-string">'nfs3,nfs4'</span></span> Client Match Spec: 192.168.1.7 RO Access Rule: sys RW Access Rule: sys User ID To Which Anonymous Users Are Mapped: 65534 Superuser Security Flavors: sys Honor SetUID Bits In SETATTR: <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre><br><br><pre> <code class="bash hljs">cm3240c-rtp::&gt; <span class="hljs-built_in"><span class="hljs-built_in">export</span></span>-policy rule show -vserver vmware -policyname root_policy -ruleindex 1 (vserver <span class="hljs-built_in"><span class="hljs-built_in">export</span></span>-policy rule show) Vserver: vmware Policy Name: root_policy Rule Index: 1 Access Protocol: nfs &lt;--- like requirement 1, <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to nfs or nfs3,nfs4 Client Match Spec: 192.168.1.5 RO Access Rule: sys RW Access Rule: never &lt;--- this can be never <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> security reasons User ID To Which Anonymous Users Are Mapped: 65534 Superuser Security Flavors: sys &lt;--- this is required <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> VAAI to be <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>, even <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the parent volumes like vsroot Honor SetUID Bits In SETATTR: <span class="hljs-literal"><span class="hljs-literal">true</span></span> Allow Creation of Devices: <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre><br><pre> <code class="bash hljs">cm3240c-rtp::&gt; nfs modify -vserver vmware -vstorage enabled</code> </pre><br></div></div><br><br><h5>  <a href="https://habr.com/ru/post/303844/">VASA</a> </h5><a name="VASA"></a><br>  <abbr title="VMware APIs for Storage Awareness">VASA</abbr> is free <abbr title="Software">software</abbr> that allows vCenter through the <abbr title="Application program interface">API</abbr> to learn about the storage capabilities and more intelligently use them.  <abbr title="VMware APIs for Storage Awareness">VASA</abbr> integrates into <abbr title="Virtual Storage Console">VSC</abbr> and allows you to create datastores with specific storage capabilities through a <abbr title="Graphical User Interface">GUI</abbr> interface (for example, presence / absence of Thing Provitioning, disk type: <abbr title="Serial Attached SCSI">SAS</abbr> / <abbr title="Serial ATA">SATA</abbr> / <abbr title="Solid state drive">SSD</abbr> , availability of a second-level cache, etc.) and include notifications upon reaching level (for example, occupied space or load).  Starting from version 6.0, <abbr title="VMware APIs for Storage Awareness">VASA</abbr> is a mandatory component of <abbr title="Virtual Storage Console">VSC</abbr> and is an important (and mandatory) part of the VMware <abbr title="Virtual volume">vVOL</abbr> paradigm. <br><br><h6>  Space Reservation - UNMAP </h6><br>  Starting with ESXi 5.0, it is possible to return released blocks from a thin moon (datastor) back to the repository.  In ESXi 5.X / 6.0 with VMFS, manual start is required to return space, for ESXi 6.X it works automatically with vVOL, and since version 6.5 it works automatically (with a delay) on VMFS-6 datastores.  On the ONTAP side, this functionality is always turned off by default; to <a href="https://habrahabr.ru/post/271959/">enable it, you need to execute several uncomplicated commands on the storage system</a> . <br><br><h6>  vVOL </h6><br>  This topic deserves special attention and is <a href="https://habrahabr.ru/post/321366/">included in a separate article</a> . <br><br><h4>  <a href="http://habrahabr.ru/post/154205/">Compatibility</a> </h4><a name="compatibility"></a><br>  <a href="http://habrahabr.ru/post/154205/">Make</a> extensive <a href="http://habrahabr.ru/post/154205/">use of the compatibility matrix</a> in your practice to reduce potential problems in the <abbr title="Data processing center">data center</abbr> infrastructure.  For troubleshooting, contact <abbr title="Knowledge base">KB</abbr> <a href="https://kb.netapp.com/">NetApp</a> and <a href="http://kb.vmware.com/">VMware</a> . <br><br>  I am sure that over time I will have something to add to this article on optimizing the ESXi host, so look here from time to time. <br><br><h4>  findings </h4><br>  The correct settings for the VMWare virtualization environment will not only improve the performance of your infrastructure, but also increase its resiliency.  Be sure to follow the recommendations of VMware and NetApp when starting up your infrastructure.  During start-up, be sure to create a test plan consisting of both load testing and fault tolerance testing, in order to eliminate possible configuration errors and have an idea of ‚Äã‚Äãthe capabilities and behavior of your infrastructure in normal operation mode, and in case of failures. <br><br>  <b>This may contain links to Habra articles that will be published later</b> . <br>  <b>I ask to send messages on errors in the text to the <abbr title="Private message">LAN</abbr> .</b> <br>  <b>Notes and additions on the contrary I ask in the comments.</b> </div><p>Source: <a href="https://habr.com/ru/post/303844/">https://habr.com/ru/post/303844/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303834/index.html">Simple graphics using D3.js</a></li>
<li><a href="../303836/index.html">What is space time really?</a></li>
<li><a href="../303838/index.html">Search for connections in social networks</a></li>
<li><a href="../303840/index.html">Java library for the efficient transfer of CSS and JavaScript</a></li>
<li><a href="../303842/index.html">Neural network as a predictor for PNG image coding</a></li>
<li><a href="../303850/index.html">Roskomnadzor blocked web services Amazon S3</a></li>
<li><a href="../303852/index.html">ALM Advisor - an online ALM-tool for assessing a planned or existing working environment.</a></li>
<li><a href="../303854/index.html">Unicorn that could</a></li>
<li><a href="../303856/index.html">Welcome to YAPC :: Russia 2016</a></li>
<li><a href="../303858/index.html">What are the next steps?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>