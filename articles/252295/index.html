<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MySQL connection pooling and how it can be used for parallelization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share with all readers an interesting topic, which I faced recently, and I liked it. The development of this topic gave me pleasure and adde...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MySQL connection pooling and how it can be used for parallelization</h1><div class="post__text post__text-html js-mediator-article">  <i>I want to share with all readers an interesting topic, which I faced recently, and I liked it.</i>  <i>The development of this topic gave me pleasure and added some experience to the piggy bank.</i>  <i>Probably many, and maybe not, faced a pool of database connections.</i>  <i>After reading this interesting option, I wanted to write an article and share it with you.</i>  <i>Perhaps the article will turn out to be a bit long, but I think that this post will still be interesting for someone to read, and this topic will interest him.</i>  <i>Maybe someone uses this article in this project, in any case, it will be interesting for me to write and tell it to you.</i> <br><a name="habracut"></a><br>  I am engaged in freelancing.  Somehow, one of my acquaintances brought me to the owners of a driving school, and there I was asked to make a program to form my collection of tickets.  Something like your traffic book tickets.  All questions are stored in MySQL DBMS in three tables, where in one collection of questions, in another subject of these questions and in the last answers to questions.  As a result, 800 questions with or without a picture, including answers.  The initial form of the formation was a conventional method with a consistent formation of questions inside.  I am quite interested in the topic of multi-threaded program execution, so after creating a fully working method, I decided to make everything more convenient, but at the same time I added sample speeds. <br><br>  To begin with, in order to form your version of the SDA tickets, you need to take into account the subject matter.  In this case, only 12 topics.  The first 8 topics consist of 40 questions, the remaining 120. Each topic corresponds to a specific number in the ticket, with the first 8 topics corresponding to 1 question from the ticket, the other 3 questions from the ticket.  To store the generated version of questions, the Dictionary is used, where each key contains a list of questions on a specific topic.  In this case, the order of questions should always be different, i.e.  you need a method that will generate a sequence of numbers from 0 to 40 without repetitions, so it turns out to choose any ticket and, accordingly, a question from it.  Taking into account everything, such an algorithm for the formation of all questions is obtained: <br><br><ul><li>  we get all the topics that we have; </li><li>  from the topics we form a list of questions for each of the topics; </li><li>  generate random numbers; </li><li>  based on the list of questions and the sequence of random numbers, we make a sample and form a list of questions on the subject; </li><li>  we put each list in the dictionary. </li></ul><br>  The implementation and operation of the first two steps depends on the logic and in my opinion can be performed once when requesting a sample.  The third step depends on how much we want to make the questions different, to make a new generation before each topic, or once for all topics.  I chose to generate only once, in my opinion this is enough.  The fourth step will work most often and in this place it should be most time consuming when sampling.  The last step is simple and just skip it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Connect to the database </h3><br>  Consider the connection to the database.  To do this, use an abstract class that will hold the connection string, Connection, and DataReader: <br><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SqlBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> String Connect; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> MySqlConnection SqlConnection; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> MySqlDataReader SqlDataReader; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SqlBase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Connect = String.Format(<span class="hljs-string"><span class="hljs-string">"Database={0};Data Source={1};User ID={2};Password={3};CharSet=utf8"</span></span>, Settings.Default.Database, Settings.Default.DataSource, Settings.Default.UserId, Settings.Default.Password); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SqlBase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SqlConnection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MySqlConnection(Connect); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SqlConnection.Open(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(ex.Message, ex); } } }</code> </pre> <br>  I like abstract classes because they allow you to create and hide comfortable work logic in yourself, allowing you to concentrate fully on other concrete things in a derivative and not worry about other details, placing the responsibilities on the base class.  In this case, creating an instance of a derived class, we automatically obtain the necessary conditions for working with the database and we need to implement the logic of the class itself to formulate a sample of questions: <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> sealed <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SqlPerceptionQuestions : SqlBase { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;Int32, List&lt;Question&gt;&gt; GetQuestion() { Generation(); GetTheme(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Request(); } private <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;Int32, List&lt;Question&gt;&gt; Request() { var _collectionDictionary = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;Int32, List&lt;Question&gt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-type"><span class="hljs-type">int</span></span> ctr = <span class="hljs-number"><span class="hljs-number">0</span></span>; ctr &lt; <span class="hljs-number"><span class="hljs-number">12</span></span>; ctr++) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var _questions = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SqlQuestions()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctr &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) { _collectionDictionary[ctr] = _questions.GetQuestionSmall((Int16)ctr); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { _collectionDictionary[ctr] = _questions.GetQuestionGreat((Int16)ctr); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _collectionDictionary; } private async <span class="hljs-type"><span class="hljs-type">void</span></span> GetTheme() { //  } //       <span class="hljs-number"><span class="hljs-number">40</span></span>  private List&lt;Question&gt; GetQuestionSmall(Int16 numTheme) { var _listQuestions = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List&lt;Question&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Int16 numCard = <span class="hljs-number"><span class="hljs-number">0</span></span>; numCard &lt; <span class="hljs-number"><span class="hljs-number">40</span></span>; numCard++) { _listQuestions.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(GetQuestion(numCard, numTheme)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _listQuestions; } //       <span class="hljs-number"><span class="hljs-number">120</span></span>  private List&lt;Question&gt; GetQuestionGreat(Int16 numTheme) { var _listQuestions = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List&lt;Question&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Int16 numQuestion = <span class="hljs-number"><span class="hljs-number">0</span></span>; numQuestion &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>; numQuestion++) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> numCard = <span class="hljs-number"><span class="hljs-number">0</span></span>; numCard &lt; <span class="hljs-number"><span class="hljs-number">40</span></span>; numCard++) { _listQuestions.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(GetQuestion(numQuestion, numTheme, numQuestion)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _listQuestions; } //          private Question GetQuestion(Int16 numCard, Int16 numTheme, Int16 numQuestion = <span class="hljs-number"><span class="hljs-number">0</span></span>) { //  } //    private List&lt;String&gt; GetResponse(Int32 questions_id) { //  } }</code> </pre><br><br>  This is the most simple and synchronous version, which runs for about 2 seconds and 200-400 milliseconds, which, accordingly, will block the user interface for all this time.  This is already a good working version, since the very first implementation worked for quite a long time, about 6 seconds.  After the improvement, it took about 2 seconds. <br><br><h3>  Creating an asynchronous version of the sample </h3><br>  Everything is good and everything is already working, but is it how it should be?  After all, we have a synchronous method (blocking) and not a console application.  A proper and completely working program is needed, which will not block even for half a second, but will work properly under any load.  To do this, first rewrite the GetQuestion () method.  Let's make it asynchronous in accordance with the TAP (Task-based Asynchronous Pattern) pattern.  Who is interested in reading on the Internet or there is a pretty good book that I like very much - ‚ÄúAsynchronous programming in C # 5.0‚Äù by Alex Davis, where this subject is very well described, or <a href="http://habrahabr.ru/post/162353/">look here</a> .  Rewrite it and it will look like this: <br><br><pre> <code class="hljs javascript">public <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> Task&lt;Dictionary&lt;Int32, List&lt;Question&gt;&gt;&gt; GetQuestionAsync() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Task.Factory.StartNew(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { Generation(); GetTheme(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Request(); }, TaskCreationOptions.LongRunning); }</code> </pre><br>  Consider the most interesting in this method: Task.Factory.StartNew ().  Starting with the .NET 4.5 version, you can use the Task.Run () version, which differs from the previous one in a simpler declaration with a smaller number of parameters when created.  In essence Task.Run (), it is simply a more convenient shell over Task.Factory.StartNew () and is very suitable for simply creating asynchronous tasks, but at the same time it has a little less control flexibility.  If you need more precise control over which thread performs the calculations or how it is planned, use Task.Factory.StartNew ().  If interested, take a <a href="http://blogs.msdn.com/b/pfxteam/archive/2011/10/24/10229468.aspx">look here</a> .  In this case, I used this option for the reason that I also specified a parameter such as TaskCreationOptions.LongRunning, which marks this task as long and means that this work item will run for a long period of time and may block other work items .  This flag also provides information for TaskScheduler, what to expect oversubscription, and this will create more threads than the number of available hardware threads.  With this option, you can completely avoid ThreadPool, including global and local queues.  Read more <a href="https://msdn.microsoft.com/ru-ru/library/dd997402(v%3Dvs.110).aspx">"Task Scheduler"</a> . <br><br>  Thus, we get the asynchronous execution of the formation of a collection of data and do not block the main stream. <br><br><h3>  Sampling parallelization </h3><br>  After that, we proceed to parallelization, which will give us an increase in the speed of data sampling.  But for this, you will have to redo a little main class, change the base class and add another one to ensure parallel cycle operation in order to avoid data races, critical sections and problems with variables for different streams. <br>  To begin, create a new nested class in the <i>SqlPerceptionQuestions</i> class - <i>SqlQuestions</i> .  We will transfer the methods to get questions and answers to them, and also make it a derivative of SqlBase, while leaving the outer class to get the topics, we will call it only once, as well as the formation of a sequence of numbers. <br><br>  Class code <i>SqlQuestions</i> : <br><br><pre> <code class="hljs cs"> <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SqlQuestions</span></span> : <span class="hljs-title"><span class="hljs-title">SqlBase</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> List&lt;Question&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetQuestionSmall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Int16 numTheme</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _listQuestions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Question&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Int16 numCard = <span class="hljs-number"><span class="hljs-number">0</span></span>; numCard &lt; <span class="hljs-number"><span class="hljs-number">40</span></span>; numCard++) { _listQuestions.Add(GetQuestion(numCard, numTheme)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _listQuestions; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> List&lt;Question&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetQuestionGreat</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Int16 numTheme</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _listQuestions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Question&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Int16 numQuestion = <span class="hljs-number"><span class="hljs-number">0</span></span>; numQuestion &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>; numQuestion++) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> numCard = <span class="hljs-number"><span class="hljs-number">0</span></span>; numCard &lt; <span class="hljs-number"><span class="hljs-number">40</span></span>; numCard++) { _listQuestions.Add(GetQuestion(numQuestion, numTheme, numQuestion)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _listQuestions; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Question </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetQuestion</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Int16 numCard, Int16 numTheme, Int16 numQuestion = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  } private List&lt;String&gt; GetResponse(Int32 questions_id) { //  } }</span></span></code> </pre><br>  For parallelization of the loop we will use Parallel.For ().  This is a rather convenient way to organize data loading in several streams.  But it is also fraught with the fact that we will need to create at least several connections to the database, since one Connection is able to process one DataReader.  Rewrite the .Request () method: <br><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Dictionary&lt;Int32, <span class="hljs-keyword"><span class="hljs-keyword">List</span></span>&lt;Question&gt;&gt; Request() { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _collectionDictionary = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;Int32, <span class="hljs-keyword"><span class="hljs-keyword">List</span></span>&lt;Question&gt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _po = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ParallelOptions { MaxDegreeOfParallelism = Environment.ProcessorCount }; Parallel.<span class="hljs-keyword"><span class="hljs-keyword">For</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>, _po, ctr =&gt; { using (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _questions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlQuestions()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctr &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) { _collectionDictionary[ctr] = _questions.GetQuestionSmall((Int16)ctr); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { _collectionDictionary[ctr] = _questions.GetQuestionGreat((Int16)ctr); } } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _collectionDictionary; }</code> </pre><br>  And after opening the connection, it must be closed.  In this case, all this will happen in a cycle.  To implement all this, I decided to create a separate derived class <i>SqlQuestions</i> .  To close the connection, we will call .Dispose (), in which we will write what we need to do when closing.  To do this, first declare the .Dispose () method in the base class: <br><br><pre> <code class="hljs cs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Dispose(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); GC.SuppressFinalize(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Boolean disposing</span></span></span><span class="hljs-function">)</span></span>;</code> </pre><br>  And we will implement it differently in derived classes.  Why is that?  Let's start with what happens when you create a connection to the database and close it?  If you open a connection and then close it, it is placed for a while (about 3 minutes) into the MySQL connection pool, and if you open a new one, the connection is taken from the pool, which means that time and resources for reopening are not used.  Let's launch our new methods and see how much time it takes to open database connections, for this we insert in the base class Stopwatch into the code where the connection is opened and see what we have at the output.  Code: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SqlBase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Stopwatch st = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stopwatch(); st.Start(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SqlConnection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MySqlConnection(Connect); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SqlConnection.Open(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (MySqlException ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(ex.Message, ex); } st.Stop(); Debug.WriteLine(<span class="hljs-string"><span class="hljs-string">"    : "</span></span> + st.Elapsed.Seconds.ToString() + <span class="hljs-string"><span class="hljs-string">"  "</span></span> + st.Elapsed.Milliseconds.ToString() + <span class="hljs-string"><span class="hljs-string">" "</span></span>); }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Opening time</b> <div class="spoiler_text"><img src="http://s49.radikal.ru/i125/1503/6d/bac9791c778f.jpg" alt="image"></div></div><br>  The first connection is the longest; it opens a connection for the <i>SqlPerceptionQuestions</i> class, which will be open for the entire duration of the method.  Subsequent connections are those that were opened while in a loop when creating instances of the <i>SqlQuestions</i> class.  Taking into account the number of processors on my computer, of which 4 we find that in a cycle the maximum will be open 4 connections.  We get that 5 connections will initially be open, while in the cycle they will both open and close.  Therefore, the first 5 connections take time to open, and after when the old connections are closed in the cycle and new ones are opened, time and resources will not go to them, as the connections are in the pool and they are simply issued each time they are required.  Because of this, the cleaning of classes is a little differently implemented.  In the <i>SqlPerceptionQuestions</i> class <i>, the</i> method will look like this: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> disposing</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.disposed) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SqlDataReader != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { SqlDataReader.Close(); SqlDataReader.Dispose(); } SqlConnection.Close(); SqlConnection.Dispose(); MySqlConnection.ClearAllPools(); } disposed = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre><br>  And in the <i>SqlQuestions</i> class <i>, the</i> exact same, except for the string MySqlConnection.ClearAllPools ();  After all, if we leave it, we get the following situation: <br><br><div class="spoiler">  <b class="spoiler_title">Opening time</b> <div class="spoiler_text"><img src="http://s49.radikal.ru/i125/1503/3b/8ccd7c57215d.jpg" alt="image"></div></div><br>  As we see, the constant cleaning of the thread pool leads to the constant opening of the connection with the ensuing consequences. <br><br><h3>  MySql connection pool </h3><br>  Consider a little more about this moment  Connector / Net MySql supports connection pooling to improve the performance and scalability of application-intensive databases.  This feature is enabled by default.  You can turn it off or change the characteristics using the connection string options.  The connection string supports options relative to the connection pool: <br><br><table><tbody><tr><th>  <nobr>Option Name</nobr> </th><th>  <nobr>Value by</nobr> <nobr><br></nobr>  <nobr>default</nobr> </th><th>  Details </th></tr><tr><td>  Cache Server Properties, CacheServerProperties </td><td>  Disabled </td><td>  Specifies whether to update the parameters of some system variables (SHOW VARIABLES) every time a connection from the pool is returned.  Enabling this option speeds up connection to the connection pool context.  Your application is not informed of configuration changes made by other connections.  This option has been added since Connector / Net 6.3. </td></tr><tr><td>  Connection Lifetime, ConnectionLifeTime </td><td>  0 </td><td>  When a connection is returned to the pool, its creation time is compared with the current time and, if it exceeds the value of ConnectionLifeTime, the connection is destroyed.  This is useful in cluster configurations for load balancing between a production server and a server that is online.  A value of zero (0) makes the connections in the pool stand by for the longest possible time. </td></tr><tr><td>  Connection Reset, ConnectionReset </td><td>  false </td><td>  If true, the connection status is removed from the pool.  The default value avoids the additional processing cycle by the server to receive the connection, but the connection status is not reset. </td></tr><tr><td>  Maximum Pool Size, Max Pool Size, MaximumPoolsize, maxpoolsize </td><td>  100 </td><td>  The maximum number of connections allowed to be in the pool. </td></tr><tr><td>  Minimum Pool Size, Min Pool Size, Minimum Size Size, minpoolsize </td><td>  0 </td><td>  The minimum number of connections allowed to be in the pool. </td></tr><tr><td>  Pooling </td><td>  true </td><td>  If true, then the MySqlConnection object is taken from the pool, if necessary, it is created and added to the corresponding pool.  Specific values: true, false, yes and no. </td></tr></tbody></table><br>  Using these parameters, you can manage the pool as needed.  For example: <br><ul><li>  Connection Reset resets the connection context and if it is used by default, then the time to receive a connection from the pool is slightly increased. </li><li>  Minimum Pool Size allows you to set, if necessary, the number of connections in the pool that will exist indefinitely, if the number of connections is less than or equal to the Minimum Pool Size value. </li><li>  Disabling Pooling will produce the same results if you clear the thread pool all the time (as in the example of this program) </li></ul><br>  By default, starting with MySQL Connector / Net 6.2, there is a background job that runs every three minutes and removes connections from the pool that have been in standby mode (not used) for more than three minutes.  Cleaning the pool frees up resources both on the client and on the server side.  This is because on the client side each connection uses a socket, and on the server side each connection uses a socket and a stream. <br><br><h3>  Parallel call stack </h3><br>  For the sake of interest, if you put a breakpoint, for example, in the .GetQuestion () method and see the parallel call stack, you will see: <br><br><div class="spoiler">  <b class="spoiler_title">Parallel stack</b> <div class="spoiler_text"><img src="http://s019.radikal.ru/i601/1503/1b/2288a568bfab.jpg" alt="image"></div></div><br>  As can be seen from the screenshot, we are in one of the threads that is suspended, and by the call stack we determine that this method was called from the method that loads a small collection of questions (40).  There are 3 more streams to the left of it, and two of them are stopped at this moment on the line of adding a question to the collection, which also process a small collection of questions.  And the last of them, 4th thread, deals with processing and receives an answer at this moment to a question, only for a question from a large collection (120).  All these 4 threads were created in a parallel loop and work almost simultaneously with the rest of the iterations of the loop.  These threads are included in the total number of threads in the program, of which 8, where the remaining 4 solve other tasks of the program. <br><br><h3>  The final touch is exception handling. </h3><br>  And finally, for the program to work, we need exception handling.  Suddenly the fields or some other parameters changed from the database or an unexpected error occurred in the program itself.  Rewrite the GetQuestionAsync () method: <br><br><pre> <code class="hljs javascript">public <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> Task&lt;Dictionary&lt;Int32, List&lt;Question&gt;&gt;&gt; GetQuestionAsync() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Task.Factory.StartNew(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Generation(); GetTheme(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Request(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (AggregateException ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AggregateException(ex.Message, ex.InnerExceptions); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AggregateException(ex.Message, ex.InnerException); } }, TaskCreationOptions.LongRunning); }</code> </pre><br>  Exception handling AggregateException is due to the fact that the Parallel.For loop, if an exception occurs, will raise this type of error and, therefore, it must be processed and passed to the caller.  It is quite logical that a parallel loop generates an error of this kind.  Consider this moment in more detail: for this, I changed the Sql query in .GetQuestion (), knowingly incorrectly specifying one of the parameters that does not exist in the database table.  We get: <br><br><div class="spoiler">  <b class="spoiler_title">Mistake</b> <div class="spoiler_text"><img src="http://s020.radikal.ru/i704/1503/5d/cedafcbfd175.png" alt="image"></div></div><br>  Moreover, if we continue debugging, then the whole exception will occur 4 times, which is quite logical.  In order to handle all 4, even if they are related to the same reason, it is necessary to arrange them somehow, for which the AggregateException exception is suitable. <br><br>  Exception handling is related to the fact that if an exception occurs in the .GetTheme () method, then one exception will be thrown there and it should also be caught. <br><br>  The calling code is arranged as follows: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Button_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoutedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { Stopwatch st = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stopwatch(); st.Start(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { SqlQuest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlPerceptionQuestions(); collectionQuest = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> SqlQuest.GetQuestionAsync(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (AggregateException ex) { ex.ShowError(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception ex) { ex.ShowError(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SqlQuest != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) SqlQuest.Dispose(); } st.Stop(); Debug.WriteLine(<span class="hljs-string"><span class="hljs-string">"  : "</span></span> + st.Elapsed.Seconds.ToString() + <span class="hljs-string"><span class="hljs-string">"  "</span></span> + st.Elapsed.Milliseconds.ToString() + <span class="hljs-string"><span class="hljs-string">" "</span></span>); Debugger.Break(); }</code> </pre><br><br><h3>  Finally ... </h3><br>  In general, it started with the fact that when I wrote a parallel version of the cycle, I thought, how often the frequent opening and closing of the database connection affects.  Visiting forums and asking smart people I learned about the pool of connections.  Then I asked myself a question: is it necessary to create it or is it being created in an implicit form?  I experimented a bit and read the MySQL documentation, and as a result I came to the conclusion that this is a very good thing, a pool of connections! <br><br><div class="spoiler">  <b class="spoiler_title">All code after changes</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">//  <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> abstract <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SqlBase : IDisposable { protected static readonly String <span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>; protected readonly MySqlConnection SqlConnection; protected MySqlDataReader SqlDataReader; protected <span class="hljs-type"><span class="hljs-type">Boolean</span></span> disposed; static SqlBase() { <span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span> = String.Format("Database={0};Data Source={1};User ID={2};Password={3};CharSet=utf8;CacheServerProperties=true", Settings.<span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span>, Settings.<span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>.DataSource, Settings.<span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>.UserId, Settings.<span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>); } protected SqlBase() { Stopwatch st = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Stopwatch(); st.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); try { this.SqlConnection = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> MySqlConnection(<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>); this.SqlConnection.<span class="hljs-keyword"><span class="hljs-keyword">Open</span></span>(); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(ex.Message, ex); } st.Stop(); <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.WriteLine("    : " + st.Elapsed.Seconds.ToString() + "  " + st.Elapsed.Milliseconds.ToString() + " "); } ~SqlBase() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Dispose() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); GC.SuppressFinalize(this); } protected abstract <span class="hljs-type"><span class="hljs-type">void</span></span> Dispose(<span class="hljs-type"><span class="hljs-type">Boolean</span></span> disposing); } //     <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> sealed <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SqlPerceptionQuestions : SqlBase { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task&lt;<span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;Int32, List&lt;Question&gt;&gt;&gt; GetQuestionAsync() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> await Task.Factory.StartNew(() =&gt; { try { Generation(); GetTheme(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Request(); } catch (AggregateException ex) { throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AggregateException(ex.Message, ex.InnerExceptions); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AggregateException(ex.Message, ex.InnerException); } }, TaskCreationOptions.LongRunning); } private <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;Int32, List&lt;Question&gt;&gt; Request() { var _collectionDictionary = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;Int32, List&lt;Question&gt;&gt;(); var _po = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ParallelOptions { MaxDegreeOfParallelism = Environment.ProcessorCount }; Parallel.<span class="hljs-keyword"><span class="hljs-keyword">For</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>, _po, ctr =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var _questions = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SqlQuestions()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctr &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) { _collectionDictionary[ctr] = _questions.GetQuestionSmall((Int16)ctr); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { _collectionDictionary[ctr] = _questions.GetQuestionGreat((Int16)ctr); } } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _collectionDictionary; } private <span class="hljs-type"><span class="hljs-type">void</span></span> GetTheme() { } private <span class="hljs-type"><span class="hljs-type">void</span></span> Generation() { } protected override <span class="hljs-type"><span class="hljs-type">void</span></span> Dispose(<span class="hljs-type"><span class="hljs-type">bool</span></span> disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.disposed) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SqlDataReader != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { SqlDataReader.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>(); SqlDataReader.Dispose(); } SqlConnection.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>(); SqlConnection.Dispose(); MySqlConnection.ClearAllPools(); } disposed = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } //        <span class="hljs-type"><span class="hljs-type">internal</span></span> sealed <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SqlQuestions : SqlBase { <span class="hljs-type"><span class="hljs-type">internal</span></span> List&lt;Question&gt; GetQuestionSmall(Int16 numTheme) { var _listQuestions = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List&lt;Question&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Int16 numCard = <span class="hljs-number"><span class="hljs-number">0</span></span>; numCard &lt; <span class="hljs-number"><span class="hljs-number">40</span></span>; numCard++) { _listQuestions.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(GetQuestion(numCard, numTheme)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _listQuestions; } <span class="hljs-type"><span class="hljs-type">internal</span></span> List&lt;Question&gt; GetQuestionGreat(Int16 numTheme) { var _listQuestions = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List&lt;Question&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Int16 numQuestion = <span class="hljs-number"><span class="hljs-number">0</span></span>; numQuestion &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>; numQuestion++) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> numCard = <span class="hljs-number"><span class="hljs-number">0</span></span>; numCard &lt; <span class="hljs-number"><span class="hljs-number">40</span></span>; numCard++) { _listQuestions.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(GetQuestion(numQuestion, numTheme, numQuestion)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _listQuestions; } private Question GetQuestion(Int16 numCard, Int16 numTheme, Int16 numQuestion = <span class="hljs-number"><span class="hljs-number">0</span></span>) { } private List&lt;String&gt; GetResponse(Int32 questions_id) { } protected override <span class="hljs-type"><span class="hljs-type">void</span></span> Dispose(<span class="hljs-type"><span class="hljs-type">bool</span></span> disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.disposed) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SqlDataReader != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { SqlDataReader.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>(); SqlDataReader.Dispose(); } SqlConnection.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>(); SqlConnection.Dispose(); } disposed = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } }</code> </pre><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/252295/">https://habr.com/ru/post/252295/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252285/index.html">Information braces or what innovative operating room could be</a></li>
<li><a href="../252287/index.html">22 photoshop plug-ins for front-end developer</a></li>
<li><a href="../252289/index.html">Build Krita for Linux for cats</a></li>
<li><a href="../252291/index.html">We tame JavaScript or another bike for frontend applications.</a></li>
<li><a href="../252293/index.html">Show your sites uptime to customers</a></li>
<li><a href="../252297/index.html">Search for typos in the project</a></li>
<li><a href="../252299/index.html">Anatomy Workshop .Net, Roslyn, CoreCLR, CoreFX, Decompilation, Hacking</a></li>
<li><a href="../252301/index.html">Launch the vanilla core on Intel Galileo</a></li>
<li><a href="../252303/index.html">SibSUTIS CTF 2015: How we held our student competitions</a></li>
<li><a href="../252305/index.html">PHPixie 3.0 ORM or new look at ActiveRecord</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>