<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Corona SDK - Crush Crush Game</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We write a simple but very exciting game. The game is called Crush it will need to crush insects, trying to avoid the pressure of the OS, as they take...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Corona SDK - Crush Crush Game</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/4e1/6d7/048/4e16d70486f992eed11f9ab76f52fdec.jpg" alt="image"><br><br>  We write a simple but very exciting game.  The game is called Crush  it will need to crush insects, trying to avoid the pressure of the OS, as they take away points, other insects add points.  All insects have different dimensions of size, reward and speed of movement.  The game is given a certain time so in the skill of the pressure of the correct animals you can easily compete with friends.  The best result is recorded and saved in the game settings. <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/X84P2ttdADQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2>  Project Settings </h2><br>  All project settings are contained in the config.lua and build.settings files.  I decided to delete the entire contents of config.lua, leaving only the line: <br><br> <code>application = { <br> }</code> <br> <br>  Now the project is trying to ‚Äúthink‚Äù on any device that the screen has a fixed size of 320 * 480 (as it was by default), we always work with the current screen resolution.  In the build.settings file, I added a new permission to the <i>settings.android.usesPermissions</i> section that gives the right to buzz with a vibrating signal when touching the wasps, the following line was added: <i>‚Äúandroid.permission.VIBRATE‚Äù</i> , and the system.vibrate () line of code uses these rights. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Entry point main.lua </h2><br>  The theater begins with a hanger, and the project in the crown begins with the first line of the main.lua file.  In this file, it is customary to store global variables and constants, as well as connect to the project the remaining files that will be needed in the project.  At the end of the file, the main project scene is loaded. <br><br>  The full code of the main.lua file is: <br><br><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--[[ ]]</span></span> <span class="hljs-comment"><span class="hljs-comment">-- StatusBar display.setStatusBar (display.HiddenStatusBar) --[[ ]] --  _W = display.contentWidth _H = display.contentHeight font = 'a_LCDNova'--  time_battle = 10--  --   filePath = system.pathForFile( 'config.dat', system.DocumentsDirectory ) composer = require("composer")--    --   path = 'assets/images/' path_interface = path .. 'interface/' path_bugs = path .. 'bugs/' path_plods = path .. 'plods/' --    widget = require( "widget" )--GUI  ls = require "libLoadSave"--/  api = require "libAPI"--  bugs = require "svcBugs"--   finish = require "svcFinish"--  "" game = require "svcGame"--   battle = nil--  ls.load() --      --  game.init()      --scMain ,       composer.gotoScene( "scMain", "crossFade", 0 )</span></span></code> </pre> <br><br><h2>  Main stage </h2><br>  The scMain.lua file is the main scene of the game.  In this project, its use is doubtful, since there is only one scene, but the project is educational and the scene can be useful if you decide to add more scenes in your experiments.  In the main scene, only one action is performed ‚Äî launch the init () function from the libGame library.  And then this function draws the entire permanent interface of the game, i.e.  those parts that will not be deleted until the end of using the application.  The file code is: <br><br><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--------------------------------------- --      -- --------------------------------------- local scene = composer.newScene() scene:addEventListener( "show", scene ) function scene:show( event ) if "will" == event.phase then game.init() end end return scene</span></span></code> </pre> <br><h2>  Service static game components. </h2><br>  This service is stored in the svcGame.lua file and its connection to the project is performed by the line in main.lua: game = require ‚ÄúsvcGame‚Äù ie  Further along the code for calling library functions we add to the name game.  The library has the following functions: <br><br><ul><li>  <i>game.init ()</i> - runs once, this creates the grass, the upper and lower side of the menu, the display components of the current and best results, the game launch button, components showing the battle timer. </li><li>  <i>game.</i>  <i>refresh ()</i> - this function is performed every time there is any change in the parameters of the game, and this is killing an insect ( <i>updating the account</i> ) and the tick of the battle timer ( <i>updating the progress bar</i> ).  The function updates the current status of all indicators. </li><li>  <i>game.</i>  <i>startGame ()</i> - handler for pressing the start button.  The function resets the current result and starts the game timer for the period specified in the constant time_battle.  Insects are created in the timer. </li></ul><br>  Full svcGame.lua code: <br><br><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">------------------------------------------------------- --      -- ------------------------------------------------------- local M = { GR = {},--  GUI = {},--  } --    M.startGame = function(event) if event.phase == 'ended' then --   battle.timer = time_battle battle.cur_score = 0 M.refresh() --  timer.performWithDelay(100, function(event) if event.count%10==0 then-- 10-  --    battle.timer = battle.timer - 1 M.refresh() end if event.count%2==1 then--   --  bugs.create(M.GR.bugs) end if event.count == time_battle*10 then--    --     finish.show() end end,time_battle*10) end end --    M.refresh = function() --   M.GUI.txt_count.text = battle.cur_score --  M.GUI.txt_best.text = battle.best_score ---     M.GUI.pr_txt.text = battle.timer --  M.GUI.pr.width = _W * .79 * (time_battle - battle.timer) / time_battle M.GUI.pr.x = _W * .105 + M.GUI.pr.width * .5 --       0 M.GUI.pr.isVisible = battle.timer &gt; 0 M.GUI.pr_txt.isVisible = battle.timer &gt; 0 M.GUI.pr_bg.isVisible = battle.timer &gt; 0 --       0 M.GUI.btn_start.isVisible = battle.timer == 0 end --  M.init = function() --  M.GR.back = display.newGroup()--   M.GR.bugs = display.newGroup()--   M.GR.front = display.newGroup()--   --[[ ]] -- M.GUI.bg = display.newImage(M.GR.back,path_interface..'bg.jpg', _W*.5, _H * .5) M.GUI.bg.width = _W M.GUI.bg.height = _H --[[ ]] --   M.GUI.up = display.newRect(M.GR.front, _W * .5, _H * .05, _W, _H * .1) M.GUI.up.strokeWidth = _H * .01 M.GUI.up:setStrokeColor(0,.5,0) M.GUI.up:setFillColor(0,.3,0) M.GUI.up:addEventListener('touch', function() return true end)--     --      M.GUI.img_count = display.newImage(M.GR.front, path_interface..'count.png', _H * .06, _H * .05) local img = M.GUI.img_count img.width = _H * .07 img.height = _H * .07 --      M.GUI.txt_count = display.newText(M.GR.front, '', _W * .3, _H * .05, font, _W * .1) --   M.GUI.img_best = display.newImage(M.GR.front, path_interface..'best.png', _W * .5 + _H * .06, _H * .05) local img = M.GUI.img_best img.width = _H * .07 img.height = _H * .07 --text   M.GUI.txt_best = display.newText(M.GR.front, '', _W * .8, _H * .05, font, _W * .1) --   M.GUI.down = display.newRect(M.GR.front, _W * .5, _H * .95, _W, _H * .1) M.GUI.down.strokeWidth = _H * .01 M.GUI.down:setStrokeColor(0,.5,0) M.GUI.down:setFillColor(0,.3,0) M.GUI.down:addEventListener('touch', function() return true end) --  M.GUI.btn_start = widget.newButton( { width = _H * .07, height = _H * .07, defaultFile = path_interface .. "btn_start_1.png", overFile = path_interface .. "btn_start_2.png", onEvent = M.startGame, x = _W * .5, y = _H * .95, } ) --  --   M.GUI.pr_bg = display.newRoundedRect(M.GR.front, _W * .5, _H * .95, _W * .8, _H * .04, _H * .01) M.GUI.pr_bg.strokeWidth = _H * .005 M.GUI.pr_bg:setStrokeColor(0,.5,0) M.GUI.pr_bg:setFillColor(.4,.7,.4) --  M.GUI.pr = display.newRoundedRect(M.GR.front, _W * .5, _H * .95, _W * .79, _H * .035, _H * .006) M.GUI.pr:setFillColor(.7,.1,.1) --       M.GUI.pr_txt = display.newText(M.GR.front, '', _W * .5, _H * .955, font, _W * .07) M.GUI.pr_txt:setFillColor(0) --   M.refresh() end return M</span></span></code> </pre> <br><h2>  Insect creation service </h2><br>  The service has several components that serve the ability to conveniently create living creatures in the game: <br><br><ul><li>  <i>bugs.bugs</i> - insect settings.  Insect can be customized by increasing or decreasing its availability. </li><li>  <i>bugs.create</i> - an insect is created, its path trajectory is calculated, it sets off.  Each insect has a handler that makes the insect impenetrable for cliques, i.e.  you cannot kill this insect and the one under it with one click.  The handler also removes the insect when it clicks, updates the game score and calls the function of creating a new insect, if you often kill insects, their number will increase faster than if you just look at them. </li><li>  <i>bugs.plod</i> - creates a blot at the place of death of the insect.  The blot is removed by itself in half a second. </li></ul><br>  The service code svcBugs.lua is: <br><br><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">------------------------------------------------ --    , -- --      -- --      -- ------------------------------------------------ local M = { GR = {},-- bugs = {--  -- { size = {20,30},--  - %   bonus = 2,--   file = '1.png',--   speed = {30,50},--   - %     }, -- { size = {25,35}, bonus = 3, file = '2.png', speed = {50,70}, }, --  { size = {15,25}, bonus = 3, file = '3.png', speed = {40,60}, }, -- { size = {20,30}, bonus = 6, file = '4.png', speed = {60,80}, }, -- { size = {35,50}, bonus = -10,--  =  file = '5.png', speed = {25,50}, }, }, AR_BUGS = {},--    } --  M.plod = function(obj) local count_plod = 3--   --   local blod = display.newImage(M.GR, path_plods..math.random(count_plod)..'.png',obj.x, obj.y) --      blod.width = obj.width blod.height = obj.height --  (  ) blod:setFillColor(math.random(),0,math.random()) --   transition.to(blod,{time = 500, alpha = 0, onComplete = function() --     display.remove(blod) end}) end --  M.create = function(GR) M.GR = GR and GR or M.GR --    local sets = M.bugs[math.random(#M.bugs)] --    local bug_sets = { file = sets.file, bonus = sets.bonus, size = (math.random(sets.size[1],sets.size[2]) / 100) * _W, speed = (math.random(sets.speed[1],sets.speed[2]) / 100) * _W, } --      local ar = {--       2  {x1 = 0, y1 = 0, x2 = _W, y2 = 0}, -- {x1 = 0, y1 = _H, x2 = _W, y2 = _H}, -- {x1 = -_H*.1, y1 = _H*.1, x2 = -_H*.1, y2 = _H*.9}, -- {x1 = _H*1.1, y1 = _H*.1, x2 = _H*1.1, y2 = _H*.9}, -- } -- 2  local l1,l2 = math.random(#ar),math.random(#ar) if l1 == l2 then if l2 == 1 then l2 = math.random(2,#ar) else l2 = l2 - 1 end end --   local x1,y1 = api.get_xy_line(ar[l1]) local x2,y2 = api.get_xy_line(ar[l2]) --  local n = #M.AR_BUGS+1 M.AR_BUGS[n] = display.newImage(M.GR, path_bugs..bug_sets.file, 0, 0) M.AR_BUGS[n].width = bug_sets.size M.AR_BUGS[n].height = bug_sets.size M.AR_BUGS[n].x = x1 M.AR_BUGS[n].y = y1 M.AR_BUGS[n].sets = bug_sets M.AR_BUGS[n].rotation = api.get_angle{x1 = x1, y1 = y1, x2 = x2, y2 = y2}--    M.AR_BUGS[n]:addEventListener('touch',function(event) if event.phase == 'began' then api.play_sound('tits') M.plod(event.target) local sets = event.target.sets battle.cur_score = battle.cur_score + sets.bonus if sets.bonus &lt; 0 then--    system.vibrate()--;) end game.refresh() M.create() display.remove(event.target) end return true end) --    local len = api.get_line_len{x1 = x1, y1 = y1, x2 = x2, y2 = y2}--  local t = len / bug_sets.speed * 1000--   transition.to(M.AR_BUGS[n],{time = t, x = x2, y = y2, onComplete = function() display.remove(M.AR_BUGS[n]) end}) end return M</span></span></code> </pre> <br><h2>  Service "Finish" </h2><br>  This simple service has only one function, finish.show (), which is called in the battle timer when the end of the battle is reached.  This function removes all insects and opens the form with the output of the result.  If the result is higher than the past, the text ‚ÄúNEW SCORE‚Äù is displayed.  Under the form, a protective layer is created that does not allow the game to be restarted until the window is closed.  When you click on the window, it closes the result of saving to the settings file.  Service code is: <br><br><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">------------------------------------------------ --       -- ------------------------------------------------ local M = { GUI = {}, GR = {}, } --  M.show = function() api.play_sound('win') --   for k,v in pairs(bugs.AR_BUGS) do display.remove(bugs.AR_BUGS[k]) end --    local is_new_score = battle.cur_score &gt; battle.best_score if is_new_score then battle.best_score = battle.cur_score end --    M.GR = display.newGroup() --   M.GUI.safe = display.newRect(M.GR, _W * .5, _H * .5, _W, _H) M.GUI.safe.alpha = .5 M.GUI.safe:setFillColor(0) M.GUI.safe:addEventListener('touch', function() return true end) --     M.GUI.wnd = display.newRoundedRect(M.GR, _W * .5, _H * .5, _W * .5, _H * .2, _H * .01) M.GUI.wnd.strokeWidth = _H * .005 M.GUI.wnd:setStrokeColor(0,.5,0) M.GUI.wnd:setFillColor(0,.3,0) M.GUI.wnd:addEventListener('touch',function(event) if event.phase == 'began' then display.remove(M.GR) end end) M.GUI.txt_1 = display.newText(M.GR, 'FINISH', _W * .5, _H * .45, font, _W * .07) M.GUI.txt_2 = display.newText(M.GR, 'NEW SCORE', _W * .5, _H * .5, font, _W * .07) M.GUI.txt_2:setFillColor(1,1,0) M.GUI.txt_2.isVisible = is_new_score M.GUI.txt_2 = display.newText(M.GR, 'SCORE: '..battle.cur_score, _W * .5, _H * .55, font, _W * .07) game.refresh() ls.save()--  end return M</span></span></code> </pre> <br><h2>  Library of storing and loading settings </h2><br>  This simple library contains two functions that allow you to store the result between gaming sessions. <br><br><ul><li>  <i>ls.load ()</i> - is performed once at the start of the game and if this start is the first, a save template is created, if not the first one loads the result of previous games. </li><li>  <i>ls.save ()</i> - executed after each battle, while the current result is saved to a file. </li></ul><br>  Settings are stored in the config.dat file in json format.  The library code is: <br><br><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">------------------------------------- --    -- --     -- ------------------------------------- local M = {} local json = require("json") M.tmp_battle = { cur_score = 0,--  best_score = 0,--  timer = 0,--    } --     M.save = function(new) local file = io.open(filePath, "w") if file then local write_data = '' write_data = json.encode(battle) file:write( write_data ) io.close( file ) end end --     M.load = function() local str = "" local file = io.open( filePath, "r" ) --   if file then local read_data = file:read("*a") battle = json.decode(read_data) io.close( file ) --   else battle = M.tmp_battle M.save() end end return M</span></span></code> </pre> <br>  Library of universal functions. <br><br>  Here all the functions that are needed in the game are stored but explicitly do not apply to any module and can later be used for other purposes.  The following functions are available: <br><br><ul><li>  <i>api.play_sound</i> - plays a music file (.wav) located in assets / music / whose name is transferred in the parameter </li><li>  <i>api.get_xy_line</i> - returns the coordinates of a random point lying on a segment of two points passed in the parameter.  The function is used to generate random start and end points of insect movement. </li><li>  <i>api.get_line_len</i> - returns the length of the segment transmitted by two points.  The function is used when calculating the time in the path of an insect through the length and speed. </li><li>  <i>api.get_angle</i> - defines the angle between the first transmitted point from which the beam is directed upwards and the beam directed to the second point.  The function is used to determine the angle of rotation of the insect image. </li></ul><br><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--------------------------------------------------- --      -- --------------------------------------------------- local M = {} --  M.play_sound = function(track) local msg = audio.loadSound("assets/music/" .. track .. ".wav") audio.play( msg,{ loops = 0, oncomplete = function(e) audio.dispose(e.handle); e.handle = nil; end}) end --  ,        M.get_xy_line = function(line) local x1,y1,x2,y2 = line.x1,line.y1,line.x2,line.y2 local x,y = 0,0 if x1 == x2 then x = x1 y = math.random(y1,y2) else y = y1 x = math.random(x1,x2) end return x,y end --  M.get_line_len = function(p) --‚àö ((X2-X1)¬≤+(Y2-Y1)¬≤) local len = math.sqrt((p.x2 - p.x1)^2 + (p.y2 - p.y1)^2) return len end --    M.get_angle = function(p) return ((math.atan2(p.y1 - p.y2, p.x1-p.x2) / (math.pi / 180)) + 270) % 360 end return M</span></span></code> </pre> <br><h2>  Conclusion </h2><br>  The full source of the game presented in the article you will find in <a href="">here.</a> <br><br>  If your knowledge of the Lua language does not allow you to confidently read the source, you can read <a href="https://habrahabr.ru/post/344304/">my article</a> on this issue. <br><br>  The article was prepared for you by Denis Goncharov aka <a href="http://vk.com/execom">execom</a> <br>  Good luck to all! </div><p>Source: <a href="https://habr.com/ru/post/344638/">https://habr.com/ru/post/344638/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344626/index.html">We understand and work with gulp</a></li>
<li><a href="../344628/index.html">Veritas Access 7.3: pros, cons, pitfalls</a></li>
<li><a href="../344630/index.html">Tutorial on creating a tracker cryptocurrency for android on Kotlin</a></li>
<li><a href="../344632/index.html">SOC for beginners. How to organize monitoring of incidents and response to attacks in the 24x7 mode</a></li>
<li><a href="../344634/index.html">ATOL Online Online Cash Desk Service: API and CMS Integration</a></li>
<li><a href="../344640/index.html">Mail for Good: how the community of programmers helps NGOs</a></li>
<li><a href="../344642/index.html">Something is wrong with the IDS signature</a></li>
<li><a href="../344644/index.html">Dynamic sound on destructible levels of Rainbow Six: Siege</a></li>
<li><a href="../344648/index.html">Born to intercept traffic</a></li>
<li><a href="../344650/index.html">This is Sparta</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>