<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Detectable virtual machine in C #: 1 level</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One creepiness of how a cool January morning brought a question from a friend - how in C # to determine whether the program is running on the OS (wind...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Detectable virtual machine in C #: 1 level</h1><div class="post__text post__text-html js-mediator-article"><p>  One creepiness of how a cool January morning brought a question from a friend - how in C # to determine whether the program is running on the OS (window application on Windows 7 or later) on the virtual machine. </p><br><p>  The requirements for such a detector were quite tough: <br><br></p><ol><li>  Must be completely in source code, </li><li>  Must be built using Visual Studio </li><li>  It should work from under the account of an unprivileged user (you cannot use methods that require, for example, installation of device drivers, or other operations that require administrator rights), </li><li>  Allowed to use the .NET Framework 4.5 and no unnecessary dependencies (such as Visual C ++ Redistributable Package). </li></ol><p></p><br><p>  Under the description of the description of the implemented detector in C # (in the next part - with some elements of C ++) <u>and a decent amount of indecent code</u> using the Visual Studio 2015 Community. </p><br><h3>  Publication structure </h3><br><ul><li>  1 level.  Studying the hardware and the simplest existing solutions: <br><br><ul><li>  some theory about virtualization, </li><li>  implement VM validation using data from Windows Management Instrumentation (WMI). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </li></ul></li><li>  2nd level.  Search for articles and publications about launch detection in virtual machines: <br><br><ul><li>  we finish the implementation with WMI, </li><li>  work with the CPUID instruction. <br><br></li></ul></li><li>  Level 3  Search for materials from hacker conferences: <br><br><ul><li>  dopilivaem work with CPUID, </li><li>  make a summary table of parameters and test results. </li></ul></li></ul><a name="habracut"></a><br><h3>  1 level.  The study of materials and existing solutions </h3><br><h4>  A bit of theory about virtualization. </h4><br><p>  Before attempting to write a <strike>spherical horse</strike> detector <strike>in a</strike> virtual machine <strike>vacuum</strike> , it is necessary to briefly indicate how, as part of the task, we understand the term ‚Äúvirtual machine‚Äù. </p><br><p>  The concept of virtualization can be divided into two categories ( <a href="https://habr.com/ru/post/322486/">1</a> ): <br><br></p><ul><li>  The first is <b>resource virtualization</b> .  Let's take a living example, why the principle of the Dropbox file storage service can be interpreted as resource virtualization: <br><br><ol><li>  We know exactly how to load / unload files, and how to interact with the service, but we can‚Äôt say how it all works inside =&gt; <u>encapsulation</u> . </li><li>  Each user has his own unique account, each account has a quota for the size of saved files, for each account, you can configure access permissions individually (although in fact the data of different users may well be stored on the same storage medium) =&gt; <u>sharing of resources</u> . </li><li>  Most likely, under the hood of Dropbox is not one or two computers, but at least a couple of hundred servers that operate and process commands from clients within the Dropbox system as a whole =&gt; <u>clustering</u> . <br><br></li></ol></li><li>  The second - <b>platform virtualization</b> - the creation of software systems based on existing hardware and software systems, dependent on or independent from them ( <a href="https://habr.com/ru/post/322486/">1</a> ). </li></ul><p></p><br><p>  In the second category, we immediately introduce two terms: a system that provides hardware resources and software for virtualization (host system, host) and an emulated system (guest system, guest). </p><br><p>  At the same time, in reality, the role of a ‚Äúguest system‚Äù can be: <br><br></p><ol><li>  Absolutely all the hardware and software of the emulated system - this type of virtualization is called <u>full emulation</u> or <u>simulation</u> .  Examples of programs that provide this type of virtualization: Bochs, QEMU. <br><br></li><li>  All software and only part of the hardware (part sufficient to ensure the isolation of the guest system) - this type of virtualization is called <u>partial emulation</u> or <u>native virtualization</u> .  Examples of programs that provide this type of virtualization: VMWare Workstation, VMWare ESXi, Microsoft Hyper-V, Oracle VirtualBox. <br><br></li><li>  There are also <u>partial virtualization</u> , <u>paravirtualization</u> , <u>operating system</u> <u>level virtualization, and application level virtualization</u> .  In all three cases, we physically have one OS, and guest systems are either individual processes or separate groups of processes (for example, user-mode processes). </li></ol><p></p><br><p>  The result of this excursion: <b>in the framework of the article and the creation of a virtual machine detector, we will be interested only in native platform virtualization</b> (that is, we will only check the launch in the Hyper-V, VirtualBox or other programs using native virtualization).  Moreover, the term ‚Äúvirtual machine‚Äù will be interpreted according to the definition from the VMWare site: ‚Äúthis is a strictly isolated software container containing the operating system and applications‚Äù ( <a href="https://habr.com/ru/post/322486/">2</a> ). </p><br><h4>  Implement VM Validation with Data from Windows Management Instrumentation (WMI) </h4><br><p>  After the goal (determination of the fact of the program's work in the environment with partial emulation) was more or less specified, we find the most famous virtual machines of this type (hereinafter referred to as VM for short) and ways to distinguish the launch of the OS on real hardware from the launch surrounded by these VMs. </p><br><p>  After reading the remarkably minted advertising pages of the developers of popular virtualization programs, a certain general scheme of their work emerges in my head (of course, the scheme of the programs, and not the developers): </p><br><p></p><ul><li>  There is a host OS.  Without loss of generality, we will assume that she is alone. </li><li>  On the host OS, a program is installed to provide virtualization (hereinafter referred to as the hypervisor). </li><li>  The hypervisor provides an interface for the installation and subsequent operation of the guest OS. </li></ul><br>  <u>Note</u> : there are cases when the host OS and the hypervisor are a single thin whole, which allows to reduce the expenditure of computer resources compared to using the host OS and the hypervisor separately (examples: VMWare ESXi or Windows Hyper-V Server). <p></p><br><p>  Only in practice, almost every hypervisor has the opportunity to install guest additions (guest additions) - a special set of programs and drivers that give the hypervisor <br>  advanced control of the guest OS functions (checking whether the guest OS is stuck, dynamic change of the available operating system RAM, "common" mouse for the host and guest OS).  However, how do they implement such an action, if, according to the advertisement, ‚ÄúVM is a strictly isolated software container‚Äù? </p><br><p>  It turns out that the guest add-ons installed on the guest OS interact in some strictly defined way directly with the hypervisor running in the host OS.  That is, if the VM definition program can take advantage of this interaction, it will prove that the OS is running on the VM!  However, under the terms of the problem, the proof must be carried out from under the User-Mode without using its own drivers ... </p><br><p>  Immediately loom the following places to check: <br><br></p><ul><li>  Search for certain equipment in the system, which simply cannot be on a physical machine. </li><li>  Search for hardware interfaces that are implemented only in VM (or vice versa, only on a physical machine). </li></ul><br>  Actually, if you enter in the search line "detect hyper-v C #" or "detect vmware C #", you come across something like this, it remains only to summarize. <p></p><br><p>  The most complete description of the various verification criteria was found in the 2013 article in the Hacker magazine ( <a href="https://habr.com/ru/post/322486/">3</a> ) - take the article as a basis.  And to get the relevant data about the hardware and processes of the OS, we will use the Windows Management Instrumentation (WMI) mechanism - literally ‚ÄúWindows management tools‚Äù.  In particular, using WMI you can easily, quickly and without administrator rights obtain a large amount of information about the hardware that the OS sees. </p><br><p>  To get data through WMI, we need to build a query in WQL (WMI Query Language), which is essentially a very simplified SQL.  For example, if we want to obtain information about the processors in the OS via WMI, the following query is required: </p><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Win32_Processor</code> </pre> <br><p>  The answer to this query is a set of objects of the Win32_Processor type with previously known field names (see <a href="https://habr.com/ru/post/322486/">4 for a</a> detailed list of available fields and classes).  Of course, if we do not need all-all fields, instead of * you can list only the necessary ones separated by commas.  In the WQL SELECT statement, by analogy with SQL, the WHERE condition is also supported, allowing you to select only by objects whose values ‚Äã‚Äãin the fields satisfy the specified conditions. </p><br><p>  For the "seed", let's learn how to get the following data from WMI-objects of the following types (data and expected values ‚Äã‚Äãin VM are taken from <a href="https://habr.com/ru/post/322486/">3</a> ): </p><table border="1"><tbody><tr><th colspan="2">  WMI object and its properties </th><th>  Condition on WQL object query </th><th>  How to use </th></tr><tr><th colspan="3">  Win32_Processor </th><td></td></tr><tr><td></td><td>  Manufacturer </td><td></td><td>  In the case of VirtualBox, it is equal to 'VBoxVBoxVBox', in the case of VMWare - 'VMwareVMware', in the case of Parallels - 'prl hyperv'. </td></tr><tr><th colspan="3">  Win32_BaseBoard </th><td></td></tr><tr><td></td><td>  Manufacturer </td><td></td><td>  In the case of Hyper-V, it is equal to 'Microsoft Corporation', despite the fact that Microsoft does not release motherboards (I <b>wonder, what does this parameter show on Microsoft Surface tablets</b> ?). </td></tr><tr><th colspan="3">  Win32_DiskDrive </th><td></td></tr><tr><td></td><td>  PNPDeviceID </td><td></td><td>  In the case of VirtualBox it contains 'VBOX_HARDDISK', in the case of VMWare it contains 'VEN_VMWARE'. </td></tr><tr><th colspan="3">  Win32_NetworkAdapter </th><td></td></tr><tr><td></td><td>  MACAddress </td><td>  PhysicalAdapter = 1 </td><td>  It is known that a manufacturer can be identified by the three upper bytes of the MAC address ‚Äî and the virtual machine manufacturers are no exception (that is, if the adapter has the PhysicalAdapter = 1 attribute but has the MAC address from the VMWare pool, then the program was most likely running on the VM). </td></tr><tr><th colspan="3">  Win32_Process </th><td></td></tr><tr><td></td><td>  Name </td><td></td><td>  When installing guest add-ons on a VM, additional processes with known names appear in the system. </td></tr></tbody></table><br><p>  We realize the acquisition of equipment data via WMI in a separate project in the form of the TTC.Utils.Environment library. </p><br><p>  We structure the project as follows: <br><br></p><ol><li>  <b>Entities</b> are objects with data (entities) received from WMI. </li><li>  <b>Services</b> - services;  for example, a service that encapsulates interaction with a .NET WMI wrapper. </li><li>  <b>Interfaces</b> - interfaces;  for example, the WMI service interface. </li><li>  <b>Queries</b> are objects containing WMI query parameters that are used to extract the specified entity types. </li></ol><p></p><br><p>  I would like the user of this library to write something like this code: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bios = wmiService.QueryFirst&lt;WmiBios&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WmiBiosQuery()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> processors = wmiService.QueryAll&lt;WmiProcessor&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WmiProcessorQuery());</code> </pre> <br><p>  and did not worry about the mechanism of interacting with WMI, building a query, or transforming the response into a strongly typed C # language class. </p><br><p>  Well, to implement this is actually not very difficult. </p><br><p>  First, we connect a link to the System.Management library to the project (it contains the .NET classes for accessing WMI).  Next, we describe the IWmiService service interface (the implementation of this interface will extract data and convert it into strongly typed objects): <br><br></p><div class="spoiler">  <b class="spoiler_title">IWmiService.cs Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     Windows Management Instrumentation (WMI). </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public interface IWmiService { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">        WMI. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TResult"&gt;</span></span></span><span class="hljs-comment"> ,     .</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="wmiQuery"&gt;</span></span></span><span class="hljs-comment">,   WMI-.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment">   .</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> TResult QueryFirst</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TResult&gt;</span></span></span><span class="hljs-comment">(WmiQueryBase wmiQuery) where TResult : class, new(); </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">        WMI. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TResult"&gt;</span></span></span><span class="hljs-comment"> ,     .</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="wmiQuery"&gt;</span></span></span><span class="hljs-comment">,   WMI-.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment">    .</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> IReadOnlyCollection</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TResult&gt;</span></span></span><span class="hljs-comment"> QueryAll</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TResult&gt;</span></span></span><span class="hljs-comment">(WmiQueryBase wmiQuery) where TResult : class, new(); }</span></span></code> </pre> <br></div></div><br>  Now we will install as entities in our project will look.  Suppose for detection we need the following fields from WMI objects of type Win32_BaseBoard: <br><br><div class="spoiler">  <b class="spoiler_title">Code WmiBaseBoard.cs - to</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WmiBaseBoard</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Manufacturer { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Product { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> SerialNumber { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <br></div></div><br>  Ideally, you need to write DTO in order to use it to translate data from the result of a WML query into the above entity, but if you postulate that the properties of the entities in the project will 1 to 1 correspond to the fields of the objects from the results of the WML query, then doing DTO for each entity means write a lot of monotonous code. <p></p><br><p>  Let's use the main property of any programmer (laziness) and instead of creating a full-fledged DTO, we simply mark each property with the following attribute, allowing us to associate the property and the result field of the WML query: <br><br></p><div class="spoiler">  <b class="spoiler_title">WmiResultAttribute.cs Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> ,       WMI. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [AttributeUsage(AttributeTargets.Property)] public class WmiResultAttribute : Attribute { public WmiResultAttribute(string propertyName) { PropertyName = propertyName; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     WMI. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public string PropertyName { get; } }</span></span></code> </pre> <br></div></div><p></p><br><p>  Having marked the properties of the entity with the specified attributes, we get: <br><br></p><div class="spoiler">  <b class="spoiler_title">Code WmiBaseBoard.cs - after</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WmiBaseBoard</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> MANUFACTURER = <span class="hljs-string"><span class="hljs-string">"Manufacturer"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PRODUCT = <span class="hljs-string"><span class="hljs-string">"Product"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> SERIAL_NUMBER = <span class="hljs-string"><span class="hljs-string">"SerialNumber"</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ReSharper disable UnusedAutoPropertyAccessor.Local [WmiResult(MANUFACTURER)] public string Manufacturer { get; private set; } [WmiResult(PRODUCT)] public string Product { get; private set; } [WmiResult(SERIAL_NUMBER)] public string SerialNumber { get; private set; } // ReSharper restore UnusedAutoPropertyAccessor.Local }</span></span></code> </pre> <br></div></div><p></p><br><p>  It remains to deal with the object that will store the request.  I'm sure you noticed that in the previous code example, the names of the fields of the WQL query results are in internal-constants.  This was done on purpose so as not to duplicate them in the request class.  By the way, an interesting side effect has turned out - with the use of such a model, you cannot read the data from the WMI field of a certain WMI object until you specify in which property of which entity it should be extracted. <br><br></p><div class="spoiler">  <b class="spoiler_title">WmiQueryBase.cs Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Management; <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">       WMI. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public class WmiQueryBase { private readonly SelectQuery _selectQuery; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    WMI. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="className"&gt;</span></span></span><span class="hljs-comment"> ,    .</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="condition"&gt;</span></span></span><span class="hljs-comment"> .</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="selectedProperties"&gt;</span></span></span><span class="hljs-comment">  .</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> protected WmiQueryBase(string className, string condition = null, string[] selectedProperties = null) { _selectQuery = new SelectQuery(className, condition, selectedProperties); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    SELECT-  WMI. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> internal SelectQuery SelectQuery { get { return _selectQuery; } } }</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">WmiBaseBoardQuery.cs code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> TTC.Utils.Environment.Entities; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WmiBaseBoardQuery</span></span> : <span class="hljs-title"><span class="hljs-title">WmiQueryBase</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WmiBiosQuery</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Win32_BaseBoard"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span><span class="hljs-function"><span class="hljs-params">, new[] { WmiBios.MANUFACTURER, WmiBios.PRODUCT, WmiBios.SERIAL_NUMBER, }</span></span></span><span class="hljs-function">)</span></span> { } }</code> </pre> <br></div></div><p></p><br><p>  With this class structure * Query, there is only one nuisance: it is inconvenient to form the parameters of the WHERE part of a WML query inside the class.  We have to act in the old fashioned way and with pens to form a string depending on the parameters: <br><br></p><div class="spoiler">  <b class="spoiler_title">WmiNetworkAdapterQuery.cs Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> TTC.Utils.Environment.Entities; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WmiNetworkAdapterQuery</span></span> : <span class="hljs-title"><span class="hljs-title">WmiQueryBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] COLUMN_NAMES = { WmiNetworkAdapter.GUID, WmiNetworkAdapter.MAC_ADDRESS, WmiNetworkAdapter.PNP_DEVICE_ID, }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WmiNetworkAdapterQuery</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">WmiNetworkAdapterType adapterType = WmiNetworkAdapterType.All</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Win32_NetworkAdapter"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span><span class="hljs-function"><span class="hljs-params">, COLUMN_NAMES</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (adapterType == WmiNetworkAdapterType.Physical) SelectQuery.Condition = <span class="hljs-string"><span class="hljs-string">"PhysicalAdapter=1"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (adapterType == WmiNetworkAdapterType.Virtual) SelectQuery.Condition = <span class="hljs-string"><span class="hljs-string">"PhysicalAdapter=0"</span></span>; } }</code> </pre> <br></div></div><p></p><br><p>  Well: the data on the entities was scattered, they learned to write requests with sin-in half, it remains only to figure out how the service will work, which works with the specified classes: <br><br></p><div class="spoiler">  <b class="spoiler_title">WmiService.cs Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    Windows Management Instrumentation (WMI). </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public class WmiService : IWmiService { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">         WMI   . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TResult"&gt;</span></span></span><span class="hljs-comment"> ,     .</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="managementObject"&gt;</span></span></span><span class="hljs-comment">,     WMI.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment">   .</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> private static TResult Extract</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TResult&gt;</span></span></span><span class="hljs-comment">(ManagementBaseObject managementObject) where TResult : class, new() { var result = new TResult(); foreach (var property in typeof(TResult).GetProperties()) { var wmiAttribute = (WmiResultAttribute)Attribute.GetCustomAttribute(property, typeof(WmiResultAttribute)); if (wmiAttribute != null) { var sourceValue = managementObject.Properties[wmiAttribute.PropertyName].Value; var targetType = Nullable.GetUnderlyingType(property.PropertyType) ?? property.PropertyType; object targetValue; if (sourceValue == null) { targetValue = null; } else if (targetType == typeof(DateTime)) { targetValue = ManagementDateTimeConverter.ToDateTime(sourceValue.ToString()).ToUniversalTime(); } else if (targetType == typeof(Guid)) { targetValue = Guid.Parse(sourceValue.ToString()); } else { targetValue = Convert.ChangeType( managementObject.Properties[wmiAttribute.PropertyName].Value, targetType); } property.SetValue(result, targetValue); } } return result; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">        WMI. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="selectQuery"&gt;</span></span></span><span class="hljs-comment">   .</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="searcher"&gt;</span></span></span><span class="hljs-comment">      WMI.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment">    .</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> private ManagementObjectCollection QueryAll(SelectQuery selectQuery, ManagementObjectSearcher searcher = null) { searcher = searcher ?? new ManagementObjectSearcher(); searcher.Query = selectQuery; return searcher.Get(); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">         WMI. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="selectQuery"&gt;</span></span></span><span class="hljs-comment">   .</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="searcher"&gt;</span></span></span><span class="hljs-comment">      WMI.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment">    .</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> private ManagementBaseObject QueryFirst(SelectQuery selectQuery, ManagementObjectSearcher searcher = null) { return QueryAll(selectQuery, searcher).Cast</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;ManagementBaseObject&gt;</span></span></span><span class="hljs-comment">().FirstOrDefault(); } public TResult QueryFirst</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TResult&gt;</span></span></span><span class="hljs-comment">(WmiQueryBase wmiQuery) where TResult : class, new() { var managementObject = QueryFirst(wmiQuery.SelectQuery); return managementObject == null ? null : Extract</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TResult&gt;</span></span></span><span class="hljs-comment">(managementObject); } public IReadOnlyCollection</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TResult&gt;</span></span></span><span class="hljs-comment"> QueryAll</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TResult&gt;</span></span></span><span class="hljs-comment">(WmiQueryBase wmiQuery) where TResult : class, new() { var managementObjects = QueryAll(wmiQuery.SelectQuery); return managementObjects?.Cast</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;ManagementBaseObject&gt;</span></span></span><span class="hljs-comment">() .Select(Extract</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TResult&gt;</span></span></span><span class="hljs-comment">) .ToList(); } }</span></span></code> </pre> <br></div></div><p></p><br><p>  A few words regarding the WmiService.Extract &lt;TResult&gt; method. <br><br>  WMI objects usually have a fairly large number of properties (and many fields can be NULL).  Assuming that, within the framework of the task, we are going to unload only a small number of object properties from WMI, it is logical to start mapping data by sorting the properties of the resulting entity.  Further, if the attribute attribute WmiResultAttribute is present, we read the value of the property with the name specified in the attribute from the query result object and perform type conversion.  At the same time, if an entity property has a type with which the standard Convert.ChangeType method does not cope or converts the type not in the way we want, we can easily transfer control to our transformation (as was done for the System.DateTime and System.Guid types) . </p><br><p>  By the way, it would be even better to split Extract into two methods: the first extracts information from the class type, the second fills the instances (otherwise the QueryAll method for the second and subsequent elements of the output collection does unnecessary work on re-studying the structure of its type).  But specifically for the purpose of detecting a virtual machine, we are unlikely to expect more than 10 objects per request, so I propose to write off this task with the note "not implemented, for natural laziness."  But if someone gets their hands on such a modification, I will gladly accept your revision. </p><br><h3>  Afterword </h3><br><p>  In order not to finish this part of the article only with the library, we will make the simplest application that uses the capabilities of this library to detect several of the most popular VMWare, Microsoft, Parallels and Oracle virtual machines based on the above criteria. </p><br><p>  Create a separate project - a console application TTC.Utils.VMDetect and create in it the following class DemoTrivialVmDetector: <br><br></p><div class="spoiler">  <b class="spoiler_title">WmiService.cs Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">      - . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> class DemoTrivialVmDetector { private readonly IWmiService _wmiService; public DemoTrivialVmDetector(IWmiService wmiService) { _wmiService = wmiService; } public MachineType GetMachineType() { var wmiProcessor = _wmiService.QueryFirst</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;WmiProcessor&gt;</span></span></span><span class="hljs-comment">(new WmiProcessorQuery()); if (wmiProcessor.Manufacturer != null) { if (wmiProcessor.Manufacturer.Contains("VBoxVBoxVBox")) return MachineType.VirtualBox; if (wmiProcessor.Manufacturer.Contains("VMwareVMware")) return MachineType.VMWare; if (wmiProcessor.Manufacturer.Contains("prl hyperv")) return MachineType.Parallels; } var wmiBaseBoard = _wmiService.QueryFirst</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;WmiBaseBoard&gt;</span></span></span><span class="hljs-comment">(new WmiBaseBoardQuery()); if (wmiBaseBoard.Manufacturer != null) { if (wmiBaseBoard.Manufacturer.Contains("Microsoft Corporation")) return MachineType.HyperV; } var wmiDiskDrives = _wmiService.QueryAll</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;WmiDiskDrive&gt;</span></span></span><span class="hljs-comment">(new WmiDiskDriveQuery()); if (wmiDiskDrives != null) foreach (var wmiDiskDrive in wmiDiskDrives) { if (wmiDiskDrive.PnpDeviceId.Contains("VBOX_HARDDISK")) return MachineType.VirtualBox; if (wmiDiskDrive.PnpDeviceId.Contains("VEN_VMWARE")) return MachineType.VMWare; } return MachineType.Unknown; } }</span></span></code> </pre> <br></div></div><p></p><br><p>  All code, including the library and the simplest test application, is laid out in the <a href="https://github.com/SLenik/vmdetect/tree/756679c0613ab243e9aac46938612fb3386a04cd">repository on github</a> , feedback and comments are welcome. </p><br><p>  <b>In the next part, we are sensitively structuring work with known VMs and using the CPUID assembler instructions we will try to detect already unknown VMs.</b> </p><a name="bibliography"></a><br><h3>  Sources </h3><br><ol><li><a name="cite1"></a>  <a href="http://www.ixbt.com/cm/virtualization.shtml">Virtualization: a new approach to building an IT infrastructure</a> </li><li><a name="cite2"></a>  <a href="http://www.vmware.com/ru/solutions/virtualization.html">Virtualization with VMWare</a> </li><li><a name="cite3"></a>  <a href="https://xakep.ru/2013/11/08/61563/">Detektim virtualki (xakep.ru)</a> </li><li><a name="cite4"></a>  <a href="https://msdn.microsoft.com/en-us/library/aa394388(v%3Dvs.85).aspx">WMI: Win32 Provider (MSDN)</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/322486/">https://habr.com/ru/post/322486/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../322476/index.html">Development of SELinux-module for the user</a></li>
<li><a href="../322478/index.html">The first way to generate collisions for SHA-1</a></li>
<li><a href="../322480/index.html">Upspin: Google's new global file system</a></li>
<li><a href="../322482/index.html">On the application of the scientific method in real life and activities</a></li>
<li><a href="../322484/index.html">MVC programming pattern as a way to implement the design process in Revit</a></li>
<li><a href="../322492/index.html">The exclusive role of the boss</a></li>
<li><a href="../322494/index.html">The simplest way to avoid routine</a></li>
<li><a href="../322496/index.html">The world's easiest lock-free hash table</a></li>
<li><a href="../322498/index.html">11 steps to high email deliverability</a></li>
<li><a href="../322500/index.html">The CDN provider Cloudflare has injected the contents of its server‚Äôs memory into arbitrary webpage code.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>