<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>9 rules how to protect your Asterisk!</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Now everyone is writing about a large number of attacks on Asterisk and other PBXs. A living example from the practice - the DPRK hacker comrades fail...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>9 rules how to protect your Asterisk!</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/e7c6a932/15c99a68/8b91b90e/8d7dd286.jpg"><br><br>  Now everyone is writing about a large number of attacks on Asterisk and other PBXs.  A living example from the practice - the DPRK hacker comrades failed to get to Asterisk, behind the ASUS ASUS simple router, why - more on that, but they did get a good break, or rather pick passwords to Yealink SIP T-22 IP phones. <br><br>  It was not difficult to do this; standard admin / admin passwords are still very popular.  And, as practice has shown, it can cost tens of thousands of rubles ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="http://www.myasterisk.ru/">MyAsterisk Team</a> specialists <a href="http://www.myasterisk.ru/">have</a> compiled 9 rules that will help you to avoid hacker attacks and keep funds on your account. <a name="habracut"></a><br><br><h5>  Rule One: Always change logins and passwords on all network devices.  Especially on IP phones, VoIP gateways, etc. </h5><br>  Passwords of subscribers, admins, Asterisk managers, etc.  must contain at least 12 characters (letters, numbers, case shift), use complex logins and passwords.  Not following this simple rule for some has already cost 15,000 rubles. <br><br><h5>  Rule two: Use non-standard ports SIP, IAX, SSH. </h5><br>  Change the standard ports to any other.  What it will be more unlike the standard - the better. <br><br>  <b>SIP</b> : The port is configured in the <i>sip</i> file <i>.</i>  <i>Conf</i> in the general section: <br>  <i>Bindport = 5060 =&gt; bindport = 5172</i> <br><br>  <b>SSH</b> : The new port should not conflict with the ports already open in the system.  For example, we will use 9321. We edit <i>/ etc / ssh / sshd_config</i> <br><br>  Remove the # sign before the change.  Port 9321 <br>  Then restart sshd to apply the changes using the command: <br>  <i>service sshd restart</i> <br><br>  <b>IAX</b> : Go to <i>/etc/asterisk/iax.conf</i> <br>  change the port on the line for any free; bindport = 4569 <br>  Restart Asterisk with <i>/etc/ininit.d/asterisk restart</i> <br><br><h5>  Rule Three: Use a user with SSH access. </h5><br>  It is necessary to create a user and give him access rights over SSH only.  For example, create a user <i>myasterisk</i> and give it a password.  The password must contain characters, numbers and letters with a change of case. <br><br>  <i># useradd myasterisk</i> <i><br></i>  <i># passwd myasterisk</i> <br><br>  Edit <i>/ etc / ssh / sshd_config</i> , adding the following line to it: <i>AllowUsers myasterisk</i> <br><br>  Prevent root user from connecting to Asterisk server via SSH: <i>PermitRootLogin no</i> <br><br><h5>  Rule Four: Set the allowed addresses for internal subscribers (Deny / Permit). </h5><br>  This setting restricts the ability to register internal subscribers only from trusted IP addresses.  For each extension, we specify a range of addresses or a valid IP address. <br><br>  <i>123</i> <i><br></i>  <i>Deny = 0.0.0.0 / 0.0.0.0</i> <i><br></i>  <i>Permit = 10.10.1.7</i> <i><br></i>  <i>Permit = 10.10.2.1 / 24</i> <br>  Where <i>10.10.2.1/24</i> is the range of local addresses from which the connection will be made.  Connections from other Asterisk addresses will not be accepted. <br><br><h5>  Rule Five: Disable guest calls (guest-calls) and registration </h5><br>  You must edit <i>/etc/asterisk/sip.conf</i> <br>  string <i>Allowguest = yes</i> replace with <i>allowguest = no;</i>  <i>Allow or reject guest calls (default is yes)</i> <br><br>  This option is not suitable for all users, sometimes it happens that it is not possible to refuse guest-calls. <br><br><h5>  Rule Six: Set Call Limit </h5><br>  In the event that you have already been hacked, the line <i>Call-limit = 1</i> , specified in the settings of your internal subscribers, will help you to lose less money. This line limits the number of simultaneous connections of your internal subscriber. <br><br><h5>  Rule number seven: use different outbound routing rules </h5><br>  Do not be lazy and use default routes, such as <i>Exten =&gt; _X., 1, Hangup</i> .  It is necessary to strictly register directions with the codes of cities, mobile operators and international codes (if such is needed at all), for example: <i>8495XXXXXXX, 8961XXXXXXXX, 89XXXXXXXXX</i> , etc. <br><br><h5>  Rule Eight: Disable the wrong password answer. </h5><br>  By default, Asterisk gives one error about the wrong password for an existing account and another for a nonexistent account.  There are many programs for selecting passwords, so the attacker will not be difficult to check all the short numbers and collect passwords only to existing accounts that answered the "wrong password".  To prevent this, change the line in the <i>/etc/asterisk/sip.conf</i> file <i>:</i> <i><br></i>  <i>alwaysauthreject = no on alwaysauthreject = yes</i> and restart Asterisk. <br><br>  After this setup, Asterisk will respond in the same way for any incorrect <i>"401 Unauthorized"</i> authorizations and will not provide details. <br><br><h5>  Rule Nine: Use iptables and fail2ban </h5><br>  <b>Fail2ban</b> helps to catch strings like ‚Äúfailed for '127.0.0.1 ‚Ä≤ - Wrong password‚Äù and ‚Äúfailed for' 127.0.0.1 ‚Ä≤ - Peer is not supposed to register‚Äù.  <b>Fail2ban</b> can significantly reduce the amount of junk SIP traffic. <br><br>  However, there are several unpleasant situations in which Asterisk log analysis will not help.  For example, in the case when an attacker sends a REGISTER request without identification data, the message ‚ÄúWrong password‚Äù will never appear in the log. <br><br>  The fact is that in Asterisk all SIP UDP signaling is handled by a single thread.  Processing SIP traffic is a resource-intensive process, 7-8 megabits of garbage requests force Asterisk to completely consume the processor core (for example, Intel E5335, E5405).  When the kernel is completely eaten, it displaces the useful SIP traffic - garbage. <br><br>  DTMF stop working for clients using SIP INFO.  Problems begin with the installation of new and the completion of existing connections.  And this is the main threat that bruteforce robots carry. <br><br>  So how to deal with problems about which there are no messages in the logs?  It's very simple - you need to generate a problem report yourself, then the rest of our countermeasure system (for example, the fail2ban program) can be left unchanged.  A characteristic feature of bruteforce is a large number of SIP packets per unit of time. <br><br>  You can count the number of packets per unit of time using the <b>iptables</b> module called recent.  On the Internet there are many examples of how with the help of the recent module they discard packets coming in with a frequency higher than a certain one.  Instead of discarding, we will generate messages for our attack detection system (for example, fail2ban).  This approach has its own advantages and disadvantages.  The main disadvantage is that the processing of messages will waste system resources, while discarding the package is conditionally free. <br><br>  The advantages are slightly more: we will be able to take advantage of all the capabilities of our attack detection system, such as whitelisting of IP addresses, a uniform record of all detected attacks, and so on. <br><br><h6>  From theory to practice!  Prepare the skeleton of the rules iptables: </h6><br>  <i>-A INPUT -p udp --dport 5060 -j SCAMBLOCK</i> <i><br></i>  <i>-A INPUT -p udp --dport 5060 -m recent --set --name SIP</i> <i><br></i>  <i>-A INPUT -p udp --dport 5060 -m recent --update --seconds 2 --hitcount 60 --name SIP \</i> <i><br></i>  <i>-j LOG --log-prefix ‚ÄúSIP flood detected:‚Äû</i> <br><br>  The first rule checks our package through the SCAMBLOCK chain.  In this chain, blocked IP addresses are stored, if the packet matches one of the addresses of this chain - it is discarded.  If the packet is not dropped, then in the second rule it is marked for accounting under the SIP name.  The third rule considers whether this package has exceeded the specified amount (60) in the specified time (2 seconds). <br><br>  If the quantity is not exceeded - the rule is ignored; if it is exceeded - the action is performed.  In our case, detailed information about the package starting with the line ‚ÄúSIP flood detected:‚Äú is written to the system log.  The number of packets and time are counted separately for each source.  Thus, it turns out that we have limited the speed of receiving SIP packets from each unblocked IP address at the level of 30 packets per second. <br><br>  For me, this restriction is comfortable, on the one hand, all clients, even the largest ones, send packets from one IP address with speeds below 30 packets / s, on the other hand, 30 packets per second practically do not reflect on the system operation.  It is possible that this value should be corrected in one direction or another, depending on server performance, number and type of subscribers. <br><br>  In some systems, the built-in restriction of the <i>recent</i> module on the <i>hitcount</i> parameter is very small, for example, on CentOS this restriction is 20 packets.  If you try the above command, you will get the following error: <br><br>  <i>iptables -A INPUT -p udp --dport 5060 -m recent --update --seconds 2 --hitcount 60 --name SIP \</i> <i><br></i>  <i>-j LOG --log-prefix ‚ÄúSIP flood detected:‚Äû</i> <i><br></i>  <i>iptables: Unknown error 4294967295</i> <i><br></i>  <i>Or like this, for 64 bit systems:</i> <i><br></i>  <i>iptables -A INPUT -p udp --dport 5060 -m recent --update --seconds 2 --hitcount 60 --name SIP \</i> <i><br></i>  <i>-j LOG --log-prefix ‚ÄúSIP flood detected:‚Äû</i> <i><br></i>  <i>iptables: Unknown error 18446744073709551615</i> <br><br>  You can change the maximum limit by passing a special parameter to the recent module at boot.  To do this, create the file <i>/etc/modprobe.d/ipt.conf</i> and write the parameter of interest to it: <br><br>  <i>options ipt_recent ip_pkt_list_tot = 60</i> <br><br>  Be careful to increase this limit, remember that with it increases the memory required to store the latest packets, as well as the number of processor cycles required to process them. <br><br>  Well, that's all, now any flood on port 5060 will be detected using the recent module module iptables.  A message about the detected flood will be sent to the system log where our favorite attack detection system (for example, fail2ban) will be able to see it.  iptables does not limit us to only the system log, the LOG action can specify the level (level) and facility of the message, and in the Syslog settings redirect the message data to a separate file.  SIP flood messages themselves will look like this: <br><br>  <i>Jun 17 23:54:44 sip2 kernel: SIP flood detected: IN = eth0 OUT = MAC = 00: 21: 5e: db: 15: b8: 00: 0f: 34: f8: 28: 7: 08: 00 SRC = 184.172.62.3 DST = 192.168.224.217 LEN = 370 TOS = 0x00 PREC = 0x00 TTL = 47 ID = 0 DF PROTO = UDP SPT = 5495 DPT = 5060 LEN = 350</i> <i><br></i>  <i>Jun 17 23:54:44 sip2 kernel: SIP flood detected: IN = eth0 OUT = MAC = 00: 21: 5e: db: 15: b8: 00: 0f: 34: f8: 28: 7: 08: 00 SRC = 184.172.62.3 DST = 192.168.224.217 LEN = 369 TOS = 0x00 PREC = 0x00 TTL = 47 ID = 0 DF PROTO = UDP SPT = 5495 DPT = 5060 LEN = 349</i> <i><br></i>  <i>Jun 17 23:54:44 sip2 kernel: SIP flood detected: IN = eth0 OUT = MAC = 00: 21: 5e: db: 15: b8: 00: 0f: 34: f8: 28:</i> <br><br>  Thank you, <a href="http://tamkovich.com/">Sergey Tamkovich,</a> for the 9th rule. <br><br>  Also, <a href="http://www.myasterisk.ru/">MyAsterisk Team</a> recommends that you discuss registration with your SIP provider only from your ip address, set a spending limit per day, based on their average costs and not to disconnect a long-distance and international connection if you do not use it, or make it possible to make outgoing MGs and MN calls after entering the pin code. <br><br>  Follow the safety rules of <a href="http://www.myasterisk.ru/">MyAsterisk Team</a> , so as not to become the next hero of this video! <br><br><iframe src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/2524735&amp;xid=17259,1500003,15700021,15700186,15700190,15700253,15700256,15700259&amp;usg=ALkJrhg1Oj2he9GaffhKAgmnSfO0W4N-bA" width="504" height="315" frameborder="0" title="Automated VOIP penetration testing using sipautohack" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/130325/">https://habr.com/ru/post/130325/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../130318/index.html">Memory barriers and non-blocking synchronization in .NET</a></li>
<li><a href="../130319/index.html">Background upload lists</a></li>
<li><a href="../130320/index.html">Configuring Replication in SQL 2008</a></li>
<li><a href="../130321/index.html">We're saving ourselves from the paper flood, or how to spend the International Day without paper.</a></li>
<li><a href="../130323/index.html">"Bloated code" in commercial software development</a></li>
<li><a href="../130326/index.html">Developing games with Intel: autumn webinar series</a></li>
<li><a href="../130327/index.html">Centralized deployment of Microsoft Word settings through Group Policy</a></li>
<li><a href="../130329/index.html">GDD 2011: Developer Impressions</a></li>
<li><a href="../130330/index.html">Unix-way reminder</a></li>
<li><a href="../130332/index.html">Google+ is the best example that Google doesn't understand the Platform.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>