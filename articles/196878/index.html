<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We struggle with the errors of the accelerometer, gyroscope, M7, digital compass and other sensors in the iPhone 5S and not only</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many have heard about the problem with uncalibrated sensors in the new iPhone 5S - the ‚Äúlevel‚Äù tool built into the native compass of iOS 7 shows a dev...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We struggle with the errors of the accelerometer, gyroscope, M7, digital compass and other sensors in the iPhone 5S and not only</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/b5e/b77/a3a/b5eb77a3a4b069c09b178b12afe9e917.png"><br><br>  Many have heard about the problem with uncalibrated sensors in the new iPhone 5S - the ‚Äúlevel‚Äù tool built into the native compass of iOS 7 shows a deviation of several degrees if the device is placed on a flat surface, such as a table. <br><br>  In short, to some extent, the sensor orientation problem has always been present and on all iOS devices.  Previously, the problem was not observed so often due to the lack of a built-in mobile OS application that allows to measure the level.  There is a similar problem on other mobile devices equipped with an accelerometer, since the principles are the same everywhere - every developer who has had to deal with different motion and orientation sensors should be familiar with this firsthand. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I develop applications using accelerometer sensors, a gyroscope and a digital compass, exactly since the API became available to developers, almost from the very beginning - being the author of one of the most popular compasses for iOS with accelerometer calibration problems and accuracy of other sensors, I also encountered some years ago. <br><br>  The way to solve the problem is quite trivial and has already been incorporated into most of both application and gaming applications, which in one way or another use gravity, movement and magnetic field sensors - calibration, which any self-respecting developer should take care of.  Depending on how complex the application is and what tasks it solves, from the technical point of view of the developer, the implementation of the solution can be both simple and complex.  But the principle is the same for everyone. <br><br>  I invite developers and application users to figure out how it works, where these errors come from, why you shouldn‚Äôt worry too much about accelerometer problems and why you don‚Äôt need to run to the store to replace the ‚Äúdefective‚Äù device - the new device is unlikely to be much better, and problems with sensor errors are solved in other ways. <a name="habracut"></a><br><br>  <b>How it was</b> <br><br>  More than four years ago, I was faced with the task of developing not the usual analogue of a two-dimensional compass, which came bundled with iOS, but a compass using augmented reality, operating in three-dimensional space and with high accuracy of combining virtual tags superimposed on real-time video. <br><br>  To combine a virtual object label with its real position in the picture obtained from the camera, it is necessary to use all motion sensors available in the mobile device. <br><br>  Accelerometer is needed to determine the gravity vector or, to put it in simple language, to find out which part of the device is looking down.  A digital compass sensor or magnetometer is needed for orientation to the cardinal points in order to know which side of the device is directed north.  Later a gyroscope appeared that determines the rotation of the device and, accordingly, allows to significantly improve the accuracy of the full orientation in three-dimensional space. <br><br>  As the development of the application and the possibility of using new sensors almost immediately revealed individual flaws inherent in the sensors. <br><br>  As it turned out, in all devices, the sensors give out unequal data, which differ within a certain error, somewhere there are more deviations, somewhere less - at the same time, a number of various non-obvious factors influence the sensor readings. <br><br>  The initial reaction of not having experience in this area at that time was similar to that described in the articles about the incorrectly installed sensor in the iPhone 5S, but further study of the issues made the opinion change and continue development without expecting that the manufacturer can and will correct something, but considering the characteristics of each of the necessary sensors. <br><br>  As a result, a high-tech toy with problems with accuracy turned out to be a reasonably accurate instrument suitable for real use - the main thing is to know how to use it correctly, which directly follows from the characteristics of each sensor, which I am writing about in detail below. <br><br>  <b>Accelerometer</b> <br><br>  Since, unlike the standard compass that works in only one orientation, my application had to work in any of the possible, already at the early stages, before the appearance of the gyroscope, one very strange feature of the accelerometer was discovered. <br><br>  It turned out that in addition to the fact that in each device the accelerometer has a small deviation, within the same physical device this deviation is different for different orientations of the device - for example, in a normal portrait orientation the deviation from the real axis of gravity can be 1 ¬∞, while , when rotated 180 ¬∞, in an inverted portrait may be 4 ¬∞. <br><br>  The solution was to add the ability to calibrate the accelerometer separately for each of the six possible orientations, and the appearance of the gyroscope gave new possibilities ‚Äî calibration of motion sensors, respectively, in one form or another, is already present in each decent application that uses them. <br><br>  Game developers had a little easier time - in games, it‚Äôs enough to support one or two orientations of the device, but it‚Äôs still impossible to just ignore the need to allow the user to use calibration, even using a gyroscope sensor. <br><br>  In the ‚Äúlevel‚Äù of the iOS 7 compass built into the calibration, it is done simply by tapping the screen ‚Äî just touch the screen and the current position of the device will be considered the reference or ‚Äúzero‚Äù position. <br><br>  <b>Compass and GPS / GLONASS (although it would seem)</b> <br><br>  Before the appearance of the gyroscope, the sensor responsible for orientation in the horizon plane along the cardinal points was the digital compass sensor - the most sensitive to external factors from all sensors and, accordingly, having the greatest problems with accuracy. <br><br>  The compass is calibrated constantly at the driver level as the device rotates - the more data the device receives, the more accurate the result will be, but there will still be an error. <br><br>  The absolute solution to the problem of compass accuracy, unfortunately, is practically impossible only through calibration.  Although it increases the accuracy.  In iOS 7, the built-in compass has an even more severe calibration than in previous versions of the OS.  Now the calibration screen closes the entire screen until the user performs the necessary actions.  In older versions, there was a small message that did not overlap the screen. <br><br>  Even compass calibration and constant data filtering do not particularly help in conditions of a non-uniform magnetic field - after all, usually after compass calibration, a person rotates around his own axis, and not around the device axis, which, when rotated 90 ¬∞, shifts the device in space by about half a meter, where other magnetic conditions. <br><br>  Near strong magnetic fields, metal objects, wires under voltage, the readings of the magnetometer are unstable due to the very high sensitivity to electromagnetic radiation - this is especially noticeable in rooms and machines, which are more and more modern, more and more stuffed with various electronic fillings. <br><br>  Plus, if the compass is required to show the geographical north, then the positioning accuracy comes with GPS and GLONASS, since the coordinates are used to determine the magnetic declination or the difference between the directions to the magnetic and server poles at a particular point on the globe. <br><br>  The magnetic compass works well and accurately on the street in the field, where there is no magnetic interference - but even so, calibration of the compass is desirable with each measurement of the azimuth. <br><br>  The direction to the north pole is most accurately determined with good GPS accuracy, also usually outside. <br><br>  To further improve the accuracy where it is needed, for example, if you need to properly target Wi-Fi or radio antennas at each other, or to make any accurate measurements, deeper support is needed on the application side, which is discussed below. <br><br>  <b>Gyroscope, gyrocompass and car mode</b> <br><br>  Indoors, in a car, in a boat or in any other means of transportation, and also when higher accuracy and stability of orientation is required, a conventional magnetic compass does not fit - orientation is needed either along the course of movement or along the gyroscope. <br><br>  Accordingly, in my application I realized both of these possibilities - for use in various vehicles there is an ‚Äúautomobile‚Äù mode and a ‚Äúgyrocompass‚Äù mode for everything else. <br><br>  With the car mode, everything is simple - the driving course is used, which depends only on the accuracy of GPS and GLONASS, and, accordingly, the direction is determined quite accurately while on foot, on car bikes, boats, airplanes, and so on. <br><br>  With a gyrocompass, the situation is both easier and more complicated. <br><br>  In the gyrocompass mode, you can accurately set the initial or correct the current direction using any external reference point - the sun, moon, stars, geographical objects, the tree-covered side of the moss, orient using maps or other methods. <br><br>  This is done simply for the user.  The marker superimposed on the live video or pointing at the object of the arrow on the dial of the compass is combined with the real position of the object or with the direction to it.  All complex mathematics based on thousands of lines of formulas remains invisible at the application level. <br><br>  Approximately the same actions are performed by pilots or personnel serving modern military aircraft, vessels testing and subsequent calibration of inertial navigation systems are performed at the beginning of the voyage and during it, which is also facilitated by a fixed arrangement of sensors, while our mobile devices are almost in constant motion. <br><br>  It would seem that a gyrocompass is the ideal solution to the problem of compass accuracy and orientation to the cardinal points, but there are also its own pitfalls. <br><br>  In industrial and military inertial navigation systems, in contrast to what is today in mobile devices, an entire complex, an array of sensors, is used to accurately determine the position in space, which makes it possible to compensate for errors and errors in the readings. <br><br>  In mobile devices, only one instance of each sensor is usually present, which makes it impossible to compensate for errors and leads to an accumulation of errors. <br><br>  The more time passes since the gyrocompass has been calibrated, and more precisely, when viewed from a technical point of view, since the determination of the reference "zero" position, the greater the accumulated error, which is expressed in the periodic shift in the orientation of the gyroscope. <br><br>  The video below illustrates the problem. <br><br>  The video shot compass mode "gyrocompass" tuned exactly to the server running on the device, which still lies on the table.  Although the device is stationary over time, a shift occurs.  At 00:09 shifted from 0 ¬∞ to 359 ¬∞.  At 01:21 it decreases to 358 ¬∞.  At 03:03, we already see azimuth 357 ¬∞. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/KyXEVN7X43U%3Ffeature%3Doembed&amp;xid=17259,15700002,15700019,15700186,15700190,15700253&amp;usg=ALkJrhiVBGgwjGg_nBzvatGnpz6LMQ4O1A" frameborder="0" allowfullscreen=""></iframe><br><br>  The accumulation of errors occurs due to the discreteness of the sensors, which at some moments can miss events, such as in the video above, the gyroscope readings are affected by the smallest vibrations of the power supply fan in the monitor and computer located nearby on the table.  Sensors, of course, progress with time, get higher resolution, but the data resolution remains.  Accordingly, such insignificant things as heartbeat and pulse can influence the readings. <br><br>  The micromechanical systems of such sensors are also influenced by such unobvious factors as ambient temperature - the temperature, although not available to ordinary developers, is taken into account for correcting sensor data at the OS driver level. <br><br>  At the same time, the orientation on the gyroscope is much more accurate than on the compass sensor - when turning 180 ¬∞, the sensor reports that the turn was the same 180 ¬∞ and not 150 ¬∞, as, for example, the compass can say in terms of interference. <br><br>  Just keep in mind that a gyroscope has such a feature and take this into account when using the device as a tool or when developing your own applications and games. <br><br>  <b>But what about the new M7 motion coprocessor?</b> <br><br>  With the announcement of the M7, I was hoping that mobile devices would become closer to large inertial navigation systems, but unfortunately, this new co-processor solves slightly other tasks. <br><br>  First of all, the M7 is designed to reduce battery power consumption when using GPS and other sensors.  Less time is spent on satellite data due to the fact that this calculation does not start from scratch when the application is started.  Additionally, data from other sensors are collected in the background, even when the application is not running, which also reduces battery consumption. <br><br>  For example, in the video illustrating the situation with the accumulation of errors in the gyroscope given above, the compass in the gyro mode works on the new iPhone 5S already using the M7. <br><br>  <b>Can you trust mobile devices?</b> <br><br>  The answer is yes, knowing and considering the features of the sensors used. <br><br>  Developers will make their own conclusions on their own. <br><br>  To the users who were interested in reading up to the end, let me give you some tips. <br><br>  There is no need to change the device.  It may not be better.  And who said that the surface of the table used is strictly perpendicular to the gravity vector? <br><br>  In games with tactile control, if the error of the accelerometer or gyroscope is clearly noticeable, look in the settings or in the pause mode of the calibration menu. <br><br>  In all actual applications implementing the ‚Äúlevel‚Äù tool, there should be a calibration setting the ‚Äúzero‚Äù position - naturally, it is also in the embedded application. <br><br>  Magnetic compass works well only on hikes in nature.  You should not expect the device to do the impossible by trying to absolutely accurately determine the direction next to the computer, speakers, radiator or in any means of transportation.  Use those specially designed for this application and modes that best fit the task. <br><br>  When using a magnetic compass, remember that the readings are relevant only immediately after calibration, until the device has been moved to any significant distance - a 90 ¬∞ rotation along the axis of the spine may require re-calibration. <br><br>  When using applications such as ‚Äúlevel‚Äù or ‚Äúgyrocompass‚Äù, remember that the sensor readings are relevant for about one to two minutes, which is quite enough to make a measurement ‚Äî in order to avoid accumulating errors, repeat the calibration before each measurement to improve measurement accuracy. <br><br>  PS I ask for questions in the comments. </div><p>Source: <a href="https://habr.com/ru/post/196878/">https://habr.com/ru/post/196878/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../196868/index.html">Click and Grow. Half a year - normal flight</a></li>
<li><a href="../196870/index.html">Algorithms in bioinformatics, online course</a></li>
<li><a href="../196872/index.html">HTML5 frequency noise generator</a></li>
<li><a href="../196874/index.html">New HP Chromebook 11 is available on Google Play</a></li>
<li><a href="../196876/index.html">Interface Digest, September 2013</a></li>
<li><a href="../196880/index.html">White Graphene protects against rust even at high temperatures.</a></li>
<li><a href="../196882/index.html">Virus on the site or reverse engineering Exploit.SWF.254</a></li>
<li><a href="../196884/index.html">With a camera in the clouds. Part 1</a></li>
<li><a href="../196886/index.html">(Archive) Matreshka.js - MK.Object</a></li>
<li><a href="../196888/index.html">"Boost.Asio C ++ Network Programming". Chapter 6: - other features</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>