<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating Guest Access to the Internet with Web Authentication</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings, colleagues. 

 Prologue 
 Our task arose - to make guest Internet. Those. Guest comes, connects to the network (WiFi or cable) and tries to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating Guest Access to the Internet with Web Authentication</h1><div class="post__text post__text-html js-mediator-article">  Greetings, colleagues. <br><br><h4>  Prologue </h4><br>  Our task arose - to make guest Internet.  Those.  Guest comes, connects to the network (WiFi or cable) and tries to access the Internet.  When you try to enter the site, he "must ask for a password." <br>  It should be noted that similar questions about solving such a problem often arise in the forums.  There is a bunch of paid software (not considered in principle, because the task is low priority) and some free solutions.  The search on the forums did not make a choice, therefore it was decided to do this on my own in free minutes. <br><br><h4>  Basic requirements: </h4><br>  Resources for the creation - both human (working time) and material - are minimal. <br>  The load is small.  Typically, this system will use no more than 10 people per day. <br>  Accessibility is low.  If the system is broken, it will be the last thing to be repaired.  The loss of several packages is not critical. <br>  Isolation is complete.  If any parts are broken, the local network should not suffer. <br>  Platform independence - all kinds of gadgets will be customers - from a phone to a large computer. <br><a name="habracut"></a><br><h4>  Implementation </h4><br>  Looking at the requirements and existing resources, it was decided to use a Linux router with one real IP address.  Since the location of the guests was not exactly specified, we created a separate guest VLAN on the local network with the thought that, if necessary, any port would turn into a guest one.  Since there were no extra servers, we used a virtual machine on Hyper-V, forwarding two VLANs to it ‚Äî the guest and the Internet.  CentOS 6.2 was installed as the OS - as the first one that came to hand.  On it DHCP and named were regularly configured.  Raised and configured httpd to work only on the internal interface.  Well, the usual protection. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Customization </h4><br>  Actually, initially the idea was this: the router (Linux) makes DNAT on its internal interface for everyone except the IP addresses included in a certain list.  And those who are on the list - they make SNAT out.  After studying the docks, I had to deliver two packages - conntrack and ipset.  The first gives the opportunity, in particular, to tear off all current IP sessions.  This should be done after changing the translation rules.  The second one allows you to operate with lists of IP addresses that iptables understands. <br>  This is implemented by the commands placed in rc.local: <br><br><blockquote>  echo 1&gt; / proc / sys / net / ipv4 / ip_forward <br>  ipset -N good iphash <br>  iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE <br>  iptables -t nat -A PREROUTING -m set!  --set good src -j DNAT --to 192.168.88.1 <br>  conntrack -F <br></blockquote><br><br>  Here 192.168.88.1 is the address of the Linux itself on the internal interface.  Eth1 - external interface. <br>  Those.  SNAT we do to everyone.  But for those who are not on the list of good, we say that in fact they do not want Yandex, but our local web server. <br>  Actually, after that, by adding / removing the necessary addresses in the ipset ‚Äúgood‚Äù followed by a <code>conntrack ‚ÄìF</code> we can manipulate the permissions of IP addresses to go to the Internet. <br><br><h4>  Authentication and Authorization </h4><br>  Now it was necessary to do so in order to get on the Internet could only be a password.  The idea of ‚Äã‚Äãimplementation is as follows: <br><ol><li>  Create an httpd index page that asks for a password.  If the password is correct, put the IP address of the requester in the ipset ‚Äúgood‚Äù.  Further, httpd is configured so that with a 404 error it displays an index page asking for a password.  Those.  Under these conditions, the internal IP address, when trying to access any HTTP address, will display the index page of the local server with a password request. </li><li>  We write a php script that generates a password.  This script must be on a separate server.  Access to the script should be limited.  For example, the secretary may have access.  How exactly to generate a password - everyone can think of it himself.  I made three types of passwords - a password that is valid for everyone until the end of the day, a password that is valid for everyone, but until a specific time (on the border of an hour, for example, 14:00, 17:00) and a password that is valid for a specific IP- addresses to a specific time (on the border of an hour). </li><li>  We write a php script that checks the password and, in the case of the correct password, adds the IP address to the list of allowed ones and also resets the current sessions.  There is one caveat - Apache works on behalf of a special user, and to manipulate the list of addresses and reset sessions, you need superuser rights.  There are several options - either setting up the sudo system (which I didn‚Äôt really want to understand due to lack of time), or creating a pipe, on one side of which the script hangs on behalf of the superuser and reads commands, and on the other the php script writes the necessary commands to the script.  I chose for myself just such a method.  To create a pipe-type file, use the <code>mknod pipename p</code> </li></ol><br><h4>  My scripts </h4><br>  In principle, creativity goes on.  Everyone can do as he wants / knows how.  I will give the source of my scripts to impart integrity to the article. <br>  In my scripts, as stated above, there are three types of password.  Passwords are identified by the first character.  The password, which is valid for all until the end of the day, begins with an asterisk.  A password that is for everyone, but with a time limit - begins with ‚Äú# NN-‚Äú, where NN is the time of the password.  The password for a specific IP with a time limit starts with ‚Äú$ NN-‚Äú, where NN is the time of the password.  As a password, individual characters of the md5 hash of the string obtained from the concatenation of date, secret (for all types), time (for the 2nd and 3rd types) and IP addresses (for the third type) are used.  The number, order of selection of characters from the hash, as well as the secret - should be set and, obviously, match on the password generator and on the verification script. <br><br><h5>  Some nuances of scripts </h5><br><ul><li>  A page requesting a password displays some kind of ID, which the client must inform the secretary.  In fact, this is the last octet of the IP address.  It is used only in generating a password with binding to an IP address. </li><li>  The <code>$symbols</code> array specifies which characters from the hash will be used as a password.  I use six characters, you can use any number greater than zero. </li><li>  The <code>debug</code> command sent to the pipe results in the output of the current IP address table with the access validity time to the <code>debug</code> file.  Example: <code>echo debug &gt;pipe</code> </li><li>  In order for everything to work properly, it is necessary once per hour (cron, preferably at: 00 or: 01 minute) in the pipe write the word <code>update</code> , and at midnight <code>reload</code> </li></ul><br><br><habracut><h5>  Password Generator (index.php) </h5><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">HTML</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FORM</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"get"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">gen.php</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PwdType"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"radio"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Common"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">checked</span></span></span><span class="hljs-tag">&gt;</span></span>Common Password<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">INPUT</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PwdType"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"radio"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"CommonTill"</span></span></span><span class="hljs-tag">&gt;</span></span>Common Password till <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">select</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Till"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">__8</span></span></span><span class="hljs-tag">"&gt;</span></span>8:00<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">__23</span></span></span><span class="hljs-tag">"&gt;</span></span>23:00<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">select</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">INPUT</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PwdType"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"radio"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Personal"</span></span></span><span class="hljs-tag">&gt;</span></span>Personal Password<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">INPUT</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">select</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PersonalTill"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">__8</span></span></span><span class="hljs-tag">"&gt;</span></span>8:00<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">__23</span></span></span><span class="hljs-tag">"&gt;</span></span>23:00<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SELECT</span></span></span><span class="hljs-tag">&gt;</span></span> Client ID:<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ClientID"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">INPUT</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">submit</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Generate password"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FORM</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">HTML</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><h5>  Password Generator (gen.php) </h5><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> $Secret=<span class="hljs-string"><span class="hljs-string">"123"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//Common secret $d=date("Ymd"); //Current Date $symbols=array(0,4,5,8,1,30); //Symbols in md5 hash for password. Numbers must be in 0..31 $ipnet="192.168.88."; if ( $PwdType == "Common" ) { $str=$d."-".$Secret; $r=md5($str); $res="*"; foreach ($symbols as &amp;$i) {$res=$res.substr($r,$i,1);}; }; if ( $PwdType == "CommonTill" ) { $Till=utf8_decode($Till); $Till=substr($Till,1,strlen($Till)-2); $str=$d."-".$Till."-".$Secret; $r=md5($str); $res="#".$Till."-"; foreach ($symbols as &amp;$i) {$res=$res.substr($r,$i,1);}; }; if ( $PwdType == "Personal" ) { $ip=$ipnet.$ClientID; $PersonalTill=utf8_decode($PersonalTill); $PersonalTill=substr($PersonalTill,1,strlen($PersonalTill)-2); $str=$d."-".$PersonalTill."-".$ip."-".$Secret; $r=md5($str); $res="$".$PersonalTill."-"; foreach ($symbols as &amp;$i) {$res=$res.substr($r,$i,1);}; }; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> &lt;H2&gt;Password="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-comment">print $res;</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">"&lt;/H2&gt; &lt;H1 align=center&gt;&lt;a href="index.php"&gt;Return&lt;/a&gt;&lt;/H1&gt;</span></span></code> </pre><br><h5>  Password checker (index.php) </h5><br><pre> <code class="php hljs">&lt;HTML&gt; &lt;!-<span class="hljs-number"><span class="hljs-number">-0123456789</span></span>ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF--&gt; <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> $addr=<span class="hljs-string"><span class="hljs-string">"192.168.88.1"</span></span>; $a=getenv(<span class="hljs-string"><span class="hljs-string">"REMOTE_ADDR"</span></span>); $s=getenv(<span class="hljs-string"><span class="hljs-string">"SERVER_NAME"</span></span>); $ipnet=<span class="hljs-string"><span class="hljs-string">"192.168.88."</span></span>; $p=strpos($a,$ipnet); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($p === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;B&gt;Internal error: &lt;I&gt;Wrong network (Network=$ipnet, Address=$a)&lt;/I&gt;&lt;/B&gt; \n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($p &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;B&gt;Internal error: &lt;I&gt;Wrong network (Position=$p)&lt;/I&gt;&lt;/B&gt; \n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; }; <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> Please, call XXXX to get password. Your ID is &lt;STRONG&gt;<span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> substr($a,strlen($ipnet));<span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span>&lt;/STRONG&gt; &lt;FORM action=http:<span class="hljs-comment"><span class="hljs-comment">//</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?</span></span></span><span class="hljs-comment">print $addr;</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">/do.php method=post&gt; &lt;CENTER&gt; Password &lt;INPUT name=pwd type=password&gt; &lt;INPUT type=submit value="Activate Internet"&gt; &lt;/CENTER&gt; &lt;/FORM&gt; &lt;/HTML&gt;</span></span></code> </pre><br><h5>  Password checker (do.php) </h5><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> $Secret=<span class="hljs-string"><span class="hljs-string">"123"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//Common secret $d=date("Ymd"); //Current Date $symbols=array(0,4,5,8,1,30); //Symbols in md5 hash for password. Numbers must be in 0..31 $ipnet="192.168.88."; $ip=getenv("REMOTE_ADDR"); $pwd=$_POST["pwd"]; $fc=substr($pwd,0,1); //first charter is code of password type $PipeFile="./pipe"; if ($pwd == "") { print "&lt;H1 align=center&gt;Wrong empty password. &lt;a href='/'&gt;return&lt;/a&gt;&lt;/H1&gt;"; exit; }; if ( $fc == "*" ) { $str=$d."-".$Secret; $r=md5($str); $res="*"; foreach ($symbols as &amp;$i) {$res=$res.substr($r,$i,1);}; $Till=25; }; if ( $fc == "#" ) { $p=strpos($pwd,"-"); $Till=substr($pwd,1,$p-1); $str=$d."-".$Till."-".$Secret; $r=md5($str); $res="#".$Till."-"; foreach ($symbols as &amp;$i) {$res=$res.substr($r,$i,1);}; }; if ( $fc == "$" ) { $p=strpos($pwd,"-"); $PersonalTill=substr($pwd,1,$p-1); $str=$d."-".$PersonalTill."-".$ip."-".$Secret; $r=md5($str); $res="$".$PersonalTill."-"; foreach ($symbols as &amp;$i) {$res=$res.substr($r,$i,1);}; $Till=$PersonalTill; }; if ($pwd != $res) { print "&lt;H1 align=center&gt;Wrong password. &lt;a href='/'&gt;return&lt;/a&gt;&lt;/H1&gt;"; exit; }; file_put_contents ( $PipeFile, substr($ip,strlen($ipnet))." $Till\n", FILE_APPEND); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> &lt;H1 align=center&gt;Access to Internte granted&lt;/H1&gt;</span></span></code> </pre><br><br><h5>  A script that monitors the pipe and makes changes. </h5><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash PipeFile="/var/www/html/pipe" LogFile="/var/log/script.log" ErrFile="/var/log/script.err" DebugFile="/var/log/script.debug" ipnet="192.168.88." ipset_prog="/usr/sbin/ipset" ipset_setname="good" ctr_prog="/usr/sbin/conntrack" function debug() { local d=`date` echo "$d Debuging started" &gt;&gt;$DebugFile for i in `seq 1 254`; do if [ ${b[$i]} != "0" ]; then echo "b[$i] = ${b[$i]}" &gt;&gt;$DebugFile fi done; echo "==================== Debuging finised =================" &gt;&gt;$DebugFile } function initfunc() { #Init for i in `seq 1 254`; do b[$i]="0" done; ( d=`date` echo "$d Init function called" $ipset_prog -F $ipsetname $ctr_prog -F ) &amp;&gt;&gt;$LogFile }; function update() { ( local d1=`date` local d=`date +%H` echo "$d1 Update function called" for i in `seq 1 254`; do if [ ${b[$i]} -gt "0" ] &amp;&amp; [ ${b[$i]} -le "$d" ]; then b[$i]=0 ip2="$ipnet$i" echo "Deleting address $ip2" &amp;&gt;&gt;$LogFile $ipset_prog -D $ipset_setname $ip2 &amp;&gt;&gt;$LogFile $ctr_prog -F fi done ) &amp;&gt;&gt;$LogFile } #update ################# Start program ################# initfunc while true; do while read line; do a=( $line ) ip=${a[0]} tm=${a[1]} if [ "$ip" == "reload" ]; then initfunc continue fi if [ "$ip" == "update" ]; then update continue fi if [ "$ip" == "debug" ]; then debug continue fi b[$ip]=$tm ip2="$ipnet$ip" ( d=`date` echo "$d Added address $ip2 with time:$tm" $ipset_prog -A $ipset_setname $ip2 &amp;&gt;&gt;$LogFile $ctr_prog -F ) &amp;&gt;&gt;$LogFile update done &lt;$PipeFile done</span></span></code> </pre></habracut></div><p>Source: <a href="https://habr.com/ru/post/163967/">https://habr.com/ru/post/163967/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../163947/index.html">Markdown markup in a RubyOnRails application</a></li>
<li><a href="../163951/index.html">Kid's Shell - a children's shell to run only authorized applications on your Android phone or tablet.</a></li>
<li><a href="../163955/index.html">Are you ready to move because of the new job?</a></li>
<li><a href="../163957/index.html">Experimental architecture of GPS trackers reduces power consumption by three orders of magnitude</a></li>
<li><a href="../163961/index.html">Netflix Best Practices for Moving from Oracle DB to Amazon SimpleDB</a></li>
<li><a href="../163969/index.html">High-Load cluster organization with several nodes</a></li>
<li><a href="../163971/index.html">Review of the smartphone Meizu MX2</a></li>
<li><a href="../163973/index.html">Ahead of their time</a></li>
<li><a href="../163975/index.html">Solving a recursive logic puzzle in Oracle SQL</a></li>
<li><a href="../163979/index.html">Benchmark HTML parsers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>