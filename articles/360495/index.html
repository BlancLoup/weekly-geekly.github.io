<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitoring file changes in Node.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The material, the translation of which we are publishing today, is devoted to the organization of monitoring file changes in Node.js. The author of th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitoring file changes in Node.js</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/d5/c9/-n/d5c9-nk8c69t5qo8ryvoqhr4kic.png"></div><br>  The material, the translation of which we are publishing today, is devoted to the organization of monitoring file changes in Node.js.  The author of the material, Dave Johnson, says that the need for a file monitoring system appeared to him in the process of creating an <a href="http://thisdavej.com/how-to-count-unique-items-in-javascript-arrays/">IoT project</a> related to feeding aquarium fish.  When someone from a family member feeds them, he presses one of the three buttons.  In particular, we are talking about a button on an expansion card connected to the Raspberry Pi, an Amazon Dash button, and a button in the web interface.  Any of these actions results in writing a string to the log file indicating the date, time, and type of event.  As a result, looking at the contents of this file, you can understand whether it is time to feed the fish or not.  Here is his fragment: <br><br><pre><code class="hljs mel"><span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-5</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>|circuit board <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-5</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>|dash <span class="hljs-keyword"><span class="hljs-keyword">button</span></span> <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-5</span></span><span class="hljs-number"><span class="hljs-number">-20</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">46</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>|web</code> </pre> <br>  After the creation of the file is established, it is necessary that the system based on Node.js respond to the events of the change of this file and take the necessary actions.  There will be reviewed and analyzed several approaches to solving this problem. <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Packages for organizing file monitoring and Node.js built-in features</font> </h2><br>  This material focuses on the Node.js built-in file-monitoring capabilities.  In fact, such tasks can be solved exclusively by means of Node, without resorting to using third-party packages.  However, if you are not against external dependencies or just want to get to a working solution as quickly as possible, without going into details, you can use the appropriate packages.  For example - packages <a href="https://www.npmjs.com/package/chokidar">chokidar</a> and <a href="https://www.npmjs.com/package/node-watch">node-watch</a> .  These are excellent libraries that are based on Node's internal file system monitoring capabilities.  It is easy to use them, they solve the tasks assigned to them.  Therefore, if you need to organize monitoring of files, without particularly going into the particular implementation of certain things in Node, these packages will help you with this.  If, in addition to getting a practical result, you are also interested in how the corresponding Node subsystems are arranged, let's examine them together. <br><br><h2>  <font color="#3AC1EF">The first steps</font> </h2><br>  In order to explore various Node tools for organizing file monitoring, we first create and configure a new project.  We will be guided by novice Node developers, so we will describe everything in sufficient detail. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, in order to create a project, we will create a new folder and move it to it using the means of the terminal.  In the terminal, run the following command: <br><br><pre> <code class="hljs swift">$ npm <span class="hljs-keyword"><span class="hljs-keyword">init</span></span> -y</code> </pre> <br>  In response, the system will create a <code>package.json</code> file for the Node.js project. <br>  Now install the <a href="https://www.npmjs.com/package/log-timestamp">log-timestamp</a> package from npm and save it in <code>package.json</code> as a dependency: <br><br><pre> <code class="hljs sql">$ npm <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> <span class="hljs-comment"><span class="hljs-comment">--save log-timestamp</span></span></code> </pre> <br>  The <code>log-timestamp</code> package allows you to attach a time stamp to messages that are output to the console using the <code>console.log</code> command.  This will allow you to analyze the time of occurrence of events related to the monitoring of files.  This package is needed solely for training purposes, and, for example, if you will be preparing something similar to what we are going to talk about, for use in production, you will not need to <code>log-timestamp</code> . <br><br><h2>  <font color="#3AC1EF">Using fs.watchFile</font> </h2><br>  The built-in Node.js <a href="https://nodejs.org/api/fs.html">fs.watchFile</a> method may seem like a logical choice for monitoring the state of our log file.  The callback passed to this method will be called whenever the file changes.  <code>fs.watchFile</code> . <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'log-timestamp'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> buttonPressesLogFile = <span class="hljs-string"><span class="hljs-string">'./button-presses.log'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`Watching for file changes on </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${buttonPressesLogFile}</span></span></span><span class="hljs-string">`</span></span>); fs.watchFile(buttonPressesLogFile, (curr, prev) =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${buttonPressesLogFile}</span></span></span><span class="hljs-string"> file Changed`</span></span>); });</code> </pre> <br>  Here we start monitoring the changes in the <code>button-pressed.log</code> .  Callback is called after the file is changed. <br><br>  The callback functions are passed two arguments of the <code>fs.stats</code> type.  This is an object with data about the current state of the file ( <code>curr</code> ), and an object with data about its previous state ( <code>prev</code> ).  This allows, for example, to find out the time of the previous file modification using the <code>prev.mtime</code> construct. <br><br>  If, after running the above code, open the <code>button-pressed.log</code> and make changes to it, the program will respond to this, the corresponding entry will appear in the console. <br><br><pre> <code class="hljs mel">$ node <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>-watcher.js [<span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span>T00:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">55.885</span></span>Z] Watching <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> changes on ./<span class="hljs-keyword"><span class="hljs-keyword">button</span></span>-presses.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> [<span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span>T00:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">04.731</span></span>Z] ./<span class="hljs-keyword"><span class="hljs-keyword">button</span></span>-presses.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> Changed</code> </pre> <br>  Experimenting, you can notice a delay between the moment of making a change in the file and the moment the message about it appears in the console.  Why?  The thing is that the <code>fs.watchFile</code> method, by default, polls files for changes every 5.007 seconds.  This time can be changed by passing <code>fs.watchFile</code> object with parameters containing the <code>interval</code> property to the <code>fs.watchFile</code> method: <br><br><pre> <code class="hljs coffeescript">fs.watchFile(buttonPressesLogFile, { interval: <span class="hljs-number"><span class="hljs-number">1000</span></span> }, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(curr, prev)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(`<span class="javascript"><span class="javascript">${buttonPressesLogFile} file Changed</span></span>`); });</code> </pre> <br>  Here we set the polling interval to 1000 milliseconds, thereby indicating that we want the system to poll our log file every second. <br><br>  Note that the <a href="https://nodejs.org/api/fs.html">fs.watchFile</a> documentation indicates that the callback function in the handler will be called whenever a file is accessed.  I, preparing this material, worked in Node v9.8.0, and in my case the system behaved differently.  The callback call occurred only when changes were made to the observed file. <br><br><h2>  <font color="#3AC1EF">Using fs.watch</font> </h2><br>  The <a href="https://nodejs.org/api/fs.html">fs.watch</a> method is a much better way to organize file <a href="https://nodejs.org/api/fs.html">monitoring</a> .  While <code>fs.watchFile</code> spends system resources on polling files, <code>fs.watch</code> relies on the operating system for system notifications of file system changes.  The documentation says that Node uses the <code>inotify</code> mechanism in the Linux OS, <code>FSEvents</code> on MacOS, and <code>ReadDirectoryChangesW</code> on Windows to receive asynchronous notifications when files change (compare this with synchronous polling of files).  The performance gain derived from using <code>fs.watch</code> instead of <code>fs.watchFile</code> is even more significant when, for example, you need to keep track of all files in a certain directory, since you can pass either the path to the specific file as the first argument to <code>fs.watch</code> file or folder.  <code>fs.watch</code> . <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'log-timestamp'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> buttonPressesLogFile = <span class="hljs-string"><span class="hljs-string">'./button-presses.log'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`Watching for file changes on </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${buttonPressesLogFile}</span></span></span><span class="hljs-string">`</span></span>); fs.watch(buttonPressesLogFile, (event, filename) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (filename) {   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${filename}</span></span></span><span class="hljs-string"> file Changed`</span></span>); } });</code> </pre> <br>  Here we observe what is happening with the log file, and, after detecting changes, we output a corresponding message to the console. <br><br>  Change the log file and see what happens.  What will be described below happens when you run the example on the Raspberry Pi (Raspbian), so what you see when you run it on your system may look different.  So, this is what was displayed after changes were made to the file. <br><br><pre> <code class="hljs mel">$ node <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>-watcher.js [<span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span>T00:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">52.588</span></span>Z] Watching <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> changes on ./<span class="hljs-keyword"><span class="hljs-keyword">button</span></span>-presses.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> [<span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span>T00:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">00.773</span></span>Z] <span class="hljs-keyword"><span class="hljs-keyword">button</span></span>-presses.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> Changed [<span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span>T00:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">00.793</span></span>Z] <span class="hljs-keyword"><span class="hljs-keyword">button</span></span>-presses.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> Changed [<span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span>T00:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">00.802</span></span>Z] <span class="hljs-keyword"><span class="hljs-keyword">button</span></span>-presses.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> Changed [<span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span>T00:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">00.813</span></span>Z] <span class="hljs-keyword"><span class="hljs-keyword">button</span></span>-presses.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> Changed</code> </pre> <br>  Interestingly, one change was made to the file, and a handler that responds to the file change was called four times.  The number of these events depends on the platform.  Perhaps the fact that one change causes several events is due to the fact that the operation of writing a file to a disk lasts for a certain period of time X, and the system detects several changes to the file on this interval of time.  In order to get rid of such ‚Äúfalse positives‚Äù, we need to modify our solution, make it less sensitive. <br><br>  Here is one technical feature of <code>fs.watch</code> .  This method allows you to respond to events that occur either when a file is renamed (these are <code>rename</code> events) or when its content changes.  If we need accuracy and we only want to observe changes in the contents of the file, the code should be brought to the following state: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'log-timestamp'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> buttonPressesLogFile = <span class="hljs-string"><span class="hljs-string">'./button-presses.log'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`Watching for file changes on </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${buttonPressesLogFile}</span></span></span><span class="hljs-string">`</span></span>); fs.watch(buttonPressesLogFile, (event, filename) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (filename &amp;&amp; event ===<span class="hljs-string"><span class="hljs-string">'change'</span></span>) {   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${filename}</span></span></span><span class="hljs-string"> file Changed`</span></span>); } });</code> </pre> <br>  In our case, such a modification of the code will not fundamentally change anything, but perhaps if you build your own system to monitor the status of files, this technique will be useful to you.  In addition, it should be noted that, when experimenting with this code, the <code>rename</code> event could be detected when running Node under Windows, but not under Raspbian. <br><br><h2>  <font color="#3AC1EF">Attempt at enhancement # 1: comparing file modification points</font> </h2><br>  We need the handler to be called only when real changes are made to the log file.  Therefore, we will try to improve the <code>fs.watch</code> code by observing the moment of file modification, which will allow us to identify real changes and avoid false positives of the handler. <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'log-timestamp'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> buttonPressesLogFile = <span class="hljs-string"><span class="hljs-string">'./button-presses.log'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`Watching for file changes on </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${buttonPressesLogFile}</span></span></span><span class="hljs-string">`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> previousMTime = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); fs.watch(buttonPressesLogFile, (event, filename) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (filename) {   <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> stats = fs.statSync(filename);   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stats.mtime.valueOf() === previousMTime.valueOf()) {     <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;   }   previousMTime = stats.mtime;   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${filename}</span></span></span><span class="hljs-string"> file Changed`</span></span>); } });</code> </pre> <br>  Here we write to the <code>previousMTime</code> variable the value of the previous file modification moment and call <code>console.log</code> only in cases when the file modification time changes.  It seems that this idea is good and now everything should work as we need.  Check it out. <br><br><pre> <code class="hljs mel">$ node <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>-watcher.js [<span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span>T00:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">50.167</span></span>Z] Watching <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> changes on ./<span class="hljs-keyword"><span class="hljs-keyword">button</span></span>-presses.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> [<span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span>T00:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">55.611</span></span>Z] <span class="hljs-keyword"><span class="hljs-keyword">button</span></span>-presses.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> Changed [<span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span>T00:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">55.629</span></span>Z] <span class="hljs-keyword"><span class="hljs-keyword">button</span></span>-presses.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> Changed [<span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span>T00:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">55.645</span></span>Z] <span class="hljs-keyword"><span class="hljs-keyword">button</span></span>-presses.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> Changed</code> </pre> <br>  The result, unfortunately, does not look much better than what we saw last time.  Obviously, the system (Raspbian in this case) generates many events in the process of saving the file, and we, in order not to see unnecessary messages, will have to find another way to improve the code. <br><br><h2>  <font color="#3AC1EF">Attempt improvement # 2: comparison of MD5 checksums</font> </h2><br>  Create an MD5-hash (checksum) of the file contents at the beginning of the work, and then, at each file change event that <code>fs.watch</code> responds <code>fs.watch</code> , we calculate the checksum again.  We may be able to get rid of unnecessary messages about changing the file, if we take into account the state of the contents of the file. <br><br>  To do this, we first need to install the <a href="https://www.npmjs.com/package/md5">md5</a> package. <br><br><pre> <code class="hljs sql">$ npm <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> <span class="hljs-comment"><span class="hljs-comment">--save md5</span></span></code> </pre> <br>  Now we will use this package and write the code to identify the real changes in the file using the checksum. <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> md5 = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'md5'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'log-timestamp'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> buttonPressesLogFile = <span class="hljs-string"><span class="hljs-string">'./button-presses.log'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`Watching for file changes on </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${buttonPressesLogFile}</span></span></span><span class="hljs-string">`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> md5Previous = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; fs.watch(buttonPressesLogFile, (event, filename) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (filename) {   <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> md5Current = md5(fs.readFileSync(buttonPressesLogFile));   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (md5Current === md5Previous) {     <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;   }   md5Previous = md5Current;   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${filename}</span></span></span><span class="hljs-string"> file Changed`</span></span>); } });</code> </pre> <br>  In this code, we use an approach that resembles the one we used, comparing the modification time of a file, but here we analyze changes in the contents of a file using its checksum.  Let's see how this code behaves in practice. <br><br><pre> <code class="hljs mel">$ node <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>-watcher.js [<span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span>T00:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">50.167</span></span>Z] Watching <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> changes on ./<span class="hljs-keyword"><span class="hljs-keyword">button</span></span>-presses.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> [<span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span>T00:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">00.924</span></span>Z] <span class="hljs-keyword"><span class="hljs-keyword">button</span></span>-presses.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> Changed [<span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span>T00:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">00.936</span></span>Z] <span class="hljs-keyword"><span class="hljs-keyword">button</span></span>-presses.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> Changed</code> </pre> <br>  Unfortunately, this is not what we need again.  The system probably generates file change events during the file saving process. <br><br><h2>  <font color="#3AC1EF">The recommended way to use fs.watch</font> </h2><br>  We looked at the various uses of <code>fs.watch</code> , but never achieved what we wanted.  However, not everything is so bad, because, in the search for a solution, we learned a lot of useful information.  Let's make another attempt to achieve the desired.  At this time, we use the technology to eliminate the ‚Äúchatter‚Äù of events by entering into our code a small delay, which will allow us not to react to events about file changes within the specified time window. <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'log-timestamp'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> buttonPressesLogFile = <span class="hljs-string"><span class="hljs-string">'./button-presses.log'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`Watching for file changes on </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${buttonPressesLogFile}</span></span></span><span class="hljs-string">`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fsWait = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; fs.watch(buttonPressesLogFile, (event, filename) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (filename) {   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fsWait) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;   fsWait = setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> {     fsWait = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;   }, <span class="hljs-number"><span class="hljs-number">100</span></span>);   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${filename}</span></span></span><span class="hljs-string"> file Changed`</span></span>); } });</code> </pre> <br>  The bounce function has been created thanks to some <a href="https://stackoverflow.com/a/46581599">help</a> from StackOverflow users.  As it turned out, a delay of 100 milliseconds is enough to issue only one message with a single file change.  At the same time, our solution is also suitable for cases when the file is subject to quite frequent changes.  This is what the output of the program now looks like. <br><br><pre> <code class="hljs mel">$ node <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>-watcher.js [<span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span>T00:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">50.167</span></span>Z] Watching <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> changes on ./<span class="hljs-keyword"><span class="hljs-keyword">button</span></span>-presses.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> [<span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span>T01:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">22.904</span></span>Z] <span class="hljs-keyword"><span class="hljs-keyword">button</span></span>-presses.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> Changed</code> </pre> <br>  As you can see, all this works fine.  We found a magic formula for building a file monitoring system.  If you take a look at the Node npm packages, which are aimed at monitoring file changes, you will find that many of them implement the bounce filtering functions.  We used a similar approach, building a solution based on standard Node mechanisms, which made it possible not only to solve the problem, but also to learn something new. <br><br>  As a result, I would like to note that the function to suppress the ‚Äúbounce‚Äù can be combined with checking MD5 checksums for issuing messages only if the file has really changed and not displaying messages in situations where there was no no real changes made. <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> md5 = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'md5'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'log-timestamp'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> buttonPressesLogFile = <span class="hljs-string"><span class="hljs-string">'./button-presses.log'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`Watching for file changes on </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${buttonPressesLogFile}</span></span></span><span class="hljs-string">`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> md5Previous = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fsWait = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; fs.watch(buttonPressesLogFile, (event, filename) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (filename) {   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fsWait) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;   fsWait = setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> {     fsWait = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;   }, <span class="hljs-number"><span class="hljs-number">100</span></span>);   <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> md5Current = md5(fs.readFileSync(buttonPressesLogFile));   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (md5Current === md5Previous) {     <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;   }   md5Previous = md5Current;   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${filename}</span></span></span><span class="hljs-string"> file Changed`</span></span>); } });</code> </pre> <br>  Perhaps, all this looks a bit difficult, and in 99% of cases there is no need for such a thing, but, in any case, I suppose it gives some food for the mind. <br><br><h2>  <font color="#3AC1EF">Results</font> </h2><br>  In Node.js, you can monitor file changes and execute some code in response to these changes.  When applied to the aquarium IoT project, this makes it possible to monitor the status of the log file that contains the feed feeding records. <br><br>  There are many situations in which monitoring files can be helpful.  It should be noted that the use of <code>fs.watchFile</code> to monitor files <code>fs.watchFile</code> not recommended, since this command, in order to detect file change events, performs regular queries to the system.  Instead, pay attention to <code>fs.watch</code> with a function to suppress the "bounce" of events. <br><br>  <b>Dear readers!</b>  Do you use mechanisms for monitoring file changes in your Node.js projects? </div><p>Source: <a href="https://habr.com/ru/post/360495/">https://habr.com/ru/post/360495/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../359465/index.html">Riddles resume. Part 2. Font also matters.</a></li>
<li><a href="../359473/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ 316 (May 21 - 27, 2018)</a></li>
<li><a href="../359899/index.html">PHP Digest number 131 (May 13 - 27, 2018)</a></li>
<li><a href="../360329/index.html">Stephen Wolfram "Making Great Projects"</a></li>
<li><a href="../360491/index.html">Oil and gas dilemma: in search of alternative DBMS</a></li>
<li><a href="../360527/index.html">Personal data on GDPR. We read the law</a></li>
<li><a href="../360529/index.html">Lanitovskie environment. Why LANIT believed in blockchain</a></li>
<li><a href="../360533/index.html">64-bit hashmap in js</a></li>
<li><a href="../360535/index.html">FBI advises to restart its routers to get rid of VPNFilter</a></li>
<li><a href="../360863/index.html">Coin (Coin)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>