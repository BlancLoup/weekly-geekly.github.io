<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Zimbra with certificate signed by Active Directory</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On one, not very beautiful day, we were forced to switch from the already-native Alt-n mDaemon to the Zimbra Collaboration Suite. 

 All anything, and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Zimbra with certificate signed by Active Directory</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/tn/ft/ay/tnftaype5uc-g4l8vuoku1ajbeg.png" alt="image"></div><br>  On one, not very beautiful day, we were forced to switch from the already-native Alt-n mDaemon to the Zimbra Collaboration Suite. <br><br>  All anything, and mDaemon vs. holivar  We leave Zimbra beyond the scope of the article, the transition itself went quite smoothly, but users began to worry about browser warnings and email clients about an untrusted certificate.  Since the mail exchange is carried out exclusively within the corporation, mDeamon had a certificate issued by the certification authority AD, so everything was smooth there.  And then I decided to Zimbra and issue a certificate from ADCS. <br><a name="habracut"></a><br>  For starters, I tried through a standard web-interface dialog.  But there even with standard settings there is an error. <br><br><img src="https://habrastorage.org/webt/zs/3w/pv/zs3wpvbzbnhvsr6kdn61e9vdpeu.png" alt="image"><img src="https://habrastorage.org/webt/ek/vv/we/ekvvwedb4zegpdzpfcqmbhnywny.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      True, if the Additional Subject Name field is deleted, the query generation proceeds normally. <br><br>  Next, either download the commercial.csr file, or go to the SSH console, under the zimbra account and see its contents: <br><br><pre><code class="bash hljs">cat /opt/zimbra/ssl/zimbra/commercial/commercial.csr -----BEGIN CERTIFICATE REQUEST----- MIIC8zCCAdsCAQAwZDELMAkGA1UEBhMCUlUxCzAJBgNVBAgMAjUyMQ0wCwYDVQQH &lt;skip&gt; IYTKJfkDPOm5XO4pQBtufMMQnmwUrnqcfrt8LUfCsjWwiImfcUaG -----END CERTIFICATE REQUEST-----</code> </pre> <br>  Copy its contents and go to the web interface of the certification center Active Directory.  Here it is necessary to mention that only Internet Explorer can work with this interface normally. <br><br><img src="https://habrastorage.org/webt/4n/-z/yw/4n-zywj8aagze7_2_1d9y5acxps.png" alt="image"><br>  <i>Zimbra can only work with base-64 certificates, so we select the appropriate options.</i> <br><br>  Click ‚ÄúCertificate Request‚Äù, then ‚ÄúAdvanced Certificate Request‚Äù, then ‚ÄúIssue request using base-64 encrypted PKCS # 10 file, or issue update request using base-64 encrypted PKCS # 7 file.‚Äù <br><br>  Insert the text of the request into the first field, select the template ‚ÄúWeb server‚Äù. <br><br><img src="https://habrastorage.org/webt/fm/as/mh/fmasmhqz89qzeybtiy_emietdjg.png" alt="image"><br><br>  After clicking on the "Issue" button, this certificate is issued to us and you can download it (in BASE-64 form, of course). <br><br>  Using the zimbra web interface, I was not able to install this certificate, so we do it using the console. <br><br>  In any way we place the received certificate and CA root certificate in the / opt / zimbra / ssl / zimbra / commercial directory <br><br>  Now we check the certificate for validity with the command: <br><br><pre> <code class="bash hljs">[zimbra@zimbra commercial]$ zmcertmgr verifycrt comm commercial.key certnew.cer CA.cer ** Verifying <span class="hljs-string"><span class="hljs-string">'certnew.cer'</span></span> against <span class="hljs-string"><span class="hljs-string">'commercial.key'</span></span> Certificate <span class="hljs-string"><span class="hljs-string">'certnew.cer'</span></span> and private key <span class="hljs-string"><span class="hljs-string">'commercial.key'</span></span> match. ** Verifying <span class="hljs-string"><span class="hljs-string">'certnew.cer'</span></span> against <span class="hljs-string"><span class="hljs-string">'CA.cer'</span></span> Valid certificate chain: certnew.cer: OK [zimbra@zimbra commercial]$</code> </pre><br>  If everything is OK, then we implement the certificate: <br><br><pre> <code class="bash hljs">[zimbra@zimbra commercial]$ zmcertmgr deploycrt comm certnew.cer CA.cer ** Fixing newlines <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">'certnew.cer'</span></span> ** Fixing newlines <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">'CA.cer'</span></span> ** Verifying <span class="hljs-string"><span class="hljs-string">'certnew.cer'</span></span> against <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/ssl/zimbra/commercial/commercial.key'</span></span> Certificate <span class="hljs-string"><span class="hljs-string">'certnew.cer'</span></span> and private key <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/ssl/zimbra/commercial/commercial.key'</span></span> match. ** Verifying <span class="hljs-string"><span class="hljs-string">'certnew.cer'</span></span> against <span class="hljs-string"><span class="hljs-string">'CA.cer'</span></span> Valid certificate chain: certnew.cer: OK ** Copying <span class="hljs-string"><span class="hljs-string">'certnew.cer'</span></span> to <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/ssl/zimbra/commercial/commercial.crt'</span></span> ** Copying <span class="hljs-string"><span class="hljs-string">'CA.cer'</span></span> to <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/ssl/zimbra/commercial/commercial_ca.crt'</span></span> ** Appending ca chain <span class="hljs-string"><span class="hljs-string">'CA.cer'</span></span> to <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/ssl/zimbra/commercial/commercial.crt'</span></span> ** Importing cert <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/ssl/zimbra/commercial/commercial_ca.crt'</span></span> as <span class="hljs-string"><span class="hljs-string">'zcs-user-ommercial_ca'</span></span> into cacerts <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/common/lib/jvm/java/jre/lib/security/cacerts'</span></span> ** NOTE: restart mailboxd to use the imported certificate. ** Saving config key <span class="hljs-string"><span class="hljs-string">'zimbraSSLCertificate'</span></span> via zmprov modifyServer zimbra.domain.local...ok ** Saving config key <span class="hljs-string"><span class="hljs-string">'zimbraSSLPrivateKey'</span></span> via zmprov modifyServer zimbra.domain.local...ok ** Installing ldap certificate <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/conf/slapd.crt'</span></span> and key <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/conf/slapd.key'</span></span> ** Copying <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/ssl/zimbra/commercial/commercial.crt'</span></span> to <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/conf/slapd.crt'</span></span> ** Copying <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/ssl/zimbra/commercial/commercial.key'</span></span> to <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/conf/slapd.key'</span></span> ** Creating file <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/ssl/zimbra/jetty.pkcs12'</span></span> ** Creating keystore <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/mailboxd/etc/keystore'</span></span> ** Installing mta certificate <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/conf/smtpd.crt'</span></span> and key <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/conf/smtpd.key'</span></span> ** Copying <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/ssl/zimbra/commercial/commercial.crt'</span></span> to <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/conf/smtpd.crt'</span></span> ** Copying <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/ssl/zimbra/commercial/commercial.key'</span></span> to <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/conf/smtpd.key'</span></span> ** Installing proxy certificate <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/conf/nginx.crt'</span></span> and key <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/conf/nginx.key'</span></span> ** Copying <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/ssl/zimbra/commercial/commercial.crt'</span></span> to <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/conf/nginx.crt'</span></span> ** Copying <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/ssl/zimbra/commercial/commercial.key'</span></span> to <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/conf/nginx.key'</span></span> ** NOTE: restart services to use the new certificates. ** Cleaning up 3 files from <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/conf/ca'</span></span> ** Removing /opt/zimbra/conf/ca/ca.key ** Removing /opt/zimbra/conf/ca/ca.pem ** Removing /opt/zimbra/conf/ca/d8183cc3.0 ** Copying CA to /opt/zimbra/conf/ca ** Copying <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/ssl/zimbra/ca/ca.key'</span></span> to <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/conf/ca/ca.key'</span></span> ** Copying <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/ssl/zimbra/ca/ca.pem'</span></span> to <span class="hljs-string"><span class="hljs-string">'/opt/zimbra/conf/ca/ca.pem'</span></span> ** Creating CA <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span> symlink <span class="hljs-string"><span class="hljs-string">'d8183cc3.0'</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">'ca.pem'</span></span> ** Creating /opt/zimbra/conf/ca/commercial_ca_1.crt ** Creating CA <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span> symlink <span class="hljs-string"><span class="hljs-string">'0c6ba62c.0'</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">'commercial_ca_1.crt'</span></span> [zimbra@zimbra commercial]$</code> </pre><br>  You can view the applied certificate with the command <br><br><pre> <code class="bash hljs">zmcertmgr viewdeployedcrt</code> </pre> <br>  After all, restart the service zimbra <br><br><pre> <code class="bash hljs">zmcontrol restart</code> </pre> <br>  Check the result: <br><br><img src="https://habrastorage.org/webt/ft/4b/df/ft4bdfxdspjr7nmfxsswuharcvg.png" alt="image"><br><br>  There are no warnings, the service is visible as valid.  As required! </div><p>Source: <a href="https://habr.com/ru/post/343560/">https://habr.com/ru/post/343560/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343550/index.html">Perfect maven. Part 1</a></li>
<li><a href="../343552/index.html">Anatomy of calltracking: how to analyze calls to the company</a></li>
<li><a href="../343554/index.html">An example of the implementation of an automated process for backing up and restoring databases with built-in tools</a></li>
<li><a href="../343556/index.html">In-Memory Computing Summit 2017 San Francisco</a></li>
<li><a href="../343558/index.html">Scala at EPAM: training and projects</a></li>
<li><a href="../343562/index.html">Javascript price</a></li>
<li><a href="../343566/index.html">Cost of operations in CPU cycles</a></li>
<li><a href="../343568/index.html">How JS Works: Features and Scope of WebAssembly</a></li>
<li><a href="../343570/index.html">As programmers are not allowed to do anything else</a></li>
<li><a href="../343572/index.html">Docker, as an indicator of maturity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>