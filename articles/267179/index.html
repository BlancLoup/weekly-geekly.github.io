<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Game for Railways: complete story</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many of us played railroad as a child and dreamed of a second or third rail set to build our branch from the balcony to the hallway. Our team managed ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Game for Railways: complete story</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/e7a/42b/0b2/e7a42b0b282084ab061987a257aeaad3.png" alt="image"><br><br>  Many of us played railroad as a child and dreamed of a second or third rail set to build our branch from the balcony to the hallway.  Our team managed to take part in the virtual construction of a huge transsib with interchanges that amaze imagination. <br><br>  By the way, on the website Kanobu a contest with tickets to Igromir as a prize will last another week. <br>  <a href="http://kanobu.ru/special/rzd/">Link to the game</a> <br>  <a href="http://gameofbombs.com/demos/railroad/v3/">and out of competition version</a> (without Kanobu wrapper) <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The plot of the game is the exact opposite of subway surfer, it is necessary to protect the train from the raids of idiots.  Since this is an official game, the guard cannot get out of the train and hang on the game.  The train can not get into an accident or even accidentally crush someone.  In the process there were many tempting ideas, maybe sometime the world will see a version with a train that destroys crowds of zombies. <br><br>  This article is not a hello-world for a crappy bird style HTML5 game.  We are talking about a real project from the developer‚Äôs point of view, a crane for deadlines, writing a game with a bunch of hacks, making a huge chain of customers ringing the project on the last day, without a time reserve.  Do you want a clean code - go to <a href="https://github.com/ivanpopelyshev/railways">github</a> and torment our child as you want.  The code is under the MIT license, but all art is not included here. <br><br>  How RZD cares about security, we know from the huge screens at the stations.  Personally, I think that if these videos were not censored, and were performed in the style of mortal kombat, the effect would have been much greater (Poezd wins. Fatality). <br><br><img src="https://habrastorage.org/files/df3/fb8/5e5/df3fb85e5a4045fbb71def5d00e82440.gif"><br><br>  So, somewhere in RZD they decided that it would be nice to make a small promo with an emphasis on safety on the railways.  A complex chain of intermediaries eventually led to us <br><br>  TK was painted fairly straight: there should be a generated level, a top-side view, a train corresponding to the style of Russian Railways, 6 types of obstacles and 3 super heroes explaining how not to behave on the tracks.  All this should work on adequate browsers, on PCs and tablets.  Superman, Spiderman and ‚Äúthat guy from GTA San Andreas‚Äù were chosen as super heroes ... <br><br>  Do you think we used our super-engine, which can render everything on DIV or on CANVAS2D or SVG and draws only those places where something has changed?  Do you think we took our super-CMS to generate pages and script management?  No, we took the easiest renderer in the world - <a href="http://www.pixijs.com/">pixi.js</a> , the easiest script <a href="http://gulpjs.com/">builder</a> at the moment - <a href="http://gulpjs.com/">gulp</a> + <a href="http://browserify.org/">browserify</a> , the simplest library for single-app - <a href="http://angular.ru/">angular.js</a> , the dumbest backend - node.js, the dumbest sprite slicer - <a href="http://www.renderhjs.net/shoebox/">shoebox</a> , the easiest to use 3d editor - <a href="http://www.blender.org/">blender</a> , the dumbest editor of polygons - <a href="https://www.codeandweb.com/physicseditor">physicseditor</a> , the best skeleton 2d-animator <a href="http://ru.esotericsoftware.com/">spine</a> .  We have no infrastructure issues.  We did not technically stand out. <br><br>  A free plan was drawn up: <br>  0) the train will pass the whole screen, and stop at the station until the next screen is generated. <br>  1) it is necessary to have a path with a fixed curvature on the turns, which can be lengthened and from which it is possible to obtain the coordinates of the sleepers. <br>  2) the path must be able to check for self-intersection.  We use a simple grid, stored in each cell who crosses it.  Smaller grid - more likely that the paths will begin to intersect. <br>  3) the path must end somewhere on the right of the screen so that it can be continued when generating the next screen. <br>  4) there must be a stupid algorithm that goes through such paths and chooses a prettier and more authentic one. <br>  5) the result can be filled with different objects (trees and pebbles). <br>  6) the train can be rented in 32 frames.  It does not look very good, but the "turning the sprite" to the desired angle right in the game solves everything.  This was done rather quickly, the result / time ratio was awesome, you could meditate on the demo: <br><br>  <a href="https://gameofbombs.com/demos/railroad/v1/">first demo</a> <br><br>  The work was far ahead of the schedule, and the path generation could have been left as it was, but someone in the middle of the chain decided to play a serious customer, and said that another option was needed.  With smooth scrolling.  The damaged phone added something about arrows and additional paths, and this all led to three weeks of debugging, optimizations and transferring the brake generator to the webworker, for it inevitably affected the FPS. <br><br>  <a href="https://gameofbombs.com/demos/railroad/v2/">second demo</a> <br><br>  Just imagine that parts of the road that is generated when generating graphs need to be run through serialization in order to transfer from the webworker to the page.  A real nightmare, it's very easy to forget some important parameters.  At the same time, it is necessary to monitor and chop off the already passed screens in order not to litter the memory. <br><br>  From one of the intermediate results, literally everyone was sick: <a href="https://gameofbombs.com/demos/railroad/v2.1/">at one‚Äôs own fear ...</a> <br><br>  Of the difficulties, we can especially note the case when, after an already generated screen, it was not possible to find a continuation for it, because some kind of rail ran into the next station, or at the edge of the screen.  If it is not possible to generate a new screen in 30 passes, it rolls back 1 screen.  Sometimes it is noticeable graphically, right along the train changes the future path. <br><br>  Well, the process of merging and splitting paths also added hassle.  We often began to walk in a circle: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/af9/55d/be7/af955dbe784fe53f64c4be1d07a1f914.jpg" alt="image"><br><br>  The switch of the arrows ended up stabbed, and this upset us all very much. <br><br>  No less than the companion similar to the hero from GTA.  Upstairs they decided that he was too "bydlovat": <br><img src="https://habrastorage.org/getpro/geektimes/post_images/79d/cd8/cc1/79dcd8cc1a8dff0c9a6970c0592d8d7f.jpg" alt="Semki there?"><br><br>  Then came the obstacles (in the literal sense, they had to be done according to the TK).  It was here that we took revenge in full and showed how we can put obstacles in place: our ‚Äúart director‚Äù went on vacation in August and, due to the lengthy rework of the generator, did not manage to coordinate many moments with the customer.  I regularly approached the computer, reread the point about the obstacles, I did not understand what to do with it, and as a result I spent time optimizing the game (various 2d / webgl options, stuffing sprites into the atlas) instead of dealing with the artists and clarifying the script .  Dissatisfaction with the lack of significant updates passed along the chain, starting with the main customer, and stopped at kanobu.ru, which tolerated, but behaved with us quite correctly.  A week before the deadlock, this deadlock was jointly resolved, a detailed script was drawn up, idiots and other elements of obstacles were drawn.  On the scheduled day everything worked as it should. <br><br>  The server part is quite simple, it can record the results coming from ajax-requests.  There were no problems with it, everything was done on the last day, and even enough time with protection from the most obvious hacks.  I think those who break the system so that I do not notice, are worthy of prizes. <br><br>  After the launch of the project, it turned out that on many devices the generator is too slow and does not have time to build a path in front.  The output turned out to be trivial - they changed the json format of the card to a binary one and generated 100 thousand screens on the server side.  This became possible because the game is divided into node.js modules and compiled using browserify.  The player starts on a random screen in the first half, and until the cached screens run out and they have to use the generator for a long time instead of loading the screens from the server :) <br><br>  This approach had an unexpected effect: in the ‚ÄúFar East‚Äù, very crooked roads appeared. <br><img src="https://habrastorage.org/getpro/habr/post_images/8e0/13c/4b3/8e013c4b3d1fed42f3e09073935d4e32.png" alt="image"><br><br>  Due to the fact that in the binary we wrote float and not double, on the screens with a huge x-coordinate (tens of millions) there was a lack of accuracy of coordinates, the rails were joined with errors of 1-2 pixels.  Yes, <a href="http://minecraft.gamepedia.com/Far_Lands">Far lands</a> began with us much earlier than in minecraft.  The same error began to appear when drawing the rail <br>  The curvature of the Far Eastern rail corrected the transition from global to local coordinates relative to the screen. <br><br>  To start from any place, the whole road is divided into dozens of screens, and stored in different files.  In this case, the final segments of the rails must be duplicated in the previous and next file, otherwise it will not be possible to start driving not from the first file.  And we forgot to delete this duplicate rail when loading the next dozens of screens, and since the coordinates of the rail were calculated somewhat pertly so as not to go to the far east, the result looked just gorgeous: <br><img src="https://habrastorage.org/getpro/habr/post_images/8d7/c8c/877/8d7c8c877009dfcdd4fa3e594f86d829.png" alt="image"><br><br>  Rivers and bridges are one of the most pervasive parts of the generator.  The fact is that the river flows through several screens at once and this greatly influences the ability of our random generator to continue the path.  Quite often, the screen with the beginning of the river falls under rollback, the rivers simply do not withstand evolutionary selection.  Careful selection of constants and the next trick solved this problem: when a rail crosses a river, the generator tries to lengthen it and put a bridge under it.  In the process of iterating the path, if the rail is removed, then the bridge must be removed along with it.  True, in some cases only the bridge was removed.  So there was a sawing bug. <br><img src="https://habrastorage.org/getpro/habr/post_images/40c/729/04b/40c72904bb66c6269b5c370652ffd22e.png" alt="image"><br><br>  Prospects for the game are excellent: based on the resulting generator, you can make a lot of new projects.  You can add jokes and realism, which everyone craves so much (if the train does not crush the idiot, then at least the security will come out and take revenge). <br>  You can write about what we have done innovative artificial intelligence, which generates ways for Russian Railways, win some prize in start-up parties, find an investor ... <br><br>  PS Especially for Habrozhilov from today somewhere around the 2015th mark there is a small Easter egg. <br>  PPS The article was accidentally published originally on GT, not for a long time;) </div><p>Source: <a href="https://habr.com/ru/post/267179/">https://habr.com/ru/post/267179/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../267165/index.html">ES6 in detail: proxy</a></li>
<li><a href="../267167/index.html">New attack on Microsoft Exchange mail server allows you to steal passwords</a></li>
<li><a href="../267173/index.html">Algorithm for schoolchildren: from beginner to Olympic medalist</a></li>
<li><a href="../267175/index.html">As we did ABC analysis for retail, or ‚Äúwithout half a liter you will not understand‚Äù</a></li>
<li><a href="../267177/index.html">Secure login with PHPixie 3</a></li>
<li><a href="../267181/index.html">Using CSS4 features today with cssnext</a></li>
<li><a href="../267183/index.html">Ethernet + PCIe + FPGA = LOVE</a></li>
<li><a href="../267185/index.html">The course "Basics of effective work with Wolfram technologies". Lesson 2.2: Defining Functions, Working with Lists, Template Expressions, and Associations</a></li>
<li><a href="../267187/index.html">How I became a programmer. The path from St. Petersburg homeless to Senior Developer for 6 years</a></li>
<li><a href="../267189/index.html">IP monitoring in blacklists using Zabbix</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>