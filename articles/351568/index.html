<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Minimal multiboot bootloader</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article explains how to create a minimal operating system kernel using the multi-boot standard. In fact, it will just load and print OK on the sc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Minimal multiboot bootloader</h1><div class="post__text post__text-html js-mediator-article"><p> This article explains how to create a minimal operating system kernel using the multi-boot standard.  In fact, it will just load and print <code>OK</code> on the screen.  In subsequent articles, we will expand it using the <code>Rust</code> programming language. </p><br><p>  I tried to explain everything in detail and keep the code as simple as possible.  If you have any questions, suggestions or any problems, please leave a comment or <a href="https://github.com/phil-opp/blog_os/issues">create a taska</a> on <code>GitHub</code> .  The source code is available in the <a href="https://github.com/phil-opp/blog_os/tree/post_1/src/arch/x86_64">repository</a> . </p><br><p><img src="https://habrastorage.org/webt/pk/qx/0v/pkqx0vqxynqm6w6pbcerba3h89a.jpeg"></p><a name="habracut"></a><br><h1 id="obzor">  Overview </h1><br><p>  When you turn on the computer, it loads the <a href="https://en.wikipedia.org/wiki/BIOS">BIOS</a> from a special flash memory.  <code>BIOS</code> runs self-tests and hardware initialization tests, then it looks for bootable devices.  If at least one was found, it transfers control to the loader, which is a small part of the executable code stored at the beginning of the storage device.  The loader locates the kernel image on the device and loads it into memory.  It also needs to switch the processor to the so-called <a href="https://en.wikipedia.org/wiki/Protected_mode">protected mode</a> , because x86 processors by default start in very limited <a href="https://wiki.osdev.org/Real_Mode">real mode</a> (to be compatible with programs from 1978). </p><br><p>  We will not write a bootloader, because this is in itself a complex project (if you really want to do this, <a href="https://wiki.osdev.org/Rolling_Your_Own_Bootloader">read about it here</a> ).  Instead, we will use one of the <a href="https://en.wikipedia.org/wiki/Comparison_of_boot_loaders">many tried and tested boot loaders</a> to boot our kernel from a CD-ROM.  But which one? </p><br><h1 id="multizagruzka">  Multiboot </h1><br><p>  Fortunately, there is a bootloader standard: <a href="https://en.wikipedia.org/wiki/Multiboot_Specification">multiboot specification</a> .  Our kernel should only indicate that it supports the specification and any compatible bootloader will be able to download it.  We will use the <code>Multiboot 2</code> specification ( <a href="http://nongnu.askapache.com/grub/phcoder/multiboot.pdf">PDF</a> ) <br>  along with the famous boot loader <a href="https://wiki.osdev.org/GRUB_2">GRUB 2</a> . </p><br><p>  To tell the loader about <code>Multiboot 2</code> support, our kernel must begin with <code> </code> , which has the following format: </p><br><table><thead><tr><th>  Field </th><th>  Type </th><th>  Value </th></tr></thead><tbody><tr><td>  magic number </td><td>  u32 </td><td> <code>0xE85250D6</code> </td> </tr><tr><td>  architecture </td><td>  u32 </td><td>  <code>0</code> for i386, <code>4</code> for MIPS </td></tr><tr><td>  header length </td><td>  u32 </td><td>  total header size including tags </td></tr><tr><td>  check sum </td><td>  u32 </td><td> <code>-(  +  +  )</code> </td> </tr><tr><td>  tags </td><td>  variable </td></tr><tr><td>  trailing tag </td><td>  (u16, u16, u32) </td><td> <code>(0, 0, 8)</code> </td> </tr></tbody></table><br><p>  Translated to x86 assembler, it will look like this ( <code>Intel</code> syntax): </p><br><pre> <code class="hljs go">section .multiboot_header header_start: dd <span class="hljs-number"><span class="hljs-number">0xe85250d</span></span>6 ;   (multiboot <span class="hljs-number"><span class="hljs-number">2</span></span>) dd <span class="hljs-number"><span class="hljs-number">0</span></span> ;  <span class="hljs-number"><span class="hljs-number">0</span></span> (  i386) dd header_end - header_start ;   ;   dd <span class="hljs-number"><span class="hljs-number">0x100000000</span></span> - (<span class="hljs-number"><span class="hljs-number">0xe85250d</span></span>6 + <span class="hljs-number"><span class="hljs-number">0</span></span> + (header_end - header_start)) ;   <span class="hljs-string"><span class="hljs-string">`multiboot`</span></span>   ;    dw <span class="hljs-number"><span class="hljs-number">0</span></span> ;  dw <span class="hljs-number"><span class="hljs-number">0</span></span> ;  dd <span class="hljs-number"><span class="hljs-number">8</span></span> ;  header_end:</code> </pre> <br><p>  If you don't know the x86 assembler, then here is a little introductory: </p><br><ul><li>  the title will be written to a section called <code>.multiboot_header</code> (we will need this later), </li><li>  <code>header_start</code> and <code>header_end</code> are tags that indicate the location in memory, we use them to calculate the length of the header, </li><li>  <code>dd</code> means <code>define double</code> (32bit) and <code>dw</code> means <code>define word</code> (16bit).  They simply output the specified 32bit / 16bit constants, </li><li>  The constant <code>0x100000000</code> in calculating the checksum is a small hack to avoid compiler warnings. </li></ul><br><p>  We can already build this file (which I called <code>multiboot_header.asm</code> ) using <code>nasm</code> . </p><br><div class="spoiler">  <b class="spoiler_title">Installing nasm on `archlinux`</b> <div class="spoiler_text"><pre> <code class="hljs coffeescript">[loomaclin@loomaclin ~]$ yaourt nasm <span class="hljs-number"><span class="hljs-number">1</span></span> extra/nasm <span class="hljs-number"><span class="hljs-number">2.13</span></span><span class="hljs-number"><span class="hljs-number">.02</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span> An <span class="hljs-number"><span class="hljs-number">80</span></span>x86 assembler designed <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> portability <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> modularity <span class="hljs-number"><span class="hljs-number">2</span></span> extra/yasm <span class="hljs-number"><span class="hljs-number">1.3</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span> A rewrite <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> NASM to allow <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> multiple syntax supported (NASM, TASM, GAS, etc.) <span class="hljs-number"><span class="hljs-number">3</span></span> aur/intel2gas <span class="hljs-number"><span class="hljs-number">1.3</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">-7</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>) (<span class="hljs-number"><span class="hljs-number">0.20</span></span>) Converts assembly language files between NASM <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> GNU assembler syntax <span class="hljs-number"><span class="hljs-number">4</span></span> aur/nasm-git <span class="hljs-number"><span class="hljs-number">20150726</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-number"><span class="hljs-number">0.00</span></span>) <span class="hljs-number"><span class="hljs-number">80</span></span>x86 assembler designed <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> portability <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> modularity <span class="hljs-number"><span class="hljs-number">5</span></span> aur/sasm <span class="hljs-number"><span class="hljs-number">3.9</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span> (<span class="hljs-number"><span class="hljs-number">18</span></span>) (<span class="hljs-number"><span class="hljs-number">0.61</span></span>) Simple crossplatform IDE <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> NASM, MASM, GAS, FASM assembly languages <span class="hljs-number"><span class="hljs-number">6</span></span> aur/yasm-git <span class="hljs-number"><span class="hljs-number">1.3</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>.r30.g6caf1518<span class="hljs-number"><span class="hljs-number">-1</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>) (<span class="hljs-number"><span class="hljs-number">0.00</span></span>) A complete rewrite <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the NASM assembler under the BSD License =<span class="hljs-function"><span class="hljs-function">=&gt;</span></span> Enter n¬∞ <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> packages to be installed (eg, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span>) =<span class="hljs-function"><span class="hljs-function">=&gt;</span></span> --------------------------------------------------------- =<span class="hljs-function"><span class="hljs-function">=&gt;</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> [sudo] password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> loomaclin: resolving dependencies... looking <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> conflicting packages... Packages (<span class="hljs-number"><span class="hljs-number">1</span></span>) nasm<span class="hljs-number"><span class="hljs-number">-2.13</span></span><span class="hljs-number"><span class="hljs-number">.02</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span> Total Download Size: <span class="hljs-number"><span class="hljs-number">0.34</span></span> MiB Total Installed Size: <span class="hljs-number"><span class="hljs-number">2.65</span></span> MiB :: Proceed with installation? [Y/n] :: Retrieving packages... nasm<span class="hljs-number"><span class="hljs-number">-2.13</span></span><span class="hljs-number"><span class="hljs-number">.02</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>-x86_64 <span class="hljs-number"><span class="hljs-number">346.0</span></span> KiB <span class="hljs-number"><span class="hljs-number">1123</span></span>K/s <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> [<span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">#####] 100% (1/1) checking keys in keyring [###</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">##] 100% (1/1) checking package integrity [#############################################################################] 100% (1/1) loading package files [#############################################################################] 100% (1/1) checking for file conflicts [#############################################################################] 100% (1/1) checking available disk space [#############################################################################] 100% :: Processing package changes... (1/1) installing nasm [#############################################################################] 100% :: Running post-transaction hooks... (1/1) Arming ConditionNeedsUpdate... [loomaclin@loomaclin ~]$ nasm --version NASM version 2.13.02 compiled on Dec 10 2017 [loomaclin@loomaclin ~]$</span></span></code> </pre> </div></div><br><p>  The following command will produce a flat binary file, the resulting file will contain 24 bytes (in <code>little endian</code> , if you are working on an x86 machine): </p><br><pre> <code class="hljs ruby">[loomaclin@loomaclin ~]$ cd IdeaProjects/ [loomaclin@loomaclin IdeaProjects]$ mkdir a_minimal_multiboot_kernel [loomaclin@loomaclin IdeaProjects]$ cd a_minimal_multiboot_kernel/ [loomaclin@loomaclin a_minimal_multiboot_kernel]$ nano multiboot_header.asm [loomaclin@loomaclin a_minimal_multiboot_kernel]$ nasm multiboot_header.asm [loomaclin@loomaclin a_minimal_multiboot_kernel]$ hexdump -x multiboot_header <span class="hljs-number"><span class="hljs-number">0000000</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span>d6 e852 <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">001</span></span>8 <span class="hljs-number"><span class="hljs-number">0000</span></span> af12 <span class="hljs-number"><span class="hljs-number">17</span></span>ad <span class="hljs-number"><span class="hljs-number">0000010</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">000</span></span>8 <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">000001</span></span>8 [loomaclin@loomaclin a_minimal_multiboot_kernel]$</code> </pre> <br><h1 id="zagruzochnyy-kod">  Boot code </h1><br><p>  To load our kernel, we need to add code that can call the loader.  Let's create the <code>boot.asm</code> file: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">global</span></span> <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> section .text bits <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-keyword"><span class="hljs-keyword">start</span></span>: ;  `OK`   mov dword [<span class="hljs-number"><span class="hljs-number">0xb8000</span></span>], <span class="hljs-number"><span class="hljs-number">0x2f4b2f4f</span></span> hlt</code> </pre> <br><p>  There are several new commands here: </p><br><ul><li>  <code>global</code> exports tags (makes them public).  The <code>start</code> label will be the entry point to our core, it should be public, </li><li>  <code>.text</code> section is the default section for executable code. </li><li>  <code>bits 32</code> indicates that the next lines are 32-bit instructions.  This is necessary because the processor is still in <a href="https://en.wikipedia.org/wiki/Protected_mode">protected mode</a> when <code>GRUB</code> starts our kernel.  When we switch to <a href="https://en.wikipedia.org/wiki/Long_mode">Long mode</a> in the next article, we can run <code>bits 64</code> (64-bit instructions), </li><li>  <code>mov dword</code> instruction puts the 32-bit constant <code>0x2f4b2f4f</code> to the memory address of <code>b8000</code> (this displays <code>OK</code> on the screen, explained in the following articles), </li><li>  <code>hlt</code> is an instruction that tells the processor to stop executing instructions. </li></ul><br><p>  After assembling, viewing and disassembling, we can see the processor <a href="https://en.wikipedia.org/wiki/Opcode">opcodes</a> in action: </p><br><pre> <code class="hljs ruby">[loomaclin@loomaclin a_minimal_multiboot_kernel]$ nano boot.asm [loomaclin@loomaclin a_minimal_multiboot_kernel]$ nasm boot.asm [loomaclin@loomaclin a_minimal_multiboot_kernel]$ hexdump -x boot <span class="hljs-number"><span class="hljs-number">0000000</span></span> <span class="hljs-number"><span class="hljs-number">05</span></span>c7 <span class="hljs-number"><span class="hljs-number">8000</span></span> <span class="hljs-number"><span class="hljs-number">000</span></span>b <span class="hljs-number"><span class="hljs-number">2</span></span>f4f <span class="hljs-number"><span class="hljs-number">2</span></span>f4b <span class="hljs-number"><span class="hljs-number">00</span></span>f4 <span class="hljs-number"><span class="hljs-number">000000</span></span>b [loomaclin@loomaclin a_minimal_multiboot_kernel]$ ndisasm -b <span class="hljs-number"><span class="hljs-number">32</span></span> boot <span class="hljs-number"><span class="hljs-number">00000000</span></span> C70500800B004F2F mov dword [dword <span class="hljs-number"><span class="hljs-number">0xb8000</span></span>],<span class="hljs-number"><span class="hljs-number">0x2f4b2f4f</span></span> -<span class="hljs-number"><span class="hljs-number">4</span></span>B2F <span class="hljs-number"><span class="hljs-number">0000000</span></span>A F4 hlt [loomaclin@loomaclin a_minimal_multiboot_kernel]$</code> </pre> <br><h1 id="sozdanie-ispolnyaemogo-fayla">  Creating an executable file </h1><br><p>  To download our executable file later via <code>GRUB</code> , it must be an executable <code>ELF</code> file.  Therefore, you need to create <code>ELF</code> object files instead of simple binaries using <code>nasm</code> .  To do this, we simply add <code>-f elf64</code> to the arguments. </p><br><p>  To create the <code>ELF</code> executable code itself, we must link the object files.  We will use a custom <a href="https://sourceware.org/binutils/docs/ld/Scripts.html">script to bind</a> , called <code>linker.ld</code> : </p><br><pre> <code class="hljs pgsql">ENTRY(<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>) SECTIONS { . = <span class="hljs-number"><span class="hljs-number">1</span></span>M; .boot : { <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> *(.multiboot_header) } .text : { *(.text) } }</code> </pre> <br><p>  Let's translate what is written in human language: </p><br><ul><li>  <code>start</code> is the entry point, the bootloader will go to this label after the kernel is loaded, </li><li> <code>. = 1M;</code>  sets the download address of the first section from the 1st megabyte, this is the location standard for loading the kernel, </li><li>  the executable part has two sections: at the beginning of the <code>boot</code> and <code>.text</code> after, </li><li>  the final section <code>.text</code> will contain all incoming sections <code>.text</code> , </li><li>  sections named as <code>.multiboot_header</code> will be added to the first output section ( <code>.boot</code> ) so that they are located at the beginning of the executable code.  This is necessary because <code>GRUB</code> expects to find a multiboot header at the beginning of the file. </li></ul><br><p>  Let's create <code>ELF</code> object files and link them using the above linker script: </p><br><pre> <code class="hljs ruby">[loomaclin@loomaclin a_minimal_multiboot_kernel]$ nasm -f elf64 multiboot_header.asm [loomaclin@loomaclin a_minimal_multiboot_kernel]$ nasm -f elf64 boot.asm [loomaclin@loomaclin a_minimal_multiboot_kernel]$ ld -n -o kernel.bin -T linker.ld multiboot_header.o boot.o [loomaclin@loomaclin a_minimal_multiboot_kernel]$</code> </pre> <br><p>  It is very important to pass the <code>-n</code> (or <code>--nmagic</code> ) flag to the linker, which disables the automatic alignment of sections in the executable file.  Otherwise, the linker may align the page of the <code>.boot</code> section in the executable file.  If this happens, <code>GRUB</code> will not be able to find the multiboot header, because it will not be at the beginning. </p><br><p>  Use the <code>objdump</code> command to display the sections of the generated executable file and verify that the <code>.boot</code> section has the smallest offset in the file: </p><br><pre> <code class="hljs pgsql">[loomaclin@loomaclin a_minimal_multiboot_kernel]$ objdump -h kernel.bin kernel.bin: file <span class="hljs-keyword"><span class="hljs-keyword">format</span></span> elf64-x86<span class="hljs-number"><span class="hljs-number">-64</span></span> Sections: Idx <span class="hljs-type"><span class="hljs-type">Name</span></span> Size VMA LMA File <span class="hljs-keyword"><span class="hljs-keyword">off</span></span> Algn <span class="hljs-number"><span class="hljs-number">0</span></span> .boot <span class="hljs-number"><span class="hljs-number">00000018</span></span> <span class="hljs-number"><span class="hljs-number">0000000000100000</span></span> <span class="hljs-number"><span class="hljs-number">0000000000100000</span></span> <span class="hljs-number"><span class="hljs-number">00000080</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>**<span class="hljs-number"><span class="hljs-number">0</span></span> CONTENTS, ALLOC, <span class="hljs-keyword"><span class="hljs-keyword">LOAD</span></span>, READONLY, DATA <span class="hljs-number"><span class="hljs-number">1</span></span> .text <span class="hljs-number"><span class="hljs-number">0000000</span></span>b <span class="hljs-number"><span class="hljs-number">0000000000100020</span></span> <span class="hljs-number"><span class="hljs-number">0000000000100020</span></span> <span class="hljs-number"><span class="hljs-number">000000</span></span>a0 <span class="hljs-number"><span class="hljs-number">2</span></span>**<span class="hljs-number"><span class="hljs-number">4</span></span> CONTENTS, ALLOC, <span class="hljs-keyword"><span class="hljs-keyword">LOAD</span></span>, READONLY, CODE [loomaclin@loomaclin a_minimal_multiboot_kernel]$</code> </pre> <br><blockquote>  Note: The <code>ld</code> and <code>objdump</code> commands are platform-specific.  If you are not working on x86_64 architecture, you need to <a href="https://os.phil-opp.com/cross-compile-binutils/">cross-compile binutils</a> .  After that, use <code>x86_64‚Äëelf‚Äëld</code> and <code>x86_64‚Äëelf‚Äëobjdump</code> instead of <code>ld</code> and <code>objdump</code> respectively. </blockquote><br><h1 id="sozdanie-iso-obraza">  Creating an ISO image </h1><br><p>  All <code>BIOS</code> based personal computers know how to boot from a CD-ROM, so we need to create a downloadable CD-ROM image containing our kernel and <code>GRUB</code> boot files in a single file called <a href="https://en.wikipedia.org/wiki/ISO_image">ISO</a> .  Create the following directory structure and copy <code>kernel.bin</code> to the <code>boot</code> directory: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">isofiles</span></span> ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">boot</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">grub</span></span> ‚îÇ ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">grub</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cfg</span></span> ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">kernel</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.bin</span></span></code> </pre> <br><p>  <code>grub.cfg</code> indicates the name of our kernel file and compatibility with <code>multiboot 2</code> .  It looks like this: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">timeout</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span> menuentry <span class="hljs-string"><span class="hljs-string">"my os"</span></span> { multiboot2 /boot/kernel.bin boot }</code> </pre> <br><p>  Execute commands: </p><br><pre> <code class="hljs ruby">[loomaclin@loomaclin a_minimal_multiboot_kernel]$ mkdir isofiles [loomaclin@loomaclin a_minimal_multiboot_kernel]$ mkdir isofiles/boot [loomaclin@loomaclin a_minimal_multiboot_kernel]$ mkdir isofiles/boot/grub [loomaclin@loomaclin a_minimal_multiboot_kernel]$ cp kernel.bin isofiles/boot/ [loomaclin@loomaclin a_minimal_multiboot_kernel]$ nano grub.cfg [loomaclin@loomaclin a_minimal_multiboot_kernel]$ cp grub.cfg isofiles/boot/grub/</code> </pre> <br><p>  Now we can create a bootable image using the following command: </p><br><pre> <code class="hljs pgsql">[loomaclin@loomaclin a_minimal_multiboot_kernel]$ grub-mkrescue -o os.iso isofiles xorriso <span class="hljs-number"><span class="hljs-number">1.4</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span> : RockRidge filesystem manipulator, libburnia project. Drive <span class="hljs-keyword"><span class="hljs-keyword">current</span></span>: -outdev <span class="hljs-string"><span class="hljs-string">'stdio:os.iso'</span></span> Media <span class="hljs-keyword"><span class="hljs-keyword">current</span></span>: stdio file, overwriteable Media status : <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> blank Media <span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> sessions, <span class="hljs-number"><span class="hljs-number">0</span></span> data blocks, <span class="hljs-number"><span class="hljs-number">0</span></span> data, <span class="hljs-number"><span class="hljs-number">7675</span></span>m free Added <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> ISO image: directory <span class="hljs-string"><span class="hljs-string">'/'</span></span>=<span class="hljs-string"><span class="hljs-string">'/tmp/grub.jN4u6m'</span></span> xorriso : <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> : <span class="hljs-number"><span class="hljs-number">898</span></span> files added <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> seconds Added <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> ISO image: directory <span class="hljs-string"><span class="hljs-string">'/'</span></span>=<span class="hljs-string"><span class="hljs-string">'/home/loomaclin/IdeaProjects/a_minimal_multiboot_kernel/isofiles'</span></span> xorriso : <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> : <span class="hljs-number"><span class="hljs-number">902</span></span> files added <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> seconds xorriso : NOTE : Copying <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span> Area: <span class="hljs-number"><span class="hljs-number">512</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> file <span class="hljs-string"><span class="hljs-string">'/usr/lib/grub/i386-pc/boot_hybrid.img'</span></span> ISO image produced: <span class="hljs-number"><span class="hljs-number">9920</span></span> sectors Written <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> medium : <span class="hljs-number"><span class="hljs-number">9920</span></span> sectors at LBA <span class="hljs-number"><span class="hljs-number">0</span></span> Writing <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-string"><span class="hljs-string">'stdio:os.iso'</span></span> completed successfully.</code> </pre> <br><blockquote>  Note: <code>grub-mkrescue</code> may cause problems on some platforms.  If it did not work for you, try the following steps: <br><ul><li>  run the command with <code>--verbose</code> , </li><li>  make sure the <code>xorriso</code> library <code>xorriso</code> installed ( <code>xorriso</code> or <code>libisoburn</code> package). </li></ul><br></blockquote><br><div class="spoiler">  <b class="spoiler_title">`Archlinux had to put` libisoburn`</b> <div class="spoiler_text"><p>  [loomaclin @ loomaclin a_minimal_multiboot_kernel] $ yaourt xorriso <br>  1 extra / libisoburn 1.4.8-2 <br>  frontend for libburn and libisofs <br>  ==&gt; Enter n ¬∞ of packages to be installed (eg, 1 2 3 or 1-3) <br>  ==&gt; - ==&gt; 1 </p><br><p>  [sudo] password for loomaclin: <br>  resolving dependencies ... <br>  looking for conflicting packages ... </p><br><p>  Packages (3) libburn-1.4.8-1 libisofs-1.4.8-1 libisoburn-1.4.8-2 </p><br><p>  Total Download Size: 1.15 MiB <br>  Total Installed Size: 3.09 MiB </p><br><p>  :: Proceed with installation?  [Y / n] <br>  :: Retrieving packages ... <br>  libburn-1.4.8-1-x86_64 259.7 KiB 911K / s 00:00 [################################ #############################################] 100% <br>  libisofs-1.4.8-1-x86_64 237.8 KiB 2.04M / s 00:00 [################################ ##############################################] 100% <br>  libisoburn-1.4.8-2-x86_64 683.8 KiB 2.34M / s 00:00 [################################ ##############################################] 100% <br>  (3/3) checking keys in keyring [############################## #####################################] 100% <br>  (3/3) checking package integrity [########################################## ####################################] 100% <br>  (3/3) loading package files [######################################### ####################################] 100% <br>  (3/3) checking for file conflicts [############################## #####################################] 100% <br>  (3/3) checking available disk space [######################################## #####################################] 100% <br>  :: Processing package changes ... <br>  (1/3) installing libburn [########################################## ###################################] 100% <br>  (2/3) installing libisofs [######################################### ###################################] 100% <br>  (3/3) installing libisoburn </p></div></div><br><ul><li>  if you are using an EFI system, <code>grub-mkrescue</code> will try to create an <code>EFI</code> default image.  You can specify the <code>-d /usr/lib/grub/i386-pc</code> argument to get rid of this behavior, or install the <code>mtools</code> package and get a working <code>EFI</code> image </li><li>  on some systems, the command is named <code>grub2-mkrescue</code> . </li></ul><br><h1 id="zagruzka">  Loading </h1><br><p>  It's time to download our OS.  To do this, use <a href="https://en.wikipedia.org/wiki/QEMU">QEMU</a> : </p><br><pre> <code class="hljs pgsql">[loomaclin@loomaclin a_minimal_multiboot_kernel]$ qemu-<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>-x86_64 -cdrom os.iso (qemu-<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>-x86_64:<span class="hljs-number"><span class="hljs-number">10878</span></span>): Gtk-<span class="hljs-built_in"><span class="hljs-built_in">WARNING</span></span> **: Allocating size <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> GtkScrollbar <span class="hljs-number"><span class="hljs-number">0x7f2337e5a280</span></span> <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> calling gtk_widget_get_preferred_width/height(). How does the code know the size <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> allocate? (qemu-<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>-x86_64:<span class="hljs-number"><span class="hljs-number">10878</span></span>): Gtk-<span class="hljs-built_in"><span class="hljs-built_in">WARNING</span></span> **: Allocating size <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> GtkScrollbar <span class="hljs-number"><span class="hljs-number">0x7f2337e5a480</span></span> <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> calling gtk_widget_get_preferred_width/height(). How does the code know the size <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> allocate? (qemu-<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>-x86_64:<span class="hljs-number"><span class="hljs-number">10878</span></span>): Gtk-<span class="hljs-built_in"><span class="hljs-built_in">WARNING</span></span> **: Allocating size <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> GtkScrollbar <span class="hljs-number"><span class="hljs-number">0x7f2337e5a680</span></span> <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> calling gtk_widget_get_preferred_width/height(). How does the code know the size <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> allocate?</code> </pre> <br><p>  The emulator window will appear: <br><img src="https://habrastorage.org/webt/7g/fg/tn/7gfgtnzoyal0krrhb9z4xgyvgua.png" alt="Emulator window"></p><br><p>  Notice the green text <code>OK</code> in the upper left corner.  If this doesn't work for you, look at the comments section. </p><br><p>  Summarize what happened: </p><br><ol><li>  The BIOS boots the boot loader (GRUB) from a virtual CD-ROM (ISO). </li><li>  The loader read the executable kernel code and found the multiboot header. </li><li>  I copied the <code>.boot</code> and <code>.text</code> <code>.boot</code> into memory (at <code>0x100000</code> and <code>0x100020</code> ). </li><li>  Moved to the entry point ( <code>0x100020</code> , this can be found by calling <code>objdump -f</code> ). </li><li>  The kernel displayed the text <code>OK</code> green and stopped the processor. </li></ol><br><p>  You can also test it on real hardware.  You need to write the resulting image to a disk or USB drive and boot from it. </p><br><h1 id="avtomatizaciya-sborki">  Assembly automation </h1><br><p>  Now you need to call 4 commands in the correct order every time we change the file.  This is bad.  Let's automate this process with a <a href="http://mrbook.org/blog/tutorials/make/">Makefile</a> .  But first we need to create a suitable directory structure to separate the architecture-dependent files: </p><br><pre> <code class="hljs css">‚Ä¶ ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">Makefile</span></span> ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">src</span></span> ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">arch</span></span> ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">x86_64</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">multiboot_header</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.asm</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">boot</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.asm</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">linker</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ld</span></span> ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">grub</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cfg</span></span></code> </pre> <br><p>  Create: </p><br><pre> <code class="hljs ruby">[loomaclin@loomaclin a_minimal_multiboot_kernel]$ mkdir -p src/arch/x86_64 [loomaclin@loomaclin a_minimal_multiboot_kernel]$ cp multiboot_header.asm src/arch/x86_64/ [loomaclin@loomaclin a_minimal_multiboot_kernel]$ cp boot.asm src/arch/x86_64/ [loomaclin@loomaclin a_minimal_multiboot_kernel]$ cp linker.ld src/arch/x86_64/ [loomaclin@loomaclin a_minimal_multiboot_kernel]$ cp grub.cfg src/arch/x86_64/ [loomaclin@loomaclin a_minimal_multiboot_kernel]$ nano Makefile</code> </pre> <br><p>  The makefile should look like this: </p><br><pre> <code class="hljs ruby">arch ?= x86_64 kernel <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= build/kernel-$(arch).bin iso <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= build/os-$(arch).iso linker_script <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= src/arch/$(arch)/linker.ld grub_cfg <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= src/arch/$(arch)/grub.cfg assembly_source_files <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= $(wildcard src/arch/$(arch)/*.asm) assembly_object_files <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= $(patsubst src/arch/$(arch)/%.asm, \ build/arch/$(arch)/%.o, $(assembly_source_files)) .<span class="hljs-symbol"><span class="hljs-symbol">PHONY:</span></span> all clean run iso <span class="hljs-symbol"><span class="hljs-symbol">all:</span></span> $(kernel) <span class="hljs-symbol"><span class="hljs-symbol">clean:</span></span> @rm -r build <span class="hljs-symbol"><span class="hljs-symbol">run:</span></span> $(iso) @qemu-system-x86_64 -cdrom $(iso) <span class="hljs-symbol"><span class="hljs-symbol">iso:</span></span> $(iso) $(iso): $(kernel) $(grub_cfg) @mkdir -p build/isofiles/boot/grub @cp $(kernel) build/isofiles/boot/kernel.bin @cp $(grub_cfg) build/isofiles/boot/grub @grub-mkrescue -o $(iso) build/isofiles <span class="hljs-number"><span class="hljs-number">2</span></span>&gt; <span class="hljs-regexp"><span class="hljs-regexp">/dev/null</span></span> @rm -r build/isofiles $(kernel): $(assembly_object_files) $(linker_script) @ld -n -T $(linker_script) -o $(kernel) $(assembly_object_files) <span class="hljs-comment"><span class="hljs-comment"># compile assembly files build/arch/$(arch)/%.o: src/arch/$(arch)/%.asm </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@mkdir</span></span></span><span class="hljs-comment"> -p $(shell dirname $@) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@nasm</span></span></span><span class="hljs-comment"> -felf64 $&lt; -o $@</span></span></code> </pre> <br><p>  Some comments (if you didn‚Äôt work with <code>make</code> before, check out the <a href="http://mrbook.org/blog/tutorials/make/">makefile tutorial</a> ): </p><br><ul><li>  $ (wildcard src / arch / $ (arch) / *. asm) selects all the assembler files in the <code>src/arch/$(arch)</code> directory, so you do not need to update the Makefile when adding files, </li><li>  the <code>patsubst</code> operation for <code>assembly_object_files</code> simply translates <code>src/arch/$(arch)/XYZ.asm</code> to <code>build/arch/$(arch)/XYZ.o</code> , </li><li>  the build target <code>$&lt;</code> and <code>$@</code> are <a href="https://www.gnu.org/software/make/manual/html_node/Automatic-Variables.html">automatically output variables</a> , </li><li>  if you are using <a href="https://os.phil-opp.com/cross-compile-binutils/">cross-compiled binutils</a> just replace <code>ld</code> with <code>x86_64-elf-ld</code> . </li></ul><br><p>  Now we can call <code>make</code> and all updated assembler files will be compiled and linked.  The <code>make iso</code> command also creates an ISO image, and <code>make run</code> runs QEMU in addition. </p><br><h1 id="chto-dalshe">  What's next? </h1><br><p>  In the <a href="https://os.phil-opp.com/entering-longmode/">next article,</a> we will create a page table and perform some processor configuration to switch to 64-bit <a href="https://en.wikipedia.org/wiki/Long_mode">long-mode</a> . </p><br><h1 id="primechaniya">  Notes </h1><br><ol><li>  The formula from the table <code>-(magic + architecture + header_length)</code> creates a negative value that does not fit into 32 bits.  By subtracting from <code>0x100000000</code> we leave the value positive without changing the subtracted value.  As a result, without an extra sign bit, the result is placed in 32 bits and the compiler is happy :) </li><li>  We do not want to load the kernel by offset 0x0, since many specific memory areas can be located up to 1 megabyte mark (for example, the so-called VGA buffer at <code>0xb8000</code> , which we use to display <code>OK</code> on the screen). </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/351568/">https://habr.com/ru/post/351568/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351556/index.html">We implement our operator in the Entity Framework Core</a></li>
<li><a href="../351558/index.html">Jessica Livingston (Y Combinator): ‚ÄúThe Sound of Silence‚Äù</a></li>
<li><a href="../351562/index.html">From patches in the fight against malware to a holistic strategy</a></li>
<li><a href="../351564/index.html">Wireless LANs or how Wi-Fi works according to IEEE 802.11 standard. Lab at Packet Tracer</a></li>
<li><a href="../351566/index.html">A few tips on organizing a Python application on the server</a></li>
<li><a href="../351570/index.html">Rust: try overloading functions</a></li>
<li><a href="../351572/index.html">CleanTalk Malware Scanner - Heuristic Code Analysis</a></li>
<li><a href="../351574/index.html">Convert IP range to Classless Addressing (CIDR) and back to Go</a></li>
<li><a href="../351576/index.html">13 reasons to switch to Kanban. And no superstition</a></li>
<li><a href="../351580/index.html">One million plus one equals one million. Theory of Relativity of the Natural Series</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>