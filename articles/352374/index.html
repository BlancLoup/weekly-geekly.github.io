<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multithreading on ships</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Task producer / consumer 
 The article is intended for beginners who have recently begun their acquaintance with the world of multithreading on JAVA. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multithreading on ships</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/is/qu/ds/isqudsql6omzujlf2zkjemnik8a.gif"></div><br><h4>  Task producer / consumer </h4><br>  The article is intended for beginners who have recently begun their acquaintance with the world of multithreading on JAVA. <br><a name="habracut"></a><br>  Not so long ago, I did an internship at EPAM and among the list of tasks that young Padawan needed to perform was a multi-threaded task.  To be fair, it‚Äôs worth noting that no one was forced to do it with low-level tools such as wait () and notify (), when you can use ArrayBlockingQueue, Semophore and the generally powerful API (java.util.concurrent) without great tricks.  Moreover, it is considered a bad practice when instead of reinventing one's own bike, ready for any scenario, while the API hides the overwhelming complexity of parallelism.  I implemented both native variants using the API.  Today I will show 1 option. <br><br>  For a start, I suggest to get acquainted with the <a href="https://habrahabr.ru/post/164487/">following article</a> . <br>  <a href="https://github.com/javanuris/multithreading_ships">Link to this project</a> . <br><br>  <b>The task was the following:</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  There are transport ships that swim up to the tunnels and then sail to the berths for loading various kinds of goods. </li><li>  They pass through a narrow tunnel where only 5 ships can be at a time.  Under the word ‚Äúswim up to the tunnels‚Äù is meant that the ships should appear from somewhere.  There may be a limited number, that is, 10 or 100, or there may be an infinite number.  The word ‚Äúswim up‚Äù is called the ship generator. </li><li>  The type of ships and their capacity may vary depending on the type of goods that need to be loaded onto the ship.  That is, for TK, I came up with 3 types of ships (bread, banana and clothing) and three types of capacity of 10, 50, 100 pcs.  goods.  3 types of ships * 3 types of capacity = 9 different types of ships. </li><li>  Then there are 3 types of berths for loading ships - Bread, Banana and Clothes.  Each berth takes or calls to itself the ship it needs and begins to load it.  In one second the mooring loads 10 units on the ship.  goods.  That is, if the ship has a capacity of 50 pcs., Then the pier will load it in 5 seconds of its work. </li></ol><br>  <b>The requirement was the following:</b> <br><br><ul><li>  Correctly break the task into parallelism. </li><li>  Synchronize streams, maintain data integrity.  After all, it‚Äôs not difficult to limit the access of threads to a shared resource, and it is much more difficult to make them work in concert. </li><li>  The work of the ship generator should not depend on the work of the berths and vice versa. </li><li>  Shared resource should be Thread Safe (If there is one in the implementation) </li><li>  Threads should not be active if there are no tasks. </li><li>  Threads should not hold mutex if there are no tasks. </li></ul><br>  And so let's go! <br><br>  To begin with, I drew a diagram to make it clearer what was happening. <br><br><img src="https://habrastorage.org/webt/gt/lj/rt/gtljrtvqi31c_lqpcyvusdgcx2c.jpeg"><br><br>  Before solving any problem, it is considered good practice to visualize it on the surface of the paper.  Especially when it comes to multi-threaded application. <br>  Let's break our application into components, in our case into classes.  The structure of the project. <br><br><img src="https://habrastorage.org/webt/wr/fa/sh/wrfash-icymrlemnpz9ifkjviyg.jpeg"><br><br>  <b>Class - Ship</b> The class itself does not contain any logic.  POJO. <br><br><div class="spoiler">  <b class="spoiler_title">Source code</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ship</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Size size; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Type type; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ship</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Size size, Type type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.size = size; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.type = type; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.count += count; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">countCheck</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count &gt;= size.getValue()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> count; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Type </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> type; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Size </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> size; } }</code> </pre> <br></div></div><br>  Since the ships may differ from each other in size and types, it was decided to create Enum classes to determine the properties of the ship.  Size and Type.  Size has predefined properties.  (code) <br><br>  Also, the Ship class has an int count counter, how many goods are already loaded into it, if more than indicated in the ship property, then the boolean countCheck () method of the same class returns false, in other words, the ship is loaded. <br><br>  <b>Class - Tunnel</b> <br><br><div class="spoiler">  <b class="spoiler_title">Source code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Tunnel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Ship&gt; store; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> maxShipsInTunel = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> minShipsInTunel = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> shipsCounter = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Tunnel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ store = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Ship element)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shipsCounter &lt; maxShipsInTunel) { notifyAll(); store.add(element); String info = String.format(<span class="hljs-string"><span class="hljs-string">"%s + The ship arrived in the tunnel: %s %s %s"</span></span>, store.size(), element.getType(), element.getSize(), Thread.currentThread().getName()); System.out.println(info); shipsCounter++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { System.out.println(store.size() + <span class="hljs-string"><span class="hljs-string">"&gt; There is no place for a ship in the tunnel: "</span></span> + Thread.currentThread().getName()); wait(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> Ship </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type shipType)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shipsCounter &gt; minShipsInTunel) { notifyAll(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Ship ship : store) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ship.getType() == shipType) { shipsCounter--; System.out.println(store.size() + <span class="hljs-string"><span class="hljs-string">"- The ship is taken from the tunnel: "</span></span> + Thread.currentThread().getName()); store.remove(ship); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ship; } } } System.out.println(<span class="hljs-string"><span class="hljs-string">"0 &lt; There are no ships in the tunnel"</span></span>); wait(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }</code> </pre><br></div></div><br>  The tunnel keeps the ships, this is done using the List.  Spaciousness tunnels 5 ships.  In the tunnel somehow you need to add ships and get.  2 add () and get () methods do this.  The get () method gets and removes the ship of the type it needs from the list.  As you can see in the add () and get () methods there is a check on the number of ships in the list.  If ship&gt; 5, then add the ship does not work and vice versa if ship &lt;0, then take from the list also fail.  Tunnel is a shared resource in a multithreading context.  Shared resources in multithreading are evil.  All the problems and complexity of multi-threaded programming come precisely because of shared resources.  So they should be avoided. <br><br>  What is the problem specifically with our shared resource. <br><br>  First, the addition and removal of ships must be consistent among the threads.  If there is no consistency, there is a <a href="https://www.viva64.com/ru/t/0042/">greater likelihood</a> of race condition and data loss.  This is what we solve with the <a href="http://www.javenue.info/post/87">synchronized keyword</a> . <br><br>  Secondly, in the TK it was mentioned: <br><br>  - Streams should not be active if there are no tasks. <br>  - Threads should not hold mutex if there are no tasks. <br><br>  For this, <a href="https://metanit.com/java/tutorial/8.5.php">there is</a> also <a href="https://metanit.com/java/tutorial/8.5.php">a solution</a> in the form of wait () and notifyAll (). <br><br>  For the add () method and the stream that executes it, the phrase ‚Äúno task‚Äù means that ship&gt; 5.  When ship&gt; 5 flow should stop its activity and wait.  In order to stop the thread and remove the mutex we call wait ().  The get () method has similar rules.  Only for him ship &lt;0.  Wait, they will wait, but how to awaken them and tell them to go to work again?  This is where the notifyAll () method comes to our rescue.  Its task is to switch the stream from the WAITING state to RUNNABLE.  When the add () method works and at the same time ship &lt;5, then it awakens the stream that works with the get () method.  And vice versa, when the get () method and ship&gt; 0 is triggered, it will wake up the thread working with the add () method.  Some kind of recursion ... But be careful!  There is a chance to catch DEADLOCK and go to an endless wait.  (http://www.quizful.net/interview/java/Deadlock) <br><br>  Going further ... <br><br>  <b>Class - ShipGenerator.</b> <br><br>  Now we need something that will generate the ships, and will do it in an independent stream.  Class ShipGenerator. <br><br><div class="spoiler">  <b class="spoiler_title">Source code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ShipGenerator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Runnable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Tunnel tunnel; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> shipCount; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ShipGenerator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Tunnel tunnel, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> shipCount)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.tunnel = tunnel; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.shipCount = shipCount; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (count &lt; shipCount) { Thread.currentThread().setName(<span class="hljs-string"><span class="hljs-string">" Generator ship"</span></span>); count++; tunnel.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Ship(getRandomSize(), getRandomType())); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Thread.sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException e) { e.printStackTrace(); } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Type </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRandomType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Random random = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Type.values()[random.nextInt(Type.values().length)]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Size </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRandomSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Random random = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Size.values()[random.nextInt(Size.values().length)]; } }</code> </pre> <br></div></div><br>  In order to add the task of generating ships to the stream, you must implement the Runnable interface.  At the input 2 parameters are Tunnel and the number of ships required for generations.  Next, override the run () method.  The run () method is the method that will be directly executed by the stream.  There we will put the logic for generating ships.  The logic is simple.  We generate ships in a random way, using Random and put Tunnel in the shared resource. <br><br>  <i>A small digression.</i>  <i>I said that it is necessary to add a task for the stream, as many mistakenly believe that by implementing the Runnable interface, they create a stream.</i>  <i>In fact, they create a task for the thread.</i>  <i>In other words, creating 1000 classes that implement the Runnable interface does not mean creating 1000 threads.</i>  <i>This means creating 1000 tasks.</i>  <i>And the number of threads that will perform these tasks will depend on the number of cores on your machine.</i> <br><br>  <b>Class - PierLoader</b> <br><br><div class="spoiler">  <b class="spoiler_title">Source code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PierLoader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Runnable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Tunnel tunnel; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Type shipType; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PierLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Tunnel tunnel, Type shipType)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.tunnel = tunnel; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.shipType =shipType; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Thread.currentThread().setName(<span class="hljs-string"><span class="hljs-string">"Loader "</span></span>+shipType); <span class="hljs-comment"><span class="hljs-comment">//Time to load the goods Thread.sleep(500); Ship ship = tunnel.get(shipType); if(ship!=null) while (ship.countCheck()){ Thread.sleep(100); ship.add(10); System.out.println(ship.getCount() + " Loaded ship. " + Thread.currentThread().getName()); } } catch (InterruptedException e) { e.printStackTrace(); } } } }</span></span></code> </pre> <br></div></div><br>  The ship was generated, added to the tunnel now needs to be removed from the tunnel and load it with goods.  To do this, we will create a PierLoader class, in other words a berth.  As we know, we have 3 types of ships, so we need to create 3 types of berths working independently of each other.  By analogy ShipGenerator we implement the Runnable interface.  At input 2, parameters are Tunnel and Type (the type of ships that receives the given berth).  Instead of add (), we call the get () method and the specific type of ships. <br><br>  <i>Note that I use sleep () only to emulate the work of loaders and ship generations (supposedly it takes time to load the goods and the ships must sail), and not to delay them in order to adjust them to other flows.</i>  <i>Never do this, there are many reasons for this, the most obvious: what happens if the load on flow A increases and will work much longer (not 1 second, but 3 seconds as you expected) than you put stream B to sleep (for 1 second) so that wait for flow A?</i>  <i>Even depending on the OS, the JVM can behave differently.</i>  <i>As you know, sleep does not release the resource, but keeps it even during sleep, if wait (), which tells the thread to stop its work and release the lock.</i> <br><br>  <b>Class - Main</b> <br><br><div class="spoiler">  <b class="spoiler_title">Source code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Main</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(<span class="hljs-string"><span class="hljs-string">"Available number of cores: "</span></span> + Runtime.getRuntime().availableProcessors()); Tunnel tunnel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Tunnel(); ShipGenerator shipGenerator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ShipGenerator(tunnel, <span class="hljs-number"><span class="hljs-number">10</span></span>); PierLoader pierLoader1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PierLoader(tunnel, Type.DRESS); PierLoader pierLoader2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PierLoader(tunnel, Type.BANANA); PierLoader pierLoader3 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PierLoader(tunnel, Type.MEAL); ExecutorService service = Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors()); service.execute(shipGenerator); service.execute(pierLoader1); service.execute(pierLoader2); service.execute(pierLoader3); service.shutdown(); } }</code> </pre> <br></div></div><br>  He is the easiest.  Initialize the Tunnel class we created.  Next, we initialize ShipGenerator, in the constructor we pass the Tunnel object and the number of ships necessary for the flow generation. <br><br>  In the same way, we create 3 PierLoader objects for loading 3 ship types.  We pass to the constructor our shared resource for threads called Tunnel.  And the type of ship that PierLoader should work. <br><br>  Then we give all this stuff to the ExecutorService class.  First, create a thread pool for running tasks.  You determine the number of threads using the Runtime.getRuntime (). AvailableProcessors () command.  It returns the number of streams available to us in int format.  It does not make sense to create 1000 threads if you have only 8 available cores. Since only 8 will be processed at a time. <br><br>  Well that's all!  Multithreaded application is ready.  You can play with the number of tasks for the threads, the time of generation of ships and the loading of goods.  The result will always be different. <br><br><h3>  Conclusion </h3><br>  In conclusion, I want to advise you to read the book "The Philosophy of Java" by Bruce Ekkel.  Chapter ‚ÄúParallel Execution‚Äù and ‚ÄúJAVA.  Programming Methods ‚ÄùN. Blinova.  Chapter "Stream Execution."  It describes the main practices of working with multithreading in Java and their complexity. <br><br>  Before writing a multithreaded application, you need to draw it on a piece of paper, make a sketch of your project.  Avoid shared resources.  Shared resources are evil.  It is better that the streams do not know and hear nothing about each other.  To use ready API, than to do everything the pens.  This will reduce development time and increase the reliability of your application.  Test and profile the application.  Perhaps you will find another bottleneck that slows down your application and does not reveal the full potential of your multithreaded application. </div><p>Source: <a href="https://habr.com/ru/post/352374/">https://habr.com/ru/post/352374/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352362/index.html">Pumping C # Performance with Federico Luis</a></li>
<li><a href="../352364/index.html">DotNext 2018 Piter program overview</a></li>
<li><a href="../352366/index.html">Smart face control: machine learning algorithms for efficient data caching on SSD</a></li>
<li><a href="../352368/index.html">MEPhI invites to the information security competition</a></li>
<li><a href="../352372/index.html">"Computer, how is my build doing?" And other magic spells</a></li>
<li><a href="../352376/index.html">Now I see you: detecting fileless malware</a></li>
<li><a href="../352378/index.html">From point A to point Chief</a></li>
<li><a href="../352380/index.html">New old vulnerability: Firefox password manager has been using outdated SHA-1 for 9 years</a></li>
<li><a href="../352382/index.html">Network physics in virtual reality</a></li>
<li><a href="../352384/index.html">Customize Mozilla Thunderbird in a corporate Windows environment</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>