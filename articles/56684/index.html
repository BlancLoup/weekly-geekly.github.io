<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Jabber webcam bot</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This idea came to me somehow by chance. Get a snapshot of a webcam that is at home, being at work or in another city and not sharing the camera via th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Jabber webcam bot</h1><div class="post__text post__text-html js-mediator-article">  This idea came to me somehow by chance.  Get a snapshot of a webcam that is at home, being at work or in another city and not sharing the camera via the web ... And not connecting via ssh ... It's funny ... What if you get it in one request in jabber!  It sounds crazy, but I started to implement this nonsense! <br><a name="habracut"></a><br>  All of the above does not pretend to manual or instruction to action.  Repetition of these dances with a tambourine can damage your technique or your brain.  So be careful) <br>  So, for starters, I learned what means to combat Jabber exist.  First I looked for libraries for Java.  There is a choice, but for some reason, everything is quite difficult to do, and something does not work with individual servers (jabber.ru, for example).  Therefore, I began to choose from this <a href="http://xmpp.org/software/libraries.shtml">list</a> .  The choice fell on ... Ruby) Firstly, because I do not know him, secondly, because of the simplicity of the first example.  As a result, I stopped at <a href="http://home.gna.org/xmpp4r/">xmpp4r</a> .  In the chop, I am a complete novice, so you can safely criticize and throw tomatoes) Code in the studio: <br><blockquote><code><font color="black">#!/usr/bin/ruby <br> require <font color="#A31515">'xmpp4r/client'</font> <br> <br> include Jabber <br> <br> <font color="#0000ff">class</font> BasicClient <br> MSG_DEFAULT= <font color="#A31515">"If your see this message you client doesn`t support html"</font> <br> MSG_DENIED= <font color="#A31515">"Access denied!"</font> <br> <br> def initialize(args) <br> puts(args[0]) <br> puts <font color="#A31515">"Jabber WebCamBot initializing"</font> <br> @my_jid=args[0] <br> @my_pwd=args[1] <br> @user_jid=args[2] <br> <font color="#0000ff">if</font> args[3] == <font color="#A31515">"debug"</font> <br> Jabber::debug = <font color="#0000ff">true</font> <br> end <br> puts <font color="#A31515">"Will connect to "</font> + @my_jid + <font color="#A31515">" and accept messages only from "</font> + @user_jid <br> do_connect <br> do_auth <br> start_work <br> end <br> <br> def do_connect() <br> @jid = JID. <font color="#0000ff">new</font> (@my_jid) <br> @cl = Client. <font color="#0000ff">new</font> (@jid) <br> @cl.connect <br> end <br> <br> def do_auth <br> @cl.auth(@my_pwd) <br> presense = Presence. <font color="#0000ff">new</font> (:dnd, <font color="#A31515">"server running"</font> ) <br> @cl.send(presense) <br> end <br> <br> def start_work <br> mainthread = Thread.current <br> @cl.add_message_callback <font color="#0000ff">do</font> |m| <br> <font color="#0000ff">if</font> m.type != :error <br> msg_jid=m. <font color="#0000ff">from</font> .node + <font color="#A31515">"@"</font> + m. <font color="#0000ff">from</font> .domain <br> puts(msg_jid) <br> <font color="#0000ff">if</font> msg_jid != @user_jid <br> puts( <font color="#A31515">"Unknown user"</font> ) <br> m2 = Message. <font color="#0000ff">new</font> (m. <font color="#0000ff">from</font> , MSG_DENIED) <br> @cl.send(m2) <br> <font color="#0000ff">else</font> <br> get_image <br> m2 = Message. <font color="#0000ff">new</font> (m. <font color="#0000ff">from</font> , MSG_DEFAULT) <br> m2.type = m.type <br> h = REXML::Element:: <font color="#0000ff">new</font> ( <font color="#A31515">"html"</font> ) <br> h.add_namespace( <font color="#A31515">'http://jabber.org/protocol/xhtml-im'</font> ) <br> <br> b = REXML::Element:: <font color="#0000ff">new</font> ( <font color="#A31515">"body"</font> ) <br> b.add_namespace( <font color="#A31515">'http://www.w3.org/1999/xhtml'</font> ) <br> <br> t = REXML::Text. <font color="#0000ff">new</font> ( @cam_image, <br> <font color="#0000ff">false</font> , nil, <font color="#0000ff">true</font> , nil, %r/.^/ ) <br> b.add(t) <br> h.add(b) <br> m2.add_element(h) <br> puts(m. <font color="#0000ff">from</font> ) <br> @cl.send(m2) <br> end <br> end <br> end <br> Thread.stop <br> end <br> <br> def get_image <br> system( <font color="#A31515">"./make.img"</font> ) <br> image_file = <font color="#2B91AF">File</font> . <font color="#0000ff">new</font> ( <font color="#A31515">"data.html"</font> , <font color="#A31515">"r"</font> ) <br> @cam_image = image_file.read() <br> end <br> end <br> <br> BasicClient. <font color="#0000ff">new</font> (ARGV)</font></code> </blockquote> <br><br>  The script is passed 4 arguments: <br><ul><li>  Jabber id </li><li>  Password from him </li><li>  Jabber ID of the user who is allowed to view pictures from your webcam </li><li>  Optional debug parameter for output of service information from xmpp4r </li></ul><br><br>  The essence of this code is that it connects to the server and waits until it receives a message from a certain known user (tobish me, who is at work).  When this message is received, the script runs an external command ./make.img (it will be described in detail later) and forms, based on the data.html file generated by it, a jabber message, which contains our image in the html tag. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here we come to the most interesting.  How to transfer a picture to see it?  My initial idea was to use ascii-art.  But, having tried, I realized that to see something would be unreal.  Therefore, we need to pass an html img tag with data encapsulated into it (via base64 encoding).  The make.img script will help us generate such a package: <br><br><blockquote> <code><font color="black">#!/bin/bash <br> <br> uvccapture -mv -o out.jpg <br> convert out.jpg -quality 20 out.jpg <br> IMG=$(cat out.jpg | base64) <br> DATE=$(date -R) <br> echo "Created: $DATE <font color="#0000ff">&lt;</font> <font color="#800000">br</font> <font color="#0000ff">/&gt;&lt;</font> <font color="#800000">img</font> <font color="#ff0000">src</font> =\ <font color="#0000ff">"data:image/png;base64,$IMG\"</font> <font color="#0000ff">/&gt;</font> " <font color="#0000ff">&gt;</font> data.html <br></font></code> </blockquote><br><br>  This script captures the image from the camera (uvccapture - there may be a thousand options, everyone chooses the capture tool that works for him. I have already earned uvccture).  Next, we reduce the quality of it through ImageMagick (do we need a high-quality image in Jabber?), Then we do base64 encoding and form an html message. <br><br>  But this is only half the battle.  We need to see this message somewhere else.  I found only one client who frivolously shows pictures in messages.  This is <a href="http://synapse.im/">synapse</a> .  He appeared recently, and about him recently wrote on <a href="http://habrahabr.ru/search/%3Fq%3Dsynapse%2Bim">Habr√©</a> .  It works quite simply, though a certain amount of time passes between the request for receiving the picture and the drawing - it's unclear because of what ... Well, in the end, I present a screenshot of our conversation with the bot: <br><img src="https://habrastorage.org/getpro/habr/post_images/d99/fa3/18a/d99fa318a32be0ac93dbc42102752e7e.png" alt="webcambot"><br><br>  PS Of course, you can say that it is better than to engage in such nonsense to look for a solution to NP-complex problems, to optimize algorithms of computational physics, or to create start-ups.  Maybe, but the thing turned out to be funny) <br>  PPS I hope the code is not absolutely terrible and there are not many ochepyatok in the text) </div><p>Source: <a href="https://habr.com/ru/post/56684/">https://habr.com/ru/post/56684/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../56675/index.html">The Dead Souls of the Professionals.ru social network</a></li>
<li><a href="../56677/index.html">Record holder Razer Mamba</a></li>
<li><a href="../56679/index.html">Improved Gmail and Calendar for iPhone / Android</a></li>
<li><a href="../56680/index.html">Empire of Microsoft</a></li>
<li><a href="../56683/index.html">2 reasons why numbered lists are easy to read</a></li>
<li><a href="../56686/index.html">Ukraine introduced a new procedure for the importation and operation of mobile</a></li>
<li><a href="../56688/index.html">MS Chart: an example of performance counters with 3D rotation</a></li>
<li><a href="../56689/index.html">Jailbreak firmware 3.0 for iPhone</a></li>
<li><a href="../56690/index.html">VPN with firewall / NAT</a></li>
<li><a href="../56691/index.html">Are you participating in the development of open source projects?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>