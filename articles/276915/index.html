<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bypassing the DPI provider on the OpenWrt router using only busybox</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone, in the light of the latest news from RosKomNadzor, I decided to take a look at how my ISP is blocking. It turned out that the Google D...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bypassing the DPI provider on the OpenWrt router using only busybox</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/3f1/52b/2aa/3f152b2aa66cefe21b2808703c6e3d73.png" alt="image"><br>  Hello everyone, in the light of the latest news from RosKomNadzor, I decided to take a look at how my ISP is blocking.  It turned out that the Google DNS does not save, and the blocking works by allocating an HTTP request to a banned site and then dropping packets found by a TCP session.  However, after a little tinkering, it turned out that a single busybox is enough to bypass it.  To whom it is interesting - well under the cat. <br><br><a name="habracut"></a><br><br>  At once I will make a reservation that the implementation of the lock depends on the provider and my method may not work for you.  So, we will consider the example of the well-known site rutracker.ogr (the domain and IP address in the post is changed to avoid). <br>  I started with a simple query to see how the provider responds in general. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Homepage Request</b> <div class="spoiler_text"><pre> wget -O / dev / null "rutracker.ogr"
 --2016-02-10 01: 21: 18-- http: //rutracker.ogr/
 Rutracker.ogr (rutracker.ogr) is recognized ... 195.82.147.214
 Connection to rutracker.ogr (rutracker.ogr) | 195.82.147.214 |: 80 ... connection established.
 HTTP request sent.  Waiting for an answer...
</pre></div></div><div class="spoiler">  <b class="spoiler_title">Package dump</b> <div class="spoiler_text"><pre> 01: 25: 10.736021 IP 192.168.5.2.53724&gt; 195.82.147.214.80: Flags [S], seq 778021515, win 29200, options [mss 1460, sackOK, TS val 40091571 ecr 0, nop, wscale 7], length 0
 01: 25: 10.771529 IP 195.82.147.214.80&gt; 192.168.5.2.53724: Flags [S.], seq 866160985, ack 778021516, win 14600, options [mss 1400], length 0
 01: 25: 10.771562 IP 192.168.5.2.53724&gt; 195.82.147.214.80: Flags [.], Ack 1, win 29200, length 0
 01: 25: 10.771701 IP 192.168.5.2.53724&gt; 195.82.147.214.80: Flags [P.], seq 1: 141, ack 1, win 29200, length 140: HTTP: GET / HTTP / 1.1
 01: 25: 11.129078 IP 192.168.5.2.53724&gt; 195.82.147.214.80: Flags [P.], seq 1: 141, ack 1, win 29200, length 140: HTTP: GET / HTTP / 1.1
 01: 25: 11.849176 IP 192.168.5.2.53724&gt; 195.82.147.214.80: Flags [P.], seq 1: 141, ack 1, win 29200, length 140: HTTP: GET / HTTP / 1.1
 01: 25: 13.292495 IP 192.168.5.2.53724&gt; 195.82.147.214.80: Flags [P.], seq 1: 141, ack 1, win 29200, length 140: HTTP: GET / HTTP / 1.1
</pre></div></div><br>  The client successfully connects, sends the request and everything.  A heap of TCP resends before timeout.  The DPI recognized the session and dropped it as forbidden.  And then for some reason I tried to try the same thing, but through telnet. <br><br><div class="spoiler">  <b class="spoiler_title">Request telnet page</b> <div class="spoiler_text"><pre> telnet rutracker.ogr 80
 Trying 195.82.147.214 ...
 Connected to rutracker.ogr.
 Escape character is '^]'.
 GET / HTTP / 1.1
 User-Agent: Wget / 1.16.3 (linux-gnu)
 Accept: * / *
 Accept-Encoding: identity
 Host: rutracker.ogr
 Connection: Keep-Alive

 HTTP / 1.1 301 Moved Permanently
 Server: nginx
 Date: Tue, 09 Feb 2016 22:29:50 GMT
 Content-Type: text / html
 Content-Length: 178
 Location: http: //rutracker.ogr/forum/index.php
 Connection: keep-alive

 &lt;html&gt;
 &lt;head&gt; &lt;title&gt; 301 Moved Permanently &lt;/ title&gt; &lt;/ head&gt;
 &lt;body bgcolor = "white"&gt;
 &lt;center&gt; &lt;h1&gt; 301 Moved Permanently &lt;/ h1&gt; &lt;/ center&gt;
 &lt;hr&gt; &lt;center&gt; nginx &lt;/ center&gt;
 &lt;/ body&gt;
 &lt;/ html&gt;
</pre></div></div><div class="spoiler">  <b class="spoiler_title">Packet dump on request via telnet</b> <div class="spoiler_text"><pre> 01: 33: 15.354300 IP 192.168.5.2.53782&gt; 195.82.147.214.80: Flags [S], seq 4112340002, win 29200, options [mss 1460, sackOK, TS val 40236956 ecr 0, nop, wscale 7], length 0
 01: 33: 15.389921 IP 195.82.147.214.80&gt; 192.168.5.2.53782: Flags [S.], seq 3472440534, ack 4112340003, win 14600, options [mss 1400], length 0
 01: 33: 15.389967 IP 192.168.5.2.53782&gt; 195.82.147.214.80: Flags [.], Ack 1, win 29200, length 0
 01: 33: 16.226472 IP 192.168.5.2.53782&gt; 195.82.147.214.80: Flags [P.], seq 1:17, ack 1, win 29200, length 16: HTTP: GET / HTTP / 1.1
 01: 33: 16.263181 IP 195.82.147.214.80&gt; 192.168.5.2.53782: Flags [.], Ack 17, win 14600, length 0
 01: 33: 16.263214 IP 192.168.5.2.53782&gt; 195.82.147.214.80: Flags [P.], seq 17: 139, ack 1, win 29200, length 122: HTTP
 01: 33: 16.298317 IP 195.82.147.214.80&gt; 192.168.5.2.53782: Flags [.], Ack 139, win 14600, length 0                                                                                                    
 01: 33: 16.789180 IP 192.168.5.2.53782&gt; 195.82.147.214.80: Flags [P.], seq 139: 141, ack 1, win 29200, length 2: HTTP                                                                                  
 01: 33: 16.827756 IP 195.82.147.214.80&gt; 192.168.5.2.53782: Flags [.], Ack 141, win 14600, length 0                                                                                                    
 01: 33: 16.828043 IP 195.82.147.214.80&gt; 192.168.5.2.53782: Flags [P.], seq 1: 383, ack 141, win 14600, length 382: HTTP: HTTP / 1.1 301 Moved Permanently                                                
 01: 33: 16.828067 IP 192.168.5.2.53782&gt; 195.82.147.214.80: Flags [.], Ack 383, win 30016, length 0                                                                                                    
 01: 33: 20.376119 IP 192.168.5.2.53782&gt; 195.82.147.214.80: Flags [F.], seq 141, ack 383, win 30016, length 0                                                                                          
 01: 33: 20.412142 IP 195.82.147.214.80&gt; 192.168.5.2.53782: Flags [F.], seq 383, ack 142, win 14600, length 0                                                                                          
 01: 33: 20.412177 IP 192.168.5.2.53782&gt; 195.82.147.214.80: Flags [.], Ack 384, win 30016, length 0                                                                                                    
 01: 33: 30.299143 IP 192.168.5.2.53780&gt; 195.82.147.214.80: Flags [FP.], Seq 1515330593: 1515330733, ack 3791059975, win 29200, length 140: HTTP: GET / HTTP / 1.1                                        
</pre></div></div><br><br>  Actually at this moment it became clear that the DPI is not so terrible as it is painted.  If you look at the dumps, you can see that telnet sends the first line of the request in a separate packet.  That is, DPI does not analyze the TCP stream, but the first packet with data from the client to the server and tries to collect the Url from the path and Host fields in order to punch it through the database.  If the first line of the request with the path and the line with the Host field are separated into different packets, then the DPI cannot process such a session correctly and skips it. <br><br>  The case remained for small.  It was necessary to make a certain proxy that would break the header of the first HTTP request in the TCP session (remember Connection: Keep-Alive) into two packets, and simply send the rest through.  I also wanted this proxy to work on the OpenWrt router in order to provide the entire home network.  You can make such a proxy in different ways, I chose the laziest, the fastest and the most naked one, since the goal was to make exactly proof of concept, and not a boxed solution. <br>  As a proxy, I have a shell script that runs from under tcpsvd (by default, there is no tcpsvd applet in OpenWrt's busybox, so it must be rebuilt using standard buildroot).  Just in case, let me remind you that tcpsvd is such a thing that listens to the port and, when the client connects, starts the child process, redirecting its input / output to the socket. <br><br>  I‚Äôve got such a script (please don‚Äôt beat with your feet, this is just a proof of concept) <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh #         appendLine() { if [[ ! -z "$1" ]] then echo -ne "$1\r\n$2" else echo -ne "$2" fi } header1="" header2="" host="" while [[ true ]] do #   read -r line #     0x0D line=`echo "$line" | tr -d "\r"` #   if [[ -z "$line" ]] then break fi # ,   Host:   header1,  -  header2 if [[ -z "$host" ]] then if [[ `echo "$line" | grep -c "Host:"` -eq "1" ]] then host=`echo "$line" | sed -re 's/^Host: (.*)\r?$/\1/'` header2=`appendLine "$header2" "$line"` else header1=`appendLine "$header1" "$line"` fi else header2=`appendLine "$header2" "$line"` fi done { #    echo -ne "$header1\r\n" #  ,  netcat  ,   ,     -   sleep 1 #    echo -ne "$header2\r\n\r\n" #  , DPI  ,  -   cat 2&gt;/dev/null } | nc "$host" 80</span></span></code> </pre> <br><br>  Just in case, I‚Äôll clarify that we only wait a second at the beginning of a TCP session, and since browsers usually do not disconnect a session, but continue to send requests to it, there should be no obvious brakes. <br><br>  This crutch proxy runs like this: <br> <code>tcpsvd 0.0.0.0 3128 ./proxy.sh <br></code> <br><br>  It remains only to redirect traffic from the browser to the proxy in any way.  You can do this, for example, as <a href="https://habrahabr.ru/post/270657/">here</a> , but you can generate a proxy auto-detection file from the list of prohibited sites.  The second option is easier, laziness won again and it turned out like this: <br><br><pre> <code class="bash hljs">{ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">"function FindProxyForURL(url, host)\n{\n\tif ("</span></span> wget <span class="hljs-string"><span class="hljs-string">"http://api.antizapret.info/group.php?data=domain"</span></span> -O- | sed -re <span class="hljs-string"><span class="hljs-string">'s/^(.*)$/localHostOrDomainIs(host,"\1") || /'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">"false)\n{ return \"PROXY 192.168.5.1:3128\"; }\nreturn \"DIRECT\";\n}"</span></span>; } &gt; ~/antidpi.pac</code> </pre><br><br>  After podsovyvaniya this file in the proxy settings, banned sites began to open without question. <br>  I would be glad if someone less lazy would make a proxy in a normal way or, if I invented a bicycle, would point to a ready-made standard solution. <br>  That's all, thank you for your attention. </div><p>Source: <a href="https://habr.com/ru/post/276915/">https://habr.com/ru/post/276915/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276899/index.html">Ryo CDR: another asterisk CDR viewer</a></li>
<li><a href="../276901/index.html">Daily releases are not so scary</a></li>
<li><a href="../276905/index.html">Go and Protocol Buffers, acceleration</a></li>
<li><a href="../276909/index.html">Microsoft will share information about Windows 10 updates</a></li>
<li><a href="../276913/index.html">Fallback actions in ES6 Promise</a></li>
<li><a href="../276917/index.html">The court recognized "Mail.Ru" blogger</a></li>
<li><a href="../276919/index.html">New Java-conference from JUG.ru in Novosibirsk</a></li>
<li><a href="../276921/index.html">Best practices for protecting e-commerce sites</a></li>
<li><a href="../276923/index.html">Creating the concept of mobile f2p games. Part 1</a></li>
<li><a href="../276925/index.html">EDI standard. Technical Overview</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>