<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>HID USB Device Management on Windows 7</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article attempts to provide step-by-step instructions on how to connect an improvised USB HID device on an AVR microcontroller and a Windows 7 x64...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>HID USB Device Management on Windows 7</h1><div class="post__text post__text-html js-mediator-article">  The article attempts to provide step-by-step instructions on how to connect an improvised <b>USB HID</b> device on an <b>AVR microcontroller</b> and a <b>Windows 7 x64-</b> based computer to exchange data and control microcontroller ports.  The sample application controls the microcontroller port via USB (an indicator LED is connected to it).  It is also possible to read the status of the state of the LED - it is extinguished or on.  The topic is intended for beginners, so a big request to programming connoisseurs is to save <s>rotten eggs and rotten tomatoes with</s> ironic comments for a better opportunity. <br><a name="habracut"></a><br><h4>  Used software </h4><br>  <b>1</b> .  For the microcontroller, the V-USB [1] library from Objective Development and the Atmel Studio 6 [2] by Atmel.  It is also necessary to download and install WinAVR [3] toolchain to compile the microcontroller's firmware (for specialists this is not necessary, because you can do with the toolchain, which is part of Atmel Studio). <br>  <b>2</b>  For writing a Windows program (host software), LibUsbDotNet [4] was used by Travis Robinson and IDE Visual Studio C # 2010 [5] by Microsoft. <br><br>  All software except Visual Studio 2010 is free, although it is possible to use Visual Studio C # 2010 Express for free for a limited time.  All actions were carried out in the environment of the Windows 7 x64 operating system, but any other operating system of the Windows family (Windows XP and later) will most certainly do. <br><br><h4>  Iron used </h4><br>  Thanks to the V-USB library, any AVR microcontroller can be used to create a USB HID device.  If you are friends with a soldering iron, you can even build a USB connection yourself using one of the published schemes.  Such a scheme (taken from the V-USB package [1]) is shown in the picture as an example. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/628/1c9/408/6281c9408c8b1fc5864a72ed3ed9bf8e.png"><br><br>  To save time and effort, it is better to use a ready-made breadboard.  It is especially convenient if the USB bootloader (bootloader) is written to the board, then you don‚Äôt need to buy a programmer to flash the board.  I used the AVR-USB-MEGA16 prototype board with an ATmega32A microcontroller, it has a bootloader (USBasploader, which emulates the behavior of the USBasp programmer).  This is how a scarf looks life-size: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/37d/804/c83/37d804c83e0accce2500a49a9823db36.jpg" alt="image"><br><br>  You can also take a metaboard (it has an ATmega168 or ATmega328 on it), or even a programmer on an ATmega8 microcontroller.  These glands can be bought cheaply on <i>ebay.com</i> or <i>dx.com</i> . <br><br><h4>  Microcontroller firmware creation using Atmel Studio 6 and V-USB library </h4><br>  Make a new project in Atmel Studio 6 (hereinafter simply AS6).  When AS6 offers to choose a microcontroller, select <b>Atmega32</b> without the letter <b>A</b> , not Atmega32A (although the Atmega32A is on the board) - this is important, since WinAVR does not see a difference, it only knows Atmega32.  These internal microcontrollers are identical, so for us there is no difference, but for AS6 there is. <br><br>  Now you need to properly configure the compiler.  In the top menu of AS6, click <b>Tools</b> , then <b>Options ..</b> and this window will appear: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d46/528/c41/d46528c416043ce4806975e87330e7f7.jpg" alt="image"><br><br>  On the left in the list, select <b>Toolchain</b> .  A list of Flavors appears on the right.  With this word Atmel has coded the possible variants of the tools used (toolchains). <br><br><pre><code class="tex hljs">.      Native,     (Default).  Native -   GCC      ,         .    Atmel,       AS6.    ,       ,       V-USB (   USB HID     USB)    .  ,         WinAVR,      .</code> </pre> <br>  To add the WinAVR toolbar to the Flavors list, click the <b>Add Flavor</b> button, the following window will appear: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/536/892/75a/53689275a2f45d6a4a88c045723f7d05.jpg" alt="image"><br><br>  In the top line of this window, type the name of the WinAVR compiler (arbitrary), and on the bottom line, enter the full path where the toolchain compiler itself is installed (with the \ bin folder indicated) and click the <b>Add</b> button.  The added compiler appears in the Flavors list, as shown in the screenshot. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4fe/853/f1e/4fe853f1e7d36113690b1ed71104edee.jpg"><br><br>  Highlight our newly added WinAVR compiler with your mouse and click the <b>Set As Default</b> button (click to make it the default), and click OK.  After this procedure, our AS6 will use the WinAVR compiler. <br><br>  It's time to adjust the properties of our project. To do this, left-click the project name in the Solution Explorer and press <b>Alt + F7</b> (Project -&gt; Properties menu), a window with settings will appear: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f96/bd7/a97/f96bd7a978cfe72d337ec2e5bde34888.jpg" alt="image"><br><br>  Make the following settings: <br><ul><li>  In the <b>AVR / GNU C Compiler -&gt; Symbols</b> section, add the <b>F_CPU = 12000000UL</b> line to the <b>-D</b> field - this corresponds to a microcontroller frequency of 12 MHz (such quartz is installed on my AVR-USB-MEGA16 development board). </li><li>  In the section <b>AVR / GNU Assemler -&gt; General</b> in the field <b>Assembler flag</b> you must add <b>-DF_CPU = 12000000UL</b> . </li><li>  In the section <b>AVR / GNU C Compiler -&gt; Optimization</b> in the <b>Optimization Level</b> field should be <b>Optimize for size (-Os)</b> . </li></ul><br>  Further, a very important point - in the left part of the window, select the <b>Advanced</b> section in the list, as shown in the figure below. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a97/5b2/c69/a975b2c695e359ddcca1641053715bb8.jpg" alt="image"><br><br>  In the <b>Toolchain Flavor</b> drop-down list, select the added WinAVR compiler, so that AS6 compiles the project using it.  At this point, the AS6 setup is complete. <br><br>  Next, you need to add the project [6] source code files to the created project - see the folder firmware \ VUSB, the files VUSB.c, usbdrv.c, usbdrvasm.S and oddebug.c.  The ASS6 project is based on one of the examples of the V-USB library: hid-custom-rq, which was originally compiled using the command line make utility.  Based on the V-USB library, you can find many other code examples - mostly USB HID devices (mice, keyboards, input and output devices), but there are also USB CDC devices (virtual COM port).  If you are too lazy to create a project yourself, simply open the VUSB.atsln project file in AS6, it has already made all the necessary settings and added all the necessary files. <br><br>  If you use another breadboard, then you need to properly configure the <i>usbconfig.h</i> file.  This is the V-USB library configuration file, it contains many settings and parameters (VID, PID, microcontroller legs, values ‚Äã‚Äãfor descriptors and other settings).  A detailed description of all the settings is given in the comments of this file.  The main attention should be paid to the pin assignment of the microcontroller, which is used for the signals USD D + and D- (macros USB_CFG_IOPORTNAME, USB_CFG_DMINUS_BIT, USB_CFG_DPLUS_BIT), these legs have special requirements.  The <i>usbconfig.h</i> configuration file from the archive [6] is intended for wiring the legs of the AVR-USB-MEGA16 <i>prototype</i> board, and it is guaranteed to work.  The program will blink with the LED that already exists on the breadboard and is connected to pin 0 of port B. <br><br><h4>  Creating a program for the computer (host software) </h4><br>  Our program should send packets that will control the microcontroller via USB connection. <br><br><pre> <code class="tex hljs">.             V-USB.         makefile   MinGW,    LibUSB.         Visual Studio   LibUsbDotNet.     LibUsbDotNet    ,          ,    .    -     ,      LibUSB  .  ,   ,   -       LibUSB,        USB   Windows.     .</code> </pre><br>  Start Microsoft Visual C # 2010 Express and create a new project based on a Windows Form.  Now we need to connect the library <b>LibUsbDotNet.dll</b> to the project.  In Solution Explorer, right-click on the project name, and select "Add Link." <br><br><img src="https://habrastorage.org/getpro/habr/post_images/855/090/9eb/8550909ebd914c2502a60df7439ada48.jpg" alt="image"><br><br>  another window will appear <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e34/910/cf0/e34910cf0d25d5e7a7bbcb1b1b3c099d.jpg" alt="image"><br><br>  here you need to find the path on the disk where the LinUsbDotNet.dll library is located (by default it is installed in the C: \ Program Files \ LibUsbDotNet folder, but it‚Äôs better to make a copy of the DLL file in the working directory of the project. After connecting the library, you must declare it in the project, add In the main module of the program (file Form1.cs) the lines: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> LibUsbDotNet; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> LibUsbDotNet.Info; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> LibUsbDotNet.Main;</code> </pre><br>  Go to the visual form editor, and bring it to approximately this form (add 3 buttons Button and 3 text labels Label): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/43d/054/8a0/43d0548a0a70569398cdc50092615234.jpg" alt="The appearance of the main form of the host software"><br><br>  Make a form load event handler.  It is needed so that when the program starts, an instance of the LibUsbDotNet class is initialized through which it is exchanged with a USB device.  Before the exchange, it is necessary to open access to our device, because several USB HID devices can be connected to the computer, and you should be able to contact each individual.  For identifying USB devices, special identifiers are used that have absolutely all USB devices, these are VID and PID. <br><br><pre> <code class="tex hljs">.              -       USB   VID  PID,     .     USB-,   ,   VID/PID,    ,           .</code> </pre><br>  The VID is the vendor ID (Vendor ID), and the PID is the device ID (Product ID).  Our USB device has a VID: 0x <b>16C0</b> , PID: 0x <b>05DF</b> , these values ‚Äã‚Äãare indicated in the <i>usbconfig.h</i> configuration file (we already mentioned this file) of the AS6 microcontroller project.  In order for the host software to access our USB device, you need to initialize the MyUsbFinder object with the same VID parameters: 0x16c0, PID: 0x05df, as specified in the <i>usbconfig.h</i> file.  To do this, add the following code to the scope of the global variables of the Form1 class: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> UsbDevice MyUsbDevice; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> UsbDeviceFinder MyUsbFinder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UsbDeviceFinder(<span class="hljs-number"><span class="hljs-number">0x16c0</span></span>, <span class="hljs-number"><span class="hljs-number">0x05df</span></span>);</code> </pre><br>  Once we have decided on which USB device we will work with, we can connect to it, and it is convenient to do this at the time the program starts (opening the form window).  To do this, select the main form of the program, and in the property editor create a handler for the loading event Form1_Load.  In the body of the handler enter the following code: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Form1_Load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { MyUsbDevice = UsbDevice.OpenUsbDevice(MyUsbFinder); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (MyUsbDevice != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { label2.Text = <span class="hljs-string"><span class="hljs-string">"  !"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> label2.Text = <span class="hljs-string"><span class="hljs-string">"   !"</span></span>; }</code> </pre><br>  Make an event handler for the click on the button1 button (‚ÄúOn‚Äù), for this, in the visual editor of the button, double-click, and add the code to the body of the event handler: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">button1_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  ,       AVR-USB-MEGA16. UsbSetupPacket packet = new UsbSetupPacket((byte)(UsbCtrlFlags.RequestType_Vendor | UsbCtrlFlags.Recipient_Device | UsbCtrlFlags.Direction_Out), 1, (short)1, 0, 0); int countIn; byte[] data = new byte[1]; MyUsbDevice.ControlTransfer(ref packet, data, 0, out countIn); }</span></span></code> </pre><br>  For the handler of the "Off" button, add the code: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">button3_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  ,       AVR-USB-MEGA16. UsbSetupPacket packet = new UsbSetupPacket((byte)(UsbCtrlFlags.RequestType_Vendor | UsbCtrlFlags.Recipient_Device | UsbCtrlFlags.Direction_Out), 1, (short)0, 0, 0); int countIn; byte[] data = new byte[1]; MyUsbDevice.ControlTransfer(ref packet, data, 0, out countIn); }</span></span></code> </pre><br>  The code for processing the "Read" button: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">button2_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//     AVR-USB-MEGA16 -  . UsbSetupPacket packet = new UsbSetupPacket((byte)(UsbCtrlFlags.RequestType_Vendor | UsbCtrlFlags.Recipient_Device | UsbCtrlFlags.Direction_In), 2, (short)0, (short)0, (short)0); int countIn; byte[] data = new byte[1]; if (MyUsbDevice.ControlTransfer(ref packet, data, 1, out countIn) &amp;&amp; (countIn == 1)) { label3.Text = "  " + data[0].ToString(); } }</span></span></code> </pre><br>  The event handler for the form closing (program shutdown) extinguishes the LED if it is lit: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Form1_FormClosed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, FormClosedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { UsbSetupPacket packet = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UsbSetupPacket((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)(UsbCtrlFlags.RequestType_Vendor | UsbCtrlFlags.Recipient_Device | UsbCtrlFlags.Direction_Out), <span class="hljs-number"><span class="hljs-number">1</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">short</span></span>)<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> countIn; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>]; MyUsbDevice.ControlTransfer(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> packet, data, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> countIn); }</code> </pre><br><h4>  How USB packages are decoded into the microcontroller's firmware </h4><br>  The reception and processing of data on the side of the microcontroller is carried out in the <i>usbFunctionSetup</i> function (located in the main module VUSB.c of the AS6 firmware project).  Here is the function: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">usbMsgLen_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">usbFunctionSetup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uchar data[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">8</span></span></span></span><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> </span></span>{ usbRequest_t *rq = (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)data; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((rq-&gt;bmRequestType &amp; USBRQ_TYPE_MASK) == USBRQ_TYPE_VENDOR){ DBG1(<span class="hljs-number"><span class="hljs-number">0x50</span></span>, &amp;rq-&gt;bRequest, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*  :    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(rq-&gt;bRequest == CUSTOM_RQ_SET_STATUS){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(rq-&gt;wValue.bytes[<span class="hljs-number"><span class="hljs-number">0</span></span>] &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>){ <span class="hljs-comment"><span class="hljs-comment">/*  LED */</span></span> LED_PORT_OUTPUT |= _BV(LED_BIT); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*  LED */</span></span> LED_PORT_OUTPUT &amp;= ~_BV(LED_BIT); } }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(rq-&gt;bRequest == CUSTOM_RQ_GET_STATUS){ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> uchar dataBuffer[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/*       usbFunctionSetup */</span></span> dataBuffer[<span class="hljs-number"><span class="hljs-number">0</span></span>] = ((LED_PORT_OUTPUT &amp; _BV(LED_BIT)) != <span class="hljs-number"><span class="hljs-number">0</span></span>); usbMsgPtr = dataBuffer; <span class="hljs-comment"><span class="hljs-comment">/*  ,    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    1  */</span></span> } }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*   USBRQ_HID_GET_REPORT  USBRQ_HID_SET_REPORT  , *     .        , *        . */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* default   :      */</span></span> }</code> </pre><br>  Our USB HID device is the simplest, and it responds only to control transfer (control transfer) that passes through endpoint 0 (default control endpoint).  The type of request (bRequest field) decodes the direction of data transfer.  If CUSTOM_RQ_SET_STATUS, then this is the data intended for the microcontroller.  The data is decoded and the microcontroller executes the command laid there.  In this case, the state of the LED is encoded in the very first received byte of data - if there is one in the low-order bit, then the LED turns on, and if it is zero, it goes out.  If CUSTOM_RQ_GET_STATUS is taken in the bRequest field, then the buffer is filled with the current LED status in response, and the buffer data is sent back to the host.  Everything is very simple, and, if desired, the behavior of the code can be easily altered to fit your needs. <br><br>  Video, how it works: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/9S8VAOIFfCQ%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700253,15700256&amp;usg=ALkJrhi6DTPKE9bi5LzOio9W0TOO14xCjg" frameborder="0" allowfullscreen=""></iframe><br><br>  I will be glad to answer in the comments questions and constructive comments. <br><br><h4>  Links </h4><br>  <b>1</b> .  <a href="https://www.google.ru/search%3Fq%3DV-USB">V-USB</a> . <br>  <b>2</b>  <a href="https://www.google.ru/search%3Fq%3DAtmel%2BStudio%2B6%2Bsite%253Aatmel.com">Atmel Studio 6</a> . <br>  <b>3</b>  <a href="http://sourceforge.net/projects/winavr/files/">WinAVR</a> . <br>  <b>4</b>  <a href="http://sourceforge.net/projects/libusbdotnet/">LibUsbDotNet C # USB Library</a> . <br>  <b>5</b>  <a href="https://www.google.ru/search%3Fq%3DVisual%2BStudio%2BC%2523%2B2010%2BExpress">Visual Studio 2010 Express</a> . <br>  <b>6</b>  <a href="http://dfiles.ru/files/t9f9h32ud">The source code for the microcontroller and for the host software</a> . <br><br>  <i>PS The impetus to the knowledge was the site <a href="http://microsin.net/">microsin.net</a> , where there was a lot of information on the USB protocols and practical application of microcontrollers in USB devices.</i>  <i><b>Thank you so much!</b></i>  <i>the developer of this site for their responsiveness and assistance in matters relating to this subject.</i> <br><br>  <i>In the future, if possible, I plan to do the same, but on a microcontroller with a hardware USB interface.</i> </div><p>Source: <a href="https://habr.com/ru/post/210736/">https://habr.com/ru/post/210736/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../210726/index.html">Beta testing "Freelance 2.0"</a></li>
<li><a href="../210728/index.html">IdBasedLocking</a></li>
<li><a href="../210730/index.html">Skype 4.2.0.13 - minor release with long-awaited fix</a></li>
<li><a href="../210732/index.html">Dedicated SaaS or how to start ‚Äúselling soup‚Äù</a></li>
<li><a href="../210734/index.html">A plugin for Bootstrap 3 that enhances the accessibility of interfaces</a></li>
<li><a href="../210738/index.html">Facebook will create an energy-efficient data storage of 10,000 Blu-ray discs</a></li>
<li><a href="../210740/index.html">Analysis of popular game addiction theories</a></li>
<li><a href="../210742/index.html">How does chromecast work?</a></li>
<li><a href="../210744/index.html">Secure backup using public services</a></li>
<li><a href="../210746/index.html">Unification of associative STL-containers by a template parameter - comparator</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>