<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Image search by fragment</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In his speech, Alexander Krainov told how Yandex.Kartinks clustered duplicate images. In other words, duplicate images were isolated and filtered. Whe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Image search by fragment</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/c26/096/e14/c26096e142897e64920f56f86d829c8d.png"><br><a name="habracut"></a><br>  In his <a href="http://habrahabr.ru/post/143667/">speech,</a> Alexander Krainov told how Yandex.Kartinks clustered duplicate images.  In other words, duplicate images were isolated and filtered.  Where the main idea was to select the outlines of the image through the <a href="http://en.wikipedia.org/wiki/DoG">DoG</a> filter, then find the key points and get their descriptors. <br>  Duplicate clustering is reduced to the search for matching descriptors.  This is the ‚Äúdigital format‚Äù of key points from the article <a href="http://habrahabr.ru/company/yandex/blog/158067/">Clustering duplicates in search by pictures</a> . <br><br>  But I would like to know in more detail what these descriptors are and how to search them. <br><br><h4>  Descriptors </h4><br>  Key points are points that ideally should not change when the image is modified or modified. <br>  Descriptors are, in general terms, a convolution of characteristics and the representation of key points in a format that is available for checking for a match. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The search for effective allocation of key points, their descriptors, as well as methods for checking for coincidences, is still on the agenda. <br><br>  But we have to start somewhere, so let's turn to the <a href="http://opencv.org/">OpenCV</a> library for help. <br><br>  The first thing you look at is the <a href="http://en.wikipedia.org/wiki/SURF">SURF</a> handles. <br>  Which promise extraordinary accuracy.  Which is confirmed after the tests. <br><br>  But there are a few nuances. <br>  SURF descriptors are vectors of 128 (or 64) numbers per key point.  The match check is performed by searching for the nearest point (or even two).  And the closer the point, the better. <br><br>  It turns out that the image with 1,000 key points will require 128,000 floating point numbers. <br>  In addition, the detection of points itself is quite a complicated operation and takes considerable time.  What does not allow to effectively use this algorithm on small devices.  In addition, the algorithm itself is closed and patented (in the USA). <br><br>  After getting acquainted with SIFT and SURF, I wanted something simple to implement with the ability to apply on a small server or device. <br><br><h4>  Perceptual hashes </h4><br>  And perceptual or <a href="http://habrahabr.ru/post/120562/">perceptual</a> hashes were found. <br>  The task of which is that with a slight change in the image hash also slightly changed. <br><br>  Matching checks are performed by counting the number of different positions between two hashes.  Those.  counting <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B0%25D1%2581%25D1%2581%25D1%2582%25D0%25BE%25D1%258F%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25A5%25D1%258D%25D0%25BC%25D0%25BC%25D0%25B8%25D0%25BD%25D0%25B3%25D0%25B0">distance hamming</a> .  And the smaller it is, the less distinct elements, the greater the coincidence. <br><br>  This method is designed to search for full or partial duplicates of the image.  Those.  with a significant change in the image format or interfering with the content makes it impossible to check for a match, since the hashes will be significantly different. <br><br>  In other words, perceptual hashes are not suitable for searching for semi-duplicates. <br><br>  Based on this, an attempt was made to combine SURF descriptors and perceptual hashes in order to solve the problem of finding fuzzy semi-duplicates. <br><br>  <a href="http://habrahabr.ru/post/205398/">The method is</a> based on clustering key points in such a way that the centers of clusters coincide on the original and cropped image.  And then a fragment of the image was extracted around the key point and a perceptual hash was obtained.  As a result, one image gave about 200 croppings of cuts and their hashes. <br><br>  This method has two and a half significant drawbacks: <br>  1. low matching rate on a large set of hashes.  Search for 1 million hashes took 20 seconds <br>  2. low speed of getting key points <br>  3. low accuracy, a lot of false positives, high requirements for the target base, not suitable for all pictures, requires pre-moderation, etc. <br><br>  The very idea that a certain number of fingerprints would stand out from the image, which could be simply compared with each other, was fascinating. <br><br>  Therefore, it was decided to try to find solutions to these problems. <br><br><h5>  Low sampling rate </h5><br>  The difficulty of finding and calculating the Hamming distance on a large data set is an independent problem and requires an independent approach. <br>  After some research on the subject, it turned out that there are many solutions to this problem. <br>  The most effective available algorithm named <a href="http://habrahabr.ru/post/211264/">HEngine</a> was selected and implemented, which allowed ~ 60 times the speed of selection from the database. <br><br><h5>  SURF and key points </h5><br>  Since we are already working with binary hashes, or fingerprints, and the coincidence is considered the Hamming distance, it is strange to use such a colossus as SURF and it would be worthwhile to consider other methods for obtaining key points and descriptors. <br><br>  In general, OpenCV provides two types of descriptors: <br><br>  - floating point handles <br>  - And binary descriptors <br><br>  Here are the binary descriptors as no other are suitable for our task, because they also use Hamming distance to check for matches. <br><br><h5>  ORB: an efficient alternative to SIFT or SURF </h5><br>  OpenCV already has a great alternative to SURF, which is not only open and without licensing restrictions, it is even easier and works faster [1]. <br><br>  ORB is Oriented FAST and Rotated BRIEF ‚Äî an improved version and combination of FAST key point detector and BRIEF binary descriptors. <br><br>  ORB has one significant nuance for us - the size of the descriptors is 32 bytes per point. <br>  The coincidence check is the sum of the Hamming distances for each byte of the descriptor (the first is compared with the first, the second with the second, and so on). <br><br>  In our task it is assumed that one point gives one value, and here it turns out 32, which must also be summed up with the corresponding index (first with first, second with second and so on) in the target database. <br><br>  Since our hash is a 64-bit number, it takes 32 bytes of the descriptor to be squeezed into 8 bytes and it does not lose much in accuracy. <br><br>  After some tests, it was decided to try to represent these 32 bytes as a 16x16 bit matrix.  And then pass this matrix through the perceptual <a href="http://phash.org/">PHash</a> hash.  The result should have been just a 64 bit number. <br><br>  Now we come to the full description of the concept. <br><br><h4>  How indexing works </h4><br>  1. Get key points and ORB descriptors, choose the number of required points in the image. <br>  2. The resulting 32-byte descriptors are represented as a 16x16 bit matrix. <br>  3. Convert the matrix to a 64-bit number using PHash. <br>  4. Save 64bit prints in MySQL. <br>  5. Select the required Hamming distance and start the HEngine daemon, which will perform the search. <br><br><h4>  How search works </h4><br>  Perform identical steps 1 - 3 of the indexing, but only on the requested image. <br>  4. Make a request to the HEngine daemon, which returns all the hashes in the specified limit. <br>  5. If required, filter out irrelevant results. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0bc/bc3/f96/0bcbc3f96254310d0ca69f1ae4e8904a.png"><br>  <i>Figure 1. Hamming distance limit 7. Gray dots are key points found.</i>  <i>Green - matching points.</i>  <i>Red - matching standard ORB brute force.</i> <i><br></i> <br><h4>  What is the result? </h4><br>  As a result, we managed to solve several problems: <br>  - find a way to quickly calculate the Hamming distance on a large data set <br>  - get rid of big and uncomfortable surf <br>  - increase the speed of selection of key points and their prints <br>  - and also not to lose much in accuracy. <br><br>  That allowed to find images by their fragment, as well as fuzzy half-duplicates without large computational resources. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d4b/0dd/445/d4b0dd4455d25406c27eb663148082f1.png"><br>  <i>Figure 2. Sweet by Friday</i> <br><br>  Considering that, depending on the settings, the described algorithm, using ORB binary descriptors, gives about 1,000 hashes per image. <br>  On the basis of 1,000 images, 1,000,000 hashes are obtained in the database.  Search and clustering of all duplicates takes one and a half minutes.  Includes brute force search and matching hashes. <br><br><h5>  Links </h5><br>  [1] Ethan Rublee, Vincent Rabaud, Kurt Konolige, Gary R. Bradski: ORB: An efficient alternative to SIFT or SURF.  ICCV 2011: 2564-2571. <br>  [2] <a href="http://en.wikipedia.org/wiki/SURF">en.wikipedia.org/wiki/SURF</a> <br>  [3] <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B0%25D1%2581%25D1%2581%25D1%2582%25D0%25BE%25D1%258F%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25A5%25D1%258D%25D0%25BC%25D0%25BC%25D0%25B8%25D0%25BD%25D0%25B3%25D0%25B0">en.wikipedia.org/wiki/Hamming distance</a> <br>  [4] <a href="http://phash.org/">phash.org</a> <br>  [5] <a href="http://habrahabr.ru/post/143667/">habrahabr.ru/post/143667</a> Clustering duplicates in Yandex.Kartinki <br>  [6] <a href="http://habrahabr.ru/post/211264/">habrahabr.ru/post/211264</a> HEngine - hashes search algorithm within a specified Hamming distance on a large data set <br>  [7] <a href="">github.com/valbok/img.chk</a> My search prototype for fragments </div><p>Source: <a href="https://habr.com/ru/post/211773/">https://habr.com/ru/post/211773/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211761/index.html">New buttons and a single payment solution Yandex.Money: two free seminars in Moscow</a></li>
<li><a href="../211763/index.html">IT certification from an employer's perspective</a></li>
<li><a href="../211765/index.html">The first version of the Cppcheck integration module in Visual Studio with open source has been released.</a></li>
<li><a href="../211767/index.html">What bread crumbs do online stores need (68% of websites make mistakes)?</a></li>
<li><a href="../211771/index.html">Athletes in Sochi allowed to use Apple devices</a></li>
<li><a href="../211775/index.html">Rating hubs and companies by posts / subscribers</a></li>
<li><a href="../211777/index.html">Personalization: debunking myths</a></li>
<li><a href="../211779/index.html">Open Terminal Client - some history</a></li>
<li><a href="../211783/index.html">Applications open for Summer Research Microsoft Research</a></li>
<li><a href="../211787/index.html">Workplace Popcorn: How to become Super-productive working for yourself</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>