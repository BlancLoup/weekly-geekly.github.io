<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>GNU Make can more than you think</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As soon as the source code of the project should be distributed, it becomes necessary to use the build system instead of generating the favorite IDE. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>GNU Make can more than you think</h1><div class="post__text post__text-html js-mediator-article">  As soon as the source code of the project should be distributed, it becomes necessary to use the build system instead of generating the favorite IDE.  In the world of unix (with the filing of gnu), autotools are traditionally used, there are excellent alternatives in the form of cmake or scons.  But for some reason, the Linux kernel is built using GNU Make, and the whole FreeBSD including ports using BSD Make.  WTF? <br><br>  Once having had enough time with autotools, I decided to conduct an experiment on how much you can shovel a Makefile to ensure a more or less convenient build. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Because  modern make are very different, I used GNU Make, because  It is native to my main system, GNU / Linux. <br>  And so, the first pleasant thing that I discovered is the absence of the need to write a rule for each file.  Those.  instead of repeating for each file blocks like: <br><pre> foo.o: foo.c
	 $ (CC) -c foo.c
</pre><br>  You can simply specify a list of dependent objects for a specific binar and it will collect them: <br><pre> main_executable: foo.o bar.o test.o main.o
     $ (Cc) $ ^ -o $ @ $ (LDFLAGS)
</pre><br>  What the $ ^ and $ @?  These are automatic variables, here $ @ is expanded to the name of the target (ie, main_executable), and $ ^ to the list of all dependencies.  Detailed description of all automatic variables <a href="http://www.gnu.org/software/make/manual/html_node/Automatic-Variables.html">here</a> . <br><br>  The second problem I wanted to solve is the generation of dependencies.  One file may depend on another, and it may depend on the system header, etc.  If you prescribe them with your hands, then there is no point in the previous discovery. <br>  As it turned out, gcc is able to parse the source and produce a list of headers on which it depends, this is done with the -M key: gcc -M foo.c.  The output of the command is in the Makefile format, therefore it can be saved to a file and connected to the Makefile.  Most build systems also use gcc -M.  Classically, dependency generation was stuffed somewhere in the target: depends, but in the <a href="http://www.gnu.org/software/make/manual/html_node/Automatic-Prerequisites.html">manual</a> there was a way to update all dependencies automatically. <br>  The council uses one list of objects, but what if there are several goals?  I'm too lazy to write with my hands for everyone!  That's why I decided to organize a Makefile according to this scheme: <br>  * There is a list of targets containing all targets (binarics).  The rule for its assembly is written manually. <br>  * For each goal there is a list of its objects: target_obj = foo.o bar.o, etc. <br>  * There is an all purpose that passes through all the goals. <br>  Proceeding from this, it is necessary to take all the targets, convert their names to the target_obj type, pull out the objects from them, rename their suffixes to .dep (or .d), and then only connect.  Sounds hard?  The line that makes it even more confusing: <b>deps = $ (foreach o, $ (targets: = _ obj), $ ($ (o):%. O = .deps /%. Dep))</b> .  I will not even try to explain the nuances, I will say only that it generates a list of dependencies for each object, in the form of .deps / foo.dep.  In the directory .deps just to not crap in the directory with sorts. <br><br>  Finally, a makefile example: <br><pre> CFLAGS = -Wall-pipe -ggdb

 compiler_obj = compiler.o string_util.o tokenizer.o btree.o memory.o ast.o
 vm_obj = vm.o

 targets = compiler vm

 all: $ (targets)

 .deps /%. dep:% .c
	 @mkdir -p .deps
	 @set -e;  rm -f $ @;  \
		 $ (CC) -M $ (CFLAGS) $ &lt;&gt; $ @;  \
		 sed -i 's, \ ($ * \) \. o [:] *, \ 1.o $ @:, g' $ @;

 deps = $ (foreach o, $ (targets: = _ obj), $ ($ (o):%. o = .deps /%. dep))
 -include $ (deps)

 echo-deps:
	 @echo $ (deps)

 compiler: $ (compiler_obj)
	 @ $ (CC) $ ^ -o $ @ $ (LDFLAGS)

 vm: $ (vm_obj)
	 @ $ (CC) $ ^ -o $ @ $ (LDFLAGS)

 clean:
	 rm -f * .o .deps / *. dep $ (targets)

 ctags:
	 @ctags * .c * .h
</pre><br><br>  PS In this case, there are still a lot of shortcomings, but the experience with GNU Make made me understand that if you wish, you can make a full-fledged build system on it.  Perhaps in the future, I will write and post a more generic makefile library. </div><p>Source: <a href="https://habr.com/ru/post/47513/">https://habr.com/ru/post/47513/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../47504/index.html">New look at the manipulators. Orbita Freestyle.</a></li>
<li><a href="../47507/index.html">Manual adjustment of search results has been added to Google search.</a></li>
<li><a href="../47510/index.html">Smale's Paradox or ‚ÄúHow to turn a sphere inside out?‚Äù</a></li>
<li><a href="../47511/index.html">Microsoft agreed to expand sales of Windows XP</a></li>
<li><a href="../47512/index.html">Nigma learned to look for chemical reactions</a></li>
<li><a href="../47514/index.html">What Web 2.0 Startups Do During A Recession</a></li>
<li><a href="../47515/index.html">Table lamp-bonfire</a></li>
<li><a href="../47516/index.html">Korean Twitter has found an investor</a></li>
<li><a href="../47518/index.html">Table lamp aquarium</a></li>
<li><a href="../47520/index.html">VirtualBox 2.1.0 and OpenGL Call Translation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>