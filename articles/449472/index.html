<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cataclysm Dark Days Ahead, static analysis and bagels</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most likely, from the title of the article you have already guessed that the focus of the error in the source code. But this is not the only thing tha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cataclysm Dark Days Ahead, static analysis and bagels</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/73b/65b/d13/73b65bd13915628ce2e414e1881f9ac3.png" alt="Picture 10"></div><br>  Most likely, from the title of the article you have already guessed that the focus of the error in the source code.  But this is not the only thing that will be discussed in this article.  If besides C ++ and errors in someone else's code you are attracted to unusual games and you are interested to find out what these bagels are and what they eat with, welcome to the cat! <br><a name="habracut"></a><br>  In my search for unusual games, I stumbled upon the game Cataclysm Dark Days Ahead, which is different from other unusual graphics: it is implemented using the multi-colored ASCII characters on a black background. <br><br>  What is striking in this game and others like it is how much is implemented in them.  Specifically, in Cataclysm, for example, even for character creation, I want to look for guides, since there are dozens of different parameters, features and initial plots, not to mention variations of events in the game itself. <br><br>  This is an open source game, and is also written in C ++.  So it was impossible to pass by and not drive this project through the PVS-Studio static analyzer, in the development of which I now take an active part.  The project itself was surprised by the high quality of the code, however, there are still some flaws in it and I will discuss a few of them in this article. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To date, quite a lot of games have already been tested using PVS-Studio.  For example, you can read our other article, <a href="https://habr.com/ru/company/pvs-studio/blog/354808/">Static Analysis in the Video Game Industry: Top 10 Software Errors</a> . <br><br><h2>  Logics </h2><br>  <b>Example 1:</b> <br><br>  The following example is a typical copy error. <br><br>  <a href="https://www.viva64.com/ru/w/v501/">V501</a> There are identical to the left and the right of the '||  operator: rng (2, 7) &lt;abs (z) ||  rng (2, 7) &lt;abs (z) overmap.cpp 1503 <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> overmap::generate_sub( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> z ) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( rng( <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span> ) &lt; <span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>( z ) || rng( <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span> ) &lt; <span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>( z ) ) { .... } .... }</code> </pre> <br>  Here the same condition is checked twice.  Most likely, the expression was copied and forgotten to change something in it.  I find it difficult to say whether this error is significant, but the check does not work as intended. <br><br>  Similar warning: <ul><li>  V501 There are identical sub-expressions "one_in (100000 / to_turns &lt;int&gt; (dur))" to the left and to the right of the '&amp;&amp;' operator.  player_hardcoded_effects.cpp 547 </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e8c/16d/103/e8c16d1033a55f07c7754b604aae4807.png" alt="Picture 9"></div><br>  <b>Example 2:</b> <br><br>  <a href="https://www.viva64.com/ru/w/v728/">V728 Anonymous</a> check can be simplified.  The '(A &amp;&amp; B) ||  (! A &amp;&amp;! B) 'expression is equivalent to the' bool (A) == bool (B) 'expression.  inventory_ui.cpp 199 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> inventory_selector_preset::sort_compare( .... ) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> left_fav = g-&gt;u.inv.assigned.count( lhs.location-&gt;invlet ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> right_fav = g-&gt;u.inv.assigned.count( rhs.location-&gt;invlet ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( left_fav &amp;&amp; right_fav ) || ( !left_fav &amp;&amp; !right_fav ) ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> .... } .... }</code> </pre> <br>  There are no errors in the condition, but it is unnecessarily complicated.  It would be worth taking pity on those who will have to deal with this condition, and it is simpler to write <i>if (left_fav == right_fav)</i> . <br><br>  Similar warning: <br><br><ul><li>  V728 Anonymous check can be simplified.  The '(A &amp;&amp;! B) ||  (! A &amp;&amp; B) 'expression is equivalent to the' bool (A)! = Bool (B) 'expression.  iuse_actor.cpp 2653 </li></ul><br><h2>  Retreat i </h2><br>  For me, it turned out to be a discovery that the games that today are called ‚Äúbagels‚Äù are only fairly light followers of the old genre of roguelike games.  It all began with the cult game Rogue in 1980, which became a role model and inspired many students and programmers to create their own games.  I think a lot has also been introduced by the community of the board role-playing game DnD and its variations. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4dc/d85/de3/4dcd85de3509609962cab730653f7ed1.png" alt="Picture 8"></div><br><h2>  Micro-optimizations </h2><br>  <b>Example 3:</b> <br><br>  The next group of analyzer warnings indicates not the error, but the possibility of micro-optimization of the program code. <br><br>  <a href="https://www.viva64.com/ru/w/v801/">V801</a> Decreased performance.  It is better to redefine the second function.  Consider replacing 'const ... type' with 'const ... &amp; type'.  map.cpp 4644 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Stack&gt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">list</span></span>&lt;item&gt; use_amount_stack( Stack <span class="hljs-built_in"><span class="hljs-built_in">stack</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> itype_id type ) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">list</span></span>&lt;item&gt; ret; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> a = <span class="hljs-built_in"><span class="hljs-built_in">stack</span></span>.begin(); a != <span class="hljs-built_in"><span class="hljs-built_in">stack</span></span>.end() &amp;&amp; quantity &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( a-&gt;use_amount( type, ret ) ) { a = <span class="hljs-built_in"><span class="hljs-built_in">stack</span></span>.erase( a ); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { ++a; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; }</code> </pre><br>  Here, <i>std :: string is</i> hidden behind <i>itype_id</i> .  Since the argument is still passed to the constant, which will not allow it to be changed, it would be faster to simply pass the variable reference to the function and not waste resources on copying.  And although, most likely, the line there will be very small, but continuous copying for no apparent reason is unnecessary.  Moreover, this function is called from different places, many of which, in turn, also receive a <i>type</i> from the outside and copy it. <br><br>  Similar warnings: <br><br><ul><li>  V801 Decreased performance.  It is better to redefine.  Consider replacing 'const ... evt_filter' with 'const ... &amp; evt_filter'.  input.cpp 691 </li><li>  V801 Decreased performance.  It is better to redefine it.  Consider replacing 'const ... color' with 'const ... &amp; color'.  output.h 207 </li><li>  In total, the analyzer issued 32 such warnings. </li></ul><br>  <b>Example 4:</b> <br><br>  <a href="https://www.viva64.com/ru/w/v813/">V813</a> Decreased performance.  The 'str' argument shouldn‚Äôt have to be rendered as a constant reference.  catacharset.cpp 256 <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base64_encode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> str )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( str.length() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; str[<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-string"><span class="hljs-string">'#'</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> str; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> input_length = str.length(); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encoded_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( output_length, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'\0'</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>, j = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; input_length; ) { .... } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; mod_table[input_length % <span class="hljs-number"><span class="hljs-number">3</span></span>]; i++ ) { encoded_data[output_length - <span class="hljs-number"><span class="hljs-number">1</span></span> - i] = <span class="hljs-string"><span class="hljs-string">'='</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"#"</span></span> + encoded_data; }</code> </pre> <br>  In this case, though the argument is not constant, it does not change in the body of the function.  Therefore, for optimization, it would be good to pass it via a constant link, and not to force the compiler to create local copies. <br><br>  This warning was also not a single one, there were 26 such cases. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4ff/557/9b3/4ff5579b36733a7bd46f4c3df6f30d90.png" alt="Picture 7"></div><br>  Similar warnings: <br><br><ul><li>  V813 Decreased performance.  The 'message' argument shouldn‚Äôt necessarily be a reference.  json.cpp 1452 </li><li>  V813 Decreased performance.  The 's' argument should not necessarily be a reference.  catacharset.cpp 218 </li><li>  And so on... </li></ul><br><h2>  Retreat II </h2><br>  Some of the classic roguelike games are still being actively developed.  If you go to the GitHub Cataclysm DDA or NetHack repositories, you can see that changes are being actively made every day.  NetHack is generally the oldest game that is still being developed: its release took place in July 1987, and the latest version dates back to 2018. <br><br>  One of the more famous games of this genre, however, is Dwarf Fortress, which has been developed since 2002 and first released in 2006.  "Losing is fun" ("Play fun") - the motto of the game, exactly reflecting its essence, since it is impossible to win in it.  This game in 2007 earned the title of the best roguelike game of the year as a result of a vote that is held annually on the ASCII GAMES website. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e39/7fb/efa/e397fbefa4204777cc74d97e2b8e52e9.png" alt="Picture 6"></div><br>  By the way, those who are interested in this game may be interested in the next news.  Dwarf Fortress will be released on Steam with improved 32-bit graphics.  With the updated picture, on which two experienced moderators of the game are working, the premium version of Dwarf Fortress will receive additional music tracks and Steam Workshop support.  But if that, owners of the paid version of Dwarf Fortress will be able to change the updated graphics to the previous form in ASCII.  <a href="https://www.patreon.com/posts/25343688">More details</a> . <br><br><h2>  Reassignment of the assignment operator </h2><br>  <b>Examples 5, 6:</b> <br><br>  Also found an interesting pair of similar warnings. <br><br>  <a href="https://www.viva64.com/ru/w/v690/">V690</a> The 'JsonObject' class implements a copy constructor, but lacks the '=' operator.  It is dangerous to use such a class.  json.h 647 <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JsonObject</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: .... JsonIn *jsin; .... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: JsonObject( JsonIn &amp;jsin ); JsonObject( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> JsonObject &amp;jsobj ); JsonObject() : positions(), start( <span class="hljs-number"><span class="hljs-number">0</span></span> ), end( <span class="hljs-number"><span class="hljs-number">0</span></span> ), jsin( <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) {} ~JsonObject() { finish(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">finish</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// moves the stream to the end of the object .... void JsonObject::finish() { .... } .... }</span></span></code> </pre> <br>  This class has a copy constructor and destructor, however, there is no overloading of the assignment operator for it.  The problem here is that the automatically generated assignment statement can only assign a pointer to <i>JsonIn</i> .  As a result, both objects of the <i>JsonObject</i> class point to the same <i>JsonIn</i> .  It is not known whether such a situation can arise somewhere now, but in any case, this is a rake, which sooner or later someone will step on. <br><br>  A similar problem is present in the next class. <br><br>  <a href="https://www.viva64.com/ru/w/v690/">V690</a> The 'JsonArray' class implements a copy constructor, but there isn‚Äôt the '=' operator.  It is dangerous to use such a class.  json.h 820 <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JsonArray</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: .... JsonIn *jsin; .... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: JsonArray( JsonIn &amp;jsin ); JsonArray( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> JsonArray &amp;jsarr ); JsonArray() : positions(), ...., jsin( <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) {}; ~JsonArray() { finish(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">finish</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// move the stream position to the end of the array void JsonArray::finish() { .... } }</span></span></code> </pre> <br>  For more information about the danger of the lack of overloading of an assignment operator for a complex class, see the article " <a href="https://www.artima.com/cppsource/bigtwo.html">The Law of The Big Two</a> " (or in the translation of this article " <a href="https://habr.com/ru/post/31346/">C ++: The Law of the Big Two</a> "). <br><br>  <b>Examples 7, 8:</b> <br><br>  Another example related to the overloaded assignment operator, but this time is about its concrete implementation. <br><br>  <a href="https://www.viva64.com/ru/w/v794/">V794</a> The assignment operator should not be protected from the case of this == &amp; other.  mattack_common.h 49 <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StringRef</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: .... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StringRefTestAccess</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>* m_start; size_type m_size; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* m_data = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> = ( StringRef <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> &amp;other ) <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> -&gt; StringRef&amp; { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>[] m_data; m_data = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; m_start = other.m_start; m_size = other.m_size; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; }</code> </pre><br>  The problem is that this implementation is not protected from assigning the object to itself, which is unsafe practice.  That is, if the operator is given a link to <i>* this</i> , a memory leak may occur. <br><br>  A similar example of mistakenly overloading an assignment operator with an interesting side effect: <br><br>  <a href="https://www.viva64.com/ru/w/v794/">V794</a> The assignment operator should not be protected from the case of this == &amp; rhs'.  player_activity.cpp 38 <br><br><pre> <code class="cpp hljs">player_activity &amp;player_activity::<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>=( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> player_activity &amp;rhs ) { type = rhs.type; .... targets.clear(); targets.reserve( rhs.targets.size() ); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::transform( rhs.targets.begin(), rhs.targets.end(), <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::back_inserter( targets ), []( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> item_location &amp; e ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> e.clone(); } ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; }</code> </pre><br>  In this case, there is also no check for assigning an object to itself.  But in addition the vector is filled.  If you try to assign an object to yourself by such an overload, then in the <i>targets</i> field you will get a doubled vector, some of whose elements are corrupted.  However, there is <i>clear</i> before the <i>transform</i> , which will clear the object's vector and data will be lost. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/92a/db9/a3a/92adb9a3ab8b30a4f8c02de2bc353a7a.png" alt="Picture 16"></div><br><h2>  Retreat III </h2><br>  In 2008, the bagels even acquired a formal definition, which received the epic title ‚ÄúBerlin Interpretation‚Äù.  According to this definition, the main features of such games are: <br><br><ul><li>  Randomly generated world, which increases replayability; </li><li>  Permadeath: if your character dies - he dies forever and all items are lost; </li><li>  Stepwise: changes occur only with the player's action, until the action is made - time stops; </li><li>  Survival: resources are extremely limited. </li></ul><br>  And the most important thing: bagels are aimed primarily at exploring and discovering the world, searching for new ways of using objects and passing dungeons. <br><br>  The usual situation in Cataclysm DDA is: you are cold and hungry to death, you are thirsty, and indeed you have six tentacles instead of your legs. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8fe/f8e/b69/8fef8eb69a48050011726fe47ec1da35.png" alt="Picture 15"></div><br><h2>  Important details </h2><br>  <b>Example 9:</b> <br><br>  <a href="https://www.viva64.com/ru/w/v1028/">V1028</a> Possible overflow.  Consider casting operands of the 'start + larger' type, not the result.  worldfactory.cpp 638 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> worldfactory::draw_mod_list( <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> &amp;start, .... ) { .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> larger = ....; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iNum = ....; .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( .... ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( iNum &gt;= <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>&gt;( start ) &amp;&amp; iNum &lt; <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>&gt;( start + larger ) ) { .... } .... } .... }</code> </pre> <br>  It seems that the programmer wanted to avoid overflow.  But bringing the result of addition in such a case is meaningless, since overflow will arise as soon as numbers are added, and the extension of types will be made over the meaningless result.  In order to avoid this situation, it is necessary to bring only one of the arguments to a larger type: <i>(static_cast &lt;size_t&gt; (start) + larger)</i> . <br><br>  <b>Example 10:</b> <br><br>  <a href="https://www.viva64.com/ru/w/v530/">V530</a>  worldfactory.cpp 1340 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> worldfactory::world_need_lua_build( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> world_name ) { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> LUA .... #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// Prevent unused var error when LUA and RELEASE enabled. world_name.size(); return false; }</span></span></span></span></code> </pre> <br>  For such cases, there is a little trick.  If the variable is unused, instead of trying to call any method, you can simply write <i>(void) world_name</i> to suppress the compiler warning. <br><br>  <b>Example 11:</b> <br><br>  <a href="https://www.viva64.com/ru/w/v812/">V812</a> Decreased performance.  Ineffective use of the 'count' function.  It can possibly be replaced by the call to the 'find' function.  player.cpp 9600 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> player::read( <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> inventory_position, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> continuous ) { .... player_activity activity; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !continuous || !<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::all_of( learners.begin(), learners.end(), [&amp;]( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::pair&lt;npc *, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; elem ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::count( activity.values.begin(), activity.values.end(), elem.first-&gt;getID() ) != <span class="hljs-number"><span class="hljs-number">0</span></span>; } ) { .... } .... }</code> </pre> <br>  Judging by the fact that the result of <i>count is</i> compared with zero, the idea is to understand whether there is at least one required element among the <i>activity</i> .  But <i>count is</i> forced to go through the entire container, since it counts all occurrences of the element.  In this situation, it will be faster to use <i>find</i> , which stops after the first match found. <br><br>  <b>Example 12:</b> <br><br>  The following error is easily detected if you know about one subtlety. <br><br>  <a href="https://www.viva64.com/ru/w/v739/">V739</a> EOF should not be compared with a value of the 'char' type.  The 'ch' should be of the 'int' type.  json.cpp 762 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> JsonIn::skip_separator() { <span class="hljs-keyword"><span class="hljs-keyword">signed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> ch; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">','</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ate_separator ) { .... } .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == EOF) { .... }</code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/976/f53/d2f/976f53d2fe83c567077c7eacb481d852.png" alt="Picture 3"></div><br>  This is one of those errors that can be difficult to notice if you don‚Äôt know that <i>EOF is</i> defined as -1.  Accordingly, if you try to compare it with a <i>signed char</i> type variable, the condition is almost always <i>false</i> .  The only exception is if the character code is 0xFF (255).  When comparing such a symbol will turn into -1 and the condition will be true. <br><br>  <b>Example 13:</b> <br><br>  The next small mistake may one day become critical.  No wonder it is in the CWE list as <a href="https://cwe.mitre.org/data/definitions/834.html">CWE-834</a> .  And by the way, there were five of them. <br><br>  <a href="https://www.viva64.com/ru/w/v663/">V663</a> Infinite loop is possible.  The 'cin.eof ()' condition is not a loop from the loop.  Consider adding the 'cin.fail ()' function call to the conditional expression.  action.cpp 46 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_keymap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::istream &amp;keymap_txt, .... )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>( !keymap_txt.eof() ) { .... } }</code> </pre> <br>  As stated in the warning, checking for the end of the file when reading is not enough, you must also check for read error <i>cin.fail ()</i> .  Change the code for a safer reading: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span>( !keymap_txt.eof() ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(keymap_txt.fail()) { keymap_txt.clear(); keymap_txt.ignore(numeric_limits&lt;streamsize&gt;::max(),<span class="hljs-string"><span class="hljs-string">'\n'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } .... }</code> </pre> <br>  <i>keymap_txt.clear () is</i> needed so that when an error is read from the file, the state (flag) of the error is removed from the stream, otherwise the text will not be <i>readable anymore</i> .  <i>keymap_txt.ignore</i> with <i>numeric_limits &lt;streamsize&gt; :: max ()</i> parameters and a control newline character allows you to skip the rest of the line. <br><br>  There is a much easier way to stop reading: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span>( !keymap_txt ) { .... }</code> </pre> <br>  If you use a stream in the context of logic, it converts itself to a value equivalent to <i>true</i> until it reaches <i>EOF</i> . <br><br><h2>  Retreat IV </h2><br>  Now the most popular are games that combine the signs of roguelike games and other genres: platformers, strategies, etc. Such games began to be called roguelike-like or roguelite.  Such games include such famous titles as Don't Starve, The Binding of Isaac, FTL: Faster Than Light, Darkest Dungeon and even Diablo. <br><br>  Although at times the difference between roguelike and roguelite is so small that it is not clear what genre the game belongs to.  Someone thinks that Dwarf Fortress is no longer a roguelike, but for someone, and Diablo is a classic bagel. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/330/a83/895/330a838954a71a90e8bd65764a9169a8.png" alt="Picture 1"></div><br><h2>  Conclusion </h2><br>  Although the project as a whole is an example of high-quality code, and it was not possible to find many serious errors, this does not mean that the use of static analysis is redundant for it.  The point is not in one-time checks, which we are doing to popularize the methodology of static code analysis, but in regular use of the analyzer.  Then many errors can be identified at an early stage and, therefore, reduce the cost of correcting them.  <a href="https://www.viva64.com/ru/b/0606/">An example of</a> calculations. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/18d/90c/4b5/18d90c4b57268f6f55e2721a68fc017c.png" alt="Picture 2"></div><br>  Over the considered game and is now under active work, and there is an active community of modders.  And it is ported to many platforms, including iOS and Android.  So, if you are interested in this game, I recommend to try it! <br><br><p> <a href="https://habr.com/ru/company/pvs-studio/blog/449488/"><img src="https://habrastorage.org/getpro/habr/post_images/898/3b6/5a7/8983b65a74adb29a2113eba12fbec3f1.png" align="left"></a> </p></div><p>Source: <a href="https://habr.com/ru/post/449472/">https://habr.com/ru/post/449472/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../44946/index.html">About two visitors of the restaurant who ordered fish.</a></li>
<li><a href="../449462/index.html">Using PKCS # 11 cryptographic token mechanisms in scripting languages</a></li>
<li><a href="../449464/index.html">Widget vk.com installs a counter from mail.ru on the site without asking</a></li>
<li><a href="../449468/index.html">As an "ethical hacking" software maker for gambling turned into a complete nightmare</a></li>
<li><a href="../44947/index.html">Qualities of a promising employee</a></li>
<li><a href="../449476/index.html">New type of SSD-storage will reduce power consumption in the data center - how it works</a></li>
<li><a href="../44948/index.html">SMS notifications with your own hands</a></li>
<li><a href="../449484/index.html">We create air quality control sensor on InfluxDB, Grafana, Docker and Raspberry Pi</a></li>
<li><a href="../449486/index.html">Mass outcome of browser games</a></li>
<li><a href="../44949/index.html">Perpetuum mobile Magnetogenerator free energy.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>