<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asterisk + FreeSwitch + Skype. Detailed guide</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, residents of Habr! 

 Having experience in the installation of Asterisk-based voip-servers, I decided to offer my detailed installation guid...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asterisk + FreeSwitch + Skype. Detailed guide</h1><div class="post__text post__text-html js-mediator-article"><img width="300" align="left" hspace="5" vspace="5" src="https://habrastorage.org/getpro/habr/post_images/fb3/de4/a7e/fb3de4a7e3f453f6a968e319b009a64e.jpg"><br><br>  Good day, residents of Habr! <br><br>  Having experience in the installation of Asterisk-based voip-servers, I decided to offer my detailed installation guide for the Asterisk-based call-center in conjunction with Skype.  Due to the popularization of Skype, this network has been used for call centers of many companies.  The use of her official client greatly limits our possibilities.  This assembly allows you to increase the number of simultaneous calls from the Skype-network. <br><a name="habracut"></a><br><h5>  <b>1. We update the server</b> </h5><br>  Install all the necessary packages and updates.  In the console, enter the command: <br><pre><code class="bash hljs">apt-get update apt-get upgrade apt-get install build-essential mc automake autoconf bison flex libtool libncurses5-dev libssl-dev dahdi-source subversion x11vnc yate-qt4 yate-mysql yum op-panel apt-get -f install apt-get install yate-qt4 yate-mysql yum op-panel</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  <b>2. Safety Notices</b> </h5><br>  Almost always immediately after installing the server, the selection of passwords begins using the standard port (22) of the ssh protocol to your server.  If, God forbid, you put a standard, well-known ‚Äúpick-ups‚Äù password, your server will capture and delete all important data.  The easiest way is to change the port number: <br><br><pre> <code class="bash hljs">nano /etc/ssh/sshd_config</code> </pre><br>  Find the line (almost at the very beginning): <i>Port 22</i> .  Change the number 22 to whatever you like, ad infinitum (preferably not more than 65535).  Restart ssh: <br><br><pre> <code class="bash hljs">/etc/init.d/ssh restart</code> </pre><br><h5>  <b>3. Install Asterisk</b> </h5><br>  3.1.  Everything is installed from the repositories <br><br><pre> <code class="bash hljs">apt-get install asterisk asterisk-mp3 asterisk-mysql asterisk-ooh323c asterisk-h323 asterisk-sounds-main asterisk-moh-opsound-g722 asterisk-moh-opsound-gsm asterisk-moh-opsound-wav</code> </pre><br>  3.2.  Install Web GUI: <br><br><pre> <code class="bash hljs">mkdir -p /root/asterisk/asterisk-gui <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /root/downloads/asterisk-gui/ svn checkout http://svn.digium.com/svn/asterisk-gui/trunk asterisk-gui svn checkout http://svn.digium.com/svn/asterisk-gui/branches/2.0/ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /root/downloads/asterisk-gui/2.0/ ./configure make make install <span class="hljs-comment"><span class="hljs-comment"># (  /var/lib/asterisk/) cp -r /etc/asterisk /etc/asterisk.backup chown -R asterisk:asterisk /var/lib/asterisk/</span></span></code> </pre><br>  3.3.  Add login information to the file manager.conf: <br><br><pre> <code class="bash hljs">nano /etc/asterisk/manager.conf enabled = yes webenabled = yes port = 5038 bindaddr = 127.0.0.1 [root] secret = toor <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> = system,call,<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>,verbose,<span class="hljs-built_in"><span class="hljs-built_in">command</span></span>,agent,user,config write = system,call,<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>,verbose,<span class="hljs-built_in"><span class="hljs-built_in">command</span></span>,agent,user,config</code> </pre> <br>  Where ‚Äúroot‚Äù is the server administrator, and ‚Äútoor‚Äù is the administrator password. <br>  Editing http.conf: <br><br><pre> <code class="bash hljs">nano /etc/asterisk/http.conf</code> </pre><br><br><pre> <code class="bash hljs">enabled=yes enablestatic=yes bindaddr = 127.0.01 redirect = / /static/config/cfgbasic.html [post_mappings] backups = /var/lib/asterisk/gui_backups</code> </pre><br>  3.4.  We carry out the necessary actions to complete <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /root/downloads/asterisk-gui/2.0/ make checkconfig</code> </pre><br>  Delete the / usr / share / asterisk / static-http / folder before creating a symbolic link: <br><br><pre> <code class="bash hljs">ln -s /var/lib/asterisk/static-http/ /usr/share/asterisk/ mk dir /usr/share/asterisk/static-http/config chmod 777 /usr/share/asterisk/static-http/config /etc/init.d/asterisk restart</code> </pre><br>  <b>Check:</b> <br><br>  In Ubuntu, the root directory of the Asterisk web server is located in <i>/ usr / share / asterisk / static-http /</i> , <br>  and the GUI is installed in <i>/ var / lib / asterisk / static-http</i> , so you need to delete the empty folder: <br><br><pre> <code class="bash hljs">rmdir /usr/share/asterisk/static-http/</code> </pre><br>  And create a link: <br><br><pre> <code class="bash hljs">ln -s /var/lib/asterisk/static-http/ /usr/share/asterisk/ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/asterisk-gui/ sudo make checkconfig</code> </pre> <br>  3.5.  Starting and stopping Asterisk <br><br>  If you installed Asterisk, you can run it with the command: <br><br><pre> <code class="bash hljs">/usr/src/asterisk -vvvgc</code> </pre><br>  You can stop Asterisk from the CLI using the ‚Äústop now‚Äù command. <br>  With no arguments, Asterisk runs as a daemon. <br><br><pre> <code class="bash hljs">/usr/sbin/asterisk</code> </pre><br>  Connect to the command line interface (CLI) by using the 'r' argument. <br><br><pre> <code class="bash hljs">/usr/sbin/asterisk -r   asterisc -r</code> </pre><br>  Reloading configuration files without a full reboot: <br><br><pre> <code class="bash hljs">asterisk -rx reload</code> </pre><br>  If the GUI hangs on the Checking write permission for gui folder, then: <br>  First you need to replace the line in the /var/lib/asterisk/static-http/config/js/astman.js file <br><br><pre> <code class="bash hljs">timeout : <span class="hljs-string"><span class="hljs-string">'60000'</span></span></code> </pre><br>  On <br><pre> <code class="bash hljs">timeout : <span class="hljs-string"><span class="hljs-string">'6'</span></span></code> </pre><br><br>  If it does not help, then reset all rights: <br><br><pre> <code class="bash hljs">chown -R asterisk:asterisk /var/lib/asterisk/ chmod -R 777 /var/lib/asterisk/ chown -R asterisk:asterisk /etc/asterisk/ chmod -R 777 /etc/asterisk/</code> </pre><br>  3.6.  Creating an Asterisk group and user <br><br><pre> <code class="bash hljs">/usr/sbin/groupadd asterisk /usr/sbin/useradd -d /var/lib/asterisk -g asterisk asterisk</code> </pre><br>  3.7.  Change of rights <br><br>  Change the rights to use the following files: <br><br><pre> <code class="bash hljs">chown --recursive asterisk:asterisk /var/lib/asterisk chown --recursive asterisk:asterisk /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/asterisk chown --recursive asterisk:asterisk /var/run/asterisk chown --recursive asterisk:asterisk /var/spool/asterisk chown --recursive asterisk:asterisk /usr/lib/asterisk chown --recursive asterisk:asterisk /etc/asterisk/</code> </pre><br>  ## If you are using Zaptel: <br><br><pre> <code class="bash hljs">chown --recursive asterisk:asterisk /dev/zap</code> </pre><br>  ## If you are using DAHDI <br><br><pre> <code class="bash hljs">chown --recursive asterisk:asterisk /dev/dahdi</code> </pre><br>  # ------------------------------------------------- --- <br><br><pre> <code class="bash hljs">chmod --recursive u=rwX,g=rX,o= /var/lib/asterisk chmod --recursive u=rwX,g=rX,o= /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/asterisk chmod --recursive u=rwX,g=rX,o= /var/run/asterisk chmod --recursive u=rwX,g=rX,o= /var/spool/asterisk chmod --recursive u=rwX,g=rX,o= /usr/lib/asterisk</code> </pre><br>  ## If you are using Zaptel <br><br><pre> <code class="bash hljs">chmod --recursive u=rwX,g=rX,o= /dev/zap</code> </pre><br>  ## If you are using DAHDI <br><br><pre> <code class="bash hljs">chmod --recursive u=rwX,g=rX,o= /dev/dahdi</code> </pre><br>  # ------------------------------------------------- --- <br><br><pre> <code class="bash hljs">chown --recursive asterisk:asterisk /etc/asterisk chmod --recursive u=rwX,g=rX,o= /etc/asterisk</code> </pre><br>  3.8.  Asterisk directories <br><br>  / usr / lib / asterisk / modules: Contains binary files (modules, codecs). <br>  / var / lib / asterisk: Contains variable data (sounds, scripts, etc.). <br>  / var / spool / asterisk: Files created during work (voice messages, outgoing calls, etc.). <br>  / var / log / asterisk: Logs, call information. <br>  / etc / asterisk: Asterisk configuration files. <br><br>  Configurations: <br>  musiconhold.conf - Set music on hold settings for MusicOnHold. <br>  cdr_mysql.conf - Customize storage of call records in MySQL. <br>  manager.conf - Configuring the Manager interface. <br>  meetme.conf - Set up conferences (meetme). <br>  mgcp.conf - Configure settings for MGCP devices. <br>  parking.conf - Call parking parking options. <br>  voicemail.conf - Voicemail settings (VoiceMail). <br>  agents.conf - Asterisk agents. <br>  extensions.conf - Asterisk Numbering Plan. <br>  iax.conf - Configure IAX devices. <br>  modem.conf - ISDN configuration using ISDN4Linux. <br>  vpb.conf - Voicetronix hardware setup. <br>  alsa.conf - ALSA sound driver settings for the console user. <br>  festival.conf - Parameters for working with the festival speech synthesizer. <br>  modules.conf - Configure Asterisk modules. <br>  zapata.conf - Setup of analog digium telephony devices. <br>  asterisk.conf - Locating Asterisk directories. <br>  indications.conf - Setting parameters for analog PBXs of various countries. <br>  rpt.conf - rtp protocol parameters. <br>  logger.conf - Asterisk logging options. <br><br>  The Asterisk Web GUI control panel will be available at the address: <a href="http://host/">host</a> : 8088, where host is the address of the server where Asterisk is located. <br><br>  3.9 Configuring Asterisk via Web GUI <br><br>  <b>Trunks.</b>  <b>Voip trunks:</b> <br>  Provider Name: SIBNET <br>  Hostname: sibnet.ru <br>  Username: user123 <br>  Password: pass123 <br>  CallerID: user <br>  FromDomain: sibnet.ru <br>  FromUser: user123 <br><br>  <b>Outgoing Calling Rules:</b> <br>  Calling Rule Name: World <br>  Pattern: _XXXXXXXXXXX <br>  Caller ID: Admin <br>  Destination: 6001 <br>  Use Trunk: SIBNET <br><br>  <b>DialPlans:</b> <br>  DialPlan Name: user <br>  Include Outgoing Calling Rules: World <br>  Include Local Contexts: default parkedcalls ringgroups voicemenus queues voicemailgroups directory pagegroups page_an_extension <br><br>  <b>Incoming Calling Rules:</b> <br>  Pattern: _XXXXXXXXXXX <br>  Destination: 6001 <br><br><h5>  <b>4. Go to install Skype</b> </h5><br>  4.1.  Create the file /etc/yum.repos.d/skype.repo and add to it: <br><br><pre> <code class="bash hljs">[skype] name=Skype Repository baseurl=http://download.skype.com/linux/repos/fedora/updates/i586/ gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-skype</code> </pre><br>  Install with the command: <br><pre> <code class="bash hljs">yum --nogpgcheck install skype</code> </pre><br>  Or from packages: <br><br><pre> <code class="bash hljs">wget www.skype.com/go/getskype-linux-deb apt-get -f install dpkg -i skype-debian_2.0.0.72-1_i386.deb  dpkg -i getskype-linux-deb aptitude install skype</code> </pre><br>  4.2.  Installing additional packages <br><br>  On rpm.pbone.net we search, download and install qt4, qt4-x11 packages. <br>  Also: <br><br><pre> <code class="bash hljs">yum install x11vnc  apt-get install x11vnc</code> </pre><br>  4.3.  Customization <br><br>  We get the user under which Skype will work: <br><br><pre> <code class="bash hljs">adduser --home /home/skype --ingroup audio --disabled-password skype</code> </pre><br>  Create a directory from which Skype will read its config: <br><br><pre> <code class="bash hljs">mkdir -p /home/skype/multi/interface01 chown -R skype.audio /home/skype/multi</code> </pre><br>  If skype is turned off, you can try this method: <br>  <i>nano</i> or <i>vim / usr / local / bin / skype_start</i> with the following contents: <br><div class="spoiler">  <b class="spoiler_title">Spoiler</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh SKYPE_SYSTEM_USER=skype SKYPE_HOME=/home/skype/multi SKYPE_USER=username SKYPE_PASSWORD=userpass SKYPE_INSTANCES=N XVFB=/usr/bin/Xvfb module_reload() { rmmod snd-dummy modprobe snd-dummy } skype_start() { for i in $(seq 1 $SKYPE_INSTANCES); do i=`printf "%02d" $i` $XVFB :1$i -ac &gt;&gt; /dev/null 2&gt;&amp;1 &amp; sleep 3 su $SKYPE_SYSTEM_USER -c "/bin/echo '$SKYPE_USER $SKYPE_PASSWORD'| DISPLAY=:1$i /usr/bin/skype \ --dbpath=$SKYPE_HOME/interface$i --pipelogin &gt;&gt; /dev/null 2&gt;&amp;1 &amp;" echo "Skype $i started" done } skype_stop() { kill -TERM `ps -u $SKYPE_SYSTEM_USER -o pid=` &gt;&gt; /dev/null 2&gt;&amp;1 sleep 3 kill -TERM `ps -C Xvfb -o pid=` &gt;&gt; /dev/null 2&gt;&amp;1 } case "$1" in start) module_reload sleep 3 skype_start ;; stop) skype_stop ;; restart) skype_stop sleep 3 skype_start ;; *) echo $"Usage: $0 {start|stop|restart}" exit 1 esac</span></span></code> </pre><br></div></div><br>  Making it executable: <br><br><pre> <code class="bash hljs">chmod +x /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/skype_start</code> </pre><br>  4.4.  Launch <br><br>  We start the VNC server <br><br><pre> <code class="bash hljs">aptitude install x11vnc /usr/bin/Xvfb :101 -ac &amp; x11vnc -display :101</code> </pre><br>  Create a file where the password for authorization will be stored: <br><br><pre> <code class="bash hljs">mcedit /home/passwd</code> </pre><br>  Create a password: <br><br><pre> <code class="bash hljs">x11vnc -storepasswd 123456 /home/passwd</code> </pre><br>  The rights: <br><br><pre> <code class="bash hljs">chmod 777 /home/passwd chown rr /home/passwd</code> </pre><br>  Stop process: <br><br><pre> <code class="bash hljs">ps ax | grep vnc <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> 22062 <span class="hljs-comment"><span class="hljs-comment"># ( )</span></span></code> </pre><br>  Before launching Skype, you need to run these modules: <br><br><pre> <code class="bash hljs">rmmod snd-dummy modprobe snd-dummy <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"snd_dummy"</span></span> &gt;&gt; /etc/modules</code> </pre><br>  Skype launch: <br><br><pre> <code class="bash hljs">su skype -c <span class="hljs-string"><span class="hljs-string">"/bin/echo 'username userpass'| DISPLAY=:101 /usr/bin/skype --dbpath=/home/skype/multi/interface01 --pipelogin &amp;"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> skype <span class="hljs-comment"><span class="hljs-comment">#  Skype ps aux # </span></span></code> </pre><br>  Having connected via vnc to the server, you can see the Skype launched in the previous step, in the settings of which you need to remove all unnecessary (disable events, automatic status change, etc.) and select the dummy driver as all audio devices (Dummy-HW 2.0) . <br><br><h5>  <b>5. Installing FreeSwitch</b> </h5><br>  5.1.  Install the necessary libraries: <br><br><pre> <code class="bash hljs">apt-get -y install build-essential subversion automake autoconf wget libtool libncurses5-dev xvfb libx11-dev libasound2-dev xfs xfonts-100dpi xfonts-75dpi xfonts-scalable apt-get install autoconf automake g++ git-core libjpeg62-dev libncurses5-dev libtool make python-dev gawk pkg-config gnutls-bin apt-get install libcurl4-openssl-dev libexpat1-dev libgnutls-dev libtiff4-dev libx11-dev unixodbc-dev libssl-dev python2.6-dev zlib1g-dev libzrtpcpp-dev libasound2-dev libogg-dev libvorbis-dev libperl-dev libgdbm-dev libdb-dev python-dev uuid-dev bison yum install expat-devel gnutls-devel libtiff-devel libX11-devel unixODBC-devel libssl-devel python-devel zlib-devel libzrtpcpp-devel alsa-lib-devel libogg-devel libvorbis-devel perl-libs gdbm-devel libdb-devel uuid-devel @development-tools</code> </pre><br>  5.2.  Download FreeSwitch: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git://git.freeswitch.org/freeswitch.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> freeswitch ./bootstrap.sh</code> </pre><br>  5.3.  Editing modules.conf: <br><br><pre> <code class="bash hljs">nano /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src/freeswitch/modules.conf</code> </pre><br>  Check and add all missing: <br><br><pre> <code class="bash hljs">applications/mod_limit codecs/mod_voipcodecs endpoints/mod_skypopen mod_say_ru formats/mod_file_string</code> </pre><br>  5.4.  Assembly and installation <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src/freeswitch ./configure make make install all <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span>-sounds-install <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span>-moh-install uhd-sounds-install uhd-moh-install hd-sounds-install hd-moh-install sounds-install moh-install</code> </pre><br>  5.5.  Copy the mod_skypopen configuration and the init script to start FreeSwitch: <br><br><pre> <code class="bash hljs">cp /usr/src/freeswitch/src/mod/endpoints/mod_skypopen/configs/skypopen.conf.xml /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/freeswitch/conf/autoload_configs/ cp /usr/src/freeswitch/debian/freeswitch.init /etc/init.d/freeswitch cp debian/freeswitch.default /etc/default/freeswitch sed -i <span class="hljs-string"><span class="hljs-string">'s/opt/usr\/local/g'</span></span> /etc/init.d/freeswitch sed -i <span class="hljs-string"><span class="hljs-string">'s/false/true/g'</span></span> /etc/default/freeswitch</code> </pre><br>  5.6.  We get the user to FreeSwitch <br><br><pre> <code class="bash hljs">adduser --disabled-password --quiet --system --home /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/freeswitch --gecos <span class="hljs-string"><span class="hljs-string">"FreeSwitch Voice Platform"</span></span> --ingroup daemon freeswitch adduser freeswitch audio chown -R freeswitch.daemon /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/freeswitch chmod -R o-rwx /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/freeswitch/</code> </pre><br>  5.7.  Run and other FreeSwitch commands <br><br><pre> <code class="bash hljs">load mod_skypiax <span class="hljs-comment"><span class="hljs-comment">#   sk list #    console loglevel 9 #    shutdown #   FreeSwitch /usr/local/freeswitch/bin/freeswitch #  FreeSwitch</span></span></code> </pre><br>  5.8.  Mod skypopen <br><br>  We now turn to the most important setting - Public API.  Here you need to allow mod_skypopen to access Skype. <br>  Skype itself allows you to add programs to the ‚ÄúAllowed programs‚Äù list only after they have accessed Skype, but it is impractical to launch FreeSwitch and mod_skypopen only to make such a setting, so the creators of mod_skypiax wrote a small utility that simulates the appeal of mod_skypopen to Skype.  It is located in the FreeSwitch source tree and needs to be compiled separately: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src/freeswitch/src/mod/endpoints/mod_skypopen/configs/old-stuff gcc -Wall -ggdb skypopen_auth.c -o skypopen_auth -lX11</code> </pre><br>  <b>You must now have the VNC screen open.</b> <br><br>  Run skypopen: <br><pre> <code class="bash hljs">./skypopen_auth :101</code> </pre><br>  Return to the vnc-connection window - in the dialog box that appears, you need to allow Skype to connect to the skypopen API.  You can also do this in the /home/skype/multi/interface01/username/config.xml file.  Citing here is this view: <br><br><pre> <code class="bash hljs">&lt;UI&gt; &lt;API&gt; &lt;Authorizations&gt;skypopen&lt;/Authorizations&gt; &lt;BlockedPrograms&gt;&lt;/BlockedPrograms&gt; &lt;/API&gt; &lt;CaptureDevice&gt;2&lt;/CaptureDevice&gt; &lt;Notifications&gt; &lt;Enable&gt; &lt;SkypeLogin&gt;0&lt;/SkypeLogin&gt; &lt;/Enable&gt; &lt;/Notifications&gt; &lt;SoundDevice&gt;2&lt;/SoundDevice&gt; &lt;/UI&gt;</code> </pre><br><br><h5>  <b>6. Configuring</b> </h5><br>  The important point is that skype-clients should be launched before loading the mod_skypopen module, i.e.  before starting freeSwitch.  Also, stopping Skype‚Äôs already involved mod_skypopen copies will cause FreeSwitch to crash. <br><br>  6.1.  Mod_skypopen <br><br><pre> <code class="bash hljs">nano /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/freeswitch/conf/autoload_configs/skypopen.conf.xml</code> </pre><br>  Edit something like this: <br><br><pre> <code class="bash hljs">&lt;configuration name=<span class="hljs-string"><span class="hljs-string">"skypopen.conf"</span></span> description=<span class="hljs-string"><span class="hljs-string">"Skypopen Configuration"</span></span>&gt; &lt;global_settings&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"debug"</span></span> value=<span class="hljs-string"><span class="hljs-string">"8"</span></span>/&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"dialplan"</span></span> value=<span class="hljs-string"><span class="hljs-string">"XML"</span></span>/&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"skype_user"</span></span> value=<span class="hljs-string"><span class="hljs-string">"username"</span></span>/&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"report_incoming_chatmessages"</span></span> value=<span class="hljs-string"><span class="hljs-string">"false"</span></span>/&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"write_silence_when_idle"</span></span> value=<span class="hljs-string"><span class="hljs-string">"false"</span></span>/&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"silent_mode"</span></span> value=<span class="hljs-string"><span class="hljs-string">"false"</span></span>/&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"setsockopt"</span></span> value=<span class="hljs-string"><span class="hljs-string">"true"</span></span>/&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"codec-prefs"</span></span> value=<span class="hljs-string"><span class="hljs-string">"gsm,ulaw"</span></span>/&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"hold-music"</span></span> value=<span class="hljs-string"><span class="hljs-string">"$</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${moh_uri}</span></span></span><span class="hljs-string">"</span></span>/&gt; &lt;/global_settings&gt; &lt;per_interface_settings&gt; &lt;interface id=<span class="hljs-string"><span class="hljs-string">"1"</span></span> name=<span class="hljs-string"><span class="hljs-string">"skypopen1"</span></span>&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"destination"</span></span> value=<span class="hljs-string"><span class="hljs-string">"5000"</span></span>/&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"context"</span></span> value=<span class="hljs-string"><span class="hljs-string">"default"</span></span>/&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"X11-display"</span></span> value=<span class="hljs-string"><span class="hljs-string">":101"</span></span>/&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"tcp_cli_port"</span></span> value=<span class="hljs-string"><span class="hljs-string">"15556"</span></span>/&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"tcp_srv_port"</span></span> value=<span class="hljs-string"><span class="hljs-string">"15557"</span></span>/&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"hold-music"</span></span> value=<span class="hljs-string"><span class="hljs-string">"$</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${moh_uri}</span></span></span><span class="hljs-string">"</span></span>/&gt; &lt;/interface&gt; &lt;/per_interface_settings&gt; &lt;/configuration&gt;</code> </pre><br><br>  Here: <br>  <b>5000</b> - extension to which the incoming Skype call will be routed; <br>  <b>: 101</b> - X server display; <br>  <b>skype_user</b> is the name of the Skype <b>account</b> . <br><br>  6.2.  Add Skypopen to autoload <br><br>  Add mod_skypopen to the list of modules loaded at the time of the launch of FreeSwitch. <br>  To do this, you need to uncomment or add the line in /usr/local/freeswitch/conf/autoload_configs/modules.conf.xml file: <br><br><pre> <code class="bash hljs">&lt;load module=<span class="hljs-string"><span class="hljs-string">"mod_skypiax"</span></span>/&gt;</code> </pre><br>  6.3.  Configuration extension 5000 <br><br>  As you probably remember, incoming Skype calls will be routed to extension 5000, which still needs to be created.  To do this, in the / usr / local / freeswitch / conf / dialplan / default directory create a file 02_skype.xml with the following content: <br><br><pre> <code class="bash hljs">&lt;include&gt; &lt;extension name=<span class="hljs-string"><span class="hljs-string">"skype_incoming"</span></span>&gt; &lt;condition field=<span class="hljs-string"><span class="hljs-string">"destination_number"</span></span> expression=<span class="hljs-string"><span class="hljs-string">"^7770$"</span></span>&gt; &lt;action application=<span class="hljs-string"><span class="hljs-string">"set"</span></span> data=<span class="hljs-string"><span class="hljs-string">"hangup_after_bridge=true"</span></span>/&gt; &lt;action application=<span class="hljs-string"><span class="hljs-string">"set"</span></span> data=<span class="hljs-string"><span class="hljs-string">"effective_caller_id_name=6001"</span></span>/&gt; &lt;action application=<span class="hljs-string"><span class="hljs-string">"bridge"</span></span> data=<span class="hljs-string"><span class="hljs-string">"sofia/gateway/asterisk/6001"</span></span>/&gt; &lt;action application=<span class="hljs-string"><span class="hljs-string">"hangup"</span></span>/&gt; &lt;/condition&gt; &lt;/extension&gt; &lt;/include&gt;</code> </pre><br>  Where: <br>  <b>asterisk</b> - the name of the gateway to which the call will go (PBX based on Asterisk); <br>  <b>6001</b> - extension to Asterisk, which will receive a call; <br>  <b>&lt;action application = "bridge" ...&gt;</b> - here is the extension that will be processed in asterisk when a call arrives, in this case 6001. <br><br>  In the same directory are examples of other extensions that need to be commented out, so that the extension we need is not processed elsewhere.  The same operation needs to be done in the /usr/local/freeswitch/conf/dialplan/default.xml file. <br><br>  Create the 01_skypopen.xml file: <br><br><pre> <code class="bash hljs">nano /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/freeswitch/conf/dialplan/public/01_skypopen.xml</code> </pre><br>  With content: <br><br><pre> <code class="bash hljs">&lt;extension name=<span class="hljs-string"><span class="hljs-string">"SKYPE#1"</span></span>&gt; &lt;condition field=<span class="hljs-string"><span class="hljs-string">"destination_number"</span></span> expression=<span class="hljs-string"><span class="hljs-string">"^8(\d{10})$"</span></span>&gt; &lt;action application=<span class="hljs-string"><span class="hljs-string">"set"</span></span> data=<span class="hljs-string"><span class="hljs-string">"continue_on_fail=true"</span></span>/&gt; &lt;action application=<span class="hljs-string"><span class="hljs-string">"set"</span></span> data=<span class="hljs-string"><span class="hljs-string">"hangup_after_bridge=true"</span></span>/&gt; &lt;action application=<span class="hljs-string"><span class="hljs-string">"bridge"</span></span> data=<span class="hljs-string"><span class="hljs-string">"skypopen/RR/+7</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span>/&gt; &lt;/condition&gt; &lt;/extension&gt;</code> </pre><br>  6.4.  Sip_profiles configuration <br><br>  On the server with FreeSwitch in the / usr / local / freeswitch / conf / sip_profiles / external directory create the file asterisk.xml with the following content: <br><br><pre> <code class="bash hljs">&lt;include&gt; &lt;gateway name=<span class="hljs-string"><span class="hljs-string">"asterisk"</span></span>&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"username"</span></span> value=<span class="hljs-string"><span class="hljs-string">"freeswitch"</span></span>/&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"realm"</span></span> value=<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>/&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"password"</span></span> value=<span class="hljs-string"><span class="hljs-string">"pass123"</span></span>/&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"register"</span></span> value=<span class="hljs-string"><span class="hljs-string">"true"</span></span>/&gt; &lt;param name=<span class="hljs-string"><span class="hljs-string">"ping"</span></span> value=<span class="hljs-string"><span class="hljs-string">"25"</span></span>/&gt; &lt;/gateway&gt; &lt;/include&gt;</code> </pre><br>  Where: <br>  <b>asterisk</b> - the name of the gateway (must match the one specified in the previous step); <br>  <b>127.0.0.1</b> - host with Asterisk; <br>  <b>freeswitch</b> - username to access the gateway; <br>  <b>pass123</b> is his password. <br><br>  6.5.  Sip.conf configuration <br><br>  On the server with Asterisk, add the following to /etc/asterisk/sip.conf: <br><div class="spoiler">  <b class="spoiler_title">Spoiler</b> <div class="spoiler_text"><pre> <code class="bash hljs">[freeswitch] <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=friend host=dynamic username=freeswitch port=5080 secret=pass123 [6001] fullname=Skype registersip=no callgroup=1 transfer=yes callcounter=yes context=default cid_number=6001 hassip=yes hasiax=no nat=no insecure=no autoprov=yes disallow=all alow=ulaw,ulaw,gsm,g726,g729 dtmfmode=rfc2833 host=dynamic username=60001 port=5080 fromdomain=1.1.1.1 secret=supersecret</code> </pre><br></div></div><br><br>  Where: <br>  <b>6001</b> - extension from previous steps <br>  <b>1.1.1.1</b> - server address with FreeSwitch <br>  <b>pass123</b> - password from Extensions 6001 <br><br>  It remains to re-read sip.conf: <br><br><pre> <code class="bash hljs">rasterisk -x <span class="hljs-string"><span class="hljs-string">'sip reload'</span></span></code> </pre><br>  6.6.  Configuration users.conf <br><br><div class="spoiler">  <b class="spoiler_title">Spoiler</b> <div class="spoiler_text"><pre> <code class="bash hljs">[freeswitch] <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=friend host=dynamic username=freeswitch port=5080 secret=pass123 [6001] fullname=Skype registersip=no callgroup=1 transfer=yes callcounter=yes context=default cid_number=6001 hassip=yes hasiax=no nat=no insecure=no autoprov=yes disallow=all alow=ulaw,ulaw,gsm,g726,g729 dtmfmode=inband host=dynamic username=6001 port=5080 fromdomain=1.1.1.1 secret=pass123 hasvoicemail=yes vmsecret=secret call-limit=100 macaddres=6001 label=6001 linekeys=1</code> </pre><br></div></div><br><br>  Where: <br>  <b>secret</b> - voicemail password. <br>  <b>100</b> - maximum lines. <br>  <b>nat = yes</b> - indicates that the client can be located behind the NAT and to open the media channel when calling this user a header broadcast is required. <br>  <b>host = dynamic</b> - there is no binding to the client's host address. <br>  <b>username = 6001</b> - username.  This login is then used in the SIP client settings. <br>  <b>dtmfmode = rfc2833</b> - the method of transmitting dtmf-tones dialing.  There is also an info method (must match the settings in the SIP client). <br>  <b>disallow = all</b> - disable all codecs. <br>  <b>allow = ulaw</b> - enable the ulaw codec.  The codec must be one that is supported by the client. <br>  <b>context = default</b> - the context describes the section of Dailplan that the client calls will go through. <br><br>  In extentions.conf, we add the following: <br><br><pre> <code class="bash hljs">[default] exten =&gt; 6000,1,Dial(SIP/6000) exten =&gt; 6001,1,Dial(SIP/6001)</code> </pre><br><br><h5>  <b>7. Startup procedure</b> </h5><br>  After installation, you need to reboot the system if possible.  Asterisk will be launched at boot.  The softtophone should already be active before rebooting. <br>  Priority: <br><br><pre> <code class="bash hljs">/usr/bin/Xvfb :101 -ac &amp; x11vnc -display :101 su skype -c <span class="hljs-string"><span class="hljs-string">"/bin/echo 'username userpass'| DISPLAY=:101 /usr/bin/skype --dbpath=/home/skype/multi/interface01 --pipelogin &amp;"</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/freeswitch/bin/freeswitch</code> </pre><br>  If the log in the FreeSwitch console is not displayed when an incoming call from the Skype network or the client is not displayed when connecting from the Vnc Viewer, you must manually restart the Skype client and re-check the client settings. <br><br>  Resources used: wiki.exp-it.ru, wiki.freeswitch.ru, asterisk-pbx.ru + books on asterisk. </div><p>Source: <a href="https://habr.com/ru/post/247981/">https://habr.com/ru/post/247981/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../247971/index.html">OS for data center Mesosphere: What is it and for whom</a></li>
<li><a href="../247973/index.html">Reflections on dereferencing a null pointer</a></li>
<li><a href="../247975/index.html">The troubleshooting algorithm in the LED lamp driver or Hercule Poirot rests</a></li>
<li><a href="../247977/index.html">Regarding the evolution of printed materials in interactive and electronic</a></li>
<li><a href="../247979/index.html">Automation of non-cash payments</a></li>
<li><a href="../247983/index.html">The basics of CG-drawing examples: draw an oscilloscope, apply 3D</a></li>
<li><a href="../247987/index.html">Backup audio records from a playlist on VKontakte (up to 6000) using Python and the VK API</a></li>
<li><a href="../247989/index.html">Melting Pot: Skyforge Fight</a></li>
<li><a href="../247995/index.html">Restore D-link DVG-N5204SP via UART</a></li>
<li><a href="../247997/index.html">Something from afar looking like monads</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>