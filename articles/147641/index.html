<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Compaq Descpro and NetBSD 1.6.1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In mid-August 2003, I first met this computer. I then worked in a small provider, went all day with a twisted pair bay, a ladder and full pockets of n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Compaq Descpro and NetBSD 1.6.1</h1><div class="post__text post__text-html js-mediator-article">  In mid-August 2003, I first met this computer.  I then worked in a small provider, went all day with a twisted pair bay, a ladder and full pockets of network cards on RTL8139 (there were built-in drivers in Win2k) and RTL8029 (yes, we had network segments on BNC!). <br><a name="habracut"></a><br>  Through my acquaintances, the owner of a small company asked me to configure him with a router so that it is inexpensive, safe and secure.  It should be noted that in those days, 80% of all the offices I connected managed to install Win2k and the second network card to the computer of a secretary or another employee (Ho-ho! They shared the interface and forth, on the Internet!).  The remaining 15% set for this purpose a special computer running any * nix-like OS and only 5% had a router or firewall in the classic sense. <br><br>  And so, what was this car?  It was a company Compaq Descpro, with a processor PIII, carrying on board as many as 512MB of memory, but without a built-in network card.  The usual office workaholic of those years.  The stamp on the cover indicated the date of production - November 2, 2000.  In general, that was not a pity. <br><br><img src="https://habrastorage.org/storage2/c94/5aa/eb0/c945aaeb0665a09af21b21c037db19de.jpeg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The choice of OS was not even in front of me - I was experiencing a period of NetBSD passion. <br><br><img src="https://habrastorage.org/storage2/255/2c8/859/2552c88599ae739e1b15a619c803c627.png"><br><br>  The procedure for installing this operating system is not much more difficult than a similar process for FreeBSD (sysinstall) and certainly much more convenient than OpenBSD. <br><br>  The set of functions required by the customer is fairly common - packet filtering, NAT, a proxy server for caching traffic (unlimited tariffs then was not only for legal entities, but also for physicists, as far as I know) and caching DNS.  Everything I needed was put from the packages, since the build from pkgsrc would take too much time, and I didn‚Äôt see any sense in it. <br><br>  Although the claimed support for a large number of platforms and architectures for this OS is rather conditional (I know what I‚Äôm talking about using the example of sun4v and hppa ports), for 386 the range of supported peripherals was quite wide at that time. <br><br>  After putting the computer to the customer, I saw him a few more times, but mostly for preventive purposes.  And then - years went by, the gateway obviously worked without failures, contacts were lost, the company grew, they took an administrator, but he understood more about 1C than NetBSD, and there was no need to change anything. <br><br>  And so, a month ago, I found a letter in the mail asking if I wanted to take this computer myself?  Out of small vanity, I left an autograph under the cover with the name of my site and the date of installation, so it worked.  As a reason for the replacement, it was indicated that after changing the provider and expanding the channel, the network settings changed, which were corrected, but the speed of work with the Internet did not exceed 1 Mb / s. <br><br>  So, let's look into the inner world of this representative of the computer world.  I‚Äôll say right away that the DVD drive was installed now, the way I had it, but it wasn‚Äôt in Compaq. <br><br><pre> NetBSD 1.6.1 (Siberian Sun) # 0: Wed Aug 20 21:17:36 MSD 2003
     root@gw.siberiansun.net: / usr / src / sys / arch / i386 / compile / SiberianSun
 cpu0: Intel Pentium III (Coppermine) (686-class), 863.89 MHz
 cpu0: I-cache 16 KB 32b / line 4-way, D-cache 16 KB 32b / line 2-way
 cpu0: L2 cache 256 KB 32b / line 8-way
 cpu0: features 383fbff &lt;FPU, VME, DE, PSE, TSC, MSR, PAE, MCE, CX8, APIC, SEP, MTRR&gt;
 cpu0: features 383fbff &lt;PGE, MCA, CMOV, FGPAT, PSE36, MMX&gt;
 cpu0: features 383fbff &lt;FXSR, SSE&gt;
 total memory = 510 MB
 avail memory = 470 MB
 using 6144 buffers containing 26236 KB of memory
 BIOS32 rev.  0 found at 0xe7300
 mainbus0 (root)
 pci0 at mainbus0 bus 0: configuration mode 1
 pci0: i / o space, memory space enabled, rd / line, rd / mult, wr / inv ok
 pchb0 at pci0 dev 0 function 0
 pchb0: Intel 82815 Hub (rev. 0x02)
 agp0 at pchb0: aperture at 0x44000000, size 0x4000000
 vga1 at pci0 dev 2 function 0: Intel 82815 Graphics (rev. 0x02)
 wsdisplay0 at vga1 kbdmux 1: console (80x25, vt100 emulation)
 wsmux1: connecting to wsdisplay0
 ppb0 at pci0 dev 30 function 0: Intel 82801AA Hub-to-PCI Bridge (rev. 0x02)
 pci1 at ppb0 bus 2
 pci1: i / o space, memory space enabled
 rtk0 at pci1 dev 9 function 0: RealTek 8139 10 / 100BaseTX
 rtk0: interrupting at irq 5
 rtk0: Ethernet address 00: 80: 48: 18: 01: 70
 ukphy0 at rtk0 phy 7: Generic IEEE 802.3u media interface
 ukphy0: OUI 0x000000, model 0x0000, rev.  0
 ukphy0: 10baseT, 10baseT-FDX, 100baseTX, 100baseTX-FDX, auto
 ep0 at pci1 dev 10 function 0: 3Com 3c595-TX 10/100 Ethernet
 ep0: interrupting at irq 9
 ep0: address 00: 20: af: d2: 0d: 6a, 64KB word-wide FIFO, 3: 1 Rx: Tx split
 ep0: 10baseT, 10baseT-FDX, 100baseTX, 100baseTX-FDX (default 100baseTX)
 pcib0 at pci0 dev 31 function 0
 pcib0: Intel 82801AA LPC Interface Bridge (rev. 0x02)
 pciide0 at pci0 dev 31 function 1: Intel 82801AA IDE Controller (ICH) (rev. 0x02)
 pciide0: bus-master DMA support present
 pciide0: primary channel wired to compatibility mode
 wd0 at pciide0 channel 0 drive 0: &lt;ST340014A&gt;
 wd0: drive supports 16-sector PIO transfers, LBA48 addressing
 wd0: 38165 MB, 16383 cyl, 16 head, 63 sec, 512 bytes / sect x 78163247 sectors
 wd0: 32-bit data port
 wd0: drive supports PIO mode 4, DMA mode 2, Ultra-DMA mode 5 (Ultra / 100)
 pciide0: primary channel interrupting at irq 14
 wd0 (pciide0: 0: 0): using PIO mode 4, Ultra-DMA mode 4 (Ultra / 66) (using DMA data transfers)
 pciide0: secondary channel wired to compatibility mode
 atapibus0 at pciide0 channel 1: 2 targets
 cd0 at atapibus0 drive 1: &lt;_NEC DVD_RW ND-4550A,, 1.07&gt; type 5 cdrom removable
 cd0: ‚Äã‚Äã32-bit data port
 cd0: ‚Äã‚Äãdrive supports PIO mode 4, DMA mode 2, Ultra-DMA mode 2 (Ultra / 33)
 pciide0: secondary channel interrupting at irq 15
 cd0 (pciide0: 1: 1): using PIO mode 4, Ultra-DMA mode 2 (Ultra / 33) (using DMA data transfers)
 uhci0 at pci0 dev 31 function 2: Intel 82801AA USB Controller (rev. 0x02)
 uhci0: interrupting at irq 11
 usb0 at uhci0: usb revision 1.0
 uhub0 at usb0
 uhub0: Intel UHCI root hub, class 9/0, rev 1.00 / 1.00, addr 1
 uhub0: 2 ports with 2 removable, self powered
 auich0 at pci0 dev 31 function 5: i82801AA (ICH) AC-97 Audio
 auich0: interrupting at irq 5
 auich0: ADS96 codec;  headphone, Analog Devices Phat Stereo
 audio0 at auich0: full duplex, mmap, independent
 isa0 at pcib0
 com0 at isa0 port 0x3f8-0x3ff irq 4: ns16550a, working fifo
 com1 at isa0 port 0x2f8-0x2ff irq 3: ns16550a, working fifo
 pckbc0 at isa0 port 0x60-0x64
 pckbd0 at pckbc0 (kbd slot)
 pckbc0: using irq 1 for kbd slot
 wskbd0 at pckbd0: console keyboard, using wsdisplay0
 lpt0 at isa0 port 0x378-0x37b irq 7
 pcppi0 at isa0 port 0x61
 sysbeep0 at pcppi0
 isapnp0 at isa0 port 0x279: ISA Plug 'n Play device support
 npx0 at isa0 port 0xf0-0xff: using exception 16
 fdc0 at isa0 port 0x3f0-0x3f7 irq 6 drq 2
 isapnp0: no ISA Plug 'n Play devices found
 biomask fd45 netmask ff65 ttymask ffe7
 Kernelized RAIDframe activated
 boot device: wd0
 root on wd0a dumps on wd0b
 root file system type: ffs
 IP Filter: v3.4.29 initialized.  Default = pass all, Logging = enabled
 wsdisplay0: screen 1 added (80x25, vt100 emulation)
 wsdisplay0: screen 2 added (80x25, vt100 emulation)
 wsdisplay0: screen 3 added (80x25, vt100 emulation)
 wsdisplay0: screen 4 added (80x25, vt100 emulation)
</pre><br><br>  Yes, one network card is quite good, it was used as an internal interface.  The second - frank consumer goods RTL8139. <br><br>  From the GENERIC kernel, so small (6254651 bytes for 1.6.1), the extra drivers were removed, which made it possible to further reduce its size to 2602114 bytes.  Of particular note is the compilation speed of the kernel - this is a fairly fast process, even by modern standards (if the compile / directory is not empty, then things will go much faster). <br><br>  #config <img src="https://habrastorage.org/storage2/aeb/bea/2f2/aebbea2f29e58cba2bc10afbb179e0f8.png"><br><br>  #make depend <br><br><img src="https://habrastorage.org/storage2/0e6/413/87d/0e641387d6366065a6c89f0e9b481466.png"><br><br>  #make <br><br><img src="https://habrastorage.org/storage2/24e/64f/5ec/24e64f5ec4e6903ca3fd40d13825b999.png"><br><br>  DHCP still works (dynamic update of the internal DNS zone), the DNS server works as a caching server, although the response time is rather long.  The proxy server is running.  The software is very old, with a huge number of vulnerabilities. <br><br>  BIND9 was shipped from packages, since the BIND8 supplied as part of the system was considered obsolete even in 2003. <br><br><img src="https://habrastorage.org/storage2/75b/a08/322/75ba083221452937970aeb380824029c.png"><br><br>  The reason for slow work was found rather quickly - ALTQ, apparently the administrator did not look at his settings.  ALTQ is configured on the internal interface (3Com network card - em0), as it is designed to handle outgoing traffic.  That is, the stream from the external network to the internal interface cannot exceed 95% of 1 Mb / s.  ALTQ, in this version of NetBSD, is not supported for rtl8139 network cards, so the width of the incoming channel is not adjustable at all.  Yes, it does not look very nice, but that was my knowledge about network technologies at that time and I did not have a second network card supported by ALTQ. <br><br><img src="https://habrastorage.org/storage2/2aa/749/f50/2aa749f508f14aa9fc27403b4e253564.png"><br><br>  The main packet filter for NetBSD is IPF, written by Darren Reed.  NetBSD 1.6.1 uses version v3.4.29, the current version of the packet filter is 5.1.1.  On the net you can find a lot of documentation on how to configure IP Filter, including in Russian. <br><br><img src="https://habrastorage.org/storage2/cf4/a85/05d/cf4a8505d851663ac347a309a6cf338e.png"><br><br>  The iperf tests showed that rtk0 is not the most worthy network card, as can be seen on the screenshots below in a large number of interrupts.  I also discovered a large resource consumption by the ipmon utility - the reason was simple - I forgot to remove the extra ‚Äúlog‚Äù in the rule set. <br><br>  "Reference" testing: LAN 100mb / s on not very good network cards, bypassing the router: <br><br><img src="https://habrastorage.org/storage2/396/404/f2c/396404f2ca0aac3746a7ef870a756b99.png"><br><br>  Through the router, with ALTQ disabled: <br><br><img src="https://habrastorage.org/storage2/764/b0f/857/764b0f8573110c997c097cb99426b18e.png"><br><br>  Load on the server with ALTQ disabled and ‚Äúlog‚Äù in the IPF rules: <br><br><img src="https://habrastorage.org/storage2/b32/3d4/fec/b323d4fec2a22ce1da4553e5d8cb5b24.png"><br><br>  The load on the server with ALTQ enabled, ‚Äúlog‚Äù in the IPF rules are removed: <br><br><img src="https://habrastorage.org/storage2/70d/0a4/287/70d0a42876a2d71febde925c393b126d.png"><br><br>  The load on the server with disabled ALTQ, ‚Äúlog‚Äù in the IPF rules is removed: <br><br><img src="https://habrastorage.org/storage2/c35/72a/00a/c3572a00a976e108da8ae9f8bbee7a65.png"><br><br>  ALTQ work: <br><br><img src="https://habrastorage.org/storage2/8bc/563/363/8bc563363aa4ed4fabcf4e596a70fd20.png"><br><br>  Summing up, I would like to say that after so many years the router is operational, although to work with a high-speed channel, it is necessary to replace the rtl0 network card. <br><br>  More than sure, there are still quite a few machines that continue their hard work of transferring packages in the most difficult conditions - in dusty, dirty, attic and under flower pots on window sills, from which no one remembers passwords and which are terrible to turn off. <br><br><img src="https://habrastorage.org/storage2/4a8/7df/d9f/4a87dfd9f5c4f7b5a67d1ab1c22e535d.jpeg"><br><br>  And what meetings with the past did you have,%% username? <br><br>  Disclaimer: external and local addresses, the domain name of the equipment is changed and all matches are random and not intended. </div><p>Source: <a href="https://habr.com/ru/post/147641/">https://habr.com/ru/post/147641/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147635/index.html">Interview with the owner of the botnet</a></li>
<li><a href="../147636/index.html">Social Engineering at PHDays 2012</a></li>
<li><a href="../147638/index.html">RIM CEO: BlackBerry 10 porting is good</a></li>
<li><a href="../147639/index.html">Enterprise 2.0 for Dummies</a></li>
<li><a href="../147640/index.html">TFS Aggregator</a></li>
<li><a href="../147643/index.html">Yahoo passwords have leaked to the network</a></li>
<li><a href="../147644/index.html">Law 89417-6: Get a public base of illegal content?</a></li>
<li><a href="../147645/index.html">2GIS +1: data and functions in exchange for an audience</a></li>
<li><a href="../147647/index.html">20 things I should have known at 20</a></li>
<li><a href="../147648/index.html">We start testing our iOS application</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>