<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Two paradoxes in C programs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to talk about two oddities that I had to face while programming computer algorithms in C. 

 So, the first unexpected behavior for some program...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Two paradoxes in C programs</h1><div class="post__text post__text-html js-mediator-article">  I want to talk about two oddities that I had to face while programming computer algorithms in C. <br><br>  So, the first unexpected behavior for some programmers.  Here is a little prog. <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; int main() { unsigned char a = 1, b; b = ~a &gt;&gt; 1; printf("%u\n", b); return 0; }</span></span></span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We analyze it.  The bitwise operation <b>~</b> inverts the state of each bit of a byte <b>a</b> in which the unit is originally written.  As a result, should receive <b>11111110b</b> , that is, <b>254</b> .  Shifting this byte to the right by one bit should get <b>127</b> .  However, the code that gives, for example, the <b>gcc</b> compiler, displays the number <b>255</b> in the console?! <br><br>  At first, I thought that the matter is in priority - what if the compiler has a priority of operations ‚Äúto mow‚Äù?  That is, it is as if a shift is first made, and then an inversion (and that is logical ...).  So what's the deal? <br><a name="habracut"></a><br>  After some deliberation, I came up with another hypothesis that by inversion, bytes are brought to the word (well, or to a double word), and then the inverted word shifts.  That's where it turns out <b>255</b> - the high bits in the word zeros, inverting them, we have ones.  Then, making the word shift to the right by one bit, there will be one in its low byte in all bits. <br><br>  This is confirmed by the following code. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; int main() { unsigned char a = 1, b; b = (unsigned char)~a &gt;&gt; 1; printf("%u\n", b); return 0; }</span></span></span></span></code> </pre><br>  Now we get the correct result.  But I finally became convinced of this by disassembling the ELF file, which is provided by <b>gcc</b> .  I will give a fragment of the received assembly code. <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp+var_6]</span></span>, 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">movzx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp+var_6]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">not</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sar</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp+var_5]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">al</span></span></code> </pre><br>  First, through the stack, the unit enters the 32-bit <b>eax</b> register.  Further it is inverted, and then moves.  The result comes from the younger part of the register <b>ax</b> - register <b>al</b> .  This justifies my hypothesis - the units that were beyond the desired byte, when a double word is shifted into it. <br><br>  As it turned out, this situation is called <b>Integer Promotion</b> and is described in Section <b>6.3.1.1 of</b> the <b>C99 standard</b> .  You can download it from here <a href="http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1124.pdf">www.open-std.org/jtc1/sc22/wg14/www/docs/n1124.pdf</a> <br><br>  The second unexpected behavior for some programmers is associated with real numbers.  We have the following code. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; int main() { float a = 1.005, b = 1000; int c = a*b; printf("%d\n", c); return 0; }</span></span></span></span></code> </pre><br>  Compiling it with <b><b>gcc</b> 4.1.1</b> , I get <b>1004</b> .  Again the question is where does the strange result come from?  Even this <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)(a*b);</code> </pre><br>  also does not give the correct result. <br><br>  Climbing on the <b>C89</b> standard, it turned out that he did not regulate anything about how to work with real numbers.  After all, when the <b>SSE</b> extension appeared, the compilers began to be considered in a mixed way - as one would think faster: something on the <b>FPU</b> , something on the <b>SSE</b> .  In the new <b>C99 standard,</b> there is some certainty.  The compiler should set the <b>FLT_EVAL_METHOD</b> macro (header file <b>float.h</b> ) to <b>0</b> , <b>1</b> , <b>2</b> for the way it counts.  So, <b>0</b> - all count as written;  <b>1</b> - <b>float</b> to actually count in <b>double</b> and then convert back to <b>float</b> ;  2 - count everything in <b>long double</b> , converting to <b>float</b> or <b>double</b> at the end of calculations, respectively. <br><br>  Now, in order to make the prog count as it should, you need to collect it <br><br><pre> <code class="cmake hljs">gcc proga.c -msse</code> </pre><br>  Only after that I got the number <b>1005</b> in the console.  It turned out that my version of the <b>gcc</b> compiler does not support the <b>FLT_EVAL_METHOD</b> macro.  By the way, with <b>double</b> <b>gcc</b> gives the code that outputs <b>1004</b> .  Only <b>Intel C 9.0</b> made normal code with <b>double</b> , but when I wrote <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)(a*b);</code> </pre><br>  (here, <b>a</b> and <b>b</b> are of <b>double</b> type).  Without a cast, the code gives <b>1004 there</b> . </div><p>Source: <a href="https://habr.com/ru/post/201868/">https://habr.com/ru/post/201868/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../201854/index.html">Astronauts assistant Robonaut finally gets legs</a></li>
<li><a href="../201856/index.html">Problems removing regular clutter on printed forms</a></li>
<li><a href="../201860/index.html">Lua API ++</a></li>
<li><a href="../201862/index.html">Comparison of the performance of the entire line of Nexus smartphones in one video</a></li>
<li><a href="../201864/index.html">How to realize a childhood dream and program something for Dendy</a></li>
<li><a href="../201870/index.html">Solving the problem of sound in one ear for some videos on Youtube</a></li>
<li><a href="../201872/index.html">What is the best e-mail address to do?</a></li>
<li><a href="../201874/index.html">What is wrong with OOP and OP</a></li>
<li><a href="../201878/index.html">Experts from iFixit have recognized Microsoft Surface Pro 2 almost unrepairable</a></li>
<li><a href="../201880/index.html">Say a word about a poor puzzle. Overview of the most popular category of children's applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>