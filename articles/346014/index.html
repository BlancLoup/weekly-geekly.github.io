<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Smart voice extension for garlands (esp8266 + stm32)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr. Last year, I made a "smart" power strip for managing Christmas tree garlands. But then the hands never came to write an article about it. Co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Smart voice extension for garlands (esp8266 + stm32)</h1><div class="post__text post__text-html js-mediator-article"><p>  Hi, Habr.  Last year, I made a "smart" power strip for managing Christmas tree garlands.  But then the hands never came to write an article about it.  Correct. </p><br><p>  Herringbone itself </p><br><p><img src="http://wiieva.com/habr/IMG_1869.JPG" alt="image"></p><br><p>  On the Christmas tree there are 3 garlands, and under it is a brood of luminous white bears.  When there are a lot of garlands, the question arises - how to manage them?  Each time it is a dubious pleasure to crawl under the Christmas tree and turn on / off the necessary garlands from the socket. </p><br><p>  Of course, a large number of "smart sockets" are sold - but with voice control, and so that 4 sockets in one device at once, without unnecessary wires and power supply units - I have not seen such. </p><a name="habracut"></a><br><h1 id="itak-pristupim">  So let's start </h1><br><p>  As the body ideally suited extension "pilot".  Seen and bought in the nearest shop. </p><br><p><img src="http://wiieva.com/habr/pilot.jpg"></p><br><p>  A 5 volt power supply unit and shield with 4 relays were found in stocks of small things bought on aliexpress. </p><br><p><img src="http://wiieva.com/habr/acdc.jpg"><img src="http://wiieva.com/habr/relayshield.jpg"></p><br><p>  Now, the most important thing is "brains".  The brains in the project will be the Wiieva board, which has everything we need - a screen, a microphone, wifi, an Arduino form factor compatible with the shield.  The WiFi module is implemented on the super popular esp8266, peripheral control and work with sound - on stm32f105rbt. </p><br><p><img src="http://wiieva.com/habr/wiieva1.jpg"><img src="http://wiieva.com/habr/wiieva2.jpg"></p><br><h1 id="sobiraem-umnyy-udlinitel">  We collect a smart extension cord </h1><br><ol><li>  Cut a hole in the body under the screen.  Under the cutout came one socket and the old switch - a small loss. <br>  On the back of the case, double-sided tape at the bottom - to make the board tighter <br></li></ol><br>  We separate the bus to which the sockets are connected, and draw the wires from each outlet separately.  Mounted power unit with power supply. <br><br><img src="http://wiieva.com/habr/internals.jpg"><br><br>  Connect the brains - connect the Wiieva board and shield with the relay 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="http://wiieva.com/habr/internals1.jpg"><br><br>  We place all the components in their place <br><br><img src="http://wiieva.com/habr/internals2.jpg"><br><br>  Top view of the "smart extension" assembly <br><br><img src="http://wiieva.com/habr/topview.jpg"><br><br>  A little aesthetics - we print a lid on a 3d printer <br><br><img src="http://wiieva.com/habr/topview2.jpg"><br><br><h1 id="chto-poluchilos">  What happened </h1><br><br><img src="http://wiieva.com/habr/IMG_1873.JPG"><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/xfbM9PDwRvE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h2 id="kak-ustroena-programnaya-i-apparatnaya-chast">  How does the software and hardware </h2><br><p>  The most difficult part of the project is the components responsible for audio input / output.  In general, there are several approaches to recording and recognizing sound: </p><br><ul><li>  device recognition <br>  Pros: no internet connection required <br>  Cons: it requires a large computing power, a very limited vocabulary, a large percentage of errors. </li><li>  recognition in the cloud, for example google or yandex <br>  Pros: good quality, practically unlimited vocabulary <br>  Cons: Internet connection required, increased latency <br>  In the case of an IoT device that has a processor with 64kb of RAM and 160 MHz - it is impossible to make confident recognition of voice commands on board.  You can train him to recognize a few words and then, having previously trained to your voice. </li></ul><br><p>  Therefore, for speech recognition used the service google speech recognition.  It would seem, not a difficult task, to record sound from a microphone and send it to google speech recognition.  However, when it comes to the device based on esp8266, the task is not trivial. </p><br><p>  The esp8266 does not have a good ADC, and the one that is on board does not technically allow to record anything other than noise.  Therefore, to capture the sound, as sufficient for speech recognition, at least an external ADC or, better still, an external processor to which the microphone is connected is needed.  Having tried several options - stopped at stm32 + digital PDM microphone. </p><br><p>  The next task is to control / transfer data from stm32 to esp8266.  UART and i2c were immediately dropped as slow interfaces and the decision was made to use SPI.  SPI is a synchronous interface with a mandatory distribution of roles: master and slave.  In the combination of stm32 and esp8266, the main logic of the program is executed on esp8266, and stm32 is a coprocessor that works with peripherals.  Therefore, it is logical to assign esp8266 the role of master, and stm32 - the role of the slave. </p><br><p>  This bunch gave a good result: clear sound from a microphone without interference and without extraneous noise.  Alas, the sound idyll did not last long, smoothly, until the received sound was sent via WiFi via http connection to google. </p><br><p>  An unpleasant story happened: while there is no active transmission over WiFi, the sound is written in perfect quality.  As soon as the active packet transmission over WiFi begins, the sound is immediately distorted by a crash.  The oscilloscope examination showed that with active WiFi transmission over the power bus, the noise is not weak, and filtering them at the circuit design level is difficult. </p><br><p>  Therefore, as often happens, the hardware problem had to be treated programmatically.  The logical solution is to save the sound in the buffer, and upon completion of the phrase send by http to the cloud.  It seemed like a business - to save in the buffer.  But here we remember that we have only 40KB of free RAM.  And even with a digitization frequency of 8kHz, 40KB will fit in just 2 seconds with a small recording of uncompressed speech.  It will be small. </p><br><p>  The solution was to pre-pack the sound with the SPEEX codec - it gives a 2KB rate per second, which is more than enough to record any voice command entirely in memory, and determine the end of the phrase with the VAD (Voice Activity Detector) algorithm. <br><img src="http://wiieva.com/habr/scheme.png"><br>  Voila - this design has earned, and began to confidently recognize any spoken phrases. <br></p><br><h2 id="pro-platu-wiieva">  Pro Wiieva fee </h2><br><p>  Here, probably, it is worth making a lyrical digression.  For those who, having read to this paragraph, the most likely question arises - is it possible that there are so many movements just for the sake of herringbone voice control.  The simple answer, of course, is not only.  A couple of years ago, when esp8266 just came to me, I had an idea - to attach cloud recognition of speech to it.  And, in my free time, I slowly saw the project with a familiar electronics engineer, which resulted in the wiieva board and the configuration described above.  In the process of life, the project got a bunch of chips, for example, mp3 player with speaker, Arduino-compatible form factor, temperature / humidity / pressure sensors, touch screen, USB, IR diode and MicroSD slot. </p><br><p>  Therefore, the main work was done before the start of the project ‚ÄúHerringbone‚Äù, and the project ‚ÄúHerringbone‚Äù was done in a couple of evenings, including the operation of grafting the board into an extension cord and writing a sketch with high-level logic. </p><br><h2 id="sketch-s-logikoy">  Sketch with logic </h2><br><p>  The program is written as a sketch for the Arduino environment esp8266. </p><br><p>  In addition to recognizing voice commands, the sketch has a UI - screensaver with a beautiful Christmas tree, a control screen with on / off buttons for garlands. <br>  In addition to local management, there is the http API on / off garlands.  This is to control the herringbone through the common interface of the smart home. </p><br><p> And with a bonus, the sketch is able to play mp3 files from a microSD card - I recorded there several Christmas compositions.  That is to say, an additional trick, to maintain New Year's mood. </p><br><p>  <a href="">Sketch Sources</a> </p><br><p>  Initialization and start of recognition </p><br><pre><code class="hljs pgsql">//    #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> &lt;WiievaRecorder.h&gt; WiievaRecorder recorder (<span class="hljs-number"><span class="hljs-number">2000</span></span>*<span class="hljs-number"><span class="hljs-number">5</span></span>); //    unsigned long timeRecorderStart = <span class="hljs-number"><span class="hljs-number">0</span></span>,timeRecorderEnd=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-type"><span class="hljs-type">bool</span></span> wasVAD = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-type"><span class="hljs-type">void</span></span> startRecognize () { //   recorder.<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> (AIO_AUDIO_IN_SPEEX); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.printf ("Start recording\n"); timeRecorderStart = millis(); timeRecorderEnd=<span class="hljs-number"><span class="hljs-number">0</span></span>; wasVAD = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre> <br><p>  The very recognition and execution of commands </p><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> processRecognize () { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!timeRecorderStart) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } //   Voice Activity <span class="hljs-type"><span class="hljs-type">bool</span></span> res = recorder.run (); <span class="hljs-type"><span class="hljs-type">bool</span></span> vad = recorder.checkVad(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (vad &amp;&amp; !wasVAD) { <span class="hljs-type"><span class="hljs-type">Serial</span></span>.printf("VAD: speech started\n"); } wasVAD = wasVAD || vad; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (millis () - timeRecorderStart &lt; <span class="hljs-number"><span class="hljs-number">3000</span></span> || vad) timeRecorderEnd = millis (); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (res &amp;&amp; (!timeRecorderEnd || millis () - timeRecorderEnd &lt; <span class="hljs-number"><span class="hljs-number">500</span></span>)) // VAD    -   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; recorder.stop(); timeRecorderStart = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!wasVAD) { //     -  <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } //  http    POST  google speech recognition HTTPClient http; http.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(url); http.addHeader ("Content-Type","audio/x-speex-with-header-byte; rate=8000"); <span class="hljs-type"><span class="hljs-type">int</span></span> httpCode = http.sendRequest ("POST",&amp;recorder,recorder.recordedSize()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(httpCode &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-type"><span class="hljs-type">Serial</span></span>.printf("[HTTP] POST... code: %d\n", httpCode); String payload = http.getString(); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println(payload); String cmd = "toggle"; //       //    <span class="hljs-type"><span class="hljs-type">JSON</span></span>,           <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (payload.indexOf ("")&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span> || payload.indexOf ("")&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span>) cmd = "off"; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (payload.indexOf ("")&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span> || payload.indexOf ("")&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span>) cmd = "on"; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (payload.indexOf ("")&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span>) startPlay(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (payload.indexOf ("")&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span>) controlAllRelay (cmd); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { //    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (payload.indexOf ("")&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span>) controlRelay (<span class="hljs-number"><span class="hljs-number">0</span></span>,cmd); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (payload.indexOf ("")&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span>) controlRelay (<span class="hljs-number"><span class="hljs-number">1</span></span>,cmd); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (payload.indexOf ("")&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span>|| payload.indexOf ("")&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span>) controlRelay (<span class="hljs-number"><span class="hljs-number">2</span></span>,cmd); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (payload.indexOf ("")&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span>) controlRelay (<span class="hljs-number"><span class="hljs-number">3</span></span>,cmd); } } http.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>(); }</code> </pre> <br><h2 id="pod-kapotom">  Under the hood </h2><br><h3 id="ocifrovka-zvuka">  Sound digitization </h3><br><p>  The PDM Microphone is connected to the stm32 SPI / I2S2 processor.  As reference I used this <a href="http://www.st.com/content/ccc/resource/technical/document/application_note/ca/18/be/bb/f8/53/47/a5/DM00040808.pdf/files/DM00040808.pdf/jcr:content/translations/en.DM00040808.pdf">Application Note from ST</a> </p><br><p>  In order not to load the processor, data from I2S is obtained using <a href="">DMA</a> in the ring ping-pong buffer. <br>  PDM.  Processing of the received PDM data occurs by interrupts from the DMA.  Working with DMA interrupts is fairly standard for stm32: <br>  There are two signs of interrupting the filling of the upper / lower halves of the buffer.  In the interrupt handler <a href="">, the buffer half is selected, with the data already prepared</a> </p><br><p>  Then the buffer is converted from the PDM format to the usual PCM: a set of samples (signal level values) <a href="">with the required sampling rate.</a> </p><br><p>  After conversion and resampling, data in PCM format is added to the <code>pdm_samples_buf</code> ring buffer. </p><br><h3 id="kodirovanie-v-speex">  Speex coding </h3><br><p>  The next stage of the pipeline is the sound packaging with the SPEEX codec.  Audio processing by a codec is a very resource-intensive process, which consumes a lot of CPU time and does not call it in the interrupt handler very well. </p><br><p>  Therefore, the packaging occurs asynchronously, in the main program loop - the <a href="">code is</a> <a href="">code part two</a> </p><br><p>  At the same time with the coding in SPEEX, the presence of voice activity is analyzed by the VAD algorithm. <br>  And the speex codec encoded speech adds up to another <code>speex_buf</code> ring buffer, from which they are already transmitted to esp9266 </p><br><h3 id="peredacha-zakodirovannogo-bufera-iz-stm32-v-esp8266">  Transfer coded buffer from stm32 to esp8266 </h3><br><p>  The interface between esp8266 and stm32 is built on the principle of command -&gt; answer.  esp8266 sends a command, stm32 processes the command and returns a response.  In a part of the commands, a data buffer is transmitted along with the body of the command / or the response body. </p><br><p>  From the side of esp8266, the work algorithm turned out to be very simple: <br>  Send command to read data buffer and read data: </p><br><p>  This is how esp8266 looks like: <br>  <a href="">recorder code</a> <br>  <a href="">SPI code</a> </p><br><p>  From the stm32 side, the task looks more complicated: <br>  Interrupts from SPI parses the command code, and depending on the command code, the required actions are performed.  In our case, <a href="">sending data from the SPEEX ring buffer to the SPI</a> </p><br><h2 id="vmesto-zaklyucheniya">  Instead of conclusion </h2><br><p>  Many interesting moments, for example, such as playing mp3, connecting a graphic library, implementing screen drivers and touch panels, integrating with a smart home and much, much more, had to be left out of this article - there would have been too much text. </p><br><p>  The plans still finish activating speech recognition by hot-word, for example, herringbone.  To do this, I plan to drag a small piece of pocketsphinx on board and do something on board like MFCC + DTW ... </p><br><h2 id="neskolko-poleznyh-ssylok">  several useful links </h2><br><p>  <a href="https://github.com/olegator77/new-year-tree">Sketch Sources</a> </p><br><p>  <a href="https://github.com/wiieva/schematics">Circuit board</a> </p><br><p>  <a href="https://github.com/wiieva/stm32aio">Program for stm32</a> </p><br><p>  <a href="https://github.com/wiieva/Arduino">Fork Arduino environment for the Wiieva board</a> </p></div><p>Source: <a href="https://habr.com/ru/post/346014/">https://habr.com/ru/post/346014/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345994/index.html">About the shape of a rotating fluid</a></li>
<li><a href="../345998/index.html">Why is it bad to be an excellent student</a></li>
<li><a href="../346000/index.html">Business function modeling</a></li>
<li><a href="../346006/index.html">Beginners on Arduino: We pack the state machine in a separate class and library</a></li>
<li><a href="../346010/index.html">Path maker: from scratch to senor</a></li>
<li><a href="../346016/index.html">[Translation] The anemic domain model is not an anti-pattern, but architecture based on the SOLID principles</a></li>
<li><a href="../346018/index.html">Current trends EdTech</a></li>
<li><a href="../346020/index.html">The decision that must be made in order not to regret life in 30 years</a></li>
<li><a href="../346022/index.html">Javascript: 12 questions and answers</a></li>
<li><a href="../346026/index.html">The CPU will pass you with giblets: the most serious security hole in the entire history of observations?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>