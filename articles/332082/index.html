<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Integration of 1C with DLL using Python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! Recently, I developed an algorithm for logistics, and I had to attach it somewhere. In addition to the web service, it was decided to impleme...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Integration of 1C with DLL using Python</h1><div class="post__text post__text-html js-mediator-article">  Hi Habr!  Recently, I developed an algorithm for logistics, and I had to attach it somewhere.  In addition to the web service, it was decided to implement this module in 1C, and there appeared quite a few pitfalls. <br><br>  Let's start with the fact that the algorithm itself is represented as a dll of the library, which has one entry point that accepts a JSON string as a parameter and gives 2 callbacks.  The first to display the status of execution, the other to get the result.  Everything is quite simple with the web service, python has a wonderful ctypes package, just load the necessary library and specify the entry point. <br><br>  It looks like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ctypes <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback_recv</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*args)</span></span></span><span class="hljs-function">:</span></span> print(args) lib = ctypes.cdll.LoadLibrary(<span class="hljs-string"><span class="hljs-string">'test.dll'</span></span>) Callback = ctypes.CFUNCTYPE(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, ctypes.c_int, ctypes.c_char_p) my_func = getattr(lib, <span class="hljs-string"><span class="hljs-string">'_ZN7GtTools4testEPKcPFviS1_E'</span></span>) cb_func = Callback(callback_recv) my_func(ctypes.c_char_p(<span class="hljs-string"><span class="hljs-string">'some data'</span></span>), cb_func)</code> </pre> <br>  As you can see, the entry point is not quite readable.  To find this line in the compiled data, you need to open the corresponding file with the .lib extension and use the objdump utility with the -D parameter; you can easily find the desired method by its name in the output. <br><br>  This method of distorting is due to the fact that the mangliter compiler (‚Äúmangle‚Äù - cripple) the name of all entry points, and the different compilers ‚Äúcripple‚Äù in different ways.  In the example, the method obtained is the MinGW <br><a name="habracut"></a><br>  In 1C, everything turned out to be much less trivial.  To connect the dll, you need to have a special Native API that allows you to register the External Component.  I wrote everything by example, but nothing took off.  I thought it was because of gcc.  All my attempts to install Visual Studio failed, then nothing was installed, then there were not enough standard libraries. <br><br>  Already falling asleep a brilliant hypothesis came to my mind.  Probably, this problem could not but be left by Pythonists, because everything that is possible at all is developed on Python.  A la rule of the Internet 34, only in relation to wonderful Python.  And because I was right! <br><br>  For python, there is a win32com package that allows you to register Python objects as COM objects.  For me, it was some kind of magic, because I don‚Äôt even really understand what a COM object is, but I know that it can do 1C. <br><br>  The pypiwin32 package does not need to be installed using pip, but rather to download its installer, since  for some reason, the objects were not registered after installation by pip. <br><br>  Having dealt with a small example, I took up the development.  First you need to create an object with an interface that identifies a COM object in the system <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GtAlgoWrapper</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># com spec _public_methods_ = ['solve','resultCallback', 'progressCallback',] #   _public_attrs_ = ['version',] #   _readonly_attr_ = [] _reg_clsid_ = '{2234314F-F3F1-2341-5BA9-5FD1E58F1526}' # uuid  _reg_progid_= 'GtAlgoWrapper' # id  _reg_desc_ = 'COM Wrapper For GTAlgo' #   def __init__(self): self.version = '0.0.1' self.progressOuterCb = None # ... def solve(self, data): # ... return '' def resultCallback(self, obj): # ... return obj def progressCallback(self, obj): #     1 ,     #     if str(type(obj)) == "&lt;type 'PyIDispatch'&gt;": com_obj = win32com.client.Dispatch(obj) try: #    1 (progressCallback)    self.progressOuterCb = com_obj.progressCallback1C; except AttributeError: raise Exception('"progressCallback"     ') return obj</span></span></code> </pre><br>  and of course we will describe his registration <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> win32com.server.register win32com.server.register.UseCommandLine(GtAlgoWrapper) print(<span class="hljs-string"><span class="hljs-string">'registred'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: main()</code> </pre><br>  Now when you run this script, the GtAlgoWrapper object will appear in the system.  His call from 1C will look like this: <br><br><pre> <code class="1c hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword"></span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">progressCallback1C</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword"></span></span></span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"></span></span></span></span>) <span class="hljs-keyword"><span class="hljs-keyword"></span></span> <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-string"><span class="hljs-string">" = "</span></span> + ); <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-string"><span class="hljs-string">" = "</span></span> + <span class="hljs-built_in"><span class="hljs-built_in"></span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword"></span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">//...  1() //   =  COM("GtAlgoWrapper"); //  .progressCalback(); //...  = ...; // JSON  .solve(); </span></span></code> </pre><br>  Thus, all the data entering the callbacks can be processed.  The only thing that can still remain incomprehensible is how to transfer data from dll to 1C: <br><br><pre> <code class="python hljs">_dependencies = [<span class="hljs-string"><span class="hljs-string">'libwinpthread-1.dll'</span></span>, <span class="hljs-string"><span class="hljs-string">'libgcc_s_dw2-1.dll'</span></span>, <span class="hljs-comment"><span class="hljs-comment"># ..., 'GtRouting0-0-1.dll'] def solve(self, data): prefix_path = 'C:/release' #       try: for dep in self._dependencies: ctypes.cdll.LoadLibrary(os.path.join(prefix_path, dep)) #        lib = ctypes.cdll.LoadLibrary(os.path.join(prefix_path, 'GtAlgo0-0-1.dll')) except WindowsError: raise Exception('cant load' + dep) solve_func = getattr(lib, '_ZN6GtAlgo5solveEPKcPFviS1_ES3_') #   StatusCallback = ctypes.CFUNCTYPE(None, ctypes.c_int, ctypes.c_char_p) ResultCallback = ctypes.CFUNCTYPE(None, ctypes.c_int, ctypes.c_char_p) scb_func = StatusCallback(self.progressOuterCb) rcb_func = ResultCallback(self.resultOuterCb) #  1C        DLL. Magic! if self.resultOuterCb is None: raise Exception('resultCallback function is not Set') if self.progressOuterCb is None: raise Exception('progressCallback function is not Set') #   solve_func(ctypes.c_char_p(data), scb_func, rcb_func)</span></span></code> </pre><br>  For successful work, you first need to call the python script to register the GtAlgoWrapper class, and then you can safely run the 1C configuration. <br><br>  So just you can link the dll library and 1C using a python, without crawling into the wilds. <br>  All Magic! <br><br><div class="spoiler">  <b class="spoiler_title">useful links</b> <div class="spoiler_text">  <a href="https://docs.python.org/3/library/ctypes.html">docs.python.org/3/library/ctypes.html</a> - ctypes package <br>  <a href="http://citforum.ru/book/cook/dll0.shtml">citforum.ru/book/cook/dll0.shtml</a> - Dynamic Libraries for Dummies <br>  <a href="https://habrahabr.ru/post/191014/">habrahabr.ru/post/191014</a> - NativeAPI <br>  <a href="http://infostart.ru/public/115486/">infostart.ru/public/115486</a> - COM object in C ++ <br>  <a href="https://infostart.ru/public/190166/">infostart.ru/public/190166</a> - COM object on Python <br>  <a href="https://pastebin.com/EFLnnrfp">pastebin.com/EFLnnrfp</a> - Full Python Script Code from Article </div></div></div><p>Source: <a href="https://habr.com/ru/post/332082/">https://habr.com/ru/post/332082/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332072/index.html">‚ÄúYou, thunderstorm, threaten, and we hold on to each other!‚Äù - tale about how I saved the ADSL modem</a></li>
<li><a href="../332074/index.html">Autoencoders in Keras, Part 6: VAE + GAN</a></li>
<li><a href="../332076/index.html">Dynamic instrumentation is not easy, but trivial *: we write yet another instrumentation for American Fuzzy Lop</a></li>
<li><a href="../332078/index.html">Classifying Text with Java Neural Network</a></li>
<li><a href="../332080/index.html">Hackers and exchanges: how to attack the sphere of finance</a></li>
<li><a href="../332084/index.html">Work with heterogeneous containers with C ++ 17</a></li>
<li><a href="../332086/index.html">Automatic application deployment with Maven and Wildfly</a></li>
<li><a href="../332088/index.html">Tasks with interviews. Three adequate tasks to "think"</a></li>
<li><a href="../332090/index.html">ReactJS - my understanding of testing</a></li>
<li><a href="../332092/index.html">Nelder-Mead optimization method. Python implementation example</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>