<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Image archive storage for a site in Azure Blob storage</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article tells about the experience of organizing budget storage of an image archive for a site with millions of ads. 



 Images in my case are ph...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Image archive storage for a site in Azure Blob storage</h1><div class="post__text post__text-html js-mediator-article">  The article tells about the experience of organizing budget storage of an image archive for a site with millions of ads. <br><br><img src="https://habrastorage.org/webt/9c/_6/sg/9c_6sgzywejobg-vzsrzgazv7_w.png"><br><a name="habracut"></a><br>  Images in my case are photos of apartments, houses, plots, etc.  I have my <a href="https://kvartiri-domiki.ru/">own project</a> which is a website with ads for the sale and rental of real estate.  The site has something about 6 years and during this time has accumulated a fairly large number of ads.  Each object card displays photos, an average of 8 photos per ad.  Actually I‚Äôm going to keep these photos in the cloud so that I can show them to visitors on the object cards. <br><br>  How did I keep them before?  - no way.  I did not store any images in myself except those that were posted manually.  In most cases, the ads get to the site through partners through automatic feed loading.  In the feed for each object there are links to photos - these are the links I store and give the visitor a photo directly from the partner.  This scheme works great and saves a bunch of resources. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Photos that visitors see in the <a href="https://kvartiri-domiki.ru/prodazha/kvartiry/moskva/">selection of ads</a> or in the <a href="https://kvartiri-domiki.ru/24102899">object card</a> are actually loaded from third-party resources. <br><br>  There is one nuance associated with the specifics of the site - archive objects are never deleted.  Those.  after an ad is removed from publication, it of course disappears from the search results, but always available via a direct link (without the seller‚Äôs contacts).  For some time, links to photos still live, it happens that over the years, but sooner or later they die.  Archived objects are valuable because visitors from search engines keep coming to them.  Also, <a href="https://kvartiri-domiki.ru/karta-cen/">a price map</a> is built on the archive (I already <a href="https://habr.com/post/335638/">wrote about it</a> ), and I also accidentally discovered an additional source of income for the project in the form of selling contact information for archival objects.  Why do they buy them - I do not know for sure, but I assume that visitors want to get contacts because they think that the ad has been removed from the publication by chance or by mistake.  It also probably happens that they want to learn something from previous owners.  Anyway, an ad with photos in this case is more likely to be purchased.  The value of photos increases after the realization of this nuance. <br><br>  Data volumes which I am going to store in a cloud make about 3-4 terabytes.  Plus a daily increase of several gigabytes.  Considering that this innovation of money will not directly bring, but only indirectly can affect the decision-making by the visitor, the budget in which I wanted to keep very modest - this is 1000-2000 p.  per month.  It would be nice to be free, but I did not find such an opportunity. <br><br><h2>  Azure </h2><br>  I somehow immediately looked towards Azure because I work on .net, and often I see beautiful promotional articles on this topic.  Plus, you have to use this platform for the main work, but there my opportunities are limited by the requirements of the business and the wishes of the management. <br><br>  Azure offers BLOB storage with three levels of storage: Hot, Cool and Archive.  Prices at all levels are different.  In general, the hotter the cheaper the reading / writing and the more expensive the monthly storage fee, and vice versa.  On Hot - it is advantageous to write / read and delete a lot, but it is expensive to store for a long time.  And on Archive it is cheap to keep but expensive to read / write.  Also at the archive and cold levels there is a fee for early deletion - this means that if I delete (or transfer to another level) an object earlier than a certain period, then I will still be charged as for all this period.  For the archival level - this is 180 days, for the cold - 30. <br><br><h2>  Prices </h2><br>  <a href="https://azure.microsoft.com/ru-ru/pricing/details/storage/blobs/">The cost of storage</a> is $ 0.0023 per GB per month at the archive level, $ 0.01 in the cold and $ 0.0196 in the hot.  At the current exchange rate, this is approximately 0.15, 0.65 and 1.28 rubles, respectively. <br><br>  I compared with the cost in Amazon and Google, it turns out that in Azure is cheaper. <br><br><table><tbody><tr><td></td><td>  <b><a href="https://azure.microsoft.com/ru-ru/pricing/details/storage/blobs/">Azure</a></b> </td><td>  <b><a href="https://aws.amazon.com/ru/s3/pricing/">Amazon (S3)</a></b> </td><td>  <b><a href="https://cloud.google.com/storage/pricing">Google</a></b> </td></tr><tr><td>  <b>Hot</b> </td><td>  $ 0.0196 </td><td>  $ 0.024 </td><td>  $ 0.026 </td></tr><tr><td>  <b>Cool</b> </td><td>  $ 0.01 </td><td>  $ 0.01 </td><td>  $ 0.01 </td></tr><tr><td>  <b>Archive</b> </td><td>  $ 0.0023 </td><td>  $ 0.0045 </td><td>  $ 0.007 </td></tr></tbody></table><br><br>  In addition to the cost of storage, it is necessary to take into account the cost of operations - they are also different at all levels.  Prices are per 10,000 transactions. <br><br>  <b>Hot</b> <br>  Reading: $ 0.0043, writing: $ 0.054 <br><br>  <b>Cool</b> <br>  Read: $ 0.01, write: $ 0.10 <br><br>  <b>Archive</b> <br>  Read: $ 6; Write: $ 0.12 <br><br><h2>  Work logic </h2><br><br>  While the ad is active, photos in it are displayed via links from third-party resources (from partners).  After removing an advertisement from publication, it becomes archival, but links to photos are still alive for some time.  Sooner or later they die, and you need to take care that by this time there was an archive copy. <br><br>  The processing of photographs can be described in the following steps: <br><br><ol><li>  As soon as the ad disappears from the partner's import file, i.e.  the partner has ceased to publish it, an entry is formed in the priority queue, where the priority is considered the number of views by visitors - the more views, the greater the likelihood that being an archive, the object will be viewed further. </li><li>  When processing a record from a queue, a blob is created containing reduced (up to 800x600) photos for the announcement.  The use of composite objects instead of photos directly is also due to savings - instead of 8 recording operations (an average of 8 photos per object), one is performed, and each operation costs money. </li><li>  BLOB is loaded first in Hot, and then immediately moved to the archive.  There is no opportunity to write directly to the archive, and since Cool has a fee for early removal, it is cheaper to use Hot as a transit. </li><li>  In the BLOB archive lies as long as links to the original photos are active (photos are still shown by links from partners). </li><li>  Checking for links is performed when a visitor enters the object's card - if you go to it, it means that the object is popular and it makes sense to restore photos from the archive. </li><li>  If the links to the original photos are dead, check if there is an archive copy, and if there is, send a request for restoration from the archive to Cool (recovery of a blob from the archive can take up to 15 hours - this is called rehydration from Microsoft). </li><li>  As soon as the BLOB has been restored from the archive, it is copied to the local storage and divided into normal photos.  Local storage is the hard drive of my server. </li><li>  Photos on the announcement card are already given from the local storage. </li><li>  Photos are stored in the local storage for several days.  If during this time there were views, the period of local storage is extended.  If there were no views, the photos are removed from the local storage, but remain at the Cool level in Azure. </li><li>  From Cool to Archive, they are copied if there were no views for two months - the object is clearly not popular and accordingly there is no point in overpaying for storage in Cool. </li></ol><br><br><h2>  First start </h2> <br>  When the process was written and tested, it was time for trial operation, and then it was expected that trouble would arise.  At that time, there were about 10 million objects in the queue; I decided to start migration from 30,000 objects per day.  I set up beautiful graphics on the dashboard and began to observe.  In the statistics, I saw strange ‚Äúattacks‚Äù with GetBlobProperties requests.  They occur at approximately equal intervals of one hour, they always begin about an hour and a half after the start of the migration, and last some more time after its completion. <br><br><img src="https://habrastorage.org/webt/wm/qx/qr/wmqxqrsvn7zctu-xyulyvr-25wu.png"><br><br>  The number of such requests was too large not to pay attention to them.  I watched the logs and saw that these requests are not coming from my server, but from foreign IP addresses.  I did not want to pay for them. <br><br>  I searched on the stack and in the documentation, but to no avail.  Wrote a <a href="https://stackoverflow.com/questions/51827955/azure-blob-storage-phantom-requests">question on Stackoverflow</a> and tech support.  In the end, after a long correspondence with technical support, and providing them with logs, they told me that they could reproduce the situation and this is a bug on their side. <br><br>  An interesting nuance is that my question on Stackoverflow was answered not explaining the reasons, but only confirming that I will pay for these requests, but the person who gave the answer insistently asked me to mark it as correct.  He also casually hinted to me that they (in support) are not welcome to spread about errors in their own products.  I let him know that I would not do this until he wrote the truth.  I could write it myself, but I thought that the technical support staff would probably measure the effectiveness, including the number of confirmed answers, so I suggested that he write the true reason and in this case I would mark his answer as correct.  After some hesitation, he agreed and added a comment about the bug to his comment.  In general, I liked how technical support works - I was even transferred to a Russian girl who still keeps me updated on the changes on this issue. <br><br>  The fact of the recognition of the bug satisfied me only morally, but I wanted to launch the mechanism into operation, and not to pay money for left-wing requests.  Especially considering that I am so confused so as to minimize the number of requests and thus the cost. <br><br>  In technical support, I was advised to wait with the launch and after a couple of weeks they wrote that the bug was fixed, but when the release with the fix will be made is unknown.  They offered to enable logging and work like this, and after the release to request compensation from Microsoft.  Actually, in this mode it still works.  I start the migration of a small number of objects every day and wait for the release. <br><br><h2>  Conclusion </h2><br>  The cost of a daily 30,000 objects costs while in 900 p.  per month - and this is quite acceptable.  Most of the costs are write operations.  So when the entire queue is processed and the stage of planned work comes, it will be clear what the real cost of such storage is.  But according to my calculations, this will happen in about a year. <br><br>  When there will be a release in Azure Blob-storage, I will add here whether it was possible to get compensation.  Regarding the monthly expenses - this is about 10% of the cost. </div><p>Source: <a href="https://habr.com/ru/post/424841/">https://habr.com/ru/post/424841/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../424823/index.html">How low-calorie food affects aging</a></li>
<li><a href="../424825/index.html">Robots and communism</a></li>
<li><a href="../424827/index.html">The illusion of space: how the new Spiderman renders spaces without geometry</a></li>
<li><a href="../424831/index.html">What to invest in the digital economy</a></li>
<li><a href="../424835/index.html">How to reduce the risk of investment on the stock exchange: 3 factors diversification</a></li>
<li><a href="../424843/index.html">And in your iOS applications, IBOutlet is already private?</a></li>
<li><a href="../424845/index.html">We calculate the "magic squares" using the GPU</a></li>
<li><a href="../424847/index.html">MNaaS and eSIM - the pros and cons of virtualization for mobile operators and their customers</a></li>
<li><a href="../424849/index.html">What is interesting about the new UCS C480 ML M5 - a server for machine learning from Cisco?</a></li>
<li><a href="../424851/index.html">What is wrong with hiring in IT?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>