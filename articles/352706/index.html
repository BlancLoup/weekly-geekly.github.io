<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to cut down a feature and not shoot yourself in the foot</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The main goal of the projects is to make money. The project I was working on was not an exception. 


 I am the developer of Wheels Market Wheels and ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to cut down a feature and not shoot yourself in the foot</h1><div class="post__text post__text-html js-mediator-article"><p>  The main goal of the projects is to make money.  The project I was working on was not an exception. </p><br><p>  I am the developer of Wheels Market Wheels and today's post will be devoted to how we differentiated the prices of paid services on our ‚Äúclassified‚Äù. </p><br><p>  Our company develops 3 products, each for 3 platforms - web, android and ios.  Users can apply various paid services to their ads, for example, a paid extension of the ad's lifetime or placing hot offers in a block. </p><br><p>  When I was attracted to this project, in my head, even before the discussion began, the thought kept that for differentiated prices? </p><br><p>  <i>Differentiated price - the price of the formation of which depends on the characteristics of the ad (region, brand, model, year, etc.).</i> </p><br><p>  The team had the task to increase the average check.  It was decided to ‚Äúgash‚Äù the feature, which contains a functional about which further and will be discussed.  The meaning of the feature was that through the admin panel we will be able to change the price of any paid service, relying on different parameters. </p><a name="habracut"></a><br><p>  At the time we started development, we already had microservice written in Go.  Sites and applications communicated with him through the client, sending the ad object to a POST request, and then, receiving in return the prices for any paid services, rendered them to the user. </p><br><p>  In the process of studying microservice, it turned out that the prices given to the user were hardcoded, that is, the price for placing an ad in hot offers was described by the ‚Äúhot‚Äù variable: 300, and the result of the answer looked like this: </p><br><pre><code class="hljs css">{ <span class="hljs-attribute"><span class="hljs-attribute">status</span></span>: <span class="hljs-string"><span class="hljs-string">"ok"</span></span>, data: { color-red: <span class="hljs-number"><span class="hljs-number">45</span></span>, hot: <span class="hljs-number"><span class="hljs-number">300</span></span>, paid-auto-re: <span class="hljs-number"><span class="hljs-number">5</span></span>, re: <span class="hljs-number"><span class="hljs-number">0</span></span>, s: <span class="hljs-number"><span class="hljs-number">90</span></span>, unset-auto-re: <span class="hljs-number"><span class="hljs-number">0</span></span>, up: <span class="hljs-number"><span class="hljs-number">200</span></span> } }</code> </pre> <br><p>  It was decided to do an important refactoring and get rid of hardcode in favor of a method that would give a differentiated price for the service. </p><br><p>  We have divided the development process into several stages: </p><br><ol><li>  The choice of data storage format. </li><li>  Development of the admin panel for price regulation. </li><li>  Differential price return method. </li></ol><br><h3>  Choosing a storage format </h3><br><p>  Initially, according to the statement of work, the product manager wanted to be able to set the price for a paid service from the administrative panel and this was one of the mostly important tasks.  Before me there was a question in what format to store the data. </p><br><p>  I decided to fill the database with ‚Äúrules‚Äù, that is, if the category of the ad is ‚ÄúAuto‚Äù and the region is ‚ÄúAlmaty‚Äù, then we apply the following price for the ad.  It remains to deal with the database. </p><br><p>  The first thing that came to mind was the MySQL database where the table with the rules for prices would be stored.  For example: </p><br><table border="1"><tbody><tr><th>  Id </th><th>  catId </th><th>  regionId </th><th>  coeff </th><th>  serviceName </th></tr><tr><td>  one </td><td>  13 </td><td>  14 </td><td>  1.4 </td><td>  hot </td></tr></tbody></table><br><p>  According to the TOR, it was necessary to set the price based on the region and category.  But, knowing how all these ‚ÄúWishlist‚Äù work, I thought that the price would need to be changed not only for the category and region, but also for a certain car model or for some other reason. </p><br><p>  In general, MySQL was no longer an option, and the choice fell on MongoDB, which would provide us with the broadest possibilities of dynamic scaling and could work with data arrays, without which the rules would be useless. </p><br><img src="https://habrastorage.org/webt/ll/n0/5-/lln05-0flcs-yuvyisg1lh72wrk.png"><br><br>  In principle, at the time of development, all our ads were already stored in MongoDB.  Feeding the rules to regulate prices there was also easier.  We stopped at this <br><br><h3>  Admin panel development for price regulation </h3><br><p>  The admin panel is not a difficult thing, it should have had the standard CRUD functionality, that is, adding, editing, deleting and displaying these rules in an easy-to-read form. </p><br><p>  We wrote this whole thing on phalcon, since this admin panel was only part of the main admin panel for a site running phalcon.  We also wrote a functional in the API that validated and saved our rules to the MongoDB collection. </p><br><p>  The ad json object looked like this: </p><br><img src="https://habrastorage.org/webt/md/fb/o7/mdfbo746-oy4unj7uwb7rv9duwm.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As we see here, there are some levels of nesting, that is, you need not only to save data with nesting, but also to do a search for this nesting in MongoDB.  To validate the data, we introduced a small collection, where we stored possible fields for use, so as not to store everything that the user sent to the API. <br><br><h3>  Differential Price Return Functionality </h3><br><p>  The last stage of our development was the stage of writing code that could work with all these rules and would return a response with a differentiated price to the request. </p><br><p>  Like before: </p><br><img src="https://habrastorage.org/webt/me/lf/-x/melf-xtdd0faqfh24sae4k5anku.png"><br><p>  Like now: </p><br><img src="https://habrastorage.org/webt/me/lf/-x/melf-xtdd0faqfh24sae4k5anku.png"><br><p>  And where is the refactoring and where are the differentiated prices?  But. </p><br><p>  These hard-coded variables in the code in the end remained as default values. </p><br><p>  The algorithm for returning prices used to work like this: </p><br><ol><li>  Formation of an array with prices for services. </li><li>  Exception handling by type for this section.  If the service is free, then give 0. </li><li>  Return of the result. </li></ol><br><p>  Now everything works as well, except that before returning the answer to the user, now there is a campaign in the method of price differentiation. </p><br><p>  The first approach to solving the problem was as follows. </p><br><p>  At the time of the formation of the array with the prices for each of its elements, that is, services, there was an additional campaign in MongoDB. </p><br><img src="https://habrastorage.org/webt/r-/xb/wv/r-xbwvt6bcearia_tgviu65fy6o.png"><br><p>  The ‚ÄúgetPriceForService‚Äù method returned the price and took the following arguments: </p><br><ol><li>  Ad object </li><li>  Service Name </li><li>  Price before processing </li></ol><br><p>  Remember, I wrote above that there is a collection with possible rules for regulating prices, and they are needed here. </p><br><p>  In order not to pass through each of the fields of an object, only a selection of possible rules was made.  On the next screen, we see the process of forming the request in MongoDB. </p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//      func getPriceForService(advert *Advert, serviceName string, basePrice int) (result int) { var mongoResult map[string]interface{} query := bson.M{} query["serviceName"] = serviceName query["$and"] = []bson.M{} //     for _, data := range getUsableValuesForPrice() { var value, err = advert.GetValueString(data.Rule) stringVal, err := getStringFromMixed(value) if err == nil { list := []string{"rules.", data.Rule} var str bytes.Buffer for _, l := range list { str.WriteString(l) } if err == nil { query["$and"] = append(query["$and"].([]bson.M), bson.M{"$or": []bson.M{bson.M{str.String(): stringVal}, bson.M{str.String(): nil}}}) } else { checkErr(err) } } } //     err := mongo.GetSession(). DB(mongo.GetDbName()). C("COLLECTION_NAME"). Find(query). Sort("-priority"). One(&amp;mongoResult) if err == nil { stringResult, err := getStringFromMixed(mongoResult["coeff"]) checkErr(err) coeff, err := strconv.ParseFloat(stringResult, 64) if err == nil { //     return int(math.Ceil(coeff * float64(basePrice))) } else { checkErr(err) } } return basePrice }</span></span></code> </pre> <br><p>  In the end, we received a request that could only fulfill and calculate the new price for the service, using the received coefficient. </p><br><p>  However, after the release of this code in production, our MongoDB died due to the fact that with a single request to microservice it gives results for all services, and I call the method when forming an array for each element.  That is, I increased the load on MongoDB by 7-8 times, and by the sweat of my face I began to rewrite my code. </p><br><p>  Information note: <i>To work with MongoDB, we used <a href="https://github.com/go-mgo/mgo">mgo</a> , which allows you to easily build queries to the database</i> . </p><br><p>  That evening, having studied the code anew, I decided to call this functionality at the very last moment, that is, before giving the results to the client.  I will knock on the same method, just a little rewritten.  The rewritten method began to accept not the name of the service anymore, but the list of services with prices ready for return. </p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//     func getPriceForServices(advert *Advert, serviceList Services) (result Services) { var mongoResult []map[string]interface{} var services []string for key, _ := range serviceList { services = append(services, key) } query := bson.M{} query["serviceName"] = bson.M{"$in": services} query["$and"] = []bson.M{} //     for _, data := range getUsableValuesForPrice() { var value, err = advert.GetValueString(data.Rule) stringVal, err := getStringFromMixed(value) if err == nil { list := []string{"rules.", data.Rule} var str bytes.Buffer for _, l := range list { str.WriteString(l) } if err == nil { query["$and"] = append(query["$and"].([]bson.M), bson.M{"$or": []bson.M{bson.M{str.String(): stringVal}, bson.M{str.String(): nil}}}) } else { checkErr(err) } } } //     err := mongo.GetSession(). DB(mongo.GetDbName()). C("Collection_name"). Find(query). Select(bson.M{"serviceName": 1, "coeff": 1}). Sort("priority"). All(&amp;mongoResult) checkErr(err) //   ,  for _, element := range mongoResult { coeff, err := getStringFromMixed(element["coeff"]) checkErr(err) intCoeff, error := strconv.ParseFloat(coeff, 64) checkErr(error) serviceName, err := getStringFromMixed(element["serviceName"]) if val, ok := serviceList[serviceName]; ok { price := int(math.Ceil(intCoeff * float64(val))) serviceList[serviceName] = price } } return serviceList }</span></span></code> </pre> <br><p>  As before, after receiving the request and completing it, we get the data with the rules for each service and the coefficient by which the old price should be multiplied. </p><br><p>  This approach eliminated all unnecessary trips to MongoDB, thus we stopped loading our base and received differentiated prices :) (profit). </p></div><p>Source: <a href="https://habr.com/ru/post/352706/">https://habr.com/ru/post/352706/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352692/index.html">Sysmon to be safe. Enhance event auditing in Windows</a></li>
<li><a href="../352694/index.html">Behavior-Driven Testing for iOS using Quick and Nimble</a></li>
<li><a href="../352696/index.html">Product Design Digest March 2018</a></li>
<li><a href="../352698/index.html">Pre-sale engineer - personal psychologist of Sale or a person on the border of money and technology</a></li>
<li><a href="../352700/index.html">Matthias Noback on Ideal Architecture - Layers, Ports, and Adapters (Part 3 - Ports and Adapters)</a></li>
<li><a href="../352708/index.html">Basic Business Instinct: The Edge of Corporate Security</a></li>
<li><a href="../352712/index.html">How to start working with lambda expressions in java</a></li>
<li><a href="../352714/index.html">Daily meetings in Agile development: 15 minutes, without which there is no release</a></li>
<li><a href="../352716/index.html">New C # 7.2. Span <T> and Memory <T></a></li>
<li><a href="../352718/index.html">Where better to live programmer. Compare 9 countries</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>