<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cross domain postMessage or how browsers support standards</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="While screwing up cloud storage to the backup script, it became necessary to use OAuth 2 authorization, for use with different cloud APIs. In principl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cross domain postMessage or how browsers support standards</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage3/612/8e9/8e6/6128e98e657aa5d707933ce8745284d2.png" align="left">  While screwing up cloud storage to the backup script, it became necessary to use OAuth 2 authorization, for use with different cloud APIs.  In principle, with the authorization itself no difficulties arose, but the problem arose in a little unexpected place. <br><br>  Considering the audience using the software, it was decided to abandon the support of ancient browsers, and everything was sharpened for modern browsers that use HTML5, which would seem quite well and equally support the standards. <br><br>  But it was not there‚Ä¶ <br><a name="habracut"></a><br><h4>  Interpretation of postMessage by different browsers </h4><br>  As it turned out, cross-domain (when pages from different domains) communicate between browser windows / tabs using postMessage is possible only in Chrome and Firefox (tested in Chrome 30 and Firefox 25). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In IE, postMessage only works when using frame / iframe (including IE 11). <br><br>  Opera unexpectedly surprised.  In version 12, everything works fine.  But in Opera 17, which is made on the same engine as Chrome, behaves differently.  If the domains are different, then postMessage works only in frame / iframe, and does not work in separate windows / tabs.  If the domains, more precisely, origin (ie, protocol + domain + port) are the same, then messages work, both between frames and between windows / tabs. <br><br>  It would seem that if all browsers support cross-domain communication between frames, so why not open the iframe authorization window in the application right away?  But here the careful <a href="http://blogs.msdn.com/b/ieinternals/archive/2010/03/30/combating-clickjacking-with-x-frame-options.aspx">X-Frame-Options</a> puts the footboard - almost on all OAuth servers it is forbidden to open the login page in the frame. <br><br><h4>  Proxy frame </h4><br>  Despite the scary name, this is a regular iframe downloaded from the application site, and its task is to transfer received tokens to the application window, since it cannot be directly transferred due to limitations in Opera and IE. <br><br>  After various options were tried, I settled on the following fairly simple solution for obtaining a token. <br><br>  For convenience, we use the following definitions: <br><ol><li>  <b>Application</b> (the web application is located on the user's domain, which is not known in advance) </li><li>  <b>Proxy frame</b> (intermediate frame located on the application server, embedded with the iframe in the application) </li><li>  <b>Application</b> site (site to which the user is redirected after OAuth authorization) </li><li>  <b>OAuth server</b> (the server you want to access) </li></ol><br>  In total, we use 3 domains: domain1 - where the user application is located, domain2 - the proxy frame and application site, domain3 - the OAuth server. <br><br>  The procedure for obtaining a token is as follows: <br><ol><li>  On the application page embedded proxy frame. <br><div style="text-align:center;"><img src="https://habrastorage.org/storage3/0fa/6b2/e3c/0fa6b2e3cda810cf084faa63c8d448b2.png"></div></li><li>  After clicking the button located in the proxy frame, the OAuth server authorization page opens in a new window / tab. <br><div style="text-align:center;"><img src="https://habrastorage.org/storage3/d9c/50c/d24/d9c50cd24eae9cd655357815532386ce.png"></div></li><li>  After the user's consent, the OAuth server sends the user to the Application site, with an authorization code in the request parameters. </li><li>  The application site makes a POST request to the OAuth server, and exchanges the authorization code and application password for the access token and / or the token for the update. <div style="text-align:center;"><img src="https://habrastorage.org/storage3/da2/45b/b96/da245bb96ff1bf6325d9b4621aaeba89.png"></div></li><li>  The resulting token is inserted into the text field (in case you cannot automatically copy it).  After that, the token is sent to the proxy frame, by changing the location.hash (this works in all browsers, since the proxy frame and application site have the same protocol, domain, port).  In fact, the use of location.hash is needed only for IE (including in IE 11), since in it postMessage does not work in different windows. </li><li>  Using the onhashchange event, the proxy frame immediately after changing the hash sends the token using postMessage (since the domains are now different) and closes the open window / tab opened for authorization. </li><li>  An application using the onmessage event receives a token and already uses it as intended. <br><div style="text-align:center;"><img src="https://habrastorage.org/storage3/169/499/f7d/169499f7db49badc4466c0024da89caa.png"></div></li></ol><br><br><h4>  Schematic illustration </h4><br><div style="text-align:center;"><img src="https://habrastorage.org/storage3/362/758/179/3627581790dbe611723ae25a3264ff7e.png"></div><br>  <i>I'm not special, though, according to beautiful schemes.</i>  <i>But I hope it will be clear.</i> <br><br><h4>  Demonstration </h4><br>  <a href="http://zapimir.net/habr/myapp.php"><b>On this page, you can see a live example</b></a> , except that the OAuth authorization itself is simulated, so that the real server is not overwhelmed. <br><br>  In normal mode, the transfer of the token occurs so quickly that the page with the text field is not visible (it closes quickly).  Therefore, who wants to see in more detail, here is <a href="http://zapimir.net/habr/myapp.php%3Fhold%3D1"><b>an example in which the window closes with a delay of 5 seconds</b></a> . <br><br><h4>  What else to read about postMessage </h4><br>  <a href="http://learn.javascript.ru/cross-window-messaging-with-postmessage">learn.javascript.ru/cross-window-messaging-with-postmessage</a> <br>  <a href="http://javascript.ru/ajax/cross-origin-2">javascript.ru/ajax/cross-origin-2</a> <br>  <a href="http://html5demos.com/postmessage2">html5demos.com/postmessage2</a> <br>  <a href="http://habrahabr.ru/post/120336/">habrahabr.ru/post/120336</a> <br>  <a href="http://caniuse.com/">caniuse.com/#search=postmessage</a> <br><br>  PS If you are interested, I can put the source codes of the scripts from the demo in the archive. </div><p>Source: <a href="https://habr.com/ru/post/197038/">https://habr.com/ru/post/197038/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../197026/index.html">How GitHub is released</a></li>
<li><a href="../197028/index.html">The story of two bridges</a></li>
<li><a href="../197030/index.html">FreeNAS 9.1.1 - we create network storage. Part 2. Installation transmission</a></li>
<li><a href="../197034/index.html">I know that you know, that I know that you know ...</a></li>
<li><a href="../197036/index.html">Linux for professionals: how to prepare a layout for printing in a print shop</a></li>
<li><a href="../197044/index.html">Centrifuge - as simple as possible, but not easier</a></li>
<li><a href="../197046/index.html">Random letter generator and its variants</a></li>
<li><a href="../197048/index.html">IT students forced to work on the assembly of the PlayStation 4</a></li>
<li><a href="../197056/index.html">Google starts paying rewards for fixing vulnerabilities in open source projects</a></li>
<li><a href="../197058/index.html">Metric # 25 - A podcast about technologies, products, and services from the IT world</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>